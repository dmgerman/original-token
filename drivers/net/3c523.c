multiline_comment|/*&n;   net-3-driver for the 3c523 Etherlink/MC card (i82586 Ethernet chip)&n;&n;&n;   This is an extension to the Linux operating system, and is covered by the&n;   same Gnu Public License that covers that work.&n;&n;   Copyright 1995, 1996 by Chris Beauregard (cpbeaure@undergrad.math.uwaterloo.ca)&n;&n;   This is basically Michael Hipp&squot;s ni52 driver, with a new probing&n;   algorithm and some minor changes to the 82586 CA and reset routines.&n;   Thanks a lot Michael for a really clean i82586 implementation!  Unless&n;   otherwise documented in ni52.c, any bugs are mine.&n;&n;   Contrary to the Ethernet-HOWTO, this isn&squot;t based on the 3c507 driver in&n;   any way.  The ni52 is a lot easier to modify.&n;&n;   sources:&n;   ni52.c&n;&n;   Crynwr packet driver collection was a great reference for my first&n;   attempt at this sucker.  The 3c507 driver also helped, until I noticed&n;   that ni52.c was a lot nicer.&n;&n;   EtherLink/MC: Micro Channel Ethernet Adapter Technical Reference&n;   Manual, courtesy of 3Com CardFacts, documents the 3c523-specific&n;   stuff.  Information on CardFacts is found in the Ethernet HOWTO.&n;   Also see &lt;a href=&quot;http://www.3com.com/&quot;&gt;&n;&n;   Microprocessor Communications Support Chips, T.J. Byers, ISBN&n;   0-444-01224-9, has a section on the i82586.  It tells you just enough&n;   to know that you really don&squot;t want to learn how to program the chip.&n;&n;   The original device probe code was stolen from ps2esdi.c&n;&n;   Known Problems:&n;   Since most of the code was stolen from ni52.c, you&squot;ll run across the&n;   same bugs in the 0.62 version of ni52.c, plus maybe a few because of&n;   the 3c523 idiosynchacies.  The 3c523 has 16K of RAM though, so there&n;   shouldn&squot;t be the overrun problem that the 8K ni52 has.&n;&n;   This driver is for a 16K adapter.  It should work fine on the 64K&n;   adapters, but it will only use one of the 4 banks of RAM.  Modifying&n;   this for the 64K version would require a lot of heinous bank&n;   switching, which I&squot;m sure not interested in doing.  If you try to&n;   implement a bank switching version, you&squot;ll basically have to remember&n;   what bank is enabled and do a switch everytime you access a memory&n;   location that&squot;s not current.  You&squot;ll also have to remap pointers on&n;   the driver side, because it only knows about 16K of the memory.&n;   Anyone desperate or masochistic enough to try?&n;&n;   It seems to be stable now when multiple transmit buffers are used.  I&n;   can&squot;t see any performance difference, but then I&squot;m working on a 386SX.&n;&n;   Multicast doesn&squot;t work.  It doesn&squot;t even pretend to work.  Don&squot;t use&n;   it.  Don&squot;t compile your kernel with multicast support.  I don&squot;t know&n;   why.&n;&n;   Features:&n;   This driver is useable as a loadable module.  If you try to specify an&n;   IRQ or a IO address (via insmod 3c523.o irq=xx io=0xyyy), it will&n;   search the MCA slots until it finds a 3c523 with the specified&n;   parameters.&n;&n;   This driver does support multiple ethernet cards when used as a module&n;   (up to MAX_3C523_CARDS, the default being 4)&n;&n;   This has been tested with both BNC and TP versions, internal and&n;   external transceivers.  Haven&squot;t tested with the 64K version (that I&n;   know of).&n;&n;   History:&n;   Jan 1st, 1996&n;   first public release&n;   Feb 4th, 1996&n;   update to 1.3.59, incorporated multicast diffs from ni52.c&n;   Feb 15th, 1996&n;   added shared irq support&n;   Apr 1999&n;   added support for multiple cards when used as a module&n;   added option to disable multicast as is causes problems&n;       Ganesh Sittampalam &lt;ganesh.sittampalam@magdalen.oxford.ac.uk&gt;&n;       Stuart Adamson &lt;stuart.adamson@compsoc.net&gt;&n;&t;&n;   $Header: /fsys2/home/chrisb/linux-1.3.59-MCA/drivers/net/RCS/3c523.c,v 1.1 1996/02/05 01:53:46 chrisb Exp chrisb $&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;3c523.h&quot;
multiline_comment|/*************************************************************************/
DECL|macro|DEBUG
mdefine_line|#define DEBUG&t;&t;&t;/* debug on */
DECL|macro|SYSBUSVAL
mdefine_line|#define SYSBUSVAL 0&t;&t;/* 1 = 8 Bit, 0 = 16 bit - 3c523 only does 16 bit */
DECL|macro|ELMC_MULTICAST
macro_line|#undef ELMC_MULTICAST&t;&t;/* Disable multicast support as it is somewhat seriously broken at the moment */
DECL|macro|make32
mdefine_line|#define make32(ptr16) (p-&gt;memtop + (short) (ptr16) )
DECL|macro|make24
mdefine_line|#define make24(ptr32) ((char *) (ptr32) - p-&gt;base)
DECL|macro|make16
mdefine_line|#define make16(ptr32) ((unsigned short) ((unsigned long) (ptr32) - (unsigned long) p-&gt;memtop ))
multiline_comment|/*************************************************************************/
multiline_comment|/*&n;   Tables to which we can map values in the configuration registers.&n; */
DECL|variable|__initdata
r_static
r_int
id|irq_table
(braket
)braket
id|__initdata
op_assign
(brace
l_int|12
comma
l_int|7
comma
l_int|3
comma
l_int|9
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|csr_table
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x300
comma
l_int|0x1300
comma
l_int|0x2300
comma
l_int|0x3300
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|shm_table
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x0c0000
comma
l_int|0x0c8000
comma
l_int|0x0d0000
comma
l_int|0x0d8000
)brace
suffix:semicolon
multiline_comment|/******************* how to calculate the buffers *****************************&n;&n;&n;  * IMPORTANT NOTE: if you configure only one NUM_XMIT_BUFFS, the driver works&n;  * --------------- in a different (more stable?) mode. Only in this mode it&squot;s&n;  *                 possible to configure the driver with &squot;NO_NOPCOMMANDS&squot;&n;&n;sizeof(scp)=12; sizeof(scb)=16; sizeof(iscp)=8;&n;sizeof(scp)+sizeof(iscp)+sizeof(scb) = 36 = INIT&n;sizeof(rfd) = 24; sizeof(rbd) = 12;&n;sizeof(tbd) = 8; sizeof(transmit_cmd) = 16;&n;sizeof(nop_cmd) = 8;&n;&n;  * if you don&squot;t know the driver, better do not change this values: */
DECL|macro|RECV_BUFF_SIZE
mdefine_line|#define RECV_BUFF_SIZE 1524&t;/* slightly oversized */
DECL|macro|XMIT_BUFF_SIZE
mdefine_line|#define XMIT_BUFF_SIZE 1524&t;/* slightly oversized */
DECL|macro|NUM_XMIT_BUFFS
mdefine_line|#define NUM_XMIT_BUFFS 4&t;/* config for both, 8K and 16K shmem */
DECL|macro|NUM_RECV_BUFFS_8
mdefine_line|#define NUM_RECV_BUFFS_8  1&t;/* config for 8K shared mem */
DECL|macro|NUM_RECV_BUFFS_16
mdefine_line|#define NUM_RECV_BUFFS_16 6&t;/* config for 16K shared mem */
macro_line|#if (NUM_XMIT_BUFFS == 1)
DECL|macro|NO_NOPCOMMANDS
mdefine_line|#define NO_NOPCOMMANDS&t;&t;/* only possible with NUM_XMIT_BUFFS=1 */
macro_line|#endif
multiline_comment|/**************************************************************************/
DECL|macro|DELAY
mdefine_line|#define DELAY(x) { mdelay(32 * x); }
multiline_comment|/* a much shorter delay: */
DECL|macro|DELAY_16
mdefine_line|#define DELAY_16(); { udelay(16) ; }
multiline_comment|/* wait for command with timeout: */
DECL|macro|WAIT_4_SCB_CMD
mdefine_line|#define WAIT_4_SCB_CMD() { int i; &bslash;&n;  for(i=0;i&lt;1024;i++) { &bslash;&n;    if(!p-&gt;scb-&gt;cmd) break; &bslash;&n;    DELAY_16(); &bslash;&n;    if(i == 1023) { &bslash;&n;      printk(KERN_WARNING &quot;%s:%d: scb_cmd timed out .. resetting i82586&bslash;n&quot;,&bslash;&n;      &t;dev-&gt;name,__LINE__); &bslash;&n;      elmc_id_reset586(); } } }
r_static
r_void
id|elmc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|reg_ptr
)paren
suffix:semicolon
r_static
r_int
id|elmc_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|elmc_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|elmc_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|elmc_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|elmc_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef ELMC_MULTICAST
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* helper-functions */
r_static
r_int
id|init586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|check586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|where
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_void
id|alloc586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|startrecv586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
op_star
id|alloc_rfa
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|elmc_rcv_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|elmc_xmt_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|elmc_rnr_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|struct|priv
r_struct
id|priv
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
DECL|member|memtop
r_char
op_star
id|memtop
suffix:semicolon
DECL|member|rfd_last
DECL|member|rfd_top
DECL|member|rfd_first
r_volatile
r_struct
id|rfd_struct
op_star
id|rfd_last
comma
op_star
id|rfd_top
comma
op_star
id|rfd_first
suffix:semicolon
DECL|member|scp
r_volatile
r_struct
id|scp_struct
op_star
id|scp
suffix:semicolon
multiline_comment|/* volatile is important */
DECL|member|iscp
r_volatile
r_struct
id|iscp_struct
op_star
id|iscp
suffix:semicolon
multiline_comment|/* volatile is important */
DECL|member|scb
r_volatile
r_struct
id|scb_struct
op_star
id|scb
suffix:semicolon
multiline_comment|/* volatile is important */
DECL|member|xmit_buffs
r_volatile
r_struct
id|tbd_struct
op_star
id|xmit_buffs
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
DECL|member|xmit_cmds
r_volatile
r_struct
id|transmit_cmd_struct
op_star
id|xmit_cmds
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
macro_line|#if (NUM_XMIT_BUFFS == 1)
DECL|member|nop_cmds
r_volatile
r_struct
id|nop_cmd_struct
op_star
id|nop_cmds
(braket
l_int|2
)braket
suffix:semicolon
macro_line|#else
DECL|member|nop_cmds
r_volatile
r_struct
id|nop_cmd_struct
op_star
id|nop_cmds
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
macro_line|#endif
DECL|member|nop_point
DECL|member|num_recv_buffs
r_volatile
r_int
id|nop_point
comma
id|num_recv_buffs
suffix:semicolon
DECL|member|xmit_cbuffs
r_volatile
r_char
op_star
id|xmit_cbuffs
(braket
id|NUM_XMIT_BUFFS
)braket
suffix:semicolon
DECL|member|xmit_count
DECL|member|xmit_last
r_volatile
r_int
id|xmit_count
comma
id|xmit_last
suffix:semicolon
DECL|member|slot
r_volatile
r_int
id|slot
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|elmc_attn586
mdefine_line|#define elmc_attn586()  {elmc_do_attn586(dev-&gt;base_addr,ELMC_CTRL_INTE);}
DECL|macro|elmc_reset586
mdefine_line|#define elmc_reset586() {elmc_do_reset586(dev-&gt;base_addr,ELMC_CTRL_INTE);}
multiline_comment|/* with interrupts disabled - this will clear the interrupt bit in the&n;   3c523 control register, and won&squot;t put it back.  This effectively&n;   disables interrupts on the card. */
DECL|macro|elmc_id_attn586
mdefine_line|#define elmc_id_attn586()  {elmc_do_attn586(dev-&gt;base_addr,0);}
DECL|macro|elmc_id_reset586
mdefine_line|#define elmc_id_reset586() {elmc_do_reset586(dev-&gt;base_addr,0);}
multiline_comment|/*************************************************************************/
multiline_comment|/*&n;   Do a Channel Attention on the 3c523.  This is extremely board dependent.&n; */
DECL|function|elmc_do_attn586
r_static
r_void
id|elmc_do_attn586
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|ints
)paren
(brace
multiline_comment|/* the 3c523 requires a minimum of 500 ns.  The delays here might be&n;&t;   a little too large, and hence they may cut the performance of the&n;&t;   card slightly.  If someone who knows a little more about Linux&n;&t;   timing would care to play with these, I&squot;d appreciate it. */
multiline_comment|/* this bit masking stuff is crap.  I&squot;d rather have separate&n;&t;   registers with strobe triggers for each of these functions.  &lt;sigh&gt;&n;&t;   Ya take what ya got. */
id|outb
c_func
(paren
id|ELMC_CTRL_RST
op_or
l_int|0x3
op_or
id|ELMC_CTRL_CA
op_or
id|ints
comma
id|ioaddr
op_plus
id|ELMC_CTRL
)paren
suffix:semicolon
id|DELAY_16
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* &gt; 500 ns */
id|outb
c_func
(paren
id|ELMC_CTRL_RST
op_or
l_int|0x3
op_or
id|ints
comma
id|ioaddr
op_plus
id|ELMC_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/*************************************************************************/
multiline_comment|/*&n;   Reset the 82586 on the 3c523.  Also very board dependent.&n; */
DECL|function|elmc_do_reset586
r_static
r_void
id|elmc_do_reset586
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|ints
)paren
(brace
multiline_comment|/* toggle the RST bit low then high */
id|outb
c_func
(paren
l_int|0x3
op_or
id|ELMC_CTRL_LBK
comma
id|ioaddr
op_plus
id|ELMC_CTRL
)paren
suffix:semicolon
id|DELAY_16
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* &gt; 500 ns */
id|outb
c_func
(paren
id|ELMC_CTRL_RST
op_or
id|ELMC_CTRL_LBK
op_or
l_int|0x3
comma
id|ioaddr
op_plus
id|ELMC_CTRL
)paren
suffix:semicolon
id|elmc_do_attn586
c_func
(paren
id|ioaddr
comma
id|ints
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************&n; * close device&n; */
DECL|function|elmc_close
r_static
r_int
id|elmc_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* the hard way to stop the receiver */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************&n; * open device&n; */
DECL|function|elmc_open
r_static
r_int
id|elmc_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|elmc_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_SAMPLE_RANDOM
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|alloc586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|startrecv586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* most done by init */
)brace
multiline_comment|/**********************************************&n; * Check to see if there&squot;s an 82586 out there.&n; */
DECL|function|check586
r_static
r_int
id|__init
id|check586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|where
comma
r_int
id|size
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_char
op_star
id|iscp_addrs
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|p-&gt;base
op_assign
id|where
op_plus
id|size
op_minus
l_int|0x01000000
suffix:semicolon
id|p-&gt;memtop
op_assign
id|phys_to_virt
c_func
(paren
id|where
)paren
op_plus
id|size
suffix:semicolon
id|p-&gt;scp
op_assign
(paren
r_struct
id|scp_struct
op_star
)paren
id|phys_to_virt
c_func
(paren
id|p-&gt;base
op_plus
id|SCP_DEFAULT_ADDRESS
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scp_struct
)paren
)paren
suffix:semicolon
id|p-&gt;scp-&gt;sysbus
op_assign
id|SYSBUSVAL
suffix:semicolon
multiline_comment|/* 1 = 8Bit-Bus, 0 = 16 Bit */
id|iscp_addrs
(braket
l_int|0
)braket
op_assign
id|phys_to_virt
c_func
(paren
id|where
)paren
suffix:semicolon
id|iscp_addrs
(braket
l_int|1
)braket
op_assign
(paren
r_char
op_star
)paren
id|p-&gt;scp
op_minus
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;iscp
op_assign
(paren
r_struct
id|iscp_struct
op_star
)paren
id|iscp_addrs
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;iscp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
)paren
suffix:semicolon
id|p-&gt;scp-&gt;iscp
op_assign
id|make24
c_func
(paren
id|p-&gt;iscp
)paren
suffix:semicolon
id|p-&gt;iscp-&gt;busy
op_assign
l_int|1
suffix:semicolon
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* reset586 does an implicit CA */
multiline_comment|/* apparently, you sometimes have to kick the 82586 twice... */
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;iscp-&gt;busy
)paren
(brace
multiline_comment|/* i82586 clears &squot;busy&squot; after successful init */
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; * set iscp at the right place, called by elmc_probe and open586.&n; */
DECL|function|alloc586
r_void
id|alloc586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|p-&gt;scp
op_assign
(paren
r_struct
id|scp_struct
op_star
)paren
id|phys_to_virt
c_func
(paren
id|p-&gt;base
op_plus
id|SCP_DEFAULT_ADDRESS
)paren
suffix:semicolon
id|p-&gt;scb
op_assign
(paren
r_struct
id|scb_struct
op_star
)paren
id|phys_to_virt
c_func
(paren
id|dev-&gt;mem_start
)paren
suffix:semicolon
id|p-&gt;iscp
op_assign
(paren
r_struct
id|iscp_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scp
op_minus
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;iscp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iscp_struct
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scp_struct
)paren
)paren
suffix:semicolon
id|p-&gt;scp-&gt;iscp
op_assign
id|make24
c_func
(paren
id|p-&gt;iscp
)paren
suffix:semicolon
id|p-&gt;scp-&gt;sysbus
op_assign
id|SYSBUSVAL
suffix:semicolon
id|p-&gt;iscp-&gt;scb_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;scb
)paren
suffix:semicolon
id|p-&gt;iscp-&gt;busy
op_assign
l_int|1
suffix:semicolon
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;iscp-&gt;busy
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Init-Problems (alloc).&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scb_struct
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************/
DECL|function|elmc_getinfo
r_static
r_int
id|elmc_getinfo
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|slot
comma
r_void
op_star
id|d
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|d
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
id|len
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Revision: 0x%x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ELMC_REVISION
)paren
op_amp
l_int|0xf
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;IRQ: %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;IO Address: %#lx-%#lx&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;base_addr
op_plus
id|ELMC_IO_EXTENT
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Memory: %#lx-%#lx&bslash;n&quot;
comma
id|dev-&gt;mem_start
comma
id|dev-&gt;mem_end
op_minus
l_int|1
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Transceiver: %s&bslash;n&quot;
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;External&quot;
suffix:colon
l_string|&quot;Internal&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Device: %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Hardware Address:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot; %02x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|buf
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|buf
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* elmc_getinfo() */
multiline_comment|/*****************************************************************/
DECL|function|elmc_probe
r_int
id|__init
id|elmc_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_static
r_int
id|slot
op_assign
l_int|0
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|u_char
id|status
op_assign
l_int|0
suffix:semicolon
id|u_char
id|revision
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|size
op_assign
l_int|0
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MCA_bus
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* search through the slots for the 3c523. */
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|ELMC_MCA_ID
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
op_minus
l_int|1
)paren
(brace
id|status
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|2
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq_table
(braket
(paren
id|status
op_amp
id|ELMC_STATUS_IRQ_SELECT
)paren
op_rshift
l_int|6
)braket
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|csr_table
(braket
(paren
id|status
op_amp
id|ELMC_STATUS_CSR_SELECT
)paren
op_rshift
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;   If we&squot;re trying to match a specified irq or IO address,&n;&t;&t;   we&squot;ll reject a match unless it&squot;s what we&squot;re looking for.&n;&t;&t;   Also reject it if the card is already in use.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|irq
op_logical_and
id|irq
op_ne
id|dev-&gt;irq
)paren
op_logical_or
(paren
id|base_addr
op_logical_and
id|base_addr
op_ne
id|dev-&gt;base_addr
)paren
op_logical_or
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ELMC_IO_EXTENT
)paren
)paren
(brace
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|ELMC_MCA_ID
comma
id|slot
op_plus
l_int|1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* found what we&squot;re looking for... */
r_break
suffix:semicolon
)brace
multiline_comment|/* we didn&squot;t find any 3c523 in the slots we checked for */
r_if
c_cond
(paren
id|slot
op_eq
id|MCA_NOTFOUND
)paren
(brace
r_return
(paren
(paren
id|base_addr
op_logical_or
id|irq
)paren
ques
c_cond
id|ENXIO
suffix:colon
id|ENODEV
)paren
suffix:semicolon
)brace
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;3Com 3c523 Etherlink/MC&quot;
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|slot
comma
(paren
id|MCA_ProcFn
)paren
id|elmc_getinfo
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* if we get this far, adapter has been found - carry on */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 3c523 adapter found in slot %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|slot
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Now we extract configuration info from the card.&n;&t;   The 3c523 provides information in two of the POS registers, but&n;&t;   the second one is only needed if we want to tell the card what IRQ&n;&t;   to use.  I suspect that whoever sets the thing up initially would&n;&t;   prefer we don&squot;t screw with those things.&n;&n;&t;   Note that we read the status info when we found the card...&n;&n;&t;   See 3c523.h for more details.&n;&t; */
multiline_comment|/* revision is stored in the first 4 bits of the revision register */
id|revision
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ELMC_REVISION
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* according to docs, we read the interrupt and write it back to&n;&t;   the IRQ select register, since the POST might not configure the IRQ&n;&t;   properly. */
r_switch
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
r_case
l_int|3
suffix:colon
id|mca_write_pos
c_func
(paren
id|slot
comma
l_int|3
comma
l_int|0x04
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|mca_write_pos
c_func
(paren
id|slot
comma
l_int|3
comma
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|mca_write_pos
c_func
(paren
id|slot
comma
l_int|3
comma
l_int|0x08
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|mca_write_pos
c_func
(paren
id|slot
comma
l_int|3
comma
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ELMC_IO_EXTENT
comma
l_string|&quot;3c523&quot;
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|priv
)paren
)paren
suffix:semicolon
(paren
(paren
r_struct
id|priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slot
op_assign
id|slot
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 3Com 3c523 Rev 0x%x at %#lx&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|revision
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* Determine if we&squot;re using the on-board transceiver (i.e. coax) or&n;&t;   an external one.  The information is pretty much useless, but I&n;&t;   guess it&squot;s worth brownie points. */
id|dev-&gt;if_port
op_assign
(paren
id|status
op_amp
id|ELMC_STATUS_DISABLE_THIN
)paren
suffix:semicolon
multiline_comment|/* The 3c523 has a 24K chunk of memory.  The first 16K is the&n;&t;   shared memory, while the last 8K is for the EtherStart BIOS ROM.&n;&t;   Which we don&squot;t care much about here.  We&squot;ll just tell Linux that&n;&t;   we&squot;re using 16K.  MCA won&squot;t permit address space conflicts caused&n;&t;   by not mapping the other 8K. */
id|dev-&gt;mem_start
op_assign
id|shm_table
(braket
(paren
id|status
op_amp
id|ELMC_STATUS_MEMORY_SELECT
)paren
op_rshift
l_int|3
)braket
suffix:semicolon
multiline_comment|/* We&squot;re using MCA, so it&squot;s a given that the information about memory&n;&t;   size is correct.  The Crynwr drivers do something like this. */
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* seems like a good idea before checking it... */
id|size
op_assign
l_int|0x4000
suffix:semicolon
multiline_comment|/* check for 16K mem */
r_if
c_cond
(paren
op_logical_neg
id|check586
c_func
(paren
id|dev
comma
id|dev-&gt;mem_start
comma
id|size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: memprobe, Can&squot;t find memory at 0x%lx!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ELMC_IO_EXTENT
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;mem_end
op_assign
id|dev-&gt;mem_start
op_plus
id|size
suffix:semicolon
multiline_comment|/* set mem_end showed by &squot;ifconfig&squot; */
(paren
(paren
r_struct
id|priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|base
op_assign
id|dev-&gt;mem_start
op_plus
id|size
op_minus
l_int|0x01000000
suffix:semicolon
id|alloc586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* make sure it doesn&squot;t generate spurious ints */
multiline_comment|/* set number of receive-buffs according to memsize */
(paren
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|num_recv_buffs
op_assign
id|NUM_RECV_BUFFS_16
suffix:semicolon
multiline_comment|/* dump all the assorted information */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IRQ %d, %sternal xcvr, memory %#lx-%#lx.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;ex&quot;
suffix:colon
l_string|&quot;in&quot;
comma
id|dev-&gt;mem_start
comma
id|dev-&gt;mem_end
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* The hardware address for the 3c523 is stored in the first six&n;&t;   bytes of the IO address. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hardware address &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|elmc_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|elmc_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|elmc_get_stats
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|elmc_send_packet
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|elmc_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|HZ
suffix:semicolon
macro_line|#ifdef ELMC_MULTICAST
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
macro_line|#else
id|dev-&gt;set_multicast_list
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* note that we haven&squot;t actually requested the IRQ from the kernel.&n;&t;   That gets done in elmc_open().  I&squot;m not sure that&squot;s such a good idea,&n;&t;   but it works, so I&squot;ll go with it. */
macro_line|#ifndef ELMC_MULTICAST
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_MULTICAST
suffix:semicolon
multiline_comment|/* Multicast doesn&squot;t work */
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************&n; * init the chip (elmc-interrupt should be disabled?!)&n; * needs a correct &squot;allocated&squot; memory&n; */
DECL|function|init586
r_static
r_int
id|init586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_void
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|s
suffix:semicolon
r_int
id|i
comma
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|configure_cmd_struct
op_star
id|cfg_cmd
suffix:semicolon
r_volatile
r_struct
id|iasetup_cmd_struct
op_star
id|ias_cmd
suffix:semicolon
r_volatile
r_struct
id|tdr_cmd_struct
op_star
id|tdr_cmd
suffix:semicolon
r_volatile
r_struct
id|mcsetup_cmd_struct
op_star
id|mc_cmd
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
id|num_addrs
op_assign
id|dev-&gt;mc_count
suffix:semicolon
id|ptr
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|p-&gt;scb
op_plus
r_sizeof
(paren
r_struct
id|scb_struct
)paren
)paren
suffix:semicolon
id|cfg_cmd
op_assign
(paren
r_struct
id|configure_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* configure-command */
id|cfg_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|cfg_cmd-&gt;cmd_cmd
op_assign
id|CMD_CONFIGURE
op_or
id|CMD_LAST
suffix:semicolon
id|cfg_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|cfg_cmd-&gt;byte_cnt
op_assign
l_int|0x0a
suffix:semicolon
multiline_comment|/* number of cfg bytes */
id|cfg_cmd-&gt;fifo
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* fifo-limit (8=tx:32/rx:64) */
id|cfg_cmd-&gt;sav_bf
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* hold or discard bad recv frames (bit 7) */
id|cfg_cmd-&gt;adr_len
op_assign
l_int|0x2e
suffix:semicolon
multiline_comment|/* addr_len |!src_insert |pre-len |loopback */
id|cfg_cmd-&gt;priority
op_assign
l_int|0x00
suffix:semicolon
id|cfg_cmd-&gt;ifs
op_assign
l_int|0x60
suffix:semicolon
id|cfg_cmd-&gt;time_low
op_assign
l_int|0x00
suffix:semicolon
id|cfg_cmd-&gt;time_high
op_assign
l_int|0xf2
suffix:semicolon
id|cfg_cmd-&gt;promisc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_ALLMULTI
op_or
id|IFF_PROMISC
)paren
)paren
(brace
id|cfg_cmd-&gt;promisc
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_PROMISC
suffix:semicolon
)brace
id|cfg_cmd-&gt;carr_coll
op_assign
l_int|0x00
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|cfg_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* warning: only active with interrupts on !! */
r_while
c_loop
(paren
op_logical_neg
(paren
id|cfg_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
op_star
id|HZ
op_div
l_int|100
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cfg_cmd-&gt;cmd_status
op_amp
(paren
id|STAT_OK
op_or
id|STAT_COMPL
)paren
)paren
op_ne
(paren
id|STAT_COMPL
op_or
id|STAT_OK
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s (elmc): configure command failed: %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cfg_cmd-&gt;cmd_status
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * individual address setup&n;&t; */
id|ias_cmd
op_assign
(paren
r_struct
id|iasetup_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|ias_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|ias_cmd-&gt;cmd_cmd
op_assign
id|CMD_IASETUP
op_or
id|CMD_LAST
suffix:semicolon
id|ias_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|ias_cmd-&gt;iaddr
comma
(paren
r_char
op_star
)paren
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|ias_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|ias_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
op_star
id|HZ
op_div
l_int|100
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ias_cmd-&gt;cmd_status
op_amp
(paren
id|STAT_OK
op_or
id|STAT_COMPL
)paren
)paren
op_ne
(paren
id|STAT_OK
op_or
id|STAT_COMPL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s (elmc): individual address setup command failed: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ias_cmd-&gt;cmd_status
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * TDR, wire check .. e.g. no resistor e.t.c&n;&t; */
id|tdr_cmd
op_assign
(paren
r_struct
id|tdr_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|tdr_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|tdr_cmd-&gt;cmd_cmd
op_assign
id|CMD_TDR
op_or
id|CMD_LAST
suffix:semicolon
id|tdr_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|tdr_cmd-&gt;status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|tdr_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
multiline_comment|/* cmd.-unit start */
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|tdr_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
op_star
id|HZ
op_div
l_int|100
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: %d Problems while running the TDR.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__LINE__
)paren
suffix:semicolon
id|result
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* wait for result */
id|result
op_assign
id|tdr_cmd-&gt;status
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
suffix:semicolon
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ack the interrupts */
r_if
c_cond
(paren
id|result
op_amp
id|TDR_LNK_OK
)paren
(brace
multiline_comment|/* empty */
)brace
r_else
r_if
c_cond
(paren
id|result
op_amp
id|TDR_XCVR_PRB
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TDR: Transceiver problem!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_amp
id|TDR_ET_OPN
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TDR: No correct termination %d clocks away.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|result
op_amp
id|TDR_TIMEMASK
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_amp
id|TDR_ET_SRT
)paren
(brace
r_if
c_cond
(paren
id|result
op_amp
id|TDR_TIMEMASK
)paren
multiline_comment|/* time == 0 -&gt; strange :-) */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TDR: Detected a short circuit %d clocks away.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|result
op_amp
id|TDR_TIMEMASK
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TDR: Unknown status %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|result
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * ack interrupts&n;&t; */
id|p-&gt;scb-&gt;cmd
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
suffix:semicolon
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * alloc nop/xmit-cmds&n;&t; */
macro_line|#if (NUM_XMIT_BUFFS == 1)
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_assign
(paren
r_struct
id|nop_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_NOP
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
r_sizeof
(paren
r_struct
id|nop_cmd_struct
)paren
suffix:semicolon
)brace
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_assign
(paren
r_struct
id|transmit_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* transmit cmd/buff 0 */
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
r_sizeof
(paren
r_struct
id|transmit_cmd_struct
)paren
suffix:semicolon
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_XMIT_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_assign
(paren
r_struct
id|nop_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_NOP
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
r_sizeof
(paren
r_struct
id|nop_cmd_struct
)paren
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_assign
(paren
r_struct
id|transmit_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/*transmit cmd/buff 0 */
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
r_sizeof
(paren
r_struct
id|transmit_cmd_struct
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ptr
op_assign
id|alloc_rfa
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|ptr
)paren
suffix:semicolon
multiline_comment|/* init receive-frame-area */
multiline_comment|/*&n;&t; * Multicast setup&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
multiline_comment|/* I don&squot;t understand this: do we really need memory after the init? */
r_int
id|len
op_assign
(paren
(paren
r_char
op_star
)paren
id|p-&gt;iscp
op_minus
(paren
r_char
op_star
)paren
id|ptr
op_minus
l_int|8
)paren
op_div
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Ooooops, no memory for MC-Setup!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
OL
id|num_addrs
)paren
(brace
id|num_addrs
op_assign
id|len
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Sorry, can only apply %d MC-Address(es).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|num_addrs
)paren
suffix:semicolon
)brace
id|mc_cmd
op_assign
(paren
r_struct
id|mcsetup_cmd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|mc_cmd-&gt;cmd_status
op_assign
l_int|0
suffix:semicolon
id|mc_cmd-&gt;cmd_cmd
op_assign
id|CMD_MCSETUP
op_or
id|CMD_LAST
suffix:semicolon
id|mc_cmd-&gt;cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|mc_cmd-&gt;mc_cnt
op_assign
id|num_addrs
op_star
l_int|6
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_addrs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mc_cmd-&gt;mc_list
(braket
id|i
)braket
comma
id|dmi-&gt;dmi_addr
comma
l_int|6
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|mc_cmd
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|mc_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|s
OG
l_int|30
op_star
id|HZ
op_div
l_int|100
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mc_cmd-&gt;cmd_status
op_amp
id|STAT_COMPL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t apply multicast-address-list.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t; * alloc xmit-buffs / init xmit_cmds&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_XMIT_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;xmit_cbuffs
(braket
id|i
)braket
op_assign
(paren
r_char
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* char-buffs */
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
id|XMIT_BUFF_SIZE
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
id|i
)braket
op_assign
(paren
r_struct
id|tbd_struct
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* TBD */
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
r_sizeof
(paren
r_struct
id|tbd_struct
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|ptr
OG
(paren
r_void
op_star
)paren
id|p-&gt;iscp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: not enough shared-mem for your configuration!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|p-&gt;xmit_cmds
(braket
id|i
)braket
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|transmit_cmd_struct
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|p-&gt;xmit_buffs
(braket
id|i
)braket
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tbd_struct
)paren
)paren
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
id|STAT_COMPL
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_XMIT
op_or
id|CMD_INT
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|i
)braket
op_member_access_from_pointer
id|tbd_offset
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;xmit_buffs
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
id|i
)braket
op_member_access_from_pointer
id|next
op_assign
l_int|0xffff
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
id|i
)braket
op_member_access_from_pointer
id|buffer
op_assign
id|make24
c_func
(paren
(paren
id|p-&gt;xmit_cbuffs
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|p-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
id|p-&gt;xmit_last
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef NO_NOPCOMMANDS
id|p-&gt;nop_point
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * &squot;start transmitter&squot; (nop-loop)&n;&t; */
macro_line|#ifndef NO_NOPCOMMANDS
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;nop_cmds
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
l_int|0xffff
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_cmd
op_assign
id|CMD_XMIT
op_or
id|CMD_LAST
op_or
id|CMD_INT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************&n; * This is a helper routine for elmc_rnr_int() and init586().&n; * It sets up the Receive Frame Area (RFA).&n; */
DECL|function|alloc_rfa
r_static
r_void
op_star
id|alloc_rfa
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_volatile
r_struct
id|rfd_struct
op_star
id|rfd
op_assign
(paren
r_struct
id|rfd_struct
op_star
)paren
id|ptr
suffix:semicolon
r_volatile
r_struct
id|rbd_struct
op_star
id|rbd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|rfd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rfd_struct
)paren
op_star
id|p-&gt;num_recv_buffs
)paren
suffix:semicolon
id|p-&gt;rfd_first
op_assign
id|rfd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|p-&gt;num_recv_buffs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rfd
(braket
id|i
)braket
dot
id|next
op_assign
id|make16
c_func
(paren
id|rfd
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|p-&gt;num_recv_buffs
)paren
suffix:semicolon
)brace
id|rfd
(braket
id|p-&gt;num_recv_buffs
op_minus
l_int|1
)braket
dot
id|last
op_assign
id|RFD_SUSP
suffix:semicolon
multiline_comment|/* RU suspend */
id|ptr
op_assign
(paren
r_void
op_star
)paren
(paren
id|rfd
op_plus
id|p-&gt;num_recv_buffs
)paren
suffix:semicolon
id|rbd
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
r_void
op_star
)paren
(paren
id|rbd
op_plus
id|p-&gt;num_recv_buffs
)paren
suffix:semicolon
multiline_comment|/* clr descriptors */
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|rbd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rbd_struct
)paren
op_star
id|p-&gt;num_recv_buffs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|p-&gt;num_recv_buffs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rbd
(braket
id|i
)braket
dot
id|next
op_assign
id|make16
c_func
(paren
(paren
id|rbd
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|p-&gt;num_recv_buffs
)paren
)paren
suffix:semicolon
id|rbd
(braket
id|i
)braket
dot
id|size
op_assign
id|RECV_BUFF_SIZE
suffix:semicolon
id|rbd
(braket
id|i
)braket
dot
id|buffer
op_assign
id|make24
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|ptr
op_plus
id|RECV_BUFF_SIZE
suffix:semicolon
)brace
id|p-&gt;rfd_top
op_assign
id|p-&gt;rfd_first
suffix:semicolon
id|p-&gt;rfd_last
op_assign
id|p-&gt;rfd_first
op_plus
id|p-&gt;num_recv_buffs
op_minus
l_int|1
suffix:semicolon
id|p-&gt;scb-&gt;rfa_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;rfd_first
)paren
suffix:semicolon
id|p-&gt;rfd_first-&gt;rbd_offset
op_assign
id|make16
c_func
(paren
id|rbd
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
multiline_comment|/**************************************************&n; * Interrupt Handler ...&n; */
DECL|function|elmc_interrupt
r_static
r_void
id|elmc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|reg_ptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|stat
suffix:semicolon
r_struct
id|priv
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;elmc-interrupt: irq %d for unknown device.&bslash;n&quot;
comma
(paren
r_int
)paren
op_minus
(paren
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
id|reg_ptr
)paren
op_member_access_from_pointer
id|orig_eax
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* The 3c523 has this habit of generating interrupts during the&n;&t;&t;   reset.  I&squot;m not sure if the ni52 has this same problem, but it&squot;s&n;&t;&t;   really annoying if we haven&squot;t finished initializing it.  I was&n;&t;&t;   hoping all the elmc_id_* commands would disable this, but I&n;&t;&t;   might have missed a few. */
id|elmc_id_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ack inter. and disable any more */
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|ELMC_CTRL_INT
op_amp
id|inb
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ELMC_CTRL
)paren
)paren
)paren
(brace
multiline_comment|/* wasn&squot;t this device */
r_return
suffix:semicolon
)brace
multiline_comment|/* reading ELMC_CTRL also clears the INT bit. */
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_while
c_loop
(paren
(paren
id|stat
op_assign
id|p-&gt;scb-&gt;status
op_amp
id|STAT_MASK
)paren
)paren
(brace
id|p-&gt;scb-&gt;cmd
op_assign
id|stat
suffix:semicolon
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ack inter. */
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_CX
)paren
(brace
multiline_comment|/* command with I-bit set complete */
id|elmc_xmt_int
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_FR
)paren
(brace
multiline_comment|/* received a frame */
id|elmc_rcv_int
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_NOPCOMMANDS
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_CNA
)paren
(brace
multiline_comment|/* CU went &squot;not ready&squot; */
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: oops! CU has left active state. stat: %04x/%04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|stat
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_RNR
)paren
(brace
multiline_comment|/* RU went &squot;not ready&squot; */
r_if
c_cond
(paren
id|p-&gt;scb-&gt;status
op_amp
id|RU_SUSPEND
)paren
(brace
multiline_comment|/* special case: RU_SUSPEND */
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_RESUME
suffix:semicolon
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Receiver-Unit went &squot;NOT READY&squot;: %04x/%04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|stat
comma
(paren
r_int
)paren
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
id|elmc_rnr_int
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for ack. (elmc_xmt_int can be faster than ack!!) */
r_if
c_cond
(paren
id|p-&gt;scb-&gt;cmd
)paren
(brace
multiline_comment|/* timed out? */
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*******************************************************&n; * receive-interrupt&n; */
DECL|function|elmc_rcv_int
r_static
r_void
id|elmc_rcv_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
r_int
id|totlen
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|rbd_struct
op_star
id|rbd
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|status
op_assign
id|p-&gt;rfd_top-&gt;status
)paren
op_amp
id|STAT_COMPL
suffix:semicolon
)paren
(brace
id|rbd
op_assign
(paren
r_struct
id|rbd_struct
op_star
)paren
id|make32
c_func
(paren
id|p-&gt;rfd_top-&gt;rbd_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|STAT_OK
)paren
(brace
multiline_comment|/* frame received without error? */
r_if
c_cond
(paren
(paren
id|totlen
op_assign
id|rbd-&gt;status
)paren
op_amp
id|RBD_LAST
)paren
(brace
multiline_comment|/* the first and the last buffer? */
id|totlen
op_and_assign
id|RBD_MASK
suffix:semicolon
multiline_comment|/* length of this frame */
id|rbd-&gt;status
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|dev_alloc_skb
c_func
(paren
id|totlen
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte alignment */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|totlen
)paren
comma
(paren
id|u8
op_star
)paren
id|phys_to_virt
c_func
(paren
id|p-&gt;base
)paren
op_plus
(paren
r_int
r_int
)paren
id|rbd-&gt;buffer
comma
id|totlen
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|p-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|p-&gt;stats.rx_bytes
op_add_assign
id|totlen
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: received oversized frame.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* frame !(ok), only with &squot;save-bad-frames&squot; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: oops! rfd-error-status: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
id|p-&gt;rfd_top-&gt;status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;rfd_top-&gt;last
op_assign
id|RFD_SUSP
suffix:semicolon
id|p-&gt;rfd_last-&gt;last
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* delete RU_SUSP  */
id|p-&gt;rfd_last
op_assign
id|p-&gt;rfd_top
suffix:semicolon
id|p-&gt;rfd_top
op_assign
(paren
r_struct
id|rfd_struct
op_star
)paren
id|make32
c_func
(paren
id|p-&gt;rfd_top-&gt;next
)paren
suffix:semicolon
multiline_comment|/* step to next RFD */
)brace
)brace
multiline_comment|/**********************************************************&n; * handle &squot;Receiver went not ready&squot;.&n; */
DECL|function|elmc_rnr_int
r_static
r_void
id|elmc_rnr_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for the last cmd */
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_ABORT
suffix:semicolon
multiline_comment|/* usually the RU is in the &squot;no resource&squot;-state .. abort it now. */
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for accept cmd. */
id|alloc_rfa
c_func
(paren
id|dev
comma
(paren
r_char
op_star
)paren
id|p-&gt;rfd_first
)paren
suffix:semicolon
id|startrecv586
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* restart RU */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Receive-Unit restarted. Status: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************&n; * handle xmit - interrupt&n; */
DECL|function|elmc_xmt_int
r_static
r_void
id|elmc_xmt_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status
op_assign
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_last
)braket
op_member_access_from_pointer
id|cmd_status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|STAT_COMPL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: strange .. xmit-int without a &squot;COMPLETE&squot;&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_OK
)paren
(brace
id|p-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|p-&gt;stats.collisions
op_add_assign
(paren
id|status
op_amp
id|TCMD_MAXCOLLMASK
)paren
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_LATECOLL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: late collision detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_NOCARRIER
)paren
(brace
id|p-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: no carrier detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_LOSTCTS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: loss of CTS detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_UNDERRUN
)paren
(brace
id|p-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: DMA underrun detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|TCMD_MAXCOLL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Max. collisions exceeded.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p-&gt;stats.collisions
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
macro_line|#if (NUM_XMIT_BUFFS != 1)
r_if
c_cond
(paren
(paren
op_increment
id|p-&gt;xmit_last
)paren
op_eq
id|NUM_XMIT_BUFFS
)paren
(brace
id|p-&gt;xmit_last
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************&n; * (re)start the receiver&n; */
DECL|function|startrecv586
r_static
r_void
id|startrecv586
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p-&gt;scb-&gt;rfa_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;rfd_first
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|RUC_START
suffix:semicolon
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* start cmd. */
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for accept cmd. (no timeout!!) */
)brace
multiline_comment|/******************************************************&n; * timeout&n; */
DECL|function|elmc_timeout
r_static
r_void
id|elmc_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* COMMAND-UNIT active? */
r_if
c_cond
(paren
id|p-&gt;scb-&gt;status
op_amp
id|CU_ACTIVE
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;%s: strange ... timeout with CU active?!?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: X0: %04x N0: %04x N1: %04x %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
comma
(paren
r_int
)paren
id|p-&gt;nop_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
comma
(paren
r_int
)paren
id|p-&gt;nop_cmds
(braket
l_int|1
)braket
op_member_access_from_pointer
id|cmd_status
comma
(paren
r_int
)paren
id|p-&gt;nop_point
)paren
suffix:semicolon
macro_line|#endif
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_ABORT
suffix:semicolon
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;nop_cmds
(braket
id|p-&gt;nop_point
)braket
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;%s: xmitter timed out, try to restart! stat: %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p-&gt;scb-&gt;status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: command-stats: %04x %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
comma
id|p-&gt;xmit_cmds
(braket
l_int|1
)braket
op_member_access_from_pointer
id|cmd_status
)paren
suffix:semicolon
macro_line|#endif
id|elmc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|elmc_open
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************&n; * send frame&n; */
DECL|function|elmc_send_packet
r_static
r_int
id|elmc_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|len
suffix:semicolon
macro_line|#ifndef NO_NOPCOMMANDS
r_int
id|next_nop
suffix:semicolon
macro_line|#endif
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|p-&gt;xmit_cbuffs
(braket
id|p-&gt;xmit_count
)braket
comma
(paren
r_char
op_star
)paren
(paren
id|skb-&gt;data
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|len
op_assign
(paren
id|ETH_ZLEN
OL
id|skb-&gt;len
)paren
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
macro_line|#if (NUM_XMIT_BUFFS == 1)
macro_line|#ifdef NO_NOPCOMMANDS
id|p-&gt;xmit_buffs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|size
op_assign
id|TBD_LAST
op_or
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;scb-&gt;cbl_offset
op_assign
id|make16
c_func
(paren
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p-&gt;scb-&gt;cmd
op_assign
id|CUC_START
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|elmc_attn586
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|WAIT_4_SCB_CMD
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p-&gt;scb-&gt;status
op_amp
id|CU_ACTIVE
)paren
)paren
(brace
multiline_comment|/* test it, because CU sometimes doesn&squot;t start immediately */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|15
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t start transmit-command.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
id|next_nop
op_assign
(paren
id|p-&gt;nop_point
op_plus
l_int|1
)paren
op_amp
l_int|0x1
suffix:semicolon
id|p-&gt;xmit_buffs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|size
op_assign
id|TBD_LAST
op_or
id|len
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
)paren
)paren
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|p-&gt;nop_point
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;xmit_cmds
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|p-&gt;nop_point
op_assign
id|next_nop
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
macro_line|#else
id|p-&gt;xmit_buffs
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|size
op_assign
id|TBD_LAST
op_or
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|next_nop
op_assign
id|p-&gt;xmit_count
op_plus
l_int|1
)paren
op_eq
id|NUM_XMIT_BUFFS
)paren
(brace
id|next_nop
op_assign
l_int|0
suffix:semicolon
)brace
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
)paren
)paren
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|next_nop
)braket
op_member_access_from_pointer
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|p-&gt;nop_cmds
(braket
id|p-&gt;xmit_count
)braket
op_member_access_from_pointer
id|cmd_link
op_assign
id|make16
c_func
(paren
(paren
id|p-&gt;xmit_cmds
(braket
id|p-&gt;xmit_count
)braket
)paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|p-&gt;xmit_count
op_assign
id|next_nop
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;xmit_count
op_ne
id|p-&gt;xmit_last
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*******************************************&n; * Someone wanna have the statistics&n; */
DECL|function|elmc_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|elmc_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|priv
op_star
id|p
op_assign
(paren
r_struct
id|priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|crc
comma
id|aln
comma
id|rsc
comma
id|ovrn
suffix:semicolon
id|crc
op_assign
id|p-&gt;scb-&gt;crc_errs
suffix:semicolon
multiline_comment|/* get error-statistic from the ni82586 */
id|p-&gt;scb-&gt;crc_errs
op_sub_assign
id|crc
suffix:semicolon
id|aln
op_assign
id|p-&gt;scb-&gt;aln_errs
suffix:semicolon
id|p-&gt;scb-&gt;aln_errs
op_sub_assign
id|aln
suffix:semicolon
id|rsc
op_assign
id|p-&gt;scb-&gt;rsc_errs
suffix:semicolon
id|p-&gt;scb-&gt;rsc_errs
op_sub_assign
id|rsc
suffix:semicolon
id|ovrn
op_assign
id|p-&gt;scb-&gt;ovrn_errs
suffix:semicolon
id|p-&gt;scb-&gt;ovrn_errs
op_sub_assign
id|ovrn
suffix:semicolon
id|p-&gt;stats.rx_crc_errors
op_add_assign
id|crc
suffix:semicolon
id|p-&gt;stats.rx_fifo_errors
op_add_assign
id|ovrn
suffix:semicolon
id|p-&gt;stats.rx_frame_errors
op_add_assign
id|aln
suffix:semicolon
id|p-&gt;stats.rx_dropped
op_add_assign
id|rsc
suffix:semicolon
r_return
op_amp
id|p-&gt;stats
suffix:semicolon
)brace
multiline_comment|/********************************************************&n; * Set MC list ..&n; */
macro_line|#ifdef ELMC_MULTICAST
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;start
)paren
(brace
multiline_comment|/* without a running interface, promiscuous doesn&squot;t work */
r_return
suffix:semicolon
)brace
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|alloc586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|startrecv586
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*************************************************************************/
macro_line|#ifdef MODULE
multiline_comment|/* Increase if needed ;) */
DECL|macro|MAX_3C523_CARDS
mdefine_line|#define MAX_3C523_CARDS 4
DECL|variable|dev_elmc
r_static
r_struct
id|net_device
id|dev_elmc
(braket
id|MAX_3C523_CARDS
)braket
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|MAX_3C523_CARDS
)braket
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
id|MAX_3C523_CARDS
)braket
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_3C523_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_3C523_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
comma
id|found
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Loop until we either can&squot;t find any more cards, or we have MAX_3C523_CARDS */
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|MAX_3C523_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_elmc
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|io
(braket
id|this_dev
)braket
suffix:semicolon
id|dev-&gt;init
op_assign
id|elmc_probe
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|io
(braket
id|this_dev
)braket
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3c523.c: No 3c523 card found at io=%#x&bslash;n&quot;
comma
id|io
(braket
id|this_dev
)braket
)paren
suffix:semicolon
)brace
r_else
id|found
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|io
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3c523.c: No 3c523 cards found&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|this_dev
suffix:semicolon
r_for
c_loop
(paren
id|this_dev
op_assign
l_int|0
suffix:semicolon
id|this_dev
OL
id|MAX_3C523_CARDS
suffix:semicolon
id|this_dev
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|dev_elmc
(braket
id|this_dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
multiline_comment|/* shutdown interrupts on the card */
id|elmc_id_reset586
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_ne
l_int|0
)paren
(brace
multiline_comment|/* this should be done by close, but if we failed to&n;&t;&t;&t;&t;   initialize properly something may have gotten hosed. */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_ne
l_int|0
)paren
(brace
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|ELMC_IO_EXTENT
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
)brace
id|irq
(braket
id|this_dev
)braket
op_assign
l_int|0
suffix:semicolon
id|io
(braket
id|this_dev
)braket
op_assign
l_int|0
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
(paren
(paren
r_struct
id|priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slot
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
eof
