multiline_comment|/*&n;   dmfe.c: Version 1.30 06/11/2000&n;&n;   A Davicom DM9102(A)/DM9132/DM9801 fast ethernet driver for Linux. &n;   Copyright (C) 1997  Sten Wang&n;   (C)Copyright 1997-1998 DAVICOM Semiconductor,Inc. All Rights Reserved.&n;&n;   This program is free software; you can redistribute it and/or&n;   modify it under the terms of the GNU General Public License&n;   as published by the Free Software Foundation; either version 2&n;   of the License, or (at your option) any later version.&n;&n;   This program is distributed in the hope that it will be useful,&n;   but WITHOUT ANY WARRANTY; without even the implied warranty of&n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;   GNU General Public License for more details.&n;&n;&n;   Compiler command:&n;   &quot;gcc -DMODULE -D__KERNEL__ -I/usr/src/linux/net/inet -Wall &n;   -Wstrict-prototypes -O6 -c dmfe.c&quot;&n;   OR&n;   &quot;gcc -DMODULE -D__KERNEL__ -I/usr/src/linux/net -Wall &n;   -Wstrict-prototypes -O6 -c dmfe.c&quot;&n;&n;   The following steps teach you how to active DM9102 board:&n;   1. Used the upper compiler command to compile dmfe.c&n;   2. insert dmfe module into kernel&n;   &quot;insmod dmfe&quot;        ;;Auto Detection Mode&n;   &quot;insmod dmfe mode=0&quot; ;;Force 10M Half Duplex&n;   &quot;insmod dmfe mode=1&quot; ;;Force 100M Half Duplex&n;   &quot;insmod dmfe mode=4&quot; ;;Force 10M Full Duplex&n;   &quot;insmod dmfe mode=5&quot; ;;Force 100M Full Duplex&n;   3. config a dm9102 network interface&n;   &quot;ifconfig eth0 172.22.3.18&quot;&n;   4. active the IP routing table&n;   &quot;route add -net 172.22.3.0 eth0&quot;&n;   5. Well done. Your DM9102 adapter actived now.&n;&n;   Author: Sten Wang, 886-3-5798797-8517, E-mail: sten_wang@davicom.com.tw&n;&n;   Date:   10/28,1998&n;&n;   (C)Copyright 1997-1998 DAVICOM Semiconductor, Inc. All Rights Reserved.&n;&n;   Marcelo Tosatti &lt;marcelo@conectiva.com.br&gt; : &n;   Made it compile in 2.3 (device to net_device)&n;   &n;   Alan Cox &lt;alan@redhat.com&gt; :&n;   Cleaned up for kernel merge.&n;   Removed the back compatibility support&n;   Reformatted, fixing spelling etc as I went&n;   Removed IRQ 0-15 assumption&n;&n;   Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt; :&n;   Updated to use new PCI driver API.&n;   Resource usage cleanups.&n;   Report driver version to user.&n;&n;   TODO&n;&n;   Implement pci_driver::suspend() and pci_driver::resume()&n;   power management methods.&n;&n;   Check and fix on 64bit and big endian boxes.&n;&n;   Test and make sure PCI latency is now correct for all cases.&n;&n; */
DECL|macro|DMFE_VERSION
mdefine_line|#define DMFE_VERSION &quot;1.30 (June 11, 2000)&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
multiline_comment|/* Board/System/Debug information/definition ---------------- */
DECL|macro|PCI_DM9132_ID
mdefine_line|#define PCI_DM9132_ID   0x91321282&t;/* Davicom DM9132 ID */
DECL|macro|PCI_DM9102_ID
mdefine_line|#define PCI_DM9102_ID   0x91021282&t;/* Davicom DM9102 ID */
DECL|macro|PCI_DM9100_ID
mdefine_line|#define PCI_DM9100_ID   0x91001282&t;/* Davicom DM9100 ID */
DECL|macro|DMFE_SUCC
mdefine_line|#define DMFE_SUCC       0
DECL|macro|DM9102_IO_SIZE
mdefine_line|#define DM9102_IO_SIZE  0x80
DECL|macro|DM9102A_IO_SIZE
mdefine_line|#define DM9102A_IO_SIZE 0x100
DECL|macro|TX_FREE_DESC_CNT
mdefine_line|#define TX_FREE_DESC_CNT 0xc&t;/* Tx packet count */
DECL|macro|TX_MAX_SEND_CNT
mdefine_line|#define TX_MAX_SEND_CNT 0x1&t;/* Maximum tx packet per time */
DECL|macro|TX_DESC_CNT
mdefine_line|#define TX_DESC_CNT     0x10&t;/* Allocated Tx descriptors */
DECL|macro|RX_DESC_CNT
mdefine_line|#define RX_DESC_CNT     0x10&t;/* Allocated Rx descriptors */
DECL|macro|DESC_ALL_CNT
mdefine_line|#define DESC_ALL_CNT    TX_DESC_CNT+RX_DESC_CNT
DECL|macro|TX_BUF_ALLOC
mdefine_line|#define TX_BUF_ALLOC    0x600
DECL|macro|RX_ALLOC_SIZE
mdefine_line|#define RX_ALLOC_SIZE   0x620
DECL|macro|DM910X_RESET
mdefine_line|#define DM910X_RESET    1
DECL|macro|CR6_DEFAULT
mdefine_line|#define CR6_DEFAULT     0x00280000&t;/* SF, HD */
DECL|macro|CR7_DEFAULT
mdefine_line|#define CR7_DEFAULT     0x1a2cd
DECL|macro|CR15_DEFAULT
mdefine_line|#define CR15_DEFAULT    0x06&t;/* TxJabber RxWatchdog */
DECL|macro|TDES0_ERR_MASK
mdefine_line|#define TDES0_ERR_MASK  0x4302&t;/* TXJT, LC, EC, FUE */
DECL|macro|MAX_PACKET_SIZE
mdefine_line|#define MAX_PACKET_SIZE 1514
DECL|macro|DMFE_MAX_MULTICAST
mdefine_line|#define DMFE_MAX_MULTICAST 14
DECL|macro|RX_MAX_TRAFFIC
mdefine_line|#define RX_MAX_TRAFFIC  0x14000
DECL|macro|MAX_CHECK_PACKET
mdefine_line|#define MAX_CHECK_PACKET 0x8000
DECL|macro|DMFE_10MHF
mdefine_line|#define DMFE_10MHF      0
DECL|macro|DMFE_100MHF
mdefine_line|#define DMFE_100MHF     1
DECL|macro|DMFE_10MFD
mdefine_line|#define DMFE_10MFD      4
DECL|macro|DMFE_100MFD
mdefine_line|#define DMFE_100MFD     5
DECL|macro|DMFE_AUTO
mdefine_line|#define DMFE_AUTO       8
DECL|macro|DMFE_TIMER_WUT
mdefine_line|#define DMFE_TIMER_WUT  jiffies+(HZ*2)/2&t;/* timer wakeup time : 1 second */
DECL|macro|DMFE_TX_TIMEOUT
mdefine_line|#define DMFE_TX_TIMEOUT ((HZ*3)/2)&t;/* tx packet time-out time 1.5 s&quot; */
DECL|macro|DMFE_DBUG
mdefine_line|#define DMFE_DBUG(dbug_now, msg, vaule) if (dmfe_debug || dbug_now) printk(&quot;DBUG: %s %x&bslash;n&quot;, msg, vaule)
DECL|macro|DELAY_5US
mdefine_line|#define DELAY_5US udelay(5)&t;/* udelay scale 1 usec */
DECL|macro|DELAY_1US
mdefine_line|#define DELAY_1US udelay(1)&t;/* udelay scale 1 usec */
DECL|macro|SHOW_MEDIA_TYPE
mdefine_line|#define SHOW_MEDIA_TYPE(mode) printk(KERN_WARNING &quot;dmfe: Change Speed to %sMhz %s duplex&bslash;n&quot;,mode &amp; 1 ?&quot;100&quot;:&quot;10&quot;, mode &amp; 4 ? &quot;full&quot;:&quot;half&quot;);
multiline_comment|/* CR9 definition: SROM/MII */
DECL|macro|CR9_SROM_READ
mdefine_line|#define CR9_SROM_READ   0x4800
DECL|macro|CR9_SRCS
mdefine_line|#define CR9_SRCS        0x1
DECL|macro|CR9_SRCLK
mdefine_line|#define CR9_SRCLK       0x2
DECL|macro|CR9_CRDOUT
mdefine_line|#define CR9_CRDOUT      0x8
DECL|macro|SROM_DATA_0
mdefine_line|#define SROM_DATA_0     0x0
DECL|macro|SROM_DATA_1
mdefine_line|#define SROM_DATA_1     0x4
DECL|macro|PHY_DATA_1
mdefine_line|#define PHY_DATA_1      0x20000
DECL|macro|PHY_DATA_0
mdefine_line|#define PHY_DATA_0      0x00000
DECL|macro|MDCLKH
mdefine_line|#define MDCLKH          0x10000
DECL|macro|SROM_CLK_WRITE
mdefine_line|#define SROM_CLK_WRITE(data, ioaddr) outl(data|CR9_SROM_READ|CR9_SRCS,ioaddr);DELAY_5US;outl(data|CR9_SROM_READ|CR9_SRCS|CR9_SRCLK,ioaddr);DELAY_5US;outl(data|CR9_SROM_READ|CR9_SRCS,ioaddr);DELAY_5US;
DECL|macro|__CHK_IO_SIZE
mdefine_line|#define __CHK_IO_SIZE(pci_id, dev_rev) ( ((pci_id)==PCI_DM9132_ID) || ((dev_rev) &gt;= 0x02000030) ) ? DM9102A_IO_SIZE: DM9102_IO_SIZE
DECL|macro|CHK_IO_SIZE
mdefine_line|#define CHK_IO_SIZE(pci_dev, dev_rev) &bslash;&n;&t;__CHK_IO_SIZE(((pci_dev)-&gt;device &lt;&lt; 16) | (pci_dev)-&gt;vendor, dev_rev)
multiline_comment|/* Structure/enum declaration ------------------------------- */
DECL|struct|tx_desc
r_struct
id|tx_desc
(brace
DECL|member|tdes0
DECL|member|tdes1
DECL|member|tdes2
DECL|member|tdes3
id|u32
id|tdes0
comma
id|tdes1
comma
id|tdes2
comma
id|tdes3
suffix:semicolon
DECL|member|tx_skb_ptr
id|u32
id|tx_skb_ptr
suffix:semicolon
DECL|member|tx_buf_ptr
id|u32
id|tx_buf_ptr
suffix:semicolon
DECL|member|next_tx_desc
id|u32
id|next_tx_desc
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rx_desc
r_struct
id|rx_desc
(brace
DECL|member|rdes0
DECL|member|rdes1
DECL|member|rdes2
DECL|member|rdes3
id|u32
id|rdes0
comma
id|rdes1
comma
id|rdes2
comma
id|rdes3
suffix:semicolon
DECL|member|rx_skb_ptr
id|u32
id|rx_skb_ptr
suffix:semicolon
DECL|member|rx_buf_ptr
id|u32
id|rx_buf_ptr
suffix:semicolon
DECL|member|next_rx_desc
id|u32
id|next_rx_desc
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|dmfe_board_info
r_struct
id|dmfe_board_info
(brace
DECL|member|chip_id
id|u32
id|chip_id
suffix:semicolon
multiline_comment|/* Chip vendor/Device ID */
DECL|member|chip_revision
id|u32
id|chip_revision
suffix:semicolon
multiline_comment|/* Chip revision */
DECL|member|next_dev
r_struct
id|net_device
op_star
id|next_dev
suffix:semicolon
multiline_comment|/* next device */
DECL|member|net_dev
r_struct
id|pci_dev
op_star
id|net_dev
suffix:semicolon
multiline_comment|/* PCI device */
DECL|member|ioaddr
r_int
r_int
id|ioaddr
suffix:semicolon
multiline_comment|/* I/O base address */
DECL|member|cr0_data
id|u32
id|cr0_data
suffix:semicolon
DECL|member|cr5_data
id|u32
id|cr5_data
suffix:semicolon
DECL|member|cr6_data
id|u32
id|cr6_data
suffix:semicolon
DECL|member|cr7_data
id|u32
id|cr7_data
suffix:semicolon
DECL|member|cr15_data
id|u32
id|cr15_data
suffix:semicolon
multiline_comment|/* descriptor pointer */
DECL|member|buf_pool_ptr
r_int
r_char
op_star
id|buf_pool_ptr
suffix:semicolon
multiline_comment|/* Tx buffer pool memory */
DECL|member|buf_pool_start
r_int
r_char
op_star
id|buf_pool_start
suffix:semicolon
multiline_comment|/* Tx buffer pool align dword */
DECL|member|desc_pool_ptr
r_int
r_char
op_star
id|desc_pool_ptr
suffix:semicolon
multiline_comment|/* descriptor pool memory */
DECL|member|first_tx_desc
r_struct
id|tx_desc
op_star
id|first_tx_desc
suffix:semicolon
DECL|member|tx_insert_ptr
r_struct
id|tx_desc
op_star
id|tx_insert_ptr
suffix:semicolon
DECL|member|tx_remove_ptr
r_struct
id|tx_desc
op_star
id|tx_remove_ptr
suffix:semicolon
DECL|member|first_rx_desc
r_struct
id|rx_desc
op_star
id|first_rx_desc
suffix:semicolon
DECL|member|rx_insert_ptr
r_struct
id|rx_desc
op_star
id|rx_insert_ptr
suffix:semicolon
DECL|member|rx_ready_ptr
r_struct
id|rx_desc
op_star
id|rx_ready_ptr
suffix:semicolon
multiline_comment|/* packet come pointer */
DECL|member|tx_packet_cnt
id|u32
id|tx_packet_cnt
suffix:semicolon
multiline_comment|/* transmitted packet count */
DECL|member|tx_queue_cnt
id|u32
id|tx_queue_cnt
suffix:semicolon
multiline_comment|/* wait to send packet count */
DECL|member|rx_avail_cnt
id|u32
id|rx_avail_cnt
suffix:semicolon
multiline_comment|/* available rx descriptor count */
DECL|member|interval_rx_cnt
id|u32
id|interval_rx_cnt
suffix:semicolon
multiline_comment|/* rx packet count a callback time */
DECL|member|phy_id2
id|u16
id|phy_id2
suffix:semicolon
multiline_comment|/* Phyxcer ID2 */
DECL|member|media_mode
id|u8
id|media_mode
suffix:semicolon
multiline_comment|/* user specify media mode */
DECL|member|op_mode
id|u8
id|op_mode
suffix:semicolon
multiline_comment|/* real work media mode */
DECL|member|phy_addr
id|u8
id|phy_addr
suffix:semicolon
DECL|member|link_failed
id|u8
id|link_failed
suffix:semicolon
multiline_comment|/* Ever link failed */
DECL|member|wait_reset
id|u8
id|wait_reset
suffix:semicolon
multiline_comment|/* Hardware failed, need to reset */
DECL|member|in_reset_state
id|u8
id|in_reset_state
suffix:semicolon
multiline_comment|/* Now driver in reset routine */
DECL|member|rx_error_cnt
id|u8
id|rx_error_cnt
suffix:semicolon
multiline_comment|/* recievd abnormal case count */
DECL|member|dm910x_chk_mode
id|u8
id|dm910x_chk_mode
suffix:semicolon
multiline_comment|/* Operating mode check */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* statistic counter */
DECL|member|srom
r_int
r_char
id|srom
(braket
l_int|128
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|dmfe_offsets
r_enum
id|dmfe_offsets
(brace
DECL|enumerator|DCR0
DECL|enumerator|DCR1
DECL|enumerator|DCR2
DECL|enumerator|DCR3
DECL|enumerator|DCR4
DECL|enumerator|DCR5
id|DCR0
op_assign
l_int|0
comma
id|DCR1
op_assign
l_int|0x08
comma
id|DCR2
op_assign
l_int|0x10
comma
id|DCR3
op_assign
l_int|0x18
comma
id|DCR4
op_assign
l_int|0x20
comma
id|DCR5
op_assign
l_int|0x28
comma
DECL|enumerator|DCR6
DECL|enumerator|DCR7
DECL|enumerator|DCR8
DECL|enumerator|DCR9
DECL|enumerator|DCR10
DECL|enumerator|DCR11
id|DCR6
op_assign
l_int|0x30
comma
id|DCR7
op_assign
l_int|0x38
comma
id|DCR8
op_assign
l_int|0x40
comma
id|DCR9
op_assign
l_int|0x48
comma
id|DCR10
op_assign
l_int|0x50
comma
id|DCR11
op_assign
l_int|0x58
comma
DECL|enumerator|DCR12
DECL|enumerator|DCR13
DECL|enumerator|DCR14
DECL|enumerator|DCR15
id|DCR12
op_assign
l_int|0x60
comma
id|DCR13
op_assign
l_int|0x68
comma
id|DCR14
op_assign
l_int|0x70
comma
id|DCR15
op_assign
l_int|0x78
)brace
suffix:semicolon
DECL|enum|dmfe_CR6_bits
r_enum
id|dmfe_CR6_bits
(brace
DECL|enumerator|CR6_RXSC
DECL|enumerator|CR6_PBF
DECL|enumerator|CR6_PM
DECL|enumerator|CR6_PAM
DECL|enumerator|CR6_FDM
id|CR6_RXSC
op_assign
l_int|0x2
comma
id|CR6_PBF
op_assign
l_int|0x8
comma
id|CR6_PM
op_assign
l_int|0x40
comma
id|CR6_PAM
op_assign
l_int|0x80
comma
id|CR6_FDM
op_assign
l_int|0x200
comma
DECL|enumerator|CR6_TXSC
DECL|enumerator|CR6_STI
DECL|enumerator|CR6_SFT
DECL|enumerator|CR6_RXA
id|CR6_TXSC
op_assign
l_int|0x2000
comma
id|CR6_STI
op_assign
l_int|0x100000
comma
id|CR6_SFT
op_assign
l_int|0x200000
comma
id|CR6_RXA
op_assign
l_int|0x40000000
comma
DECL|enumerator|CR6_NO_PURGE
id|CR6_NO_PURGE
op_assign
l_int|0x20000000
)brace
suffix:semicolon
multiline_comment|/* Global variable declaration ----------------------------- */
DECL|variable|dmfe_debug
r_static
r_int
id|dmfe_debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|dmfe_media_mode
r_static
r_int
r_char
id|dmfe_media_mode
op_assign
l_int|8
suffix:semicolon
DECL|variable|dmfe_cr6_user_set
r_static
id|u32
id|dmfe_cr6_user_set
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* For module input parameter */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|cr6set
r_static
id|u32
id|cr6set
op_assign
l_int|0
suffix:semicolon
DECL|variable|mode
r_static
r_int
r_char
id|mode
op_assign
l_int|8
suffix:semicolon
DECL|variable|chkmode
r_static
id|u8
id|chkmode
op_assign
l_int|1
suffix:semicolon
DECL|variable|CrcTable
r_static
r_int
r_int
id|CrcTable
(braket
l_int|256
)braket
op_assign
(brace
l_int|0x00000000L
comma
l_int|0x77073096L
comma
l_int|0xEE0E612CL
comma
l_int|0x990951BAL
comma
l_int|0x076DC419L
comma
l_int|0x706AF48FL
comma
l_int|0xE963A535L
comma
l_int|0x9E6495A3L
comma
l_int|0x0EDB8832L
comma
l_int|0x79DCB8A4L
comma
l_int|0xE0D5E91EL
comma
l_int|0x97D2D988L
comma
l_int|0x09B64C2BL
comma
l_int|0x7EB17CBDL
comma
l_int|0xE7B82D07L
comma
l_int|0x90BF1D91L
comma
l_int|0x1DB71064L
comma
l_int|0x6AB020F2L
comma
l_int|0xF3B97148L
comma
l_int|0x84BE41DEL
comma
l_int|0x1ADAD47DL
comma
l_int|0x6DDDE4EBL
comma
l_int|0xF4D4B551L
comma
l_int|0x83D385C7L
comma
l_int|0x136C9856L
comma
l_int|0x646BA8C0L
comma
l_int|0xFD62F97AL
comma
l_int|0x8A65C9ECL
comma
l_int|0x14015C4FL
comma
l_int|0x63066CD9L
comma
l_int|0xFA0F3D63L
comma
l_int|0x8D080DF5L
comma
l_int|0x3B6E20C8L
comma
l_int|0x4C69105EL
comma
l_int|0xD56041E4L
comma
l_int|0xA2677172L
comma
l_int|0x3C03E4D1L
comma
l_int|0x4B04D447L
comma
l_int|0xD20D85FDL
comma
l_int|0xA50AB56BL
comma
l_int|0x35B5A8FAL
comma
l_int|0x42B2986CL
comma
l_int|0xDBBBC9D6L
comma
l_int|0xACBCF940L
comma
l_int|0x32D86CE3L
comma
l_int|0x45DF5C75L
comma
l_int|0xDCD60DCFL
comma
l_int|0xABD13D59L
comma
l_int|0x26D930ACL
comma
l_int|0x51DE003AL
comma
l_int|0xC8D75180L
comma
l_int|0xBFD06116L
comma
l_int|0x21B4F4B5L
comma
l_int|0x56B3C423L
comma
l_int|0xCFBA9599L
comma
l_int|0xB8BDA50FL
comma
l_int|0x2802B89EL
comma
l_int|0x5F058808L
comma
l_int|0xC60CD9B2L
comma
l_int|0xB10BE924L
comma
l_int|0x2F6F7C87L
comma
l_int|0x58684C11L
comma
l_int|0xC1611DABL
comma
l_int|0xB6662D3DL
comma
l_int|0x76DC4190L
comma
l_int|0x01DB7106L
comma
l_int|0x98D220BCL
comma
l_int|0xEFD5102AL
comma
l_int|0x71B18589L
comma
l_int|0x06B6B51FL
comma
l_int|0x9FBFE4A5L
comma
l_int|0xE8B8D433L
comma
l_int|0x7807C9A2L
comma
l_int|0x0F00F934L
comma
l_int|0x9609A88EL
comma
l_int|0xE10E9818L
comma
l_int|0x7F6A0DBBL
comma
l_int|0x086D3D2DL
comma
l_int|0x91646C97L
comma
l_int|0xE6635C01L
comma
l_int|0x6B6B51F4L
comma
l_int|0x1C6C6162L
comma
l_int|0x856530D8L
comma
l_int|0xF262004EL
comma
l_int|0x6C0695EDL
comma
l_int|0x1B01A57BL
comma
l_int|0x8208F4C1L
comma
l_int|0xF50FC457L
comma
l_int|0x65B0D9C6L
comma
l_int|0x12B7E950L
comma
l_int|0x8BBEB8EAL
comma
l_int|0xFCB9887CL
comma
l_int|0x62DD1DDFL
comma
l_int|0x15DA2D49L
comma
l_int|0x8CD37CF3L
comma
l_int|0xFBD44C65L
comma
l_int|0x4DB26158L
comma
l_int|0x3AB551CEL
comma
l_int|0xA3BC0074L
comma
l_int|0xD4BB30E2L
comma
l_int|0x4ADFA541L
comma
l_int|0x3DD895D7L
comma
l_int|0xA4D1C46DL
comma
l_int|0xD3D6F4FBL
comma
l_int|0x4369E96AL
comma
l_int|0x346ED9FCL
comma
l_int|0xAD678846L
comma
l_int|0xDA60B8D0L
comma
l_int|0x44042D73L
comma
l_int|0x33031DE5L
comma
l_int|0xAA0A4C5FL
comma
l_int|0xDD0D7CC9L
comma
l_int|0x5005713CL
comma
l_int|0x270241AAL
comma
l_int|0xBE0B1010L
comma
l_int|0xC90C2086L
comma
l_int|0x5768B525L
comma
l_int|0x206F85B3L
comma
l_int|0xB966D409L
comma
l_int|0xCE61E49FL
comma
l_int|0x5EDEF90EL
comma
l_int|0x29D9C998L
comma
l_int|0xB0D09822L
comma
l_int|0xC7D7A8B4L
comma
l_int|0x59B33D17L
comma
l_int|0x2EB40D81L
comma
l_int|0xB7BD5C3BL
comma
l_int|0xC0BA6CADL
comma
l_int|0xEDB88320L
comma
l_int|0x9ABFB3B6L
comma
l_int|0x03B6E20CL
comma
l_int|0x74B1D29AL
comma
l_int|0xEAD54739L
comma
l_int|0x9DD277AFL
comma
l_int|0x04DB2615L
comma
l_int|0x73DC1683L
comma
l_int|0xE3630B12L
comma
l_int|0x94643B84L
comma
l_int|0x0D6D6A3EL
comma
l_int|0x7A6A5AA8L
comma
l_int|0xE40ECF0BL
comma
l_int|0x9309FF9DL
comma
l_int|0x0A00AE27L
comma
l_int|0x7D079EB1L
comma
l_int|0xF00F9344L
comma
l_int|0x8708A3D2L
comma
l_int|0x1E01F268L
comma
l_int|0x6906C2FEL
comma
l_int|0xF762575DL
comma
l_int|0x806567CBL
comma
l_int|0x196C3671L
comma
l_int|0x6E6B06E7L
comma
l_int|0xFED41B76L
comma
l_int|0x89D32BE0L
comma
l_int|0x10DA7A5AL
comma
l_int|0x67DD4ACCL
comma
l_int|0xF9B9DF6FL
comma
l_int|0x8EBEEFF9L
comma
l_int|0x17B7BE43L
comma
l_int|0x60B08ED5L
comma
l_int|0xD6D6A3E8L
comma
l_int|0xA1D1937EL
comma
l_int|0x38D8C2C4L
comma
l_int|0x4FDFF252L
comma
l_int|0xD1BB67F1L
comma
l_int|0xA6BC5767L
comma
l_int|0x3FB506DDL
comma
l_int|0x48B2364BL
comma
l_int|0xD80D2BDAL
comma
l_int|0xAF0A1B4CL
comma
l_int|0x36034AF6L
comma
l_int|0x41047A60L
comma
l_int|0xDF60EFC3L
comma
l_int|0xA867DF55L
comma
l_int|0x316E8EEFL
comma
l_int|0x4669BE79L
comma
l_int|0xCB61B38CL
comma
l_int|0xBC66831AL
comma
l_int|0x256FD2A0L
comma
l_int|0x5268E236L
comma
l_int|0xCC0C7795L
comma
l_int|0xBB0B4703L
comma
l_int|0x220216B9L
comma
l_int|0x5505262FL
comma
l_int|0xC5BA3BBEL
comma
l_int|0xB2BD0B28L
comma
l_int|0x2BB45A92L
comma
l_int|0x5CB36A04L
comma
l_int|0xC2D7FFA7L
comma
l_int|0xB5D0CF31L
comma
l_int|0x2CD99E8BL
comma
l_int|0x5BDEAE1DL
comma
l_int|0x9B64C2B0L
comma
l_int|0xEC63F226L
comma
l_int|0x756AA39CL
comma
l_int|0x026D930AL
comma
l_int|0x9C0906A9L
comma
l_int|0xEB0E363FL
comma
l_int|0x72076785L
comma
l_int|0x05005713L
comma
l_int|0x95BF4A82L
comma
l_int|0xE2B87A14L
comma
l_int|0x7BB12BAEL
comma
l_int|0x0CB61B38L
comma
l_int|0x92D28E9BL
comma
l_int|0xE5D5BE0DL
comma
l_int|0x7CDCEFB7L
comma
l_int|0x0BDBDF21L
comma
l_int|0x86D3D2D4L
comma
l_int|0xF1D4E242L
comma
l_int|0x68DDB3F8L
comma
l_int|0x1FDA836EL
comma
l_int|0x81BE16CDL
comma
l_int|0xF6B9265BL
comma
l_int|0x6FB077E1L
comma
l_int|0x18B74777L
comma
l_int|0x88085AE6L
comma
l_int|0xFF0F6A70L
comma
l_int|0x66063BCAL
comma
l_int|0x11010B5CL
comma
l_int|0x8F659EFFL
comma
l_int|0xF862AE69L
comma
l_int|0x616BFFD3L
comma
l_int|0x166CCF45L
comma
l_int|0xA00AE278L
comma
l_int|0xD70DD2EEL
comma
l_int|0x4E048354L
comma
l_int|0x3903B3C2L
comma
l_int|0xA7672661L
comma
l_int|0xD06016F7L
comma
l_int|0x4969474DL
comma
l_int|0x3E6E77DBL
comma
l_int|0xAED16A4AL
comma
l_int|0xD9D65ADCL
comma
l_int|0x40DF0B66L
comma
l_int|0x37D83BF0L
comma
l_int|0xA9BCAE53L
comma
l_int|0xDEBB9EC5L
comma
l_int|0x47B2CF7FL
comma
l_int|0x30B5FFE9L
comma
l_int|0xBDBDF21CL
comma
l_int|0xCABAC28AL
comma
l_int|0x53B39330L
comma
l_int|0x24B4A3A6L
comma
l_int|0xBAD03605L
comma
l_int|0xCDD70693L
comma
l_int|0x54DE5729L
comma
l_int|0x23D967BFL
comma
l_int|0xB3667A2EL
comma
l_int|0xC4614AB8L
comma
l_int|0x5D681B02L
comma
l_int|0x2A6F2B94L
comma
l_int|0xB40BBE37L
comma
l_int|0xC30C8EA1L
comma
l_int|0x5A05DF1BL
comma
l_int|0x2D02EF8DL
)brace
suffix:semicolon
multiline_comment|/* function declaration ------------------------------------- */
r_static
r_int
id|dmfe_open
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dmfe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dmfe_stop
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|dmfe_get_stats
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_set_filter_mode
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dmfe_do_ioctl
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|u16
id|read_srom_word
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|dmfe_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_descriptor_init
c_func
(paren
r_struct
id|dmfe_board_info
op_star
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|allocated_rx_buffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|update_cr6
c_func
(paren
id|u32
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|send_filter_frame
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|dm9132_id_table
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|u16
id|phy_read
c_func
(paren
id|u32
comma
id|u8
comma
id|u8
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|phy_write
c_func
(paren
id|u32
comma
id|u8
comma
id|u8
comma
id|u16
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|phy_write_1bit
c_func
(paren
id|u32
comma
id|u32
)paren
suffix:semicolon
r_static
id|u16
id|phy_read_1bit
c_func
(paren
id|u32
)paren
suffix:semicolon
r_static
r_void
id|dmfe_sense_speed
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_process_mode
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|dmfe_rx_packet
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_reused_skb
c_func
(paren
r_struct
id|dmfe_board_info
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_dynamic_reset
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_free_rxbuffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_init_dm910x
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
r_int
id|cal_CRC
c_func
(paren
r_int
r_char
op_star
comma
r_int
r_int
comma
id|u8
)paren
suffix:semicolon
multiline_comment|/* DM910X network board routine ---------------------------- */
multiline_comment|/*&n; *&t;Search DM910X board, allocate space and register it&n; */
DECL|function|dmfe_init_one
r_static
r_int
id|__init
id|dmfe_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
r_int
id|pci_iobase
suffix:semicolon
id|u8
id|pci_irqline
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
suffix:semicolon
multiline_comment|/* Point a board information structure */
r_int
id|i
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|u32
id|dev_rev
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_probe()&quot;
comma
l_int|0
)paren
suffix:semicolon
id|pci_iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|pci_irqline
op_assign
id|pdev-&gt;irq
suffix:semicolon
multiline_comment|/* Interrupt check */
r_if
c_cond
(paren
id|pci_irqline
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dmfe: Interrupt wrong : IRQ=%d&bslash;n&quot;
comma
id|pci_irqline
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* iobase check */
r_if
c_cond
(paren
id|pci_iobase
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dmfe: I/O base is zero&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* Enable Master/IO access, Disable memory access */
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#if 0&t;/* pci_{enable_device,set_master} sets minimum latency for us now */
multiline_comment|/* Set Latency Timer 80h */
multiline_comment|/* FIXME: setting values &gt; 32 breaks some SiS 559x stuff.&n;&t;   Need a PCI quirk.. */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x80
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Read Chip revision */
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|dev_rev
)paren
suffix:semicolon
multiline_comment|/* Init network device */
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
op_star
id|db
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_goto
id|err_out
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* IO range check */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|pci_iobase
comma
id|CHK_IO_SIZE
c_func
(paren
id|pdev
comma
id|dev_rev
)paren
comma
id|dev-&gt;name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dmfe: I/O conflict : IO=%lx Range=%x&bslash;n&quot;
comma
id|pci_iobase
comma
id|CHK_IO_SIZE
c_func
(paren
id|pdev
comma
id|dev_rev
)paren
)paren
suffix:semicolon
r_goto
id|err_out_netdev
suffix:semicolon
)brace
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|db-&gt;chip_id
op_assign
id|ent-&gt;driver_data
suffix:semicolon
id|db-&gt;ioaddr
op_assign
id|pci_iobase
suffix:semicolon
id|db-&gt;chip_revision
op_assign
id|dev_rev
suffix:semicolon
id|db-&gt;net_dev
op_assign
id|pdev
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|pci_iobase
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pci_irqline
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|dmfe_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|dmfe_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|dmfe_stop
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|dmfe_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|dmfe_set_filter_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|dmfe_do_ioctl
suffix:semicolon
multiline_comment|/* read 64 word srom data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
id|db-&gt;srom
)paren
(braket
id|i
)braket
op_assign
id|read_srom_word
c_func
(paren
id|pci_iobase
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Set Node address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|db-&gt;srom
(braket
l_int|20
op_plus
id|i
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_netdev
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|dmfe_remove_one
r_static
r_void
id|__exit
id|dmfe_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_remove_one()&quot;
comma
l_int|0
)paren
suffix:semicolon
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|CHK_IO_SIZE
c_func
(paren
id|pdev
comma
id|db-&gt;chip_revision
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* free board information */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_remove_one() exit&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Open the interface.&n; *&t;The interface is opened whenever &quot;ifconfig&quot; actives it.&n; */
DECL|function|dmfe_open
r_static
r_int
id|dmfe_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_open&quot;
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|dmfe_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* Allocated Tx/Rx descriptor memory */
id|db-&gt;desc_pool_ptr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|DESC_ALL_CNT
op_plus
l_int|0x20
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;desc_pool_ptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u32
)paren
id|db-&gt;desc_pool_ptr
op_amp
l_int|0x1f
)paren
id|db-&gt;first_tx_desc
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
(paren
(paren
(paren
id|u32
)paren
id|db-&gt;desc_pool_ptr
op_amp
op_complement
l_int|0x1f
)paren
op_plus
l_int|0x20
)paren
suffix:semicolon
r_else
id|db-&gt;first_tx_desc
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|db-&gt;desc_pool_ptr
suffix:semicolon
multiline_comment|/* Allocated Tx buffer memory */
id|db-&gt;buf_pool_ptr
op_assign
id|kmalloc
c_func
(paren
id|TX_BUF_ALLOC
op_star
id|TX_DESC_CNT
op_plus
l_int|4
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;buf_pool_ptr
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|db-&gt;desc_pool_ptr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|u32
)paren
id|db-&gt;buf_pool_ptr
op_amp
l_int|0x3
)paren
id|db-&gt;buf_pool_start
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
id|u32
)paren
id|db-&gt;buf_pool_ptr
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|0x4
)paren
suffix:semicolon
r_else
id|db-&gt;buf_pool_start
op_assign
id|db-&gt;buf_pool_ptr
suffix:semicolon
multiline_comment|/* system variable init */
id|db-&gt;cr6_data
op_assign
id|CR6_DEFAULT
op_or
id|dmfe_cr6_user_set
suffix:semicolon
id|db-&gt;tx_packet_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;tx_queue_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|0
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|0
suffix:semicolon
id|db-&gt;in_reset_state
op_assign
l_int|0
suffix:semicolon
id|db-&gt;rx_error_cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chkmode
op_logical_or
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
op_logical_or
(paren
id|db-&gt;chip_revision
op_ge
l_int|0x02000030
)paren
)paren
(brace
singleline_comment|//db-&gt;cr6_data &amp;= ~CR6_SFT;         /* Used Tx threshold */
singleline_comment|//db-&gt;cr6_data |= CR6_NO_PURGE;     /* No purge if rx unavailable */
id|db-&gt;cr0_data
op_assign
l_int|0xc00000
suffix:semicolon
multiline_comment|/* TX/RX desc burst mode */
id|db-&gt;dm910x_chk_mode
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Enter the normal mode */
)brace
r_else
(brace
id|db-&gt;cr0_data
op_assign
l_int|0
suffix:semicolon
id|db-&gt;dm910x_chk_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enter the check mode */
)brace
multiline_comment|/* Initilize DM910X board */
id|dmfe_init_dm910x
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* set and active a timer process */
id|init_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
suffix:semicolon
id|db-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|db-&gt;timer.function
op_assign
op_amp
id|dmfe_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initilize DM910X board&n;   Reset DM910X board&n;   Initilize TX/Rx descriptor chain structure&n;   Send the set-up frame&n;   Enable Tx/Rx machine&n; */
DECL|function|dmfe_init_dm910x
r_static
r_void
id|dmfe_init_dm910x
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ioaddr
op_assign
id|db-&gt;ioaddr
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_init_dm910x()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset DM910x board : need 32 PCI clock to complete */
id|outl
c_func
(paren
id|DM910X_RESET
comma
id|ioaddr
op_plus
id|DCR0
)paren
suffix:semicolon
multiline_comment|/* RESET MAC */
id|DELAY_5US
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr0_data
comma
id|ioaddr
op_plus
id|DCR0
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x180
comma
id|ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* Let bit 7 output port */
id|outl
c_func
(paren
l_int|0x80
comma
id|ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* RESET DM9102 phyxcer */
id|outl
c_func
(paren
l_int|0x0
comma
id|ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* Clear RESET signal */
multiline_comment|/* Phy addr : DM910(A)2/DM9132/9801, phy address = 1 */
id|db-&gt;phy_addr
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Media Mode Check */
id|db-&gt;media_mode
op_assign
id|dmfe_media_mode
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
id|dmfe_sense_speed
c_func
(paren
id|db
)paren
suffix:semicolon
r_else
id|db-&gt;op_mode
op_assign
id|db-&gt;media_mode
suffix:semicolon
id|dmfe_process_mode
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* Initiliaze Transmit/Receive decriptor and CR3/4 */
id|dmfe_descriptor_init
c_func
(paren
id|db
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Init CR6 to program DM910x operation */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Send setup frame */
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
id|dm9132_id_table
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9132 */
r_else
id|send_filter_frame
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9102/DM9102A */
multiline_comment|/* Init CR5/CR7, interrupt active bit */
id|outl
c_func
(paren
l_int|0xffffffff
comma
id|ioaddr
op_plus
id|DCR5
)paren
suffix:semicolon
multiline_comment|/* clear all CR5 status */
id|db-&gt;cr7_data
op_assign
id|CR7_DEFAULT
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr7_data
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* Init CR15, Tx jabber and Rx watchdog timer */
id|db-&gt;cr15_data
op_assign
id|CR15_DEFAULT
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr15_data
comma
id|ioaddr
op_plus
id|DCR15
)paren
suffix:semicolon
multiline_comment|/* Enable DM910X Tx/Rx function */
id|db-&gt;cr6_data
op_or_assign
id|CR6_RXSC
op_or
id|CR6_TXSC
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|ioaddr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   Hardware start transmission.&n;   Send a packet to media from the upper layer.&n; */
DECL|function|dmfe_start_xmit
r_static
r_int
id|dmfe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|tx_desc
op_star
id|txptr
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_start_xmit&quot;
comma
l_int|0
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Too large packet check */
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|MAX_PACKET_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: oversized frame (%d bytes) for transmit.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|u16
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* No Tx resource check, it never happen nromally */
r_if
c_cond
(paren
id|db-&gt;tx_packet_cnt
op_ge
id|TX_FREE_DESC_CNT
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* transmit this packet */
id|txptr
op_assign
id|db-&gt;tx_insert_ptr
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|txptr-&gt;tx_buf_ptr
comma
(paren
r_char
op_star
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|txptr-&gt;tdes1
op_assign
l_int|0xe1000000
op_or
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Point to next transmit free descriptor */
id|db-&gt;tx_insert_ptr
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|txptr-&gt;next_tx_desc
suffix:semicolon
multiline_comment|/* Transmit Packet Process */
r_if
c_cond
(paren
id|db-&gt;tx_packet_cnt
OL
id|TX_MAX_SEND_CNT
)paren
(brace
id|txptr-&gt;tdes0
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* set owner bit to DM910X */
id|db-&gt;tx_packet_cnt
op_increment
suffix:semicolon
multiline_comment|/* Ready to send count */
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling comand */
)brace
r_else
(brace
id|db-&gt;tx_queue_cnt
op_increment
suffix:semicolon
multiline_comment|/* queue the tx packet */
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling comand */
)brace
multiline_comment|/* Tx resource check */
r_if
c_cond
(paren
id|db-&gt;tx_packet_cnt
OL
id|TX_FREE_DESC_CNT
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* free this SKB */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Stop the interface.&n; *&t;The interface is stopped when it is brought.&n; */
DECL|function|dmfe_stop
r_static
r_int
id|dmfe_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_stop&quot;
comma
l_int|0
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reset &amp; stop DM910X board */
id|outl
c_func
(paren
id|DM910X_RESET
comma
id|ioaddr
op_plus
id|DCR0
)paren
suffix:semicolon
id|DELAY_5US
suffix:semicolon
multiline_comment|/* deleted timer */
id|del_timer_sync
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* free interrupt */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* free allocated rx buffer */
id|dmfe_free_rxbuffer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* free all descriptor memory and buffer memory */
id|kfree
c_func
(paren
id|db-&gt;desc_pool_ptr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|db-&gt;buf_pool_ptr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   DM9102 insterrupt handler&n;   receive the packet to upper layer, free the transmitted packet&n; */
DECL|function|dmfe_interrupt
r_static
r_void
id|dmfe_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|tx_desc
op_star
id|txptr
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
suffix:semicolon
id|u32
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|1
comma
l_string|&quot;dmfe_interrupt() without device arg&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* A real interrupt coming */
id|db
op_assign
(paren
r_struct
id|dmfe_board_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_interrupt()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable all interrupt in CR7 to solve the interrupt edge problem */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* Got DM910X status */
id|db-&gt;cr5_data
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DCR5
)paren
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr5_data
comma
id|ioaddr
op_plus
id|DCR5
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;CR5=%x&bslash;n&quot;, db-&gt;cr5_data); */
multiline_comment|/* Check system status */
r_if
c_cond
(paren
id|db-&gt;cr5_data
op_amp
l_int|0x2000
)paren
(brace
multiline_comment|/* A system bus error occurred */
id|DMFE_DBUG
c_func
(paren
l_int|1
comma
l_string|&quot;A system bus error occurred. CR5=&quot;
comma
id|db-&gt;cr5_data
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Need to RESET */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* disable all interrupt */
r_return
suffix:semicolon
)brace
multiline_comment|/* Free the transmitted descriptor */
id|txptr
op_assign
id|db-&gt;tx_remove_ptr
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;tx_packet_cnt
)paren
(brace
multiline_comment|/* printk(&quot;tdes0=%x&bslash;n&quot;, txptr-&gt;tdes0); */
r_if
c_cond
(paren
id|txptr-&gt;tdes0
op_amp
l_int|0x80000000
)paren
r_break
suffix:semicolon
id|db-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|txptr-&gt;tdes0
op_amp
id|TDES0_ERR_MASK
)paren
op_logical_and
(paren
id|txptr-&gt;tdes0
op_ne
l_int|0x7fffffff
)paren
)paren
(brace
multiline_comment|/* printk(&quot;tdes0=%x&bslash;n&quot;, txptr-&gt;tdes0); */
id|db-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Transmit statistic counter */
r_if
c_cond
(paren
id|txptr-&gt;tdes0
op_ne
l_int|0x7fffffff
)paren
(brace
multiline_comment|/* printk(&quot;tdes0=%x&bslash;n&quot;, txptr-&gt;tdes0); */
id|db-&gt;stats.collisions
op_add_assign
(paren
id|txptr-&gt;tdes0
op_rshift
l_int|3
)paren
op_amp
l_int|0xf
suffix:semicolon
id|db-&gt;stats.tx_bytes
op_add_assign
id|txptr-&gt;tdes1
op_amp
l_int|0x7ff
suffix:semicolon
r_if
c_cond
(paren
id|txptr-&gt;tdes0
op_amp
id|TDES0_ERR_MASK
)paren
id|db-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
id|txptr
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|txptr-&gt;next_tx_desc
suffix:semicolon
id|db-&gt;tx_packet_cnt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Update TX remove pointer to next */
id|db-&gt;tx_remove_ptr
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|txptr
suffix:semicolon
multiline_comment|/* Send the Tx packet in queue */
r_if
c_cond
(paren
(paren
id|db-&gt;tx_packet_cnt
OL
id|TX_MAX_SEND_CNT
)paren
op_logical_and
id|db-&gt;tx_queue_cnt
)paren
(brace
id|txptr-&gt;tdes0
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* set owner bit to DM910X */
id|db-&gt;tx_packet_cnt
op_increment
suffix:semicolon
multiline_comment|/* Ready to send count */
id|outl
c_func
(paren
l_int|0x1
comma
id|ioaddr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling command */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* saved the time stamp */
id|db-&gt;tx_queue_cnt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Resource available check */
r_if
c_cond
(paren
id|db-&gt;tx_packet_cnt
OL
id|TX_FREE_DESC_CNT
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Received the coming packet */
r_if
c_cond
(paren
id|db-&gt;rx_avail_cnt
)paren
id|dmfe_rx_packet
c_func
(paren
id|dev
comma
id|db
)paren
suffix:semicolon
multiline_comment|/* reallocated rx descriptor buffer */
r_if
c_cond
(paren
id|db-&gt;rx_avail_cnt
OL
id|RX_DESC_CNT
)paren
id|allocated_rx_buffer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* Mode Check */
r_if
c_cond
(paren
id|db-&gt;dm910x_chk_mode
op_amp
l_int|0x2
)paren
(brace
id|db-&gt;dm910x_chk_mode
op_assign
l_int|0x4
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
l_int|0x100
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore CR7 to enable interrupt mask */
r_if
c_cond
(paren
id|db-&gt;interval_rx_cnt
OG
id|RX_MAX_TRAFFIC
)paren
id|db-&gt;cr7_data
op_assign
l_int|0x1a28d
suffix:semicolon
r_else
id|db-&gt;cr7_data
op_assign
l_int|0x1a2cd
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr7_data
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   Receive the come packet and pass to upper layer&n; */
DECL|function|dmfe_rx_packet
r_static
r_void
id|dmfe_rx_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_struct
id|rx_desc
op_star
id|rxptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|rxlen
suffix:semicolon
id|rxptr
op_assign
id|db-&gt;rx_ready_ptr
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;rx_avail_cnt
)paren
(brace
r_if
c_cond
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|0x80000000
)paren
multiline_comment|/* packet owner check */
r_break
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_decrement
suffix:semicolon
id|db-&gt;interval_rx_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|0x300
)paren
op_ne
l_int|0x300
)paren
(brace
multiline_comment|/* A packet without First/Last flag */
multiline_comment|/* reused this SKB */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Reused SK buffer, rdes0&quot;
comma
id|rxptr-&gt;rdes0
)paren
suffix:semicolon
id|dmfe_reused_skb
c_func
(paren
id|db
comma
(paren
r_struct
id|sk_buff
op_star
)paren
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
multiline_comment|/* db-&gt;rx_error_cnt++; */
)brace
r_else
(brace
multiline_comment|/* A packet with First/Last flag */
id|rxlen
op_assign
(paren
(paren
id|rxptr-&gt;rdes0
op_rshift
l_int|16
)paren
op_amp
l_int|0x3fff
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* skip CRC */
r_if
c_cond
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* error summary bit check */
multiline_comment|/* This is a error packet */
multiline_comment|/* printk(&quot;rdes0 error : %x &bslash;n&quot;, rxptr-&gt;rdes0); */
id|db-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|1
)paren
id|db-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|2
)paren
id|db-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|0x80
)paren
id|db-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|0x8000
)paren
op_logical_or
(paren
(paren
id|db-&gt;cr6_data
op_amp
id|CR6_PM
)paren
op_logical_and
(paren
id|rxlen
OG
l_int|6
)paren
)paren
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|rxptr-&gt;rx_skb_ptr
suffix:semicolon
multiline_comment|/* Received Packet CRC check need or not */
r_if
c_cond
(paren
(paren
id|db-&gt;dm910x_chk_mode
op_amp
l_int|1
)paren
op_logical_and
(paren
id|cal_CRC
c_func
(paren
id|skb-&gt;tail
comma
id|rxlen
comma
l_int|1
)paren
op_ne
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|skb-&gt;tail
op_plus
id|rxlen
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* Found a error received packet */
id|dmfe_reused_skb
c_func
(paren
id|db
comma
(paren
r_struct
id|sk_buff
op_star
)paren
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
id|db-&gt;dm910x_chk_mode
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* A good packet coming, send to upper layer */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|rxlen
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Send to upper layer */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|db-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|db-&gt;stats.rx_bytes
op_add_assign
id|rxlen
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Reuse SKB buffer when the packet is error */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Reused SK buffer, rdes0&quot;
comma
id|rxptr-&gt;rdes0
)paren
suffix:semicolon
id|dmfe_reused_skb
c_func
(paren
id|db
comma
(paren
r_struct
id|sk_buff
op_star
)paren
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
)brace
)brace
id|rxptr
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
id|rxptr-&gt;next_rx_desc
suffix:semicolon
)brace
id|db-&gt;rx_ready_ptr
op_assign
id|rxptr
suffix:semicolon
)brace
multiline_comment|/*&n;   Get statistics from driver.&n; */
DECL|function|dmfe_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|dmfe_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
(paren
r_struct
id|dmfe_board_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_get_stats&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
op_amp
id|db-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n;   Set DM910X multicast address&n; */
DECL|function|dmfe_set_filter_mode
r_static
r_void
id|dmfe_set_filter_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_set_filter_mode()&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Enable PROM Mode&quot;
comma
l_int|0
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
id|CR6_PM
op_or
id|CR6_PBF
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
op_logical_or
id|dev-&gt;mc_count
OG
id|DMFE_MAX_MULTICAST
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Pass all multicast address&quot;
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_and_assign
op_complement
(paren
id|CR6_PM
op_or
id|CR6_PBF
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
id|CR6_PAM
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Set multicast address&quot;
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
id|dm9132_id_table
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9132 */
r_else
id|send_filter_frame
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9102/DM9102A */
)brace
multiline_comment|/*&n;   Process the upper socket ioctl command&n; */
DECL|function|dmfe_do_ioctl
r_static
r_int
id|dmfe_do_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_do_ioctl()&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   A periodic timer routine&n;   Dynamic media sense, allocated Rx buffer...&n; */
DECL|function|dmfe_timer
r_static
r_void
id|dmfe_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|u32
id|tmp_cr8
suffix:semicolon
r_int
r_char
id|tmp_cr12
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
(paren
r_struct
id|dmfe_board_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_timer()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Do reset now */
r_if
c_cond
(paren
id|db-&gt;in_reset_state
)paren
r_return
suffix:semicolon
multiline_comment|/* Operating Mode Check */
r_if
c_cond
(paren
(paren
id|db-&gt;dm910x_chk_mode
op_amp
l_int|0x1
)paren
op_logical_and
(paren
id|db-&gt;stats.rx_packets
OG
id|MAX_CHECK_PACKET
)paren
)paren
(brace
id|db-&gt;dm910x_chk_mode
op_assign
l_int|0x4
suffix:semicolon
)brace
multiline_comment|/* Dynamic reset DM910X : system error or transmit time-out */
id|tmp_cr8
op_assign
id|inl
c_func
(paren
id|db-&gt;ioaddr
op_plus
id|DCR8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|db-&gt;interval_rx_cnt
op_eq
l_int|0
)paren
op_logical_and
(paren
id|tmp_cr8
)paren
)paren
(brace
id|db-&gt;wait_reset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* printk(&quot;CR8 %x, Interval Rx %x&bslash;n&quot;, tmp_cr8, db-&gt;interval_rx_cnt); */
)brace
multiline_comment|/* Receiving Traffic check */
r_if
c_cond
(paren
id|db-&gt;interval_rx_cnt
OG
id|RX_MAX_TRAFFIC
)paren
id|db-&gt;cr7_data
op_assign
l_int|0x1a28d
suffix:semicolon
r_else
id|db-&gt;cr7_data
op_assign
l_int|0x1a2cd
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr7_data
comma
id|db-&gt;ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
id|db-&gt;interval_rx_cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;wait_reset
op_or
(paren
id|db-&gt;tx_packet_cnt
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
OG
id|DMFE_TX_TIMEOUT
)paren
)paren
op_or
(paren
id|db-&gt;rx_error_cnt
OG
l_int|3
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;   printk(&quot;wait_reset %x, tx cnt %x, rx err %x, time %x&bslash;n&quot;, db-&gt;wait_reset, db-&gt;tx_packet_cnt, db-&gt;rx_error_cnt, jiffies-dev-&gt;trans_start);&n;&t;&t; */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Warn!! Warn!! Tx/Rx moniotr step1&quot;
comma
id|db-&gt;tx_packet_cnt
)paren
suffix:semicolon
id|dmfe_dynamic_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|db-&gt;rx_error_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear previos counter */
multiline_comment|/* Link status check, Dynamic media type change */
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
id|tmp_cr12
op_assign
id|inb
c_func
(paren
id|db-&gt;ioaddr
op_plus
id|DCR9
op_plus
l_int|3
)paren
suffix:semicolon
multiline_comment|/* DM9132 */
r_else
id|tmp_cr12
op_assign
id|inb
c_func
(paren
id|db-&gt;ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* DM9102/DM9102A */
r_if
c_cond
(paren
(paren
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9102_ID
)paren
op_logical_and
(paren
id|db-&gt;chip_revision
op_eq
l_int|0x02000030
)paren
)paren
op_logical_or
(paren
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
op_logical_and
(paren
id|db-&gt;chip_revision
op_eq
l_int|0x02000010
)paren
)paren
)paren
(brace
multiline_comment|/* DM9102A Chip */
r_if
c_cond
(paren
id|tmp_cr12
op_amp
l_int|2
)paren
id|tmp_cr12
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* Link failed */
r_else
id|tmp_cr12
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* Link OK */
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp_cr12
op_amp
l_int|0x3
)paren
op_logical_and
op_logical_neg
id|db-&gt;link_failed
)paren
(brace
multiline_comment|/* Link Failed */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Link Failed&quot;
comma
id|tmp_cr12
)paren
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|1
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
l_int|0x8000
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
multiline_comment|/* reset Phy */
multiline_comment|/* 10/100M link failed, used 1M Home-Net */
id|db-&gt;cr6_data
op_or_assign
l_int|0x00040000
suffix:semicolon
multiline_comment|/* CR6 bit18 = 1, select Home-Net */
id|db-&gt;cr6_data
op_and_assign
op_complement
l_int|0x00000200
suffix:semicolon
multiline_comment|/* CR6 bit9 =0, half duplex mode */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
multiline_comment|/* For DM9801 : PHY ID1 0181h, PHY ID2 B900h */
id|db-&gt;phy_id2
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|3
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;phy_id2
op_eq
l_int|0xb900
)paren
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|25
comma
l_int|0x7e08
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tmp_cr12
op_amp
l_int|0x3
)paren
op_logical_and
id|db-&gt;link_failed
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Link link OK&quot;
comma
id|tmp_cr12
)paren
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CR6 bit18=0, select 10/100M */
id|db-&gt;cr6_data
op_and_assign
op_complement
l_int|0x00040000
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
multiline_comment|/* Auto Sense Speed */
r_if
c_cond
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
id|dmfe_sense_speed
c_func
(paren
id|db
)paren
suffix:semicolon
id|dmfe_process_mode
c_func
(paren
id|db
)paren
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
multiline_comment|/* SHOW_MEDIA_TYPE(db-&gt;op_mode); */
)brace
multiline_comment|/* reallocated rx descriptor buffer */
r_if
c_cond
(paren
id|db-&gt;rx_avail_cnt
OL
id|RX_DESC_CNT
)paren
id|allocated_rx_buffer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* Timer active again */
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   Dynamic reset the DM910X board&n;   Stop DM910X board&n;   Free Tx/Rx allocated memory&n;   Reset DM910X board&n;   Re-initilize DM910X board&n; */
DECL|function|dmfe_dynamic_reset
r_static
r_void
id|dmfe_dynamic_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_dynamic_reset()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enter dynamic reset route */
id|db-&gt;in_reset_state
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable upper layer interface */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_and_assign
op_complement
(paren
id|CR6_RXSC
op_or
id|CR6_TXSC
)paren
suffix:semicolon
multiline_comment|/* Disable Tx/Rx */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* Free Rx Allocate buffer */
id|dmfe_free_rxbuffer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* system variable init */
id|db-&gt;tx_packet_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;tx_queue_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|0
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|0
suffix:semicolon
id|db-&gt;rx_error_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Re-initilize DM910X board */
id|dmfe_init_dm910x
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Leave dynamic reser route */
id|db-&gt;in_reset_state
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Restart upper layer interface */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   free all allocated rx buffer &n; */
DECL|function|dmfe_free_rxbuffer
r_static
r_void
id|dmfe_free_rxbuffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_free_rxbuffer()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* free allocated rx buffer */
r_while
c_loop
(paren
id|db-&gt;rx_avail_cnt
)paren
(brace
id|dev_kfree_skb
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|db-&gt;rx_ready_ptr-&gt;rx_skb_ptr
)paren
)paren
suffix:semicolon
id|db-&gt;rx_ready_ptr
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
id|db-&gt;rx_ready_ptr-&gt;next_rx_desc
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   Reused the SK buffer&n; */
DECL|function|dmfe_reused_skb
r_static
r_void
id|dmfe_reused_skb
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rx_desc
op_star
id|rxptr
op_assign
id|db-&gt;rx_insert_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rxptr-&gt;rdes0
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|rxptr-&gt;rx_skb_ptr
op_assign
(paren
id|u32
)paren
id|skb
suffix:semicolon
id|rxptr-&gt;rdes2
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
id|rxptr-&gt;rdes0
op_assign
l_int|0x80000000
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_increment
suffix:semicolon
id|db-&gt;rx_insert_ptr
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
id|rxptr-&gt;next_rx_desc
suffix:semicolon
)brace
r_else
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;SK Buffer reused method error&quot;
comma
id|db-&gt;rx_avail_cnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   Initialize transmit/Receive descriptor &n;   Using Chain structure, and allocated Tx/Rx buffer&n; */
DECL|function|dmfe_descriptor_init
r_static
r_void
id|dmfe_descriptor_init
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
comma
id|u32
id|ioaddr
)paren
(brace
r_struct
id|tx_desc
op_star
id|tmp_tx
suffix:semicolon
r_struct
id|rx_desc
op_star
id|tmp_rx
suffix:semicolon
r_int
r_char
op_star
id|tmp_buf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_descriptor_init()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* tx descriptor start pointer */
id|db-&gt;tx_insert_ptr
op_assign
id|db-&gt;first_tx_desc
suffix:semicolon
id|db-&gt;tx_remove_ptr
op_assign
id|db-&gt;first_tx_desc
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;first_tx_desc
)paren
comma
id|ioaddr
op_plus
id|DCR4
)paren
suffix:semicolon
multiline_comment|/* Init CR4 */
multiline_comment|/* rx descriptor start pointer */
id|db-&gt;first_rx_desc
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
(paren
(paren
id|u32
)paren
id|db-&gt;first_tx_desc
op_plus
r_sizeof
(paren
r_struct
id|rx_desc
)paren
op_star
id|TX_DESC_CNT
)paren
suffix:semicolon
id|db-&gt;rx_insert_ptr
op_assign
id|db-&gt;first_rx_desc
suffix:semicolon
id|db-&gt;rx_ready_ptr
op_assign
id|db-&gt;first_rx_desc
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;first_rx_desc
)paren
comma
id|ioaddr
op_plus
id|DCR3
)paren
suffix:semicolon
multiline_comment|/* Init CR3 */
multiline_comment|/* Init Transmit chain */
id|tmp_buf
op_assign
id|db-&gt;buf_pool_start
suffix:semicolon
r_for
c_loop
(paren
id|tmp_tx
op_assign
id|db-&gt;first_tx_desc
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_DESC_CNT
suffix:semicolon
id|i
op_increment
comma
id|tmp_tx
op_increment
)paren
(brace
id|tmp_tx-&gt;tx_buf_ptr
op_assign
(paren
id|u32
)paren
id|tmp_buf
suffix:semicolon
id|tmp_tx-&gt;tdes0
op_assign
l_int|0
suffix:semicolon
id|tmp_tx-&gt;tdes1
op_assign
l_int|0x81000000
suffix:semicolon
multiline_comment|/* IC, chain */
id|tmp_tx-&gt;tdes2
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|tmp_buf
)paren
suffix:semicolon
id|tmp_tx-&gt;tdes3
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|tmp_tx
)paren
op_plus
r_sizeof
(paren
r_struct
id|tx_desc
)paren
suffix:semicolon
id|tmp_tx-&gt;next_tx_desc
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u32
)paren
id|tmp_tx
op_plus
r_sizeof
(paren
r_struct
id|tx_desc
)paren
)paren
suffix:semicolon
id|tmp_buf
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
(paren
id|u32
)paren
id|tmp_buf
op_plus
id|TX_BUF_ALLOC
)paren
suffix:semicolon
)brace
(paren
op_decrement
id|tmp_tx
)paren
op_member_access_from_pointer
id|tdes3
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|db-&gt;first_tx_desc
)paren
suffix:semicolon
id|tmp_tx-&gt;next_tx_desc
op_assign
(paren
id|u32
)paren
id|db-&gt;first_tx_desc
suffix:semicolon
multiline_comment|/* Init Receive descriptor chain */
r_for
c_loop
(paren
id|tmp_rx
op_assign
id|db-&gt;first_rx_desc
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_DESC_CNT
suffix:semicolon
id|i
op_increment
comma
id|tmp_rx
op_increment
)paren
(brace
id|tmp_rx-&gt;rdes0
op_assign
l_int|0
suffix:semicolon
id|tmp_rx-&gt;rdes1
op_assign
l_int|0x01000600
suffix:semicolon
id|tmp_rx-&gt;rdes3
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|tmp_rx
)paren
op_plus
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|tmp_rx-&gt;next_rx_desc
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u32
)paren
id|tmp_rx
op_plus
r_sizeof
(paren
r_struct
id|rx_desc
)paren
)paren
suffix:semicolon
)brace
(paren
op_decrement
id|tmp_rx
)paren
op_member_access_from_pointer
id|rdes3
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|db-&gt;first_rx_desc
)paren
suffix:semicolon
id|tmp_rx-&gt;next_rx_desc
op_assign
(paren
id|u32
)paren
id|db-&gt;first_rx_desc
suffix:semicolon
multiline_comment|/* pre-allocated Rx buffer */
id|allocated_rx_buffer
c_func
(paren
id|db
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   Update CR6 vaule&n;   Firstly stop DM910X , then written value and start&n; */
DECL|function|update_cr6
r_static
r_void
id|update_cr6
c_func
(paren
id|u32
id|cr6_data
comma
id|u32
id|ioaddr
)paren
(brace
id|u32
id|cr6_tmp
suffix:semicolon
id|cr6_tmp
op_assign
id|cr6_data
op_amp
op_complement
l_int|0x2002
suffix:semicolon
multiline_comment|/* stop Tx/Rx */
id|outl
c_func
(paren
id|cr6_tmp
comma
id|ioaddr
op_plus
id|DCR6
)paren
suffix:semicolon
id|DELAY_5US
suffix:semicolon
id|outl
c_func
(paren
id|cr6_data
comma
id|ioaddr
op_plus
id|DCR6
)paren
suffix:semicolon
id|cr6_tmp
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DCR6
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;CR6 update %x &quot;, cr6_tmp); */
)brace
multiline_comment|/* Send a setup frame for DM9132&n;   This setup frame initilize DM910X addres filter mode&n; */
DECL|function|dm9132_id_table
r_static
r_void
id|dm9132_id_table
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mc_cnt
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mcptr
suffix:semicolon
id|u16
op_star
id|addrptr
suffix:semicolon
id|u32
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
l_int|0xc0
suffix:semicolon
multiline_comment|/* ID Table */
id|u32
id|hash_val
suffix:semicolon
id|u16
id|i
comma
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dm9132_id_table()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Node address */
id|addrptr
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|outw
c_func
(paren
id|addrptr
(braket
l_int|0
)braket
comma
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_add_assign
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|addrptr
(braket
l_int|1
)braket
comma
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_add_assign
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|addrptr
(braket
l_int|2
)braket
comma
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* Clear Hash Table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* broadcast address */
id|hash_table
(braket
l_int|3
)braket
op_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* the multicast address in Hash Table : 64 bits */
r_for
c_loop
(paren
id|mcptr
op_assign
id|dev-&gt;mc_list
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mc_cnt
suffix:semicolon
id|i
op_increment
comma
id|mcptr
op_assign
id|mcptr-&gt;next
)paren
(brace
id|hash_val
op_assign
id|cal_CRC
c_func
(paren
(paren
r_char
op_star
)paren
id|mcptr-&gt;dmi_addr
comma
l_int|6
comma
l_int|0
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|hash_table
(braket
id|hash_val
op_div
l_int|16
)braket
op_or_assign
(paren
id|u16
)paren
l_int|1
op_lshift
(paren
id|hash_val
op_mod
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* Write the hash table to MAC MD table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
comma
id|ioaddr
op_add_assign
l_int|4
)paren
(brace
id|outw
c_func
(paren
id|hash_table
(braket
id|i
)braket
comma
id|ioaddr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Send a setup frame for DM9102/DM9102A&n;   This setup frame initilize DM910X addres filter mode&n; */
DECL|function|send_filter_frame
r_static
r_void
id|send_filter_frame
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mc_cnt
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mcptr
suffix:semicolon
r_struct
id|tx_desc
op_star
id|txptr
suffix:semicolon
id|u16
op_star
id|addrptr
suffix:semicolon
id|u32
op_star
id|suptr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;send_filetr_frame()&quot;
comma
l_int|0
)paren
suffix:semicolon
id|txptr
op_assign
id|db-&gt;tx_insert_ptr
suffix:semicolon
id|suptr
op_assign
(paren
id|u32
op_star
)paren
id|txptr-&gt;tx_buf_ptr
suffix:semicolon
multiline_comment|/* Node address */
id|addrptr
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* broadcast address */
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* fit the multicast address */
r_for
c_loop
(paren
id|mcptr
op_assign
id|dev-&gt;mc_list
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mc_cnt
suffix:semicolon
id|i
op_increment
comma
id|mcptr
op_assign
id|mcptr-&gt;next
)paren
(brace
id|addrptr
op_assign
(paren
id|u16
op_star
)paren
id|mcptr-&gt;dmi_addr
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
)brace
multiline_comment|/* prepare the setup frame */
id|db-&gt;tx_insert_ptr
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|txptr-&gt;next_tx_desc
suffix:semicolon
id|txptr-&gt;tdes1
op_assign
l_int|0x890000c0
suffix:semicolon
multiline_comment|/* Resource Check and Send the setup packet */
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;tx_packet_cnt
)paren
(brace
multiline_comment|/* Resource Empty */
id|db-&gt;tx_packet_cnt
op_increment
suffix:semicolon
id|txptr-&gt;tdes0
op_assign
l_int|0x80000000
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
op_or
l_int|0x2000
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling command */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Put into TX queue */
id|db-&gt;tx_queue_cnt
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Allocate rx buffer,&n; *&t;Allocate as many Rx buffers as possible.&n; */
DECL|function|allocated_rx_buffer
r_static
r_void
id|allocated_rx_buffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_struct
id|rx_desc
op_star
id|rxptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|rxptr
op_assign
id|db-&gt;rx_insert_ptr
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;rx_avail_cnt
OL
id|RX_DESC_CNT
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|RX_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|rxptr-&gt;rx_skb_ptr
op_assign
(paren
id|u32
)paren
id|skb
suffix:semicolon
id|rxptr-&gt;rdes2
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
id|rxptr-&gt;rdes0
op_assign
l_int|0x80000000
suffix:semicolon
id|rxptr
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
id|rxptr-&gt;next_rx_desc
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_increment
suffix:semicolon
)brace
id|db-&gt;rx_insert_ptr
op_assign
id|rxptr
suffix:semicolon
)brace
multiline_comment|/*&n;   Read one word data from the serial ROM&n; */
DECL|function|read_srom_word
r_static
id|u16
id|read_srom_word
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|offset
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|srom_data
op_assign
l_int|0
suffix:semicolon
r_int
id|cr9_ioaddr
op_assign
id|ioaddr
op_plus
id|DCR9
suffix:semicolon
id|outl
c_func
(paren
id|CR9_SROM_READ
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
comma
id|cr9_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Send the Read Command 110b */
id|SROM_CLK_WRITE
c_func
(paren
id|SROM_DATA_1
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|SROM_CLK_WRITE
c_func
(paren
id|SROM_DATA_1
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|SROM_CLK_WRITE
c_func
(paren
id|SROM_DATA_0
comma
id|cr9_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Send the offset */
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|srom_data
op_assign
(paren
id|offset
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|SROM_DATA_1
suffix:colon
id|SROM_DATA_0
suffix:semicolon
id|SROM_CLK_WRITE
c_func
(paren
id|srom_data
comma
id|cr9_ioaddr
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
comma
id|cr9_ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
op_or
id|CR9_SRCLK
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|DELAY_5US
suffix:semicolon
id|srom_data
op_assign
(paren
id|srom_data
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inl
c_func
(paren
id|cr9_ioaddr
)paren
op_amp
id|CR9_CRDOUT
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|DELAY_5US
suffix:semicolon
)brace
id|outl
c_func
(paren
id|CR9_SROM_READ
comma
id|cr9_ioaddr
)paren
suffix:semicolon
r_return
id|srom_data
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Auto sense the media mode&n; */
DECL|function|dmfe_sense_speed
r_static
r_void
id|dmfe_sense_speed
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|phy_mode
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|DELAY_5US
suffix:semicolon
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|1
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phy_mode
op_amp
l_int|0x24
)paren
op_eq
l_int|0x24
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
)paren
(brace
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
multiline_comment|/* DM9132 */
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|7
comma
id|db-&gt;chip_id
)paren
op_amp
l_int|0xf000
suffix:semicolon
r_else
multiline_comment|/* DM9102/DM9102A */
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|db-&gt;chip_id
)paren
op_amp
l_int|0xf000
suffix:semicolon
multiline_comment|/* printk(&quot;Phy_mode %x &quot;,phy_mode); */
r_switch
c_cond
(paren
id|phy_mode
)paren
(brace
r_case
l_int|0x1000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_10MHF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_10MFD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_100MHF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_100MFD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_10MHF
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Media Type error, phy reg17&quot;
comma
id|phy_mode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|db-&gt;op_mode
op_assign
id|DMFE_10MHF
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Link Failed :&quot;
comma
id|phy_mode
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   Process op-mode&n;   AUTO mode : PHY controller in Auto-negotiation Mode&n;   Force mode: PHY controller in force mode with HUB&n;   N-way force capability with SWITCH&n; */
DECL|function|dmfe_process_mode
r_static
r_void
id|dmfe_process_mode
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|u16
id|phy_reg
suffix:semicolon
multiline_comment|/* Full Duplex Mode Check */
id|db-&gt;cr6_data
op_and_assign
op_complement
id|CR6_FDM
suffix:semicolon
multiline_comment|/* Clear Full Duplex Bit */
r_if
c_cond
(paren
id|db-&gt;op_mode
op_amp
l_int|0x4
)paren
id|db-&gt;cr6_data
op_or_assign
id|CR6_FDM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
)paren
(brace
multiline_comment|/* Force Mode Check */
multiline_comment|/* User force the media type */
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|5
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;Nway phy_reg5 %x &quot;,phy_reg); */
r_if
c_cond
(paren
id|phy_reg
op_amp
l_int|0x1
)paren
(brace
multiline_comment|/* parter own the N-Way capability */
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|4
comma
id|db-&gt;chip_id
)paren
op_amp
op_complement
l_int|0x1e0
suffix:semicolon
r_switch
c_cond
(paren
id|db-&gt;op_mode
)paren
(brace
r_case
id|DMFE_10MHF
suffix:colon
id|phy_reg
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_10MFD
suffix:colon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MHF
suffix:colon
id|phy_reg
op_or_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MFD
suffix:colon
id|phy_reg
op_or_assign
l_int|0x100
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|4
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* parter without the N-Way capability */
r_switch
c_cond
(paren
id|db-&gt;op_mode
)paren
(brace
r_case
id|DMFE_10MHF
suffix:colon
id|phy_reg
op_assign
l_int|0x0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_10MFD
suffix:colon
id|phy_reg
op_assign
l_int|0x100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MHF
suffix:colon
id|phy_reg
op_assign
l_int|0x2000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MFD
suffix:colon
id|phy_reg
op_assign
l_int|0x2100
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;   Write a word to Phy register&n; */
DECL|function|phy_write
r_static
r_void
id|phy_write
c_func
(paren
id|u32
id|iobase
comma
id|u8
id|phy_addr
comma
id|u8
id|offset
comma
id|u16
id|phy_data
comma
id|u32
id|chip_id
)paren
(brace
id|u16
id|i
suffix:semicolon
id|u32
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|chip_id
op_eq
id|PCI_DM9132_ID
)paren
(brace
id|ioaddr
op_assign
id|iobase
op_plus
l_int|0x80
op_plus
id|offset
op_star
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|phy_data
comma
id|ioaddr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DM9102/DM9102A Chip */
id|ioaddr
op_assign
id|iobase
op_plus
id|DCR9
suffix:semicolon
multiline_comment|/* Send 33 synchronization clock to Phy controller */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|35
suffix:semicolon
id|i
op_increment
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send start command(01) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send write command(01) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send Phy addres */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|phy_addr
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Send register addres */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|offset
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* written trasnition */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Write a word data to PHY controller */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x8000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|phy_data
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   Read a word data from phy register&n; */
DECL|function|phy_read
r_static
id|u16
id|phy_read
c_func
(paren
id|u32
id|iobase
comma
id|u8
id|phy_addr
comma
id|u8
id|offset
comma
id|u32
id|chip_id
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|phy_data
suffix:semicolon
id|u32
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|chip_id
op_eq
id|PCI_DM9132_ID
)paren
(brace
multiline_comment|/* DM9132 Chip */
id|ioaddr
op_assign
id|iobase
op_plus
l_int|0x80
op_plus
id|offset
op_star
l_int|4
suffix:semicolon
id|phy_data
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DM9102/DM9102A Chip */
id|ioaddr
op_assign
id|iobase
op_plus
id|DCR9
suffix:semicolon
multiline_comment|/* Send 33 synchronization clock to Phy controller */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|35
suffix:semicolon
id|i
op_increment
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send start command(01) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send read command(10) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Send Phy addres */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|phy_addr
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Send register addres */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|offset
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Skip transition state */
id|phy_read_1bit
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* read 16bit data */
r_for
c_loop
(paren
id|phy_data
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phy_data
op_lshift_assign
l_int|1
suffix:semicolon
id|phy_data
op_or_assign
id|phy_read_1bit
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
)brace
r_return
id|phy_data
suffix:semicolon
)brace
multiline_comment|/*&n;   Write one bit data to Phy Controller&n; */
DECL|function|phy_write_1bit
r_static
r_void
id|phy_write_1bit
c_func
(paren
id|u32
id|ioaddr
comma
id|u32
id|phy_data
)paren
(brace
id|outl
c_func
(paren
id|phy_data
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* MII Clock Low */
id|DELAY_1US
suffix:semicolon
id|outl
c_func
(paren
id|phy_data
op_or
id|MDCLKH
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* MII Clock High */
id|DELAY_1US
suffix:semicolon
id|outl
c_func
(paren
id|phy_data
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* MII Clock Low */
id|DELAY_1US
suffix:semicolon
)brace
multiline_comment|/*&n;   Read one bit phy data from PHY controller&n; */
DECL|function|phy_read_1bit
r_static
id|u16
id|phy_read_1bit
c_func
(paren
id|u32
id|ioaddr
)paren
(brace
id|u16
id|phy_data
suffix:semicolon
id|outl
c_func
(paren
l_int|0x50000
comma
id|ioaddr
)paren
suffix:semicolon
id|DELAY_1US
suffix:semicolon
id|phy_data
op_assign
(paren
id|inl
c_func
(paren
id|ioaddr
)paren
op_rshift
l_int|19
)paren
op_amp
l_int|0x1
suffix:semicolon
id|outl
c_func
(paren
l_int|0x40000
comma
id|ioaddr
)paren
suffix:semicolon
id|DELAY_1US
suffix:semicolon
r_return
id|phy_data
suffix:semicolon
)brace
multiline_comment|/*&n;   Calculate the CRC valude of the Rx packet&n;   flag = 1 : return the reverse CRC (for the received packet CRC)&n;   0 : return the normal CRC (for Hash Table index)&n; */
DECL|function|cal_CRC
r_int
r_int
id|cal_CRC
c_func
(paren
r_int
r_char
op_star
id|Data
comma
r_int
r_int
id|Len
comma
id|u8
id|flag
)paren
(brace
r_int
r_int
id|Crc
op_assign
l_int|0xffffffff
suffix:semicolon
r_while
c_loop
(paren
id|Len
op_decrement
)paren
(brace
id|Crc
op_assign
id|CrcTable
(braket
(paren
id|Crc
op_xor
op_star
id|Data
op_increment
)paren
op_amp
l_int|0xFF
)braket
op_xor
(paren
id|Crc
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
)paren
r_return
op_complement
id|Crc
suffix:semicolon
r_else
r_return
id|Crc
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_struct
id|pci_device_id
id|dmfe_pci_tbl
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|0x1282
comma
l_int|0x9132
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9132_ID
)brace
comma
(brace
l_int|0x1282
comma
l_int|0x9102
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9102_ID
)brace
comma
(brace
l_int|0x1282
comma
l_int|0x9100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9100_ID
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dmfe_pci_tbl
)paren
suffix:semicolon
DECL|variable|dmfe_driver
r_static
r_struct
id|pci_driver
id|dmfe_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;dmfe&quot;
comma
id|id_table
suffix:colon
id|dmfe_pci_tbl
comma
id|probe
suffix:colon
id|dmfe_init_one
comma
id|remove
suffix:colon
id|dmfe_remove_one
comma
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sten Wang, sten_wang@davicom.com.tw&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Davicom DM910X fast ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cr6set
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|chkmode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*&t;Description: &n; *&t;when user used insmod to add module, system invoked init_module()&n; *&t;to initilize and register.&n; */
DECL|function|dmfe_init_module
r_static
r_int
id|__init
id|dmfe_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;init_module() &quot;
comma
id|debug
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|dmfe_debug
op_assign
id|debug
suffix:semicolon
multiline_comment|/* set debug flag */
r_if
c_cond
(paren
id|cr6set
)paren
id|dmfe_cr6_user_set
op_assign
id|cr6set
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
id|dmfe_media_mode
op_assign
id|mode
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dmfe_media_mode
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rc
op_assign
id|pci_register_driver
c_func
(paren
op_amp
id|dmfe_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;Davicom DM91xx net driver loaded, version &quot;
id|DMFE_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Description: &n; *&t;when user used rmmod to delete module, system invoked clean_module()&n; *&t;to un-register all registered services.&n; */
DECL|function|dmfe_cleanup_module
r_static
r_void
id|__exit
id|dmfe_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|dmfe_driver
)paren
suffix:semicolon
)brace
DECL|variable|dmfe_init_module
id|module_init
c_func
(paren
id|dmfe_init_module
)paren
suffix:semicolon
DECL|variable|dmfe_cleanup_module
id|module_exit
c_func
(paren
id|dmfe_cleanup_module
)paren
suffix:semicolon
eof
