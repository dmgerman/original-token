multiline_comment|/*&n; *  An Ethernet driver for the dual-function NCR 53C885 SCSI/Ethernet&n; *  controller.&n; *&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;ncr885e.c:v1.0 02/10/00 dan@synergymicro.com, cort@fsmlabs.com&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;ncr885e.h&quot;
macro_line|#include &quot;ncr885_debug.h&quot;
DECL|variable|chipname
r_static
r_const
r_char
op_star
id|chipname
op_assign
l_string|&quot;ncr885e&quot;
suffix:semicolon
DECL|macro|NCR885E_DEBUG
mdefine_line|#define NCR885E_DEBUG   0
multiline_comment|/* The 885&squot;s Ethernet PCI device id. */
macro_line|#ifndef PCI_DEVICE_ID_NCR_53C885_ETHERNET
DECL|macro|PCI_DEVICE_ID_NCR_53C885_ETHERNET
mdefine_line|#define PCI_DEVICE_ID_NCR_53C885_ETHERNET  0x0701
macro_line|#endif
DECL|macro|NR_RX_RING
mdefine_line|#define NR_RX_RING    8
DECL|macro|NR_TX_RING
mdefine_line|#define NR_TX_RING    8
DECL|macro|MAX_TX_ACTIVE
mdefine_line|#define MAX_TX_ACTIVE (NR_TX_RING-1)
DECL|macro|NCMDS_TX
mdefine_line|#define NCMDS_TX      NR_TX_RING
DECL|macro|RX_BUFLEN
mdefine_line|#define RX_BUFLEN     (ETH_FRAME_LEN + 8)
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT    5*HZ
DECL|macro|NCR885E_TOTAL_SIZE
mdefine_line|#define NCR885E_TOTAL_SIZE 0xe0
DECL|macro|TXSR
mdefine_line|#define TXSR          (1&lt;&lt;6)   /* tx: xfer status written */
DECL|macro|TXABORT
mdefine_line|#define TXABORT       (1&lt;&lt;7)   /* tx: abort */
DECL|macro|EOP
mdefine_line|#define EOP           (1&lt;&lt;7)   /* rx: end of packet written to buffer */
DECL|variable|ncr885e_debug
r_int
id|ncr885e_debug
op_assign
id|NCR885E_DEBUG
suffix:semicolon
DECL|variable|print_version
r_static
r_int
id|print_version
op_assign
l_int|0
suffix:semicolon
DECL|struct|ncr885e_private
r_struct
id|ncr885e_private
(brace
multiline_comment|/* preserve a 1-1 marking with buffs */
DECL|member|head
r_struct
id|dbdma_cmd
op_star
id|head
suffix:semicolon
DECL|member|tx_cmds
r_struct
id|dbdma_cmd
op_star
id|tx_cmds
suffix:semicolon
DECL|member|rx_cmds
r_struct
id|dbdma_cmd
op_star
id|rx_cmds
suffix:semicolon
DECL|member|stop_cmd
r_struct
id|dbdma_cmd
op_star
id|stop_cmd
suffix:semicolon
DECL|member|tx_skbufs
r_struct
id|sk_buff
op_star
id|tx_skbufs
(braket
id|NR_TX_RING
)braket
suffix:semicolon
DECL|member|rx_skbufs
r_struct
id|sk_buff
op_star
id|rx_skbufs
(braket
id|NR_RX_RING
)braket
suffix:semicolon
DECL|member|rx_current
r_int
id|rx_current
suffix:semicolon
DECL|member|rx_dirty
r_int
id|rx_dirty
suffix:semicolon
DECL|member|tx_dirty
r_int
id|tx_dirty
suffix:semicolon
DECL|member|tx_current
r_int
id|tx_current
suffix:semicolon
DECL|member|tx_status
r_int
r_int
id|tx_status
(braket
id|NR_TX_RING
)braket
suffix:semicolon
DECL|member|tx_fullup
r_int
r_char
id|tx_fullup
suffix:semicolon
DECL|member|tx_active
r_int
r_char
id|tx_active
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|tx_timeout
r_struct
id|timer_list
id|tx_timeout
suffix:semicolon
DECL|member|timeout_active
r_int
id|timeout_active
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|root_dev
r_static
r_struct
id|net_device
op_star
id|root_dev
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|ncr885e_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ncr885e_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ncr885e_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ncr885e_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ncr885e_probe1
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
r_char
id|irq
)paren
suffix:semicolon
r_static
r_int
id|ncr885e_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ncr885e_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ncr885e_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ncr885e_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ncr885e_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|ncr885e_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|show_dbdma_cmd
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cmd
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
r_int
id|ioadddr
comma
r_int
id|location
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef NCR885E_DEBUG_MII
r_static
r_void
id|show_mii
c_func
(paren
r_int
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|read_mii
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
id|reg
)paren
suffix:semicolon
r_static
r_void
id|write_mii
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
id|reg
comma
r_int
id|data
)paren
suffix:semicolon
macro_line|#endif /* NCR885E_DEBUG_MII */
DECL|macro|TX_RESET_FLAGS
mdefine_line|#define TX_RESET_FLAGS    (TX_CHANNEL_RUN|TX_CHANNEL_PAUSE|TX_CHANNEL_WAKE)
DECL|macro|RX_RESET_FLAGS
mdefine_line|#define RX_RESET_FLAGS    (RX_CHANNEL_RUN|RX_CHANNEL_PAUSE|RX_CHANNEL_WAKE)
DECL|variable|__initdata
r_static
r_struct
id|pci_device_id
id|ncr885e_pci_tbl
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_NCR
comma
id|PCI_DEVICE_ID_NCR_53C885_ETHERNET
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ncr885e_pci_tbl
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|debug_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|req
comma
r_int
id|cmd
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ncr885e_private
op_star
id|data
suffix:semicolon
r_struct
id|ncr885e_regs
op_star
id|regs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_union
(brace
r_struct
id|ncr885e_regs
id|dump
suffix:semicolon
r_struct
id|ncr885e_private
id|priv
suffix:semicolon
)brace
id|temp
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* dump the rx ring status */
r_case
id|NCR885E_GET_PRIV
suffix:colon
id|data
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
op_amp
id|req-&gt;ifr_data
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
op_amp
id|req-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|ncr885e_private
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|temp.priv
comma
id|sp
comma
r_sizeof
(paren
r_struct
id|ncr885e_private
)paren
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|data
comma
(paren
r_char
op_star
)paren
op_amp
id|temp.priv
comma
r_sizeof
(paren
r_struct
id|ncr885e_private
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NCR885E_GET_REGS
suffix:colon
id|regs
op_assign
(paren
r_struct
id|ncr885e_regs
op_star
)paren
op_amp
id|req-&gt;ifr_data
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
op_amp
id|req-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|ncr885e_regs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|temp.dump.tx_status
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TX_CHANNEL_STATUS
)paren
suffix:semicolon
id|temp.dump.rx_status
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RX_CHANNEL_STATUS
)paren
suffix:semicolon
id|temp.dump.mac_config
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
id|temp.dump.tx_control
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|temp.dump.rx_control
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|temp.dump.tx_cmd_ptr
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TX_CMD_PTR_LO
)paren
suffix:semicolon
id|temp.dump.rx_cmd_ptr
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RX_CMD_PTR_LO
)paren
suffix:semicolon
id|temp.dump.int_status
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT_STATUS_REG
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|regs
comma
(paren
r_char
op_star
)paren
op_amp
id|temp.dump
comma
r_sizeof
(paren
r_struct
id|ncr885e_regs
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*  Enable interrupts on the 53C885 */
r_static
r_inline
r_void
DECL|function|ncr885e_enable
id|ncr885e_enable
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|reg
suffix:semicolon
id|reg
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT_ENABLE
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
op_or
id|INTERRUPT_INTE
comma
id|ioaddr
op_plus
id|INTERRUPT_ENABLE
)paren
suffix:semicolon
)brace
multiline_comment|/*  Disable interrupts on the 53c885 */
r_static
r_inline
r_void
DECL|function|ncr885e_disable
id|ncr885e_disable
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|reg
suffix:semicolon
id|reg
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT_ENABLE
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
op_amp
op_complement
id|INTERRUPT_INTE
comma
id|ioaddr
op_plus
id|INTERRUPT_ENABLE
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ncr885e_reset
id|ncr885e_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
r_int
r_int
id|cntl
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Resetting 53C885...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* disable interrupts on the 53C885 */
id|ncr885e_disable
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* disable rx in the MAC */
id|reg
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
op_amp
op_complement
id|MAC_CONFIG_RXEN
comma
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
op_amp
id|MAC_CONFIG_RXEN
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|reg
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
op_or
id|MAC_CONFIG_SRST
comma
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
multiline_comment|/* disable both rx and tx DBDMA channels */
id|outl
c_func
(paren
id|TX_DBDMA_ENABLE
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|TX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|outl
c_func
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_CHANNEL_STATUS
)paren
op_amp
id|TX_DBDMA_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RX_CHANNEL_STATUS
)paren
op_amp
id|RX_DBDMA_ENABLE
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* perform a &quot;software reset&quot; */
id|cntl
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DBDMA_CONTROL
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cntl
op_or
id|DBDMA_SRST
comma
id|ioaddr
op_plus
id|DBDMA_CONTROL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DBDMA_CONTROL
)paren
op_amp
id|DBDMA_SRST
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* books says that a software reset should be done to the MAC, as&n;&t;   well.  This true??? */
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: reset complete&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*  configure the 53C885 chip.&n;&n;    The DBDMA command descriptors on the 53C885 can be programmed to&n;    branch, interrupt or pause conditionally or always by using the&n;    interrupt, branch and wait select registers.  */
r_static
r_void
DECL|function|ncr885e_config
id|ncr885e_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Configuring 53C885.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ncr885e_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* The 53C885 can be programmed to perform conditional DBDMA&n;&t;   branches, interrupts or waits.&n;  &n;&t;   Neither channel makes use of &quot;wait&quot;, as it requires that the&n;&t;   DBDMA engine to be restarted.  Don&squot;t go there.  The rx channel&n;&t;   will branch upon the successful reception of a packet (&squot;EOP&squot; in&n;&t;   the xfer_status field).  The branch address is to the STOP&n;&t;   DBDMA command descriptor, which shuts down the rx channel until&n;&t;   the interrupt is serviced.   */
multiline_comment|/* cause tx channel to stop after &quot;status received&quot; */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TX_INT_SELECT
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|TX_WAIT_STAT_RECV
op_lshift
l_int|16
)paren
op_or
id|TX_WAIT_STAT_RECV
comma
id|ioaddr
op_plus
id|TX_WAIT_SELECT
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TX_BRANCH_SELECT
)paren
suffix:semicolon
multiline_comment|/* cause rx channel to branch to the STOP descriptor on &quot;End-of-Packet&quot; */
macro_line|#if 0
id|outl
c_func
(paren
(paren
id|RX_INT_SELECT_EOP
op_lshift
l_int|16
)paren
op_or
id|RX_INT_SELECT_EOP
comma
id|ioaddr
op_plus
id|RX_INT_SELECT
)paren
suffix:semicolon
macro_line|#else
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RX_INT_SELECT
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RX_WAIT_SELECT
)paren
suffix:semicolon
macro_line|#else
id|outl
c_func
(paren
(paren
id|RX_WAIT_SELECT_EOP
op_lshift
l_int|16
)paren
op_or
id|RX_WAIT_SELECT_EOP
comma
id|ioaddr
op_plus
id|RX_WAIT_SELECT
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 1
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RX_BRANCH_SELECT
)paren
suffix:semicolon
macro_line|#else
id|outl
c_func
(paren
(paren
id|RX_BRANCH_SELECT_EOP
op_lshift
l_int|16
)paren
op_or
id|RX_BRANCH_SELECT_EOP
comma
id|ioaddr
op_plus
id|RX_BRANCH_SELECT
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* configure DBDMA */
id|outl
c_func
(paren
(paren
id|DBDMA_BE
op_or
id|DBDMA_DPMRLE
op_or
id|DBDMA_TDPCE
op_or
id|DBDMA_DDPE
op_or
id|DBDMA_TDPE
op_or
(paren
id|DBDMA_BURST_4
op_lshift
id|DBDMA_TX_BST_SHIFT
)paren
op_or
(paren
id|DBDMA_BURST_4
op_lshift
id|DBDMA_RX_BST_SHIFT
)paren
op_or
(paren
id|DBDMA_TX_ARBITRATION_DEFAULT
)paren
op_or
(paren
id|DBDMA_RX_ARBITRATION_DEFAULT
)paren
)paren
comma
id|ioaddr
op_plus
id|DBDMA_CONTROL
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TX_THRESHOLD
)paren
suffix:semicolon
multiline_comment|/* disable MAC loopback */
id|outl
c_func
(paren
(paren
id|MAC_CONFIG_ITXA
op_or
id|MAC_CONFIG_RXEN
op_or
id|MAC_CONFIG_RETRYL
op_or
id|MAC_CONFIG_PADEN
op_or
(paren
l_int|0x18
op_lshift
l_int|16
)paren
)paren
comma
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
multiline_comment|/* configure MAC */
id|outl
c_func
(paren
(paren
id|MAC_CONFIG_ITXA
op_or
id|MAC_CONFIG_RXEN
op_or
id|MAC_CONFIG_RETRYL
op_or
id|MAC_CONFIG_PADEN
op_or
(paren
l_int|0x18
op_lshift
l_int|16
)paren
)paren
comma
id|ioaddr
op_plus
id|MAC_CONFIG
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
l_int|0x1018
)paren
comma
id|ioaddr
op_plus
id|NBTOB_INTP_GAP
)paren
suffix:semicolon
multiline_comment|/* clear and enable interrupts */
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT_CLEAR
)paren
suffix:semicolon
id|ncr885e_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* and enable them in the chip */
id|outl
c_func
(paren
(paren
id|INTERRUPT_INTE
op_or
id|INTERRUPT_TX_MASK
op_or
id|INTERRUPT_RX_MASK
)paren
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|INTERRUPT_ENABLE
op_minus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 53C885 config complete.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;   transmit interrupt  */
r_static
r_void
DECL|function|ncr885e_tx
id|ncr885e_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
comma
op_star
id|dp
suffix:semicolon
r_int
r_int
id|txbits
comma
id|xfer
suffix:semicolon
r_int
id|i
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|sp-&gt;tx_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ncr885e_tx: active=%d, dirty=%d, current=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;tx_active
comma
id|sp-&gt;tx_dirty
comma
id|sp-&gt;tx_current
)paren
suffix:semicolon
id|sp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|sp-&gt;tx_dirty
suffix:semicolon
id|cp
op_assign
id|sp-&gt;tx_cmds
op_plus
(paren
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|dp
op_assign
id|cp
op_plus
l_int|1
suffix:semicolon
id|sp-&gt;tx_active
op_decrement
suffix:semicolon
id|xfer
op_assign
id|inw
c_func
(paren
op_amp
id|dp-&gt;xfer_status
)paren
suffix:semicolon
id|txbits
op_assign
id|inw
c_func
(paren
op_amp
id|sp-&gt;tx_status
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|4
)paren
(brace
id|show_dbdma_cmd
c_func
(paren
id|cp
)paren
suffix:semicolon
id|show_dbdma_cmd
c_func
(paren
id|dp
)paren
suffix:semicolon
)brace
multiline_comment|/* get xmit result */
id|txbits
op_assign
id|inw
c_func
(paren
op_amp
id|sp-&gt;tx_status
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx xfer=%04x, txbits=%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|xfer
comma
id|txbits
)paren
suffix:semicolon
multiline_comment|/* look for any channel status (?) */
r_if
c_cond
(paren
id|xfer
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|sp-&gt;tx_skbufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txbits
op_amp
id|TX_STATUS_TXOK
)paren
(brace
id|sp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|sp-&gt;stats.tx_bytes
op_add_assign
id|inw
c_func
(paren
op_amp
id|cp-&gt;req_count
)paren
suffix:semicolon
)brace
multiline_comment|/* dropped packets */
r_if
c_cond
(paren
id|txbits
op_amp
(paren
id|TX_STATUS_TDLC
op_or
id|TX_STATUS_TDEC
)paren
)paren
(brace
id|sp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
multiline_comment|/* add the collisions */
id|sp-&gt;stats.collisions
op_add_assign
(paren
id|txbits
op_amp
l_int|0x04
)paren
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*  rx interrupt handling */
r_static
r_void
DECL|function|ncr885e_rx
id|ncr885e_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
comma
id|nb
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_char
op_star
id|data
comma
op_star
id|stats
suffix:semicolon
r_int
r_int
id|rxbits
comma
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|i
op_assign
id|sp-&gt;rx_current
suffix:semicolon
id|cp
op_assign
id|sp-&gt;rx_cmds
op_plus
(paren
id|i
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ncr885e_rx dirty=%d, current=%d (cp@%p)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;rx_dirty
comma
id|sp-&gt;rx_current
comma
id|cp
)paren
suffix:semicolon
id|nb
op_assign
id|inw
c_func
(paren
op_amp
id|cp-&gt;req_count
)paren
op_minus
id|inw
c_func
(paren
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: (rx %d) bytes=%d, xfer_status=%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|nb
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|skb
op_assign
id|sp-&gt;rx_skbufs
(braket
id|i
)braket
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|stats
op_assign
id|data
op_plus
id|nb
op_minus
l_int|3
suffix:semicolon
id|rxbits
op_assign
(paren
id|stats
(braket
l_int|0
)braket
op_or
id|stats
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|stats
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  rx_bits=%06lx&bslash;n&quot;
comma
id|rxbits
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|nb
op_minus
l_int|3
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|sp-&gt;rx_skbufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rxbits
op_amp
id|RX_STATUS_RXOK
)paren
(brace
id|sp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|sp-&gt;stats.rx_bytes
op_add_assign
id|nb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxbits
op_amp
id|RX_STATUS_MCAST
)paren
id|sp-&gt;stats.multicast
op_increment
suffix:semicolon
)brace
id|sp-&gt;rx_dirty
op_assign
id|sp-&gt;rx_current
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|sp-&gt;rx_current
op_ge
id|NR_RX_RING
)paren
id|sp-&gt;rx_current
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fix up the one we just trashed */
id|cp
op_assign
id|sp-&gt;rx_cmds
op_plus
(paren
id|sp-&gt;rx_dirty
op_star
l_int|2
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUFLEN
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|0
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|sp-&gt;rx_skbufs
(braket
id|sp-&gt;rx_dirty
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ncr885e_rx: using ring index %d, filling cp @ %p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;rx_current
comma
id|cp
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RX_BUFLEN
comma
op_amp
id|cp-&gt;req_count
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|data
)paren
comma
op_amp
id|cp-&gt;phy_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
id|cp
op_assign
id|sp-&gt;rx_cmds
op_plus
(paren
id|sp-&gt;rx_current
op_star
l_int|2
)paren
suffix:semicolon
multiline_comment|/* restart rx DMA */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|cp
)paren
comma
id|ioaddr
op_plus
id|RX_CMD_PTR_LO
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
op_or
id|RX_CHANNEL_RUN
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncr885e_misc_ints
id|ncr885e_misc_ints
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|status
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;miscellaneous interrupt handled; status=%02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* various transmit errors */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|INTERRUPT_PPET
op_or
id|INTERRUPT_PBFT
op_or
id|INTERRUPT_IIDT
)paren
)paren
(brace
multiline_comment|/* illegal instruction in tx dma */
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_IIDT
)paren
(brace
id|cp
op_assign
(paren
r_struct
id|dbdma_cmd
op_star
)paren
id|bus_to_virt
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TX_CMD_PTR_LO
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx illegal insn:&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; tx DBDMA - cmd = %p, status = %04x&bslash;n&quot;
comma
id|cp
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_CHANNEL_STATUS
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; command = %04x, phy_addr=%08x, req_count=%04x&bslash;n&quot;
comma
id|inw
c_func
(paren
op_amp
id|cp-&gt;command
)paren
comma
id|inw
c_func
(paren
op_amp
id|cp-&gt;phy_addr
)paren
comma
id|inw
c_func
(paren
op_amp
id|cp-&gt;req_count
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_PPET
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx PCI parity error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_PBFT
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx PCI bus fault&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* look for rx errors */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|INTERRUPT_PPER
op_or
id|INTERRUPT_PBFR
op_or
id|INTERRUPT_IIDR
)paren
)paren
(brace
multiline_comment|/* illegal instruction in rx dma */
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_IIDR
)paren
(brace
macro_line|#if 0
id|cmd
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RX_CMD_PTR_LO
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: rx illegal DMA instruction:&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;    channel status=%04x,&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RX_CHANNEL_STATUS
)paren
)paren
suffix:semicolon
macro_line|#if 0
id|show_dbdma_cmd
c_func
(paren
id|bus_to_virt
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RX_CMD_PTR_LO
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;    instr (%08x) %08x %08x %08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd
comma
id|cmd
(braket
l_int|0
)braket
comma
id|cmd
(braket
l_int|1
)braket
comma
id|cmd
(braket
l_int|2
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* PCI parity error */
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_PPER
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rx PCI parity error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_PBFR
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rx PCI bus fault&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_WI
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link pulse&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* bump any counters */
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncr885e_interrupt
id|ncr885e_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|ncr885e_private
op_star
id|sp
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;symba: Interrupt IRQ %d for unknown device&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT_CLEAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 53C885 interrupt 0x%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* handle non-tx and rx interrupts first */
r_if
c_cond
(paren
id|status
op_amp
op_complement
(paren
id|INTERRUPT_DIT
op_or
id|INTERRUPT_DIR
)paren
)paren
id|ncr885e_misc_ints
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* look for tx interrupt: more to transmit, DBDMA stopped, or tx done */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|INTERRUPT_DIT
)paren
)paren
(brace
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx int; int=%02x, chan stat=%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TX_CHANNEL_STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* turn off timer */
id|del_timer
c_func
(paren
op_amp
id|sp-&gt;tx_timeout
)paren
suffix:semicolon
id|sp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop DMA */
id|outl
c_func
(paren
id|TX_DBDMA_ENABLE
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|TX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|ncr885e_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|INTERRUPT_DIR
)paren
(brace
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rx interrupt; int=%02x, rx channel stat=%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RX_CHANNEL_STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* stop DMA */
id|outl
c_func
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
multiline_comment|/* and handle the interrupt */
id|ncr885e_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*  doesn&squot;t set the address permanently, however... */
r_static
r_int
DECL|function|ncr885e_set_address
id|ncr885e_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sockaddr
op_star
id|saddr
op_assign
id|addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|reg
(braket
l_int|3
)braket
suffix:semicolon
r_int
r_char
op_star
id|ioaddr
comma
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|saddr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: setting new MAC address - &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;dev_addr
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%c%2.2x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
op_star
id|p
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|reg
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: Setting new mac address - &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|p
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* stop rx for the change */
id|outl
c_func
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ioaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg
(braket
id|i
)braket
op_assign
(paren
(paren
id|reg
(braket
id|i
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|reg
(braket
id|i
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%04x &quot;
comma
id|reg
(braket
id|i
)braket
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|STATION_ADDRESS_0
op_plus
(paren
id|i
op_star
l_int|2
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* restart rx */
id|outl
c_func
(paren
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
op_or
id|RX_CHANNEL_RUN
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncr885e_tx_timeout
id|ncr885e_tx_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
comma
id|ioaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|sp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|sp-&gt;tx_dirty
suffix:semicolon
multiline_comment|/* if we weren&squot;t active, bail... */
r_if
c_cond
(paren
id|sp-&gt;tx_active
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ncr885e_timeout...tx not active!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 53C885 timed out.  Resetting...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* disable rx and tx DMA */
id|outl
c_func
(paren
(paren
id|TX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
comma
id|ioaddr
op_plus
id|TX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
multiline_comment|/* reset the chip */
id|ncr885e_config
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ncr885e_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* clear the wedged skb in the tx ring */
id|sp-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
op_increment
id|sp-&gt;stats.tx_errors
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;tx_skbufs
(braket
id|i
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|sp-&gt;tx_skbufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|sp-&gt;tx_skbufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* start anew from the beginning of the ring buffer (why not?) */
id|sp-&gt;tx_current
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* restart rx dma */
id|outl
c_func
(paren
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
op_or
id|RX_CHANNEL_RUN
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|out
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ncr885e_set_timeout
id|ncr885e_set_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;timeout_active
)paren
id|del_timer
c_func
(paren
op_amp
id|sp-&gt;tx_timeout
)paren
suffix:semicolon
id|sp-&gt;tx_timeout.expires
op_assign
id|jiffies
op_plus
id|TX_TIMEOUT
suffix:semicolon
id|sp-&gt;tx_timeout.function
op_assign
id|ncr885e_tx_timeout
suffix:semicolon
id|sp-&gt;tx_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sp-&gt;tx_timeout
)paren
suffix:semicolon
id|sp-&gt;timeout_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  The goal is to set up DBDMA such that the rx ring contains only&n; *  one DMA descriptor per ring element and the tx ring has two (using&n; *  the cool features of branch- and wait-select.  However, I&squot;m not sure&n; *  if it&squot;s possible.  For now, we plod through it with 3 descriptors&n; *  for tx, and two for rx.&n; */
r_static
r_int
DECL|function|ncr885e_open
id|ncr885e_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* allocate enough space for the tx and rx rings and a STOP descriptor */
id|size
op_assign
(paren
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
op_star
(paren
(paren
id|NR_TX_RING
op_star
l_int|3
)paren
op_plus
(paren
id|NR_RX_RING
op_star
l_int|2
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|cp
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Insufficient memory (%d bytes) for DBDMA&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|sp-&gt;lock
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|cp
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|sp-&gt;head
op_assign
id|cp
suffix:semicolon
id|sp-&gt;stop_cmd
op_assign
id|cp
suffix:semicolon
id|outl
c_func
(paren
id|DBDMA_STOP
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
id|sp-&gt;rx_cmds
op_assign
op_increment
id|cp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cp
op_assign
id|sp-&gt;rx_cmds
op_plus
(paren
id|i
op_star
l_int|2
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_BUFLEN
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* if there is insufficient memory, make this last ring use a &n;&t;&t;   static buffer and leave the loop with that skb as final one */
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient memory for rx ring buffer&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|sp-&gt;rx_skbufs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* The DMA commands here are done such that an EOP is the only&n;&t;&t;   way that we should get an interrupt.  This means that we could&n;&t;&t;   fill more than one skbuff before getting the interrupt at EOP. */
multiline_comment|/* Handle rx DMA such that it always interrupts.... */
id|outw
c_func
(paren
(paren
id|INPUT_MORE
op_or
id|INTR_ALWAYS
)paren
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RX_BUFLEN
comma
op_amp
id|cp-&gt;req_count
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|data
)paren
comma
op_amp
id|cp-&gt;phy_addr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sp-&gt;stop_cmd
)paren
comma
op_amp
id|cp-&gt;cmd_dep
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;rx at %p&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
id|show_dbdma_cmd
c_func
(paren
id|cp
)paren
suffix:semicolon
macro_line|#endif
op_increment
id|cp
suffix:semicolon
id|outw
c_func
(paren
id|DBDMA_STOP
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize to all rx buffers are available, fill limit is the end */
id|sp-&gt;rx_dirty
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;rx_current
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fill the tx ring */
id|sp-&gt;tx_cmds
op_assign
id|cp
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* minimal setup for tx command */
id|cp
op_assign
id|sp-&gt;tx_cmds
op_plus
(paren
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|outw
c_func
(paren
id|OUTPUT_LAST
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tx OUTPUT_LAST at %p&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
id|show_dbdma_cmd
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
multiline_comment|/* full setup for the status cmd */
id|cp
op_increment
suffix:semicolon
id|outw
c_func
(paren
id|INPUT_LAST
op_or
id|INTR_ALWAYS
op_or
id|WAIT_IFCLR
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|sp-&gt;tx_status
(braket
id|i
)braket
)paren
comma
op_amp
id|cp-&gt;phy_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|2
comma
op_amp
id|cp-&gt;req_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tx INPUT_LAST cmd at %p&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
id|show_dbdma_cmd
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
op_increment
id|cp
suffix:semicolon
id|outw
c_func
(paren
id|DBDMA_STOP
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* chain the last tx DMA command to the STOP cmd */
id|outw
c_func
(paren
(paren
id|INPUT_LAST
op_or
id|INTR_ALWAYS
op_or
id|BR_ALWAYS
)paren
comma
op_amp
id|cp-&gt;command
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sp-&gt;stop_cmd
)paren
comma
op_amp
id|cp-&gt;cmd_dep
)paren
suffix:semicolon
macro_line|#endif
id|sp-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;tx_current
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;tx_dirty
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* the order seems important here for some reason.  If the MPIC isn&squot;t&n;&t;   enabled before the ethernet chip is enabled, shrapnel from the&n;&t;   bootloader causes us to receive interrupts even though we&squot;ve not &n;&t;   yet enabled the tx channel.  Go figure.  It&squot;d be better to configure&n;&t;   the chip in the probe1() routine, but then we don&squot;t see interrupts&n;&t;   at all.  Everything looks all right on the logic analyzer, but... */
id|ncr885e_config
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* enable ethernet interrupts */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|ncr885e_interrupt
comma
id|SA_SHIRQ
comma
id|chipname
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
(paren
r_void
)paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|INTERRUPT_CLEAR
)paren
suffix:semicolon
id|ncr885e_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* start rx DBDMA */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sp-&gt;rx_cmds
)paren
comma
id|ioaddr
op_plus
id|RX_CMD_PTR_LO
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
op_or
id|RX_CHANNEL_RUN
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ncr885e_xmit_start
id|ncr885e_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|sp
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cp
comma
op_star
id|dp
suffix:semicolon
r_int
r_int
id|flags
comma
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|len
comma
id|next
comma
id|fill
comma
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: xmit_start len=%d, dirty=%d, current=%d, active=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
comma
id|sp-&gt;tx_dirty
comma
id|sp-&gt;tx_current
comma
id|sp-&gt;tx_active
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* find the free slot in the ring buffer */
id|fill
op_assign
id|sp-&gt;tx_current
suffix:semicolon
id|next
op_assign
id|fill
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ge
id|NR_TX_RING
)paren
id|next
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
multiline_comment|/* mark ourselves as busy, even if we have too many packets waiting */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* see if it&squot;s necessary to defer this packet */
r_if
c_cond
(paren
id|sp-&gt;tx_active
op_ge
id|MAX_TX_ACTIVE
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|sp-&gt;tx_active
op_increment
suffix:semicolon
multiline_comment|/* bump &quot;active tx&quot; count */
id|sp-&gt;tx_current
op_assign
id|next
suffix:semicolon
multiline_comment|/* and show that we&squot;ve used this buffer */
id|sp-&gt;tx_dirty
op_assign
id|fill
suffix:semicolon
multiline_comment|/* and mark this one to get picked up */
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|ETH_FRAME_LEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: xmit frame too long (%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
id|len
op_assign
id|ETH_FRAME_LEN
suffix:semicolon
)brace
multiline_comment|/* get index into the tx DBDMA chain */
id|entry
op_assign
id|fill
op_star
l_int|3
suffix:semicolon
id|sp-&gt;tx_skbufs
(braket
id|fill
)braket
op_assign
id|skb
suffix:semicolon
id|cp
op_assign
id|sp-&gt;tx_cmds
op_plus
id|entry
suffix:semicolon
id|dp
op_assign
id|cp
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* update the rest of the OUTPUT_MORE descriptor */
id|outw
c_func
(paren
id|len
comma
op_amp
id|cp-&gt;req_count
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
op_amp
id|cp-&gt;phy_addr
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
multiline_comment|/* and finish off the INPUT_MORE */
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|dp-&gt;xfer_status
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
op_amp
id|dp-&gt;res_count
)paren
suffix:semicolon
id|sp-&gt;tx_status
(braket
id|fill
)braket
op_assign
l_int|0
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|sp-&gt;tx_status
(braket
id|fill
)braket
)paren
comma
op_amp
id|dp-&gt;phy_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: xmit_start: active %d, tx_current %d, tx_dirty %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sp-&gt;tx_active
comma
id|sp-&gt;tx_current
comma
id|sp-&gt;tx_dirty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|4
)paren
(brace
id|show_dbdma_cmd
c_func
(paren
id|cp
)paren
suffix:semicolon
id|show_dbdma_cmd
c_func
(paren
id|dp
)paren
suffix:semicolon
)brace
multiline_comment|/* restart the tx DMA engine */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|cp
)paren
comma
id|ioaddr
op_plus
id|TX_CMD_PTR_LO
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|TX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
op_or
id|TX_CHANNEL_RUN
comma
id|ioaddr
op_plus
id|TX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|ncr885e_set_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ncr885e_close
id|ncr885e_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ncr885e_private
op_star
id|np
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NCR885E Ethernet closing...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down Ethernet chip&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ncr885e_disable
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|np-&gt;tx_timeout
)paren
suffix:semicolon
multiline_comment|/* flip off rx and tx */
id|outl
c_func
(paren
(paren
id|RX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
comma
id|ioaddr
op_plus
id|RX_CHANNEL_CONTROL
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|TX_DBDMA_ENABLE
op_lshift
l_int|16
)paren
comma
id|ioaddr
op_plus
id|TX_CHANNEL_CONTROL
)paren
suffix:semicolon
multiline_comment|/* free up the IRQ */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;rx_skbufs
(braket
id|i
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|np-&gt;rx_skbufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|np-&gt;rx_skbufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TX_RING
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;tx_skbufs
(braket
id|i
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|np-&gt;tx_skbufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|np-&gt;tx_skbufs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np-&gt;head
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  multicast promiscuous mode isn&squot;t used here.  Allow code in the&n; *  IP stack to determine which multicast packets are good or bad....&n; *  (this avoids having to use the hash table registers)&n; */
r_static
r_void
DECL|function|ncr885e_set_multicast
id|ncr885e_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|ncr885e_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: set_multicast: dev-&gt;flags = %x, AF=%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;flags
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|ADDRESS_FILTER
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outw
c_func
(paren
id|ADDRESS_RPPRO
comma
id|ioaddr
op_plus
id|ADDRESS_FILTER
)paren
suffix:semicolon
)brace
multiline_comment|/* accept all multicast packets without checking the mc_list.  */
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling all multicast packets.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outw
c_func
(paren
id|ADDRESS_RPPRM
comma
id|ioaddr
op_plus
id|ADDRESS_FILTER
)paren
suffix:semicolon
)brace
multiline_comment|/* enable broadcast rx */
r_else
(brace
id|outw
c_func
(paren
id|ADDRESS_RPABC
comma
id|ioaddr
op_plus
id|ADDRESS_FILTER
)paren
suffix:semicolon
)brace
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|ncr885e_stats
id|ncr885e_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ncr885e_private
op_star
id|np
op_assign
(paren
r_struct
id|ncr885e_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|np-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*  By this function, we&squot;re certain that we have a 885 Ethernet controller&n; *  so we finish setting it up and wrap up all the required Linux ethernet&n; *  configuration.&n; */
DECL|function|ncr885e_probe1
r_static
r_int
id|__init
id|ncr885e_probe1
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
r_char
id|irq
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ncr885e_private
op_star
id|sp
suffix:semicolon
r_int
r_int
id|station_addr
(braket
l_int|3
)braket
comma
id|val
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|ncr885e_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* snag the station address and display it */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|STATION_ADDRESS_0
op_plus
(paren
id|i
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|station_addr
(braket
id|i
)braket
op_assign
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|val
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at %08lx,&quot;
comma
id|dev-&gt;name
comma
id|chipname
comma
id|ioaddr
)paren
suffix:semicolon
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|station_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c%2.2x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;, IRQ %d.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* set up a timer */
id|init_timer
c_func
(paren
op_amp
id|sp-&gt;tx_timeout
)paren
suffix:semicolon
id|sp-&gt;timeout_active
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* everything else */
id|dev-&gt;open
op_assign
id|ncr885e_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ncr885e_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ncr885e_stats
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ncr885e_xmit_start
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ncr885e_set_multicast
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|ncr885e_set_address
suffix:semicolon
id|root_dev
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  Since the NCR 53C885 is a multi-function chip, I&squot;m not worrying about&n; *  trying to get the the device(s) in slot order.  For our (Synergy&squot;s)&n; *  purpose, there&squot;s just a single 53C885 on the board and we don&squot;t &n; *  worry about the rest.&n; */
DECL|function|ncr885e_probe
r_static
r_int
id|__init
id|ncr885e_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|ioaddr
comma
id|ret
suffix:semicolon
r_int
r_char
id|irq
suffix:semicolon
multiline_comment|/* use &squot;if&squot; not &squot;while&squot; where because driver only supports one device */
r_if
c_cond
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_NCR
comma
id|PCI_DEVICE_ID_NCR_53C885_ETHERNET
comma
id|pdev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|print_version
)paren
(brace
id|print_version
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Use I/O space */
id|ioaddr
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|ioaddr
comma
id|NCR885E_TOTAL_SIZE
comma
l_string|&quot;ncr885e&quot;
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* finish off the probe */
id|ret
op_assign
id|ncr885e_probe1
c_func
(paren
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|release_region
c_func
(paren
id|ioaddr
comma
id|NCR885E_TOTAL_SIZE
)paren
suffix:semicolon
r_else
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* debugging to peek at dma descriptors */
r_static
r_void
DECL|function|show_dbdma_cmd
id|show_dbdma_cmd
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cmd
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; cmd %04x, physaddr %08x, req_count %04x&bslash;n&quot;
comma
id|inw
c_func
(paren
op_amp
id|cmd-&gt;command
)paren
comma
id|inl
c_func
(paren
op_amp
id|cmd-&gt;phy_addr
)paren
comma
id|inw
c_func
(paren
op_amp
id|cmd-&gt;req_count
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; res_count %04x, xfer_status %04x, branch %08x&bslash;n&quot;
comma
id|inw
c_func
(paren
op_amp
id|cmd-&gt;res_count
)paren
comma
id|inw
c_func
(paren
op_amp
id|cmd-&gt;xfer_status
)paren
comma
id|inl
c_func
(paren
op_amp
id|cmd-&gt;cmd_dep
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
id|location
)paren
(brace
r_int
id|loop
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|outb
c_func
(paren
(paren
id|location
op_amp
l_int|0xff
)paren
comma
id|ioaddr
op_plus
id|EE_WORD_ADDR
)paren
suffix:semicolon
multiline_comment|/* take spillover from location in control reg */
id|outb
c_func
(paren
id|EE_CONTROL_RND_READB
op_or
(paren
id|location
op_amp
(paren
l_int|0x7
op_lshift
l_int|8
)paren
)paren
comma
id|ioaddr
op_plus
id|EE_CONTROL
)paren
suffix:semicolon
id|loop
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EE_STATUS
)paren
op_amp
id|EE_SEB
)paren
op_logical_and
(paren
id|loop
OG
l_int|0
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|loop
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EE_STATUS
)paren
op_amp
id|EE_SEE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Serial EEPROM read error&bslash;n&quot;
comma
id|chipname
)paren
suffix:semicolon
id|val
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
id|val
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EE_READ_DATA
)paren
suffix:semicolon
r_return
(paren
r_int
)paren
id|val
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef NCR885E_DEBUG_MII
r_static
r_void
DECL|function|show_mii
id|show_mii
c_func
(paren
r_int
r_int
id|ioaddr
)paren
(brace
r_int
id|phyctrl
comma
id|phystat
comma
id|phyadvert
comma
id|phypartner
comma
id|phyexpan
suffix:semicolon
id|phyctrl
op_assign
id|read_mii
c_func
(paren
id|ioaddr
comma
id|MII_AUTO_NEGOTIATION_CONTROL
)paren
suffix:semicolon
id|phystat
op_assign
id|read_mii
c_func
(paren
id|ioaddr
comma
id|MII_AUTO_NEGOTIATION_STATUS
)paren
suffix:semicolon
id|phyadvert
op_assign
id|read_mii
c_func
(paren
id|ioaddr
comma
id|MII_AUTO_NEGOTIATION_ADVERTISEMENT
)paren
suffix:semicolon
id|phypartner
op_assign
id|read_mii
c_func
(paren
id|ioaddr
comma
id|MII_AUTO_NEGOTIATION_LINK_PARTNER
)paren
suffix:semicolon
id|phyexpan
op_assign
id|read_mii
c_func
(paren
id|ioaddr
comma
id|MII_AUTO_NEGOTIATION_EXPANSION
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PHY: advert=%d %s, partner=%s %s, link=%d, %s%s&bslash;n&quot;
comma
(paren
id|phyadvert
op_amp
id|MANATECH_100BASETX_FULL_DUPLEX
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
comma
(paren
id|phyctrl
op_amp
id|MANC_AUTO_NEGOTIATION_ENABLE
ques
c_cond
l_string|&quot;auto&quot;
suffix:colon
l_string|&quot;fixed&quot;
)paren
comma
(paren
id|phypartner
op_amp
id|MANLP_ACKNOWLEDGE
ques
c_cond
(paren
id|phypartner
op_amp
id|MANATECH_100BASETX_FULL_DUPLEX
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
)paren
suffix:colon
l_string|&quot;?&quot;
)paren
comma
(paren
id|phyexpan
op_amp
id|MANE_LINK_PARTNER_AUTO_ABLE
ques
c_cond
l_string|&quot;auto&quot;
suffix:colon
l_string|&quot;fixed&quot;
)paren
comma
(paren
id|phyctrl
op_amp
id|MANC_PHY_SPEED_100
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
comma
(paren
id|phystat
op_amp
id|MANS_LINK_STATUS
ques
c_cond
l_string|&quot;up&quot;
suffix:colon
l_string|&quot;down&quot;
)paren
comma
(paren
id|phyexpan
op_amp
id|MANE_PARALLEL_DETECTION_FAULT
ques
c_cond
l_string|&quot; PD-fault&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_mii
id|read_mii
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
id|reg
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_INDICATOR
)paren
op_amp
id|MII_BUSY
)paren
(brace
r_if
c_cond
(paren
id|timeout
op_decrement
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Timed out waiting for MII&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|outw
c_func
(paren
(paren
l_int|1
op_lshift
l_int|8
)paren
op_plus
id|reg
comma
id|ioaddr
op_plus
id|MII_ADDRESS
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MIIM_RSTAT
comma
id|ioaddr
op_plus
id|MIIM_COMMAND
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_INDICATOR
)paren
op_amp
id|MII_BUSY
)paren
(brace
r_if
c_cond
(paren
id|timeout
op_decrement
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Timed out waiting for MII&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_READ_DATA
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|write_mii
id|write_mii
c_func
(paren
r_int
r_int
id|ioaddr
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
id|timeout
op_assign
l_int|100000
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MII indicator: %02x&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_INDICATOR
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_INDICATOR
)paren
op_amp
id|MII_BUSY
)paren
(brace
r_if
c_cond
(paren
id|timeout
op_decrement
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Timeout waiting to write to MII&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
(paren
l_int|1
op_lshift
l_int|8
)paren
op_plus
id|reg
comma
id|ioaddr
op_plus
id|MII_ADDRESS
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
comma
id|ioaddr
op_plus
id|MII_WRITE_DATA
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* NCR885E_DEBUG_MII */
DECL|function|ncr885e_cleanup
r_static
r_void
id|__exit
id|ncr885e_cleanup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|root_dev
)paren
(brace
id|unregister_netdev
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_dev-&gt;base_addr
comma
id|NCR885E_TOTAL_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|root_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|variable|ncr885e_probe
id|module_init
c_func
(paren
id|ncr885e_probe
)paren
suffix:semicolon
DECL|variable|ncr885e_cleanup
id|module_exit
c_func
(paren
id|ncr885e_cleanup
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; *  c-basic-offset: 8&n; * End:&n; */
eof
