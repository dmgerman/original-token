multiline_comment|/* $Id: lmc_media.c,v 1.13 2000/04/11 05:25:26 asj Exp $ */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
singleline_comment|//#include &lt;asm/smp.h&gt;
macro_line|#if LINUX_VERSION_CODE &lt; 0x20155
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;asm/processor.h&gt;             /* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &quot;../syncppp.h&quot;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20200
macro_line|#include &lt;asm/uaccess.h&gt;
singleline_comment|//#include &lt;asm/spinlock.h&gt;
macro_line|#endif
macro_line|#include &quot;lmc_ver.h&quot;
macro_line|#include &quot;lmc.h&quot;
macro_line|#include &quot;lmc_var.h&quot;
macro_line|#include &quot;lmc_ioctl.h&quot;
macro_line|#include &quot;lmc_debug.h&quot;
DECL|macro|CONFIG_LMC_IGNORE_HARDWARE_HANDSHAKE
mdefine_line|#define CONFIG_LMC_IGNORE_HARDWARE_HANDSHAKE 1
multiline_comment|/*&n;  * Copyright (c) 1997-2000 LAN Media Corporation (LMC)&n;  * All rights reserved.  www.lanmedia.com&n;  *&n;  * This code is written by:&n;  * Andrew Stanley-Jones (asj@cban.com)&n;  * Rob Braun (bbraun@vix.com),&n;  * Michael Graff (explorer@vix.com) and&n;  * Matt Thomas (matt@3am-software.com).&n;  *&n;  * This software may be used and distributed according to the terms&n;  * of the GNU Public License version 2, incorporated herein by reference.&n;  */
multiline_comment|/*&n; * For lack of a better place, put the SSI cable stuff here.&n; */
DECL|variable|lmc_t1_cables
r_char
op_star
id|lmc_t1_cables
(braket
)braket
op_assign
(brace
l_string|&quot;V.10/RS423&quot;
comma
l_string|&quot;EIA530A&quot;
comma
l_string|&quot;reserved&quot;
comma
l_string|&quot;X.21&quot;
comma
l_string|&quot;V.35&quot;
comma
l_string|&quot;EIA449/EIA530/V.36&quot;
comma
l_string|&quot;V.28/EIA232&quot;
comma
l_string|&quot;none&quot;
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * protocol independent method.&n; */
r_static
r_void
id|lmc_set_protocol
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * media independent methods to check on media status, link, light LEDs,&n; * etc.&n; */
r_static
r_void
id|lmc_ds3_init
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ds3_default
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ds3_set_status
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|lmc_ds3_set_100ft
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|lmc_ds3_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ds3_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_ds3_set_scram
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_ds3_watchdog
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_init
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_default
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_set_status
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_set_clock
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|lmc_hssi_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_set_link_status
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_hssi_watchdog
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_init
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_default
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_set_status
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_set_clock
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_set_speed
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|lmc_ssi_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_set_link_status
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_ssi_watchdog
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_init
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_default
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_set_status
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|lmc_t1_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_set_circuit_type
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_set_clock
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_t1_watchdog
(paren
id|lmc_softc_t
op_star
r_const
)paren
suffix:semicolon
r_static
r_void
id|lmc_dummy_set_1
(paren
id|lmc_softc_t
op_star
r_const
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lmc_dummy_set2_1
(paren
id|lmc_softc_t
op_star
r_const
comma
id|lmc_ctl_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|write_av9110_bit
(paren
id|lmc_softc_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|write_av9110
(paren
id|lmc_softc_t
op_star
comma
id|u_int32_t
comma
id|u_int32_t
comma
id|u_int32_t
comma
id|u_int32_t
comma
id|u_int32_t
)paren
suffix:semicolon
DECL|variable|lmc_ds3_media
id|lmc_media_t
id|lmc_ds3_media
op_assign
(brace
id|lmc_ds3_init
comma
multiline_comment|/* special media init stuff */
id|lmc_ds3_default
comma
multiline_comment|/* reset to default state */
id|lmc_ds3_set_status
comma
multiline_comment|/* reset status to state provided */
id|lmc_dummy_set_1
comma
multiline_comment|/* set clock source */
id|lmc_dummy_set2_1
comma
multiline_comment|/* set line speed */
id|lmc_ds3_set_100ft
comma
multiline_comment|/* set cable length */
id|lmc_ds3_set_scram
comma
multiline_comment|/* set scrambler */
id|lmc_ds3_get_link_status
comma
multiline_comment|/* get link status */
id|lmc_dummy_set_1
comma
multiline_comment|/* set link status */
id|lmc_ds3_set_crc_length
comma
multiline_comment|/* set CRC length */
id|lmc_dummy_set_1
comma
multiline_comment|/* set T1 or E1 circuit type */
id|lmc_ds3_watchdog
)brace
suffix:semicolon
DECL|variable|lmc_hssi_media
id|lmc_media_t
id|lmc_hssi_media
op_assign
(brace
id|lmc_hssi_init
comma
multiline_comment|/* special media init stuff */
id|lmc_hssi_default
comma
multiline_comment|/* reset to default state */
id|lmc_hssi_set_status
comma
multiline_comment|/* reset status to state provided */
id|lmc_hssi_set_clock
comma
multiline_comment|/* set clock source */
id|lmc_dummy_set2_1
comma
multiline_comment|/* set line speed */
id|lmc_dummy_set_1
comma
multiline_comment|/* set cable length */
id|lmc_dummy_set_1
comma
multiline_comment|/* set scrambler */
id|lmc_hssi_get_link_status
comma
multiline_comment|/* get link status */
id|lmc_hssi_set_link_status
comma
multiline_comment|/* set link status */
id|lmc_hssi_set_crc_length
comma
multiline_comment|/* set CRC length */
id|lmc_dummy_set_1
comma
multiline_comment|/* set T1 or E1 circuit type */
id|lmc_hssi_watchdog
)brace
suffix:semicolon
DECL|variable|lmc_ssi_media
id|lmc_media_t
id|lmc_ssi_media
op_assign
(brace
id|lmc_ssi_init
comma
multiline_comment|/* special media init stuff */
id|lmc_ssi_default
comma
multiline_comment|/* reset to default state */
id|lmc_ssi_set_status
comma
multiline_comment|/* reset status to state provided */
id|lmc_ssi_set_clock
comma
multiline_comment|/* set clock source */
id|lmc_ssi_set_speed
comma
multiline_comment|/* set line speed */
id|lmc_dummy_set_1
comma
multiline_comment|/* set cable length */
id|lmc_dummy_set_1
comma
multiline_comment|/* set scrambler */
id|lmc_ssi_get_link_status
comma
multiline_comment|/* get link status */
id|lmc_ssi_set_link_status
comma
multiline_comment|/* set link status */
id|lmc_ssi_set_crc_length
comma
multiline_comment|/* set CRC length */
id|lmc_dummy_set_1
comma
multiline_comment|/* set T1 or E1 circuit type */
id|lmc_ssi_watchdog
)brace
suffix:semicolon
DECL|variable|lmc_t1_media
id|lmc_media_t
id|lmc_t1_media
op_assign
(brace
id|lmc_t1_init
comma
multiline_comment|/* special media init stuff */
id|lmc_t1_default
comma
multiline_comment|/* reset to default state */
id|lmc_t1_set_status
comma
multiline_comment|/* reset status to state provided */
id|lmc_t1_set_clock
comma
multiline_comment|/* set clock source */
id|lmc_dummy_set2_1
comma
multiline_comment|/* set line speed */
id|lmc_dummy_set_1
comma
multiline_comment|/* set cable length */
id|lmc_dummy_set_1
comma
multiline_comment|/* set scrambler */
id|lmc_t1_get_link_status
comma
multiline_comment|/* get link status */
id|lmc_dummy_set_1
comma
multiline_comment|/* set link status */
id|lmc_t1_set_crc_length
comma
multiline_comment|/* set CRC length */
id|lmc_t1_set_circuit_type
comma
multiline_comment|/* set T1 or E1 circuit type */
id|lmc_t1_watchdog
)brace
suffix:semicolon
r_static
r_void
DECL|function|lmc_dummy_set_1
id|lmc_dummy_set_1
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|a
)paren
(brace
)brace
r_static
r_void
DECL|function|lmc_dummy_set2_1
id|lmc_dummy_set2_1
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|a
)paren
(brace
)brace
multiline_comment|/*&n; *  HSSI methods&n; */
r_static
r_void
DECL|function|lmc_hssi_init
id|lmc_hssi_init
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|sc-&gt;ictl.cardtype
op_assign
id|LMC_CTL_CARDTYPE_LMC5200
suffix:semicolon
id|lmc_gpio_mkoutput
(paren
id|sc
comma
id|LMC_GEP_HSSI_CLOCK
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_hssi_default
id|lmc_hssi_default
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|sc-&gt;lmc_miireg16
op_assign
id|LMC_MII16_LED_ALL
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_link_status
(paren
id|sc
comma
id|LMC_LINK_DOWN
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_crc_length
(paren
id|sc
comma
id|LMC_CTL_CRC_LENGTH_16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Given a user provided state, set ourselves up to match it.  This will&n; * always reset the card if needed.&n; */
r_static
r_void
DECL|function|lmc_hssi_set_status
id|lmc_hssi_set_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|ctl
)paren
(brace
r_if
c_cond
(paren
id|ctl
op_eq
l_int|NULL
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|sc-&gt;ictl.clock_source
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
l_int|NULL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;   * check for change in clock source&n;   */
r_if
c_cond
(paren
id|ctl-&gt;clock_source
op_logical_and
op_logical_neg
id|sc-&gt;ictl.clock_source
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|LMC_CTL_CLOCK_SOURCE_INT
)paren
suffix:semicolon
id|sc-&gt;lmc_timing
op_assign
id|LMC_CTL_CLOCK_SOURCE_INT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|ctl-&gt;clock_source
op_logical_and
id|sc-&gt;ictl.clock_source
)paren
(brace
id|sc-&gt;lmc_timing
op_assign
id|LMC_CTL_CLOCK_SOURCE_EXT
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
suffix:semicolon
)brace
id|lmc_set_protocol
(paren
id|sc
comma
id|ctl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 1 == internal, 0 == external&n; */
r_static
r_void
DECL|function|lmc_hssi_set_clock
id|lmc_hssi_set_clock
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|ie
)paren
(brace
r_int
id|old
suffix:semicolon
id|old
op_assign
id|sc-&gt;ictl.clock_source
suffix:semicolon
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
(brace
id|sc-&gt;lmc_gpio
op_or_assign
id|LMC_GEP_HSSI_CLOCK
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_EXT
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|ie
)paren
(brace
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: clock external&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_HSSI_CLOCK
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_INT
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|ie
)paren
(brace
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: clock internal&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * return hardware link status.&n; * 0 == link is down, 1 == link is up.&n; */
r_static
r_int
DECL|function|lmc_hssi_get_link_status
id|lmc_hssi_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
multiline_comment|/*&n;     * We&squot;re using the same code as SSI since&n;     * they&squot;re practically the same&n;     */
r_return
id|lmc_ssi_get_link_status
c_func
(paren
id|sc
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_hssi_set_link_status
id|lmc_hssi_set_link_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|LMC_LINK_UP
)paren
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_HSSI_TA
suffix:semicolon
r_else
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_HSSI_TA
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 0 == 16bit, 1 == 32bit&n; */
r_static
r_void
DECL|function|lmc_hssi_set_crc_length
id|lmc_hssi_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|LMC_CTL_CRC_LENGTH_32
)paren
(brace
multiline_comment|/* 32 bit */
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_HSSI_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_32
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit */
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_HSSI_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_16
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_hssi_watchdog
id|lmc_hssi_watchdog
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
multiline_comment|/* HSSI is blank */
)brace
multiline_comment|/*&n; *  DS3 methods&n; */
multiline_comment|/*&n; * Set cable length&n; */
r_static
r_void
DECL|function|lmc_ds3_set_100ft
id|lmc_ds3_set_100ft
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|ie
)paren
(brace
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_CABLE_LENGTH_GT_100FT
)paren
(brace
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_DS3_ZERO
suffix:semicolon
id|sc-&gt;ictl.cable_length
op_assign
id|LMC_CTL_CABLE_LENGTH_GT_100FT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_CABLE_LENGTH_LT_100FT
)paren
(brace
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_DS3_ZERO
suffix:semicolon
id|sc-&gt;ictl.cable_length
op_assign
id|LMC_CTL_CABLE_LENGTH_LT_100FT
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_ds3_default
id|lmc_ds3_default
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|sc-&gt;lmc_miireg16
op_assign
id|LMC_MII16_LED_ALL
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_link_status
(paren
id|sc
comma
id|LMC_LINK_DOWN
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_cable_length
(paren
id|sc
comma
id|LMC_CTL_CABLE_LENGTH_LT_100FT
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_scrambler
(paren
id|sc
comma
id|LMC_CTL_OFF
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_crc_length
(paren
id|sc
comma
id|LMC_CTL_CRC_LENGTH_16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Given a user provided state, set ourselves up to match it.  This will&n; * always reset the card if needed.&n; */
r_static
r_void
DECL|function|lmc_ds3_set_status
id|lmc_ds3_set_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|ctl
)paren
(brace
r_if
c_cond
(paren
id|ctl
op_eq
l_int|NULL
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_cable_length
(paren
id|sc
comma
id|sc-&gt;ictl.cable_length
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_scrambler
(paren
id|sc
comma
id|sc-&gt;ictl.scrambler_onoff
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
l_int|NULL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;   * check for change in cable length setting&n;   */
r_if
c_cond
(paren
id|ctl-&gt;cable_length
op_logical_and
op_logical_neg
id|sc-&gt;ictl.cable_length
)paren
id|lmc_ds3_set_100ft
(paren
id|sc
comma
id|LMC_CTL_CABLE_LENGTH_GT_100FT
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|ctl-&gt;cable_length
op_logical_and
id|sc-&gt;ictl.cable_length
)paren
id|lmc_ds3_set_100ft
(paren
id|sc
comma
id|LMC_CTL_CABLE_LENGTH_LT_100FT
)paren
suffix:semicolon
multiline_comment|/*&n;   * Check for change in scrambler setting (requires reset)&n;   */
r_if
c_cond
(paren
id|ctl-&gt;scrambler_onoff
op_logical_and
op_logical_neg
id|sc-&gt;ictl.scrambler_onoff
)paren
id|lmc_ds3_set_scram
(paren
id|sc
comma
id|LMC_CTL_ON
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|ctl-&gt;scrambler_onoff
op_logical_and
id|sc-&gt;ictl.scrambler_onoff
)paren
id|lmc_ds3_set_scram
(paren
id|sc
comma
id|LMC_CTL_OFF
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
id|ctl
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_ds3_init
id|lmc_ds3_init
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
r_int
id|i
suffix:semicolon
id|sc-&gt;ictl.cardtype
op_assign
id|LMC_CTL_CARDTYPE_LMC5245
suffix:semicolon
multiline_comment|/* writes zeros everywhere */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
id|i
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* set some essential bits */
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|1
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
l_int|0x25
)paren
suffix:semicolon
multiline_comment|/* ser, xtx */
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|5
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* emode */
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|14
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* rcgen, tcgen */
multiline_comment|/* clear counters and latched bits */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
id|i
)paren
suffix:semicolon
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * 1 == DS3 payload scrambled, 0 == not scrambled&n; */
r_static
r_void
DECL|function|lmc_ds3_set_scram
id|lmc_ds3_set_scram
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|ie
)paren
(brace
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_ON
)paren
(brace
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_DS3_SCRAM
suffix:semicolon
id|sc-&gt;ictl.scrambler_onoff
op_assign
id|LMC_CTL_ON
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_DS3_SCRAM
suffix:semicolon
id|sc-&gt;ictl.scrambler_onoff
op_assign
id|LMC_CTL_OFF
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * return hardware link status.&n; * 0 == link is down, 1 == link is up.&n; */
r_static
r_int
DECL|function|lmc_ds3_get_link_status
id|lmc_ds3_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|u_int16_t
id|link_status
comma
id|link_status_11
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|7
)paren
suffix:semicolon
id|link_status
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
multiline_comment|/* LMC5245 (DS3) &amp; LMC1200 (DS1) LED definitions&n;     * led0 yellow = far-end adapter is in Red alarm condition&n;     * led1 blue   = received an Alarm Indication signal&n;     *               (upstream failure)&n;     * led2 Green  = power to adapter, Gate Array loaded &amp; driver&n;     *               attached&n;     * led3 red    = Loss of Signal (LOS) or out of frame (OOF)&n;     *               conditions detected on T3 receive signal&n;     */
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|link_status
op_amp
id|LMC_FRAMER_REG0_DLOS
)paren
op_logical_or
(paren
id|link_status
op_amp
id|LMC_FRAMER_REG0_OOFS
)paren
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_ne
l_int|1
)paren
(brace
id|u16
id|r1
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|01
)paren
suffix:semicolon
multiline_comment|/* Turn on Xbit error as our cisco does */
id|r1
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
id|r1
op_and_assign
l_int|0xfe
suffix:semicolon
id|lmc_mii_writereg
c_func
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
id|r1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Red Alarm - Loss of Signal or Loss of Framing&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED3
)paren
suffix:semicolon
multiline_comment|/* turn on red LED */
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_DS3_LED3
)paren
suffix:semicolon
multiline_comment|/* turn on red LED */
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_eq
l_int|1
)paren
(brace
id|u16
id|r1
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|01
)paren
suffix:semicolon
multiline_comment|/* Turn off Xbit error */
id|r1
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
id|r1
op_or_assign
l_int|0x01
suffix:semicolon
id|lmc_mii_writereg
c_func
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
id|r1
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|lmc_mii_writereg
c_func
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|0x10
)paren
suffix:semicolon
id|link_status_11
op_assign
id|lmc_mii_readreg
c_func
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|link_status
op_amp
id|LMC_FRAMER_REG0_AIS
)paren
op_logical_or
(paren
id|link_status_11
op_amp
id|LMC_FRAMER_REG10_XBIT
)paren
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: AIS Alarm or XBit Error&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Remote end has loss of signal or framing&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED0
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_DS3_LED0
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
l_int|9
)paren
suffix:semicolon
id|link_status
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link_status
op_amp
id|LMC_FRAMER_REG9_RBLUE
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Blue Alarm - Receiving all 1&squot;s&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED1
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_DS3_LED1
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * 0 == 16bit, 1 == 32bit&n; */
r_static
r_void
DECL|function|lmc_ds3_set_crc_length
id|lmc_ds3_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|LMC_CTL_CRC_LENGTH_32
)paren
(brace
multiline_comment|/* 32 bit */
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_DS3_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_32
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit */
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_DS3_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_16
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_ds3_watchdog
id|lmc_ds3_watchdog
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
)brace
multiline_comment|/*&n; *  SSI methods&n; */
r_static
r_void
DECL|function|lmc_ssi_init
id|lmc_ssi_init
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|u_int16_t
id|mii17
suffix:semicolon
r_int
id|cable
suffix:semicolon
id|sc-&gt;ictl.cardtype
op_assign
id|LMC_CTL_CARDTYPE_LMC1000
suffix:semicolon
id|mii17
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|17
)paren
suffix:semicolon
id|cable
op_assign
(paren
id|mii17
op_amp
id|LMC_MII17_SSI_CABLE_MASK
)paren
op_rshift
id|LMC_MII17_SSI_CABLE_SHIFT
suffix:semicolon
id|sc-&gt;ictl.cable_type
op_assign
id|cable
suffix:semicolon
id|lmc_gpio_mkoutput
(paren
id|sc
comma
id|LMC_GEP_SSI_TXCLOCK
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_ssi_default
id|lmc_ssi_default
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|sc-&gt;lmc_miireg16
op_assign
id|LMC_MII16_LED_ALL
suffix:semicolon
multiline_comment|/*&n;   * make TXCLOCK always be an output&n;   */
id|lmc_gpio_mkoutput
(paren
id|sc
comma
id|LMC_GEP_SSI_TXCLOCK
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_link_status
(paren
id|sc
comma
id|LMC_LINK_DOWN
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_speed
(paren
id|sc
comma
l_int|NULL
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_crc_length
(paren
id|sc
comma
id|LMC_CTL_CRC_LENGTH_16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Given a user provided state, set ourselves up to match it.  This will&n; * always reset the card if needed.&n; */
r_static
r_void
DECL|function|lmc_ssi_set_status
id|lmc_ssi_set_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|ctl
)paren
(brace
r_if
c_cond
(paren
id|ctl
op_eq
l_int|NULL
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|sc-&gt;ictl.clock_source
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_speed
(paren
id|sc
comma
op_amp
id|sc-&gt;ictl
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
l_int|NULL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;   * check for change in clock source&n;   */
r_if
c_cond
(paren
id|ctl-&gt;clock_source
op_eq
id|LMC_CTL_CLOCK_SOURCE_INT
op_logical_and
id|sc-&gt;ictl.clock_source
op_eq
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|LMC_CTL_CLOCK_SOURCE_INT
)paren
suffix:semicolon
id|sc-&gt;lmc_timing
op_assign
id|LMC_CTL_CLOCK_SOURCE_INT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ctl-&gt;clock_source
op_eq
id|LMC_CTL_CLOCK_SOURCE_EXT
op_logical_and
id|sc-&gt;ictl.clock_source
op_eq
id|LMC_CTL_CLOCK_SOURCE_INT
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_clock_source
(paren
id|sc
comma
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
suffix:semicolon
id|sc-&gt;lmc_timing
op_assign
id|LMC_CTL_CLOCK_SOURCE_EXT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctl-&gt;clock_rate
op_ne
id|sc-&gt;ictl.clock_rate
)paren
id|sc-&gt;lmc_media-&gt;set_speed
(paren
id|sc
comma
id|ctl
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
id|ctl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 1 == internal, 0 == external&n; */
r_static
r_void
DECL|function|lmc_ssi_set_clock
id|lmc_ssi_set_clock
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|ie
)paren
(brace
r_int
id|old
suffix:semicolon
id|old
op_assign
id|ie
suffix:semicolon
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
(brace
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_SSI_TXCLOCK
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_EXT
suffix:semicolon
r_if
c_cond
(paren
id|ie
op_ne
id|old
)paren
(brace
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: clock external&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sc-&gt;lmc_gpio
op_or_assign
id|LMC_GEP_SSI_TXCLOCK
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_INT
suffix:semicolon
r_if
c_cond
(paren
id|ie
op_ne
id|old
)paren
(brace
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: clock internal&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|lmc_ssi_set_speed
id|lmc_ssi_set_speed
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|ctl
)paren
(brace
id|lmc_ctl_t
op_star
id|ictl
op_assign
op_amp
id|sc-&gt;ictl
suffix:semicolon
id|lmc_av9110_t
op_star
id|av
suffix:semicolon
multiline_comment|/* original settings for clock rate of:&n;   *  100 Khz (8,25,0,0,2) were incorrect&n;   *  they should have been 80,125,1,3,3&n;   *  There are 17 param combinations to produce this freq.&n;   *  For 1.5 Mhz use 120,100,1,1,2 (226 param. combinations)&n;   */
r_if
c_cond
(paren
id|ctl
op_eq
l_int|NULL
)paren
(brace
id|av
op_assign
op_amp
id|ictl-&gt;cardspec.ssi
suffix:semicolon
id|ictl-&gt;clock_rate
op_assign
l_int|1500000
suffix:semicolon
id|av-&gt;f
op_assign
id|ictl-&gt;clock_rate
suffix:semicolon
id|av-&gt;n
op_assign
l_int|120
suffix:semicolon
id|av-&gt;m
op_assign
l_int|100
suffix:semicolon
id|av-&gt;v
op_assign
l_int|1
suffix:semicolon
id|av-&gt;x
op_assign
l_int|1
suffix:semicolon
id|av-&gt;r
op_assign
l_int|2
suffix:semicolon
id|write_av9110
(paren
id|sc
comma
id|av-&gt;n
comma
id|av-&gt;m
comma
id|av-&gt;v
comma
id|av-&gt;x
comma
id|av-&gt;r
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|av
op_assign
op_amp
id|ctl-&gt;cardspec.ssi
suffix:semicolon
r_if
c_cond
(paren
id|av-&gt;f
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|ictl-&gt;clock_rate
op_assign
id|av-&gt;f
suffix:semicolon
multiline_comment|/* really, this is the rate we are */
id|ictl-&gt;cardspec.ssi
op_assign
op_star
id|av
suffix:semicolon
id|write_av9110
(paren
id|sc
comma
id|av-&gt;n
comma
id|av-&gt;m
comma
id|av-&gt;v
comma
id|av-&gt;x
comma
id|av-&gt;r
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * return hardware link status.&n; * 0 == link is down, 1 == link is up.&n; */
r_static
r_int
DECL|function|lmc_ssi_get_link_status
id|lmc_ssi_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|u_int16_t
id|link_status
suffix:semicolon
id|u_int32_t
id|ticks
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
r_int
id|hw_hdsk
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;   * missing CTS?  Hmm.  If we require CTS on, we may never get the&n;   * link to come up, so omit it in this test.&n;   *&n;   * Also, it seems that with a loopback cable, DCD isn&squot;t asserted,&n;   * so just check for things like this:&n;   *      DSR _must_ be asserted.&n;   *      One of DCD or CTS must be asserted.&n;   */
multiline_comment|/* LMC 1000 (SSI) LED definitions&n;   * led0 Green = power to adapter, Gate Array loaded &amp;&n;   *              driver attached&n;   * led1 Green = DSR and DTR and RTS and CTS are set&n;   * led2 Green = Cable detected&n;   * led3 red   = No timing is available from the&n;   *              cable or the on-board frequency&n;   *              generator.&n;   */
id|link_status
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Is the transmit clock still available */
id|ticks
op_assign
id|LMC_CSR_READ
(paren
id|sc
comma
id|csr_gp_timer
)paren
suffix:semicolon
id|ticks
op_assign
l_int|0x0000ffff
op_minus
(paren
id|ticks
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
id|lmc_led_on
(paren
id|sc
comma
id|LMC_MII16_LED0
)paren
suffix:semicolon
multiline_comment|/* ====== transmit clock determination ===== */
r_if
c_cond
(paren
id|sc-&gt;lmc_timing
op_eq
id|LMC_CTL_CLOCK_SOURCE_INT
)paren
(brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_MII16_LED3
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ticks
op_eq
l_int|0
)paren
(brace
multiline_comment|/* no clock found ? */
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_ne
l_int|1
)paren
(brace
id|sc-&gt;stats.tx_lossOfClockCnt
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Lost Clock, Link Down&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
id|lmc_led_on
(paren
id|sc
comma
id|LMC_MII16_LED3
)paren
suffix:semicolon
multiline_comment|/* turn ON red LED */
)brace
r_else
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Clock Returned&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|lmc_led_off
(paren
id|sc
comma
id|LMC_MII16_LED3
)paren
suffix:semicolon
multiline_comment|/* turn OFF red LED */
)brace
r_if
c_cond
(paren
(paren
id|link_status
op_amp
id|LMC_MII16_SSI_DSR
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Also HSSI CA */
id|ret
op_assign
l_int|0
suffix:semicolon
id|hw_hdsk
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_LMC_IGNORE_HARDWARE_HANDSHAKE
r_if
c_cond
(paren
(paren
id|link_status
op_amp
(paren
id|LMC_MII16_SSI_CTS
op_or
id|LMC_MII16_SSI_DCD
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|hw_hdsk
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|hw_hdsk
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: DSR not asserted&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_MII16_LED1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: DSR now asserted&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_MII16_LED1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|1
)paren
(brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_MII16_LED2
)paren
suffix:semicolon
multiline_comment|/* Over all good status? */
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_ssi_set_link_status
id|lmc_ssi_set_link_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|LMC_LINK_UP
)paren
(brace
id|sc-&gt;lmc_miireg16
op_or_assign
(paren
id|LMC_MII16_SSI_DTR
op_or
id|LMC_MII16_SSI_RTS
)paren
suffix:semicolon
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: asserting DTR and RTS&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
(paren
id|LMC_MII16_SSI_DTR
op_or
id|LMC_MII16_SSI_RTS
)paren
suffix:semicolon
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: deasserting DTR and RTS&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 0 == 16bit, 1 == 32bit&n; */
r_static
r_void
DECL|function|lmc_ssi_set_crc_length
id|lmc_ssi_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|LMC_CTL_CRC_LENGTH_32
)paren
(brace
multiline_comment|/* 32 bit */
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_SSI_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_32
suffix:semicolon
id|sc-&gt;lmc_crcSize
op_assign
id|LMC_CTL_CRC_BYTESIZE_4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit */
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_SSI_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_16
suffix:semicolon
id|sc-&gt;lmc_crcSize
op_assign
id|LMC_CTL_CRC_BYTESIZE_2
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * These are bits to program the ssi frequency generator&n; */
r_static
r_inline
r_void
DECL|function|write_av9110_bit
id|write_av9110_bit
(paren
id|lmc_softc_t
op_star
id|sc
comma
r_int
id|c
)paren
(brace
multiline_comment|/*&n;   * set the data bit as we need it.&n;   */
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_CLK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_amp
l_int|0x01
)paren
id|sc-&gt;lmc_gpio
op_or_assign
id|LMC_GEP_DATA
suffix:semicolon
r_else
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_DATA
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
multiline_comment|/*&n;   * set the clock to high&n;   */
id|sc-&gt;lmc_gpio
op_or_assign
id|LMC_GEP_CLK
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
multiline_comment|/*&n;   * set the clock to low again.&n;   */
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_CLK
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|write_av9110
id|write_av9110
(paren
id|lmc_softc_t
op_star
id|sc
comma
id|u_int32_t
id|n
comma
id|u_int32_t
id|m
comma
id|u_int32_t
id|v
comma
id|u_int32_t
id|x
comma
id|u_int32_t
id|r
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if 0
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: speed %u, %d %d %d %d %d&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
comma
id|sc-&gt;ictl.clock_rate
comma
id|n
comma
id|m
comma
id|v
comma
id|x
comma
id|r
)paren
suffix:semicolon
macro_line|#endif
id|sc-&gt;lmc_gpio
op_or_assign
id|LMC_GEP_SSI_GENERATOR
suffix:semicolon
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_DATA
op_or
id|LMC_GEP_CLK
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
multiline_comment|/*&n;   * Set the TXCLOCK, GENERATOR, SERIAL, and SERIALCLK&n;   * as outputs.&n;   */
id|lmc_gpio_mkoutput
(paren
id|sc
comma
(paren
id|LMC_GEP_DATA
op_or
id|LMC_GEP_CLK
op_or
id|LMC_GEP_SSI_GENERATOR
)paren
)paren
suffix:semicolon
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_SSI_GENERATOR
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
multiline_comment|/*&n;   * a shifting we will go...&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|write_av9110_bit
(paren
id|sc
comma
id|n
op_rshift
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|write_av9110_bit
(paren
id|sc
comma
id|m
op_rshift
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|write_av9110_bit
(paren
id|sc
comma
id|v
op_rshift
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|write_av9110_bit
(paren
id|sc
comma
id|x
op_rshift
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|write_av9110_bit
(paren
id|sc
comma
id|r
op_rshift
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|write_av9110_bit
(paren
id|sc
comma
l_int|0x17
op_rshift
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;   * stop driving serial-related signals&n;   */
id|lmc_gpio_mkinput
(paren
id|sc
comma
(paren
id|LMC_GEP_DATA
op_or
id|LMC_GEP_CLK
op_or
id|LMC_GEP_SSI_GENERATOR
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_ssi_watchdog
id|lmc_ssi_watchdog
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|u_int16_t
id|mii17
suffix:semicolon
r_struct
id|ssicsr2
(brace
r_int
r_int
id|dtr
suffix:colon
l_int|1
comma
id|dsr
suffix:colon
l_int|1
comma
id|rts
suffix:colon
l_int|1
comma
id|cable
suffix:colon
l_int|3
comma
id|crc
suffix:colon
l_int|1
comma
id|led0
suffix:colon
l_int|1
comma
id|led1
suffix:colon
l_int|1
comma
id|led2
suffix:colon
l_int|1
comma
id|led3
suffix:colon
l_int|1
comma
id|fifo
suffix:colon
l_int|1
comma
id|ll
suffix:colon
l_int|1
comma
id|rl
suffix:colon
l_int|1
comma
id|tm
suffix:colon
l_int|1
comma
id|loop
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
r_struct
id|ssicsr2
op_star
id|ssicsr
suffix:semicolon
id|mii17
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|17
)paren
suffix:semicolon
id|ssicsr
op_assign
(paren
r_struct
id|ssicsr2
op_star
)paren
op_amp
id|mii17
suffix:semicolon
r_if
c_cond
(paren
id|ssicsr-&gt;cable
op_eq
l_int|7
)paren
(brace
id|lmc_led_off
(paren
id|sc
comma
id|LMC_MII16_LED2
)paren
suffix:semicolon
)brace
r_else
(brace
id|lmc_led_on
(paren
id|sc
comma
id|LMC_MII16_LED2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  T1 methods&n; */
multiline_comment|/*&n; * The framer regs are multiplexed through MII regs 17 &amp; 18&n; *  write the register address to MII reg 17 and the *  data to MII reg 18. */
r_static
r_void
DECL|function|lmc_t1_write
id|lmc_t1_write
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|a
comma
r_int
id|d
)paren
(brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
id|a
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|18
comma
id|d
)paren
suffix:semicolon
)brace
multiline_comment|/* Save a warning&n;static int&n;lmc_t1_read (lmc_softc_t * const sc, int a)&n;{&n;  lmc_mii_writereg (sc, 0, 17, a);&n;  return lmc_mii_readreg (sc, 0, 18);&n;}&n;*/
r_static
r_void
DECL|function|lmc_t1_init
id|lmc_t1_init
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|u_int16_t
id|mii16
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sc-&gt;ictl.cardtype
op_assign
id|LMC_CTL_CARDTYPE_LMC1200
suffix:semicolon
id|mii16
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* reset 8370 */
id|mii16
op_and_assign
op_complement
id|LMC_MII16_T1_RST
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|mii16
op_or
id|LMC_MII16_T1_RST
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|mii16
)paren
suffix:semicolon
multiline_comment|/* set T1 or E1 line.  Uses sc-&gt;lmcmii16 reg in function so update it */
id|sc-&gt;lmc_miireg16
op_assign
id|mii16
suffix:semicolon
id|lmc_t1_set_circuit_type
c_func
(paren
id|sc
comma
id|LMC_CTL_CIRCUIT_TYPE_T1
)paren
suffix:semicolon
id|mii16
op_assign
id|sc-&gt;lmc_miireg16
suffix:semicolon
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x01
comma
l_int|0x1B
)paren
suffix:semicolon
multiline_comment|/* CR0     - primary control             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x02
comma
l_int|0x42
)paren
suffix:semicolon
multiline_comment|/* JAT_CR  - jitter atten config         */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x14
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* LOOP    - loopback config             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x15
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* DL3_TS  - external data link timeslot */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x18
comma
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* PIO     - programmable I/O            */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x19
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* POE     - programmable OE             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x1A
comma
l_int|0x0F
)paren
suffix:semicolon
multiline_comment|/* CMUX    - clock input mux             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x20
comma
l_int|0x41
)paren
suffix:semicolon
multiline_comment|/* LIU_CR  - RX LIU config               */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x22
comma
l_int|0x76
)paren
suffix:semicolon
multiline_comment|/* RLIU_CR - RX LIU config               */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x40
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* RCR0    - RX config                   */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x45
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* RALM    - RX alarm config             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x46
comma
l_int|0x05
)paren
suffix:semicolon
multiline_comment|/* LATCH   - RX alarm/err/cntr latch     */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x68
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* TLIU_CR - TX LIU config               */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x70
comma
l_int|0x0D
)paren
suffix:semicolon
multiline_comment|/* TCR0    - TX framer config            */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x71
comma
l_int|0x05
)paren
suffix:semicolon
multiline_comment|/* TCR1    - TX config                   */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x72
comma
l_int|0x0B
)paren
suffix:semicolon
multiline_comment|/* TFRM    - TX frame format             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x73
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TERROR  - TX error insert             */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x74
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TMAN    - TX manual Sa/FEBE config    */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x75
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TALM    - TX alarm signal config      */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x76
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TPATT   - TX test pattern config      */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x77
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TLB     - TX inband loopback config   */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x90
comma
l_int|0x05
)paren
suffix:semicolon
multiline_comment|/* CLAD_CR - clock rate adapter config   */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x91
comma
l_int|0x05
)paren
suffix:semicolon
multiline_comment|/* CSEL    - clad freq sel               */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0xA6
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* DL1_CTL - DL1 control                 */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0xB1
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* DL2_CTL - DL2 control                 */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0xD0
comma
l_int|0x47
)paren
suffix:semicolon
multiline_comment|/* SBI_CR  - sys bus iface config        */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0xD1
comma
l_int|0x70
)paren
suffix:semicolon
multiline_comment|/* RSB_CR  - RX sys bus config           */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0xD4
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* TSB_CR  - TX sys bus config           */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x0E0
op_plus
id|i
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* SBCn - sys bus per-channel ctl    */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x100
op_plus
id|i
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TPCn - TX per-channel ctl         */
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x180
op_plus
id|i
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* RPCn - RX per-channel ctl         */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|25
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lmc_t1_write
(paren
id|sc
comma
l_int|0x0E0
op_plus
id|i
comma
l_int|0x0D
)paren
suffix:semicolon
multiline_comment|/* SBCn - sys bus per-channel ctl    */
)brace
id|mii16
op_or_assign
id|LMC_MII16_T1_XOE
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|mii16
)paren
suffix:semicolon
id|sc-&gt;lmc_miireg16
op_assign
id|mii16
suffix:semicolon
)brace
r_static
r_void
DECL|function|lmc_t1_default
id|lmc_t1_default
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|sc-&gt;lmc_miireg16
op_assign
id|LMC_MII16_LED_ALL
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_link_status
(paren
id|sc
comma
id|LMC_LINK_DOWN
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_circuit_type
(paren
id|sc
comma
id|LMC_CTL_CIRCUIT_TYPE_T1
)paren
suffix:semicolon
id|sc-&gt;lmc_media-&gt;set_crc_length
(paren
id|sc
comma
id|LMC_CTL_CRC_LENGTH_16
)paren
suffix:semicolon
multiline_comment|/* Right now we can only clock from out internal source */
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_INT
suffix:semicolon
)brace
multiline_comment|/* * Given a user provided state, set ourselves up to match it.  This will * always reset the card if needed.&n; */
r_static
r_void
DECL|function|lmc_t1_set_status
id|lmc_t1_set_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|ctl
)paren
(brace
r_if
c_cond
(paren
id|ctl
op_eq
l_int|NULL
)paren
(brace
id|sc-&gt;lmc_media-&gt;set_circuit_type
(paren
id|sc
comma
id|sc-&gt;ictl.circuit_type
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
l_int|NULL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;   * check for change in circuit type         */
r_if
c_cond
(paren
id|ctl-&gt;circuit_type
op_eq
id|LMC_CTL_CIRCUIT_TYPE_T1
op_logical_and
id|sc-&gt;ictl.circuit_type
op_eq
id|LMC_CTL_CIRCUIT_TYPE_E1
)paren
id|sc-&gt;lmc_media-&gt;set_circuit_type
(paren
id|sc
comma
id|LMC_CTL_CIRCUIT_TYPE_E1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ctl-&gt;circuit_type
op_eq
id|LMC_CTL_CIRCUIT_TYPE_E1
op_logical_and
id|sc-&gt;ictl.circuit_type
op_eq
id|LMC_CTL_CIRCUIT_TYPE_T1
)paren
id|sc-&gt;lmc_media-&gt;set_circuit_type
(paren
id|sc
comma
id|LMC_CTL_CIRCUIT_TYPE_T1
)paren
suffix:semicolon
id|lmc_set_protocol
(paren
id|sc
comma
id|ctl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * return hardware link status.&n; * 0 == link is down, 1 == link is up.&n; */
r_static
r_int
DECL|function|lmc_t1_get_link_status
id|lmc_t1_get_link_status
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
id|u_int16_t
id|link_status
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* LMC5245 (DS3) &amp; LMC1200 (DS1) LED definitions&n;   * led0 yellow = far-end adapter is in Red alarm condition&n;   * led1 blue   = received an Alarm Indication signal&n;   *               (upstream failure)&n;   * led2 Green  = power to adapter, Gate Array loaded &amp; driver&n;   *               attached&n;   * led3 red    = Loss of Signal (LOS) or out of frame (OOF)&n;   *               conditions detected on T3 receive signal&n;   */
id|lmc_trace
c_func
(paren
id|sc-&gt;lmc_device
comma
l_string|&quot;lmc_t1_get_link_status in&quot;
)paren
suffix:semicolon
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED2
)paren
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
id|T1FRAMER_ALARM1_STATUS
)paren
suffix:semicolon
id|link_status
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link_status
op_amp
id|T1F_RAIS
)paren
(brace
multiline_comment|/* turn on blue LED */
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Receive AIS/Blue Alarm. Far end in RED alarm&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED1
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: End AIS/Blue Alarm&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_off
(paren
id|sc
comma
id|LMC_DS3_LED1
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Yellow Alarm is nasty evil stuff, looks at data patterns&n;     * inside the channel and confuses it with HDLC framing&n;     * ignore all yellow alarms.&n;     *&n;     * Do listen to MultiFrame Yellow alarm which while implemented&n;     * different ways isn&squot;t in the channel and hence somewhat&n;     * more reliable&n;     */
r_if
c_cond
(paren
id|link_status
op_amp
id|T1F_RMYEL
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Receive Yellow AIS Alarm&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED0
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: End of Yellow AIS Alarm&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_DS3_LED0
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Loss of signal and los of frame&n;     * Use the green bit to identify which one lit the led&n;     */
r_if
c_cond
(paren
id|link_status
op_amp
id|T1F_RLOF
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Local Red Alarm: Loss of Framing&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED3
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: End Red Alarm (LOF)&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|link_status
op_amp
id|T1F_RLOS
)paren
)paren
(brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_DS3_LED3
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link_status
op_amp
id|T1F_RLOS
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|2
)braket
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Local Red Alarm: Loss of Signal&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_led_on
c_func
(paren
id|sc
comma
id|LMC_DS3_LED3
)paren
suffix:semicolon
id|sc-&gt;last_led_err
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sc-&gt;last_led_err
(braket
l_int|2
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: End Red Alarm (LOS)&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|link_status
op_amp
id|T1F_RLOF
)paren
)paren
(brace
id|lmc_led_off
c_func
(paren
id|sc
comma
id|LMC_DS3_LED3
)paren
suffix:semicolon
)brace
id|sc-&gt;last_led_err
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|sc-&gt;lmc_xinfo.t1_alarm1_status
op_assign
id|link_status
suffix:semicolon
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|17
comma
id|T1FRAMER_ALARM2_STATUS
)paren
suffix:semicolon
id|sc-&gt;lmc_xinfo.t1_alarm2_status
op_assign
id|lmc_mii_readreg
(paren
id|sc
comma
l_int|0
comma
l_int|18
)paren
suffix:semicolon
id|lmc_trace
c_func
(paren
id|sc-&gt;lmc_device
comma
l_string|&quot;lmc_t1_get_link_status out&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * 1 == T1 Circuit Type , 0 == E1 Circuit Type&n; */
r_static
r_void
DECL|function|lmc_t1_set_circuit_type
id|lmc_t1_set_circuit_type
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|ie
)paren
(brace
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_CIRCUIT_TYPE_T1
)paren
(brace
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_T1_Z
suffix:semicolon
id|sc-&gt;ictl.circuit_type
op_assign
id|LMC_CTL_CIRCUIT_TYPE_T1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: In T1 Mode&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_T1_Z
suffix:semicolon
id|sc-&gt;ictl.circuit_type
op_assign
id|LMC_CTL_CIRCUIT_TYPE_E1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: In E1 Mode&bslash;n&quot;
comma
id|sc-&gt;name
)paren
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 0 == 16bit, 1 == 32bit */
r_static
r_void
DECL|function|lmc_t1_set_crc_length
id|lmc_t1_set_crc_length
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|LMC_CTL_CRC_LENGTH_32
)paren
(brace
multiline_comment|/* 32 bit */
id|sc-&gt;lmc_miireg16
op_or_assign
id|LMC_MII16_T1_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_32
suffix:semicolon
id|sc-&gt;lmc_crcSize
op_assign
id|LMC_CTL_CRC_BYTESIZE_4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit */
id|sc-&gt;lmc_miireg16
op_and_assign
op_complement
id|LMC_MII16_T1_CRC
suffix:semicolon
id|sc-&gt;ictl.crc_length
op_assign
id|LMC_CTL_CRC_LENGTH_16
suffix:semicolon
id|sc-&gt;lmc_crcSize
op_assign
id|LMC_CTL_CRC_BYTESIZE_2
suffix:semicolon
)brace
id|lmc_mii_writereg
(paren
id|sc
comma
l_int|0
comma
l_int|16
comma
id|sc-&gt;lmc_miireg16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 1 == internal, 0 == external&n; */
r_static
r_void
DECL|function|lmc_t1_set_clock
id|lmc_t1_set_clock
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
r_int
id|ie
)paren
(brace
r_int
id|old
suffix:semicolon
id|old
op_assign
id|ie
suffix:semicolon
r_if
c_cond
(paren
id|ie
op_eq
id|LMC_CTL_CLOCK_SOURCE_EXT
)paren
(brace
id|sc-&gt;lmc_gpio
op_and_assign
op_complement
(paren
id|LMC_GEP_SSI_TXCLOCK
)paren
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_EXT
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|ie
)paren
(brace
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: clock external&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sc-&gt;lmc_gpio
op_or_assign
id|LMC_GEP_SSI_TXCLOCK
suffix:semicolon
id|LMC_CSR_WRITE
(paren
id|sc
comma
id|csr_gp
comma
id|sc-&gt;lmc_gpio
)paren
suffix:semicolon
id|sc-&gt;ictl.clock_source
op_assign
id|LMC_CTL_CLOCK_SOURCE_INT
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|ie
)paren
(brace
id|printk
(paren
id|LMC_PRINTF_FMT
l_string|&quot;: clock internal&bslash;n&quot;
comma
id|LMC_PRINTF_ARGS
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|lmc_t1_watchdog
id|lmc_t1_watchdog
(paren
id|lmc_softc_t
op_star
r_const
id|sc
)paren
(brace
)brace
r_static
r_void
DECL|function|lmc_set_protocol
id|lmc_set_protocol
(paren
id|lmc_softc_t
op_star
r_const
id|sc
comma
id|lmc_ctl_t
op_star
id|ctl
)paren
(brace
r_if
c_cond
(paren
id|ctl
op_eq
l_int|0
)paren
(brace
id|sc-&gt;ictl.keepalive_onoff
op_assign
id|LMC_CTL_ON
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
eof
