multiline_comment|/*&n; * Synchronous PPP / Cisco-HDLC driver for the COMX boards&n; *&n; * Author: Gergely Madarasz &lt;gorgo@itc.hu&gt;&n; *&n; * based on skeleton code by Tivadar Szemethy &lt;tiv@itc.hu&gt;&n; *&n; * Copyright (C) 1999 ITConsult-Pro Co. &lt;info@itc.hu&gt;&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; *&n; *&n; * Version 0.10 (99/06/10):&n; *&t;&t;- written the first code :)&n; *&n; * Version 0.20 (99/06/16):&n; *&t;&t;- added hdlc protocol &n; *&t;&t;- protocol up is IFF_RUNNING&n; *&n; * Version 0.21 (99/07/15):&n; *&t;&t;- some small fixes with the line status&n; *&n; * Version 0.22 (99/08/05):&n; *&t;&t;- don&squot;t test IFF_RUNNING but the pp_link_state of the sppp&n; * &n; * Version 0.23 (99/12/02):&n; *&t;&t;- tbusy fixes&n; *&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;0.23&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include&t;&quot;syncppp.h&quot;
macro_line|#include&t;&quot;comx.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Author: Gergely Madarasz &lt;gorgo@itc.hu&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Cisco-HDLC / Synchronous PPP driver for the COMX sync serial boards&quot;
)paren
suffix:semicolon
DECL|variable|syncppp_protocol
r_static
r_struct
id|comx_protocol
id|syncppp_protocol
suffix:semicolon
DECL|variable|hdlc_protocol
r_static
r_struct
id|comx_protocol
id|hdlc_protocol
suffix:semicolon
DECL|struct|syncppp_data
r_struct
id|syncppp_data
(brace
DECL|member|status_timer
r_struct
id|timer_list
id|status_timer
suffix:semicolon
)brace
suffix:semicolon
DECL|function|syncppp_status_timerfun
r_static
r_void
id|syncppp_status_timerfun
c_func
(paren
r_int
r_int
id|d
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|d
suffix:semicolon
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|syncppp_data
op_star
id|spch
op_assign
id|ch-&gt;LINE_privdata
suffix:semicolon
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;line_status
op_amp
id|PROTO_UP
)paren
op_logical_and
(paren
id|sp-&gt;pp_link_state
op_eq
id|SPPP_LINK_UP
)paren
)paren
(brace
id|comx_status
c_func
(paren
id|dev
comma
id|ch-&gt;line_status
op_or
id|PROTO_UP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ch-&gt;line_status
op_amp
id|PROTO_UP
)paren
op_logical_and
(paren
id|sp-&gt;pp_link_state
op_eq
id|SPPP_LINK_DOWN
)paren
)paren
(brace
id|comx_status
c_func
(paren
id|dev
comma
id|ch-&gt;line_status
op_amp
op_complement
id|PROTO_UP
)paren
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|spch-&gt;status_timer
comma
id|jiffies
op_plus
id|HZ
op_star
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|syncppp_tx
r_static
r_int
id|syncppp_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;line_status
op_amp
id|LINE_UP
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|syncppp_status
r_static
r_void
id|syncppp_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|status
)paren
(brace
id|status
op_and_assign
op_complement
(paren
id|PROTO_UP
op_or
id|PROTO_LOOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LINE_UP
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sppp_open
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Line went down */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sppp_close
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|comx_status
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|syncppp_open
r_static
r_int
id|syncppp_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|syncppp_data
op_star
id|spch
op_assign
id|ch-&gt;LINE_privdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;init_status
op_amp
id|HW_OPEN
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ch-&gt;init_status
op_or_assign
id|LINE_OPEN
suffix:semicolon
id|ch-&gt;line_status
op_and_assign
op_complement
(paren
id|PROTO_UP
op_or
id|PROTO_LOOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;line_status
op_amp
id|LINE_UP
)paren
(brace
id|sppp_open
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|spch-&gt;status_timer
)paren
suffix:semicolon
id|spch-&gt;status_timer.function
op_assign
id|syncppp_status_timerfun
suffix:semicolon
id|spch-&gt;status_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|spch-&gt;status_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|3
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|spch-&gt;status_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|syncppp_close
r_static
r_int
id|syncppp_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|syncppp_data
op_star
id|spch
op_assign
id|ch-&gt;LINE_privdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;init_status
op_amp
id|HW_OPEN
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|spch-&gt;status_timer
)paren
suffix:semicolon
id|sppp_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ch-&gt;init_status
op_and_assign
op_complement
id|LINE_OPEN
suffix:semicolon
id|ch-&gt;line_status
op_and_assign
op_complement
(paren
id|PROTO_UP
op_or
id|PROTO_LOOP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|syncppp_xmit
r_static
r_int
id|syncppp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ch
op_member_access_from_pointer
id|HW_send_packet
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
r_case
id|FRAME_QUEUED
suffix:colon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRAME_ACCEPTED
suffix:colon
r_case
id|FRAME_DROPPED
suffix:colon
r_break
suffix:semicolon
r_case
id|FRAME_ERROR
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmit frame error (len %d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|syncppp_statistics
r_static
r_int
id|syncppp_statistics
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|page
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|syncppp_exit
r_static
r_int
id|syncppp_exit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sppp_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;type
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;LINE_rx
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_tx
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_status
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_open
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_close
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_xmit
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_header
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_rebuild_header
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_statistics
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|ch-&gt;LINE_privdata
)paren
suffix:semicolon
id|ch-&gt;LINE_privdata
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|syncppp_init
r_static
r_int
id|syncppp_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ppp_device
op_star
id|pppdev
op_assign
(paren
r_struct
id|ppp_device
op_star
)paren
id|ch-&gt;if_ptr
suffix:semicolon
id|ch-&gt;LINE_privdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|syncppp_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ch-&gt;LINE_privdata
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|pppdev-&gt;dev
op_assign
id|dev
suffix:semicolon
id|sppp_attach
c_func
(paren
id|pppdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;protocol
op_eq
op_amp
id|hdlc_protocol
)paren
(brace
id|pppdev-&gt;sppp.pp_flags
op_or_assign
id|PP_CISCO
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_HDLC
suffix:semicolon
)brace
r_else
(brace
id|pppdev-&gt;sppp.pp_flags
op_and_assign
op_complement
id|PP_CISCO
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
)brace
id|ch-&gt;LINE_rx
op_assign
id|sppp_input
suffix:semicolon
id|ch-&gt;LINE_tx
op_assign
id|syncppp_tx
suffix:semicolon
id|ch-&gt;LINE_status
op_assign
id|syncppp_status
suffix:semicolon
id|ch-&gt;LINE_open
op_assign
id|syncppp_open
suffix:semicolon
id|ch-&gt;LINE_close
op_assign
id|syncppp_close
suffix:semicolon
id|ch-&gt;LINE_xmit
op_assign
id|syncppp_xmit
suffix:semicolon
id|ch-&gt;LINE_header
op_assign
l_int|NULL
suffix:semicolon
id|ch-&gt;LINE_statistics
op_assign
id|syncppp_statistics
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|syncppp_protocol
r_static
r_struct
id|comx_protocol
id|syncppp_protocol
op_assign
(brace
l_string|&quot;ppp&quot;
comma
id|VERSION
comma
id|ARPHRD_PPP
comma
id|syncppp_init
comma
id|syncppp_exit
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|hdlc_protocol
r_static
r_struct
id|comx_protocol
id|hdlc_protocol
op_assign
(brace
l_string|&quot;hdlc&quot;
comma
id|VERSION
comma
id|ARPHRD_PPP
comma
id|syncppp_init
comma
id|syncppp_exit
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|macro|comx_proto_ppp_init
mdefine_line|#define comx_proto_ppp_init init_module
macro_line|#endif
DECL|function|comx_proto_ppp_init
r_int
id|__init
id|comx_proto_ppp_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|ret
op_assign
id|comx_register_protocol
c_func
(paren
op_amp
id|hdlc_protocol
)paren
)paren
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
r_return
id|comx_register_protocol
c_func
(paren
op_amp
id|syncppp_protocol
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|comx_unregister_protocol
c_func
(paren
id|syncppp_protocol.name
)paren
suffix:semicolon
id|comx_unregister_protocol
c_func
(paren
id|hdlc_protocol.name
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
