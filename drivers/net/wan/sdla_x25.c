multiline_comment|/*****************************************************************************&n;* sdla_x25.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver.  X.25 module.&n;*&n;* Author:&t;Gene Kozin&t;&lt;genek@compuserve.com&gt;&n;*&n;* Copyright:&t;(c) 1995-1997 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Mar 15, 1998  Alan Cox&t; o 2.1.x porting&n;* Nov 27, 1997&t;Jaspreet Singh&t; o Added protection against enabling of irqs&n;*&t;&t;&t;&t;   when they are disabled.&n;* Nov 17, 1997  Farhan Thawar    o Added IPX support&n;*&t;&t;&t;&t; o Changed if_send() to now buffer packets when&n;*&t;&t;&t;&t;   the board is busy&n;*&t;&t;&t;&t; o Removed queueing of packets via the polling&n;*&t;&t;&t;&t;   routing&n;*&t;&t;&t;&t; o Changed if_send() critical flags to properly&n;*&t;&t;&t;&t;   handle race conditions&n;* Nov 06, 1997  Farhan Thawar    o Added support for SVC timeouts&n;*&t;&t;&t;&t; o Changed PVC encapsulation to ETH_P_IP&n;* Jul 21, 1997  Jaspreet Singh&t; o Fixed freeing up of buffers using kfree()&n;*&t;&t;&t;&t;   when packets are received.&n;* Mar 11, 1997  Farhan Thawar   Version 3.1.1&n;*                                o added support for V35&n;*                                o changed if_send() to return 0 if&n;*                                  wandev.critical() is true&n;*                                o free socket buffer in if_send() if&n;*                                  returning 0&n;*                                o added support for single &squot;@&squot; address to&n;*                                  accept all incoming calls&n;*                                o fixed bug in set_chan_state() to disconnect&n;* Jan 15, 1997&t;Gene Kozin&t;Version 3.1.0&n;*&t;&t;&t;&t; o implemented exec() entry point&n;* Jan 07, 1997&t;Gene Kozin&t;Initial version.&n;*****************************************************************************/
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|_GNUC_
mdefine_line|#define&t;_GNUC_
macro_line|#include &lt;linux/sdla_x25.h&gt;&t;/* X.25 firmware API definitions */
multiline_comment|/****** Defines &amp; Macros ****************************************************/
DECL|macro|CMD_OK
mdefine_line|#define&t;CMD_OK&t;&t;0&t;&t;/* normal firmware return code */
DECL|macro|CMD_TIMEOUT
mdefine_line|#define&t;CMD_TIMEOUT&t;0xFF&t;&t;/* firmware command timed out */
DECL|macro|MAX_CMD_RETRY
mdefine_line|#define&t;MAX_CMD_RETRY&t;10&t;&t;/* max number of firmware retries */
DECL|macro|X25_CHAN_MTU
mdefine_line|#define&t;X25_CHAN_MTU&t;4096&t;&t;/* unfragmented logical channel MTU */
DECL|macro|X25_HRDHDR_SZ
mdefine_line|#define&t;X25_HRDHDR_SZ&t;7&t;&t;/* max encapsulation header size */
DECL|macro|X25_CONCT_TMOUT
mdefine_line|#define&t;X25_CONCT_TMOUT&t;(90*HZ)&t;&t;/* link connection timeout */
DECL|macro|X25_RECON_TMOUT
mdefine_line|#define&t;X25_RECON_TMOUT&t;(10*HZ)&t;&t;/* link connection timeout */
DECL|macro|CONNECT_TIMEOUT
mdefine_line|#define&t;CONNECT_TIMEOUT&t;(90*HZ)&t;&t;/* link connection timeout */
DECL|macro|HOLD_DOWN_TIME
mdefine_line|#define&t;HOLD_DOWN_TIME&t;(30*HZ)&t;&t;/* link hold down time */
multiline_comment|/* For IPXWAN */
DECL|macro|CVHexToAscii
mdefine_line|#define CVHexToAscii(b) (((unsigned char)(b) &gt; (unsigned char)9) ? ((unsigned char)&squot;A&squot; + ((unsigned char)(b) - (unsigned char)10)) : ((unsigned char)&squot;0&squot; + (unsigned char)(b)))
multiline_comment|/****** Data Structures *****************************************************/
multiline_comment|/* This is an extention of the &squot;struct net_device&squot; we create for each network&n; * interface to keep the rest of X.25 channel-specific data.&n; */
DECL|struct|x25_channel
r_typedef
r_struct
id|x25_channel
(brace
multiline_comment|/* This member must be first. */
DECL|member|slave
r_struct
id|net_device
op_star
id|slave
suffix:semicolon
multiline_comment|/* WAN slave */
DECL|member|name
r_char
id|name
(braket
id|WAN_IFNAME_SZ
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* interface name, ASCIIZ */
DECL|member|addr
r_char
id|addr
(braket
id|WAN_ADDRESS_SZ
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* media address, ASCIIZ */
DECL|member|lcn
r_int
id|lcn
suffix:semicolon
multiline_comment|/* logical channel number */
DECL|member|tx_pkt_size
r_int
id|tx_pkt_size
suffix:semicolon
DECL|member|protocol
r_int
r_int
id|protocol
suffix:semicolon
multiline_comment|/* ethertype, 0 - multiplexed */
DECL|member|svc
r_char
id|svc
suffix:semicolon
multiline_comment|/* 0 - permanent, 1 - switched */
DECL|member|state
r_char
id|state
suffix:semicolon
multiline_comment|/* channel state */
DECL|member|drop_sequence
r_char
id|drop_sequence
suffix:semicolon
multiline_comment|/* mark sequence for dropping */
DECL|member|state_tick
r_int
r_int
id|state_tick
suffix:semicolon
multiline_comment|/* time of the last state change */
DECL|member|idle_timeout
r_int
id|idle_timeout
suffix:semicolon
multiline_comment|/* sec, before disconnecting */
DECL|member|i_timeout_sofar
r_int
r_int
id|i_timeout_sofar
suffix:semicolon
multiline_comment|/* # of sec&squot;s we&squot;ve been idle */
DECL|member|hold_timeout
r_int
id|hold_timeout
suffix:semicolon
multiline_comment|/* sec, before re-connecting */
DECL|member|tick_counter
r_int
r_int
id|tick_counter
suffix:semicolon
multiline_comment|/* counter for transmit time out */
DECL|member|devtint
r_char
id|devtint
suffix:semicolon
multiline_comment|/* Weather we should dev_tint() */
DECL|member|rx_skb
r_struct
id|sk_buff
op_star
id|rx_skb
suffix:semicolon
multiline_comment|/* receive socket buffer */
DECL|member|tx_skb
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
multiline_comment|/* transmit socket buffer */
DECL|member|card
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* -&gt; owner */
DECL|member|ch_idx
r_int
id|ch_idx
suffix:semicolon
DECL|member|ifstats
r_struct
id|net_device_stats
id|ifstats
suffix:semicolon
multiline_comment|/* interface statistics */
DECL|typedef|x25_channel_t
)brace
id|x25_channel_t
suffix:semicolon
DECL|struct|x25_call_info
r_typedef
r_struct
id|x25_call_info
(brace
DECL|member|dest
r_char
id|dest
(braket
l_int|17
)braket
suffix:semicolon
multiline_comment|/* ASCIIZ destination address */
DECL|member|src
r_char
id|src
(braket
l_int|17
)braket
suffix:semicolon
multiline_comment|/* ASCIIZ source address */
DECL|member|nuser
r_char
id|nuser
suffix:semicolon
multiline_comment|/* number of user data bytes */
DECL|member|user
r_int
r_char
id|user
(braket
l_int|127
)braket
suffix:semicolon
multiline_comment|/* user data */
DECL|member|nfacil
r_char
id|nfacil
suffix:semicolon
multiline_comment|/* number of facilities */
r_struct
(brace
DECL|member|code
r_int
r_char
id|code
suffix:semicolon
DECL|member|parm
r_int
r_char
id|parm
suffix:semicolon
DECL|member|facil
)brace
id|facil
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* facilities */
DECL|typedef|x25_call_info_t
)brace
id|x25_call_info_t
suffix:semicolon
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|del_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* WANPIPE-specific entry points */
r_static
r_int
id|wpx_exec
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt handlers */
r_static
r_void
id|wpx_isr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|tx_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|status_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|event_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|spur_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Background polling routines */
r_static
r_void
id|wpx_poll
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_disconnected
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_connecting
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_active
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* X.25 firmware interface functions */
r_static
r_int
id|x25_get_version
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|x25_configure
(paren
id|sdla_t
op_star
id|card
comma
id|TX25Config
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|x25_get_err_stats
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|x25_get_stats
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|x25_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|x25_close_hdlc
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|x25_open_hdlc
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|x25_setup_hdlc
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|x25_set_dtr
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dtr
)paren
suffix:semicolon
r_static
r_int
id|x25_get_chan_conf
(paren
id|sdla_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
id|x25_place_call
(paren
id|sdla_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
id|x25_accept_call
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|lcn
comma
r_int
id|qdm
)paren
suffix:semicolon
r_static
r_int
id|x25_clear_call
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|lcn
comma
r_int
id|cause
comma
r_int
id|diagn
)paren
suffix:semicolon
r_static
r_int
id|x25_send
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|lcn
comma
r_int
id|qdm
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|x25_fetch_events
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|x25_error
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
r_int
id|cmd
comma
r_int
id|lcn
)paren
suffix:semicolon
multiline_comment|/* X.25 asynchronous event handlers */
r_static
r_int
id|incoming_call
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
suffix:semicolon
r_static
r_int
id|call_accepted
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
suffix:semicolon
r_static
r_int
id|call_cleared
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
suffix:semicolon
r_static
r_int
id|timeout_event
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
suffix:semicolon
r_static
r_int
id|restart_event
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
r_static
r_int
id|connect
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|disconnect
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_struct
id|net_device
op_star
id|get_dev_by_lcn
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_int
id|lcn
)paren
suffix:semicolon
r_static
r_int
id|chan_connect
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|chan_disc
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_chan_state
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_int
id|chan_send
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
r_char
id|bps_to_speed_code
(paren
r_int
r_int
id|bps
)paren
suffix:semicolon
r_static
r_int
r_int
id|dec_to_uint
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
r_int
id|hex_to_uint
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|parse_call_info
(paren
r_int
r_char
op_star
id|str
comma
id|x25_call_info_t
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* IPX functions */
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
suffix:semicolon
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
comma
r_int
r_int
id|proto
)paren
suffix:semicolon
r_extern
r_void
id|disable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|enable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/****** Global Data **********************************************************&n; * Note: All data must be explicitly initialized!!!&n; */
multiline_comment|/****** Public Functions ****************************************************/
multiline_comment|/*============================================================================&n; * X.25 Protocol Initialization routine.&n; *&n; * This routine is called by the main WANPIPE module during setup.  At this&n; * point adapter is completely initialized and X.25 firmware is running.&n; *  o read firmware version (to make sure it&squot;s alive)&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.&n; */
DECL|function|wpx_init
r_int
id|wpx_init
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
r_union
(brace
r_char
id|str
(braket
l_int|80
)braket
suffix:semicolon
id|TX25Config
id|cfg
suffix:semicolon
)brace
id|u
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_X25
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize protocol-specific fields */
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|X25_MBOX_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|X25_RXMBOX_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|X25_STATUS_OFFS
)paren
suffix:semicolon
multiline_comment|/* Read firmware version.  Note that when adapter initializes, it&n;&t; * clears the mailbox, so it may appear that the first command was&n;&t; * executed successfully when in fact it was merely erased. To work&n;&t; * around this, we execute the first command twice.&n;&t; */
r_if
c_cond
(paren
id|x25_get_version
c_func
(paren
id|card
comma
l_int|NULL
)paren
op_logical_or
id|x25_get_version
c_func
(paren
id|card
comma
id|u.str
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: running X.25 firmware v%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|u.str
)paren
suffix:semicolon
multiline_comment|/* Configure adapter. Here we set resonable defaults, then parse&n;&t; * device configuration structure and set configuration options.&n;&t; * Most configuration options are verified and corrected (if&n;&t; * necessary) since we can&squot;t rely on the adapter to do so and don&squot;t&n;&t; * want it to fail either.&n;&t; */
id|memset
c_func
(paren
op_amp
id|u.cfg
comma
l_int|0
comma
r_sizeof
(paren
id|u.cfg
)paren
)paren
suffix:semicolon
id|u.cfg.t1
op_assign
l_int|3
suffix:semicolon
id|u.cfg.n2
op_assign
l_int|10
suffix:semicolon
id|u.cfg.autoHdlc
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* automatic HDLC connection */
id|u.cfg.hdlcWindow
op_assign
l_int|7
suffix:semicolon
id|u.cfg.pktWindow
op_assign
l_int|2
suffix:semicolon
id|u.cfg.station
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* DTE */
id|u.cfg.options
op_assign
l_int|0x00B0
suffix:semicolon
multiline_comment|/* disable D-bit pragmatics */
id|u.cfg.ccittCompat
op_assign
l_int|1988
suffix:semicolon
id|u.cfg.t10t20
op_assign
l_int|30
suffix:semicolon
id|u.cfg.t11t21
op_assign
l_int|30
suffix:semicolon
id|u.cfg.t12t22
op_assign
l_int|30
suffix:semicolon
id|u.cfg.t13t23
op_assign
l_int|30
suffix:semicolon
id|u.cfg.t16t26
op_assign
l_int|30
suffix:semicolon
id|u.cfg.t28
op_assign
l_int|30
suffix:semicolon
id|u.cfg.r10r20
op_assign
l_int|5
suffix:semicolon
id|u.cfg.r12r22
op_assign
l_int|5
suffix:semicolon
id|u.cfg.r13r23
op_assign
l_int|5
suffix:semicolon
id|u.cfg.responseOpt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* RR&squot;s after every packet */
r_if
c_cond
(paren
id|conf-&gt;clocking
op_ne
id|WANOPT_EXTERNAL
)paren
id|u.cfg.baudRate
op_assign
id|bps_to_speed_code
c_func
(paren
id|conf-&gt;bps
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;station
op_ne
id|WANOPT_DTE
)paren
(brace
id|u.cfg.station
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DCE mode */
)brace
r_if
c_cond
(paren
id|conf-&gt;interface
op_ne
id|WANOPT_RS232
)paren
(brace
id|u.cfg.hdlcOptions
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* V35 mode */
)brace
multiline_comment|/* adjust MTU */
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;mtu
op_logical_or
(paren
id|conf-&gt;mtu
op_ge
l_int|1024
)paren
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|1024
suffix:semicolon
r_else
r_if
c_cond
(paren
id|conf-&gt;mtu
op_ge
l_int|512
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|512
suffix:semicolon
r_else
r_if
c_cond
(paren
id|conf-&gt;mtu
op_ge
l_int|256
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|256
suffix:semicolon
r_else
r_if
c_cond
(paren
id|conf-&gt;mtu
op_ge
l_int|128
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|128
suffix:semicolon
r_else
id|card-&gt;wandev.mtu
op_assign
l_int|64
suffix:semicolon
id|u.cfg.defPktSize
op_assign
id|u.cfg.pktMTU
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.hi_pvc
)paren
(brace
id|card-&gt;u.x.hi_pvc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.hi_pvc
comma
l_int|4095
)paren
suffix:semicolon
id|card-&gt;u.x.lo_pvc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.lo_pvc
comma
id|card-&gt;u.x.hi_pvc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;u.x25.hi_svc
)paren
(brace
id|card-&gt;u.x.hi_svc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.hi_svc
comma
l_int|4095
)paren
suffix:semicolon
id|card-&gt;u.x.lo_svc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.lo_svc
comma
id|card-&gt;u.x.hi_svc
)paren
suffix:semicolon
)brace
id|u.cfg.loPVC
op_assign
id|card-&gt;u.x.lo_pvc
suffix:semicolon
id|u.cfg.hiPVC
op_assign
id|card-&gt;u.x.hi_pvc
suffix:semicolon
id|u.cfg.loTwoWaySVC
op_assign
id|card-&gt;u.x.lo_svc
suffix:semicolon
id|u.cfg.hiTwoWaySVC
op_assign
id|card-&gt;u.x.hi_svc
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.hdlc_window
)paren
id|u.cfg.hdlcWindow
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.hdlc_window
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.pkt_window
)paren
id|u.cfg.pktWindow
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.pkt_window
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.t1
)paren
id|u.cfg.t1
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t1
comma
l_int|30
)paren
suffix:semicolon
id|u.cfg.t2
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t2
comma
l_int|29
)paren
suffix:semicolon
id|u.cfg.t4
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t4
comma
l_int|240
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.n2
)paren
id|u.cfg.n2
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.n2
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.ccitt_compat
)paren
id|u.cfg.ccittCompat
op_assign
id|conf-&gt;u.x25.ccitt_compat
suffix:semicolon
multiline_comment|/* initialize adapter */
r_if
c_cond
(paren
(paren
id|x25_configure
c_func
(paren
id|card
comma
op_amp
id|u.cfg
)paren
op_ne
id|CMD_OK
)paren
op_logical_or
(paren
id|x25_close_hdlc
c_func
(paren
id|card
)paren
op_ne
id|CMD_OK
)paren
op_logical_or
multiline_comment|/* close HDLC link */
(paren
id|x25_set_dtr
c_func
(paren
id|card
comma
l_int|0
)paren
op_ne
id|CMD_OK
)paren
)paren
multiline_comment|/* drop DTR */
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Initialize protocol-specific fields of adapter data space */
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|card-&gt;wandev.station
op_assign
id|conf-&gt;station
suffix:semicolon
id|card-&gt;isr
op_assign
op_amp
id|wpx_isr
suffix:semicolon
id|card-&gt;poll
op_assign
op_amp
id|wpx_poll
suffix:semicolon
id|card-&gt;exec
op_assign
op_amp
id|wpx_exec
suffix:semicolon
id|card-&gt;wandev.update
op_assign
op_amp
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
op_amp
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
op_amp
id|del_if
suffix:semicolon
id|card-&gt;wandev.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
id|card-&gt;wandev.enable_tx_int
op_assign
l_int|0
suffix:semicolon
id|card-&gt;irq_dis_if_send_count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;irq_dis_poll_count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.enable_IPX
op_assign
id|conf-&gt;enable_IPX
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;network_number
)paren
id|card-&gt;wandev.network_number
op_assign
id|conf-&gt;network_number
suffix:semicolon
r_else
id|card-&gt;wandev.network_number
op_assign
l_int|0xDEADBEEF
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Update device status &amp; statistics.&n; */
DECL|function|update
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|x25_get_err_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|x25_get_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|wandev-&gt;critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registaration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created)&n; */
DECL|function|new_if
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize private data */
id|chan
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|x25_channel_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chan
comma
l_int|0
comma
r_sizeof
(paren
id|x25_channel_t
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|chan-&gt;name
comma
id|conf-&gt;name
)paren
suffix:semicolon
id|chan-&gt;card
op_assign
id|card
suffix:semicolon
id|chan-&gt;protocol
op_assign
id|ETH_P_IP
suffix:semicolon
id|chan-&gt;tx_skb
op_assign
id|chan-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* verify media address */
r_if
c_cond
(paren
id|conf-&gt;addr
(braket
l_int|0
)braket
op_eq
l_char|&squot;@&squot;
)paren
multiline_comment|/* SVC */
(brace
id|chan-&gt;svc
op_assign
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|chan-&gt;addr
comma
op_amp
id|conf-&gt;addr
(braket
l_int|1
)braket
comma
id|WAN_ADDRESS_SZ
)paren
suffix:semicolon
multiline_comment|/* Set channel timeouts (default if not specified) */
id|chan-&gt;idle_timeout
op_assign
(paren
id|conf-&gt;idle_timeout
)paren
ques
c_cond
id|conf-&gt;idle_timeout
suffix:colon
l_int|90
suffix:semicolon
id|chan-&gt;hold_timeout
op_assign
(paren
id|conf-&gt;hold_timeout
)paren
ques
c_cond
id|conf-&gt;hold_timeout
suffix:colon
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_digit
c_func
(paren
id|conf-&gt;addr
(braket
l_int|0
)braket
)paren
)paren
multiline_comment|/* PVC */
(brace
r_int
id|lcn
op_assign
id|dec_to_uint
c_func
(paren
id|conf-&gt;addr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lcn
op_ge
id|card-&gt;u.x.lo_pvc
)paren
op_logical_and
(paren
id|lcn
op_le
id|card-&gt;u.x.hi_pvc
)paren
)paren
(brace
id|chan-&gt;lcn
op_assign
id|lcn
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PVC %u is out of range on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|lcn
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid media address on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* prepare network device data space for registration */
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|chan
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Delete logical channel.&n; */
DECL|function|del_if
r_static
r_int
id|del_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** WANPIPE-specific entry points ***************************************/
multiline_comment|/*============================================================================&n; * Execute adapter interface command.&n; */
DECL|function|wpx_exec
r_static
r_int
id|wpx_exec
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
comma
id|len
suffix:semicolon
id|TX25Cmd
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
comma
id|u_cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* execute command */
r_do
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd.length
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|u_data
comma
id|cmd.length
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sdla_exec
c_func
(paren
id|mbox
)paren
)paren
id|err
op_assign
id|mbox-&gt;cmd.result
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|cmd.command
comma
id|cmd.lcn
)paren
)paren
suffix:semicolon
multiline_comment|/* return result */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|u_cmd
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|u_data
op_logical_and
id|copy_to_user
c_func
(paren
id|u_data
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Network Device Interface ********************************************/
multiline_comment|/*============================================================================&n; * Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration.&n; */
DECL|function|if_init
r_static
r_int
id|if_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
op_amp
id|if_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
op_amp
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|if_stats
suffix:semicolon
multiline_comment|/* Initialize media-specific parameters */
id|dev-&gt;type
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* ARP h/w type */
id|dev-&gt;mtu
op_assign
id|X25_CHAN_MTU
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|X25_HRDHDR_SZ
suffix:semicolon
multiline_comment|/* media header length */
id|dev-&gt;addr_len
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* hardware address length */
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;svc
)paren
op_star
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|chan-&gt;lcn
)paren
suffix:semicolon
multiline_comment|/* Initialize hardware parameters (just for reference) */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
(paren
r_int
r_int
)paren
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|dev-&gt;mem_end
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length */
id|dev-&gt;tx_queue_len
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Initialize socket buffers */
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open network interface.&n; * o prevent module from unloading by incrementing use count&n; * o if link is disconnected then initiate connection&n; *&n; * Return 0 if O.k. or errno.&n; */
DECL|function|if_open
r_static
r_int
id|if_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* only one open is allowed */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* If this is the first open, initiate physical connection */
r_if
c_cond
(paren
id|card-&gt;open_cnt
op_eq
l_int|1
)paren
id|connect
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close network interface.&n; * o reset flags.&n; * o if there&squot;s no more open channels then disconnect physical link.&n; */
DECL|function|if_close
r_static
r_int
id|if_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chan-&gt;state
op_eq
id|WAN_CONNECTED
)paren
op_logical_or
(paren
id|chan-&gt;state
op_eq
id|WAN_CONNECTING
)paren
)paren
id|chan_disc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* If this is the last close, disconnect physical link */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;open_cnt
)paren
id|disconnect
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Build media header.&n; * o encapsulate packet according to encapsulation type.&n; *&n; * The trick here is to put packet type (Ethertype) into &squot;protocol&squot; field of&n; * the socket buffer, so that we don&squot;t forget it.  If encapsulation fails,&n; * set skb-&gt;protocol to 0 and discard packet later.&n; *&n; * Return:&t;media header length.&n; */
DECL|function|if_header
r_static
r_int
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|hdr_len
op_assign
id|dev-&gt;hard_header_len
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;protocol
)paren
(brace
id|hdr_len
op_assign
id|wanrouter_encapsulate
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr_len
OL
l_int|0
)paren
(brace
id|hdr_len
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|hdr_len
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Re-build media header.&n; *&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved&n; */
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rebuild_header() called for interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a packet on a network interface.&n; * o set tbusy flag (marks start of the transmission).&n; * o check link state. If link is not up, then drop the packet.&n; * o check channel status. If it&squot;s down then initiate a call.&n; * o pass a packet to corresponding WAN device.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * 2. Setting tbusy flag will inhibit further transmit requests from the&n; *    protocol stack and can be used for flow control with protocol layer.&n; */
DECL|function|if_send
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_struct
id|net_device
op_star
id|dev2
suffix:semicolon
id|TX25Status
op_star
id|status
op_assign
id|card-&gt;flags
suffix:semicolon
r_int
r_int
id|host_cpu_flags
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|chan-&gt;tick_counter
)paren
OL
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
r_return
id|dev-&gt;tbusy
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit time out %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_while
c_loop
(paren
id|dev2
)paren
(brace
id|x25_channel_t
op_star
id|chan2
op_assign
id|dev2-&gt;priv
suffix:semicolon
id|dev2-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev2
op_assign
id|chan2-&gt;slave
suffix:semicolon
)brace
)brace
id|chan-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
op_increment
id|card-&gt;irq_dis_if_send_count
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Hit critical in if_send()!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.critical
op_eq
id|CRITICAL_IN_ISR
)paren
(brace
id|card-&gt;wandev.enable_tx_int
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_if_send_count
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|card-&gt;irq_dis_poll_count
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
id|dev-&gt;tbusy
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_if_send_count
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|card-&gt;irq_dis_poll_count
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
id|dev-&gt;tbusy
suffix:semicolon
)brace
multiline_comment|/* Below is only until we have per-channel IPX going.... */
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan-&gt;svc
)paren
)paren
(brace
id|chan-&gt;protocol
op_assign
id|skb-&gt;protocol
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
multiline_comment|/* Below is only until we have per-channel IPX going.... */
r_else
r_if
c_cond
(paren
(paren
id|chan-&gt;svc
)paren
op_logical_and
(paren
id|chan-&gt;protocol
op_logical_and
(paren
id|chan-&gt;protocol
op_ne
id|skb-&gt;protocol
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unsupported Ethertype 0x%04X on interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|skb-&gt;protocol
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_errors
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|chan-&gt;state
)paren
(brace
r_case
id|WAN_DISCONNECTED
suffix:colon
multiline_comment|/* Try to establish connection. If succeded, then start&n;&t;&t;&t; * transmission, else drop a packet.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|chan_connect
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* fall through */
r_case
id|WAN_CONNECTED
suffix:colon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|ETH_P_IPX
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.enable_IPX
)paren
(brace
id|switch_net_numbers
c_func
(paren
id|skb-&gt;data
comma
id|card-&gt;wandev.network_number
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
r_goto
id|tx_done
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|chan_send
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|status-&gt;imask
op_or_assign
l_int|0x2
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
id|tx_done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;tbusy
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_if_send_count
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|card-&gt;irq_dis_poll_count
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
id|dev-&gt;tbusy
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get Ethernet-style interface statistics.&n; * Return a pointer to struct net_device_stats&n; */
DECL|function|if_stats
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
id|chan-&gt;ifstats
suffix:semicolon
)brace
multiline_comment|/****** Interrupt Handlers **************************************************/
multiline_comment|/*============================================================================&n; * X.25 Interrupt Service Routine.&n; */
DECL|function|wpx_isr
r_static
r_void
id|wpx_isr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Status
op_star
id|status
op_assign
id|card-&gt;flags
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|host_cpu_flags
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;wpx_isr: %s, wandev.critical set to 0x%02X, int type = 0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.critical
comma
id|status-&gt;iflags
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* For all interrupts set the critical flag to CRITICAL_RX_INTR.&n;         * If the if_send routine is called with this flag set it will set&n;         * the enable transmit flag to 1. (for a delayed interrupt)&n;         */
id|card-&gt;wandev.critical
op_assign
id|CRITICAL_IN_ISR
suffix:semicolon
r_switch
c_cond
(paren
id|status-&gt;iflags
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* receive interrupt */
id|rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* transmit interrupt */
id|tx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|1
suffix:semicolon
id|status-&gt;imask
op_and_assign
op_complement
l_int|0x2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* modem status interrupt */
id|status_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
multiline_comment|/* network event interrupt */
id|event_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unwanted interrupt */
id|spur_intr
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
id|CRITICAL_INTR_HANDLED
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.enable_tx_int
)paren
(brace
id|card-&gt;wandev.enable_tx_int
op_assign
l_int|0
suffix:semicolon
id|status-&gt;imask
op_or_assign
l_int|0x2
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
id|status-&gt;iflags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clear interrupt condition */
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;buff_int_mode_unbusy
)paren
(brace
id|x25_channel_t
op_star
id|chan
suffix:semicolon
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;devtint
)paren
(brace
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*============================================================================&n; * Receive interrupt handler.&n; * This routine handles fragmented IP packets using M-bit according to the&n; * RFC1356.&n; * o map ligical channel number to network interface.&n; * o allocate socket buffer or append received packet to the existing one.&n; * o if M-bit is reset (i.e. it&squot;s the last packet in a sequence) then &n; *   decapsulate packet and pass socket buffer to the protocol stack.&n; *&n; * Notes:&n; * 1. When allocating a socket buffer, if M-bit is set then more data is&n; *    comming and we have to allocate buffer for the maximum IP packet size&n; *    expected on this channel.&n; * 2. If something goes wrong and X.25 packet has to be dropped (e.g. no&n; *    socket buffers available) the whole packet sequence must be discarded.&n; */
DECL|function|rx_intr
r_static
r_void
id|rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Mbox
op_star
id|rxmb
op_assign
id|card-&gt;rxmb
suffix:semicolon
r_int
id|lcn
op_assign
id|rxmb-&gt;cmd.lcn
suffix:semicolon
multiline_comment|/* logical channel number */
r_int
id|len
op_assign
id|rxmb-&gt;cmd.length
suffix:semicolon
multiline_comment|/* packet length */
r_int
id|qdm
op_assign
id|rxmb-&gt;cmd.qdm
suffix:semicolon
multiline_comment|/* Q,D and M bits */
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
id|lcn
)paren
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_void
op_star
id|bufptr
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: receiving on orphaned LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|chan-&gt;i_timeout_sofar
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;drop_sequence
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|qdm
op_amp
l_int|0x01
)paren
)paren
id|chan-&gt;drop_sequence
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|chan-&gt;rx_skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate new socket buffer */
r_int
id|bufsize
op_assign
(paren
id|qdm
op_amp
l_int|0x01
)paren
ques
c_cond
id|dev-&gt;mtu
suffix:colon
id|len
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|bufsize
op_plus
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|chan-&gt;drop_sequence
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set flag */
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|chan-&gt;protocol
)paren
suffix:semicolon
id|chan-&gt;rx_skb
op_assign
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OL
id|len
)paren
(brace
multiline_comment|/* No room for the packet. Call off the whole thing! */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|chan-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|qdm
op_amp
l_int|0x01
)paren
id|chan-&gt;drop_sequence
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unexpectedly long packet sequence &quot;
l_string|&quot;on interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_length_errors
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Append packet to the socket buffer */
id|bufptr
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bufptr
comma
id|rxmb-&gt;data
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qdm
op_amp
l_int|0x01
)paren
r_return
suffix:semicolon
multiline_comment|/* more data is comming */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* timestamp */
id|chan-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* dequeue packet */
multiline_comment|/* Decapsulate packet, if necessary */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
op_logical_and
op_logical_neg
id|wanrouter_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* can&squot;t decapsulate packet */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_errors
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|handle_IPXWAN
c_func
(paren
id|skb-&gt;data
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.enable_IPX
comma
id|card-&gt;wandev.network_number
comma
id|skb-&gt;protocol
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.enable_IPX
)paren
(brace
r_if
c_cond
(paren
id|chan_send
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
id|chan-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* FIXME: increment IPX packet dropped statistic */
)brace
)brace
r_else
(brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_packets
suffix:semicolon
id|chan-&gt;ifstats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*============================================================================&n; * Transmit interrupt handler.&n; *&t;o Release socket buffer&n; *&t;o Clear &squot;tbusy&squot; flag&n; */
DECL|function|tx_intr
r_static
r_void
id|tx_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
multiline_comment|/* unbusy all devices and then dev_tint(); */
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|chan-&gt;devtint
op_assign
id|dev-&gt;tbusy
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Modem status interrupt handler.&n; */
DECL|function|status_intr
r_static
r_void
id|status_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
)brace
multiline_comment|/*============================================================================&n; * Network event interrupt handler.&n; */
DECL|function|event_intr
r_static
r_void
id|event_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
)brace
multiline_comment|/*============================================================================&n; * Spurious interrupt handler.&n; * o print a warning&n; * o &n; * If number of spurious interrupts exceeded some limit, then ???&n; */
DECL|function|spur_intr
r_static
r_void
id|spur_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/****** Background Polling Routines  ****************************************/
multiline_comment|/*============================================================================&n; * Main polling routine.&n; * This routine is repeatedly called by the WANPIPE &squot;thread&squot; to allow for&n; * time-dependent housekeeping work.&n; *&n; * Notes:&n; * 1. This routine may be called on interrupt context with all interrupts&n; *    enabled. Beware!&n; */
DECL|function|wpx_poll
r_static
r_void
id|wpx_poll
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_int
r_int
id|host_cpu_flags
suffix:semicolon
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
op_increment
id|card-&gt;irq_dis_poll_count
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: critical in polling!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|card-&gt;irq_dis_if_send_count
)paren
op_logical_and
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_poll_count
)paren
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|card-&gt;wandev.state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|poll_active
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|poll_connecting
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|poll_disconnected
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|card-&gt;irq_dis_if_send_count
)paren
op_logical_and
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;irq_dis_poll_count
)paren
)paren
)paren
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|host_cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle physical link establishment phase.&n; * o if connection timed out, disconnect the link.&n; */
DECL|function|poll_connecting
r_static
r_void
id|poll_connecting
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Status
op_star
id|status
op_assign
id|card-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|status-&gt;gflags
op_amp
id|X25_HDLC_ABM
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
id|x25_set_intr_mode
c_func
(paren
id|card
comma
l_int|0x83
)paren
suffix:semicolon
multiline_comment|/* enable Rx interrupts */
id|status-&gt;imask
op_and_assign
op_complement
l_int|0x2
suffix:semicolon
multiline_comment|/* mask Tx interupts */
)brace
r_else
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|card-&gt;state_tick
)paren
OG
id|CONNECT_TIMEOUT
)paren
id|disconnect
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle physical link disconnected phase.&n; * o if hold-down timeout has expired and there are open interfaces, connect&n; *   link.&n; */
DECL|function|poll_disconnected
r_static
r_void
id|poll_disconnected
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;open_cnt
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|card-&gt;state_tick
)paren
OG
id|HOLD_DOWN_TIME
)paren
)paren
id|connect
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle active link phase.&n; * o fetch X.25 asynchronous events.&n; * o kick off transmission on all interfaces.&n; */
DECL|function|poll_active
r_static
r_void
id|poll_active
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Fetch X.25 asynchronous events */
id|x25_fetch_events
c_func
(paren
id|card
)paren
suffix:semicolon
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|chan-&gt;tx_skb
suffix:semicolon
multiline_comment|/* If there is a packet queued for transmission then kick&n;&t;&t; * the channel&squot;s send routine. When transmission is complete&n;&t;&t; * or if error has occurred, release socket buffer and reset&n;&t;&t; * &squot;tbusy&squot; flag.&n;&t;&t; */
r_if
c_cond
(paren
id|skb
op_logical_and
(paren
id|chan_send
c_func
(paren
id|dev
comma
id|skb
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|chan-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* If SVC has been idle long enough, close virtual circuit */
r_if
c_cond
(paren
(paren
id|chan-&gt;svc
)paren
op_logical_and
(paren
id|chan-&gt;state
op_eq
id|WAN_CONNECTED
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|chan-&gt;i_timeout_sofar
)paren
op_div
id|HZ
OG
id|chan-&gt;idle_timeout
)paren
(brace
multiline_comment|/* Close svc */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Closing down Idle link %s on LCN %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;name
comma
id|chan-&gt;lcn
)paren
suffix:semicolon
id|chan-&gt;i_timeout_sofar
op_assign
id|jiffies
suffix:semicolon
id|chan_disc
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
)brace
multiline_comment|/****** SDLA Firmware-Specific Functions *************************************&n; * Almost all X.25 commands can unexpetedly fail due to so called &squot;X.25&n; * asynchronous events&squot; such as restart, interrupt, incoming call request,&n; * call clear request, etc.  They can&squot;t be ignored and have to be dealt with&n; * immediately.  To tackle with this problem we execute each interface command&n; * in a loop until good return code is received or maximum number of retries&n; * is reached.  Each interface command returns non-zero return code, an&n; * asynchronous event/error handler x25_error() is called.&n; */
multiline_comment|/*============================================================================&n; * Read X.25 firmware version.&n; *&t;Put code version as ASCII string in str. &n; */
DECL|function|x25_get_version
r_static
r_int
id|x25_get_version
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_READ_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_READ_CODE_VERSION
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|str
)paren
(brace
r_int
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
id|memcpy
c_func
(paren
id|str
comma
id|mbox-&gt;data
comma
id|len
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Configure adapter.&n; */
DECL|function|x25_configure
r_static
r_int
id|x25_configure
(paren
id|sdla_t
op_star
id|card
comma
id|TX25Config
op_star
id|conf
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
(paren
r_void
op_star
)paren
id|conf
comma
r_sizeof
(paren
id|TX25Config
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|TX25Config
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_SET_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_SET_CONFIGURATION
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get communications error statistics.&n; */
DECL|function|x25_get_err_stats
r_static
r_int
id|x25_get_err_stats
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_HDLC_READ_COMM_ERR
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_HDLC_READ_COMM_ERR
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|THdlcCommErr
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|stats-&gt;rxOverrun
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|stats-&gt;rxBadCrc
suffix:semicolon
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|stats-&gt;rxAborted
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|stats-&gt;txAborted
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get protocol statistics.&n; */
DECL|function|x25_get_stats
r_static
r_int
id|x25_get_stats
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_READ_STATISTICS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_READ_STATISTICS
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|TX25Stats
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_packets
op_assign
id|stats-&gt;rxData
suffix:semicolon
id|card-&gt;wandev.stats.tx_packets
op_assign
id|stats-&gt;rxData
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close HDLC link.&n; */
DECL|function|x25_close_hdlc
r_static
r_int
id|x25_close_hdlc
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_HDLC_LINK_CLOSE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_HDLC_LINK_CLOSE
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open HDLC link.&n; */
DECL|function|x25_open_hdlc
r_static
r_int
id|x25_open_hdlc
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_HDLC_LINK_OPEN
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_HDLC_LINK_OPEN
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Setup HDLC link.&n; */
DECL|function|x25_setup_hdlc
r_static
r_int
id|x25_setup_hdlc
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_HDLC_LINK_SETUP
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_HDLC_LINK_SETUP
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set (raise/drop) DTR.&n; */
DECL|function|x25_set_dtr
r_static
r_int
id|x25_set_dtr
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dtr
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|1
)braket
op_assign
id|dtr
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x01
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|3
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_SET_GLOBAL_VARS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_SET_GLOBAL_VARS
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set interrupt mode.&n; */
DECL|function|x25_set_intr_mode
r_static
r_int
id|x25_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.fwid
op_eq
id|SFID_X25_508
)paren
(brace
id|mbox-&gt;data
(braket
l_int|1
)braket
op_assign
id|card-&gt;hw.irq
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|2
suffix:semicolon
)brace
r_else
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_SET_INTERRUPT_MODE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_SET_INTERRUPT_MODE
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Read X.25 channel configuration.&n; */
DECL|function|x25_get_chan_conf
r_static
r_int
id|x25_get_chan_conf
(paren
id|sdla_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|lcn
op_assign
id|chan-&gt;lcn
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.lcn
op_assign
id|lcn
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_READ_CHANNEL_CONFIG
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_READ_CHANNEL_CONFIG
comma
id|lcn
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|TX25Status
op_star
id|status
op_assign
id|card-&gt;flags
suffix:semicolon
multiline_comment|/* calculate an offset into the array of status bytes */
r_if
c_cond
(paren
id|card-&gt;u.x.hi_svc
op_le
l_int|255
)paren
id|chan-&gt;ch_idx
op_assign
id|lcn
op_minus
l_int|1
suffix:semicolon
r_else
(brace
r_int
id|offset
suffix:semicolon
r_switch
c_cond
(paren
id|mbox-&gt;data
(braket
l_int|0
)braket
op_logical_and
l_int|0x1F
)paren
(brace
r_case
l_int|0x01
suffix:colon
id|offset
op_assign
id|status-&gt;pvc_map
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|offset
op_assign
id|status-&gt;icc_map
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|offset
op_assign
id|status-&gt;twc_map
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|offset
op_assign
id|status-&gt;ogc_map
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
id|chan-&gt;ch_idx
op_assign
id|lcn
op_minus
l_int|1
op_minus
id|offset
suffix:semicolon
)brace
multiline_comment|/* get actual transmit packet size on this channel */
r_switch
c_cond
(paren
id|mbox-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x38
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|64
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x18
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|256
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x28
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|512
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x30
suffix:colon
id|chan-&gt;tx_pkt_size
op_assign
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 packet size on LCN %d is %d.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
comma
id|chan-&gt;tx_pkt_size
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Place X.25 call.&n; */
DECL|function|x25_place_call
r_static
r_int
id|x25_place_call
(paren
id|sdla_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_char
id|str
(braket
l_int|64
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;-d%s -uCC&quot;
comma
id|chan-&gt;addr
)paren
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|mbox-&gt;data
comma
id|str
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_PLACE_CALL
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_PLACE_CALL
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|chan-&gt;lcn
op_assign
id|mbox-&gt;cmd.lcn
suffix:semicolon
id|chan-&gt;protocol
op_assign
id|ETH_P_IP
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Accept X.25 call.&n; */
DECL|function|x25_accept_call
r_static
r_int
id|x25_accept_call
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|lcn
comma
r_int
id|qdm
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.lcn
op_assign
id|lcn
suffix:semicolon
id|mbox-&gt;cmd.qdm
op_assign
id|qdm
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_ACCEPT_CALL
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_ACCEPT_CALL
comma
id|lcn
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Clear X.25 call.&n; */
DECL|function|x25_clear_call
r_static
r_int
id|x25_clear_call
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|lcn
comma
r_int
id|cause
comma
r_int
id|diagn
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.lcn
op_assign
id|lcn
suffix:semicolon
id|mbox-&gt;cmd.cause
op_assign
id|cause
suffix:semicolon
id|mbox-&gt;cmd.diagn
op_assign
id|diagn
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_CLEAR_CALL
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_CLEAR_CALL
comma
id|lcn
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send X.25 data packet.&n; */
DECL|function|x25_send
r_static
r_int
id|x25_send
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|lcn
comma
r_int
id|qdm
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
(brace
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|len
suffix:semicolon
id|mbox-&gt;cmd.lcn
op_assign
id|lcn
suffix:semicolon
id|mbox-&gt;cmd.qdm
op_assign
id|qdm
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_WRITE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_WRITE
comma
id|lcn
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Fetch X.25 asynchronous events.&n; */
DECL|function|x25_fetch_events
r_static
r_int
id|x25_fetch_events
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|TX25Status
op_star
id|status
op_assign
id|card-&gt;flags
suffix:semicolon
id|TX25Mbox
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status-&gt;gflags
op_amp
l_int|0x20
)paren
(brace
id|memset
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|TX25Cmd
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|X25_IS_DATA_AVAILABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|x25_error
c_func
(paren
id|card
comma
id|err
comma
id|X25_IS_DATA_AVAILABLE
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * X.25 asynchronous event/error handler.&n; *&t;This routine is called each time interface command returns non-zero&n; *&t;return code to handle X.25 asynchronous events and common errors.&n; *&t;Return non-zero to repeat command or zero to cancel it.&n; *&n; * Notes:&n; * 1. This function may be called recursively, as handling some of the&n; *    asynchronous events (e.g. call request) requires execution of the&n; *    interface command(s) that, in turn, may also return asynchronous&n; *    events.  To avoid re-entrancy problems we copy mailbox to dynamically&n; *    allocated memory before processing events.&n; */
DECL|function|x25_error
r_static
r_int
id|x25_error
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
r_int
id|cmd
comma
r_int
id|lcn
)paren
(brace
r_int
id|retry
op_assign
l_int|1
suffix:semicolon
r_int
id|dlen
op_assign
(paren
(paren
id|TX25Mbox
op_star
)paren
id|card-&gt;mbox
)paren
op_member_access_from_pointer
id|cmd.length
suffix:semicolon
id|TX25Mbox
op_star
id|mb
suffix:semicolon
id|mb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|TX25Mbox
)paren
op_plus
id|dlen
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: x25_error() out of memory!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|mb
comma
id|card-&gt;mbox
comma
r_sizeof
(paren
id|TX25Mbox
)paren
op_plus
id|dlen
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
l_int|0x40
suffix:colon
multiline_comment|/* X.25 asynchronous packet was received */
id|mb-&gt;data
(braket
id|dlen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_switch
c_cond
(paren
id|mb-&gt;cmd.pktType
op_amp
l_int|0x7F
)paren
(brace
r_case
l_int|0x30
suffix:colon
multiline_comment|/* incoming call */
id|retry
op_assign
id|incoming_call
c_func
(paren
id|card
comma
id|cmd
comma
id|lcn
comma
id|mb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x31
suffix:colon
multiline_comment|/* connected */
id|retry
op_assign
id|call_accepted
c_func
(paren
id|card
comma
id|cmd
comma
id|lcn
comma
id|mb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* call clear request */
id|retry
op_assign
id|call_cleared
c_func
(paren
id|card
comma
id|cmd
comma
id|lcn
comma
id|mb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* reset request */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 reset request on LCN %d! &quot;
l_string|&quot;Cause:0x%02X Diagn:0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;cmd.lcn
comma
id|mb-&gt;cmd.cause
comma
id|mb-&gt;cmd.diagn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* restart request */
id|retry
op_assign
id|restart_event
c_func
(paren
id|card
comma
id|cmd
comma
id|lcn
comma
id|mb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 event 0x%02X on LCN %d! &quot;
l_string|&quot;Cause:0x%02X Diagn:0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;cmd.pktType
comma
id|mb-&gt;cmd.lcn
comma
id|mb-&gt;cmd.cause
comma
id|mb-&gt;cmd.diagn
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x41
suffix:colon
multiline_comment|/* X.25 protocol violation indication */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 protocol violation on LCN %d! &quot;
l_string|&quot;Packet:0x%02X Cause:0x%02X Diagn:0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;cmd.lcn
comma
id|mb-&gt;cmd.pktType
op_amp
l_int|0x7F
comma
id|mb-&gt;cmd.cause
comma
id|mb-&gt;cmd.diagn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x42
suffix:colon
multiline_comment|/* X.25 timeout */
id|retry
op_assign
id|timeout_event
c_func
(paren
id|card
comma
id|cmd
comma
id|lcn
comma
id|mb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x43
suffix:colon
multiline_comment|/* X.25 retry limit exceeded */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: exceeded X.25 retry limit on LCN %d! &quot;
l_string|&quot;Packet:0x%02X Diagn:0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;cmd.lcn
comma
id|mb-&gt;cmd.pktType
comma
id|mb-&gt;cmd.diagn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* modem failure */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: modem failure!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
multiline_comment|/* N2 retry limit */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: exceeded HDLC retry limit!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* unnumbered frame was received while in ABM */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received Unnumbered frame 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: command 0x%02X timed out!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
)paren
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* abort command */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X returned 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
comma
id|err
)paren
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* abort command */
)brace
id|kfree
c_func
(paren
id|mb
)paren
suffix:semicolon
r_return
id|retry
suffix:semicolon
)brace
multiline_comment|/****** X.25 Asynchronous Event Handlers *************************************&n; * These functions are called by the x25_error() and should return 0, if&n; * the command resulting in the asynchronous event must be aborted.&n; */
multiline_comment|/*============================================================================&n; * Handle X.25 incoming call request.&n; *&t;RFC 1356 establishes the following rules:&n; *&t;1. The first octet in the Call User Data (CUD) field of the call&n; *&t;   request packet contains NLPID identifying protocol encapsulation.&n; *&t;2. Calls MUST NOT be accepted unless router supports requested&n; *&t;   protocol encapsulation.&n; *&t;3. A diagnostic code 249 defined by ISO/IEC 8208 may be used when&n; *&t;   clearing a call because protocol encapsulation is not supported.&n; *&t;4. If an incoming call is received while a call request is pending&n; *&t;   (i.e. call collision has occurred), the incoming call shall be&n; *&t;   rejected and call request shall be retried.&n; */
DECL|function|incoming_call
r_static
r_int
id|incoming_call
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_int
id|new_lcn
op_assign
id|mb-&gt;cmd.lcn
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_channel_t
op_star
id|chan
op_assign
l_int|NULL
suffix:semicolon
r_int
id|accept
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set to &squot;1&squot; if o.k. to accept call */
id|x25_call_info_t
op_star
id|info
suffix:semicolon
multiline_comment|/* Make sure there is no call collision */
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 incoming call collision on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Make sure D bit is not set in call request */
r_if
c_cond
(paren
id|mb-&gt;cmd.qdm
op_amp
l_int|0x02
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 incoming call on LCN %d with D-bit set!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Parse call request data */
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|x25_call_info_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: not enough memory to parse X.25 incoming call &quot;
l_string|&quot;on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|parse_call_info
c_func
(paren
id|mb-&gt;data
comma
id|info
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 incoming call on LCN %d! Call data: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
comma
id|mb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Find available channel */
id|dev
op_assign
id|wandev-&gt;dev
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;svc
op_logical_or
(paren
id|chan-&gt;state
op_ne
id|WAN_DISCONNECTED
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|info-&gt;src
comma
id|chan-&gt;addr
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* If just an &squot;@&squot; is specified, accept all incoming calls */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|chan-&gt;addr
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no channels available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Check requested protocol encapsulation */
r_else
r_if
c_cond
(paren
id|info-&gt;nuser
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no user data in incoming call on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|info-&gt;user
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* multiplexed */
id|chan-&gt;protocol
op_assign
l_int|0
suffix:semicolon
id|accept
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NLPID_IP
suffix:colon
multiline_comment|/* IP datagrams */
id|chan-&gt;protocol
op_assign
id|ETH_P_IP
suffix:semicolon
id|accept
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NLPID_SNAP
suffix:colon
multiline_comment|/* IPX datagrams */
id|chan-&gt;protocol
op_assign
id|ETH_P_IPX
suffix:semicolon
id|accept
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unsupported NLPID 0x%02X in incoming call &quot;
l_string|&quot;on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|info-&gt;user
(braket
l_int|0
)braket
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|249
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|accept
op_logical_and
(paren
id|x25_accept_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
)paren
op_eq
id|CMD_OK
)paren
)paren
(brace
id|chan-&gt;lcn
op_assign
id|new_lcn
suffix:semicolon
r_if
c_cond
(paren
id|x25_get_chan_conf
c_func
(paren
id|card
comma
id|chan
)paren
op_eq
id|CMD_OK
)paren
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_else
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle accepted call.&n; */
DECL|function|call_accepted
r_static
r_int
id|call_accepted
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
(brace
r_int
id|new_lcn
op_assign
id|mb-&gt;cmd.lcn
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
op_amp
id|card-&gt;wandev
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 call accepted on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: clearing orphaned connection on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Get channel configuration and notify router */
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|x25_get_chan_conf
c_func
(paren
id|card
comma
id|chan
)paren
op_ne
id|CMD_OK
)paren
(brace
id|x25_clear_call
c_func
(paren
id|card
comma
id|new_lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle cleared call.&n; */
DECL|function|call_cleared
r_static
r_int
id|call_cleared
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
(brace
r_int
id|new_lcn
op_assign
id|mb-&gt;cmd.lcn
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
op_amp
id|card-&gt;wandev
comma
id|new_lcn
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 clear request on LCN %d! Cause:0x%02X &quot;
l_string|&quot;Diagn:0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
comma
id|mb-&gt;cmd.cause
comma
id|mb-&gt;cmd.diagn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
(paren
(paren
id|cmd
op_eq
id|X25_WRITE
)paren
op_logical_and
(paren
id|lcn
op_eq
id|new_lcn
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle X.25 restart event.&n; */
DECL|function|restart_event
r_static
r_int
id|restart_event
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 restart request! Cause:0x%02X Diagn:0x%02X&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;cmd.cause
comma
id|mb-&gt;cmd.diagn
)paren
suffix:semicolon
multiline_comment|/* down all logical channels */
id|dev
op_assign
id|wandev-&gt;dev
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
r_return
(paren
id|cmd
op_eq
id|X25_WRITE
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle timeout event.&n; */
DECL|function|timeout_event
r_static
r_int
id|timeout_event
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cmd
comma
r_int
id|lcn
comma
id|TX25Mbox
op_star
id|mb
)paren
(brace
r_int
id|new_lcn
op_assign
id|mb-&gt;cmd.lcn
suffix:semicolon
r_if
c_cond
(paren
id|mb-&gt;cmd.pktType
op_eq
l_int|0x05
)paren
multiline_comment|/* call request time out */
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
op_amp
id|card-&gt;wandev
comma
id|new_lcn
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 call timed timeout on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|new_lcn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: X.25 packet 0x%02X timeout on LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mb-&gt;cmd.pktType
comma
id|new_lcn
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/******* Miscellaneous ******************************************************/
multiline_comment|/*============================================================================&n; * Establish physical connection.&n; * o open HDLC and raise DTR&n; *&n; * Return:&t;0&t;connection established&n; *&t;&t;1&t;connection is in progress&n; *&t;&t;&lt;0&t;error&n; */
DECL|function|connect
r_static
r_int
id|connect
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|x25_open_hdlc
c_func
(paren
id|card
)paren
op_logical_or
id|x25_setup_hdlc
c_func
(paren
id|card
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Tear down physical connection.&n; * o close HDLC link&n; * o drop DTR&n; *&n; * Return:&t;0&n; *&t;&t;&lt;0&t;error&n; */
DECL|function|disconnect
r_static
r_int
id|disconnect
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|x25_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable interrupt generation */
id|x25_close_hdlc
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* close HDLC link */
id|x25_set_dtr
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* drop DTR */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Find network device by its channel number.&n; */
DECL|function|get_dev_by_lcn
r_static
r_struct
id|net_device
op_star
id|get_dev_by_lcn
(paren
id|wan_device_t
op_star
id|wandev
comma
r_int
id|lcn
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
id|dev
op_assign
id|wandev-&gt;dev
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;lcn
op_eq
id|lcn
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Initiate connection on the logical channel.&n; * o for PVC we just get channel configuration&n; * o for SVCs place an X.25 call&n; *&n; * Return:&t;0&t;connected&n; *&t;&t;&gt;0&t;connection in progress&n; *&t;&t;&lt;0&t;failure&n; */
DECL|function|chan_connect
r_static
r_int
id|chan_connect
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;addr
(braket
l_int|0
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* no destination address */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: placing X.25 call to %s ...&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x25_place_call
c_func
(paren
id|card
comma
id|chan
)paren
op_ne
id|CMD_OK
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|x25_get_chan_conf
c_func
(paren
id|card
comma
id|chan
)paren
op_ne
id|CMD_OK
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Disconnect logical channel.&n; * o if SVC then clear X.25 call&n; */
DECL|function|chan_disc
r_static
r_int
id|chan_disc
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
id|x25_clear_call
c_func
(paren
id|chan-&gt;card
comma
id|chan-&gt;lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set logical channel state.&n; */
DECL|function|set_chan_state
r_static
r_void
id|set_chan_state
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|state
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_ne
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s connected!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|chan-&gt;lcn
)paren
suffix:semicolon
id|chan-&gt;i_timeout_sofar
op_assign
id|jiffies
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s connecting...&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s disconnected!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;lcn
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|chan-&gt;state
op_assign
id|state
suffix:semicolon
)brace
id|chan-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send packet on a logical channel.&n; *&t;When this function is called, tx_skb field of the channel data space&n; *&t;points to the transmit socket buffer.  When transmission is complete,&n; *&t;release socket buffer and reset &squot;tbusy&squot; flag.&n; *&n; * Return:&t;0&t;- transmission complete&n; *&t;&t;1&t;- busy&n; *&n; * Notes:&n; * 1. If packet length is greater than MTU for this channel, we&squot;ll fragment&n; *    the packet into &squot;complete sequence&squot; using M-bit.&n; * 2. When transmission is complete, an event notification should be issued&n; *    to the router.&n; */
DECL|function|chan_send
r_static
r_int
id|chan_send
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|TX25Status
op_star
id|status
op_assign
id|card-&gt;flags
suffix:semicolon
r_int
id|len
comma
id|qdm
suffix:semicolon
multiline_comment|/* Check to see if channel is ready */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status-&gt;cflags
(braket
id|chan-&gt;ch_idx
)braket
op_amp
l_int|0x40
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|chan-&gt;tx_pkt_size
)paren
(brace
id|len
op_assign
id|chan-&gt;tx_pkt_size
suffix:semicolon
id|qdm
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* set M-bit (more data) */
)brace
r_else
multiline_comment|/* final packet */
(brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|qdm
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|x25_send
c_func
(paren
id|card
comma
id|chan-&gt;lcn
comma
id|qdm
comma
id|len
comma
id|skb-&gt;data
)paren
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* success */
id|chan-&gt;i_timeout_sofar
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|qdm
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
op_increment
id|chan-&gt;ifstats.tx_packets
suffix:semicolon
id|chan-&gt;ifstats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x33
suffix:colon
multiline_comment|/* Tx busy */
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* failure */
op_increment
id|chan-&gt;ifstats.tx_errors
suffix:semicolon
multiline_comment|/*&t;&t;&t;return 1; */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Parse X.25 call request data and fill x25_call_info_t structure.&n; */
DECL|function|parse_call_info
r_static
r_void
id|parse_call_info
(paren
r_int
r_char
op_star
id|str
comma
id|x25_call_info_t
op_star
id|info
)paren
(brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|x25_call_info_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|str
suffix:semicolon
op_increment
id|str
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;-&squot;
)paren
r_switch
c_cond
(paren
id|str
(braket
l_int|1
)braket
)paren
(brace
r_case
l_char|&squot;d&squot;
suffix:colon
multiline_comment|/* destination address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
(brace
id|ch
op_assign
id|str
(braket
l_int|2
op_plus
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_digit
c_func
(paren
id|ch
)paren
)paren
r_break
suffix:semicolon
id|info-&gt;dest
(braket
id|i
)braket
op_assign
id|ch
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;s&squot;
suffix:colon
multiline_comment|/* source address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
(brace
id|ch
op_assign
id|str
(braket
l_int|2
op_plus
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_digit
c_func
(paren
id|ch
)paren
)paren
r_break
suffix:semicolon
id|info-&gt;src
(braket
id|i
)braket
op_assign
id|ch
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;u&squot;
suffix:colon
multiline_comment|/* user data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|127
suffix:semicolon
op_increment
id|i
)paren
(brace
id|ch
op_assign
id|str
(braket
l_int|2
op_plus
l_int|2
op_star
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_hex_digit
c_func
(paren
id|ch
)paren
)paren
r_break
suffix:semicolon
id|info-&gt;user
(braket
id|i
)braket
op_assign
id|hex_to_uint
c_func
(paren
op_amp
id|str
(braket
l_int|2
op_plus
l_int|2
op_star
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
)brace
id|info-&gt;nuser
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;f&squot;
suffix:colon
multiline_comment|/* facilities */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
op_increment
id|i
)paren
(brace
id|ch
op_assign
id|str
(braket
l_int|2
op_plus
l_int|4
op_star
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_hex_digit
c_func
(paren
id|ch
)paren
)paren
r_break
suffix:semicolon
id|info-&gt;facil
(braket
id|i
)braket
dot
id|code
op_assign
id|hex_to_uint
c_func
(paren
op_amp
id|str
(braket
l_int|2
op_plus
l_int|4
op_star
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
id|ch
op_assign
id|str
(braket
l_int|4
op_plus
l_int|4
op_star
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_hex_digit
c_func
(paren
id|ch
)paren
)paren
r_break
suffix:semicolon
id|info-&gt;facil
(braket
id|i
)braket
dot
id|parm
op_assign
id|hex_to_uint
c_func
(paren
op_amp
id|str
(braket
l_int|4
op_plus
l_int|4
op_star
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
)brace
id|info-&gt;nfacil
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*============================================================================&n; * Convert line speed in bps to a number used by S502 code.&n; */
DECL|function|bps_to_speed_code
r_static
r_int
r_char
id|bps_to_speed_code
(paren
r_int
r_int
id|bps
)paren
(brace
r_int
r_char
id|number
suffix:semicolon
r_if
c_cond
(paren
id|bps
op_le
l_int|1200
)paren
id|number
op_assign
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|2400
)paren
id|number
op_assign
l_int|0x02
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|4800
)paren
id|number
op_assign
l_int|0x03
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|9600
)paren
id|number
op_assign
l_int|0x04
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|19200
)paren
id|number
op_assign
l_int|0x05
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|38400
)paren
id|number
op_assign
l_int|0x06
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|45000
)paren
id|number
op_assign
l_int|0x07
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|56000
)paren
id|number
op_assign
l_int|0x08
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|64000
)paren
id|number
op_assign
l_int|0x09
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|74000
)paren
id|number
op_assign
l_int|0x0A
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|112000
)paren
id|number
op_assign
l_int|0x0B
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_le
l_int|128000
)paren
id|number
op_assign
l_int|0x0C
suffix:semicolon
r_else
id|number
op_assign
l_int|0x0D
suffix:semicolon
r_return
id|number
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Convert decimal string to unsigned integer.&n; * If len != 0 then only &squot;len&squot; characters of the string are converted.&n; */
DECL|function|dec_to_uint
r_static
r_int
r_int
id|dec_to_uint
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
l_int|0
suffix:semicolon
id|len
op_logical_and
id|is_digit
c_func
(paren
op_star
id|str
)paren
suffix:semicolon
op_increment
id|str
comma
op_decrement
id|len
)paren
id|val
op_assign
(paren
id|val
op_star
l_int|10
)paren
op_plus
(paren
op_star
id|str
op_minus
(paren
r_int
)paren
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Convert hex string to unsigned integer.&n; * If len != 0 then only &squot;len&squot; characters of the string are conferted.&n; */
DECL|function|hex_to_uint
r_static
r_int
r_int
id|hex_to_uint
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
(brace
r_int
id|val
comma
id|ch
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
l_int|0
suffix:semicolon
id|len
suffix:semicolon
op_increment
id|str
comma
op_decrement
id|len
)paren
(brace
id|ch
op_assign
op_star
id|str
suffix:semicolon
r_if
c_cond
(paren
id|is_digit
c_func
(paren
id|ch
)paren
)paren
id|val
op_assign
(paren
id|val
op_lshift
l_int|4
)paren
op_plus
(paren
id|ch
op_minus
(paren
r_int
)paren
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|is_hex_digit
c_func
(paren
id|ch
)paren
)paren
id|val
op_assign
(paren
id|val
op_lshift
l_int|4
)paren
op_plus
(paren
(paren
id|ch
op_amp
l_int|0xDF
)paren
op_minus
(paren
r_int
)paren
l_char|&squot;A&squot;
op_plus
l_int|10
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_return
id|val
suffix:semicolon
)brace
DECL|function|handle_IPXWAN
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
comma
r_int
r_int
id|proto
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
)paren
(brace
multiline_comment|/* It&squot;s an IPX packet */
r_if
c_cond
(paren
op_logical_neg
id|enable_IPX
)paren
(brace
multiline_comment|/* Return 1 so we don&squot;t pass it up the stack. */
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* It&squot;s not IPX so pass it up the stack. */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|16
)braket
op_eq
l_int|0x90
op_logical_and
id|sendpacket
(braket
l_int|17
)braket
op_eq
l_int|0x04
)paren
(brace
multiline_comment|/* It&squot;s IPXWAN */
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x02
op_logical_and
id|sendpacket
(braket
l_int|34
)braket
op_eq
l_int|0x00
)paren
(brace
multiline_comment|/* It&squot;s a timer request packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Timer Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
multiline_comment|/* Go through the routing options and answer no to every&n;&t;&t;&t; * option except Unnumbered RIP/SAP */
r_for
c_loop
(paren
id|i
op_assign
l_int|41
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x00
suffix:semicolon
id|i
op_add_assign
l_int|5
)paren
(brace
multiline_comment|/* 0x02 is the option for Unnumbered RIP/SAP */
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|4
)braket
op_ne
l_int|0x02
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Skip over the extended Node ID option */
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x04
)paren
(brace
id|i
op_add_assign
l_int|8
suffix:semicolon
)brace
multiline_comment|/* We also want to turn off all header compression opt. */
r_for
c_loop
(paren
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x80
suffix:semicolon
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_add_assign
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|3
)braket
)paren
op_plus
l_int|4
suffix:semicolon
)brace
multiline_comment|/* Set the packet type to timer response */
id|sendpacket
(braket
l_int|34
)braket
op_assign
l_int|0x01
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Timer Response&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|34
)braket
op_eq
l_int|0x02
)paren
(brace
multiline_comment|/* This is an information request packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Information Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
multiline_comment|/* Set the packet type to information response */
id|sendpacket
(braket
l_int|34
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* Set the router name */
id|sendpacket
(braket
l_int|51
)braket
op_assign
l_char|&squot;X&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|52
)braket
op_assign
l_char|&squot;T&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|53
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|54
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|55
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|56
)braket
op_assign
l_char|&squot;E&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|57
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|58
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_rshift
l_int|28
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|59
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0F000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|60
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00F00000
)paren
op_rshift
l_int|20
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|61
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000F0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|62
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0000F000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|63
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00000F00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|64
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000000F0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|65
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_amp
l_int|0x0000000F
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|66
suffix:semicolon
id|i
OL
l_int|99
suffix:semicolon
id|i
op_add_assign
l_int|1
)paren
(brace
id|sendpacket
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Information Response packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown IPXWAN packet!&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the WNodeID to our network address */
id|sendpacket
(braket
l_int|35
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|36
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|37
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|38
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If we get here its an IPX-data packet, so it&squot;ll get passed up the stack.&n;&t;&t;   switch the network numbers */
id|switch_net_numbers
c_func
(paren
id|sendpacket
comma
id|network_number
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   If incoming is 0 (outgoing)- if the net numbers is ours make it 0&n;   if incoming is 1 - if the net number is 0 make it ours &n;&n;*/
DECL|function|switch_net_numbers
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
(brace
r_int
r_int
id|pnetwork_number
suffix:semicolon
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
multiline_comment|/* If the destination network number is ours, make it 0 */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|6
)braket
op_assign
id|sendpacket
(braket
l_int|7
)braket
op_assign
id|sendpacket
(braket
l_int|8
)braket
op_assign
id|sendpacket
(braket
l_int|9
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If the incoming network is 0, make it ours */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|6
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|7
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|8
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|9
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|18
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|19
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|20
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|21
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
multiline_comment|/* If the source network is ours, make it 0 */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|18
)braket
op_assign
id|sendpacket
(braket
l_int|19
)braket
op_assign
id|sendpacket
(braket
l_int|20
)braket
op_assign
id|sendpacket
(braket
l_int|21
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If the source network is 0, make it ours */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|18
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|19
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|20
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|21
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* switch_net_numbers */
multiline_comment|/****** End *****************************************************************/
eof
