multiline_comment|/*****************************************************************************&n;* sdla_ppp.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver. PPP module.&n;*&n;* Author: &t;Nenad Corbic &lt;ncorbic@sangoma.com&gt;&n;*&n;* Copyright:&t;(c) 1995-1999 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;*&n;* Oct 25, 1999  Nenad Corbic    o Support for 2.0.X kernels&n;*                                 Moved dynamic route processing into &n;*                                 a polling routine.&n;* Oct 07, 1999  Nenad Corbic    o Support for S514 PCI card.  &n;*               Gideon Hack     o UPD and Updates executed using timer interrupt&n;* Sep 10, 1999  Nenad Corbic    o Fixed up the /proc statistics&n;* Jul 20, 1999  Nenad Corbic    o Remove the polling routines and use &n;*                                 interrupts instead.&n;* Sep 17, 1998&t;Jaspreet Singh&t;o Updates for 2.2.X Kernels.&n;* Aug 13, 1998&t;Jaspreet Singh&t;o Improved Line Tracing.&n;* Jun 22, 1998&t;David Fong&t;o Added remote IP address assignment&n;* Mar 15, 1998&t;Alan Cox&t;o 2.1.8x basic port.&n;* Apr 16, 1998&t;Jaspreet Singh&t;o using htons() for the IPX protocol.&n;* Dec 09, 1997&t;Jaspreet Singh&t;o Added PAP and CHAP.&n;*&t;&t;&t;&t;o Implemented new routines like &n;*&t;&t;&t;&t;  ppp_set_inbnd_auth(), ppp_set_outbnd_auth(),&n;*&t;&t;&t;&t;  tokenize() and strstrip().&n;* Nov 27, 1997&t;Jaspreet Singh&t;o Added protection against enabling of irqs &n;*&t;&t;&t;&t;  while they have been disabled.&n;* Nov 24, 1997  Jaspreet Singh  o Fixed another RACE condition caused by&n;*                                 disabling and enabling of irqs.&n;*                               o Added new counters for stats on disable/enable&n;*                                 IRQs.&n;* Nov 10, 1997&t;Jaspreet Singh&t;o Initialized &squot;skb-&gt;mac.raw&squot; to &squot;skb-&gt;data&squot;&n;*&t;&t;&t;&t;  before every netif_rx().&n;*&t;&t;&t;&t;o Free up the device structure in del_if().&n;* Nov 07, 1997&t;Jaspreet Singh&t;o Changed the delay to zero for Line tracing&n;*&t;&t;&t;&t;  command.&n;* Oct 20, 1997 &t;Jaspreet Singh&t;o Added hooks in for Router UP time.&n;* Oct 16, 1997&t;Jaspreet Singh  o The critical flag is used to maintain flow&n;*&t;&t;&t;&t;  control by avoiding RACE conditions.  The &n;*&t;&t;&t;&t;  cli() and restore_flags() are taken out.&n;*&t;&t;&t;&t;  A new structure, &quot;ppp_private_area&quot;, is added &n;*&t;&t;&t;&t;  to provide Driver Statistics.   &n;* Jul 21, 1997 &t;Jaspreet Singh&t;o Protected calls to sdla_peek() by adding &n;*&t;&t;&t;&t;  save_flags(), cli() and restore_flags().&n;* Jul 07, 1997&t;Jaspreet Singh  o Added configurable TTL for UDP packets&n;*&t;&t;&t;&t;o Added ability to discard mulitcast and&n;*&t;&t;&t;&t;  broacast source addressed packets.&n;* Jun 27, 1997 &t;Jaspreet Singh&t;o Added FT1 monitor capabilities&n;*&t;&t;&t;&t;  New case (0x25) statement in if_send routine.&n;*&t;&t;&t;&t;  Added a global variable rCount to keep track&n;*&t;&t;&t;&t;  of FT1 status enabled on the board.&n;* May 22, 1997&t;Jaspreet Singh&t;o Added change in the PPP_SET_CONFIG command for&n;*&t;&t;&t;&t;508 card to reflect changes in the new &n;*&t;&t;&t;&t;ppp508.sfm for supporting:continous transmission&n;*&t;&t;&t;&t;of Configure-Request packets without receiving a&n;*&t;&t;&t;&t;reply &t;&t;&t;&t;&n;*&t;&t;&t;&t;OR-ed 0x300 to conf_flags &n;*&t;&t;&t;        o Changed connect_tmout from 900 to 0&n;* May 21, 1997&t;Jaspreet Singh  o Fixed UDP Management for multiple boards&n;* Apr 25, 1997  Farhan Thawar    o added UDP Management stuff&n;* Mar 11, 1997  Farhan Thawar   Version 3.1.1&n;*                                o fixed (+1) bug in rx_intr()&n;*                                o changed if_send() to return 0 if&n;*                                  wandev.critical() is true&n;*                                o free socket buffer in if_send() if&n;*                                  returning 0 &n;* Jan 15, 1997&t;Gene Kozin&t;Version 3.1.0&n;*&t;&t;&t;&t; o implemented exec() entry point&n;* Jan 06, 1997&t;Gene Kozin&t;Initial version.&n;*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;linux/if_arp.h&gt;&t;/* ARPHRD_* defines */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;linux/in.h&gt;&t;&t;/* sockaddr_in */
macro_line|#include &lt;linux/inet.h&gt;&t;&t;/* in_aton(), in_ntoa() prototypes */
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/sdla_ppp.h&gt;&t;&t;/* PPP firmware API definitions */
macro_line|#include &lt;linux/sdlasfm.h&gt;&t;&t;/* S514 Type Definition */
multiline_comment|/****** Defines &amp; Macros ****************************************************/
macro_line|#ifdef&t;_DEBUG_
DECL|macro|STATIC
mdefine_line|#define&t;STATIC
macro_line|#else
DECL|macro|STATIC
mdefine_line|#define&t;STATIC&t;&t;static
macro_line|#endif
DECL|macro|PPP_DFLT_MTU
mdefine_line|#define&t;PPP_DFLT_MTU&t;1500&t;&t;/* default MTU */
DECL|macro|PPP_MAX_MTU
mdefine_line|#define&t;PPP_MAX_MTU&t;4000&t;&t;/* maximum MTU */
DECL|macro|PPP_HDR_LEN
mdefine_line|#define PPP_HDR_LEN&t;1
DECL|macro|CONNECT_TIMEOUT
mdefine_line|#define&t;CONNECT_TIMEOUT&t;(90*HZ)&t;&t;/* link connection timeout */
DECL|macro|HOLD_DOWN_TIME
mdefine_line|#define&t;HOLD_DOWN_TIME&t;(5*HZ)&t;&t;/* link hold down time : Changed from 30 to 5 */
multiline_comment|/* For handle_IPXWAN() */
DECL|macro|CVHexToAscii
mdefine_line|#define CVHexToAscii(b) (((unsigned char)(b) &gt; (unsigned char)9) ? ((unsigned char)&squot;A&squot; + ((unsigned char)(b) - (unsigned char)10)) : ((unsigned char)&squot;0&squot; + (unsigned char)(b)))
multiline_comment|/* Macro for enabling/disabling debugging comments */
singleline_comment|//#define NEX_DEBUG
macro_line|#ifdef NEX_DEBUG
DECL|macro|NEX_PRINTK
mdefine_line|#define NEX_PRINTK(format, a...) printk(format, ## a)
macro_line|#else
DECL|macro|NEX_PRINTK
mdefine_line|#define NEX_PRINTK(format, a...)
macro_line|#endif /* NEX_DEBUG */ 
DECL|macro|DCD
mdefine_line|#define DCD(a)   ( a &amp; 0x08 ? &quot;HIGH&quot; : &quot;LOW&quot; )
DECL|macro|CTS
mdefine_line|#define CTS(a)   ( a &amp; 0x20 ? &quot;HIGH&quot; : &quot;LOW&quot; )
DECL|macro|LCP
mdefine_line|#define LCP(a)   ( a == 0x09 ? &quot;OPEN&quot; : &quot;CLOSED&quot; )
DECL|macro|IP
mdefine_line|#define IP(a)    ( a == 0x09 ? &quot;ENABLED&quot; : &quot;DISABLED&quot; )
DECL|macro|TMR_INT_ENABLED_UPDATE
mdefine_line|#define TMR_INT_ENABLED_UPDATE  &t;1
DECL|macro|TMR_INT_ENABLED_PPP_EVENT
mdefine_line|#define TMR_INT_ENABLED_PPP_EVENT&t;2
DECL|macro|TMR_INT_ENABLED_UDP
mdefine_line|#define TMR_INT_ENABLED_UDP&t;&t;4
multiline_comment|/* Set Configuraton Command Definitions */
DECL|macro|PERCENT_TX_BUFF
mdefine_line|#define PERCENT_TX_BUFF&t;&t;&t;60
DECL|macro|TIME_BETWEEN_CONF_REQ
mdefine_line|#define TIME_BETWEEN_CONF_REQ  &t;&t;30
DECL|macro|TIME_BETWEEN_PAP_CHAP_REQ
mdefine_line|#define TIME_BETWEEN_PAP_CHAP_REQ&t;30
DECL|macro|WAIT_PAP_CHAP_WITHOUT_REPLY
mdefine_line|#define WAIT_PAP_CHAP_WITHOUT_REPLY     300
DECL|macro|WAIT_AFTER_DCD_CTS_LOW
mdefine_line|#define WAIT_AFTER_DCD_CTS_LOW          5
DECL|macro|TIME_DCD_CTS_LOW_AFTER_LNK_DOWN
mdefine_line|#define TIME_DCD_CTS_LOW_AFTER_LNK_DOWN 10
DECL|macro|WAIT_DCD_HIGH_AFTER_ENABLE_COMM
mdefine_line|#define WAIT_DCD_HIGH_AFTER_ENABLE_COMM 900
DECL|macro|MAX_CONF_REQ_WITHOUT_REPLY
mdefine_line|#define MAX_CONF_REQ_WITHOUT_REPLY      10
DECL|macro|MAX_TERM_REQ_WITHOUT_REPLY
mdefine_line|#define MAX_TERM_REQ_WITHOUT_REPLY      2
DECL|macro|NUM_CONF_NAK_WITHOUT_REPLY
mdefine_line|#define NUM_CONF_NAK_WITHOUT_REPLY      5
DECL|macro|NUM_AUTH_REQ_WITHOUT_REPLY
mdefine_line|#define NUM_AUTH_REQ_WITHOUT_REPLY      10
DECL|macro|END_OFFSET
mdefine_line|#define END_OFFSET 0x1F0
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT (5*HZ)
multiline_comment|/******Data Structures*****************************************************/
multiline_comment|/* This structure is placed in the private data area of the device structure.&n; * The card structure used to occupy the private area but now the following &n; * structure will incorporate the card structure along with PPP specific data&n; */
DECL|struct|ppp_private_area
r_typedef
r_struct
id|ppp_private_area
(brace
multiline_comment|/* This member must be first. */
DECL|member|slave
r_struct
id|net_device
op_star
id|slave
suffix:semicolon
multiline_comment|/* WAN slave */
DECL|member|card
id|sdla_t
op_star
id|card
suffix:semicolon
DECL|member|router_start_time
r_int
r_int
id|router_start_time
suffix:semicolon
multiline_comment|/*router start time in sec */
DECL|member|tick_counter
r_int
r_int
id|tick_counter
suffix:semicolon
multiline_comment|/*used for 5 second counter*/
DECL|member|mc
r_int
id|mc
suffix:semicolon
multiline_comment|/*multicast support on or off*/
DECL|member|enable_IPX
r_int
r_char
id|enable_IPX
suffix:semicolon
DECL|member|network_number
r_int
r_int
id|network_number
suffix:semicolon
DECL|member|pap
r_int
r_char
id|pap
suffix:semicolon
DECL|member|chap
r_int
r_char
id|chap
suffix:semicolon
DECL|member|sysname
r_int
r_char
id|sysname
(braket
l_int|31
)braket
suffix:semicolon
multiline_comment|/* system name for in-bnd auth*/
DECL|member|userid
r_int
r_char
id|userid
(braket
l_int|511
)braket
suffix:semicolon
multiline_comment|/* list of user ids */
DECL|member|passwd
r_int
r_char
id|passwd
(braket
l_int|511
)braket
suffix:semicolon
multiline_comment|/* list of passwords */
DECL|member|protocol
r_int
id|protocol
suffix:semicolon
multiline_comment|/* SKB Protocol */
DECL|member|ip_local
id|u32
id|ip_local
suffix:semicolon
multiline_comment|/* Local IP Address */
DECL|member|ip_remote
id|u32
id|ip_remote
suffix:semicolon
multiline_comment|/* remote IP Address */
DECL|member|timer_int_enabled
r_int
r_char
id|timer_int_enabled
suffix:semicolon
multiline_comment|/* Who enabled the timer inter*/
DECL|member|update_comms_stats
r_int
r_char
id|update_comms_stats
suffix:semicolon
multiline_comment|/* Used by update function */
DECL|member|curr_trace_addr
r_int
r_int
id|curr_trace_addr
suffix:semicolon
multiline_comment|/* Trace information */
DECL|member|start_trace_addr
r_int
r_int
id|start_trace_addr
suffix:semicolon
DECL|member|end_trace_addr
r_int
r_int
id|end_trace_addr
suffix:semicolon
DECL|member|udp_pkt_lgth
r_int
r_int
id|udp_pkt_lgth
suffix:semicolon
DECL|member|udp_pkt_src
r_char
id|udp_pkt_src
suffix:semicolon
DECL|member|udp_pkt_data
r_char
id|udp_pkt_data
(braket
id|MAX_LGTH_UDP_MGNT_PKT
)braket
suffix:semicolon
multiline_comment|/* PPP specific statistics */
DECL|member|if_send_stat
id|if_send_stat_t
id|if_send_stat
suffix:semicolon
DECL|member|rx_intr_stat
id|rx_intr_stat_t
id|rx_intr_stat
suffix:semicolon
DECL|member|pipe_mgmt_stat
id|pipe_mgmt_stat_t
id|pipe_mgmt_stat
suffix:semicolon
DECL|member|router_up_time
r_int
r_int
id|router_up_time
suffix:semicolon
DECL|typedef|ppp_private_area_t
)brace
id|ppp_private_area_t
suffix:semicolon
multiline_comment|/* variable for keeping track of enabling/disabling FT1 monitor status */
DECL|variable|rCount
r_static
r_int
id|rCount
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
id|disable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|enable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|new_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|del_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* WANPIPE-specific entry points */
r_static
r_int
id|wpp_exec
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|if_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|if_rebuild_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* PPP firmware interface functions */
r_static
r_int
id|ppp_read_version
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|ppp_set_outbnd_auth
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
suffix:semicolon
r_static
r_int
id|ppp_set_inbnd_auth
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
suffix:semicolon
r_static
r_int
id|ppp_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|ppp_set_intr_mode
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_char
id|mode
)paren
suffix:semicolon
r_static
r_int
id|ppp_comm_enable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ppp_comm_disable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ppp_get_err_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ppp_send
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_int
id|proto
)paren
suffix:semicolon
r_static
r_int
id|ppp_error
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
id|ppp_mbox_t
op_star
id|mb
)paren
suffix:semicolon
id|STATIC
r_void
id|wpp_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|event_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|timer_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Background polling routines */
r_static
r_void
id|process_route
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|poll_disconnected
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
r_static
r_int
id|read_info
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|read_connection_info
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|remove_route
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|config508
c_func
(paren
id|ppp_private_area_t
op_star
id|ppp_priv_area
comma
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|show_disc_cause
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cause
)paren
suffix:semicolon
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
suffix:semicolon
r_static
r_void
id|process_udp_mgmt_pkt
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_struct
id|net_device
op_star
id|dev
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
suffix:semicolon
r_static
r_void
id|init_ppp_tx_rx_buff
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|init_ppp_priv_struct
c_func
(paren
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
suffix:semicolon
r_static
r_void
id|init_global_statistics
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|tokenize
c_func
(paren
r_char
op_star
id|str
comma
r_char
op_star
op_star
id|tokens
)paren
suffix:semicolon
r_static
r_char
op_star
id|strstrip
c_func
(paren
r_char
op_star
id|str
comma
r_char
op_star
id|s
)paren
suffix:semicolon
r_static
r_int
id|chk_bcast_mcast_addr
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
DECL|variable|Read_connection_info
r_static
r_int
id|Read_connection_info
suffix:semicolon
DECL|variable|Intr_test_counter
r_static
r_int
id|Intr_test_counter
suffix:semicolon
DECL|variable|available_buffer_space
r_static
r_int
r_int
id|available_buffer_space
suffix:semicolon
multiline_comment|/* IPX functions */
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
suffix:semicolon
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_PX
comma
r_int
r_int
id|network_number
comma
r_int
r_int
id|proto
)paren
suffix:semicolon
multiline_comment|/* Lock Functions */
r_static
r_void
id|s508_lock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
suffix:semicolon
r_static
r_void
id|s508_unlock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
suffix:semicolon
r_static
r_int
id|store_udp_mgmt_pkt
c_func
(paren
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
suffix:semicolon
r_static
r_int
r_int
id|calc_checksum
(paren
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
multiline_comment|/****** Public Functions ****************************************************/
multiline_comment|/*============================================================================&n; * PPP protocol initialization routine.&n; *&n; * This routine is called by the main WANPIPE module during setup.  At this&n; * point adapter is completely initialized and firmware is running.&n; *  o read firmware version (to make sure it&squot;s alive)&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.&n; */
DECL|function|wpp_init
r_int
id|wpp_init
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
r_union
(brace
r_char
id|str
(braket
l_int|80
)braket
suffix:semicolon
)brace
id|u
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_PPP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize miscellaneous pointers to structures on the adapter */
r_switch
c_cond
(paren
id|card-&gt;hw.type
)paren
(brace
r_case
id|SDLA_S508
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP508_MB_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP508_FLG_OFFS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDLA_S514
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP514_MB_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP514_FLG_OFFS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Read firmware version.  Note that when adapter initializes, it&n;&t; * clears the mailbox, so it may appear that the first command was&n;&t; * executed successfully when in fact it was merely erased. To work&n;&t; * around this, we execute the first command twice.&n;&t; */
r_if
c_cond
(paren
id|ppp_read_version
c_func
(paren
id|card
comma
l_int|NULL
)paren
op_logical_or
id|ppp_read_version
c_func
(paren
id|card
comma
id|u.str
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: running PPP firmware v%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|u.str
)paren
suffix:semicolon
multiline_comment|/* Adjust configuration and set defaults */
id|card-&gt;wandev.mtu
op_assign
(paren
id|conf-&gt;mtu
)paren
ques
c_cond
id|min
c_func
(paren
id|conf-&gt;mtu
comma
id|PPP_MAX_MTU
)paren
suffix:colon
id|PPP_DFLT_MTU
suffix:semicolon
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|card-&gt;wandev.station
op_assign
id|conf-&gt;station
suffix:semicolon
id|card-&gt;isr
op_assign
op_amp
id|wpp_isr
suffix:semicolon
id|card-&gt;poll
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;exec
op_assign
op_amp
id|wpp_exec
suffix:semicolon
id|card-&gt;wandev.update
op_assign
op_amp
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
op_amp
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
op_amp
id|del_if
suffix:semicolon
id|card-&gt;wandev.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
id|card-&gt;wandev.udp_port
op_assign
id|conf-&gt;udp_port
suffix:semicolon
id|card-&gt;wandev.ttl
op_assign
id|conf-&gt;ttl
suffix:semicolon
id|card-&gt;irq_dis_if_send_count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;irq_dis_poll_count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.p.authenticator
op_assign
id|conf-&gt;u.ppp.authenticator
suffix:semicolon
id|card-&gt;u.p.ip_mode
op_assign
id|conf-&gt;u.ppp.ip_mode
ques
c_cond
id|conf-&gt;u.ppp.ip_mode
suffix:colon
id|WANOPT_PPP_STATIC
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
id|Read_connection_info
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* initialize global statistics */
id|init_global_statistics
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Update device status &amp; statistics.&n; */
DECL|function|update
r_static
r_int
id|update
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_volatile
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|//FIXME: Do we need this
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|ppp_priv_area-&gt;update_comms_stats
op_assign
l_int|2
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|PPP_INTR_TIMER
suffix:semicolon
multiline_comment|/* wait a maximum of 1 second for the statistics to be updated */
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|ppp_priv_area-&gt;update_comms_stats
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
(paren
l_int|1
op_star
id|HZ
)paren
)paren
(brace
id|ppp_priv_area-&gt;update_comms_stats
op_assign
l_int|0
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registaration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created)&n; */
DECL|function|new_if
r_static
r_int
id|new_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;ndev
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize private data */
id|ppp_priv_area
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ppp_private_area_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_priv_area
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ppp_priv_area
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_private_area_t
)paren
)paren
suffix:semicolon
id|ppp_priv_area-&gt;card
op_assign
id|card
suffix:semicolon
multiline_comment|/* initialize data */
id|strcpy
c_func
(paren
id|card-&gt;u.p.if_name
comma
id|conf-&gt;name
)paren
suffix:semicolon
multiline_comment|/* initialize data in ppp_private_area structure */
id|init_ppp_priv_struct
c_func
(paren
id|ppp_priv_area
)paren
suffix:semicolon
id|ppp_priv_area-&gt;mc
op_assign
id|conf-&gt;mc
suffix:semicolon
id|ppp_priv_area-&gt;pap
op_assign
id|conf-&gt;pap
suffix:semicolon
id|ppp_priv_area-&gt;chap
op_assign
id|conf-&gt;chap
suffix:semicolon
multiline_comment|/* If no user ids are specified */
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|conf-&gt;userid
)paren
op_logical_and
(paren
id|ppp_priv_area-&gt;pap
op_logical_or
id|ppp_priv_area-&gt;chap
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ppp_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* If no passwords are specified */
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|conf-&gt;passwd
)paren
op_logical_and
(paren
id|ppp_priv_area-&gt;pap
op_logical_or
id|ppp_priv_area-&gt;chap
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ppp_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|conf-&gt;sysname
)paren
OG
l_int|31
)paren
(brace
id|kfree
c_func
(paren
id|ppp_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* If no system name is specified */
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|conf-&gt;sysname
)paren
op_logical_and
(paren
id|card-&gt;u.p.authenticator
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ppp_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* copy the data into the ppp private structure */
id|memcpy
c_func
(paren
id|ppp_priv_area-&gt;userid
comma
id|conf-&gt;userid
comma
id|strlen
c_func
(paren
id|conf-&gt;userid
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ppp_priv_area-&gt;passwd
comma
id|conf-&gt;passwd
comma
id|strlen
c_func
(paren
id|conf-&gt;passwd
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ppp_priv_area-&gt;sysname
comma
id|conf-&gt;sysname
comma
id|strlen
c_func
(paren
id|conf-&gt;sysname
)paren
)paren
suffix:semicolon
id|ppp_priv_area-&gt;enable_IPX
op_assign
id|conf-&gt;enable_IPX
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;network_number
)paren
id|ppp_priv_area-&gt;network_number
op_assign
id|conf-&gt;network_number
suffix:semicolon
r_else
id|ppp_priv_area-&gt;network_number
op_assign
l_int|0xDEADBEEF
suffix:semicolon
multiline_comment|/* prepare network device data space for registration */
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|card-&gt;u.p.if_name
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
op_amp
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|ppp_priv_area
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Delete logical channel.&n; */
DECL|function|del_if
r_static
r_int
id|del_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** WANPIPE-specific entry points ***************************************/
multiline_comment|/*============================================================================&n; * Execute adapter interface command.&n; */
singleline_comment|//FIXME: Why do we need this ????
DECL|function|wpp_exec
r_static
r_int
id|wpp_exec
c_func
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
(brace
id|ppp_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
id|u_cmd
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|u_data
comma
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
multiline_comment|/* execute command */
r_if
c_cond
(paren
op_logical_neg
id|sdla_exec
c_func
(paren
id|mbox
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* return result */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|u_cmd
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|u_data
op_logical_and
id|copy_to_user
c_func
(paren
id|u_data
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Network Device Interface ********************************************/
multiline_comment|/*============================================================================&n; * Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration.&n; */
DECL|function|if_init
r_static
r_int
id|if_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
macro_line|#ifndef LINUX_2_1
r_int
id|i
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
op_amp
id|if_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
op_amp
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|if_stats
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|if_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Initialize media-specific parameters */
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
multiline_comment|/* ARP h/w type */
id|dev-&gt;flags
op_or_assign
id|IFF_POINTOPOINT
suffix:semicolon
multiline_comment|/* Enable Mulitcasting if specified by user*/
r_if
c_cond
(paren
id|ppp_priv_area-&gt;mc
op_eq
id|WANOPT_YES
)paren
(brace
id|dev-&gt;flags
op_or_assign
id|IFF_MULTICAST
suffix:semicolon
)brace
macro_line|#ifndef LINUX_2_1
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
macro_line|#endif&t;
id|dev-&gt;mtu
op_assign
id|wandev-&gt;mtu
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|PPP_HDR_LEN
suffix:semicolon
multiline_comment|/* media header length */
multiline_comment|/* Initialize hardware parameters (just for reference) */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|wandev-&gt;maddr
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length */
id|dev-&gt;tx_queue_len
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* Initialize socket buffers */
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open network interface.&n; * o enable communications and interrupts.&n; * o prevent module from unloading by incrementing use count&n; *&n; * Return 0 if O.k. or errno.&n; */
DECL|function|if_open
r_static
r_int
id|if_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* only one open is allowed */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;configured
)paren
(brace
r_if
c_cond
(paren
id|config508
c_func
(paren
id|ppp_priv_area
comma
id|card
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|Intr_test_counter
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|intr_test
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_or
(paren
id|Intr_test_counter
OL
id|MAX_INTR_TEST_COUNTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Interrupt Test Failed, Counter: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Please choose another interrupt&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt Test Passed, Counter: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
id|card-&gt;configured
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Initialize Rx/Tx buffer control fields */
id|init_ppp_tx_rx_buff
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_set_intr_mode
c_func
(paren
id|card
comma
id|PPP_INTR_RXRDY
op_or
id|PPP_INTR_TXRDY
op_or
id|PPP_INTR_MODEM
op_or
id|PPP_INTR_CMD
op_or
id|PPP_INTR_DISC
op_or
id|PPP_INTR_OPEN
op_or
id|PPP_INTR_DROP_DTR
op_or
id|PPP_INTR_TIMER
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Turn off the transmit and timer interrupt */
id|flags-&gt;imask
op_and_assign
op_complement
(paren
id|PPP_INTR_TXRDY
op_or
id|PPP_INTR_TIMER
)paren
suffix:semicolon
multiline_comment|/* If you are not the authenticator and any one of the protocol is &n;&t; * enabled then we call the set_out_bound_authentication.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.p.authenticator
op_logical_and
(paren
id|ppp_priv_area-&gt;pap
op_logical_or
id|ppp_priv_area-&gt;chap
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppp_set_outbnd_auth
c_func
(paren
id|card
comma
id|ppp_priv_area
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
multiline_comment|/* If you are the authenticator and any one of the protocol is enabled&n;&t; * then we call the set_in_bound_authentication.&n;&t; */
r_if
c_cond
(paren
id|card-&gt;u.p.authenticator
op_logical_and
(paren
id|ppp_priv_area-&gt;pap
op_logical_or
id|ppp_priv_area-&gt;chap
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppp_set_inbnd_auth
c_func
(paren
id|card
comma
id|ppp_priv_area
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ppp_comm_enable
c_func
(paren
id|card
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|min
c_func
(paren
id|dev-&gt;mtu
comma
id|card-&gt;wandev.mtu
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|ppp_priv_area-&gt;router_start_time
op_assign
id|tv.tv_sec
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close network interface.&n; * o if this is the last open, then disable communications and interrupts.&n; * o reset flags.&n; */
DECL|function|if_close
r_static
r_int
id|if_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|ppp_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|ppp_comm_disable
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Build media header.&n; *&n; * The trick here is to put packet type (Ethertype) into &squot;protocol&squot; field of&n; * the socket buffer, so that we don&squot;t forget it.  If packet type is not&n; * supported, set skb-&gt;protocol to 0 and discard packet later.&n; *&n; * Return:&t;media header length.&n; */
DECL|function|if_header
r_static
r_int
id|if_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
r_case
id|ETH_P_IPX
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|skb-&gt;protocol
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|PPP_HDR_LEN
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Re-build media header.&n; *&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved&n; */
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rebuild_header() called for interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle transmit timeout from netif watchdog&n; */
DECL|function|if_tx_timeout
r_static
r_void
id|if_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
multiline_comment|/* If our device stays busy for at least 5 seconds then we will&n;&t; * kick start the device by making dev-&gt;tbusy = 0.  We expect &n;&t; * that our device never stays busy more than 5 seconds. So this&n;&t; * is only used as a last resort. &n;&t; */
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_tbusy
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.collisions
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit times out&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_tbusy_timeout
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.collisions
suffix:semicolon
multiline_comment|/* unbusy the card (because only one interface per card) */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a packet on a network interface.&n; * o set tbusy flag (marks start of the transmission) to block a timer-based&n; *   transmit from overlapping.&n; * o check link state. If link is not up, then drop the packet.&n; * o execute adapter send command.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * 2. Setting tbusy flag will inhibit further transmit requests from the&n; *    protocol stack and can be used for flow control with protocol layer.&n; */
DECL|function|if_send
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
r_int
r_char
op_star
id|sendpacket
suffix:semicolon
r_int
r_int
id|smp_flags
suffix:semicolon
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
r_int
id|udp_type
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_entry
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* If we get here, some higher layer thinks we&squot;ve missed an&n;&t;&t; * tx-done interrupt.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s got kicked!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_skb_null
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sendpacket
op_assign
id|skb-&gt;data
suffix:semicolon
id|udp_type
op_assign
id|udp_pkt_type
c_func
(paren
id|skb
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_eq
id|UDP_PTPIPE_TYPE
)paren
(brace
r_if
c_cond
(paren
id|store_udp_mgmt_pkt
c_func
(paren
id|UDP_PKT_FRM_STACK
comma
id|card
comma
id|skb
comma
id|dev
comma
id|ppp_priv_area
)paren
)paren
(brace
id|flags-&gt;imask
op_or_assign
id|PPP_INTR_TIMER
suffix:semicolon
)brace
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_PIPE_request
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check for broadcast and multicast addresses &n;&t; * If found, drop (deallocate) a packet and return.&n;&t; */
r_if
c_cond
(paren
id|chk_bcast_mcast_addr
c_func
(paren
id|card
comma
id|dev
comma
id|skb
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_lock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical in if_send: %x&bslash;n&quot;
comma
id|card-&gt;wandev.name
comma
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_critical_non_ISR
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
(brace
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_wan_disconnected
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
)paren
(brace
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_protocol_error
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_errors
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*If it&squot;s IPX change the network numbers to 0 if they&squot;re ours.*/
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppp_priv_area-&gt;enable_IPX
)paren
(brace
id|switch_net_numbers
c_func
(paren
id|skb-&gt;data
comma
id|ppp_priv_area-&gt;network_number
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_goto
id|tx_done
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ppp_send
c_func
(paren
id|card
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|skb-&gt;protocol
)paren
)paren
(brace
id|retry
op_assign
l_int|1
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_adptr_bfrs_full
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_tx_int_enabled
suffix:semicolon
id|ppp_priv_area-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
id|flags-&gt;imask
op_or_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* unmask Tx interrupts */
)brace
r_else
(brace
op_increment
id|ppp_priv_area-&gt;if_send_stat.if_send_bfr_passed_to_adptr
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
id|card-&gt;wandev.stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
)brace
id|tx_done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|retry
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
id|retry
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Store a UDP management packet for later processing.&n; */
DECL|function|store_udp_mgmt_pkt
r_static
r_int
id|store_udp_mgmt_pkt
c_func
(paren
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
(brace
r_int
id|udp_pkt_stored
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppp_priv_area-&gt;udp_pkt_lgth
op_logical_and
(paren
id|skb-&gt;len
op_le
id|MAX_LGTH_UDP_MGNT_PKT
)paren
)paren
(brace
id|ppp_priv_area-&gt;udp_pkt_lgth
op_assign
id|skb-&gt;len
suffix:semicolon
id|ppp_priv_area-&gt;udp_pkt_src
op_assign
id|udp_pkt_src
suffix:semicolon
id|memcpy
c_func
(paren
id|ppp_priv_area-&gt;udp_pkt_data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_UDP
suffix:semicolon
id|ppp_priv_area-&gt;protocol
op_assign
id|skb-&gt;protocol
suffix:semicolon
id|udp_pkt_stored
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|MAX_LGTH_UDP_MGNT_PKT
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PIPEMON UDP request too long : %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PIPEMON UPD request already pending&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|ppp_priv_area-&gt;udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|udp_pkt_stored
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Reply to UDP Management system.&n; * Return length of reply.&n; */
DECL|function|reply_udp
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
(brace
r_int
r_int
id|len
comma
id|udp_length
comma
id|temp
comma
id|ip_length
suffix:semicolon
r_int
r_int
id|ip_temp
suffix:semicolon
r_int
id|even_bound
op_assign
l_int|0
suffix:semicolon
id|ppp_udp_pkt_t
op_star
id|p_udp_pkt
op_assign
(paren
id|ppp_udp_pkt_t
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Set length of packet */
id|len
op_assign
r_sizeof
(paren
id|ip_pkt_t
)paren
op_plus
r_sizeof
(paren
id|udp_pkt_t
)paren
op_plus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_plus
r_sizeof
(paren
id|cblock_t
)paren
op_plus
id|mbox_len
suffix:semicolon
multiline_comment|/* fill in UDP reply */
id|p_udp_pkt-&gt;wp_mgmt.request_reply
op_assign
id|UDPMGMT_REPLY
suffix:semicolon
multiline_comment|/* fill in UDP length */
id|udp_length
op_assign
r_sizeof
(paren
id|udp_pkt_t
)paren
op_plus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_plus
r_sizeof
(paren
id|cblock_t
)paren
op_plus
id|mbox_len
suffix:semicolon
multiline_comment|/* put it on an even boundary */
r_if
c_cond
(paren
id|udp_length
op_amp
l_int|0x0001
)paren
(brace
id|udp_length
op_add_assign
l_int|1
suffix:semicolon
id|len
op_add_assign
l_int|1
suffix:semicolon
id|even_bound
op_assign
l_int|1
suffix:semicolon
)brace
id|temp
op_assign
(paren
id|udp_length
op_lshift
l_int|8
)paren
op_or
(paren
id|udp_length
op_rshift
l_int|8
)paren
suffix:semicolon
id|p_udp_pkt-&gt;udp_pkt.udp_length
op_assign
id|temp
suffix:semicolon
multiline_comment|/* swap UDP ports */
id|temp
op_assign
id|p_udp_pkt-&gt;udp_pkt.udp_src_port
suffix:semicolon
id|p_udp_pkt-&gt;udp_pkt.udp_src_port
op_assign
id|p_udp_pkt-&gt;udp_pkt.udp_dst_port
suffix:semicolon
id|p_udp_pkt-&gt;udp_pkt.udp_dst_port
op_assign
id|temp
suffix:semicolon
multiline_comment|/* add UDP pseudo header */
id|temp
op_assign
l_int|0x1100
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|p_udp_pkt-&gt;data
op_plus
id|mbox_len
op_plus
id|even_bound
)paren
)paren
op_assign
id|temp
suffix:semicolon
id|temp
op_assign
(paren
id|udp_length
op_lshift
l_int|8
)paren
op_or
(paren
id|udp_length
op_rshift
l_int|8
)paren
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|p_udp_pkt-&gt;data
op_plus
id|mbox_len
op_plus
id|even_bound
op_plus
l_int|2
)paren
)paren
op_assign
id|temp
suffix:semicolon
multiline_comment|/* calculate UDP checksum */
id|p_udp_pkt-&gt;udp_pkt.udp_checksum
op_assign
l_int|0
suffix:semicolon
id|p_udp_pkt-&gt;udp_pkt.udp_checksum
op_assign
id|calc_checksum
c_func
(paren
op_amp
id|data
(braket
id|UDP_OFFSET
)braket
comma
id|udp_length
op_plus
id|UDP_OFFSET
)paren
suffix:semicolon
multiline_comment|/* fill in IP length */
id|ip_length
op_assign
id|udp_length
op_plus
r_sizeof
(paren
id|ip_pkt_t
)paren
suffix:semicolon
id|temp
op_assign
(paren
id|ip_length
op_lshift
l_int|8
)paren
op_or
(paren
id|ip_length
op_rshift
l_int|8
)paren
suffix:semicolon
id|p_udp_pkt-&gt;ip_pkt.total_length
op_assign
id|temp
suffix:semicolon
multiline_comment|/* swap IP addresses */
id|ip_temp
op_assign
id|p_udp_pkt-&gt;ip_pkt.ip_src_address
suffix:semicolon
id|p_udp_pkt-&gt;ip_pkt.ip_src_address
op_assign
id|p_udp_pkt-&gt;ip_pkt.ip_dst_address
suffix:semicolon
id|p_udp_pkt-&gt;ip_pkt.ip_dst_address
op_assign
id|ip_temp
suffix:semicolon
multiline_comment|/* fill in IP checksum */
id|p_udp_pkt-&gt;ip_pkt.hdr_checksum
op_assign
l_int|0
suffix:semicolon
id|p_udp_pkt-&gt;ip_pkt.hdr_checksum
op_assign
id|calc_checksum
c_func
(paren
id|data
comma
r_sizeof
(paren
id|ip_pkt_t
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* reply_udp */
DECL|function|calc_checksum
r_int
r_int
id|calc_checksum
(paren
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|temp
suffix:semicolon
r_int
r_int
id|sum
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|temp
comma
op_amp
id|data
(braket
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
r_int
r_int
)paren
id|temp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sum
op_rshift
l_int|16
)paren
(brace
id|sum
op_assign
(paren
id|sum
op_amp
l_int|0xffffUL
)paren
op_plus
(paren
id|sum
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
id|temp
op_assign
(paren
r_int
r_int
)paren
id|sum
suffix:semicolon
id|temp
op_assign
op_complement
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_eq
l_int|0
)paren
(brace
id|temp
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_return
id|temp
suffix:semicolon
)brace
multiline_comment|/*&n;   If incoming is 0 (outgoing)- if the net numbers is ours make it 0&n;   if incoming is 1 - if the net number is 0 make it ours &n;&n;*/
DECL|function|switch_net_numbers
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
(brace
r_int
r_int
id|pnetwork_number
suffix:semicolon
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
singleline_comment|//If the destination network number is ours, make it 0
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|6
)braket
op_assign
id|sendpacket
(braket
l_int|7
)braket
op_assign
id|sendpacket
(braket
l_int|8
)braket
op_assign
id|sendpacket
(braket
l_int|9
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|//If the incoming network is 0, make it ours
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|6
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|7
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|8
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|9
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|18
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|19
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|20
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|21
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
singleline_comment|//If the source network is ours, make it 0
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|18
)braket
op_assign
id|sendpacket
(braket
l_int|19
)braket
op_assign
id|sendpacket
(braket
l_int|20
)braket
op_assign
id|sendpacket
(braket
l_int|21
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|//If the source network is 0, make it ours
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|18
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|19
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|20
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|21
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* switch_net_numbers */
multiline_comment|/*============================================================================&n; * Get ethernet-style interface statistics.&n; * Return a pointer to struct net_device_stats.&n; */
DECL|function|if_stats
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
id|ppp_priv_area
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|card
op_assign
id|ppp_priv_area-&gt;card
suffix:semicolon
r_return
op_amp
id|card-&gt;wandev.stats
suffix:semicolon
)brace
multiline_comment|/****** PPP Firmware Interface Functions ************************************/
multiline_comment|/*============================================================================&n; * Read firmware code version.&n; *&t;Put code version as ASCII string in str. &n; */
DECL|function|ppp_read_version
r_static
r_int
id|ppp_read_version
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_READ_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|str
)paren
(brace
r_int
id|len
op_assign
id|mb-&gt;cmd.length
suffix:semicolon
id|memcpy
c_func
(paren
id|str
comma
id|mb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*===========================================================================&n; * Set Out-Bound Authentication.&n;*/
DECL|function|ppp_set_outbnd_auth
r_static
r_int
id|ppp_set_outbnd_auth
(paren
id|sdla_t
op_star
id|card
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;data
comma
l_int|0
comma
(paren
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;userid
)paren
op_plus
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;passwd
)paren
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mb-&gt;data
comma
id|ppp_priv_area-&gt;userid
comma
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;userid
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|mb-&gt;data
op_plus
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;userid
)paren
op_plus
l_int|1
)paren
comma
id|ppp_priv_area-&gt;passwd
comma
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;passwd
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;userid
)paren
op_plus
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;passwd
)paren
op_plus
l_int|2
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_SET_OUTBOUND_AUTH
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*===========================================================================&n; * Set In-Bound Authentication.&n;*/
DECL|function|ppp_set_inbnd_auth
r_static
r_int
id|ppp_set_inbnd_auth
(paren
id|sdla_t
op_star
id|card
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
r_char
op_star
id|user_tokens
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|pass_tokens
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|userids
comma
id|passwds
suffix:semicolon
r_int
id|add_ptr
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;data
comma
l_int|0
comma
l_int|1008
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mb-&gt;data
comma
id|ppp_priv_area-&gt;sysname
comma
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;sysname
)paren
)paren
suffix:semicolon
multiline_comment|/* Parse the userid string and the password string and build a string&n;&t;   to copy it to the data area of the command structure.   The string&n;&t;   will look like &quot;SYS_NAME&lt;NULL&gt;USER1&lt;NULL&gt;PASS1&lt;NULL&gt;USER2&lt;NULL&gt;PASS2&n;&t;   ....&lt;NULL&gt; &quot; &n;&t; */
id|userids
op_assign
id|tokenize
c_func
(paren
id|ppp_priv_area-&gt;userid
comma
id|user_tokens
)paren
suffix:semicolon
id|passwds
op_assign
id|tokenize
c_func
(paren
id|ppp_priv_area-&gt;passwd
comma
id|pass_tokens
)paren
suffix:semicolon
r_if
c_cond
(paren
id|userids
op_ne
id|passwds
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Number of passwords does not equal the number of user ids&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|add_ptr
op_assign
id|strlen
c_func
(paren
id|ppp_priv_area-&gt;sysname
)paren
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|userids
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
(paren
id|mb-&gt;data
op_plus
id|add_ptr
)paren
comma
id|user_tokens
(braket
id|i
)braket
comma
id|strlen
c_func
(paren
id|user_tokens
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|mb-&gt;data
op_plus
id|add_ptr
op_plus
id|strlen
c_func
(paren
id|user_tokens
(braket
id|i
)braket
)paren
op_plus
l_int|1
)paren
comma
id|pass_tokens
(braket
id|i
)braket
comma
id|strlen
c_func
(paren
id|pass_tokens
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|add_ptr
op_assign
id|add_ptr
op_plus
id|strlen
c_func
(paren
id|user_tokens
(braket
id|i
)braket
)paren
op_plus
l_int|1
op_plus
id|strlen
c_func
(paren
id|pass_tokens
(braket
id|i
)braket
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|mb-&gt;cmd.length
op_assign
id|add_ptr
op_plus
l_int|1
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_SET_INBOUND_AUTH
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Tokenize string.&n; *      Parse a string of the following syntax:&n; *              &lt;arg1&gt;,&lt;arg2&gt;,...&n; *      and fill array of tokens with pointers to string elements.&n; *&n; */
DECL|function|tokenize
r_static
r_int
id|tokenize
(paren
r_char
op_star
id|str
comma
r_char
op_star
op_star
id|tokens
)paren
(brace
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|tokens
(braket
l_int|0
)braket
op_assign
id|strtok
c_func
(paren
id|str
comma
l_string|&quot;/&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tokens
(braket
id|cnt
)braket
op_logical_and
(paren
id|cnt
OL
l_int|32
op_minus
l_int|1
)paren
)paren
(brace
id|tokens
(braket
id|cnt
)braket
op_assign
id|strstrip
c_func
(paren
id|tokens
(braket
id|cnt
)braket
comma
l_string|&quot; &bslash;t&quot;
)paren
suffix:semicolon
id|tokens
(braket
op_increment
id|cnt
)braket
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;/&quot;
)paren
suffix:semicolon
)brace
r_return
id|cnt
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Strip leading and trailing spaces off the string str.&n; */
DECL|function|strstrip
r_static
r_char
op_star
id|strstrip
(paren
r_char
op_star
id|str
comma
r_char
op_star
id|s
)paren
(brace
r_char
op_star
id|eos
op_assign
id|str
op_plus
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
multiline_comment|/* -&gt; end of string */
r_while
c_loop
(paren
op_star
id|str
op_logical_and
id|strchr
c_func
(paren
id|s
comma
op_star
id|str
)paren
)paren
op_increment
id|str
multiline_comment|/* strip leading spaces */
suffix:semicolon
r_while
c_loop
(paren
(paren
id|eos
OG
id|str
)paren
op_logical_and
id|strchr
c_func
(paren
id|s
comma
op_star
(paren
id|eos
op_minus
l_int|1
)paren
)paren
)paren
op_decrement
id|eos
multiline_comment|/* strip trailing spaces */
suffix:semicolon
op_star
id|eos
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|str
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Configure PPP firmware.&n; */
DECL|function|ppp_configure
r_static
r_int
id|ppp_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|data_len
op_assign
r_sizeof
(paren
id|ppp508_conf_t
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mb-&gt;data
comma
id|data
comma
id|data_len
)paren
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
id|data_len
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_SET_CONFIG
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set interrupt mode.&n; */
DECL|function|ppp_set_intr_mode
r_static
r_int
id|ppp_set_intr_mode
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_char
id|mode
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|ppp_intr_info_t
op_star
id|ppp_intr_data
op_assign
(paren
id|ppp_intr_info_t
op_star
)paren
op_amp
id|mb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|ppp_intr_data-&gt;i_enable
op_assign
id|mode
suffix:semicolon
id|ppp_intr_data-&gt;irq
op_assign
id|card-&gt;hw.irq
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* If timer has been enabled, set the timer delay to 1sec */
r_if
c_cond
(paren
id|mode
op_amp
l_int|0x80
)paren
(brace
id|ppp_intr_data-&gt;timer_len
op_assign
l_int|5
suffix:semicolon
singleline_comment|//100; //250;
id|mb-&gt;cmd.length
op_assign
l_int|4
suffix:semicolon
)brace
id|mb-&gt;cmd.command
op_assign
id|PPP_SET_INTR_FLAGS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Enable communications.&n; */
DECL|function|ppp_comm_enable
r_static
r_int
id|ppp_comm_enable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_COMM_ENABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Disable communications.&n; */
DECL|function|ppp_comm_disable
r_static
r_int
id|ppp_comm_disable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_COMM_DISABLE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get communications error statistics.&n; */
DECL|function|ppp_get_err_stats
r_static
r_int
id|ppp_get_err_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_READ_ERROR_STATS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
id|ppp_err_stats_t
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mb-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|stats-&gt;rx_overrun
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|stats-&gt;rx_bad_crc
suffix:semicolon
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|stats-&gt;rx_abort
suffix:semicolon
id|card-&gt;wandev.stats.rx_length_errors
op_assign
id|stats-&gt;rx_lost
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|stats-&gt;tx_abort
suffix:semicolon
)brace
r_else
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send packet.&n; *&t;Return:&t;0 - o.k.&n; *&t;&t;1 - no transmit buffers available&n; */
DECL|function|ppp_send
r_static
r_int
id|ppp_send
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_int
id|proto
)paren
(brace
id|ppp_buf_ctl_t
op_star
id|txbuf
op_assign
id|card-&gt;u.p.txbuf
suffix:semicolon
r_if
c_cond
(paren
id|txbuf-&gt;flag
)paren
r_return
l_int|1
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|txbuf-&gt;buf.ptr
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|txbuf-&gt;length
op_assign
id|len
suffix:semicolon
multiline_comment|/* frame length */
r_if
c_cond
(paren
id|proto
op_eq
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
)paren
id|txbuf-&gt;proto
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* protocol ID */
r_else
id|txbuf-&gt;proto
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* protocol ID */
id|txbuf-&gt;flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* start transmission */
multiline_comment|/* Update transmit buffer control fields */
id|card-&gt;u.p.txbuf
op_assign
op_increment
id|txbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|txbuf
OG
id|card-&gt;u.p.txbuf_last
)paren
id|card-&gt;u.p.txbuf
op_assign
id|card-&gt;u.p.txbuf_base
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Firmware Error Handler **********************************************/
multiline_comment|/*============================================================================&n; * Firmware error handler.&n; *&t;This routine is called whenever firmware command returns non-zero&n; *&t;return code.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
DECL|function|ppp_error
r_static
r_int
id|ppp_error
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
id|ppp_mbox_t
op_star
id|mb
)paren
(brace
r_int
id|cmd
op_assign
id|mb-&gt;cmd.command
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: command 0x%02X timed out!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X returned 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
comma
id|err
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Interrupt Handlers **************************************************/
multiline_comment|/*============================================================================&n; * PPP interrupt service routine.&n; */
DECL|function|wpp_isr
id|STATIC
r_void
id|wpp_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_entry
suffix:semicolon
singleline_comment|//FIXME: Do we need this
id|card-&gt;force_enable_irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
op_increment
id|card-&gt;statistics.isr_already_critical
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Critical while in ISR!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|flags-&gt;iflag
)paren
(brace
r_case
id|PPP_INTR_RXRDY
suffix:colon
multiline_comment|/* receive interrupt  0x01  (bit 0)*/
op_increment
id|card-&gt;statistics.isr_rx
suffix:semicolon
id|rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_INTR_TXRDY
suffix:colon
multiline_comment|/* transmit interrupt  0x02 (bit 1)*/
op_increment
id|card-&gt;statistics.isr_tx
suffix:semicolon
id|flags-&gt;imask
op_and_assign
op_complement
id|PPP_INTR_TXRDY
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_INTR_CMD
suffix:colon
multiline_comment|/* interface command completed */
op_increment
id|Intr_test_counter
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_intr_test
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_INTR_MODEM
suffix:colon
multiline_comment|/* modem status change (DCD, CTS) 0x04 (bit 2)*/
r_case
id|PPP_INTR_DISC
suffix:colon
multiline_comment|/* Data link disconnected 0x10  (bit 4)*/
r_case
id|PPP_INTR_OPEN
suffix:colon
multiline_comment|/* Data link open 0x20  (bit 5)*/
r_case
id|PPP_INTR_DROP_DTR
suffix:colon
multiline_comment|/* DTR drop timeout expired  0x40 bit 6 */
id|event_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_INTR_TIMER
suffix:colon
id|timer_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unexpected interrupt */
op_increment
id|card-&gt;statistics.isr_spurious
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|flags-&gt;iflag
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
id|flags-&gt;iflag
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;buff_int_mode_unbusy
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Receive interrupt handler.&n; */
DECL|function|rx_intr
r_static
r_void
id|rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_buf_ctl_t
op_star
id|rxbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_void
op_star
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_int
id|udp_type
suffix:semicolon
r_if
c_cond
(paren
id|rxbuf-&gt;flag
op_ne
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: corrupted Rx buffer @ 0x%X, flag = 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
(paren
r_int
)paren
id|rxbuf
comma
id|rxbuf-&gt;flag
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|card-&gt;statistics.rx_intr_corrupt_rx_bfr
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_logical_and
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|len
op_assign
id|rxbuf-&gt;length
suffix:semicolon
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Allocate socket buffer */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Copy data to the socket buffer */
r_int
id|addr
op_assign
id|rxbuf-&gt;buf.ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
op_plus
id|len
)paren
OG
id|card-&gt;u.p.rx_top
op_plus
l_int|1
)paren
(brace
r_int
id|tmp
op_assign
id|card-&gt;u.p.rx_top
op_minus
id|addr
op_plus
l_int|1
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|tmp
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|tmp
)paren
suffix:semicolon
id|addr
op_assign
id|card-&gt;u.p.rx_base
suffix:semicolon
id|len
op_sub_assign
id|tmp
suffix:semicolon
)brace
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Decapsulate packet */
r_switch
c_cond
(paren
id|rxbuf-&gt;proto
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udp_type
op_assign
id|udp_pkt_type
c_func
(paren
id|skb
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_eq
id|UDP_PTPIPE_TYPE
)paren
(brace
multiline_comment|/* Handle a UDP Request in Timer Interrupt */
r_if
c_cond
(paren
id|store_udp_mgmt_pkt
c_func
(paren
id|UDP_PKT_FRM_NETWORK
comma
id|card
comma
id|skb
comma
id|dev
comma
id|ppp_priv_area
)paren
)paren
(brace
id|flags-&gt;imask
op_or_assign
id|PPP_INTR_TIMER
suffix:semicolon
)brace
op_increment
id|ppp_priv_area-&gt;rx_intr_stat.rx_intr_PIPE_request
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|handle_IPXWAN
c_func
(paren
id|skb-&gt;data
comma
id|card-&gt;devname
comma
id|ppp_priv_area-&gt;enable_IPX
comma
id|ppp_priv_area-&gt;network_number
comma
id|skb-&gt;protocol
)paren
)paren
(brace
multiline_comment|/* Handle an IPXWAN packet */
r_if
c_cond
(paren
id|ppp_priv_area-&gt;enable_IPX
)paren
(brace
id|ppp_send
c_func
(paren
id|card
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Pass data up the protocol stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_packets
suffix:semicolon
id|card-&gt;wandev.stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;rx_intr_stat.rx_intr_bfr_passed_to_stack
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;rx_intr_stat.rx_intr_no_socket
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
op_increment
id|card-&gt;statistics.rx_intr_dev_not_started
suffix:semicolon
)brace
multiline_comment|/* Release buffer element and calculate a pointer to the next one */
id|rxbuf-&gt;flag
op_assign
l_int|0x00
suffix:semicolon
id|card-&gt;rxmb
op_assign
op_increment
id|rxbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|rxbuf
OG
id|card-&gt;u.p.rxbuf_last
)paren
id|card-&gt;rxmb
op_assign
id|card-&gt;u.p.rxbuf_base
suffix:semicolon
)brace
DECL|function|event_intr
r_void
id|event_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_switch
c_cond
(paren
id|flags-&gt;iflag
)paren
(brace
r_case
id|PPP_INTR_MODEM
suffix:colon
multiline_comment|/* modem status change (DCD, CTS) 0x04  (bit 2)*/
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Modem status: DCD=%s CTS=%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|DCD
c_func
(paren
id|flags-&gt;mstatus
)paren
comma
id|CTS
c_func
(paren
id|flags-&gt;mstatus
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_INTR_DISC
suffix:colon
multiline_comment|/* Data link disconnected 0x10  (bit 4)*/
id|NEX_PRINTK
(paren
id|KERN_INFO
l_string|&quot;Data link disconnected intr Cause %X&bslash;n&quot;
comma
id|flags-&gt;disc_cause
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;disc_cause
op_amp
(paren
id|PPP_LOCAL_TERMINATION
op_or
id|PPP_DCD_CTS_DROP
op_or
id|PPP_REMOTE_TERMINATION
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.p.ip_mode
op_eq
id|WANOPT_PPP_PEER
)paren
(brace
id|Read_connection_info
op_assign
l_int|1
suffix:semicolon
id|remove_route
(paren
id|card
)paren
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|show_disc_cause
c_func
(paren
id|card
comma
id|flags-&gt;disc_cause
)paren
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_PPP_EVENT
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|PPP_INTR_TIMER
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPP_INTR_OPEN
suffix:colon
multiline_comment|/* Data link open 0x20  (bit 5)*/
id|NEX_PRINTK
(paren
id|KERN_INFO
l_string|&quot;%s: PPP Link Open, LCP=%s IP=%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|LCP
c_func
(paren
id|flags-&gt;lcp_state
)paren
comma
id|IP
c_func
(paren
id|flags-&gt;ip_state
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;lcp_state
op_eq
l_int|0x09
op_logical_and
(paren
id|flags-&gt;ip_state
op_eq
l_int|0x09
op_logical_or
id|flags-&gt;ipx_state
op_eq
l_int|0x09
)paren
)paren
(brace
multiline_comment|/* Initialize the polling timer and set the state&n;                                 * to WAN_CONNNECTED &n;                                 */
id|card-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_PPP_EVENT
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|PPP_INTR_TIMER
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPP_INTR_DROP_DTR
suffix:colon
multiline_comment|/* DTR drop timeout expired  0x40 bit 6 */
id|NEX_PRINTK
c_func
(paren
id|KERN_INFO
l_string|&quot;DTR Drop Timeout Interrrupt &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.p.ip_mode
op_eq
id|WANOPT_PPP_PEER
)paren
(brace
id|Read_connection_info
op_assign
l_int|1
suffix:semicolon
id|remove_route
(paren
id|card
)paren
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|show_disc_cause
c_func
(paren
id|card
comma
id|flags-&gt;disc_cause
)paren
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_PPP_EVENT
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|PPP_INTR_TIMER
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error, Invalid PPP Event&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TIMER INTERRUPT */
DECL|function|timer_intr
r_void
id|timer_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
multiline_comment|/* Update statistics */
r_if
c_cond
(paren
id|ppp_priv_area-&gt;timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UPDATE
)paren
(brace
id|ppp_get_err_stats
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|ppp_priv_area-&gt;update_comms_stats
)paren
)paren
(brace
id|ppp_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
)brace
)brace
multiline_comment|/* PPIPEMON UDP request */
r_if
c_cond
(paren
id|ppp_priv_area-&gt;timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UDP
)paren
(brace
id|process_udp_mgmt_pkt
c_func
(paren
id|card
comma
id|dev
comma
id|ppp_priv_area
)paren
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UDP
suffix:semicolon
)brace
multiline_comment|/* PPP Event */
r_if
c_cond
(paren
id|ppp_priv_area-&gt;timer_int_enabled
op_amp
id|TMR_INT_ENABLED_PPP_EVENT
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_DISCONNECTED
)paren
(brace
id|poll_disconnected
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* If the state is CONNECTING, it means that communicatins were&n;&t; &t; * enabled. When the remote side enables its comminication we&n;&t; &t; * should get an interrupt PPP_INTR_OPEN, thus turn off polling &n;&t;&t; */
r_else
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_CONNECTING
)paren
(brace
multiline_comment|/* Turn off the timer interrupt */
id|ppp_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_PPP_EVENT
suffix:semicolon
)brace
multiline_comment|/* If state is connected and we are in PEER mode &n;&t; &t; * poll for an IP address which will be provided by remote end.&n;&t; &t; */
r_else
r_if
c_cond
(paren
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_CONNECTED
op_logical_and
id|card-&gt;u.p.ip_mode
op_eq
id|WANOPT_PPP_PEER
)paren
op_logical_and
id|Read_connection_info
)paren
(brace
id|card-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_connection_info
(paren
id|card
)paren
)paren
(brace
id|card-&gt;poll
op_assign
op_amp
id|process_route
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If we are using Static IP,no need to poll for&n;&t;&t;&t; * an IP address. &n;&t;&t; &t; */
id|NEX_PRINTK
c_func
(paren
id|KERN_INFO
l_string|&quot;Turning off TIMER &bslash;n&quot;
)paren
suffix:semicolon
id|ppp_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_PPP_EVENT
suffix:semicolon
)brace
)brace
multiline_comment|/* End of PPP_EVENT */
multiline_comment|/* Only disable the timer interrupt if there are no udp, statistic */
multiline_comment|/* updates or events pending */
r_if
c_cond
(paren
op_logical_neg
id|ppp_priv_area-&gt;timer_int_enabled
)paren
(brace
id|flags-&gt;imask
op_and_assign
op_complement
id|PPP_INTR_TIMER
suffix:semicolon
)brace
)brace
DECL|function|handle_IPXWAN
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
comma
r_int
r_int
id|proto
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
)paren
(brace
singleline_comment|//It&squot;s an IPX packet
r_if
c_cond
(paren
op_logical_neg
id|enable_IPX
)paren
(brace
singleline_comment|//Return 1 so we don&squot;t pass it up the stack.
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|//It&squot;s not IPX so pass it up the stack.
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|16
)braket
op_eq
l_int|0x90
op_logical_and
id|sendpacket
(braket
l_int|17
)braket
op_eq
l_int|0x04
)paren
(brace
singleline_comment|//It&squot;s IPXWAN
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x02
op_logical_and
id|sendpacket
(braket
l_int|34
)braket
op_eq
l_int|0x00
)paren
(brace
singleline_comment|//It&squot;s a timer request packet
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Timer Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
singleline_comment|//Go through the routing options and answer no to every
singleline_comment|//option except Unnumbered RIP/SAP
r_for
c_loop
(paren
id|i
op_assign
l_int|41
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x00
suffix:semicolon
id|i
op_add_assign
l_int|5
)paren
(brace
singleline_comment|//0x02 is the option for Unnumbered RIP/SAP
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|4
)braket
op_ne
l_int|0x02
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|//Skip over the extended Node ID option
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x04
)paren
(brace
id|i
op_add_assign
l_int|8
suffix:semicolon
)brace
singleline_comment|//We also want to turn off all header compression opt.
r_for
c_loop
(paren
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x80
suffix:semicolon
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_add_assign
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|3
)braket
)paren
op_plus
l_int|4
suffix:semicolon
)brace
singleline_comment|//Set the packet type to timer response
id|sendpacket
(braket
l_int|34
)braket
op_assign
l_int|0x01
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Timer Response&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|34
)braket
op_eq
l_int|0x02
)paren
(brace
singleline_comment|//This is an information request packet
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Information Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
singleline_comment|//Set the packet type to information response
id|sendpacket
(braket
l_int|34
)braket
op_assign
l_int|0x03
suffix:semicolon
singleline_comment|//Set the router name
id|sendpacket
(braket
l_int|51
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|52
)braket
op_assign
l_char|&squot;T&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|53
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|54
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|55
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|56
)braket
op_assign
l_char|&squot;E&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|57
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|58
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_rshift
l_int|28
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|59
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0F000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|60
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00F00000
)paren
op_rshift
l_int|20
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|61
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000F0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|62
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0000F000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|63
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00000F00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|64
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000000F0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|65
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_amp
l_int|0x0000000F
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|66
suffix:semicolon
id|i
OL
l_int|99
suffix:semicolon
id|i
op_add_assign
l_int|1
)paren
(brace
id|sendpacket
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Information Response packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown IPXWAN packet!&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//Set the WNodeID to our network address
id|sendpacket
(braket
l_int|35
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|36
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|37
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|38
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//If we get here&squot;s its an IPX-data packet, so it&squot;ll get passed up the stack.
singleline_comment|//switch the network numbers
id|switch_net_numbers
c_func
(paren
id|sendpacket
comma
id|network_number
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/****** Background Polling Routines  ****************************************/
multiline_comment|/* All polling functions are invoked by the TIMER interrupt in the wpp_isr &n; * routine.  &n; */
multiline_comment|/*============================================================================&n; * Monitor active link phase.&n; */
DECL|function|process_route
r_static
r_void
id|process_route
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|card-&gt;u.p.ip_mode
op_eq
id|WANOPT_PPP_PEER
)paren
op_logical_and
(paren
id|Read_connection_info
op_logical_and
id|flags-&gt;ip_state
op_eq
l_int|0x09
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IPCP State Opened.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_info
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: An error occurred in IP assignment.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Assigned Lcl. Addr: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ifa-&gt;ifa_local
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Assigned Rmt. Addr: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ifa-&gt;ifa_address
)paren
)paren
suffix:semicolon
)brace
id|Read_connection_info
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error: Null pointer in Poll Active&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|card-&gt;poll
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Monitor physical link disconnected phase.&n; *  o if interface is up and the hold-down timeout has expired, then retry&n; *    connection.&n; */
DECL|function|poll_disconnected
r_static
r_void
id|poll_disconnected
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|netif_running
c_func
(paren
id|dev
)paren
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|card-&gt;state_tick
)paren
OG
id|HOLD_DOWN_TIME
)paren
)paren
(brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_comm_enable
c_func
(paren
id|card
)paren
op_eq
id|CMD_OK
)paren
(brace
id|init_ppp_tx_rx_buff
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/****** Miscellaneous Functions *********************************************/
multiline_comment|/*============================================================================&n; * Configure S508 adapter.&n; */
DECL|function|config508
r_static
r_int
id|config508
c_func
(paren
id|ppp_private_area_t
op_star
id|ppp_priv_area
comma
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp508_conf_t
id|cfg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
multiline_comment|/* Prepare PPP configuration structure */
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|ppp508_conf_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.clocking
)paren
id|cfg.line_speed
op_assign
id|card-&gt;wandev.bps
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.interface
op_eq
id|WANOPT_RS232
)paren
id|cfg.conf_flags
op_or_assign
id|INTERFACE_LEVEL_RS232
suffix:semicolon
id|cfg.conf_flags
op_or_assign
id|DONT_TERMINATE_LNK_MAX_CONFIG
suffix:semicolon
multiline_comment|/*send Configure-Request packets forever*/
id|cfg.txbuf_percent
op_assign
id|PERCENT_TX_BUFF
suffix:semicolon
multiline_comment|/* % of Tx bufs */
id|cfg.mtu_local
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|cfg.mtu_remote
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
multiline_comment|/*    Default   */
id|cfg.restart_tmr
op_assign
id|TIME_BETWEEN_CONF_REQ
suffix:semicolon
multiline_comment|/*    30 = 3sec */
id|cfg.auth_rsrt_tmr
op_assign
id|TIME_BETWEEN_PAP_CHAP_REQ
suffix:semicolon
multiline_comment|/*    30 = 3sec */
id|cfg.auth_wait_tmr
op_assign
id|WAIT_PAP_CHAP_WITHOUT_REPLY
suffix:semicolon
multiline_comment|/*   300 = 30s  */
id|cfg.mdm_fail_tmr
op_assign
id|WAIT_AFTER_DCD_CTS_LOW
suffix:semicolon
multiline_comment|/*     5 = 0.5s */
id|cfg.dtr_drop_tmr
op_assign
id|TIME_DCD_CTS_LOW_AFTER_LNK_DOWN
suffix:semicolon
multiline_comment|/*    10 = 1s   */
id|cfg.connect_tmout
op_assign
id|WAIT_DCD_HIGH_AFTER_ENABLE_COMM
suffix:semicolon
multiline_comment|/*   900 = 90s  */
id|cfg.conf_retry
op_assign
id|MAX_CONF_REQ_WITHOUT_REPLY
suffix:semicolon
multiline_comment|/*    10 = 1s   */
id|cfg.term_retry
op_assign
id|MAX_TERM_REQ_WITHOUT_REPLY
suffix:semicolon
multiline_comment|/*     2 times  */
id|cfg.fail_retry
op_assign
id|NUM_CONF_NAK_WITHOUT_REPLY
suffix:semicolon
multiline_comment|/*     5 times  */
id|cfg.auth_retry
op_assign
id|NUM_AUTH_REQ_WITHOUT_REPLY
suffix:semicolon
multiline_comment|/*     10 times */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.p.authenticator
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Device is not configured as an authenticator&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|cfg.auth_options
op_assign
id|NO_AUTHENTICATION
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Device is configured as an authenticator&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|cfg.auth_options
op_assign
id|INBOUND_AUTH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppp_priv_area-&gt;pap
op_eq
id|WANOPT_YES
)paren
(brace
id|cfg.auth_options
op_or_assign
id|PAP_AUTH
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Pap enabled&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppp_priv_area-&gt;chap
op_eq
id|WANOPT_YES
)paren
(brace
id|cfg.auth_options
op_or_assign
id|CHAP_AUTH
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chap enabled&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppp_priv_area-&gt;enable_IPX
op_eq
id|WANOPT_YES
)paren
(brace
id|cfg.ipx_options
op_assign
id|ENABLE_IPX
op_or
id|ROUTING_PROT_DEFAULT
suffix:semicolon
)brace
r_else
(brace
id|cfg.ipx_options
op_assign
id|DISABLE_IPX
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|card-&gt;u.p.ip_mode
)paren
(brace
r_case
id|WANOPT_PPP_STATIC
suffix:colon
id|cfg.ip_options
op_assign
id|L_AND_R_IP_NO_ASSIG
op_or
id|ENABLE_IP
suffix:semicolon
id|cfg.ip_local
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
id|cfg.ip_remote
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_address
suffix:semicolon
id|NEX_PRINTK
c_func
(paren
id|KERN_INFO
l_string|&quot;Local %s Remote %s Name %s&bslash;n&quot;
comma
id|in_ntoa
c_func
(paren
id|cfg.ip_local
)paren
comma
id|in_ntoa
c_func
(paren
id|cfg.ip_remote
)paren
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANOPT_PPP_PEER
suffix:colon
id|cfg.ip_options
op_assign
id|L_IP_REMOTE_ASSIG
op_or
id|R_IP_REMOTE_ASSIG
op_or
id|ENABLE_IP
suffix:semicolon
id|cfg.ip_local
op_assign
l_int|0x00
suffix:semicolon
id|cfg.ip_remote
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ppp_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Show disconnection cause.&n; */
DECL|function|show_disc_cause
r_static
r_void
id|show_disc_cause
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|cause
)paren
(brace
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0802
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link terminated by peer&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0004
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link terminated by user&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0008
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: authentication failed&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0010
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: authentication protocol negotiation failed&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0020
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: peer&squot;s request for authentication rejected&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0040
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MRU option rejected by peer&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0080
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: peer&squot;s MRU was too small&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0100
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed to negotiate peer&squot;s LCP options&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0200
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed to negotiate peer&squot;s IPCP options&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cause
op_amp
l_int|0x0400
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed to negotiate peer&squot;s IPXCP options&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Process UDP call of type PTPIPEAB.&n; */
DECL|function|process_udp_mgmt_pkt
r_static
r_void
id|process_udp_mgmt_pkt
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_struct
id|net_device
op_star
id|dev
comma
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
(brace
r_int
r_char
id|buf2
(braket
l_int|5
)braket
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
r_int
id|frames
comma
id|len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
r_int
r_int
id|data_length
comma
id|buffer_length
comma
id|real_len
suffix:semicolon
r_int
r_int
id|data_ptr
suffix:semicolon
r_int
id|udp_mgmt_req_valid
op_assign
l_int|1
suffix:semicolon
id|ppp_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_int
id|err
suffix:semicolon
id|ppp_udp_pkt_t
op_star
id|ppp_udp_pkt
op_assign
(paren
id|ppp_udp_pkt_t
op_star
)paren
op_amp
id|ppp_priv_area-&gt;udp_pkt_data
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buf2
comma
op_amp
id|card-&gt;wandev.udp_port
comma
l_int|2
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ppp_udp_pkt-&gt;cblock.command
)paren
(brace
multiline_comment|/* FT1 MONITOR STATUS */
r_case
id|FT1_MONITOR_STATUS_CTRL
suffix:colon
multiline_comment|/* PPIPE_ENABLE_TRACING */
r_case
id|PPIPE_ENABLE_TRACING
suffix:colon
multiline_comment|/* PPIPE_DISABLE_TRACING */
r_case
id|PPIPE_DISABLE_TRACING
suffix:colon
multiline_comment|/* PPIPE_GET_TRACE_INFO */
r_case
id|PPIPE_GET_TRACE_INFO
suffix:colon
multiline_comment|/* SET FT1 MODE */
r_case
id|SET_FT1_MODE
suffix:colon
r_if
c_cond
(paren
id|ppp_priv_area-&gt;udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
op_increment
id|ppp_priv_area-&gt;pipe_mgmt_stat
dot
id|UDP_PIPE_mgmt_direction_err
suffix:semicolon
id|udp_mgmt_req_valid
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|udp_mgmt_req_valid
)paren
(brace
multiline_comment|/* set length to 0 */
id|ppp_udp_pkt-&gt;cblock.length
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* set return code */
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0xCD
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Initialize the trace element */
id|trace_element_t
id|trace_element
suffix:semicolon
r_switch
c_cond
(paren
id|ppp_udp_pkt-&gt;cblock.command
)paren
(brace
multiline_comment|/* PPIPE_ENABLE_TRACING */
r_case
id|PPIPE_ENABLE_TRACING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;TracingEnabled
)paren
(brace
multiline_comment|/* OPERATE_DATALINE_MONITOR */
id|mbox-&gt;cmd.command
op_assign
id|PPP_DATALINE_MONITOR
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0x01
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set the return code */
id|ppp_udp_pkt-&gt;cblock.result
op_assign
id|mbox-&gt;cmd.result
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0xC000
comma
op_amp
id|buf2
comma
l_int|2
)paren
suffix:semicolon
id|ppp_priv_area-&gt;curr_trace_addr
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ppp_priv_area-&gt;curr_trace_addr
comma
op_amp
id|buf2
comma
l_int|2
)paren
suffix:semicolon
id|ppp_priv_area-&gt;start_trace_addr
op_assign
id|ppp_priv_area-&gt;curr_trace_addr
suffix:semicolon
id|ppp_priv_area-&gt;end_trace_addr
op_assign
id|ppp_priv_area-&gt;start_trace_addr
op_plus
id|END_OFFSET
suffix:semicolon
multiline_comment|/* MAX_SEND_BUFFER_SIZE - 28 (IP header) &n;&t;&t;&t;&t;   - 32 (ppipemon CBLOCK) */
id|available_buffer_space
op_assign
id|MAX_LGTH_UDP_MGNT_PKT
op_minus
r_sizeof
(paren
id|ip_pkt_t
)paren
op_minus
r_sizeof
(paren
id|udp_pkt_t
)paren
op_minus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_minus
r_sizeof
(paren
id|cblock_t
)paren
suffix:semicolon
)brace
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* PPIPE_DISABLE_TRACING */
r_case
id|PPIPE_DISABLE_TRACING
suffix:colon
r_if
c_cond
(paren
id|card-&gt;TracingEnabled
)paren
(brace
multiline_comment|/* OPERATE_DATALINE_MONITOR */
id|mbox-&gt;cmd.command
op_assign
l_int|0x33
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
multiline_comment|/*set return code*/
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* PPIPE_GET_TRACE_INFO */
r_case
id|PPIPE_GET_TRACE_INFO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;TracingEnabled
)paren
(brace
multiline_comment|/* set return code */
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
)brace
id|buffer_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* frames &lt; 62, where 62 is the number of trace&n;&t;&t;&t;   information elements.  There is in total 496&n;&t;&t;&t;   bytes of space and each trace information&n;&t;&t;&t;   element is 8 bytes. &n;&t;&t;&t; */
r_for
c_loop
(paren
id|frames
op_assign
l_int|0
suffix:semicolon
id|frames
OL
l_int|62
suffix:semicolon
id|frames
op_increment
)paren
(brace
id|trace_pkt_t
op_star
id|trace_pkt
op_assign
(paren
id|trace_pkt_t
op_star
)paren
op_amp
id|ppp_udp_pkt-&gt;data
(braket
id|buffer_length
)braket
suffix:semicolon
multiline_comment|/* Read the whole trace packet */
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|ppp_priv_area-&gt;curr_trace_addr
comma
op_amp
id|trace_element
comma
r_sizeof
(paren
id|trace_element_t
)paren
)paren
suffix:semicolon
multiline_comment|/* no data on board so exit */
r_if
c_cond
(paren
id|trace_element.opp_flag
op_eq
l_int|0x00
)paren
(brace
r_break
suffix:semicolon
)brace
id|data_ptr
op_assign
id|trace_element.trace_data_ptr
suffix:semicolon
multiline_comment|/* See if there is actual data on the trace buffer */
r_if
c_cond
(paren
id|data_ptr
)paren
(brace
id|data_length
op_assign
id|trace_element.trace_length
suffix:semicolon
)brace
r_else
(brace
id|data_length
op_assign
l_int|0
suffix:semicolon
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_or_assign
l_int|0x02
suffix:semicolon
)brace
singleline_comment|//FIXME: Do we need this check
r_if
c_cond
(paren
(paren
id|available_buffer_space
op_minus
id|buffer_length
)paren
OL
(paren
r_sizeof
(paren
id|trace_element_t
)paren
op_plus
l_int|1
)paren
)paren
(brace
multiline_comment|/*indicate we have more frames &n;&t;&t;&t;&t;&t; * on board and exit &n;&t;&t;&t;&t;&t; */
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_or_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
)brace
id|trace_pkt-&gt;status
op_assign
id|trace_element.trace_type
suffix:semicolon
id|trace_pkt-&gt;time_stamp
op_assign
id|trace_element.trace_time_stamp
suffix:semicolon
id|trace_pkt-&gt;real_length
op_assign
id|trace_element.trace_length
suffix:semicolon
id|real_len
op_assign
id|trace_element.trace_length
suffix:semicolon
r_if
c_cond
(paren
id|data_ptr
op_eq
l_int|0
)paren
(brace
id|trace_pkt-&gt;data_avail
op_assign
l_int|0x00
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* we can take it next time */
r_if
c_cond
(paren
(paren
id|available_buffer_space
op_minus
id|buffer_length
)paren
OL
(paren
id|real_len
op_plus
r_sizeof
(paren
id|trace_pkt_t
)paren
)paren
)paren
(brace
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_or_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
)brace
id|trace_pkt-&gt;data_avail
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* get the data */
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|data_ptr
comma
op_amp
id|trace_pkt-&gt;data
comma
id|real_len
)paren
suffix:semicolon
)brace
multiline_comment|/* zero the opp flag to &n;&t;&t;&t;&t;   show we got the frame */
id|buf2
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|ppp_priv_area-&gt;curr_trace_addr
comma
op_amp
id|buf2
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* now move onto the next &n;&t;&t;&t;&t;   frame */
id|ppp_priv_area-&gt;curr_trace_addr
op_add_assign
l_int|8
suffix:semicolon
multiline_comment|/* check if we passed the last address */
r_if
c_cond
(paren
id|ppp_priv_area-&gt;curr_trace_addr
op_ge
id|ppp_priv_area-&gt;end_trace_addr
)paren
(brace
id|ppp_priv_area-&gt;curr_trace_addr
op_assign
id|ppp_priv_area-&gt;start_trace_addr
suffix:semicolon
)brace
multiline_comment|/* update buffer length and make sure its even */
r_if
c_cond
(paren
id|trace_pkt-&gt;data_avail
op_eq
l_int|0x01
)paren
(brace
id|buffer_length
op_add_assign
id|real_len
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* for the header */
id|buffer_length
op_add_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|buffer_length
op_amp
l_int|0x0001
)paren
(brace
id|buffer_length
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* ok now set the total number of frames passed&n;&t;&t;&t;   in the high 5 bits */
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_or_assign
(paren
id|frames
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* set the data length */
id|mbox-&gt;cmd.length
op_assign
id|buffer_length
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.length
op_assign
id|buffer_length
suffix:semicolon
multiline_comment|/* set return code */
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* PPIPE_GET_IBA_DATA */
r_case
id|PPIPE_GET_IBA_DATA
suffix:colon
id|mbox-&gt;cmd.length
op_assign
l_int|0x09
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0xF003
comma
op_amp
id|ppp_udp_pkt-&gt;data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
multiline_comment|/* set the length of the data */
id|ppp_udp_pkt-&gt;cblock.length
op_assign
l_int|0x09
suffix:semicolon
multiline_comment|/* set return code */
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* PPIPE_KILL_BOARD */
r_case
id|PPIPE_KILL_BOARD
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* PPIPE_FT1_READ_STATUS */
r_case
id|PPIPE_FT1_READ_STATUS
suffix:colon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0xF020
comma
op_amp
id|ppp_udp_pkt-&gt;data
comma
l_int|2
)paren
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.length
op_assign
l_int|2
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPIPE_FLUSH_DRIVER_STATS
suffix:colon
id|init_ppp_priv_struct
c_func
(paren
id|ppp_priv_area
)paren
suffix:semicolon
id|init_global_statistics
c_func
(paren
id|card
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPIPE_ROUTER_UP_TIME
suffix:colon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|ppp_priv_area-&gt;router_up_time
op_assign
id|tv.tv_sec
op_minus
id|ppp_priv_area-&gt;router_start_time
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|ppp_udp_pkt-&gt;data
op_assign
id|ppp_priv_area-&gt;router_up_time
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FT1 MONITOR STATUS */
r_case
id|FT1_MONITOR_STATUS_CTRL
suffix:colon
multiline_comment|/* Enable FT1 MONITOR STATUS */
r_if
c_cond
(paren
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rCount
op_increment
op_ne
l_int|0
)paren
(brace
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable FT1 MONITOR STATUS */
r_if
c_cond
(paren
id|ppp_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|rCount
op_ne
l_int|0
)paren
(brace
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* PPIPE_DRIVER_STATISTICS */
r_case
id|PPIPE_DRIVER_STAT_IFSEND
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Getting IF_SEND Drivers Statistics&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;data
comma
op_amp
id|ppp_priv_area-&gt;if_send_stat
comma
r_sizeof
(paren
id|if_send_stat_t
)paren
)paren
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.length
op_assign
r_sizeof
(paren
id|if_send_stat_t
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|if_send_stat_t
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPIPE_DRIVER_STAT_INTR
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;data
comma
op_amp
id|card-&gt;statistics
comma
r_sizeof
(paren
id|global_stats_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;data
op_plus
r_sizeof
(paren
id|global_stats_t
)paren
comma
op_amp
id|ppp_priv_area-&gt;rx_intr_stat
comma
r_sizeof
(paren
id|rx_intr_stat_t
)paren
)paren
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.length
op_assign
r_sizeof
(paren
id|global_stats_t
)paren
op_plus
r_sizeof
(paren
id|rx_intr_stat_t
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|ppp_udp_pkt-&gt;cblock.length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPIPE_DRIVER_STAT_GEN
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;data
comma
op_amp
id|ppp_priv_area-&gt;pipe_mgmt_stat
comma
r_sizeof
(paren
id|pipe_mgmt_stat_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;data
op_plus
r_sizeof
(paren
id|pipe_mgmt_stat_t
)paren
comma
op_amp
id|card-&gt;statistics
comma
r_sizeof
(paren
id|global_stats_t
)paren
)paren
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|ppp_udp_pkt-&gt;cblock.length
op_assign
r_sizeof
(paren
id|global_stats_t
)paren
op_plus
r_sizeof
(paren
id|rx_intr_stat_t
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|ppp_udp_pkt-&gt;cblock.length
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* it&squot;s a board command */
id|mbox-&gt;cmd.command
op_assign
id|ppp_udp_pkt-&gt;cblock.command
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|ppp_udp_pkt-&gt;cblock.length
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;cmd.length
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;data
comma
(paren
r_int
r_char
op_star
)paren
id|ppp_udp_pkt-&gt;data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
)brace
multiline_comment|/* run the command on the board */
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;pipe_mgmt_stat
dot
id|UDP_PIPE_mgmt_adptr_cmnd_timeout
suffix:semicolon
r_break
suffix:semicolon
)brace
op_increment
id|ppp_priv_area-&gt;pipe_mgmt_stat.UDP_PIPE_mgmt_adptr_cmnd_OK
suffix:semicolon
multiline_comment|/* copy the result back to our buffer */
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;cblock
comma
id|mbox
comma
r_sizeof
(paren
id|cblock_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;cmd.length
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|ppp_udp_pkt-&gt;data
comma
op_amp
id|mbox-&gt;data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end of switch */
)brace
multiline_comment|/* end of else */
multiline_comment|/* Fill UDP TTL */
id|ppp_udp_pkt-&gt;ip_pkt.ttl
op_assign
id|card-&gt;wandev.ttl
suffix:semicolon
id|len
op_assign
id|reply_udp
c_func
(paren
id|ppp_priv_area-&gt;udp_pkt_data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_priv_area-&gt;udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
op_increment
id|ppp_priv_area-&gt;pipe_mgmt_stat.UDP_PIPE_mgmt_passed_to_adptr
suffix:semicolon
id|ppp_send
c_func
(paren
id|card
comma
id|ppp_priv_area-&gt;udp_pkt_data
comma
id|len
comma
id|ppp_priv_area-&gt;protocol
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Pass it up the stack&n;    &t;&t;   Allocate socket buffer */
r_if
c_cond
(paren
(paren
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* copy data into new_skb */
id|buf
op_assign
id|skb_put
c_func
(paren
id|new_skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|ppp_priv_area-&gt;udp_pkt_data
comma
id|len
)paren
suffix:semicolon
op_increment
id|ppp_priv_area-&gt;pipe_mgmt_stat.UDP_PIPE_mgmt_passed_to_stack
suffix:semicolon
multiline_comment|/* Decapsulate packet and pass it up the protocol &n;&t;&t;&t;   stack */
id|new_skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|new_skb-&gt;mac.raw
op_assign
id|new_skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|new_skb
)paren
suffix:semicolon
)brace
r_else
(brace
op_increment
id|ppp_priv_area-&gt;pipe_mgmt_stat.UDP_PIPE_mgmt_no_socket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;no socket buffers available!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|ppp_priv_area-&gt;udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Initial the ppp_private_area structure.&n; */
DECL|function|init_ppp_priv_struct
r_static
r_void
id|init_ppp_priv_struct
c_func
(paren
id|ppp_private_area_t
op_star
id|ppp_priv_area
)paren
(brace
id|memset
c_func
(paren
op_amp
id|ppp_priv_area-&gt;if_send_stat
comma
l_int|0
comma
r_sizeof
(paren
id|if_send_stat_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ppp_priv_area-&gt;rx_intr_stat
comma
l_int|0
comma
r_sizeof
(paren
id|rx_intr_stat_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ppp_priv_area-&gt;pipe_mgmt_stat
comma
l_int|0
comma
r_sizeof
(paren
id|pipe_mgmt_stat_t
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Initialize Global Statistics&n; */
DECL|function|init_global_statistics
r_static
r_void
id|init_global_statistics
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|memset
c_func
(paren
op_amp
id|card-&gt;statistics
comma
l_int|0
comma
r_sizeof
(paren
id|global_stats_t
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Initialize Receive and Transmit Buffers.&n; */
DECL|function|init_ppp_tx_rx_buff
r_static
r_void
id|init_ppp_tx_rx_buff
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp508_buf_info_t
op_star
id|info
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP514_BUF_OFFS
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|info-&gt;txb_ptr
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.txbuf_base
op_plus
(paren
id|info-&gt;txb_num
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|info-&gt;rxb_ptr
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.rxbuf_base
op_plus
(paren
id|info-&gt;rxb_num
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|PPP508_BUF_OFFS
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|info-&gt;txb_ptr
op_minus
id|PPP508_MB_VECT
)paren
)paren
suffix:semicolon
id|card-&gt;u.p.txbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.txbuf_base
op_plus
(paren
id|info-&gt;txb_num
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|info-&gt;rxb_ptr
op_minus
id|PPP508_MB_VECT
)paren
)paren
suffix:semicolon
id|card-&gt;u.p.rxbuf_last
op_assign
(paren
id|ppp_buf_ctl_t
op_star
)paren
id|card-&gt;u.p.rxbuf_base
op_plus
(paren
id|info-&gt;rxb_num
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|card-&gt;u.p.rx_base
op_assign
id|info-&gt;rxb_base
suffix:semicolon
id|card-&gt;u.p.rx_top
op_assign
id|info-&gt;rxb_end
suffix:semicolon
id|card-&gt;u.p.txbuf
op_assign
id|card-&gt;u.p.txbuf_base
suffix:semicolon
id|card-&gt;rxmb
op_assign
id|card-&gt;u.p.rxbuf_base
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Read Connection Information (ie for Remote IP address assginment).&n; * Called when ppp interface connected.&n; */
DECL|function|read_info
r_static
r_int
id|read_info
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|ifreq
id|if_info
suffix:semicolon
r_struct
id|sockaddr_in
op_star
id|if_data1
comma
op_star
id|if_data2
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
multiline_comment|/* Set Local and remote addresses */
id|memset
c_func
(paren
op_amp
id|if_info
comma
l_int|0
comma
r_sizeof
(paren
id|if_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|if_info.ifr_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
multiline_comment|/* Change the local and remote ip address of the interface.&n;&t; * This will also add in the destination route.&n;&t; */
id|if_data1
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_addr
suffix:semicolon
id|if_data1-&gt;sin_addr.s_addr
op_assign
id|ppp_priv_area-&gt;ip_local
suffix:semicolon
id|if_data1-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
id|if_data2
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_dstaddr
suffix:semicolon
id|if_data2-&gt;sin_addr.s_addr
op_assign
id|ppp_priv_area-&gt;ip_remote
suffix:semicolon
id|if_data2-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFDSTADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* restore old block */
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Adding of route failed:&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s:&t;Local : %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ppp_priv_area-&gt;ip_local
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s:&t;Remote: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ppp_priv_area-&gt;ip_remote
)paren
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Remove Dynamic Route.&n; * Called when ppp interface disconnected.&n; */
DECL|function|remove_route
r_static
r_int
id|remove_route
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_int
id|ip_addr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
r_struct
id|ifreq
id|if_info
suffix:semicolon
r_struct
id|sockaddr_in
op_star
id|if_data1
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
id|ip_addr
op_assign
id|ifa-&gt;ifa_local
suffix:semicolon
multiline_comment|/* Set Local and remote addresses */
id|memset
c_func
(paren
op_amp
id|if_info
comma
l_int|0
comma
r_sizeof
(paren
id|if_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|if_info.ifr_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
multiline_comment|/* Change the local ip address of the interface to 0.&n;&t; * This will also delete the destination route.&n;&t; */
id|if_data1
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_addr
suffix:semicolon
id|if_data1-&gt;sin_addr.s_addr
op_assign
l_int|0
suffix:semicolon
id|if_data1-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* restore old block */
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Deleting dynamic route failed %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: PPP Deleting dynamic route %s successfuly&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ip_addr
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Perform the Interrupt Test by running the READ_CODE_VERSION command MAX_INTR&n; * _TEST_COUNTER times.&n; */
DECL|function|intr_test
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
multiline_comment|/* The critical flag is unset because during intialization (if_open) &n;&t; * we want the interrupts to be enabled so that when the wpp_isr is&n;&t; * called it does not exit due to critical flag set.&n;&t; */
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|ppp_set_intr_mode
c_func
(paren
id|card
comma
l_int|0x08
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_INTR_TEST_COUNTER
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Run command READ_CODE_VERSION */
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_READ_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
id|err
suffix:semicolon
id|err
op_assign
id|ppp_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
r_return
id|err
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Determine what type of UDP call it is. DRVSTATS or PTPIPEAB ?&n; */
DECL|function|udp_pkt_type
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
(brace
r_int
r_char
op_star
id|sendpacket
suffix:semicolon
r_int
r_char
id|buf2
(braket
l_int|5
)braket
suffix:semicolon
singleline_comment|//FIXME: Use the structure
id|ppp_udp_pkt_t
op_star
id|ppp_udp_pkt
op_assign
(paren
id|ppp_udp_pkt_t
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|sendpacket
op_assign
id|skb-&gt;data
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buf2
comma
op_amp
id|card-&gt;wandev.udp_port
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppp_udp_pkt-&gt;ip_pkt.ver_inet_hdr_length
op_eq
l_int|0x45
op_logical_and
multiline_comment|/* IP packet */
id|sendpacket
(braket
l_int|9
)braket
op_eq
l_int|0x11
op_logical_and
multiline_comment|/* UDP packet */
id|sendpacket
(braket
l_int|22
)braket
op_eq
id|buf2
(braket
l_int|1
)braket
op_logical_and
multiline_comment|/* UDP Port */
id|sendpacket
(braket
l_int|23
)braket
op_eq
id|buf2
(braket
l_int|0
)braket
op_logical_and
id|sendpacket
(braket
l_int|36
)braket
op_eq
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|28
)braket
op_eq
l_int|0x50
op_logical_and
multiline_comment|/* PTPIPEAB: Signature */
id|sendpacket
(braket
l_int|29
)braket
op_eq
l_int|0x54
op_logical_and
id|sendpacket
(braket
l_int|30
)braket
op_eq
l_int|0x50
op_logical_and
id|sendpacket
(braket
l_int|31
)braket
op_eq
l_int|0x49
op_logical_and
id|sendpacket
(braket
l_int|32
)braket
op_eq
l_int|0x50
op_logical_and
id|sendpacket
(braket
l_int|33
)braket
op_eq
l_int|0x45
op_logical_and
id|sendpacket
(braket
l_int|34
)braket
op_eq
l_int|0x41
op_logical_and
id|sendpacket
(braket
l_int|35
)braket
op_eq
l_int|0x42
)paren
(brace
r_return
id|UDP_PTPIPE_TYPE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|28
)braket
op_eq
l_int|0x44
op_logical_and
multiline_comment|/* DRVSTATS: Signature */
id|sendpacket
(braket
l_int|29
)braket
op_eq
l_int|0x52
op_logical_and
id|sendpacket
(braket
l_int|30
)braket
op_eq
l_int|0x56
op_logical_and
id|sendpacket
(braket
l_int|31
)braket
op_eq
l_int|0x53
op_logical_and
id|sendpacket
(braket
l_int|32
)braket
op_eq
l_int|0x54
op_logical_and
id|sendpacket
(braket
l_int|33
)braket
op_eq
l_int|0x41
op_logical_and
id|sendpacket
(braket
l_int|34
)braket
op_eq
l_int|0x54
op_logical_and
id|sendpacket
(braket
l_int|35
)braket
op_eq
l_int|0x53
)paren
(brace
r_return
id|UDP_DRVSTATS_TYPE
suffix:semicolon
)brace
r_else
r_return
id|UDP_INVALID_TYPE
suffix:semicolon
)brace
r_else
r_return
id|UDP_INVALID_TYPE
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Check to see if the packet to be transmitted contains a broadcast or&n; * multicast source IP address.&n; */
DECL|function|chk_bcast_mcast_addr
r_static
r_int
id|chk_bcast_mcast_addr
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|u32
id|src_ip_addr
suffix:semicolon
id|u32
id|broadcast_ip_addr
op_assign
l_int|0
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
multiline_comment|/* read the IP source address from the outgoing packet */
id|src_ip_addr
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* read the IP broadcast address for the device */
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
(brace
id|broadcast_ip_addr
op_assign
id|ifa-&gt;ifa_broadcast
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check if the IP Source Address is a Broadcast address */
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_BROADCAST
)paren
op_logical_and
(paren
id|src_ip_addr
op_eq
id|broadcast_ip_addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Broadcast Source Address silently discarded&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* check if the IP Source Address is a Multicast address */
r_if
c_cond
(paren
(paren
id|ntohl
c_func
(paren
id|src_ip_addr
)paren
op_ge
l_int|0xE0000001
)paren
op_logical_and
(paren
id|ntohl
c_func
(paren
id|src_ip_addr
)paren
op_le
l_int|0xFFFFFFFE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Multicast Source Address silently discarded&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s508_lock
r_void
id|s508_lock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
(brace
macro_line|#ifdef CONFIG_SMP
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
op_star
id|smp_flags
)paren
suffix:semicolon
macro_line|#else
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
macro_line|#endif                                                                     
)brace
DECL|function|s508_unlock
r_void
id|s508_unlock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
(brace
macro_line|#ifdef CONFIG_SMP
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
op_star
id|smp_flags
)paren
suffix:semicolon
macro_line|#else
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
macro_line|#endif           
)brace
DECL|function|read_connection_info
r_static
r_int
id|read_connection_info
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ppp_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|ppp_private_area_t
op_star
id|ppp_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ppp508_connect_info_t
op_star
id|ppp508_connect_info
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mb-&gt;cmd
comma
l_int|0
comma
r_sizeof
(paren
id|ppp_cmd_t
)paren
)paren
suffix:semicolon
id|mb-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|PPP_GET_CONNECTION_INFO
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|ppp_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
r_else
(brace
id|ppp508_connect_info
op_assign
(paren
id|ppp508_connect_info_t
op_star
)paren
id|mb-&gt;data
suffix:semicolon
id|ppp_priv_area-&gt;ip_remote
op_assign
id|ppp508_connect_info-&gt;ip_remote
suffix:semicolon
id|ppp_priv_area-&gt;ip_local
op_assign
id|ppp508_connect_info-&gt;ip_local
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/****** End *****************************************************************/
eof
