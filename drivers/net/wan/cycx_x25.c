multiline_comment|/*&n;* cycx_x25.c&t;Cyclom 2X WAN Link Driver.  X.25 module.&n;*&n;* Author:&t;Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n;*&n;* Copyright:&t;(c) 1998-2000 Arnaldo Carvalho de Melo&n;*&n;* Based on sdla_x25.c by Gene Kozin &lt;genek@compuserve.com&gt;&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* 2000/04/02&t;acme&t;&t;dprintk, cycx_debug&n;* &t;&t;&t;&t;fixed the bug introduced in get_dev_by_lcn and&n;* &t;&t;&t;&t;get_dev_by_dte_addr by the anonymous hacker&n;* &t;&t;&t;&t;that converted this driver to softnet&n;* 2000/01/08&t;acme&t;&t;cleanup&n;* 1999/10/27&t;acme&t;&t;use ARPHRD_HWX25 so that the X.25 stack know&n;*&t;&t;&t;&t;that we have a X.25 stack implemented in&n;*&t;&t;&t;&t;firmware onboard&n;* 1999/10/18&t;acme&t;&t;support for X.25 sockets in if_send,&n;*&t;&t;&t;&t;beware: socket(AF_X25...) IS WORK IN PROGRESS,&n;*&t;&t;&t;&t;TCP/IP over X.25 via wanrouter not affected,&n;*&t;&t;&t;&t;working.&n;* 1999/10/09&t;acme&t;&t;chan_disc renamed to chan_disconnect,&n;* &t;&t;&t;&t;began adding support for X.25 sockets:&n;* &t;&t;&t;&t;conf-&gt;protocol in new_if&n;* 1999/10/05&t;acme&t;&t;fixed return E... to return -E...&n;* 1999/08/10&t;acme&t;&t;serialized access to the card thru a spinlock&n;*&t;&t;&t;&t;in x25_exec&n;* 1999/08/09&t;acme&t;&t;removed per channel spinlocks&n;*&t;&t;&t;&t;removed references to enable_tx_int&n;* 1999/05/28&t;acme&t;&t;fixed nibble_to_byte, ackvc now properly treated&n;*&t;&t;&t;&t;if_send simplified&n;* 1999/05/25&t;acme&t;&t;fixed t1, t2, t21 &amp; t23 configuration&n;*&t;&t;&t;&t;use spinlocks instead of cli/sti in some points&n;* 1999/05/24&t;acme&t;&t;finished the x25_get_stat function&n;* 1999/05/23&t;acme&t;&t;dev-&gt;type = ARPHRD_X25 (tcpdump only works,&n;*&t;&t;&t;&t;AFAIT, with ARPHRD_ETHER). This seems to be&n;*&t;&t;&t;&t;needed to use socket(AF_X25)...&n;*&t;&t;&t;&t;Now the config file must specify a peer media&n;*&t;&t;&t;&t;address for svc channels over a crossover cable.&n;*&t;&t;&t;&t;Removed hold_timeout from x25_channel_t,&n;*&t;&t;&t;&t;not used.&n;*&t;&t;&t;&t;A little enhancement in the DEBUG processing&n;* 1999/05/22&t;acme&t;&t;go to DISCONNECTED in disconnect_confirm_intr,&n;*&t;&t;&t;&t;instead of chan_disc.&n;* 1999/05/16&t;marcelo&t;&t;fixed timer initialization in SVCs&n;* 1999/01/05&t;acme&t;&t;x25_configure now get (most of) all&n;*&t;&t;&t;&t;parameters...&n;* 1999/01/05&t;acme&t;&t;pktlen now (correctly) uses log2 (value&n;*&t;&t;&t;&t;configured)&n;* 1999/01/03&t;acme&t;&t;judicious use of data types (u8, u16, u32, etc)&n;* 1999/01/03&t;acme&t;&t;cyx_isr: reset dpmbase to acknowledge&n;*&t;&t;&t;&t;indication (interrupt from cyclom 2x)&n;* 1999/01/02&t;acme&t;&t;cyx_isr: first hackings...&n;* 1999/01/0203  acme &t;&t;when initializing an array don&squot;t give less&n;*&t;&t;&t;&t;elements than declared...&n;* &t;&t;&t;&t;example: char send_cmd[6] = &quot;?&bslash;xFF&bslash;x10&quot;;&n;*          &t;&t;&t;you&squot;ll gonna lose a couple hours, &squot;cause your&n;*&t;&t;&t;&t;brain won&squot;t admit that there&squot;s an error in the&n;*&t;&t;&t;&t;above declaration...  the side effect is that&n;*&t;&t;&t;&t;memset is put into the unresolved symbols&n;*&t;&t;&t;&t;instead of using the inline memset functions...&n;* 1999/01/02    acme &t;&t;began chan_connect, chan_send, x25_send&n;* 1998/12/31&t;acme&t;&t;x25_configure&n;*&t;&t;&t;&t;this code can be compiled as non module&n;* 1998/12/27&t;acme&t;&t;code cleanup&n;*&t;&t;&t;&t;IPX code wiped out! let&squot;s decrease code&n;*&t;&t;&t;&t;complexity for now, remember: I&squot;m learning! :)&n;*                               bps_to_speed_code OK&n;* 1998/12/26&t;acme&t;&t;Minimal debug code cleanup&n;* 1998/08/08&t;acme&t;&t;Initial version.&n;*/
DECL|macro|CYCLOMX_X25_DEBUG
mdefine_line|#define CYCLOMX_X25_DEBUG 1
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;linux/if_arp.h&gt;       /* ARPHRD_HWX25 */
macro_line|#include &lt;linux/cyclomx.h&gt;&t;/* Cyclom 2X common user API definitions */
macro_line|#include &lt;linux/cycx_x25.h&gt;&t;/* X.25 firmware API definitions */
multiline_comment|/* Defines &amp; Macros */
DECL|macro|MAX_CMD_RETRY
mdefine_line|#define MAX_CMD_RETRY&t;5
DECL|macro|X25_CHAN_MTU
mdefine_line|#define X25_CHAN_MTU&t;2048&t;/* unfragmented logical channel MTU */
multiline_comment|/* Data Structures */
multiline_comment|/* This is an extension of the &squot;struct net_device&squot; we create for each network&n;   interface to keep the rest of X.25 channel-specific data. */
DECL|struct|x25_channel
r_typedef
r_struct
id|x25_channel
(brace
multiline_comment|/* This member must be first. */
DECL|member|slave
r_struct
id|net_device
op_star
id|slave
suffix:semicolon
multiline_comment|/* WAN slave */
DECL|member|name
r_char
id|name
(braket
id|WAN_IFNAME_SZ
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* interface name, ASCIIZ */
DECL|member|addr
r_char
id|addr
(braket
id|WAN_ADDRESS_SZ
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* media address, ASCIIZ */
DECL|member|local_addr
r_char
op_star
id|local_addr
suffix:semicolon
multiline_comment|/* local media address, ASCIIZ -&n;&t;&t;&t;&t;&t;   svc thru crossover cable */
DECL|member|lcn
id|s16
id|lcn
suffix:semicolon
multiline_comment|/* logical channel number/conn.req.key*/
DECL|member|link
id|u8
id|link
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* timer used for svc channel disc. */
DECL|member|protocol
id|u16
id|protocol
suffix:semicolon
multiline_comment|/* ethertype, 0 - multiplexed */
DECL|member|svc
id|u8
id|svc
suffix:semicolon
multiline_comment|/* 0 - permanent, 1 - switched */
DECL|member|state
id|u8
id|state
suffix:semicolon
multiline_comment|/* channel state */
DECL|member|drop_sequence
id|u8
id|drop_sequence
suffix:semicolon
multiline_comment|/* mark sequence for dropping */
DECL|member|idle_tmout
id|u32
id|idle_tmout
suffix:semicolon
multiline_comment|/* sec, before disconnecting */
DECL|member|rx_skb
r_struct
id|sk_buff
op_star
id|rx_skb
suffix:semicolon
multiline_comment|/* receive socket buffer */
DECL|member|card
id|cycx_t
op_star
id|card
suffix:semicolon
multiline_comment|/* -&gt; owner */
DECL|member|ifstats
r_struct
id|net_device_stats
id|ifstats
suffix:semicolon
multiline_comment|/* interface statistics */
DECL|typedef|x25_channel_t
)brace
id|x25_channel_t
suffix:semicolon
multiline_comment|/* Function Prototypes */
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
comma
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
comma
id|del_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
comma
id|if_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
comma
id|if_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
comma
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
comma
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
comma
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Interrupt handlers */
r_static
r_void
id|cyx_isr
(paren
id|cycx_t
op_star
id|card
)paren
comma
id|tx_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|rx_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|log_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|stat_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|connect_confirm_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|disconnect_confirm_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|connect_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|disconnect_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
comma
id|spur_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
suffix:semicolon
multiline_comment|/* X.25 firmware interface functions */
r_static
r_int
id|x25_configure
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Config
op_star
id|conf
)paren
comma
id|x25_get_stats
(paren
id|cycx_t
op_star
id|card
)paren
comma
id|x25_send
(paren
id|cycx_t
op_star
id|card
comma
id|u8
id|link
comma
id|u8
id|lcn
comma
id|u8
id|bitm
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
comma
id|x25_connect_response
(paren
id|cycx_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
comma
id|x25_disconnect_response
(paren
id|cycx_t
op_star
id|card
comma
id|u8
id|link
comma
id|u8
id|lcn
)paren
suffix:semicolon
multiline_comment|/* channel functions */
r_static
r_int
id|chan_connect
(paren
r_struct
id|net_device
op_star
id|dev
)paren
comma
id|chan_send
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|chan_disconnect
(paren
r_struct
id|net_device
op_star
id|dev
)paren
comma
id|chan_x25_send_event
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|event
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
r_static
r_void
id|set_chan_state
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|state
)paren
comma
id|chan_timer
(paren
r_int
r_int
id|d
)paren
suffix:semicolon
r_static
r_void
id|nibble_to_byte
(paren
id|u8
op_star
id|s
comma
id|u8
op_star
id|d
comma
id|u8
id|len
comma
id|u8
id|nibble
)paren
comma
id|reset_timer
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|u8
id|bps_to_speed_code
(paren
id|u32
id|bps
)paren
suffix:semicolon
r_static
id|u8
id|log2
(paren
id|u32
id|n
)paren
suffix:semicolon
r_static
r_int
id|dec_to_uint
(paren
id|u8
op_star
id|str
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_struct
id|net_device
op_star
id|get_dev_by_lcn
(paren
id|wan_device_t
op_star
id|wandev
comma
id|s16
id|lcn
)paren
suffix:semicolon
r_static
r_struct
id|net_device
op_star
id|get_dev_by_dte_addr
(paren
id|wan_device_t
op_star
id|wandev
comma
r_char
op_star
id|dte
)paren
suffix:semicolon
macro_line|#ifdef CYCLOMX_X25_DEBUG
r_static
r_void
id|hex_dump
c_func
(paren
r_char
op_star
id|msg
comma
r_int
r_char
op_star
id|p
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|x25_dump_config
c_func
(paren
id|TX25Config
op_star
id|conf
)paren
suffix:semicolon
r_static
r_void
id|x25_dump_stats
c_func
(paren
id|TX25Stats
op_star
id|stats
)paren
suffix:semicolon
r_static
r_void
id|x25_dump_devs
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
macro_line|#else
DECL|macro|hex_dump
mdefine_line|#define hex_dump(msg, p, len)
DECL|macro|x25_dump_config
mdefine_line|#define x25_dump_config(conf)
DECL|macro|x25_dump_stats
mdefine_line|#define x25_dump_stats(stats)
DECL|macro|x25_dump_devs
mdefine_line|#define x25_dump_devs(wandev)
macro_line|#endif
multiline_comment|/* Public Functions */
multiline_comment|/* X.25 Protocol Initialization routine.&n; *&n; * This routine is called by the main Cyclom 2X module during setup.  At this&n; * point adapter is completely initialized and X.25 firmware is running.&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.  */
DECL|function|cyx_init
r_int
id|cyx_init
(paren
id|cycx_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
id|TX25Config
id|cfg
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_X25
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize protocol-specific fields */
id|card-&gt;mbox
op_assign
id|card-&gt;hw.dpmbase
op_plus
id|X25_MBOX_OFFS
suffix:semicolon
id|card-&gt;u.x.connection_keys
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.x.lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Configure adapter. Here we set reasonable defaults, then parse&n;&t; * device configuration structure and set configuration options.&n;&t; * Most configuration options are verified and corrected (if&n;&t; * necessary) since we can&squot;t rely on the adapter to do so and don&squot;t&n;&t; * want it to fail either. */
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|cfg
)paren
)paren
suffix:semicolon
id|cfg.link
op_assign
l_int|0
suffix:semicolon
id|cfg.clock
op_assign
id|conf-&gt;clocking
op_eq
id|WANOPT_EXTERNAL
ques
c_cond
l_int|8
suffix:colon
l_int|55
suffix:semicolon
id|cfg.speed
op_assign
id|bps_to_speed_code
c_func
(paren
id|conf-&gt;bps
)paren
suffix:semicolon
id|cfg.n3win
op_assign
l_int|7
suffix:semicolon
id|cfg.n2win
op_assign
l_int|2
suffix:semicolon
id|cfg.n2
op_assign
l_int|5
suffix:semicolon
id|cfg.nvc
op_assign
l_int|1
suffix:semicolon
id|cfg.npvc
op_assign
l_int|1
suffix:semicolon
id|cfg.flags
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* default = V35 */
id|cfg.t1
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* line carrier timeout */
id|cfg.t2
op_assign
l_int|29
suffix:semicolon
multiline_comment|/* tx timeout */
id|cfg.t21
op_assign
l_int|180
suffix:semicolon
multiline_comment|/* CALL timeout */
id|cfg.t23
op_assign
l_int|180
suffix:semicolon
multiline_comment|/* CLEAR timeout */
multiline_comment|/* adjust MTU */
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;mtu
op_logical_or
id|conf-&gt;mtu
op_ge
l_int|512
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|512
suffix:semicolon
r_else
r_if
c_cond
(paren
id|conf-&gt;mtu
op_ge
l_int|256
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|256
suffix:semicolon
r_else
r_if
c_cond
(paren
id|conf-&gt;mtu
op_ge
l_int|128
)paren
id|card-&gt;wandev.mtu
op_assign
l_int|128
suffix:semicolon
r_else
id|card-&gt;wandev.mtu
op_assign
l_int|64
suffix:semicolon
id|cfg.pktlen
op_assign
id|log2
c_func
(paren
id|card-&gt;wandev.mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;station
op_eq
id|WANOPT_DTE
)paren
(brace
id|cfg.locaddr
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* DTE */
id|cfg.remaddr
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* DCE */
)brace
r_else
(brace
id|cfg.locaddr
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* DCE */
id|cfg.remaddr
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* DTE */
)brace
r_if
c_cond
(paren
id|conf-&gt;interface
op_eq
id|WANOPT_RS232
)paren
id|cfg.flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME just reset the 2nd bit */
r_if
c_cond
(paren
id|conf-&gt;u.x25.hi_pvc
)paren
(brace
id|card-&gt;u.x.hi_pvc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.hi_pvc
comma
l_int|4095
)paren
suffix:semicolon
id|card-&gt;u.x.lo_pvc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.lo_pvc
comma
id|card-&gt;u.x.hi_pvc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;u.x25.hi_svc
)paren
(brace
id|card-&gt;u.x.hi_svc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.hi_svc
comma
l_int|4095
)paren
suffix:semicolon
id|card-&gt;u.x.lo_svc
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.lo_svc
comma
id|card-&gt;u.x.hi_svc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;u.x.lo_pvc
op_eq
l_int|255
)paren
id|cfg.npvc
op_assign
l_int|0
suffix:semicolon
r_else
id|cfg.npvc
op_assign
id|card-&gt;u.x.hi_pvc
op_minus
id|card-&gt;u.x.lo_pvc
op_plus
l_int|1
suffix:semicolon
id|cfg.nvc
op_assign
id|card-&gt;u.x.hi_svc
op_minus
id|card-&gt;u.x.lo_svc
op_plus
l_int|1
op_plus
id|cfg.npvc
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.hdlc_window
)paren
id|cfg.n2win
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.hdlc_window
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.pkt_window
)paren
id|cfg.n3win
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.pkt_window
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.t1
)paren
id|cfg.t1
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t1
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.t2
)paren
id|cfg.t2
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t2
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.t11_t21
)paren
id|cfg.t21
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t11_t21
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.t13_t23
)paren
id|cfg.t23
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.t13_t23
comma
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.x25.n2
)paren
id|cfg.n2
op_assign
id|min
c_func
(paren
id|conf-&gt;u.x25.n2
comma
l_int|30
)paren
suffix:semicolon
multiline_comment|/* initialize adapter */
r_if
c_cond
(paren
id|x25_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Initialize protocol-specific fields of adapter data space */
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|card-&gt;wandev.station
op_assign
id|conf-&gt;station
suffix:semicolon
id|card-&gt;isr
op_assign
id|cyx_isr
suffix:semicolon
id|card-&gt;exec
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;wandev.update
op_assign
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
id|del_if
suffix:semicolon
id|card-&gt;wandev.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* WAN Device Driver Entry Points */
multiline_comment|/* Update device status &amp; statistics. */
DECL|function|update
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
op_logical_neg
id|wandev
op_logical_or
op_logical_neg
id|wandev
op_member_access_from_pointer
r_private
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|x25_get_stats
c_func
(paren
id|wandev
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created) */
DECL|function|new_if
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|cycx_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;name
(braket
l_int|0
)braket
op_logical_or
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize private data */
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|x25_channel_t
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chan
comma
l_int|0
comma
r_sizeof
(paren
id|x25_channel_t
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|chan-&gt;name
comma
id|conf-&gt;name
)paren
suffix:semicolon
id|chan-&gt;card
op_assign
id|card
suffix:semicolon
id|chan-&gt;link
op_assign
id|conf-&gt;port
suffix:semicolon
id|chan-&gt;protocol
op_assign
id|conf-&gt;protocol
ques
c_cond
id|ETH_P_X25
suffix:colon
id|ETH_P_IP
suffix:semicolon
id|chan-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* only used in svc connected thru crossover cable */
id|chan-&gt;local_addr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;addr
(braket
l_int|0
)braket
op_eq
l_char|&squot;@&squot;
)paren
(brace
multiline_comment|/* SVC */
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|conf-&gt;local_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OG
id|WAN_ADDRESS_SZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s local addr too long!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;local_addr
op_assign
id|kmalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;local_addr
)paren
(brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|strncpy
c_func
(paren
id|chan-&gt;local_addr
comma
id|conf-&gt;local_addr
comma
id|WAN_ADDRESS_SZ
)paren
suffix:semicolon
)brace
id|chan-&gt;svc
op_assign
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|chan-&gt;addr
comma
op_amp
id|conf-&gt;addr
(braket
l_int|1
)braket
comma
id|WAN_ADDRESS_SZ
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|chan-&gt;timer
)paren
suffix:semicolon
id|chan-&gt;timer.function
op_assign
id|chan_timer
suffix:semicolon
id|chan-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
multiline_comment|/* Set channel timeouts (default if not specified) */
id|chan-&gt;idle_tmout
op_assign
id|conf-&gt;idle_timeout
ques
c_cond
id|conf-&gt;idle_timeout
suffix:colon
l_int|90
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_digit
c_func
(paren
id|conf-&gt;addr
(braket
l_int|0
)braket
)paren
)paren
(brace
multiline_comment|/* PVC */
id|s16
id|lcn
op_assign
id|dec_to_uint
c_func
(paren
id|conf-&gt;addr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcn
op_ge
id|card-&gt;u.x.lo_pvc
op_logical_and
id|lcn
op_le
id|card-&gt;u.x.hi_pvc
)paren
id|chan-&gt;lcn
op_assign
id|lcn
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PVC %u is out of range on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|lcn
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid media address on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;local_addr
)paren
id|kfree
c_func
(paren
id|chan-&gt;local_addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* prepare network device data space for registration */
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|chan
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Delete logical channel. */
DECL|function|del_if
r_static
r_int
id|del_if
(paren
id|wan_device_t
op_star
id|wandev
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;local_addr
)paren
id|kfree
c_func
(paren
id|chan-&gt;local_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_eq
id|WAN_CONNECTED
)paren
id|del_timer
c_func
(paren
op_amp
id|chan-&gt;timer
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Network Device Interface */
multiline_comment|/* Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration. */
DECL|function|if_init
r_static
r_int
id|if_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|if_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|if_stats
suffix:semicolon
multiline_comment|/* Initialize media-specific parameters */
id|dev-&gt;mtu
op_assign
id|X25_CHAN_MTU
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_HWX25
suffix:semicolon
multiline_comment|/* ARP h/w type */
id|dev-&gt;hard_header_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* media header length */
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* hardware address length */
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;svc
)paren
op_star
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|chan-&gt;lcn
)paren
suffix:semicolon
multiline_comment|/* Initialize hardware parameters (just for reference) */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
(paren
r_int
r_int
)paren
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
(paren
r_int
r_int
)paren
(paren
id|wandev-&gt;maddr
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
)paren
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_NOARP
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length */
id|dev-&gt;tx_queue_len
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Initialize socket buffers */
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Open network interface.&n; * o prevent module from unloading by incrementing use count&n; * o if link is disconnected then initiate connection&n; *&n; * Return 0 if O.k. or errno.  */
DECL|function|if_open
r_static
r_int
id|if_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* only one open is allowed */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cyclomx_mod_inc_use_count
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Close network interface.&n; * o reset flags.&n; * o if there&squot;s no more open channels then disconnect physical link. */
DECL|function|if_close
r_static
r_int
id|if_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_eq
id|WAN_CONNECTED
op_logical_or
id|chan-&gt;state
op_eq
id|WAN_CONNECTING
)paren
id|chan_disconnect
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cyclomx_mod_dec_use_count
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Build media header.&n; * o encapsulate packet according to encapsulation type.&n; *&n; * The trick here is to put packet type (Ethertype) into &squot;protocol&squot; field of&n; * the socket buffer, so that we don&squot;t forget it.  If encapsulation fails,&n; * set skb-&gt;protocol to 0 and discard packet later.&n; *&n; * Return:&t;media header length. */
DECL|function|if_header
r_static
r_int
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
id|skb-&gt;protocol
op_assign
id|type
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* * Re-build media header.&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved */
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Send a packet on a network interface.&n; * o set busy flag (marks start of the transmission).&n; * o check link state. If link is not up, then drop the packet.&n; * o check channel status. If it&squot;s down then initiate a call.&n; * o pass a packet to corresponding WAN device.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * 2. Setting tbusy flag will inhibit further transmit requests from the&n; *    protocol stack and can be used for flow control with protocol layer. */
DECL|function|if_send
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;svc
)paren
id|chan-&gt;protocol
op_assign
id|skb-&gt;protocol
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chan-&gt;svc
op_logical_and
id|chan-&gt;protocol
op_logical_and
id|chan-&gt;protocol
op_ne
id|skb-&gt;protocol
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unsupported Ethertype 0x%04X on interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|skb-&gt;protocol
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_errors
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;protocol
op_eq
id|ETH_P_IP
)paren
(brace
r_switch
c_cond
(paren
id|chan-&gt;state
)paren
(brace
r_case
id|WAN_DISCONNECTED
suffix:colon
r_if
c_cond
(paren
id|chan_connect
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* fall thru */
r_case
id|WAN_CONNECTED
suffix:colon
id|reset_timer
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_send
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* chan-&gt;protocol == ETH_P_X25 */
r_switch
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Connect request */
id|chan_connect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|free_packet
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Disconnect request */
id|chan_disconnect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|free_packet
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unknown %d x25-iface request on %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|skb-&gt;data
(braket
l_int|0
)braket
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_errors
suffix:semicolon
r_goto
id|free_packet
suffix:semicolon
)brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Remove control byte */
id|reset_timer
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_send
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
multiline_comment|/* prepare for future retransmissions */
id|skb_push
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|free_packet
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get Ethernet-style interface statistics.&n; * Return a pointer to struct net_device_stats */
DECL|function|if_stats
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
id|chan
ques
c_cond
op_amp
id|chan-&gt;ifstats
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Interrupt Handlers */
multiline_comment|/* X.25 Interrupt Service Routine. */
DECL|function|cyx_isr
r_static
r_void
id|cyx_isr
(paren
id|cycx_t
op_star
id|card
)paren
(brace
id|TX25Cmd
id|cmd
suffix:semicolon
id|u16
id|z
op_assign
l_int|0
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|0
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|X25_RXMBOX_OFFS
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd.command
)paren
(brace
r_case
id|X25_DATA_INDICATION
suffix:colon
id|rx_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_ACK_FROM_VC
suffix:colon
id|tx_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_LOG
suffix:colon
id|log_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_STATISTIC
suffix:colon
id|stat_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_CONNECT_CONFIRM
suffix:colon
id|connect_confirm_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_CONNECT_INDICATION
suffix:colon
id|connect_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_DISCONNECT_INDICATION
suffix:colon
id|disconnect_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_DISCONNECT_CONFIRM
suffix:colon
id|disconnect_confirm_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_LINE_ON
suffix:colon
id|cyclomx_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X25_LINE_OFF
suffix:colon
id|cyclomx_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|spur_intr
c_func
(paren
id|card
comma
op_amp
id|cmd
)paren
suffix:semicolon
multiline_comment|/* unwanted interrupt */
)brace
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0
comma
op_amp
id|z
comma
r_sizeof
(paren
id|z
)paren
)paren
suffix:semicolon
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|X25_RXMBOX_OFFS
comma
op_amp
id|z
comma
r_sizeof
(paren
id|z
)paren
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Transmit interrupt handler.&n; *&t;o Release socket buffer&n; *&t;o Clear &squot;tbusy&squot; flag */
DECL|function|tx_intr
r_static
r_void
id|tx_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
id|u8
id|lcn
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|lcn
comma
r_sizeof
(paren
id|lcn
)paren
)paren
suffix:semicolon
multiline_comment|/* unbusy device and then dev_tint(); */
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
id|lcn
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|card-&gt;buff_int_mode_unbusy
op_assign
l_int|1
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:ackvc for inexistent lcn %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
)paren
suffix:semicolon
)brace
multiline_comment|/* Receive interrupt handler.&n; * This routine handles fragmented IP packets using M-bit according to the&n; * RFC1356.&n; * o map logical channel number to network interface.&n; * o allocate socket buffer or append received packet to the existing one.&n; * o if M-bit is reset (i.e. it&squot;s the last packet in a sequence) then &n; *   decapsulate packet and pass socket buffer to the protocol stack.&n; *&n; * Notes:&n; * 1. When allocating a socket buffer, if M-bit is set then more data is&n; *    coming and we have to allocate buffer for the maximum IP packet size&n; *    expected on this channel.&n; * 2. If something goes wrong and X.25 packet has to be dropped (e.g. no&n; *    socket buffers available) the whole packet sequence must be discarded. */
DECL|function|rx_intr
r_static
r_void
id|rx_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u8
id|bitm
comma
id|lcn
suffix:semicolon
r_int
id|pktlen
op_assign
id|cmd-&gt;len
op_minus
l_int|5
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|lcn
comma
r_sizeof
(paren
id|lcn
)paren
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|4
comma
op_amp
id|bitm
comma
r_sizeof
(paren
id|bitm
)paren
)paren
suffix:semicolon
id|bitm
op_and_assign
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
id|lcn
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: receiving on orphaned LCN %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|reset_timer
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;drop_sequence
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bitm
)paren
id|chan-&gt;drop_sequence
op_assign
l_int|0
suffix:semicolon
r_else
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|chan-&gt;rx_skb
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate new socket buffer */
r_int
id|bufsize
op_assign
id|bitm
ques
c_cond
id|dev-&gt;mtu
suffix:colon
id|pktlen
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
(paren
id|chan-&gt;protocol
op_eq
id|ETH_P_X25
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_plus
id|bufsize
op_plus
id|dev-&gt;hard_header_len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|chan-&gt;drop_sequence
op_assign
l_int|1
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;protocol
op_eq
id|ETH_P_X25
)paren
multiline_comment|/* X.25 socket layer control */
multiline_comment|/* 0 = data packet (dev_alloc_skb zeroed skb-&gt;data) */
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|chan-&gt;protocol
)paren
suffix:semicolon
id|chan-&gt;rx_skb
op_assign
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OL
id|pktlen
)paren
(brace
multiline_comment|/* No room for the packet. Call off the whole thing! */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|chan-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|bitm
)paren
id|chan-&gt;drop_sequence
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unexpectedly long packet sequence &quot;
l_string|&quot;on interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_length_errors
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Append packet to the socket buffer  */
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|5
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pktlen
)paren
comma
id|pktlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bitm
)paren
r_return
suffix:semicolon
multiline_comment|/* more data is coming */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* timestamp */
id|chan-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* dequeue packet */
op_increment
id|chan-&gt;ifstats.rx_packets
suffix:semicolon
id|chan-&gt;ifstats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Connect interrupt handler. */
DECL|function|connect_intr
r_static
r_void
id|connect_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
id|u8
id|d
(braket
l_int|32
)braket
comma
id|loc
(braket
l_int|24
)braket
comma
id|rem
(braket
l_int|24
)braket
suffix:semicolon
id|u8
id|lcn
comma
id|sizeloc
comma
id|sizerem
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|lcn
comma
r_sizeof
(paren
id|lcn
)paren
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|5
comma
op_amp
id|sizeloc
comma
r_sizeof
(paren
id|sizeloc
)paren
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|6
comma
id|d
comma
id|cmd-&gt;len
op_minus
l_int|6
)paren
suffix:semicolon
id|sizerem
op_assign
id|sizeloc
op_rshift
l_int|4
suffix:semicolon
id|sizeloc
op_and_assign
l_int|0x0F
suffix:semicolon
id|loc
(braket
l_int|0
)braket
op_assign
id|rem
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|sizeloc
)paren
id|nibble_to_byte
c_func
(paren
id|d
comma
id|loc
comma
id|sizeloc
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sizerem
)paren
id|nibble_to_byte
c_func
(paren
id|d
op_plus
(paren
id|sizeloc
op_rshift
l_int|1
)paren
comma
id|rem
comma
id|sizerem
comma
id|sizeloc
op_amp
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;connect_intr:lcn=%d, local=%s, remote=%s&bslash;n&quot;
comma
id|lcn
comma
id|loc
comma
id|rem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|get_dev_by_dte_addr
c_func
(paren
id|wandev
comma
id|rem
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: connect not expected: remote %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|rem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|chan-&gt;lcn
op_assign
id|lcn
suffix:semicolon
id|x25_connect_response
c_func
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
multiline_comment|/* Connect confirm interrupt handler. */
DECL|function|connect_confirm_intr
r_static
r_void
id|connect_confirm_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
id|u8
id|lcn
comma
id|key
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|lcn
comma
r_sizeof
(paren
id|lcn
)paren
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|1
comma
op_amp
id|key
comma
r_sizeof
(paren
id|key
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: connect_confirm_intr:lcn=%d, key=%d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
comma
id|key
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
op_minus
id|key
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|clear_bit
c_func
(paren
op_decrement
id|key
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;u.x.connection_keys
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: connect confirm not expected: lcn %d, &quot;
l_string|&quot;key=%d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
comma
id|key
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
op_decrement
id|key
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;u.x.connection_keys
)paren
suffix:semicolon
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|chan-&gt;lcn
op_assign
id|lcn
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
multiline_comment|/* Disconnect confirm interrupt handler. */
DECL|function|disconnect_confirm_intr
r_static
r_void
id|disconnect_confirm_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|u8
id|lcn
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|lcn
comma
r_sizeof
(paren
id|lcn
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: disconnect_confirm_intr:lcn=%d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
id|lcn
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Invalid channel, discard packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:disconnect confirm not expected!:lcn %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|lcn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
multiline_comment|/* disconnect interrupt handler. */
DECL|function|disconnect_intr
r_static
r_void
id|disconnect_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|u8
id|lcn
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|lcn
comma
r_sizeof
(paren
id|lcn
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;disconnect_intr:lcn=%d&bslash;n&quot;
comma
id|lcn
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|get_dev_by_lcn
c_func
(paren
id|wandev
comma
id|lcn
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|x25_disconnect_response
c_func
(paren
id|card
comma
id|chan-&gt;link
comma
id|lcn
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
r_else
id|x25_disconnect_response
c_func
(paren
id|card
comma
l_int|0
comma
id|lcn
)paren
suffix:semicolon
)brace
multiline_comment|/* LOG interrupt handler. */
DECL|function|log_intr
r_static
r_void
id|log_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
macro_line|#if CYCLOMX_X25_DEBUG
r_char
id|bf
(braket
l_int|20
)braket
suffix:semicolon
id|u16
id|size
comma
id|toread
comma
id|link
comma
id|msg_code
suffix:semicolon
id|u8
id|code
comma
id|routine
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|msg_code
comma
r_sizeof
(paren
id|msg_code
)paren
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|2
comma
op_amp
id|link
comma
r_sizeof
(paren
id|link
)paren
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|4
comma
op_amp
id|size
comma
r_sizeof
(paren
id|size
)paren
)paren
suffix:semicolon
multiline_comment|/* at most 20 bytes are available... thanks to Daniela :) */
id|toread
op_assign
id|size
OL
l_int|20
ques
c_cond
id|size
suffix:colon
l_int|20
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|10
comma
op_amp
id|bf
comma
id|toread
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|10
op_plus
id|toread
comma
op_amp
id|code
comma
l_int|1
)paren
suffix:semicolon
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
op_plus
l_int|10
op_plus
id|toread
op_plus
l_int|1
comma
op_amp
id|routine
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cyx_isr: X25_LOG (0x4500) indic.:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cmd-&gt;buf=0x%X&bslash;n&quot;
comma
id|cmd-&gt;buf
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Log message code=0x%X&bslash;n&quot;
comma
id|msg_code
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Link=%d&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;log code=0x%X&bslash;n&quot;
comma
id|code
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;log routine=0x%X&bslash;n&quot;
comma
id|routine
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Message size=%d&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
id|hex_dump
c_func
(paren
l_string|&quot;Message&quot;
comma
id|bf
comma
id|toread
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* STATISTIC interrupt handler. */
DECL|function|stat_intr
r_static
r_void
id|stat_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|cycx_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|cmd-&gt;buf
comma
op_amp
id|card-&gt;u.x.stats
comma
r_sizeof
(paren
id|card-&gt;u.x.stats
)paren
)paren
suffix:semicolon
id|hex_dump
c_func
(paren
l_string|&quot;stat_intr&quot;
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|card-&gt;u.x.stats
comma
r_sizeof
(paren
id|card-&gt;u.x.stats
)paren
)paren
suffix:semicolon
id|x25_dump_stats
c_func
(paren
op_amp
id|card-&gt;u.x.stats
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|card-&gt;wait_stats
)paren
suffix:semicolon
)brace
multiline_comment|/* Spurious interrupt handler.&n; * o print a warning&n; * If number of spurious interrupts exceeded some limit, then ??? */
DECL|function|spur_intr
r_static
r_void
id|spur_intr
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Cmd
op_star
id|cmd
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt (0x%X)!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd-&gt;command
)paren
suffix:semicolon
)brace
macro_line|#ifdef CYCLOMX_X25_DEBUG
DECL|function|hex_dump
r_static
r_void
id|hex_dump
c_func
(paren
r_char
op_star
id|msg
comma
r_int
r_char
op_star
id|p
comma
r_int
id|len
)paren
(brace
r_int
r_char
id|hex
(braket
l_int|1024
)braket
comma
op_star
id|phex
op_assign
id|hex
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
(paren
r_sizeof
(paren
id|hex
)paren
op_div
l_int|2
)paren
)paren
id|len
op_assign
(paren
r_sizeof
(paren
id|hex
)paren
op_div
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|sprintf
c_func
(paren
id|phex
comma
l_string|&quot;%02x&quot;
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
id|phex
op_add_assign
l_int|2
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|msg
comma
id|hex
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Cyclom 2X Firmware-Specific Functions */
multiline_comment|/* Exec X.25 command. */
DECL|function|x25_exec
r_static
r_int
id|x25_exec
(paren
id|cycx_t
op_star
id|card
comma
r_int
id|command
comma
r_int
id|link
comma
r_void
op_star
id|d1
comma
r_int
id|len1
comma
r_void
op_star
id|d2
comma
r_int
id|len2
)paren
(brace
id|TX25Cmd
id|c
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|addr
op_assign
l_int|0x1200
op_plus
l_int|0x2E0
op_star
id|link
op_plus
l_int|0x1E2
suffix:semicolon
id|u8
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|c.command
op_assign
id|command
suffix:semicolon
id|c.link
op_assign
id|link
suffix:semicolon
id|c.len
op_assign
id|len1
op_plus
id|len2
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;u.x.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* write command */
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|X25_MBOX_OFFS
comma
op_amp
id|c
comma
r_sizeof
(paren
id|c
)paren
op_minus
r_sizeof
(paren
id|c.buf
)paren
)paren
suffix:semicolon
multiline_comment|/* write X.25 data */
r_if
c_cond
(paren
id|d1
)paren
(brace
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|d1
comma
id|len1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d2
)paren
(brace
r_if
c_cond
(paren
id|len2
OG
l_int|254
)paren
(brace
id|u32
id|addr1
op_assign
l_int|0xA00
op_plus
l_int|0x400
op_star
id|link
suffix:semicolon
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
op_plus
id|len1
comma
id|d2
comma
l_int|249
)paren
suffix:semicolon
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr1
comma
(paren
(paren
id|u8
op_star
)paren
id|d2
)paren
op_plus
l_int|249
comma
id|len2
op_minus
l_int|249
)paren
suffix:semicolon
)brace
r_else
id|cycx_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
op_plus
id|len1
comma
id|d2
comma
id|len2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* generate interruption, executing command */
id|cycx_intr
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
multiline_comment|/* wait till card-&gt;mbox == 0 */
r_do
(brace
id|err
op_assign
id|cycx_exec
c_func
(paren
id|card-&gt;mbox
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|retry
op_decrement
op_logical_and
id|err
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;u.x.lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Configure adapter. */
DECL|function|x25_configure
r_static
r_int
id|x25_configure
(paren
id|cycx_t
op_star
id|card
comma
id|TX25Config
op_star
id|conf
)paren
(brace
r_struct
(brace
id|u16
id|nlinks
suffix:semicolon
id|TX25Config
id|conf
(braket
l_int|2
)braket
suffix:semicolon
)brace
id|x25_cmd_conf
suffix:semicolon
id|memset
(paren
op_amp
id|x25_cmd_conf
comma
l_int|0
comma
r_sizeof
(paren
id|x25_cmd_conf
)paren
)paren
suffix:semicolon
id|x25_cmd_conf.nlinks
op_assign
l_int|2
suffix:semicolon
id|x25_cmd_conf.conf
(braket
l_int|0
)braket
op_assign
op_star
id|conf
suffix:semicolon
multiline_comment|/* FIXME: we need to find a way in the wanrouter framework&n;&t;&t;  to configure the second link, for now lets use it&n;&t;&t;  with the same config from the first link, fixing&n;&t;&t;  the interface type to RS232, the speed in 38400 and&n;&t;&t;  the clock to external */
id|x25_cmd_conf.conf
(braket
l_int|1
)braket
op_assign
op_star
id|conf
suffix:semicolon
id|x25_cmd_conf.conf
(braket
l_int|1
)braket
dot
id|link
op_assign
l_int|1
suffix:semicolon
id|x25_cmd_conf.conf
(braket
l_int|1
)braket
dot
id|speed
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* 38400 */
id|x25_cmd_conf.conf
(braket
l_int|1
)braket
dot
id|clock
op_assign
l_int|8
suffix:semicolon
id|x25_cmd_conf.conf
(braket
l_int|1
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default = RS232 */
id|x25_dump_config
c_func
(paren
op_amp
id|x25_cmd_conf.conf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|x25_dump_config
c_func
(paren
op_amp
id|x25_cmd_conf.conf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
id|x25_exec
c_func
(paren
id|card
comma
id|X25_CONFIG
comma
l_int|0
comma
op_amp
id|x25_cmd_conf
comma
r_sizeof
(paren
id|x25_cmd_conf
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Get protocol statistics. */
DECL|function|x25_get_stats
r_static
r_int
id|x25_get_stats
(paren
id|cycx_t
op_star
id|card
)paren
(brace
multiline_comment|/* the firmware expects 20 in the size field!!!&n;&t;   thanks to Daniela */
r_int
id|err
op_assign
id|x25_exec
c_func
(paren
id|card
comma
id|X25_STATISTIC
comma
l_int|0
comma
l_int|NULL
comma
l_int|20
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|card-&gt;wait_stats
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|card-&gt;wandev.stats.rx_packets
op_assign
id|card-&gt;u.x.stats.n2_rx_frames
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|card-&gt;u.x.stats.rx_over_errors
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|card-&gt;u.x.stats.rx_crc_errors
suffix:semicolon
id|card-&gt;wandev.stats.rx_length_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|card-&gt;wandev.stats.rx_frame_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|card-&gt;u.x.stats.rx_aborts
suffix:semicolon
id|card-&gt;wandev.stats.rx_dropped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|card-&gt;wandev.stats.rx_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|card-&gt;wandev.stats.tx_packets
op_assign
id|card-&gt;u.x.stats.n2_tx_frames
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|card-&gt;u.x.stats.tx_aborts
suffix:semicolon
id|card-&gt;wandev.stats.tx_dropped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|card-&gt;wandev.stats.collisions
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|card-&gt;wandev.stats.tx_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not available from fw */
id|x25_dump_devs
c_func
(paren
op_amp
id|card-&gt;wandev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* return the number of nibbles */
DECL|function|byte_to_nibble
r_static
r_int
id|byte_to_nibble
c_func
(paren
id|u8
op_star
id|s
comma
id|u8
op_star
id|d
comma
r_char
op_star
id|nibble
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|nibble
op_logical_and
op_star
id|s
)paren
(brace
id|d
(braket
id|i
)braket
op_or_assign
op_star
id|s
op_increment
op_minus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|nibble
op_assign
l_int|0
suffix:semicolon
op_increment
id|i
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|s
)paren
(brace
id|d
(braket
id|i
)braket
op_assign
(paren
op_star
id|s
op_minus
l_char|&squot;0&squot;
)paren
op_lshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|s
op_plus
l_int|1
)paren
)paren
id|d
(braket
id|i
)braket
op_or_assign
op_star
(paren
id|s
op_plus
l_int|1
)paren
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_else
(brace
op_star
id|nibble
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
op_increment
id|i
suffix:semicolon
id|s
op_add_assign
l_int|2
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
DECL|function|nibble_to_byte
r_static
r_void
id|nibble_to_byte
c_func
(paren
id|u8
op_star
id|s
comma
id|u8
op_star
id|d
comma
id|u8
id|len
comma
id|u8
id|nibble
)paren
(brace
r_if
c_cond
(paren
id|nibble
)paren
(brace
op_star
id|d
op_increment
op_assign
l_char|&squot;0&squot;
op_plus
(paren
op_star
id|s
op_increment
op_amp
l_int|0x0F
)paren
suffix:semicolon
op_decrement
id|len
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
)paren
(brace
op_star
id|d
op_increment
op_assign
l_char|&squot;0&squot;
op_plus
(paren
op_star
id|s
op_rshift
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|len
)paren
(brace
op_star
id|d
op_increment
op_assign
l_char|&squot;0&squot;
op_plus
(paren
op_star
id|s
op_amp
l_int|0x0F
)paren
suffix:semicolon
op_decrement
id|len
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
op_increment
id|s
suffix:semicolon
)brace
op_star
id|d
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
multiline_comment|/* Place X.25 call. */
DECL|function|x25_place_call
r_static
r_int
id|x25_place_call
(paren
id|cycx_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
(brace
r_int
id|err
op_assign
l_int|0
comma
id|len
suffix:semicolon
r_char
id|d
(braket
l_int|64
)braket
comma
id|nibble
op_assign
l_int|0
comma
id|mylen
op_assign
id|chan-&gt;local_addr
ques
c_cond
id|strlen
c_func
(paren
id|chan-&gt;local_addr
)paren
suffix:colon
l_int|0
comma
id|remotelen
op_assign
id|strlen
c_func
(paren
id|chan-&gt;addr
)paren
suffix:semicolon
id|u8
id|key
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.x.connection_keys
op_eq
op_complement
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: too many simultaneous connection &quot;
l_string|&quot;requests!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|key
op_assign
id|ffz
c_func
(paren
id|card-&gt;u.x.connection_keys
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|key
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;u.x.connection_keys
)paren
suffix:semicolon
op_increment
id|key
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s:x25_place_call:key=%d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|key
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
id|d
(braket
l_int|1
)braket
op_assign
id|key
suffix:semicolon
multiline_comment|/* user key */
id|d
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
id|d
(braket
l_int|4
)braket
op_assign
l_int|0x0B
suffix:semicolon
id|len
op_assign
id|byte_to_nibble
c_func
(paren
id|chan-&gt;addr
comma
id|d
op_plus
l_int|6
comma
op_amp
id|nibble
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;local_addr
)paren
id|len
op_add_assign
id|byte_to_nibble
c_func
(paren
id|chan-&gt;local_addr
comma
id|d
op_plus
l_int|6
op_plus
id|len
comma
op_amp
id|nibble
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nibble
)paren
op_increment
id|len
suffix:semicolon
id|d
(braket
l_int|5
)braket
op_assign
id|mylen
op_lshift
l_int|4
op_or
id|remotelen
suffix:semicolon
id|d
(braket
l_int|6
op_plus
id|len
op_plus
l_int|1
)braket
op_assign
l_int|0xCC
suffix:semicolon
multiline_comment|/* TCP/IP over X.25, thanks to Daniela :) */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|x25_exec
c_func
(paren
id|card
comma
id|X25_CONNECT_REQUEST
comma
id|chan-&gt;link
comma
op_amp
id|d
comma
l_int|7
op_plus
id|len
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
id|clear_bit
c_func
(paren
op_decrement
id|key
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;u.x.connection_keys
)paren
suffix:semicolon
r_else
id|chan-&gt;lcn
op_assign
op_minus
id|key
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Place X.25 CONNECT RESPONSE. */
DECL|function|x25_connect_response
r_static
r_int
id|x25_connect_response
(paren
id|cycx_t
op_star
id|card
comma
id|x25_channel_t
op_star
id|chan
)paren
(brace
id|u8
id|d
(braket
l_int|8
)braket
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
id|d
(braket
l_int|0
)braket
op_assign
id|d
(braket
l_int|3
)braket
op_assign
id|chan-&gt;lcn
suffix:semicolon
id|d
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
id|d
(braket
l_int|4
)braket
op_assign
l_int|0x0F
suffix:semicolon
id|d
(braket
l_int|7
)braket
op_assign
l_int|0xCC
suffix:semicolon
multiline_comment|/* TCP/IP over X.25, thanks Daniela */
r_return
id|x25_exec
c_func
(paren
id|card
comma
id|X25_CONNECT_RESPONSE
comma
id|chan-&gt;link
comma
op_amp
id|d
comma
l_int|8
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Place X.25 DISCONNECT RESPONSE.  */
DECL|function|x25_disconnect_response
r_static
r_int
id|x25_disconnect_response
(paren
id|cycx_t
op_star
id|card
comma
id|u8
id|link
comma
id|u8
id|lcn
)paren
(brace
r_char
id|d
(braket
l_int|5
)braket
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
id|d
(braket
l_int|0
)braket
op_assign
id|d
(braket
l_int|3
)braket
op_assign
id|lcn
suffix:semicolon
id|d
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
id|d
(braket
l_int|4
)braket
op_assign
l_int|0x17
suffix:semicolon
r_return
id|x25_exec
c_func
(paren
id|card
comma
id|X25_DISCONNECT_RESPONSE
comma
id|link
comma
op_amp
id|d
comma
l_int|5
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear X.25 call.  */
DECL|function|x25_clear_call
r_static
r_int
id|x25_clear_call
(paren
id|cycx_t
op_star
id|card
comma
id|u8
id|link
comma
id|u8
id|lcn
comma
id|u8
id|cause
comma
id|u8
id|diagn
)paren
(brace
id|u8
id|d
(braket
l_int|7
)braket
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
id|d
(braket
l_int|0
)braket
op_assign
id|d
(braket
l_int|3
)braket
op_assign
id|lcn
suffix:semicolon
id|d
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
id|d
(braket
l_int|4
)braket
op_assign
l_int|0x13
suffix:semicolon
id|d
(braket
l_int|5
)braket
op_assign
id|cause
suffix:semicolon
id|d
(braket
l_int|6
)braket
op_assign
id|diagn
suffix:semicolon
r_return
id|x25_exec
c_func
(paren
id|card
comma
id|X25_DISCONNECT_REQUEST
comma
id|link
comma
id|d
comma
l_int|7
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Send X.25 data packet. */
DECL|function|x25_send
r_static
r_int
id|x25_send
(paren
id|cycx_t
op_star
id|card
comma
id|u8
id|link
comma
id|u8
id|lcn
comma
id|u8
id|bitm
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
(brace
id|u8
id|d
(braket
)braket
op_assign
l_string|&quot;?&bslash;xFF&bslash;x10??&quot;
suffix:semicolon
id|d
(braket
l_int|0
)braket
op_assign
id|d
(braket
l_int|3
)braket
op_assign
id|lcn
suffix:semicolon
id|d
(braket
l_int|4
)braket
op_assign
id|bitm
suffix:semicolon
r_return
id|x25_exec
c_func
(paren
id|card
comma
id|X25_DATA_REQUEST
comma
id|link
comma
op_amp
id|d
comma
l_int|5
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* Miscellaneous */
multiline_comment|/* Find network device by its channel number.  */
DECL|function|get_dev_by_lcn
r_static
r_struct
id|net_device
op_star
id|get_dev_by_lcn
(paren
id|wan_device_t
op_star
id|wandev
comma
id|s16
id|lcn
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|wandev-&gt;dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|chan
op_assign
(paren
id|x25_channel_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;lcn
op_eq
id|lcn
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/* Find network device by its remote dte address. */
DECL|function|get_dev_by_dte_addr
r_static
r_struct
id|net_device
op_star
id|get_dev_by_dte_addr
(paren
id|wan_device_t
op_star
id|wandev
comma
r_char
op_star
id|dte
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|wandev-&gt;dev
suffix:semicolon
id|x25_channel_t
op_star
id|chan
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|chan
op_assign
(paren
id|x25_channel_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|chan-&gt;addr
comma
id|dte
)paren
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/* Initiate connection on the logical channel.&n; * o for PVC we just get channel configuration&n; * o for SVCs place an X.25 call&n; *&n; * Return:&t;0&t;connected&n; *&t;&t;&gt;0&t;connection in progress&n; *&t;&t;&lt;0&t;failure */
DECL|function|chan_connect
r_static
r_int
id|chan_connect
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;addr
(braket
l_int|0
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* no destination address */
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: placing X.25 call to %s...&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x25_place_call
c_func
(paren
id|card
comma
id|chan
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Disconnect logical channel.&n; * o if SVC then clear X.25 call */
DECL|function|chan_disconnect
r_static
r_void
id|chan_disconnect
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
(brace
id|x25_clear_call
c_func
(paren
id|chan-&gt;card
comma
id|chan-&gt;link
comma
id|chan-&gt;lcn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTING
)paren
suffix:semicolon
)brace
r_else
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
multiline_comment|/* Called by kernel timer */
DECL|function|chan_timer
r_static
r_void
id|chan_timer
(paren
r_int
r_int
id|d
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|d
suffix:semicolon
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_eq
id|WAN_CONNECTED
)paren
id|chan_disconnect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: chan_timer for svc (%s) not connected!&bslash;n&quot;
comma
id|chan-&gt;card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Set logical channel state. */
DECL|function|set_chan_state
r_static
r_void
id|set_chan_state
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|state
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|u32
id|flags
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|string_state
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_ne
id|state
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;svc
op_logical_and
id|chan-&gt;state
op_eq
id|WAN_CONNECTED
)paren
id|del_timer
c_func
(paren
op_amp
id|chan-&gt;timer
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|string_state
op_assign
l_string|&quot;connected!&quot;
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|chan-&gt;lcn
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|reset_timer
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;protocol
op_eq
id|ETH_P_X25
)paren
id|chan_x25_send_event
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|string_state
op_assign
l_string|&quot;connecting...&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTING
suffix:colon
id|string_state
op_assign
l_string|&quot;disconnecting...&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|string_state
op_assign
l_string|&quot;disconnected!&quot;
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;lcn
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;protocol
op_eq
id|ETH_P_X25
)paren
id|chan_x25_send_event
c_func
(paren
id|dev
comma
l_int|2
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
comma
id|string_state
)paren
suffix:semicolon
id|chan-&gt;state
op_assign
id|state
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Send packet on a logical channel.&n; *&t;When this function is called, tx_skb field of the channel data space&n; *&t;points to the transmit socket buffer.  When transmission is complete,&n; *&t;release socket buffer and reset &squot;tbusy&squot; flag.&n; *&n; * Return:&t;0&t;- transmission complete&n; *&t;&t;1&t;- busy&n; *&n; * Notes:&n; * 1. If packet length is greater than MTU for this channel, we&squot;ll fragment&n; *    the packet into &squot;complete sequence&squot; using M-bit.&n; * 2. When transmission is complete, an event notification should be issued&n; *    to the router.  */
DECL|function|chan_send
r_static
r_int
id|chan_send
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|cycx_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_int
id|bitm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* final packet */
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|card-&gt;wandev.mtu
)paren
(brace
id|len
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|bitm
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* set M-bit (more data) */
)brace
r_if
c_cond
(paren
id|x25_send
c_func
(paren
id|card
comma
id|chan-&gt;link
comma
id|chan-&gt;lcn
comma
id|bitm
comma
id|len
comma
id|skb-&gt;data
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bitm
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
op_increment
id|chan-&gt;ifstats.tx_packets
suffix:semicolon
id|chan-&gt;ifstats.tx_bytes
op_add_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Send event (connection, disconnection, etc) to X.25 socket layer */
DECL|function|chan_x25_send_event
r_static
r_void
id|chan_x25_send_event
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|event
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|1
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FUNCTION__
l_string|&quot;: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ptr
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|event
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_X25
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert line speed in bps to a number used by cyclom 2x code. */
DECL|function|bps_to_speed_code
r_static
id|u8
id|bps_to_speed_code
(paren
id|u32
id|bps
)paren
(brace
id|u8
id|number
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* defaults to the lowest (1200) speed ;&gt; */
r_if
c_cond
(paren
id|bps
op_ge
l_int|512000
)paren
id|number
op_assign
l_int|8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|256000
)paren
id|number
op_assign
l_int|7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|64000
)paren
id|number
op_assign
l_int|6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|38400
)paren
id|number
op_assign
l_int|5
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|19200
)paren
id|number
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|9600
)paren
id|number
op_assign
l_int|3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|4800
)paren
id|number
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bps
op_ge
l_int|2400
)paren
id|number
op_assign
l_int|1
suffix:semicolon
r_return
id|number
suffix:semicolon
)brace
multiline_comment|/* log base 2 */
DECL|function|log2
r_static
id|u8
id|log2
(paren
id|u32
id|n
)paren
(brace
id|u8
id|log
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|n
OG
l_int|1
)paren
(brace
id|n
op_rshift_assign
l_int|1
suffix:semicolon
op_increment
id|log
suffix:semicolon
)brace
r_return
id|log
suffix:semicolon
)brace
multiline_comment|/* Convert decimal string to unsigned integer.&n; * If len != 0 then only &squot;len&squot; characters of the string are converted. */
DECL|function|dec_to_uint
r_static
r_int
id|dec_to_uint
(paren
id|u8
op_star
id|str
comma
r_int
id|len
)paren
(brace
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
op_logical_and
id|is_digit
c_func
(paren
op_star
id|str
)paren
suffix:semicolon
op_increment
id|str
comma
op_decrement
id|len
)paren
id|val
op_assign
(paren
id|val
op_star
l_int|10
)paren
op_plus
(paren
op_star
id|str
op_minus
(paren
r_int
)paren
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|reset_timer
r_static
r_void
id|reset_timer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;svc
)paren
id|mod_timer
c_func
(paren
op_amp
id|chan-&gt;timer
comma
id|jiffies
op_plus
id|chan-&gt;idle_tmout
op_star
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#ifdef CYCLOMX_X25_DEBUG
DECL|function|x25_dump_config
r_static
r_void
id|x25_dump_config
c_func
(paren
id|TX25Config
op_star
id|conf
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;X.25 configuration&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;-----------------&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;link number=%d&bslash;n&quot;
comma
id|conf-&gt;link
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;line speed=%d&bslash;n&quot;
comma
id|conf-&gt;speed
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clock=%sternal&bslash;n&quot;
comma
id|conf-&gt;clock
op_eq
l_int|8
ques
c_cond
l_string|&quot;Ex&quot;
suffix:colon
l_string|&quot;In&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;# level 2 retransm.=%d&bslash;n&quot;
comma
id|conf-&gt;n2
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;level 2 window=%d&bslash;n&quot;
comma
id|conf-&gt;n2win
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;level 3 window=%d&bslash;n&quot;
comma
id|conf-&gt;n3win
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;# logical channels=%d&bslash;n&quot;
comma
id|conf-&gt;nvc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;level 3 pkt len=%d&bslash;n&quot;
comma
id|conf-&gt;pktlen
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;my address=%d&bslash;n&quot;
comma
id|conf-&gt;locaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;remote address=%d&bslash;n&quot;
comma
id|conf-&gt;remaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;t1=%d seconds&bslash;n&quot;
comma
id|conf-&gt;t1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;t2=%d seconds&bslash;n&quot;
comma
id|conf-&gt;t2
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;t21=%d seconds&bslash;n&quot;
comma
id|conf-&gt;t21
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;# PVCs=%d&bslash;n&quot;
comma
id|conf-&gt;npvc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;t23=%d seconds&bslash;n&quot;
comma
id|conf-&gt;t23
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;flags=0x%x&bslash;n&quot;
comma
id|conf-&gt;flags
)paren
suffix:semicolon
)brace
DECL|function|x25_dump_stats
r_static
r_void
id|x25_dump_stats
c_func
(paren
id|TX25Stats
op_star
id|stats
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;X.25 statistics&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;--------------&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;rx_crc_errors=%d&bslash;n&quot;
comma
id|stats-&gt;rx_crc_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;rx_over_errors=%d&bslash;n&quot;
comma
id|stats-&gt;rx_over_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;n2_tx_frames=%d&bslash;n&quot;
comma
id|stats-&gt;n2_tx_frames
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;n2_rx_frames=%d&bslash;n&quot;
comma
id|stats-&gt;n2_rx_frames
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tx_timeouts=%d&bslash;n&quot;
comma
id|stats-&gt;tx_timeouts
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;rx_timeouts=%d&bslash;n&quot;
comma
id|stats-&gt;rx_timeouts
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;n3_tx_packets=%d&bslash;n&quot;
comma
id|stats-&gt;n3_tx_packets
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;n3_rx_packets=%d&bslash;n&quot;
comma
id|stats-&gt;n3_rx_packets
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tx_aborts=%d&bslash;n&quot;
comma
id|stats-&gt;tx_aborts
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;rx_aborts=%d&bslash;n&quot;
comma
id|stats-&gt;rx_aborts
)paren
suffix:semicolon
)brace
DECL|function|x25_dump_devs
r_static
r_void
id|x25_dump_devs
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|wandev-&gt;dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;X.25 dev states&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;name: addr:           txoff:  protocol:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;---------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
id|x25_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%-5.5s %-15.15s   %d     ETH_P_%s&bslash;n&quot;
comma
id|chan-&gt;name
comma
id|chan-&gt;addr
comma
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
comma
id|chan-&gt;protocol
op_eq
id|ETH_P_IP
ques
c_cond
l_string|&quot;IP&quot;
suffix:colon
l_string|&quot;X25&quot;
)paren
suffix:semicolon
id|dev
op_assign
id|chan-&gt;slave
suffix:semicolon
)brace
)brace
macro_line|#endif /* CYCLOMX_X25_DEBUG */
multiline_comment|/* End */
eof
