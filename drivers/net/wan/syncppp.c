multiline_comment|/*&n; *&t;NET3:&t;A (fairly minimal) implementation of synchronous PPP for Linux&n; *&t;&t;as well as a CISCO HDLC implementation. See the copyright &n; *&t;&t;message below for the original source.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the license, or (at your option) any later version.&n; *&n; *&t;Note however. This code is also used in a different form by FreeBSD.&n; *&t;Therefore when making any non OS specific change please consider&n; *&t;contributing it back to the original author under the terms&n; *&t;below in addition.&n; *&t;&t;-- Alan&n; *&n; *&t;Port for Linux-2.1 by Jan &quot;Yenya&quot; Kasprzak &lt;kas@fi.muni.cz&gt;&n; */
multiline_comment|/*&n; * Synchronous PPP/Cisco link level subroutines.&n; * Keepalive protocol implemented in both Cisco and PPP modes.&n; *&n; * Copyright (C) 1994 Cronyx Ltd.&n; * Author: Serge Vakulenko, &lt;vak@zebub.msk.su&gt;&n; *&n; * This software is distributed with NO WARRANTIES, not even the implied&n; * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n; *&n; * Authors grant any other persons or organisations permission to use&n; * or modify this software as long as this message is kept with the software,&n; * all derivative works or modified versions.&n; *&n; * Version 1.9, Wed Oct  4 18:58:15 MSK 1995&n; *&n; * $Id: syncppp.c,v 1.18 2000/04/11 05:25:31 asj Exp $&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/pkt_sched.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &quot;syncppp.h&quot;
DECL|macro|MAXALIVECNT
mdefine_line|#define MAXALIVECNT     6               /* max. alive packets */
DECL|macro|PPP_ALLSTATIONS
mdefine_line|#define PPP_ALLSTATIONS 0xff            /* All-Stations broadcast address */
DECL|macro|PPP_UI
mdefine_line|#define PPP_UI          0x03            /* Unnumbered Information */
DECL|macro|PPP_IP
mdefine_line|#define PPP_IP          0x0021          /* Internet Protocol */
DECL|macro|PPP_ISO
mdefine_line|#define PPP_ISO         0x0023          /* ISO OSI Protocol */
DECL|macro|PPP_XNS
mdefine_line|#define PPP_XNS         0x0025          /* Xerox NS Protocol */
DECL|macro|PPP_IPX
mdefine_line|#define PPP_IPX         0x002b          /* Novell IPX Protocol */
DECL|macro|PPP_LCP
mdefine_line|#define PPP_LCP         0xc021          /* Link Control Protocol */
DECL|macro|PPP_IPCP
mdefine_line|#define PPP_IPCP        0x8021          /* Internet Protocol Control Protocol */
DECL|macro|LCP_CONF_REQ
mdefine_line|#define LCP_CONF_REQ    1               /* PPP LCP configure request */
DECL|macro|LCP_CONF_ACK
mdefine_line|#define LCP_CONF_ACK    2               /* PPP LCP configure acknowledge */
DECL|macro|LCP_CONF_NAK
mdefine_line|#define LCP_CONF_NAK    3               /* PPP LCP configure negative ack */
DECL|macro|LCP_CONF_REJ
mdefine_line|#define LCP_CONF_REJ    4               /* PPP LCP configure reject */
DECL|macro|LCP_TERM_REQ
mdefine_line|#define LCP_TERM_REQ    5               /* PPP LCP terminate request */
DECL|macro|LCP_TERM_ACK
mdefine_line|#define LCP_TERM_ACK    6               /* PPP LCP terminate acknowledge */
DECL|macro|LCP_CODE_REJ
mdefine_line|#define LCP_CODE_REJ    7               /* PPP LCP code reject */
DECL|macro|LCP_PROTO_REJ
mdefine_line|#define LCP_PROTO_REJ   8               /* PPP LCP protocol reject */
DECL|macro|LCP_ECHO_REQ
mdefine_line|#define LCP_ECHO_REQ    9               /* PPP LCP echo request */
DECL|macro|LCP_ECHO_REPLY
mdefine_line|#define LCP_ECHO_REPLY  10              /* PPP LCP echo reply */
DECL|macro|LCP_DISC_REQ
mdefine_line|#define LCP_DISC_REQ    11              /* PPP LCP discard request */
DECL|macro|LCP_OPT_MRU
mdefine_line|#define LCP_OPT_MRU             1       /* maximum receive unit */
DECL|macro|LCP_OPT_ASYNC_MAP
mdefine_line|#define LCP_OPT_ASYNC_MAP       2       /* async control character map */
DECL|macro|LCP_OPT_AUTH_PROTO
mdefine_line|#define LCP_OPT_AUTH_PROTO      3       /* authentication protocol */
DECL|macro|LCP_OPT_QUAL_PROTO
mdefine_line|#define LCP_OPT_QUAL_PROTO      4       /* quality protocol */
DECL|macro|LCP_OPT_MAGIC
mdefine_line|#define LCP_OPT_MAGIC           5       /* magic number */
DECL|macro|LCP_OPT_RESERVED
mdefine_line|#define LCP_OPT_RESERVED        6       /* reserved */
DECL|macro|LCP_OPT_PROTO_COMP
mdefine_line|#define LCP_OPT_PROTO_COMP      7       /* protocol field compression */
DECL|macro|LCP_OPT_ADDR_COMP
mdefine_line|#define LCP_OPT_ADDR_COMP       8       /* address/control field compression */
DECL|macro|IPCP_CONF_REQ
mdefine_line|#define IPCP_CONF_REQ   LCP_CONF_REQ    /* PPP IPCP configure request */
DECL|macro|IPCP_CONF_ACK
mdefine_line|#define IPCP_CONF_ACK   LCP_CONF_ACK    /* PPP IPCP configure acknowledge */
DECL|macro|IPCP_CONF_NAK
mdefine_line|#define IPCP_CONF_NAK   LCP_CONF_NAK    /* PPP IPCP configure negative ack */
DECL|macro|IPCP_CONF_REJ
mdefine_line|#define IPCP_CONF_REJ   LCP_CONF_REJ    /* PPP IPCP configure reject */
DECL|macro|IPCP_TERM_REQ
mdefine_line|#define IPCP_TERM_REQ   LCP_TERM_REQ    /* PPP IPCP terminate request */
DECL|macro|IPCP_TERM_ACK
mdefine_line|#define IPCP_TERM_ACK   LCP_TERM_ACK    /* PPP IPCP terminate acknowledge */
DECL|macro|IPCP_CODE_REJ
mdefine_line|#define IPCP_CODE_REJ   LCP_CODE_REJ    /* PPP IPCP code reject */
DECL|macro|CISCO_MULTICAST
mdefine_line|#define CISCO_MULTICAST         0x8f    /* Cisco multicast address */
DECL|macro|CISCO_UNICAST
mdefine_line|#define CISCO_UNICAST           0x0f    /* Cisco unicast address */
DECL|macro|CISCO_KEEPALIVE
mdefine_line|#define CISCO_KEEPALIVE         0x8035  /* Cisco keepalive protocol */
DECL|macro|CISCO_ADDR_REQ
mdefine_line|#define CISCO_ADDR_REQ          0       /* Cisco address request */
DECL|macro|CISCO_ADDR_REPLY
mdefine_line|#define CISCO_ADDR_REPLY        1       /* Cisco address reply */
DECL|macro|CISCO_KEEPALIVE_REQ
mdefine_line|#define CISCO_KEEPALIVE_REQ     2       /* Cisco keepalive request */
DECL|struct|ppp_header
r_struct
id|ppp_header
(brace
DECL|member|address
id|u8
id|address
suffix:semicolon
DECL|member|control
id|u8
id|control
suffix:semicolon
DECL|member|protocol
id|u16
id|protocol
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|PPP_HEADER_LEN
mdefine_line|#define PPP_HEADER_LEN          sizeof (struct ppp_header)
DECL|struct|lcp_header
r_struct
id|lcp_header
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|ident
id|u8
id|ident
suffix:semicolon
DECL|member|len
id|u16
id|len
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|LCP_HEADER_LEN
mdefine_line|#define LCP_HEADER_LEN          sizeof (struct lcp_header)
DECL|struct|cisco_packet
r_struct
id|cisco_packet
(brace
DECL|member|type
id|u32
id|type
suffix:semicolon
DECL|member|par1
id|u32
id|par1
suffix:semicolon
DECL|member|par2
id|u32
id|par2
suffix:semicolon
DECL|member|rel
id|u16
id|rel
suffix:semicolon
DECL|member|time0
id|u16
id|time0
suffix:semicolon
DECL|member|time1
id|u16
id|time1
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|CISCO_PACKET_LEN
mdefine_line|#define CISCO_PACKET_LEN 18
DECL|macro|CISCO_BIG_PACKET_LEN
mdefine_line|#define CISCO_BIG_PACKET_LEN 20
DECL|variable|spppq
r_static
r_struct
id|sppp
op_star
id|spppq
suffix:semicolon
DECL|variable|sppp_keepalive_timer
r_static
r_struct
id|timer_list
id|sppp_keepalive_timer
suffix:semicolon
DECL|variable|spppq_lock
r_static
id|spinlock_t
id|spppq_lock
suffix:semicolon
r_static
r_void
id|sppp_keepalive
(paren
r_int
r_int
id|dummy
)paren
suffix:semicolon
r_static
r_void
id|sppp_cp_send
(paren
r_struct
id|sppp
op_star
id|sp
comma
id|u16
id|proto
comma
id|u8
id|type
comma
id|u8
id|ident
comma
id|u16
id|len
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|sppp_cisco_send
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_int
id|type
comma
r_int
id|par1
comma
r_int
id|par2
)paren
suffix:semicolon
r_static
r_void
id|sppp_lcp_input
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|sk_buff
op_star
id|m
)paren
suffix:semicolon
r_static
r_void
id|sppp_cisco_input
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|sk_buff
op_star
id|m
)paren
suffix:semicolon
r_static
r_void
id|sppp_ipcp_input
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|sk_buff
op_star
id|m
)paren
suffix:semicolon
r_static
r_void
id|sppp_lcp_open
(paren
r_struct
id|sppp
op_star
id|sp
)paren
suffix:semicolon
r_static
r_void
id|sppp_ipcp_open
(paren
r_struct
id|sppp
op_star
id|sp
)paren
suffix:semicolon
r_static
r_int
id|sppp_lcp_conf_parse_options
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|lcp_header
op_star
id|h
comma
r_int
id|len
comma
id|u32
op_star
id|magic
)paren
suffix:semicolon
r_static
r_void
id|sppp_cp_timeout
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_char
op_star
id|sppp_lcp_type_name
(paren
id|u8
id|type
)paren
suffix:semicolon
r_static
r_char
op_star
id|sppp_ipcp_type_name
(paren
id|u8
id|type
)paren
suffix:semicolon
r_static
r_void
id|sppp_print_bytes
(paren
id|u8
op_star
id|p
comma
id|u16
id|len
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Interface down stub&n; */
DECL|function|if_down
r_static
r_void
id|if_down
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
op_amp
(paren
(paren
r_struct
id|ppp_device
op_star
)paren
id|dev
)paren
op_member_access_from_pointer
id|sppp
suffix:semicolon
id|sp-&gt;pp_link_state
op_assign
id|SPPP_LINK_DOWN
suffix:semicolon
)brace
multiline_comment|/*&n; * Timeout routine activations.&n; */
DECL|function|sppp_set_timeout
r_static
r_void
id|sppp_set_timeout
c_func
(paren
r_struct
id|sppp
op_star
id|p
comma
r_int
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|p-&gt;pp_flags
op_amp
id|PP_TIMO
)paren
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|p-&gt;pp_timer
)paren
suffix:semicolon
id|p-&gt;pp_timer.function
op_assign
id|sppp_cp_timeout
suffix:semicolon
id|p-&gt;pp_timer.expires
op_assign
id|jiffies
op_plus
id|s
op_star
id|HZ
suffix:semicolon
id|p-&gt;pp_timer.data
op_assign
(paren
r_int
r_int
)paren
id|p
suffix:semicolon
id|p-&gt;pp_flags
op_or_assign
id|PP_TIMO
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|p-&gt;pp_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|sppp_clear_timeout
r_static
r_void
id|sppp_clear_timeout
c_func
(paren
r_struct
id|sppp
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;pp_flags
op_amp
id|PP_TIMO
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|p-&gt;pp_timer
)paren
suffix:semicolon
id|p-&gt;pp_flags
op_and_assign
op_complement
id|PP_TIMO
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;sppp_input -&t;receive and process a WAN PPP frame&n; *&t;@skb:&t;The buffer to process&n; *&t;@dev:&t;The device it arrived on&n; *&n; *&t;This can be called directly by cards that do not have&n; *&t;timing constraints but is normally called from the network layer&n; *&t;after interrupt servicing to process frames queued via netif_rx().&n; *&n; *&t;We process the options in the card. If the frame is destined for&n; *&t;the protocol stacks then it requeues the frame for the upper level&n; *&t;protocol. If it is a control from it is processed and discarded&n; *&t;here.&n; */
DECL|function|sppp_input
r_void
id|sppp_input
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ppp_header
op_star
id|h
suffix:semicolon
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
(brace
multiline_comment|/* Count received bytes, add FCS and one flag */
id|sp-&gt;ibytes
op_add_assign
id|skb-&gt;len
op_plus
l_int|3
suffix:semicolon
id|sp-&gt;ipkts
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
op_le
id|PPP_HEADER_LEN
)paren
(brace
multiline_comment|/* Too small packet, drop it. */
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: input packet is too small, %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Get PPP header. */
id|h
op_assign
(paren
r_struct
id|ppp_header
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ppp_header
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|h-&gt;address
)paren
(brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Invalid PPP packet. */
id|invalid
suffix:colon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid input packet &lt;0x%x 0x%x 0x%x&gt;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|h-&gt;address
comma
id|h-&gt;control
comma
id|ntohs
(paren
id|h-&gt;protocol
)paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
r_case
id|PPP_ALLSTATIONS
suffix:colon
r_if
c_cond
(paren
id|h-&gt;control
op_ne
id|PPP_UI
)paren
r_goto
id|invalid
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: PPP packet in Cisco mode &lt;0x%x 0x%x 0x%x&gt;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|h-&gt;address
comma
id|h-&gt;control
comma
id|ntohs
(paren
id|h-&gt;protocol
)paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ntohs
(paren
id|h-&gt;protocol
)paren
)paren
(brace
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_eq
id|LCP_STATE_OPENED
)paren
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_PROTO_REJ
comma
op_increment
id|sp-&gt;pp_seq
comma
id|skb-&gt;len
op_plus
l_int|2
comma
op_amp
id|h-&gt;protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid input protocol &lt;0x%x 0x%x 0x%x&gt;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|h-&gt;address
comma
id|h-&gt;control
comma
id|ntohs
(paren
id|h-&gt;protocol
)paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
r_case
id|PPP_LCP
suffix:colon
id|sppp_lcp_input
(paren
id|sp
comma
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|PPP_IPCP
suffix:colon
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_eq
id|LCP_STATE_OPENED
)paren
id|sppp_ipcp_input
(paren
id|sp
comma
id|skb
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;IPCP when still waiting LCP finish.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|PPP_IP
suffix:colon
r_if
c_cond
(paren
id|sp-&gt;ipcp.state
op_eq
id|IPCP_STATE_OPENED
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Yow an IP frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef IPX
r_case
id|PPP_IPX
suffix:colon
multiline_comment|/* IPX IPXCP not implemented yet */
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_eq
id|LCP_STATE_OPENED
)paren
(brace
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
r_case
id|CISCO_MULTICAST
suffix:colon
r_case
id|CISCO_UNICAST
suffix:colon
multiline_comment|/* Don&squot;t check the control field here (RFC 1547). */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: Cisco packet in PPP mode &lt;0x%x 0x%x 0x%x&gt;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|h-&gt;address
comma
id|h-&gt;control
comma
id|ntohs
(paren
id|h-&gt;protocol
)paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ntohs
(paren
id|h-&gt;protocol
)paren
)paren
(brace
r_default
suffix:colon
r_goto
id|invalid
suffix:semicolon
r_case
id|CISCO_KEEPALIVE
suffix:colon
id|sppp_cisco_input
(paren
id|sp
comma
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#ifdef CONFIG_INET
r_case
id|ETH_P_IP
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IPX
r_case
id|ETH_P_IPX
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|variable|sppp_input
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_input
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Handle transmit packets.&n; */
DECL|function|sppp_hard_header
r_static
r_int
id|sppp_hard_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|__u16
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ppp_header
op_star
id|h
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ppp_header
)paren
)paren
suffix:semicolon
id|h
op_assign
(paren
r_struct
id|ppp_header
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
(brace
id|h-&gt;address
op_assign
id|CISCO_UNICAST
suffix:semicolon
id|h-&gt;control
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|h-&gt;address
op_assign
id|PPP_ALLSTATIONS
suffix:semicolon
id|h-&gt;control
op_assign
id|PPP_UI
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
(brace
id|h-&gt;protocol
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|h-&gt;protocol
op_assign
id|htons
c_func
(paren
id|PPP_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
id|h-&gt;protocol
op_assign
id|htons
c_func
(paren
id|PPP_IPX
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
r_sizeof
(paren
r_struct
id|ppp_header
)paren
suffix:semicolon
)brace
DECL|function|sppp_rebuild_header
r_static
r_int
id|sppp_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Send keepalive packets, every 10 seconds.&n; */
DECL|function|sppp_keepalive
r_static
r_void
id|sppp_keepalive
(paren
r_int
r_int
id|dummy
)paren
(brace
r_struct
id|sppp
op_star
id|sp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spppq_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sp
op_assign
id|spppq
suffix:semicolon
id|sp
suffix:semicolon
id|sp
op_assign
id|sp-&gt;pp_next
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;pp_if
suffix:semicolon
multiline_comment|/* Keepalive mode disabled or channel down? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_KEEPALIVE
)paren
op_logical_or
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* No keepalive in PPP mode if LCP not opened yet. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
op_logical_and
id|sp-&gt;lcp.state
op_ne
id|LCP_STATE_OPENED
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_alivecnt
op_eq
id|MAXALIVECNT
)paren
(brace
multiline_comment|/* No keepalive packets got.  Stop the interface. */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: protocol down&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|if_down
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
)paren
(brace
multiline_comment|/* Shut down the PPP link. */
id|sp-&gt;lcp.magic
op_assign
id|jiffies
suffix:semicolon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Initiate negotiation. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sp-&gt;pp_alivecnt
op_le
id|MAXALIVECNT
)paren
op_increment
id|sp-&gt;pp_alivecnt
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
id|sppp_cisco_send
(paren
id|sp
comma
id|CISCO_KEEPALIVE_REQ
comma
op_increment
id|sp-&gt;pp_seq
comma
id|sp-&gt;pp_rseq
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_eq
id|LCP_STATE_OPENED
)paren
(brace
r_int
id|nmagic
op_assign
id|htonl
(paren
id|sp-&gt;lcp.magic
)paren
suffix:semicolon
id|sp-&gt;lcp.echoid
op_assign
op_increment
id|sp-&gt;pp_seq
suffix:semicolon
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_ECHO_REQ
comma
id|sp-&gt;lcp.echoid
comma
l_int|4
comma
op_amp
id|nmagic
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spppq_lock
comma
id|flags
)paren
suffix:semicolon
id|sppp_keepalive_timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sppp_keepalive_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle incoming PPP Link Control Protocol packets.&n; */
DECL|function|sppp_lcp_input
r_static
r_void
id|sppp_lcp_input
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|lcp_header
op_star
id|h
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;pp_if
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|u8
op_star
id|p
comma
id|opt
(braket
l_int|6
)braket
suffix:semicolon
id|u32
id|rmagic
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid lcp packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|h
op_assign
(paren
r_struct
id|lcp_header
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|lcp_header
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
(brace
r_char
id|state
op_assign
l_char|&squot;?&squot;
suffix:semicolon
r_switch
c_cond
(paren
id|sp-&gt;lcp.state
)paren
(brace
r_case
id|LCP_STATE_CLOSED
suffix:colon
id|state
op_assign
l_char|&squot;C&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_ACK_RCVD
suffix:colon
id|state
op_assign
l_char|&squot;R&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_ACK_SENT
suffix:colon
id|state
op_assign
l_char|&squot;S&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_OPENED
suffix:colon
id|state
op_assign
l_char|&squot;O&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: lcp input(%c): %d bytes &lt;%s id=%xh len=%xh&quot;
comma
id|dev-&gt;name
comma
id|state
comma
id|len
comma
id|sppp_lcp_type_name
(paren
id|h-&gt;type
)paren
comma
id|h-&gt;ident
comma
id|ntohs
(paren
id|h-&gt;len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|4
)paren
id|sppp_print_bytes
(paren
(paren
id|u8
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|ntohs
(paren
id|h-&gt;len
)paren
)paren
id|len
op_assign
id|ntohs
(paren
id|h-&gt;len
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|h-&gt;type
)paren
(brace
r_default
suffix:colon
multiline_comment|/* Unknown packet type -- send Code-Reject packet. */
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_CODE_REJ
comma
op_increment
id|sp-&gt;pp_seq
comma
id|skb-&gt;len
comma
id|h
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_CONF_REQ
suffix:colon
r_if
c_cond
(paren
id|len
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: invalid lcp configure request packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|4
op_logical_and
op_logical_neg
id|sppp_lcp_conf_parse_options
(paren
id|sp
comma
id|h
comma
id|len
comma
op_amp
id|rmagic
)paren
)paren
r_goto
id|badreq
suffix:semicolon
r_if
c_cond
(paren
id|rmagic
op_eq
id|sp-&gt;lcp.magic
)paren
(brace
multiline_comment|/* Local and remote magics equal -- loopback? */
r_if
c_cond
(paren
id|sp-&gt;pp_loopcnt
op_ge
id|MAXALIVECNT
op_star
l_int|5
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: loopback&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;pp_loopcnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
id|if_down
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: conf req: magic glitch&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_increment
id|sp-&gt;pp_loopcnt
suffix:semicolon
multiline_comment|/* MUST send Conf-Nack packet. */
id|rmagic
op_assign
op_complement
id|sp-&gt;lcp.magic
suffix:semicolon
id|opt
(braket
l_int|0
)braket
op_assign
id|LCP_OPT_MAGIC
suffix:semicolon
id|opt
(braket
l_int|1
)braket
op_assign
r_sizeof
(paren
id|opt
)paren
suffix:semicolon
id|opt
(braket
l_int|2
)braket
op_assign
id|rmagic
op_rshift
l_int|24
suffix:semicolon
id|opt
(braket
l_int|3
)braket
op_assign
id|rmagic
op_rshift
l_int|16
suffix:semicolon
id|opt
(braket
l_int|4
)braket
op_assign
id|rmagic
op_rshift
l_int|8
suffix:semicolon
id|opt
(braket
l_int|5
)braket
op_assign
id|rmagic
suffix:semicolon
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_CONF_NAK
comma
id|h-&gt;ident
comma
r_sizeof
(paren
id|opt
)paren
comma
op_amp
id|opt
)paren
suffix:semicolon
id|badreq
suffix:colon
r_switch
c_cond
(paren
id|sp-&gt;lcp.state
)paren
(brace
r_case
id|LCP_STATE_OPENED
suffix:colon
multiline_comment|/* Initiate renegotiation. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* fall through... */
r_case
id|LCP_STATE_ACK_SENT
suffix:colon
multiline_comment|/* Go to closed state. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Send Configure-Ack packet. */
id|sp-&gt;pp_loopcnt
op_assign
l_int|0
suffix:semicolon
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_CONF_ACK
comma
id|h-&gt;ident
comma
id|len
op_minus
l_int|4
comma
id|h
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Change the state. */
r_switch
c_cond
(paren
id|sp-&gt;lcp.state
)paren
(brace
r_case
id|LCP_STATE_CLOSED
suffix:colon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_ACK_SENT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_ACK_RCVD
suffix:colon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_OPENED
suffix:semicolon
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_OPENED
suffix:colon
multiline_comment|/* Remote magic changed -- close session. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
multiline_comment|/* Initiate renegotiation. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* An ACK has already been sent. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_ACK_SENT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LCP_CONF_ACK
suffix:colon
r_if
c_cond
(paren
id|h-&gt;ident
op_ne
id|sp-&gt;lcp.confid
)paren
r_break
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;pp_link_state
op_ne
id|SPPP_LINK_UP
)paren
op_logical_and
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
multiline_comment|/* Coming out of loopback mode. */
id|sp-&gt;pp_link_state
op_assign
id|SPPP_LINK_UP
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: protocol up&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sp-&gt;lcp.state
)paren
(brace
r_case
id|LCP_STATE_CLOSED
suffix:colon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_ACK_RCVD
suffix:semicolon
id|sppp_set_timeout
(paren
id|sp
comma
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_ACK_SENT
suffix:colon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_OPENED
suffix:semicolon
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LCP_CONF_NAK
suffix:colon
r_if
c_cond
(paren
id|h-&gt;ident
op_ne
id|sp-&gt;lcp.confid
)paren
r_break
suffix:semicolon
id|p
op_assign
(paren
id|u8
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|10
op_logical_and
id|p
(braket
l_int|0
)braket
op_eq
id|LCP_OPT_MAGIC
op_logical_and
id|p
(braket
l_int|1
)braket
op_ge
l_int|4
)paren
(brace
id|rmagic
op_assign
(paren
id|u32
)paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|24
op_or
(paren
id|u32
)paren
id|p
(braket
l_int|3
)braket
op_lshift
l_int|16
op_or
id|p
(braket
l_int|4
)braket
op_lshift
l_int|8
op_or
id|p
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rmagic
op_eq
op_complement
id|sp-&gt;lcp.magic
)paren
(brace
r_int
id|newmagic
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: conf nak: magic glitch&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|get_random_bytes
c_func
(paren
op_amp
id|newmagic
comma
r_sizeof
(paren
id|newmagic
)paren
)paren
suffix:semicolon
id|sp-&gt;lcp.magic
op_add_assign
id|newmagic
suffix:semicolon
)brace
r_else
id|sp-&gt;lcp.magic
op_assign
id|rmagic
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_ne
id|LCP_STATE_ACK_SENT
)paren
(brace
multiline_comment|/* Go to closed state. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
)brace
multiline_comment|/* The link will be renegotiated after timeout,&n;&t;&t; * to avoid endless req-nack loop. */
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
id|sppp_set_timeout
(paren
id|sp
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_CONF_REJ
suffix:colon
r_if
c_cond
(paren
id|h-&gt;ident
op_ne
id|sp-&gt;lcp.confid
)paren
r_break
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Initiate renegotiation. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_ne
id|LCP_STATE_ACK_SENT
)paren
(brace
multiline_comment|/* Go to closed state. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LCP_TERM_REQ
suffix:colon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Send Terminate-Ack packet. */
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_TERM_ACK
comma
id|h-&gt;ident
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Go to closed state. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
multiline_comment|/* Initiate renegotiation. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_TERM_ACK
suffix:colon
r_case
id|LCP_CODE_REJ
suffix:colon
r_case
id|LCP_PROTO_REJ
suffix:colon
multiline_comment|/* Ignore for now. */
r_break
suffix:semicolon
r_case
id|LCP_DISC_REQ
suffix:colon
multiline_comment|/* Discard the packet. */
r_break
suffix:semicolon
r_case
id|LCP_ECHO_REQ
suffix:colon
r_if
c_cond
(paren
id|sp-&gt;lcp.state
op_ne
id|LCP_STATE_OPENED
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid lcp echo request packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohl
(paren
op_star
(paren
r_int
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
)paren
op_eq
id|sp-&gt;lcp.magic
)paren
(brace
multiline_comment|/* Line loopback mode detected. */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: loopback&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|if_down
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Shut down the PPP link. */
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Initiate negotiation. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
(paren
r_int
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
op_assign
id|htonl
(paren
id|sp-&gt;lcp.magic
)paren
suffix:semicolon
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_ECHO_REPLY
comma
id|h-&gt;ident
comma
id|len
op_minus
l_int|4
comma
id|h
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_ECHO_REPLY
suffix:colon
r_if
c_cond
(paren
id|h-&gt;ident
op_ne
id|sp-&gt;lcp.echoid
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid lcp echo reply packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohl
(paren
op_star
(paren
r_int
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
)paren
op_ne
id|sp-&gt;lcp.magic
)paren
id|sp-&gt;pp_alivecnt
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Handle incoming Cisco keepalive protocol packets.&n; */
DECL|function|sppp_cisco_input
r_static
r_void
id|sppp_cisco_input
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|cisco_packet
op_star
id|h
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;pp_if
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_ne
id|CISCO_PACKET_LEN
op_logical_and
id|skb-&gt;len
op_ne
id|CISCO_BIG_PACKET_LEN
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid cisco packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|h
op_assign
(paren
r_struct
id|cisco_packet
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|cisco_packet
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: cisco input: %d bytes &lt;%xh %xh %xh %xh %xh-%xh&gt;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
comma
id|ntohl
(paren
id|h-&gt;type
)paren
comma
id|h-&gt;par1
comma
id|h-&gt;par2
comma
id|h-&gt;rel
comma
id|h-&gt;time0
comma
id|h-&gt;time1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ntohl
(paren
id|h-&gt;type
)paren
)paren
(brace
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: unknown cisco packet type: 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ntohl
(paren
id|h-&gt;type
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISCO_ADDR_REPLY
suffix:colon
multiline_comment|/* Reply on address request, ignore */
r_break
suffix:semicolon
r_case
id|CISCO_KEEPALIVE_REQ
suffix:colon
id|sp-&gt;pp_alivecnt
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;pp_rseq
op_assign
id|ntohl
(paren
id|h-&gt;par1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_seq
op_eq
id|sp-&gt;pp_rseq
)paren
(brace
multiline_comment|/* Local and remote sequence numbers are equal.&n;&t;&t;&t; * Probably, the line is in loopback mode. */
r_int
id|newseq
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_loopcnt
op_ge
id|MAXALIVECNT
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: loopback&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;pp_loopcnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
id|if_down
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
op_increment
id|sp-&gt;pp_loopcnt
suffix:semicolon
multiline_comment|/* Generate new local sequence number */
id|get_random_bytes
c_func
(paren
op_amp
id|newseq
comma
r_sizeof
(paren
id|newseq
)paren
)paren
suffix:semicolon
id|sp-&gt;pp_seq
op_xor_assign
id|newseq
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sp-&gt;pp_loopcnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_link_state
op_eq
id|SPPP_LINK_DOWN
op_logical_and
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|sp-&gt;pp_link_state
op_assign
id|SPPP_LINK_UP
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: protocol up&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CISCO_ADDR_REQ
suffix:colon
multiline_comment|/* Stolen from net/ipv4/devinet.c -- SIOCGIFADDR ioctl */
(brace
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
r_struct
id|in_ifaddr
op_star
id|ifa
suffix:semicolon
id|u32
id|addr
op_assign
l_int|0
comma
id|mask
op_assign
op_complement
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: is the mask correct? */
macro_line|#ifdef CONFIG_INET
r_if
c_cond
(paren
(paren
id|in_dev
op_assign
id|in_dev_get
c_func
(paren
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
id|ifa
op_ne
l_int|NULL
suffix:semicolon
id|ifa
op_assign
id|ifa-&gt;ifa_next
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|dev-&gt;name
comma
id|ifa-&gt;ifa_label
)paren
op_eq
l_int|0
)paren
(brace
id|addr
op_assign
id|ifa-&gt;ifa_local
suffix:semicolon
id|mask
op_assign
id|ifa-&gt;ifa_mask
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|in_dev-&gt;lock
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in_dev
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
multiline_comment|/* I hope both addr and mask are in the net order */
id|sppp_cisco_send
(paren
id|sp
comma
id|CISCO_ADDR_REPLY
comma
id|addr
comma
id|mask
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Send PPP LCP packet.&n; */
DECL|function|sppp_cp_send
r_static
r_void
id|sppp_cp_send
(paren
r_struct
id|sppp
op_star
id|sp
comma
id|u16
id|proto
comma
id|u8
id|type
comma
id|u8
id|ident
comma
id|u16
id|len
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|ppp_header
op_star
id|h
suffix:semicolon
r_struct
id|lcp_header
op_star
id|lh
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;pp_if
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|dev-&gt;hard_header_len
op_plus
id|PPP_HEADER_LEN
op_plus
id|LCP_HEADER_LEN
op_plus
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|h
op_assign
(paren
r_struct
id|ppp_header
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ppp_header
)paren
)paren
suffix:semicolon
id|h-&gt;address
op_assign
id|PPP_ALLSTATIONS
suffix:semicolon
multiline_comment|/* broadcast address */
id|h-&gt;control
op_assign
id|PPP_UI
suffix:semicolon
multiline_comment|/* Unnumbered Info */
id|h-&gt;protocol
op_assign
id|htons
(paren
id|proto
)paren
suffix:semicolon
multiline_comment|/* Link Control Protocol */
id|lh
op_assign
(paren
r_struct
id|lcp_header
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|lcp_header
)paren
)paren
suffix:semicolon
id|lh-&gt;type
op_assign
id|type
suffix:semicolon
id|lh-&gt;ident
op_assign
id|ident
suffix:semicolon
id|lh-&gt;len
op_assign
id|htons
(paren
id|LCP_HEADER_LEN
op_plus
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: %s output &lt;%s id=%xh len=%xh&quot;
comma
id|dev-&gt;name
comma
id|proto
op_eq
id|PPP_LCP
ques
c_cond
l_string|&quot;lcp&quot;
suffix:colon
l_string|&quot;ipcp&quot;
comma
id|proto
op_eq
id|PPP_LCP
ques
c_cond
id|sppp_lcp_type_name
(paren
id|lh-&gt;type
)paren
suffix:colon
id|sppp_ipcp_type_name
(paren
id|lh-&gt;type
)paren
comma
id|lh-&gt;ident
comma
id|ntohs
(paren
id|lh-&gt;len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
id|sppp_print_bytes
(paren
(paren
id|u8
op_star
)paren
(paren
id|lh
op_plus
l_int|1
)paren
comma
id|len
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|sp-&gt;obytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Control is high priority so it doesnt get queued behind data */
id|skb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send Cisco keepalive packet.&n; */
DECL|function|sppp_cisco_send
r_static
r_void
id|sppp_cisco_send
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_int
id|type
comma
r_int
id|par1
comma
r_int
id|par2
)paren
(brace
r_struct
id|ppp_header
op_star
id|h
suffix:semicolon
r_struct
id|cisco_packet
op_star
id|ch
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;pp_if
suffix:semicolon
id|u32
id|t
op_assign
id|jiffies
op_star
l_int|1000
op_div
id|HZ
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|dev-&gt;hard_header_len
op_plus
id|PPP_HEADER_LEN
op_plus
id|CISCO_PACKET_LEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|h
op_assign
(paren
r_struct
id|ppp_header
op_star
)paren
id|skb_put
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ppp_header
)paren
)paren
suffix:semicolon
id|h-&gt;address
op_assign
id|CISCO_MULTICAST
suffix:semicolon
id|h-&gt;control
op_assign
l_int|0
suffix:semicolon
id|h-&gt;protocol
op_assign
id|htons
(paren
id|CISCO_KEEPALIVE
)paren
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|cisco_packet
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|CISCO_PACKET_LEN
)paren
suffix:semicolon
id|ch-&gt;type
op_assign
id|htonl
(paren
id|type
)paren
suffix:semicolon
id|ch-&gt;par1
op_assign
id|htonl
(paren
id|par1
)paren
suffix:semicolon
id|ch-&gt;par2
op_assign
id|htonl
(paren
id|par2
)paren
suffix:semicolon
id|ch-&gt;rel
op_assign
op_minus
l_int|1
suffix:semicolon
id|ch-&gt;time0
op_assign
id|htons
(paren
(paren
id|u16
)paren
(paren
id|t
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|ch-&gt;time1
op_assign
id|htons
(paren
(paren
id|u16
)paren
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: cisco output: &lt;%xh %xh %xh %xh %xh-%xh&gt;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ntohl
(paren
id|ch-&gt;type
)paren
comma
id|ch-&gt;par1
comma
id|ch-&gt;par2
comma
id|ch-&gt;rel
comma
id|ch-&gt;time0
comma
id|ch-&gt;time1
)paren
suffix:semicolon
id|sp-&gt;obytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sppp_close - close down a synchronous PPP or Cisco HDLC link&n; *&t;@dev: The network device to drop the link of&n; *&n; *&t;This drops the logical interface to the channel. It is not&n; *&t;done politely as we assume we will also be dropping DTR. Any&n; *&t;timeouts are killed.&n; */
DECL|function|sppp_close
r_int
id|sppp_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;pp_link_state
op_assign
id|SPPP_LINK_DOWN
suffix:semicolon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sppp_close
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_close
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;sppp_open - open a synchronous PPP or Cisco HDLC link&n; *&t;@dev:&t;Network device to activate&n; *&t;&n; *&t;Close down any existing synchronous session and commence&n; *&t;from scratch. In the PPP case this means negotiating LCP/IPCP&n; *&t;and friends, while for Cisco HDLC we simply need to start sending&n; *&t;keepalives&n; */
DECL|function|sppp_open
r_int
id|sppp_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sppp_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
)paren
(brace
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
)brace
id|sp-&gt;pp_link_state
op_assign
id|SPPP_LINK_DOWN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sppp_open
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_open
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;sppp_reopen - notify of physical link loss&n; *&t;@dev: Device that lost the link&n; *&n; *&t;This function informs the synchronous protocol code that&n; *&t;the underlying link died (for example a carrier drop on X.21)&n; *&n; *&t;We increment the magic numbers to ensure that if the other end&n; *&t;failed to notice we will correctly start a new session. It happens&n; *&t;do to the nature of telco circuits is that you can lose carrier on&n; *&t;one endonly.&n; *&n; *&t;Having done this we go back to negotiating. This function may&n; *&t;be called from an interrupt context.&n; */
DECL|function|sppp_reopen
r_int
id|sppp_reopen
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sppp_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
)paren
(brace
id|sp-&gt;lcp.magic
op_assign
id|jiffies
suffix:semicolon
op_increment
id|sp-&gt;pp_seq
suffix:semicolon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
multiline_comment|/* Give it a moment for the line to settle then go */
id|sppp_set_timeout
(paren
id|sp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|sp-&gt;pp_link_state
op_assign
id|SPPP_LINK_DOWN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sppp_reopen
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_reopen
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;sppp_change_mtu - Change the link MTU&n; *&t;@dev:&t;Device to change MTU on&n; *&t;@new_mtu: New MTU&n; *&n; *&t;Change the MTU on the link. This can only be called with&n; *&t;the link down. It returns an error if the link is up or&n; *&t;the mtu is out of range.&n; */
DECL|function|sppp_change_mtu
r_int
id|sppp_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
id|new_mtu
id|PPP_MTU
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sppp_change_mtu
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_change_mtu
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;sppp_do_ioctl - Ioctl handler for ppp/hdlc&n; *&t;@dev: Device subject to ioctl&n; *&t;@ifr: Interface request block from the user&n; *&t;@cmd: Command that is being issued&n; *&t;&n; *&t;This function handles the ioctls that may be issued by the user&n; *&t;to control the settings of a PPP/HDLC link. It does both busy&n; *&t;and security checks. This function is intended to be wrapped by&n; *&t;callers who wish to add additional ioctl calls of their own.&n; */
DECL|function|sppp_do_ioctl
r_int
id|sppp_do_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SPPPIOCCISCO
suffix:colon
id|sp-&gt;pp_flags
op_or_assign
id|PP_CISCO
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_HDLC
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPPPIOCPPP
suffix:colon
id|sp-&gt;pp_flags
op_and_assign
op_complement
id|PP_CISCO
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPPPIOCDEBUG
suffix:colon
id|sp-&gt;pp_flags
op_and_assign
op_complement
id|PP_DEBUG
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_flags
)paren
(brace
id|sp-&gt;pp_flags
op_or_assign
id|PP_DEBUG
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sppp_do_ioctl
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_do_ioctl
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;sppp_attach - attach synchronous PPP/HDLC to a device&n; *&t;@pd:&t;PPP device to initialise&n; *&n; *&t;This initialises the PPP/HDLC support on an interface. At the&n; *&t;time of calling the dev element must point to the network device&n; *&t;that this interface is attached to. The interface should not yet&n; *&t;be registered. &n; */
DECL|function|sppp_attach
r_void
id|sppp_attach
c_func
(paren
r_struct
id|ppp_device
op_star
id|pd
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pd-&gt;dev
suffix:semicolon
r_struct
id|sppp
op_star
id|sp
op_assign
op_amp
id|pd-&gt;sppp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spppq_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Initialize keepalive handler. */
r_if
c_cond
(paren
op_logical_neg
id|spppq
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|sppp_keepalive_timer
)paren
suffix:semicolon
id|sppp_keepalive_timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|sppp_keepalive_timer.function
op_assign
id|sppp_keepalive
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sppp_keepalive_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Insert new entry into the keepalive list. */
id|sp-&gt;pp_next
op_assign
id|spppq
suffix:semicolon
id|spppq
op_assign
id|sp
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spppq_lock
comma
id|flags
)paren
suffix:semicolon
id|sp-&gt;pp_loopcnt
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;pp_alivecnt
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;pp_seq
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;pp_rseq
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;pp_flags
op_assign
id|PP_KEEPALIVE
op_or
id|PP_CISCO
op_or
id|debug
suffix:semicolon
multiline_comment|/*PP_DEBUG;*/
id|sp-&gt;lcp.magic
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
id|sp-&gt;pp_if
op_assign
id|dev
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Device specific setup. All but interrupt handler and&n;&t; *&t;hard_start_xmit.&n;&t; */
id|dev-&gt;hard_header
op_assign
id|sppp_hard_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|sppp_rebuild_header
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|10
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_HDLC
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|ppp_header
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|PPP_MTU
suffix:semicolon
multiline_comment|/*&n;&t; *&t;These 4 are callers but MUST also call sppp_ functions&n;&t; */
id|dev-&gt;do_ioctl
op_assign
id|sppp_do_ioctl
suffix:semicolon
macro_line|#if 0
id|dev-&gt;get_stats
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Let the driver override these */
id|dev-&gt;open
op_assign
id|sppp_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sppp_close
suffix:semicolon
macro_line|#endif&t;
id|dev-&gt;change_mtu
op_assign
id|sppp_change_mtu
suffix:semicolon
id|dev-&gt;hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_MULTICAST
op_or
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|sppp_attach
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_attach
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;sppp_detach - release PPP resources from a device&n; *&t;@dev:&t;Network device to release&n; *&n; *&t;Stop and free up any PPP/HDLC resources used by this&n; *&t;interface. This must be called before the device is&n; *&t;freed.&n; */
DECL|function|sppp_detach
r_void
id|sppp_detach
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sppp
op_star
op_star
id|q
comma
op_star
id|p
comma
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|sppp_of
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spppq_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Remove the entry from the keepalive list. */
r_for
c_loop
(paren
id|q
op_assign
op_amp
id|spppq
suffix:semicolon
(paren
id|p
op_assign
op_star
id|q
)paren
suffix:semicolon
id|q
op_assign
op_amp
id|p-&gt;pp_next
)paren
r_if
c_cond
(paren
id|p
op_eq
id|sp
)paren
(brace
op_star
id|q
op_assign
id|p-&gt;pp_next
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Stop keepalive handler. */
r_if
c_cond
(paren
op_logical_neg
id|spppq
)paren
id|del_timer
c_func
(paren
op_amp
id|sppp_keepalive_timer
)paren
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spppq_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|sppp_detach
id|EXPORT_SYMBOL
c_func
(paren
id|sppp_detach
)paren
suffix:semicolon
multiline_comment|/*&n; * Analyze the LCP Configure-Request options list&n; * for the presence of unknown options.&n; * If the request contains unknown options, build and&n; * send Configure-reject packet, containing only unknown options.&n; */
r_static
r_int
DECL|function|sppp_lcp_conf_parse_options
id|sppp_lcp_conf_parse_options
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|lcp_header
op_star
id|h
comma
r_int
id|len
comma
id|u32
op_star
id|magic
)paren
(brace
id|u8
op_star
id|buf
comma
op_star
id|r
comma
op_star
id|p
suffix:semicolon
r_int
id|rlen
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
id|buf
op_assign
id|r
op_assign
id|kmalloc
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|p
op_assign
(paren
r_void
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rlen
op_assign
l_int|0
suffix:semicolon
id|len
OG
l_int|1
op_logical_and
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|len
op_sub_assign
id|p
(braket
l_int|1
)braket
comma
id|p
op_add_assign
id|p
(braket
l_int|1
)braket
)paren
(brace
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
id|LCP_OPT_MAGIC
suffix:colon
multiline_comment|/* Magic number -- extract. */
r_if
c_cond
(paren
id|len
op_ge
l_int|6
op_logical_and
id|p
(braket
l_int|1
)braket
op_eq
l_int|6
)paren
(brace
op_star
id|magic
op_assign
(paren
id|u32
)paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|24
op_or
(paren
id|u32
)paren
id|p
(braket
l_int|3
)braket
op_lshift
l_int|16
op_or
id|p
(braket
l_int|4
)braket
op_lshift
l_int|8
op_or
id|p
(braket
l_int|5
)braket
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LCP_OPT_ASYNC_MAP
suffix:colon
multiline_comment|/* Async control character map -- check to be zero. */
r_if
c_cond
(paren
id|len
op_ge
l_int|6
op_logical_and
id|p
(braket
l_int|1
)braket
op_eq
l_int|6
op_logical_and
op_logical_neg
id|p
(braket
l_int|2
)braket
op_logical_and
op_logical_neg
id|p
(braket
l_int|3
)braket
op_logical_and
op_logical_neg
id|p
(braket
l_int|4
)braket
op_logical_and
op_logical_neg
id|p
(braket
l_int|5
)braket
)paren
r_continue
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_OPT_MRU
suffix:colon
multiline_comment|/* Maximum receive unit -- always OK. */
r_continue
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Others not supported. */
r_break
suffix:semicolon
)brace
multiline_comment|/* Add the option to rejected list. */
id|memcpy
c_func
(paren
id|r
comma
id|p
comma
id|p
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|r
op_add_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|rlen
op_add_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rlen
)paren
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_CONF_REJ
comma
id|h-&gt;ident
comma
id|rlen
comma
id|buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
(paren
id|rlen
op_eq
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sppp_ipcp_input
r_static
r_void
id|sppp_ipcp_input
(paren
r_struct
id|sppp
op_star
id|sp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|lcp_header
op_star
id|h
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;pp_if
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid ipcp packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|h
op_assign
(paren
r_struct
id|lcp_header
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|lcp_header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: ipcp input: %d bytes &lt;%s id=%xh len=%xh&quot;
comma
id|dev-&gt;name
comma
id|len
comma
id|sppp_ipcp_type_name
(paren
id|h-&gt;type
)paren
comma
id|h-&gt;ident
comma
id|ntohs
(paren
id|h-&gt;len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|4
)paren
id|sppp_print_bytes
(paren
(paren
id|u8
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|ntohs
(paren
id|h-&gt;len
)paren
)paren
id|len
op_assign
id|ntohs
(paren
id|h-&gt;len
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|h-&gt;type
)paren
(brace
r_default
suffix:colon
multiline_comment|/* Unknown packet type -- send Code-Reject packet. */
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_IPCP
comma
id|IPCP_CODE_REJ
comma
op_increment
id|sp-&gt;pp_seq
comma
id|len
comma
id|h
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_CONF_REQ
suffix:colon
r_if
c_cond
(paren
id|len
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_DEBUG
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid ipcp configure request packet length: %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|4
)paren
(brace
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_IPCP
comma
id|LCP_CONF_REJ
comma
id|h-&gt;ident
comma
id|len
op_minus
l_int|4
comma
id|h
op_plus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sp-&gt;ipcp.state
)paren
(brace
r_case
id|IPCP_STATE_OPENED
suffix:colon
multiline_comment|/* Initiate renegotiation. */
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* fall through... */
r_case
id|IPCP_STATE_ACK_SENT
suffix:colon
multiline_comment|/* Go to closed state. */
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Send Configure-Ack packet. */
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_IPCP
comma
id|IPCP_CONF_ACK
comma
id|h-&gt;ident
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Change the state. */
r_if
c_cond
(paren
id|sp-&gt;ipcp.state
op_eq
id|IPCP_STATE_ACK_RCVD
)paren
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_OPENED
suffix:semicolon
r_else
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_ACK_SENT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IPCP_CONF_ACK
suffix:colon
r_if
c_cond
(paren
id|h-&gt;ident
op_ne
id|sp-&gt;ipcp.confid
)paren
r_break
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sp-&gt;ipcp.state
)paren
(brace
r_case
id|IPCP_STATE_CLOSED
suffix:colon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_ACK_RCVD
suffix:semicolon
id|sppp_set_timeout
(paren
id|sp
comma
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_STATE_ACK_SENT
suffix:colon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_OPENED
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IPCP_CONF_NAK
suffix:colon
r_case
id|IPCP_CONF_REJ
suffix:colon
r_if
c_cond
(paren
id|h-&gt;ident
op_ne
id|sp-&gt;ipcp.confid
)paren
r_break
suffix:semicolon
id|sppp_clear_timeout
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Initiate renegotiation. */
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;ipcp.state
op_ne
id|IPCP_STATE_ACK_SENT
)paren
multiline_comment|/* Go to closed state. */
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_TERM_REQ
suffix:colon
multiline_comment|/* Send Terminate-Ack packet. */
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_IPCP
comma
id|IPCP_TERM_ACK
comma
id|h-&gt;ident
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Go to closed state. */
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
multiline_comment|/* Initiate renegotiation. */
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_TERM_ACK
suffix:colon
multiline_comment|/* Ignore for now. */
r_case
id|IPCP_CODE_REJ
suffix:colon
multiline_comment|/* Ignore for now. */
r_break
suffix:semicolon
)brace
)brace
DECL|function|sppp_lcp_open
r_static
r_void
id|sppp_lcp_open
(paren
r_struct
id|sppp
op_star
id|sp
)paren
(brace
r_char
id|opt
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;lcp.magic
)paren
id|sp-&gt;lcp.magic
op_assign
id|jiffies
suffix:semicolon
id|opt
(braket
l_int|0
)braket
op_assign
id|LCP_OPT_MAGIC
suffix:semicolon
id|opt
(braket
l_int|1
)braket
op_assign
r_sizeof
(paren
id|opt
)paren
suffix:semicolon
id|opt
(braket
l_int|2
)braket
op_assign
id|sp-&gt;lcp.magic
op_rshift
l_int|24
suffix:semicolon
id|opt
(braket
l_int|3
)braket
op_assign
id|sp-&gt;lcp.magic
op_rshift
l_int|16
suffix:semicolon
id|opt
(braket
l_int|4
)braket
op_assign
id|sp-&gt;lcp.magic
op_rshift
l_int|8
suffix:semicolon
id|opt
(braket
l_int|5
)braket
op_assign
id|sp-&gt;lcp.magic
suffix:semicolon
id|sp-&gt;lcp.confid
op_assign
op_increment
id|sp-&gt;pp_seq
suffix:semicolon
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_LCP
comma
id|LCP_CONF_REQ
comma
id|sp-&gt;lcp.confid
comma
r_sizeof
(paren
id|opt
)paren
comma
op_amp
id|opt
)paren
suffix:semicolon
id|sppp_set_timeout
(paren
id|sp
comma
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|sppp_ipcp_open
r_static
r_void
id|sppp_ipcp_open
(paren
r_struct
id|sppp
op_star
id|sp
)paren
(brace
id|sp-&gt;ipcp.confid
op_assign
op_increment
id|sp-&gt;pp_seq
suffix:semicolon
id|sppp_cp_send
(paren
id|sp
comma
id|PPP_IPCP
comma
id|IPCP_CONF_REQ
comma
id|sp-&gt;ipcp.confid
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|sppp_set_timeout
(paren
id|sp
comma
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Process PPP control protocol timeouts.&n; */
DECL|function|sppp_cp_timeout
r_static
r_void
id|sppp_cp_timeout
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|sppp
op_star
id|sp
op_assign
(paren
r_struct
id|sppp
op_star
)paren
id|arg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sp-&gt;pp_flags
op_and_assign
op_complement
id|PP_TIMO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;pp_if-&gt;flags
op_amp
id|IFF_UP
)paren
op_logical_or
(paren
id|sp-&gt;pp_flags
op_amp
id|PP_CISCO
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sp-&gt;lcp.state
)paren
(brace
r_case
id|LCP_STATE_CLOSED
suffix:colon
multiline_comment|/* No ACK for Configure-Request, retry. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_ACK_RCVD
suffix:colon
multiline_comment|/* ACK got, but no Configure-Request for peer, retry. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
id|sp-&gt;lcp.state
op_assign
id|LCP_STATE_CLOSED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_ACK_SENT
suffix:colon
multiline_comment|/* ACK sent but no ACK for Configure-Request, retry. */
id|sppp_lcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCP_STATE_OPENED
suffix:colon
multiline_comment|/* LCP is already OK, try IPCP. */
r_switch
c_cond
(paren
id|sp-&gt;ipcp.state
)paren
(brace
r_case
id|IPCP_STATE_CLOSED
suffix:colon
multiline_comment|/* No ACK for Configure-Request, retry. */
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_STATE_ACK_RCVD
suffix:colon
multiline_comment|/* ACK got, but no Configure-Request for peer, retry. */
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
id|sp-&gt;ipcp.state
op_assign
id|IPCP_STATE_CLOSED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_STATE_ACK_SENT
suffix:colon
multiline_comment|/* ACK sent but no ACK for Configure-Request, retry. */
id|sppp_ipcp_open
(paren
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPCP_STATE_OPENED
suffix:colon
multiline_comment|/* IPCP is OK. */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sppp_lcp_type_name
r_static
r_char
op_star
id|sppp_lcp_type_name
(paren
id|u8
id|type
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|LCP_CONF_REQ
suffix:colon
r_return
(paren
l_string|&quot;conf-req&quot;
)paren
suffix:semicolon
r_case
id|LCP_CONF_ACK
suffix:colon
r_return
(paren
l_string|&quot;conf-ack&quot;
)paren
suffix:semicolon
r_case
id|LCP_CONF_NAK
suffix:colon
r_return
(paren
l_string|&quot;conf-nack&quot;
)paren
suffix:semicolon
r_case
id|LCP_CONF_REJ
suffix:colon
r_return
(paren
l_string|&quot;conf-rej&quot;
)paren
suffix:semicolon
r_case
id|LCP_TERM_REQ
suffix:colon
r_return
(paren
l_string|&quot;term-req&quot;
)paren
suffix:semicolon
r_case
id|LCP_TERM_ACK
suffix:colon
r_return
(paren
l_string|&quot;term-ack&quot;
)paren
suffix:semicolon
r_case
id|LCP_CODE_REJ
suffix:colon
r_return
(paren
l_string|&quot;code-rej&quot;
)paren
suffix:semicolon
r_case
id|LCP_PROTO_REJ
suffix:colon
r_return
(paren
l_string|&quot;proto-rej&quot;
)paren
suffix:semicolon
r_case
id|LCP_ECHO_REQ
suffix:colon
r_return
(paren
l_string|&quot;echo-req&quot;
)paren
suffix:semicolon
r_case
id|LCP_ECHO_REPLY
suffix:colon
r_return
(paren
l_string|&quot;echo-reply&quot;
)paren
suffix:semicolon
r_case
id|LCP_DISC_REQ
suffix:colon
r_return
(paren
l_string|&quot;discard-req&quot;
)paren
suffix:semicolon
)brace
id|sprintf
(paren
id|buf
comma
l_string|&quot;%xh&quot;
comma
id|type
)paren
suffix:semicolon
r_return
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|sppp_ipcp_type_name
r_static
r_char
op_star
id|sppp_ipcp_type_name
(paren
id|u8
id|type
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|IPCP_CONF_REQ
suffix:colon
r_return
(paren
l_string|&quot;conf-req&quot;
)paren
suffix:semicolon
r_case
id|IPCP_CONF_ACK
suffix:colon
r_return
(paren
l_string|&quot;conf-ack&quot;
)paren
suffix:semicolon
r_case
id|IPCP_CONF_NAK
suffix:colon
r_return
(paren
l_string|&quot;conf-nack&quot;
)paren
suffix:semicolon
r_case
id|IPCP_CONF_REJ
suffix:colon
r_return
(paren
l_string|&quot;conf-rej&quot;
)paren
suffix:semicolon
r_case
id|IPCP_TERM_REQ
suffix:colon
r_return
(paren
l_string|&quot;term-req&quot;
)paren
suffix:semicolon
r_case
id|IPCP_TERM_ACK
suffix:colon
r_return
(paren
l_string|&quot;term-ack&quot;
)paren
suffix:semicolon
r_case
id|IPCP_CODE_REJ
suffix:colon
r_return
(paren
l_string|&quot;code-rej&quot;
)paren
suffix:semicolon
)brace
id|sprintf
(paren
id|buf
comma
l_string|&quot;%xh&quot;
comma
id|type
)paren
suffix:semicolon
r_return
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|sppp_print_bytes
r_static
r_void
id|sppp_print_bytes
(paren
id|u_char
op_star
id|p
comma
id|u16
id|len
)paren
(brace
id|printk
(paren
l_string|&quot; %x&quot;
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|len
OG
l_int|0
)paren
id|printk
(paren
l_string|&quot;-%x&quot;
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sppp_rcv -&t;receive and process a WAN PPP frame&n; *&t;@skb:&t;The buffer to process&n; *&t;@dev:&t;The device it arrived on&n; *&t;@p: Unused&n; *&n; *&t;Protocol glue. This drives the deferred processing mode the poorer&n; *&t;cards use. This can be called directly by cards that do not have&n; *&t;timing constraints but is normally called from the network layer&n; *&t;after interrupt servicing to process frames queued via netif_rx.&n; */
DECL|function|sppp_rcv
r_static
r_int
id|sppp_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|p
)paren
(brace
id|sppp_input
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sppp_packet_type
r_struct
id|packet_type
id|sppp_packet_type
op_assign
(brace
l_int|0
comma
l_int|NULL
comma
id|sppp_rcv
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|sync_ppp_init
r_void
id|sync_ppp_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cronyx Ltd, Synchronous PPP and CISCO HDLC (c) 1994&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Linux port (c) 1998 Building Number Three Ltd &amp; Jan &bslash;&quot;Yenya&bslash;&quot; Kasprzak.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|spppq_lock
)paren
suffix:semicolon
id|sppp_packet_type.type
op_assign
id|htons
c_func
(paren
id|ETH_P_WAN_PPP
)paren
suffix:semicolon
id|dev_add_pack
c_func
(paren
op_amp
id|sppp_packet_type
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|debug
)paren
(brace
id|debug
op_assign
id|PP_DEBUG
suffix:semicolon
)brace
id|sync_ppp_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|dev_remove_pack
c_func
(paren
op_amp
id|sppp_packet_type
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
