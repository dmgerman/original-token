multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Driver for SGI&squot;s IOC3 based Ethernet cards as found in the PCI card.&n; *&n; * Copyright (C) 1999, 2000 Ralf Baechle&n; * Copyright (C) 1995, 1999, 2000 by Silicon Graphics, Inc.&n; *&n; * Reporting bugs:&n; *&n; * If you find problems with this drivers, then if possible do the&n; * following.  Hook up a terminal to the MSC port, send an NMI to the CPUs&n; * by typing ^Tnmi (where ^T stands for &lt;CTRL&gt;-T).  You&squot;ll see something&n; * like:&n; * 1A 000: &n; * 1A 000: *** NMI while in Kernel and no NMI vector installed on node 0&n; * 1A 000: *** Error EPC: 0xffffffff800265e4 (0xffffffff800265e4)&n; * 1A 000: *** Press ENTER to continue.&n; *&n; * Next enter the command ``lw i:0x86000f0 0x18&squot;&squot; and include this&n; * commands output which will look like below with your bugreport.&n; *&n; * 1A 000: POD MSC Dex&gt; lw i:0x86000f0 0x18&n; * 1A 000: 92000000086000f0: 0021f28c 00000000 00000000 00000000&n; * 1A 000: 9200000008600100: a5000000 01cde000 00000000 000004e0&n; * 1A 000: 9200000008600110: 00000650 00000000 00110b15 00000000&n; * 1A 000: 9200000008600120: 006d0005 77bbca0a a5000000 01ce0000&n; * 1A 000: 9200000008600130: 80000500 00000500 00002538 05690008&n; * 1A 000: 9200000008600140: 00000000 00000000 000003e1 0000786d&n; *&n; * To do:&n; *&n; *  - Handle allocation failures in ioc3_alloc_skb() more gracefully.&n; *  - Handle allocation failures in ioc3_init_rings().&n; *  - Use prefetching for large packets.  What is a good lower limit for&n; *    prefetching?&n; *  - We&squot;re probably allocating a bit too much memory.&n; *  - Workarounds for various PHYs.&n; *  - Proper autonegotiation.&n; *  - What exactly is net_device_stats.tx_dropped supposed to count?&n; *  - Use hardware checksums.&n; *  - Convert to using the PCI infrastructure / IOC3 meta driver.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/sn0/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubni.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubio.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/sn/ioc3.h&gt;
macro_line|#include &lt;asm/sn/sn0/ip27.h&gt;
macro_line|#include &lt;asm/pci/bridge.h&gt;
multiline_comment|/* 32 RX buffers.  This is tunable in the range of 16 &lt;= x &lt; 512.  */
DECL|macro|RX_BUFFS
mdefine_line|#define RX_BUFFS 64
multiline_comment|/* Private ioctls that de facto are well known and used for examply&n;   by mii-tool.  */
DECL|macro|SIOCGMIIPHY
mdefine_line|#define SIOCGMIIPHY (SIOCDEVPRIVATE)&t;/* Read from current PHY */
DECL|macro|SIOCGMIIREG
mdefine_line|#define SIOCGMIIREG (SIOCDEVPRIVATE+1)&t;/* Read any PHY register */
DECL|macro|SIOCSMIIREG
mdefine_line|#define SIOCSMIIREG (SIOCDEVPRIVATE+2)&t;/* Write any PHY register */
multiline_comment|/* These exist in other drivers; we don&squot;t use them at this time.  */
DECL|macro|SIOCGPARAMS
mdefine_line|#define SIOCGPARAMS (SIOCDEVPRIVATE+3)&t;/* Read operational parameters */
DECL|macro|SIOCSPARAMS
mdefine_line|#define SIOCSPARAMS (SIOCDEVPRIVATE+4)&t;/* Set operational parameters */
multiline_comment|/* Private per NIC data of the driver.  */
DECL|struct|ioc3_private
r_struct
id|ioc3_private
(brace
DECL|member|regs
r_struct
id|ioc3
op_star
id|regs
suffix:semicolon
DECL|member|phy
r_int
id|phy
suffix:semicolon
DECL|member|rxr
r_int
r_int
op_star
id|rxr
suffix:semicolon
multiline_comment|/* pointer to receiver ring */
DECL|member|txr
r_struct
id|ioc3_etxd
op_star
id|txr
suffix:semicolon
DECL|member|rx_skbs
r_struct
id|sk_buff
op_star
id|rx_skbs
(braket
l_int|512
)braket
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
l_int|128
)braket
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|rx_ci
r_int
id|rx_ci
suffix:semicolon
multiline_comment|/* RX consumer index */
DECL|member|rx_pi
r_int
id|rx_pi
suffix:semicolon
multiline_comment|/* RX producer index */
DECL|member|tx_ci
r_int
id|tx_ci
suffix:semicolon
multiline_comment|/* TX consumer index */
DECL|member|tx_pi
r_int
id|tx_pi
suffix:semicolon
multiline_comment|/* TX producer index */
DECL|member|txqlen
r_int
id|txqlen
suffix:semicolon
DECL|member|emcr
DECL|member|ehar_h
DECL|member|ehar_l
id|u32
id|emcr
comma
id|ehar_h
comma
id|ehar_l
suffix:semicolon
DECL|member|negtimer
r_struct
id|timer_list
id|negtimer
suffix:semicolon
DECL|member|ioc3_lock
id|spinlock_t
id|ioc3_lock
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|ioc3_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|ioc3_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ioc3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ioc3_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_inline
r_int
r_int
id|ioc3_hash
c_func
(paren
r_const
r_int
r_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ioc3_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ioc3_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ioc3_str
r_static
r_const
r_char
id|ioc3_str
(braket
)braket
op_assign
l_string|&quot;IOC3 Ethernet&quot;
suffix:semicolon
multiline_comment|/* We use this to acquire receive skb&squot;s that we can DMA directly into. */
DECL|macro|ALIGNED_RX_SKB_ADDR
mdefine_line|#define ALIGNED_RX_SKB_ADDR(addr) &bslash;&n;&t;((((unsigned long)(addr) + (128 - 1)) &amp; ~(128 - 1)) - (unsigned long)(addr))
DECL|macro|ioc3_alloc_skb
mdefine_line|#define ioc3_alloc_skb(__length, __gfp_flags) &bslash;&n;({&t;struct sk_buff *__skb; &bslash;&n;&t;__skb = alloc_skb((__length) + 128, (__gfp_flags)); &bslash;&n;&t;if (__skb) { &bslash;&n;&t;&t;int __offset = ALIGNED_RX_SKB_ADDR(__skb-&gt;data); &bslash;&n;&t;&t;if(__offset) &bslash;&n;&t;&t;&t;skb_reserve(__skb, __offset); &bslash;&n;&t;} &bslash;&n;&t;__skb; &bslash;&n;})
multiline_comment|/* BEWARE: The IOC3 documentation documents the size of rx buffers as&n;   1644 while it&squot;s actually 1664.  This one was nasty to track down ...  */
DECL|macro|RX_OFFSET
mdefine_line|#define RX_OFFSET&t;&t;10
DECL|macro|RX_BUF_ALLOC_SIZE
mdefine_line|#define RX_BUF_ALLOC_SIZE&t;(1664 + RX_OFFSET + 128)
multiline_comment|/* DMA barrier to separate cached and uncached accesses.  */
DECL|macro|BARRIER
mdefine_line|#define BARRIER()&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__(&quot;sync&quot; ::: &quot;memory&quot;)
DECL|macro|IOC3_SIZE
mdefine_line|#define IOC3_SIZE 0x100000
DECL|macro|ioc3_r
mdefine_line|#define ioc3_r(reg)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;({&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;u32 __res;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__res = ioc3-&gt;reg;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__res;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;})
DECL|macro|ioc3_w
mdefine_line|#define ioc3_w(reg,val)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(ioc3-&gt;reg = (val));&t;&t;&t;&t;&t;&t;&bslash;&n;} while(0)
r_static
r_inline
id|u32
DECL|function|mcr_pack
id|mcr_pack
c_func
(paren
id|u32
id|pulse
comma
id|u32
id|sample
)paren
(brace
r_return
(paren
id|pulse
op_lshift
l_int|10
)paren
op_or
(paren
id|sample
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|nic_wait
id|nic_wait
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
id|u32
id|mcr
suffix:semicolon
r_do
(brace
id|mcr
op_assign
id|ioc3_r
c_func
(paren
id|mcr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|mcr
op_amp
l_int|2
)paren
)paren
suffix:semicolon
r_return
id|mcr
op_amp
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|nic_reset
id|nic_reset
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_int
id|presence
suffix:semicolon
id|ioc3_w
c_func
(paren
id|mcr
comma
id|mcr_pack
c_func
(paren
l_int|500
comma
l_int|65
)paren
)paren
suffix:semicolon
id|presence
op_assign
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|ioc3_w
c_func
(paren
id|mcr
comma
id|mcr_pack
c_func
(paren
l_int|0
comma
l_int|500
)paren
)paren
suffix:semicolon
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_return
id|presence
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|nic_read_bit
id|nic_read_bit
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_int
id|result
suffix:semicolon
id|ioc3_w
c_func
(paren
id|mcr
comma
id|mcr_pack
c_func
(paren
l_int|6
comma
l_int|13
)paren
)paren
suffix:semicolon
id|result
op_assign
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|ioc3_w
c_func
(paren
id|mcr
comma
id|mcr_pack
c_func
(paren
l_int|0
comma
l_int|100
)paren
)paren
suffix:semicolon
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|nic_write_bit
id|nic_write_bit
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
id|bit
)paren
(brace
r_if
c_cond
(paren
id|bit
)paren
id|ioc3_w
c_func
(paren
id|mcr
comma
id|mcr_pack
c_func
(paren
l_int|6
comma
l_int|110
)paren
)paren
suffix:semicolon
r_else
id|ioc3_w
c_func
(paren
id|mcr
comma
id|mcr_pack
c_func
(paren
l_int|80
comma
l_int|30
)paren
)paren
suffix:semicolon
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read a byte from an iButton device&n; */
r_static
id|u32
DECL|function|nic_read_byte
id|nic_read_byte
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
id|u32
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|result
op_assign
(paren
id|result
op_rshift
l_int|1
)paren
op_or
(paren
id|nic_read_bit
c_func
(paren
id|ioc3
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Write a byte to an iButton device&n; */
r_static
r_void
DECL|function|nic_write_byte
id|nic_write_byte
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
id|byte
)paren
(brace
r_int
id|i
comma
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|bit
op_assign
id|byte
op_amp
l_int|1
suffix:semicolon
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
id|nic_write_bit
c_func
(paren
id|ioc3
comma
id|bit
)paren
suffix:semicolon
)brace
)brace
r_static
id|u64
DECL|function|nic_find
id|nic_find
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
op_star
id|last
)paren
(brace
r_int
id|a
comma
id|b
comma
id|index
comma
id|disc
suffix:semicolon
id|u64
id|address
op_assign
l_int|0
suffix:semicolon
id|nic_reset
c_func
(paren
id|ioc3
)paren
suffix:semicolon
multiline_comment|/* Search ROM.  */
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* Algorithm from ``Book of iButton Standards&squot;&squot;.  */
r_for
c_loop
(paren
id|index
op_assign
l_int|0
comma
id|disc
op_assign
l_int|0
suffix:semicolon
id|index
OL
l_int|64
suffix:semicolon
id|index
op_increment
)paren
(brace
id|a
op_assign
id|nic_read_bit
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|b
op_assign
id|nic_read_bit
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
op_logical_and
id|b
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NIC search failed (not fatal).&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|last
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|a
op_logical_and
op_logical_neg
id|b
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
op_star
id|last
)paren
(brace
id|address
op_or_assign
l_int|1UL
op_lshift
id|index
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|index
OG
op_star
id|last
)paren
(brace
id|address
op_and_assign
op_complement
(paren
l_int|1UL
op_lshift
id|index
)paren
suffix:semicolon
id|disc
op_assign
id|index
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|address
op_amp
(paren
l_int|1UL
op_lshift
id|index
)paren
)paren
op_eq
l_int|0
)paren
id|disc
op_assign
id|index
suffix:semicolon
id|nic_write_bit
c_func
(paren
id|ioc3
comma
id|address
op_amp
(paren
l_int|1UL
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|a
)paren
id|address
op_or_assign
l_int|1UL
op_lshift
id|index
suffix:semicolon
r_else
id|address
op_and_assign
op_complement
(paren
l_int|1UL
op_lshift
id|index
)paren
suffix:semicolon
id|nic_write_bit
c_func
(paren
id|ioc3
comma
id|a
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
op_star
id|last
op_assign
id|disc
suffix:semicolon
r_return
id|address
suffix:semicolon
)brace
DECL|function|nic_init
r_static
r_int
id|nic_init
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_const
r_char
op_star
id|type
suffix:semicolon
id|u8
id|crc
suffix:semicolon
id|u8
id|serial
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|save
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|type
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|u64
id|reg
suffix:semicolon
id|reg
op_assign
id|nic_find
c_func
(paren
id|ioc3
comma
op_amp
id|save
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg
op_amp
l_int|0xff
)paren
(brace
r_case
l_int|0x91
suffix:colon
id|type
op_assign
l_string|&quot;DS1981U&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|save
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Let the caller try again.  */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|nic_reset
c_func
(paren
id|ioc3
)paren
suffix:semicolon
multiline_comment|/* Match ROM.  */
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0x55
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|nic_write_byte
c_func
(paren
id|ioc3
comma
(paren
id|reg
op_rshift
(paren
id|i
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|reg
op_rshift_assign
l_int|8
suffix:semicolon
multiline_comment|/* Shift out type.  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|serial
(braket
id|i
)braket
op_assign
id|reg
op_amp
l_int|0xff
suffix:semicolon
id|reg
op_rshift_assign
l_int|8
suffix:semicolon
)brace
id|crc
op_assign
id|reg
op_amp
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Found %s NIC&quot;
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
l_string|&quot;unknown&quot;
)paren
(brace
id|printk
(paren
l_string|&quot; registration number %02x:%02x:%02x:%02x:%02x:%02x,&quot;
l_string|&quot; CRC %02x&quot;
comma
id|serial
(braket
l_int|0
)braket
comma
id|serial
(braket
l_int|1
)braket
comma
id|serial
(braket
l_int|2
)braket
comma
id|serial
(braket
l_int|3
)braket
comma
id|serial
(braket
l_int|4
)braket
comma
id|serial
(braket
l_int|5
)braket
comma
id|crc
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the NIC (Number-In-a-Can) device.&n; */
DECL|function|ioc3_get_eaddr
r_static
r_void
id|ioc3_get_eaddr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
id|u8
id|nic
(braket
l_int|14
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|tries
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* There may be some problem with the battery?  */
id|ioc3_w
c_func
(paren
id|gpcr_s
comma
(paren
l_int|1
op_lshift
l_int|21
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tries
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nic_init
c_func
(paren
id|ioc3
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to read MAC address&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Read Memory.  */
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0xf0
)paren
suffix:semicolon
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0x00
)paren
suffix:semicolon
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0x00
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|13
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|nic
(braket
id|i
)braket
op_assign
id|nic_read_byte
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ethernet address is &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
op_minus
l_int|2
)braket
op_assign
id|nic
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|nic
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|7
)paren
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Caller must hold the ioc3_lock ever for MII readers.  This is also&n;   used to protect the transmitter side but it&squot;s low contention.  */
DECL|function|mii_read
r_static
id|u16
id|mii_read
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
id|phy
comma
r_int
id|reg
)paren
(brace
r_while
c_loop
(paren
id|ioc3-&gt;micr
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
id|ioc3-&gt;micr
op_assign
(paren
id|phy
op_lshift
id|MICR_PHYADDR_SHIFT
)paren
op_or
id|reg
op_or
id|MICR_READTRIG
suffix:semicolon
r_while
c_loop
(paren
id|ioc3-&gt;micr
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
r_return
id|ioc3-&gt;midr_r
op_amp
id|MIDR_DATA_MASK
suffix:semicolon
)brace
DECL|function|mii_write
r_static
r_void
id|mii_write
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
id|phy
comma
r_int
id|reg
comma
id|u16
id|data
)paren
(brace
r_while
c_loop
(paren
id|ioc3-&gt;micr
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
id|ioc3-&gt;midr_w
op_assign
id|data
suffix:semicolon
id|ioc3-&gt;micr
op_assign
(paren
id|phy
op_lshift
id|MICR_PHYADDR_SHIFT
)paren
op_or
id|reg
suffix:semicolon
r_while
c_loop
(paren
id|ioc3-&gt;micr
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
)brace
r_static
r_int
id|ioc3_mii_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
suffix:semicolon
DECL|function|ioc3_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ioc3_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
(paren
r_struct
id|ioc3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|ip-&gt;stats.collisions
op_add_assign
(paren
id|ioc3-&gt;etcdc
op_amp
id|ETCDC_COLLCNT_MASK
)paren
suffix:semicolon
r_return
op_amp
id|ip-&gt;stats
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ioc3_rx
id|ioc3_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|new_skb
suffix:semicolon
r_int
id|rx_entry
comma
id|n_entry
comma
id|len
suffix:semicolon
r_struct
id|ioc3_erxbuf
op_star
id|rxb
suffix:semicolon
r_int
r_int
op_star
id|rxr
suffix:semicolon
id|u32
id|w0
comma
id|err
suffix:semicolon
id|rxr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ip-&gt;rxr
suffix:semicolon
multiline_comment|/* Ring base */
id|rx_entry
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
multiline_comment|/* RX consume index */
id|n_entry
op_assign
id|ip-&gt;rx_pi
suffix:semicolon
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|rx_entry
)braket
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
(paren
id|skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:semicolon
id|w0
op_assign
id|rxb-&gt;w0
suffix:semicolon
r_while
c_loop
(paren
id|w0
op_amp
id|ERXBUF_V
)paren
(brace
id|err
op_assign
id|rxb-&gt;err
suffix:semicolon
multiline_comment|/* It&squot;s valid ...  */
r_if
c_cond
(paren
id|err
op_amp
id|ERXBUF_GOODPKT
)paren
(brace
id|len
op_assign
(paren
id|w0
op_rshift
id|ERXBUF_BYTECNT_SHIFT
)paren
op_amp
l_int|0x7ff
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ip-&gt;rx_skbs
(braket
id|rx_entry
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Poison  */
id|new_skb
op_assign
id|ioc3_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
multiline_comment|/* Ouch, drop packet and just recycle packet&n;&t;&t;&t;&t;   to keep the ring filled.  */
id|ip-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|new_skb
op_assign
id|skb
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Because we reserve afterwards. */
id|skb_put
c_func
(paren
id|new_skb
comma
(paren
l_int|1664
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
id|new_skb-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|ip-&gt;stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* Statistics */
id|ip-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The frame is invalid and the skb never&n;                           reached the network layer so we can just&n;                           recycle it.  */
id|new_skb
op_assign
id|skb
suffix:semicolon
id|ip-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_amp
id|ERXBUF_CRCERR
)paren
multiline_comment|/* Statistics */
id|ip-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err
op_amp
id|ERXBUF_FRAMERR
)paren
id|ip-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
id|next
suffix:colon
id|ip-&gt;rx_skbs
(braket
id|n_entry
)braket
op_assign
id|new_skb
suffix:semicolon
id|rxr
(braket
id|n_entry
)braket
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|rxb
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
id|rxb-&gt;w0
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear valid flag */
id|n_entry
op_assign
(paren
id|n_entry
op_plus
l_int|1
)paren
op_amp
l_int|511
suffix:semicolon
multiline_comment|/* Update erpir */
multiline_comment|/* Now go on to the next ring entry.  */
id|rx_entry
op_assign
(paren
id|rx_entry
op_plus
l_int|1
)paren
op_amp
l_int|511
suffix:semicolon
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|rx_entry
)braket
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
(paren
id|skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:semicolon
id|w0
op_assign
id|rxb-&gt;w0
suffix:semicolon
)brace
id|ioc3-&gt;erpir
op_assign
(paren
id|n_entry
op_lshift
l_int|3
)paren
op_or
id|ERPIR_ARM
suffix:semicolon
id|ip-&gt;rx_pi
op_assign
id|n_entry
suffix:semicolon
id|ip-&gt;rx_ci
op_assign
id|rx_entry
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ioc3_tx
id|ioc3_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_int
r_int
id|packets
comma
id|bytes
suffix:semicolon
r_int
id|tx_entry
comma
id|o_entry
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|etcir
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|etcir
op_assign
id|ioc3-&gt;etcir
suffix:semicolon
id|tx_entry
op_assign
(paren
id|etcir
op_rshift
l_int|7
)paren
op_amp
l_int|127
suffix:semicolon
id|o_entry
op_assign
id|ip-&gt;tx_ci
suffix:semicolon
id|packets
op_assign
l_int|0
suffix:semicolon
id|bytes
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|o_entry
op_ne
id|tx_entry
)paren
(brace
id|packets
op_increment
suffix:semicolon
id|skb
op_assign
id|ip-&gt;tx_skbs
(braket
id|o_entry
)braket
suffix:semicolon
id|bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ip-&gt;tx_skbs
(braket
id|o_entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|o_entry
op_assign
(paren
id|o_entry
op_plus
l_int|1
)paren
op_amp
l_int|127
suffix:semicolon
multiline_comment|/* Next */
id|etcir
op_assign
id|ioc3-&gt;etcir
suffix:semicolon
multiline_comment|/* More pkts sent?  */
id|tx_entry
op_assign
(paren
id|etcir
op_rshift
l_int|7
)paren
op_amp
l_int|127
suffix:semicolon
)brace
id|ip-&gt;stats.tx_packets
op_add_assign
id|packets
suffix:semicolon
id|ip-&gt;stats.tx_bytes
op_add_assign
id|bytes
suffix:semicolon
id|ip-&gt;txqlen
op_sub_assign
id|packets
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;txqlen
OL
l_int|128
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ip-&gt;tx_ci
op_assign
id|o_entry
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with fatal IOC3 errors.  This condition might be caused by a hard or&n; * software problems, so we should try to recover&n; * more gracefully if this ever happens.  In theory we might be flooded&n; * with such error interrupts if something really goes wrong, so we might&n; * also consider to take the interface down.&n; */
r_static
r_void
DECL|function|ioc3_error
id|ioc3_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
comma
id|u32
id|eisr
)paren
(brace
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXOFLO
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXBUFOFLO
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX buffer overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXMEMERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX PCI error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXPARERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX SSRAM parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_TXBUFUFLO
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX buffer underflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_TXMEMERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX PCI error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|ioc3_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_mii_init
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread.  */
DECL|function|ioc3_interrupt
r_static
r_void
id|ioc3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|_dev
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_const
id|u32
id|enabled
op_assign
id|EISR_RXTIMERINT
op_or
id|EISR_RXOFLO
op_or
id|EISR_RXBUFOFLO
op_or
id|EISR_RXMEMERR
op_or
id|EISR_RXPARERR
op_or
id|EISR_TXBUFUFLO
op_or
id|EISR_TXEXPLICIT
op_or
id|EISR_TXMEMERR
suffix:semicolon
id|u32
id|eisr
suffix:semicolon
id|eisr
op_assign
id|ioc3-&gt;eisr
op_amp
id|enabled
suffix:semicolon
r_while
c_loop
(paren
id|eisr
)paren
(brace
id|ioc3-&gt;eisr
op_assign
id|eisr
suffix:semicolon
id|ioc3-&gt;eisr
suffix:semicolon
multiline_comment|/* Flush */
r_if
c_cond
(paren
id|eisr
op_amp
(paren
id|EISR_RXOFLO
op_or
id|EISR_RXBUFOFLO
op_or
id|EISR_RXMEMERR
op_or
id|EISR_RXPARERR
op_or
id|EISR_TXBUFUFLO
op_or
id|EISR_TXMEMERR
)paren
)paren
id|ioc3_error
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
comma
id|eisr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXTIMERINT
)paren
id|ioc3_rx
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_TXEXPLICIT
)paren
id|ioc3_tx
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
id|eisr
op_assign
id|ioc3-&gt;eisr
op_amp
id|enabled
suffix:semicolon
)brace
)brace
DECL|function|negotiate
r_static
r_void
id|negotiate
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
(paren
r_struct
id|ioc3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|ip-&gt;negtimer
comma
id|jiffies
op_plus
l_int|20
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|ioc3_mii_init
r_static
r_int
id|ioc3_mii_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
id|u16
id|word
comma
id|mii0
suffix:semicolon
r_int
id|i
comma
id|phy
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|phy
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|word
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|i
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|word
op_ne
l_int|0xffff
)paren
op_logical_and
(paren
id|word
op_ne
l_int|0x0000
)paren
)paren
(brace
id|phy
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Found a PHY&t;&t;*/
)brace
)brace
r_if
c_cond
(paren
id|phy
op_eq
op_minus
l_int|1
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ip-&gt;phy
op_assign
id|phy
suffix:semicolon
multiline_comment|/* Autonegotiate 100mbit and fullduplex. */
id|mii0
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|ip-&gt;phy
comma
l_int|0
)paren
suffix:semicolon
id|mii_write
c_func
(paren
id|ioc3
comma
id|ip-&gt;phy
comma
l_int|0
comma
id|mii0
op_or
l_int|0x3100
)paren
suffix:semicolon
id|ip-&gt;negtimer.function
op_assign
op_amp
id|negotiate
suffix:semicolon
id|ip-&gt;negtimer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|ip-&gt;negtimer
comma
id|jiffies
)paren
suffix:semicolon
multiline_comment|/* Run it now  */
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ioc3_clean_rx_ring
id|ioc3_clean_rx_ring
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
id|i
op_amp
l_int|15
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ip-&gt;rx_skbs
(braket
id|ip-&gt;rx_pi
)braket
op_assign
id|ip-&gt;rx_skbs
(braket
id|ip-&gt;rx_ci
)braket
suffix:semicolon
id|ip-&gt;rxr
(braket
id|ip-&gt;rx_pi
op_increment
)braket
op_assign
id|ip-&gt;rxr
(braket
id|ip-&gt;rx_ci
op_increment
)braket
suffix:semicolon
)brace
id|ip-&gt;rx_pi
op_and_assign
l_int|511
suffix:semicolon
id|ip-&gt;rx_ci
op_and_assign
l_int|511
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
id|i
op_ne
id|ip-&gt;rx_pi
suffix:semicolon
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_amp
l_int|511
)paren
(brace
r_struct
id|ioc3_erxbuf
op_star
id|rxb
suffix:semicolon
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|i
)braket
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
(paren
id|skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:semicolon
id|rxb-&gt;w0
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|ioc3_clean_tx_ring
id|ioc3_clean_tx_ring
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|ip-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|ip-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|ip-&gt;txr
(braket
id|i
)braket
dot
id|cmd
op_assign
l_int|0
suffix:semicolon
)brace
id|ip-&gt;tx_pi
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;tx_ci
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ioc3_free_rings
id|ioc3_free_rings
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|rx_entry
comma
id|n_entry
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;txr
)paren
(brace
id|ioc3_clean_tx_ring
c_func
(paren
id|ip
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ip-&gt;txr
comma
l_int|2
)paren
suffix:semicolon
id|ip-&gt;txr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip-&gt;rxr
)paren
(brace
id|n_entry
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
id|rx_entry
op_assign
id|ip-&gt;rx_pi
suffix:semicolon
r_while
c_loop
(paren
id|n_entry
op_ne
id|rx_entry
)paren
(brace
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|n_entry
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|n_entry
op_assign
(paren
id|n_entry
op_plus
l_int|1
)paren
op_amp
l_int|511
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|ip-&gt;rxr
)paren
suffix:semicolon
id|ip-&gt;rxr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ioc3_alloc_rings
id|ioc3_alloc_rings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_struct
id|ioc3_erxbuf
op_star
id|rxb
suffix:semicolon
r_int
r_int
op_star
id|rxr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;rxr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate and initialize rx ring.  4kb = 512 entries  */
id|ip-&gt;rxr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_ATOMIC
)paren
suffix:semicolon
id|rxr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ip-&gt;rxr
suffix:semicolon
multiline_comment|/* Now the rx buffers.  The RX ring may be larger but&n;&t;&t;   we only allocate 16 buffers for now.  Need to tune&n;&t;&t;   this for performance and memory later.  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|ioc3_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|show_free_areas
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ip-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Because we reserve afterwards. */
id|skb_put
c_func
(paren
id|skb
comma
(paren
l_int|1664
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|rxr
(braket
id|i
)braket
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|rxb
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
)brace
id|ip-&gt;rx_ci
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;rx_pi
op_assign
id|RX_BUFFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip-&gt;txr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate and initialize tx rings.  16kb = 128 bufs.  */
id|ip-&gt;txr
op_assign
(paren
r_struct
id|ioc3_etxd
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_ATOMIC
comma
l_int|2
)paren
suffix:semicolon
id|ip-&gt;tx_pi
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;tx_ci
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ioc3_init_rings
id|ioc3_init_rings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ioc3_private
op_star
id|ip
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_int
r_int
id|ring
suffix:semicolon
id|ioc3_free_rings
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_alloc_rings
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
id|ioc3_clean_rx_ring
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_clean_tx_ring
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/* Now the rx ring base, consume &amp; produce registers.  */
id|ring
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|ip-&gt;rxr
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
id|ioc3-&gt;erbr_h
op_assign
id|ring
op_rshift
l_int|32
suffix:semicolon
id|ioc3-&gt;erbr_l
op_assign
id|ring
op_amp
l_int|0xffffffff
suffix:semicolon
id|ioc3-&gt;ercir
op_assign
(paren
id|ip-&gt;rx_ci
op_lshift
l_int|3
)paren
suffix:semicolon
id|ioc3-&gt;erpir
op_assign
(paren
id|ip-&gt;rx_pi
op_lshift
l_int|3
)paren
op_or
id|ERPIR_ARM
suffix:semicolon
id|ring
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|ip-&gt;txr
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
id|ip-&gt;txqlen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* nothing queued  */
multiline_comment|/* Now the tx ring base, consume &amp; produce registers.  */
id|ioc3-&gt;etbr_h
op_assign
id|ring
op_rshift
l_int|32
suffix:semicolon
id|ioc3-&gt;etbr_l
op_assign
id|ring
op_amp
l_int|0xffffffff
suffix:semicolon
id|ioc3-&gt;etpir
op_assign
(paren
id|ip-&gt;tx_pi
op_lshift
l_int|7
)paren
suffix:semicolon
id|ioc3-&gt;etcir
op_assign
(paren
id|ip-&gt;tx_ci
op_lshift
l_int|7
)paren
suffix:semicolon
id|ioc3-&gt;etcir
suffix:semicolon
multiline_comment|/* Flush */
)brace
r_static
r_inline
r_void
DECL|function|ioc3_ssram_disc
id|ioc3_ssram_disc
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_volatile
id|u32
op_star
id|ssram0
op_assign
op_amp
id|ioc3-&gt;ssram
(braket
l_int|0x0000
)braket
suffix:semicolon
r_volatile
id|u32
op_star
id|ssram1
op_assign
op_amp
id|ioc3-&gt;ssram
(braket
l_int|0x4000
)braket
suffix:semicolon
r_int
r_int
id|pattern
op_assign
l_int|0x5555
suffix:semicolon
multiline_comment|/* Assume the larger size SSRAM and enable parity checking */
id|ioc3-&gt;emcr
op_or_assign
(paren
id|EMCR_BUFSIZ
op_or
id|EMCR_RAMPAR
)paren
suffix:semicolon
op_star
id|ssram0
op_assign
id|pattern
suffix:semicolon
op_star
id|ssram1
op_assign
op_complement
id|pattern
op_amp
id|IOC3_SSRAM_DM
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ssram0
op_amp
id|IOC3_SSRAM_DM
)paren
op_ne
id|pattern
op_logical_or
(paren
op_star
id|ssram1
op_amp
id|IOC3_SSRAM_DM
)paren
op_ne
(paren
op_complement
id|pattern
op_amp
id|IOC3_SSRAM_DM
)paren
)paren
(brace
multiline_comment|/* set ssram size to 64 KB */
id|ip-&gt;emcr
op_assign
id|EMCR_RAMPAR
suffix:semicolon
id|ioc3-&gt;emcr
op_and_assign
op_complement
id|EMCR_BUFSIZ
suffix:semicolon
)brace
r_else
(brace
id|ip-&gt;emcr
op_assign
id|EMCR_BUFSIZ
op_or
id|EMCR_RAMPAR
suffix:semicolon
)brace
)brace
DECL|function|ioc3_init
r_static
r_void
id|ioc3_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|ioc3-&gt;emcr
op_assign
id|EMCR_RST
suffix:semicolon
multiline_comment|/* Reset&t;&t;*/
id|ioc3-&gt;emcr
suffix:semicolon
multiline_comment|/* flush WB&t;&t;*/
id|udelay
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Give it time ...&t;*/
id|ioc3-&gt;emcr
op_assign
l_int|0
suffix:semicolon
id|ioc3-&gt;emcr
suffix:semicolon
multiline_comment|/* Misc registers  */
id|ioc3-&gt;erbar
op_assign
l_int|0
suffix:semicolon
id|ioc3-&gt;etcsr
op_assign
(paren
l_int|17
op_lshift
id|ETCSR_IPGR2_SHIFT
)paren
op_or
(paren
l_int|11
op_lshift
id|ETCSR_IPGR1_SHIFT
)paren
op_or
l_int|21
suffix:semicolon
id|ioc3-&gt;etcdc
suffix:semicolon
multiline_comment|/* Clear on read */
id|ioc3-&gt;ercsr
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* RX low watermark  */
id|ioc3-&gt;ertr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Interrupt immediately */
id|ioc3-&gt;emar_h
op_assign
(paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
id|ioc3-&gt;emar_l
op_assign
(paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|ioc3-&gt;ehar_h
op_assign
id|ip-&gt;ehar_h
suffix:semicolon
id|ioc3-&gt;ehar_l
op_assign
id|ip-&gt;ehar_l
suffix:semicolon
id|ioc3-&gt;ersr
op_assign
l_int|42
suffix:semicolon
multiline_comment|/* XXX should be random */
id|ioc3_init_rings
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
id|ip-&gt;emcr
op_or_assign
(paren
(paren
id|RX_OFFSET
op_div
l_int|2
)paren
op_lshift
id|EMCR_RXOFF_SHIFT
)paren
op_or
id|EMCR_TXDMAEN
op_or
id|EMCR_TXEN
op_or
id|EMCR_RXDMAEN
op_or
id|EMCR_RXEN
suffix:semicolon
id|ioc3-&gt;emcr
op_assign
id|ip-&gt;emcr
suffix:semicolon
id|ioc3-&gt;eier
op_assign
id|EISR_RXTIMERINT
op_or
id|EISR_RXOFLO
op_or
id|EISR_RXBUFOFLO
op_or
id|EISR_RXMEMERR
op_or
id|EISR_RXPARERR
op_or
id|EISR_TXBUFUFLO
op_or
id|EISR_TXEXPLICIT
op_or
id|EISR_TXMEMERR
suffix:semicolon
id|ioc3-&gt;eier
suffix:semicolon
)brace
DECL|function|ioc3_stop
r_static
r_inline
r_void
id|ioc3_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|ioc3-&gt;emcr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Shutup */
id|ioc3-&gt;eier
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|ioc3-&gt;eier
suffix:semicolon
multiline_comment|/* Flush */
)brace
r_static
r_int
DECL|function|ioc3_open
id|ioc3_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ioc3_interrupt
comma
l_int|0
comma
id|ioc3_str
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|ip
op_assign
(paren
r_struct
id|ioc3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ip-&gt;ehar_h
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;ehar_l
op_assign
l_int|0
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ioc3_close
id|ioc3_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ip-&gt;negtimer
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Flush */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|ioc3_free_rings
c_func
(paren
id|ip
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_pci_init
r_static
r_int
id|ioc3_pci_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u16
id|mii0
comma
id|mii_status
comma
id|mii2
comma
id|mii3
comma
id|mii4
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// XXX
r_struct
id|ioc3_private
op_star
id|ip
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
r_int
r_int
id|ioc3_base
comma
id|ioc3_size
suffix:semicolon
id|u32
id|vendor
comma
id|model
comma
id|rev
suffix:semicolon
r_int
id|phy
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|ioc3_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|ip
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ip
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This probably needs to be register_netdevice, or call&n;&t; * init_etherdev so that it calls register_netdevice. Quick&n;&t; * hack for now.&n;&t; */
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|ioc3_base
op_assign
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|ioc3_size
op_assign
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|ioc3_base
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|ioremap
c_func
(paren
id|ioc3_base
comma
id|ioc3_size
)paren
suffix:semicolon
id|ip-&gt;regs
op_assign
id|ioc3
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ip-&gt;emcr
op_assign
l_int|0
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ip-&gt;negtimer
)paren
suffix:semicolon
id|ioc3_mii_init
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
id|phy
op_assign
id|ip-&gt;phy
suffix:semicolon
r_if
c_cond
(paren
id|phy
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: Didn&squot;t find a PHY, goodbye.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|ioc3_free_rings
c_func
(paren
id|ip
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|mii0
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|phy
comma
l_int|0
)paren
suffix:semicolon
id|mii_status
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|phy
comma
l_int|1
)paren
suffix:semicolon
id|mii2
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|phy
comma
l_int|2
)paren
suffix:semicolon
id|mii3
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|phy
comma
l_int|3
)paren
suffix:semicolon
id|mii4
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|phy
comma
l_int|4
)paren
suffix:semicolon
id|vendor
op_assign
(paren
id|mii2
op_lshift
l_int|12
)paren
op_or
(paren
id|mii3
op_rshift
l_int|4
)paren
suffix:semicolon
id|model
op_assign
(paren
id|mii3
op_rshift
l_int|4
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|rev
op_assign
id|mii3
op_amp
l_int|0xf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Using PHY %d, vendor 0x%x, model %d, rev %d.&bslash;n&quot;
comma
id|phy
comma
id|vendor
comma
id|model
comma
id|rev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  MII transceiver found at MDIO address &quot;
l_string|&quot;%d, config %4.4x status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
comma
id|mii0
comma
id|mii_status
)paren
suffix:semicolon
id|ioc3_ssram_disc
c_func
(paren
id|ip
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IOC3 SSRAM has %d kbyte.&bslash;n&quot;
comma
id|ip-&gt;emcr
op_amp
id|EMCR_BUFSIZ
ques
c_cond
l_int|128
suffix:colon
l_int|64
)paren
suffix:semicolon
id|ioc3_get_eaddr
c_func
(paren
id|dev
comma
id|ioc3
)paren
suffix:semicolon
multiline_comment|/* The IOC3-specific entries in the device structure. */
id|dev-&gt;open
op_assign
id|ioc3_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ioc3_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ioc3_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ioc3_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ioc3_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|ioc3_ioctl
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ioc3_set_multicast_list
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_probe
r_static
r_int
id|__init
id|ioc3_probe
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SGI
comma
id|PCI_DEVICE_ID_SGI_IOC3
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|ioc3_pci_init
c_func
(paren
id|pdev
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|cards
op_increment
suffix:semicolon
)brace
)brace
r_return
id|cards
ques
c_cond
op_minus
id|ENODEV
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_cleanup_module
r_static
r_void
id|__exit
id|ioc3_cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Later, when we really support modules.  */
)brace
r_static
r_int
DECL|function|ioc3_start_xmit
id|ioc3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_struct
id|ioc3_etxd
op_star
id|desc
suffix:semicolon
r_int
id|produce
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|data
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|produce
op_assign
id|ip-&gt;tx_pi
suffix:semicolon
id|desc
op_assign
op_amp
id|ip-&gt;txr
(braket
id|produce
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|104
)paren
(brace
multiline_comment|/* Short packet, let&squot;s copy it directly into the ring.  */
id|memcpy
c_func
(paren
id|desc-&gt;data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
multiline_comment|/* Very short packet, pad with zeros at the end. */
id|memset
c_func
(paren
id|desc-&gt;data
op_plus
id|len
comma
l_int|0
comma
id|ETH_ZLEN
op_minus
id|len
)paren
suffix:semicolon
id|len
op_assign
id|ETH_ZLEN
suffix:semicolon
)brace
id|desc-&gt;cmd
op_assign
id|len
op_or
id|ETXD_INTWHENDONE
op_or
id|ETXD_D0V
suffix:semicolon
id|desc-&gt;bufcnt
op_assign
id|len
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|data
op_xor
(paren
id|data
op_plus
id|len
)paren
)paren
op_amp
l_int|0x4000
)paren
(brace
r_int
r_int
id|b2
comma
id|s1
comma
id|s2
suffix:semicolon
id|b2
op_assign
(paren
id|data
op_or
l_int|0x3fffUL
)paren
op_plus
l_int|1UL
suffix:semicolon
id|s1
op_assign
id|b2
op_minus
id|data
suffix:semicolon
id|s2
op_assign
id|data
op_plus
id|len
op_minus
id|b2
suffix:semicolon
id|desc-&gt;cmd
op_assign
id|len
op_or
id|ETXD_INTWHENDONE
op_or
id|ETXD_B1V
op_or
id|ETXD_B2V
suffix:semicolon
id|desc-&gt;bufcnt
op_assign
(paren
id|s1
op_lshift
id|ETXD_B1CNT_SHIFT
)paren
op_or
(paren
id|s2
op_lshift
id|ETXD_B2CNT_SHIFT
)paren
suffix:semicolon
id|desc-&gt;p1
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
id|data
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
id|desc-&gt;p2
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
id|data
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal sized packet that doesn&squot;t cross a page boundary. */
id|desc-&gt;cmd
op_assign
id|len
op_or
id|ETXD_INTWHENDONE
op_or
id|ETXD_B1V
suffix:semicolon
id|desc-&gt;bufcnt
op_assign
id|len
op_lshift
id|ETXD_B1CNT_SHIFT
suffix:semicolon
id|desc-&gt;p1
op_assign
(paren
l_int|0xa5UL
op_lshift
l_int|56
)paren
op_or
(paren
id|data
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
)brace
id|BARRIER
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ip-&gt;tx_skbs
(braket
id|produce
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/* Remember skb */
id|produce
op_assign
(paren
id|produce
op_plus
l_int|1
)paren
op_amp
l_int|127
suffix:semicolon
id|ip-&gt;tx_pi
op_assign
id|produce
suffix:semicolon
id|ioc3-&gt;etpir
op_assign
id|produce
op_lshift
l_int|7
suffix:semicolon
multiline_comment|/* Fire ... */
id|ip-&gt;txqlen
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;txqlen
OG
l_int|127
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_timeout
r_static
r_void
id|ioc3_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_mii_init
c_func
(paren
id|dev
comma
id|ip
comma
id|ioc3
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Given a multicast ethernet address, this routine calculates the&n; * address&squot;s bit index in the logical address filter mask&n; */
DECL|macro|CRC_MASK
mdefine_line|#define CRC_MASK        0xEDB88320
r_static
r_inline
r_int
r_int
DECL|function|ioc3_hash
id|ioc3_hash
c_func
(paren
r_const
r_int
r_char
op_star
id|addr
)paren
(brace
r_int
r_int
id|temp
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
r_int
r_int
id|crc
suffix:semicolon
r_int
id|bits
comma
id|len
suffix:semicolon
id|len
op_assign
id|ETH_ALEN
suffix:semicolon
r_for
c_loop
(paren
id|crc
op_assign
op_complement
l_int|0
suffix:semicolon
op_decrement
id|len
op_ge
l_int|0
suffix:semicolon
id|addr
op_increment
)paren
(brace
id|byte
op_assign
op_star
id|addr
suffix:semicolon
r_for
c_loop
(paren
id|bits
op_assign
l_int|8
suffix:semicolon
op_decrement
id|bits
op_ge
l_int|0
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|byte
op_xor
id|crc
)paren
op_amp
l_int|1
)paren
id|crc
op_assign
(paren
id|crc
op_rshift
l_int|1
)paren
op_xor
id|CRC_MASK
suffix:semicolon
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|crc
op_and_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* bit reverse lowest 6 bits for hash index */
r_for
c_loop
(paren
id|bits
op_assign
l_int|6
suffix:semicolon
op_decrement
id|bits
op_ge
l_int|0
suffix:semicolon
)paren
(brace
id|temp
op_lshift_assign
l_int|1
suffix:semicolon
id|temp
op_or_assign
(paren
id|crc
op_amp
l_int|0x1
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|temp
suffix:semicolon
)brace
multiline_comment|/* Provide ioctl() calls to examine the MII xcvr state. */
DECL|function|ioc3_ioctl
r_static
r_int
id|ioc3_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
(paren
r_struct
id|ioc3_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_int
id|phy
op_assign
id|ip-&gt;phy
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get the address of the PHY in use.  */
r_if
c_cond
(paren
id|phy
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|phy
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read any PHY register.  */
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|mii_read
c_func
(paren
id|ioc3
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write any PHY register.  */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|mii_write
c_func
(paren
id|ioc3
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|ioc3_set_multicast_list
r_static
r_void
id|ioc3_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_char
op_star
id|addr
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|u64
id|ehar
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous.  */
multiline_comment|/* Unconditionally log net taps.  */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ip-&gt;emcr
op_or_assign
id|EMCR_PROMISC
suffix:semicolon
id|ioc3-&gt;emcr
op_assign
id|ip-&gt;emcr
suffix:semicolon
id|ioc3-&gt;emcr
suffix:semicolon
)brace
r_else
(brace
id|ip-&gt;emcr
op_and_assign
op_complement
id|EMCR_PROMISC
suffix:semicolon
id|ioc3-&gt;emcr
op_assign
id|ip-&gt;emcr
suffix:semicolon
multiline_comment|/* Clear promiscuous. */
id|ioc3-&gt;emcr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
multiline_comment|/* Too many for hashing to make sense or we want all&n;&t;&t;&t;   multicast packets anyway,  so skip computing all the&n;&t;&t;&t;   hashes and just accept all packets.  */
id|ip-&gt;ehar_h
op_assign
l_int|0xffffffff
suffix:semicolon
id|ip-&gt;ehar_l
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addr
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|ehar
op_or_assign
(paren
l_int|1UL
op_lshift
id|ioc3_hash
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
id|ip-&gt;ehar_h
op_assign
id|ehar
op_rshift
l_int|32
suffix:semicolon
id|ip-&gt;ehar_l
op_assign
id|ehar
op_amp
l_int|0xffffffff
suffix:semicolon
)brace
id|ioc3-&gt;ehar_h
op_assign
id|ip-&gt;ehar_h
suffix:semicolon
id|ioc3-&gt;ehar_l
op_assign
id|ip-&gt;ehar_l
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ralf Baechle &lt;ralf@oss.sgi.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SGI IOC3 Ethernet driver&quot;
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
DECL|variable|ioc3_probe
id|module_init
c_func
(paren
id|ioc3_probe
)paren
suffix:semicolon
DECL|variable|ioc3_cleanup_module
id|module_exit
c_func
(paren
id|ioc3_cleanup_module
)paren
suffix:semicolon
eof
