multiline_comment|/*&n; * rrunner.c: Linux driver for the Essential RoadRunner HIPPI board.&n; *&n; * Written 1998 by Jes Sorensen, &lt;Jes.Sorensen@cern.ch&gt;.&n; *&n; * Thanks to Essential Communication for providing us with hardware&n; * and very comprehensive documentation without which I would not have&n; * been able to write this driver. A special thank you to John Gibbon&n; * for sorting out the legal issues, with the NDA, allowing the code to&n; * be released under the GPL.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
DECL|macro|DEBUG
mdefine_line|#define DEBUG 1
DECL|macro|RX_DMA_SKBUFF
mdefine_line|#define RX_DMA_SKBUFF 1
DECL|macro|PKT_COPY_THRESHOLD
mdefine_line|#define PKT_COPY_THRESHOLD 512
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/hippidevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;rrunner.h&quot;
multiline_comment|/*&n; * Implementation notes:&n; *&n; * The DMA engine only allows for DMA within physical 64KB chunks of&n; * memory. The current approach of the driver (and stack) is to use&n; * linear blocks of memory for the skbuffs. However, as the data block&n; * is always the first part of the skb and skbs are 2^n aligned so we&n; * are guarantted to get the whole block within one 64KB align 64KB&n; * chunk.&n; *&n; * On the long term, relying on being able to allocate 64KB linear&n; * chunks of memory is not feasible and the skb handling code and the&n; * stack will need to know about I/O vectors or something similar.&n; */
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;rrunner.c: v0.06 09/02/98  Jes Sorensen (Jes.Sorensen@cern.ch)&bslash;n&quot;
suffix:semicolon
r_static
r_int
r_int
id|read_eeprom
c_func
(paren
r_struct
id|rr_private
op_star
id|rrpriv
comma
r_int
r_int
id|offset
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
suffix:semicolon
r_static
id|u32
id|read_eeprom_word
c_func
(paren
r_struct
id|rr_private
op_star
id|rrpriv
comma
r_void
op_star
id|offset
)paren
suffix:semicolon
r_static
r_int
id|rr_load_firmware
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|rr_hippi_probe
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_static
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|boards_found
op_assign
l_int|0
suffix:semicolon
r_int
id|version_disp
suffix:semicolon
multiline_comment|/* was version info already displayed? */
id|u8
id|pci_bus
suffix:semicolon
multiline_comment|/* PCI bus number (0-255) */
id|u8
id|pci_dev_fun
suffix:semicolon
multiline_comment|/* PCI device and function numbers (0-255) */
id|u8
id|pci_latency
suffix:semicolon
id|u16
id|command
suffix:semicolon
multiline_comment|/* PCI Configuration space Command register */
r_int
r_int
id|tmp
suffix:semicolon
id|u8
id|irq
suffix:semicolon
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* is PCI BIOS even present? */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|version_disp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|255
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_ESSENTIAL
comma
id|PCI_DEVICE_ID_ESSENTIAL_ROADRUNNER
comma
id|i
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_dev_fun
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
multiline_comment|/* Enable mastering */
id|command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;shared mem not enabled - unable to configure RoadRunner&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * So we found our HIPPI ... time to tell the system.&n;&t;&t; */
id|dev
op_assign
id|init_hippi_dev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|rr_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Read register base address from&n;&t;&t;   PCI Configuration Space */
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|irq
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|rrpriv-&gt;pci_bus
op_assign
id|pci_bus
suffix:semicolon
id|rrpriv-&gt;pci_dev_fun
op_assign
id|pci_dev_fun
suffix:semicolon
id|sprintf
c_func
(paren
id|rrpriv-&gt;name
comma
l_string|&quot;RoadRunner serial HIPPI&quot;
)paren
suffix:semicolon
macro_line|#ifdef __SMP__
id|spin_lock_init
c_func
(paren
op_amp
id|rrpriv-&gt;lock
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;open
op_assign
op_amp
id|rr_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|rr_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|rr_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|rr_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|rr_ioctl
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Dummy value.&n;&t;&t; */
id|dev-&gt;base_addr
op_assign
l_int|42
suffix:semicolon
multiline_comment|/* display version info if adapter is found */
r_if
c_cond
(paren
op_logical_neg
id|version_disp
)paren
(brace
multiline_comment|/* set display flag to TRUE so that */
multiline_comment|/* we only display this string ONCE */
id|version_disp
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Essential RoadRunner serial HIPPI at 0x%08x, irq %i&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tmp
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|pci_latency
op_le
l_int|48
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  PCI latency counter too low (%i), setting to 48 clocks&bslash;n&quot;
comma
id|pci_latency
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_LATENCY_TIMER
comma
l_int|48
)paren
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|pci_latency
op_le
l_int|0x58
)paren
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_dev_fun
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x58
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * Remap the regs into kernel space.&n;&t;&t; */
id|rrpriv-&gt;regs
op_assign
(paren
r_struct
id|rr_regs
op_star
)paren
id|ioremap
c_func
(paren
id|tmp
comma
l_int|0x1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rrpriv-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:  Unable to map I/O register, RoadRunner %i will be disabled.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Don&squot;t access any registes before this point!&n;&t;&t; */
macro_line|#ifdef __BIG_ENDIAN
id|regs-&gt;HostCtrl
op_or_assign
id|NO_SWAP
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * Need to add a case for little-endian 64-bit hosts here.&n;&t;&t; */
id|rr_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|boards_found
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is bollocks, but we need to tell the net-init&n;&t;&t; * code that it shall go for the next device.&n;&t;&t; */
id|dev-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we&squot;re at this point we&squot;re going through rr_hippi_probe()&n;&t; * for the first time.  Return success (0) if we&squot;ve initialized&n;&t; * 1 or more boards. Otherwise, return failure (-ENODEV).&n;&t; */
r_if
c_cond
(paren
id|boards_found
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Commands are considered to be slow, thus there is no reason to&n; * inline this.&n; */
DECL|function|rr_issue_cmd
r_static
r_void
id|rr_issue_cmd
c_func
(paren
r_struct
id|rr_private
op_star
id|rrpriv
comma
r_struct
id|cmd
op_star
id|cmd
)paren
(brace
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|u32
id|idx
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
multiline_comment|/*&n;&t; * This is temporary - it will go away in the final version.&n;&t; * We probably also want to make this function inline.&n;&t; */
r_if
c_cond
(paren
id|regs-&gt;HostCtrl
op_amp
id|NIC_HALTED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;issuing command for halted NIC, code 0x%x, HostCtrl %08x&bslash;n&quot;
comma
id|cmd-&gt;code
comma
id|regs-&gt;HostCtrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;Mode
op_amp
id|FATAL_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;error code %02x&bslash;n&quot;
comma
id|regs-&gt;Fail1
)paren
suffix:semicolon
)brace
id|idx
op_assign
id|rrpriv-&gt;info-&gt;cmd_ctrl.pi
suffix:semicolon
id|regs-&gt;CmdRing
(braket
id|idx
)braket
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_minus
l_int|1
)paren
op_mod
id|CMD_RING_ENTRIES
suffix:semicolon
id|rrpriv-&gt;info-&gt;cmd_ctrl.pi
op_assign
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;Mode
op_amp
id|FATAL_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;error code %02x&bslash;n&quot;
comma
id|regs-&gt;Fail1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset the board in a sensible manner. The NIC is already halted&n; * when we get here and a spin-lock is held.&n; */
DECL|function|rr_reset
r_static
r_int
id|rr_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
r_struct
id|eeprom
op_star
id|hw
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|start_pc
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|rr_load_firmware
c_func
(paren
id|dev
)paren
suffix:semicolon
id|regs-&gt;TX_state
op_assign
l_int|0x01000000
suffix:semicolon
id|regs-&gt;RX_state
op_assign
l_int|0xff800000
suffix:semicolon
id|regs-&gt;AssistState
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;LocalCtrl
op_assign
id|CLEAR_INTA
suffix:semicolon
id|regs-&gt;BrkPt
op_assign
l_int|0x01
suffix:semicolon
id|regs-&gt;Timer
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;TimerRef
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaReadState
op_assign
id|RESET_DMA
suffix:semicolon
id|regs-&gt;DmaWriteState
op_assign
id|RESET_DMA
suffix:semicolon
id|regs-&gt;DmaWriteHostHi
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaWriteHostLo
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaReadHostHi
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaReadHostLo
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaReadLen
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaWriteLen
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaWriteLcl
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaWriteIPchecksum
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaReadLcl
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DmaReadIPchecksum
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;PciState
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0x90 for GE? */
id|regs-&gt;Mode
op_assign
id|SWAP_DATA
suffix:semicolon
macro_line|#if 0
multiline_comment|/*&n;&t; * Don&squot;t worry, this is just black magic.&n;&t; */
id|regs-&gt;RxBase
op_assign
l_int|0xdf000
suffix:semicolon
id|regs-&gt;RxPrd
op_assign
l_int|0xdf000
suffix:semicolon
id|regs-&gt;RxCon
op_assign
l_int|0xdf000
suffix:semicolon
id|regs-&gt;TxBase
op_assign
l_int|0xce000
suffix:semicolon
id|regs-&gt;TxPrd
op_assign
l_int|0xce000
suffix:semicolon
id|regs-&gt;TxCon
op_assign
l_int|0xce000
suffix:semicolon
id|regs-&gt;RxIndPro
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;RxIndCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;RxIndRef
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;TxIndPro
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;TxIndCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;TxIndRef
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;pad10
(braket
l_int|0
)braket
op_assign
l_int|0xcc000
suffix:semicolon
id|regs-&gt;DrCmndPro
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DrCmndCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DwCmndPro
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DwCmndCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DwCmndRef
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DrDataPro
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DrDataCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DrDataRef
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DwDataPro
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DwDataCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;DwDataRef
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|regs-&gt;MbEvent
op_assign
l_int|0xffffffff
suffix:semicolon
id|regs-&gt;Event
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;TxPi
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;IpRxPi
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;EvtCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;EvtPrd
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CMD_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
id|regs-&gt;CmdRing
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;PciState
op_assign
l_int|0
suffix:semicolon
id|start_pc
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
op_amp
id|hw-&gt;rncd_info.FwStart
)paren
suffix:semicolon
macro_line|#if (DEBUG &gt; 1)
id|printk
c_func
(paren
l_string|&quot;%s: Executing firmware at address 0x%06x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|start_pc
)paren
suffix:semicolon
macro_line|#endif
id|regs-&gt;Pc
op_assign
id|start_pc
op_plus
l_int|0x800
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|regs-&gt;Pc
op_assign
id|start_pc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read a string from the EEPROM.&n; */
DECL|function|read_eeprom
r_static
r_int
r_int
id|read_eeprom
c_func
(paren
r_struct
id|rr_private
op_star
id|rrpriv
comma
r_int
r_int
id|offset
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
(brace
r_struct
id|rr_regs
op_star
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|u32
id|misc
comma
id|io
comma
id|i
suffix:semicolon
id|io
op_assign
id|regs-&gt;ExtIo
suffix:semicolon
id|regs-&gt;ExtIo
op_assign
l_int|0
suffix:semicolon
id|misc
op_assign
id|regs-&gt;LocalCtrl
suffix:semicolon
id|regs-&gt;LocalCtrl
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|regs-&gt;WinBase
op_assign
(paren
id|EEPROM_BASE
op_plus
(paren
(paren
id|offset
op_plus
id|i
)paren
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|buf
(braket
id|i
)braket
op_assign
(paren
id|regs-&gt;WinData
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
id|regs-&gt;LocalCtrl
op_assign
id|misc
suffix:semicolon
id|regs-&gt;ExtIo
op_assign
id|io
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/*&n; * Shortcut to read one word (4 bytes) out of the EEPROM and convert&n; * it to our CPU byte-order.&n; */
DECL|function|read_eeprom_word
r_static
id|u32
id|read_eeprom_word
c_func
(paren
r_struct
id|rr_private
op_star
id|rrpriv
comma
r_void
op_star
id|offset
)paren
(brace
id|u32
id|word
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_eeprom
c_func
(paren
id|rrpriv
comma
(paren
r_int
r_int
)paren
id|offset
comma
(paren
r_char
op_star
)paren
op_amp
id|word
comma
l_int|4
)paren
op_eq
l_int|4
)paren
)paren
r_return
id|be32_to_cpu
c_func
(paren
id|word
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|rr_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|u32
id|sram_size
comma
id|rev
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|rev
op_assign
id|regs-&gt;FwRev
suffix:semicolon
r_if
c_cond
(paren
id|rev
OG
l_int|0x00020024
)paren
id|printk
c_func
(paren
l_string|&quot;  Firmware revision: %i.%i.%i&bslash;n&quot;
comma
(paren
id|rev
op_rshift
l_int|16
)paren
comma
(paren
(paren
id|rev
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|rev
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;  Firmware revision too old: %i.%i.%i, please upgrade to 2.0.37 or later.&bslash;n&quot;
comma
(paren
id|rev
op_rshift
l_int|16
)paren
comma
(paren
(paren
id|rev
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|rev
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;  Maximum receive rings %i&bslash;n&quot;
comma
id|regs-&gt;MaxRxRng
)paren
suffix:semicolon
id|sram_size
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  SRAM size 0x%06x&bslash;n&quot;
comma
id|sram_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rr_init1
r_static
r_int
id|rr_init1
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|u32
id|hostctrl
suffix:semicolon
r_int
r_int
id|myjif
comma
id|flags
comma
id|tmp_ptr
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hostctrl
op_assign
id|regs-&gt;HostCtrl
suffix:semicolon
id|regs-&gt;HostCtrl
op_or_assign
id|HALT_NIC
suffix:semicolon
r_if
c_cond
(paren
id|hostctrl
op_amp
id|PARITY_ERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Parity error halting NIC - this is serious!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|memset
c_func
(paren
id|rrpriv-&gt;rx_ctrl
comma
l_int|0
comma
l_int|256
op_star
r_sizeof
(paren
r_struct
id|ring_ctrl
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rrpriv-&gt;info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rr_info
)paren
)paren
suffix:semicolon
id|tmp_ptr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|rrpriv-&gt;rx_ctrl
)paren
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 64)
id|regs-&gt;RxRingHi
op_assign
(paren
id|tmp_ptr
op_rshift
l_int|32
)paren
suffix:semicolon
macro_line|#else
id|regs-&gt;RxRingHi
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|regs-&gt;RxRingLo
op_assign
(paren
(paren
id|tmp_ptr
)paren
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|tmp_ptr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|rrpriv-&gt;info
)paren
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 64)
id|regs-&gt;InfoPtrHi
op_assign
(paren
id|tmp_ptr
op_rshift
l_int|32
)paren
suffix:semicolon
macro_line|#else
id|regs-&gt;InfoPtrHi
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|regs-&gt;InfoPtrLo
op_assign
(paren
(paren
id|tmp_ptr
)paren
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.entry_size
op_assign
r_sizeof
(paren
r_struct
id|event
)paren
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.entries
op_assign
id|EVT_RING_ENTRIES
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.mode
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|rrpriv-&gt;evt_ring
)paren
suffix:semicolon
id|rrpriv-&gt;info-&gt;cmd_ctrl.entry_size
op_assign
r_sizeof
(paren
r_struct
id|cmd
)paren
suffix:semicolon
id|rrpriv-&gt;info-&gt;cmd_ctrl.entries
op_assign
id|CMD_RING_ENTRIES
suffix:semicolon
id|rrpriv-&gt;info-&gt;cmd_ctrl.mode
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;cmd_ctrl.pi
op_assign
l_int|15
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CMD_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|regs-&gt;CmdRing
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|rrpriv-&gt;info-&gt;tx_ctrl.entry_size
op_assign
r_sizeof
(paren
r_struct
id|tx_desc
)paren
suffix:semicolon
id|rrpriv-&gt;info-&gt;tx_ctrl.entries
op_assign
id|TX_RING_ENTRIES
suffix:semicolon
id|rrpriv-&gt;info-&gt;tx_ctrl.mode
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;tx_ctrl.pi
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;tx_ctrl.rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|rrpriv-&gt;tx_ring
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set dirty_tx before we start receiving interrupts, otherwise&n;&t; * the interrupt handler might think it is supposed to process&n;&t; * tx ints before we are up and running, which may cause a null&n;&t; * pointer access in the int handler.&n;&t; */
id|rrpriv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;dirty_rx
op_assign
id|rrpriv-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|rr_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|regs-&gt;IntrTmr
op_assign
l_int|0x60
suffix:semicolon
id|regs-&gt;WriteDmaThresh
op_assign
l_int|0x80
op_or
l_int|0x1f
suffix:semicolon
id|regs-&gt;ReadDmaThresh
op_assign
l_int|0x80
op_or
l_int|0x1f
suffix:semicolon
id|rrpriv-&gt;fw_running
op_assign
l_int|0
suffix:semicolon
id|hostctrl
op_and_assign
op_complement
(paren
id|HALT_NIC
op_or
id|INVALID_INST_B
op_or
id|PARITY_ERR
)paren
suffix:semicolon
id|regs-&gt;HostCtrl
op_assign
id|hostctrl
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now start the FirmWare.&n;&t; */
id|cmd.code
op_assign
id|C_START_FW
suffix:semicolon
id|cmd.ring
op_assign
l_int|0
suffix:semicolon
id|cmd.index
op_assign
l_int|0
suffix:semicolon
id|rr_issue_cmd
c_func
(paren
id|rrpriv
comma
op_amp
id|cmd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Give the FirmWare time to chew on the `get running&squot; command.&n;&t; */
id|myjif
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
(paren
id|jiffies
OL
id|myjif
)paren
op_logical_and
op_logical_neg
id|rrpriv-&gt;fw_running
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|rrpriv-&gt;rx_ring
(braket
id|i
)braket
dot
id|mode
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|dev-&gt;mtu
op_plus
id|HIPPI_HLEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|rrpriv-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Sanity test to see if we conflict with the DMA&n;&t;&t; * limitations of the Roadrunner.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
)paren
op_amp
l_int|0xfff
)paren
OG
op_complement
l_int|65320
)paren
id|printk
c_func
(paren
l_string|&quot;skb alloc error&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 32)
id|rrpriv-&gt;rx_ring
(braket
id|i
)braket
dot
id|zero
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|rrpriv-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|rrpriv-&gt;rx_ring
(braket
id|i
)braket
dot
id|size
op_assign
id|dev-&gt;mtu
op_plus
id|HIPPI_HLEN
suffix:semicolon
)brace
id|rrpriv-&gt;rx_ctrl
(braket
l_int|4
)braket
dot
id|entry_size
op_assign
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|rrpriv-&gt;rx_ctrl
(braket
l_int|4
)braket
dot
id|entries
op_assign
id|RX_RING_ENTRIES
suffix:semicolon
id|rrpriv-&gt;rx_ctrl
(braket
l_int|4
)braket
dot
id|mode
op_assign
l_int|8
suffix:semicolon
id|rrpriv-&gt;rx_ctrl
(braket
l_int|4
)braket
dot
id|pi
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;rx_ctrl
(braket
l_int|4
)braket
dot
id|rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|rrpriv-&gt;rx_ring
)paren
suffix:semicolon
id|cmd.code
op_assign
id|C_NEW_RNG
suffix:semicolon
id|cmd.ring
op_assign
l_int|4
suffix:semicolon
id|cmd.index
op_assign
l_int|0
suffix:semicolon
id|rr_issue_cmd
c_func
(paren
id|rrpriv
comma
op_amp
id|cmd
)paren
suffix:semicolon
macro_line|#if 0
(brace
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|regs-&gt;ExtIo
suffix:semicolon
id|regs-&gt;ExtIo
op_assign
l_int|0x80
suffix:semicolon
id|i
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|i
)paren
suffix:semicolon
id|regs-&gt;ExtIo
op_assign
id|tmp
suffix:semicolon
)brace
macro_line|#endif
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * All events are considered to be slow (RX/TX ints do not generate&n; * events) and are handled here, outside the main interrupt handler,&n; * to reduce the size of the handler.&n; */
DECL|function|rr_handle_event
r_static
id|u32
id|rr_handle_event
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|prodidx
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|u32
id|tmp
comma
id|eidx
suffix:semicolon
macro_line|#if 0
r_int
id|i
suffix:semicolon
macro_line|#endif
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|eidx
op_assign
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
suffix:semicolon
r_while
c_loop
(paren
id|prodidx
op_ne
id|eidx
)paren
(brace
r_switch
c_cond
(paren
id|rrpriv-&gt;evt_ring
(braket
id|eidx
)braket
dot
id|code
)paren
(brace
r_case
id|E_NIC_UP
suffix:colon
id|tmp
op_assign
id|regs-&gt;FwRev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Firmware revision %i.%i.%i up and running&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|tmp
op_rshift
l_int|16
)paren
comma
(paren
(paren
id|tmp
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|tmp
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|rrpriv-&gt;fw_running
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_LINK_ON
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Optical link ON&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_LINK_OFF
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Optical link OFF&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_RX_IDLE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: RX data not moving&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_WATCHDOG
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: The watchdog is here to see us&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * TX events.&n;&t;&t; */
r_case
id|E_CON_REJ
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Connection rejected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rrpriv-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_CON_TMOUT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Connection timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_DISC_ERR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: HIPPI disconnect error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rrpriv-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_TX_IDLE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter idle&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_TX_LINK_DROP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Link lost during transmit&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rrpriv-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * RX events.&n;&t;&t; */
r_case
id|E_VAL_RNG
suffix:colon
multiline_comment|/* Should be ignored */
macro_line|#if (DEBUG &gt; 2)
id|printk
c_func
(paren
l_string|&quot;%s: RX ring valid event&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|regs-&gt;IpRxPi
op_assign
id|RX_RING_ENTRIES
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_INV_RNG
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: RX ring invalid event&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_RX_RNG_OUT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Receive ring full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_RX_PAR_ERR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Receive parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_RX_LLRC_ERR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Receive LLRC error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_PKT_LN_ERR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Receive packet length error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unhandled event 0x%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rrpriv-&gt;evt_ring
(braket
id|eidx
)braket
dot
id|code
)paren
suffix:semicolon
)brace
id|eidx
op_assign
(paren
id|eidx
op_plus
l_int|1
)paren
op_mod
id|EVT_RING_ENTRIES
suffix:semicolon
)brace
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
op_assign
id|eidx
suffix:semicolon
r_return
id|eidx
suffix:semicolon
)brace
DECL|function|rx_int
r_static
r_int
id|rx_int
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|rxlimit
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|index
comma
id|pkt_len
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|index
op_assign
id|rrpriv-&gt;cur_rx
suffix:semicolon
r_while
c_loop
(paren
id|index
op_ne
id|rxlimit
)paren
(brace
id|pkt_len
op_assign
id|rrpriv-&gt;rx_ring
(braket
id|index
)braket
dot
id|size
suffix:semicolon
macro_line|#if (DEBUG &gt; 2)
id|printk
c_func
(paren
l_string|&quot;index %i, rxlimit %i&bslash;n&quot;
comma
id|index
comma
id|rxlimit
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;len %x, mode %x&bslash;n&quot;
comma
id|pkt_len
comma
id|rrpriv-&gt;rx_ring
(braket
id|index
)braket
dot
id|mode
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
multiline_comment|/*&n; * I have never seen this occur&n; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|rrpriv-&gt;rx_skbuff
(braket
id|index
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Trying to receive in empty skbuff&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pkt_len
OG
l_int|0
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
OL
id|PKT_COPY_THRESHOLD
)paren
(brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|pkt_len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Out of memory deferring packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rrpriv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|defer
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|rrpriv-&gt;rx_skbuff
(braket
id|index
)braket
op_member_access_from_pointer
id|data
comma
id|pkt_len
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|newskb
suffix:semicolon
id|newskb
op_assign
id|alloc_skb
c_func
(paren
id|dev-&gt;mtu
op_plus
id|HIPPI_HLEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newskb
)paren
(brace
id|skb
op_assign
id|rrpriv-&gt;rx_skbuff
(braket
id|index
)braket
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
id|rrpriv-&gt;rx_skbuff
(braket
id|index
)braket
op_assign
id|newskb
suffix:semicolon
id|rrpriv-&gt;rx_ring
(braket
id|index
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|newskb-&gt;data
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Out of memory, deferring packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rrpriv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|defer
suffix:semicolon
)brace
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|hippi_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* send it up */
id|rrpriv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|rrpriv-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|defer
suffix:colon
id|rrpriv-&gt;rx_ring
(braket
id|index
)braket
dot
id|mode
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;rx_ring
(braket
id|index
)braket
dot
id|size
op_assign
id|dev-&gt;mtu
op_plus
id|HIPPI_HLEN
suffix:semicolon
r_if
c_cond
(paren
(paren
id|index
op_amp
l_int|7
)paren
op_eq
l_int|7
)paren
id|regs-&gt;IpRxPi
op_assign
id|index
suffix:semicolon
id|index
op_assign
(paren
id|index
op_plus
l_int|1
)paren
op_mod
id|RX_RING_ENTRIES
suffix:semicolon
)brace
id|rrpriv-&gt;cur_rx
op_assign
id|index
suffix:semicolon
r_return
id|index
suffix:semicolon
)brace
DECL|function|rr_interrupt
r_static
r_void
id|rr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|prodidx
comma
id|eidx
comma
id|txcsmr
comma
id|rxlimit
comma
id|txcon
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|regs-&gt;HostCtrl
op_amp
id|RR_INT
)paren
)paren
(brace
macro_line|#if 0
multiline_comment|/* These are harmless */
id|printk
c_func
(paren
l_string|&quot;%s: spurious interrupt detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;interrupt
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|prodidx
op_assign
id|regs-&gt;EvtPrd
suffix:semicolon
id|txcsmr
op_assign
(paren
id|prodidx
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|rxlimit
op_assign
(paren
id|prodidx
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|prodidx
op_and_assign
l_int|0xff
suffix:semicolon
macro_line|#if (DEBUG &gt; 2)
id|printk
c_func
(paren
l_string|&quot;%s: interrupt, prodidx = %i, eidx = %i&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|prodidx
comma
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
)paren
suffix:semicolon
macro_line|#endif
id|txcon
op_assign
id|rrpriv-&gt;dirty_tx
suffix:semicolon
r_if
c_cond
(paren
id|txcsmr
op_ne
id|txcon
)paren
(brace
r_do
(brace
id|rrpriv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|rrpriv-&gt;stats.tx_bytes
op_add_assign
id|rrpriv-&gt;tx_skbuff
(braket
id|txcon
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|rrpriv-&gt;tx_skbuff
(braket
id|txcon
)braket
)paren
suffix:semicolon
id|rrpriv-&gt;tx_skbuff
(braket
id|txcon
)braket
op_assign
l_int|NULL
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|txcon
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|txcon
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|txcon
)braket
dot
id|mode
op_assign
l_int|0
suffix:semicolon
id|txcon
op_assign
(paren
id|txcon
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
suffix:semicolon
)brace
r_while
c_loop
(paren
id|txcsmr
op_ne
id|txcon
)paren
suffix:semicolon
id|rrpriv-&gt;dirty_tx
op_assign
id|txcon
suffix:semicolon
r_if
c_cond
(paren
id|rrpriv-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
(paren
(paren
(paren
id|rrpriv-&gt;info-&gt;tx_ctrl.pi
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
)paren
op_ne
id|rrpriv-&gt;dirty_tx
)paren
)paren
(brace
id|rrpriv-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
)brace
id|rx_int
c_func
(paren
id|dev
comma
id|rxlimit
)paren
suffix:semicolon
id|eidx
op_assign
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
suffix:semicolon
r_if
c_cond
(paren
id|prodidx
op_ne
id|eidx
)paren
id|eidx
op_assign
id|rr_handle_event
c_func
(paren
id|dev
comma
id|prodidx
)paren
suffix:semicolon
id|eidx
op_or_assign
(paren
(paren
id|txcsmr
op_lshift
l_int|8
)paren
op_or
(paren
id|rxlimit
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|regs-&gt;EvtCon
op_assign
id|eidx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|rr_open
r_static
r_int
id|rr_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
macro_line|#if 0
id|regs-&gt;HostCtrl
op_or_assign
(paren
id|HALT_NIC
op_or
id|RR_CLEAR_INT
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|rr_interrupt
comma
l_int|0
comma
id|rrpriv-&gt;name
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Requested IRQ %d is busy&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|rrpriv-&gt;rx_ctrl
op_assign
id|kmalloc
c_func
(paren
l_int|256
op_star
r_sizeof
(paren
r_struct
id|ring_ctrl
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|rrpriv-&gt;info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rr_info
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|rr_init1
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rr_dump
r_static
r_void
id|rr_dump
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|u32
id|index
comma
id|cons
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: dumping NIC TX rings&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RxPrd %08x, TxPrd %02x, EvtPrd %08x, TxPi %02x, TxCtrlPi %02x&bslash;n&quot;
comma
id|regs-&gt;RxPrd
comma
id|regs-&gt;TxPrd
comma
id|regs-&gt;EvtPrd
comma
id|regs-&gt;TxPi
comma
id|rrpriv-&gt;info-&gt;tx_ctrl.pi
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Error code 0x%x&bslash;n&quot;
comma
id|regs-&gt;Fail1
)paren
suffix:semicolon
id|index
op_assign
(paren
(paren
(paren
id|regs-&gt;EvtPrd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_minus
l_int|1
)paren
op_mod
id|EVT_RING_ENTRIES
suffix:semicolon
id|cons
op_assign
id|rrpriv-&gt;dirty_tx
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TX ring index %i, TX consumer %i&bslash;n&quot;
comma
id|index
comma
id|cons
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rrpriv-&gt;tx_skbuff
(braket
id|index
)braket
)paren
(brace
id|len
op_assign
id|min
c_func
(paren
l_int|0x80
comma
id|rrpriv-&gt;tx_skbuff
(braket
id|index
)braket
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;skbuff for index %i is valid - dumping data (0x%x bytes - DMA len 0x%x)&bslash;n&quot;
comma
id|index
comma
id|len
comma
id|rrpriv-&gt;tx_ring
(braket
id|index
)braket
dot
id|size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|7
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
r_int
r_char
)paren
id|rrpriv-&gt;tx_skbuff
(braket
id|index
)braket
op_member_access_from_pointer
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rrpriv-&gt;tx_skbuff
(braket
id|cons
)braket
)paren
(brace
id|len
op_assign
id|min
c_func
(paren
l_int|0x80
comma
id|rrpriv-&gt;tx_skbuff
(braket
id|cons
)braket
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;skbuff for cons %i is valid - dumping data (0x%x bytes - skbuff len 0x%x)&bslash;n&quot;
comma
id|cons
comma
id|len
comma
id|rrpriv-&gt;tx_skbuff
(braket
id|cons
)braket
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mode 0x%x, size 0x%x,&bslash;n phys %08x (virt %08x), skbuff-addr %08x, truesize 0x%x&bslash;n&quot;
comma
id|rrpriv-&gt;tx_ring
(braket
id|cons
)braket
dot
id|mode
comma
id|rrpriv-&gt;tx_ring
(braket
id|cons
)braket
dot
id|size
comma
id|rrpriv-&gt;tx_ring
(braket
id|cons
)braket
dot
id|addr
comma
(paren
r_int
r_int
)paren
id|bus_to_virt
c_func
(paren
id|rrpriv-&gt;tx_ring
(braket
id|cons
)braket
dot
id|addr
)paren
comma
(paren
r_int
r_int
)paren
id|rrpriv-&gt;tx_skbuff
(braket
id|cons
)braket
op_member_access_from_pointer
id|data
comma
(paren
r_int
r_int
)paren
id|rrpriv-&gt;tx_skbuff
(braket
id|cons
)braket
op_member_access_from_pointer
id|truesize
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|7
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
r_int
r_char
)paren
id|rrpriv-&gt;tx_ring
(braket
id|cons
)braket
dot
id|size
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;dumping TX ring info:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;mode 0x%x, size 0x%x, phys-addr %08x&bslash;n&quot;
comma
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|mode
comma
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|size
comma
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
)paren
suffix:semicolon
)brace
DECL|function|rr_close
r_static
r_int
id|rr_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
id|tmp
op_assign
id|regs-&gt;HostCtrl
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|NIC_HALTED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: NIC already halted&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rr_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|tmp
op_or_assign
id|HALT_NIC
suffix:semicolon
)brace
id|regs-&gt;HostCtrl
op_assign
id|tmp
suffix:semicolon
multiline_comment|/*&n;&t; * Lock to make sure we are not cleaning up while another CPU&n;&t; * handling interrupts.&n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|rrpriv-&gt;lock
)paren
suffix:semicolon
id|regs-&gt;TxPi
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;IpRxPi
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;EvtCon
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;EvtPrd
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CMD_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
id|regs-&gt;CmdRing
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;tx_ctrl.entries
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;cmd_ctrl.pi
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;info-&gt;evt_ctrl.pi
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;rx_ctrl
(braket
l_int|4
)braket
dot
id|entries
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rrpriv-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|rrpriv-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rrpriv-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
id|rrpriv-&gt;rx_ring
(braket
id|i
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|rrpriv-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|rrpriv-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|rrpriv-&gt;rx_ctrl
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rrpriv-&gt;info
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|rrpriv-&gt;lock
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rr_start_xmit
r_static
r_int
id|rr_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
r_struct
id|ring_ctrl
op_star
id|txctrl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|index
comma
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|u32
op_star
id|ifield
suffix:semicolon
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
multiline_comment|/*&n;&t; * We probably need to deal with tbusy here to prevent overruns.&n;&t; */
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;incoming skb too small - reallocating&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|8
)paren
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|new_skb
comma
l_int|8
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|new_skb-&gt;data
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|new_skb
suffix:semicolon
)brace
id|ifield
op_assign
(paren
id|u32
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|8
)paren
suffix:semicolon
id|ifield
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ifield
(braket
l_int|1
)braket
op_assign
id|skb
op_member_access_from_pointer
r_private
dot
id|ifield
suffix:semicolon
multiline_comment|/*&n;&t; * We don&squot;t need the lock before we are actually going to start&n;&t; * fiddling with the control blocks.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|txctrl
op_assign
op_amp
id|rrpriv-&gt;info-&gt;tx_ctrl
suffix:semicolon
id|index
op_assign
id|txctrl-&gt;pi
suffix:semicolon
id|rrpriv-&gt;tx_skbuff
(braket
id|index
)braket
op_assign
id|skb
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|index
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|rrpriv-&gt;tx_ring
(braket
id|index
)braket
dot
id|size
op_assign
id|len
op_plus
l_int|8
suffix:semicolon
multiline_comment|/* include IFIELD */
id|rrpriv-&gt;tx_ring
(braket
id|index
)braket
dot
id|mode
op_assign
id|PACKET_START
op_or
id|PACKET_END
suffix:semicolon
id|txctrl-&gt;pi
op_assign
(paren
id|index
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
suffix:semicolon
id|regs-&gt;TxPi
op_assign
id|txctrl-&gt;pi
suffix:semicolon
r_if
c_cond
(paren
id|txctrl-&gt;pi
op_eq
id|rrpriv-&gt;dirty_tx
)paren
(brace
id|rrpriv-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rrpriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rr_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|rr_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|rrpriv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the firmware out of the EEPROM and put it into the SRAM&n; * (or from user space - later)&n; *&n; * This operation requires the NIC to be halted and is performed with&n; * interrupts disabled and with the spinlock hold.&n; */
DECL|function|rr_load_firmware
r_static
r_int
id|rr_load_firmware
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
r_struct
id|rr_regs
op_star
id|regs
suffix:semicolon
macro_line|#if 0
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
id|localctrl
comma
id|eptr
comma
id|sptr
comma
id|segptr
comma
id|len
comma
id|tmp
suffix:semicolon
id|u32
id|p2len
comma
id|p2size
comma
id|nr_seg
comma
id|revision
comma
id|io
comma
id|sram_size
suffix:semicolon
r_struct
id|eeprom
op_star
id|hw
op_assign
l_int|NULL
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|rrpriv-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|regs-&gt;HostCtrl
op_amp
id|NIC_HALTED
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Trying to load firmware to a running NIC.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|localctrl
op_assign
id|regs-&gt;LocalCtrl
suffix:semicolon
id|regs-&gt;LocalCtrl
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;EvtPrd
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;RxPrd
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;TxPrd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * First wipe the entire SRAM, otherwise we might run into all&n;&t; * kinds of trouble ... sigh, this took almost all afternoon&n;&t; * to track down ;-(&n;&t; */
id|io
op_assign
id|regs-&gt;ExtIo
suffix:semicolon
id|regs-&gt;ExtIo
op_assign
l_int|0
suffix:semicolon
id|sram_size
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
OL
id|sram_size
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|regs-&gt;WinBase
op_assign
id|i
op_star
l_int|4
suffix:semicolon
id|regs-&gt;WinData
op_assign
l_int|0
suffix:semicolon
)brace
id|regs-&gt;ExtIo
op_assign
id|io
suffix:semicolon
id|eptr
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
op_amp
id|hw-&gt;rncd_info.AddrRunCodeSegs
)paren
suffix:semicolon
id|eptr
op_assign
(paren
(paren
id|eptr
op_amp
l_int|0x1fffff
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|p2len
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
(paren
l_int|0x83
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|p2len
op_assign
(paren
id|p2len
op_lshift
l_int|2
)paren
suffix:semicolon
id|p2size
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
(paren
l_int|0x84
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|p2size
op_assign
(paren
(paren
id|p2size
op_amp
l_int|0x1fffff
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eptr
OL
id|p2size
)paren
op_logical_or
(paren
id|eptr
OG
(paren
id|p2size
op_plus
id|p2len
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: eptr is invalid&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|revision
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
op_amp
id|hw-&gt;manf.HeaderFmt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: invalid firmware format (%i)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|revision
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|nr_seg
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
id|eptr
)paren
suffix:semicolon
id|eptr
op_add_assign
l_int|4
suffix:semicolon
macro_line|#if (DEBUG &gt; 1)
id|printk
c_func
(paren
l_string|&quot;%s: nr_seg %i&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|nr_seg
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_seg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sptr
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
id|eptr
)paren
suffix:semicolon
id|eptr
op_add_assign
l_int|4
suffix:semicolon
id|len
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
id|eptr
)paren
suffix:semicolon
id|eptr
op_add_assign
l_int|4
suffix:semicolon
id|segptr
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
id|eptr
)paren
suffix:semicolon
id|segptr
op_assign
(paren
(paren
id|segptr
op_amp
l_int|0x1fffff
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|eptr
op_add_assign
l_int|4
suffix:semicolon
macro_line|#if (DEBUG &gt; 1)
id|printk
c_func
(paren
l_string|&quot;%s: segment %i, sram address %06x, length %04x, segptr %06x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|sptr
comma
id|len
comma
id|segptr
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|len
suffix:semicolon
id|j
op_increment
)paren
(brace
id|tmp
op_assign
id|read_eeprom_word
c_func
(paren
id|rrpriv
comma
(paren
r_void
op_star
)paren
id|segptr
)paren
suffix:semicolon
id|regs-&gt;WinBase
op_assign
id|sptr
suffix:semicolon
id|regs-&gt;WinData
op_assign
id|tmp
suffix:semicolon
id|segptr
op_add_assign
l_int|4
suffix:semicolon
id|sptr
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|regs-&gt;LocalCtrl
op_assign
id|localctrl
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rr_ioctl
r_static
r_int
id|rr_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|rr_private
op_star
id|rrpriv
suffix:semicolon
id|rrpriv
op_assign
(paren
r_struct
id|rr_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCRRPFW
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|rrpriv-&gt;fw_running
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: firmware already running&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: updating firmware&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; * compile-command: &quot;gcc -D__KERNEL__ -I../../include -Wall -Wstrict-prototypes -O2 -pipe -fomit-frame-pointer -fno-strength-reduce -m486 -malign-loops=2 -malign-jumps=2 -malign-functions=2 -DCPU=686 -c rrunner.c&quot;&n; * End:&n; */
eof
