DECL|macro|PT_DEBUG
macro_line|#undef PT_DEBUG 1
multiline_comment|/*&n; * pt.c: Linux device driver for the Gracilis PackeTwin.&n; * Copyright (c) 1995 Craig Small VK2XLZ (vk2xlz@vk2xlz.ampr.org.)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2, as&n; * published by the Free Software Foundation.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 675 Mass Ave, Cambridge MA 02139, USA.&n; *&n; * This driver is largely based upon the PI driver by David Perry.&n; *&n; * Revision History&n; * 23/02/95 cs  Started again on driver, last one scrapped&n; * 27/02/95 cs  Program works, we have chan A only.  Tx stays on&n; * 28/02/95 cs  Fix Tx problem (&amp; TxUIE instead of | )&n; *&t;&t;Fix Chan B Tx timer problem, used TMR2 instead of TMR1&n; * 03/03/95 cs  Painfully found out (after 3 days) SERIAL_CFG is write only&n; *              created image of it and DMA_CFG&n; * 21/06/95 cs  Upgraded to suit PI driver 0.8 ALPHA&n; * 22/08/95&t;cs&t;Changed it all around to make it like pi driver&n; * 23/08/95 cs  It now works, got caught again by TMR2 and we must have&n; *&t;&t;&t;&t;auto-enables for daughter boards.&n; * 07/10/95 cs  Fixed for 1.3.30 (hopefully)&n; * 26/11/95 cs  Fixed for 1.3.43, ala 29/10 for pi2.c by ac&n; * 21/12/95 cs  Got rid of those nasty warnings when compiling, for 1.3.48&n; * 08/08/96 jsn Convert to use as a module. Removed send_kiss, empty_scc and&n; *&t;&t;pt_loopback functions - they were unused.&n; */
multiline_comment|/* &n; * default configuration of the PackeTwin,&n; * ie What Craig uses his PT for.&n; */
DECL|macro|PT_DMA
mdefine_line|#define PT_DMA 3
DECL|macro|DEF_A_SPEED
mdefine_line|#define DEF_A_SPEED&t;4800&t;&t;/* 4800 baud */
DECL|macro|DEF_A_TXDELAY
mdefine_line|#define DEF_A_TXDELAY&t;350&t;&t;/* 350 mS */
DECL|macro|DEF_A_PERSIST
mdefine_line|#define DEF_A_PERSIST&t;64&t;&t;/* 25% persistence */
DECL|macro|DEF_A_SLOTIME
mdefine_line|#define DEF_A_SLOTIME&t;10&t;&t;/* 10 mS */
DECL|macro|DEF_A_SQUELDELAY
mdefine_line|#define DEF_A_SQUELDELAY 30&t;&t;/* 30 mS */
DECL|macro|DEF_A_CLOCKMODE
mdefine_line|#define DEF_A_CLOCKMODE&t;0&t;&t;/* Normal clock mode */
DECL|macro|DEF_A_NRZI
mdefine_line|#define DEF_A_NRZI&t;&t;1&t;&t;/* NRZI mode */
DECL|macro|DEF_B_SPEED
mdefine_line|#define DEF_B_SPEED&t;0&t;&t;/* 0 means external clock */
DECL|macro|DEF_B_TXDELAY
mdefine_line|#define DEF_B_TXDELAY&t;250&t;&t;/* 250 mS */
DECL|macro|DEF_B_PERSIST
mdefine_line|#define DEF_B_PERSIST&t;64&t;&t;/* 25% */
DECL|macro|DEF_B_SLOTIME
mdefine_line|#define DEF_B_SLOTIME&t;10&t;&t;/* 10 mS */
DECL|macro|DEF_B_SQUELDELAY
mdefine_line|#define DEF_B_SQUELDELAY 30&t;&t;/* 30 mS */
DECL|macro|DEF_B_CLOCKMODE
mdefine_line|#define DEF_B_CLOCKMODE 0 &t;&t;/* Normal clock mode ?!? */
DECL|macro|DEF_B_NRZI
mdefine_line|#define DEF_B_NRZI&t;&t;1&t;&t;/* NRZI mode */
DECL|macro|PARAM_TXDELAY
mdefine_line|#define&t;PARAM_TXDELAY&t;1
DECL|macro|PARAM_PERSIST
mdefine_line|#define&t;PARAM_PERSIST&t;2
DECL|macro|PARAM_SLOTTIME
mdefine_line|#define&t;PARAM_SLOTTIME&t;3
DECL|macro|PARAM_FULLDUP
mdefine_line|#define&t;PARAM_FULLDUP&t;5
DECL|macro|PARAM_HARDWARE
mdefine_line|#define&t;PARAM_HARDWARE&t;6
DECL|macro|PARAM_RETURN
mdefine_line|#define&t;PARAM_RETURN&t;255
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &quot;pt.h&quot;
macro_line|#include &quot;z8530.h&quot;
macro_line|#include &lt;net/ax25.h&gt;
DECL|struct|mbuf
r_struct
id|mbuf
(brace
DECL|member|next
r_struct
id|mbuf
op_star
id|next
suffix:semicolon
DECL|member|cnt
r_int
id|cnt
suffix:semicolon
DECL|member|data
r_char
id|data
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * The actual PT devices we will use&n; */
DECL|function|pt0_preprobe
r_static
r_int
id|pt0_preprobe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Dummy probe function */
DECL|variable|pt0a
r_static
r_struct
id|device
id|pt0a
op_assign
(brace
l_string|&quot;pt0a&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|pt0_preprobe
)brace
suffix:semicolon
DECL|variable|pt0b
r_static
r_struct
id|device
id|pt0b
op_assign
(brace
l_string|&quot;pt0b&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|pt0_preprobe
)brace
suffix:semicolon
multiline_comment|/* Ok, they shouldn&squot;t be here, but both channels share them */
multiline_comment|/* The Images of the Serial and DMA config registers */
DECL|variable|pt_sercfg
r_static
r_int
r_char
id|pt_sercfg
op_assign
l_int|0
suffix:semicolon
DECL|variable|pt_dmacfg
r_static
r_int
r_char
id|pt_dmacfg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The number of IO ports used by the card */
DECL|macro|PT_TOTAL_SIZE
mdefine_line|#define PT_TOTAL_SIZE   16
multiline_comment|/* Index to functions, as function prototypes. */
r_static
r_int
id|pt_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pt_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pt_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|pt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|pt_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pt_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|pt_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|pt_rts
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
comma
r_int
id|x
)paren
suffix:semicolon
r_static
r_void
id|pt_rxisr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|pt_txisr
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|pt_exisr
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_void
id|pt_tmrisr
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_char
op_star
id|get_dma_buffer
c_func
(paren
r_int
r_int
op_star
id|mem_ptr
)paren
suffix:semicolon
r_static
r_int
id|valid_dma_page
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|dev_buffsize
)paren
suffix:semicolon
r_static
r_int
id|hw_probe
c_func
(paren
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|tdelay
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
comma
r_int
id|time
)paren
suffix:semicolon
r_static
r_void
id|chipset_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ax25_bcast
r_static
r_char
id|ax25_bcast
(braket
l_int|7
)braket
op_assign
(brace
l_char|&squot;Q&squot;
op_lshift
l_int|1
comma
l_char|&squot;S&squot;
op_lshift
l_int|1
comma
l_char|&squot;T&squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot;0&squot;
op_lshift
l_int|1
)brace
suffix:semicolon
DECL|variable|ax25_test
r_static
r_char
id|ax25_test
(braket
l_int|7
)braket
op_assign
(brace
l_char|&squot;L&squot;
op_lshift
l_int|1
comma
l_char|&squot;I&squot;
op_lshift
l_int|1
comma
l_char|&squot;N&squot;
op_lshift
l_int|1
comma
l_char|&squot;U&squot;
op_lshift
l_int|1
comma
l_char|&squot;X&squot;
op_lshift
l_int|1
comma
l_char|&squot; &squot;
op_lshift
l_int|1
comma
l_char|&squot;1&squot;
op_lshift
l_int|1
)brace
suffix:semicolon
DECL|variable|ext2_secrm_seed
r_static
r_int
id|ext2_secrm_seed
op_assign
l_int|152
suffix:semicolon
DECL|function|random
r_static
r_inline
r_int
r_char
id|random
c_func
(paren
r_void
)paren
(brace
r_return
(paren
r_int
r_char
)paren
(paren
id|ext2_secrm_seed
op_assign
id|ext2_secrm_seed
op_star
l_int|60691
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|wrtscc
r_static
r_inline
r_void
id|wrtscc
c_func
(paren
r_int
id|cbase
comma
r_int
id|ctl
comma
r_int
id|sccreg
comma
r_int
r_char
id|val
)paren
(brace
id|outb_p
c_func
(paren
id|sccreg
comma
id|ctl
)paren
suffix:semicolon
multiline_comment|/* Select register */
id|outb_p
c_func
(paren
id|val
comma
id|ctl
)paren
suffix:semicolon
multiline_comment|/* Output value */
)brace
DECL|function|rdscc
r_static
r_inline
r_int
r_char
id|rdscc
c_func
(paren
r_int
id|cbase
comma
r_int
id|ctl
comma
r_int
id|sccreg
)paren
(brace
r_int
r_char
id|retval
suffix:semicolon
id|outb_p
c_func
(paren
id|sccreg
comma
id|ctl
)paren
suffix:semicolon
multiline_comment|/* Select register */
id|retval
op_assign
id|inb_p
c_func
(paren
id|ctl
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|switchbuffers
r_static
r_void
id|switchbuffers
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;rcvbuf
op_eq
id|lp-&gt;rxdmabuf1
)paren
id|lp-&gt;rcvbuf
op_assign
id|lp-&gt;rxdmabuf2
suffix:semicolon
r_else
id|lp-&gt;rcvbuf
op_assign
id|lp-&gt;rxdmabuf1
suffix:semicolon
)brace
DECL|function|hardware_send_packet
r_static
r_void
id|hardware_send_packet
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_char
id|kickflag
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
multiline_comment|/* First, let&squot;s see if this packet is actually a KISS packet */
id|ptr
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|ptr
(braket
l_int|0
)braket
op_ne
l_int|0
op_logical_and
id|skb-&gt;len
op_ge
l_int|2
)paren
(brace
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: Rx KISS... Control = %d, value = %d.&bslash;n&quot;
comma
id|ptr
(braket
l_int|0
)braket
comma
(paren
id|skb-&gt;len
OG
l_int|1
ques
c_cond
id|ptr
(braket
l_int|1
)braket
suffix:colon
op_minus
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Kludge to get device */
r_if
c_cond
(paren
(paren
r_struct
id|pt_local
op_star
)paren
(paren
op_amp
id|pt0b.priv
)paren
op_eq
id|lp
)paren
id|dev
op_assign
op_amp
id|pt0b
suffix:semicolon
r_else
id|dev
op_assign
op_amp
id|pt0a
suffix:semicolon
r_switch
c_cond
(paren
id|ptr
(braket
l_int|0
)braket
)paren
(brace
r_case
id|PARAM_TXDELAY
suffix:colon
multiline_comment|/*TxDelay is in 10mS increments */
id|lp-&gt;txdelay
op_assign
id|ptr
(braket
l_int|1
)braket
op_star
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_PERSIST
suffix:colon
id|lp-&gt;persist
op_assign
id|ptr
(braket
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SLOTTIME
suffix:colon
id|lp-&gt;slotime
op_assign
id|ptr
(braket
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_FULLDUP
suffix:colon
multiline_comment|/* Yeah right, you wish!  Fullduplex is a little while to&n;&t;&t;&t;&t; * go folks, but this is how you fire it up&n;&t;&t;&t;&t; */
r_break
suffix:semicolon
multiline_comment|/* Perhaps we should have txtail here?? */
)brace
multiline_comment|/*switch */
r_return
suffix:semicolon
)brace
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|kickflag
op_assign
(paren
id|skb_peek
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|lp-&gt;sndbuf
op_eq
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: hardware_send_packet(): kickflag = %d (%d).&bslash;n&quot;
comma
id|kickflag
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;
id|skb_queue_tail
c_func
(paren
op_amp
id|lp-&gt;sndq
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kickflag
)paren
(brace
multiline_comment|/* Simulate interrupt to transmit */
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
id|pt_txisr
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tstate
op_eq
id|IDLE
)paren
id|pt_txisr
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* hardware_send_packet() */
DECL|function|setup_rx_dma
r_static
r_void
id|setup_rx_dma
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|dma_abs
suffix:semicolon
r_int
r_char
id|dmachan
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dma_abs
op_assign
(paren
r_int
r_int
)paren
(paren
id|lp-&gt;rcvbuf-&gt;data
)paren
suffix:semicolon
id|dmachan
op_assign
id|lp-&gt;dmachan
suffix:semicolon
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_dma_page
c_func
(paren
id|dma_abs
comma
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PI: RX buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get ready for RX DMA */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_FN_RDYFN
op_or
id|WT_RDY_RT
op_or
id|INT_ERR_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dmachan
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dmachan
)paren
suffix:semicolon
multiline_comment|/* Set DMA mode register to single transfers, incrementing address,&n;     *  auto init, writes&n;     */
id|set_dma_mode
c_func
(paren
id|dmachan
comma
id|DMA_MODE_READ
op_or
l_int|0x10
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dmachan
comma
id|dma_abs
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dmachan
comma
id|lp-&gt;bufsiz
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dmachan
)paren
suffix:semicolon
multiline_comment|/* If a packet is already coming in, this line is supposed to&n;&t;   avoid receiving a partial packet.&n;     */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Rx_CRC
)paren
suffix:semicolon
multiline_comment|/* Enable RX dma */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_RDY_ENAB
op_or
id|WT_FN_RDYFN
op_or
id|WT_RDY_RT
op_or
id|INT_ERR_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|setup_tx_dma
r_static
r_void
id|setup_tx_dma
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
comma
r_int
id|length
)paren
(brace
r_int
r_int
id|dma_abs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|dmachan
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dmachan
op_assign
id|lp-&gt;dmachan
suffix:semicolon
id|dma_abs
op_assign
(paren
r_int
r_int
)paren
(paren
id|lp-&gt;txdmabuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_dma_page
c_func
(paren
id|dma_abs
comma
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PT: TX buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
)brace
id|disable_dma
c_func
(paren
id|dmachan
)paren
suffix:semicolon
multiline_comment|/* Set DMA mode register to single transfers, incrementing address,&n;     *  no auto init, reads&n;     */
id|set_dma_mode
c_func
(paren
id|dmachan
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dmachan
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dmachan
comma
id|dma_abs
)paren
suffix:semicolon
multiline_comment|/* output byte count */
id|set_dma_count
c_func
(paren
id|dmachan
comma
id|length
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|free_p
r_static
r_void
id|free_p
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
multiline_comment|/* Fill in the MAC-level header */
DECL|function|pt_header
r_static
r_int
id|pt_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_return
id|ax25_encapsulate
c_func
(paren
id|skb
comma
id|dev
comma
id|type
comma
id|daddr
comma
id|saddr
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* Rebuild the MAC-level header */
DECL|function|pt_rebuild_header
r_static
r_int
id|pt_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|ax25_rebuild_header
c_func
(paren
id|buff
comma
id|dev
comma
id|raddr
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This sets up all the registers in the SCC for the given channel&n; * based upon tsync_hwint()&n; */
DECL|function|scc_init
r_static
r_void
id|scc_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pt_local
op_star
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_register
r_int
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
r_int
id|tc
comma
id|br
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: scc_init(): (%d).&bslash;n&quot;
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We may put something here to enable_escc */
r_if
c_cond
(paren
id|cmd
op_amp
id|CHANA
)paren
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R9
comma
id|CHRA
)paren
suffix:semicolon
multiline_comment|/* Reset channel A */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R2
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Initialise interrupt vector */
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R9
comma
id|CHRB
)paren
suffix:semicolon
multiline_comment|/* Reset channel B */
)brace
multiline_comment|/* Deselect all Rx and Tx interrupts */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Turn off external interrupts (like CTS/CD) */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* X1 clock, SDLC mode */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R4
comma
id|SDLC
op_or
id|X1CLK
)paren
suffix:semicolon
multiline_comment|/* Preset CRC and set mode */
r_if
c_cond
(paren
id|lp-&gt;nrzi
)paren
(brace
multiline_comment|/* Preset Tx CRC, put into NRZI mode */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Preset Tx CRC, put into NRZ mode */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
)paren
suffix:semicolon
)brace
multiline_comment|/* Tx/Rx parameters */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
multiline_comment|/* Use internal clocking */
(brace
multiline_comment|/* Tx Clk from BRG. Rx Clk form DPLL, TRxC pin outputs DPLL */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R11
comma
id|TCBR
op_or
id|RCDPLL
op_or
id|TRxCDP
op_or
id|TRxCOI
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Use external clocking */
multiline_comment|/* Tx Clk from TRxCL. Rx Clk from RTxCL, TRxC pin if input */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R11
comma
id|TCTRxCP
op_or
id|RCRTxCP
op_or
id|TRxCBR
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wiz1 */
)brace
multiline_comment|/* Null out SDLC start address */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R6
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SDLC flag */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R7
comma
id|FLAG
)paren
suffix:semicolon
multiline_comment|/* Setup Tx but don&squot;t enable it */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|Tx8
op_or
id|DTR
)paren
suffix:semicolon
multiline_comment|/* Setup Rx */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* Setup the BRG, turn it off first */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
)paren
suffix:semicolon
multiline_comment|/* set the 32x time constant for the BRG in Rx mode */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
id|br
op_assign
id|lp-&gt;speed
suffix:semicolon
id|tc
op_assign
(paren
(paren
id|lp-&gt;xtal
op_div
l_int|32
)paren
op_div
(paren
id|br
op_star
l_int|2
)paren
)paren
op_minus
l_int|2
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R12
comma
id|tc
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* lower byte */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R13
comma
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* upper byte */
)brace
multiline_comment|/* Turn transmitter off, to setup stuff */
id|pt_rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
multiline_comment|/* External clocking */
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
multiline_comment|/* DPLL frm BRG, BRG src PCLK */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SSBR
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SEARCH
)paren
suffix:semicolon
multiline_comment|/* SEARCH mode, keep BRG src */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|BRENABL
)paren
suffix:semicolon
multiline_comment|/* Enable the BRG */
multiline_comment|/* Turn off external clock port */
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_and_assign
op_complement
id|PT_EXTCLKA
)paren
comma
(paren
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
)paren
suffix:semicolon
r_else
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_and_assign
op_complement
id|PT_EXTCLKB
)paren
comma
(paren
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DPLL frm rtxc,BRG src PCLK */
multiline_comment|/*&t;&t;wrtscc(lp-&gt;cardbase, cmd, R14, BRSRC | SSRTxC);*/
multiline_comment|/* Turn on external clock port */
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_or_assign
id|PT_EXTCLKA
)paren
comma
(paren
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
)paren
suffix:semicolon
r_else
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_or_assign
id|PT_EXTCLKB
)paren
comma
(paren
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dmachan
)paren
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
(paren
id|INT_ALL_Rx
op_or
id|EXT_INT_ENAB
)paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|BRKIE
)paren
suffix:semicolon
multiline_comment|/* ABORT int */
multiline_comment|/* Turn on the DTR to tell modem we&squot;re alive */
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_or_assign
id|PT_DTRA_ON
)paren
comma
(paren
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
)paren
suffix:semicolon
r_else
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_or_assign
id|PT_DTRB_ON
)paren
comma
(paren
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
)paren
suffix:semicolon
multiline_comment|/* Now, turn on the receiver and hunt for a flag */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|RxCRC_ENAB
op_or
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* scc_init() */
multiline_comment|/* Resets the given channel and whole SCC if both channels off */
DECL|function|chipset_init
r_static
r_void
id|chipset_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pt_local
op_star
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: chipset_init(): pt0a tstate = %d.&bslash;n&quot;
comma
(paren
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0a.priv
)paren
op_member_access_from_pointer
id|tstate
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: chipset_init(): pt0b tstate = %d.&bslash;n&quot;
comma
(paren
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0b.priv
)paren
op_member_access_from_pointer
id|tstate
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Reset SCC if both channels are to be canned */
r_if
c_cond
(paren
(paren
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
op_logical_and
op_logical_neg
(paren
id|pt_sercfg
op_amp
id|PT_DTRB_ON
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
op_logical_and
op_logical_neg
(paren
id|pt_sercfg
op_amp
id|PT_DTRA_ON
)paren
)paren
)paren
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
multiline_comment|/* Reset int and dma registers */
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_assign
l_int|0
)paren
comma
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|pt_dmacfg
op_assign
l_int|0
)paren
comma
id|lp-&gt;cardbase
op_plus
id|DMA_CFG
)paren
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: chipset_init() Resetting SCC, called by ch (%d).&bslash;n&quot;
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;        
)brace
multiline_comment|/* Reset individual channel */
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R9
comma
id|MIE
op_or
id|DLC
op_or
id|NV
op_or
id|CHRA
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_and_assign
op_complement
id|PT_DTRA_ON
)paren
comma
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R9
comma
id|MIE
op_or
id|DLC
op_or
id|NV
op_or
id|CHRB
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_and_assign
op_complement
id|PT_DTRB_ON
)paren
comma
id|lp-&gt;cardbase
op_plus
id|SERIAL_CFG
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* chipset_init() */
DECL|function|pt_init
r_int
id|pt_init
c_func
(paren
r_void
)paren
(brace
r_int
op_star
id|port
suffix:semicolon
r_int
id|ioaddr
op_assign
l_int|0
suffix:semicolon
r_int
id|card_type
op_assign
l_int|0
suffix:semicolon
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x230
comma
l_int|0x240
comma
l_int|0x250
comma
l_int|0x260
comma
l_int|0x270
comma
l_int|0x280
comma
l_int|0x290
comma
l_int|0x2a0
comma
l_int|0x2b0
comma
l_int|0x300
comma
l_int|0x330
comma
l_int|0x3f0
comma
l_int|0
)brace
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PT: 0.41 ALPHA 07 October 1995 Craig Small (vk2xlz@vk2xlz.ampr.org)&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|port
op_logical_and
op_logical_neg
id|card_type
suffix:semicolon
id|port
op_increment
)paren
(brace
id|ioaddr
op_assign
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|PT_TOTAL_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PT: Probing for card at address %#3x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
id|card_type
op_assign
id|hw_probe
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card_type
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PT: Found a PT at address %#3x&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: ERROR: No card found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;     * Link a couple of device structures into the chain&n;     *&n;     * For the A port&n;     * Allocate space for 4 buffers even though we only need 3,&n;     * because one of them may cross a DMA page boundary and&n;     * be rejected by get_dma_buffer().&n;     */
id|register_netdev
c_func
(paren
op_amp
id|pt0a
)paren
suffix:semicolon
id|pt0a.priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pt_local
)paren
op_plus
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
op_star
l_int|4
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|pt0a.dma
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wizzer - no dma yet */
id|pt0a.base_addr
op_assign
id|ioaddr
op_plus
id|CHANA
suffix:semicolon
id|pt0a.irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* And B port */
id|register_netdev
c_func
(paren
op_amp
id|pt0b
)paren
suffix:semicolon
id|pt0b.priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pt_local
)paren
op_plus
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
op_star
l_int|4
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|pt0b.base_addr
op_assign
id|ioaddr
op_plus
id|CHANB
suffix:semicolon
id|pt0b.irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Now initialise them */
id|pt_probe
c_func
(paren
op_amp
id|pt0a
)paren
suffix:semicolon
id|pt_probe
c_func
(paren
op_amp
id|pt0b
)paren
suffix:semicolon
id|pt0b.irq
op_assign
id|pt0a.irq
suffix:semicolon
multiline_comment|/* IRQ is shared */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pt_init() */
multiline_comment|/*&n; * Probe for PT card.  Also initialises the timers&n; */
DECL|function|hw_probe
r_static
r_int
id|hw_probe
c_func
(paren
r_int
id|ioaddr
)paren
(brace
r_int
id|time
op_assign
l_int|1000
suffix:semicolon
multiline_comment|/* Number of milliseconds to test */
r_int
id|a
op_assign
l_int|1
suffix:semicolon
r_int
id|b
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|start_time
comma
id|end_time
suffix:semicolon
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1CLR
)paren
suffix:semicolon
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR2CLR
)paren
suffix:semicolon
multiline_comment|/* Timer counter channel 0, 1mS period */
id|outb_p
c_func
(paren
id|SC0
op_or
id|LSB_MSB
op_or
id|MODE3
comma
id|ioaddr
op_plus
id|TMRCMD
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TMR0
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x18
comma
id|ioaddr
op_plus
id|TMR0
)paren
suffix:semicolon
multiline_comment|/* Setup timer control word for timer 1 */
id|outb_p
c_func
(paren
id|SC1
op_or
id|LSB_MSB
op_or
id|MODE0
comma
id|ioaddr
op_plus
id|TMRCMD
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|time
op_lshift
l_int|1
)paren
op_amp
l_int|0xff
comma
id|ioaddr
op_plus
id|TMR1
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|time
op_rshift
l_int|7
)paren
op_amp
l_int|0xff
comma
id|ioaddr
op_plus
id|TMR1
)paren
suffix:semicolon
multiline_comment|/* wait until counter reg is loaded */
r_do
(brace
multiline_comment|/* Latch count for reading */
id|outb_p
c_func
(paren
id|SC1
comma
id|ioaddr
op_plus
id|TMRCMD
)paren
suffix:semicolon
id|a
op_assign
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1
)paren
suffix:semicolon
id|b
op_assign
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|b
op_eq
l_int|0
)paren
suffix:semicolon
id|start_time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|b
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Latch count for reading */
id|outb_p
c_func
(paren
id|SC1
comma
id|ioaddr
op_plus
id|TMRCMD
)paren
suffix:semicolon
id|a
op_assign
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1
)paren
suffix:semicolon
id|b
op_assign
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1
)paren
suffix:semicolon
id|end_time
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Don&squot;t wait forever - there may be no card here */
r_if
c_cond
(paren
(paren
id|end_time
op_minus
id|start_time
)paren
OG
l_int|200
)paren
(brace
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1CLR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Now fix the timers up for general operation */
multiline_comment|/* Clear the timers */
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1CLR
)paren
suffix:semicolon
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR2CLR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SC1
op_or
id|LSB_MSB
op_or
id|MODE0
comma
id|ioaddr
op_plus
id|TMRCMD
)paren
suffix:semicolon
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1CLR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SC2
op_or
id|LSB_MSB
op_or
id|MODE0
comma
id|ioaddr
op_plus
id|TMRCMD
)paren
suffix:semicolon
multiline_comment|/* Should this be tmr1 or tmr2? wiz3*/
id|inb_p
c_func
(paren
id|ioaddr
op_plus
id|TMR1CLR
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* hw_probe() */
DECL|function|pt_rts
r_static
r_void
id|pt_rts
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
comma
r_int
id|x
)paren
(brace
r_int
id|tc
suffix:semicolon
r_int
id|br
suffix:semicolon
r_int
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_rts(): Transmitter status will be %d (%d).&bslash;n&quot;
comma
id|x
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;
r_if
c_cond
(paren
id|x
op_eq
id|ON
)paren
(brace
multiline_comment|/* Ex ints off to avoid int */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
l_int|0
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* Rx off */
id|lp-&gt;rstate
op_assign
id|IDLE
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
multiline_comment|/* Setup for Tx DMA */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_FN_RDYFN
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No interrupts */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;clockmode
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
(brace
id|br
op_assign
id|lp-&gt;speed
suffix:semicolon
id|tc
op_assign
(paren
id|lp-&gt;xtal
op_div
(paren
id|br
op_star
l_int|2
)paren
)paren
op_minus
l_int|2
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R12
comma
id|tc
op_amp
l_int|0xff
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R13
comma
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Turn on Tx by raising RTS */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|TxENAB
op_or
id|Tx8
op_or
id|DTR
)paren
suffix:semicolon
multiline_comment|/* Transmitter on now */
)brace
r_else
(brace
multiline_comment|/* turning off Tx */
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
multiline_comment|/* Turn off Tx by dropping RTS */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|Tx8
op_or
id|DTR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;clockmode
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;speed
)paren
multiline_comment|/* internally clocked */
(brace
multiline_comment|/* Reprogram BRG from 32x clock for Rx DPLL */
multiline_comment|/* BRG off, keep PClk source */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
)paren
suffix:semicolon
id|br
op_assign
id|lp-&gt;speed
suffix:semicolon
id|tc
op_assign
(paren
(paren
id|lp-&gt;xtal
op_div
l_int|32
)paren
op_div
(paren
id|br
op_star
l_int|2
)paren
)paren
op_minus
l_int|2
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R12
comma
id|tc
op_amp
l_int|0xff
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R13
comma
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* SEARCH mode, BRG source */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|SEARCH
)paren
suffix:semicolon
multiline_comment|/* Enable the BRG */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R14
comma
id|BRSRC
op_or
id|BRENABL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Flush Rx fifo */
multiline_comment|/* Turn Rx off */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
multiline_comment|/* Reset error latch */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
multiline_comment|/* get status byte from R1 */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
)paren
suffix:semicolon
multiline_comment|/* Read and dump data in queue */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
multiline_comment|/* Now, turn on Rx and hunt for a flag */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset buffer pointers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allow aborts to interrupt us */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|INT_ALL_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
)brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|BRKIE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* pt_rts() */
DECL|function|valid_dma_page
r_static
r_int
id|valid_dma_page
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|dev_bufsize
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|addr
op_amp
l_int|0xffff
)paren
op_plus
id|dev_bufsize
)paren
op_le
l_int|0x10000
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pt_set_mac_address
r_static
r_int
id|pt_set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr
op_star
id|sa
op_assign
(paren
r_struct
id|sockaddr
op_star
)paren
id|addr
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|sa-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/* addr is an AX.25 shifted ASCII */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* mac address */
)brace
multiline_comment|/* Allocate a buffer which does not cross a DMA page boundary */
DECL|function|get_dma_buffer
r_static
r_char
op_star
id|get_dma_buffer
c_func
(paren
r_int
r_int
op_star
id|mem_ptr
)paren
(brace
r_char
op_star
id|ret
suffix:semicolon
id|ret
op_assign
(paren
r_char
op_star
)paren
op_star
id|mem_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_dma_page
c_func
(paren
op_star
id|mem_ptr
comma
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
)paren
(brace
op_star
id|mem_ptr
op_add_assign
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
suffix:semicolon
id|ret
op_assign
(paren
r_char
op_star
)paren
op_star
id|mem_ptr
suffix:semicolon
)brace
op_star
id|mem_ptr
op_add_assign
(paren
id|DMA_BUFF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/* get_dma_buffer() */
multiline_comment|/*&n; * Sets up all the structures for the PT device&n; */
DECL|function|pt_probe
r_static
r_int
id|pt_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
suffix:semicolon
r_struct
id|pt_local
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mem_ptr
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/*&n;     * Initialise the device structure.&n;     * Must be done before chipset_init()&n;     * Make sure data structures used by  the PT are aligned&n;     */
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|dev-&gt;priv
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pt_local
)paren
)paren
suffix:semicolon
multiline_comment|/* Allocate some buffers which do not cross DMA boundaries */
id|mem_ptr
op_assign
(paren
r_int
r_int
)paren
id|dev-&gt;priv
op_plus
r_sizeof
(paren
r_struct
id|pt_local
)paren
suffix:semicolon
id|lp-&gt;txdmabuf
op_assign
id|get_dma_buffer
c_func
(paren
op_amp
id|mem_ptr
)paren
suffix:semicolon
id|lp-&gt;rxdmabuf1
op_assign
(paren
r_struct
id|mbuf
op_star
)paren
id|get_dma_buffer
c_func
(paren
op_amp
id|mem_ptr
)paren
suffix:semicolon
id|lp-&gt;rxdmabuf2
op_assign
(paren
r_struct
id|mbuf
op_star
)paren
id|get_dma_buffer
c_func
(paren
op_amp
id|mem_ptr
)paren
suffix:semicolon
multiline_comment|/* Initialise the Rx buffer */
id|lp-&gt;rcvbuf
op_assign
id|lp-&gt;rxdmabuf1
suffix:semicolon
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialise the transmit queue head structure */
id|skb_queue_head_init
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
suffix:semicolon
id|lp-&gt;base
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp-&gt;cardbase
op_assign
id|dev-&gt;base_addr
op_amp
l_int|0x3f0
suffix:semicolon
multiline_comment|/* These need to be initialised before scc_init() is called.&n;     */
id|lp-&gt;xtal
op_assign
id|XTAL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
id|lp-&gt;speed
op_assign
id|DEF_A_SPEED
suffix:semicolon
id|lp-&gt;txdelay
op_assign
id|DEF_A_TXDELAY
suffix:semicolon
id|lp-&gt;persist
op_assign
id|DEF_A_PERSIST
suffix:semicolon
id|lp-&gt;slotime
op_assign
id|DEF_A_SLOTIME
suffix:semicolon
id|lp-&gt;squeldelay
op_assign
id|DEF_A_SQUELDELAY
suffix:semicolon
id|lp-&gt;clockmode
op_assign
id|DEF_A_CLOCKMODE
suffix:semicolon
id|lp-&gt;nrzi
op_assign
id|DEF_A_NRZI
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;speed
op_assign
id|DEF_B_SPEED
suffix:semicolon
id|lp-&gt;txdelay
op_assign
id|DEF_B_TXDELAY
suffix:semicolon
id|lp-&gt;persist
op_assign
id|DEF_B_PERSIST
suffix:semicolon
id|lp-&gt;slotime
op_assign
id|DEF_B_SLOTIME
suffix:semicolon
id|lp-&gt;squeldelay
op_assign
id|DEF_B_SQUELDELAY
suffix:semicolon
id|lp-&gt;clockmode
op_assign
id|DEF_B_CLOCKMODE
suffix:semicolon
id|lp-&gt;nrzi
op_assign
id|DEF_B_NRZI
suffix:semicolon
)brace
id|lp-&gt;bufsiz
op_assign
id|DMA_BUFF_SIZE
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
id|chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
multiline_comment|/* Note that a single IRQ services 2 devices (A and B channels)&n;        */
multiline_comment|/*&n;&t; * We disable the dma for a while, we have to get ints working&n;&t; * properly first!!&n;&t; */
id|lp-&gt;dmachan
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|2
)paren
(brace
id|autoirq_setup
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Turn on PT interrupts */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|pt_sercfg
op_or_assign
id|PT_EI
comma
id|lp-&gt;cardbase
op_plus
id|INT_CFG
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Set a timer interrupt */
id|tdelay
c_func
(paren
id|lp
comma
l_int|1
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|autoirq_report
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Turn off PT interrupts */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|pt_sercfg
op_and_assign
op_complement
id|PT_EI
)paren
comma
id|lp-&gt;cardbase
op_plus
id|INT_CFG
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: ERROR: Failed to detect IRQ line, assuming IRQ7.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PT: Autodetected IRQ %d, assuming DMA %d&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* This board has jumpered interrupts. Snarf the interrupt vector&n;         * now.  There is no point in waiting since no other device can use&n;         * the interrupt, and this marks the &squot;irqaction&squot; as busy.&n;         */
(brace
r_int
id|irqval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|pt_interrupt
comma
l_int|0
comma
l_string|&quot;pt&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqval
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: ERROR: Unable to get IRQ %d (irqval = %d).&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|irqval
)paren
suffix:semicolon
r_return
id|EAGAIN
suffix:semicolon
)brace
)brace
multiline_comment|/* Grab the region */
id|request_region
c_func
(paren
id|ioaddr
op_amp
l_int|0x3f0
comma
id|PT_TOTAL_SIZE
comma
l_string|&quot;pt&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* A port */
id|dev-&gt;open
op_assign
id|pt_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|pt_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|pt_ioctl
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|pt_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|pt_get_stats
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|pt_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|pt_rebuild_header
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|pt_set_mac_address
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_AX25
suffix:semicolon
multiline_comment|/* AF_AX25 device */
id|dev-&gt;hard_header_len
op_assign
l_int|73
suffix:semicolon
multiline_comment|/* We do digipeaters now */
id|dev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* eth_mtu is default */
id|dev-&gt;addr_len
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* sizeof an ax.25 address */
id|memcpy
c_func
(paren
id|dev-&gt;broadcast
comma
id|ax25_bcast
comma
l_int|7
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|ax25_test
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* New style flags */
id|dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pt_probe() */
multiline_comment|/* Open/initialise the board.  This is called (in the current kernel)&n; * sometime after booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &squot;should&squot; only be set once at boot, so that there is&n; * a non-reboot way to recover if something goes wrong.&n; * derived from last half of tsync_attach()&n; */
DECL|function|pt_open
r_static
r_int
id|pt_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pt_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_static
id|first_time
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
r_if
c_cond
(paren
id|first_time
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
l_string|&quot;pt&quot;
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Reset hardware */
id|chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
id|scc_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|scc_init
c_func
(paren
id|dev-&gt;next
)paren
suffix:semicolon
)brace
multiline_comment|/* Save a copy of register RR0 for comparing with later on */
multiline_comment|/* We always put 0 in zero count */
id|lp-&gt;saved_RR0
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R0
)paren
op_amp
op_complement
id|ZCOUNT
suffix:semicolon
multiline_comment|/* master interrupt enable */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R9
comma
id|MIE
op_or
id|NV
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|pt_sercfg
op_or_assign
id|PT_EI
comma
id|lp-&gt;cardbase
op_plus
id|INT_CFG
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
id|jiffies
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|first_time
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pt_open() */
DECL|function|pt_send_packet
r_static
r_int
id|pt_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pt_local
op_star
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_send_packet(): (%d)&bslash;n&quot;
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;
multiline_comment|/* If some higher layer thinks we&squot;ve missed an tx-done interrupt&n;&t;   we are passed NULL. Caution: dev_tint() handles the cli()/sti()&n;&t;   itself.*/
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|hardware_send_packet
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to pt_open() */
DECL|function|pt_close
r_static
r_int
id|pt_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pt_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|ptr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|cmd
suffix:semicolon
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Reset SCC or channel */
id|chipset_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
id|lp-&gt;open_time
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free any buffers left in the hardware transmit queue */
r_while
c_loop
(paren
(paren
id|ptr
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_ne
l_int|NULL
)paren
id|free_p
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_close(): Closing down channel (%d).&bslash;n&quot;
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pt_close() */
DECL|function|pt_ioctl
r_static
r_int
id|pt_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pt_req
id|rq
suffix:semicolon
r_struct
id|pt_local
op_star
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|pt_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|rq
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|pt_req
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rq.cmd
)paren
(brace
r_case
id|SIOCSPIPARAM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;txdelay
op_assign
id|rq.txdelay
suffix:semicolon
id|lp-&gt;persist
op_assign
id|rq.persist
suffix:semicolon
id|lp-&gt;slotime
op_assign
id|rq.slotime
suffix:semicolon
id|lp-&gt;squeldelay
op_assign
id|rq.squeldelay
suffix:semicolon
id|lp-&gt;clockmode
op_assign
id|rq.clockmode
suffix:semicolon
id|lp-&gt;speed
op_assign
id|rq.speed
suffix:semicolon
id|pt_open
c_func
(paren
op_amp
id|pt0a
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSPIDMA
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_amp
id|CHANA
)paren
(brace
multiline_comment|/* if A channel */
r_if
c_cond
(paren
id|rq.dmachan
template_param
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pt_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
id|dev-&gt;dma
op_assign
id|lp-&gt;dmachan
op_assign
id|rq.dmachan
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|lp-&gt;dmachan
comma
l_string|&quot;pt&quot;
)paren
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
id|pt_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSPIIRQ
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* add this later */
r_break
suffix:semicolon
r_case
id|SIOCGPIPARAM
suffix:colon
r_case
id|SIOCGPIDMA
suffix:colon
r_case
id|SIOCGPIIRQ
suffix:colon
id|rq.speed
op_assign
id|lp-&gt;speed
suffix:semicolon
id|rq.txdelay
op_assign
id|lp-&gt;txdelay
suffix:semicolon
id|rq.persist
op_assign
id|lp-&gt;persist
suffix:semicolon
id|rq.slotime
op_assign
id|lp-&gt;slotime
suffix:semicolon
id|rq.squeldelay
op_assign
id|lp-&gt;squeldelay
suffix:semicolon
id|rq.clockmode
op_assign
id|lp-&gt;clockmode
suffix:semicolon
id|rq.dmachan
op_assign
id|lp-&gt;dmachan
suffix:semicolon
id|rq.irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|rq
comma
r_sizeof
(paren
r_struct
id|pt_req
)paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n;   closed. */
r_static
r_struct
id|netstats
op_star
DECL|function|pt_get_stats
id|pt_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pt_local
op_star
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c skeleton.c&quot;&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  tab-width: 4&n; * End:&n; */
DECL|function|tdelay
r_static
r_void
id|tdelay
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
comma
r_int
id|time
)paren
(brace
multiline_comment|/* For some reason, we turn off the Tx interrupts here! */
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dmachan
)paren
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R1
comma
id|INT_ALL_Rx
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
(brace
id|outb_p
c_func
(paren
id|time
op_amp
l_int|0xff
comma
id|lp-&gt;cardbase
op_plus
id|TMR1
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|time
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|lp-&gt;cardbase
op_plus
id|TMR1
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb_p
c_func
(paren
id|time
op_amp
l_int|0xff
comma
id|lp-&gt;cardbase
op_plus
id|TMR2
)paren
suffix:semicolon
id|outb_p
c_func
(paren
(paren
id|time
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|lp-&gt;cardbase
op_plus
id|TMR2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* tdelay */
DECL|function|pt_txisr
r_static
r_void
id|pt_txisr
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_txisr(): tstate = %d (%d).&bslash;n&quot;
comma
id|lp-&gt;tstate
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
r_case
id|CRCOUT
suffix:colon
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|IDLE
suffix:colon
multiline_comment|/* Transmitter idle. Find a frame for transmission */
r_if
c_cond
(paren
(paren
id|lp-&gt;sndbuf
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Nothing to send - return to receive mode&n;&t;         * Tx off now - flag should have gone&n;&t;         */
id|pt_rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dmachan
)paren
(brace
id|lp-&gt;txptr
op_assign
id|lp-&gt;sndbuf-&gt;data
suffix:semicolon
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Ignore KISS control byte */
id|lp-&gt;txcnt
op_assign
(paren
r_int
)paren
id|lp-&gt;sndbuf-&gt;len
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If a buffer to send, drop though here */
r_case
id|DEFER
suffix:colon
multiline_comment|/* Check DCD - debounce it */
multiline_comment|/* See Intel Microcommunications Handbook p2-308 */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|DCD
)paren
op_ne
l_int|0
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* DEFER until DCD transition or timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|DCDIE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|lp-&gt;persist
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;slotime
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pt_rts
c_func
(paren
id|lp
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* Tx on */
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|Tx8
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|ST_TXDELAY
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;txdelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|ACTIVE
suffix:colon
multiline_comment|/* Here we are actively sending a frame */
r_if
c_cond
(paren
id|lp-&gt;txcnt
op_decrement
)paren
(brace
multiline_comment|/* XLZ - checkout Gracilis PT code to see if the while &n;&t;         * loop is better or not.&n;&t;         */
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* next char is gone */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* stuffing a char satisfies interrupt condition */
)brace
r_else
(brace
multiline_comment|/* No more to send */
id|free_p
c_func
(paren
id|lp-&gt;sndbuf
)paren
suffix:semicolon
id|lp-&gt;sndbuf
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|TxEOM
)paren
)paren
(brace
multiline_comment|/* Did we underrun */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|SEND_ABORT
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lp-&gt;tstate
op_assign
id|UNDERRUN
suffix:semicolon
multiline_comment|/* Send flags on underrun */
r_if
c_cond
(paren
id|lp-&gt;nrzi
)paren
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZ
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset Tx interrupt pending */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_P
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: pt_txisr(): Invalid tstate (%d) for chan %s.&bslash;n&quot;
comma
id|lp-&gt;tstate
comma
(paren
id|cmd
op_amp
id|CHANA
ques
c_cond
l_string|&quot;A&quot;
suffix:colon
l_string|&quot;B&quot;
)paren
)paren
suffix:semicolon
id|pt_rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*switch */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|pt_rxisr
r_static
r_void
id|pt_rxisr
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pt_local
op_star
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
r_int
id|bytecount
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
id|rse
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|sksize
comma
id|pkt_len
suffix:semicolon
r_struct
id|mbuf
op_star
id|cur_buf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|cfix
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Get status byte from R1 */
id|rse
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
)paren
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_rxisr(): R1 = %#3x. (%d)&bslash;n&quot;
comma
id|rse
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif        
r_if
c_cond
(paren
id|lp-&gt;dmachan
op_logical_and
(paren
id|rse
op_amp
id|Rx_OVR
)paren
)paren
id|lp-&gt;rstate
op_assign
id|RXERROR
suffix:semicolon
r_if
c_cond
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|Rx_CH_AV
op_logical_and
op_logical_neg
id|lp-&gt;dmachan
)paren
(brace
multiline_comment|/* There is a char to be stored&n;         * Read special condition bits before reading the data char&n;         */
r_if
c_cond
(paren
id|rse
op_amp
id|Rx_OVR
)paren
(brace
multiline_comment|/* Rx overrun - toss buffer */
multiline_comment|/* wind back the pointers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|RXERROR
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lp-&gt;rcvbuf-&gt;cnt
op_ge
id|lp-&gt;bufsiz
)paren
(brace
multiline_comment|/* Too large packet&n;                  * wind back Rx buffer pointers&n;                  */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|TOOBIG
suffix:semicolon
)brace
multiline_comment|/* ok, we can store the Rx char if no errors */
r_if
c_cond
(paren
id|lp-&gt;rstate
op_eq
id|ACTIVE
)paren
(brace
op_star
id|lp-&gt;rcp
op_increment
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* we got an error, dump the FIFO */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
multiline_comment|/* Reset error latch */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
multiline_comment|/* Resync the SCC */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|ENT_HM
op_or
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rse
op_amp
id|END_FR
)paren
(brace
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_rxisr() Got end of a %u byte frame.&bslash;n&quot;
comma
id|lp-&gt;rcvbuf-&gt;cnt
)paren
suffix:semicolon
macro_line|#endif&t;     
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
id|clear_dma_ff
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
id|bytecount
op_assign
id|lp-&gt;bufsiz
op_minus
id|get_dma_residue
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
)brace
r_else
(brace
id|bytecount
op_assign
id|lp-&gt;rcvbuf-&gt;cnt
suffix:semicolon
)brace
multiline_comment|/* END OF FRAME - Make sure Rx was active */
r_if
c_cond
(paren
id|lp-&gt;rcvbuf-&gt;cnt
OG
l_int|0
op_logical_or
id|lp-&gt;dmachan
)paren
(brace
r_if
c_cond
(paren
(paren
id|rse
op_amp
id|CRC_ERR
)paren
op_logical_or
(paren
id|lp-&gt;rstate
OG
id|ACTIVE
)paren
op_logical_or
(paren
id|bytecount
OL
l_int|10
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|bytecount
op_ge
l_int|10
)paren
op_logical_and
(paren
id|rse
op_amp
id|CRC_ERR
)paren
)paren
(brace
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;rstate
op_eq
id|RXERROR
)paren
(brace
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* wind back Rx buffer pointers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Re-sync the SCC */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|ENT_HM
op_or
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
)brace
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_rxisr() %s error.&bslash;n&quot;
comma
(paren
id|rse
op_amp
id|CRC_ERR
)paren
ques
c_cond
l_string|&quot;CRC&quot;
suffix:colon
l_string|&quot;state&quot;
)paren
suffix:semicolon
macro_line|#endif                 
)brace
r_else
(brace
multiline_comment|/* We have a valid frame */
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
id|pkt_len
op_assign
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
id|bytecount
op_minus
l_int|2
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Get buffer for next frame */
id|cur_buf
op_assign
id|lp-&gt;rcvbuf
suffix:semicolon
id|switchbuffers
c_func
(paren
id|lp
)paren
suffix:semicolon
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
(brace
id|pkt_len
op_assign
id|lp-&gt;rcvbuf-&gt;cnt
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* Toss 2 CRC bytes */
id|pkt_len
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* make room for KISS control byte */
)brace
multiline_comment|/* Malloc up new buffer */
id|sksize
op_assign
id|pkt_len
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|sksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: %s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* KISS kludge = prefix with a 0 byte */
id|cfix
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
op_star
id|cfix
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* skb-&gt;data points to the start of sk_buff area */
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
id|memcpy
c_func
(paren
id|cfix
comma
(paren
r_char
op_star
)paren
id|cur_buf-&gt;data
comma
id|pkt_len
op_minus
l_int|1
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|cfix
comma
id|lp-&gt;rcvbuf-&gt;data
comma
id|pkt_len
op_minus
l_int|1
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|ntohs
c_func
(paren
id|ETH_P_AX25
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|IS_SKB
c_func
(paren
id|skb
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dmachan
)paren
(brace
multiline_comment|/* packet queued - wind back buffer for next frame */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* good frame */
)brace
multiline_comment|/* check active Rx */
multiline_comment|/* Clear error status */
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
multiline_comment|/* Reset error latch */
)brace
multiline_comment|/* end EOF check */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* pt_rxisr() */
multiline_comment|/*&n; * This handles the two timer interrupts.&n; * This is a real bugger, cause you have to rip it out of the pi&squot;s&n; * external status code.  They use the CTS line or something.&n; */
DECL|function|pt_tmrisr
r_static
r_void
id|pt_tmrisr
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_tmrisr(): tstate = %d (%d).&bslash;n&quot;
comma
id|lp-&gt;tstate
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
multiline_comment|/* Most of this stuff is in pt_exisr() */
r_case
id|FLAGOUT
suffix:colon
r_case
id|ST_TXDELAY
suffix:colon
r_case
id|DEFER
suffix:colon
multiline_comment|/*    case ACTIVE:&n;    case UNDERRUN:*/
id|pt_exisr
c_func
(paren
id|lp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|lp-&gt;base
op_amp
id|CHANA
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: pt_tmrisr(): Invalid tstate %d for Channel A&bslash;n&quot;
comma
id|lp-&gt;tstate
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PT: pt_tmrisr(): Invalid tstate %d for Channel B&bslash;n&quot;
comma
id|lp-&gt;tstate
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* pt_tmrisr() */
multiline_comment|/*&n; * This routine is called by the kernel when there is an interrupt for the&n; * PT.&n; */
DECL|function|pt_interrupt
r_static
r_void
id|pt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* It&squot;s a tad dodgy here, but we assume pt0a until proven otherwise */
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|pt0a
suffix:semicolon
r_struct
id|pt_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|intreg
suffix:semicolon
r_int
r_char
id|st
suffix:semicolon
r_register
r_int
id|cbase
op_assign
id|dev-&gt;base_addr
op_amp
l_int|0x3f0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Read the PT&squot;s interrupt register, this is not the SCC one! */
id|intreg
op_assign
id|inb_p
c_func
(paren
id|cbase
op_plus
id|INT_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|intreg
op_amp
l_int|0x07
)paren
op_ne
l_int|0x07
)paren
(brace
multiline_comment|/* Read interrupt register pending from Channel A */
r_while
c_loop
(paren
(paren
id|st
op_assign
id|rdscc
c_func
(paren
id|cbase
comma
id|cbase
op_plus
id|CHANA
op_plus
id|CTL
comma
id|R3
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Read interrupt vector from R2, channel B */
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_interrupt(): R3 = %#3x&quot;
comma
id|st
)paren
suffix:semicolon
macro_line|#endif&t;&t;        
multiline_comment|/*        &t;st = rdscc(lp-&gt;cardbase, cbase + CHANB + CTL, R2) &amp; 0x0e;*/
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PI: R2 = %#3x.&bslash;n&quot;
comma
id|st
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
id|st
op_amp
id|CHARxIP
)paren
(brace
multiline_comment|/* Channel A Rx */
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0a.priv
suffix:semicolon
id|pt_rxisr
c_func
(paren
op_amp
id|pt0a
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHATxIP
)paren
(brace
multiline_comment|/* Channel A Tx */
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0a.priv
suffix:semicolon
id|pt_txisr
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHAEXT
)paren
(brace
multiline_comment|/* Channel A External Status */
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0a.priv
suffix:semicolon
id|pt_exisr
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHBRxIP
)paren
(brace
multiline_comment|/* Channel B Rx */
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0b.priv
suffix:semicolon
id|pt_rxisr
c_func
(paren
op_amp
id|pt0b
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHBTxIP
)paren
(brace
multiline_comment|/* Channel B Tx */
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0b.priv
suffix:semicolon
id|pt_txisr
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st
op_amp
id|CHBEXT
)paren
(brace
multiline_comment|/* Channel B External Status */
id|lp
op_assign
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0b.priv
suffix:semicolon
id|pt_exisr
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset highest interrupt under service */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|lp-&gt;base
op_plus
id|CTL
comma
id|R0
comma
id|RES_H_IUS
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end of SCC ints */
r_if
c_cond
(paren
op_logical_neg
(paren
id|intreg
op_amp
id|PT_TMR1_MSK
)paren
)paren
(brace
multiline_comment|/* Clear timer 1 */
id|inb_p
c_func
(paren
id|cbase
op_plus
id|TMR1CLR
)paren
suffix:semicolon
id|pt_tmrisr
c_func
(paren
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0a.priv
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|intreg
op_amp
id|PT_TMR2_MSK
)paren
)paren
(brace
multiline_comment|/* Clear timer 2 */
id|inb_p
c_func
(paren
id|cbase
op_plus
id|TMR2CLR
)paren
suffix:semicolon
id|pt_tmrisr
c_func
(paren
(paren
r_struct
id|pt_local
op_star
)paren
id|pt0b.priv
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the next PT interrupt vector */
id|intreg
op_assign
id|inb_p
c_func
(paren
id|cbase
op_plus
id|INT_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* while (intreg) */
)brace
multiline_comment|/* pt_interrupt() */
DECL|function|pt_exisr
r_static
r_void
id|pt_exisr
c_func
(paren
r_struct
id|pt_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cmd
op_assign
id|lp-&gt;base
op_plus
id|CTL
suffix:semicolon
r_int
r_char
id|st
suffix:semicolon
r_char
id|c
suffix:semicolon
r_int
id|length
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Get external status */
id|st
op_assign
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
suffix:semicolon
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: exisr(): R0 = %#3x tstate = %d (%d).&bslash;n&quot;
comma
id|st
comma
id|lp-&gt;tstate
comma
id|lp-&gt;base
op_amp
id|CHANA
)paren
suffix:semicolon
macro_line|#endif&t;
multiline_comment|/* Reset external status latch */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;rstate
op_ge
id|ACTIVE
)paren
op_logical_and
(paren
id|st
op_amp
id|BRK_ABRT
)paren
op_logical_and
id|lp-&gt;dmachan
)paren
(brace
id|setup_rx_dma
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp-&gt;rstate
op_assign
id|ACTIVE
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|lp-&gt;tstate
)paren
(brace
r_case
id|ACTIVE
suffix:colon
multiline_comment|/* Unexpected underrun */
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: exisr(): unexpected underrun detected.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif&t;    
id|free_p
c_func
(paren
id|lp-&gt;sndbuf
)paren
suffix:semicolon
id|lp-&gt;sndbuf
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dmachan
)paren
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|SEND_ABORT
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
id|lp-&gt;tstate
op_assign
id|FLAGOUT
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;squeldelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|UNDERRUN
suffix:colon
id|lp-&gt;tstate
op_assign
id|CRCOUT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|FLAGOUT
suffix:colon
multiline_comment|/* squeldelay has timed out */
multiline_comment|/* Find a frame for transmission */
r_if
c_cond
(paren
(paren
id|lp-&gt;sndbuf
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;sndq
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Nothing to send - return to Rx mode */
id|pt_rts
c_func
(paren
id|lp
comma
id|OFF
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|IDLE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dmachan
)paren
(brace
id|lp-&gt;txptr
op_assign
id|lp-&gt;sndbuf-&gt;data
suffix:semicolon
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Ignore KISS control byte */
id|lp-&gt;txcnt
op_assign
(paren
r_int
)paren
id|lp-&gt;sndbuf-&gt;len
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Fall through if we have a packet */
r_case
id|ST_TXDELAY
suffix:colon
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
multiline_comment|/* Disable DMA chan */
id|disable_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
multiline_comment|/* Set up for TX dma */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_FN_RDYFN
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|length
op_assign
id|lp-&gt;sndbuf-&gt;len
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|lp-&gt;txdmabuf
comma
op_amp
id|lp-&gt;sndbuf-&gt;data
(braket
l_int|1
)braket
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* Setup DMA controller for Tx */
id|setup_tx_dma
c_func
(paren
id|lp
comma
id|length
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|lp-&gt;dmachan
)paren
suffix:semicolon
multiline_comment|/* Reset CRC, Txint pending */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_CRC
op_or
id|RES_Tx_P
)paren
suffix:semicolon
multiline_comment|/* Allow underrun only */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|TxUIE
)paren
suffix:semicolon
multiline_comment|/* Enable TX DMA */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|WT_RDY_ENAB
op_or
id|WT_FN_RDYFN
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* Send CRC on underrun */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EOM_L
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|ACTIVE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Get first char to send */
id|lp-&gt;txcnt
op_decrement
suffix:semicolon
id|c
op_assign
op_star
id|lp-&gt;txptr
op_increment
suffix:semicolon
multiline_comment|/* Reset CRC for next frame */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_Tx_CRC
)paren
suffix:semicolon
multiline_comment|/* send abort on underrun */
r_if
c_cond
(paren
id|lp-&gt;nrzi
)paren
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZI
op_or
id|ABUNDER
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R10
comma
id|CRCPS
op_or
id|NRZ
op_or
id|ABUNDER
)paren
suffix:semicolon
)brace
multiline_comment|/* send first char */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* Reset end of message latch */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EOM_L
)paren
suffix:semicolon
multiline_comment|/* stuff an extra one in */
multiline_comment|/*        while ((rdscc(lp-&gt;cardbase, cmd, R0) &amp; Tx_BUF_EMP) &amp;&amp; lp-&gt;txcnt)&n;        {&n;            lp-&gt;txcnt--;&n;            c = *lp-&gt;txptr++;&n;            wrtscc(lp-&gt;cardbase, cmd, R8, c);&n;        }*/
multiline_comment|/* select Tx interrupts to enable */
multiline_comment|/* Allow underrun int only */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|TxUIE
)paren
suffix:semicolon
multiline_comment|/* Reset external interrupts */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* Tx and Rx ints enabled */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R1
comma
id|TxINT_ENAB
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
id|lp-&gt;tstate
op_assign
id|ACTIVE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* slotime has timed out */
r_case
id|DEFER
suffix:colon
multiline_comment|/* Check DCD - debounce it&n;         * see Intel Microcommunications Handbook, p2-308&n;         */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R0
)paren
op_amp
id|DCD
)paren
op_ne
l_int|0
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* DEFER until DCD transition or timeout */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R15
comma
id|DCDIE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|random
c_func
(paren
)paren
OG
id|lp-&gt;persist
)paren
(brace
id|lp-&gt;tstate
op_assign
id|DEFER
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;slotime
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R5
comma
id|TxCRC_ENAB
op_or
id|RTS
op_or
id|Tx8
)paren
suffix:semicolon
id|pt_rts
c_func
(paren
id|lp
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* Tx on */
id|lp-&gt;tstate
op_assign
id|ST_TXDELAY
suffix:semicolon
id|tdelay
c_func
(paren
id|lp
comma
id|lp-&gt;txdelay
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Only for int driven parts */
r_if
c_cond
(paren
id|lp-&gt;dmachan
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* end switch */
multiline_comment|/*&n;     * Rx mode only&n;     * This triggers when hunt mode is entered, &amp; since an ABORT&n;     * automatically enters hunt mode, we use that to clean up&n;     * any waiting garbage&n;     */
r_if
c_cond
(paren
(paren
id|lp-&gt;rstate
op_eq
id|ACTIVE
)paren
op_logical_and
(paren
id|st
op_amp
id|BRK_ABRT
)paren
)paren
(brace
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: exisr(): abort detected.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif        
multiline_comment|/* read and dump all of SCC Rx FIFO */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Re-sync the SCC */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|ENT_HM
op_or
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for DCD transitions */
r_if
c_cond
(paren
(paren
id|st
op_amp
id|DCD
)paren
op_ne
(paren
id|lp-&gt;saved_RR0
op_amp
id|DCD
)paren
)paren
(brace
macro_line|#ifdef PT_DEBUG    
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_exisr(): DCD is now %s.&bslash;n&quot;
comma
(paren
id|st
op_amp
id|DCD
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|st
op_amp
id|DCD
)paren
(brace
multiline_comment|/* Check that we don&squot;t already have some data */
r_if
c_cond
(paren
id|lp-&gt;rcvbuf-&gt;cnt
OG
l_int|0
)paren
(brace
macro_line|#ifdef PT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PT: pt_exisr() dumping %u bytes from buffer.&bslash;n&quot;
comma
id|lp-&gt;rcvbuf-&gt;cnt
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;&t;
multiline_comment|/* wind back buffers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* DCD off */
multiline_comment|/* read and dump al SCC FIFO */
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
(paren
r_void
)paren
id|rdscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R8
)paren
suffix:semicolon
multiline_comment|/* wind back buffers */
id|lp-&gt;rcp
op_assign
id|lp-&gt;rcvbuf-&gt;data
suffix:semicolon
id|lp-&gt;rcvbuf-&gt;cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Re-sync the SCC */
id|wrtscc
c_func
(paren
id|lp-&gt;cardbase
comma
id|cmd
comma
id|R3
comma
id|RxENABLE
op_or
id|ENT_HM
op_or
id|AUTO_ENAB
op_or
id|Rx8
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Update the saved version of register RR) */
id|lp-&gt;saved_RR0
op_assign
id|st
op_amp
op_complement
id|ZCOUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* pt_exisr() */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|register_symtab
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_return
id|pt_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|free_irq
c_func
(paren
id|pt0a.irq
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* IRQs and IO Ports are shared */
id|release_region
c_func
(paren
id|pt0a.base_addr
op_amp
l_int|0x3f0
comma
id|PT_TOTAL_SIZE
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|pt0a.irq
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|pt0a.priv
)paren
suffix:semicolon
id|pt0a.priv
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|pt0a
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pt0b.priv
)paren
suffix:semicolon
id|pt0b.priv
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|pt0b
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
