multiline_comment|/*****************************************************************************&n;* sdlamain.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver.  Main module.&n;*&n;* Author:&t;Gene Kozin&t;&lt;genek@compuserve.com&gt;&n;*&n;* Copyright:&t;(c) 1995-1997 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Jan 02, 1997&t;Gene Kozin&t;Initial version.&n;*****************************************************************************/
macro_line|#if&t;!defined(__KERNEL__) || !defined(MODULE)
macro_line|#error&t;This code MUST be compiled as a kernel module!
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;&t;/* OS configuration options */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/module.h&gt;&t;/* support for loadable modules */
macro_line|#include &lt;linux/ioport.h&gt;&t;/* request_region(), release_region() */
macro_line|#include &lt;linux/tqueue.h&gt;&t;/* for kernel task queues */
macro_line|#include &lt;linux/router.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;asm/segment.h&gt;&t;/* kernel &lt;-&gt; user copy */
multiline_comment|/****** Defines &amp; Macros ****************************************************/
macro_line|#ifdef&t;_DEBUG_
DECL|macro|STATIC
mdefine_line|#define&t;STATIC
macro_line|#else
DECL|macro|STATIC
mdefine_line|#define&t;STATIC&t;&t;static
macro_line|#endif
DECL|macro|DRV_VERSION
mdefine_line|#define&t;DRV_VERSION&t;3&t;&t;/* version number */
DECL|macro|DRV_RELEASE
mdefine_line|#define&t;DRV_RELEASE&t;0&t;&t;/* release (minor version) number */
DECL|macro|MAX_CARDS
mdefine_line|#define&t;MAX_CARDS&t;8&t;&t;/* max number of adapters */
macro_line|#ifndef&t;CONFIG_WANPIPE_CARDS&t;&t;/* configurable option */
DECL|macro|CONFIG_WANPIPE_CARDS
mdefine_line|#define&t;CONFIG_WANPIPE_CARDS 1
macro_line|#endif
DECL|macro|CMD_OK
mdefine_line|#define&t;CMD_OK&t;&t;0&t;&t;/* normal firmware return code */
DECL|macro|CMD_TIMEOUT
mdefine_line|#define&t;CMD_TIMEOUT&t;0xFF&t;&t;/* firmware command timed out */
DECL|macro|MAX_CMD_RETRY
mdefine_line|#define&t;MAX_CMD_RETRY&t;10&t;&t;/* max number of firmware retries */
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* Module entry points */
r_int
id|init_module
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* WAN link driver entry points */
r_static
r_int
id|setup
(paren
id|wan_device_t
op_star
id|wandev
comma
id|wandev_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|shutdown
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|ioctl
(paren
id|wan_device_t
op_star
id|wandev
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/* IOCTL hanlers */
r_static
r_int
id|ioctl_dump
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_dump_t
op_star
id|u_dump
)paren
suffix:semicolon
r_static
r_int
id|ioctl_exec
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_exec_t
op_star
id|u_exec
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
id|STATIC
r_void
id|sdla_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
id|STATIC
r_void
id|sdla_poll
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
multiline_comment|/****** Global Data **********************************************************&n; * Note: All data must be explicitly initialized!!!&n; */
multiline_comment|/* private data */
DECL|variable|drvname
r_static
r_char
id|drvname
(braket
)braket
op_assign
l_string|&quot;wanpipe&quot;
suffix:semicolon
DECL|variable|fullname
r_static
r_char
id|fullname
(braket
)braket
op_assign
l_string|&quot;WANPIPE(tm) Multiprotocol Driver&quot;
suffix:semicolon
DECL|variable|copyright
r_static
r_char
id|copyright
(braket
)braket
op_assign
l_string|&quot;(c) 1995-1996 Sangoma Technologies Inc.&quot;
suffix:semicolon
DECL|variable|ncards
r_static
r_int
id|ncards
op_assign
id|CONFIG_WANPIPE_CARDS
suffix:semicolon
DECL|variable|active
r_static
r_int
id|active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of active cards */
DECL|variable|card_array
r_static
id|sdla_t
op_star
id|card_array
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* adapter data space */
multiline_comment|/* Task queue element for creating a &squot;thread&squot; */
DECL|variable|sdla_tq
r_static
r_struct
id|tq_struct
id|sdla_tq
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* .next */
l_int|0
comma
multiline_comment|/* .sync */
op_amp
id|sdla_poll
comma
multiline_comment|/* .routine */
l_int|NULL
multiline_comment|/* .data */
)brace
suffix:semicolon
multiline_comment|/******* Kernel Loadable Module Entry Points ********************************/
multiline_comment|/*============================================================================&n; * Module &squot;insert&squot; entry point.&n; * o print announcement&n; * o allocate adapter data space&n; * o initialize static data&n; * o register all cards with WAN router&n; * o calibrate SDLA shared memory access delay.&n; *&n; * Return:&t;0&t;Ok&n; *&t;&t;&lt; 0&t;error.&n; * Context:&t;process&n; */
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
(brace
r_int
id|cnt
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s v%u.%u %s&bslash;n&quot;
comma
id|fullname
comma
id|DRV_VERSION
comma
id|DRV_RELEASE
comma
id|copyright
)paren
suffix:semicolon
multiline_comment|/* Verify number of cards and allocate adapter data space */
id|ncards
op_assign
id|min
c_func
(paren
id|ncards
comma
id|MAX_CARDS
)paren
suffix:semicolon
id|ncards
op_assign
id|max
c_func
(paren
id|ncards
comma
l_int|1
)paren
suffix:semicolon
id|card_array
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|sdla_t
)paren
op_star
id|ncards
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_array
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|card_array
comma
l_int|0
comma
r_sizeof
(paren
id|sdla_t
)paren
op_star
id|ncards
)paren
suffix:semicolon
multiline_comment|/* Register adapters with WAN router */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|ncards
suffix:semicolon
op_increment
id|cnt
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
op_amp
id|card_array
(braket
id|cnt
)braket
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;devname
comma
l_string|&quot;%s%d&quot;
comma
id|drvname
comma
id|cnt
op_plus
l_int|1
)paren
suffix:semicolon
id|wandev-&gt;magic
op_assign
id|ROUTER_MAGIC
suffix:semicolon
id|wandev-&gt;name
op_assign
id|card-&gt;devname
suffix:semicolon
id|wandev
op_member_access_from_pointer
r_private
op_assign
id|card
suffix:semicolon
id|wandev-&gt;setup
op_assign
op_amp
id|setup
suffix:semicolon
id|wandev-&gt;shutdown
op_assign
op_amp
id|shutdown
suffix:semicolon
id|wandev-&gt;ioctl
op_assign
op_amp
id|ioctl
suffix:semicolon
id|err
op_assign
id|register_wandev
c_func
(paren
id|wandev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s registration failed with error %d!&bslash;n&quot;
comma
id|drvname
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cnt
)paren
id|ncards
op_assign
id|cnt
suffix:semicolon
multiline_comment|/* adjust actual number of cards */
r_else
id|kfree
c_func
(paren
id|card_array
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Module &squot;remove&squot; entry point.&n; * o unregister all adapters from the WAN router&n; * o release all remaining system resources&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncards
suffix:semicolon
op_increment
id|i
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
op_amp
id|card_array
(braket
id|i
)braket
suffix:semicolon
id|unregister_wandev
c_func
(paren
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|card_array
)paren
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Setup/confugure WAN link driver.&n; * o check adapter state&n; * o make sure firmware is present in configuration&n; * o make sure I/O port and IRQ are specified&n; * o make sure I/O region is available&n; * o allocate interrupt vector&n; * o setup SDLA hardware&n; * o call appropriate routine to perform protocol-specific initialization&n; * o mark I/O region as used&n; * o if this is the first active card, then schedule background task&n; *&n; * This function is called when router handles ROUTER_SETUP IOCTL. The&n; * configuration structure is in kernel memory (including extended data, if&n; * any).&n; */
DECL|function|setup
r_static
r_int
id|setup
(paren
id|wan_device_t
op_star
id|wandev
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|irq
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|conf
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_ne
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|EBUSY
multiline_comment|/* already configured */
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;data_size
op_logical_or
(paren
id|conf-&gt;data
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: firmware not found in configuration data!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;ioport
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t configure without I/O port address!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;irq
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t configure without IRQ!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Make sure I/O port region is available */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|conf-&gt;ioport
comma
id|SDLA_MAXIORANGE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: I/O region 0x%X - 0x%X is in use!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|conf-&gt;ioport
comma
id|conf-&gt;ioport
op_plus
id|SDLA_MAXIORANGE
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Allocate IRQ */
id|irq
op_assign
(paren
id|conf-&gt;irq
op_eq
l_int|2
)paren
ques
c_cond
l_int|9
suffix:colon
id|conf-&gt;irq
suffix:semicolon
multiline_comment|/* IRQ2 -&gt; IRQ9 */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sdla_isr
comma
l_int|0
comma
id|wandev-&gt;name
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t reserve IRQ %d!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|irq
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Configure hardware, load firmware, etc. */
id|memset
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0
comma
r_sizeof
(paren
id|sdlahw_t
)paren
)paren
suffix:semicolon
id|card-&gt;hw.port
op_assign
id|conf-&gt;ioport
suffix:semicolon
id|card-&gt;hw.irq
op_assign
(paren
id|conf-&gt;irq
op_eq
l_int|9
)paren
ques
c_cond
l_int|2
suffix:colon
id|conf-&gt;irq
suffix:semicolon
id|card-&gt;hw.dpmbase
op_assign
id|conf-&gt;maddr
suffix:semicolon
id|card-&gt;hw.dpmsize
op_assign
id|SDLA_WINDOWSIZE
suffix:semicolon
id|card-&gt;hw.type
op_assign
id|conf-&gt;hw_opt
(braket
l_int|0
)braket
suffix:semicolon
id|card-&gt;hw.pclk
op_assign
id|conf-&gt;hw_opt
(braket
l_int|1
)braket
suffix:semicolon
id|err
op_assign
id|sdla_setup
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|conf-&gt;data
comma
id|conf-&gt;data_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|free_irq
c_func
(paren
id|irq
comma
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Intialize WAN device data space */
id|wandev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|wandev-&gt;dma
op_assign
l_int|0
suffix:semicolon
id|wandev-&gt;ioport
op_assign
id|card-&gt;hw.port
suffix:semicolon
id|wandev-&gt;maddr
op_assign
id|card-&gt;hw.dpmbase
suffix:semicolon
id|wandev-&gt;msize
op_assign
id|card-&gt;hw.dpmsize
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|0
)braket
op_assign
id|card-&gt;hw.type
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|1
)braket
op_assign
id|card-&gt;hw.pclk
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|2
)braket
op_assign
id|card-&gt;hw.memory
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|3
)braket
op_assign
id|card-&gt;hw.fwid
suffix:semicolon
multiline_comment|/* Protocol-specific initialization */
r_switch
c_cond
(paren
id|card-&gt;hw.fwid
)paren
(brace
macro_line|#ifdef&t;CONFIG_WANPIPE_X25
r_case
id|SFID_X25_502
suffix:colon
r_case
id|SFID_X25_508
suffix:colon
id|err
op_assign
id|wpx_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_WANPIPE_FR
r_case
id|SFID_FR502
suffix:colon
r_case
id|SFID_FR508
suffix:colon
id|err
op_assign
id|wpf_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_WANPIPE_PPP
r_case
id|SFID_PPP502
suffix:colon
r_case
id|SFID_PPP508
suffix:colon
id|err
op_assign
id|wpp_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: this firmware is not supported!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|sdla_down
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Reserve I/O region and schedule background task */
id|request_region
c_func
(paren
id|card-&gt;hw.port
comma
id|card-&gt;hw.io_range
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|active
op_eq
l_int|1
)paren
id|queue_task
c_func
(paren
op_amp
id|sdla_tq
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
id|wandev-&gt;critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Shut down WAN link driver. &n; * o shut down adapter hardware&n; * o release system resources.&n; *&n; * This function is called by the router when device is being unregistered or&n; * when it handles ROUTER_DOWN IOCTL.&n; */
DECL|function|shutdown
r_static
r_int
id|shutdown
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|wandev-&gt;state
op_assign
id|WAN_UNCONFIGURED
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|active
op_eq
l_int|0
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* stop background thread */
id|sdla_down
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|wandev-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;hw.port
comma
id|card-&gt;hw.io_range
)paren
suffix:semicolon
id|wandev-&gt;critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Driver I/O control. &n; * o verify arguments&n; * o perform requested action&n; *&n; * This function is called when router handles one of the reserved user&n; * IOCTLs.  Note that &squot;arg&squot; stil points to user address space.&n; */
DECL|function|ioctl
r_static
r_int
id|ioctl
(paren
id|wan_device_t
op_star
id|wandev
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|WANPIPE_DUMP
suffix:colon
id|err
op_assign
id|ioctl_dump
c_func
(paren
id|wandev
op_member_access_from_pointer
r_private
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANPIPE_EXEC
suffix:colon
id|err
op_assign
id|ioctl_exec
c_func
(paren
id|wandev
op_member_access_from_pointer
r_private
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|wandev-&gt;critical
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/****** Driver IOCTL Hanlers ************************************************/
multiline_comment|/*============================================================================&n; * Dump adpater memory to user buffer.&n; * o verify request structure&n; * o copy request structure to kernel data space&n; * o verify length/offset&n; * o verify user buffer&n; * o copy adapter memory image to user buffer&n; *&n; * Note: when dumping memory, this routine switches curent dual-port memory&n; *&t; vector, so care must be taken to avoid racing conditions.&n; */
DECL|function|ioctl_dump
r_static
r_int
id|ioctl_dump
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_dump_t
op_star
id|u_dump
)paren
(brace
id|sdla_dump_t
id|dump
suffix:semicolon
r_int
id|winsize
suffix:semicolon
r_int
r_int
id|oldvec
suffix:semicolon
multiline_comment|/* DPM window vector */
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u_dump
op_eq
l_int|NULL
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|u_dump
comma
r_sizeof
(paren
id|sdla_dump_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|dump
comma
(paren
r_void
op_star
)paren
id|u_dump
comma
r_sizeof
(paren
id|sdla_dump_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dump.magic
op_ne
id|WANPIPE_MAGIC
)paren
op_logical_or
(paren
id|dump.offset
op_plus
id|dump.length
OG
id|card-&gt;hw.memory
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dump.ptr
op_eq
l_int|NULL
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|dump.ptr
comma
id|dump.length
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|winsize
op_assign
id|card-&gt;hw.dpmsize
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* &gt;&gt;&gt; critical section start &lt;&lt;&lt; */
id|oldvec
op_assign
id|card-&gt;hw.vector
suffix:semicolon
r_while
c_loop
(paren
id|dump.length
)paren
(brace
r_int
id|pos
op_assign
id|dump.offset
op_mod
id|winsize
suffix:semicolon
multiline_comment|/* current offset */
r_int
r_int
id|vec
op_assign
id|dump.offset
op_minus
id|pos
suffix:semicolon
multiline_comment|/* current vector */
r_int
id|len
op_assign
(paren
id|dump.length
OG
(paren
id|winsize
op_minus
id|pos
)paren
)paren
ques
c_cond
(paren
id|winsize
op_minus
id|pos
)paren
suffix:colon
id|dump.length
suffix:semicolon
r_if
c_cond
(paren
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|vec
)paren
op_ne
l_int|0
)paren
multiline_comment|/* relocate window */
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|dump.ptr
)paren
comma
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|pos
)paren
comma
id|len
)paren
suffix:semicolon
id|dump.length
op_sub_assign
id|len
suffix:semicolon
id|dump.offset
op_add_assign
id|len
suffix:semicolon
(paren
r_char
op_star
)paren
id|dump.ptr
op_add_assign
id|len
suffix:semicolon
)brace
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|oldvec
)paren
suffix:semicolon
multiline_comment|/* restore DPM window position */
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* &gt;&gt;&gt; critical section end &lt;&lt;&lt; */
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Execute adapter firmware command.&n; * o verify request structure&n; * o copy request structure to kernel data space&n; * o call protocol-specific &squot;exec&squot; function&n; */
DECL|function|ioctl_exec
r_static
r_int
id|ioctl_exec
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_exec_t
op_star
id|u_exec
)paren
(brace
id|sdla_exec_t
id|exec
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;exec
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u_exec
op_eq
l_int|NULL
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|u_exec
comma
r_sizeof
(paren
id|sdla_exec_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|exec
comma
(paren
r_void
op_star
)paren
id|u_exec
comma
r_sizeof
(paren
id|sdla_exec_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|exec.magic
op_ne
id|WANPIPE_MAGIC
)paren
op_logical_or
(paren
id|exec.cmd
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|card
op_member_access_from_pointer
id|exec
c_func
(paren
id|card
comma
id|exec.cmd
comma
id|exec.data
)paren
suffix:semicolon
)brace
multiline_comment|/******* Miscellaneous ******************************************************/
multiline_comment|/*============================================================================&n; * SDLA Interrupt Service Routine.&n; * o acknowledge SDLA hardware interrupt.&n; * o call protocol-specific interrupt service routine, if any.&n; */
DECL|function|sdla_isr
id|STATIC
r_void
id|sdla_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
DECL|macro|card
mdefine_line|#define&t;card&t;((sdla_t*)dev_id)
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_UNCONFIGURED
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;in_isr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: interrupt re-entrancy on IRQ %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
id|sdla_intack
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;isr
)paren
id|card
op_member_access_from_pointer
id|isr
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
DECL|macro|card
macro_line|#undef&t;card
)brace
multiline_comment|/*============================================================================&n; * SDLA polling routine.&n; * This routine simulates kernel thread to perform various housekeeping job.&n; *&n; * o for each configured device call its poll() routine&n; * o if there is at least one active card, then reschedule itself once again&n; */
DECL|function|sdla_poll
id|STATIC
r_void
id|sdla_poll
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncards
suffix:semicolon
op_increment
id|i
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
op_amp
id|card_array
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_UNCONFIGURED
)paren
op_logical_and
id|card-&gt;poll
op_logical_and
op_logical_neg
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|card
op_member_access_from_pointer
id|poll
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|active
)paren
id|queue_task
c_func
(paren
op_amp
id|sdla_tq
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * This routine is called by the protocol-specific modules when network&n; * interface is being open.  The only reason we need this, is because we&n; * have to call MOD_INC_USE_COUNT, but cannot include &squot;module.h&squot; where it&squot;s&n; * defined more than once into the same kernel module.&n; */
DECL|function|wanpipe_open
r_void
id|wanpipe_open
(paren
id|sdla_t
op_star
id|card
)paren
(brace
op_increment
id|card-&gt;open_cnt
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * This routine is called by the protocol-specific modules when network&n; * interface is being closed.  The only reason we need this, is because we&n; * have to call MOD_DEC_USE_COUNT, but cannot include &squot;module.h&squot; where it&squot;s&n; * defined more than once into the same kernel module.&n; */
DECL|function|wanpipe_close
r_void
id|wanpipe_close
(paren
id|sdla_t
op_star
id|card
)paren
(brace
op_decrement
id|card-&gt;open_cnt
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set WAN device state.&n; */
DECL|function|wanpipe_set_state
r_void
id|wanpipe_set_state
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: link connected!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: link connecting...&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: link disconnected!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;wandev.state
op_assign
id|state
suffix:semicolon
)brace
id|card-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/****** End *****************************************************************/
eof
