multiline_comment|/* tulip.c: A DEC 21040 ethernet driver for linux. */
multiline_comment|/*&n;   NOTICE: this version works with kernels 1.1.82 and later only!&n;&t;Written 1994,1995 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver is for the SMC EtherPower PCI ethernet adapter.&n;&t;It should work with most other DEC 21*40-based ethercards.&n;&n;&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;&t;Center of Excellence in Space Data and Information Sciences&n;&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;tulip.c:v0.05 1/20/95 becker@cesdis.gsfc.nasa.gov&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
multiline_comment|/* The total size is unusually large: The 21040 aligns each of its 16&n;   longword-wide registers on a quadword boundary. */
DECL|macro|TULIP_TOTAL_SIZE
mdefine_line|#define TULIP_TOTAL_SIZE 0x80
macro_line|#ifdef HAVE_DEVLIST
DECL|variable|tulip_drv
r_struct
id|netdev_entry
id|tulip_drv
op_assign
(brace
l_string|&quot;Tulip&quot;
comma
id|tulip_pci_probe
comma
id|TULIP_TOTAL_SIZE
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
DECL|macro|TULIP_DEBUG
mdefine_line|#define TULIP_DEBUG 1
macro_line|#ifdef TULIP_DEBUG
DECL|variable|tulip_debug
r_int
id|tulip_debug
op_assign
id|TULIP_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|tulip_debug
r_int
id|tulip_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the DECchip 21040 &quot;Tulip&quot;, Digital&squot;s&n;single-chip ethernet controller for PCI, as used on the SMC EtherPower&n;ethernet adapter.&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS should be set to assign the&n;PCI INTA signal to an otherwise unused system IRQ line.  While it&squot;s&n;physically possible to shared PCI interrupt lines, the kernel doesn&squot;t&n;support it. &n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;The Tulip can use either ring buffers or lists of Tx and Rx descriptors.&n;The current driver uses a statically allocated Rx ring of descriptors and&n;buffers, and a list of the Tx buffers.&n;&n;IIIC. Synchronization&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and other software.&n;&n;The send packet thread has partial control over the Tx ring and &squot;dev-&gt;tbusy&squot;&n;flag.  It sets the tbusy flag whenever it&squot;s queuing a Tx packet. If the next&n;queue slot is empty, it clears the tbusy flag when finished otherwise it sets&n;the &squot;tp-&gt;tx_full&squot; flag.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring.  (The Tx-done interrupt can&squot;t be selectively turned off, so&n;we can&squot;t avoid the interrupt overhead by having the Tx routine reap the Tx&n;stats.)&t; After reaping the stats, it marks the queue entry as empty by setting&n;the &squot;base&squot; to zero.&t; Iff the &squot;tp-&gt;tx_full&squot; flag is set, it clears both the&n;tx_full and tbusy flags.&n;&n;IV. Notes&n;&n;Thanks to Duke Kamstra of SMC for providing an EtherPower board.&n;&n;The DEC databook doesn&squot;t document which Rx filter settings accept broadcast&n;packets.  Nor does it document how to configure the part to configure the&n;serial subsystem for normal (vs. loopback) operation or how to have it&n;autoswitch between internal 10baseT, SIA and AUI transceivers.&n;&n;The databook claims that CSR13, CSR14, and CSR15 should each be the last&n;register of the set CSR12-15 written.   Hmmm, now how is that possible?&n;*/
DECL|macro|DEC_VENDOR_ID
mdefine_line|#define DEC_VENDOR_ID&t;0x1011&t;&t;/* Hex &squot;D&squot; :-&gt; */
DECL|macro|DEC_21040_ID
mdefine_line|#define DEC_21040_ID&t;0x0002&t;&t;/* Change for 21140. */
multiline_comment|/* Keep the ring sizes a power of two for efficiency. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;4
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;4
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;&t;&t;/* Size of each temporary Rx buffer.*/
multiline_comment|/* Offsets to the Command and Status Registers, &quot;CSRs&quot;.  All accesses&n;   must be longword instructions and quadword aligned. */
DECL|enum|tulip_offsets
r_enum
id|tulip_offsets
(brace
DECL|enumerator|CSR0
DECL|enumerator|CSR1
DECL|enumerator|CSR2
DECL|enumerator|CSR3
DECL|enumerator|CSR4
DECL|enumerator|CSR5
id|CSR0
op_assign
l_int|0
comma
id|CSR1
op_assign
l_int|0x08
comma
id|CSR2
op_assign
l_int|0x10
comma
id|CSR3
op_assign
l_int|0x18
comma
id|CSR4
op_assign
l_int|0x20
comma
id|CSR5
op_assign
l_int|0x28
comma
DECL|enumerator|CSR6
DECL|enumerator|CSR7
DECL|enumerator|CSR8
DECL|enumerator|CSR9
DECL|enumerator|CSR10
DECL|enumerator|CSR11
id|CSR6
op_assign
l_int|0x30
comma
id|CSR7
op_assign
l_int|0x38
comma
id|CSR8
op_assign
l_int|0x40
comma
id|CSR9
op_assign
l_int|0x48
comma
id|CSR10
op_assign
l_int|0x50
comma
id|CSR11
op_assign
l_int|0x58
comma
DECL|enumerator|CSR12
DECL|enumerator|CSR13
DECL|enumerator|CSR14
DECL|enumerator|CSR15
id|CSR12
op_assign
l_int|0x60
comma
id|CSR13
op_assign
l_int|0x68
comma
id|CSR14
op_assign
l_int|0x70
comma
id|CSR15
op_assign
l_int|0x78
)brace
suffix:semicolon
multiline_comment|/* The Tulip Rx and Tx buffer descriptors. */
DECL|struct|tulip_rx_desc
r_struct
id|tulip_rx_desc
(brace
DECL|member|status
r_int
id|status
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|member|buffer1
DECL|member|buffer2
r_char
op_star
id|buffer1
comma
op_star
id|buffer2
suffix:semicolon
multiline_comment|/* We use only buffer 1.  */
)brace
suffix:semicolon
DECL|struct|tulip_tx_desc
r_struct
id|tulip_tx_desc
(brace
DECL|member|status
r_int
id|status
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|member|buffer1
DECL|member|buffer2
r_char
op_star
id|buffer1
comma
op_star
id|buffer2
suffix:semicolon
multiline_comment|/* We use only buffer 1.  */
)brace
suffix:semicolon
DECL|struct|tulip_private
r_struct
id|tulip_private
(brace
DECL|member|devname
r_char
id|devname
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Used only for kernel debugging. */
DECL|member|rx_ring
r_struct
id|tulip_rx_desc
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_ring
r_struct
id|tulip_tx_desc
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for skfree(). */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_buffs
r_int
id|rx_buffs
suffix:semicolon
multiline_comment|/* Address of temporary Rx buffers. */
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
DECL|member|setup_frame
r_int
id|setup_frame
(braket
l_int|48
)braket
suffix:semicolon
multiline_comment|/* Pseudo-Tx frame to init address table. */
DECL|member|cur_rx
DECL|member|cur_tx
r_int
r_int
id|cur_rx
comma
id|cur_tx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_rx
DECL|member|dirty_tx
r_int
r_int
id|dirty_rx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
DECL|member|pad0
DECL|member|pad1
r_int
id|pad0
comma
id|pad1
suffix:semicolon
multiline_comment|/* Used for 8-byte alignment */
)brace
suffix:semicolon
r_static
r_void
id|tulip_probe1
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|irq
)paren
suffix:semicolon
r_static
r_int
id|tulip_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tulip_init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tulip_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tulip_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tulip_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|tulip_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|tulip_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
"&f;"
macro_line|#ifndef MODULE
multiline_comment|/* This 21040 probe is unlike most other board probes.  We can use memory&n;   efficiently by allocating a large contiguous region and dividing it&n;   ourselves.  This is done by having the initialization occur before&n;   the &squot;kmalloc()&squot; memory management system is started. */
DECL|function|dec21040_init
r_int
id|dec21040_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_int
id|pci_index
suffix:semicolon
r_for
c_loop
(paren
id|pci_index
op_assign
l_int|0
suffix:semicolon
id|pci_index
OL
l_int|8
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
comma
id|pci_irq_line
suffix:semicolon
r_int
r_int
id|pci_ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_find_device
(paren
id|DEC_VENDOR_ID
comma
id|DEC_21040_ID
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq_line
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|pci_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Remove I/O space marker in bit 0. */
id|pci_ioaddr
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;Found DEC PCI Tulip at I/O %#lx, IRQ %d.&bslash;n&quot;
comma
id|pci_ioaddr
comma
id|pci_irq_line
)paren
suffix:semicolon
id|tulip_probe1
c_func
(paren
id|pci_ioaddr
comma
id|pci_irq_line
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef MODULE
DECL|function|tulip_probe
r_static
r_int
id|tulip_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tulip: This driver does not yet install properly from module!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|function|tulip_probe1
r_static
r_void
id|tulip_probe1
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|irq
)paren
(brace
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Already printed version info. */
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|0
op_logical_and
id|did_version
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: DEC 21040 Tulip at %#3x,&quot;
comma
id|dev-&gt;name
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_amp
op_complement
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Clear the missed-packet counter. */
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/* The station address ROM is read byte serially.  The register must&n;&t;   be polled, waiting for the value to be read bit serially from the&n;&t;   EEPROM.&n;&t;   */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR9
)paren
suffix:semicolon
multiline_comment|/* Reset the pointer with a dummy write. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|value
comma
id|boguscnt
op_assign
l_int|100000
suffix:semicolon
r_do
id|value
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR9
)paren
suffix:semicolon
r_while
c_loop
(paren
id|value
template_param
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|value
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;, IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* We do a request_region() only to register /proc/ioports info. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|TULIP_TOTAL_SIZE
comma
l_string|&quot;DEC Tulip Ethernet&quot;
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* Make certain the data structures are quadword aligned. */
id|tp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|tp
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|tp
suffix:semicolon
id|tp-&gt;rx_buffs
op_assign
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
op_star
id|RX_RING_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
multiline_comment|/* The Tulip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|tulip_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|tulip_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|tulip_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|tulip_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
op_amp
id|set_mac_address
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
r_static
r_int
DECL|function|tulip_open
id|tulip_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Reset the chip, holding bit 0 set at least 10 PCI cycles. */
id|outl
c_func
(paren
l_int|0xfff80001
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
id|SLOW_DOWN_IO
suffix:semicolon
multiline_comment|/* Deassert reset.  Set 8 longword cache alignment, 8 longword burst.&n;&t;   Cache alignment bits 15:14&t;     Burst length 13:8&n;    &t;0000&t;No alignment  0x00000000 unlimited&t;&t;0800 8 longwords&n;&t;&t;4000&t;8  longwords&t;&t;0100 1 longword&t;&t;1000 16 longwords&n;&t;&t;8000&t;16 longwords&t;&t;0200 2 longwords&t;2000 32 longwords&n;&t;&t;C000&t;32  longwords&t;&t;0400 4 longwords&n;&t;   Wait the specified 50 PCI cycles after a reset by initializing&n;&t;   Tx and Rx queues and the address filter list. */
id|outl
c_func
(paren
l_int|0xfff84800
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_ne
l_int|NULL
op_logical_or
(paren
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
)paren
op_eq
l_int|NULL
op_logical_or
id|dev-&gt;irq
op_eq
l_int|0
op_logical_or
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|tulip_interrupt
comma
l_int|0
comma
l_string|&quot;DEC 21040 Tulip&quot;
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: tulip_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|tulip_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Fill the whole address filter table with our physical address. */
(brace
r_int
r_int
op_star
id|eaddrs
op_assign
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
r_int
op_star
id|setup_frm
op_assign
id|tp-&gt;setup_frame
comma
id|i
suffix:semicolon
multiline_comment|/* You must add the broadcast address when doing perfect filtering! */
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* Fill the rest of the accept table with our physical address. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|2
)braket
suffix:semicolon
)brace
multiline_comment|/* Put the setup frame on the Tx list. */
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|length
op_assign
l_int|0x08000000
op_or
l_int|192
suffix:semicolon
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|buffer1
op_assign
(paren
r_char
op_star
)paren
id|tp-&gt;setup_frame
suffix:semicolon
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|buffer2
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|tp-&gt;cur_tx
op_increment
comma
id|tp-&gt;dirty_tx
op_increment
suffix:semicolon
)brace
id|outl
c_func
(paren
(paren
r_int
)paren
id|tp-&gt;rx_ring
comma
id|ioaddr
op_plus
id|CSR3
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
r_int
)paren
id|tp-&gt;tx_ring
comma
id|ioaddr
op_plus
id|CSR4
)paren
suffix:semicolon
multiline_comment|/* Turn on the xcvr interface. */
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000004
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
multiline_comment|/* Start the chip&squot;s Tx and Rx processes. */
id|outl
c_func
(paren
l_int|0xfffe2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Trigger an immediate transmit demand to process the setup frame. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR1
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|outl
c_func
(paren
l_int|0xFFFFFFFF
comma
id|ioaddr
op_plus
id|CSR7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Done tulip_open(), CSR0 %8.8x, CSR13 %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR0
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
)paren
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
r_static
r_void
DECL|function|tulip_init_ring
id|tulip_init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
id|tp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;dirty_rx
op_assign
id|tp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* Owned by Tulip chip */
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|length
op_assign
id|PKT_BUF_SZ
suffix:semicolon
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buffer1
op_assign
(paren
r_char
op_star
)paren
(paren
id|tp-&gt;rx_buffs
op_plus
id|i
op_star
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buffer2
op_assign
(paren
r_char
op_star
)paren
op_amp
id|tp-&gt;rx_ring
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/* Mark the last entry as wrapping the ring. */
id|tp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|length
op_assign
id|PKT_BUF_SZ
op_or
l_int|0x02000000
suffix:semicolon
id|tp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|buffer2
op_assign
(paren
r_char
op_star
)paren
op_amp
id|tp-&gt;rx_ring
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* The Tx buffer descriptor is filled in as needed, but we&n;&t;   do need to clear the ownership bit. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0x00000000
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|tulip_start_xmit
id|tulip_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
suffix:semicolon
multiline_comment|/* Transmitter timeout, serious problems. */
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tickssofar
OL
l_int|20
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, status %8.8x, SIA %8.8x %8.8x %8.8x %8.8x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR14
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR15
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  Rx ring %8.8x: &quot;
comma
(paren
r_int
)paren
id|tp-&gt;rx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
(paren
r_int
r_int
)paren
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n  Tx ring %8.8x: &quot;
comma
(paren
r_int
)paren
id|tp-&gt;tx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
(paren
r_int
r_int
)paren
id|tp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|tp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* We should reinitialize the hardware here. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
op_logical_or
id|skb-&gt;len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Obsolete driver layer request made: skbuff==NULL.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well.&n;&t;   If this ever occurs the queue layer is doing something evil! */
r_if
c_cond
(paren
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Caution: the write order is important here, set the base address&n;&t;   with the &quot;ownership&quot; bits last. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|tp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|tp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
id|skb-&gt;len
op_or
(paren
id|entry
op_eq
id|TX_RING_SIZE
op_minus
l_int|1
ques
c_cond
l_int|0xe2000000
suffix:colon
l_int|0xe0000000
)paren
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|buffer1
op_assign
id|skb-&gt;data
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|buffer2
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* Pass ownership to the chip. */
id|tp-&gt;cur_tx
op_increment
suffix:semicolon
multiline_comment|/* Trigger an immediate transmit demand. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|tulip_interrupt
r_static
r_void
id|tulip_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
r_struct
id|tulip_private
op_star
id|lp
suffix:semicolon
r_int
id|csr5
comma
id|ioaddr
comma
id|boguscnt
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;tulip_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_do
(brace
id|csr5
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
id|outl
c_func
(paren
id|csr5
op_amp
l_int|0x0001ffff
comma
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt  csr5=%#8.8x new csr5=%#8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr5
comma
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|csr5
op_amp
l_int|0x00018000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x0040
)paren
multiline_comment|/* Rx interrupt */
id|tulip_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x0001
)paren
(brace
multiline_comment|/* Tx-done interrupt */
r_int
id|dirty_tx
op_assign
id|lp-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|dirty_tx
OL
id|lp-&gt;cur_tx
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_int
id|status
op_assign
id|lp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* There was an major error, log it. */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x4104
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0C00
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0200
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0002
)paren
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0080
)paren
id|lp-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0100
)paren
id|lp-&gt;stats.collisions16
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0001
)paren
id|lp-&gt;stats.tx_deferred
op_increment
suffix:semicolon
macro_line|#endif
id|lp-&gt;stats.collisions
op_add_assign
(paren
id|status
op_rshift
l_int|3
)paren
op_amp
l_int|15
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;tx_skbuff
(braket
id|entry
)braket
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|dirty_tx
op_increment
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|lp-&gt;cur_tx
op_minus
id|dirty_tx
op_ge
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;out-of-sync dirty pointer, %d vs. %d, full=%d.&bslash;n&quot;
comma
id|dirty_tx
comma
id|lp-&gt;cur_tx
comma
id|lp-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
id|dirty_tx
OG
id|lp-&gt;cur_tx
op_minus
id|TX_RING_SIZE
op_plus
l_int|2
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|lp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|lp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/* Log errors. */
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* Abnormal error summary bit. */
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x0008
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Tx babble. */
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x0100
)paren
(brace
multiline_comment|/* Missed a Rx frame. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x0800
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Something Wicked happened! %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr5
)paren
suffix:semicolon
multiline_comment|/* Hmmmmm, it&squot;s not clear what to do here. */
)brace
)brace
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Too much work at interrupt, csr5=0x%8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr5
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupt sources. */
id|outl
c_func
(paren
l_int|0x0001ffff
comma
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: exiting interrupt, csr5=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
multiline_comment|/* Special code for testing *only*. */
(brace
r_static
r_int
id|stopit
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
op_eq
l_int|0
op_logical_and
op_decrement
id|stopit
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Emergency stop, looping startup interrupt.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|tulip_rx
id|tulip_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|lp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|lp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot; In tulip_rx().&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If we own the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_ge
l_int|0
)paren
(brace
r_int
id|status
op_assign
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;  tulip_rx() status was %8.8x.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x0300
)paren
op_ne
l_int|0x0300
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Ethernet frame spanned multiple buffers, status %8.8x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* There was a fatal error. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* end of a packet.*/
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0890
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0004
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0002
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0001
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer, compatible with net-2e. */
r_int
id|pkt_len
op_assign
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_rshift
l_int|16
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Check that at least two ring entries are free.&n;&t;&t;&t;&t;   If not, free one and mark stats-&gt;rx_dropped++. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|lp-&gt;rx_ring
(braket
(paren
id|entry
op_plus
id|i
)paren
op_mod
id|RX_RING_SIZE
)braket
dot
id|status
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|RX_RING_SIZE
op_minus
l_int|2
)paren
(brace
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|lp-&gt;cur_rx
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the data fields */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
comma
id|pkt_len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|entry
op_assign
(paren
op_increment
id|lp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tulip_close
id|tulip_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Shutting down ethercard, status was %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR7
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_amp
op_complement
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|tulip_get_stats
id|tulip_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_return
op_amp
id|tp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set or clear the multicast filter for this adaptor.&n; */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|csr6
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_amp
op_complement
l_int|0x00D5
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
id|outl
c_func
(paren
id|csr6
op_or
l_int|0x00C0
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Log any net taps. */
id|printk
c_func
(paren
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
OG
l_int|15
op_logical_or
(paren
id|dev-&gt;mc_flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to filter perfectly -- accept all multicasts. */
id|outl
c_func
(paren
id|csr6
op_or
l_int|0x0080
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
op_star
id|setup_frm
op_assign
id|tp-&gt;setup_frame
suffix:semicolon
r_int
r_int
op_star
id|eaddrs
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* We have &lt;= 15 addresses that we can use the wonderful&n;&t;&t;   16 address perfect filtering of the Tulip.  Note that only&n;&t;&t;   the low shortword of setup_frame[] is valid. */
id|outl
c_func
(paren
id|csr6
op_or
l_int|0x0000
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|dmi
)paren
(brace
id|eaddrs
op_assign
(paren
r_int
r_int
op_star
)paren
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
id|i
op_increment
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
)brace
multiline_comment|/* Fill the rest of the table with our physical address. */
id|eaddrs
op_assign
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
r_do
(brace
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|i
OL
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Now add this frame to the Tx list. */
)brace
)brace
r_static
r_int
DECL|function|set_mac_address
id|set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Setting MAC address to &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|addr
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|devicename
r_static
r_char
id|devicename
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|dev_tulip
r_static
r_struct
id|device
id|dev_tulip
op_assign
(brace
id|devicename
comma
multiline_comment|/* device name is inserted by linux/drivers/net/net_init.c */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|tulip_probe
)brace
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tulip: Sorry, modularization is not completed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|io
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;tulip: You should not use auto-probing with insmod!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_tulip.base_addr
op_assign
id|io
suffix:semicolon
id|dev_tulip.irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|dev_tulip
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tulip: register_netdev() returned non-zero.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|dev_tulip
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -m486 -c tulip.c&quot;&n; *  c-indent-level: 4&n; *  tab-width: 4&n; * End:&n; */
eof
