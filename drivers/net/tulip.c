multiline_comment|/* tulip.c: A DEC 21040-family ethernet driver for linux. */
multiline_comment|/*&n;   NOTICE: THIS IS THE ALPHA TEST VERSION!&n;&t;Written 1994-1997 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver is for the SMC EtherPower PCI ethernet adapter.&n;&t;It should work with most other DEC 21*40-based ethercards.&n;&n;&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;&t;Center of Excellence in Space Data and Information Sciences&n;&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;&n;&t;Support and updates available at&n;&t;http://cesdis.gsfc.nasa.gov/linux/drivers/tulip.html&n;*/
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;tulip.c:v0.83 10/19/97 becker@cesdis.gsfc.nasa.gov&bslash;n&quot;
suffix:semicolon
multiline_comment|/* A few user-configurable values. */
multiline_comment|/* Used to pass the full-duplex flag, etc. */
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|options
r_static
r_int
id|options
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|mtu
r_static
r_int
id|mtu
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* Jumbo MTU for interfaces. */
multiline_comment|/* Set if the PCI BIOS detects the chips on a multiport board backwards. */
macro_line|#ifdef REVERSE_PROBE_ORDER
DECL|variable|reverse_probe
r_static
r_int
id|reverse_probe
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|reverse_probe
r_static
r_int
id|reverse_probe
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Keep the ring sizes a power of two for efficiency.&n;   Making the Tx ring too large decreases the effectiveness of channel&n;   bonding and packet priority.&n;   There are no ill effects from too-large receive rings. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;16
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;16
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-buffer Rx structure. */
macro_line|#ifdef __alpha__
DECL|variable|rx_copybreak
r_static
r_const
id|rx_copybreak
op_assign
l_int|1518
suffix:semicolon
macro_line|#else
DECL|variable|rx_copybreak
r_static
r_const
id|rx_copybreak
op_assign
l_int|100
suffix:semicolon
macro_line|#endif
multiline_comment|/* The following example shows how to always use the 10base2 port. */
macro_line|#ifdef notdef
DECL|macro|TULIP_DEFAULT_MEDIA
mdefine_line|#define TULIP_DEFAULT_MEDIA 1&t;&t;/* 1 == 10base2 */
DECL|macro|TULIP_NO_MEDIA_SWITCH
mdefine_line|#define TULIP_NO_MEDIA_SWITCH&t;&t;/* Don&squot;t switch from this port */
macro_line|#endif
multiline_comment|/* Define to force full-duplex operation on all Tulip interfaces. */
multiline_comment|/* #define  TULIP_FULL_DUPLEX 1 */
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  ((2000*HZ)/1000)
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef MODULE
macro_line|#ifdef MODVERSIONS
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#else
DECL|macro|MOD_INC_USE_COUNT
mdefine_line|#define MOD_INC_USE_COUNT
DECL|macro|MOD_DEC_USE_COUNT
mdefine_line|#define MOD_DEC_USE_COUNT
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
multiline_comment|/* Kernel compatibility defines, common to David Hind&squot;s PCMCIA package.&n;   This is only in the support-all-kernels source code. */
macro_line|#include &lt;linux/version.h&gt;&t;&t;/* Evil, but neccessary */
macro_line|#if defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &lt; 0x10300
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (x)&t;&t;&t;/* What to put in timer-&gt;expires.  */
DECL|macro|DEV_ALLOC_SKB
mdefine_line|#define DEV_ALLOC_SKB(len) alloc_skb(len, GFP_ATOMIC)
DECL|macro|virt_to_bus
mdefine_line|#define virt_to_bus(addr)  ((unsigned long)addr)
DECL|macro|bus_to_virt
mdefine_line|#define bus_to_virt(addr) ((void*)addr)
macro_line|#else  /* 1.3.0 and later */
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
DECL|macro|DEV_ALLOC_SKB
mdefine_line|#define DEV_ALLOC_SKB(len) dev_alloc_skb(len + 2)
macro_line|#endif
macro_line|#if defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &lt; 0x10338
macro_line|#ifdef MODULE
macro_line|#if !defined(CONFIG_MODVERSIONS) &amp;&amp; !defined(__NO_VERSION__)
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
macro_line|#endif
macro_line|#else
DECL|macro|MOD_INC_USE_COUNT
macro_line|#undef MOD_INC_USE_COUNT
DECL|macro|MOD_INC_USE_COUNT
mdefine_line|#define MOD_INC_USE_COUNT
DECL|macro|MOD_DEC_USE_COUNT
macro_line|#undef MOD_DEC_USE_COUNT
DECL|macro|MOD_DEC_USE_COUNT
mdefine_line|#define MOD_DEC_USE_COUNT
macro_line|#endif
macro_line|#endif /* 1.3.38 */
macro_line|#if (LINUX_VERSION_CODE &gt;= 0x10344)
DECL|macro|NEW_MULTICAST
mdefine_line|#define NEW_MULTICAST
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#endif
macro_line|#if (LINUX_VERSION_CODE &gt;= 0x20100)
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
macro_line|#endif
macro_line|#ifdef SA_SHIRQ
DECL|macro|IRQ
mdefine_line|#define IRQ(irq, dev_id, pt_regs) (irq, dev_id, pt_regs)
macro_line|#else
DECL|macro|IRQ
mdefine_line|#define IRQ(irq, dev_id, pt_regs) (irq, pt_regs)
macro_line|#endif
macro_line|#if (LINUX_VERSION_CODE &lt; 0x20123)
DECL|macro|test_and_set_bit
mdefine_line|#define test_and_set_bit(val, addr) set_bit(val, addr)
macro_line|#endif
multiline_comment|/* This my implementation of shared IRQs, now only used for 1.2.13. */
macro_line|#ifdef HAVE_SHARED_IRQ
DECL|macro|USE_SHARED_IRQ
mdefine_line|#define USE_SHARED_IRQ
macro_line|#include &lt;linux/shared_irq.h&gt;
macro_line|#endif
multiline_comment|/* The total size is unusually large: The 21040 aligns each of its 16&n;   longword-wide registers on a quadword boundary. */
DECL|macro|TULIP_TOTAL_SIZE
mdefine_line|#define TULIP_TOTAL_SIZE 0x80
macro_line|#ifdef HAVE_DEVLIST
DECL|variable|tulip_drv
r_struct
id|netdev_entry
id|tulip_drv
op_assign
(brace
l_string|&quot;Tulip&quot;
comma
id|tulip_pci_probe
comma
id|TULIP_TOTAL_SIZE
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef TULIP_DEBUG
DECL|variable|tulip_debug
r_int
id|tulip_debug
op_assign
id|TULIP_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|tulip_debug
r_int
id|tulip_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the DECchip &quot;Tulip&quot;, Digital&squot;s&n;single-chip ethernet controllers for PCI.  Supported members of the family&n;are the 21040, 21041, 21140, 21140A and 21142.  These chips are used on&n;many PCI boards including the SMC EtherPower series.&n;&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS preferably should assign the&n;PCI INTA signal to an otherwise unused system IRQ line.&n;Note: Kernel versions earlier than 1.3.73 do not support shared PCI&n;interrupt lines.&n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;&n;The Tulip can use either ring buffers or lists of Tx and Rx descriptors.&n;This driver uses statically allocated rings of Rx and Tx descriptors, set at&n;compile time by RX/TX_RING_SIZE.  This version of the driver allocates skbuffs&n;for the Rx ring buffers at open() time and passes the skb-&gt;data field to the&n;Tulip as receive data buffers.  When an incoming frame is less than&n;RX_COPYBREAK bytes long, a fresh skbuff is allocated and the frame is&n;copied to the new skbuff.  When the incoming frame is larger, the skbuff is&n;passed directly up the protocol stack and replaced by a newly allocated&n;skbuff.&n;&n;The RX_COPYBREAK value is chosen to trade-off the memory wasted by&n;using a full-sized skbuff for small frames vs. the copying costs of larger&n;frames.  For small frames the copying cost is negligible (esp. considering&n;that we are pre-loading the cache with immediately useful header&n;information).  For large frames the copying cost is non-trivial, and the&n;larger copy might flush the cache of useful data.  A subtle aspect of this&n;choice is that the Tulip only receives into longword aligned buffers, thus&n;the IP header at offset 14 isn&squot;t longword aligned for further processing.&n;Copied frames are put into the new skbuff at an offset of &quot;+2&quot;, thus copying&n;has the beneficial effect of aligning the IP header and preloading the&n;cache.&n;&n;IIIC. Synchronization&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and other software.&n;&n;The send packet thread has partial control over the Tx ring and &squot;dev-&gt;tbusy&squot;&n;flag.  It sets the tbusy flag whenever it&squot;s queuing a Tx packet. If the next&n;queue slot is empty, it clears the tbusy flag when finished otherwise it sets&n;the &squot;tp-&gt;tx_full&squot; flag.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring.  (The Tx-done interrupt can&squot;t be selectively turned off, so&n;we can&squot;t avoid the interrupt overhead by having the Tx routine reap the Tx&n;stats.)&t; After reaping the stats, it marks the queue entry as empty by setting&n;the &squot;base&squot; to zero.&t; Iff the &squot;tp-&gt;tx_full&squot; flag is set, it clears both the&n;tx_full and tbusy flags.&n;&n;IV. Notes&n;&n;Thanks to Duke Kamstra of SMC for providing an EtherPower board.&n;&n;IVb. References&n;&n;http://cesdis.gsfc.nasa.gov/linux/misc/NWay.html&n;http://www.digital.com  (search for current 21*4* datasheets and &quot;21X4 SROM&quot;)&n;http://www.national.com/pf/DP/DP83840.html&n;&n;IVc. Errata&n;&n;The DEC databook doesn&squot;t document which Rx filter settings accept broadcast&n;packets.  Nor does it document how to configure the part to configure the&n;serial subsystem for normal (vs. loopback) operation or how to have it&n;autoswitch between internal 10baseT, SIA and AUI transceivers.&n;&n;The 21040 databook claims that CSR13, CSR14, and CSR15 should each be the last&n;register of the set CSR12-15 written.  Hmmm, now how is that possible?  */
multiline_comment|/* A few values that may be tweaked. */
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;&t;&t;/* Size of each temporary Rx buffer.*/
multiline_comment|/* This is a mysterious value that can be written to CSR11 in the 21040 (only)&n;   to support a pre-NWay full-duplex signaling mechanism using short frames.&n;   No one knows what it should be, but if left at its default value some&n;   10base2(!) packets trigger a full-duplex-request interrupt. */
DECL|macro|FULL_DUPLEX_MAGIC
mdefine_line|#define FULL_DUPLEX_MAGIC&t;0x6969
macro_line|#ifndef PCI_VENDOR_ID_DEC&t;&t;/* Now defined in linux/pci.h */
DECL|macro|PCI_VENDOR_ID_DEC
mdefine_line|#define PCI_VENDOR_ID_DEC&t;&t;&t;0x1011
DECL|macro|PCI_DEVICE_ID_TULIP
mdefine_line|#define PCI_DEVICE_ID_TULIP&t;&t;&t;0x0002&t;&t;/* 21040. */
DECL|macro|PCI_DEVICE_ID_TULIP_FAST
mdefine_line|#define PCI_DEVICE_ID_TULIP_FAST&t;0x0009&t;&t;/* 21140. */
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_DEC_TULIP_PLUS
DECL|macro|PCI_DEVICE_ID_DEC_TULIP_PLUS
mdefine_line|#define PCI_DEVICE_ID_DEC_TULIP_PLUS&t;0x0014&t;&t;/* 21041. */
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_DEC_TULIP_21142
DECL|macro|PCI_DEVICE_ID_DEC_TULIP_21142
mdefine_line|#define PCI_DEVICE_ID_DEC_TULIP_21142&t;0x0019
macro_line|#endif
macro_line|#ifndef PCI_VENDOR_ID_LITEON
DECL|macro|PCI_VENDOR_ID_LITEON
mdefine_line|#define PCI_VENDOR_ID_LITEON&t;0x11AD
DECL|macro|PCI_DEVICE_ID_PNIC
mdefine_line|#define PCI_DEVICE_ID_PNIC&t;&t;0x0002
DECL|macro|PCI_DEVICE_ID_PNIC_X
mdefine_line|#define PCI_DEVICE_ID_PNIC_X&t;0x0168
macro_line|#else
multiline_comment|/* Now PCI_VENDOR_ID_LITEON is defined, but device IDs have different names */
DECL|macro|PCI_DEVICE_ID_PNIC
mdefine_line|#define PCI_DEVICE_ID_PNIC&t;&t;PCI_DEVICE_ID_LITEON_LNE100TX
DECL|macro|PCI_DEVICE_ID_PNIC_X
mdefine_line|#define PCI_DEVICE_ID_PNIC_X&t;0x0168
macro_line|#endif
multiline_comment|/* The rest of these values should never change. */
r_static
r_void
id|tulip_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
multiline_comment|/* A table describing the chip types. */
DECL|struct|tulip_chip_table
r_static
r_struct
id|tulip_chip_table
(brace
DECL|member|device_id
r_int
id|device_id
suffix:semicolon
DECL|member|chip_name
r_char
op_star
id|chip_name
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|member|media_timer
r_void
(paren
op_star
id|media_timer
)paren
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
DECL|variable|tulip_tbl
)brace
id|tulip_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE_ID_DEC_TULIP
comma
l_string|&quot;Digital DS21040 Tulip&quot;
comma
l_int|0
comma
id|tulip_timer
)brace
comma
(brace
id|PCI_DEVICE_ID_DEC_TULIP_PLUS
comma
l_string|&quot;Digital DS21041 Tulip&quot;
comma
l_int|0
comma
id|tulip_timer
)brace
comma
(brace
id|PCI_DEVICE_ID_DEC_TULIP_FAST
comma
l_string|&quot;Digital DS21140 Tulip&quot;
comma
l_int|0
comma
id|tulip_timer
)brace
comma
(brace
id|PCI_DEVICE_ID_DEC_TULIP_21142
comma
l_string|&quot;Digital DS21142/3 Tulip&quot;
comma
l_int|0
comma
id|tulip_timer
)brace
comma
(brace
id|PCI_DEVICE_ID_PNIC_X
comma
l_string|&quot;Lite-On 82c168 PNIC&quot;
comma
l_int|0
comma
id|tulip_timer
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* This matches the table above. */
DECL|enum|chips
DECL|enumerator|DC21040
DECL|enumerator|DC21041
DECL|enumerator|DC21140
DECL|enumerator|DC21142
DECL|enumerator|LC82C168
r_enum
id|chips
(brace
id|DC21040
op_assign
l_int|0
comma
id|DC21041
op_assign
l_int|1
comma
id|DC21140
op_assign
l_int|2
comma
id|DC21142
op_assign
l_int|3
comma
id|LC82C168
)brace
suffix:semicolon
DECL|variable|medianame
r_static
r_const
r_char
op_star
r_const
id|medianame
(braket
)braket
op_assign
(brace
l_string|&quot;10baseT&quot;
comma
l_string|&quot;10base2&quot;
comma
l_string|&quot;AUI&quot;
comma
l_string|&quot;100baseTx&quot;
comma
l_string|&quot;10baseT-FD&quot;
comma
l_string|&quot;100baseTx-FD&quot;
comma
l_string|&quot;100baseT4&quot;
comma
l_string|&quot;100baseFx&quot;
comma
l_string|&quot;100baseFx-FD&quot;
comma
l_string|&quot;MII 10baseT&quot;
comma
l_string|&quot;MII 10baseT-FD&quot;
comma
l_string|&quot;MII&quot;
comma
l_string|&quot;10baseT(forced)&quot;
comma
l_string|&quot;MII 100baseTx&quot;
comma
l_string|&quot;MII 100baseTx-FD&quot;
comma
l_string|&quot;MII 100baseT4&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* A full-duplex map for above. */
DECL|variable|media_fd
r_static
r_const
r_char
id|media_fd
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0
comma
l_int|0
comma
l_int|0xff
comma
l_int|0
comma
l_int|0xff
comma
l_int|0x01
comma
l_int|0
comma
l_int|0
comma
l_int|0xff
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* 21041 transceiver register settings: 10-T, 10-2, AUI, 10-T, 10T-FD*/
DECL|variable|t21041_csr13
r_static
id|u16
id|t21041_csr13
(braket
)braket
op_assign
(brace
l_int|0xEF05
comma
l_int|0xEF09
comma
l_int|0xEF09
comma
l_int|0xEF01
comma
l_int|0xEF09
comma
)brace
suffix:semicolon
DECL|variable|t21041_csr14
r_static
id|u16
id|t21041_csr14
(braket
)braket
op_assign
(brace
l_int|0x7F3F
comma
l_int|0xF7FD
comma
l_int|0xF7FD
comma
l_int|0x7F3F
comma
l_int|0x7F3D
comma
)brace
suffix:semicolon
DECL|variable|t21041_csr15
r_static
id|u16
id|t21041_csr15
(braket
)braket
op_assign
(brace
l_int|0x0008
comma
l_int|0x0006
comma
l_int|0x000E
comma
l_int|0x0008
comma
l_int|0x0008
comma
)brace
suffix:semicolon
DECL|variable|t21142_csr13
r_static
id|u16
id|t21142_csr13
(braket
)braket
op_assign
(brace
l_int|0x0001
comma
l_int|0x0009
comma
l_int|0x0009
comma
l_int|0x0000
comma
l_int|0x0001
comma
)brace
suffix:semicolon
DECL|variable|t21142_csr14
r_static
id|u16
id|t21142_csr14
(braket
)braket
op_assign
(brace
l_int|0xFFFF
comma
l_int|0x0705
comma
l_int|0x0705
comma
l_int|0x0000
comma
l_int|0x7F3D
comma
)brace
suffix:semicolon
DECL|variable|t21142_csr15
r_static
id|u16
id|t21142_csr15
(braket
)braket
op_assign
(brace
l_int|0x0008
comma
l_int|0x0006
comma
l_int|0x000E
comma
l_int|0x0008
comma
l_int|0x0008
comma
)brace
suffix:semicolon
multiline_comment|/* Offsets to the Command and Status Registers, &quot;CSRs&quot;.  All accesses&n;   must be longword instructions and quadword aligned. */
DECL|enum|tulip_offsets
r_enum
id|tulip_offsets
(brace
DECL|enumerator|CSR0
DECL|enumerator|CSR1
DECL|enumerator|CSR2
DECL|enumerator|CSR3
DECL|enumerator|CSR4
DECL|enumerator|CSR5
id|CSR0
op_assign
l_int|0
comma
id|CSR1
op_assign
l_int|0x08
comma
id|CSR2
op_assign
l_int|0x10
comma
id|CSR3
op_assign
l_int|0x18
comma
id|CSR4
op_assign
l_int|0x20
comma
id|CSR5
op_assign
l_int|0x28
comma
DECL|enumerator|CSR6
DECL|enumerator|CSR7
DECL|enumerator|CSR8
DECL|enumerator|CSR9
DECL|enumerator|CSR10
DECL|enumerator|CSR11
id|CSR6
op_assign
l_int|0x30
comma
id|CSR7
op_assign
l_int|0x38
comma
id|CSR8
op_assign
l_int|0x40
comma
id|CSR9
op_assign
l_int|0x48
comma
id|CSR10
op_assign
l_int|0x50
comma
id|CSR11
op_assign
l_int|0x58
comma
DECL|enumerator|CSR12
DECL|enumerator|CSR13
DECL|enumerator|CSR14
DECL|enumerator|CSR15
id|CSR12
op_assign
l_int|0x60
comma
id|CSR13
op_assign
l_int|0x68
comma
id|CSR14
op_assign
l_int|0x70
comma
id|CSR15
op_assign
l_int|0x78
)brace
suffix:semicolon
multiline_comment|/* The bits in the CSR5 status registers, mostly interrupt sources. */
DECL|enum|status_bits
r_enum
id|status_bits
(brace
DECL|enumerator|TimerInt
DECL|enumerator|TPLnkFail
DECL|enumerator|TPLnkPass
id|TimerInt
op_assign
l_int|0x800
comma
id|TPLnkFail
op_assign
l_int|0x1000
comma
id|TPLnkPass
op_assign
l_int|0x10
comma
DECL|enumerator|RxJabber
DECL|enumerator|RxDied
DECL|enumerator|RxNoBuf
DECL|enumerator|RxIntr
id|RxJabber
op_assign
l_int|0x200
comma
id|RxDied
op_assign
l_int|0x100
comma
id|RxNoBuf
op_assign
l_int|0x80
comma
id|RxIntr
op_assign
l_int|0x40
comma
DECL|enumerator|TxFIFOUnderflow
DECL|enumerator|TxJabber
DECL|enumerator|TxNoBuf
DECL|enumerator|TxDied
id|TxFIFOUnderflow
op_assign
l_int|0x20
comma
id|TxJabber
op_assign
l_int|0x08
comma
id|TxNoBuf
op_assign
l_int|0x04
comma
id|TxDied
op_assign
l_int|0x02
comma
DECL|enumerator|TxIntr
id|TxIntr
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
multiline_comment|/* The Tulip Rx and Tx buffer descriptors. */
DECL|struct|tulip_rx_desc
r_struct
id|tulip_rx_desc
(brace
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|length
id|s32
id|length
suffix:semicolon
DECL|member|buffer1
DECL|member|buffer2
id|u32
id|buffer1
comma
id|buffer2
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tulip_tx_desc
r_struct
id|tulip_tx_desc
(brace
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|length
id|s32
id|length
suffix:semicolon
DECL|member|buffer1
DECL|member|buffer2
id|u32
id|buffer1
comma
id|buffer2
suffix:semicolon
multiline_comment|/* We use only buffer 1.  */
)brace
suffix:semicolon
DECL|struct|medialeaf
r_struct
id|medialeaf
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|media
id|u8
id|media
suffix:semicolon
DECL|member|leafdata
r_int
r_char
op_star
id|leafdata
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mediatable
r_struct
id|mediatable
(brace
DECL|member|defaultmedia
id|u16
id|defaultmedia
suffix:semicolon
DECL|member|leafcount
DECL|member|csr12dir
id|u8
id|leafcount
comma
id|csr12dir
suffix:semicolon
multiline_comment|/* General purpose pin directions. */
DECL|member|has_mii
r_int
id|has_mii
suffix:colon
l_int|1
suffix:semicolon
DECL|member|mleaf
r_struct
id|medialeaf
id|mleaf
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mediainfo
r_struct
id|mediainfo
(brace
DECL|member|next
r_struct
id|mediainfo
op_star
id|next
suffix:semicolon
DECL|member|info_type
r_int
id|info_type
suffix:semicolon
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|non_mii
DECL|member|media
DECL|member|csr12val
DECL|member|bitnum
DECL|member|flags
DECL|member|non_mii
r_struct
id|non_mii
(brace
r_char
id|media
suffix:semicolon
r_int
r_char
id|csr12val
suffix:semicolon
r_char
id|bitnum
comma
id|flags
suffix:semicolon
)brace
id|non_mii
suffix:semicolon
DECL|member|info
r_int
r_char
op_star
id|info
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tulip_private
r_struct
id|tulip_private
(brace
DECL|member|devname
r_char
id|devname
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Used only for kernel debugging. */
DECL|member|product_name
r_const
r_char
op_star
id|product_name
suffix:semicolon
DECL|member|next_module
r_struct
id|device
op_star
id|next_module
suffix:semicolon
DECL|member|rx_ring
r_struct
id|tulip_rx_desc
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_ring
r_struct
id|tulip_tx_desc
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for skfree(). */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The addresses of receive-in-place skbuffs. */
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_buffs
r_char
op_star
id|rx_buffs
suffix:semicolon
multiline_comment|/* Address of temporary Rx buffers. */
DECL|member|setup_frame
id|u32
id|setup_frame
(braket
l_int|48
)braket
suffix:semicolon
multiline_comment|/* Pseudo-Tx frame to init address table. */
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
DECL|member|revision
r_int
id|revision
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; 0x20139
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
macro_line|#else
DECL|member|stats
r_struct
id|enet_statistics
id|stats
suffix:semicolon
macro_line|#endif
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
macro_line|#ifdef CONFIG_NET_HW_FLOWCONTROL
DECL|member|fc_bit
r_int
id|fc_bit
suffix:semicolon
macro_line|#endif
DECL|member|cur_rx
DECL|member|cur_tx
r_int
r_int
id|cur_rx
comma
id|cur_tx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_rx
DECL|member|dirty_tx
r_int
r_int
id|dirty_rx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The Tx queue is full. */
DECL|member|full_duplex
r_int
r_int
id|full_duplex
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Full-duplex operation requested. */
DECL|member|full_duplex_lock
r_int
r_int
id|full_duplex_lock
suffix:colon
l_int|1
suffix:semicolon
DECL|member|default_port
r_int
r_int
id|default_port
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Last dev-&gt;if_port value. */
DECL|member|media2
r_int
r_int
id|media2
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Secondary monitored media port. */
DECL|member|medialock
r_int
r_int
id|medialock
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t sense media type. */
DECL|member|mediasense
r_int
r_int
id|mediasense
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Media sensing in progress. */
DECL|member|csr6
r_int
r_int
id|csr6
suffix:semicolon
multiline_comment|/* Current CSR6 control settings. */
DECL|member|eeprom
r_int
r_char
id|eeprom
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Serial EEPROM contents. */
DECL|member|phys
r_int
r_char
id|phys
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* MII device addresses. */
DECL|member|mtable
r_struct
id|mediatable
op_star
id|mtable
suffix:semicolon
DECL|member|cur_index
r_int
id|cur_index
suffix:semicolon
multiline_comment|/* Current media index. */
DECL|member|pci_bus
DECL|member|pci_device_fn
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
DECL|member|pad0
DECL|member|pad1
r_int
id|pad0
comma
id|pad1
suffix:semicolon
multiline_comment|/* Used for 8-byte alignment */
)brace
suffix:semicolon
r_static
r_struct
id|device
op_star
id|tulip_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_id
comma
r_int
id|options
)paren
suffix:semicolon
r_static
r_void
id|parse_eeprom
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|select_media
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|startup
)paren
suffix:semicolon
r_static
r_int
id|tulip_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tulip_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|tulip_tx_timeout
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tulip_init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tulip_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tulip_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tulip_interrupt
id|IRQ
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|tulip_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|tulip_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef NEW_MULTICAST
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#else
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FASTROUTE
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
r_static
r_int
id|tulip_accept_fastpath
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|dst_entry
op_star
id|dst
)paren
suffix:semicolon
macro_line|#endif
"&f;"
macro_line|#ifdef MODULE
multiline_comment|/* A list of all installed Tulip devices, for removing the driver module. */
DECL|variable|root_tulip_dev
r_static
r_struct
id|device
op_star
id|root_tulip_dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* This 21040 probe no longer uses a large fixed contiguous Rx buffer region,&n;   but now receives directly into full-sized skbuffs that are allocated&n;   at open() time.&n;   This allows the probe routine to use the old driver initialization&n;   interface. */
DECL|function|tulip_probe
r_int
id|tulip_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Static, for multiple probe calls. */
multiline_comment|/* Ideally we would detect all network cards in slot order.  That would&n;&t;   be best done a central PCI probe dispatch, which wouldn&squot;t work&n;&t;   well with the current structure.  So instead we detect just the&n;&t;   Tulip cards in slot order. */
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_int
r_char
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|pci_index
OL
l_int|0xff
suffix:semicolon
id|pci_index
op_increment
)paren
(brace
r_int
r_char
id|pci_irq_line
comma
id|pci_latency
suffix:semicolon
r_int
r_int
id|pci_command
comma
id|vendor
comma
id|device
suffix:semicolon
r_int
r_int
id|pci_ioaddr
comma
id|chip_idx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_find_class
(paren
id|PCI_CLASS_NETWORK_ETHERNET
op_lshift
l_int|8
comma
id|reverse_probe
ques
c_cond
l_int|0xfe
op_minus
id|pci_index
suffix:colon
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_if
c_cond
(paren
id|reverse_probe
)paren
r_continue
suffix:semicolon
r_else
r_break
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device
)paren
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq_line
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|pci_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Remove I/O space marker in bit 0. */
id|pci_ioaddr
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|vendor
op_ne
id|PCI_VENDOR_ID_DEC
op_logical_and
id|vendor
op_ne
id|PCI_VENDOR_ID_LITEON
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|vendor
op_eq
id|PCI_VENDOR_ID_LITEON
)paren
id|device
op_assign
id|PCI_DEVICE_ID_PNIC_X
suffix:semicolon
r_for
c_loop
(paren
id|chip_idx
op_assign
l_int|0
suffix:semicolon
id|tulip_tbl
(braket
id|chip_idx
)braket
dot
id|chip_name
suffix:semicolon
id|chip_idx
op_increment
)paren
r_if
c_cond
(paren
id|device
op_eq
id|tulip_tbl
(braket
id|chip_idx
)braket
dot
id|device_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|tulip_tbl
(braket
id|chip_idx
)braket
dot
id|chip_name
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unknown Digital PCI ethernet chip type&quot;
l_string|&quot; %4.4x&quot;&quot; detected: not configured.&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Found DEC PCI Tulip at I/O %#x, IRQ %d.&bslash;n&quot;
comma
id|pci_ioaddr
comma
id|pci_irq_line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|pci_ioaddr
comma
id|TULIP_TOTAL_SIZE
)paren
)paren
r_continue
suffix:semicolon
macro_line|#ifdef MODULE
id|dev
op_assign
id|tulip_probe1
c_func
(paren
id|dev
comma
id|pci_ioaddr
comma
id|pci_irq_line
comma
id|chip_idx
comma
id|cards_found
)paren
suffix:semicolon
macro_line|#else
id|dev
op_assign
id|tulip_probe1
c_func
(paren
id|dev
comma
id|pci_ioaddr
comma
id|pci_irq_line
comma
id|chip_idx
comma
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev
)paren
(brace
multiline_comment|/* Get and check the bus-master and latency values. */
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_command
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  PCI Master Bit has not been set! Setting...&bslash;n&quot;
)paren
suffix:semicolon
id|pci_command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
suffix:semicolon
)brace
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
OL
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  PCI latency timer (CFLT) is unreasonably&quot;
l_string|&quot; low at %d.  Setting to 64 clocks.&bslash;n&quot;
comma
id|pci_latency
)paren
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_LATENCY_TIMER
comma
l_int|64
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  PCI latency timer (CFLT) is %#x.&bslash;n&quot;
comma
id|pci_latency
)paren
suffix:semicolon
multiline_comment|/* Bring the 21143 out power-down mode. */
r_if
c_cond
(paren
id|device
op_eq
id|PCI_DEVICE_ID_DEC_TULIP_21142
)paren
id|pcibios_write_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
l_int|0x40
comma
l_int|0x40000000
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
)brace
)brace
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|tulip_probe1
r_static
r_struct
id|device
op_star
id|tulip_probe1
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|chip_id
comma
r_int
id|board_idx
)paren
(brace
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Already printed version info. */
r_struct
id|tulip_private
op_star
id|tp
suffix:semicolon
multiline_comment|/* See note below on the multiport cards. */
r_static
r_int
r_char
id|last_phys_addr
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x00
comma
l_char|&squot;L&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;u&squot;
comma
l_char|&squot;x&squot;
)brace
suffix:semicolon
r_static
r_int
id|last_irq
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|sum
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|0
op_logical_and
id|did_version
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at %#3x,&quot;
comma
id|dev-&gt;name
comma
id|tulip_tbl
(braket
id|chip_id
)braket
dot
id|chip_name
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_amp
op_complement
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Clear the missed-packet counter. */
(paren
r_volatile
)paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip_id
op_eq
id|DC21041
)paren
(brace
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR9
)paren
op_amp
l_int|0x8000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 21040 compatible mode,&quot;
)paren
suffix:semicolon
id|chip_id
op_assign
id|DC21040
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot; 21041 mode,&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The station address ROM is read byte serially.  The register must&n;&t;   be polled, waiting for the value to be read bit serially from the&n;&t;   EEPROM.&n;&t;   */
id|sum
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|chip_id
op_eq
id|DC21040
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR9
)paren
suffix:semicolon
multiline_comment|/* Reset the pointer with a dummy write. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|value
comma
id|boguscnt
op_assign
l_int|100000
suffix:semicolon
r_do
id|value
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR9
)paren
suffix:semicolon
r_while
c_loop
(paren
id|value
template_param
l_int|0
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|value
suffix:semicolon
id|sum
op_add_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|chip_id
op_eq
id|LC82C168
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|value
comma
id|boguscnt
op_assign
l_int|100000
suffix:semicolon
id|outl
c_func
(paren
l_int|0x600
op_or
id|i
comma
id|ioaddr
op_plus
l_int|0x98
)paren
suffix:semicolon
r_do
id|value
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR9
)paren
suffix:semicolon
r_while
c_loop
(paren
id|value
template_param
l_int|0
)paren
suffix:semicolon
(paren
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
id|i
)braket
op_assign
id|value
suffix:semicolon
id|sum
op_add_assign
id|value
op_amp
l_int|0xffff
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Must be a new chip, with a serial EEPROM interface. */
multiline_comment|/* We read the whole EEPROM, and sort it out later.  DEC has a&n;&t;&t;   specification _Digital Semiconductor 21X4 Serial ROM Format_&n;&t;&t;   but early vendor boards just put the address in the first six&n;&t;&t;   EEPROM locations. */
r_int
r_char
id|ee_data
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|sa_offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ee_data
)paren
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
id|ee_data
)paren
(braket
id|i
)braket
op_assign
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Detect the simple EEPROM format by the duplicated station addr. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ee_data
(braket
id|i
)braket
op_ne
id|ee_data
(braket
l_int|16
op_plus
id|i
)braket
)paren
id|sa_offset
op_assign
l_int|20
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|ee_data
(braket
id|i
op_plus
id|sa_offset
)braket
suffix:semicolon
id|sum
op_add_assign
id|ee_data
(braket
id|i
op_plus
id|sa_offset
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* Lite-On boards have the address byte-swapped. */
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_eq
l_int|0xA0
op_logical_and
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_eq
l_int|0x00
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_char
id|tmp
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|tmp
suffix:semicolon
)brace
multiline_comment|/* On the Zynx 315 Etherarray and other multiport boards only the&n;&t;   first Tulip has an EEPROM.&n;&t;   The addresses of the subsequent ports are derived from the first.&n;&t;   Many PCI BIOSes also incorrectly report the IRQ line, so we correct&n;&t;   that here as well. */
r_if
c_cond
(paren
id|sum
op_eq
l_int|0
op_logical_or
id|sum
op_eq
l_int|6
op_star
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; EEPROM not present,&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|last_phys_addr
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|last_phys_addr
(braket
id|i
)braket
op_plus
l_int|1
suffix:semicolon
macro_line|#if defined(__i386__)&t;&t;/* This BIOS bug doesn&squot;t exist on Alphas. */
id|irq
op_assign
id|last_irq
suffix:semicolon
macro_line|#endif
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|last_phys_addr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, IRQ %d.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|last_irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* We do a request_region() only to register /proc/ioports info. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|TULIP_TOTAL_SIZE
comma
id|tulip_tbl
(braket
id|chip_id
)braket
dot
id|chip_name
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* Make certain the data structures are quadword aligned. */
id|tp
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|tp
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|tp
)paren
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|tp
suffix:semicolon
macro_line|#ifdef MODULE
id|tp-&gt;next_module
op_assign
id|root_tulip_dev
suffix:semicolon
id|root_tulip_dev
op_assign
id|dev
suffix:semicolon
macro_line|#endif
id|tp-&gt;chip_id
op_assign
id|chip_id
suffix:semicolon
macro_line|#ifdef TULIP_FULL_DUPLEX
id|tp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;full_duplex_lock
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef TULIP_DEFAULT_MEDIA
id|tp-&gt;default_port
op_assign
id|TULIP_DEFAULT_MEDIA
suffix:semicolon
macro_line|#endif
macro_line|#ifdef TULIP_NO_MEDIA_SWITCH
id|tp-&gt;medialock
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* The lower four bits are the media type. */
r_if
c_cond
(paren
id|board_idx
op_ge
l_int|0
)paren
(brace
id|tp-&gt;full_duplex
op_assign
(paren
id|options
(braket
id|board_idx
)braket
op_amp
l_int|16
)paren
op_logical_or
id|full_duplex
(braket
id|board_idx
)braket
OG
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;full_duplex
)paren
id|tp-&gt;full_duplex_lock
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;default_port
op_assign
id|options
(braket
id|board_idx
)braket
op_amp
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;default_port
)paren
id|tp-&gt;medialock
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mtu
(braket
id|board_idx
)braket
OG
l_int|0
)paren
id|dev-&gt;mtu
op_assign
id|mtu
(braket
id|board_idx
)braket
suffix:semicolon
)brace
multiline_comment|/* This is logically part of probe1(), but too complex to write inline. */
r_if
c_cond
(paren
id|chip_id
op_ne
id|DC21040
op_logical_and
id|chip_id
op_ne
id|LC82C168
)paren
id|parse_eeprom
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;mtable
op_logical_and
id|tp-&gt;mtable-&gt;has_mii
)paren
(brace
r_int
id|phy
comma
id|phy_idx
suffix:semicolon
multiline_comment|/* Find the connected MII xcvrs.&n;&t;&t;   Doing this in open() would allow detecting external xcvrs later,&n;&t;&t;   but takes much time. */
r_for
c_loop
(paren
id|phy
op_assign
l_int|0
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
id|phy
OL
l_int|32
op_logical_and
id|phy_idx
OL
r_sizeof
(paren
id|tp-&gt;phys
)paren
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
op_logical_and
id|mii_status
op_ne
l_int|0x0000
)paren
(brace
id|tp-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phy
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  MII transceiver found at MDIO address %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|phy_idx
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ***WARNING***: No MII transceiver found!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tp-&gt;phys
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* The Tulip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|tulip_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|tulip_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|tulip_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|tulip_get_stats
suffix:semicolon
macro_line|#ifdef HAVE_MULTICAST
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_multicast_list
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|dev-&gt;accept_fastpath
op_assign
id|tulip_accept_fastpath
suffix:semicolon
macro_line|#endif
multiline_comment|/* Reset the xcvr interface and turn on heartbeat. */
r_switch
c_cond
(paren
id|chip_id
)paren
(brace
r_case
id|DC21041
suffix:colon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xFFFFFFFF
comma
id|ioaddr
op_plus
id|CSR14
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000008
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
multiline_comment|/* Listen on AUI also. */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_or
l_int|0x200
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x0000EF05
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DC21140
suffix:colon
r_case
id|DC21142
suffix:colon
r_if
c_cond
(paren
id|tp-&gt;mtable
)paren
id|outl
c_func
(paren
id|tp-&gt;mtable-&gt;csr12dir
op_or
l_int|0x100
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DC21040
suffix:colon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000004
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LC82C168
suffix:colon
id|outl
c_func
(paren
l_int|0x33
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x0201F078
comma
id|ioaddr
op_plus
l_int|0xB8
)paren
suffix:semicolon
multiline_comment|/* Turn on autonegotiation. */
r_break
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Serial EEPROM section. */
multiline_comment|/* The main routine to parse the very complicated SROM structure.&n;   Search www.digital.com for &quot;21X4 SROM&quot; to get details.&n;   This code is very complex, and will require changes to support&n;   additional cards, so I&squot;ll be verbose about what is going on.&n;   */
multiline_comment|/* Known cards that have old-style EEPROMs. */
DECL|struct|fixups
r_static
r_struct
id|fixups
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|addr0
DECL|member|addr1
DECL|member|addr2
r_int
r_char
id|addr0
comma
id|addr1
comma
id|addr2
suffix:semicolon
DECL|member|newtable
id|u16
id|newtable
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Max length below. */
DECL|variable|eeprom_fixups
)brace
id|eeprom_fixups
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Asante&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0x94
comma
(brace
l_int|0x1e00
comma
l_int|0x0000
comma
l_int|0x0800
comma
l_int|0x0100
comma
l_int|0x018c
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xe078
comma
l_int|0x0001
comma
l_int|0x0050
comma
l_int|0x0018
)brace
)brace
comma
(brace
l_string|&quot;SMC9332DST&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0xC0
comma
(brace
l_int|0x1e00
comma
l_int|0x0000
comma
l_int|0x0800
comma
l_int|0x021f
comma
l_int|0x0000
comma
l_int|0x009E
comma
multiline_comment|/* 10baseT */
l_int|0x0903
comma
l_int|0x006D
comma
multiline_comment|/* 100baseTx */
)brace
)brace
comma
(brace
l_string|&quot;Cogent EM100&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0x92
comma
(brace
l_int|0x1e00
comma
l_int|0x0000
comma
l_int|0x0800
comma
l_int|0x013f
comma
l_int|0x0103
comma
l_int|0x006D
comma
multiline_comment|/* 100baseTx */
)brace
)brace
comma
(brace
l_string|&quot;Maxtech NX-110&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0xE8
comma
(brace
l_int|0x1e00
comma
l_int|0x0000
comma
l_int|0x0800
comma
l_int|0x0313
comma
l_int|0x1001
comma
l_int|0x009E
comma
multiline_comment|/* 10base2, CSR12 0x10*/
l_int|0x0000
comma
l_int|0x009E
comma
multiline_comment|/* 10baseT */
l_int|0x0303
comma
l_int|0x006D
comma
multiline_comment|/* 100baseTx, CSR12 0x03 */
)brace
)brace
comma
(brace
l_string|&quot;Accton EN1207&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0xE8
comma
(brace
l_int|0x1e00
comma
l_int|0x0000
comma
l_int|0x0800
comma
l_int|0x031F
comma
l_int|0x1B01
comma
l_int|0x0000
comma
multiline_comment|/* 10base2,   CSR12 0x1B */
l_int|0x1B03
comma
l_int|0x006D
comma
multiline_comment|/* 100baseTx, CSR12 0x1B */
l_int|0x0B00
comma
l_int|0x009E
comma
multiline_comment|/* 10baseT,   CSR12 0x0B */
)brace
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(brace
)brace
)brace
)brace
suffix:semicolon
DECL|variable|block_name
r_static
r_const
r_char
op_star
id|block_name
(braket
)braket
op_assign
(brace
l_string|&quot;21140 non-MII&quot;
comma
l_string|&quot;21140 MII PHY&quot;
comma
l_string|&quot;21142 non-MII PHY&quot;
comma
l_string|&quot;21142 MII PHY&quot;
comma
l_string|&quot;21143 SYM PHY&quot;
comma
l_string|&quot;21143 reset method&quot;
)brace
suffix:semicolon
DECL|macro|EEPROM_SIZE
mdefine_line|#define EEPROM_SIZE 128
DECL|function|parse_eeprom
r_static
r_void
id|parse_eeprom
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
multiline_comment|/* The last media info list parsed, for multiport boards.  */
r_static
r_struct
id|mediatable
op_star
id|last_mediatable
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
r_char
op_star
id|last_ee_data
op_assign
l_int|NULL
suffix:semicolon
r_static
id|controller_index
op_assign
l_int|0
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_char
op_star
id|ee_data
op_assign
id|tp-&gt;eeprom
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp-&gt;mtable
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EEPROM_SIZE
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
id|ee_data
)paren
(braket
id|i
)braket
op_assign
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Detect an old-style (SA only) EEPROM layout:&n;&t;   memcmp(eedata, eedata+16, 8). */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ee_data
(braket
id|i
)braket
op_ne
id|ee_data
(braket
l_int|16
op_plus
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|ee_data
(braket
l_int|0
)braket
op_eq
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|last_mediatable
)paren
(brace
id|controller_index
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  Controller %d of multiport board.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|controller_index
)paren
suffix:semicolon
id|tp-&gt;mtable
op_assign
id|last_mediatable
suffix:semicolon
id|ee_data
op_assign
id|last_ee_data
suffix:semicolon
r_goto
id|subsequent_board
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  Missing EEPROM, this interface may &quot;
l_string|&quot;not work correctly!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Do a fix-up based on the vendor half of the station address prefix. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|eeprom_fixups
(braket
id|i
)braket
dot
id|name
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_eq
id|eeprom_fixups
(braket
id|i
)braket
dot
id|addr0
op_logical_and
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_eq
id|eeprom_fixups
(braket
id|i
)braket
dot
id|addr1
op_logical_and
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_eq
id|eeprom_fixups
(braket
id|i
)braket
dot
id|addr2
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_eq
l_int|0xE8
op_logical_and
id|ee_data
(braket
l_int|0x1a
)braket
op_eq
l_int|0x55
)paren
id|i
op_increment
suffix:semicolon
multiline_comment|/* An Accton EN1207, not an outlaw Maxtech. */
id|memcpy
c_func
(paren
id|ee_data
op_plus
l_int|26
comma
id|eeprom_fixups
(braket
id|i
)braket
dot
id|newtable
comma
r_sizeof
(paren
id|eeprom_fixups
(braket
id|i
)braket
dot
id|newtable
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Old format EEPROM on &squot;%s&squot; board.  Using&quot;
l_string|&quot; substitute media control info.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|eeprom_fixups
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|eeprom_fixups
(braket
id|i
)braket
dot
id|name
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No fixup found. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Old style EEPROM -- no media selection information.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;read_eeprom:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s%4.4x&quot;
comma
(paren
id|i
op_amp
l_int|7
)paren
op_eq
l_int|0
ques
c_cond
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
suffix:colon
l_string|&quot; &quot;
comma
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|controller_index
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ee_data
(braket
l_int|19
)braket
OG
l_int|1
)paren
(brace
multiline_comment|/* Multiport board. */
id|last_ee_data
op_assign
id|ee_data
suffix:semicolon
)brace
id|subsequent_board
suffix:colon
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21041
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
(paren
r_void
op_star
)paren
id|ee_data
op_plus
id|ee_data
(braket
l_int|27
op_plus
id|controller_index
op_star
l_int|3
)braket
suffix:semicolon
r_int
id|media
op_assign
op_star
(paren
id|u16
op_star
)paren
id|p
suffix:semicolon
r_int
id|count
op_assign
id|p
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:21041 Media information at %d, default media &quot;
l_string|&quot;%4.4x (%s).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ee_data
(braket
l_int|27
)braket
comma
id|media
comma
id|media
op_amp
l_int|0x0800
ques
c_cond
l_string|&quot;Autosense&quot;
suffix:colon
id|medianame
(braket
id|media
op_amp
l_int|15
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|media_code
op_assign
id|p
(braket
l_int|3
op_plus
id|i
op_star
l_int|7
)braket
suffix:semicolon
id|u16
op_star
id|csrvals
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|p
(braket
l_int|3
op_plus
id|i
op_star
l_int|7
op_plus
l_int|1
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  21041 media %2.2x (%s),&quot;
l_string|&quot; csr13 %4.4x csr14 %4.4x csr15 %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_code
op_amp
l_int|15
comma
id|medianame
(braket
id|media_code
op_amp
l_int|15
)braket
comma
id|csrvals
(braket
l_int|0
)braket
comma
id|csrvals
(braket
l_int|1
)braket
comma
id|csrvals
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_char
op_star
id|p
op_assign
(paren
r_void
op_star
)paren
id|ee_data
op_plus
id|ee_data
(braket
l_int|27
)braket
suffix:semicolon
r_int
r_char
id|csr12dir
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
r_struct
id|mediatable
op_star
id|mtable
suffix:semicolon
id|u16
id|media
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
id|p
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21140
)paren
id|csr12dir
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|count
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|mtable
op_assign
(paren
r_struct
id|mediatable
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mediatable
)paren
op_plus
id|count
op_star
r_sizeof
(paren
r_struct
id|medialeaf
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtable
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Horrible, impossible failure. */
id|last_mediatable
op_assign
id|tp-&gt;mtable
op_assign
id|mtable
suffix:semicolon
id|mtable-&gt;defaultmedia
op_assign
id|media
suffix:semicolon
id|mtable-&gt;leafcount
op_assign
id|count
suffix:semicolon
id|mtable-&gt;csr12dir
op_assign
id|csr12dir
suffix:semicolon
id|mtable-&gt;has_mii
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  EEPROM default media type %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media
op_amp
l_int|0x0800
ques
c_cond
l_string|&quot;Autosense&quot;
suffix:colon
id|medianame
(braket
id|media
op_amp
l_int|15
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|medialeaf
op_star
id|leaf
op_assign
op_amp
id|mtable-&gt;mleaf
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 21140 Compact block. */
id|leaf-&gt;type
op_assign
l_int|0
suffix:semicolon
id|leaf-&gt;media
op_assign
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x3f
suffix:semicolon
id|leaf-&gt;leafdata
op_assign
id|p
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|leaf-&gt;type
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|1
)paren
(brace
id|mtable-&gt;has_mii
op_assign
l_int|1
suffix:semicolon
id|leaf-&gt;media
op_assign
l_int|11
suffix:semicolon
)brace
r_else
id|leaf-&gt;media
op_assign
id|p
(braket
l_int|2
)braket
op_amp
l_int|0x0f
suffix:semicolon
id|leaf-&gt;leafdata
op_assign
id|p
op_plus
l_int|2
suffix:semicolon
id|p
op_add_assign
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x3f
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
op_logical_and
id|leaf-&gt;media
op_eq
l_int|11
)paren
(brace
r_int
r_char
op_star
id|bp
op_assign
id|leaf-&gt;leafdata
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  MII interface PHY %d, setup/reset &quot;
l_string|&quot;sequences %d/%d long, capabilities %2.2x %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|bp
(braket
l_int|0
)braket
comma
id|bp
(braket
l_int|1
)braket
comma
id|bp
(braket
l_int|1
op_plus
id|bp
(braket
l_int|1
)braket
op_star
l_int|2
)braket
comma
id|bp
(braket
l_int|5
op_plus
id|bp
(braket
l_int|2
op_plus
id|bp
(braket
l_int|1
)braket
op_star
l_int|2
)braket
op_star
l_int|2
)braket
comma
id|bp
(braket
l_int|4
op_plus
id|bp
(braket
l_int|2
op_plus
id|bp
(braket
l_int|1
)braket
op_star
l_int|2
)braket
op_star
l_int|2
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  Index #%d - Media %s (#%d) described &quot;
l_string|&quot;by a %s (%d) block.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|medianame
(braket
id|leaf-&gt;media
)braket
comma
id|leaf-&gt;media
comma
id|block_name
(braket
id|leaf-&gt;type
)braket
comma
id|leaf-&gt;type
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Reading a serial EEPROM is a &quot;bit&quot; grungy, but we work our way through:-&gt;.*/
multiline_comment|/*  EEPROM_Ctrl bits. */
DECL|macro|EE_SHIFT_CLK
mdefine_line|#define EE_SHIFT_CLK&t;0x02&t;/* EEPROM shift clock. */
DECL|macro|EE_CS
mdefine_line|#define EE_CS&t;&t;&t;0x01&t;/* EEPROM chip select. */
DECL|macro|EE_DATA_WRITE
mdefine_line|#define EE_DATA_WRITE&t;0x04&t;/* EEPROM chip data in. */
DECL|macro|EE_WRITE_0
mdefine_line|#define EE_WRITE_0&t;&t;0x01
DECL|macro|EE_WRITE_1
mdefine_line|#define EE_WRITE_1&t;&t;0x05
DECL|macro|EE_DATA_READ
mdefine_line|#define EE_DATA_READ&t;0x08&t;/* EEPROM chip data out. */
DECL|macro|EE_ENB
mdefine_line|#define EE_ENB&t;&t;&t;(0x4800 | EE_CS)
multiline_comment|/* Delay between EEPROM clock transitions.&n;   The 1.2 code is a &quot;nasty&quot; timing loop, but PC compatible machines are&n;   *supposed* to delay an ISA-compatible period for the SLOW_DOWN_IO macro.  */
macro_line|#ifdef _LINUX_DELAY_H
DECL|macro|eeprom_delay
mdefine_line|#define eeprom_delay(nanosec)&t;udelay((nanosec + 999)/1000)
macro_line|#else
DECL|macro|eeprom_delay
mdefine_line|#define eeprom_delay(nanosec)&t;do { int _i = 3; while (--_i &gt; 0) { __SLOW_DOWN_IO; }} while (0)
macro_line|#endif
multiline_comment|/* The EEPROM commands include the alway-set leading bit. */
DECL|macro|EE_WRITE_CMD
mdefine_line|#define EE_WRITE_CMD&t;(5 &lt;&lt; 6)
DECL|macro|EE_READ_CMD
mdefine_line|#define EE_READ_CMD&t;&t;(6 &lt;&lt; 6)
DECL|macro|EE_ERASE_CMD
mdefine_line|#define EE_ERASE_CMD&t;(7 &lt;&lt; 6)
DECL|function|read_eeprom
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|ee_addr
op_assign
id|ioaddr
op_plus
id|CSR9
suffix:semicolon
r_int
id|read_cmd
op_assign
id|location
op_or
id|EE_READ_CMD
suffix:semicolon
id|outl
c_func
(paren
id|EE_ENB
op_amp
op_complement
id|EE_CS
comma
id|ee_addr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|EE_DATA_WRITE
suffix:colon
l_int|0
suffix:semicolon
id|outl
c_func
(paren
id|EE_ENB
op_or
id|dataval
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EE_ENB
op_or
id|dataval
op_or
id|EE_SHIFT_CLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
l_int|150
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EE_ENB
op_or
id|dataval
comma
id|ee_addr
)paren
suffix:semicolon
multiline_comment|/* Finish EEPROM a clock tick. */
id|eeprom_delay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|EE_ENB
op_or
id|EE_SHIFT_CLK
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inl
c_func
(paren
id|ee_addr
)paren
op_amp
id|EE_DATA_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|EE_ENB
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
multiline_comment|/* Terminate the EEPROM access. */
id|outl
c_func
(paren
id|EE_ENB
op_amp
op_complement
id|EE_CS
comma
id|ee_addr
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Read and write the MII registers using software-generated serial&n;   MDIO protocol.  It is just different enough from the EEPROM protocol&n;   to not share code.  The maxium data clock rate is 2.5 Mhz. */
DECL|macro|MDIO_SHIFT_CLK
mdefine_line|#define MDIO_SHIFT_CLK&t;0x10000
DECL|macro|MDIO_DATA_WRITE0
mdefine_line|#define MDIO_DATA_WRITE0 0x00000
DECL|macro|MDIO_DATA_WRITE1
mdefine_line|#define MDIO_DATA_WRITE1 0x20000
DECL|macro|MDIO_ENB
mdefine_line|#define MDIO_ENB&t;&t;0x00000&t;&t;/* Ignore the 0x02000 databook setting. */
DECL|macro|MDIO_ENB_IN
mdefine_line|#define MDIO_ENB_IN&t;&t;0x40000
DECL|macro|MDIO_DATA_READ
mdefine_line|#define MDIO_DATA_READ&t;0x80000
macro_line|#ifdef _LINUX_DELAY_H
DECL|macro|mdio_delay
mdefine_line|#define mdio_delay()&t;udelay(1)
macro_line|#else
DECL|macro|mdio_delay
mdefine_line|#define mdio_delay()&t;__SLOW_DOWN_IO
macro_line|#endif
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|read_cmd
op_assign
(paren
l_int|0xf6
op_lshift
l_int|10
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|5
)paren
op_or
id|location
suffix:semicolon
r_int
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|ioaddr
op_plus
id|CSR9
suffix:semicolon
multiline_comment|/* Establish sync by sending at least 32 logic ones. */
r_for
c_loop
(paren
id|i
op_assign
l_int|32
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|MDIO_ENB
op_or
id|MDIO_DATA_WRITE1
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDIO_ENB
op_or
id|MDIO_DATA_WRITE1
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|17
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_DATA_WRITE1
suffix:colon
l_int|0
suffix:semicolon
id|outl
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|dataval
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inl
c_func
(paren
id|mdio_addr
)paren
op_amp
id|MDIO_DATA_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear out extra bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|MDIO_ENB_IN
op_or
id|MDIO_SHIFT_CLK
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|MDIO_ENB_IN
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_HW_FLOWCONTROL
multiline_comment|/* Enable receiver */
DECL|function|tulip_xon
r_void
id|tulip_xon
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|lp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|clear_bit
c_func
(paren
id|lp-&gt;fc_bit
comma
op_amp
id|netdev_fc_xoff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
id|outl
c_func
(paren
id|lp-&gt;csr6
op_or
l_int|0x2002
comma
id|dev-&gt;base_addr
op_plus
id|CSR6
)paren
suffix:semicolon
)brace
macro_line|#endif
"&f;"
r_static
r_int
DECL|function|tulip_open
id|tulip_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* On some chip revs we must set the MII/SYM port before the reset!? */
r_if
c_cond
(paren
id|tp-&gt;mtable
op_logical_and
id|tp-&gt;mtable-&gt;has_mii
)paren
id|outl
c_func
(paren
l_int|0x00040000
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Reset the chip, holding bit 0 set at least 50 PCI cycles. */
id|outl
c_func
(paren
l_int|0x00000001
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
macro_line|#ifdef _LINUX_DELAY_H
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
macro_line|#else
id|SLOW_DOWN_IO
suffix:semicolon
macro_line|#endif
multiline_comment|/* Deassert reset.&n;&t;   486: Set 8 longword cache alignment, 8 longword burst.&n;&t;   586: Set 16 longword cache alignment, no burst limit.&n;&t;   Cache alignment bits 15:14&t;     Burst length 13:8&n;&t;&t;0000&t;No alignment  0x00000000 unlimited&t;&t;0800 8 longwords&n;&t;&t;4000&t;8  longwords&t;&t;0100 1 longword&t;&t;1000 16 longwords&n;&t;&t;8000&t;16 longwords&t;&t;0200 2 longwords&t;2000 32 longwords&n;&t;&t;C000&t;32  longwords&t;&t;0400 4 longwords&n;&t;   Wait the specified 50 PCI cycles after a reset by initializing&n;&t;   Tx and Rx queues and the address filter list. */
macro_line|#if defined(__alpha__)
multiline_comment|/* ToDo: Alpha setting could be better. */
id|outl
c_func
(paren
l_int|0x00200000
op_or
l_int|0xE000
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
macro_line|#elif defined(__powerpc__)
id|outl
c_func
(paren
l_int|0x00200080
op_or
l_int|0x8000
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
macro_line|#elif defined(__i386__)
macro_line|#if defined(MODULE)
multiline_comment|/* When a module we don&squot;t have &squot;x86&squot; to check. */
id|outl
c_func
(paren
l_int|0x00200000
op_or
l_int|0x4800
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
macro_line|#else
macro_line|#ifndef ORIGINAL_TEXT
mdefine_line|#define x86 (boot_cpu_data.x86)
macro_line|#endif
id|outl
c_func
(paren
l_int|0x00200000
op_or
(paren
id|x86
op_le
l_int|4
ques
c_cond
l_int|0x4800
suffix:colon
l_int|0x8000
)paren
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x86
op_le
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: This is a 386/486 PCI system, setting cache &quot;
l_string|&quot;alignment to %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_int|0x00200000
op_or
(paren
id|x86
op_le
l_int|4
ques
c_cond
l_int|0x4800
suffix:colon
l_int|0x8000
)paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#else
id|outl
c_func
(paren
l_int|0x00200000
op_or
l_int|0x4800
comma
id|ioaddr
op_plus
id|CSR0
)paren
suffix:semicolon
macro_line|#warning Processor architecture undefined!
macro_line|#endif
macro_line|#ifdef SA_SHIRQ
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|tulip_interrupt
comma
id|SA_SHIRQ
comma
id|tulip_tbl
(braket
id|tp-&gt;chip_id
)braket
dot
id|chip_name
comma
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_ne
l_int|NULL
op_logical_or
(paren
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
id|dev
)paren
op_eq
l_int|NULL
op_logical_or
id|dev-&gt;irq
op_eq
l_int|0
op_logical_or
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|tulip_interrupt
comma
l_int|0
comma
id|tulip_tbl
(braket
id|tp-&gt;chip_id
)braket
dot
id|chip_name
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tulip_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|tulip_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* This is set_rx_mode(), but without starting the transmitter. */
multiline_comment|/* Fill the whole address filter table with our physical address. */
(brace
id|u16
op_star
id|eaddrs
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|u32
op_star
id|setup_frm
op_assign
id|tp-&gt;setup_frame
comma
id|i
suffix:semicolon
multiline_comment|/* You must add the broadcast address when doing perfect filtering! */
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* Fill the rest of the accept table with our physical address. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|2
)braket
suffix:semicolon
)brace
multiline_comment|/* Put the setup frame on the Tx list. */
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|length
op_assign
l_int|0x08000000
op_or
l_int|192
suffix:semicolon
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|tp-&gt;setup_frame
)paren
suffix:semicolon
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|tp-&gt;cur_tx
op_increment
suffix:semicolon
)brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;rx_ring
)paren
comma
id|ioaddr
op_plus
id|CSR3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|tp-&gt;tx_ring
)paren
comma
id|ioaddr
op_plus
id|CSR4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
id|dev-&gt;if_port
op_assign
id|tp-&gt;default_port
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21041
op_logical_and
id|dev-&gt;if_port
OG
l_int|4
)paren
multiline_comment|/* Invalid: Select initial TP, autosense, autonegotiate.  */
id|dev-&gt;if_port
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Allow selecting a default media. */
r_if
c_cond
(paren
id|tp-&gt;mtable
op_eq
l_int|NULL
)paren
r_goto
id|media_picked
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;mtable-&gt;leafcount
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|tp-&gt;mtable-&gt;mleaf
(braket
id|i
)braket
dot
id|media
op_eq
(paren
id|dev-&gt;if_port
op_eq
l_int|12
ques
c_cond
l_int|0
suffix:colon
id|dev-&gt;if_port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Using user-specified media %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
r_goto
id|media_picked
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tp-&gt;mtable-&gt;defaultmedia
op_amp
l_int|0x0800
)paren
op_eq
l_int|0
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;mtable-&gt;leafcount
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|tp-&gt;mtable-&gt;mleaf
(braket
id|i
)braket
dot
id|media
op_eq
(paren
id|tp-&gt;mtable-&gt;defaultmedia
op_amp
l_int|15
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Using EEPROM-set media %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|tp-&gt;mtable-&gt;mleaf
(braket
id|i
)braket
dot
id|media
)braket
)paren
suffix:semicolon
r_goto
id|media_picked
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|tp-&gt;mtable-&gt;leafcount
op_minus
l_int|1
suffix:semicolon
(paren
id|media_fd
(braket
id|tp-&gt;mtable-&gt;mleaf
(braket
id|i
)braket
dot
id|media
)braket
op_amp
l_int|2
)paren
op_logical_and
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
suffix:semicolon
id|media_picked
suffix:colon
id|tp-&gt;cur_index
op_assign
id|i
suffix:semicolon
id|tp-&gt;csr6
op_assign
l_int|0
suffix:semicolon
id|select_media
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Start the chip&squot;s Tx to process setup frame. */
id|outl
c_func
(paren
id|tp-&gt;csr6
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2000
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|outl
c_func
(paren
l_int|0x0001ebef
comma
id|ioaddr
op_plus
id|CSR7
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR2
)paren
suffix:semicolon
multiline_comment|/* Rx poll demand */
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done tulip_open(), CSR0 %8.8x, CSR5 %8.8x CSR13 %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR0
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the timer to switch to check for link beat and perhaps switch&n;&t;   to an alternate media type. */
id|init_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|tp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 2.4 sec. */
id|tp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tp-&gt;timer.function
op_assign
op_amp
id|tulip_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_HW_FLOWCONTROL
id|tp-&gt;fc_bit
op_assign
id|netdev_register_fc
c_func
(paren
id|dev
comma
id|tulip_xon
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|dev-&gt;tx_semaphore
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set up the transceiver control registers for the selected media type. */
DECL|function|select_media
r_static
r_void
id|select_media
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|startup
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|mediatable
op_star
id|mtable
op_assign
id|tp-&gt;mtable
suffix:semicolon
id|u32
id|new_csr6
suffix:semicolon
r_int
id|check_mii
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|mtable
)paren
(brace
r_struct
id|medialeaf
op_star
id|mleaf
op_assign
op_amp
id|mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
id|mleaf-&gt;leafdata
suffix:semicolon
r_switch
c_cond
(paren
id|mleaf-&gt;type
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* 21140 non-MII xcvr. */
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Using a 21140 non-MII transceiver with control&quot;
l_string|&quot; setting %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|startup
)paren
id|outl
c_func
(paren
id|mtable-&gt;csr12dir
op_or
l_int|0x100
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|outl
c_func
(paren
id|p
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|new_csr6
op_assign
l_int|0x02000000
op_or
(paren
(paren
id|p
(braket
l_int|2
)braket
op_amp
l_int|0x71
)paren
op_lshift
l_int|18
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|startup
)paren
(brace
id|outl
c_func
(paren
id|mtable-&gt;csr12dir
op_or
l_int|0x100
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Doing a reset sequence of length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p
(braket
l_int|2
op_plus
id|p
(braket
l_int|1
)braket
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|p
(braket
l_int|2
op_plus
id|p
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|i
op_increment
)paren
id|outl
c_func
(paren
id|p
(braket
l_int|3
op_plus
id|p
(braket
l_int|1
)braket
op_plus
id|i
)braket
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s  Doing a transceiver setup sequence of length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|i
op_increment
)paren
id|outl
c_func
(paren
id|p
(braket
l_int|2
op_plus
id|i
)braket
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
)brace
id|check_mii
op_assign
l_int|1
suffix:semicolon
id|new_csr6
op_assign
l_int|0x020C0000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
(brace
id|u16
op_star
id|setup
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|p
(braket
l_int|0
)braket
op_amp
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: 21142 non-MII %s transceiver control %4.4x/%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
comma
id|setup
(braket
l_int|0
)braket
comma
id|setup
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* SIA (CSR13-15) setup values are provided. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|outl
c_func
(paren
id|setup
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|CSR14
)paren
suffix:semicolon
id|outl
c_func
(paren
id|setup
(braket
l_int|2
)braket
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
id|outl
c_func
(paren
id|setup
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|setup
op_add_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21142_csr14
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR14
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21142_csr15
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21142_csr13
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|setup
(braket
l_int|0
)braket
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
multiline_comment|/* Direction */
id|outl
c_func
(paren
id|setup
(braket
l_int|1
)braket
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
multiline_comment|/* Data */
r_if
c_cond
(paren
id|mleaf-&gt;type
op_eq
l_int|4
)paren
id|new_csr6
op_assign
l_int|0x02000000
op_or
(paren
(paren
id|setup
(braket
l_int|2
)braket
op_amp
l_int|0x71
)paren
op_lshift
l_int|18
)paren
suffix:semicolon
r_else
id|new_csr6
op_assign
l_int|0x82420000
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|3
suffix:colon
(brace
r_int
id|init_length
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|u16
op_star
id|init_sequence
op_assign
(paren
id|u16
op_star
)paren
(paren
id|p
op_plus
l_int|2
)paren
suffix:semicolon
r_int
id|reset_length
op_assign
id|p
(braket
l_int|2
op_plus
id|init_length
op_star
l_int|2
)braket
suffix:semicolon
id|u16
op_star
id|reset_sequence
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|p
(braket
l_int|3
op_plus
id|init_length
op_star
l_int|2
)braket
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|startup
)paren
(brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:  Doing a 21142 reset sequence of length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|reset_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|reset_length
suffix:semicolon
id|i
op_increment
)paren
id|outl
c_func
(paren
id|reset_sequence
(braket
id|i
)braket
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Doing a 21142 xcvr setup sequence of length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|init_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|init_length
suffix:semicolon
id|i
op_increment
)paren
id|outl
c_func
(paren
id|init_sequence
(braket
id|i
)braket
op_lshift
l_int|16
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
id|check_mii
op_assign
l_int|1
suffix:semicolon
id|new_csr6
op_assign
l_int|0x020C0000
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|new_csr6
op_assign
l_int|0x020C0000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Using media type %s, CSR12 is %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21140
)paren
(brace
multiline_comment|/* Set media type to MII @ 100mbps: 0x020C0000 */
id|new_csr6
op_assign
l_int|0x020C0000
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Unknown media control, assuming MII, CSR12 %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21041
)paren
(brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: 21041 using media %s, CSR12 is %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
op_amp
l_int|15
)braket
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
multiline_comment|/* Reset the serial interface */
id|outl
c_func
(paren
id|t21041_csr14
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR14
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21041_csr15
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21041_csr13
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|new_csr6
op_assign
l_int|0x80020000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|LC82C168
)paren
(brace
r_if
c_cond
(paren
id|startup
)paren
id|dev-&gt;if_port
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LiteOn PHY status is %3.3x, CSR12 %4.4x,&quot;
l_string|&quot; media %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0xB8
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|3
op_logical_or
id|dev-&gt;if_port
op_eq
l_int|5
)paren
(brace
id|outl
c_func
(paren
l_int|0x33
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|new_csr6
op_assign
l_int|0x01860000
suffix:semicolon
r_if
c_cond
(paren
id|startup
)paren
id|outl
c_func
(paren
l_int|0x0201F868
comma
id|ioaddr
op_plus
l_int|0xB8
)paren
suffix:semicolon
multiline_comment|/* Trigger autonegotiation. */
r_else
id|outl
c_func
(paren
l_int|0x1F868
comma
id|ioaddr
op_plus
l_int|0xB8
)paren
suffix:semicolon
)brace
r_else
(brace
id|outl
c_func
(paren
l_int|0x32
comma
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|new_csr6
op_assign
l_int|0x00420000
suffix:semicolon
id|outl
c_func
(paren
l_int|0x1F078
comma
id|ioaddr
op_plus
l_int|0xB8
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 21040 */
multiline_comment|/* Turn on the xcvr interface. */
r_int
id|csr12
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: 21040 media type is %s, CSR12 is %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;AUI&quot;
suffix:colon
l_string|&quot;10baseT&quot;
comma
id|csr12
)paren
suffix:semicolon
id|new_csr6
op_assign
(paren
id|dev-&gt;if_port
ques
c_cond
l_int|0x01860000
suffix:colon
l_int|0x00420000
)paren
suffix:semicolon
multiline_comment|/* Set the full duplux match frame. */
id|outl
c_func
(paren
id|FULL_DUPLEX_MAGIC
comma
id|ioaddr
op_plus
id|CSR11
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
multiline_comment|/* Reset the serial interface */
id|outl
c_func
(paren
id|dev-&gt;if_port
ques
c_cond
l_int|0x0000000C
suffix:colon
l_int|0x00000004
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
)brace
id|tp-&gt;csr6
op_assign
id|new_csr6
op_or
(paren
id|tp-&gt;csr6
op_amp
l_int|0xfdff
)paren
op_or
(paren
id|tp-&gt;full_duplex
ques
c_cond
l_int|0x0200
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|tulip_timer
r_static
r_void
id|tulip_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|csr12
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection tick, status %8.8x mode %8.8x &quot;
l_string|&quot;SIA %8.8x %8.8x %8.8x %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
comma
id|csr12
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR14
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR15
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|tp-&gt;chip_id
)paren
(brace
r_case
id|DC21040
suffix:colon
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0002
)paren
(brace
multiline_comment|/* Network error */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No 10baseT link beat found, switching to %s media.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;10baseT&quot;
suffix:colon
l_string|&quot;AUI&quot;
)paren
suffix:semicolon
id|dev-&gt;if_port
op_xor_assign
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|dev-&gt;if_port
ques
c_cond
l_int|0x0000000C
suffix:colon
l_int|0x00000004
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DC21041
suffix:colon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: 21041 media tick  CSR12 %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;if_port
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0004
)paren
(brace
multiline_comment|/*LnkFail */
multiline_comment|/* 10baseT is dead.  Check for activity on alternate port. */
id|tp-&gt;mediasense
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0200
)paren
id|dev-&gt;if_port
op_assign
l_int|2
suffix:semicolon
r_else
id|dev-&gt;if_port
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No 21041 10baseT link beat, Media switched to %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
multiline_comment|/* Reset */
id|outl
c_func
(paren
id|t21041_csr14
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR14
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21041_csr15
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR15
)paren
suffix:semicolon
id|outl
c_func
(paren
id|t21041_csr13
(braket
id|dev-&gt;if_port
)braket
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|next_tick
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
multiline_comment|/* 2.4 sec. */
)brace
r_else
id|next_tick
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* 10base2 */
r_case
l_int|2
suffix:colon
multiline_comment|/* AUI */
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0100
)paren
(brace
id|next_tick
op_assign
(paren
l_int|30
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* 30 sec. */
id|tp-&gt;mediasense
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|csr12
op_amp
l_int|0x0004
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 21041 media switched to 10baseT.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
id|select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 2.4 sec. */
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;mediasense
op_logical_or
(paren
id|csr12
op_amp
l_int|0x0002
)paren
)paren
(brace
id|dev-&gt;if_port
op_assign
l_int|3
op_minus
id|dev-&gt;if_port
suffix:semicolon
multiline_comment|/* Swap ports. */
id|select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|next_tick
op_assign
l_int|20
op_star
id|HZ
suffix:semicolon
)brace
r_else
(brace
id|next_tick
op_assign
l_int|20
op_star
id|HZ
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LC82C168
suffix:colon
(brace
r_int
id|phy_reg
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0xB8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LC82C168 phy status %8.8x, CSR5 %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_reg
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_amp
l_int|0x04000000
)paren
(brace
multiline_comment|/* Remote link fault */
id|outl
c_func
(paren
l_int|0x0201F078
comma
id|ioaddr
op_plus
l_int|0xB8
)paren
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
)brace
r_else
id|next_tick
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
op_amp
id|TPLnkFail
)paren
(brace
multiline_comment|/* 100baseTx link beat */
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s link beat failed, CSR12 %4.4x, &quot;
l_string|&quot;CSR5 %8.8x, PHY %3.3x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|dev-&gt;if_port
)braket
comma
id|csr12
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0xB8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
(brace
id|dev-&gt;if_port
op_assign
l_int|3
suffix:semicolon
)brace
r_else
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
id|select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|DC21140
suffix:colon
r_case
id|DC21142
suffix:colon
(brace
r_struct
id|medialeaf
op_star
id|mleaf
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;mtable
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No EEPROM info, use generic code. */
multiline_comment|/* Assume this is like a SMC card, and check its link beat bit. */
r_if
c_cond
(paren
(paren
id|dev-&gt;if_port
op_eq
l_int|0
op_logical_and
(paren
id|csr12
op_amp
l_int|0x0080
)paren
)paren
op_logical_or
(paren
id|dev-&gt;if_port
op_eq
l_int|1
op_logical_and
(paren
id|csr12
op_amp
l_int|0x0040
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|dev-&gt;if_port
op_xor_assign
l_int|1
suffix:semicolon
multiline_comment|/* Stop the transmit process. */
id|tp-&gt;csr6
op_assign
(paren
id|dev-&gt;if_port
ques
c_cond
l_int|0x03860000
suffix:colon
l_int|0x02420000
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link beat timed out, CSR12 is 0x%2.2x, switching to&quot;
l_string|&quot; %s media.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
op_amp
l_int|0xff
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;100baseTx&quot;
suffix:colon
l_string|&quot;10baseT&quot;
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0xA002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
)brace
r_else
(brace
id|next_tick
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: network media monitor 0x%2.2x, link&quot;
l_string|&quot; beat detected as %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
op_amp
l_int|0xff
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;100baseTx&quot;
suffix:colon
l_string|&quot;10baseT&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|mleaf
op_assign
op_amp
id|tp-&gt;mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
suffix:semicolon
id|p
op_assign
id|mleaf-&gt;leafdata
suffix:semicolon
r_switch
c_cond
(paren
id|mleaf-&gt;type
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|4
suffix:colon
(brace
multiline_comment|/* Type 0 non-MII or #4 SYM transceiver.  Check the link beat bit. */
id|s8
id|bitnum
op_assign
id|p
(braket
id|mleaf-&gt;type
op_eq
l_int|4
ques
c_cond
l_int|5
suffix:colon
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transceiver monitor tick: CSR12=%#2.2x bit %d is&quot;
l_string|&quot; %d, expecting %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
comma
(paren
id|bitnum
op_rshift
l_int|1
)paren
op_amp
l_int|7
comma
(paren
id|csr12
op_amp
(paren
l_int|1
op_lshift
(paren
(paren
id|bitnum
op_rshift
l_int|1
)paren
op_amp
l_int|7
)paren
)paren
)paren
op_ne
l_int|0
comma
(paren
id|bitnum
op_ge
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Check that the specified bit has the proper value. */
r_if
c_cond
(paren
(paren
id|bitnum
OL
l_int|0
)paren
op_ne
(paren
(paren
id|csr12
op_amp
(paren
l_int|1
op_lshift
(paren
(paren
id|bitnum
op_rshift
l_int|1
)paren
op_amp
l_int|7
)paren
)paren
)paren
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Link beat detected for %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|mleaf-&gt;media
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;medialock
)paren
r_break
suffix:semicolon
id|select_next_media
suffix:colon
r_if
c_cond
(paren
op_decrement
id|tp-&gt;cur_index
OL
l_int|0
)paren
(brace
multiline_comment|/* We start again, but should instead look for default. */
id|tp-&gt;cur_index
op_assign
id|tp-&gt;mtable-&gt;leafcount
op_minus
l_int|1
suffix:semicolon
)brace
id|dev-&gt;if_port
op_assign
id|tp-&gt;mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
dot
id|media
suffix:semicolon
r_if
c_cond
(paren
id|media_fd
(braket
id|dev-&gt;if_port
)braket
)paren
r_goto
id|select_next_media
suffix:semicolon
multiline_comment|/* Skip FD entries. */
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: No link beat on media %s,&quot;
l_string|&quot; trying transceiver type %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|medianame
(braket
id|mleaf-&gt;media
op_amp
l_int|15
)braket
comma
id|medianame
(braket
id|tp-&gt;mtable-&gt;mleaf
(braket
id|tp-&gt;cur_index
)braket
dot
id|media
)braket
)paren
suffix:semicolon
id|select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Restart the transmit process. */
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|next_tick
op_assign
(paren
l_int|24
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|1
suffix:colon
r_case
l_int|3
suffix:colon
multiline_comment|/* 21140, 21142 MII */
(brace
r_int
id|mii_reg1
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
r_int
id|mii_reg5
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII monitoring tick: CSR12 %2.2x, &quot;
l_string|&quot;MII status %4.4x, Link partner report %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr12
comma
id|mii_reg1
comma
id|mii_reg5
)paren
suffix:semicolon
macro_line|#ifdef notdef
r_if
c_cond
(paren
id|mii_reg1
op_ne
l_int|0xffff
op_logical_and
(paren
id|mii_reg1
op_amp
l_int|0x0004
)paren
op_eq
l_int|0
)paren
r_goto
id|select_next_media
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|mii_reg1
op_ne
l_int|0xffff
op_logical_and
(paren
id|mii_reg1
op_amp
l_int|0x0004
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No link beat on the MII interface, &quot;
l_string|&quot;status then %4.4x now %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mii_reg1
comma
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mii_reg5
op_eq
l_int|0xffff
op_logical_or
id|mii_reg5
op_eq
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* No MII device or no link partner report */
r_else
r_if
c_cond
(paren
id|tp-&gt;full_duplex_lock
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|mii_reg5
op_amp
l_int|0x0100
)paren
op_ne
l_int|0
op_logical_or
(paren
id|mii_reg5
op_amp
l_int|0x00C0
)paren
op_eq
l_int|0x0040
)paren
(brace
multiline_comment|/* 100baseTx-FD  or  10T-FD, but not 100-HD */
r_if
c_cond
(paren
id|tp-&gt;full_duplex
op_eq
l_int|0
)paren
(brace
id|tp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;csr6
op_or_assign
l_int|0x0200
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|0
)paren
multiline_comment|/* Gurppp, should be &gt;1 */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s-duplex based on MII&quot;
l_string|&quot; Xcvr #%d parter capability of %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|tp-&gt;phys
(braket
l_int|0
)braket
comma
id|mii_reg5
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 21142 serial block has no link beat. */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Invalid chip type. */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|next_tick
)paren
(brace
id|tp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|next_tick
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|tulip_tx_timeout
r_static
r_void
id|tulip_tx_timeout
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;mtable
op_logical_and
id|tp-&gt;mtable-&gt;has_mii
)paren
(brace
multiline_comment|/* Do nothing -- the media monitor should handle this. */
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timeout using MII device.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21040
)paren
(brace
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
op_amp
l_int|0x0002
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: transmit timed out, switching to %s media.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;10baseT&quot;
suffix:colon
l_string|&quot;AUI&quot;
)paren
suffix:semicolon
id|dev-&gt;if_port
op_xor_assign
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|dev-&gt;if_port
ques
c_cond
l_int|0x0000000C
suffix:colon
l_int|0x00000004
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21140
op_logical_or
id|tp-&gt;chip_id
op_eq
id|DC21142
)paren
(brace
multiline_comment|/* Stop the transmit process. */
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|dev-&gt;if_port
op_xor_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: 21140 transmit timed out, status %8.8x, &quot;
l_string|&quot;SIA %8.8x %8.8x %8.8x %8.8x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR14
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR15
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, switching to %s media.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;if_port
ques
c_cond
l_string|&quot;100baseTx&quot;
suffix:colon
l_string|&quot;10baseT&quot;
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|tp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21041
)paren
(brace
id|u32
id|csr12
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: 21041 transmit timed out, status %8.8x, CSR12 %8.8x,&quot;
l_string|&quot; CSR13 %8.8x, CSR14 %8.8x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|csr12
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR13
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR14
)paren
)paren
suffix:semicolon
id|tp-&gt;mediasense
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|1
op_logical_or
id|dev-&gt;if_port
op_eq
l_int|2
)paren
r_if
c_cond
(paren
id|csr12
op_amp
l_int|0x0004
)paren
(brace
id|dev-&gt;if_port
op_assign
l_int|2
op_minus
id|dev-&gt;if_port
suffix:semicolon
)brace
r_else
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
r_else
id|dev-&gt;if_port
op_assign
l_int|1
suffix:semicolon
id|select_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|tp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, status %8.8x, CSR12 %8.8x,&quot;
l_string|&quot; resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR12
)paren
)paren
suffix:semicolon
macro_line|#ifdef way_too_many_messages
id|printk
c_func
(paren
l_string|&quot;  Rx ring %8.8x: &quot;
comma
(paren
r_int
)paren
id|tp-&gt;rx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
(paren
r_int
r_int
)paren
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n  Tx ring %8.8x: &quot;
comma
(paren
r_int
)paren
id|tp-&gt;tx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
(paren
r_int
r_int
)paren
id|tp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Perhaps we should reinitialize the hardware here. */
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop and restart the chip&squot;s Tx processes . */
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
id|tp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Trigger an immediate transmit demand. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|tp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
r_static
r_void
DECL|function|tulip_init_ring
id|tulip_init_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
id|tp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;dirty_rx
op_assign
id|tp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* Owned by Tulip chip */
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|length
op_assign
id|PKT_BUF_SZ
suffix:semicolon
(brace
multiline_comment|/* Note the receive buffer must be longword aligned.&n;&t;&t;&t;   dev_alloc_skb() provides 16 byte alignment.  But do *not*&n;&t;&t;&t;   use skb_reserve() to align the IP header! */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|DEV_ALLOC_SKB
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|tp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Bad news!  */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
macro_line|#if LINUX_VERSION_CODE &gt; 0x10300
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
macro_line|#else
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
)brace
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buffer2
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;rx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark the last entry as wrapping the ring. */
id|tp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|length
op_assign
id|PKT_BUF_SZ
op_or
l_int|0x02000000
suffix:semicolon
id|tp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|buffer2
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;rx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* The Tx buffer descriptor is filled in as needed, but we&n;&t;   do need to clear the ownership bit. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0x00000000
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buffer2
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;tx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|tp-&gt;tx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|buffer2
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|tp-&gt;tx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tulip_start_xmit
id|tulip_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|u32
id|flag
suffix:semicolon
macro_line|#ifdef ORIGINAL_TEXT
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
op_logical_or
id|skb-&gt;len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Obsolete driver layer request made: skbuff==NULL.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_tint
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xchg
c_func
(paren
op_amp
id|dev-&gt;tx_semaphore
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* With new queueing algorithm returning 1 when dev-&gt;tbusy == 0&n;&t;&t;   should not result in lockups, but I am still not sure. --ANK&n;&t;&t; */
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Please check: are you still alive?&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Block a timer-based transmit from overlapping.  This could better be&n;&t;   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
op_ge
id|TX_TIMEOUT
)paren
id|tulip_tx_timeout
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|dev-&gt;tx_semaphore
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Caution: the write order is important here, set the base address&n;&t;   with the &quot;ownership&quot; bits last. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|tp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|tp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
OL
id|TX_RING_SIZE
op_div
l_int|2
)paren
(brace
multiline_comment|/* Typical path */
id|flag
op_assign
l_int|0x60000000
suffix:semicolon
multiline_comment|/* No interrupt */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
op_eq
id|TX_RING_SIZE
op_div
l_int|2
)paren
(brace
id|flag
op_assign
l_int|0xe0000000
suffix:semicolon
multiline_comment|/* Tx-done intr. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
OL
id|TX_RING_SIZE
op_minus
l_int|2
)paren
(brace
id|flag
op_assign
l_int|0x60000000
suffix:semicolon
multiline_comment|/* No Tx-done intr. */
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Leave room for set_rx_mode() to fill entries. */
id|flag
op_assign
l_int|0xe0000000
suffix:semicolon
multiline_comment|/* Tx-done intr. */
id|tp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry
op_eq
id|TX_RING_SIZE
op_minus
l_int|1
)paren
id|flag
op_or_assign
l_int|0xe2000000
suffix:semicolon
id|tp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
id|skb-&gt;len
op_or
id|flag
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* Pass ownership to the chip. */
id|tp-&gt;cur_tx
op_increment
suffix:semicolon
multiline_comment|/* Trigger an immediate transmit demand. */
id|outl
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|CSR1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|dev-&gt;tx_semaphore
op_assign
l_int|1
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|IRQ
r_static
r_void
id|tulip_interrupt
id|IRQ
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
macro_line|#ifdef SA_SHIRQ&t;&t;/* Use the now-standard shared IRQ implementation. */
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_instance
suffix:semicolon
macro_line|#else
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
(paren
id|irq2dev_map
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#endif
r_struct
id|tulip_private
op_star
id|lp
suffix:semicolon
r_int
id|csr5
comma
id|ioaddr
comma
id|boguscnt
op_assign
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot; tulip_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;interrupt
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Re-entering the interrupt handler.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
r_do
(brace
id|csr5
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
id|outl
c_func
(paren
id|csr5
op_amp
l_int|0x0001ffff
comma
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt  csr5=%#8.8x new csr5=%#8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr5
comma
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|csr5
op_amp
l_int|0x00018000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|csr5
op_amp
id|RxIntr
)paren
id|tulip_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr5
op_amp
(paren
id|TxNoBuf
op_or
id|TxDied
op_or
id|TxIntr
)paren
)paren
(brace
r_int
id|dirty_tx
suffix:semicolon
r_for
c_loop
(paren
id|dirty_tx
op_assign
id|lp-&gt;dirty_tx
suffix:semicolon
id|dirty_tx
OL
id|lp-&gt;cur_tx
suffix:semicolon
id|dirty_tx
op_increment
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_int
id|status
op_assign
id|lp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
multiline_comment|/* Check for Rx filter setup frames. */
r_if
c_cond
(paren
id|lp-&gt;tx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* There was an major error, log it. */
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit error, Tx status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x4104
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0C00
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0200
)paren
id|lp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0002
)paren
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x0080
)paren
op_logical_and
id|lp-&gt;full_duplex
op_eq
l_int|0
)paren
id|lp-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0100
)paren
id|lp-&gt;stats.collisions16
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0001
)paren
id|lp-&gt;stats.tx_deferred
op_increment
suffix:semicolon
macro_line|#endif
id|lp-&gt;stats.collisions
op_add_assign
(paren
id|status
op_rshift
l_int|3
)paren
op_amp
l_int|15
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|lp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|lp-&gt;cur_tx
op_minus
id|dirty_tx
OG
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Out-of-sync dirty pointer, %d vs. %d, full=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dirty_tx
comma
id|lp-&gt;cur_tx
comma
id|lp-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
id|dirty_tx
OG
id|lp-&gt;cur_tx
op_minus
id|TX_RING_SIZE
op_plus
l_int|2
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|lp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
id|lp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
)brace
multiline_comment|/* Log errors. */
r_if
c_cond
(paren
id|csr5
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* Abnormal error summary bit. */
r_if
c_cond
(paren
id|csr5
op_amp
id|TxJabber
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|csr5
op_amp
id|TxFIFOUnderflow
)paren
(brace
id|lp-&gt;csr6
op_or_assign
l_int|0x00200000
suffix:semicolon
multiline_comment|/* Reconfigure to store-n-forward. */
multiline_comment|/* Restart the transmit process. */
id|outl
c_func
(paren
id|lp-&gt;csr6
op_or
l_int|0x0002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|outl
c_func
(paren
id|lp-&gt;csr6
op_or
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr5
op_amp
id|RxDied
)paren
(brace
multiline_comment|/* Missed a Rx frame. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csr5
op_amp
id|TimerInt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Something Wicked happened! %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr5
)paren
suffix:semicolon
multiline_comment|/* Hmmmmm, it&squot;s not clear what to do here. */
)brace
multiline_comment|/* Clear all error sources, included undocumented ones! */
id|outl
c_func
(paren
l_int|0x000f7ba
comma
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, csr5=0x%8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|csr5
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupt sources. */
id|outl
c_func
(paren
l_int|0x0001ffff
comma
id|ioaddr
op_plus
id|CSR5
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, csr5=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
multiline_comment|/* Code that should never be run!  Perhaps remove after testing.. */
(brace
r_static
r_int
id|stopit
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
op_eq
l_int|0
op_logical_and
op_decrement
id|stopit
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Emergency stop, looping startup interrupt.&bslash;n&quot;
id|KERN_ERR
l_string|&quot;%s: Disabling interrupt handler %d to avoid &quot;
l_string|&quot;locking up the machine.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
macro_line|#ifdef SA_SHIRQ
id|free_irq
c_func
(paren
id|irq
comma
id|dev
)paren
suffix:semicolon
macro_line|#else
id|free_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_FASTROUTE
multiline_comment|/* DMAing cards are the most easy in this respect,&n;   they are able to make fast route to any device.&n;&n;   Now we allow to make it only to another ethernet card.&n; */
DECL|function|tulip_accept_fastpath
r_static
r_int
id|tulip_accept_fastpath
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|dst_entry
op_star
id|dst
)paren
(brace
r_struct
id|device
op_star
id|odev
op_assign
id|dst-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;ops-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|odev-&gt;type
op_ne
id|ARPHRD_ETHER
op_logical_or
id|odev-&gt;accept_fastpath
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   Return values:&n;&n;   0 - packet has gone by fast path.&n;   1 - fast path is OK, but device deferred xmit. (semifast path)&n;&n;   2 - fast path is hit, but packet is a bit strange. (NI)&n;   3 - oom&n;&n;   4 - fast path miss.&n; */
DECL|function|tulip_fast_forward
r_static
r_int
id|tulip_fast_forward
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|entry
comma
r_int
id|len
)paren
(brace
r_struct
id|tulip_private
op_star
id|lp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|lp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
id|h
suffix:semicolon
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|ETH_HLEN
)paren
suffix:semicolon
id|h
op_assign
(paren
op_star
(paren
id|u8
op_star
)paren
op_amp
id|iph-&gt;daddr
op_xor
op_star
(paren
id|u8
op_star
)paren
op_amp
id|iph-&gt;saddr
)paren
op_amp
id|NETDEV_FASTROUTE_HMASK
suffix:semicolon
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
(paren
id|dev-&gt;fastpath
(braket
id|h
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
op_logical_and
(paren
(paren
id|u16
op_star
)paren
op_amp
id|iph-&gt;daddr
)paren
(braket
l_int|0
)braket
op_eq
(paren
(paren
id|u16
op_star
)paren
op_amp
id|rt-&gt;key.dst
)paren
(braket
l_int|0
)braket
op_logical_and
(paren
(paren
id|u16
op_star
)paren
op_amp
id|iph-&gt;daddr
)paren
(braket
l_int|1
)braket
op_eq
(paren
(paren
id|u16
op_star
)paren
op_amp
id|rt-&gt;key.dst
)paren
(braket
l_int|1
)braket
op_logical_and
(paren
(paren
id|u16
op_star
)paren
op_amp
id|iph-&gt;saddr
)paren
(braket
l_int|0
)braket
op_eq
(paren
(paren
id|u16
op_star
)paren
op_amp
id|rt-&gt;key.src
)paren
(braket
l_int|0
)braket
op_logical_and
(paren
(paren
id|u16
op_star
)paren
op_amp
id|iph-&gt;saddr
)paren
(braket
l_int|1
)braket
op_eq
(paren
(paren
id|u16
op_star
)paren
op_amp
id|rt-&gt;key.src
)paren
(braket
l_int|1
)braket
op_logical_and
id|rt-&gt;u.dst.obsolete
op_eq
l_int|0
)paren
(brace
r_struct
id|device
op_star
id|odev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|dev_fastroute_stat.hits
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|u8
op_star
)paren
id|iph
op_ne
l_int|0x45
op_logical_or
(paren
id|eth-&gt;h_dest
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
op_logical_or
op_logical_neg
id|neigh_is_valid
c_func
(paren
id|rt-&gt;u.dst.neighbour
)paren
op_logical_or
id|iph-&gt;ttl
op_le
l_int|1
)paren
r_goto
id|alas2
suffix:semicolon
id|ip_decrease_ttl
c_func
(paren
id|iph
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|DEV_ALLOC_SKB
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
r_goto
id|oom
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|skb2-&gt;tail
)paren
suffix:semicolon
id|skb2-&gt;dev
op_assign
id|dev
suffix:semicolon
id|lp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb2
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|ip_statistics.IpInReceives
op_increment
suffix:semicolon
id|ip_statistics.IpForwDatagrams
op_increment
suffix:semicolon
multiline_comment|/* Could use hh cache */
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|odev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|rt-&gt;u.dst.neighbour-&gt;ha
comma
l_int|6
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|odev
suffix:semicolon
macro_line|#ifdef FAST_SKB_RECYCLE /* DO NOT DEFINE IT! READ COMMENT */
multiline_comment|/* We could use fast buffer recycling here if odev&n;&t;&t;&t;   is not DMAing.&n;&n;&t;&t;&t;   The only problem is that we must allocate skb2&n;&t;&t;&t;   BEFORE we lose skb, otherwise we would make hole in&n;&t;&t;&t;   tulip rx array. Hence, to implement FAST_SKB_RECYCLE&n;&t;&t;&t;   we need always keep at least one skb in a safe place.&n;&t;&t;&t; */
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|odev-&gt;tx_semaphore
op_logical_and
id|odev-&gt;tbusy
op_eq
l_int|0
op_logical_and
id|odev-&gt;interrupt
op_eq
l_int|0
op_logical_and
id|odev
op_member_access_from_pointer
id|hard_start_xmit
c_func
(paren
id|skb
comma
id|odev
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef FAST_SKB_RECYCLE
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|skb-&gt;users
)paren
op_eq
l_int|1
)paren
(brace
id|skb-&gt;tail
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;len
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|dev_fastroute_stat.succeed
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef FAST_SKB_RECYCLE
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Otherwise... */
id|skb-&gt;pkt_type
op_assign
id|PACKET_FASTROUTE
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|dev_fastroute_stat.deferred
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|4
suffix:semicolon
id|oom
suffix:colon
r_return
l_int|3
suffix:semicolon
id|alas2
suffix:colon
macro_line|#ifdef not_yet
id|skb-&gt;dst
op_assign
id|dst_clone
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
macro_line|#else
r_return
l_int|4
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
r_static
r_int
DECL|function|tulip_rx
id|tulip_rx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|lp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|lp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; In tulip_rx(), entry %d %8.8x.&bslash;n&quot;
comma
id|entry
comma
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
)paren
suffix:semicolon
multiline_comment|/* If we own the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_ge
l_int|0
)paren
(brace
r_int
id|status
op_assign
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x0300
)paren
op_ne
l_int|0x0300
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xffff
)paren
op_ne
l_int|0x7fff
)paren
(brace
multiline_comment|/* Ingore earlier buffers. */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet frame spanned &quot;
l_string|&quot;multiple buffers, status %8.8x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* There was a fatal error. */
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* end of a packet.*/
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0890
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0004
)paren
id|lp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0002
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0001
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer, compatible with net-2e. */
multiline_comment|/* Omit the four octet CRC from the length. */
r_int
id|pkt_len
op_assign
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_rshift
l_int|16
)paren
op_minus
l_int|4
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|rx_in_place
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_NET_HW_FLOWCONTROL
r_if
c_cond
(paren
id|netdev_dropping
)paren
r_goto
id|throttle
suffix:semicolon
macro_line|#endif
id|skb
op_assign
id|lp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_NET_FASTROUTE
r_switch
c_cond
(paren
id|tulip_fast_forward
c_func
(paren
id|dev
comma
id|entry
comma
id|pkt_len
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_goto
id|gone
suffix:semicolon
r_case
l_int|1
suffix:colon
r_goto
id|semi_gone
suffix:semicolon
r_case
l_int|2
suffix:colon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|memory_squeeze
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Check if the packet is long enough to just accept without&n;&t;&t;&t;   copying to a properly sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OG
id|rx_copybreak
)paren
(brace
r_struct
id|sk_buff
op_star
id|newskb
suffix:semicolon
r_char
op_star
id|temp
suffix:semicolon
multiline_comment|/* Get a fresh skbuff to replace the filled one. */
id|newskb
op_assign
id|DEV_ALLOC_SKB
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newskb
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* No memory, drop the packet. */
r_goto
id|memory_squeeze
suffix:semicolon
)brace
multiline_comment|/* Pass up the skb already on the Rx ring. */
id|temp
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
)paren
op_ne
id|temp
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Internal consistency error -- the &quot;
l_string|&quot;skbuff addresses do not match&quot;
l_string|&quot; in tulip_rx: %p vs. %p / %p.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
)paren
comma
id|skb-&gt;head
comma
id|temp
)paren
suffix:semicolon
id|rx_in_place
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|newskb
suffix:semicolon
id|newskb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Longword alignment required: do not skb_reserve(2)! */
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|newskb-&gt;tail
)paren
suffix:semicolon
)brace
r_else
id|skb
op_assign
id|DEV_ALLOC_SKB
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
id|memory_squeeze
suffix:colon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Check that at least two ring entries are free.&n;&t;&t;&t;&t;   If not, free one and mark stats-&gt;rx_dropped++. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|lp-&gt;rx_ring
(braket
(paren
id|entry
op_plus
id|i
)paren
op_mod
id|RX_RING_SIZE
)braket
dot
id|status
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|RX_RING_SIZE
op_minus
l_int|2
)paren
(brace
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|lp-&gt;cur_rx
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rx_in_place
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the data fields */
macro_line|#if LINUX_VERSION_CODE &lt; 0x20200  || defined(__alpha__)
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
)paren
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#else
macro_line|#ifdef ORIGINAL_TEXT
macro_line|#warning Code untested
macro_line|#else
macro_line|#error Code is wrong, and it has nothing to do with 2.2 :-)
macro_line|#endif
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|bus_to_virt
c_func
(paren
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|buffer1
)paren
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE &gt; 0x10300
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#else
id|skb-&gt;len
op_assign
id|pkt_len
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|semi_gone
suffix:colon
macro_line|#endif
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_HW_FLOWCONTROL
r_if
c_cond
(paren
id|netdev_dropping
)paren
(brace
id|throttle
suffix:colon
r_if
c_cond
(paren
id|lp-&gt;fc_bit
)paren
(brace
id|outl
c_func
(paren
id|lp-&gt;csr6
op_or
l_int|0x2000
comma
id|dev-&gt;base_addr
op_plus
id|CSR6
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|lp-&gt;fc_bit
comma
op_amp
id|netdev_fc_xoff
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|gone
suffix:colon
macro_line|#endif
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
macro_line|#ifndef ORIGINAL_TEXT
id|lp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
macro_line|#endif
)brace
id|lp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|entry
op_assign
(paren
op_increment
id|lp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tulip_close
id|tulip_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_NET_FASTROUTE
id|dev-&gt;tx_semaphore
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_NET_HW_FLOWCONTROL
r_if
c_cond
(paren
id|tp-&gt;fc_bit
)paren
(brace
r_int
id|bit
op_assign
id|tp-&gt;fc_bit
suffix:semicolon
id|tp-&gt;fc_bit
op_assign
l_int|0
suffix:semicolon
id|netdev_unregister_fc
c_func
(paren
id|bit
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|tulip_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR5
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outl
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|CSR7
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_amp
op_complement
l_int|0x2002
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* 21040 -- Leave the card in 10baseT state. */
r_if
c_cond
(paren
id|tp-&gt;chip_id
op_eq
id|DC21040
)paren
id|outl
c_func
(paren
l_int|0x00000004
comma
id|ioaddr
op_plus
id|CSR13
)paren
suffix:semicolon
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
macro_line|#ifdef SA_SHIRQ
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
macro_line|#else
id|free_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|irq2dev_map
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Free all the skbuffs in the Rx queue. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|tp-&gt;rx_skbuff
(braket
id|i
)braket
suffix:semicolon
id|tp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Not owned by Tulip chip. */
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|length
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buffer1
op_assign
l_int|0xBADF00D0
suffix:semicolon
multiline_comment|/* An invalid address. */
r_if
c_cond
(paren
id|skb
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
id|skb-&gt;free
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|tp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|tp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|enet_statistics
op_star
DECL|function|tulip_get_stats
id|tulip_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR8
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_return
op_amp
id|tp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n;   Note that we only use exclusion around actually queueing the&n;   new frame, not around filling tp-&gt;setup_frame.  This is non-deterministic&n;   when re-entered but still correct. */
multiline_comment|/* The little-endian AUTODIN32 ethernet CRC calculation.&n;   N.B. Do not use for bulk data, use a table-based routine instead.&n;   This is common code and should be moved to net/core/crc.c */
DECL|variable|ethernet_polynomial_le
r_static
r_int
r_const
id|ethernet_polynomial_le
op_assign
l_int|0xedb88320U
suffix:semicolon
DECL|function|ether_crc_le
r_static
r_inline
r_int
id|ether_crc_le
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
r_int
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Initial value. */
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|8
suffix:semicolon
op_decrement
id|bit
op_ge
l_int|0
suffix:semicolon
id|current_octet
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|crc
op_xor
id|current_octet
)paren
op_amp
l_int|1
)paren
(brace
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|crc
op_xor_assign
id|ethernet_polynomial_le
suffix:semicolon
)brace
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|crc
suffix:semicolon
)brace
macro_line|#ifdef NEW_MULTICAST
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
macro_line|#else
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|num_addrs
comma
r_void
op_star
id|addrs
)paren
macro_line|#endif
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|csr6
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|CSR6
)paren
op_amp
op_complement
l_int|0x00D5
suffix:semicolon
r_struct
id|tulip_private
op_star
id|tp
op_assign
(paren
r_struct
id|tulip_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|tp-&gt;csr6
op_and_assign
op_complement
l_int|0x00D5
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
id|outl
c_func
(paren
id|csr6
op_or
l_int|0x00C0
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tp-&gt;csr6
op_or_assign
l_int|0xC0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
l_int|1000
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to filter perfectly -- accept all multicasts. */
id|outl
c_func
(paren
id|csr6
op_or
l_int|0x0080
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
id|tp-&gt;csr6
op_or_assign
l_int|0x80
suffix:semicolon
)brace
r_else
(brace
id|u32
op_star
id|setup_frm
op_assign
id|tp-&gt;setup_frame
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|u16
op_star
id|eaddrs
suffix:semicolon
id|u32
id|tx_flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mc_count
OG
l_int|14
)paren
(brace
multiline_comment|/* Must use a multicast hash table. */
id|u16
id|hash_table
(braket
l_int|32
)braket
suffix:semicolon
id|memset
c_func
(paren
id|hash_table
comma
l_int|0
comma
r_sizeof
(paren
id|hash_table
)paren
)paren
suffix:semicolon
multiline_comment|/* This should work on big-endian machines as well. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
id|set_bit
c_func
(paren
id|ether_crc_le
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_amp
l_int|0x1ff
comma
id|hash_table
)paren
suffix:semicolon
multiline_comment|/* Copy the hash table to the setup frame.&n;&t;&t;&t; NOTE that only the LOW SHORTWORD of setup_frame[] is valid! */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
op_star
id|setup_frm
op_increment
op_assign
id|hash_table
(braket
id|i
)braket
suffix:semicolon
id|setup_frm
op_add_assign
l_int|7
suffix:semicolon
id|tx_flags
op_assign
l_int|0x08400000
op_or
l_int|192
suffix:semicolon
multiline_comment|/* Too clever: i &gt; 15 for fall-though. */
)brace
r_else
(brace
multiline_comment|/* We have &lt;= 15 addresses so we can use the wonderful&n;&t;&t;&t; 16 address perfect filtering of the Tulip. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
multiline_comment|/* Note that only the low shortword of setup_frame[] is valid!&n;&t;&t;&t;   This code may require tweaking for non-x86 architectures! */
id|eaddrs
op_assign
(paren
id|u16
op_star
)paren
id|mclist-&gt;dmi_addr
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
op_star
id|eaddrs
op_increment
suffix:semicolon
)brace
multiline_comment|/* Fill the rest of the table with our physical address.&n;&t;&t;&t; Once again, only the low shortword or setup_frame[] is valid! */
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
l_int|0xffff
suffix:semicolon
id|tx_flags
op_assign
l_int|0x08000000
op_or
l_int|192
suffix:semicolon
)brace
id|eaddrs
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
r_do
(brace
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|setup_frm
op_increment
op_assign
id|eaddrs
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|i
OL
l_int|15
)paren
suffix:semicolon
multiline_comment|/* Now add this frame to the Tx list. */
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
OG
id|TX_RING_SIZE
op_minus
l_int|2
)paren
(brace
multiline_comment|/* Same setup recently queued, we need not add it. */
)brace
r_else
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|entry
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|entry
op_assign
id|tp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Avoid a chip errata by prefixing a dummy entry. */
id|tp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
(paren
id|entry
op_eq
id|TX_RING_SIZE
op_minus
l_int|1
)paren
ques
c_cond
l_int|0x02000000
suffix:colon
l_int|0
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|buffer1
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
id|entry
op_assign
id|tp-&gt;cur_tx
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
)brace
id|tp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Put the setup frame on the Tx list. */
r_if
c_cond
(paren
id|entry
op_eq
id|TX_RING_SIZE
op_minus
l_int|1
)paren
id|tx_flags
op_or_assign
l_int|0x02000000
suffix:semicolon
multiline_comment|/* Wrap ring. */
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
id|tx_flags
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|buffer1
op_assign
id|virt_to_bus
c_func
(paren
id|tp-&gt;setup_frame
)paren
suffix:semicolon
id|tp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0x80000000
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;cur_tx
op_minus
id|tp-&gt;dirty_tx
op_ge
id|TX_RING_SIZE
op_minus
l_int|2
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Trigger an immediate transmit demand. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|CSR1
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|csr6
op_or
l_int|0x0000
comma
id|ioaddr
op_plus
id|CSR6
)paren
suffix:semicolon
)brace
)brace
"&f;"
macro_line|#ifdef MODULE
macro_line|#if LINUX_VERSION_CODE &gt; 0x20118
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Digital 21*4* Tulip ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|reverse_probe
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* An additional parameter that may be passed in... */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|debug
op_ge
l_int|0
)paren
id|tulip_debug
op_assign
id|debug
suffix:semicolon
id|root_tulip_dev
op_assign
l_int|NULL
suffix:semicolon
r_return
id|tulip_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|next_dev
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_tulip_dev
)paren
(brace
id|next_dev
op_assign
(paren
(paren
r_struct
id|tulip_private
op_star
)paren
id|root_tulip_dev-&gt;priv
)paren
op_member_access_from_pointer
id|next_module
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_tulip_dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_tulip_dev-&gt;base_addr
comma
id|TULIP_TOTAL_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_tulip_dev
)paren
suffix:semicolon
id|root_tulip_dev
op_assign
id|next_dev
suffix:semicolon
)brace
)brace
macro_line|#endif  /* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODVERSIONS -DMODULE -D__KERNEL__ -I/usr/src/linux/net/inet -Wall -Wstrict-prototypes -O6 -c tulip.c&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
