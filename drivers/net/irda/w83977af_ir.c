multiline_comment|/*********************************************************************&n; *                &n; * Filename:      w83977af_ir.c&n; * Version:       1.0&n; * Description:   FIR driver for the Winbond W83977AF Super I/O chip&n; * Status:        Experimental.&n; * Author:        Paul VanderSpek&n; * Created at:    Wed Nov  4 11:46:16 1998&n; * Modified at:   Fri Jan 28 12:10:59 2000&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998-2000 Dag Brattli &lt;dagb@cs.uit.no&gt;&n; *     Copyright (c) 1998-1999 Rebel.com&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither Paul VanderSpek nor Rebel.com admit liability nor provide&n; *     warranty for any of this software. This material is provided &quot;AS-IS&quot;&n; *     and at no charge.&n; *     &n; *     If you find bugs in this file, its very likely that the same bug&n; *     will also be in pc87108.c since the implementations are quite&n; *     similar.&n; *&n; *     Notice that all functions that needs to access the chip in _any_&n; *     way, must save BSR register on entry, and restore it on exit. &n; *     It is _very_ important to follow this policy!&n; *&n; *         __u8 bank;&n; *     &n; *         bank = inb( iobase+BSR);&n; *  &n; *         do_your_stuff_here();&n; *&n; *         outb( bank, iobase+BSR);&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt; 
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/w83977af.h&gt;
macro_line|#include &lt;net/irda/w83977af_ir.h&gt;
macro_line|#ifdef  CONFIG_ARCH_NETWINDER            /* Adjust to NetWinder differences */
DECL|macro|CONFIG_NETWINDER_TX_DMA_PROBLEMS
macro_line|#undef  CONFIG_NETWINDER_TX_DMA_PROBLEMS /* Not needed */
DECL|macro|CONFIG_NETWINDER_RX_DMA_PROBLEMS
mdefine_line|#define CONFIG_NETWINDER_RX_DMA_PROBLEMS /* Must have this one! */
macro_line|#endif
DECL|macro|CONFIG_USE_INTERNAL_TIMER
macro_line|#undef  CONFIG_USE_INTERNAL_TIMER  /* Just cannot make that timer work */
DECL|macro|CONFIG_USE_W977_PNP
mdefine_line|#define CONFIG_USE_W977_PNP        /* Currently needed */
DECL|macro|PIO_MAX_SPEED
mdefine_line|#define PIO_MAX_SPEED       115200 
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;w83977af_ir&quot;
suffix:semicolon
DECL|variable|qos_mtt_bits
r_static
r_int
id|qos_mtt_bits
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 1 ms or more */
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT 8
DECL|variable|io
r_static
r_int
r_int
id|io
(braket
)braket
op_assign
(brace
l_int|0x180
comma
op_complement
l_int|0
comma
op_complement
l_int|0
comma
op_complement
l_int|0
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_NETWINDER             /* Adjust to NetWinder differences */
DECL|variable|irq
r_static
r_int
r_int
id|irq
(braket
)braket
op_assign
(brace
l_int|6
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#else
DECL|variable|irq
r_static
r_int
r_int
id|irq
(braket
)braket
op_assign
(brace
l_int|11
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|dma
r_static
r_int
r_int
id|dma
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|efbase
r_static
r_int
r_int
id|efbase
(braket
)braket
op_assign
(brace
id|W977_EFIO_BASE
comma
id|W977_EFIO2_BASE
)brace
suffix:semicolon
DECL|variable|efio
r_static
r_int
r_int
id|efio
op_assign
id|W977_EFIO_BASE
suffix:semicolon
DECL|variable|dev_self
r_static
r_struct
id|w83977af_ir
op_star
id|dev_self
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Some prototypes */
r_static
r_int
id|w83977af_open
c_func
(paren
r_int
id|i
comma
r_int
r_int
id|iobase
comma
r_int
r_int
id|irq
comma
r_int
r_int
id|dma
)paren
suffix:semicolon
r_static
r_int
id|w83977af_close
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|w83977af_probe
c_func
(paren
r_int
id|iobase
comma
r_int
id|irq
comma
r_int
id|dma
)paren
suffix:semicolon
r_static
r_int
id|w83977af_dma_receive
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|w83977af_dma_receive_complete
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|w83977af_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|w83977af_pio_write
c_func
(paren
r_int
id|iobase
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|fifo_size
)paren
suffix:semicolon
r_static
r_void
id|w83977af_dma_write
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|w83977af_change_speed
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
comma
id|__u32
id|speed
)paren
suffix:semicolon
r_static
r_void
id|w83977af_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|w83977af_is_receiving
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|w83977af_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|w83977af_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|w83977af_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|w83977af_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|w83977af_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n; * Function w83977af_init ()&n; *&n; *    Initialize chip. Just try to find out how many chips we are dealing with&n; *    and where they are&n; */
DECL|function|w83977af_init
r_int
id|__init
id|w83977af_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|io
(braket
id|i
)braket
OL
l_int|2000
)paren
op_logical_and
(paren
id|i
OL
l_int|4
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|CHIP_IO_EXTENT
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|w83977af_open
c_func
(paren
id|i
comma
id|io
(braket
id|i
)braket
comma
id|irq
(braket
id|i
)braket
comma
id|dma
(braket
id|i
)braket
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_cleanup ()&n; *&n; *    Close all configured chips&n; *&n; */
macro_line|#ifdef MODULE
DECL|function|w83977af_cleanup
r_void
id|w83977af_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|w83977af_close
c_func
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Function w83977af_open (iobase, irq)&n; *&n; *    Open driver instance&n; *&n; */
DECL|function|w83977af_open
r_int
id|w83977af_open
c_func
(paren
r_int
id|i
comma
r_int
r_int
id|iobase
comma
r_int
r_int
id|irq
comma
r_int
r_int
id|dma
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|w83977af_ir
op_star
id|self
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w83977af_probe
c_func
(paren
id|iobase
comma
id|irq
comma
id|dma
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *  Allocate new instance of the driver&n;&t; */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|w83977af_ir
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IrDA: Can&squot;t allocate memory for &quot;
l_string|&quot;IrDA control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|w83977af_ir
)paren
)paren
suffix:semicolon
multiline_comment|/* Need to store self somewhere */
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
multiline_comment|/* Initialize IO */
id|self-&gt;io.fir_base
op_assign
id|iobase
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|irq
suffix:semicolon
id|self-&gt;io.fir_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.dma
op_assign
id|dma
suffix:semicolon
id|self-&gt;io.fifo_size
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Lock the port that we need */
id|ret
op_assign
id|check_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
multiline_comment|/* w83977af_cleanup( self);  */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
comma
id|driver_name
)paren
suffix:semicolon
multiline_comment|/* Initialize QoS for this device */
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* The only value we must override it the baudrate */
multiline_comment|/* FIXME: The HP HDLS-1100 does not support 1152000! */
id|self-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* The HP HDLS-1100 needs 1 ms according to the specs */
id|self-&gt;qos.min_turn_time.bits
op_assign
id|qos_mtt_bits
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;flags
op_assign
id|IFF_FIR
op_or
id|IFF_MIR
op_or
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
suffix:semicolon
multiline_comment|/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */
id|self-&gt;rx_buff.truesize
op_assign
l_int|14384
suffix:semicolon
id|self-&gt;tx_buff.truesize
op_assign
l_int|4000
suffix:semicolon
multiline_comment|/* Allocate memory if needed */
id|self-&gt;rx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;rx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|self-&gt;rx_buff.head
comma
l_int|0
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;tx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;tx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;tx_buff.head
comma
l_int|0
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;rx_buff.in_frame
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|dev_alloc
c_func
(paren
l_string|&quot;irda%d&quot;
comma
op_amp
id|err
)paren
)paren
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), dev_alloc() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Override the network functions we need to use */
id|dev-&gt;init
op_assign
id|w83977af_net_init
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|w83977af_hard_xmit
suffix:semicolon
id|dev-&gt;open
op_assign
id|w83977af_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|w83977af_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|w83977af_net_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|w83977af_net_get_stats
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|register_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), register_netdevice() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_close (self)&n; *&n; *    Close driver instance&n; *&n; */
DECL|function|w83977af_close
r_static
r_int
id|w83977af_close
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
macro_line|#ifdef CONFIG_USE_W977_PNP
multiline_comment|/* enter PnP configuration mode */
id|w977_efm_enter
c_func
(paren
id|efio
)paren
suffix:semicolon
id|w977_select_device
c_func
(paren
id|W977_DEVICE_IR
comma
id|efio
)paren
suffix:semicolon
multiline_comment|/* Deactivate device */
id|w977_write_reg
c_func
(paren
l_int|0x30
comma
l_int|0x00
comma
id|efio
)paren
suffix:semicolon
id|w977_efm_exit
c_func
(paren
id|efio
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_USE_W977_PNP */
multiline_comment|/* Remove netdevice */
r_if
c_cond
(paren
id|self-&gt;netdev
)paren
(brace
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Release the PORT that this driver is using */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Releasing Region %03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w83977af_probe
r_int
id|w83977af_probe
c_func
(paren
r_int
id|iobase
comma
r_int
id|irq
comma
r_int
id|dma
)paren
(brace
r_int
id|version
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USE_W977_PNP
multiline_comment|/* Enter PnP configuration mode */
id|w977_efm_enter
c_func
(paren
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
id|w977_select_device
c_func
(paren
id|W977_DEVICE_IR
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Configure PnP port, IRQ, and DMA channel */
id|w977_write_reg
c_func
(paren
l_int|0x60
comma
(paren
id|iobase
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
id|w977_write_reg
c_func
(paren
l_int|0x61
comma
(paren
id|iobase
)paren
op_amp
l_int|0xff
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
id|w977_write_reg
c_func
(paren
l_int|0x70
comma
id|irq
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_NETWINDER
multiline_comment|/* Netwinder uses 1 higher than Linux */
id|w977_write_reg
c_func
(paren
l_int|0x74
comma
id|dma
op_plus
l_int|1
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#else
id|w977_write_reg
c_func
(paren
l_int|0x74
comma
id|dma
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif /*CONFIG_ARCH_NETWINDER */
id|w977_write_reg
c_func
(paren
l_int|0x75
comma
l_int|0x04
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Disable Tx DMA */
multiline_comment|/* Set append hardware CRC, enable IR bank selection */
id|w977_write_reg
c_func
(paren
l_int|0xf0
comma
id|APEDCRC
op_or
id|ENBNKSEL
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Activate device */
id|w977_write_reg
c_func
(paren
l_int|0x30
comma
l_int|0x01
comma
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
id|w977_efm_exit
c_func
(paren
id|efbase
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_USE_W977_PNP */
multiline_comment|/* Disable Advanced mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|iobase
op_plus
l_int|2
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Turn on UART (global) interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|HCR_EN_IRQ
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
multiline_comment|/* Switch to advanced mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|ADCR1
)paren
op_or
id|ADCR1_ADV_SL
comma
id|iobase
op_plus
id|ADCR1
)paren
suffix:semicolon
multiline_comment|/* Set default IR-mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|HCR_SIR
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
multiline_comment|/* Read the Advanced IR ID */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET3
)paren
suffix:semicolon
id|version
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|AUID
)paren
suffix:semicolon
multiline_comment|/* Should be 0x1? */
r_if
c_cond
(paren
l_int|0x10
op_eq
(paren
id|version
op_amp
l_int|0xf0
)paren
)paren
(brace
id|efio
op_assign
id|efbase
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Set FIFO size to 32 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ADCR2_RXFS32
op_or
id|ADCR2_TXFS32
comma
id|iobase
op_plus
id|ADCR2
)paren
suffix:semicolon
multiline_comment|/* Set FIFO threshold to TX17, RX16 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|UFR_RXTL
op_or
id|UFR_TXTL
op_or
id|UFR_TXF_RST
op_or
id|UFR_RXF_RST
op_or
id|UFR_EN_FIFO
comma
id|iobase
op_plus
id|UFR
)paren
suffix:semicolon
multiline_comment|/* Receiver frame length */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|2048
op_amp
l_int|0xff
comma
id|iobase
op_plus
l_int|6
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|2048
op_rshift
l_int|8
)paren
op_amp
l_int|0x1f
comma
id|iobase
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Init HP HSDL-1100 transceiver. &n;&t;&t;&t; * &n;&t;&t;&t; * Set IRX_MSL since we have 2 * receive paths IRRX, &n;&t;&t;&t; * and IRRXH. Clear IRSL0D since we want IRSL0 * to &n;&t;&t;&t; * be a input pin used for IRRXH &n;&t;&t;&t; *&n;&t;&t;&t; *   IRRX  pin 37 connected to receiver &n;&t;&t;&t; *   IRTX  pin 38 connected to transmitter&n;&t;&t;&t; *   FIRRX pin 39 connected to receiver      (IRSL0) &n;&t;&t;&t; *   CIRRX pin 40 connected to pin 37&n;&t;&t;&t; */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET7
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x40
comma
id|iobase
op_plus
l_int|7
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;W83977AF (IR) driver loaded. &quot;
l_string|&quot;Version: 0x%02x&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Try next extented function register address */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Wrong chip version&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|w83977af_change_speed
r_void
id|w83977af_change_speed
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
comma
id|__u32
id|speed
)paren
(brace
r_int
id|ir_mode
op_assign
id|HCR_SIR
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
multiline_comment|/* Save current bank */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
multiline_comment|/* Select Set 2 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|ABHL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|9600
suffix:colon
id|outb
c_func
(paren
l_int|0x0c
comma
id|iobase
op_plus
id|ABLL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|outb
c_func
(paren
l_int|0x06
comma
id|iobase
op_plus
id|ABLL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|outb
c_func
(paren
l_int|0x03
comma
id|iobase
op_plus
id|ABLL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|outb
c_func
(paren
l_int|0x02
comma
id|iobase
op_plus
id|ABLL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|outb
c_func
(paren
l_int|0x01
comma
id|iobase
op_plus
id|ABLL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|576000
suffix:colon
id|ir_mode
op_assign
id|HCR_MIR_576
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 576000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|ir_mode
op_assign
id|HCR_MIR_1152
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 1152000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|ir_mode
op_assign
id|HCR_FIR
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 4000000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ir_mode
op_assign
id|HCR_FIR
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unknown baud rate of %d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Set speed mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ir_mode
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
multiline_comment|/* set FIFO size to 32 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ADCR2_RXFS32
op_or
id|ADCR2_TXFS32
comma
id|iobase
op_plus
id|ADCR2
)paren
suffix:semicolon
multiline_comment|/* set FIFO threshold to TX17, RX16 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|UFR
)paren
suffix:semicolon
multiline_comment|/* Reset */
id|outb
c_func
(paren
id|UFR_EN_FIFO
comma
id|iobase
op_plus
id|UFR
)paren
suffix:semicolon
multiline_comment|/* First we must enable FIFO */
id|outb
c_func
(paren
l_int|0xa7
comma
id|iobase
op_plus
id|UFR
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Enable some interrupts so we can receive frames */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
id|PIO_MAX_SPEED
)paren
(brace
id|outb
c_func
(paren
id|ICR_EFSFI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
id|w83977af_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|ICR_ERBRI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
multiline_comment|/* Restore SSR */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_hard_xmit (skb, dev)&n; *&n; *    Sets up a DMA transfer to send the current frame.&n; *&n; */
DECL|function|w83977af_hard_xmit
r_int
id|w83977af_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|w83977af_ir
op_star
id|self
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
r_int
id|mtt
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|w83977af_ir
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(%ld), skb-&gt;len=%d&bslash;n&quot;
comma
id|jiffies
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Lock transmit buffer */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
(paren
id|speed
op_assign
id|irda_get_speed
c_func
(paren
id|skb
)paren
)paren
op_ne
id|self-&gt;io.speed
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|w83977af_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Decide if we should use PIO or DMA transfer */
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
id|PIO_MAX_SPEED
)paren
(brace
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|memcpy
c_func
(paren
id|self-&gt;tx_buff.data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|self-&gt;tx_buff.len
op_assign
id|skb-&gt;len
suffix:semicolon
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USE_INTERNAL_TIMER
r_if
c_cond
(paren
id|mtt
OG
l_int|50
)paren
(brace
multiline_comment|/* Adjust for timer resolution */
id|mtt
op_div_assign
l_int|1000
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Setup timer */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mtt
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|TMRL
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|mtt
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
comma
id|iobase
op_plus
id|TMRH
)paren
suffix:semicolon
multiline_comment|/* Start timer */
id|outb
c_func
(paren
id|IR_MSL_EN_TMR
comma
id|iobase
op_plus
id|IR_MSL
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Enable timer interrupt */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ICR_ETMRI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(%ld), mtt=%d&bslash;n&quot;
comma
id|jiffies
comma
id|mtt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
id|udelay
c_func
(paren
id|mtt
)paren
suffix:semicolon
multiline_comment|/* Enable DMA interrupt */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ICR_EDMAI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
id|w83977af_dma_write
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USE_INTERNAL_TIMER
)brace
macro_line|#endif
)brace
r_else
(brace
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;tx_buff.len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
multiline_comment|/* Add interrupt on tx low level (will fire immediately) */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ICR_ETXTHI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Restore set register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_dma_write (self, iobase)&n; *&n; *    Send frame using DMA&n; *&n; */
DECL|function|w83977af_dma_write
r_static
r_void
id|w83977af_dma_write
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
id|__u8
id|set
suffix:semicolon
macro_line|#ifdef CONFIG_NETWINDER_TX_DMA_PROBLEMS
r_int
r_int
id|flags
suffix:semicolon
id|__u8
id|hcr
suffix:semicolon
macro_line|#endif
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), len=%d&bslash;n&quot;
comma
id|self-&gt;tx_buff.len
)paren
suffix:semicolon
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
op_amp
op_complement
id|HCR_EN_DMA
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
multiline_comment|/* Choose transmit DMA channel  */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ADCR1_D_CHSW
op_or
multiline_comment|/*ADCR1_DMA_F|*/
id|ADCR1_ADV_SL
comma
id|iobase
op_plus
id|ADCR1
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NETWINDER_TX_DMA_PROBLEMS
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|self-&gt;io.dma
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|self-&gt;io.dma
comma
id|virt_to_bus
c_func
(paren
id|self-&gt;tx_buff.data
)paren
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_buff.len
)paren
suffix:semicolon
macro_line|#else
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
macro_line|#endif
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Enable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NETWINDER_TX_DMA_PROBLEMS
id|hcr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|hcr
op_or
id|HCR_EN_DMA
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else&t;
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
op_or
id|HCR_EN_DMA
op_or
id|HCR_TX_WT
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Restore set register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_pio_write (iobase, buf, len, fifo_size)&n; *&n; *    &n; *&n; */
DECL|function|w83977af_pio_write
r_static
r_int
id|w83977af_pio_write
c_func
(paren
r_int
id|iobase
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|fifo_size
)paren
(brace
r_int
id|actual
op_assign
l_int|0
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Save current bank */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb_p
c_func
(paren
id|iobase
op_plus
id|USR
)paren
op_amp
id|USR_TSRE
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), warning, FIFO not empty yet!&bslash;n&quot;
)paren
suffix:semicolon
id|fifo_size
op_sub_assign
l_int|17
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;%d bytes left in tx fifo&bslash;n&quot;
comma
id|fifo_size
)paren
suffix:semicolon
)brace
multiline_comment|/* Fill FIFO with current frame */
r_while
c_loop
(paren
(paren
id|fifo_size
op_decrement
OG
l_int|0
)paren
op_logical_and
(paren
id|actual
OL
id|len
)paren
)paren
(brace
multiline_comment|/* Transmit next byte */
id|outb
c_func
(paren
id|buf
(braket
id|actual
op_increment
)braket
comma
id|iobase
op_plus
id|TBR
)paren
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), fifo_size %d ; %d sent of %d&bslash;n&quot;
comma
id|fifo_size
comma
id|actual
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Restore bank */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
id|actual
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_dma_xmit_complete (self)&n; *&n; *    The transfer of a frame in finished. So do the necessary things&n; *&n; *    &n; */
DECL|function|w83977af_dma_xmit_complete
r_void
id|w83977af_dma_xmit_complete
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(%ld)&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
op_amp
op_complement
id|HCR_EN_DMA
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
multiline_comment|/* Check for underrrun! */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|AUDR
)paren
op_amp
id|AUDR_UNDR
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Transmit underrun!&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
multiline_comment|/* Clear bit, by writing 1 to it */
id|outb
c_func
(paren
id|AUDR_UNDR
comma
id|iobase
op_plus
id|AUDR
)paren
suffix:semicolon
)brace
r_else
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|w83977af_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Unlock tx_buff and request another frame */
multiline_comment|/* Tell the network layer, that we want more frames */
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Restore set */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_dma_receive (self)&n; *&n; *    Get ready for receiving a frame. The device will initiate a DMA&n; *    if it starts to receive a frame.&n; *&n; */
DECL|function|w83977af_dma_receive
r_int
id|w83977af_dma_receive
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
macro_line|#ifdef CONFIG_NETWINDER_RX_DMA_PROBLEMS
r_int
r_int
id|flags
suffix:semicolon
id|__u8
id|hcr
suffix:semicolon
macro_line|#endif
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
op_amp
op_complement
id|HCR_EN_DMA
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
multiline_comment|/* Choose DMA Rx, DMA Fairness, and Advanced mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|ADCR1
)paren
op_amp
op_complement
id|ADCR1_D_CHSW
)paren
multiline_comment|/*|ADCR1_DMA_F*/
op_or
id|ADCR1_ADV_SL
comma
id|iobase
op_plus
id|ADCR1
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
macro_line|#ifdef CONFIG_NETWINDER_RX_DMA_PROBLEMS
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|self-&gt;io.dma
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|self-&gt;io.dma
comma
id|virt_to_bus
c_func
(paren
id|self-&gt;rx_buff.data
)paren
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
macro_line|#else
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;rx_buff.data
comma
id|self-&gt;rx_buff.truesize
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n;&t; * Reset Rx FIFO. This will also flush the ST_FIFO, it&squot;s very &n;&t; * important that we don&squot;t reset the Tx FIFO since it might not&n;&t; * be finished transmitting yet&n;&t; */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|UFR_RXTL
op_or
id|UFR_TXTL
op_or
id|UFR_RXF_RST
op_or
id|UFR_EN_FIFO
comma
id|iobase
op_plus
id|UFR
)paren
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
id|self-&gt;st_fifo.tail
op_assign
id|self-&gt;st_fifo.head
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NETWINDER_RX_DMA_PROBLEMS
id|hcr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|hcr
op_or
id|HCR_EN_DMA
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else&t;
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|HCR
)paren
op_or
id|HCR_EN_DMA
comma
id|iobase
op_plus
id|HCR
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Restore set */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_receive_complete (self)&n; *&n; *    Finished with receiving a frame&n; *&n; */
DECL|function|w83977af_dma_receive_complete
r_int
id|w83977af_dma_receive_complete
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|st_fifo
op_star
id|st_fifo
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|__u8
id|status
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|st_fifo
op_assign
op_amp
id|self-&gt;st_fifo
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Read status FIFO */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET5
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FS_FO
)paren
)paren
op_amp
id|FS_FO_FSFDR
)paren
(brace
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|len
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|RFLFL
)paren
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|len
op_or_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|RFLFH
)paren
op_lshift
l_int|8
suffix:semicolon
id|st_fifo-&gt;tail
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|st_fifo-&gt;len
)paren
(brace
multiline_comment|/* Get first entry */
id|status
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
suffix:semicolon
id|len
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
suffix:semicolon
id|st_fifo-&gt;head
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_decrement
suffix:semicolon
multiline_comment|/* Check for errors */
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_ERR_MSK
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_LST_FR
)paren
(brace
multiline_comment|/* Add number of lost frames to stats */
id|self-&gt;stats.rx_errors
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Skip frame */
id|self-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_MX_LEX
)paren
id|self-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_PHY_ERR
)paren
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_CRC_ERR
)paren
id|self-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* The errors below can be reported in both cases */
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_RX_OV
)paren
id|self-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FS_FO_FSF_OV
)paren
id|self-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check if we have transfered all data to memory */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|USR
)paren
op_amp
id|USR_RDR
)paren
(brace
macro_line|#ifdef CONFIG_USE_INTERNAL_TIMER
multiline_comment|/* Put this entry back in fifo */
id|st_fifo-&gt;head
op_decrement
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
multiline_comment|/* Restore set register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* I&squot;ll be back! */
macro_line|#else
id|udelay
c_func
(paren
l_int|80
)paren
suffix:semicolon
multiline_comment|/* Should be enough!? */
macro_line|#endif
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|__FUNCTION__
l_string|&quot;(), memory squeeze, dropping frame.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Restore set register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*  Align to 20 bytes */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Copy frame without CRC */
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|4000000
)paren
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Move to next frame */
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Restore set register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function pc87108_pio_receive (self)&n; *&n; *    Receive all data in receiver FIFO&n; *&n; */
DECL|function|w83977af_pio_receive
r_static
r_void
id|w83977af_pio_receive
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
(brace
id|__u8
id|byte
op_assign
l_int|0x00
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/*  Receive all characters in Rx FIFO */
r_do
(brace
id|byte
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|RBR
)paren
suffix:semicolon
id|async_unwrap_char
c_func
(paren
id|self-&gt;netdev
comma
op_amp
id|self-&gt;stats
comma
op_amp
id|self-&gt;rx_buff
comma
id|byte
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|USR
)paren
op_amp
id|USR_RDR
)paren
suffix:semicolon
multiline_comment|/* Data available */
)brace
multiline_comment|/*&n; * Function w83977af_sir_interrupt (self, eir)&n; *&n; *    Handle SIR interrupt&n; *&n; */
DECL|function|w83977af_sir_interrupt
r_static
id|__u8
id|w83977af_sir_interrupt
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
comma
r_int
id|isr
)paren
(brace
r_int
id|actual
suffix:semicolon
id|__u8
id|new_icr
op_assign
l_int|0
suffix:semicolon
id|__u8
id|set
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), isr=%#x&bslash;n&quot;
comma
id|isr
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Transmit FIFO low on data */
r_if
c_cond
(paren
id|isr
op_amp
id|ISR_TXTH_I
)paren
(brace
multiline_comment|/* Write data left in transmit buffer */
id|actual
op_assign
id|w83977af_pio_write
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
comma
id|self-&gt;io.fifo_size
)paren
suffix:semicolon
id|self-&gt;tx_buff.data
op_add_assign
id|actual
suffix:semicolon
id|self-&gt;tx_buff.len
op_sub_assign
id|actual
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Check if finished */
r_if
c_cond
(paren
id|self-&gt;tx_buff.len
OG
l_int|0
)paren
(brace
id|new_icr
op_or_assign
id|ICR_ETXTHI
suffix:semicolon
)brace
r_else
(brace
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|AUDR_SFEND
comma
id|iobase
op_plus
id|AUDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
multiline_comment|/* Feed me more packets */
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|new_icr
op_or_assign
id|ICR_ETBREI
suffix:semicolon
)brace
)brace
multiline_comment|/* Check if transmission has completed */
r_if
c_cond
(paren
id|isr
op_amp
id|ISR_TXEMP_I
)paren
(brace
multiline_comment|/* Check if we need to change the speed? */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Changing speed!&bslash;n&quot;
)paren
suffix:semicolon
id|w83977af_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Turn around and get ready to receive some data */
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|new_icr
op_or_assign
id|ICR_ERBRI
suffix:semicolon
)brace
multiline_comment|/* Rx FIFO threshold or timeout */
r_if
c_cond
(paren
id|isr
op_amp
id|ISR_RXTH_I
)paren
(brace
id|w83977af_pio_receive
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Keep receiving */
id|new_icr
op_or_assign
id|ICR_ERBRI
suffix:semicolon
)brace
r_return
id|new_icr
suffix:semicolon
)brace
multiline_comment|/*&n; * Function pc87108_fir_interrupt (self, eir)&n; *&n; *    Handle MIR/FIR interrupt&n; *&n; */
DECL|function|w83977af_fir_interrupt
r_static
id|__u8
id|w83977af_fir_interrupt
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
comma
r_int
id|isr
)paren
(brace
id|__u8
id|new_icr
op_assign
l_int|0
suffix:semicolon
id|__u8
id|set
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* End of frame detected in FIFO */
r_if
c_cond
(paren
id|isr
op_amp
(paren
id|ISR_FEND_I
op_or
id|ISR_FSF_I
)paren
)paren
(brace
r_if
c_cond
(paren
id|w83977af_dma_receive_complete
c_func
(paren
id|self
)paren
)paren
(brace
multiline_comment|/* Wait for next status FIFO interrupt */
id|new_icr
op_or_assign
id|ICR_EFSFI
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DMA not finished yet */
multiline_comment|/* Set timer value, resolution 1 ms */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|iobase
op_plus
id|TMRL
)paren
suffix:semicolon
multiline_comment|/* 1 ms */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|TMRH
)paren
suffix:semicolon
multiline_comment|/* Start timer */
id|outb
c_func
(paren
id|IR_MSL_EN_TMR
comma
id|iobase
op_plus
id|IR_MSL
)paren
suffix:semicolon
id|new_icr
op_or_assign
id|ICR_ETMRI
suffix:semicolon
)brace
)brace
multiline_comment|/* Timer finished */
r_if
c_cond
(paren
id|isr
op_amp
id|ISR_TMR_I
)paren
(brace
multiline_comment|/* Disable timer */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IR_MSL
)paren
suffix:semicolon
multiline_comment|/* Clear timer event */
multiline_comment|/* switch_bank(iobase, SET0); */
multiline_comment|/* &t;&t;outb(ASCR_CTE, iobase+ASCR); */
multiline_comment|/* Check if this is a TX timer interrupt */
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_XMIT
)paren
(brace
id|w83977af_dma_write
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
id|new_icr
op_or_assign
id|ICR_EDMAI
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check if DMA has now finished */
id|w83977af_dma_receive_complete
c_func
(paren
id|self
)paren
suffix:semicolon
id|new_icr
op_or_assign
id|ICR_EFSFI
suffix:semicolon
)brace
)brace
multiline_comment|/* Finished with DMA */
r_if
c_cond
(paren
id|isr
op_amp
id|ISR_DMA_I
)paren
(brace
id|w83977af_dma_xmit_complete
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Check if there are more frames to be transmitted */
multiline_comment|/* if (irda_device_txqueue_empty(self)) { */
multiline_comment|/* Prepare for receive &n;&t;&t; * &n;&t;&t; * ** Netwinder Tx DMA likes that we do this anyway **&n;&t;&t; */
id|w83977af_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
id|new_icr
op_assign
id|ICR_EFSFI
suffix:semicolon
multiline_comment|/* } */
)brace
multiline_comment|/* Restore set */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
r_return
id|new_icr
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_interrupt (irq, dev_id, regs)&n; *&n; *    An interrupt from the chip has arrived. Time to do some work&n; *&n; */
DECL|function|w83977af_interrupt
r_static
r_void
id|w83977af_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|w83977af_ir
op_star
id|self
suffix:semicolon
id|__u8
id|set
comma
id|icr
comma
id|isr
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|w83977af_ir
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Save current bank */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|icr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
id|isr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|ISR
)paren
op_amp
id|icr
suffix:semicolon
multiline_comment|/* Mask out the interesting ones */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
r_if
c_cond
(paren
id|isr
)paren
(brace
multiline_comment|/* Dispatch interrupt handler for the current speed */
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
id|PIO_MAX_SPEED
)paren
id|icr
op_assign
id|w83977af_fir_interrupt
c_func
(paren
id|self
comma
id|isr
)paren
suffix:semicolon
r_else
id|icr
op_assign
id|w83977af_sir_interrupt
c_func
(paren
id|self
comma
id|isr
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|icr
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
multiline_comment|/* Restore (new) interrupts */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
)brace
multiline_comment|/*&n; * Function w83977af_is_receiving (self)&n; *&n; *    Return TRUE is we are currently receiving a frame&n; *&n; */
DECL|function|w83977af_is_receiving
r_static
r_int
id|w83977af_is_receiving
c_func
(paren
r_struct
id|w83977af_ir
op_star
id|self
)paren
(brace
r_int
id|status
op_assign
id|FALSE
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|FALSE
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Check if rx FIFO is not empty */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|RXFDTH
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* We are receiving something */
id|status
op_assign
id|TRUE
suffix:semicolon
)brace
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
)brace
r_else
id|status
op_assign
(paren
id|self-&gt;rx_buff.state
op_ne
id|OUTSIDE_FRAME
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_net_init (dev)&n; *&n; *    &n; *&n; */
DECL|function|w83977af_net_init
r_static
r_int
id|w83977af_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set up to be a normal IrDA network device driver */
id|irda_device_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Insert overrides below this line! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_net_open (dev)&n; *&n; *    Start the device&n; *&n; */
DECL|function|w83977af_net_open
r_static
r_int
id|w83977af_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|w83977af_ir
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|w83977af_ir
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|w83977af_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always allocate the DMA channel after the IRQ,&n;&t; * and clean up on failure.&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|dev-&gt;name
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|self
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Enable some interrupts so we can receive frames again */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
id|outb
c_func
(paren
id|ICR_EFSFI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
id|w83977af_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|ICR_ERBRI
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Open new IrLAP layer instance, now that everything should be&n;&t; * initialized properly &n;&t; */
id|self-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_net_close (dev)&n; *&n; *    Stop the device&n; *&n; */
DECL|function|w83977af_net_close
r_static
r_int
id|w83977af_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|w83977af_ir
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|set
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|w83977af_ir
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Save current set */
id|set
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|SET0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|ICR
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|set
comma
id|iobase
op_plus
id|SSR
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function w83977af_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
DECL|function|w83977af_net_ioctl
r_static
r_int
id|w83977af_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|w83977af_ir
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|w83977af_change_speed
c_func
(paren
id|self
comma
id|irq-&gt;ifr_baudrate
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|irq-&gt;ifr_receiving
op_assign
id|w83977af_is_receiving
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|w83977af_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|w83977af_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|w83977af_ir
op_star
id|self
op_assign
(paren
r_struct
id|w83977af_ir
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|self-&gt;stats
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dag Brattli &lt;dagb@cs.uit.no&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Winbond W83977AF IrDA Device Driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|qos_mtt_bits
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qos_mtt_bits
comma
l_string|&quot;Mimimum Turn Time&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;Base I/O addresses&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;IRQ lines&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Function init_module (void)&n; *&n; *    &n; *&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|w83977af_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function cleanup_module (void)&n; *&n; *    &n; *&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|w83977af_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
