multiline_comment|/*********************************************************************&n; *                &n; * Filename:      nsc-ircc.c&n; * Version:       1.0&n; * Description:   Driver for the NSC PC&squot;108 and PC&squot;338 IrDA chipsets&n; * Status:        Stable.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sat Nov  7 21:43:15 1998&n; * Modified at:   Wed Mar  1 11:29:34 2000&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998-2000 Dag Brattli &lt;dagb@cs.uit.no&gt;&n; *     Copyright (c) 1998 Lichen Wang, &lt;lwang@actisys.com&gt;&n; *     Copyright (c) 1998 Actisys Corp., www.actisys.com&n; *     All Rights Reserved&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; *     Notice that all functions that needs to access the chip in _any_&n; *     way, must save BSR register on entry, and restore it on exit. &n; *     It is _very_ important to follow this policy!&n; *&n; *         __u8 bank;&n; *     &n; *         bank = inb(iobase+BSR);&n; *  &n; *         do_your_stuff_here();&n; *&n; *         outb(bank, iobase+BSR);&n; *&n; *    If you find bugs in this file, its very likely that the same bug&n; *    will also be in w83977af_ir.c since the implementations are quite&n; *    similar.&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irlap_frame.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/nsc-ircc.h&gt;
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT 8
DECL|macro|BROKEN_DONGLE_ID
mdefine_line|#define BROKEN_DONGLE_ID
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;nsc-ircc&quot;
suffix:semicolon
multiline_comment|/* Module parameters */
DECL|variable|qos_mtt_bits
r_static
r_int
id|qos_mtt_bits
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 1 ms or more */
DECL|variable|dongle_id
r_static
r_int
id|dongle_id
suffix:semicolon
multiline_comment|/* Use BIOS settions by default, but user may supply module parameters */
DECL|variable|io
r_static
r_int
r_int
id|io
(braket
)braket
op_assign
(brace
op_complement
l_int|0
comma
op_complement
l_int|0
comma
op_complement
l_int|0
comma
op_complement
l_int|0
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
r_int
id|irq
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|dma
r_static
r_int
r_int
id|dma
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_static
r_int
id|nsc_ircc_probe_108
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_probe_338
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_init_108
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_init_338
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* These are the known NSC chips */
DECL|variable|chips
r_static
id|nsc_chip_t
id|chips
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;PC87108&quot;
comma
(brace
l_int|0x150
comma
l_int|0x398
comma
l_int|0xea
)brace
comma
l_int|0x05
comma
l_int|0x10
comma
l_int|0xf0
comma
id|nsc_ircc_probe_108
comma
id|nsc_ircc_init_108
)brace
comma
(brace
l_string|&quot;PC87338&quot;
comma
(brace
l_int|0x398
comma
l_int|0x15c
comma
l_int|0x2e
)brace
comma
l_int|0x08
comma
l_int|0xb0
comma
l_int|0xf0
comma
id|nsc_ircc_probe_338
comma
id|nsc_ircc_init_338
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Max 4 instances for now */
DECL|variable|dev_self
r_static
r_struct
id|nsc_ircc_cb
op_star
id|dev_self
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|dongle_types
r_static
r_char
op_star
id|dongle_types
(braket
)braket
op_assign
(brace
l_string|&quot;Differential serial interface&quot;
comma
l_string|&quot;Differential serial interface&quot;
comma
l_string|&quot;Reserved&quot;
comma
l_string|&quot;Reserved&quot;
comma
l_string|&quot;Sharp RY5HD01&quot;
comma
l_string|&quot;Reserved&quot;
comma
l_string|&quot;Single-ended serial interface&quot;
comma
l_string|&quot;Consumer-IR only&quot;
comma
l_string|&quot;HP HSDL-2300, HP HSDL-3600/HSDL-3610&quot;
comma
l_string|&quot;IBM31T1100 or Temic TFDS6000/TFDS6500&quot;
comma
l_string|&quot;Reserved&quot;
comma
l_string|&quot;Reserved&quot;
comma
l_string|&quot;HP HSDL-1100/HSDL-2100&quot;
comma
l_string|&quot;HP HSDL-1100/HSDL-2100&quot;
l_string|&quot;Supports SIR Mode only&quot;
comma
l_string|&quot;No dongle connected&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* Some prototypes */
r_static
r_int
id|nsc_ircc_open
c_func
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_int
id|nsc_ircc_close
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
r_static
r_int
id|nsc_ircc_setup
c_func
(paren
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|nsc_ircc_pio_receive
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_dma_receive
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_dma_receive_complete
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_hard_xmit_sir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_hard_xmit_fir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_pio_write
c_func
(paren
r_int
id|iobase
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|fifo_size
)paren
suffix:semicolon
r_static
r_void
id|nsc_ircc_dma_xmit
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|nsc_ircc_change_speed
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
id|__u32
id|baud
)paren
suffix:semicolon
r_static
r_void
id|nsc_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_is_receiving
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_read_dongle_id
(paren
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|nsc_ircc_init_dongle_interface
(paren
r_int
id|iobase
comma
r_int
id|dongle_id
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|nsc_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|nsc_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
multiline_comment|/*&n; * Function nsc_ircc_init ()&n; *&n; *    Initialize chip. Just try to find out how many chips we are dealing with&n; *    and where they are&n; */
DECL|function|nsc_ircc_init
r_int
id|__init
id|nsc_ircc_init
c_func
(paren
r_void
)paren
(brace
id|chipio_t
id|info
suffix:semicolon
id|nsc_chip_t
op_star
id|chip
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_int
id|cfg_base
suffix:semicolon
r_int
id|cfg
comma
id|id
suffix:semicolon
r_int
id|reg
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe for all the NSC chipsets we know about */
r_for
c_loop
(paren
id|chip
op_assign
id|chips
suffix:semicolon
id|chip-&gt;name
suffix:semicolon
id|chip
op_increment
comma
id|i
op_increment
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Probing for %s ...&bslash;n&quot;
comma
id|chip-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Try all config registers for this chip */
r_for
c_loop
(paren
id|cfg
op_assign
l_int|0
suffix:semicolon
id|cfg
OL
l_int|3
suffix:semicolon
id|cfg
op_increment
)paren
(brace
id|cfg_base
op_assign
id|chip-&gt;cfg
(braket
id|cfg
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cfg_base
)paren
r_continue
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|chipio_t
)paren
)paren
suffix:semicolon
id|info.cfg_base
op_assign
id|cfg_base
suffix:semicolon
id|info.fir_base
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
id|info.dma
op_assign
id|dma
(braket
id|i
)braket
suffix:semicolon
id|info.irq
op_assign
id|irq
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Read index register */
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0xff
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;() no chip at 0x%03x&bslash;n&quot;
comma
id|cfg_base
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Read chip identification register */
id|outb
c_func
(paren
id|chip-&gt;cid_index
comma
id|cfg_base
)paren
suffix:semicolon
id|id
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
id|chip-&gt;cid_mask
)paren
op_eq
id|chip-&gt;cid_value
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;() Found %s chip, revision=%d&bslash;n&quot;
comma
id|chip-&gt;name
comma
id|id
op_amp
op_complement
id|chip-&gt;cid_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t; * If the user supplies the base address, then&n;&t;&t;&t;&t; * we init the chip, if not we probe the values&n;&t;&t;&t;&t; * set by the BIOS&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|io
(braket
id|i
)braket
OL
l_int|2000
)paren
(brace
id|chip
op_member_access_from_pointer
id|init
c_func
(paren
id|chip
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
r_else
id|chip
op_member_access_from_pointer
id|probe
c_func
(paren
id|chip
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nsc_ircc_open
c_func
(paren
id|i
comma
op_amp
id|info
)paren
op_eq
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Wrong chip id=0x%02x&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_cleanup ()&n; *&n; *    Close all configured chips&n; *&n; */
macro_line|#ifdef MODULE
DECL|function|nsc_ircc_cleanup
r_static
r_void
id|nsc_ircc_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|pm_unregister_all
c_func
(paren
id|nsc_ircc_pmproc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|nsc_ircc_close
c_func
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Function nsc_ircc_open (iobase, irq)&n; *&n; *    Open driver instance&n; *&n; */
DECL|function|nsc_ircc_open
r_static
r_int
id|nsc_ircc_open
c_func
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nsc_ircc_setup
c_func
(paren
id|info
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Allocate new instance of the driver */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|nsc_ircc_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), can&squot;t allocate memory for &quot;
l_string|&quot;control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|nsc_ircc_cb
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Need to store self somewhere */
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
id|self-&gt;index
op_assign
id|i
suffix:semicolon
multiline_comment|/* Initialize IO */
id|self-&gt;io.cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
id|self-&gt;io.fir_base
op_assign
id|info-&gt;fir_base
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|info-&gt;irq
suffix:semicolon
id|self-&gt;io.fir_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.dma
op_assign
id|info-&gt;dma
suffix:semicolon
id|self-&gt;io.fifo_size
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Reserve the ioports that we need */
id|ret
op_assign
id|check_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
comma
id|driver_name
)paren
suffix:semicolon
multiline_comment|/* Initialize QoS for this device */
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* The only value we must override it the baudrate */
id|self-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
id|self-&gt;qos.min_turn_time.bits
op_assign
id|qos_mtt_bits
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;flags
op_assign
id|IFF_FIR
op_or
id|IFF_MIR
op_or
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
op_or
id|IFF_DONGLE
suffix:semicolon
multiline_comment|/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */
id|self-&gt;rx_buff.truesize
op_assign
l_int|14384
suffix:semicolon
id|self-&gt;tx_buff.truesize
op_assign
l_int|14384
suffix:semicolon
multiline_comment|/* Allocate memory if needed */
id|self-&gt;rx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;rx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;rx_buff.head
comma
l_int|0
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;tx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;tx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;tx_buff.head
comma
l_int|0
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;rx_buff.in_frame
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Reset Tx queue info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|dev_alloc
c_func
(paren
l_string|&quot;irda%d&quot;
comma
op_amp
id|err
)paren
)paren
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), dev_alloc() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Override the network functions we need to use */
id|dev-&gt;init
op_assign
id|nsc_ircc_net_init
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|nsc_ircc_hard_xmit_sir
suffix:semicolon
id|dev-&gt;open
op_assign
id|nsc_ircc_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|nsc_ircc_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|nsc_ircc_net_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|nsc_ircc_net_get_stats
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|register_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), register_netdev() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Check if user has supplied the dongle id or not */
r_if
c_cond
(paren
op_logical_neg
id|dongle_id
)paren
(brace
id|dongle_id
op_assign
id|nsc_ircc_read_dongle_id
c_func
(paren
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Found dongle: %s&bslash;n&quot;
comma
id|driver_name
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Using dongle: %s&bslash;n&quot;
comma
id|driver_name
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
)brace
id|self-&gt;io.dongle_id
op_assign
id|dongle_id
suffix:semicolon
id|nsc_ircc_init_dongle_interface
c_func
(paren
id|self-&gt;io.fir_base
comma
id|dongle_id
)paren
suffix:semicolon
id|pmdev
op_assign
id|pm_register
c_func
(paren
id|PM_SYS_DEV
comma
id|PM_SYS_IRDA
comma
id|nsc_ircc_pmproc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdev
)paren
id|pmdev-&gt;data
op_assign
id|self
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/*&n; * Function nsc_ircc_close (self)&n; *&n; *    Close driver instance&n; *&n; */
DECL|function|nsc_ircc_close
r_static
r_int
id|nsc_ircc_close
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Remove netdevice */
r_if
c_cond
(paren
id|self-&gt;netdev
)paren
(brace
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Release the PORT that this driver is using */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Releasing Region %03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|dev_self
(braket
id|self-&gt;index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Function nsc_ircc_init_108 (iobase, cfg_base, irq, dma)&n; *&n; *    Initialize the NSC &squot;108 chip&n; *&n; */
DECL|function|nsc_ircc_init_108
r_static
r_int
id|nsc_ircc_init_108
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_int
id|cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
id|__u8
id|temp
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
l_int|2
comma
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* Mode Control Register (MCTL) */
id|outb
c_func
(paren
l_int|0x00
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Disable device */
multiline_comment|/* Base Address and Interrupt Control Register (BAIC) */
id|outb
c_func
(paren
l_int|0
comma
id|cfg_base
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fir_base
)paren
(brace
r_case
l_int|0x3e8
suffix:colon
id|outb
c_func
(paren
l_int|0x14
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2e8
suffix:colon
id|outb
c_func
(paren
l_int|0x15
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3f8
suffix:colon
id|outb
c_func
(paren
l_int|0x16
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2f8
suffix:colon
id|outb
c_func
(paren
l_int|0x17
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), invalid base_address&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Control Signal Routing Register (CSRT) */
r_switch
c_cond
(paren
id|info-&gt;irq
)paren
(brace
r_case
l_int|3
suffix:colon
id|temp
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|temp
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|temp
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|temp
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|temp
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|temp
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|temp
op_assign
l_int|0x07
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), invalid irq&quot;
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|1
comma
id|cfg_base
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;dma
)paren
(brace
r_case
l_int|0
suffix:colon
id|outb
c_func
(paren
l_int|0x08
op_plus
id|temp
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|outb
c_func
(paren
l_int|0x10
op_plus
id|temp
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|outb
c_func
(paren
l_int|0x18
op_plus
id|temp
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), invalid dma&quot;
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|2
comma
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* Mode Control Register (MCTL) */
id|outb
c_func
(paren
l_int|0x03
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Enable device */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_probe_108 (chip, info)&n; *&n; *    &n; *&n; */
DECL|function|nsc_ircc_probe_108
r_static
r_int
id|nsc_ircc_probe_108
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_int
id|cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
r_int
id|reg
suffix:semicolon
multiline_comment|/* Read address and interrupt control register (BAIC) */
id|outb
c_func
(paren
id|CFG_BAIC
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|info-&gt;fir_base
op_assign
l_int|0x3e8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|info-&gt;fir_base
op_assign
l_int|0x2e8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|info-&gt;fir_base
op_assign
l_int|0x3f8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|info-&gt;fir_base
op_assign
l_int|0x2f8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|info-&gt;sir_base
op_assign
id|info-&gt;fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing fir_base=0x%03x&bslash;n&quot;
comma
id|info-&gt;fir_base
)paren
suffix:semicolon
multiline_comment|/* Read control signals routing register (CSRT) */
id|outb
c_func
(paren
id|CFG_CSRT
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg
op_amp
l_int|0x07
)paren
(brace
r_case
l_int|0
suffix:colon
id|info-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|info-&gt;irq
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|info-&gt;irq
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|info-&gt;irq
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|info-&gt;irq
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|info-&gt;irq
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|info-&gt;irq
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|info-&gt;irq
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing irq=%d&bslash;n&quot;
comma
id|info-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Currently we only read Rx DMA but it will also be used for Tx */
r_switch
c_cond
(paren
(paren
id|reg
op_rshift
l_int|3
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|info-&gt;dma
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|info-&gt;dma
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|info-&gt;dma
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|info-&gt;dma
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing dma=%d&bslash;n&quot;
comma
id|info-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* Read mode control register (MCTL) */
id|outb
c_func
(paren
id|CFG_MCTL
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;enabled
op_assign
id|reg
op_amp
l_int|0x01
suffix:semicolon
id|info-&gt;suspended
op_assign
op_logical_neg
(paren
(paren
id|reg
op_rshift
l_int|1
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_init_338 (chip, info)&n; *&n; *    Initialize the NSC &squot;338 chip. Remember that the 87338 needs two &n; *    consecutive writes to the data registers while CPU interrupts are&n; *    disabled. The 97338 does not require this, but shouldn&squot;t be any&n; *    harm if we do it anyway.&n; */
DECL|function|nsc_ircc_init_338
r_static
r_int
id|nsc_ircc_init_338
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
multiline_comment|/* No init yet */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_probe_338 (chip, info)&n; *&n; *    &n; *&n; */
DECL|function|nsc_ircc_probe_338
r_static
r_int
id|nsc_ircc_probe_338
c_func
(paren
id|nsc_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_int
id|cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
r_int
id|reg
comma
id|com
op_assign
l_int|0
suffix:semicolon
r_int
id|pnp
suffix:semicolon
multiline_comment|/* Read funtion enable register (FER) */
id|outb
c_func
(paren
id|CFG_FER
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;enabled
op_assign
(paren
id|reg
op_rshift
l_int|2
)paren
op_amp
l_int|0x01
suffix:semicolon
multiline_comment|/* Check if we are in Legacy or PnP mode */
id|outb
c_func
(paren
id|CFG_PNP0
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|pnp
op_assign
(paren
id|reg
op_rshift
l_int|4
)paren
op_amp
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|pnp
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;(), Chip is in PnP mode&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x46
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
op_amp
l_int|0xfe
)paren
op_lshift
l_int|2
suffix:semicolon
id|outb
c_func
(paren
l_int|0x47
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_or_assign
(paren
(paren
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
op_amp
l_int|0xfc
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|info-&gt;fir_base
op_assign
id|reg
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Read function address register (FAR) */
id|outb
c_func
(paren
id|CFG_FAR
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|reg
op_rshift
l_int|4
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|info-&gt;fir_base
op_assign
l_int|0x3f8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|info-&gt;fir_base
op_assign
l_int|0x2f8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|com
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|com
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|com
)paren
(brace
r_switch
c_cond
(paren
(paren
id|reg
op_rshift
l_int|6
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|com
op_eq
l_int|3
)paren
id|info-&gt;fir_base
op_assign
l_int|0x3e8
suffix:semicolon
r_else
id|info-&gt;fir_base
op_assign
l_int|0x2e8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|com
op_eq
l_int|3
)paren
id|info-&gt;fir_base
op_assign
l_int|0x338
suffix:semicolon
r_else
id|info-&gt;fir_base
op_assign
l_int|0x238
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|com
op_eq
l_int|3
)paren
id|info-&gt;fir_base
op_assign
l_int|0x2e8
suffix:semicolon
r_else
id|info-&gt;fir_base
op_assign
l_int|0x2e0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|com
op_eq
l_int|3
)paren
id|info-&gt;fir_base
op_assign
l_int|0x220
suffix:semicolon
r_else
id|info-&gt;fir_base
op_assign
l_int|0x228
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|info-&gt;sir_base
op_assign
id|info-&gt;fir_base
suffix:semicolon
multiline_comment|/* Read PnP register 1 (PNP1) */
id|outb
c_func
(paren
id|CFG_PNP1
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;irq
op_assign
id|reg
op_rshift
l_int|4
suffix:semicolon
multiline_comment|/* Read PnP register 3 (PNP3) */
id|outb
c_func
(paren
id|CFG_PNP3
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;dma
op_assign
(paren
id|reg
op_amp
l_int|0x07
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Read power and test register (PTR) */
id|outb
c_func
(paren
id|CFG_PTR
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;suspended
op_assign
id|reg
op_amp
l_int|0x01
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_setup (info)&n; *&n; *    Returns non-negative on success.&n; *&n; */
DECL|function|nsc_ircc_setup
r_static
r_int
id|nsc_ircc_setup
c_func
(paren
id|chipio_t
op_star
id|info
)paren
(brace
r_int
id|version
suffix:semicolon
r_int
id|iobase
op_assign
id|info-&gt;fir_base
suffix:semicolon
multiline_comment|/* Read the Module ID */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK3
)paren
suffix:semicolon
id|version
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|MID
)paren
suffix:semicolon
multiline_comment|/* Should be 0x2? */
r_if
c_cond
(paren
l_int|0x20
op_ne
(paren
id|version
op_amp
l_int|0xf0
)paren
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s, Wrong chip version %02x&bslash;n&quot;
comma
id|driver_name
comma
id|version
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Found chip at base=0x%03x&bslash;n&quot;
comma
id|driver_name
comma
id|info-&gt;cfg_base
)paren
suffix:semicolon
multiline_comment|/* Switch to advanced mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ECR1_EXT_SL
comma
id|iobase
op_plus
id|ECR1
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
multiline_comment|/* Set FIFO threshold to TX17, RX16, reset and enable FIFO&squot;s */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FCR_RXTH
op_or
id|FCR_TXTH
op_or
id|FCR_TXSR
op_or
id|FCR_RXSR
op_or
id|FCR_FIFO_EN
comma
id|iobase
op_plus
id|FCR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x03
comma
id|iobase
op_plus
id|LCR
)paren
suffix:semicolon
multiline_comment|/* 8 bit word length */
id|outb
c_func
(paren
id|MCR_SIR
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
multiline_comment|/* Start at SIR-mode, also clears LSR*/
multiline_comment|/* Set FIFO size to 32 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EXCR2_RFSIZ
op_or
id|EXCR2_TFSIZ
comma
id|iobase
op_plus
id|EXCR2
)paren
suffix:semicolon
multiline_comment|/* IRCR2: FEND_MD is not set */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Make sure that some defaults are OK */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK6
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x20
comma
id|iobase
op_plus
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set 32 bits FIR CRC */
id|outb
c_func
(paren
l_int|0x0a
comma
id|iobase
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set MIR pulse width */
id|outb
c_func
(paren
l_int|0x0d
comma
id|iobase
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Set SIR pulse width to 1.6us */
id|outb
c_func
(paren
l_int|0x2a
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Set beginning frag, and preamble length */
id|MESSAGE
c_func
(paren
l_string|&quot;%s, driver loaded (Dag Brattli)&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
multiline_comment|/* Enable receive interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IER_RXHDL_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_read_dongle_id (void)&n; *&n; * Try to read dongle indentification. This procedure needs to be executed&n; * once after power-on/reset. It also needs to be used whenever you suspect&n; * that the user may have plugged/unplugged the IrDA Dongle.&n; */
DECL|function|nsc_ircc_read_dongle_id
r_static
r_int
id|nsc_ircc_read_dongle_id
(paren
r_int
id|iobase
)paren
(brace
r_int
id|dongle_id
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Select Bank 7 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK7
)paren
suffix:semicolon
multiline_comment|/* IRCFG4: IRSL0_DS and IRSL21_DS are cleared */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* ID0, 1, and 2 are pulled up/down very slowly */
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* IRCFG1: read the ID bits */
id|dongle_id
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
macro_line|#ifdef BROKEN_DONGLE_ID
r_if
c_cond
(paren
id|dongle_id
op_eq
l_int|0x0a
)paren
id|dongle_id
op_assign
l_int|0x09
suffix:semicolon
macro_line|#endif&t;
multiline_comment|/* Go back to  bank 0 before returning */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
id|dongle_id
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_init_dongle_interface (iobase, dongle_id)&n; *&n; *     This function initializes the dongle for the transceiver that is&n; *     used. This procedure needs to be executed once after&n; *     power-on/reset. It also needs to be used whenever you suspect that&n; *     the dongle is changed. &n; */
DECL|function|nsc_ircc_init_dongle_interface
r_static
r_void
id|nsc_ircc_init_dongle_interface
(paren
r_int
id|iobase
comma
r_int
id|dongle_id
)paren
(brace
r_int
id|bank
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Select Bank 7 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK7
)paren
suffix:semicolon
multiline_comment|/* IRCFG4: set according to dongle_id */
r_switch
c_cond
(paren
id|dongle_id
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Differential serial interface */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* Reserved */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Sharp RY5HD01 */
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
multiline_comment|/* Reserved, but this is what the Thinkpad reports */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* Single-ended serial interface */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
multiline_comment|/* Consumer-IR only */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s is not for IrDA mode&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* HP HSDL-2300, HP HSDL-3600/HSDL-3610 */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
multiline_comment|/* IBM31T1100 or Temic TFDS6000/TFDS6500 */
id|outb
c_func
(paren
l_int|0x28
comma
id|iobase
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Set irsl[0-2] as output */
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x0B
suffix:colon
multiline_comment|/* Reserved */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x0D
suffix:colon
multiline_comment|/* HP HSDL-1100/HSDL-2100 */
multiline_comment|/* &n;&t;&t; * Set irsl0 as input, irsl[1-2] as output, and separate &n;&t;&t; * inputs are used for SIR and MIR/FIR &n;&t;&t; */
id|outb
c_func
(paren
l_int|0x48
comma
id|iobase
op_plus
l_int|7
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
multiline_comment|/* Supports SIR Mode only */
id|outb
c_func
(paren
l_int|0x28
comma
id|iobase
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Set irsl[0-2] as output */
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
multiline_comment|/* No dongle connected */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x62
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), invalid dongle_id %#x&quot;
comma
id|dongle_id
)paren
suffix:semicolon
)brace
multiline_comment|/* IRCFG1: IRSL1 and 2 are set to IrDA mode */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
)brace
multiline_comment|/* set_up_dongle_interface */
multiline_comment|/*&n; * Function nsc_ircc_change_dongle_speed (iobase, speed, dongle_id)&n; *&n; *    Change speed of the attach dongle&n; *&n; */
DECL|function|nsc_ircc_change_dongle_speed
r_static
r_void
id|nsc_ircc_change_dongle_speed
c_func
(paren
r_int
id|iobase
comma
r_int
id|speed
comma
r_int
id|dongle_id
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Select Bank 7 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK7
)paren
suffix:semicolon
multiline_comment|/* IRCFG1: set according to dongle_id */
r_switch
c_cond
(paren
id|dongle_id
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Differential serial interface */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* Reserved */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Sharp RY5HD01 */
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
multiline_comment|/* Reserved */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* Single-ended serial interface */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
multiline_comment|/* Consumer-IR only */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s is not for IrDA mode&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* HP HSDL-2300, HP HSDL-3600/HSDL-3610 */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|115200
)paren
id|outb
c_func
(paren
l_int|0x01
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
multiline_comment|/* IBM31T1100 or Temic TFDS6000/TFDS6500 */
id|outb
c_func
(paren
l_int|0x01
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|4000000
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x81
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x80
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x0B
suffix:colon
multiline_comment|/* Reserved */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s not defined by irda yet&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
multiline_comment|/* same as */
r_case
l_int|0x0D
suffix:colon
multiline_comment|/* HP HSDL-1100/HSDL-2100 */
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
multiline_comment|/* Supports SIR Mode only */
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
multiline_comment|/* No dongle connected */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), %s is not for IrDA mode&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x62
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), invalid data_rate&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_change_speed (self, baud)&n; *&n; *    Change the speed of the device&n; *&n; */
DECL|function|nsc_ircc_change_speed
r_static
r_void
id|nsc_ircc_change_speed
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
id|__u32
id|speed
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|__u8
id|mcr
op_assign
id|MCR_SIR
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), speed=%d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Select Bank 2 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|BGDH
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|9600
suffix:colon
id|outb
c_func
(paren
l_int|0x0c
comma
id|iobase
op_plus
id|BGDL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|outb
c_func
(paren
l_int|0x06
comma
id|iobase
op_plus
id|BGDL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|outb
c_func
(paren
l_int|0x03
comma
id|iobase
op_plus
id|BGDL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|outb
c_func
(paren
l_int|0x02
comma
id|iobase
op_plus
id|BGDL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|outb
c_func
(paren
l_int|0x01
comma
id|iobase
op_plus
id|BGDL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|576000
suffix:colon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK5
)paren
suffix:semicolon
multiline_comment|/* IRCR2: MDRS is set */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
l_int|4
)paren
op_or
l_int|0x04
comma
id|iobase
op_plus
l_int|4
)paren
suffix:semicolon
id|mcr
op_assign
id|MCR_MIR
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 576000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|mcr
op_assign
id|MCR_MIR
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 1152000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|mcr
op_assign
id|MCR_FIR
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 4000000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mcr
op_assign
id|MCR_FIR
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unknown baud rate of %d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Set appropriate speed mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mcr
op_or
id|MCR_TX_DFR
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
multiline_comment|/* Give some hits to the transceiver */
id|nsc_ircc_change_dongle_speed
c_func
(paren
id|iobase
comma
id|speed
comma
id|self-&gt;io.dongle_id
)paren
suffix:semicolon
multiline_comment|/* Set FIFO threshold to TX17, RX16 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|FCR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FCR_FIFO_EN
comma
id|iobase
op_plus
id|FCR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FCR_RXTH
op_or
multiline_comment|/* Set Rx FIFO threshold */
id|FCR_TXTH
op_or
multiline_comment|/* Set Tx FIFO threshold */
id|FCR_TXSR
op_or
multiline_comment|/* Reset Tx FIFO */
id|FCR_RXSR
op_or
multiline_comment|/* Reset Rx FIFO */
id|FCR_FIFO_EN
comma
multiline_comment|/* Enable FIFOs */
id|iobase
op_plus
id|FCR
)paren
suffix:semicolon
multiline_comment|/* Set FIFO size to 32 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EXCR2_RFSIZ
op_or
id|EXCR2_TFSIZ
comma
id|iobase
op_plus
id|EXCR2
)paren
suffix:semicolon
multiline_comment|/* Enable some interrupts so we can receive frames */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|115200
)paren
(brace
multiline_comment|/* Install FIR xmit handler */
id|dev-&gt;hard_start_xmit
op_assign
id|nsc_ircc_hard_xmit_fir
suffix:semicolon
id|outb
c_func
(paren
id|IER_SFIF_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
id|nsc_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Install SIR xmit handler */
id|dev-&gt;hard_start_xmit
op_assign
id|nsc_ircc_hard_xmit_sir
suffix:semicolon
id|outb
c_func
(paren
id|IER_RXHDL_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore BSR */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_hard_xmit (skb, dev)&n; *&n; *    Transmit the frame!&n; *&n; */
DECL|function|nsc_ircc_hard_xmit_sir
r_static
r_int
id|nsc_ircc_hard_xmit_sir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
(paren
id|speed
op_assign
id|irda_get_speed
c_func
(paren
id|skb
)paren
)paren
op_ne
id|self-&gt;io.speed
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|nsc_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;tx_buff.len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|self-&gt;tx_buff.len
suffix:semicolon
multiline_comment|/* Add interrupt on tx low level (will fire immediately) */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IER_TXLDL_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|nsc_ircc_hard_xmit_fir
r_static
r_int
id|nsc_ircc_hard_xmit_fir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
r_int
id|mtt
comma
id|diff
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
(paren
id|speed
op_assign
id|irda_get_speed
c_func
(paren
id|skb
)paren
)paren
op_ne
id|self-&gt;io.speed
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|nsc_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Register and copy this frame to DMA memory */
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|start
op_assign
id|self-&gt;tx_fifo.tail
suffix:semicolon
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|start
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|self-&gt;tx_fifo.len
op_increment
suffix:semicolon
id|self-&gt;tx_fifo.free
op_increment
suffix:semicolon
multiline_comment|/* Start transmit only if there is currently no transmit going on */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.len
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Check if we must wait the min turn time or not */
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
(brace
multiline_comment|/* Check how much time we have used already */
id|get_fast_time
c_func
(paren
op_amp
id|self-&gt;now
)paren
suffix:semicolon
id|diff
op_assign
id|self-&gt;now.tv_usec
op_minus
id|self-&gt;stamp.tv_usec
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
l_int|0
)paren
id|diff
op_add_assign
l_int|1000000
suffix:semicolon
multiline_comment|/* Check if the mtt is larger than the time we have&n;&t;&t;&t; * already used by all the protocol processing&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mtt
OG
id|diff
)paren
(brace
id|mtt
op_sub_assign
id|diff
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t; * Use timer if delay larger than 125 us, and&n;&t;&t;&t;&t; * use udelay for smaller values which should&n;&t;&t;&t;&t; * be acceptable&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mtt
OG
l_int|125
)paren
(brace
multiline_comment|/* Adjust for timer resolution */
id|mtt
op_assign
id|mtt
op_div
l_int|125
suffix:semicolon
multiline_comment|/* Setup timer */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mtt
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|TMRL
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|mtt
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
comma
id|iobase
op_plus
id|TMRH
)paren
suffix:semicolon
multiline_comment|/* Start timer */
id|outb
c_func
(paren
id|IRCR1_TMR_EN
comma
id|iobase
op_plus
id|IRCR1
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Enable timer interrupt */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IER_TMR_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Timer will take care of the rest */
r_goto
id|out
suffix:semicolon
)brace
r_else
id|udelay
c_func
(paren
id|mtt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Enable DMA interrupt */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IER_DMA_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Transmit frame */
id|nsc_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
)brace
id|out
suffix:colon
multiline_comment|/* Not busy transmitting anymore if window is not full */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.free
OL
id|MAX_TX_WINDOW
)paren
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_dma_xmit (self, iobase)&n; *&n; *    Transmit data using DMA&n; *&n; */
DECL|function|nsc_ircc_dma_xmit
r_static
r_void
id|nsc_ircc_dma_xmit
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_int
id|bsr
suffix:semicolon
multiline_comment|/* Save current bank */
id|bsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|MCR
)paren
op_amp
op_complement
id|MCR_DMA_EN
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Choose transmit DMA channel  */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ECR1_DMASWP
op_or
id|ECR1_DMANF
op_or
id|ECR1_EXT_SL
comma
id|iobase
op_plus
id|ECR1
)paren
suffix:semicolon
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|start
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
multiline_comment|/* Enable DMA and SIR interaction pulse */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|MCR
)paren
op_or
id|MCR_TX_DFR
op_or
id|MCR_DMA_EN
op_or
id|MCR_IR_PLS
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bsr
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_pio_xmit (self, iobase)&n; *&n; *    Transmit data using PIO. Returns the number of bytes that actually&n; *    got transfered&n; *&n; */
DECL|function|nsc_ircc_pio_write
r_static
r_int
id|nsc_ircc_pio_write
c_func
(paren
r_int
id|iobase
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|fifo_size
)paren
(brace
r_int
id|actual
op_assign
l_int|0
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb_p
c_func
(paren
id|iobase
op_plus
id|LSR
)paren
op_amp
id|LSR_TXEMP
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), warning, FIFO not empty yet!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIFO may still be filled to the Tx interrupt threshold */
id|fifo_size
op_sub_assign
l_int|17
suffix:semicolon
)brace
multiline_comment|/* Fill FIFO with current frame */
r_while
c_loop
(paren
(paren
id|fifo_size
op_decrement
OG
l_int|0
)paren
op_logical_and
(paren
id|actual
OL
id|len
)paren
)paren
(brace
multiline_comment|/* Transmit next byte */
id|outb
c_func
(paren
id|buf
(braket
id|actual
op_increment
)braket
comma
id|iobase
op_plus
id|TXD
)paren
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), fifo_size %d ; %d sent of %d&bslash;n&quot;
comma
id|fifo_size
comma
id|actual
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Restore bank */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
id|actual
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_dma_xmit_complete (self)&n; *&n; *    The transfer of a frame in finished. This function will only be called &n; *    by the interrupt handler&n; *&n; */
DECL|function|nsc_ircc_dma_xmit_complete
r_static
r_int
id|nsc_ircc_dma_xmit_complete
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
r_int
id|ret
op_assign
id|TRUE
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|MCR
)paren
op_amp
op_complement
id|MCR_DMA_EN
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
multiline_comment|/* Check for underrrun! */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|ASCR
)paren
op_amp
id|ASCR_TXUR
)paren
(brace
id|self-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
multiline_comment|/* Clear bit, by writing 1 into it */
id|outb
c_func
(paren
id|ASCR_TXUR
comma
id|iobase
op_plus
id|ASCR
)paren
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|nsc_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Finished with this frame, so prepare for next */
id|self-&gt;tx_fifo.ptr
op_increment
suffix:semicolon
id|self-&gt;tx_fifo.len
op_decrement
suffix:semicolon
multiline_comment|/* Any frames to be sent back-to-back? */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.len
)paren
(brace
id|nsc_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
multiline_comment|/* Not finished yet! */
id|ret
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset Tx FIFO info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
)brace
multiline_comment|/* Make sure we have room for more frames */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.free
OL
id|MAX_TX_WINDOW
)paren
(brace
multiline_comment|/* Not busy transmitting anymore */
multiline_comment|/* Tell the network layer, that we can accept more frames */
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore bank */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_dma_receive (self)&n; *&n; *    Get ready for receiving a frame. The device will initiate a DMA&n; *    if it starts to receive a frame.&n; *&n; */
DECL|function|nsc_ircc_dma_receive
r_static
r_int
id|nsc_ircc_dma_receive
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|__u8
id|bsr
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Reset Tx FIFO info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
multiline_comment|/* Save current bank */
id|bsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|MCR
)paren
op_amp
op_complement
id|MCR_DMA_EN
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
multiline_comment|/* Choose DMA Rx, DMA Fairness, and Advanced mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ECR1_DMANF
op_or
id|ECR1_EXT_SL
comma
id|iobase
op_plus
id|ECR1
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Reset Rx FIFO. This will also flush the ST_FIFO */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FCR_RXSR
op_or
id|FCR_FIFO_EN
comma
id|iobase
op_plus
id|FCR
)paren
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
id|self-&gt;st_fifo.pending_bytes
op_assign
l_int|0
suffix:semicolon
id|self-&gt;st_fifo.tail
op_assign
id|self-&gt;st_fifo.head
op_assign
l_int|0
suffix:semicolon
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;rx_buff.data
comma
id|self-&gt;rx_buff.truesize
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Enable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|MCR
)paren
op_or
id|MCR_DMA_EN
comma
id|iobase
op_plus
id|MCR
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bsr
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_dma_receive_complete (self)&n; *&n; *    Finished with receiving frames&n; *&n; *    &n; */
DECL|function|nsc_ircc_dma_receive_complete
r_static
r_int
id|nsc_ircc_dma_receive_complete
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_struct
id|st_fifo
op_star
id|st_fifo
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
id|status
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
r_int
id|len
suffix:semicolon
id|st_fifo
op_assign
op_amp
id|self-&gt;st_fifo
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Read all entries in status FIFO */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK5
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FRM_ST
)paren
)paren
op_amp
id|FRM_ST_VLD
)paren
(brace
multiline_comment|/* We must empty the status FIFO no matter what */
id|len
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|RFLFL
)paren
op_or
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|RFLFH
)paren
op_amp
l_int|0x1f
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_fifo-&gt;tail
op_ge
id|MAX_RX_WINDOW
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), window is full!&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_add_assign
id|len
suffix:semicolon
id|st_fifo-&gt;tail
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
)brace
multiline_comment|/* Try to process all entries in status FIFO */
r_while
c_loop
(paren
id|st_fifo-&gt;len
OG
l_int|0
)paren
(brace
multiline_comment|/* Get first entry */
id|status
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
suffix:semicolon
id|len
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_sub_assign
id|len
suffix:semicolon
id|st_fifo-&gt;head
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_decrement
suffix:semicolon
multiline_comment|/* Check for errors */
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_ERR_MSK
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_LOST_FR
)paren
(brace
multiline_comment|/* Add number of lost frames to stats */
id|self-&gt;stats.rx_errors
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Skip frame */
id|self-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_MAX_LEN
)paren
id|self-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_PHY_ERR
)paren
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_BAD_CRC
)paren
id|self-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* The errors below can be reported in both cases */
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_OVR1
)paren
id|self-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FRM_ST_OVR2
)paren
id|self-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*  &n;&t;&t;&t; * First we must make sure that the frame we&n;&t;&t;&t; * want to deliver is all in main memory. If we&n;&t;&t;&t; * cannot tell, then we check if the Rx FIFO is&n;&t;&t;&t; * empty. If not then we will have to take a nap&n;&t;&t;&t; * and try again later.  &n;&t;&t;&t; */
r_if
c_cond
(paren
id|st_fifo-&gt;pending_bytes
OL
id|self-&gt;io.fifo_size
)paren
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|LSR
)paren
op_amp
id|LSR_RXDA
)paren
(brace
multiline_comment|/* Put this entry back in fifo */
id|st_fifo-&gt;head
op_decrement
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_add_assign
id|len
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
multiline_comment|/*  &n;&t;&t;&t;&t;&t; * DMA not finished yet, so try again &n;&t;&t;&t;&t;&t; * later, set timer value, resolution &n;&t;&t;&t;&t;&t; * 125 us &n;&t;&t;&t;&t;&t; */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
id|iobase
op_plus
id|TMRL
)paren
suffix:semicolon
multiline_comment|/* x 125 us */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|TMRH
)paren
suffix:semicolon
multiline_comment|/* Start timer */
id|outb
c_func
(paren
id|IRCR1_TMR_EN
comma
id|iobase
op_plus
id|IRCR1
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* I&squot;ll be back! */
)brace
)brace
multiline_comment|/* &n;&t;&t;&t; * Remember the time we received this frame, so we can&n;&t;&t;&t; * reduce the min turn time a bit since we will know&n;&t;&t;&t; * how much time we have used for protocol processing&n;&t;&t;&t; */
id|get_fast_time
c_func
(paren
op_amp
id|self-&gt;stamp
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), memory squeeze, &quot;
l_string|&quot;dropping frame.&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;stats.rx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* Make sure IP header gets aligned */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Copy frame without CRC */
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|4000000
)paren
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Move to next frame */
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_pio_receive (self)&n; *&n; *    Receive all data in receiver FIFO&n; *&n; */
DECL|function|nsc_ircc_pio_receive
r_static
r_void
id|nsc_ircc_pio_receive
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
id|__u8
id|byte
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/*  Receive all characters in Rx FIFO */
r_do
(brace
id|byte
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|RXD
)paren
suffix:semicolon
id|async_unwrap_char
c_func
(paren
id|self-&gt;netdev
comma
op_amp
id|self-&gt;stats
comma
op_amp
id|self-&gt;rx_buff
comma
id|byte
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|LSR
)paren
op_amp
id|LSR_RXDA
)paren
suffix:semicolon
multiline_comment|/* Data available */
)brace
multiline_comment|/*&n; * Function nsc_ircc_sir_interrupt (self, eir)&n; *&n; *    Handle SIR interrupt&n; *&n; */
DECL|function|nsc_ircc_sir_interrupt
r_static
r_void
id|nsc_ircc_sir_interrupt
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
r_int
id|eir
)paren
(brace
r_int
id|actual
suffix:semicolon
multiline_comment|/* Check if transmit FIFO is low on data */
r_if
c_cond
(paren
id|eir
op_amp
id|EIR_TXLDL_EV
)paren
(brace
multiline_comment|/* Write data left in transmit buffer */
id|actual
op_assign
id|nsc_ircc_pio_write
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
comma
id|self-&gt;io.fifo_size
)paren
suffix:semicolon
id|self-&gt;tx_buff.data
op_add_assign
id|actual
suffix:semicolon
id|self-&gt;tx_buff.len
op_sub_assign
id|actual
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Check if finished */
r_if
c_cond
(paren
id|self-&gt;tx_buff.len
OG
l_int|0
)paren
id|self-&gt;ier
op_assign
id|IER_TXLDL_IE
suffix:semicolon
r_else
(brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_TXEMP_IE
suffix:semicolon
)brace
)brace
multiline_comment|/* Check if transmission has completed */
r_if
c_cond
(paren
id|eir
op_amp
id|EIR_TXEMP_EV
)paren
(brace
multiline_comment|/* Check if we need to change the speed? */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Changing speed!&bslash;n&quot;
)paren
suffix:semicolon
id|nsc_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check if we are going to FIR */
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
multiline_comment|/* Should wait for status FIFO interrupt */
id|self-&gt;ier
op_assign
id|IER_SFIF_IE
suffix:semicolon
multiline_comment|/* No need to do anymore SIR stuff */
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Turn around and get ready to receive some data */
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_RXHDL_IE
suffix:semicolon
)brace
multiline_comment|/* Rx FIFO threshold or timeout */
r_if
c_cond
(paren
id|eir
op_amp
id|EIR_RXHDL_EV
)paren
(brace
id|nsc_ircc_pio_receive
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Keep receiving */
id|self-&gt;ier
op_assign
id|IER_RXHDL_IE
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function nsc_ircc_fir_interrupt (self, eir)&n; *&n; *    Handle MIR/FIR interrupt&n; *&n; */
DECL|function|nsc_ircc_fir_interrupt
r_static
r_void
id|nsc_ircc_fir_interrupt
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
comma
r_int
id|eir
)paren
(brace
id|__u8
id|bank
suffix:semicolon
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Status FIFO event*/
r_if
c_cond
(paren
id|eir
op_amp
id|EIR_SFIF_EV
)paren
(brace
multiline_comment|/* Check if DMA has finished */
r_if
c_cond
(paren
id|nsc_ircc_dma_receive_complete
c_func
(paren
id|self
comma
id|iobase
)paren
)paren
(brace
multiline_comment|/* Wait for next status FIFO interrupt */
id|self-&gt;ier
op_assign
id|IER_SFIF_IE
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;ier
op_assign
id|IER_SFIF_IE
op_or
id|IER_TMR_IE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|eir
op_amp
id|EIR_TMR_EV
)paren
(brace
multiline_comment|/* Timer finished */
multiline_comment|/* Disable timer */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCR1
)paren
suffix:semicolon
multiline_comment|/* Clear timer event */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ASCR_CTE
comma
id|iobase
op_plus
id|ASCR
)paren
suffix:semicolon
multiline_comment|/* Check if this is a Tx timer interrupt */
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_XMIT
)paren
(brace
id|nsc_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
multiline_comment|/* Interrupt on DMA */
id|self-&gt;ier
op_assign
id|IER_DMA_IE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check (again) if DMA has finished */
r_if
c_cond
(paren
id|nsc_ircc_dma_receive_complete
c_func
(paren
id|self
comma
id|iobase
)paren
)paren
(brace
id|self-&gt;ier
op_assign
id|IER_SFIF_IE
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;ier
op_assign
id|IER_SFIF_IE
op_or
id|IER_TMR_IE
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|eir
op_amp
id|EIR_DMA_EV
)paren
(brace
multiline_comment|/* Finished with all transmissions? */
r_if
c_cond
(paren
id|nsc_ircc_dma_xmit_complete
c_func
(paren
id|self
)paren
)paren
(brace
multiline_comment|/* Check if there are more frames to be transmitted */
r_if
c_cond
(paren
id|irda_device_txqueue_empty
c_func
(paren
id|self-&gt;netdev
)paren
)paren
(brace
multiline_comment|/* Prepare for receive */
id|nsc_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_SFIF_IE
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*  Not finished yet, so interrupt on DMA again */
id|self-&gt;ier
op_assign
id|IER_DMA_IE
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_interrupt (irq, dev_id, regs)&n; *&n; *    An interrupt from the chip has arrived. Time to do some work&n; *&n; */
DECL|function|nsc_ircc_interrupt
r_static
r_void
id|nsc_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
id|__u8
id|bsr
comma
id|eir
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|bsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Save current bank */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
id|eir
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|EIR
)paren
op_amp
id|self-&gt;ier
suffix:semicolon
multiline_comment|/* Mask out the interesting ones */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
r_if
c_cond
(paren
id|eir
)paren
(brace
multiline_comment|/* Dispatch interrupt handler for the current speed */
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
id|nsc_ircc_fir_interrupt
c_func
(paren
id|self
comma
id|iobase
comma
id|eir
)paren
suffix:semicolon
r_else
id|nsc_ircc_sir_interrupt
c_func
(paren
id|self
comma
id|eir
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|self-&gt;ier
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Restore interrupts */
id|outb
c_func
(paren
id|bsr
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|spin_unlock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_is_receiving (self)&n; *&n; *    Return TRUE is we are currently receiving a frame&n; *&n; */
DECL|function|nsc_ircc_is_receiving
r_static
r_int
id|nsc_ircc_is_receiving
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
op_assign
id|FALSE
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|FALSE
suffix:semicolon
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Check if rx FIFO is not empty */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|RXFLV
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* We are receiving something */
id|status
op_assign
id|TRUE
suffix:semicolon
)brace
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
)brace
r_else
id|status
op_assign
(paren
id|self-&gt;rx_buff.state
op_ne
id|OUTSIDE_FRAME
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_net_init (dev)&n; *&n; *    Initialize network device&n; *&n; */
DECL|function|nsc_ircc_net_init
r_static
r_int
id|nsc_ircc_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup to be a normal IrDA network device driver */
id|irda_device_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Insert overrides below this line! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_net_open (dev)&n; *&n; *    Start the device&n; *&n; */
DECL|function|nsc_ircc_net_open
r_static
r_int
id|nsc_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|nsc_ircc_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate irq=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always allocate the DMA channel after the IRQ, and clean up on &n;&t; * failure.&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|dev-&gt;name
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate dma=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|self
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* turn on interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IER_LS_IE
op_or
id|IER_RXHDL_IE
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Open new IrLAP layer instance, now that everything should be&n;&t; * initialized properly &n;&t; */
id|self-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_net_close (dev)&n; *&n; *    Stop the device&n; *&n; */
DECL|function|nsc_ircc_net_close
r_static
r_int
id|nsc_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u8
id|bank
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Save current bank */
id|bank
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IER
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|outb
c_func
(paren
id|bank
comma
id|iobase
op_plus
id|BSR
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function nsc_ircc_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
DECL|function|nsc_ircc_net_ioctl
r_static
r_int
id|nsc_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|nsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|nsc_ircc_change_speed
c_func
(paren
id|self
comma
id|irq-&gt;ifr_baudrate
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|irq-&gt;ifr_receiving
op_assign
id|nsc_ircc_is_receiving
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|nsc_ircc_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|nsc_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|nsc_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|self-&gt;stats
suffix:semicolon
)brace
DECL|function|nsc_ircc_suspend
r_static
r_void
id|nsc_ircc_suspend
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Suspending&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.suspended
)paren
r_return
suffix:semicolon
id|nsc_ircc_net_close
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|self-&gt;io.suspended
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|nsc_ircc_wakeup
r_static
r_void
id|nsc_ircc_wakeup
c_func
(paren
r_struct
id|nsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;io.suspended
)paren
r_return
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Switch to advanced mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ECR1_EXT_SL
comma
id|iobase
op_plus
id|ECR1
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|nsc_ircc_net_open
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Waking up&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
id|self-&gt;io.suspended
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|nsc_ircc_pmproc
r_static
r_int
id|nsc_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|nsc_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|nsc_ircc_cb
op_star
)paren
id|dev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|self
)paren
(brace
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|nsc_ircc_suspend
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|nsc_ircc_wakeup
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dag Brattli &lt;dagb@cs.uit.no&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;NSC IrDA Device Driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|qos_mtt_bits
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qos_mtt_bits
comma
l_string|&quot;Minimum Turn Time&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;Base I/O addresses&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;IRQ lines&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dma
comma
l_string|&quot;DMA channels&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dongle_id
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dongle_id
comma
l_string|&quot;Type-id of used dongle&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|nsc_ircc_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|nsc_ircc_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
