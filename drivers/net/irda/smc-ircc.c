multiline_comment|/*********************************************************************&n; *                &n; * Filename:      smc-ircc.c&n; * Version:       0.3&n; * Description:   Driver for the SMC Infrared Communications Controller&n; * Status:        Experimental.&n; * Author:        Thomas Davis (tadavis@jps.net)&n; * Created at:    &n; * Modified at:   Wed Jan  5 12:38:06 2000&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1999-2000 Dag Brattli&n; *     Copyright (c) 1998-1999 Thomas Davis, &n; *     All Rights Reserved.&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; * &n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&n; *     GNU General Public License for more details.&n; * &n; *     You should have received a copy of the GNU General Public License &n; *     along with this program; if not, write to the Free Software &n; *     Foundation, Inc., 59 Temple Place, Suite 330, Boston, &n; *     MA 02111-1307 USA&n; *&n; *     SIO&squot;s: SMC FDC37N869, FDC37C669&n; *     Applicable Models : Fujitsu Lifebook 635t, Sony PCG-505TX&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irlap_frame.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/smc-ircc.h&gt;
macro_line|#include &lt;net/irda/irport.h&gt;
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;smc-ircc&quot;
suffix:semicolon
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT 8
DECL|variable|io
r_static
r_int
r_int
id|io
(braket
)braket
op_assign
(brace
l_int|0x2e8
comma
l_int|0x140
comma
l_int|0x118
comma
l_int|0x240
)brace
suffix:semicolon
DECL|variable|io2
r_static
r_int
r_int
id|io2
(braket
)braket
op_assign
(brace
l_int|0x2f8
comma
l_int|0x3e8
comma
l_int|0x2e8
comma
l_int|0x3e8
)brace
suffix:semicolon
DECL|variable|dev_self
r_static
r_struct
id|ircc_cb
op_star
id|dev_self
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Some prototypes */
r_static
r_int
id|ircc_open
c_func
(paren
r_int
id|i
comma
r_int
r_int
id|iobase
comma
r_int
r_int
id|board_addr
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_int
id|ircc_close
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
r_static
r_int
id|ircc_probe
c_func
(paren
r_int
id|iobase
comma
r_int
id|board_addr
)paren
suffix:semicolon
r_static
r_int
id|ircc_probe_smc
c_func
(paren
r_int
op_star
id|ioaddr
comma
r_int
op_star
id|ioaddr2
)paren
suffix:semicolon
r_static
r_int
id|ircc_dma_receive
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ircc_dma_receive_complete
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|ircc_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ircc_dma_xmit
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|ircc_change_speed
c_func
(paren
r_void
op_star
id|priv
comma
id|__u32
id|speed
)paren
suffix:semicolon
r_static
r_void
id|ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|ircc_is_receiving
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ircc_irq
r_static
r_int
id|ircc_irq
op_assign
l_int|255
suffix:semicolon
DECL|variable|ircc_dma
r_static
r_int
id|ircc_dma
op_assign
l_int|255
suffix:semicolon
DECL|function|register_bank
r_static
r_inline
r_void
id|register_bank
c_func
(paren
r_int
id|iobase
comma
r_int
id|bank
)paren
(brace
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_MASTER
)paren
op_amp
l_int|0xf0
)paren
op_or
(paren
id|bank
op_amp
l_int|0x07
)paren
)paren
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_init ()&n; *&n; *    Initialize chip. Just try to find out how many chips we are dealing with&n; *    and where they are&n; */
DECL|function|ircc_init
r_int
id|__init
id|ircc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ioaddr
comma
id|ioaddr2
suffix:semicolon
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|io
(braket
id|i
)braket
OL
l_int|2000
)paren
op_logical_and
(paren
id|i
OL
l_int|4
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|CHIP_IO_EXTENT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|ircc_open
c_func
(paren
id|i
comma
id|io
(braket
id|i
)braket
comma
id|io2
(braket
id|i
)braket
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* last chance saloon, see what the controller says */
r_if
c_cond
(paren
id|ircc_probe_smc
c_func
(paren
op_amp
id|ioaddr
comma
op_amp
id|ioaddr2
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|CHIP_IO_EXTENT
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|ircc_open
c_func
(paren
l_int|0
comma
id|ioaddr
comma
id|ioaddr2
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_cleanup ()&n; *&n; *    Close all configured chips&n; *&n; */
macro_line|#ifdef MODULE
DECL|function|ircc_cleanup
r_static
r_void
id|ircc_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|ircc_close
c_func
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Function ircc_open (iobase, irq)&n; *&n; *    Open driver instance&n; *&n; */
DECL|function|ircc_open
r_static
r_int
id|ircc_open
c_func
(paren
r_int
id|i
comma
r_int
r_int
id|iobase
comma
r_int
r_int
id|iobase2
)paren
(brace
r_struct
id|ircc_cb
op_star
id|self
suffix:semicolon
r_struct
id|irport_cb
op_star
id|irport
suffix:semicolon
r_int
id|config
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|config
op_assign
id|ircc_probe
c_func
(paren
id|iobase
comma
id|iobase2
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), addr 0x%04x - no device found!&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Allocate new instance of the driver&n;&t; */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ircc_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s, Can&squot;t allocate memory for control block!&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ircc_cb
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Need to store self somewhere */
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
id|irport
op_assign
id|irport_open
c_func
(paren
l_int|0
comma
id|iobase2
comma
id|config
op_rshift
l_int|4
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irport
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Steal the network device from irport */
id|self-&gt;netdev
op_assign
id|irport-&gt;netdev
suffix:semicolon
id|self-&gt;irport
op_assign
id|irport
suffix:semicolon
id|irport-&gt;priv
op_assign
id|self
suffix:semicolon
multiline_comment|/* Initialize IO */
id|self-&gt;io.iobase
op_assign
id|iobase
suffix:semicolon
id|self-&gt;io.iobase2
op_assign
id|iobase2
suffix:semicolon
multiline_comment|/* Used by irport */
id|self-&gt;io.irq
op_assign
id|config
op_rshift
l_int|4
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ircc_irq
OL
l_int|255
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Overriding IRQ - chip says %d, using %d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.irq
comma
id|ircc_irq
)paren
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|ircc_irq
suffix:semicolon
)brace
id|self-&gt;io.io_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.io_ext2
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Used by irport */
id|self-&gt;io.dma
op_assign
id|config
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ircc_dma
OL
l_int|255
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Overriding DMA - chip says %d, using %d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.dma
comma
id|ircc_dma
)paren
suffix:semicolon
id|self-&gt;io.dma
op_assign
id|ircc_dma
suffix:semicolon
)brace
id|self-&gt;io.fifo_size
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Lock the port that we need */
id|ret
op_assign
id|check_region
c_func
(paren
id|self-&gt;io.iobase
comma
id|self-&gt;io.io_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.iobase
)paren
suffix:semicolon
multiline_comment|/* ircc_cleanup(self-&gt;self);  */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|self-&gt;io.iobase
comma
id|self-&gt;io.io_ext
comma
id|driver_name
)paren
suffix:semicolon
multiline_comment|/* Initialize QoS for this device */
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|irport-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* The only value we must override it the baudrate */
id|irport-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
id|irport-&gt;qos.min_turn_time.bits
op_assign
l_int|0x07
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|irport-&gt;qos
)paren
suffix:semicolon
id|irport-&gt;flags
op_assign
id|IFF_FIR
op_or
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
suffix:semicolon
multiline_comment|/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */
id|self-&gt;rx_buff.truesize
op_assign
l_int|4000
suffix:semicolon
id|self-&gt;tx_buff.truesize
op_assign
l_int|4000
suffix:semicolon
id|self-&gt;rx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;rx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|self-&gt;rx_buff.head
comma
l_int|0
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;tx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;tx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;tx_buff.head
comma
l_int|0
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;rx_buff.in_frame
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Override the speed change function, since we must control it now */
id|irport-&gt;change_speed
op_assign
op_amp
id|ircc_change_speed
suffix:semicolon
id|self-&gt;netdev-&gt;open
op_assign
op_amp
id|ircc_net_open
suffix:semicolon
id|self-&gt;netdev-&gt;stop
op_assign
op_amp
id|ircc_net_close
suffix:semicolon
id|irport_start
c_func
(paren
id|self-&gt;irport
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_close (self)&n; *&n; *    Close driver instance&n; *&n; */
macro_line|#ifdef MODULE
DECL|function|ircc_close
r_static
r_int
id|ircc_close
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|irport_close
c_func
(paren
id|self-&gt;irport
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_RESET
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_CFGA_IRDA_SIR_A
op_or
id|IRCC_CFGA_TX_POLARITY
comma
id|iobase
op_plus
id|IRCC_SCE_CFGA
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_CFGB_IR
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
multiline_comment|/* Release the PORT that this driver is using */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), releasing 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.iobase
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.iobase
comma
id|self-&gt;io.io_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Function ircc_probe_smc (ioaddr, ioaddr2)&n; *&n; *    Probe the SMC Chip for an IrDA port&n; *&n; */
DECL|function|ircc_probe_smc
r_static
r_int
id|ircc_probe_smc
c_func
(paren
r_int
op_star
id|ioaddr
comma
r_int
op_star
id|ioaddr2
)paren
(brace
r_static
r_int
id|smcreg
(braket
)braket
op_assign
(brace
l_int|0x3f0
comma
l_int|0x370
)brace
suffix:semicolon
id|__u8
id|devid
comma
id|mode
suffix:semicolon
id|__u8
id|conf_reg
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|fir_io
suffix:semicolon
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
op_logical_and
id|ret
op_eq
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|conf_reg
op_assign
id|smcreg
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Enter configuration */
id|outb
c_func
(paren
l_int|0x55
comma
id|conf_reg
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|conf_reg
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0d
comma
id|conf_reg
)paren
suffix:semicolon
id|devid
op_assign
id|inb
c_func
(paren
id|conf_reg
op_plus
l_int|1
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), devid=0x%02x&bslash;n&quot;
comma
id|devid
)paren
suffix:semicolon
multiline_comment|/* Check for expected device ID; are there others? */
r_if
c_cond
(paren
id|devid
op_eq
l_int|0x29
)paren
(brace
id|outb
c_func
(paren
l_int|0x0c
comma
id|conf_reg
)paren
suffix:semicolon
id|mode
op_assign
id|inb
c_func
(paren
id|conf_reg
op_plus
l_int|1
)paren
suffix:semicolon
id|mode
op_assign
(paren
id|mode
op_amp
l_int|0x38
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* Value for IR port */
r_if
c_cond
(paren
id|mode
op_logical_and
id|mode
OL
l_int|4
)paren
(brace
multiline_comment|/* SIR iobase */
id|outb
c_func
(paren
l_int|0x25
comma
id|conf_reg
)paren
suffix:semicolon
op_star
id|ioaddr2
op_assign
id|inb
c_func
(paren
id|conf_reg
op_plus
l_int|1
)paren
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* FIR iobase */
id|outb
c_func
(paren
l_int|0x2b
comma
id|conf_reg
)paren
suffix:semicolon
id|fir_io
op_assign
id|inb
c_func
(paren
id|conf_reg
op_plus
l_int|1
)paren
op_lshift
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|fir_io
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
op_star
id|ioaddr
op_assign
id|fir_io
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Exit configuration */
id|outb
c_func
(paren
l_int|0xaa
comma
id|conf_reg
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_probe (iobase, board_addr, irq, dma)&n; *&n; *    Returns non-negative on success.&n; *&n; */
DECL|function|ircc_probe
r_static
r_int
id|ircc_probe
c_func
(paren
r_int
id|iobase
comma
r_int
id|iobase2
)paren
(brace
r_int
id|version
op_assign
l_int|1
suffix:semicolon
r_int
id|low
comma
id|high
comma
id|chip
comma
id|config
comma
id|dma
comma
id|irq
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Power on device */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_MASTER
)paren
op_amp
op_complement
id|IRCC_MASTER_POWERDOWN
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|3
)paren
suffix:semicolon
id|high
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_ID_HIGH
)paren
suffix:semicolon
id|low
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_ID_LOW
)paren
suffix:semicolon
id|chip
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_CHIP_ID
)paren
suffix:semicolon
id|version
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_VERSION
)paren
suffix:semicolon
id|config
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_INTERFACE
)paren
suffix:semicolon
id|irq
op_assign
id|config
op_rshift
l_int|4
op_amp
l_int|0x0f
suffix:semicolon
id|dma
op_assign
id|config
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|high
op_eq
l_int|0x10
op_logical_and
id|low
op_eq
l_int|0xb8
op_logical_and
(paren
id|chip
op_eq
l_int|0xf1
op_logical_or
id|chip
op_eq
l_int|0xf2
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;SMC IrDA Controller found; IrCC version %d.%d, &quot;
l_string|&quot;port 0x%04x, dma %d, interrupt %d&bslash;n&quot;
comma
id|chip
op_amp
l_int|0x0f
comma
id|version
comma
id|iobase
comma
id|dma
comma
id|irq
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
r_return
id|config
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_change_speed (self, baud)&n; *&n; *    Change the speed of the device&n; *&n; */
DECL|function|ircc_change_speed
r_static
r_void
id|ircc_change_speed
c_func
(paren
r_void
op_star
id|priv
comma
id|__u32
id|speed
)paren
(brace
r_int
id|iobase
comma
id|ir_mode
comma
id|select
comma
id|fast
suffix:semicolon
r_struct
id|ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|ircc_cb
op_star
)paren
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|9600
suffix:colon
r_case
l_int|19200
suffix:colon
r_case
l_int|38400
suffix:colon
r_case
l_int|57600
suffix:colon
r_case
l_int|115200
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), using irport to change speed to %d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_RESET
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_INT_EN
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|irport_hard_xmit
suffix:semicolon
multiline_comment|/* We must give the interrupt back to irport */
id|self-&gt;irport-&gt;interrupt
op_assign
id|irport_interrupt
suffix:semicolon
id|irport_start
c_func
(paren
id|self-&gt;irport
)paren
suffix:semicolon
id|irport_change_speed
c_func
(paren
id|self-&gt;irport
comma
id|speed
)paren
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|576000
suffix:colon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_HDLC
suffix:semicolon
id|select
op_assign
l_int|0
suffix:semicolon
id|fast
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 576000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_HDLC
suffix:semicolon
id|select
op_assign
id|IRCC_1152
suffix:semicolon
id|fast
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 1152000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_4PPM
suffix:semicolon
id|select
op_assign
l_int|0
suffix:semicolon
id|fast
op_assign
id|IRCC_LCR_A_FAST
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), handling baud of 4000000&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unknown baud rate of %d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
c_func
(paren
id|IRCC_MASTER_RESET
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|irport_stop
c_func
(paren
id|self-&gt;irport
)paren
suffix:semicolon
multiline_comment|/* Install FIR transmit handler */
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|ircc_hard_xmit
suffix:semicolon
multiline_comment|/* Need to steal the interrupt as well */
id|self-&gt;irport-&gt;interrupt
op_assign
op_amp
id|ircc_interrupt
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGA
)paren
op_amp
l_int|0x87
)paren
op_or
id|ir_mode
)paren
comma
id|iobase
op_plus
id|IRCC_SCE_CFGA
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
l_int|0x3f
)paren
op_or
id|IRCC_CFGB_IR
)paren
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
(paren
r_void
)paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_FIFO_THRESHOLD
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|64
comma
id|iobase
op_plus
id|IRCC_FIFO_THRESHOLD
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_CONTROL
)paren
op_amp
l_int|0x30
)paren
op_or
id|select
op_or
id|IRCC_CRC
comma
id|iobase
op_plus
id|IRCC_CONTROL
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|fast
comma
id|iobase
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_hard_xmit (skb, dev)&n; *&n; *    Transmit the frame!&n; *&n; */
DECL|function|ircc_hard_xmit
r_static
r_int
id|ircc_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|irport_cb
op_star
id|irport
suffix:semicolon
r_struct
id|ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|mtt
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
id|irport
op_assign
(paren
r_struct
id|irport_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ircc_cb
op_star
)paren
id|irport-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(%ld), skb-&gt;len=%d&bslash;n&quot;
comma
id|jiffies
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
(paren
id|speed
op_assign
id|irda_get_speed
c_func
(paren
id|skb
)paren
)paren
op_ne
id|self-&gt;io.speed
)paren
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
multiline_comment|/* Lock transmit buffer */
r_if
c_cond
(paren
id|irda_lock
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_eq
id|FALSE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|memcpy
c_func
(paren
id|self-&gt;tx_buff.head
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Make sure that the length is a multiple of 16 bits */
r_if
c_cond
(paren
id|skb-&gt;len
op_amp
l_int|0x01
)paren
id|skb-&gt;len
op_increment
suffix:semicolon
id|self-&gt;tx_buff.len
op_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
id|udelay
c_func
(paren
id|mtt
)paren
suffix:semicolon
id|ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_dma_xmit (self, iobase)&n; *&n; *    Transmit data using DMA&n; *&n; */
DECL|function|ircc_dma_xmit
r_static
r_void
id|ircc_dma_xmit
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
id|outb
c_func
(paren
l_int|0x08
comma
id|self-&gt;io.iobase2
op_plus
l_int|4
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_CONTROL
)paren
op_amp
l_int|0xf0
)paren
comma
id|iobase
op_plus
id|IRCC_CONTROL
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|2
comma
id|iobase
op_plus
id|IRCC_BOF_COUNT_LO
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_BRICKWALL_CNT_LO
)paren
suffix:semicolon
macro_line|#if 1
id|outb
c_func
(paren
id|self-&gt;tx_buff.len
op_rshift
l_int|8
comma
id|iobase
op_plus
id|IRCC_BRICKWALL_TX_CNT_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|self-&gt;tx_buff.len
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|IRCC_TX_SIZE_LO
)paren
suffix:semicolon
macro_line|#else
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_BRICKWALL_TX_CNT_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_TX_SIZE_LO
)paren
suffix:semicolon
macro_line|#endif
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_or
id|IRCC_CFGB_DMA_ENABLE
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_IER_ACTIVE_FRAME
op_or
id|IRCC_IER_EOM
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_LCR_B_SCE_TRANSMIT
op_or
id|IRCC_LCR_B_SIP_ENABLE
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_INT_EN
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_dma_xmit_complete (self)&n; *&n; *    The transfer of a frame in finished. This function will only be called &n; *    by the interrupt handler&n; *&n; */
DECL|function|ircc_dma_xmit_complete
r_static
r_void
id|ircc_dma_xmit_complete
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
comma
r_int
id|underrun
)paren
(brace
r_int
id|iobase
comma
id|d
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|self-&gt;io.iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|self-&gt;io.iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
id|IRCC_CFGB_DMA_ENABLE
comma
id|self-&gt;io.iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
id|d
op_assign
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: dma residue = %d, len=%d, sent=%d&bslash;n&quot;
comma
id|d
comma
id|self-&gt;tx_buff.len
comma
id|self-&gt;tx_buff.len
op_minus
id|d
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
multiline_comment|/* Check for underrrun! */
r_if
c_cond
(paren
id|underrun
)paren
(brace
id|self-&gt;irport-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;irport-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;irport-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|self-&gt;irport-&gt;stats.tx_bytes
op_add_assign
id|self-&gt;tx_buff.len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Unlock tx_buff and request another frame */
id|self-&gt;netdev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unlock */
multiline_comment|/* Tell the network layer, that we can accept more frames */
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_dma_receive (self)&n; *&n; *    Get ready for receiving a frame. The device will initiate a DMA&n; *    if it starts to receive a frame.&n; *&n; */
DECL|function|ircc_dma_receive
r_static
r_int
id|ircc_dma_receive
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;rx_buff.data
comma
id|self-&gt;rx_buff.truesize
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
multiline_comment|/* driver-&gt;media_busy = FALSE; */
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
macro_line|#if 0
id|self-&gt;rx_buff.offset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|register_bank
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_CONTROL
)paren
op_amp
l_int|0xf0
comma
id|iobase
op_plus
id|IRCC_CONTROL
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|2
comma
id|iobase
op_plus
id|IRCC_BOF_COUNT_LO
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_BRICKWALL_CNT_LO
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_BRICKWALL_TX_CNT_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_TX_SIZE_LO
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_RX_SIZE_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_RX_SIZE_LO
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_LCR_B_SCE_RECEIVE
op_or
id|IRCC_LCR_B_SIP_ENABLE
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_or
id|IRCC_CFGB_DMA_ENABLE
op_or
id|IRCC_CFGB_DMA_BURST
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_dma_receive_complete (self)&n; *&n; *    Finished with receiving frames&n; *&n; *    &n; */
DECL|function|ircc_dma_receive_complete
r_static
r_int
id|ircc_dma_receive_complete
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
comma
id|msgcnt
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|msgcnt
op_assign
id|inb
c_func
(paren
id|self-&gt;io.iobase
op_plus
id|IRCC_LCR_B
)paren
op_amp
l_int|0x08
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: dma count = %d&bslash;n&quot;
comma
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
)paren
suffix:semicolon
id|len
op_assign
id|self-&gt;rx_buff.truesize
op_minus
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
op_minus
l_int|4
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: msgcnt = %d, len=%d&bslash;n&quot;
comma
id|msgcnt
comma
id|len
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), memory squeeze, dropping frame.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* Make sure IP header gets aligned */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
)paren
suffix:semicolon
id|self-&gt;irport-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|self-&gt;io.iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|self-&gt;io.iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
op_complement
id|IRCC_CFGB_DMA_ENABLE
comma
id|self-&gt;io.iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_interrupt (irq, dev_id, regs)&n; *&n; *    An interrupt from the chip has arrived. Time to do some work&n; *&n; */
DECL|function|ircc_interrupt
r_static
r_void
id|ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|iobase
comma
id|iir
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|ircc_cb
op_star
id|self
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|iir
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_IIR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), iir = 0x%02x&bslash;n&quot;
comma
id|iir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iir
op_amp
id|IRCC_IIR_EOM
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), IRCC_IIR_EOM&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_RECV
)paren
id|ircc_dma_receive_complete
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
r_else
id|ircc_dma_xmit_complete
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
id|ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iir
op_amp
id|IRCC_IIR_ACTIVE_FRAME
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), IRCC_IIR_ACTIVE_FRAME&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|INSIDE_FRAME
suffix:semicolon
macro_line|#if 0
id|ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|iir
op_amp
id|IRCC_IIR_RAW_MODE
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), IIR RAW mode interrupt.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_IER_ACTIVE_FRAME
op_or
id|IRCC_IER_EOM
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_INT_EN
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_is_receiving (self)&n; *&n; *    Return TRUE is we are currently receiving a frame&n; *&n; */
DECL|function|ircc_is_receiving
r_static
r_int
id|ircc_is_receiving
c_func
(paren
r_struct
id|ircc_cb
op_star
id|self
)paren
(brace
r_int
id|status
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* int iobase; */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|FALSE
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: dma count = %d&bslash;n&quot;
comma
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
)paren
suffix:semicolon
id|status
op_assign
(paren
id|self-&gt;rx_buff.state
op_ne
id|OUTSIDE_FRAME
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_net_open (dev)&n; *&n; *    Start the device&n; *&n; */
DECL|function|ircc_net_open
r_static
r_int
id|ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|irport_cb
op_star
id|irport
suffix:semicolon
r_struct
id|ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|irport
op_assign
(paren
r_struct
id|irport_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ircc_cb
op_star
)paren
id|irport-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|irport_net_open
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* irport allocates the irq */
multiline_comment|/*&n;&t; * Always allocate the DMA channel after the IRQ,&n;&t; * and clean up on failure.&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|dev-&gt;name
)paren
)paren
(brace
id|irport_net_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ircc_net_close (dev)&n; *&n; *    Stop the device&n; *&n; */
DECL|function|ircc_net_close
r_static
r_int
id|ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|irport_cb
op_star
id|irport
suffix:semicolon
r_struct
id|ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|irport
op_assign
(paren
r_struct
id|irport_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ircc_cb
op_star
)paren
id|irport-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.iobase
suffix:semicolon
id|irport_net_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Thomas Davis &lt;tadavis@jps.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SMC IrCC controller driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_dma
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_irq
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|ircc_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|ircc_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
