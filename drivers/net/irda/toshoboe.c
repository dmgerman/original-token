multiline_comment|/*********************************************************************&n; *                &n; * Filename:      toshoboe.c&n; * Version:       0.1&n; * Description:   Driver for the Toshiba OBOE (or type-O or 700 or 701)&n; *                FIR Chipset. &n; * Status:        Experimental.&n; * Author:        James McKenzie &lt;james@fishsoup.dhs.org&gt;&n; * Created at:    Sat May 8  12:35:27 1999&n; * Modified:      Paul Bristow &lt;paul.bristow@technologist.com&gt;&n; * Modified:      Mon Nov 11 19:10:05 1999&n; * &n; *     Copyright (c) 1999-2000 James McKenzie, All Rights Reserved.&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither James McKenzie nor Cambridge University admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; *     Applicable Models : Libretto 100CT. and many more&n; *     Toshiba refers to this chip as the type-O IR port.&n; *&n; ********************************************************************/
multiline_comment|/* This driver is experimental, I have only three ir devices */
multiline_comment|/* an olivetti notebook which doesn&squot;t have FIR, a toshiba libretto, and */
multiline_comment|/* an hp printer, this works fine at 4MBPS with my HP printer */
DECL|variable|rcsid
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: toshoboe.c,v 1.91 1999/06/29 14:21:06 root Exp $&quot;
suffix:semicolon
multiline_comment|/* Define this to have only one frame in the XMIT or RECV queue */
multiline_comment|/* Toshiba&squot;s drivers do this, but it disables back to back tansfers */
multiline_comment|/* I think that the chip may have some problems certainly, I have */
multiline_comment|/* seen it jump over tasks in the taskfile-&gt;xmit with this turned on */
DECL|macro|ONETASK
mdefine_line|#define ONETASK 
multiline_comment|/* To adjust the number of tasks in use edit toshoboe.h */
multiline_comment|/* Define this to enable FIR and MIR support */
DECL|macro|ENABLE_FAST
mdefine_line|#define ENABLE_FAST
multiline_comment|/* Number of ports this driver can support, you also need to edit dev_self below */
DECL|macro|NSELFS
mdefine_line|#define NSELFS 4
multiline_comment|/* Size of IO window */
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT&t;0x1f
multiline_comment|/* Transmit and receive buffer sizes, adjust at your peril */
DECL|macro|RX_BUF_SZ
mdefine_line|#define RX_BUF_SZ &t;4196
DECL|macro|TX_BUF_SZ
mdefine_line|#define TX_BUF_SZ&t;4196
multiline_comment|/* No user servicable parts below here */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irlap_frame.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
r_static
r_int
id|toshoboe_pmproc
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#include &lt;net/irda/toshoboe.h&gt;
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;toshoboe&quot;
suffix:semicolon
DECL|variable|dev_self
r_static
r_struct
id|toshoboe_cb
op_star
id|dev_self
(braket
id|NSELFS
op_plus
l_int|1
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|max_baud
r_static
r_int
id|max_baud
op_assign
l_int|4000000
suffix:semicolon
multiline_comment|/* Shutdown the chip and point the taskfile reg somewhere else */
r_static
r_void
DECL|function|toshoboe_stopchip
id|toshoboe_stopchip
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0e
comma
id|OBOE_REG_11
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x3f
comma
id|OBOE_TFP2
)paren
suffix:semicolon
multiline_comment|/*Write the taskfile address */
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_TFP1
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_TFP0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0f
comma
id|OBOE_REG_1B
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_REG_1A
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*FIXME: should i do this to disbale ints */
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xe
comma
id|OBOE_LOCK
)paren
suffix:semicolon
)brace
multiline_comment|/*Set the baud rate */
r_static
r_void
DECL|function|toshoboe_setbaud
id|toshoboe_setbaud
(paren
r_struct
id|toshoboe_cb
op_star
id|self
comma
r_int
id|baud
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: setting baud to %d&bslash;n&quot;
comma
id|baud
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|2400
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xbf
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x5f
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x2f
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x17
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xb
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x7
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x3
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_MIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_MIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x1
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_FIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_FIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x01
comma
id|OBOE_REG_9
)paren
suffix:semicolon
id|self-&gt;io.speed
op_assign
id|baud
suffix:semicolon
)brace
multiline_comment|/* Wake the chip up and get it looking at the taskfile */
r_static
r_void
DECL|function|toshoboe_startchip
id|toshoboe_startchip
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u32
id|physaddr
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|OBOE_LOCK
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_NTR_VAL
comma
id|OBOE_NTR
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xf0
comma
id|OBOE_REG_D
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_ISR
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0f
comma
id|OBOE_REG_1A
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_REG_1B
)paren
suffix:semicolon
id|physaddr
op_assign
id|virt_to_bus
(paren
id|self-&gt;taskfile
)paren
suffix:semicolon
id|outb_p
(paren
(paren
id|physaddr
op_rshift
l_int|0x0a
)paren
op_amp
l_int|0xff
comma
id|OBOE_TFP0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
id|physaddr
op_rshift
l_int|0x12
)paren
op_amp
l_int|0xff
comma
id|OBOE_TFP1
)paren
suffix:semicolon
id|outb_p
(paren
(paren
id|physaddr
op_rshift
l_int|0x1a
)paren
op_amp
l_int|0x3f
comma
id|OBOE_TFP2
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0e
comma
id|OBOE_REG_11
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
comma
l_int|9600
)paren
suffix:semicolon
)brace
multiline_comment|/*Let the chip look at memory */
r_static
r_void
DECL|function|toshoboe_enablebm
id|toshoboe_enablebm
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_master
(paren
id|self-&gt;pdev
)paren
suffix:semicolon
)brace
multiline_comment|/*Don&squot;t let the chip look at memory */
r_static
r_void
DECL|function|toshoboe_disablebm
id|toshoboe_disablebm
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u8
id|command
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|self-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_byte
(paren
id|self-&gt;pdev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
)brace
multiline_comment|/*setup the taskfile */
r_static
r_void
DECL|function|toshoboe_initbuffs
id|toshoboe_initbuffs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|control
op_assign
l_int|0x00
suffix:semicolon
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|buffer
op_assign
id|virt_to_bus
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;taskfile-&gt;recv
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;taskfile-&gt;recv
(braket
id|i
)braket
dot
id|control
op_assign
l_int|0x83
suffix:semicolon
id|self-&gt;taskfile-&gt;recv
(braket
id|i
)braket
dot
id|buffer
op_assign
id|virt_to_bus
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*Transmit something */
r_static
r_int
DECL|function|toshoboe_hard_xmit
id|toshoboe_hard_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
r_int
id|mtt
comma
id|len
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
(paren
id|speed
op_assign
id|irda_get_speed
c_func
(paren
id|skb
)paren
)paren
op_ne
id|self-&gt;io.speed
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|toshoboe_setbaud
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;stopped
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef ONETASK
r_if
c_cond
(paren
id|self-&gt;txpending
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|self-&gt;txs
op_assign
id|inb_p
(paren
id|OBOE_XMTT
)paren
op_minus
id|OBOE_XMTT_OFFSET
suffix:semicolon
id|self-&gt;txs
op_and_assign
l_int|0x3f
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|self-&gt;taskfile-&gt;xmit
(braket
id|self-&gt;txs
)braket
dot
id|control
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
(paren
id|OBOE_RST
)paren
op_amp
id|OBOE_RST_WRAP
)paren
(brace
id|len
op_assign
id|async_wrap_skb
(paren
id|skb
comma
id|self-&gt;xmit_bufs
(braket
id|self-&gt;txs
)braket
comma
id|TX_BUF_SZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
(paren
id|self-&gt;xmit_bufs
(braket
id|self-&gt;txs
)braket
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
)brace
id|self-&gt;taskfile-&gt;xmit
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|len
op_amp
l_int|0x0fff
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x1e
comma
id|OBOE_REG_11
)paren
suffix:semicolon
id|self-&gt;taskfile-&gt;xmit
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
l_int|0x84
suffix:semicolon
id|mtt
op_assign
id|irda_get_mtt
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
id|udelay
(paren
id|mtt
)paren
suffix:semicolon
id|self-&gt;txpending
op_increment
suffix:semicolon
multiline_comment|/*FIXME: ask about busy,media_busy stuff, for the moment */
multiline_comment|/*busy means can&squot;t queue any more */
macro_line|#ifndef ONETASK
r_if
c_cond
(paren
id|self-&gt;txpending
op_ne
id|TX_SLOTS
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|OBOE_REG_9
)paren
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*interrupt handler */
r_static
r_void
DECL|function|toshoboe_interrupt
id|toshoboe_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev_id
suffix:semicolon
id|__u8
id|irqstat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irqstat
op_assign
id|inb_p
(paren
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/* woz it us */
r_if
c_cond
(paren
op_logical_neg
(paren
id|irqstat
op_amp
l_int|0xf8
)paren
)paren
r_return
suffix:semicolon
id|outb_p
(paren
id|irqstat
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*Acknologede it */
multiline_comment|/* Txdone */
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_TXDONE
)paren
(brace
id|self-&gt;txpending
op_decrement
suffix:semicolon
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|toshoboe_setbaud
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Tell network layer that we want more frames */
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_RXDONE
)paren
(brace
macro_line|#ifdef ONETASK
id|self-&gt;rxs
op_assign
id|inb_p
(paren
id|OBOE_RCVT
)paren
suffix:semicolon
id|self-&gt;rxs
op_add_assign
(paren
id|RX_SLOTS
op_minus
l_int|1
)paren
suffix:semicolon
id|self-&gt;rxs
op_mod_assign
id|RX_SLOTS
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_eq
l_int|0
)paren
macro_line|#endif
(brace
r_int
id|len
op_assign
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|2
)paren
id|len
op_sub_assign
l_int|2
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb_reserve
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
(paren
id|skb-&gt;data
comma
id|self-&gt;recv_bufs
(braket
id|self-&gt;rxs
)braket
comma
id|len
)paren
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
id|__FUNCTION__
l_string|&quot;(), memory squeeze, dropping frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_assign
l_int|0x83
suffix:semicolon
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|len
op_assign
l_int|0x0
suffix:semicolon
id|self-&gt;rxs
op_increment
suffix:semicolon
id|self-&gt;rxs
op_mod_assign
id|RX_SLOTS
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_20
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Oboe_irq: 20&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_10
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Oboe_irq: 10&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
l_int|0x8
)paren
(brace
multiline_comment|/*FIXME: I think this is a TX or RX error of some sort */
id|self-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|toshoboe_net_init
id|toshoboe_net_init
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup to be a normal IrDA network device driver */
id|irda_device_setup
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Insert overrides below this line! */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|toshoboe_initptrs
id|toshoboe_initptrs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/*FIXME: need to test this carefully to check which one */
multiline_comment|/*of the two possible startup logics the chip uses */
multiline_comment|/*although it won&squot;t make any difference if no-one xmits durining init */
multiline_comment|/*and none what soever if using ONETASK */
id|self-&gt;rxs
op_assign
id|inb_p
(paren
id|OBOE_RCVT
)paren
suffix:semicolon
id|self-&gt;txs
op_assign
id|inb_p
(paren
id|OBOE_XMTT
)paren
op_minus
id|OBOE_XMTT_OFFSET
suffix:semicolon
macro_line|#if 0
id|self-&gt;rxs
op_assign
l_int|0
suffix:semicolon
id|self-&gt;txs
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|self-&gt;rxs
op_assign
id|RX_SLOTS
op_minus
l_int|1
suffix:semicolon
id|self-&gt;txs
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|self-&gt;txpending
op_assign
l_int|0
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_open
id|toshoboe_net_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;stopped
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|self-&gt;io.irq
comma
id|toshoboe_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
id|dev-&gt;name
comma
(paren
r_void
op_star
)paren
id|self
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|toshoboe_initbuffs
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_enablebm
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_initptrs
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;   * Open new IrLAP layer instance, now that everything should be&n;   * initialized properly &n;   */
id|self-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;open
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_close
id|toshoboe_net_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;open
op_assign
l_int|0
suffix:semicolon
id|free_irq
(paren
id|self-&gt;io.irq
comma
(paren
r_void
op_star
)paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;stopped
)paren
(brace
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_disablebm
(paren
id|self
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function toshoboe_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
DECL|function|toshoboe_net_ioctl
r_static
r_int
id|toshoboe_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* toshoboe_setbaud(self, irq-&gt;ifr_baudrate); */
multiline_comment|/* Just change speed once - inserted by Paul Bristow */
id|self-&gt;new_speed
op_assign
id|irq-&gt;ifr_baudrate
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|irq-&gt;ifr_receiving
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Can&squot;t tell */
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Toshiba OBOE IrDA Device Driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;James McKenzie &lt;james@fishsoup.dhs.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|max_baud
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_baus
comma
l_string|&quot;Maximum baud rate&quot;
)paren
suffix:semicolon
r_static
r_int
DECL|function|toshoboe_close
id|toshoboe_close
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;stopped
)paren
(brace
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_disablebm
(paren
id|self
)paren
suffix:semicolon
)brace
id|release_region
(paren
id|self-&gt;io.sir_base
comma
id|self-&gt;io.sir_ext
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;xmit_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;recv_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;netdev
)paren
(brace
multiline_comment|/* Remove netdevice */
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|self-&gt;taskfilebuf
)paren
suffix:semicolon
id|self-&gt;taskfilebuf
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;taskfile
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|toshoboe_open
id|toshoboe_open
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|NSELFS
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;Oboe: No more instances available&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|self
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|toshoboe_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;IrDA: Can&squot;t allocate memory for &quot;
l_string|&quot;IrDA control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|toshoboe_cb
)paren
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
multiline_comment|/*This needs moving if we ever get more than one chip */
id|self-&gt;open
op_assign
l_int|0
suffix:semicolon
id|self-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|self-&gt;pdev
op_assign
id|pci_dev
suffix:semicolon
id|self-&gt;base
op_assign
id|pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|self-&gt;io.sir_base
op_assign
id|self-&gt;base
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
id|self-&gt;io.sir_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.speed
op_assign
l_int|9600
suffix:semicolon
multiline_comment|/* Lock the port that we need */
id|i
op_assign
id|check_region
(paren
id|self-&gt;io.sir_base
comma
id|self-&gt;io.sir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.sir_base
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|irda_init_max_qos_capabilies
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;qos.baud_rate.bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|2400
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_2400
suffix:semicolon
multiline_comment|/*if (max_baud&gt;=4800) idev-&gt;qos.baud_rate.bits|=IR_4800; */
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|9600
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_9600
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|19200
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_19200
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|115200
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_115200
suffix:semicolon
macro_line|#ifdef ENABLE_FAST
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|576000
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_576000
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|1152000
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_1152000
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|4000000
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
macro_line|#endif
id|self-&gt;qos.min_turn_time.bits
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/*FIXME: what does this do? */
id|irda_qos_bits_to_value
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;flags
op_assign
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
suffix:semicolon
macro_line|#ifdef ENABLE_FAST
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|576000
)paren
id|self-&gt;flags
op_or_assign
id|IFF_FIR
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now setup the endless buffers we need */
id|self-&gt;txs
op_assign
l_int|0
suffix:semicolon
id|self-&gt;rxs
op_assign
l_int|0
suffix:semicolon
id|self-&gt;taskfilebuf
op_assign
id|kmalloc
(paren
id|OBOE_TASK_BUF_LEN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;taskfilebuf
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;toshoboe: kmalloc for DMA failed()&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|self-&gt;taskfilebuf
comma
l_int|0
comma
id|OBOE_TASK_BUF_LEN
)paren
suffix:semicolon
multiline_comment|/*We need to align the taskfile on a taskfile size boundary */
(brace
id|__u32
id|addr
suffix:semicolon
id|addr
op_assign
(paren
id|__u32
)paren
id|self-&gt;taskfilebuf
suffix:semicolon
id|addr
op_and_assign
op_complement
(paren
r_sizeof
(paren
r_struct
id|OboeTaskFile
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
r_struct
id|OboeTaskFile
)paren
suffix:semicolon
id|self-&gt;taskfile
op_assign
(paren
r_struct
id|OboeTaskFile
op_star
)paren
id|addr
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;xmit_bufs
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
id|TX_BUF_SZ
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
id|ok
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;recv_bufs
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
id|TX_BUF_SZ
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
id|ok
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok
op_ne
id|RX_SLOTS
op_plus
id|TX_SLOTS
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;toshoboe: kmalloc for buffers failed()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
id|kfree
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
id|kfree
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|request_region
(paren
id|self-&gt;io.sir_base
comma
id|self-&gt;io.sir_ext
comma
id|driver_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|dev_alloc
c_func
(paren
l_string|&quot;irda%d&quot;
comma
op_amp
id|err
)paren
)paren
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), dev_alloc() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
id|toshoboe_net_init
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|toshoboe_hard_xmit
suffix:semicolon
id|dev-&gt;open
op_assign
id|toshoboe_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|toshoboe_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|toshoboe_net_ioctl
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|register_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), register_netdev() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pmdev
op_assign
id|pm_register
(paren
id|PM_PCI_DEV
comma
id|PM_PCI_ID
c_func
(paren
id|pci_dev
)paren
comma
id|toshoboe_pmproc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdev
)paren
id|pmdev-&gt;data
op_assign
id|self
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: Using &quot;
)paren
suffix:semicolon
macro_line|#ifdef ONETASK
id|printk
(paren
l_string|&quot;single&quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
(paren
l_string|&quot;multiple&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
(paren
l_string|&quot; tasks, version %s&bslash;n&quot;
comma
id|rcsid
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|toshoboe_gotosleep
id|toshoboe_gotosleep
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
op_assign
l_int|10
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: suspending&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;stopped
)paren
r_return
suffix:semicolon
id|self-&gt;stopped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;open
)paren
r_return
suffix:semicolon
multiline_comment|/*FIXME: can&squot;t sleep here wait one second */
r_while
c_loop
(paren
(paren
id|i
op_decrement
)paren
op_logical_and
(paren
id|self-&gt;txpending
)paren
)paren
id|mdelay
(paren
l_int|100
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_disablebm
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;txpending
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|toshoboe_wakeup
id|toshoboe_wakeup
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;stopped
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;open
)paren
(brace
id|self-&gt;stopped
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|toshoboe_initbuffs
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_enablebm
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
comma
id|self-&gt;io.speed
)paren
suffix:semicolon
id|toshoboe_initptrs
(paren
id|self
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: waking up&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_pmproc
id|toshoboe_pmproc
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|self
)paren
(brace
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|toshoboe_gotosleep
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|toshoboe_wakeup
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|toshoboe_init
r_int
id|__init
id|toshoboe_init
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|pci_dev
op_assign
id|pci_find_device
(paren
id|PCI_VENDOR_ID_TOSHIBA
comma
id|PCI_DEVICE_ID_FIR701
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: Found 701 chip at 0x%0lx irq %d&bslash;n&quot;
comma
id|pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|pci_dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|toshoboe_open
(paren
id|pci_dev
)paren
)paren
id|found
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_static
r_void
DECL|function|toshoboe_cleanup
id|toshoboe_cleanup
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|toshoboe_close
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|pm_unregister_all
(paren
id|toshoboe_pmproc
)paren
suffix:semicolon
)brace
r_int
DECL|function|init_module
id|init_module
(paren
r_void
)paren
(brace
r_return
id|toshoboe_init
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
(paren
r_void
)paren
(brace
id|toshoboe_cleanup
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
