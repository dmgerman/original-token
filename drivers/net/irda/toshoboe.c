multiline_comment|/*********************************************************************&n; *                &n; * Filename:      toshoboe.c&n; * Version:       0.1&n; * Description:   Driver for the Toshiba OBOE (or type-O or 700 or 701)&n; *                FIR Chipset. &n; * Status:        Experimental.&n; * Author:        James McKenzie &lt;james@fishsoup.dhs.org&gt;&n; * Created at:    Sat May 8  12:35:27 1999&n; * &n; *     Copyright (c) 1999 James McKenzie, All Rights Reserved.&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither James McKenzie nor Cambridge University admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; *     Applicable Models : Libretto 100CT. and many more&n; *     Toshiba refers to this chip as the type-O IR port.&n; *&n; ********************************************************************/
multiline_comment|/* This driver is experimental, I have only three ir devices */
multiline_comment|/* an olivetti notebook which doesn&squot;t have FIR, a toshiba libretto, and */
multiline_comment|/* an hp printer, this works fine at 4MBPS with my HP printer */
DECL|variable|rcsid
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: toshoboe.c,v 1.5 1999/05/12 12:24:39 root Exp root $&quot;
suffix:semicolon
multiline_comment|/* &n; * $Log: toshoboe.c,v $&n; * Revision 1.5  1999/05/12 12:24:39  root&n; * *** empty log message ***&n; *&n; * Revision 1.4  1999/05/12 11:55:08  root&n; * *** empty log message ***&n; *&n; * Revision 1.3  1999/05/09 01:33:12  root&n; * *** empty log message ***&n; *&n; * Revision 1.2  1999/05/09 01:30:38  root&n; * *** empty log message ***&n; *&n; * Revision 1.1  1999/05/09 01:25:04  root&n; * Initial revision&n; * &n; */
multiline_comment|/* Define this to have only one frame in the XMIT or RECV queue */
multiline_comment|/* Toshiba&squot;s drivers do this, but it disables back to back tansfers */
multiline_comment|/* I think that the chip may have some problems certainly, I have */
multiline_comment|/* seen it jump over tasks in the taskfile-&gt;xmit with this turned on */
DECL|macro|ONETASK
mdefine_line|#define ONETASK
multiline_comment|/* To adjust the number of tasks in use edit toshoboe.h */
multiline_comment|/* Define this to enable FIR and MIR support */
DECL|macro|ENABLE_FAST
mdefine_line|#define ENABLE_FAST
multiline_comment|/* Number of ports this driver can support, you also need to edit dev_self below */
DECL|macro|NSELFS
mdefine_line|#define NSELFS 4
multiline_comment|/* Size of IO window */
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT&t;0x1f
multiline_comment|/* Transmit and receive buffer sizes, adjust at your peril */
DECL|macro|RX_BUF_SZ
mdefine_line|#define RX_BUF_SZ &t;4196
DECL|macro|TX_BUF_SZ
mdefine_line|#define TX_BUF_SZ&t;4196
multiline_comment|/* No user servicable parts below here */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irlap_frame.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/toshoboe.h&gt;
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;toshoboe&quot;
suffix:semicolon
DECL|variable|dev_self
r_static
r_struct
id|toshoboe_cb
op_star
id|dev_self
(braket
id|NSELFS
op_plus
l_int|1
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Shutdown the chip and point the taskfile reg somewhere else */
r_static
r_void
DECL|function|toshoboe_stopchip
id|toshoboe_stopchip
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0e
comma
id|OBOE_REG_11
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x3f
comma
id|OBOE_TFP2
)paren
suffix:semicolon
multiline_comment|/*Write the taskfile address */
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_TFP1
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_TFP0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0f
comma
id|OBOE_REG_1B
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_REG_1A
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*FIXME: should i do this to disbale ints */
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xe
comma
id|OBOE_LOCK
)paren
suffix:semicolon
)brace
multiline_comment|/*Set the baud rate */
r_static
r_void
DECL|function|toshoboe_setbaud
id|toshoboe_setbaud
(paren
r_struct
id|toshoboe_cb
op_star
id|self
comma
r_int
id|baud
)paren
(brace
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: seting baud to %d&bslash;n&quot;
comma
id|baud
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|2400
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xbf
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x5f
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x2f
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x17
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xb
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x7
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_SIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_SIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x3
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_MIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_MIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x1
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|outb_p
(paren
id|OBOE_PMDL_FIR
comma
id|OBOE_PMDL
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_SMDL_FIR
comma
id|OBOE_SMDL
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0
comma
id|OBOE_UDIV
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sti
(paren
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x01
comma
id|OBOE_REG_9
)paren
suffix:semicolon
)brace
multiline_comment|/* Wake the chip up and get it looking at the taskfile */
r_static
r_void
DECL|function|toshoboe_startchip
id|toshoboe_startchip
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u32
id|physaddr
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|OBOE_LOCK
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
id|OBOE_NTR_VAL
comma
id|OBOE_NTR
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xf0
comma
id|OBOE_REG_D
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_ISR
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0f
comma
id|OBOE_REG_1A
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xff
comma
id|OBOE_REG_1B
)paren
suffix:semicolon
id|physaddr
op_assign
id|virt_to_bus
(paren
id|self-&gt;taskfile
)paren
suffix:semicolon
id|outb_p
(paren
(paren
id|physaddr
op_rshift
l_int|0x0a
)paren
op_amp
l_int|0xff
comma
id|OBOE_TFP0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
id|physaddr
op_rshift
l_int|0x12
)paren
op_amp
l_int|0xff
comma
id|OBOE_TFP1
)paren
suffix:semicolon
id|outb_p
(paren
(paren
id|physaddr
op_rshift
l_int|0x1a
)paren
op_amp
l_int|0x3f
comma
id|OBOE_TFP2
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0e
comma
id|OBOE_REG_11
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
comma
l_int|9600
)paren
suffix:semicolon
)brace
multiline_comment|/*Let the chip look at memory */
r_static
r_void
DECL|function|toshoboe_enablebm
id|toshoboe_enablebm
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_master
(paren
id|self-&gt;pdev
)paren
suffix:semicolon
)brace
multiline_comment|/*Don&squot;t let the chip look at memory */
r_static
r_void
DECL|function|toshoboe_disablebm
id|toshoboe_disablebm
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u8
id|command
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|self-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_byte
(paren
id|self-&gt;pdev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
)brace
multiline_comment|/*setup the taskfile */
r_static
r_void
DECL|function|toshoboe_initbuffs
id|toshoboe_initbuffs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|control
op_assign
l_int|0x00
suffix:semicolon
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|buffer
op_assign
id|virt_to_bus
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;taskfile-&gt;recv
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;taskfile-&gt;recv
(braket
id|i
)braket
dot
id|control
op_assign
l_int|0x83
suffix:semicolon
id|self-&gt;taskfile-&gt;recv
(braket
id|i
)braket
dot
id|buffer
op_assign
id|virt_to_bus
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|sti
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*Transmit something */
r_static
r_int
DECL|function|toshoboe_hard_xmit
id|toshoboe_hard_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|irda_device
op_star
id|idev
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_int
id|mtt
comma
id|len
suffix:semicolon
id|idev
op_assign
(paren
r_struct
id|irda_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|idev
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev-&gt;magic
op_eq
id|IRDA_DEVICE_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
macro_line|#ifdef ONETASK
r_if
c_cond
(paren
id|self-&gt;txpending
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|self-&gt;txs
op_assign
id|inb_p
(paren
id|OBOE_XMTT
)paren
op_minus
id|OBOE_XMTT_OFFSET
suffix:semicolon
id|self-&gt;txs
op_and_assign
l_int|0x3f
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|self-&gt;taskfile-&gt;xmit
(braket
id|self-&gt;txs
)braket
dot
id|control
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
(paren
id|OBOE_RST
)paren
op_amp
id|OBOE_RST_WRAP
)paren
(brace
id|len
op_assign
id|async_wrap_skb
(paren
id|skb
comma
id|self-&gt;xmit_bufs
(braket
id|self-&gt;txs
)braket
comma
id|TX_BUF_SZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
(paren
id|self-&gt;xmit_bufs
(braket
id|self-&gt;txs
)braket
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
)brace
id|self-&gt;taskfile-&gt;xmit
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|len
op_amp
l_int|0x0fff
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x1e
comma
id|OBOE_REG_11
)paren
suffix:semicolon
id|self-&gt;taskfile-&gt;xmit
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
l_int|0x84
suffix:semicolon
id|mtt
op_assign
id|irda_get_mtt
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
id|udelay
(paren
id|mtt
)paren
suffix:semicolon
id|self-&gt;txpending
op_increment
suffix:semicolon
multiline_comment|/*FIXME: ask about tbusy,media_busy stuff, for the moment */
multiline_comment|/*tbusy means can&squot;t queue any more */
macro_line|#ifndef ONETASK
r_if
c_cond
(paren
id|self-&gt;txpending
op_eq
id|TX_SLOTS
)paren
(brace
macro_line|#else
(brace
macro_line|#endif
r_if
c_cond
(paren
id|irda_lock
(paren
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
op_eq
id|FALSE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|outb_p
(paren
l_int|0x80
comma
id|OBOE_RST
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|OBOE_REG_9
)paren
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*interrupt handler */
r_static
r_void
DECL|function|toshoboe_interrupt
id|toshoboe_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|irda_device
op_star
id|idev
op_assign
(paren
r_struct
id|irda_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|__u8
id|irqstat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|idev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self
)paren
r_return
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irqstat
op_assign
id|inb_p
(paren
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/* woz it us */
r_if
c_cond
(paren
op_logical_neg
(paren
id|irqstat
op_amp
l_int|0xf8
)paren
)paren
r_return
suffix:semicolon
id|outb_p
(paren
id|irqstat
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*Acknologede it */
multiline_comment|/* Txdone */
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_TXDONE
)paren
(brace
id|self-&gt;txpending
op_decrement
suffix:semicolon
id|idev-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|idev-&gt;media_busy
op_assign
id|FALSE
suffix:semicolon
id|idev-&gt;netdev.tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_RXDONE
)paren
(brace
macro_line|#ifdef ONETASK
id|self-&gt;rxs
op_assign
id|inb_p
(paren
id|OBOE_RCVT
)paren
suffix:semicolon
id|self-&gt;rxs
op_add_assign
(paren
id|RX_SLOTS
op_minus
l_int|1
)paren
suffix:semicolon
id|self-&gt;rxs
op_mod_assign
id|RX_SLOTS
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_eq
l_int|0
)paren
macro_line|#endif
(brace
r_int
id|len
op_assign
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|2
)paren
id|len
op_sub_assign
l_int|2
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb_reserve
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
(paren
id|skb-&gt;data
comma
id|self-&gt;recv_bufs
(braket
id|self-&gt;rxs
)braket
comma
id|len
)paren
suffix:semicolon
id|idev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
op_amp
id|idev-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
id|__FUNCTION__
l_string|&quot;(), memory squeeze, dropping frame.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_assign
l_int|0x83
suffix:semicolon
id|self-&gt;taskfile-&gt;recv
(braket
id|self-&gt;rxs
)braket
dot
id|len
op_assign
l_int|0x0
suffix:semicolon
id|self-&gt;rxs
op_increment
suffix:semicolon
id|self-&gt;rxs
op_mod_assign
id|RX_SLOTS
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_20
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Oboe_irq: 20&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_ISR_10
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Oboe_irq: 10&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
l_int|0x8
)paren
(brace
multiline_comment|/*FIXME: I think this is a TX or RX error of some sort */
id|idev-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|idev-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Change the baud rate */
r_static
r_void
DECL|function|toshoboe_change_speed
id|toshoboe_change_speed
(paren
r_struct
id|irda_device
op_star
id|idev
comma
r_int
id|speed
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev-&gt;magic
op_eq
id|IRDA_DEVICE_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|idev-&gt;io.baudrate
op_assign
id|speed
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
)brace
multiline_comment|/* Check all xmit_tasks finished */
r_static
r_void
DECL|function|toshoboe_wait_until_sent
id|toshoboe_wait_until_sent
(paren
r_struct
id|irda_device
op_star
id|idev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev-&gt;magic
op_eq
id|IRDA_DEVICE_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_while
c_loop
(paren
id|self-&gt;taskfile-&gt;xmit
(braket
id|i
)braket
dot
id|control
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
(paren
l_int|6
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
DECL|function|toshoboe_is_receiving
id|toshoboe_is_receiving
(paren
r_struct
id|irda_device
op_star
id|idev
)paren
(brace
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*FIXME Can&squot;t tell! */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_init
id|toshoboe_net_init
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup to be a normal IrDA network device driver */
id|irda_device_setup
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Insert overrides below this line! */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_open
id|toshoboe_net_open
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|irda_device
op_star
id|idev
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|idev
op_assign
(paren
r_struct
id|irda_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|idev
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev-&gt;magic
op_eq
id|IRDA_DEVICE_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|idev-&gt;io.irq
comma
id|toshoboe_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
id|idev-&gt;name
comma
(paren
r_void
op_star
)paren
id|idev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|toshoboe_initbuffs
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_enablebm
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/*FIXME: need to test this carefully to check which one */
multiline_comment|/*of the two possible startup logics the chip uses */
multiline_comment|/*although it won&squot;t make any difference if no-one xmits durining init */
multiline_comment|/*and none what soever if using ONETASK */
id|self-&gt;rxs
op_assign
id|inb_p
(paren
id|OBOE_RCVT
)paren
suffix:semicolon
id|self-&gt;txs
op_assign
id|inb_p
(paren
id|OBOE_XMTT
)paren
op_minus
id|OBOE_XMTT_OFFSET
suffix:semicolon
macro_line|#if 0
id|self-&gt;rxs
op_assign
l_int|0
suffix:semicolon
id|self-&gt;txs
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|self-&gt;rxs
op_assign
id|RX_SLOTS
op_minus
l_int|1
suffix:semicolon
id|self-&gt;txs
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|self-&gt;txpending
op_assign
l_int|0
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_close
id|toshoboe_net_close
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|irda_device
op_star
id|idev
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|idev
op_assign
(paren
r_struct
id|irda_device
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|idev
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev-&gt;magic
op_eq
id|IRDA_DEVICE_MAGIC
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|free_irq
(paren
id|idev-&gt;io.irq
comma
(paren
r_void
op_star
)paren
id|idev
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_disablebm
(paren
id|self
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_static
r_int
DECL|function|toshoboe_close
id|toshoboe_close
(paren
r_struct
id|irda_device
op_star
id|idev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
(paren
id|idev-&gt;magic
op_eq
id|IRDA_DEVICE_MAGIC
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|idev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|release_region
(paren
id|idev-&gt;io.iobase
comma
id|idev-&gt;io.io_ext
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;xmit_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;recv_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
(paren
id|self-&gt;taskfilebuf
)paren
suffix:semicolon
id|self-&gt;taskfilebuf
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;taskfile
op_assign
l_int|NULL
suffix:semicolon
id|irda_device_close
(paren
id|idev
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|toshoboe_open
id|toshoboe_open
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_struct
id|irda_device
op_star
id|idev
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|NSELFS
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;Oboe: No more instances available&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|self
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|toshoboe_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;IrDA: Can&squot;t allocate memory for &quot;
l_string|&quot;IrDA control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|toshoboe_cb
)paren
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
id|self-&gt;pdev
op_assign
id|pci_dev
suffix:semicolon
id|self-&gt;base
op_assign
id|pci_dev-&gt;base_address
(braket
l_int|0
)braket
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|idev
op_assign
op_amp
id|self-&gt;idev
suffix:semicolon
multiline_comment|/*Setup idev */
id|idev-&gt;io.iobase
op_assign
id|self-&gt;base
suffix:semicolon
id|idev-&gt;io.irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
id|idev-&gt;io.io_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
multiline_comment|/* Lock the port that we need */
id|i
op_assign
id|check_region
(paren
id|idev-&gt;io.iobase
comma
id|idev-&gt;io.io_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DEBUG
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|idev-&gt;io.iobase
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
(paren
id|idev-&gt;io.iobase
comma
id|idev-&gt;io.io_ext
comma
id|driver_name
)paren
suffix:semicolon
id|irda_init_max_qos_capabilies
(paren
op_amp
id|idev-&gt;qos
)paren
suffix:semicolon
id|idev-&gt;qos.baud_rate.bits
op_assign
id|IR_2400
op_or
multiline_comment|/*IR_4800 | */
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_115200
suffix:semicolon
macro_line|#ifdef ENABLE_FAST
id|idev-&gt;qos.baud_rate.bits
op_or_assign
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
macro_line|#endif
id|idev-&gt;qos.min_turn_time.bits
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/*FIXME: what does this do? */
id|irda_qos_bits_to_value
(paren
op_amp
id|idev-&gt;qos
)paren
suffix:semicolon
id|idev-&gt;flags
op_assign
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
suffix:semicolon
macro_line|#ifdef ENABLE_FAST
id|idev-&gt;flags
op_or_assign
id|IFF_FIR
suffix:semicolon
macro_line|#endif
multiline_comment|/* These aren&squot;t much use as we need to have a whole panoply of&n;   * buffers running */
id|idev-&gt;rx_buff.flags
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;tx_buff.flags
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;rx_buff.truesize
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;rx_buff.truesize
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;change_speed
op_assign
id|toshoboe_change_speed
suffix:semicolon
id|idev-&gt;wait_until_sent
op_assign
id|toshoboe_wait_until_sent
suffix:semicolon
id|idev-&gt;is_receiving
op_assign
id|toshoboe_is_receiving
suffix:semicolon
id|idev-&gt;netdev.init
op_assign
id|toshoboe_net_init
suffix:semicolon
id|idev-&gt;netdev.hard_start_xmit
op_assign
id|toshoboe_hard_xmit
suffix:semicolon
id|idev-&gt;netdev.open
op_assign
id|toshoboe_net_open
suffix:semicolon
id|idev-&gt;netdev.stop
op_assign
id|toshoboe_net_close
suffix:semicolon
multiline_comment|/* Now setup the endless buffers we need */
id|self-&gt;txs
op_assign
l_int|0
suffix:semicolon
id|self-&gt;rxs
op_assign
l_int|0
suffix:semicolon
id|self-&gt;taskfilebuf
op_assign
id|kmalloc
(paren
id|OBOE_TASK_BUF_LEN
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;taskfilebuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;toshoboe: kmalloc for DMA failed()&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|self-&gt;taskfilebuf
comma
l_int|0
comma
id|OBOE_TASK_BUF_LEN
)paren
suffix:semicolon
multiline_comment|/*We need to align the taskfile on a taskfile size boundary */
(brace
id|__u32
id|addr
suffix:semicolon
id|addr
op_assign
(paren
id|__u32
)paren
id|self-&gt;taskfilebuf
suffix:semicolon
id|addr
op_and_assign
op_complement
(paren
r_sizeof
(paren
r_struct
id|OboeTaskFile
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
r_struct
id|OboeTaskFile
)paren
suffix:semicolon
id|self-&gt;taskfile
op_assign
(paren
r_struct
id|OboeTaskFile
op_star
)paren
id|addr
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;xmit_bufs
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
id|TX_BUF_SZ
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
id|ok
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;recv_bufs
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
id|TX_BUF_SZ
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
id|ok
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok
op_ne
id|RX_SLOTS
op_plus
id|TX_SLOTS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;toshoboe: kmalloc for buffers failed()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|self-&gt;xmit_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|self-&gt;recv_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|irda_device_open
(paren
id|idev
comma
id|driver_name
comma
id|self
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: Using &quot;
)paren
suffix:semicolon
macro_line|#ifdef ONETASK
id|printk
(paren
l_string|&quot;single&quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
(paren
l_string|&quot;multiple&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
(paren
l_string|&quot; tasks, version %s&bslash;n&quot;
comma
id|rcsid
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|toshoboe_init
r_int
id|__init
id|toshoboe_init
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|pci_dev
op_assign
id|pci_find_device
(paren
id|PCI_VENDOR_ID_TOSHIBA
comma
id|PCI_DEVICE_ID_FIR701
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;ToshOboe: Found 701 chip at 0x%0lx irq %d&bslash;n&quot;
comma
id|pci_dev-&gt;base_address
(braket
l_int|0
)braket
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
comma
id|pci_dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|toshoboe_open
(paren
id|pci_dev
)paren
)paren
id|found
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_static
r_void
DECL|function|toshoboe_cleanup
id|toshoboe_cleanup
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|toshoboe_close
(paren
op_amp
(paren
id|dev_self
(braket
id|i
)braket
op_member_access_from_pointer
id|idev
)paren
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|init_module
id|init_module
(paren
r_void
)paren
(brace
r_return
id|toshoboe_init
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
(paren
r_void
)paren
(brace
id|toshoboe_cleanup
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
