multiline_comment|/*********************************************************************&n; *                &n; * Filename:      airport.c&n; * Version:       0.2&n; * Description:   Implementation for the Adaptec Airport 1000 and 2000 &n; *                dongles&n; * Status:        Experimental.&n; * Author:        Fons Botman &lt;budely@tref.nl&gt;&n; * Created at:    Wed May 19 23:14:34 CEST 1999&n; * Based on:      actisys.c by Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1998-1999 Fons Botman, All Rights Reserved.&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; *     Neither Fons Botman nor anyone else admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *     &n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
r_static
r_int
id|airport_reset_wrapper
c_func
(paren
r_struct
id|irda_task
op_star
id|task
)paren
suffix:semicolon
r_static
r_void
id|airport_open
c_func
(paren
id|dongle_t
op_star
id|self
comma
r_struct
id|qos_info
op_star
id|qos
)paren
suffix:semicolon
r_static
r_void
id|airport_close
c_func
(paren
id|dongle_t
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|airport_change_speed_wrapper
c_func
(paren
r_struct
id|irda_task
op_star
id|task
)paren
suffix:semicolon
DECL|variable|dongle
r_static
r_struct
id|dongle_reg
id|dongle
op_assign
(brace
id|Q_NULL
comma
id|IRDA_AIRPORT_DONGLE
comma
id|airport_open
comma
id|airport_close
comma
id|airport_reset_wrapper
comma
id|airport_change_speed_wrapper
comma
)brace
suffix:semicolon
DECL|function|airport_init
r_int
id|__init
id|airport_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|irda_device_register_dongle
c_func
(paren
op_amp
id|dongle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|airport_cleanup
r_void
id|airport_cleanup
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|irda_device_unregister_dongle
c_func
(paren
op_amp
id|dongle
)paren
suffix:semicolon
)brace
DECL|function|airport_open
r_static
r_void
id|airport_open
c_func
(paren
id|dongle_t
op_star
id|self
comma
r_struct
id|qos_info
op_star
id|qos
)paren
(brace
id|qos-&gt;baud_rate.bits
op_and_assign
id|IR_2400
op_or
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
suffix:semicolon
multiline_comment|/* May need 1ms */
id|qos-&gt;min_turn_time.bits
op_and_assign
l_int|0x07
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
DECL|function|airport_close
r_static
r_void
id|airport_close
c_func
(paren
id|dongle_t
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Power off dongle */
id|self
op_member_access_from_pointer
id|set_dtr_rts
c_func
(paren
id|self-&gt;dev
comma
id|FALSE
comma
id|FALSE
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|airport_set_command_mode
r_static
r_void
id|airport_set_command_mode
c_func
(paren
id|dongle_t
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|set_dtr_rts
c_func
(paren
id|self-&gt;dev
comma
id|FALSE
comma
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|airport_set_normal_mode
r_static
r_void
id|airport_set_normal_mode
c_func
(paren
id|dongle_t
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|set_dtr_rts
c_func
(paren
id|self-&gt;dev
comma
id|TRUE
comma
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|airport_write_char
r_void
id|airport_write_char
c_func
(paren
id|dongle_t
op_star
id|self
comma
r_int
r_char
id|c
)paren
(brace
r_int
id|actual
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(,0x%x)&bslash;n&quot;
comma
id|c
op_amp
l_int|0xff
)paren
suffix:semicolon
id|actual
op_assign
id|self
op_member_access_from_pointer
id|write
c_func
(paren
id|self-&gt;dev
comma
op_amp
id|c
comma
l_int|1
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|actual
op_eq
l_int|1
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
)brace
DECL|macro|JIFFIES_TO_MSECS
mdefine_line|#define JIFFIES_TO_MSECS(j) ((j)*1000/HZ)
DECL|function|airport_waitfor_char
r_static
r_int
id|airport_waitfor_char
c_func
(paren
id|dongle_t
op_star
id|self
comma
r_int
r_char
id|c
)paren
(brace
id|__u8
id|buf
(braket
l_int|100
)braket
suffix:semicolon
r_int
id|i
comma
id|found
op_assign
id|FALSE
suffix:semicolon
r_int
id|before
suffix:semicolon
r_int
id|len
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(,0x%x)&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* Sleep approx. 10 ms */
id|before
op_assign
id|jiffies
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|MSECS_TO_JIFFIES
c_func
(paren
l_int|20
)paren
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot; waited %ldms&bslash;n&quot;
comma
id|JIFFIES_TO_MSECS
c_func
(paren
id|jiffies
op_minus
id|before
)paren
)paren
suffix:semicolon
id|len
op_assign
id|self
op_member_access_from_pointer
id|read
c_func
(paren
id|self-&gt;dev
comma
id|buf
comma
l_int|100
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|found
op_logical_and
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* IRDA_DEBUG(6, __FUNCTION__ &quot; 0x02x&bslash;n&quot;, idev-&gt;rx_buff.data[i]); */
id|found
op_assign
id|c
op_eq
id|buf
(braket
id|i
)braket
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot; returns %s&bslash;n&quot;
comma
(paren
id|found
ques
c_cond
l_string|&quot;true&quot;
suffix:colon
l_string|&quot;false&quot;
)paren
)paren
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
DECL|function|airport_check_command_mode
r_static
r_int
id|airport_check_command_mode
c_func
(paren
id|dongle_t
op_star
id|self
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|found
op_assign
id|FALSE
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|MSECS_TO_JIFFIES
c_func
(paren
l_int|20
)paren
)paren
suffix:semicolon
id|airport_set_command_mode
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Loop until the time expires (200ms) or we get the magic char. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|25
suffix:semicolon
id|i
op_increment
)paren
(brace
id|airport_write_char
c_func
(paren
id|self
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airport_waitfor_char
c_func
(paren
id|self
comma
l_int|0xc3
)paren
)paren
(brace
id|found
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot; OK. (%d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot; FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|found
suffix:semicolon
)brace
DECL|function|airport_write_register
r_static
r_int
id|airport_write_register
c_func
(paren
id|dongle_t
op_star
id|self
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|ok
op_assign
id|FALSE
suffix:semicolon
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(,0x%x)&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
id|airport_check_command_mode
c_func
(paren
id|self
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|airport_write_char
c_func
(paren
id|self
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|airport_waitfor_char
c_func
(paren
id|self
comma
id|reg
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Now read it back */
id|airport_write_char
c_func
(paren
id|self
comma
(paren
id|reg
op_lshift
l_int|4
)paren
op_or
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airport_waitfor_char
c_func
(paren
id|self
comma
id|reg
)paren
)paren
(brace
id|ok
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|airport_set_normal_mode
c_func
(paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(,0x%x) returns OK&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(,0x%x) returns False!&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
)brace
r_return
id|ok
suffix:semicolon
)brace
multiline_comment|/*&n; * Function airport_change_speed (self, speed)&n; *&n; *    Change speed of the Airport type IrDA dongles.&n; */
DECL|function|airport_change_speed
r_static
r_void
id|airport_change_speed
c_func
(paren
id|dongle_t
op_star
id|self
comma
id|__u32
id|speed
)paren
(brace
id|__u32
id|current_baudrate
suffix:semicolon
r_int
id|baudcode
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(,%d)&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Find the correct baudrate code for the required baudrate */
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|2400
suffix:colon
id|baudcode
op_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|baudcode
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|baudcode
op_assign
l_int|0x30
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|baudcode
op_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|baudcode
op_assign
l_int|0x50
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|baudcode
op_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|baudcode
op_assign
l_int|0x70
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot; bad baud rate: %d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|current_baudrate
op_assign
id|self-&gt;speed
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot; current baudrate: %d&bslash;n&quot;
comma
id|current_baudrate
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|self-&gt;dev
comma
id|IRDA_RAW
)paren
suffix:semicolon
multiline_comment|/* Set the new speed in both registers */
r_if
c_cond
(paren
id|airport_write_register
c_func
(paren
id|self
comma
id|baudcode
)paren
)paren
(brace
r_if
c_cond
(paren
id|airport_write_register
c_func
(paren
id|self
comma
id|baudcode
op_or
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* ok */
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot; Cannot set new speed in second register&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot; Cannot set new speed in first register&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|self
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|self-&gt;dev
comma
id|IRDA_IRLAP
)paren
suffix:semicolon
multiline_comment|/* How do I signal an error in these functions? */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot; returning&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|airport_change_speed_wrapper
r_int
id|airport_change_speed_wrapper
c_func
(paren
r_struct
id|irda_task
op_star
id|task
)paren
(brace
id|dongle_t
op_star
id|self
op_assign
(paren
id|dongle_t
op_star
)paren
id|task-&gt;instance
suffix:semicolon
id|__u32
id|speed
op_assign
(paren
id|__u32
)paren
id|task-&gt;param
suffix:semicolon
id|irda_execute_as_process
c_func
(paren
id|self
comma
(paren
id|TODO_CALLBACK
)paren
id|airport_change_speed
comma
id|speed
)paren
suffix:semicolon
id|irda_task_next_state
c_func
(paren
id|task
comma
id|IRDA_TASK_DONE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function airport_reset (self)&n; *&n; *      Reset the Airport type dongle. Warning, this function must only be&n; *      called with a process context!&n; *&n; */
DECL|function|airport_reset
r_static
r_void
id|airport_reset
c_func
(paren
id|dongle_t
op_star
id|self
)paren
(brace
r_int
id|ok
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;()&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|self
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|self-&gt;dev
comma
id|IRDA_RAW
)paren
suffix:semicolon
id|airport_set_normal_mode
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Sleep 2000 ms */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot; waiting for powerup&bslash;n&quot;
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|MSECS_TO_JIFFIES
c_func
(paren
l_int|2000
)paren
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot; finished waiting for powerup&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* set dongle speed to 9600 */
id|ok
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
id|ok
op_assign
id|airport_write_register
c_func
(paren
id|self
comma
l_int|0x30
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
id|MESSAGE
c_func
(paren
id|__FUNCTION__
l_string|&quot;() dongle not connected?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
id|ok
op_assign
id|airport_write_register
c_func
(paren
id|self
comma
l_int|0x31
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
id|ok
op_assign
id|airport_write_register
c_func
(paren
id|self
comma
l_int|0x02
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
id|ok
op_assign
id|airport_write_register
c_func
(paren
id|self
comma
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
(brace
id|ok
op_assign
id|airport_check_command_mode
c_func
(paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
(brace
id|airport_write_char
c_func
(paren
id|self
comma
l_int|0x04
)paren
suffix:semicolon
id|ok
op_assign
id|airport_waitfor_char
c_func
(paren
id|self
comma
l_int|0x04
)paren
suffix:semicolon
)brace
id|airport_set_normal_mode
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
id|self
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|self-&gt;dev
comma
id|IRDA_IRLAP
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|MSECS_TO_JIFFIES
c_func
(paren
l_int|20
)paren
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot; waited 20ms&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;speed
op_assign
l_int|9600
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
id|MESSAGE
c_func
(paren
id|__FUNCTION__
l_string|&quot;() failed.&bslash;n&quot;
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot; returning.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|airport_reset_wrapper
r_int
id|airport_reset_wrapper
c_func
(paren
r_struct
id|irda_task
op_star
id|task
)paren
(brace
id|dongle_t
op_star
id|self
op_assign
(paren
id|dongle_t
op_star
)paren
id|task-&gt;instance
suffix:semicolon
id|irda_execute_as_process
c_func
(paren
id|self
comma
(paren
id|TODO_CALLBACK
)paren
id|airport_reset
comma
l_int|0
)paren
suffix:semicolon
id|irda_task_next_state
c_func
(paren
id|task
comma
id|IRDA_TASK_DONE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Fons Botman &lt;budely@tref.nl&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Adaptec Airport 1000 and 2000 dongle driver&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Function init_module (void)&n; *&n; *    Initialize Airport module&n; *&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|airport_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function cleanup_module (void)&n; *&n; *    Cleanup Airport module&n; *&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|airport_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
