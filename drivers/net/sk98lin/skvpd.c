multiline_comment|/******************************************************************************&n; *&n; * Name:&t;skvpd.c&n; * Project:&t;GEnesis, PCI Gigabit Ethernet Adapter&n; * Version:&t;$Revision: 1.27 $&n; * Date:&t;$Date: 2000/08/10 11:29:06 $&n; * Purpose:&t;Shared software to read and write VPD data&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998-2000 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * History:&n; *&n; *&t;$Log: skvpd.c,v $&n; *&t;Revision 1.27  2000/08/10 11:29:06  rassmann&n; *&t;Editorial changes.&n; *&t;Preserving 32-bit alignment in structs for the adapter context.&n; *&t;Removed unused function VpdWriteDword() (#if 0).&n; *&t;Made VpdReadKeyword() available for SKDIAG only.&n; *&t;&n; *&t;Revision 1.26  2000/06/13 08:00:01  mkarl&n; *&t;additional cast to avoid compile problems in 64 bit environment&n; *&t;&n; *&t;Revision 1.25  1999/11/22 13:39:32  cgoos&n; *&t;Changed license header to GPL.&n; *&t;&n; *&t;Revision 1.24  1999/03/11 14:25:49  malthoff&n; *&t;Replace __STDC__ with SK_KR_PROTO.&n; *&t;&n; *&t;Revision 1.23  1999/01/11 15:13:11  gklug&n; *&t;fix: syntax error&n; *&t;&n; *&t;Revision 1.22  1998/10/30 06:41:15  gklug&n; *&t;rmv: WARNING&n; *&t;&n; *&t;Revision 1.21  1998/10/29 07:15:14  gklug&n; *&t;fix: Write Stream function needs verify.&n; *&t;&n; *&t;Revision 1.20  1998/10/28 18:05:08  gklug&n; *&t;chg: no DEBUG in VpdMayWrite&n; *&t;&n; *&t;Revision 1.19  1998/10/28 15:56:11  gklug&n; *&t;fix: Return len at end of ReadStream&n; *&t;fix: Write even less than 4 bytes correctly&n; *&t;&n; *&t;Revision 1.18  1998/10/28 09:00:47  gklug&n; *&t;fix: unreferenced local vars&n; *&t;&n; *&t;Revision 1.17  1998/10/28 08:25:45  gklug&n; *&t;fix: WARNING&n; *&t;&n; *&t;Revision 1.16  1998/10/28 08:17:30  gklug&n; *&t;fix: typo&n; *&t;&n; *&t;Revision 1.15  1998/10/28 07:50:32  gklug&n; *&t;fix: typo&n; *&t;&n; *&t;Revision 1.14  1998/10/28 07:20:38  gklug&n; *&t;chg: Interface functions to use IoC as parameter as well&n; *&t;fix: VpdRead/WriteDWord now returns SK_U32&n; *&t;chg: VPD_IN/OUT names conform to SK_IN/OUT&n; *&t;add: usage of VPD_IN/OUT8 macros&n; *&t;add: VpdRead/Write Stream functions to r/w a stream of data&n; *&t;fix: VpdTransferBlock swapped illeagal&n; *&t;add: VpdMayWrite&n; *&t;&n; *&t;Revision 1.13  1998/10/22 10:02:37  gklug&n; *&t;fix: SysKonnectFileId typo&n; *&t;&n; *&t;Revision 1.12  1998/10/20 10:01:01  gklug&n; *&t;fix: parameter to SkOsGetTime&n; *&t;&n; *&t;Revision 1.11  1998/10/15 12:51:48  malthoff&n; *&t;Remove unrequired parameter p in vpd_setup_para().&n; *&t;&n; *&t;Revision 1.10  1998/10/08 14:52:43  malthoff&n; *&t;Remove CvsId by SysKonnectFileId.&n; *&t;&n; *&t;Revision 1.9  1998/09/16 07:33:52  malthoff&n; *&t;remove memcmp() by SK_MEMCMP and&n; *&t;memcpy() by SK_MEMCPY() to be&n; *&t;independant from the &squot;C&squot; Standard Library.&n; *&t;&n; *&t;Revision 1.8  1998/08/19 12:52:35  malthoff&n; *&t;compiler fix: use SK_VPD_KEY instead of S_VPD.&n; *&t;&n; *&t;Revision 1.7  1998/08/19 08:14:01  gklug&n; *&t;fix: remove struct keyword as much as possible from the c-code (see CCC)&n; *&t;&n; *&t;Revision 1.6  1998/08/18 13:03:58  gklug&n; *&t;SkOsGetTime now returns SK_U64&n; *&t;&n; *&t;Revision 1.5  1998/08/18 08:17:29  malthoff&n; *&t;Ensure we issue a VPD read in vpd_read_dword().&n; *&t;Discard all VPD keywords other than Vx or Yx, where&n; *&t;x is &squot;0..9&squot; or &squot;A..Z&squot;.&n; *&t;&n; *&t;Revision 1.4  1998/07/03 14:52:19  malthoff&n; *&t;Add category SK_DBGCAT_FATAL to some debug macros.&n; *&t;bug fix: correct the keyword name check in vpd_write().&n; *&t;&n; *&t;Revision 1.3  1998/06/26 11:16:53  malthoff&n; *&t;Correct the modified File Identifier.&n; *&t;&n; *&t;Revision 1.2  1998/06/26 11:13:43  malthoff&n; *&t;Modify the File Identifier.&n; *&t;&n; *&t;Revision 1.1  1998/06/19 14:11:08  malthoff&n; *&t;Created, Tests with AIX were performed successfully&n; *&t;&n; *&n; ******************************************************************************/
multiline_comment|/*&n;&t;Please refer skvpd.txt for infomation how to include this module&n; */
DECL|variable|SysKonnectFileId
r_static
r_const
r_char
id|SysKonnectFileId
(braket
)braket
op_assign
l_string|&quot;@(#)$Id: skvpd.c,v 1.27 2000/08/10 11:29:06 rassmann Exp $ (C) SK&quot;
suffix:semicolon
macro_line|#include &quot;h/skdrv1st.h&quot;
macro_line|#include &quot;h/sktypes.h&quot;
macro_line|#include &quot;h/skdebug.h&quot;
macro_line|#include &quot;h/skdrv2nd.h&quot;
multiline_comment|/*&n; * Static functions&n; */
macro_line|#ifndef SK_KR_PROTO
r_static
id|SK_VPD_PARA
op_star
id|vpd_find_para
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
r_char
op_star
id|key
comma
id|SK_VPD_PARA
op_star
id|p
)paren
suffix:semicolon
macro_line|#else&t;/* SK_KR_PROTO */
r_static
id|SK_VPD_PARA
op_star
id|vpd_find_para
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif&t;/* SK_KR_PROTO */
multiline_comment|/*&n; * waits for a completetion of a VPD transfer&n; * The VPD transfer must complete within SK_TICKS_PER_SEC/16&n; *&n; * returns&t;0:&t;success, transfer completes&n; *&t;&t;error&t;exit(9) with a error message&n; */
DECL|function|VpdWait
r_static
r_int
id|VpdWait
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_int
id|event
)paren
multiline_comment|/* event to wait for (VPD_READ / VPD_write) completion*/
(brace
id|SK_U64
id|start_time
suffix:semicolon
id|SK_U16
id|state
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd wait for %s&bslash;n&quot;
comma
id|event
ques
c_cond
l_string|&quot;Write&quot;
suffix:colon
l_string|&quot;Read&quot;
)paren
)paren
suffix:semicolon
id|start_time
op_assign
id|SkOsGetTime
c_func
(paren
id|pAC
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|SkOsGetTime
c_func
(paren
id|pAC
)paren
op_minus
id|start_time
OG
id|SK_TICKS_PER_SEC
op_div
l_int|16
)paren
(brace
id|VPD_STOP
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_FATAL
op_or
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;ERROR:vpd wait timeout&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|VPD_IN16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
op_amp
id|state
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;state = %x, event %x&bslash;n&quot;
comma
id|state
comma
id|event
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
r_int
)paren
(paren
id|state
op_amp
id|PCI_VPD_FLAG
)paren
op_eq
id|event
)paren
(brace
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef SKDIAG
multiline_comment|/*&n; * Read the dword at address &squot;addr&squot; from the VPD EEPROM.&n; *&n; * Needed Time:&t;MIN 1,3 ms&t;MAX 2,6 ms&n; *&n; * Note: The DWord is returned in the endianess of the machine the routine&n; *       is running on.&n; *&n; * Returns the data read.&n; */
DECL|function|VpdReadDWord
id|SK_U32
id|VpdReadDWord
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_int
id|addr
)paren
multiline_comment|/* VPD address */
(brace
id|SK_U32
id|Rtv
suffix:semicolon
multiline_comment|/* start VPD read */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd read dword at 0x%x&bslash;n&quot;
comma
id|addr
)paren
)paren
suffix:semicolon
id|addr
op_and_assign
op_complement
id|VPD_WRITE
suffix:semicolon
multiline_comment|/* ensure the R/W bit is set to read */
id|VPD_OUT16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
(paren
id|SK_U16
)paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* ignore return code here */
(paren
r_void
)paren
id|VpdWait
c_func
(paren
id|pAC
comma
id|IoC
comma
id|VPD_READ
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t swap here, it&squot;s a data stream of bytes */
id|Rtv
op_assign
l_int|0
suffix:semicolon
id|VPD_IN32
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_DAT_REG
comma
op_amp
id|Rtv
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd read dword data = 0x%x&bslash;n&quot;
comma
id|Rtv
)paren
)paren
suffix:semicolon
r_return
(paren
id|Rtv
)paren
suffix:semicolon
)brace
macro_line|#endif&t;
singleline_comment|// SKDIAG
macro_line|#if 0
multiline_comment|/*&n;&t;Write the dword &squot;data&squot; at address &squot;addr&squot; into the VPD EEPROM, and&n;&t;verify that the data is written.&n;&n; Needed Time:&n;&n;.&t;&t;&t;&t;MIN&t;&t;MAX&n;. -------------------------------------------------------------------&n;. write&t;&t;&t;&t;1.8 ms&t;&t;3.6 ms&n;. internal write cyles&t;&t;0.7 ms&t;&t;7.0 ms&n;. -------------------------------------------------------------------&n;. over all program time&t; &t;2.5 ms&t;&t;10.6 ms&n;. read&t;&t;&t;&t;1.3 ms&t;&t;2.6 ms&n;. -------------------------------------------------------------------&n;. over all &t;&t;&t;3.8 ms&t;&t;13.2 ms&n;.&n;&n;&n; Returns&t;0:&t;success&n;&t;&t;&t;1:&t;error,&t;I2C transfer does not terminate&n;&t;&t;&t;2:&t;error,&t;data verify error&n;&n; */
r_static
r_int
id|VpdWriteDWord
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pAC pointer */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_int
id|addr
comma
multiline_comment|/* VPD address */
id|SK_U32
id|data
)paren
multiline_comment|/* VPD data to write */
(brace
multiline_comment|/* start VPD write */
multiline_comment|/* Don&squot;t swap here, it&squot;s a data stream of bytes */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd write dword at addr 0x%x, data = 0x%x&bslash;n&quot;
comma
id|addr
comma
id|data
)paren
)paren
suffix:semicolon
id|VPD_OUT32
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_DAT_REG
comma
(paren
id|SK_U32
)paren
id|data
)paren
suffix:semicolon
multiline_comment|/* But do it here */
id|addr
op_or_assign
id|VPD_WRITE
suffix:semicolon
id|VPD_OUT16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
(paren
id|SK_U16
)paren
(paren
id|addr
op_or
id|VPD_WRITE
)paren
)paren
suffix:semicolon
multiline_comment|/* this may take up to 10,6 ms */
r_if
c_cond
(paren
id|VpdWait
c_func
(paren
id|pAC
comma
id|IoC
comma
id|VPD_WRITE
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;Write Timed Out&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* verify data */
r_if
c_cond
(paren
id|VpdReadDWord
c_func
(paren
id|pAC
comma
id|IoC
comma
id|addr
)paren
op_ne
id|data
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Data Verify Error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* VpdWriteDWord */
macro_line|#endif&t;/* 0 */
multiline_comment|/*&n; *&t;Read one Stream of &squot;len&squot; bytes of VPD data, starting at &squot;addr&squot; from&n; *&t;or to the I2C EEPROM.&n; *&n; * Returns number of bytes read / written.&n; */
DECL|function|VpdWriteStream
r_static
r_int
id|VpdWriteStream
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|buf
comma
multiline_comment|/* data buffer */
r_int
id|Addr
comma
multiline_comment|/* VPD start address */
r_int
id|Len
)paren
multiline_comment|/* number of bytes to read / to write */
(brace
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
id|SK_U16
id|AdrReg
suffix:semicolon
r_int
id|Rtv
suffix:semicolon
id|SK_U8
op_star
id|pComp
suffix:semicolon
multiline_comment|/* Compare pointer */
id|SK_U8
id|Data
suffix:semicolon
multiline_comment|/* Input Data for Compare */
multiline_comment|/* Init Compare Pointer */
id|pComp
op_assign
(paren
id|SK_U8
op_star
)paren
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|Len
suffix:semicolon
id|i
op_increment
comma
id|buf
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * At the begin of each cycle read the Data Reg&n;&t;&t;&t; * So it is initialized even if only a few bytes&n;&t;&t;&t; * are written.&n;&t;&t;&t; */
id|AdrReg
op_assign
(paren
id|SK_U16
)paren
id|Addr
suffix:semicolon
id|AdrReg
op_and_assign
op_complement
id|VPD_WRITE
suffix:semicolon
multiline_comment|/* READ operation */
id|VPD_OUT16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
id|AdrReg
)paren
suffix:semicolon
multiline_comment|/* ignore return code here */
id|Rtv
op_assign
id|VpdWait
c_func
(paren
id|pAC
comma
id|IoC
comma
id|VPD_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Rtv
op_ne
l_int|0
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
)brace
multiline_comment|/* Write current Byte */
id|VPD_OUT8
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_DAT_REG
op_plus
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
comma
op_star
(paren
id|SK_U8
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
op_eq
l_int|3
)paren
op_logical_or
(paren
id|i
op_eq
(paren
id|Len
op_minus
l_int|1
)paren
)paren
)paren
(brace
multiline_comment|/* New Address needs to be written to VPD_ADDR reg */
id|AdrReg
op_assign
(paren
id|SK_U16
)paren
id|Addr
suffix:semicolon
id|Addr
op_add_assign
r_sizeof
(paren
id|SK_U32
)paren
suffix:semicolon
id|AdrReg
op_or_assign
id|VPD_WRITE
suffix:semicolon
multiline_comment|/* WRITE operation */
id|VPD_OUT16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
id|AdrReg
)paren
suffix:semicolon
multiline_comment|/* Wait for termination */
id|Rtv
op_assign
id|VpdWait
c_func
(paren
id|pAC
comma
id|IoC
comma
id|VPD_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Rtv
op_ne
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;Write Timed Out&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|i
op_minus
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Now re-read to verify&n;&t;&t;&t; */
id|AdrReg
op_and_assign
op_complement
id|VPD_WRITE
suffix:semicolon
multiline_comment|/* READ operation */
id|VPD_OUT16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
id|AdrReg
)paren
suffix:semicolon
multiline_comment|/* Wait for termination */
id|Rtv
op_assign
id|VpdWait
c_func
(paren
id|pAC
comma
id|IoC
comma
id|VPD_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Rtv
op_ne
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;Verify Timed Out&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|i
op_minus
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
(paren
r_int
)paren
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
suffix:semicolon
id|j
op_increment
comma
id|pComp
op_increment
)paren
(brace
id|VPD_IN8
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_DAT_REG
op_plus
id|j
comma
op_amp
id|Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Data
op_ne
op_star
id|pComp
)paren
(brace
multiline_comment|/* Verify Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;WriteStream Verify Error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|i
op_minus
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
op_plus
id|j
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
id|Len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read one Stream of &squot;len&squot; bytes of VPD data, starting at &squot;addr&squot; from&n; *&t;or to the I2C EEPROM.&n; *&n; * Returns number of bytes read / written.&n; */
DECL|function|VpdReadStream
r_static
r_int
id|VpdReadStream
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|buf
comma
multiline_comment|/* data buffer */
r_int
id|Addr
comma
multiline_comment|/* VPD start address */
r_int
id|Len
)paren
multiline_comment|/* number of bytes to read / to write */
(brace
r_int
id|i
suffix:semicolon
id|SK_U16
id|AdrReg
suffix:semicolon
r_int
id|Rtv
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|Len
suffix:semicolon
id|i
op_increment
comma
id|buf
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* New Address needs to be written to VPD_ADDR reg */
id|AdrReg
op_assign
(paren
id|SK_U16
)paren
id|Addr
suffix:semicolon
id|Addr
op_add_assign
r_sizeof
(paren
id|SK_U32
)paren
suffix:semicolon
id|AdrReg
op_and_assign
op_complement
id|VPD_WRITE
suffix:semicolon
multiline_comment|/* READ operation */
id|VPD_OUT16
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_ADR_REG
comma
id|AdrReg
)paren
suffix:semicolon
multiline_comment|/* ignore return code here */
id|Rtv
op_assign
id|VpdWait
c_func
(paren
id|pAC
comma
id|IoC
comma
id|VPD_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Rtv
op_ne
l_int|0
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
)brace
id|VPD_IN8
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_VPD_DAT_REG
op_plus
(paren
id|i
op_mod
r_sizeof
(paren
id|SK_U32
)paren
)paren
comma
(paren
id|SK_U8
op_star
)paren
id|buf
)paren
suffix:semicolon
)brace
r_return
id|Len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read ore wirtes &squot;len&squot; bytes of VPD data, starting at &squot;addr&squot; from&n; *&t;or to the I2C EEPROM.&n; *&n; * Returns number of bytes read / written.&n; */
DECL|function|VpdTransferBlock
r_static
r_int
id|VpdTransferBlock
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|buf
comma
multiline_comment|/* data buffer */
r_int
id|addr
comma
multiline_comment|/* VPD start address */
r_int
id|len
comma
multiline_comment|/* number of bytes to read / to write */
r_int
id|dir
)paren
multiline_comment|/* transfer direction may be VPD_READ or VPD_WRITE */
(brace
r_int
id|Rtv
suffix:semicolon
multiline_comment|/* Return value */
r_int
id|vpd_rom_size
suffix:semicolon
id|SK_U32
id|our_reg2
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd %s block, addr = 0x%x, len = %d&bslash;n&quot;
comma
id|dir
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
comma
id|addr
comma
id|len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|VPD_IN32
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PCI_OUR_REG_2
comma
op_amp
id|our_reg2
)paren
suffix:semicolon
id|vpd_rom_size
op_assign
l_int|256
op_lshift
(paren
(paren
id|our_reg2
op_amp
id|PCI_VPD_ROM_SZ
)paren
op_rshift
l_int|14
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
OG
id|vpd_rom_size
op_minus
l_int|4
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Address error: 0x%x, exp. &lt; 0x%x&bslash;n&quot;
comma
id|addr
comma
id|vpd_rom_size
op_minus
l_int|4
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr
op_plus
id|len
OG
id|vpd_rom_size
)paren
(brace
id|len
op_assign
id|vpd_rom_size
op_minus
id|addr
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;Warning: len was cut to %d&bslash;n&quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dir
op_eq
id|VPD_READ
)paren
(brace
id|Rtv
op_assign
id|VpdReadStream
c_func
(paren
id|pAC
comma
id|IoC
comma
id|buf
comma
id|addr
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
id|Rtv
op_assign
id|VpdWriteStream
c_func
(paren
id|pAC
comma
id|IoC
comma
id|buf
comma
id|addr
comma
id|len
)paren
suffix:semicolon
)brace
r_return
(paren
id|Rtv
)paren
suffix:semicolon
)brace
macro_line|#ifdef SKDIAG
multiline_comment|/*&n; *&t;Read &squot;len&squot; bytes of VPD data, starting at &squot;addr&squot;.&n; *&n; * Returns number of bytes read.&n; */
DECL|function|VpdReadBlock
r_int
id|VpdReadBlock
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pAC pointer */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|buf
comma
multiline_comment|/* buffer were the data should be stored */
r_int
id|addr
comma
multiline_comment|/* start reading at the VPD address */
r_int
id|len
)paren
multiline_comment|/* number of bytes to read */
(brace
r_return
(paren
id|VpdTransferBlock
c_func
(paren
id|pAC
comma
id|IoC
comma
id|buf
comma
id|addr
comma
id|len
comma
id|VPD_READ
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Write &squot;len&squot; bytes of *but to the VPD EEPROM, starting at &squot;addr&squot;.&n; *&n; * Returns number of bytes writes.&n; */
DECL|function|VpdWriteBlock
r_int
id|VpdWriteBlock
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pAC pointer */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|buf
comma
multiline_comment|/* buffer, holds the data to write */
r_int
id|addr
comma
multiline_comment|/* start writing at the VPD address */
r_int
id|len
)paren
multiline_comment|/* number of bytes to write */
(brace
r_return
(paren
id|VpdTransferBlock
c_func
(paren
id|pAC
comma
id|IoC
comma
id|buf
comma
id|addr
comma
id|len
comma
id|VPD_WRITE
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* SKDIAG */
multiline_comment|/*&n; * (re)initialize the VPD buffer&n; *&n; * Reads the VPD data from the EEPROM into the VPD buffer.&n; * Get the remaining read only and read / write space.&n; *&n; * return&t;0:&t;success&n; *&t;&t;1:&t;fatal VPD error&n; */
DECL|function|VpdInit
r_static
r_int
id|VpdInit
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
)paren
multiline_comment|/* IO Context */
(brace
id|SK_VPD_PARA
op_star
id|r
comma
id|rp
suffix:semicolon
multiline_comment|/* RW or RV */
r_int
id|i
suffix:semicolon
r_int
r_char
id|x
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_INIT
comma
(paren
l_string|&quot;VpdInit .. &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* read the VPD data into the VPD buffer */
r_if
c_cond
(paren
id|VpdTransferBlock
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pAC-&gt;vpd.vpd_buf
comma
l_int|0
comma
id|VPD_SIZE
comma
id|VPD_READ
)paren
op_ne
id|VPD_SIZE
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;Block Read Error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* find the end tag of the RO area */
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_assign
id|vpd_find_para
c_func
(paren
id|pAC
comma
id|VPD_RV
comma
op_amp
id|rp
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Encoding Error: RV Tag not found&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;p_val
op_plus
id|r-&gt;p_len
OG
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_div
l_int|2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Encoding Error: Invalid VPD struct size&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|pAC-&gt;vpd.v.vpd_free_ro
op_assign
id|r-&gt;p_len
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* test the checksum */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|x
op_assign
l_int|0
suffix:semicolon
(paren
r_int
)paren
id|i
op_le
(paren
r_int
)paren
id|VPD_SIZE
op_div
l_int|2
op_minus
id|r-&gt;p_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|x
op_add_assign
id|pAC-&gt;vpd.vpd_buf
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ne
l_int|0
)paren
(brace
multiline_comment|/* checksum error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;VPD Checksum Error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* find and check the end tag of the RW area */
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_assign
id|vpd_find_para
c_func
(paren
id|pAC
comma
id|VPD_RW
comma
op_amp
id|rp
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Encoding Error: RV Tag not found&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;p_val
OL
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_div
l_int|2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Encoding Error: Invalid VPD struct size&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|pAC-&gt;vpd.v.vpd_free_rw
op_assign
id|r-&gt;p_len
suffix:semicolon
multiline_comment|/* everything seems to be ok */
id|pAC-&gt;vpd.v.vpd_status
op_or_assign
id|VPD_VALID
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_INIT
comma
(paren
l_string|&quot;done. Free RO = %d, Free RW = %d&bslash;n&quot;
comma
id|pAC-&gt;vpd.v.vpd_free_ro
comma
id|pAC-&gt;vpd.v.vpd_free_rw
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;find the Keyword &squot;key&squot; in the VPD buffer and fills the&n; *&t;parameter sturct &squot;p&squot; with it&squot;s values&n; *&n; * returns&t;*p&t;success&n; *&t;&t;0:&t;parameter was not found or VPD encoding error&n; */
DECL|function|vpd_find_para
r_static
id|SK_VPD_PARA
op_star
id|vpd_find_para
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
r_char
op_star
id|key
comma
multiline_comment|/* keyword to find (e.g. &quot;MN&quot;) */
id|SK_VPD_PARA
op_star
id|p
)paren
multiline_comment|/* parameter description struct */
(brace
r_char
op_star
id|v
suffix:semicolon
multiline_comment|/* points to vpd buffer */
r_int
id|max
suffix:semicolon
multiline_comment|/* Maximum Number of Iterations */
id|v
op_assign
id|pAC-&gt;vpd.vpd_buf
suffix:semicolon
id|max
op_assign
l_int|128
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd find para %s .. &quot;
comma
id|key
)paren
)paren
suffix:semicolon
multiline_comment|/* check mandatory resource type ID string (Product Name) */
r_if
c_cond
(paren
op_star
id|v
op_ne
(paren
r_char
)paren
id|RES_ID
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Error: 0x%x missing&bslash;n&quot;
comma
id|RES_ID
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|key
comma
id|VPD_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|p-&gt;p_len
op_assign
id|VPD_GET_RES_LEN
c_func
(paren
id|v
)paren
suffix:semicolon
id|p-&gt;p_val
op_assign
id|VPD_GET_VAL
c_func
(paren
id|v
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;found, len = %d&bslash;n&quot;
comma
id|p-&gt;p_len
)paren
)paren
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
id|v
op_add_assign
l_int|3
op_plus
id|VPD_GET_RES_LEN
c_func
(paren
id|v
)paren
op_plus
l_int|3
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|SK_MEMCMP
c_func
(paren
id|key
comma
id|v
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|p-&gt;p_len
op_assign
id|VPD_GET_VPD_LEN
c_func
(paren
id|v
)paren
suffix:semicolon
id|p-&gt;p_val
op_assign
id|VPD_GET_VAL
c_func
(paren
id|v
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;found, len = %d&bslash;n&quot;
comma
id|p-&gt;p_len
)paren
)paren
suffix:semicolon
r_return
(paren
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* exit when reaching the &quot;RW&quot; Tag or the maximum of itera. */
id|max
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|SK_MEMCMP
c_func
(paren
id|VPD_RW
comma
id|v
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
id|max
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SK_MEMCMP
c_func
(paren
id|VPD_RV
comma
id|v
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|v
op_add_assign
l_int|3
op_plus
id|VPD_GET_VPD_LEN
c_func
(paren
id|v
)paren
op_plus
l_int|3
suffix:semicolon
multiline_comment|/* skip VPD-W */
)brace
r_else
(brace
id|v
op_add_assign
l_int|3
op_plus
id|VPD_GET_VPD_LEN
c_func
(paren
id|v
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;scanning &squot;%c%c&squot; len = %d&bslash;n&quot;
comma
id|v
(braket
l_int|0
)braket
comma
id|v
(braket
l_int|1
)braket
comma
id|v
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;not found&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max
op_eq
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Key/Len Encoding error&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Move &squot;n&squot; bytes. Begin with the last byte if &squot;n&squot; is &gt; 0,&n; *&t;Start with the last byte if n is &lt; 0.&n; *&n; * returns nothing&n; */
DECL|function|vpd_move_para
r_static
r_void
id|vpd_move_para
c_func
(paren
r_char
op_star
id|start
comma
multiline_comment|/* start of memory block */
r_char
op_star
id|end
comma
multiline_comment|/* end of memory block to move */
r_int
id|n
)paren
multiline_comment|/* number of bytes the memory block has to be moved */
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* number of byte copied */
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|i
op_assign
(paren
r_int
)paren
(paren
id|end
op_minus
id|start
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|p
op_assign
id|start
op_plus
id|n
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
l_int|0
)paren
(brace
op_star
id|p
op_increment
op_assign
op_star
id|start
op_increment
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
)brace
r_else
(brace
id|p
op_assign
id|end
op_plus
id|n
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
l_int|0
)paren
(brace
op_star
id|p
op_decrement
op_assign
op_star
id|end
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;setup the VPD keyword &squot;key&squot; at &squot;ip&squot;.&n; *&n; * returns nothing&n; */
DECL|function|vpd_insert_key
r_static
r_void
id|vpd_insert_key
c_func
(paren
r_char
op_star
id|key
comma
multiline_comment|/* keyword to insert */
r_char
op_star
id|buf
comma
multiline_comment|/* buffer with the keyword value */
r_int
id|len
comma
multiline_comment|/* length of the value string */
r_char
op_star
id|ip
)paren
multiline_comment|/* inseration point */
(brace
id|SK_VPD_KEY
op_star
id|p
suffix:semicolon
id|p
op_assign
(paren
id|SK_VPD_KEY
op_star
)paren
id|ip
suffix:semicolon
id|p-&gt;p_key
(braket
l_int|0
)braket
op_assign
id|key
(braket
l_int|0
)braket
suffix:semicolon
id|p-&gt;p_key
(braket
l_int|1
)braket
op_assign
id|key
(braket
l_int|1
)braket
suffix:semicolon
id|p-&gt;p_len
op_assign
(paren
r_int
r_char
)paren
id|len
suffix:semicolon
id|SK_MEMCPY
c_func
(paren
op_amp
id|p-&gt;p_val
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Setup the VPD end tag &quot;RV&quot; / &quot;RW&quot;.&n; *&t;Also correct the remaining space variables vpd_free_ro / vpd_free_rw.&n; *&n; * returns&t;0:&t;success&n; *&t;&t;1:&t;encoding error&n; */
DECL|function|vpd_mod_endtag
r_static
r_int
id|vpd_mod_endtag
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
r_char
op_star
id|etp
)paren
multiline_comment|/* end pointer input position */
(brace
id|SK_VPD_KEY
op_star
id|p
suffix:semicolon
r_int
r_char
id|x
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd modify endtag at 0x%x = &squot;%c%c&squot;&bslash;n&quot;
comma
id|etp
comma
id|etp
(braket
l_int|0
)braket
comma
id|etp
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|p
op_assign
(paren
id|SK_VPD_KEY
op_star
)paren
id|etp
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;p_key
(braket
l_int|0
)braket
op_ne
l_char|&squot;R&squot;
op_logical_or
(paren
id|p-&gt;p_key
(braket
l_int|1
)braket
op_ne
l_char|&squot;V&squot;
op_logical_and
id|p-&gt;p_key
(braket
l_int|1
)braket
op_ne
l_char|&squot;W&squot;
)paren
)paren
(brace
multiline_comment|/* something wrong here, encoding error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
op_or
id|SK_DBGCAT_FATAL
comma
(paren
l_string|&quot;Encoding Error: invalid end tag&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|etp
OG
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_div
l_int|2
)paren
(brace
multiline_comment|/* create &quot;RW&quot; tag */
id|p-&gt;p_len
op_assign
(paren
r_int
r_char
)paren
(paren
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_minus
id|etp
op_minus
l_int|3
op_minus
l_int|1
)paren
suffix:semicolon
id|pAC-&gt;vpd.v.vpd_free_rw
op_assign
(paren
r_int
)paren
id|p-&gt;p_len
suffix:semicolon
id|i
op_assign
id|pAC-&gt;vpd.v.vpd_free_rw
suffix:semicolon
id|etp
op_add_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* create &quot;RV&quot; tag */
id|p-&gt;p_len
op_assign
(paren
r_int
r_char
)paren
(paren
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_div
l_int|2
op_minus
id|etp
op_minus
l_int|3
)paren
suffix:semicolon
id|pAC-&gt;vpd.v.vpd_free_ro
op_assign
(paren
r_int
)paren
id|p-&gt;p_len
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* setup checksum */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|x
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VPD_SIZE
op_div
l_int|2
op_minus
id|p-&gt;p_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|x
op_add_assign
id|pAC-&gt;vpd.vpd_buf
(braket
id|i
)braket
suffix:semicolon
)brace
id|p-&gt;p_val
op_assign
(paren
r_char
)paren
l_int|0
op_minus
id|x
suffix:semicolon
id|i
op_assign
id|pAC-&gt;vpd.v.vpd_free_ro
suffix:semicolon
id|etp
op_add_assign
l_int|4
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
)paren
(brace
op_star
id|etp
op_increment
op_assign
l_int|0x00
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Insert a VPD keyword into the VPD buffer.&n; *&n; *&t;The keyword &squot;key&squot; is inserted at the position &squot;ip&squot; in the&n; *&t;VPD buffer.&n; *&t;The keywords behind the input position will&n; *&t;be moved. The VPD end tag &quot;RV&quot; or &quot;RW&quot; is generated again.&n; *&n; * returns&t;0:&t;success&n; *&t;&t;2:&t;value string was cut&n; *&t;&t;4:&t;VPD full, keyword was not written&n; *&t;&t;6:&t;fatal VPD error&n; *&n; */
DECL|function|VpdSetupPara
r_int
id|VpdSetupPara
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
r_char
op_star
id|key
comma
multiline_comment|/* keyword to insert */
r_char
op_star
id|buf
comma
multiline_comment|/* buffer with the keyword value */
r_int
id|len
comma
multiline_comment|/* length of the keyword value */
r_int
id|type
comma
multiline_comment|/* VPD_RO_KEY or VPD_RW_KEY */
r_int
id|op
)paren
multiline_comment|/* operation to do: ADD_KEY or OWR_KEY */
(brace
id|SK_VPD_PARA
id|vp
suffix:semicolon
r_char
op_star
id|etp
suffix:semicolon
multiline_comment|/* end tag position */
r_int
id|free
suffix:semicolon
multiline_comment|/* remaining space in selected area */
r_char
op_star
id|ip
suffix:semicolon
multiline_comment|/* input position inside the VPD buffer */
r_int
id|rtv
suffix:semicolon
multiline_comment|/* return code */
r_int
id|head
suffix:semicolon
multiline_comment|/* additional haeder bytes to move */
r_int
id|found
suffix:semicolon
multiline_comment|/* additinoal bytes if the keyword was found */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;vpd setup para key = %s, val = %s&bslash;n&quot;
comma
id|key
comma
id|buf
)paren
)paren
suffix:semicolon
id|rtv
op_assign
l_int|0
suffix:semicolon
id|ip
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|VPD_RW_KEY
)paren
(brace
multiline_comment|/* end tag is &quot;RW&quot; */
id|free
op_assign
id|pAC-&gt;vpd.v.vpd_free_rw
suffix:semicolon
id|etp
op_assign
id|pAC-&gt;vpd.vpd_buf
op_plus
(paren
id|VPD_SIZE
op_minus
id|free
op_minus
l_int|1
op_minus
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* end tag is &quot;RV&quot; */
id|free
op_assign
id|pAC-&gt;vpd.v.vpd_free_ro
suffix:semicolon
id|etp
op_assign
id|pAC-&gt;vpd.vpd_buf
op_plus
(paren
id|VPD_SIZE
op_div
l_int|2
op_minus
id|free
op_minus
l_int|4
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Free RO = %d, Free RW = %d&bslash;n&quot;
comma
id|pAC-&gt;vpd.v.vpd_free_ro
comma
id|pAC-&gt;vpd.v.vpd_free_rw
)paren
)paren
suffix:semicolon
id|head
op_assign
l_int|0
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
id|OWR_KEY
)paren
(brace
r_if
c_cond
(paren
id|vpd_find_para
c_func
(paren
id|pAC
comma
id|key
comma
op_amp
id|vp
)paren
)paren
(brace
id|found
op_assign
l_int|3
suffix:semicolon
id|ip
op_assign
id|vp.p_val
op_minus
l_int|3
suffix:semicolon
id|free
op_add_assign
id|vp.p_len
op_plus
l_int|3
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Overwrite Key&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|op
op_assign
id|ADD_KEY
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Add Key&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|op
op_eq
id|ADD_KEY
)paren
(brace
id|ip
op_assign
id|etp
suffix:semicolon
id|vp.p_len
op_assign
l_int|0
suffix:semicolon
id|head
op_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_plus
l_int|3
OG
id|free
)paren
(brace
r_if
c_cond
(paren
id|free
OL
l_int|7
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;VPD Buffer Overflow, keyword not written&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* cut it again */
id|len
op_assign
id|free
op_minus
l_int|3
suffix:semicolon
id|rtv
op_assign
l_int|2
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;VPD Buffer Full, Keyword was cut&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|vpd_move_para
c_func
(paren
id|ip
op_plus
id|vp.p_len
op_plus
id|found
comma
id|etp
op_plus
l_int|2
comma
id|len
op_minus
id|vp.p_len
op_plus
id|head
)paren
suffix:semicolon
id|vpd_insert_key
c_func
(paren
id|key
comma
id|buf
comma
id|len
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vpd_mod_endtag
c_func
(paren
id|pAC
comma
id|etp
op_plus
id|len
op_minus
id|vp.p_len
op_plus
id|head
)paren
)paren
(brace
id|pAC-&gt;vpd.v.vpd_status
op_and_assign
op_complement
id|VPD_VALID
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;VPD Encoding Error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|6
suffix:semicolon
)brace
r_return
(paren
id|rtv
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read the contents of the VPD EEPROM and copy it to the&n; *&t;VPD buffer if not already done.&n; *&n; * return:&t;A pointer to the vpd_status structure. The structure contains&n; *&t;&t;this fields.&n; */
DECL|function|VpdStat
id|SK_VPD_STATUS
op_star
id|VpdStat
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
)paren
multiline_comment|/* IO Context */
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
)paren
(brace
(paren
r_void
)paren
id|VpdInit
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
)brace
r_return
op_amp
id|pAC-&gt;vpd.v
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read the contents of the VPD EEPROM and copy it to the VPD&n; *&t;buffer if not already done.&n; *&t;Scan the VPD buffer for VPD keywords and create the VPD&n; *&t;keyword list by copying the keywords to &squot;buf&squot;, all after&n; *&t;each other and terminated with a &squot;&bslash;0&squot;.&n; *&n; * Exceptions:&t;o The Resource Type ID String (product name) is called &quot;Name&quot;&n; *&t;&t;o The VPD end tags &squot;RV&squot; and &squot;RW&squot; are not listed&n; *&n; *&t;The number of copied keywords is counted in &squot;elements&squot;.&n; *&n; * returns&t;0:&t;success&n; *&t;&t;2:&t;buffer overfull, one or more keywords are missing&n; *&t;&t;6:&t;fatal VPD error&n; *&n; *&t;example values after returning:&n; *&n; *&t;&t;buf =&t;&quot;Name&bslash;0PN&bslash;0EC&bslash;0MN&bslash;0SN&bslash;0CP&bslash;0VF&bslash;0VL&bslash;0YA&bslash;0&quot;&n; *&t;&t;*len =&t;&t;30&n; *&t;&t;*elements =&t; 9&n; */
DECL|function|VpdKeys
r_int
id|VpdKeys
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|buf
comma
multiline_comment|/* buffer where to copy the keywords */
r_int
op_star
id|len
comma
multiline_comment|/* buffer length */
r_int
op_star
id|elements
)paren
multiline_comment|/* number of keywords returned */
(brace
r_char
op_star
id|v
suffix:semicolon
r_int
id|n
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;list vpd keys .. &quot;
)paren
)paren
suffix:semicolon
op_star
id|elements
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|VpdInit
c_func
(paren
id|pAC
comma
id|IoC
)paren
op_ne
l_int|0
)paren
(brace
op_star
id|len
op_assign
l_int|0
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;VPD Init Error, terminated&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|6
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|strlen
c_func
(paren
id|VPD_NAME
)paren
op_plus
l_int|1
op_le
op_star
id|len
)paren
(brace
id|v
op_assign
id|pAC-&gt;vpd.vpd_buf
suffix:semicolon
id|strcpy
c_func
(paren
id|buf
comma
id|VPD_NAME
)paren
suffix:semicolon
id|n
op_assign
id|strlen
c_func
(paren
id|VPD_NAME
)paren
op_plus
l_int|1
suffix:semicolon
id|buf
op_add_assign
id|n
suffix:semicolon
op_star
id|elements
op_assign
l_int|1
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;&squot;%c%c&squot; &quot;
comma
id|v
(braket
l_int|0
)braket
comma
id|v
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|len
op_assign
l_int|0
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;buffer overflow&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
id|v
op_add_assign
l_int|3
op_plus
id|VPD_GET_RES_LEN
c_func
(paren
id|v
)paren
op_plus
l_int|3
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* exit when reaching the &quot;RW&quot; Tag */
r_if
c_cond
(paren
id|SK_MEMCMP
c_func
(paren
id|VPD_RW
comma
id|v
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SK_MEMCMP
c_func
(paren
id|VPD_RV
comma
id|v
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|v
op_add_assign
l_int|3
op_plus
id|VPD_GET_VPD_LEN
c_func
(paren
id|v
)paren
op_plus
l_int|3
suffix:semicolon
multiline_comment|/* skip VPD-W */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_plus
l_int|3
op_le
op_star
id|len
)paren
(brace
id|SK_MEMCPY
c_func
(paren
id|buf
comma
id|v
comma
l_int|2
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|2
suffix:semicolon
op_star
id|buf
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|n
op_add_assign
l_int|3
suffix:semicolon
id|v
op_add_assign
l_int|3
op_plus
id|VPD_GET_VPD_LEN
c_func
(paren
id|v
)paren
suffix:semicolon
op_star
id|elements
op_add_assign
l_int|1
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;&squot;%c%c&squot; &quot;
comma
id|v
(braket
l_int|0
)braket
comma
id|v
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|len
op_assign
id|n
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;buffer overflow&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|2
)paren
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
op_star
id|len
op_assign
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read the contents of the VPD EEPROM and copy it to the&n; *&t;VPD buffer if not already done. Search for the VPD keyword&n; *&t;&squot;key&squot; and copy its value to &squot;buf&squot;. Add a terminating &squot;&bslash;0&squot;.&n; *&t;If the value does not fit into the buffer cut it after&n; *&t;&squot;len&squot; - 1 bytes.&n; *&n; * returns&t;0:&t;success&n; *&t;&t;1:&t;keyword not found&n; *&t;&t;2:&t;value string was cut&n; *&t;&t;3:&t;VPD transfer timeout&n; *&t;&t;6:&t;fatal VPD error&n; */
DECL|function|VpdRead
r_int
id|VpdRead
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|key
comma
multiline_comment|/* keyword to read (e.g. &quot;MN&quot;) */
r_char
op_star
id|buf
comma
multiline_comment|/* buffer where to copy the keyword value */
r_int
op_star
id|len
)paren
multiline_comment|/* buffer length */
(brace
id|SK_VPD_PARA
op_star
id|p
comma
id|vp
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;vpd read %s .. &quot;
comma
id|key
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|VpdInit
c_func
(paren
id|pAC
comma
id|IoC
)paren
op_ne
l_int|0
)paren
(brace
op_star
id|len
op_assign
l_int|0
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;vpd init error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|6
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|vpd_find_para
c_func
(paren
id|pAC
comma
id|key
comma
op_amp
id|vp
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;p_len
OG
(paren
op_star
(paren
r_int
op_star
)paren
id|len
)paren
op_minus
l_int|1
)paren
(brace
id|p-&gt;p_len
op_assign
op_star
id|len
op_minus
l_int|1
suffix:semicolon
)brace
id|SK_MEMCPY
c_func
(paren
id|buf
comma
id|p-&gt;p_val
comma
id|p-&gt;p_len
)paren
suffix:semicolon
id|buf
(braket
id|p-&gt;p_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|len
op_assign
id|p-&gt;p_len
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;%c%c%c%c.., len = %d&bslash;n&quot;
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
comma
id|buf
(braket
l_int|2
)braket
comma
id|buf
(braket
l_int|3
)braket
comma
op_star
id|len
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|len
op_assign
l_int|0
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;not found&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check whether a given key may be written&n; *&n; * returns&n; *&t;SK_TRUE&t;&t;Yes it may be written&n; *&t;SK_FALSE&t;No it may be written&n; */
DECL|function|VpdMayWrite
id|SK_BOOL
id|VpdMayWrite
c_func
(paren
r_char
op_star
id|key
)paren
multiline_comment|/* keyword to write (allowed values &quot;Yx&quot;, &quot;Vx&quot;) */
(brace
r_if
c_cond
(paren
(paren
op_star
id|key
op_ne
l_char|&squot;Y&squot;
op_logical_and
op_star
id|key
op_ne
l_char|&squot;V&squot;
)paren
op_logical_or
id|key
(braket
l_int|1
)braket
template_param
l_char|&squot;Z&squot;
op_logical_or
(paren
id|key
(braket
l_int|1
)braket
OG
l_char|&squot;9&squot;
op_logical_and
id|key
(braket
l_int|1
)braket
OL
l_char|&squot;A&squot;
)paren
op_logical_or
id|strlen
c_func
(paren
id|key
)paren
op_ne
l_int|2
)paren
(brace
r_return
(paren
id|SK_FALSE
)paren
suffix:semicolon
)brace
r_return
(paren
id|SK_TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read the contents of the VPD EEPROM and copy it to the VPD&n; *&t;buffer if not already done. Insert/overwrite the keyword &squot;key&squot;&n; *&t;in the VPD buffer. Cut the keyword value if it does not fit&n; *&t;into the VPD read / write area.&n; *&n; * returns&t;0:&t;success&n; *&t;&t;2:&t;value string was cut&n; *&t;&t;3:&t;VPD transfer timeout&n; *&t;&t;4:&t;VPD full, keyword was not written&n; *&t;&t;5:&t;keyword cannot be written&n; *&t;&t;6:&t;fatal VPD error&n; */
DECL|function|VpdWrite
r_int
id|VpdWrite
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|key
comma
multiline_comment|/* keyword to write (allowed values &quot;Yx&quot;, &quot;Vx&quot;) */
r_char
op_star
id|buf
)paren
multiline_comment|/* buffer where the keyword value can be read from */
(brace
r_int
id|len
suffix:semicolon
multiline_comment|/* lenght of the keyword to write */
r_int
id|rtv
suffix:semicolon
multiline_comment|/* return code */
r_int
id|rtv2
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;vpd write %s = %s&bslash;n&quot;
comma
id|key
comma
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|key
op_ne
l_char|&squot;Y&squot;
op_logical_and
op_star
id|key
op_ne
l_char|&squot;V&squot;
)paren
op_logical_or
id|key
(braket
l_int|1
)braket
template_param
l_char|&squot;Z&squot;
op_logical_or
(paren
id|key
(braket
l_int|1
)braket
OG
l_char|&squot;9&squot;
op_logical_and
id|key
(braket
l_int|1
)braket
OL
l_char|&squot;A&squot;
)paren
op_logical_or
id|strlen
c_func
(paren
id|key
)paren
op_ne
l_int|2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;illegal key tag, keyword not written&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|VpdInit
c_func
(paren
id|pAC
comma
id|IoC
)paren
op_ne
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;vpd init error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|6
suffix:semicolon
)brace
)brace
id|rtv
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|VPD_MAX_LEN
)paren
(brace
multiline_comment|/* cut it */
id|len
op_assign
id|VPD_MAX_LEN
suffix:semicolon
id|rtv
op_assign
l_int|2
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;keyword to long, cut after %d bytes&bslash;n&quot;
comma
id|VPD_MAX_LEN
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rtv2
op_assign
id|VpdSetupPara
c_func
(paren
id|pAC
comma
id|key
comma
id|buf
comma
id|len
comma
id|VPD_RW_KEY
comma
id|OWR_KEY
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;vpd write error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|rtv2
suffix:semicolon
)brace
r_return
(paren
id|rtv
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read the contents of the VPD EEPROM and copy it to the&n; *&t;VPD buffer if not already done. Remove the VPD keyword&n; *&t;&squot;key&squot; from the VPD buffer.&n; *&t;Only the keywords in the read/write area can be deleted.&n; *&t;Keywords in the read only area cannot be deleted.&n; *&n; * returns&t;0:&t;success, keyword was removed&n; *&t;&t;1:&t;keyword not found&n; *&t;&t;5:&t;keyword cannot be deleted&n; *&t;&t;6:&t;fatal VPD error&n; */
DECL|function|VpdDelete
r_int
id|VpdDelete
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|key
)paren
multiline_comment|/* keyword to read (e.g. &quot;MN&quot;) */
(brace
id|SK_VPD_PARA
op_star
id|p
comma
id|vp
suffix:semicolon
r_char
op_star
id|etp
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;vpd delete key %s&bslash;n&quot;
comma
id|key
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|VpdInit
c_func
(paren
id|pAC
comma
id|IoC
)paren
op_ne
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;vpd init error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|6
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|vpd_find_para
c_func
(paren
id|pAC
comma
id|key
comma
op_amp
id|vp
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;p_val
OL
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_div
l_int|2
)paren
(brace
multiline_comment|/* try to delete read only keyword */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;cannot delete RO keyword&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|5
)paren
suffix:semicolon
)brace
id|etp
op_assign
id|pAC-&gt;vpd.vpd_buf
op_plus
(paren
id|VPD_SIZE
op_minus
id|pAC-&gt;vpd.v.vpd_free_rw
op_minus
l_int|1
op_minus
l_int|3
)paren
suffix:semicolon
id|vpd_move_para
c_func
(paren
id|vp.p_val
op_plus
id|vp.p_len
comma
id|etp
op_plus
l_int|2
comma
op_minus
(paren
(paren
r_int
)paren
(paren
id|vp.p_len
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vpd_mod_endtag
c_func
(paren
id|pAC
comma
id|etp
op_minus
id|vp.p_len
op_minus
l_int|3
)paren
)paren
(brace
id|pAC-&gt;vpd.v.vpd_status
op_and_assign
op_complement
id|VPD_VALID
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;vpd encoding error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|6
suffix:semicolon
)brace
)brace
r_else
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;keyword not found&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;If the VPD buffer contains valid data write the VPD&n; *&t;read/write area back to the VPD EEPROM.&n; *&n; * returns&t;0:&t;success&n; *&t;&t;3:&t;VPD transfer timeout&n; */
DECL|function|VpdUpdate
r_int
id|VpdUpdate
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|IoC
)paren
multiline_comment|/* IO Context */
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;vpd update .. &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
(brace
r_if
c_cond
(paren
id|VpdTransferBlock
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pAC-&gt;vpd.vpd_buf
op_plus
id|VPD_SIZE
op_div
l_int|2
comma
id|VPD_SIZE
op_div
l_int|2
comma
id|VPD_SIZE
op_div
l_int|2
comma
id|VPD_WRITE
)paren
op_ne
id|VPD_SIZE
op_div
l_int|2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;transfer timed out&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read the contents of the VPD EEPROM and copy it to the VPD buffer&n; *&t;if not already done. If the keyword &quot;VF&quot; is not present it will be&n; *&t;created and the error log message will be stored to this keyword.&n; *&t;If &quot;VF&quot; is not present the error log message will be stored to the&n; *&t;keyword &quot;VL&quot;. &quot;VL&quot; will created or overwritten if &quot;VF&quot; is present.&n; *&t;The VPD read/write area is saved to the VPD EEPROM.&n; *&n; * returns nothing, errors will be ignored.&n; */
DECL|function|VpdErrLog
r_void
id|VpdErrLog
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* common data base */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO Context */
r_char
op_star
id|msg
)paren
multiline_comment|/* error log message */
(brace
id|SK_VPD_PARA
op_star
id|v
comma
id|vf
suffix:semicolon
multiline_comment|/* VF */
r_int
id|len
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;vpd error log msg %s&bslash;n&quot;
comma
id|msg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;vpd.v.vpd_status
op_amp
id|VPD_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|VpdInit
c_func
(paren
id|pAC
comma
id|IoC
)paren
op_ne
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_ERR
comma
(paren
l_string|&quot;vpd init error&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|len
op_assign
id|strlen
c_func
(paren
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|VPD_MAX_LEN
)paren
(brace
multiline_comment|/* cut it */
id|len
op_assign
id|VPD_MAX_LEN
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|v
op_assign
id|vpd_find_para
c_func
(paren
id|pAC
comma
id|VPD_VF
comma
op_amp
id|vf
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;overwrite VL&bslash;n&quot;
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|VpdSetupPara
c_func
(paren
id|pAC
comma
id|VPD_VL
comma
id|msg
comma
id|len
comma
id|VPD_RW_KEY
comma
id|OWR_KEY
)paren
suffix:semicolon
)brace
r_else
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_VPD
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;write VF&bslash;n&quot;
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|VpdSetupPara
c_func
(paren
id|pAC
comma
id|VPD_VF
comma
id|msg
comma
id|len
comma
id|VPD_RW_KEY
comma
id|ADD_KEY
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|VpdUpdate
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
)brace
eof
