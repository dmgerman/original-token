multiline_comment|/******************************************************************************&n; *&n; * Name:&t;skgehwt.c&n; * Project:&t;GEnesis, PCI Gigabit Ethernet Adapter&n; * Version:&t;$Revision: 1.13 $&n; * Date:&t;$Date: 1999/11/22 13:31:12 $&n; * Purpose:&t;Hardware Timer.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * History:&n; *&n; *&t;$Log: skgehwt.c,v $&n; *&t;Revision 1.13  1999/11/22 13:31:12  cgoos&n; *&t;Changed license header to GPL.&n; *&t;&n; *&t;Revision 1.12  1998/10/15 15:11:34  gklug&n; *&t;fix: ID_sccs to SysKonnectFileId&n; *&t;&n; *&t;Revision 1.11  1998/10/08 15:27:51  gklug&n; *&t;chg: correction factor is host clock dependent&n; *&t;&n; *&t;Revision 1.10  1998/09/15 14:18:31  cgoos&n; *&t;Changed more BOOLEANs to SK_xxx&n; *&n; *&t;Revision 1.9  1998/09/15 14:16:06  cgoos&n; *&t;Changed line 107: FALSE to SK_FALSE&n; *&t;&n; *&t;Revision 1.8  1998/08/24 13:04:44  gklug&n; *&t;fix: typo&n; *&t;&n; *&t;Revision 1.7  1998/08/19 09:50:49  gklug&n; *&t;fix: remove struct keyword from c-code (see CCC) add typedefs&n; *&t;&n; *&t;Revision 1.6  1998/08/17 09:59:02  gklug&n; *&t;fix: typos&n; *&t;&n; *&t;Revision 1.5  1998/08/14 07:09:10  gklug&n; *&t;fix: chg pAc -&gt; pAC&n; *&t;&n; *&t;Revision 1.4  1998/08/10 14:14:52  gklug&n; *&t;rmv: unneccessary SK_ADDR macro&n; *&t;&n; *&t;Revision 1.3  1998/08/07 12:53:44  gklug&n; *&t;fix: first compiled version&n; *&t;&n; *&t;Revision 1.2  1998/08/07 09:19:29  gklug&n; *&t;adapt functions to the C coding conventions&n; *&t;rmv unneccessary functions.&n; *&t;&n; *&t;Revision 1.1  1998/08/05 11:28:36  gklug&n; *&t;first version: adapted from SMT/FDDI&n; *&t;&n; *&t;&n; *&t;&n; *&n; ******************************************************************************/
multiline_comment|/*&n;&t;Event queue and dispatcher&n;*/
DECL|variable|SysKonnectFileId
r_static
r_const
r_char
id|SysKonnectFileId
(braket
)braket
op_assign
l_string|&quot;$Header: /usr56/projects/ge/schedule/skgehwt.c,v 1.13 1999/11/22 13:31:12 cgoos Exp $&quot;
suffix:semicolon
macro_line|#include &quot;h/skdrv1st.h&quot;&t;&t;/* Driver Specific Definitions */
macro_line|#include &quot;h/skdrv2nd.h&quot;&t;&t;/* Adapter Control- and Driver specific Def. */
macro_line|#ifdef __C2MAN__
multiline_comment|/*&n;&t;Hardware Timer function queue management.&n;&n;&t;General Description:&n;&n; */
DECL|function|intro
id|intro
c_func
(paren
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Prototypes of local functions.&n; */
DECL|macro|SK_HWT_MAX
mdefine_line|#define&t;SK_HWT_MAX&t;(65000)
multiline_comment|/* correction factor */
DECL|macro|SK_HWT_FAC
mdefine_line|#define&t;SK_HWT_FAC&t;(1000 * (SK_U32)pAC-&gt;GIni.GIHstClkFact / 100)
multiline_comment|/*&n; * Initialize hardware timer.&n; *&n; * Must be called during init level 1.&n; */
DECL|function|SkHwtInit
r_void
id|SkHwtInit
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|Ioc
)paren
multiline_comment|/* IoContext */
(brace
id|pAC-&gt;Hwt.TStart
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Hwt.TStop
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Hwt.TActive
op_assign
id|SK_FALSE
suffix:semicolon
id|SkHwtStop
c_func
(paren
id|pAC
comma
id|Ioc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; * Start hardware timer (clock ticks are 16us).&n; *&n; */
DECL|function|SkHwtStart
r_void
id|SkHwtStart
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|Ioc
comma
multiline_comment|/* IoContext */
id|SK_U32
id|Time
)paren
multiline_comment|/* Time in units of 16us to load the timer with. */
(brace
id|SK_U32
id|Cnt
suffix:semicolon
r_if
c_cond
(paren
id|Time
OG
id|SK_HWT_MAX
)paren
id|Time
op_assign
id|SK_HWT_MAX
suffix:semicolon
id|pAC-&gt;Hwt.TStart
op_assign
id|Time
suffix:semicolon
id|pAC-&gt;Hwt.TStop
op_assign
l_int|0L
suffix:semicolon
id|Cnt
op_assign
id|Time
suffix:semicolon
multiline_comment|/*&n;&t; * if time &lt; 16 us&n;&t; *&t;time = 16 us&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|Cnt
)paren
(brace
id|Cnt
op_increment
suffix:semicolon
)brace
id|SK_OUT32
c_func
(paren
id|Ioc
comma
id|B2_TI_INI
comma
id|Cnt
op_star
id|SK_HWT_FAC
)paren
suffix:semicolon
id|SK_OUT16
c_func
(paren
id|Ioc
comma
id|B2_TI_CRTL
comma
id|TIM_START
)paren
suffix:semicolon
multiline_comment|/* Start timer. */
id|pAC-&gt;Hwt.TActive
op_assign
id|SK_TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Stop hardware timer.&n; * and clear the timer IRQ&n; */
DECL|function|SkHwtStop
r_void
id|SkHwtStop
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|Ioc
)paren
multiline_comment|/* IoContext */
(brace
id|SK_OUT16
c_func
(paren
id|Ioc
comma
id|B2_TI_CRTL
comma
id|TIM_STOP
)paren
suffix:semicolon
id|SK_OUT16
c_func
(paren
id|Ioc
comma
id|B2_TI_CRTL
comma
id|TIM_CLR_IRQ
)paren
suffix:semicolon
id|pAC-&gt;Hwt.TActive
op_assign
id|SK_FALSE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Stop hardware timer and read time elapsed since last start.&n; *&n; * returns&n; *&t;The elapsed time since last start in units of 16us.&n; *&n; */
DECL|function|SkHwtRead
id|SK_U32
id|SkHwtRead
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|Ioc
)paren
multiline_comment|/* IoContext */
(brace
id|SK_U32
id|TRead
suffix:semicolon
id|SK_U32
id|IStatus
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Hwt.TActive
)paren
(brace
id|SkHwtStop
c_func
(paren
id|pAC
comma
id|Ioc
)paren
suffix:semicolon
id|SK_IN32
c_func
(paren
id|Ioc
comma
id|B2_TI_VAL
comma
op_amp
id|TRead
)paren
suffix:semicolon
id|TRead
op_div_assign
id|SK_HWT_FAC
suffix:semicolon
id|SK_IN32
c_func
(paren
id|Ioc
comma
id|B0_ISRC
comma
op_amp
id|IStatus
)paren
suffix:semicolon
multiline_comment|/* Check if timer expired (or wraparound). */
r_if
c_cond
(paren
(paren
id|TRead
OG
id|pAC-&gt;Hwt.TStart
)paren
op_logical_or
(paren
id|IStatus
op_amp
id|IS_TIMINT
)paren
)paren
(brace
id|SkHwtStop
c_func
(paren
id|pAC
comma
id|Ioc
)paren
suffix:semicolon
id|pAC-&gt;Hwt.TStop
op_assign
id|pAC-&gt;Hwt.TStart
suffix:semicolon
)brace
r_else
(brace
id|pAC-&gt;Hwt.TStop
op_assign
id|pAC-&gt;Hwt.TStart
op_minus
id|TRead
suffix:semicolon
)brace
)brace
r_return
(paren
id|pAC-&gt;Hwt.TStop
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * interrupt source= timer&n; */
DECL|function|SkHwtIsr
r_void
id|SkHwtIsr
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapters context */
id|SK_IOC
id|Ioc
)paren
multiline_comment|/* IoContext */
(brace
id|SkHwtStop
c_func
(paren
id|pAC
comma
id|Ioc
)paren
suffix:semicolon
id|pAC-&gt;Hwt.TStop
op_assign
id|pAC-&gt;Hwt.TStart
suffix:semicolon
id|SkTimerDone
c_func
(paren
id|pAC
comma
id|Ioc
)paren
suffix:semicolon
)brace
multiline_comment|/* End of file */
eof
