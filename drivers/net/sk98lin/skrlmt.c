multiline_comment|/******************************************************************************&n; *&n; * Name:&t;skrlmt.c&n; * Project:&t;GEnesis, PCI Gigabit Ethernet Adapter&n; * Version:&t;$Revision: 1.49 $&n; * Date:&t;$Date: 1999/11/22 13:38:02 $&n; * Purpose:&t;Manage links on SK-NET Adapters, esp. redundant ones.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * History:&n; *&n; *&t;$Log: skrlmt.c,v $&n; *&t;Revision 1.49  1999/11/22 13:38:02  cgoos&n; *&t;Changed license header to GPL.&n; *&t;Added initialization to some variables to avoid compiler warnings.&n; *&t;&n; *&t;Revision 1.48  1999/10/04 14:01:17  rassmann&n; *&t;Corrected reaction to reception of BPDU frames.&n; *&t;Added parameter descriptions to &quot;For Readme&quot; section skrlmt.txt.&n; *&t;Clarified usage of lookahead result *pForRlmt.&n; *&t;Requested driver to present RLMT packets as soon as poosible.&n; *&t;&n; *&t;Revision 1.47  1999/07/20 12:53:36  rassmann&n; *&t;Fixed documentation errors for lookahead macros.&n; *&t;&n; *&t;Revision 1.46  1999/05/28 13:29:16  rassmann&n; *&t;Replaced C++-style comment.&n; *&t;&n; *&t;Revision 1.45  1999/05/28 13:28:08  rassmann&n; *&t;Corrected syntax error (xxx).&n; *&t;&n; *&t;Revision 1.44  1999/05/28 11:15:54  rassmann&n; *&t;Changed behaviour to reflect Design Spec v1.2.&n; *&t;Controlling Link LED(s).&n; *&t;Introduced RLMT Packet Version field in RLMT Packet.&n; *&t;Newstyle lookahead macros (checking meta-information before looking at&n; *&t;  the packet).&n; *&t;&n; *&t;Revision 1.43  1999/01/28 13:12:43  rassmann&n; *&t;Corrected Lookahead (bug introduced in previous Rev.).&n; *&t;&n; *&t;Revision 1.42  1999/01/28 12:50:41  rassmann&n; *&t;Not using broadcast time stamps in CheckLinkState mode.&n; *&t;&n; *&t;Revision 1.41  1999/01/27 14:13:02  rassmann&n; *&t;Monitoring broadcast traffic.&n; *&t;Switching more reliably and not too early if switch is&n; *&t; configured for spanning tree.&n; *&t;&n; *&t;Revision 1.40  1999/01/22 13:17:30  rassmann&n; *&t;Informing PNMI of NET_UP.&n; *&t;Clearing RLMT multicast addresses before first setting them.&n; *&t;Reporting segmentation earlier, setting a &quot;quiet time&quot;&n; *&t; after a report.&n; *&t;&n; *&t;Revision 1.39  1998/12/10 15:29:53  rassmann&n; *&t;Corrected SuspectStatus in SkRlmtBuildCheckChain().&n; *&t;Corrected CHECK_SEG mode.&n; *&t;&n; *&t;Revision 1.38  1998/12/08 13:11:23  rassmann&n; *&t;Stopping SegTimer at RlmtStop.&n; *&t;&n; *&t;Revision 1.37  1998/12/07 16:51:42  rassmann&n; *&t;Corrected comments.&n; *&t;&n; *&t;Revision 1.36  1998/12/04 10:58:56  rassmann&n; *&t;Setting next pointer to NULL when receiving.&n; *&t;&n; *&t;Revision 1.35  1998/12/03 16:12:42  rassmann&n; *&t;Ignoring/correcting illegal PrefPort values.&n; *&t;&n; *&t;Revision 1.34  1998/12/01 11:45:35  rassmann&n; *&t;Code cleanup.&n; *&t;&n; *&t;Revision 1.33  1998/12/01 10:29:32  rassmann&n; *&t;Starting standby ports before getting the net up.&n; *&t;Checking if a port is started when the link comes up.&n; *&t;&n; *&t;Revision 1.32  1998/11/30 16:19:50  rassmann&n; *&t;New default for PortNoRx.&n; *&t;&n; *&t;Revision 1.31  1998/11/27 19:17:13  rassmann&n; *&t;Corrected handling of LINK_DOWN coming shortly after LINK_UP.&n; *&t;&n; *&t;Revision 1.30  1998/11/24 12:37:31  rassmann&n; *&t;Implemented segmentation check.&n; *&t;&n; *&t;Revision 1.29  1998/11/18 13:04:32  rassmann&n; *&t;Secured PortUpTimer event.&n; *&t;Waiting longer before starting standby port(s).&n; *&t;&n; *&t;Revision 1.28  1998/11/17 13:43:04  rassmann&n; *&t;Handling (logical) tx failure.&n; *&t;Sending packet on logical address after PORT_SWITCH.&n; *&t;&n; *&t;Revision 1.27  1998/11/13 17:09:50  rassmann&n; *&t;Secured some events against being called in wrong state.&n; *&t;&n; *&t;Revision 1.26  1998/11/13 16:56:54  rassmann&n; *&t;Added macro version of SkRlmtLookaheadPacket.&n; *&t;&n; *&t;Revision 1.25  1998/11/06 18:06:04  rassmann&n; *&t;Corrected timing when RLMT checks fail.&n; *&t;Clearing tx counter earlier in periodical checks.&n; *&t;&n; *&t;Revision 1.24  1998/11/05 10:37:27  rassmann&n; *&t;Checking destination address in Lookahead.&n; *&t;&n; *&t;Revision 1.23  1998/11/03 13:53:49  rassmann&n; *&t;RLMT should switch now (at least in mode 3).&n; *&t;&n; *&t;Revision 1.22  1998/10/29 14:34:49  rassmann&n; *&t;Clearing SK_RLMT struct at startup.&n; *&t;Initializing PortsUp during SK_RLMT_START.&n; *&t;&n; *&t;Revision 1.21  1998/10/28 11:30:17  rassmann&n; *&t;Default mode is now SK_RLMT_CHECK_LOC_LINK.&n; *&t;&n; *&t;Revision 1.20  1998/10/26 16:02:03  rassmann&n; *&t;Ignoring LINK_DOWN for links that are down.&n; *&t;&n; *&t;Revision 1.19  1998/10/22 15:54:01  rassmann&n; *&t;Corrected EtherLen.&n; *&t;Starting Link Check when second port comes up.&n; *&t;&n; *&t;Revision 1.18  1998/10/22 11:39:50  rassmann&n; *&t;Corrected signed/unsigned mismatches.&n; *&t;Corrected receive list handling and address recognition.&n; *&t;&n; *&t;Revision 1.17  1998/10/19 17:01:20  rassmann&n; *&t;More detailed checking of received packets.&n; *&t;&n; *&t;Revision 1.16  1998/10/15 15:16:34  rassmann&n; *&t;Finished Spanning Tree checking.&n; *&t;Checked with lint.&n; *&t;&n; *&t;Revision 1.15  1998/09/24 19:16:07  rassmann&n; *&t;Code cleanup.&n; *&t;Introduced Timer for PORT_DOWN due to no RX.&n; *&t;&n; *&t;Revision 1.14  1998/09/18 20:27:14  rassmann&n; *&t;Added address override.&n; *&t;&n; *&t;Revision 1.13  1998/09/16 11:31:48  rassmann&n; *&t;Including skdrv1st.h again. :(&n; *&t;&n; *&t;Revision 1.12  1998/09/16 11:09:50  rassmann&n; *&t;Syntax corrections.&n; *&t;&n; *&t;Revision 1.11  1998/09/15 12:32:03  rassmann&n; *&t;Syntax correction.&n; *&t;&n; *&t;Revision 1.10  1998/09/15 11:28:49  rassmann&n; *&t;Syntax corrections.&n; *&t;&n; *&t;Revision 1.9  1998/09/14 17:07:37  rassmann&n; *&t;Added code for port checking via LAN.&n; *&t;Changed Mbuf definition.&n; *&t;&n; *&t;Revision 1.8  1998/09/07 11:14:14  rassmann&n; *&t;Syntax corrections.&n; *&t;&n; *&t;Revision 1.7  1998/09/07 09:06:07  rassmann&n; *&t;Syntax corrections.&n; *&t;&n; *&t;Revision 1.6  1998/09/04 19:41:33  rassmann&n; *&t;Syntax corrections.&n; *&t;Started entering code for checking local links.&n; *&t;&n; *&t;Revision 1.5  1998/09/04 12:14:27  rassmann&n; *&t;Interface cleanup.&n; *&t;&n; *&t;Revision 1.4  1998/09/02 16:55:28  rassmann&n; *&t;Updated to reflect new DRV/HWAC/RLMT interface.&n; *&t;&n; *&t;Revision 1.3  1998/08/27 14:29:03  rassmann&n; *&t;Code cleanup.&n; *&t;&n; *&t;Revision 1.2  1998/08/27 14:26:24  rassmann&n; *&t;Updated interface.&n; *&t;&n; *&t;Revision 1.1  1998/08/21 08:26:49  rassmann&n; *&t;First public version.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * Description:&n; *&n; * This module contains code for Link ManagemenT (LMT) of SK-NET Adapters.&n; * It is mainly intended for adapters with more than one link.&n; * For such adapters, this module realizes Redundant Link ManagemenT (RLMT).&n; *&n; * Include File Hierarchy:&n; *&n; *&t;&quot;skdrv1st.h&quot;&n; *&t;&quot;skdrv2nd.h&quot;&n; *&n; ******************************************************************************/
macro_line|#ifndef&t;lint
DECL|variable|SysKonnectFileId
r_static
r_const
r_char
id|SysKonnectFileId
(braket
)braket
op_assign
l_string|&quot;@(#) $Id: skrlmt.c,v 1.49 1999/11/22 13:38:02 cgoos Exp $ (C) SysKonnect.&quot;
suffix:semicolon
macro_line|#endif&t;/* !defined(lint) */
DECL|macro|__SKRLMT_C
mdefine_line|#define __SKRLMT_C
macro_line|#ifdef __cplusplus
id|xxxx
multiline_comment|/* not supported yet - force error */
r_extern
l_string|&quot;C&quot;
(brace
macro_line|#endif&t;/* cplusplus */
macro_line|#include &quot;h/skdrv1st.h&quot;
macro_line|#include &quot;h/skdrv2nd.h&quot;
multiline_comment|/* defines ********************************************************************/
macro_line|#ifndef SK_HWAC_LINK_LED
DECL|macro|SK_HWAC_LINK_LED
mdefine_line|#define SK_HWAC_LINK_LED(a,b,c,d)
macro_line|#endif&t;/* !defined(SK_HWAC_LINK_LED) */
macro_line|#ifndef DEBUG
DECL|macro|RLMT_STATIC
mdefine_line|#define RLMT_STATIC&t;static
macro_line|#else&t;/* DEBUG */
mdefine_line|#define RLMT_STATIC
macro_line|#ifndef SK_LITTLE_ENDIAN
multiline_comment|/* First 32 bits */
mdefine_line|#define OFFS_LO32&t;1
multiline_comment|/* Second 32 bits */
mdefine_line|#define OFFS_HI32&t;0
macro_line|#else&t;/* SK_LITTLE_ENDIAN */
multiline_comment|/* First 32 bits */
mdefine_line|#define OFFS_LO32&t;0
multiline_comment|/* Second 32 bits */
mdefine_line|#define OFFS_HI32&t;1
macro_line|#endif&t;/* SK_LITTLE_ENDIAN */
macro_line|#endif&t;/* DEBUG */
multiline_comment|/* ----- Private timeout values ----- */
DECL|macro|SK_RLMT_MIN_TO_VAL
mdefine_line|#define SK_RLMT_MIN_TO_VAL&t;&t;   125000&t;/* 1/8 sec. */
DECL|macro|SK_RLMT_DEF_TO_VAL
mdefine_line|#define SK_RLMT_DEF_TO_VAL&t;&t;  1000000&t;/* 1 sec. */
DECL|macro|SK_RLMT_PORTDOWN_TIM_VAL
mdefine_line|#define SK_RLMT_PORTDOWN_TIM_VAL&t;   900000&t;/* another 0.9 sec. */
DECL|macro|SK_RLMT_PORTSTART_TIM_VAL
mdefine_line|#define SK_RLMT_PORTSTART_TIM_VAL&t;   100000&t;/* 0.1 sec. */
DECL|macro|SK_RLMT_PORTUP_TIM_VAL
mdefine_line|#define SK_RLMT_PORTUP_TIM_VAL&t;&t;  2500000&t;/* 2.5 sec. */
DECL|macro|SK_RLMT_SEG_TO_VAL
mdefine_line|#define SK_RLMT_SEG_TO_VAL&t;&t;900000000&t;/* 15 min. */
multiline_comment|/*&n; * Amount that a time stamp must be later to be recognized as &quot;substantially&n; * later&quot;. This is about 1/128 sec.&n; */
DECL|macro|SK_RLMT_BC_DELTA
mdefine_line|#define SK_RLMT_BC_DELTA&t;((SK_TICKS_PER_SEC &gt;&gt; 7) + 1)
multiline_comment|/* ----- Private RLMT defaults ----- */
DECL|macro|SK_RLMT_DEF_PREF_PORT
mdefine_line|#define SK_RLMT_DEF_PREF_PORT&t;0&t;&t;&t;/* &quot;Lower&quot; port. */
DECL|macro|SK_RLMT_DEF_MODE
mdefine_line|#define SK_RLMT_DEF_MODE &t;SK_RLMT_CHECK_LINK&t;/* Default RLMT Mode. */
multiline_comment|/* ----- Private RLMT checking states ----- */
DECL|macro|SK_RLMT_RCS_SEG
mdefine_line|#define SK_RLMT_RCS_SEG&t;&t;1&t;/* RLMT Check State: check seg. */
DECL|macro|SK_RLMT_RCS_START_SEG
mdefine_line|#define SK_RLMT_RCS_START_SEG&t;2&t;/* RLMT Check State: start check seg. */
DECL|macro|SK_RLMT_RCS_SEND_SEG
mdefine_line|#define SK_RLMT_RCS_SEND_SEG&t;4&t;/* RLMT Check State: send BPDU packet */
DECL|macro|SK_RLMT_RCS_REPORT_SEG
mdefine_line|#define SK_RLMT_RCS_REPORT_SEG&t;8&t;/* RLMT Check State: report seg. */
multiline_comment|/* ----- Private PORT checking states ----- */
DECL|macro|SK_RLMT_PCS_TX
mdefine_line|#define SK_RLMT_PCS_TX&t;&t;1&t;/* Port Check State: check tx. */
DECL|macro|SK_RLMT_PCS_RX
mdefine_line|#define SK_RLMT_PCS_RX&t;&t;2&t;/* Port Check State: check rx. */
multiline_comment|/* ----- Private PORT events ----- */
multiline_comment|/* Note: Update simulation when changing these. */
DECL|macro|SK_RLMT_PORTSTART_TIM
mdefine_line|#define SK_RLMT_PORTSTART_TIM&t;1100&t;/* Port start timeout. */
DECL|macro|SK_RLMT_PORTUP_TIM
mdefine_line|#define SK_RLMT_PORTUP_TIM&t;1101&t;/* Port can now go up. */
DECL|macro|SK_RLMT_PORTDOWN_RX_TIM
mdefine_line|#define SK_RLMT_PORTDOWN_RX_TIM&t;1102&t;/* Port did not receive once ... */
DECL|macro|SK_RLMT_PORTDOWN
mdefine_line|#define SK_RLMT_PORTDOWN&t;1103&t;/* Port went down. */
DECL|macro|SK_RLMT_PORTDOWN_TX_TIM
mdefine_line|#define SK_RLMT_PORTDOWN_TX_TIM&t;1104&t;/* Partner did not receive ... */
multiline_comment|/* ----- Private RLMT events ----- */
multiline_comment|/* Note: Update simulation when changing these. */
DECL|macro|SK_RLMT_TIM
mdefine_line|#define SK_RLMT_TIM&t;&t;2100&t;/* RLMT timeout. */
DECL|macro|SK_RLMT_SEG_TIM
mdefine_line|#define SK_RLMT_SEG_TIM&t;&t;2101&t;/* RLMT segmentation check timeout. */
DECL|macro|TO_SHORTEN
mdefine_line|#define TO_SHORTEN(tim)&t;((tim) / 2)
multiline_comment|/* Error numbers and messages. */
DECL|macro|SKERR_RLMT_E001
mdefine_line|#define SKERR_RLMT_E001&t;&t;(SK_ERRBASE_RLMT + 0)
DECL|macro|SKERR_RLMT_E001_MSG
mdefine_line|#define SKERR_RLMT_E001_MSG&t;&quot;No Packet.&quot;
DECL|macro|SKERR_RLMT_E002
mdefine_line|#define SKERR_RLMT_E002&t;&t;(SKERR_RLMT_E001 + 1)
DECL|macro|SKERR_RLMT_E002_MSG
mdefine_line|#define SKERR_RLMT_E002_MSG&t;&quot;Short Packet.&quot;
DECL|macro|SKERR_RLMT_E003
mdefine_line|#define SKERR_RLMT_E003&t;&t;(SKERR_RLMT_E002 + 1)
DECL|macro|SKERR_RLMT_E003_MSG
mdefine_line|#define SKERR_RLMT_E003_MSG&t;&quot;Unknown RLMT event.&quot;
DECL|macro|SKERR_RLMT_E004
mdefine_line|#define SKERR_RLMT_E004&t;&t;(SKERR_RLMT_E003 + 1)
DECL|macro|SKERR_RLMT_E004_MSG
mdefine_line|#define SKERR_RLMT_E004_MSG&t;&quot;PortsUp incorrect.&quot;
DECL|macro|SKERR_RLMT_E005
mdefine_line|#define SKERR_RLMT_E005&t;&t;(SKERR_RLMT_E004 + 1)
DECL|macro|SKERR_RLMT_E005_MSG
mdefine_line|#define SKERR_RLMT_E005_MSG&t;&bslash;&n; &quot;Net seems to be segmented (different root bridges are reported on the ports).&quot;
DECL|macro|SKERR_RLMT_E006
mdefine_line|#define SKERR_RLMT_E006&t;&t;(SKERR_RLMT_E005 + 1)
DECL|macro|SKERR_RLMT_E006_MSG
mdefine_line|#define SKERR_RLMT_E006_MSG&t;&quot;Duplicate MAC Address detected.&quot;
DECL|macro|SKERR_RLMT_E007
mdefine_line|#define SKERR_RLMT_E007&t;&t;(SKERR_RLMT_E006 + 1)
DECL|macro|SKERR_RLMT_E007_MSG
mdefine_line|#define SKERR_RLMT_E007_MSG&t;&quot;LinksUp incorrect.&quot;
DECL|macro|SKERR_RLMT_E008
mdefine_line|#define SKERR_RLMT_E008&t;&t;(SKERR_RLMT_E007 + 1)
DECL|macro|SKERR_RLMT_E008_MSG
mdefine_line|#define SKERR_RLMT_E008_MSG&t;&quot;Port not started but link came up.&quot;
DECL|macro|SKERR_RLMT_E009
mdefine_line|#define SKERR_RLMT_E009&t;&t;(SKERR_RLMT_E008 + 1)
DECL|macro|SKERR_RLMT_E009_MSG
mdefine_line|#define SKERR_RLMT_E009_MSG&t;&quot;Corrected illegal setting of Preferred Port.&quot;
DECL|macro|SKERR_RLMT_E010
mdefine_line|#define SKERR_RLMT_E010&t;&t;(SKERR_RLMT_E009 + 1)
DECL|macro|SKERR_RLMT_E010_MSG
mdefine_line|#define SKERR_RLMT_E010_MSG&t;&quot;Ignored illegal Preferred Port.&quot;
multiline_comment|/* LLC field values. */
DECL|macro|LLC_COMMAND_RESPONSE_BIT
mdefine_line|#define LLC_COMMAND_RESPONSE_BIT&t;1
DECL|macro|LLC_TEST_COMMAND
mdefine_line|#define LLC_TEST_COMMAND&t;&t;0xE3
DECL|macro|LLC_UI
mdefine_line|#define LLC_UI&t;&t;&t;&t;0x03
multiline_comment|/* RLMT Packet fields. */
DECL|macro|SK_RLMT_DSAP
mdefine_line|#define&t;SK_RLMT_DSAP&t;&t;&t;0
DECL|macro|SK_RLMT_SSAP
mdefine_line|#define&t;SK_RLMT_SSAP&t;&t;&t;0
DECL|macro|SK_RLMT_CTRL
mdefine_line|#define SK_RLMT_CTRL&t;&t;&t;(LLC_TEST_COMMAND)
DECL|macro|SK_RLMT_INDICATOR0
mdefine_line|#define SK_RLMT_INDICATOR0&t;&t;0x53&t;/* S */
DECL|macro|SK_RLMT_INDICATOR1
mdefine_line|#define SK_RLMT_INDICATOR1&t;&t;0x4B&t;/* K */
DECL|macro|SK_RLMT_INDICATOR2
mdefine_line|#define SK_RLMT_INDICATOR2&t;&t;0x2D&t;/* - */
DECL|macro|SK_RLMT_INDICATOR3
mdefine_line|#define SK_RLMT_INDICATOR3&t;&t;0x52&t;/* R */
DECL|macro|SK_RLMT_INDICATOR4
mdefine_line|#define SK_RLMT_INDICATOR4&t;&t;0x4C&t;/* L */
DECL|macro|SK_RLMT_INDICATOR5
mdefine_line|#define SK_RLMT_INDICATOR5&t;&t;0x4D&t;/* M */
DECL|macro|SK_RLMT_INDICATOR6
mdefine_line|#define SK_RLMT_INDICATOR6&t;&t;0x54&t;/* T */
DECL|macro|SK_RLMT_PACKET_VERSION
mdefine_line|#define SK_RLMT_PACKET_VERSION&t;0
multiline_comment|/* RLMT SPT Flag values. */
DECL|macro|SK_RLMT_SPT_FLAG_CHANGE
mdefine_line|#define&t;SK_RLMT_SPT_FLAG_CHANGE&t;&t;0x01
DECL|macro|SK_RLMT_SPT_FLAG_CHANGE_ACK
mdefine_line|#define&t;SK_RLMT_SPT_FLAG_CHANGE_ACK&t;0x80
multiline_comment|/* RLMT SPT Packet fields. */
DECL|macro|SK_RLMT_SPT_DSAP
mdefine_line|#define&t;SK_RLMT_SPT_DSAP&t;&t;0x42
DECL|macro|SK_RLMT_SPT_SSAP
mdefine_line|#define&t;SK_RLMT_SPT_SSAP&t;&t;0x42
DECL|macro|SK_RLMT_SPT_CTRL
mdefine_line|#define SK_RLMT_SPT_CTRL&t;&t;(LLC_UI)
DECL|macro|SK_RLMT_SPT_PROTOCOL_ID0
mdefine_line|#define&t;SK_RLMT_SPT_PROTOCOL_ID0&t;0x00
DECL|macro|SK_RLMT_SPT_PROTOCOL_ID1
mdefine_line|#define&t;SK_RLMT_SPT_PROTOCOL_ID1&t;0x00
DECL|macro|SK_RLMT_SPT_PROTOCOL_VERSION_ID
mdefine_line|#define&t;SK_RLMT_SPT_PROTOCOL_VERSION_ID&t;0x00
DECL|macro|SK_RLMT_SPT_BPDU_TYPE
mdefine_line|#define&t;SK_RLMT_SPT_BPDU_TYPE&t;&t;0x00
DECL|macro|SK_RLMT_SPT_FLAGS
mdefine_line|#define&t;SK_RLMT_SPT_FLAGS&t;&t;0x00&t;/* ?? */
DECL|macro|SK_RLMT_SPT_ROOT_ID0
mdefine_line|#define&t;SK_RLMT_SPT_ROOT_ID0&t;&t;0xFF&t;/* Lowest possible priority. */
DECL|macro|SK_RLMT_SPT_ROOT_ID1
mdefine_line|#define&t;SK_RLMT_SPT_ROOT_ID1&t;&t;0xFF&t;/* Lowest possible priority. */
multiline_comment|/* Remaining 6 bytes will be the current port address. */
DECL|macro|SK_RLMT_SPT_ROOT_PATH_COST0
mdefine_line|#define&t;SK_RLMT_SPT_ROOT_PATH_COST0&t;0x00
DECL|macro|SK_RLMT_SPT_ROOT_PATH_COST1
mdefine_line|#define&t;SK_RLMT_SPT_ROOT_PATH_COST1&t;0x00
DECL|macro|SK_RLMT_SPT_ROOT_PATH_COST2
mdefine_line|#define&t;SK_RLMT_SPT_ROOT_PATH_COST2&t;0x00
DECL|macro|SK_RLMT_SPT_ROOT_PATH_COST3
mdefine_line|#define&t;SK_RLMT_SPT_ROOT_PATH_COST3&t;0x00
DECL|macro|SK_RLMT_SPT_BRIDGE_ID0
mdefine_line|#define&t;SK_RLMT_SPT_BRIDGE_ID0&t;&t;0xFF&t;/* Lowest possible priority. */
DECL|macro|SK_RLMT_SPT_BRIDGE_ID1
mdefine_line|#define&t;SK_RLMT_SPT_BRIDGE_ID1&t;&t;0xFF&t;/* Lowest possible priority. */
multiline_comment|/* Remaining 6 bytes will be the current port address. */
DECL|macro|SK_RLMT_SPT_PORT_ID0
mdefine_line|#define&t;SK_RLMT_SPT_PORT_ID0&t;&t;0xFF&t;/* Lowest possible priority. */
DECL|macro|SK_RLMT_SPT_PORT_ID1
mdefine_line|#define&t;SK_RLMT_SPT_PORT_ID1&t;&t;0xFF&t;/* Lowest possible priority. */
DECL|macro|SK_RLMT_SPT_MSG_AGE0
mdefine_line|#define&t;SK_RLMT_SPT_MSG_AGE0&t;&t;0x00
DECL|macro|SK_RLMT_SPT_MSG_AGE1
mdefine_line|#define&t;SK_RLMT_SPT_MSG_AGE1&t;&t;0x00
DECL|macro|SK_RLMT_SPT_MAX_AGE0
mdefine_line|#define&t;SK_RLMT_SPT_MAX_AGE0&t;&t;0x00
DECL|macro|SK_RLMT_SPT_MAX_AGE1
mdefine_line|#define&t;SK_RLMT_SPT_MAX_AGE1&t;&t;0xFF
DECL|macro|SK_RLMT_SPT_HELLO_TIME0
mdefine_line|#define&t;SK_RLMT_SPT_HELLO_TIME0&t;&t;0x00
DECL|macro|SK_RLMT_SPT_HELLO_TIME1
mdefine_line|#define&t;SK_RLMT_SPT_HELLO_TIME1&t;&t;0xFF
DECL|macro|SK_RLMT_SPT_FWD_DELAY0
mdefine_line|#define&t;SK_RLMT_SPT_FWD_DELAY0&t;&t;0x00
DECL|macro|SK_RLMT_SPT_FWD_DELAY1
mdefine_line|#define&t;SK_RLMT_SPT_FWD_DELAY1&t;&t;0x40
multiline_comment|/* Size defines. */
DECL|macro|SK_RLMT_MIN_PACKET_SIZE
mdefine_line|#define SK_RLMT_MIN_PACKET_SIZE&t;34
DECL|macro|SK_RLMT_MAX_PACKET_SIZE
mdefine_line|#define SK_RLMT_MAX_PACKET_SIZE&t;(SK_RLMT_MAX_TX_BUF_SIZE)
DECL|macro|SK_PACKET_DATA_LEN
mdefine_line|#define SK_PACKET_DATA_LEN&t;(SK_RLMT_MAX_PACKET_SIZE - &bslash;&n;&t;&t;&t;&t; SK_RLMT_MIN_PACKET_SIZE)
multiline_comment|/* ----- RLMT packet types ----- */
DECL|macro|SK_PACKET_ANNOUNCE
mdefine_line|#define SK_PACKET_ANNOUNCE&t;1&t;/* Port announcement. */
DECL|macro|SK_PACKET_ALIVE
mdefine_line|#define SK_PACKET_ALIVE&t;&t;2&t;/* Alive packet to port. */
DECL|macro|SK_PACKET_ADDR_CHANGED
mdefine_line|#define SK_PACKET_ADDR_CHANGED&t;3&t;/* Port address changed. */
DECL|macro|SK_PACKET_CHECK_TX
mdefine_line|#define SK_PACKET_CHECK_TX&t;4&t;/* Check your tx line. */
macro_line|#ifdef SK_LITTLE_ENDIAN
DECL|macro|SK_U16_TO_NETWORK_ORDER
mdefine_line|#define SK_U16_TO_NETWORK_ORDER(Val,Addr) { &bslash;&n;&t;SK_U8&t;*_Addr = (SK_U8*)(Addr); &bslash;&n;&t;SK_U16&t;_Val = (SK_U16)(Val); &bslash;&n;&t;*_Addr++ = (SK_U8)(_Val &gt;&gt; 8); &bslash;&n;&t;*_Addr = (SK_U8)(_Val &amp; 0xFF); &bslash;&n;}
macro_line|#endif&t;/* SK_LITTLE_ENDIAN */
macro_line|#ifdef SK_BIG_ENDIAN
DECL|macro|SK_U16_TO_NETWORK_ORDER
mdefine_line|#define SK_U16_TO_NETWORK_ORDER(Val,Addr) (*(SK_U16*)(Addr) = (SK_U16)(Val))
macro_line|#endif&t;/* SK_BIG_ENDIAN */
DECL|macro|AUTONEG_FAILED
mdefine_line|#define AUTONEG_FAILED&t;SK_FALSE
DECL|macro|AUTONEG_SUCCESS
mdefine_line|#define AUTONEG_SUCCESS&t;SK_TRUE
multiline_comment|/* typedefs *******************************************************************/
multiline_comment|/* RLMT packet.  Length: SK_RLMT_MAX_PACKET_SIZE (60) bytes. */
DECL|struct|s_RlmtPacket
r_typedef
r_struct
id|s_RlmtPacket
(brace
DECL|member|DstAddr
id|SK_U8
id|DstAddr
(braket
id|SK_MAC_ADDR_LEN
)braket
suffix:semicolon
DECL|member|SrcAddr
id|SK_U8
id|SrcAddr
(braket
id|SK_MAC_ADDR_LEN
)braket
suffix:semicolon
DECL|member|TypeLen
id|SK_U8
id|TypeLen
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|DSap
id|SK_U8
id|DSap
suffix:semicolon
DECL|member|SSap
id|SK_U8
id|SSap
suffix:semicolon
DECL|member|Ctrl
id|SK_U8
id|Ctrl
suffix:semicolon
DECL|member|Indicator
id|SK_U8
id|Indicator
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|RlmtPacketType
id|SK_U8
id|RlmtPacketType
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|Align1
id|SK_U8
id|Align1
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|Random
id|SK_U8
id|Random
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Random value of requesting(!) station. */
DECL|member|RlmtPacketVersion
id|SK_U8
id|RlmtPacketVersion
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* RLMT Packet version */
DECL|member|Data
id|SK_U8
id|Data
(braket
id|SK_PACKET_DATA_LEN
)braket
suffix:semicolon
DECL|typedef|SK_RLMT_PACKET
)brace
id|SK_RLMT_PACKET
suffix:semicolon
DECL|struct|s_SpTreeRlmtPacket
r_typedef
r_struct
id|s_SpTreeRlmtPacket
(brace
DECL|member|DstAddr
id|SK_U8
id|DstAddr
(braket
id|SK_MAC_ADDR_LEN
)braket
suffix:semicolon
DECL|member|SrcAddr
id|SK_U8
id|SrcAddr
(braket
id|SK_MAC_ADDR_LEN
)braket
suffix:semicolon
DECL|member|TypeLen
id|SK_U8
id|TypeLen
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|DSap
id|SK_U8
id|DSap
suffix:semicolon
DECL|member|SSap
id|SK_U8
id|SSap
suffix:semicolon
DECL|member|Ctrl
id|SK_U8
id|Ctrl
suffix:semicolon
DECL|member|ProtocolId
id|SK_U8
id|ProtocolId
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|ProtocolVersionId
id|SK_U8
id|ProtocolVersionId
suffix:semicolon
DECL|member|BpduType
id|SK_U8
id|BpduType
suffix:semicolon
DECL|member|Flags
id|SK_U8
id|Flags
suffix:semicolon
DECL|member|RootId
id|SK_U8
id|RootId
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|RootPathCost
id|SK_U8
id|RootPathCost
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|BridgeId
id|SK_U8
id|BridgeId
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|PortId
id|SK_U8
id|PortId
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|MessageAge
id|SK_U8
id|MessageAge
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|MaxAge
id|SK_U8
id|MaxAge
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|HelloTime
id|SK_U8
id|HelloTime
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|ForwardDelay
id|SK_U8
id|ForwardDelay
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|SK_SPTREE_PACKET
)brace
id|SK_SPTREE_PACKET
suffix:semicolon
multiline_comment|/* global variables ***********************************************************/
DECL|variable|SkRlmtMcAddr
id|SK_MAC_ADDR
id|SkRlmtMcAddr
op_assign
(brace
(brace
l_int|0x01
comma
l_int|0x00
comma
l_int|0x5A
comma
l_int|0x52
comma
l_int|0x4C
comma
l_int|0x4D
)brace
)brace
suffix:semicolon
DECL|variable|BridgeMcAddr
id|SK_MAC_ADDR
id|BridgeMcAddr
op_assign
(brace
(brace
l_int|0x01
comma
l_int|0x80
comma
l_int|0xC2
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
suffix:semicolon
DECL|variable|BcAddr
id|SK_MAC_ADDR
id|BcAddr
op_assign
(brace
(brace
l_int|0xFF
comma
l_int|0xFF
comma
l_int|0xFF
comma
l_int|0xFF
comma
l_int|0xFF
comma
l_int|0xFF
)brace
)brace
suffix:semicolon
multiline_comment|/* local variables ************************************************************/
multiline_comment|/* None. */
multiline_comment|/* functions ******************************************************************/
id|RLMT_STATIC
r_void
id|SkRlmtCheckSwitch
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
id|SK_IOC
id|IoC
)paren
suffix:semicolon
id|RLMT_STATIC
r_void
id|SkRlmtCheckSeg
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
id|SK_IOC
id|IoC
)paren
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtInit - initialize data, set state to init&n; *&n; * Description:&n; *&n; *&t;SK_INIT_DATA&n; *&t;============&n; *&n; *&t;This routine initializes all RLMT-related variables to a known state.&n; *&t;The initial state is SK_RLMT_RS_INIT.&n; *&t;All ports are initialized to SK_RLMT_PS_INIT.&n; *&n; *&n; *&t;SK_INIT_IO&n; *&t;==========&n; *&n; *&t;Nothing.&n; *&n; *&n; *&t;SK_INIT_RUN&n; *&t;===========&n; *&n; *&t;Determine the adapter&squot;s random value.&n; *&t;Set the hw registers, the &quot;logical adapter address&quot;, the&n; *&t;RLMT multicast address, and eventually the BPDU multicast address.&n; *&n; * Context:&n; *&t;init, pageable&n; *&n; * Returns:&n; *&t;Nothing.&n; */
DECL|function|SkRlmtInit
r_void
id|SkRlmtInit
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
r_int
id|Level
)paren
multiline_comment|/* initialization level */
(brace
id|SK_U32
id|i
comma
id|j
suffix:semicolon
id|SK_U64
id|Random
suffix:semicolon
id|SK_EVPARA
id|Para
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_INIT
comma
(paren
l_string|&quot;RLMT Init level %d.&bslash;n&quot;
comma
id|Level
)paren
)paren
r_switch
c_cond
(paren
id|Level
)paren
(brace
r_case
id|SK_INIT_DATA
suffix:colon
multiline_comment|/* Initialize data structures. */
id|SK_MEMSET
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pAC-&gt;Rlmt
comma
l_int|0
comma
r_sizeof
(paren
id|SK_RLMT
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAX_MACS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_assign
id|SK_RLMT_PS_INIT
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|LinkDown
op_assign
id|SK_TRUE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortDown
op_assign
id|SK_TRUE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortStarted
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortNoRx
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
)brace
id|pAC-&gt;Rlmt.RlmtState
op_assign
id|SK_RLMT_RS_INIT
suffix:semicolon
id|pAC-&gt;Rlmt.RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.MacPreferred
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* Automatic. */
id|pAC-&gt;Rlmt.PrefPort
op_assign
id|SK_RLMT_DEF_PREF_PORT
suffix:semicolon
id|pAC-&gt;Rlmt.MacActive
op_assign
id|pAC-&gt;Rlmt.PrefPort
suffix:semicolon
multiline_comment|/* Just assuming. */
id|pAC-&gt;Rlmt.RlmtMode
op_assign
id|SK_RLMT_DEF_MODE
suffix:semicolon
id|pAC-&gt;Rlmt.TimeoutValue
op_assign
id|SK_RLMT_DEF_TO_VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_INIT_IO
suffix:colon
multiline_comment|/* GIMacsFound first available here. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_INIT
comma
(paren
l_string|&quot;RLMT: %d MACs were detected.&bslash;n&quot;
comma
id|pAC-&gt;GIni.GIMacsFound
)paren
)paren
multiline_comment|/* Initialize HW registers? */
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
OL
l_int|2
)paren
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_CHECK_LINK
suffix:semicolon
(paren
r_void
)paren
id|SkRlmtEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_RLMT_MODE_CHANGE
comma
id|Para
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SK_INIT_RUN
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Random
op_assign
id|SkOsGetTime
c_func
(paren
id|pAC
)paren
suffix:semicolon
op_star
(paren
id|SK_U32
op_star
)paren
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Random
op_assign
op_star
(paren
id|SK_U32
op_star
)paren
op_amp
id|Random
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Random
(braket
id|j
)braket
op_xor_assign
id|pAC-&gt;Addr.Port
(braket
id|i
)braket
dot
id|CurrentMacAddress.a
(braket
id|SK_MAC_ADDR_LEN
op_minus
l_int|1
op_minus
id|j
)braket
suffix:semicolon
)brace
(paren
r_void
)paren
id|SkAddrMcClear
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
id|SK_ADDR_PERMANENT
op_or
id|SK_MC_SW_ONLY
)paren
suffix:semicolon
multiline_comment|/* Add RLMT MC address. */
(paren
r_void
)paren
id|SkAddrMcAdd
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
op_amp
id|SkRlmtMcAddr
comma
id|SK_ADDR_PERMANENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
(brace
multiline_comment|/* Add BPDU MC address. */
(paren
r_void
)paren
id|SkAddrMcAdd
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
op_amp
id|BridgeMcAddr
comma
id|SK_ADDR_PERMANENT
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|SkAddrMcUpdate
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* error */
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SkRlmtInit */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtBuildCheckChain - build the check chain&n; *&n; * Description:&n; *&t;This routine builds the local check chain:&n; *&t;- Each port that is up checks the next port.&n; *&t;- The last port that is up checks the first port that is up.&n; *&n; * Notes:&n; *&t;- Currently only local ports are considered when building the chain.&n; *&t;- Currently the SuspectState is just reset;&n; *&t;  it would be better to save it ...&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing&n; */
DECL|function|SkRlmtBuildCheckChain
id|RLMT_STATIC
r_void
id|SkRlmtBuildCheckChain
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
multiline_comment|/* adapter context */
(brace
id|SK_U32
id|i
suffix:semicolon
id|SK_U32
id|NumMacsUp
suffix:semicolon
id|SK_U32
id|FirstMacUp
op_assign
l_int|0
suffix:semicolon
id|SK_U32
id|PrevMacUp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_LOC_LINK
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortsChecked
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
multiline_comment|/* Nothing to build. */
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SkRlmtBuildCheckChain.&bslash;n&quot;
)paren
)paren
id|NumMacsUp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortsChecked
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortsSuspect
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|CheckingState
op_and_assign
op_complement
(paren
id|SK_RLMT_PCS_RX
op_or
id|SK_RLMT_PCS_TX
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If more than two links are detected we should consider&n;&t;&t; * checking at least two other ports:&n;&t;&t; * 1. the next port that is not LinkDown and&n;&t;&t; * 2. the next port that is not PortDown.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|LinkDown
)paren
(brace
r_if
c_cond
(paren
id|NumMacsUp
op_eq
l_int|0
)paren
(brace
id|FirstMacUp
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortCheck
(braket
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortsChecked
)braket
dot
id|CheckAddr
op_assign
id|pAC-&gt;Addr.Port
(braket
id|i
)braket
dot
id|CurrentMacAddress
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortCheck
(braket
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortsChecked
)braket
dot
id|SuspectTx
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortsChecked
op_increment
suffix:semicolon
)brace
id|PrevMacUp
op_assign
id|i
suffix:semicolon
id|NumMacsUp
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|NumMacsUp
OG
l_int|1
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortCheck
(braket
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortsChecked
)braket
dot
id|CheckAddr
op_assign
id|pAC-&gt;Addr.Port
(braket
id|FirstMacUp
)braket
dot
id|CurrentMacAddress
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortCheck
(braket
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortsChecked
)braket
dot
id|SuspectTx
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PrevMacUp
)braket
dot
id|PortsChecked
op_increment
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Port %d checks %d other ports: %2X.&bslash;n&quot;
comma
id|i
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortsChecked
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortCheck
(braket
l_int|0
)braket
dot
id|CheckAddr.a
(braket
l_int|5
)braket
)paren
)paren
)brace
macro_line|#endif&t;/* DEBUG */
r_return
suffix:semicolon
)brace
multiline_comment|/* SkRlmtBuildCheckChain */
macro_line|#ifdef SK_RLMT_SLOW_LOOKAHEAD
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtLookaheadPacket - examine received packet shortly, count s-th&n; *&n; * Description:&n; *&t;This routine examines each received packet fast and short and&n; *&t;increments some counters.&n; *&t;The received packet has to be stored virtually contiguous.&n; *&t;This function does the following:&n; *&t;- Increment some counters.&n; *&t;- Ensure length is sufficient.&n; *&t;- Ensure that destination address is physical port address,&n; *&t;  RLMT multicast, or BPDU multicast address.&n; *&n; * Notes:&n; *&t;This function is fully reentrant while the fast path is not blocked.&n; *&n; * Context:&n; *&t;isr/dpr, not pageable&n; *&n; * Returns:&n; *&t;SK_FALSE packet for upper layers&n; *&t;SK_TRUE  packet for RLMT&n; */
DECL|function|SkRlmtLookaheadPacket
id|SK_BOOL
id|SkRlmtLookaheadPacket
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_U32
id|PortIdx
comma
multiline_comment|/* receiving port */
id|SK_U8
op_star
id|pLaPacket
comma
multiline_comment|/* received packet&squot;s data */
r_int
id|PacketLength
comma
multiline_comment|/* received packet&squot;s length */
multiline_comment|/* Necessary? */
r_int
id|LaLength
)paren
multiline_comment|/* lookahead length */
(brace
r_int
id|i
suffix:semicolon
id|SK_BOOL
id|IsBc
suffix:semicolon
multiline_comment|/* Broadcast address? */
r_int
id|RxDest
suffix:semicolon
multiline_comment|/* Receive destination? */
r_int
id|Offset
suffix:semicolon
multiline_comment|/* Offset of data to present to LOOKAHEAD. */
r_int
id|NumBytes
suffix:semicolon
multiline_comment|/* #Bytes to present to LOOKAHEAD. */
id|SK_RLMT_PACKET
op_star
id|pRPacket
suffix:semicolon
id|SK_ADDR_PORT
op_star
id|pAPort
suffix:semicolon
macro_line|#ifdef DEBUG
id|PacketLength
op_assign
id|PacketLength
suffix:semicolon
macro_line|#endif&t;/* DEBUG */
id|pRPacket
op_assign
(paren
id|SK_RLMT_PACKET
op_star
)paren
id|pLaPacket
suffix:semicolon
id|pAPort
op_assign
op_amp
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|pLaPacket
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Create error log entry. */
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E001
comma
id|SKERR_RLMT_E001_MSG
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtLookaheadPacket: NULL pointer.&bslash;n&quot;
)paren
)paren
r_return
(paren
id|SK_FALSE
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* DEBUG */
multiline_comment|/* Drivers should get IsBc from the descriptor. */
id|IsBc
op_assign
id|SK_TRUE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|IsBc
op_logical_and
id|i
OL
id|SK_MAC_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IsBc
op_assign
id|IsBc
op_logical_and
(paren
id|pLaPacket
(braket
id|i
)braket
op_eq
l_int|0xFF
)paren
suffix:semicolon
)brace
id|SK_RLMT_PRE_LOOKAHEAD
c_func
(paren
id|pAC
comma
id|PortIdx
comma
id|PacketLength
comma
id|IsBc
comma
op_amp
id|Offset
comma
op_amp
id|NumBytes
)paren
r_if
c_cond
(paren
id|NumBytes
op_eq
l_int|0
)paren
(brace
r_return
(paren
id|SK_FALSE
)paren
suffix:semicolon
)brace
id|SK_RLMT_LOOKAHEAD
c_func
(paren
id|pAC
comma
id|PortIdx
comma
op_amp
id|pLaPacket
(braket
id|Offset
)braket
comma
id|IsBc
comma
id|pLaPacket
(braket
l_int|0
)braket
op_amp
l_int|1
comma
multiline_comment|/* Drivers: Get info from descriptor. */
op_amp
id|RxDest
)paren
r_if
c_cond
(paren
id|RxDest
op_amp
id|SK_RLMT_RX_RLMT
)paren
(brace
r_return
(paren
id|SK_TRUE
)paren
suffix:semicolon
)brace
r_return
(paren
id|SK_FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtLookaheadPacket */
macro_line|#endif&t;/* SK_RLMT_SLOW_LOOKAHEAD */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtBuildPacket - build an RLMT packet&n; *&n; * Description:&n; *&t;This routine sets up an RLMT packet.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;NULL or pointer to RLMT mbuf&n; */
DECL|function|SkRlmtBuildPacket
id|RLMT_STATIC
id|SK_MBUF
op_star
id|SkRlmtBuildPacket
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|PortIdx
comma
multiline_comment|/* sending port */
id|SK_U16
id|PacketType
comma
multiline_comment|/* RLMT packet type */
id|SK_MAC_ADDR
op_star
id|SrcAddr
comma
multiline_comment|/* source address */
id|SK_MAC_ADDR
op_star
id|DestAddr
)paren
multiline_comment|/* destination address */
(brace
r_int
id|i
suffix:semicolon
id|SK_U16
id|Length
suffix:semicolon
id|SK_MBUF
op_star
id|pMb
suffix:semicolon
id|SK_RLMT_PACKET
op_star
id|pPacket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pMb
op_assign
id|SkDrvAllocRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_RLMT_MAX_PACKET_SIZE
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pPacket
op_assign
(paren
id|SK_RLMT_PACKET
op_star
)paren
id|pMb-&gt;pData
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAC_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pPacket-&gt;DstAddr
(braket
id|i
)braket
op_assign
id|DestAddr-&gt;a
(braket
id|i
)braket
suffix:semicolon
id|pPacket-&gt;SrcAddr
(braket
id|i
)braket
op_assign
id|SrcAddr-&gt;a
(braket
id|i
)braket
suffix:semicolon
)brace
id|pPacket-&gt;DSap
op_assign
id|SK_RLMT_DSAP
suffix:semicolon
id|pPacket-&gt;SSap
op_assign
id|SK_RLMT_SSAP
suffix:semicolon
id|pPacket-&gt;Ctrl
op_assign
id|SK_RLMT_CTRL
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_INDICATOR0
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_INDICATOR1
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|2
)braket
op_assign
id|SK_RLMT_INDICATOR2
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|3
)braket
op_assign
id|SK_RLMT_INDICATOR3
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|4
)braket
op_assign
id|SK_RLMT_INDICATOR4
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|5
)braket
op_assign
id|SK_RLMT_INDICATOR5
suffix:semicolon
id|pPacket-&gt;Indicator
(braket
l_int|6
)braket
op_assign
id|SK_RLMT_INDICATOR6
suffix:semicolon
id|SK_U16_TO_NETWORK_ORDER
c_func
(paren
id|PacketType
comma
op_amp
id|pPacket-&gt;RlmtPacketType
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pPacket-&gt;Random
(braket
id|i
)braket
op_assign
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|Random
(braket
id|i
)braket
suffix:semicolon
)brace
id|SK_U16_TO_NETWORK_ORDER
c_func
(paren
id|SK_RLMT_PACKET_VERSION
comma
op_amp
id|pPacket-&gt;RlmtPacketVersion
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_PACKET_DATA_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pPacket-&gt;Data
(braket
id|i
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
id|Length
op_assign
id|SK_RLMT_MAX_PACKET_SIZE
suffix:semicolon
multiline_comment|/* Or smaller. */
id|pMb-&gt;Length
op_assign
id|Length
suffix:semicolon
id|pMb-&gt;PortIdx
op_assign
id|PortIdx
suffix:semicolon
id|Length
op_sub_assign
l_int|14
suffix:semicolon
id|SK_U16_TO_NETWORK_ORDER
c_func
(paren
id|Length
comma
op_amp
id|pPacket-&gt;TypeLen
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PacketType
op_eq
id|SK_PACKET_ALIVE
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|TxHelloCts
op_increment
suffix:semicolon
)brace
)brace
r_return
(paren
id|pMb
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtBuildPacket */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtBuildSpanningTreePacket - build spanning tree check packet&n; *&n; * Description:&n; *&t;This routine sets up a BPDU packet for spanning tree check.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;NULL or pointer to RLMT mbuf&n; */
DECL|function|SkRlmtBuildSpanningTreePacket
id|RLMT_STATIC
id|SK_MBUF
op_star
id|SkRlmtBuildSpanningTreePacket
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|PortIdx
)paren
multiline_comment|/* sending port */
(brace
r_int
id|i
suffix:semicolon
id|SK_U16
id|Length
suffix:semicolon
id|SK_MBUF
op_star
id|pMb
suffix:semicolon
id|SK_SPTREE_PACKET
op_star
id|pSPacket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pMb
op_assign
id|SkDrvAllocRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_RLMT_MAX_PACKET_SIZE
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pSPacket
op_assign
(paren
id|SK_SPTREE_PACKET
op_star
)paren
id|pMb-&gt;pData
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAC_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pSPacket-&gt;DstAddr
(braket
id|i
)braket
op_assign
id|BridgeMcAddr.a
(braket
id|i
)braket
suffix:semicolon
id|pSPacket-&gt;SrcAddr
(braket
id|i
)braket
op_assign
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|CurrentMacAddress.a
(braket
id|i
)braket
suffix:semicolon
)brace
id|pSPacket-&gt;DSap
op_assign
id|SK_RLMT_SPT_DSAP
suffix:semicolon
id|pSPacket-&gt;SSap
op_assign
id|SK_RLMT_SPT_SSAP
suffix:semicolon
id|pSPacket-&gt;Ctrl
op_assign
id|SK_RLMT_SPT_CTRL
suffix:semicolon
id|pSPacket-&gt;ProtocolId
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_PROTOCOL_ID0
suffix:semicolon
id|pSPacket-&gt;ProtocolId
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_PROTOCOL_ID1
suffix:semicolon
id|pSPacket-&gt;ProtocolVersionId
op_assign
id|SK_RLMT_SPT_PROTOCOL_VERSION_ID
suffix:semicolon
id|pSPacket-&gt;BpduType
op_assign
id|SK_RLMT_SPT_BPDU_TYPE
suffix:semicolon
id|pSPacket-&gt;Flags
op_assign
id|SK_RLMT_SPT_FLAGS
suffix:semicolon
id|pSPacket-&gt;RootId
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_ROOT_ID0
suffix:semicolon
id|pSPacket-&gt;RootId
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_ROOT_ID1
suffix:semicolon
id|pSPacket-&gt;RootPathCost
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_ROOT_PATH_COST0
suffix:semicolon
id|pSPacket-&gt;RootPathCost
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_ROOT_PATH_COST1
suffix:semicolon
id|pSPacket-&gt;RootPathCost
(braket
l_int|2
)braket
op_assign
id|SK_RLMT_SPT_ROOT_PATH_COST2
suffix:semicolon
id|pSPacket-&gt;RootPathCost
(braket
l_int|3
)braket
op_assign
id|SK_RLMT_SPT_ROOT_PATH_COST3
suffix:semicolon
id|pSPacket-&gt;BridgeId
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_BRIDGE_ID0
suffix:semicolon
id|pSPacket-&gt;BridgeId
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_BRIDGE_ID1
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Use virtual address as bridge ID and filter these packets&n;&t;&t; * on receive.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAC_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pSPacket-&gt;BridgeId
(braket
id|i
op_plus
l_int|2
)braket
op_assign
id|pSPacket-&gt;RootId
(braket
id|i
op_plus
l_int|2
)braket
op_assign
id|pAC-&gt;Addr.CurrentMacAddress.a
(braket
id|i
)braket
suffix:semicolon
)brace
id|pSPacket-&gt;PortId
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_PORT_ID0
suffix:semicolon
id|pSPacket-&gt;PortId
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_PORT_ID1
suffix:semicolon
id|pSPacket-&gt;MessageAge
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_MSG_AGE0
suffix:semicolon
id|pSPacket-&gt;MessageAge
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_MSG_AGE1
suffix:semicolon
id|pSPacket-&gt;MaxAge
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_MAX_AGE0
suffix:semicolon
id|pSPacket-&gt;MaxAge
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_MAX_AGE1
suffix:semicolon
id|pSPacket-&gt;HelloTime
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_HELLO_TIME0
suffix:semicolon
id|pSPacket-&gt;HelloTime
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_HELLO_TIME1
suffix:semicolon
id|pSPacket-&gt;ForwardDelay
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_SPT_FWD_DELAY0
suffix:semicolon
id|pSPacket-&gt;ForwardDelay
(braket
l_int|1
)braket
op_assign
id|SK_RLMT_SPT_FWD_DELAY1
suffix:semicolon
id|Length
op_assign
id|SK_RLMT_MAX_PACKET_SIZE
suffix:semicolon
multiline_comment|/* Or smaller. */
id|pMb-&gt;Length
op_assign
id|Length
suffix:semicolon
id|pMb-&gt;PortIdx
op_assign
id|PortIdx
suffix:semicolon
id|Length
op_sub_assign
l_int|14
suffix:semicolon
id|SK_U16_TO_NETWORK_ORDER
c_func
(paren
id|Length
comma
op_amp
id|pSPacket-&gt;TypeLen
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|TxSpHelloReqCts
op_increment
suffix:semicolon
)brace
r_return
(paren
id|pMb
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtBuildSpanningTreePacket */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtSend - build and send check packets&n; *&n; * Description:&n; *&t;Depending on the RLMT state and the checking state, several packets&n; *&t;are sent through the indicated port.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing.&n; */
DECL|function|SkRlmtSend
id|RLMT_STATIC
r_void
id|SkRlmtSend
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|PortIdx
)paren
(brace
r_int
id|j
suffix:semicolon
id|SK_EVPARA
id|Para
suffix:semicolon
id|SK_RLMT_PORT
op_star
id|pRPort
suffix:semicolon
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_LOC_LINK
)paren
(brace
r_if
c_cond
(paren
id|pRPort-&gt;CheckingState
op_amp
(paren
id|SK_RLMT_PCS_TX
op_or
id|SK_RLMT_PCS_RX
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Port is suspicious. Send the RLMT packet to the&n;&t;&t;&t; * RLMT multicast address.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
comma
id|SK_PACKET_ALIVE
comma
op_amp
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|CurrentMacAddress
comma
op_amp
id|SkRlmtMcAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * Send a directed RLMT packet to all ports that are&n;&t;&t;&t; * checked by the indicated port.&n;&t;&t;&t; */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|pRPort-&gt;PortsChecked
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
comma
id|SK_PACKET_ALIVE
comma
op_amp
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|CurrentMacAddress
comma
op_amp
id|pRPort-&gt;PortCheck
(braket
id|j
)braket
dot
id|CheckAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
op_logical_and
(paren
id|pAC-&gt;Rlmt.CheckingState
op_amp
id|SK_RLMT_RCS_SEND_SEG
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Send a BPDU packet to make a connected switch tell us&n;&t;&t; * the correct root bridge.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildSpanningTreePacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pAC-&gt;Rlmt.CheckingState
op_and_assign
op_complement
id|SK_RLMT_RCS_SEND_SEG
suffix:semicolon
id|pRPort-&gt;RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_TX
comma
(paren
l_string|&quot;SkRlmtSend: BPDU Packet on Port %u.&bslash;n&quot;
comma
id|PortIdx
)paren
)paren
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SkRlmtSend */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtPortReceives - check if port is (going) down and bring it up&n; *&n; * Description:&n; *&t;This routine checks if a port who received a non-BPDU packet&n; *&t;needs to go up or needs to be stopped going down.&n; *&n;* Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing.&n; */
DECL|function|SkRlmtPortReceives
id|RLMT_STATIC
r_void
id|SkRlmtPortReceives
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|PortIdx
)paren
multiline_comment|/* port to check */
(brace
id|SK_RLMT_PORT
op_star
id|pRPort
suffix:semicolon
id|SK_EVPARA
id|Para
suffix:semicolon
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
suffix:semicolon
id|pRPort-&gt;PortNoRx
op_assign
id|SK_FALSE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pRPort-&gt;PortState
op_eq
id|SK_RLMT_PS_DOWN
)paren
op_logical_and
op_logical_neg
(paren
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_TX
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Port is marked down (rx), but received a non-BPDU packet.&n;&t;&t; * Bring it up.&n;&t;&t; */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Received on PortDown.&bslash;n&quot;
)paren
)paren
id|pRPort-&gt;PortState
op_assign
id|SK_RLMT_PS_GOING_UP
suffix:semicolon
id|pRPort-&gt;GuTimeStamp
op_assign
id|SkOsGetTime
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|PortIdx
suffix:semicolon
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;UpTimer
comma
id|SK_RLMT_PORTUP_TIM_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PORTUP_TIM
comma
id|Para
)paren
suffix:semicolon
id|SkRlmtCheckSwitch
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Stop bringing port down.&bslash;n&quot;
)paren
)paren
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownRxTimer
)paren
suffix:semicolon
id|SkRlmtCheckSwitch
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
)brace
id|pRPort-&gt;CheckingState
op_and_assign
op_complement
id|SK_RLMT_PCS_RX
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* SkRlmtPortReceives */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtPacketReceive - receive a packet for closer examination&n; *&n; * Description:&n; *&t;This routine examines a packet more closely than SkRlmtLookahead*().&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing.&n; */
DECL|function|SkRlmtPacketReceive
id|RLMT_STATIC
r_void
id|SkRlmtPacketReceive
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_MBUF
op_star
id|pMb
)paren
multiline_comment|/* received packet */
(brace
macro_line|#ifdef xDEBUG
r_extern
r_void
id|DumpData
c_func
(paren
r_char
op_star
id|p
comma
r_int
id|size
)paren
suffix:semicolon
macro_line|#endif&t;/* DEBUG */
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
id|SK_U16
id|PacketType
suffix:semicolon
id|SK_U32
id|PortIdx
suffix:semicolon
id|SK_ADDR_PORT
op_star
id|pAPort
suffix:semicolon
id|SK_RLMT_PORT
op_star
id|pRPort
suffix:semicolon
id|SK_RLMT_PACKET
op_star
id|pRPacket
suffix:semicolon
id|SK_SPTREE_PACKET
op_star
id|pSPacket
suffix:semicolon
id|SK_EVPARA
id|Para
suffix:semicolon
id|PortIdx
op_assign
id|pMb-&gt;PortIdx
suffix:semicolon
id|pAPort
op_assign
op_amp
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
suffix:semicolon
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: PortIdx == %d.&bslash;n&quot;
comma
id|PortIdx
)paren
)paren
id|pRPacket
op_assign
(paren
id|SK_RLMT_PACKET
op_star
)paren
id|pMb-&gt;pData
suffix:semicolon
id|pSPacket
op_assign
(paren
id|SK_SPTREE_PACKET
op_star
)paren
id|pRPacket
suffix:semicolon
macro_line|#ifdef xDEBUG
id|DumpData
c_func
(paren
(paren
r_char
op_star
)paren
id|pRPacket
comma
l_int|32
)paren
suffix:semicolon
macro_line|#endif&t;/* DEBUG */
r_if
c_cond
(paren
(paren
id|pRPort-&gt;PacketsPerTimeSlot
op_minus
id|pRPort-&gt;BpduPacketsPerTimeSlot
)paren
op_ne
l_int|0
)paren
(brace
id|SkRlmtPortReceives
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
)paren
suffix:semicolon
)brace
multiline_comment|/* Check destination address. */
r_if
c_cond
(paren
op_logical_neg
id|SK_ADDR_EQUAL
c_func
(paren
id|pAPort-&gt;CurrentMacAddress.a
comma
id|pRPacket-&gt;DstAddr
)paren
op_logical_and
op_logical_neg
id|SK_ADDR_EQUAL
c_func
(paren
id|SkRlmtMcAddr.a
comma
id|pRPacket-&gt;DstAddr
)paren
op_logical_and
op_logical_neg
id|SK_ADDR_EQUAL
c_func
(paren
id|BridgeMcAddr.a
comma
id|pRPacket-&gt;DstAddr
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Not sent to current MAC or registered MC address&n;&t;&t; * =&gt; Trash it.&n;&t;&t; */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Not for me.&bslash;n&quot;
)paren
)paren
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SK_ADDR_EQUAL
c_func
(paren
id|pAPort-&gt;CurrentMacAddress.a
comma
id|pRPacket-&gt;SrcAddr
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Was sent by same port (may happen during port switching&n;&t;&t; * or in case of duplicate MAC addresses).&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * Check for duplicate address here:&n;&t;&t; * If Packet.Random != My.Random =&gt; DupAddr.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|pRPort-&gt;Random
(braket
id|i
)braket
op_ne
id|pRPacket-&gt;Random
(braket
id|i
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * CAUTION: Do not check for duplicate MAC&n;&t;&t; * address in RLMT Alive Reply packets.&n;&t;&t; */
r_if
c_cond
(paren
id|i
op_ge
l_int|0
op_logical_and
id|pRPacket-&gt;DSap
op_eq
id|SK_RLMT_DSAP
op_logical_and
id|pRPacket-&gt;Ctrl
op_eq
id|SK_RLMT_CTRL
op_logical_and
id|pRPacket-&gt;SSap
op_eq
id|SK_RLMT_SSAP
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|0
)braket
op_eq
id|SK_RLMT_INDICATOR0
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|1
)braket
op_eq
id|SK_RLMT_INDICATOR1
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|2
)braket
op_eq
id|SK_RLMT_INDICATOR2
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|3
)braket
op_eq
id|SK_RLMT_INDICATOR3
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|4
)braket
op_eq
id|SK_RLMT_INDICATOR4
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|5
)braket
op_eq
id|SK_RLMT_INDICATOR5
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|6
)braket
op_eq
id|SK_RLMT_INDICATOR6
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Duplicate MAC Address.&bslash;n&quot;
)paren
)paren
multiline_comment|/* Error Log entry. */
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_COMM
comma
id|SKERR_RLMT_E006
comma
id|SKERR_RLMT_E006_MSG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Simply trash it. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Sent by me.&bslash;n&quot;
)paren
)paren
)brace
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check SuspectTx entries. */
r_if
c_cond
(paren
id|pRPort-&gt;PortsSuspect
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|pRPort-&gt;PortsChecked
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pRPort-&gt;PortCheck
(braket
id|j
)braket
dot
id|SuspectTx
op_logical_and
id|SK_ADDR_EQUAL
c_func
(paren
id|pRPacket-&gt;SrcAddr
comma
id|pRPort-&gt;PortCheck
(braket
id|j
)braket
dot
id|CheckAddr.a
)paren
)paren
(brace
id|pRPort-&gt;PortCheck
(braket
id|j
)braket
dot
id|SuspectTx
op_assign
id|SK_FALSE
suffix:semicolon
id|pRPort-&gt;PortsSuspect
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Determine type of packet. */
r_if
c_cond
(paren
id|pRPacket-&gt;DSap
op_eq
id|SK_RLMT_DSAP
op_logical_and
id|pRPacket-&gt;Ctrl
op_eq
id|SK_RLMT_CTRL
op_logical_and
(paren
id|pRPacket-&gt;SSap
op_amp
op_complement
id|LLC_COMMAND_RESPONSE_BIT
)paren
op_eq
id|SK_RLMT_SSAP
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|0
)braket
op_eq
id|SK_RLMT_INDICATOR0
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|1
)braket
op_eq
id|SK_RLMT_INDICATOR1
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|2
)braket
op_eq
id|SK_RLMT_INDICATOR2
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|3
)braket
op_eq
id|SK_RLMT_INDICATOR3
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|4
)braket
op_eq
id|SK_RLMT_INDICATOR4
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|5
)braket
op_eq
id|SK_RLMT_INDICATOR5
op_logical_and
id|pRPacket-&gt;Indicator
(braket
l_int|6
)braket
op_eq
id|SK_RLMT_INDICATOR6
)paren
(brace
multiline_comment|/* It&squot;s an RLMT packet. */
id|PacketType
op_assign
(paren
id|SK_U16
)paren
(paren
(paren
id|pRPacket-&gt;RlmtPacketType
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|pRPacket-&gt;RlmtPacketType
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|PacketType
)paren
(brace
r_case
id|SK_PACKET_ANNOUNCE
suffix:colon
multiline_comment|/* Not yet used. */
macro_line|#if 0
multiline_comment|/* Build the check chain. */
id|SkRlmtBuildCheckChain
c_func
(paren
id|pAC
)paren
suffix:semicolon
macro_line|#endif&t;/* 0 */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Announce.&bslash;n&quot;
)paren
)paren
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PACKET_ALIVE
suffix:colon
r_if
c_cond
(paren
id|pRPacket-&gt;SSap
op_amp
id|LLC_COMMAND_RESPONSE_BIT
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Alive Reply.&bslash;n&quot;
)paren
)paren
multiline_comment|/* Alive Reply Packet. */
macro_line|#if 0
id|pRPort-&gt;RlmtAcksPerTimeSlot
op_increment
suffix:semicolon
macro_line|#endif&t;/* 0 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|PromMode
op_amp
id|SK_PROM_MODE_LLC
)paren
op_logical_or
id|SK_ADDR_EQUAL
c_func
(paren
id|pRPacket-&gt;DstAddr
comma
id|pAPort-&gt;CurrentMacAddress.a
)paren
)paren
(brace
multiline_comment|/* Obviously we could send something. */
r_if
c_cond
(paren
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_TX
)paren
(brace
id|pRPort-&gt;CheckingState
op_and_assign
op_complement
id|SK_RLMT_PCS_TX
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownTxTimer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pRPort-&gt;PortState
op_eq
id|SK_RLMT_PS_DOWN
)paren
op_logical_and
op_logical_neg
(paren
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
)paren
(brace
id|pRPort-&gt;PortState
op_assign
id|SK_RLMT_PS_GOING_UP
suffix:semicolon
id|pRPort-&gt;GuTimeStamp
op_assign
id|SkOsGetTime
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownTxTimer
)paren
suffix:semicolon
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|PortIdx
suffix:semicolon
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;UpTimer
comma
id|SK_RLMT_PORTUP_TIM_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PORTUP_TIM
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Mark sending port as alive? */
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Alive Request Packet. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Alive Request.&bslash;n&quot;
)paren
)paren
id|pRPort-&gt;RxHelloCts
op_increment
suffix:semicolon
macro_line|#if 0
id|pRPort-&gt;RlmtChksPerTimeSlot
op_increment
suffix:semicolon
macro_line|#endif&t;/* 0 */
multiline_comment|/* Answer. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAC_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pRPacket-&gt;DstAddr
(braket
id|i
)braket
op_assign
id|pRPacket-&gt;SrcAddr
(braket
id|i
)braket
suffix:semicolon
id|pRPacket-&gt;SrcAddr
(braket
id|i
)braket
op_assign
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|CurrentMacAddress.a
(braket
id|i
)braket
suffix:semicolon
)brace
id|pRPacket-&gt;SSap
op_or_assign
id|LLC_COMMAND_RESPONSE_BIT
suffix:semicolon
id|Para.pParaPtr
op_assign
id|pMb
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SK_PACKET_CHECK_TX
suffix:colon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Check your tx line.&bslash;n&quot;
)paren
)paren
multiline_comment|/*&n;&t;&t;&t; * A port checking us requests us to check our tx line.&n;&t;&t;&t; */
id|pRPort-&gt;CheckingState
op_or_assign
id|SK_RLMT_PCS_TX
suffix:semicolon
multiline_comment|/* Start PortDownTx timer. */
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|PortIdx
suffix:semicolon
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownTxTimer
comma
id|SK_RLMT_PORTDOWN_TIM_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PORTDOWN_TX_TIM
comma
id|Para
)paren
suffix:semicolon
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
comma
id|SK_PACKET_ALIVE
comma
op_amp
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|CurrentMacAddress
comma
op_amp
id|SkRlmtMcAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SK_PACKET_ADDR_CHANGED
suffix:colon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Address Change.&bslash;n&quot;
)paren
)paren
multiline_comment|/* Build the check chain. */
id|SkRlmtBuildCheckChain
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Unknown RLMT packet.&bslash;n&quot;
)paren
)paren
multiline_comment|/* RA;:;: ??? */
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|pSPacket-&gt;DSap
op_eq
id|SK_RLMT_SPT_DSAP
op_logical_and
id|pSPacket-&gt;Ctrl
op_eq
id|SK_RLMT_SPT_CTRL
op_logical_and
(paren
id|pSPacket-&gt;SSap
op_amp
op_complement
id|LLC_COMMAND_RESPONSE_BIT
)paren
op_eq
id|SK_RLMT_SPT_SSAP
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: BPDU Packet.&bslash;n&quot;
)paren
)paren
multiline_comment|/* Spanning Tree packet. */
id|pRPort-&gt;RxSpHelloCts
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SK_ADDR_EQUAL
c_func
(paren
op_amp
id|pSPacket-&gt;RootId
(braket
l_int|2
)braket
comma
op_amp
id|pAC-&gt;Addr.CurrentMacAddress.a
(braket
l_int|0
)braket
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Check segmentation if a new root bridge is set and&n;&t;&t;&t; * the segmentation check is not currently running.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|SK_ADDR_EQUAL
c_func
(paren
op_amp
id|pSPacket-&gt;RootId
(braket
l_int|2
)braket
comma
op_amp
id|pRPort-&gt;Root.Id
(braket
l_int|2
)braket
)paren
op_logical_and
(paren
id|pAC-&gt;Rlmt.LinksUp
OG
l_int|1
)paren
op_logical_and
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
op_logical_and
op_logical_neg
(paren
id|pAC-&gt;Rlmt.CheckingState
op_amp
id|SK_RLMT_RCS_SEG
)paren
)paren
(brace
id|pAC-&gt;Rlmt.CheckingState
op_or_assign
id|SK_RLMT_RCS_START_SEG
op_or
id|SK_RLMT_RCS_SEND_SEG
suffix:semicolon
)brace
multiline_comment|/* Store tree view of this port. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pRPort-&gt;Root.Id
(braket
id|i
)braket
op_assign
id|pSPacket-&gt;RootId
(braket
id|i
)braket
suffix:semicolon
)brace
id|pRPort-&gt;RootIdSet
op_assign
id|SK_TRUE
suffix:semicolon
)brace
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.CheckingState
op_amp
id|SK_RLMT_RCS_REPORT_SEG
)paren
(brace
id|SkRlmtCheckSeg
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_RX
comma
(paren
l_string|&quot;SkRlmtPacketReceive: Unknown Packet Type.&bslash;n&quot;
)paren
)paren
multiline_comment|/* Unknown packet. */
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SkRlmtPacketReceive */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtCheckPort - check if a port works&n; *&n; * Description:&n; *&t;This routine checks if a port whose link is up received something&n; *&t;and if it seems to transmit successfully.&n; *&n; *&t;# PortState: PsInit, PsLinkDown, PsDown, PsGoingUp, PsUp&n; *&t;# PortCheckingState (Bitfield): ChkTx, ChkRx, ChkSeg&n; *&t;# RlmtCheckingState (Bitfield): ChkSeg, StartChkSeg, ReportSeg&n; *&n; *&t;if (Rx - RxBpdu == 0) {&t;# No rx.&n; *&t;&t;if (state == PsUp) {&n; *&t;&t;&t;PortCheckingState |= ChkRx&n; *&t;&t;}&n; *&t;&t;if (ModeCheckSeg &amp;&amp; (Timeout ==&n; *&t;&t;&t;TO_SHORTEN(RLMT_DEFAULT_TIMEOUT))) {&n; *&t;&t;&t;RlmtCheckingState |= ChkSeg)&n; *&t;&t;&t;PortCheckingState |= ChkSeg&n; *&t;&t;}&n; *&t;&t;NewTimeout = TO_SHORTEN(Timeout)&n; *&t;&t;if (NewTimeout &lt; RLMT_MIN_TIMEOUT) {&n; *&t;&t;&t;NewTimeout = RLMT_MIN_TIMEOUT&n; *&t;&t;&t;PortState = PsDown&n; *&t;&t;&t;...&n; *&t;&t;}&n; *&t;}&n; *&t;else {&t;# something was received&n; *&t;&t;# Set counter to 0 at LinkDown?&n; *&t;&t;#   No - rx may be reported after LinkDown ???&n; *&t;&t;PortCheckingState &amp;= ~ChkRx&n; *&t;&t;NewTimeout = RLMT_DEFAULT_TIMEOUT&n; *&t;&t;if (RxAck == 0) {&n; *&t;&t;&t;possible reasons:&n; *&t;&t;&t;is my tx line bad? --&n; *&t;&t;&t;&t;send RLMT multicast and report&n; *&t;&t;&t;&t;back internally? (only possible&n; *&t;&t;&t;&t;between ports on same adapter)&n; *&t;&t;}&n; *&t;&t;if (RxChk == 0) {&n; *&t;&t;&t;possible reasons:&n; *&t;&t;&t;- tx line of port set to check me&n; *&t;&t;&t;  maybe bad&n; *&t;&t;&t;- no other port/adapter available or set&n; *&t;&t;&t;  to check me&n; *&t;&t;&t;- adapter checking me has a longer&n; *&t;&t;&t;  timeout&n; *&t;&t;&t;??? anything that can be done here?&n; *&t;&t;}&n; *&t;}&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;New timeout value.&n; */
DECL|function|SkRlmtCheckPort
id|RLMT_STATIC
id|SK_U32
id|SkRlmtCheckPort
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|PortIdx
)paren
multiline_comment|/* port to check */
(brace
r_int
id|i
suffix:semicolon
id|SK_U32
id|NewTimeout
suffix:semicolon
id|SK_RLMT_PORT
op_star
id|pRPort
suffix:semicolon
id|SK_EVPARA
id|Para
suffix:semicolon
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pRPort-&gt;PacketsPerTimeSlot
op_minus
id|pRPort-&gt;BpduPacketsPerTimeSlot
)paren
op_eq
l_int|0
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SkRlmtCheckPort %d: No (%d) receives in last time slot.&bslash;n&quot;
comma
id|PortIdx
comma
id|pRPort-&gt;PacketsPerTimeSlot
)paren
)paren
multiline_comment|/*&n;&t;&t; * Check segmentation if there was no receive at least twice&n;&t;&t; * in a row (PortNoRx is already set) and the segmentation&n;&t;&t; * check is not currently running.&n;&t;&t; */
r_if
c_cond
(paren
id|pRPort-&gt;PortNoRx
op_logical_and
(paren
id|pAC-&gt;Rlmt.LinksUp
OG
l_int|1
)paren
op_logical_and
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
op_logical_and
op_logical_neg
(paren
id|pAC-&gt;Rlmt.CheckingState
op_amp
id|SK_RLMT_RCS_SEG
)paren
)paren
(brace
id|pAC-&gt;Rlmt.CheckingState
op_or_assign
id|SK_RLMT_RCS_START_SEG
op_or
id|SK_RLMT_RCS_SEND_SEG
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SkRlmtCheckPort: PortsSuspect %d, PcsRx %d.&bslash;n&quot;
comma
id|pRPort-&gt;PortsSuspect
comma
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
)paren
r_if
c_cond
(paren
id|pRPort-&gt;PortState
op_ne
id|SK_RLMT_PS_DOWN
)paren
(brace
id|NewTimeout
op_assign
id|TO_SHORTEN
c_func
(paren
id|pAC-&gt;Rlmt.TimeoutValue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewTimeout
OL
id|SK_RLMT_MIN_TO_VAL
)paren
(brace
id|NewTimeout
op_assign
id|SK_RLMT_MIN_TO_VAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
)paren
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|PortIdx
suffix:semicolon
id|pRPort-&gt;CheckingState
op_or_assign
id|SK_RLMT_PCS_RX
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * What shall we do if the port checked&n;&t;&t;&t;&t; * by this one receives our request&n;&t;&t;&t;&t; * frames?  What&squot;s bad - our rx line&n;&t;&t;&t;&t; * or his tx line?&n;&t;&t;&t;&t; */
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownRxTimer
comma
id|SK_RLMT_PORTDOWN_TIM_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PORTDOWN_RX_TIM
comma
id|Para
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pRPort-&gt;PortsChecked
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pRPort-&gt;PortCheck
(braket
id|i
)braket
dot
id|SuspectTx
)paren
(brace
r_continue
suffix:semicolon
)brace
id|pRPort-&gt;PortCheck
(braket
id|i
)braket
dot
id|SuspectTx
op_assign
id|SK_TRUE
suffix:semicolon
id|pRPort-&gt;PortsSuspect
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
comma
id|SK_PACKET_CHECK_TX
comma
op_amp
id|pAC-&gt;Addr.Port
(braket
id|PortIdx
)braket
dot
id|CurrentMacAddress
comma
op_amp
id|pRPort-&gt;PortCheck
(braket
id|i
)braket
dot
id|CheckAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* PortDown -- or all partners suspect. */
id|NewTimeout
op_assign
id|SK_RLMT_DEF_TO_VAL
suffix:semicolon
)brace
id|pRPort-&gt;PortNoRx
op_assign
id|SK_TRUE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* A non-BPDU packet was received. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SkRlmtCheckPort %d: %d (%d) receives in last time slot.&bslash;n&quot;
comma
id|PortIdx
comma
id|pRPort-&gt;PacketsPerTimeSlot
op_minus
id|pRPort-&gt;BpduPacketsPerTimeSlot
comma
id|pRPort-&gt;PacketsPerTimeSlot
)paren
)paren
id|SkRlmtPortReceives
c_func
(paren
id|pAC
comma
id|IoC
comma
id|PortIdx
)paren
suffix:semicolon
id|NewTimeout
op_assign
id|SK_RLMT_DEF_TO_VAL
suffix:semicolon
)brace
r_return
(paren
id|NewTimeout
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtCheckPort */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtSelectBcRx - select new active port, criteria 1 (CLP)&n; *&n; * Description:&n; *&t;This routine selects the port that received a broadcast frame&n; *&t;substantially later than all other ports.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;SK_BOOL&n; */
DECL|function|SkRlmtSelectBcRx
id|RLMT_STATIC
id|SK_BOOL
id|SkRlmtSelectBcRx
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|A
comma
multiline_comment|/* active port */
id|SK_U32
id|P
comma
multiline_comment|/* preferred port */
id|SK_U32
op_star
id|N
)paren
multiline_comment|/* new active port */
(brace
id|SK_U64
id|BcTimeStamp
suffix:semicolon
id|SK_U32
id|i
suffix:semicolon
id|SK_BOOL
id|PortFound
suffix:semicolon
id|BcTimeStamp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Not totally necessary, but feeling better. */
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
multiline_comment|/* Select port with the latest TimeStamp. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;TimeStamp Port %d: %.08x%.08x.&bslash;n&quot;
comma
id|i
comma
op_star
(paren
(paren
id|SK_U32
op_star
)paren
(paren
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|BcTimeStamp
)paren
op_plus
id|OFFS_HI32
)paren
comma
op_star
(paren
(paren
id|SK_U32
op_star
)paren
(paren
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|BcTimeStamp
)paren
op_plus
id|OFFS_LO32
)paren
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortDown
op_logical_and
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortNoRx
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
op_logical_or
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|BcTimeStamp
OG
id|BcTimeStamp
)paren
(brace
id|BcTimeStamp
op_assign
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|BcTimeStamp
suffix:semicolon
op_star
id|N
op_assign
id|i
suffix:semicolon
id|PortFound
op_assign
id|SK_TRUE
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|PortFound
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Port %d received the last broadcast.&bslash;n&quot;
comma
op_star
id|N
)paren
)paren
multiline_comment|/* Look if another port&squot;s time stamp is similar. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
op_star
id|N
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortDown
op_logical_and
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortNoRx
op_logical_and
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|BcTimeStamp
OG
id|BcTimeStamp
op_minus
id|SK_RLMT_BC_DELTA
op_logical_or
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|BcTimeStamp
op_plus
id|SK_RLMT_BC_DELTA
OG
id|BcTimeStamp
)paren
)paren
(brace
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Port %d received a broadcast %s.&bslash;n&quot;
comma
id|i
comma
l_string|&quot;at a similar time&quot;
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|PortFound
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_CHECK_SWITCH found Port %d receiving %s.&bslash;n&quot;
comma
op_star
id|N
comma
l_string|&quot;the substantially latest broadcast&quot;
)paren
)paren
)brace
macro_line|#endif&t;/* DEBUG */
r_return
(paren
id|PortFound
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtSelectBcRx */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtSelectNotSuspect - select new active port, criteria 2 (CLP)&n; *&n; * Description:&n; *&t;This routine selects a good port (it is PortUp &amp;&amp; !SuspectRx).&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;SK_BOOL&n; */
DECL|function|SkRlmtSelectNotSuspect
id|RLMT_STATIC
id|SK_BOOL
id|SkRlmtSelectNotSuspect
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|A
comma
multiline_comment|/* active port */
id|SK_U32
id|P
comma
multiline_comment|/* preferred port */
id|SK_U32
op_star
id|N
)paren
multiline_comment|/* new active port */
(brace
id|SK_U32
id|i
suffix:semicolon
id|SK_BOOL
id|PortFound
suffix:semicolon
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
multiline_comment|/* Select first port that is PortUp &amp;&amp; !SuspectRx. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortDown
op_logical_and
op_logical_neg
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
)paren
(brace
op_star
id|N
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|A
)braket
dot
id|PortDown
op_logical_and
op_logical_neg
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|A
)braket
dot
id|CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
)paren
(brace
op_star
id|N
op_assign
id|A
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|P
)braket
dot
id|PortDown
op_logical_and
op_logical_neg
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|P
)braket
dot
id|CheckingState
op_amp
id|SK_RLMT_PCS_RX
)paren
)paren
(brace
op_star
id|N
op_assign
id|P
suffix:semicolon
)brace
id|PortFound
op_assign
id|SK_TRUE
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_CHECK_SWITCH found Port %d up and not check RX.&bslash;n&quot;
comma
op_star
id|N
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|PortFound
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtSelectNotSuspect */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtSelectUp - select new active port, criteria 3, 4 (CLP)&n; *&n; * Description:&n; *&t;This routine selects a port that is up.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;SK_BOOL&n; */
DECL|function|SkRlmtSelectUp
id|RLMT_STATIC
id|SK_BOOL
id|SkRlmtSelectUp
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|A
comma
multiline_comment|/* active port */
id|SK_U32
id|P
comma
multiline_comment|/* preferred port */
id|SK_U32
op_star
id|N
comma
multiline_comment|/* new active port */
id|SK_BOOL
id|AutoNegDone
)paren
multiline_comment|/* successfully auto-negotiated? */
(brace
id|SK_U32
id|i
suffix:semicolon
id|SK_BOOL
id|PortFound
suffix:semicolon
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
multiline_comment|/* Select first port that is PortUp. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_UP
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
op_star
id|N
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|A
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_UP
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|A
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
op_star
id|N
op_assign
id|A
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|P
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_UP
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|P
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
op_star
id|N
op_assign
id|P
suffix:semicolon
)brace
id|PortFound
op_assign
id|SK_TRUE
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_CHECK_SWITCH found Port %d up.&bslash;n&quot;
comma
op_star
id|N
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|PortFound
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtSelectUp */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtSelectGoingUp - select new active port, criteria 5, 6 (CLP)&n; *&n; * Description:&n; *&t;This routine selects the port that is going up for the longest time.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;SK_BOOL&n; */
DECL|function|SkRlmtSelectGoingUp
id|RLMT_STATIC
id|SK_BOOL
id|SkRlmtSelectGoingUp
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|A
comma
multiline_comment|/* active port */
id|SK_U32
id|P
comma
multiline_comment|/* preferred port */
id|SK_U32
op_star
id|N
comma
multiline_comment|/* new active port */
id|SK_BOOL
id|AutoNegDone
)paren
multiline_comment|/* successfully auto-negotiated? */
(brace
id|SK_U64
id|GuTimeStamp
op_assign
l_int|0
suffix:semicolon
id|SK_U32
id|i
suffix:semicolon
id|SK_BOOL
id|PortFound
suffix:semicolon
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
multiline_comment|/* Select port that is PortGoingUp for the longest time. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_GOING_UP
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
id|GuTimeStamp
op_assign
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|GuTimeStamp
suffix:semicolon
op_star
id|N
op_assign
id|i
suffix:semicolon
id|PortFound
op_assign
id|SK_TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
r_return
(paren
id|SK_FALSE
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
op_star
id|N
op_plus
l_int|1
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_GOING_UP
op_logical_and
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|GuTimeStamp
OL
id|GuTimeStamp
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
id|GuTimeStamp
op_assign
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|GuTimeStamp
suffix:semicolon
op_star
id|N
op_assign
id|i
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_CHECK_SWITCH found Port %d going up.&bslash;n&quot;
comma
op_star
id|N
)paren
)paren
r_return
(paren
id|SK_TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtSelectGoingUp */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtSelectDown - select new active port, criteria 7, 8 (CLP)&n; *&n; * Description:&n; *&t;This routine selects a port that is down.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;SK_BOOL&n; */
DECL|function|SkRlmtSelectDown
id|RLMT_STATIC
id|SK_BOOL
id|SkRlmtSelectDown
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|A
comma
multiline_comment|/* active port */
id|SK_U32
id|P
comma
multiline_comment|/* preferred port */
id|SK_U32
op_star
id|N
comma
multiline_comment|/* new active port */
id|SK_BOOL
id|AutoNegDone
)paren
multiline_comment|/* successfully auto-negotiated? */
(brace
id|SK_U32
id|i
suffix:semicolon
id|SK_BOOL
id|PortFound
suffix:semicolon
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
multiline_comment|/* Select first port that is PortDown. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_DOWN
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
op_star
id|N
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|A
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_DOWN
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|A
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
op_star
id|N
op_assign
id|A
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|P
)braket
dot
id|PortState
op_eq
id|SK_RLMT_PS_DOWN
op_logical_and
id|pAC-&gt;GIni.GP
(braket
id|P
)braket
dot
id|PAutoNegFail
op_ne
id|AutoNegDone
)paren
(brace
op_star
id|N
op_assign
id|P
suffix:semicolon
)brace
id|PortFound
op_assign
id|SK_TRUE
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_CHECK_SWITCH found Port %d down.&bslash;n&quot;
comma
op_star
id|N
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|PortFound
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtSelectDown */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtCheckSwitch - select new active port and switch to it&n; *&n; * Description:&n; *&t;This routine decides which port should be the active one and queues&n; *&t;port switching if necessary.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing.&n; */
DECL|function|SkRlmtCheckSwitch
id|RLMT_STATIC
r_void
id|SkRlmtCheckSwitch
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
)paren
multiline_comment|/* I/O context */
(brace
id|SK_EVPARA
id|Para
suffix:semicolon
id|SK_U32
id|A
suffix:semicolon
id|SK_U32
id|P
suffix:semicolon
id|SK_U32
id|i
suffix:semicolon
id|SK_BOOL
id|PortFound
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtState
op_eq
id|SK_RLMT_RS_INIT
)paren
(brace
r_return
suffix:semicolon
)brace
id|A
op_assign
id|pAC-&gt;Rlmt.MacActive
suffix:semicolon
multiline_comment|/* Index of active port. */
id|P
op_assign
id|pAC-&gt;Rlmt.PrefPort
suffix:semicolon
multiline_comment|/* Index of preferred port. */
id|PortFound
op_assign
id|SK_FALSE
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.LinksUp
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Last link went down - shut down the net.&n;&t;&t; */
id|pAC-&gt;Rlmt.RlmtState
op_assign
id|SK_RLMT_RS_NET_DOWN
suffix:semicolon
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_NET_DOWN_TEMP
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_NET_DOWN
comma
id|Para
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.LinksUp
op_eq
l_int|1
op_logical_and
id|pAC-&gt;Rlmt.RlmtState
op_eq
id|SK_RLMT_RS_NET_DOWN
)paren
(brace
multiline_comment|/* First link came up - get the net up. */
id|pAC-&gt;Rlmt.RlmtState
op_assign
id|SK_RLMT_RS_NET_UP
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If pAC-&gt;Rlmt.MacActive != Para.Para32[0],&n;&t;&t; * the DRV switches to the port that came up.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|LinkDown
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|A
)braket
dot
id|LinkDown
)paren
(brace
id|i
op_assign
id|A
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|P
)braket
dot
id|LinkDown
)paren
(brace
id|i
op_assign
id|P
suffix:semicolon
)brace
id|PortFound
op_assign
id|SK_TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|PortFound
)paren
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|pAC-&gt;Rlmt.MacActive
suffix:semicolon
id|Para.Para32
(braket
l_int|1
)braket
op_assign
id|i
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_PNMI
comma
id|SK_PNMI_EVT_RLMT_PORT_SWITCH
comma
id|Para
)paren
suffix:semicolon
id|pAC-&gt;Rlmt.MacActive
op_assign
id|i
suffix:semicolon
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|i
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_NET_UP
comma
id|Para
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
id|SK_PACKET_ANNOUNCE
comma
op_amp
id|pAC-&gt;Addr.CurrentMacAddress
comma
op_amp
id|SkRlmtMcAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Send packet to RLMT multicast address&n;&t;&t;&t;&t; * to force switches to learn the new&n;&t;&t;&t;&t; * location of the address.&n;&t;&t;&t;&t; */
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E007
comma
id|SKERR_RLMT_E007_MSG
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|A
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Preselection:&n;&t;&t; *   If RLMT Mode != CheckLinkState&n;&t;&t; *     select port that received a broadcast frame&n;&t;&t; *     substantially later than all other ports&n;&t;&t; *   else select first port that is not SuspectRx&n;&t;&t; *   else select first port that is PortUp&n;&t;&t; *   else select port that is PortGoingUp for the longest time&n;&t;&t; *   else select first port that is PortDown&n;&t;&t; *   else stop.&n;&t;&t; *&n;&t;&t; * For the preselected port:&n;&t;&t; *   If ActivePort is equal in quality, select ActivePort.&n;&t;&t; *&n;&t;&t; *   If PrefPort is equal in quality, select PrefPort.&n;&t;&t; *&n;&t;&t; *   If MacActive != SelectedPort,&n;&t;&t; *     If old ActivePort is LinkDown,&n;&t;&t; *       SwitchHard&n;&t;&t; *     else&n;&t;&t; *       SwitchSoft&n;&t;&t; */
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_ne
id|SK_RLMT_CHECK_LINK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectBcRx
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectNotSuspect
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectUp
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
comma
id|AUTONEG_SUCCESS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectUp
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
comma
id|AUTONEG_FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectGoingUp
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
comma
id|AUTONEG_SUCCESS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectGoingUp
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
comma
id|AUTONEG_FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_ne
id|SK_RLMT_CHECK_LINK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectDown
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
comma
id|AUTONEG_SUCCESS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortFound
)paren
(brace
id|PortFound
op_assign
id|SkRlmtSelectDown
c_func
(paren
id|pAC
comma
id|IoC
comma
id|A
comma
id|P
comma
op_amp
id|Para.Para32
(braket
l_int|1
)braket
comma
id|AUTONEG_FAILED
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|PortFound
)paren
(brace
r_if
c_cond
(paren
id|Para.Para32
(braket
l_int|1
)braket
op_ne
id|A
)paren
(brace
id|pAC-&gt;Rlmt.MacActive
op_assign
id|Para.Para32
(braket
l_int|1
)braket
suffix:semicolon
id|SK_HWAC_LINK_LED
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|1
)braket
comma
id|SK_LED_ACTIVE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|A
)braket
dot
id|LinkDown
)paren
(brace
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_SWITCH_HARD
comma
id|Para
)paren
suffix:semicolon
)brace
r_else
(brace
id|SK_HWAC_LINK_LED
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|SK_LED_STANDBY
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_SWITCH_SOFT
comma
id|Para
)paren
suffix:semicolon
)brace
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_PNMI
comma
id|SK_PNMI_EVT_RLMT_PORT_SWITCH
comma
id|Para
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Para.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|1
)braket
comma
id|SK_PACKET_ANNOUNCE
comma
op_amp
id|pAC-&gt;Addr.CurrentMacAddress
comma
op_amp
id|SkRlmtMcAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Send &quot;new&quot; packet to RLMT multicast&n;&t;&t;&t;&t;&t; * address to force switches to learn&n;&t;&t;&t;&t;&t; * the new location of the MAC address.&n;&t;&t;&t;&t;&t; */
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E004
comma
id|SKERR_RLMT_E004_MSG
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SkRlmtCheckSwitch */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtCheckSeg - Report if segmentation is detected&n; *&n; * Description:&n; *&t;This routine checks if the ports see different root bridges and reports&n; *&t;segmentation in such a case.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing.&n; */
DECL|function|SkRlmtCheckSeg
id|RLMT_STATIC
r_void
id|SkRlmtCheckSeg
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
)paren
multiline_comment|/* I/O context */
(brace
id|SK_BOOL
id|Equal
suffix:semicolon
id|SK_U32
id|i
comma
id|j
suffix:semicolon
id|pAC-&gt;Rlmt.RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|Equal
op_assign
id|SK_TRUE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|LinkDown
op_logical_or
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|RootIdSet
)paren
(brace
r_continue
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Root ID %d: %02x %02x %02x %02x %02x %02x %02x %02x.&bslash;n&quot;
comma
id|i
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|0
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|1
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|2
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|3
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|4
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|5
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|6
)braket
comma
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
l_int|7
)braket
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.RootIdSet
)paren
(brace
id|pAC-&gt;Rlmt.Root
op_assign
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root
suffix:semicolon
id|pAC-&gt;Rlmt.RootIdSet
op_assign
id|SK_TRUE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Equal
op_and_assign
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|Root.Id
(braket
id|j
)braket
op_eq
id|pAC-&gt;Rlmt.Root.Id
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Equal
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|Equal
)paren
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_COMM
comma
id|SKERR_RLMT_E005
comma
id|SKERR_RLMT_E005_MSG
)paren
suffix:semicolon
macro_line|#ifdef SK_PNMI_EVT_SEGMENTATION
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_PNMI
comma
id|SK_PNMI_EVT_SEGMENTATION
comma
id|Para
)paren
suffix:semicolon
macro_line|#endif&t;/* SK_PNMI_EVT_SEGMENTATION */
id|pAC-&gt;Rlmt.CheckingState
op_and_assign
op_complement
id|SK_RLMT_RCS_REPORT_SEG
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* SkRlmtCheckSeg */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtPortStart - initialize port variables and start port&n; *&n; * Description:&n; *&t;This routine initializes a port&squot;s variables and issues a PORT_START&n; *&t;to the HWAC module.  This handles retries if the start fails or the&n; *&t;link eventually goes down.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&n; * Returns:&n; *&t;Nothing&n; */
DECL|function|SkRlmtPortStart
id|RLMT_STATIC
r_void
id|SkRlmtPortStart
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|PortIdx
)paren
multiline_comment|/* event code */
(brace
id|SK_EVPARA
id|Para
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|PortState
op_assign
id|SK_RLMT_PS_LINK_DOWN
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|PortStarted
op_assign
id|SK_TRUE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|LinkDown
op_assign
id|SK_TRUE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|PortDown
op_assign
id|SK_TRUE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|CheckingState
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|PortIdx
)braket
dot
id|RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|PortIdx
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_HWAC
comma
id|SK_HWEV_PORT_START
comma
id|Para
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtPortStart */
multiline_comment|/******************************************************************************&n; *&n; *&t;SkRlmtEvent - a PORT- or an RLMT-specific event happened&n; *&n; * Description:&n; *&t;This routine handles PORT- and RLMT-specific events.&n; *&n; * Context:&n; *&t;runtime, pageable?&n; *&t;may be called after SK_INIT_IO&n; *&n; * Returns:&n; *&t;0&n; */
DECL|function|SkRlmtEvent
r_int
id|SkRlmtEvent
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* I/O context */
id|SK_U32
id|Event
comma
multiline_comment|/* event code */
id|SK_EVPARA
id|Para
)paren
multiline_comment|/* event-specific parameter */
(brace
id|SK_U32
id|i
comma
id|j
suffix:semicolon
id|SK_RLMT_PORT
op_star
id|pRPort
suffix:semicolon
id|SK_EVPARA
id|Para2
suffix:semicolon
id|SK_MBUF
op_star
id|pMb
suffix:semicolon
id|SK_MBUF
op_star
id|pNextMb
suffix:semicolon
id|SK_MAC_ADDR
op_star
id|pOldMacAddr
suffix:semicolon
id|SK_MAC_ADDR
op_star
id|pNewMacAddr
suffix:semicolon
id|SK_U32
id|Timeout
suffix:semicolon
id|SK_U32
id|NewTimeout
suffix:semicolon
id|SK_U32
id|PrevRlmtMode
suffix:semicolon
r_switch
c_cond
(paren
id|Event
)paren
(brace
r_case
id|SK_RLMT_PORTSTART_TIM
suffix:colon
multiline_comment|/* From RLMT via TIME. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTSTART_TIMEOUT Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
multiline_comment|/*&n;&t;&t; * Used to start non-preferred ports if the preferred one&n;&t;&t; * does not come up.&n;&t;&t; * This timeout needs only be set when starting the first&n;&t;&t; * (preferred) port.&n;&t;&t; */
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|LinkDown
)paren
(brace
multiline_comment|/* PORT_START failed. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortStarted
)paren
(brace
id|SkRlmtPortStart
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTSTART_TIMEOUT Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_LINK_UP
suffix:colon
multiline_comment|/* From SIRQ. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_LINK_UP Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pRPort-&gt;PortStarted
)paren
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E008
comma
id|SKERR_RLMT_E008_MSG
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_LINK_UP Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pRPort-&gt;LinkDown
)paren
(brace
multiline_comment|/* RA;:;: Any better solution? */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_LINK_UP Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;UpTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownRxTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownTxTimer
)paren
suffix:semicolon
multiline_comment|/* Do something if timer already fired? */
id|pRPort-&gt;LinkDown
op_assign
id|SK_FALSE
suffix:semicolon
id|pRPort-&gt;PortState
op_assign
id|SK_RLMT_PS_GOING_UP
suffix:semicolon
id|pRPort-&gt;GuTimeStamp
op_assign
id|SkOsGetTime
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|pRPort-&gt;BcTimeStamp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.LinksUp
op_eq
l_int|0
)paren
(brace
id|SK_HWAC_LINK_LED
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|SK_LED_ACTIVE
)paren
suffix:semicolon
)brace
r_else
(brace
id|SK_HWAC_LINK_LED
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|SK_LED_STANDBY
)paren
suffix:semicolon
)brace
id|pAC-&gt;Rlmt.LinksUp
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortStarted
)paren
(brace
id|SkRlmtPortStart
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|SkRlmtCheckSwitch
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.LinksUp
op_ge
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_LOC_LINK
)paren
(brace
multiline_comment|/* Build the check chain. */
id|SkRlmtBuildCheckChain
c_func
(paren
id|pAC
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * If the first link comes up, start the periodical&n;&t;&t; * RLMT timeout.&n;&t;&t; */
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
OG
l_int|1
op_logical_and
id|pAC-&gt;Rlmt.LinksUp
op_eq
l_int|1
op_logical_and
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_OTHERS
)paren
)paren
(brace
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.LocTimer
comma
id|pAC-&gt;Rlmt.TimeoutValue
comma
id|SKGE_RLMT
comma
id|SK_RLMT_TIM
comma
id|Para
)paren
suffix:semicolon
)brace
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;UpTimer
comma
id|SK_RLMT_PORTUP_TIM_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PORTUP_TIM
comma
id|Para
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Later:&n;&t;&t; * if (pAC-&gt;Rlmt.RlmtMode &amp; SK_RLMT_CHECK_LOC_LINK) &amp;&amp;&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_LINK
)paren
op_logical_and
(paren
id|Para2.pParaPtr
op_assign
id|SkRlmtBuildPacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|SK_PACKET_ANNOUNCE
comma
op_amp
id|pAC-&gt;Addr.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|CurrentMacAddress
comma
op_amp
id|SkRlmtMcAddr
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Send &quot;new&quot; packet to RLMT multicast address. */
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
(brace
r_if
c_cond
(paren
(paren
id|Para2.pParaPtr
op_assign
id|SkRlmtBuildSpanningTreePacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|0
)braket
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.CheckingState
op_or_assign
id|SK_RLMT_RCS_SEG
op_or
id|SK_RLMT_RCS_REPORT_SEG
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para2
)paren
suffix:semicolon
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.SegTimer
comma
id|SK_RLMT_SEG_TO_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_SEG_TIM
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_LINK_UP Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_PORTUP_TIM
suffix:colon
multiline_comment|/* From RLMT via TIME. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTUP_TIM Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pRPort-&gt;LinkDown
op_logical_or
(paren
id|pRPort-&gt;PortState
op_eq
id|SK_RLMT_PS_UP
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTUP_TIM Port %d Event (%d) EMPTY.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
id|pRPort-&gt;PortDown
op_assign
id|SK_FALSE
suffix:semicolon
id|pRPort-&gt;PortState
op_assign
id|SK_RLMT_PS_UP
suffix:semicolon
id|pAC-&gt;Rlmt.PortsUp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtState
op_ne
id|SK_RLMT_RS_INIT
)paren
(brace
id|SkRlmtCheckSwitch
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_PNMI
comma
id|SK_PNMI_EVT_RLMT_PORT_UP
comma
id|Para
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTUP_TIM Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_PORTDOWN
suffix:colon
multiline_comment|/* From RLMT. */
r_case
id|SK_RLMT_PORTDOWN_RX_TIM
suffix:colon
multiline_comment|/* From RLMT via TIME. */
r_case
id|SK_RLMT_PORTDOWN_TX_TIM
suffix:colon
multiline_comment|/* From RLMT via TIME. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTDOWN* Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pRPort-&gt;PortStarted
op_logical_or
(paren
id|Event
op_eq
id|SK_RLMT_PORTDOWN_TX_TIM
op_logical_and
op_logical_neg
(paren
id|pRPort-&gt;CheckingState
op_amp
id|SK_RLMT_PCS_TX
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTDOWN* Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Stop port&squot;s timers. */
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;UpTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownRxTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pRPort-&gt;DownTxTimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pRPort-&gt;PortState
op_ne
id|SK_RLMT_PS_LINK_DOWN
)paren
(brace
id|pRPort-&gt;PortState
op_assign
id|SK_RLMT_PS_DOWN
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pRPort-&gt;PortDown
)paren
(brace
id|pAC-&gt;Rlmt.PortsUp
op_decrement
suffix:semicolon
id|pRPort-&gt;PortDown
op_assign
id|SK_TRUE
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_PNMI
comma
id|SK_PNMI_EVT_RLMT_PORT_DOWN
comma
id|Para
)paren
suffix:semicolon
)brace
id|pRPort-&gt;PacketsPerTimeSlot
op_assign
l_int|0
suffix:semicolon
id|pRPort-&gt;DataPacketsPerTimeSlot
op_assign
l_int|0
suffix:semicolon
id|pRPort-&gt;BpduPacketsPerTimeSlot
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|pRPort-&gt;RlmtChksPerTimeSlot
op_assign
l_int|0
suffix:semicolon
id|pRPort-&gt;RlmtAcksPerTimeSlot
op_assign
l_int|0
suffix:semicolon
macro_line|#endif&t;/* 0 */
multiline_comment|/*&n;&t;&t; * RA;:;: To be checked:&n;&t;&t; * - actions at RLMT_STOP: We should not switch anymore.&n;&t;&t; */
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtState
op_ne
id|SK_RLMT_RS_INIT
)paren
(brace
r_if
c_cond
(paren
id|Para.Para32
(braket
l_int|0
)braket
op_eq
id|pAC-&gt;Rlmt.MacActive
)paren
(brace
multiline_comment|/* Active Port went down. */
id|SkRlmtCheckSwitch
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORTDOWN* Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_LINK_DOWN
suffix:colon
multiline_comment|/* From SIRQ. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_LINK_DOWN Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|LinkDown
)paren
(brace
id|pAC-&gt;Rlmt.LinksUp
op_decrement
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|LinkDown
op_assign
id|SK_TRUE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|PortState
op_assign
id|SK_RLMT_PS_LINK_DOWN
suffix:semicolon
id|SK_HWAC_LINK_LED
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|SK_LED_OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_LOC_LINK
)paren
(brace
multiline_comment|/* Build the check chain. */
id|SkRlmtBuildCheckChain
c_func
(paren
id|pAC
)paren
suffix:semicolon
)brace
multiline_comment|/* Ensure that port is marked down. */
(paren
r_void
)paren
id|SkRlmtEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_RLMT_PORTDOWN
comma
id|Para
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_LINK_DOWN Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_PORT_ADDR
suffix:colon
multiline_comment|/* From ADDR. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORT_ADDR Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
multiline_comment|/* Port&squot;s physical MAC address changed. */
id|pOldMacAddr
op_assign
op_amp
id|pAC-&gt;Addr.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|PreviousMacAddress
suffix:semicolon
id|pNewMacAddr
op_assign
op_amp
id|pAC-&gt;Addr.Port
(braket
id|Para.Para32
(braket
l_int|0
)braket
)braket
dot
id|CurrentMacAddress
suffix:semicolon
multiline_comment|/*&n;&t;&t; * NOTE: This is not scalable for solutions where ports are&n;&t;&t; *&t; checked remotely.  There, we need to send an RLMT&n;&t;&t; *&t; address change packet - and how do we ensure delivery?&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|pRPort-&gt;PortsChecked
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SK_ADDR_EQUAL
c_func
(paren
id|pRPort-&gt;PortCheck
(braket
id|j
)braket
dot
id|CheckAddr.a
comma
id|pOldMacAddr-&gt;a
)paren
)paren
(brace
id|pRPort-&gt;PortCheck
(braket
id|j
)braket
dot
id|CheckAddr
op_assign
op_star
id|pNewMacAddr
suffix:semicolon
)brace
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PORT_ADDR Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* ----- RLMT events ----- */
r_case
id|SK_RLMT_START
suffix:colon
multiline_comment|/* From DRV. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_START Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtState
op_ne
id|SK_RLMT_RS_INIT
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_START Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.PrefPort
op_ge
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
)paren
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E009
comma
id|SKERR_RLMT_E009_MSG
)paren
suffix:semicolon
multiline_comment|/* Change PrefPort to internal default. */
id|Para.Para32
(braket
l_int|0
)braket
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
(paren
r_void
)paren
id|SkRlmtEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_RLMT_PREFPORT_CHANGE
comma
id|Para
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
op_eq
l_int|1
op_logical_and
id|pAC-&gt;Rlmt.RlmtMode
op_ne
id|SK_RLMT_CHECK_LINK
)paren
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_CHECK_LINK
suffix:semicolon
(paren
r_void
)paren
id|SkRlmtEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_RLMT_MODE_CHANGE
comma
id|Para
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* 0 */
id|pAC-&gt;Rlmt.LinksUp
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.PortsUp
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.CheckingState
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.RlmtState
op_assign
id|SK_RLMT_RS_NET_DOWN
suffix:semicolon
id|SkRlmtPortStart
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pAC-&gt;Rlmt.PrefPort
)paren
suffix:semicolon
multiline_comment|/* Start Timer (for first port only). */
id|Para2.Para32
(braket
l_int|0
)braket
op_assign
id|pAC-&gt;Rlmt.PrefPort
suffix:semicolon
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|pAC-&gt;Rlmt.PrefPort
)braket
dot
id|UpTimer
comma
id|SK_RLMT_PORTSTART_TIM_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PORTSTART_TIM
comma
id|Para2
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_START Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_STOP
suffix:colon
multiline_comment|/* From DRV. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STOP Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtState
op_eq
id|SK_RLMT_RS_INIT
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STOP Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Stop RLMT timers. */
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.LocTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.SegTimer
)paren
suffix:semicolon
multiline_comment|/* Stop Net. */
id|pAC-&gt;Rlmt.RlmtState
op_assign
id|SK_RLMT_RS_INIT
suffix:semicolon
id|pAC-&gt;Rlmt.RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|Para2.Para32
(braket
l_int|0
)braket
op_assign
id|SK_RLMT_NET_DOWN_FINAL
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_NET_DOWN
comma
id|Para2
)paren
suffix:semicolon
multiline_comment|/* Stop ports. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_ne
id|SK_RLMT_PS_INIT
)paren
(brace
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|UpTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|DownRxTimer
)paren
suffix:semicolon
id|SkTimerStop
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|DownTxTimer
)paren
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortState
op_assign
id|SK_RLMT_PS_INIT
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|PortStarted
op_assign
id|SK_FALSE
suffix:semicolon
id|Para2.Para32
(braket
l_int|0
)braket
op_assign
id|i
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_HWAC
comma
id|SK_HWEV_PORT_STOP
comma
id|Para2
)paren
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STOP Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_TIM
suffix:colon
multiline_comment|/* From RLMT via TIME. */
macro_line|#if 0
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_TIM Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
macro_line|#endif&t;/* 0 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_OTHERS
)paren
op_logical_or
id|pAC-&gt;Rlmt.LinksUp
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Mode changed or all links down:&n;&t;&t;&t; * No more link checking.&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
macro_line|#if 0
id|pAC-&gt;Rlmt.SwitchCheckCounter
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.SwitchCheckCounter
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;Rlmt.SwitchCheckCounter
suffix:semicolon
)brace
macro_line|#endif&t;/* 0 */
id|NewTimeout
op_assign
id|SK_RLMT_DEF_TO_VAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pRPort-&gt;LinkDown
)paren
(brace
id|Timeout
op_assign
id|SkRlmtCheckPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Timeout
OL
id|NewTimeout
)paren
(brace
id|NewTimeout
op_assign
id|Timeout
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * This counter should be set to 0 for all&n;&t;&t;&t;&t; * ports before the first frame is sent in the&n;&t;&t;&t;&t; * next loop.&n;&t;&t;&t;&t; */
id|pRPort-&gt;PacketsPerTimeSlot
op_assign
l_int|0
suffix:semicolon
id|pRPort-&gt;DataPacketsPerTimeSlot
op_assign
l_int|0
suffix:semicolon
id|pRPort-&gt;BpduPacketsPerTimeSlot
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|pRPort-&gt;RlmtChksPerTimeSlot
op_assign
l_int|0
suffix:semicolon
id|pRPort-&gt;RlmtAcksPerTimeSlot
op_assign
l_int|0
suffix:semicolon
macro_line|#endif&t;/* 0 */
)brace
)brace
id|pAC-&gt;Rlmt.TimeoutValue
op_assign
id|NewTimeout
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.LinksUp
OG
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If checking remote ports, also send packets if&n;&t;&t;&t; *   (LinksUp == 1) &amp;&amp;&n;&t;&t;&t; *   this port checks at least one (remote) port.&n;&t;&t;&t; */
multiline_comment|/*&n;&t;&t;&t; * Must be new loop, as SkRlmtCheckPort can request to&n;&t;&t;&t; * check segmentation when e.g. checking the last port.&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pRPort
op_assign
op_amp
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pRPort-&gt;LinkDown
)paren
(brace
multiline_comment|/* !PortDown? */
id|SkRlmtSend
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.LocTimer
comma
id|pAC-&gt;Rlmt.TimeoutValue
comma
id|SKGE_RLMT
comma
id|SK_RLMT_TIM
comma
id|Para
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.LinksUp
OG
l_int|1
op_logical_and
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
op_logical_and
(paren
id|pAC-&gt;Rlmt.CheckingState
op_amp
id|SK_RLMT_RCS_START_SEG
)paren
)paren
(brace
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.SegTimer
comma
id|SK_RLMT_SEG_TO_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_SEG_TIM
comma
id|Para
)paren
suffix:semicolon
id|pAC-&gt;Rlmt.CheckingState
op_and_assign
op_complement
id|SK_RLMT_RCS_START_SEG
suffix:semicolon
id|pAC-&gt;Rlmt.CheckingState
op_or_assign
id|SK_RLMT_RCS_SEG
op_or
id|SK_RLMT_RCS_REPORT_SEG
suffix:semicolon
)brace
macro_line|#if 0
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_TIM Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
macro_line|#endif&t;/* 0 */
r_break
suffix:semicolon
r_case
id|SK_RLMT_SEG_TIM
suffix:colon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_SEG_TIM Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
macro_line|#ifdef DEBUG
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SK_U8
id|InAddr8
(braket
l_int|6
)braket
suffix:semicolon
id|SK_U16
op_star
id|InAddr
suffix:semicolon
id|SK_ADDR_PORT
op_star
id|pAPort
suffix:semicolon
id|InAddr
op_assign
(paren
id|SK_U16
op_star
)paren
op_amp
id|InAddr8
(braket
l_int|0
)braket
suffix:semicolon
id|pAPort
op_assign
op_amp
id|pAC-&gt;Addr.Port
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|pAPort-&gt;NextExactMatchRlmt
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* Get exact match address j from port i. */
id|XM_INADDR
c_func
(paren
id|IoC
comma
id|i
comma
id|XM_EXM
c_func
(paren
id|j
)paren
comma
id|InAddr
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;MC address %d on Port %u: %02x %02x %02x %02x %02x %02x --  %02x %02x %02x %02x %02x %02x.&bslash;n&quot;
comma
id|j
comma
id|i
comma
id|InAddr8
(braket
l_int|0
)braket
comma
id|InAddr8
(braket
l_int|1
)braket
comma
id|InAddr8
(braket
l_int|2
)braket
comma
id|InAddr8
(braket
l_int|3
)braket
comma
id|InAddr8
(braket
l_int|4
)braket
comma
id|InAddr8
(braket
l_int|5
)braket
comma
id|pAPort-&gt;Exact
(braket
id|j
)braket
dot
id|a
(braket
l_int|0
)braket
comma
id|pAPort-&gt;Exact
(braket
id|j
)braket
dot
id|a
(braket
l_int|1
)braket
comma
id|pAPort-&gt;Exact
(braket
id|j
)braket
dot
id|a
(braket
l_int|2
)braket
comma
id|pAPort-&gt;Exact
(braket
id|j
)braket
dot
id|a
(braket
l_int|3
)braket
comma
id|pAPort-&gt;Exact
(braket
id|j
)braket
dot
id|a
(braket
l_int|4
)braket
comma
id|pAPort-&gt;Exact
(braket
id|j
)braket
dot
id|a
(braket
l_int|5
)braket
)paren
)paren
)brace
)brace
macro_line|#endif&t;/* DEBUG */
id|pAC-&gt;Rlmt.CheckingState
op_and_assign
op_complement
id|SK_RLMT_RCS_SEG
suffix:semicolon
id|SkRlmtCheckSeg
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_SEG_TIM Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_PACKET_RECEIVED
suffix:colon
multiline_comment|/* From DRV. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PACKET_RECEIVED Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
multiline_comment|/* Should we ignore frames during port switching? */
macro_line|#ifdef DEBUG
id|pMb
op_assign
id|Para.pParaPtr
suffix:semicolon
r_if
c_cond
(paren
id|pMb
op_eq
l_int|NULL
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;No mbuf.&bslash;n&quot;
)paren
)paren
)brace
r_else
r_if
c_cond
(paren
id|pMb-&gt;pNext
op_ne
l_int|NULL
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;More than one mbuf or pMb-&gt;pNext not set.&bslash;n&quot;
)paren
)paren
)brace
macro_line|#endif&t;/* DEBUG */
r_for
c_loop
(paren
id|pMb
op_assign
id|Para.pParaPtr
suffix:semicolon
id|pMb
op_ne
l_int|NULL
suffix:semicolon
id|pMb
op_assign
id|pNextMb
)paren
(brace
id|pNextMb
op_assign
id|pMb-&gt;pNext
suffix:semicolon
id|pMb-&gt;pNext
op_assign
l_int|NULL
suffix:semicolon
id|SkRlmtPacketReceive
c_func
(paren
id|pAC
comma
id|IoC
comma
id|pMb
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PACKET_RECEIVED Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_STATS_CLEAR
suffix:colon
multiline_comment|/* From PNMI. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STATS_CLEAR Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
multiline_comment|/* Clear statistics for virtual and physical ports. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|TxHelloCts
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|RxHelloCts
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|TxSpHelloReqCts
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|RxSpHelloCts
op_assign
l_int|0
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STATS_CLEAR Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_STATS_UPDATE
suffix:colon
multiline_comment|/* From PNMI. */
macro_line|#if 0
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STATS_UPDATE Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
multiline_comment|/* Update statistics. */
multiline_comment|/* Currently always up-to-date. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_STATS_UPDATE Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
macro_line|#endif&t;/* 0 */
r_break
suffix:semicolon
r_case
id|SK_RLMT_PREFPORT_CHANGE
suffix:colon
multiline_comment|/* From PNMI. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PREFPORT_CHANGE to Port %d Event (%d) BEGIN.&bslash;n&quot;
comma
id|Para.Para32
(braket
l_int|0
)braket
comma
id|Event
)paren
)paren
multiline_comment|/* 0xFFFFFFFF == auto-mode. */
r_if
c_cond
(paren
id|Para.Para32
(braket
l_int|0
)braket
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|pAC-&gt;Rlmt.PrefPort
op_assign
id|SK_RLMT_DEF_PREF_PORT
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|Para.Para32
(braket
l_int|0
)braket
op_ge
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
)paren
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E010
comma
id|SKERR_RLMT_E010_MSG
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PREFPORT_CHANGE Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
id|pAC-&gt;Rlmt.PrefPort
op_assign
id|Para.Para32
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|pAC-&gt;Rlmt.MacPreferred
op_assign
id|Para.Para32
(braket
l_int|0
)braket
suffix:semicolon
id|SkRlmtCheckSwitch
c_func
(paren
id|pAC
comma
id|IoC
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_PREFPORT_CHANGE Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_case
id|SK_RLMT_MODE_CHANGE
suffix:colon
multiline_comment|/* From PNMI. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_MODE_CHANGE Event (%d) BEGIN.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
OL
l_int|2
)paren
(brace
id|pAC-&gt;Rlmt.RlmtMode
op_assign
id|SK_RLMT_CHECK_LINK
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Forced RLMT mode to CLS on single link adapter.&bslash;n&quot;
)paren
)paren
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_MODE_CHANGE Event (%d) EMPTY.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Update RLMT mode. */
id|PrevRlmtMode
op_assign
id|pAC-&gt;Rlmt.RlmtMode
suffix:semicolon
id|pAC-&gt;Rlmt.RlmtMode
op_assign
id|Para.Para32
(braket
l_int|0
)braket
op_or
id|SK_RLMT_CHECK_LINK
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;RLMT: Changed Mode to %X.&bslash;n&quot;
comma
id|pAC-&gt;Rlmt.RlmtMode
)paren
)paren
r_if
c_cond
(paren
(paren
id|PrevRlmtMode
op_amp
id|SK_RLMT_CHECK_LOC_LINK
)paren
op_ne
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_LOC_LINK
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|PrevRlmtMode
op_amp
id|SK_RLMT_CHECK_OTHERS
)paren
op_logical_and
id|pAC-&gt;GIni.GIMacsFound
OG
l_int|1
op_logical_and
id|pAC-&gt;Rlmt.PortsUp
op_eq
l_int|1
)paren
(brace
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.LocTimer
comma
id|pAC-&gt;Rlmt.TimeoutValue
comma
id|SKGE_RLMT
comma
id|SK_RLMT_TIM
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|PrevRlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
op_ne
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SK_U32
)paren
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
r_void
)paren
id|SkAddrMcClear
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
id|SK_ADDR_PERMANENT
op_or
id|SK_MC_SW_ONLY
)paren
suffix:semicolon
multiline_comment|/* Add RLMT MC address. */
(paren
r_void
)paren
id|SkAddrMcAdd
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
op_amp
id|SkRlmtMcAddr
comma
id|SK_ADDR_PERMANENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
(brace
multiline_comment|/* Add BPDU MC address. */
(paren
r_void
)paren
id|SkAddrMcAdd
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
comma
op_amp
id|BridgeMcAddr
comma
id|SK_ADDR_PERMANENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtState
op_ne
id|SK_RLMT_RS_INIT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|LinkDown
op_logical_and
(paren
id|Para2.pParaPtr
op_assign
id|SkRlmtBuildSpanningTreePacket
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pAC-&gt;Rlmt.Port
(braket
id|i
)braket
dot
id|RootIdSet
op_assign
id|SK_FALSE
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_RLMT_SEND
comma
id|Para2
)paren
suffix:semicolon
)brace
)brace
)brace
(paren
r_void
)paren
id|SkAddrMcUpdate
c_func
(paren
id|pAC
comma
id|IoC
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;Rlmt.RlmtMode
op_amp
id|SK_RLMT_CHECK_SEG
)paren
(brace
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;Rlmt.SegTimer
comma
id|SK_RLMT_SEG_TO_VAL
comma
id|SKGE_RLMT
comma
id|SK_RLMT_SEG_TIM
comma
id|Para
)paren
suffix:semicolon
)brace
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;SK_RLMT_MODE_CHANGE Event (%d) END.&bslash;n&quot;
comma
id|Event
)paren
)paren
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Create error log entry. */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_RLMT
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Unknown RLMT Event %d.&bslash;n&quot;
comma
id|Event
)paren
)paren
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_RLMT_E003
comma
id|SKERR_RLMT_E003_MSG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* SkRlmtEvent */
macro_line|#ifdef __cplusplus
)brace
macro_line|#endif&t;/* __cplusplus */
eof
