multiline_comment|/******************************************************************************&n; *&n; * Name:      &t;skge.c&n; * Project:&t;GEnesis, PCI Gigabit Ethernet Adapter&n; * Version:&t;$Revision: 1.29 $&n; * Date:       &t;$Date: 2000/02/21 13:31:56 $&n; * Purpose:&t;The main driver source module&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;Driver for SysKonnect Gigabit Ethernet Server Adapters:&n; *&n; *&t;SK-9841 (single link 1000Base-LX)&n; *&t;SK-9842 (dual link   1000Base-LX)&n; *&t;SK-9843 (single link 1000Base-SX)&n; *&t;SK-9844 (dual link   1000Base-SX)&n; *&t;SK-9821 (single link 1000Base-T)&n; *&t;SK-9822 (dual link   1000Base-T)&n; *&n; *&t;Created 10-Feb-1999, based on Linux&squot; acenic.c, 3c59x.c and &n; *&t;SysKonnects GEnesis Solaris driver&n; *&t;Author: Christoph Goos (cgoos@syskonnect.de)&n; *&n; *&t;Address all question to: linux@syskonnect.de&n; *&n; *&t;The technical manual for the adapters is available from SysKonnect&squot;s&n; *&t;web pages: www.syskonnect.com&n; *&t;Goto &quot;Support&quot; and search Knowledge Base for &quot;manual&quot;.&n; *&t;&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * History:&n; *&n; *&t;$Log: skge.c,v $&n; *&t;Kernel 2.4.x specific:&n; *&t;Revision 1.xx  2000/09/12 13:31:56  cgoos&n; *&t;Fixed missign &quot;dev=NULL in skge_probe.&n; *&t;Added counting for jumbo frames (corrects error statistic).&n; *&t;Removed VLAN tag check (enables VLAN support).&n; *&t;&n; *&t;Kernel 2.2.x specific:&n; *&t;Revision 1.29  2000/02/21 13:31:56  cgoos&n; *&t;Fixed &quot;unused&quot; warning for UltraSPARC change.&n; *&t;&n; *&t;Partially kernel 2.2.x specific:&n; *&t;Revision 1.28  2000/02/21 10:32:36  cgoos&n; *&t;Added fixes for UltraSPARC.&n; *&t;Now printing RlmtMode and PrefPort setting at startup.&n; *&t;Changed XmitFrame return value.&n; *&t;Fixed rx checksum calculation for BIG ENDIAN systems.&n; *&t;Fixed rx jumbo frames counted as ierrors.&n; *&t;&n; *&t;&n; *&t;Revision 1.27  1999/11/25 09:06:28  cgoos&n; *&t;Changed base_addr to unsigned long.&n; *&t;&n; *&t;Revision 1.26  1999/11/22 13:29:16  cgoos&n; *&t;Changed license header to GPL.&n; *&t;Changes for inclusion in linux kernel (2.2.13).&n; *&t;Removed 2.0.x defines.&n; *&t;Changed SkGeProbe to skge_probe.&n; *&t;Added checks in SkGeIoctl.&n; *&t;&n; *&t;Revision 1.25  1999/10/07 14:47:52  cgoos&n; *&t;Changed 984x to 98xx.&n; *&t;&n; *&t;Revision 1.24  1999/09/30 07:21:01  cgoos&n; *&t;Removed SK_RLMT_SLOW_LOOKAHEAD option.&n; *&t;Giving spanning tree packets also to OS now.&n; *&t;&n; *&t;Revision 1.23  1999/09/29 07:36:50  cgoos&n; *&t;Changed assignment for IsBc/IsMc.&n; *&t;&n; *&t;Revision 1.22  1999/09/28 12:57:09  cgoos&n; *&t;Added CheckQueue also to Single-Port-ISR.&n; *&t;&n; *&t;Revision 1.21  1999/09/28 12:42:41  cgoos&n; *&t;Changed parameter strings for RlmtMode.&n; *&t;&n; *&t;Revision 1.20  1999/09/28 12:37:57  cgoos&n; *&t;Added CheckQueue for fast delivery of RLMT frames.&n; *&t;&n; *&t;Revision 1.19  1999/09/16 07:57:25  cgoos&n; *&t;Copperfield changes.&n; *&t;&n; *&t;Revision 1.18  1999/09/03 13:06:30  cgoos&n; *&t;Fixed RlmtMode=CheckSeg bug: wrong DEV_KFREE_SKB in RLMT_SEND caused&n; *&t;double allocated skb&squot;s.&n; *&t;FrameStat in ReceiveIrq was accessed via wrong Rxd.&n; *&t;Queue size for async. standby Tx queue was zero.&n; *&t;FillRxLimit of 0 could cause problems with ReQueue, changed to 1.&n; *&t;Removed debug output of checksum statistic.&n; *&t;&n; *&t;Revision 1.17  1999/08/11 13:55:27  cgoos&n; *&t;Transmit descriptor polling was not reenabled after SkGePortInit.&n; *&t;&n; *&t;Revision 1.16  1999/07/27 15:17:29  cgoos&n; *&t;Added some &quot;&bslash;n&quot; in output strings (removed while debuging...).&n; *&t;&n; *&t;Revision 1.15  1999/07/23 12:09:30  cgoos&n; *&t;Performance optimization, rx checksumming, large frame support.&n; *&t;&n; *&t;Revision 1.14  1999/07/14 11:26:27  cgoos&n; *&t;Removed Link LED settings (now in RLMT).&n; *&t;Added status output at NET UP.&n; *&t;Fixed SMP problems with Tx and SWITCH running in parallel.&n; *&t;Fixed return code problem at RLMT_SEND event.&n; *&t;&n; *&t;Revision 1.13  1999/04/07 10:11:42  cgoos&n; *&t;Fixed Single Port problems.&n; *&t;Fixed Multi-Adapter problems.&n; *&t;Always display startup string.&n; *&t;&n; *&t;Revision 1.12  1999/03/29 12:26:37  cgoos&n; *&t;Reversed locking to fine granularity.&n; *&t;Fixed skb double alloc problem (caused by incorrect xmit return code).&n; *&t;Enhanced function descriptions.&n; *&t;&n; *&t;Revision 1.11  1999/03/15 13:10:51  cgoos&n; *&t;Changed device identifier in output string to ethX.&n; *&t;&n; *&t;Revision 1.10  1999/03/15 12:12:34  cgoos&n; *&t;Changed copyright notice.&n; *&t;&n; *&t;Revision 1.9  1999/03/15 12:10:17  cgoos&n; *&t;Changed locking to one driver lock.&n; *&t;Added check of SK_AC-size (for consistency with library).&n; *&t;&n; *&t;Revision 1.8  1999/03/08 11:44:02  cgoos&n; *&t;Fixed missing dev-&gt;tbusy in SkGeXmit.&n; *&t;Changed large frame (jumbo) buffer number.&n; *&t;Added copying of short frames.&n; *&t;&n; *&t;Revision 1.7  1999/03/04 13:26:57  cgoos&n; *&t;Fixed spinlock calls for SMP.&n; *&t;&n; *&t;Revision 1.6  1999/03/02 09:53:51  cgoos&n; *&t;Added descriptor revertion for big endian machines.&n; *&t;&n; *&t;Revision 1.5  1999/03/01 08:50:59  cgoos&n; *&t;Fixed SkGeChangeMtu.&n; *&t;Fixed pci config space accesses.&n; *&t;&n; *&t;Revision 1.4  1999/02/18 15:48:44  cgoos&n; *&t;Corrected some printk&squot;s.&n; *&t;&n; *&t;Revision 1.3  1999/02/18 12:45:55  cgoos&n; *&t;Changed SK_MAX_CARD_PARAM to default 16&n; *&t;&n; *&t;Revision 1.2  1999/02/18 10:55:32  cgoos&n; *&t;Removed SkGeDrvTimeStamp function.&n; *&t;Printing &quot;ethX:&quot; before adapter type at adapter init.&n; *&t;&n; *&n; *&t;10-Feb-1999 cg&t;Created, based on Linux&squot; acenic.c, 3c59x.c and &n; *&t;&t;&t;SysKonnects GEnesis Solaris driver&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * Possible compiler options (#define xxx / -Dxxx):&n; *&n; *&t;debugging can be enable by changing SK_DEBUG_CHKMOD and &n; *&t;SK_DEBUG_CHKCAT in makefile (described there).&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * Description:&n; *&n; *&t;This is the main module of the Linux GE driver.&n; *&t;&n; *&t;All source files except skge.c, skdrv1st.h, skdrv2nd.h and sktypes.h&n; *&t;are part of SysKonnect&squot;s COMMON MODULES for the SK-98xx adapters.&n; *&t;Those are used for drivers on multiple OS&squot;, so some thing may seem&n; *&t;unnecessary complicated on Linux. Please do not try to &squot;clean up&squot;&n; *&t;them without VERY good reasons, because this will make it more&n; *&t;difficult to keep the Linux driver in synchronisation with the&n; *&t;other versions.&n; *&n; * Include file hierarchy:&n; *&n; *&t;&lt;linux/module.h&gt;&n; *&n; *&t;&quot;h/skdrv1st.h&quot;&n; *&t;&t;&lt;linux/version.h&gt;&n; *&t;&t;&lt;linux/types.h&gt;&n; *&t;&t;&lt;linux/kernel.h&gt;&n; *&t;&t;&lt;linux/string.h&gt;&n; *&t;&t;&lt;linux/errno.h&gt;&n; *&t;&t;&lt;linux/ioport.h&gt;&n; *&t;&t;&lt;linux/malloc.h&gt;&n; *&t;&t;&lt;linux/interrupt.h&gt;&n; *&t;&t;&lt;linux/pci.h&gt;&n; *&t;&t;&lt;asm/byteorder.h&gt;&n; *&t;&t;&lt;asm/bitops.h&gt;&n; *&t;&t;&lt;asm/io.h&gt;&n; *&t;&t;&lt;linux/netdevice.h&gt;&n; *&t;&t;&lt;linux/etherdevice.h&gt;&n; *&t;&t;&lt;linux/skbuff.h&gt;&n; *&t;    those three depending on kernel version used:&n; *&t;&t;&lt;linux/bios32.h&gt;&n; *&t;&t;&lt;linux/init.h&gt;&n; *&t;&t;&lt;asm/uaccess.h&gt;&n; *&t;&t;&lt;net/checksum.h&gt;&n; *&n; *&t;&t;&quot;h/skerror.h&quot;&n; *&t;&t;&quot;h/skdebug.h&quot;&n; *&t;&t;&quot;h/sktypes.h&quot;&n; *&t;&t;&quot;h/lm80.h&quot;&n; *&t;&t;&quot;h/xmac_ii.h&quot;&n; *&n; *      &quot;h/skdrv2nd.h&quot;&n; *&t;&t;&quot;h/skqueue.h&quot;&n; *&t;&t;&quot;h/skgehwt.h&quot;&n; *&t;&t;&quot;h/sktimer.h&quot;&n; *&t;&t;&quot;h/ski2c.h&quot;&n; *&t;&t;&quot;h/skgepnmi.h&quot;&n; *&t;&t;&quot;h/skvpd.h&quot;&n; *&t;&t;&quot;h/skgehw.h&quot;&n; *&t;&t;&quot;h/skgeinit.h&quot;&n; *&t;&t;&quot;h/skaddr.h&quot;&n; *&t;&t;&quot;h/skgesirq.h&quot;&n; *&t;&t;&quot;h/skcsum.h&quot;&n; *&t;&t;&quot;h/skrlmt.h&quot;&n; *&n; ******************************************************************************/
DECL|variable|SysKonnectFileId
r_static
r_const
r_char
id|SysKonnectFileId
(braket
)braket
op_assign
l_string|&quot;@(#)&quot;
id|__FILE__
l_string|&quot; (C) SysKonnect.&quot;
suffix:semicolon
DECL|variable|SysKonnectBuildNumber
r_static
r_const
r_char
id|SysKonnectBuildNumber
(braket
)braket
op_assign
l_string|&quot;@(#)SK-BUILD: 3.05 (20000907) PL: 01&quot;
suffix:semicolon
macro_line|#include&t;&lt;linux/module.h&gt;
macro_line|#include&t;&lt;linux/init.h&gt;
macro_line|#include&t;&quot;h/skdrv1st.h&quot;
macro_line|#include&t;&quot;h/skdrv2nd.h&quot;
multiline_comment|/* defines ******************************************************************/
DECL|macro|BOOT_STRING
mdefine_line|#define BOOT_STRING&t;&quot;sk98lin: Network Device Driver v3.05&bslash;n&quot; &bslash;&n;&t;&t;&t;&quot;Copyright (C) 1999-2000 SysKonnect&quot;
DECL|macro|VER_STRING
mdefine_line|#define VER_STRING&t;&quot;3.05&quot;
multiline_comment|/* for debuging on x86 only */
multiline_comment|/* #define BREAKPOINT() asm(&quot; int $3&quot;); */
multiline_comment|/* use of a transmit complete interrupt */
DECL|macro|USE_TX_COMPLETE
mdefine_line|#define USE_TX_COMPLETE
multiline_comment|/* use interrupt moderation (for tx complete only) */
singleline_comment|// #define USE_INT_MOD
DECL|macro|INTS_PER_SEC
mdefine_line|#define INTS_PER_SEC&t;1000
multiline_comment|/*&n; * threshold for copying small receive frames&n; * set to 0 to avoid copying, set to 9001 to copy all frames&n; */
DECL|macro|SK_COPY_THRESHOLD
mdefine_line|#define SK_COPY_THRESHOLD&t;200
multiline_comment|/* number of adapters that can be configured via command line params */
DECL|macro|SK_MAX_CARD_PARAM
mdefine_line|#define SK_MAX_CARD_PARAM&t;16
multiline_comment|/*&n; * use those defines for a compile-in version of the driver instead &n; * of command line parameters&n; */
singleline_comment|// #define AUTO_NEG_A&t;{&quot;Sense&quot;, }
singleline_comment|// #define AUTO_NEG_B&t;{&quot;Sense&quot;, }
singleline_comment|// #define DUP_CAP_A&t;{&quot;Both&quot;, }
singleline_comment|// #define DUP_CAP_B&t;{&quot;Both&quot;, }
singleline_comment|// #define FLOW_CTRL_A&t;{&quot;SymOrRem&quot;, }
singleline_comment|// #define FLOW_CTRL_B&t;{&quot;SymOrRem&quot;, }
singleline_comment|// #define ROLE_A&t;{&quot;Auto&quot;, }
singleline_comment|// #define ROLE_B&t;{&quot;Auto&quot;, }
singleline_comment|// #define PREF_PORT&t;{&quot;A&quot;, }
singleline_comment|// #define RLMT_MODE&t;{&quot;CheckLink&quot;, }
DECL|macro|DEV_KFREE_SKB
mdefine_line|#define DEV_KFREE_SKB(skb) dev_kfree_skb(skb)
DECL|macro|DEV_KFREE_SKB_IRQ
mdefine_line|#define DEV_KFREE_SKB_IRQ(skb) dev_kfree_skb_irq(skb)
DECL|macro|DEV_KFREE_SKB_ANY
mdefine_line|#define DEV_KFREE_SKB_ANY(skb) dev_kfree_skb_any(skb)
multiline_comment|/* function prototypes ******************************************************/
r_static
r_void
id|FreeResources
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|SkGeBoardInit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|SK_AC
op_star
id|pAC
)paren
suffix:semicolon
r_static
id|SK_BOOL
id|BoardAllocMem
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
suffix:semicolon
r_static
r_void
id|BoardFreeMem
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
suffix:semicolon
r_static
r_void
id|BoardInitMem
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
suffix:semicolon
r_static
r_void
id|SetupRing
c_func
(paren
id|SK_AC
op_star
comma
r_void
op_star
comma
r_uintptr
comma
id|RXD
op_star
op_star
comma
id|RXD
op_star
op_star
comma
id|RXD
op_star
op_star
comma
r_int
op_star
comma
id|SK_BOOL
)paren
suffix:semicolon
r_static
r_void
id|SkGeIsr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
suffix:semicolon
r_static
r_void
id|SkGeIsrOnePort
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
suffix:semicolon
r_static
r_int
id|SkGeOpen
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|SkGeClose
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|SkGeXmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|SkGeSetMacAddr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
suffix:semicolon
r_static
r_void
id|SkGeSetRxMode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|SkGeStats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|SkGeIoctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|GetConfiguration
c_func
(paren
id|SK_AC
op_star
)paren
suffix:semicolon
r_static
r_void
id|ProductStr
c_func
(paren
id|SK_AC
op_star
)paren
suffix:semicolon
r_static
r_int
id|XmitFrame
c_func
(paren
id|SK_AC
op_star
comma
id|TX_PORT
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
id|FreeTxDescriptors
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
id|TX_PORT
op_star
)paren
suffix:semicolon
r_static
r_void
id|FillRxRing
c_func
(paren
id|SK_AC
op_star
comma
id|RX_PORT
op_star
)paren
suffix:semicolon
r_static
id|SK_BOOL
id|FillRxDescriptor
c_func
(paren
id|SK_AC
op_star
comma
id|RX_PORT
op_star
)paren
suffix:semicolon
r_static
r_void
id|ReceiveIrq
c_func
(paren
id|SK_AC
op_star
comma
id|RX_PORT
op_star
)paren
suffix:semicolon
r_static
r_void
id|ClearAndStartRx
c_func
(paren
id|SK_AC
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ClearTxIrq
c_func
(paren
id|SK_AC
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ClearRxRing
c_func
(paren
id|SK_AC
op_star
comma
id|RX_PORT
op_star
)paren
suffix:semicolon
r_static
r_void
id|ClearTxRing
c_func
(paren
id|SK_AC
op_star
comma
id|TX_PORT
op_star
)paren
suffix:semicolon
r_static
r_void
id|SetQueueSizes
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
suffix:semicolon
r_static
r_int
id|SkGeChangeMtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
suffix:semicolon
r_static
r_void
id|PortReInitBmu
c_func
(paren
id|SK_AC
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|SkGeIocMib
c_func
(paren
id|SK_AC
op_star
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_static
r_void
id|DumpMsg
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_static
r_void
id|DumpData
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|DumpLong
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* global variables *********************************************************/
DECL|variable|BootString
r_static
r_const
r_char
op_star
id|BootString
op_assign
id|BOOT_STRING
suffix:semicolon
DECL|variable|root_dev
r_static
r_struct
id|net_device
op_star
id|root_dev
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|probed
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* local variables **********************************************************/
DECL|variable|TxQueueAddr
r_static
r_uintptr
id|TxQueueAddr
(braket
id|SK_MAX_MACS
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|0x680
comma
l_int|0x600
)brace
comma
(brace
l_int|0x780
comma
l_int|0x700
)brace
)brace
suffix:semicolon
DECL|variable|RxQueueAddr
r_static
r_uintptr
id|RxQueueAddr
(braket
id|SK_MAX_MACS
)braket
op_assign
(brace
l_int|0x400
comma
l_int|0x480
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************&n; *&n; * &t;skge_probe - find all SK-98xx adapters&n; *&n; * Description:&n; *&t;This function scans the PCI bus for SK-98xx adapters. Resources for&n; *&t;each adapter are allocated and the adapter is brought into Init 1&n; *&t;state.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|skge_probe
r_static
r_int
id|__init
id|skge_probe
(paren
r_void
)paren
(brace
r_int
id|boards_found
op_assign
l_int|0
suffix:semicolon
r_int
id|version_disp
op_assign
l_int|0
suffix:semicolon
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|base_address
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|probed
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|probed
op_increment
suffix:semicolon
multiline_comment|/* display driver info */
r_if
c_cond
(paren
op_logical_neg
id|version_disp
)paren
(brace
multiline_comment|/* set display flag to TRUE so that */
multiline_comment|/* we only display this string ONCE */
id|version_disp
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|BootString
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* is PCI support present? */
r_return
op_minus
id|ENODEV
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SYSKONNECT
comma
id|PCI_DEVICE_ID_SYSKONNECT_GE
comma
id|pdev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
id|SK_AC
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to allocate etherdev &quot;
l_string|&quot;structure!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pAC
op_assign
id|dev-&gt;priv
suffix:semicolon
id|pAC-&gt;PciDev
op_assign
op_star
id|pdev
suffix:semicolon
id|pAC-&gt;PciDevId
op_assign
id|pdev-&gt;device
suffix:semicolon
id|pAC-&gt;dev
op_assign
id|dev
suffix:semicolon
id|sprintf
c_func
(paren
id|pAC-&gt;Name
comma
l_string|&quot;SysKonnect SK-98xx&quot;
)paren
suffix:semicolon
id|pAC-&gt;CheckQueue
op_assign
id|SK_FALSE
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|SkGeOpen
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|SkGeClose
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|SkGeXmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|SkGeStats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|SkGeSetRxMode
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
op_amp
id|SkGeSetMacAddr
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|SkGeIoctl
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
op_amp
id|SkGeChangeMtu
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Dummy value.&n;&t;&t; */
id|dev-&gt;base_addr
op_assign
l_int|42
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|base_address
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef SK_BIG_ENDIAN
multiline_comment|/*&n;&t;&t; * On big endian machines, we use the adapter&squot;s aibility of&n;&t;&t; * reading the descriptors as big endian.&n;&t;&t; */
(brace
id|SK_U32
id|our2
suffix:semicolon
id|SkPciReadCfgDWord
c_func
(paren
id|pAC
comma
id|PCI_OUR_REG_2
comma
op_amp
id|our2
)paren
suffix:semicolon
id|our2
op_or_assign
id|PCI_REV_DESC
suffix:semicolon
id|SkPciWriteCfgDWord
c_func
(paren
id|pAC
comma
id|PCI_OUR_REG_2
comma
id|our2
)paren
suffix:semicolon
)brace
macro_line|#endif /* BIG ENDIAN */
multiline_comment|/*&n;&t;&t; * Remap the regs into kernel space.&n;&t;&t; */
id|pAC-&gt;IoBase
op_assign
(paren
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|base_address
comma
l_int|0x4000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pAC-&gt;IoBase
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:  Unable to map I/O register, &quot;
l_string|&quot;SK 98xx No. %i will be disabled.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|boards_found
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pAC-&gt;Index
op_assign
id|boards_found
suffix:semicolon
r_if
c_cond
(paren
id|SkGeBoardInit
c_func
(paren
id|dev
comma
id|pAC
)paren
)paren
(brace
id|FreeResources
c_func
(paren
id|dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|dev-&gt;dev_addr
comma
(paren
id|caddr_t
)paren
op_amp
id|pAC-&gt;Addr.CurrentMacAddress
comma
l_int|6
)paren
suffix:semicolon
id|boards_found
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is bollocks, but we need to tell the net-init&n;&t;&t; * code that it shall go for the next device.&n;&t;&t; */
macro_line|#ifndef MODULE
id|dev-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * If we&squot;re at this point we&squot;re going through skge_probe() for&n;&t; * the first time.  Return success (0) if we&squot;ve initialized 1&n;&t; * or more boards. Otherwise, return failure (-ENODEV).&n;&t; */
r_return
id|boards_found
suffix:semicolon
)brace
multiline_comment|/* skge_probe */
multiline_comment|/*****************************************************************************&n; *&n; * &t;FreeResources - release resources allocated for adapter&n; *&n; * Description:&n; *&t;This function releases the IRQ, unmaps the IO and&n; *&t;frees the desriptor ring.&n; *&n; * Returns: N/A&n; *&t;&n; */
DECL|function|FreeResources
r_static
r_void
id|FreeResources
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SK_U32
id|AllocFlag
suffix:semicolon
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
(brace
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|AllocFlag
op_assign
id|pAC-&gt;AllocFlag
suffix:semicolon
r_if
c_cond
(paren
id|AllocFlag
op_amp
id|SK_ALLOC_IRQ
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;IoBase
)paren
(brace
id|iounmap
c_func
(paren
id|pAC-&gt;IoBase
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;pDescrMem
)paren
(brace
id|BoardFreeMem
c_func
(paren
id|pAC
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* FreeResources */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Christoph Goos &lt;cgoos@syskonnect.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SysKonnect SK-NET Gigabit Ethernet SK-98xx driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|AutoNeg_A
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|AutoNeg_B
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|DupCap_A
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|DupCap_B
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|FlowCtrl_A
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|FlowCtrl_B
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|Role_A
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|Role_B
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|PrefPort
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|RlmtMode
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
multiline_comment|/* not used, just there because every driver should have them: */
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SK_MAX_CARD_PARAM
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#ifdef AUTO_NEG_A
DECL|variable|AutoNeg_A
r_static
r_char
op_star
id|AutoNeg_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|AUTO_NEG_A
suffix:semicolon
macro_line|#else
DECL|variable|AutoNeg_A
r_static
r_char
op_star
id|AutoNeg_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DUP_CAP_A
DECL|variable|DupCap_A
r_static
r_char
op_star
id|DupCap_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|DUP_CAP_A
suffix:semicolon
macro_line|#else
DECL|variable|DupCap_A
r_static
r_char
op_star
id|DupCap_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FLOW_CTRL_A
DECL|variable|FlowCtrl_A
r_static
r_char
op_star
id|FlowCtrl_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|FLOW_CTRL_A
suffix:semicolon
macro_line|#else
DECL|variable|FlowCtrl_A
r_static
r_char
op_star
id|FlowCtrl_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ROLE_A
DECL|variable|Role_A
r_static
r_char
op_star
id|Role_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|ROLE_A
suffix:semicolon
macro_line|#else
DECL|variable|Role_A
r_static
r_char
op_star
id|Role_A
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef AUTO_NEG_B
DECL|variable|AutoNeg_B
r_static
r_char
op_star
id|AutoNeg_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|AUTO_NEG_B
suffix:semicolon
macro_line|#else
DECL|variable|AutoNeg_B
r_static
r_char
op_star
id|AutoNeg_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DUP_CAP_B
DECL|variable|DupCap_B
r_static
r_char
op_star
id|DupCap_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|DUP_CAP_B
suffix:semicolon
macro_line|#else
DECL|variable|DupCap_B
r_static
r_char
op_star
id|DupCap_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FLOW_CTRL_B
DECL|variable|FlowCtrl_B
r_static
r_char
op_star
id|FlowCtrl_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|FLOW_CTRL_B
suffix:semicolon
macro_line|#else
DECL|variable|FlowCtrl_B
r_static
r_char
op_star
id|FlowCtrl_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ROLE_B
DECL|variable|Role_B
r_static
r_char
op_star
id|Role_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|ROLE_B
suffix:semicolon
macro_line|#else
DECL|variable|Role_B
r_static
r_char
op_star
id|Role_B
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef PREF_PORT
DECL|variable|PrefPort
r_static
r_char
op_star
id|PrefPort
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|PREF_PORT
suffix:semicolon
macro_line|#else
DECL|variable|PrefPort
r_static
r_char
op_star
id|PrefPort
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef RLMT_MODE
DECL|variable|RlmtMode
r_static
r_char
op_star
id|RlmtMode
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
id|RLMT_MODE
suffix:semicolon
macro_line|#else
DECL|variable|RlmtMode
r_static
r_char
op_star
id|RlmtMode
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not used */
DECL|variable|options
r_static
r_int
id|options
(braket
id|SK_MAX_CARD_PARAM
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* not used */
multiline_comment|/*****************************************************************************&n; *&n; * &t;skge_init_module - module initialization function&n; *&n; * Description:&n; *&t;Very simple, only call skge_probe and return approriate result.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|skge_init_module
r_static
r_int
id|__init
id|skge_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|cards
suffix:semicolon
id|root_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* just to avoid warnings ... */
id|debug
op_assign
l_int|0
suffix:semicolon
id|options
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|cards
op_assign
id|skge_probe
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cards
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No adapter found&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|cards
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* skge_init_module */
multiline_comment|/*****************************************************************************&n; *&n; * &t;skge_cleanup_module - module unload function&n; *&n; * Description:&n; *&t;Disable adapter if it is still running, free resources,&n; *&t;free device struct.&n; *&n; * Returns: N/A&n; */
DECL|function|skge_cleanup_module
r_static
r_void
id|__exit
id|skge_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_struct
id|net_device
op_star
id|next
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
id|SK_EVPARA
id|EvPara
suffix:semicolon
r_while
c_loop
(paren
id|root_dev
)paren
(brace
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|root_dev-&gt;priv
suffix:semicolon
id|next
op_assign
id|pAC-&gt;Next
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|SkGeYellowLED
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;BoardLevel
op_eq
l_int|2
)paren
(brace
multiline_comment|/* board is still alive */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_STOP
comma
id|EvPara
)paren
suffix:semicolon
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
l_int|0
)paren
suffix:semicolon
id|SkGeDeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We do NOT check here, if IRQ was pending, of course*/
)brace
r_if
c_cond
(paren
id|pAC-&gt;BoardLevel
op_eq
l_int|1
)paren
(brace
multiline_comment|/* board is still alive */
id|SkGeDeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|0
suffix:semicolon
)brace
id|FreeResources
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|root_dev-&gt;get_stats
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* &n;&t;&t; * otherwise unregister_netdev calls get_stats with&n;&t;&t; * invalid IO ...  :-(&n;&t;&t; */
id|unregister_netdev
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|root_dev
op_assign
id|next
suffix:semicolon
)brace
)brace
multiline_comment|/* skge_cleanup_module */
DECL|variable|skge_init_module
id|module_init
c_func
(paren
id|skge_init_module
)paren
suffix:semicolon
DECL|variable|skge_cleanup_module
id|module_exit
c_func
(paren
id|skge_cleanup_module
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeBoardInit - do level 0 and 1 initialization&n; *&n; * Description:&n; *&t;This function prepares the board hardware for running. The desriptor&n; *&t;ring is set up, the IRQ is allocated and the configuration settings&n; *&t;are examined.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|SkGeBoardInit
r_static
r_int
id|__init
id|SkGeBoardInit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|SK_AC
op_star
id|pAC
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
r_char
op_star
id|DescrString
op_assign
l_string|&quot;sk98lin: Driver for Linux&quot;
suffix:semicolon
multiline_comment|/* this is given to PNMI */
r_char
op_star
id|VerStr
op_assign
id|VER_STRING
suffix:semicolon
r_int
id|Ret
suffix:semicolon
multiline_comment|/* return code of request_irq */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;IoBase: %08lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|pAC-&gt;IoBase
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAX_MACS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|HwAddr
op_assign
id|pAC-&gt;IoBase
op_plus
id|TxQueueAddr
(braket
id|i
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|PortIndex
op_assign
id|i
suffix:semicolon
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|HwAddr
op_assign
id|pAC-&gt;IoBase
op_plus
id|RxQueueAddr
(braket
id|i
)braket
suffix:semicolon
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|PortIndex
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* Initialize the mutexes */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAX_MACS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxDesRingLock
)paren
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
)paren
suffix:semicolon
multiline_comment|/* level 0 init common modules here */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
multiline_comment|/* Does a RESET on board ...*/
r_if
c_cond
(paren
id|SkGeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HWInit (0) failed.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|SkI2cInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
id|SkEventInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
id|SkPnmiInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
id|SkAddrInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
id|SkRlmtInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
id|SkTimerInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|0
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;RxBufSize
op_assign
id|ETH_BUF_SIZE
suffix:semicolon
id|SK_PNMI_SET_DRIVER_DESCR
c_func
(paren
id|pAC
comma
id|DescrString
)paren
suffix:semicolon
id|SK_PNMI_SET_DRIVER_VER
c_func
(paren
id|pAC
comma
id|VerStr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|GetConfiguration
c_func
(paren
id|pAC
)paren
suffix:semicolon
multiline_comment|/* level 1 init common modules here (HW init) */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SkGeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HWInit (1) failed.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|SkI2cInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkEventInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkPnmiInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkAddrInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkRlmtInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkTimerInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
op_eq
l_int|2
)paren
(brace
id|Ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|SkGeIsr
comma
id|SA_SHIRQ
comma
id|pAC-&gt;Name
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
op_eq
l_int|1
)paren
(brace
id|Ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|SkGeIsrOnePort
comma
id|SA_SHIRQ
comma
id|pAC-&gt;Name
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: illegal number of ports: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pAC-&gt;GIni.GIMacsFound
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Requested IRQ %d is busy&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|pAC-&gt;AllocFlag
op_or_assign
id|SK_ALLOC_IRQ
suffix:semicolon
multiline_comment|/* Alloc memory for this board (Mem for RxD/TxD) : */
r_if
c_cond
(paren
op_logical_neg
id|BoardAllocMem
c_func
(paren
id|pAC
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No memory for descriptor rings&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|SkCsSetReceiveFlags
c_func
(paren
id|pAC
comma
id|SKCS_PROTO_IP
op_or
id|SKCS_PROTO_TCP
op_or
id|SKCS_PROTO_UDP
comma
op_amp
id|pAC-&gt;CsOfs1
comma
op_amp
id|pAC-&gt;CsOfs2
)paren
suffix:semicolon
id|pAC-&gt;CsOfs
op_assign
(paren
id|pAC-&gt;CsOfs2
op_lshift
l_int|16
)paren
op_or
id|pAC-&gt;CsOfs1
suffix:semicolon
id|BoardInitMem
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|SetQueueSizes
c_func
(paren
id|pAC
)paren
suffix:semicolon
multiline_comment|/* Print adapter specific string from vpd */
id|ProductStr
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pAC-&gt;DeviceStr
)paren
suffix:semicolon
multiline_comment|/* Print configuration settings */
id|printk
c_func
(paren
l_string|&quot;      PrefPort:%c  RlmtMode:%s&bslash;n&quot;
comma
l_char|&squot;A&squot;
op_plus
id|pAC-&gt;Rlmt.PrefPort
comma
(paren
id|pAC-&gt;RlmtMode
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;ChkLink&quot;
suffix:colon
(paren
(paren
id|pAC-&gt;RlmtMode
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;ChkLink&quot;
suffix:colon
(paren
(paren
id|pAC-&gt;RlmtMode
op_eq
l_int|3
)paren
ques
c_cond
l_string|&quot;ChkOth&quot;
suffix:colon
(paren
(paren
id|pAC-&gt;RlmtMode
op_eq
l_int|7
)paren
ques
c_cond
l_string|&quot;ChkSeg&quot;
suffix:colon
l_string|&quot;Error&quot;
)paren
)paren
)paren
)paren
suffix:semicolon
id|SkGeYellowLED
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Register the device here&n;&t; */
id|pAC-&gt;Next
op_assign
id|root_dev
suffix:semicolon
id|root_dev
op_assign
id|dev
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* SkGeBoardInit */
multiline_comment|/*****************************************************************************&n; *&n; * &t;BoardAllocMem - allocate the memory for the descriptor rings&n; *&n; * Description:&n; *&t;This function allocates the memory for all descriptor rings.&n; *&t;Each ring is aligned for the desriptor alignment and no ring&n; *&t;has a 4 GByte boundary in it (because the upper 32 bit must&n; *&t;be constant for all descriptiors in one rings).&n; *&n; * Returns:&n; *&t;SK_TRUE, if all memory could be allocated&n; *&t;SK_FALSE, if not&n; */
DECL|function|BoardAllocMem
r_static
id|SK_BOOL
id|BoardAllocMem
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
(brace
id|caddr_t
id|pDescrMem
suffix:semicolon
multiline_comment|/* pointer to descriptor memory area */
r_int
id|AllocLength
suffix:semicolon
multiline_comment|/* length of complete descriptor area */
r_int
id|i
suffix:semicolon
multiline_comment|/* loop counter */
r_int
r_int
id|BusAddr
suffix:semicolon
multiline_comment|/* rings plus one for alignment (do not cross 4 GB boundary) */
multiline_comment|/* RX_RING_SIZE is assumed bigger than TX_RING_SIZE */
macro_line|#if (BITS_PER_LONG == 32)
id|AllocLength
op_assign
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
op_star
id|pAC-&gt;GIni.GIMacsFound
op_plus
l_int|8
suffix:semicolon
macro_line|#else
id|AllocLength
op_assign
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
op_star
id|pAC-&gt;GIni.GIMacsFound
op_plus
id|RX_RING_SIZE
op_plus
l_int|8
suffix:semicolon
macro_line|#endif
id|pDescrMem
op_assign
id|pci_alloc_consistent
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|AllocLength
comma
op_amp
id|pAC-&gt;pDescrMemDMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDescrMem
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
id|SK_FALSE
)paren
suffix:semicolon
)brace
id|pAC-&gt;pDescrMem
op_assign
id|pDescrMem
suffix:semicolon
multiline_comment|/* Descriptors need 8 byte alignment, and this is ensured&n;&t; * by pci_alloc_consistent.&n;&t; */
id|BusAddr
op_assign
(paren
r_int
r_int
)paren
id|pAC-&gt;pDescrMemDMA
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_TX_PROGRESS
comma
(paren
l_string|&quot;TX%d/A: pDescrMem: %lX,   PhysDescrMem: %lX&bslash;n&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|pDescrMem
comma
id|BusAddr
)paren
)paren
suffix:semicolon
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|pTxDescrRing
op_assign
id|pDescrMem
suffix:semicolon
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|VTxDescrRing
op_assign
id|BusAddr
suffix:semicolon
id|pDescrMem
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
id|BusAddr
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_TX_PROGRESS
comma
(paren
l_string|&quot;RX%d: pDescrMem: %lX,   PhysDescrMem: %lX&bslash;n&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|pDescrMem
comma
(paren
r_int
r_int
)paren
id|BusAddr
)paren
)paren
suffix:semicolon
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|pRxDescrRing
op_assign
id|pDescrMem
suffix:semicolon
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|VRxDescrRing
op_assign
id|BusAddr
suffix:semicolon
id|pDescrMem
op_add_assign
id|RX_RING_SIZE
suffix:semicolon
id|BusAddr
op_add_assign
id|RX_RING_SIZE
suffix:semicolon
)brace
multiline_comment|/* for */
r_return
(paren
id|SK_TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/* BoardAllocMem */
multiline_comment|/****************************************************************************&n; *&n; *&t;BoardFreeMem - reverse of BoardAllocMem&n; *&n; * Description:&n; *&t;Free all memory allocated in BoardAllocMem: adapter context,&n; *&t;descriptor rings, locks.&n; *&n; * Returns:&t;N/A&n; */
DECL|function|BoardFreeMem
r_static
r_void
id|BoardFreeMem
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
(brace
r_int
id|AllocLength
suffix:semicolon
multiline_comment|/* length of complete descriptor area */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;BoardFreeMem&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 32)
id|AllocLength
op_assign
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
op_star
id|pAC-&gt;GIni.GIMacsFound
op_plus
l_int|8
suffix:semicolon
macro_line|#else
id|AllocLength
op_assign
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
op_star
id|pAC-&gt;GIni.GIMacsFound
op_plus
id|RX_RING_SIZE
op_plus
l_int|8
suffix:semicolon
macro_line|#endif
id|pci_free_consistent
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|AllocLength
comma
id|pAC-&gt;pDescrMem
comma
id|pAC-&gt;pDescrMemDMA
)paren
suffix:semicolon
id|pAC-&gt;pDescrMem
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* BoardFreeMem */
multiline_comment|/*****************************************************************************&n; *&n; * &t;BoardInitMem - initiate the descriptor rings&n; *&n; * Description:&n; *&t;This function sets the descriptor rings up in memory.&n; *&t;The adapter is initialized with the descriptor start addresses.&n; *&n; * Returns:&t;N/A&n; */
DECL|function|BoardInitMem
r_static
r_void
id|BoardInitMem
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
multiline_comment|/* pointer to adapter context */
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* loop counter */
r_int
id|RxDescrSize
suffix:semicolon
multiline_comment|/* the size of a rx descriptor rounded up to alignment*/
r_int
id|TxDescrSize
suffix:semicolon
multiline_comment|/* the size of a tx descriptor rounded up to alignment*/
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;BoardInitMem&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|RxDescrSize
op_assign
(paren
(paren
(paren
r_sizeof
(paren
id|RXD
)paren
op_minus
l_int|1
)paren
op_div
id|DESCR_ALIGN
)paren
op_plus
l_int|1
)paren
op_star
id|DESCR_ALIGN
suffix:semicolon
id|pAC-&gt;RxDescrPerRing
op_assign
id|RX_RING_SIZE
op_div
id|RxDescrSize
suffix:semicolon
id|TxDescrSize
op_assign
(paren
(paren
(paren
r_sizeof
(paren
id|TXD
)paren
op_minus
l_int|1
)paren
op_div
id|DESCR_ALIGN
)paren
op_plus
l_int|1
)paren
op_star
id|DESCR_ALIGN
suffix:semicolon
id|pAC-&gt;TxDescrPerRing
op_assign
id|TX_RING_SIZE
op_div
id|RxDescrSize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SetupRing
c_func
(paren
id|pAC
comma
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|pTxDescrRing
comma
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|VTxDescrRing
comma
(paren
id|RXD
op_star
op_star
)paren
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|pTxdRingHead
comma
(paren
id|RXD
op_star
op_star
)paren
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|pTxdRingTail
comma
(paren
id|RXD
op_star
op_star
)paren
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|pTxdRingPrev
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|TxdRingFree
comma
id|SK_TRUE
)paren
suffix:semicolon
id|SetupRing
c_func
(paren
id|pAC
comma
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|pRxDescrRing
comma
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|VRxDescrRing
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|pRxdRingHead
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|pRxdRingTail
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|pRxdRingPrev
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxdRingFree
comma
id|SK_FALSE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* BoardInitMem */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SetupRing - create one descriptor ring&n; *&n; * Description:&n; *&t;This function creates one descriptor ring in the given memory area.&n; *&t;The head, tail and number of free descriptors in the ring are set.&n; *&n; * Returns:&n; *&t;none&n; */
DECL|function|SetupRing
r_static
r_void
id|SetupRing
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
r_void
op_star
id|pMemArea
comma
multiline_comment|/* a pointer to the memory area for the ring */
r_uintptr
id|VMemArea
comma
multiline_comment|/* the virtual bus address of the memory area */
id|RXD
op_star
op_star
id|ppRingHead
comma
multiline_comment|/* address where the head should be written */
id|RXD
op_star
op_star
id|ppRingTail
comma
multiline_comment|/* address where the tail should be written */
id|RXD
op_star
op_star
id|ppRingPrev
comma
multiline_comment|/* address where the tail should be written */
r_int
op_star
id|pRingFree
comma
multiline_comment|/* address where the # of free descr. goes */
id|SK_BOOL
id|IsTx
)paren
multiline_comment|/* flag: is this a tx ring */
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* loop counter */
r_int
id|DescrSize
suffix:semicolon
multiline_comment|/* the size of a descriptor rounded up to alignment*/
r_int
id|DescrNum
suffix:semicolon
multiline_comment|/* number of descriptors per ring */
id|RXD
op_star
id|pDescr
suffix:semicolon
multiline_comment|/* pointer to a descriptor (receive or transmit) */
id|RXD
op_star
id|pNextDescr
suffix:semicolon
multiline_comment|/* pointer to the next descriptor */
id|RXD
op_star
id|pPrevDescr
suffix:semicolon
multiline_comment|/* pointer to the previous descriptor */
r_uintptr
id|VNextDescr
suffix:semicolon
multiline_comment|/* the virtual bus address of the next descriptor */
r_if
c_cond
(paren
id|IsTx
op_eq
id|SK_TRUE
)paren
(brace
id|DescrSize
op_assign
(paren
(paren
(paren
r_sizeof
(paren
id|TXD
)paren
op_minus
l_int|1
)paren
op_div
id|DESCR_ALIGN
)paren
op_plus
l_int|1
)paren
op_star
id|DESCR_ALIGN
suffix:semicolon
id|DescrNum
op_assign
id|TX_RING_SIZE
op_div
id|DescrSize
suffix:semicolon
)brace
r_else
(brace
id|DescrSize
op_assign
(paren
(paren
(paren
r_sizeof
(paren
id|RXD
)paren
op_minus
l_int|1
)paren
op_div
id|DESCR_ALIGN
)paren
op_plus
l_int|1
)paren
op_star
id|DESCR_ALIGN
suffix:semicolon
id|DescrNum
op_assign
id|RX_RING_SIZE
op_div
id|DescrSize
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_TX_PROGRESS
comma
(paren
l_string|&quot;Descriptor size: %d   Descriptor Number: %d&bslash;n&quot;
comma
id|DescrSize
comma
id|DescrNum
)paren
)paren
suffix:semicolon
id|pDescr
op_assign
(paren
id|RXD
op_star
)paren
id|pMemArea
suffix:semicolon
id|pPrevDescr
op_assign
l_int|NULL
suffix:semicolon
id|pNextDescr
op_assign
(paren
id|RXD
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|pDescr
)paren
op_plus
id|DescrSize
)paren
suffix:semicolon
id|VNextDescr
op_assign
id|VMemArea
op_plus
id|DescrSize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DescrNum
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* set the pointers right */
id|pDescr-&gt;VNextRxd
op_assign
id|VNextDescr
op_amp
l_int|0xffffffffULL
suffix:semicolon
id|pDescr-&gt;pNextRxd
op_assign
id|pNextDescr
suffix:semicolon
id|pDescr-&gt;TcpSumStarts
op_assign
id|pAC-&gt;CsOfs
suffix:semicolon
multiline_comment|/* advance on step */
id|pPrevDescr
op_assign
id|pDescr
suffix:semicolon
id|pDescr
op_assign
id|pNextDescr
suffix:semicolon
id|pNextDescr
op_assign
(paren
id|RXD
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|pDescr
)paren
op_plus
id|DescrSize
)paren
suffix:semicolon
id|VNextDescr
op_add_assign
id|DescrSize
suffix:semicolon
)brace
id|pPrevDescr-&gt;pNextRxd
op_assign
(paren
id|RXD
op_star
)paren
id|pMemArea
suffix:semicolon
id|pPrevDescr-&gt;VNextRxd
op_assign
id|VMemArea
suffix:semicolon
id|pDescr
op_assign
(paren
id|RXD
op_star
)paren
id|pMemArea
suffix:semicolon
op_star
id|ppRingHead
op_assign
(paren
id|RXD
op_star
)paren
id|pMemArea
suffix:semicolon
op_star
id|ppRingTail
op_assign
op_star
id|ppRingHead
suffix:semicolon
op_star
id|ppRingPrev
op_assign
id|pPrevDescr
suffix:semicolon
op_star
id|pRingFree
op_assign
id|DescrNum
suffix:semicolon
)brace
multiline_comment|/* SetupRing */
multiline_comment|/*****************************************************************************&n; *&n; * &t;PortReInitBmu - re-initiate the descriptor rings for one port&n; *&n; * Description:&n; *&t;This function reinitializes the descriptor rings of one port&n; *&t;in memory. The port must be stopped before.&n; *&t;The HW is initialized with the descriptor start addresses.&n; *&n; * Returns:&n; *&t;none&n; */
DECL|function|PortReInitBmu
r_static
r_void
id|PortReInitBmu
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
r_int
id|PortIndex
)paren
multiline_comment|/* index of the port for which to re-init */
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;PortReInitBmu &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* set address of first descriptor of ring in BMU */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|TxQueueAddr
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
op_plus
id|TX_Q_CUR_DESCR_LOW
comma
(paren
r_uint32
)paren
(paren
(paren
(paren
id|caddr_t
)paren
(paren
id|pAC-&gt;TxPort
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|pTxdRingHead
)paren
op_minus
id|pAC-&gt;TxPort
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|pTxDescrRing
op_plus
id|pAC-&gt;TxPort
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|VTxDescrRing
)paren
op_amp
l_int|0xFFFFFFFF
)paren
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|TxQueueAddr
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
op_plus
id|TX_Q_DESCR_HIGH
comma
(paren
r_uint32
)paren
(paren
(paren
(paren
id|caddr_t
)paren
(paren
id|pAC-&gt;TxPort
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|pTxdRingHead
)paren
op_minus
id|pAC-&gt;TxPort
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|pTxDescrRing
op_plus
id|pAC-&gt;TxPort
(braket
id|PortIndex
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|VTxDescrRing
)paren
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|RxQueueAddr
(braket
id|PortIndex
)braket
op_plus
id|RX_Q_CUR_DESCR_LOW
comma
(paren
r_uint32
)paren
(paren
(paren
(paren
id|caddr_t
)paren
(paren
id|pAC-&gt;RxPort
(braket
id|PortIndex
)braket
dot
id|pRxdRingHead
)paren
op_minus
id|pAC-&gt;RxPort
(braket
id|PortIndex
)braket
dot
id|pRxDescrRing
op_plus
id|pAC-&gt;RxPort
(braket
id|PortIndex
)braket
dot
id|VRxDescrRing
)paren
op_amp
l_int|0xFFFFFFFF
)paren
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|RxQueueAddr
(braket
id|PortIndex
)braket
op_plus
id|RX_Q_DESCR_HIGH
comma
(paren
r_uint32
)paren
(paren
(paren
(paren
id|caddr_t
)paren
(paren
id|pAC-&gt;RxPort
(braket
id|PortIndex
)braket
dot
id|pRxdRingHead
)paren
op_minus
id|pAC-&gt;RxPort
(braket
id|PortIndex
)braket
dot
id|pRxDescrRing
op_plus
id|pAC-&gt;RxPort
(braket
id|PortIndex
)braket
dot
id|VRxDescrRing
)paren
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* PortReInitBmu */
multiline_comment|/****************************************************************************&n; *&n; *&t;SkGeIsr - handle adapter interrupts&n; *&n; * Description:&n; *&t;The interrupt routine is called when the network adapter&n; *&t;generates an interrupt. It may also be called if another device&n; *&t;shares this interrupt vector with the driver.&n; *&n; * Returns: N/A&n; *&n; */
DECL|function|SkGeIsr
r_static
r_void
id|SkGeIsr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
id|SK_AC
op_star
id|pAC
suffix:semicolon
id|SK_U32
id|IntSrc
suffix:semicolon
multiline_comment|/* interrupts source register contents */
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;&t; * Check and process if its our interrupt&n;&t; */
id|SK_IN32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_SP_ISRC
comma
op_amp
id|IntSrc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntSrc
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
id|IntSrc
op_amp
id|IRQ_MASK
)paren
op_amp
op_complement
id|SPECIAL_IRQS
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#if 0 /* software irq currently not used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_SW
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;Software IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_RX1
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF RX1 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|SK_PNMI_CNT_RX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_RX2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF RX2 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|SK_PNMI_CNT_RX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_TX_COMPLETE /* only if tx complete interrupt used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_AS_TX1
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF AS TX1 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_TX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_AS_TX2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF AS TX2 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_TX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
)brace
macro_line|#if 0 /* only if sync. queues used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_SY_TX1
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF SY TX1 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_TX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|ClearTxIrq
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_SY_TX2
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF SY TX2 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_TX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
l_int|1
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|ClearTxIrq
c_func
(paren
id|pAC
comma
l_int|1
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
)brace
macro_line|#endif /* 0 */
macro_line|#endif /* USE_TX_COMPLETE */
multiline_comment|/* do all IO at once */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_RX1
)paren
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_RX2
)paren
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef USE_TX_COMPLETE /* only if tx complete interrupt used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_AS_TX1
)paren
id|ClearTxIrq
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_LOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_AS_TX2
)paren
id|ClearTxIrq
c_func
(paren
id|pAC
comma
l_int|1
comma
id|TX_PRIO_LOW
)paren
suffix:semicolon
macro_line|#endif
id|SK_IN32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_ISRC
comma
op_amp
id|IntSrc
)paren
suffix:semicolon
)brace
multiline_comment|/* while (IntSrc &amp; IRQ_MASK != 0) */
r_if
c_cond
(paren
(paren
id|IntSrc
op_amp
id|SPECIAL_IRQS
)paren
op_logical_or
id|pAC-&gt;CheckQueue
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;SPECIAL IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pAC-&gt;CheckQueue
op_assign
id|SK_FALSE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntSrc
op_amp
id|SPECIAL_IRQS
)paren
id|SkGeSirqIsr
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|IntSrc
)paren
suffix:semicolon
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * do it all again is case we cleared an interrupt that &n;&t; * came in after handling the ring (OUTs may be delayed&n;&t; * in hardware buffers, but are through after IN)&n;&t; */
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|pAC-&gt;ActivePort
)braket
)paren
suffix:semicolon
singleline_comment|//&t;ReceiveIrq(pAC, &amp;pAC-&gt;RxPort[1]);
macro_line|#if 0
singleline_comment|// #ifdef USE_TX_COMPLETE /* only if tx complete interrupt used */
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
macro_line|#if 0&t;/* only if sync. queues used */
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
l_int|1
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|1
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
macro_line|#endif /* 0 */
macro_line|#endif /* USE_TX_COMPLETE */
multiline_comment|/* IRQ is processed - Enable IRQs again*/
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
id|IRQ_MASK
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* SkGeIsr */
multiline_comment|/****************************************************************************&n; *&n; *&t;SkGeIsrOnePort - handle adapter interrupts for single port adapter&n; *&n; * Description:&n; *&t;The interrupt routine is called when the network adapter&n; *&t;generates an interrupt. It may also be called if another device&n; *&t;shares this interrupt vector with the driver.&n; *&t;This is the same as above, but handles only one port.&n; *&n; * Returns: N/A&n; *&n; */
DECL|function|SkGeIsrOnePort
r_static
r_void
id|SkGeIsrOnePort
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
id|SK_AC
op_star
id|pAC
suffix:semicolon
id|SK_U32
id|IntSrc
suffix:semicolon
multiline_comment|/* interrupts source register contents */
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*&n;&t; * Check and process if its our interrupt&n;&t; */
id|SK_IN32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_SP_ISRC
comma
op_amp
id|IntSrc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntSrc
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
id|IntSrc
op_amp
id|IRQ_MASK
)paren
op_amp
op_complement
id|SPECIAL_IRQS
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#if 0 /* software irq currently not used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_SW
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;Software IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_RX1
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF RX1 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|SK_PNMI_CNT_RX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_TX_COMPLETE /* only if tx complete interrupt used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_AS_TX1
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF AS TX1 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_TX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
)brace
macro_line|#if 0 /* only if sync. queues used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_SY_TX1
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;EOF SY TX1 IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_TX_INTR
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|ClearTxIrq
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
)brace
macro_line|#endif /* 0 */
macro_line|#endif /* USE_TX_COMPLETE */
multiline_comment|/* do all IO at once */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_RX1
)paren
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef USE_TX_COMPLETE /* only if tx complete interrupt used */
r_if
c_cond
(paren
id|IntSrc
op_amp
id|IRQ_EOF_AS_TX1
)paren
id|ClearTxIrq
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_LOW
)paren
suffix:semicolon
macro_line|#endif
id|SK_IN32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_ISRC
comma
op_amp
id|IntSrc
)paren
suffix:semicolon
)brace
multiline_comment|/* while (IntSrc &amp; IRQ_MASK != 0) */
r_if
c_cond
(paren
(paren
id|IntSrc
op_amp
id|SPECIAL_IRQS
)paren
op_logical_or
id|pAC-&gt;CheckQueue
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_INT_SRC
comma
(paren
l_string|&quot;SPECIAL IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pAC-&gt;CheckQueue
op_assign
id|SK_FALSE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntSrc
op_amp
id|SPECIAL_IRQS
)paren
id|SkGeSirqIsr
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|IntSrc
)paren
suffix:semicolon
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * do it all again is case we cleared an interrupt that &n;&t; * came in after handling the ring (OUTs may be delayed&n;&t; * in hardware buffers, but are through after IN)&n;&t; */
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#if 0
singleline_comment|// #ifdef USE_TX_COMPLETE /* only if tx complete interrupt used */
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
macro_line|#if 0&t;/* only if sync. queues used */
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
l_int|0
comma
id|TX_PRIO_HIGH
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
l_int|0
)braket
(braket
id|TX_PRIO_HIGH
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
macro_line|#endif /* 0 */
macro_line|#endif /* USE_TX_COMPLETE */
multiline_comment|/* IRQ is processed - Enable IRQs again*/
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
id|IRQ_MASK
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* SkGeIsrOnePort */
multiline_comment|/****************************************************************************&n; *&n; *&t;SkGeOpen - handle start of initialized adapter&n; *&n; * Description:&n; *&t;This function starts the initialized adapter.&n; *&t;The board level variable is set and the adapter is&n; *&t;brought to full functionality.&n; *&t;The device flags are set for operation.&n; *&t;Do all necessary level 2 initialization, enable interrupts and&n; *&t;give start command to RLMT.&n; *&n; * Returns:&n; *&t;0 on success&n; *&t;!= 0 on error&n; */
DECL|function|SkGeOpen
r_static
r_int
id|SkGeOpen
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
multiline_comment|/* pointer to adapter context struct */
r_int
r_int
id|Flags
suffix:semicolon
multiline_comment|/* for spin lock */
r_int
id|i
suffix:semicolon
id|SK_EVPARA
id|EvPara
suffix:semicolon
multiline_comment|/* an event parameter union */
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeOpen: pAC=0x%lX:&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|pAC
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;BoardLevel
op_eq
l_int|0
)paren
(brace
multiline_comment|/* level 1 init common modules here */
r_if
c_cond
(paren
id|SkGeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: HWInit(1) failed&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|SkI2cInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkEventInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkPnmiInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkAddrInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkRlmtInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkTimerInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* level 2 init modules here */
id|SkGeInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkI2cInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkEventInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkPnmiInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkAddrInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkRlmtInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkTimerInit
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|// Enable transmit descriptor polling.
id|SkGePollTxD
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|i
comma
id|SK_TRUE
)paren
suffix:semicolon
id|FillRxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|SkGeYellowLED
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef USE_INT_MOD
singleline_comment|// moderate only TX complete interrupts (these are not time critical)
DECL|macro|IRQ_MOD_MASK
mdefine_line|#define IRQ_MOD_MASK (IRQ_EOF_AS_TX1 | IRQ_EOF_AS_TX2)
(brace
r_int
r_int
id|ModBase
suffix:semicolon
id|ModBase
op_assign
l_int|53125000
op_div
id|INTS_PER_SEC
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B2_IRQM_INI
comma
id|ModBase
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B2_IRQM_MSK
comma
id|IRQ_MOD_MASK
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B2_IRQM_CTRL
comma
id|TIM_START
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* enable Interrupts */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
id|IRQ_MASK
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_HWE_IMSK
comma
id|IRQ_HWE_MASK
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_START
comma
id|EvPara
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;RlmtMode
op_ne
l_int|0
)paren
(brace
id|EvPara.Para32
(braket
l_int|0
)braket
op_assign
id|pAC-&gt;RlmtMode
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_MODE_CHANGE
comma
id|EvPara
)paren
suffix:semicolon
)brace
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeOpen suceeded&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* SkGeOpen */
multiline_comment|/****************************************************************************&n; *&n; *&t;SkGeClose - Stop initialized adapter&n; *&n; * Description:&n; *&t;Close initialized adapter.&n; *&n; * Returns:&n; *&t;0 - on success&n; *&t;error code - on error&n; */
DECL|function|SkGeClose
r_static
r_int
id|SkGeClose
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
multiline_comment|/* for spin lock */
r_int
id|i
suffix:semicolon
id|SK_EVPARA
id|EvPara
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeClose: pAC=0x%lX &quot;
comma
(paren
r_int
r_int
)paren
id|pAC
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Clear multicast table, promiscuous mode ....&n;&t; */
id|SkAddrMcClear
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
l_int|0
)paren
suffix:semicolon
id|SkAddrPromiscuousChange
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
id|SK_PROM_MODE_NONE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
l_int|0
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_STOP
comma
id|EvPara
)paren
suffix:semicolon
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* stop the hardware */
id|SkGeDeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|pAC-&gt;BoardLevel
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* clear all descriptor rings */
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
id|ClearRxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
id|ClearTxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeClose: done &quot;
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* SkGeClose */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeXmit - Linux frame transmit function&n; *&n; * Description:&n; *&t;The system calls this function to send frames onto the wire.&n; *&t;It puts the frame in the tx descriptor ring. If the ring is&n; *&t;full then, the &squot;tbusy&squot; flag is set.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; * WARNING: returning 1 in &squot;tbusy&squot; case caused system crashes (double&n; *&t;allocated skb&squot;s) !!!&n; */
DECL|function|SkGeXmit
r_static
r_int
id|SkGeXmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_int
id|Rc
suffix:semicolon
multiline_comment|/* return code of XmitFrame */
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|Rc
op_assign
id|XmitFrame
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|pAC-&gt;ActivePort
)braket
(braket
id|TX_PRIO_LOW
)braket
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Transmitter out of resources? */
r_if
c_cond
(paren
id|Rc
op_le
l_int|0
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* If not taken, give buffer ownership back to the&n;&t; * queueing layer.&n;&t; */
r_if
c_cond
(paren
id|Rc
OL
l_int|0
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* SkGeXmit */
multiline_comment|/*****************************************************************************&n; *&n; * &t;XmitFrame - fill one socket buffer into the transmit ring&n; *&n; * Description:&n; *&t;This function puts a message into the transmit descriptor ring&n; *&t;if there is a descriptors left.&n; *&t;Linux skb&squot;s consist of only one continuous buffer.&n; *&t;The first step locks the ring. It is held locked&n; *&t;all time to avoid problems with SWITCH_../PORT_RESET.&n; *&t;Then the descriptoris allocated.&n; *&t;The second part is linking the buffer to the descriptor.&n; *&t;At the very last, the Control field of the descriptor&n; *&t;is made valid for the BMU and a start TX command is given&n; *&t;if necessary.&n; *&n; * Returns:&n; *&t;&gt; 0 - on succes: the number of bytes in the message&n; *&t;= 0 - on resource shortage: this frame sent or dropped, now&n; *        the ring is full ( -&gt; set tbusy)&n; *&t;&lt; 0 - on failure: other problems ( -&gt; return failure to upper layers)&n; */
DECL|function|XmitFrame
r_static
r_int
id|XmitFrame
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|TX_PORT
op_star
id|pTxPort
comma
multiline_comment|/* pointer to struct of port to send to */
r_struct
id|sk_buff
op_star
id|pMessage
)paren
multiline_comment|/* pointer to send-message */
(brace
id|TXD
op_star
id|pTxd
suffix:semicolon
multiline_comment|/* the rxd to fill */
r_int
r_int
id|Flags
suffix:semicolon
id|SK_U64
id|PhysAddr
suffix:semicolon
r_int
id|BytesSend
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_TX_PROGRESS
comma
(paren
l_string|&quot;X&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pTxPort-&gt;TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pTxPort-&gt;TxdRingFree
op_eq
l_int|0
)paren
(brace
multiline_comment|/* no enough free descriptors in ring at the moment */
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
id|pTxPort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pTxPort-&gt;TxdRingFree
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pTxPort-&gt;TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|SK_PNMI_CNT_NO_TX_BUF
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_TX_PROGRESS
comma
(paren
l_string|&quot;XmitFrame failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* this message can not be sent now */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* advance head counter behind descriptor needed for this frame */
id|pTxd
op_assign
id|pTxPort-&gt;pTxdRingHead
suffix:semicolon
id|pTxPort-&gt;pTxdRingHead
op_assign
id|pTxd-&gt;pNextTxd
suffix:semicolon
id|pTxPort-&gt;TxdRingFree
op_decrement
suffix:semicolon
multiline_comment|/* the needed descriptor is reserved now */
multiline_comment|/* &n;&t; * everything allocated ok, so add buffer to descriptor&n;&t; */
macro_line|#ifdef SK_DUMP_TX
id|DumpMsg
c_func
(paren
id|pMessage
comma
l_string|&quot;XmitFrame&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set up descriptor and CONTROL dword */
id|PhysAddr
op_assign
(paren
id|SK_U64
)paren
id|pci_map_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|pMessage-&gt;data
comma
id|pMessage-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|pTxd-&gt;VDataLow
op_assign
(paren
id|SK_U32
)paren
(paren
id|PhysAddr
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|pTxd-&gt;VDataHigh
op_assign
(paren
id|SK_U32
)paren
(paren
id|PhysAddr
op_rshift
l_int|32
)paren
suffix:semicolon
id|pTxd-&gt;pMBuf
op_assign
id|pMessage
suffix:semicolon
id|pTxd-&gt;TBControl
op_assign
id|TX_CTRL_OWN_BMU
op_or
id|TX_CTRL_STF
op_or
id|TX_CTRL_CHECK_DEFAULT
op_or
id|TX_CTRL_SOFTWARE
op_or
macro_line|#ifdef USE_TX_COMPLETE
id|TX_CTRL_EOF
op_or
id|TX_CTRL_EOF_IRQ
op_or
id|pMessage-&gt;len
suffix:semicolon
macro_line|#else
id|TX_CTRL_EOF
op_or
id|pMessage-&gt;len
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pTxPort-&gt;pTxdRingPrev-&gt;TBControl
op_amp
id|TX_CTRL_OWN_BMU
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* previous descriptor already done, so give tx start cmd */
multiline_comment|/* StartTx(pAC, pTxPort-&gt;HwAddr); */
id|SK_OUT8
c_func
(paren
id|pTxPort-&gt;HwAddr
comma
id|TX_Q_CTRL
comma
id|TX_Q_CTRL_START
)paren
suffix:semicolon
)brace
id|pTxPort-&gt;pTxdRingPrev
op_assign
id|pTxd
suffix:semicolon
id|BytesSend
op_assign
id|pMessage-&gt;len
suffix:semicolon
multiline_comment|/* after releasing the lock, the skb may be immidiately freed */
r_if
c_cond
(paren
id|pTxPort-&gt;TxdRingFree
op_ne
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pTxPort-&gt;TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
r_return
(paren
id|BytesSend
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ring full: set tbusy on return */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pTxPort-&gt;TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* XmitFrame */
multiline_comment|/*****************************************************************************&n; *&n; * &t;FreeTxDescriptors - release descriptors from the descriptor ring&n; *&n; * Description:&n; *&t;This function releases descriptors from a transmit ring if they&n; *&t;have been sent by the BMU.&n; *&t;If a descriptors is sent, it can be freed and the message can&n; *&t;be freed, too.&n; *&t;The SOFTWARE controllable bit is used to prevent running around a&n; *&t;completely free ring for ever. If this bit is no set in the&n; *&t;frame (by XmitFrame), this frame has never been sent or is&n; *&t;already freed.&n; *&t;The Tx descriptor ring lock must be held while calling this function !!!&n; *&n; * Returns:&n; *&t;none&n; */
DECL|function|FreeTxDescriptors
r_static
r_void
id|FreeTxDescriptors
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context */
id|TX_PORT
op_star
id|pTxPort
)paren
multiline_comment|/* pointer to destination port structure */
(brace
id|TXD
op_star
id|pTxd
suffix:semicolon
multiline_comment|/* pointer to the checked descriptor */
id|TXD
op_star
id|pNewTail
suffix:semicolon
multiline_comment|/* pointer to &squot;end&squot; of the ring */
id|SK_U32
id|Control
suffix:semicolon
multiline_comment|/* TBControl field of descriptor */
id|SK_U64
id|PhysAddr
suffix:semicolon
multiline_comment|/* address of DMA mapping */
id|pNewTail
op_assign
id|pTxPort-&gt;pTxdRingTail
suffix:semicolon
id|pTxd
op_assign
id|pNewTail
suffix:semicolon
multiline_comment|/* &n;&t; * loop forever; exits if TX_CTRL_SOFTWARE bit not set in start frame&n;&t; * or TX_CTRL_OWN_BMU bit set in any frame&n;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|Control
op_assign
id|pTxd-&gt;TBControl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Control
op_amp
id|TX_CTRL_SOFTWARE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * software controllable bit is set in first&n;&t;&t;&t; * fragment when given to BMU. Not set means that&n;&t;&t;&t; * this fragment was never sent or is already &n;&t;&t;&t; * freed ( -&gt; ring completely free now).&n;&t;&t;&t; */
id|pTxPort-&gt;pTxdRingTail
op_assign
id|pTxd
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|pAC-&gt;dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Control
op_amp
id|TX_CTRL_OWN_BMU
)paren
(brace
id|pTxPort-&gt;pTxdRingTail
op_assign
id|pTxd
suffix:semicolon
r_if
c_cond
(paren
id|pTxPort-&gt;TxdRingFree
OG
l_int|0
)paren
(brace
id|netif_start_queue
c_func
(paren
id|pAC-&gt;dev
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* release the DMA mapping */
id|PhysAddr
op_assign
(paren
(paren
id|SK_U64
)paren
id|pTxd-&gt;VDataHigh
)paren
op_lshift
(paren
id|SK_U64
)paren
l_int|32
suffix:semicolon
id|PhysAddr
op_or_assign
(paren
id|SK_U64
)paren
id|pTxd-&gt;VDataLow
suffix:semicolon
id|pci_unmap_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PhysAddr
comma
id|pTxd-&gt;pMBuf-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
multiline_comment|/* free message */
id|DEV_KFREE_SKB_ANY
c_func
(paren
id|pTxd-&gt;pMBuf
)paren
suffix:semicolon
id|pTxPort-&gt;TxdRingFree
op_increment
suffix:semicolon
id|pTxd-&gt;TBControl
op_and_assign
op_complement
id|TX_CTRL_SOFTWARE
suffix:semicolon
id|pTxd
op_assign
id|pTxd-&gt;pNextTxd
suffix:semicolon
multiline_comment|/* point behind fragment with EOF */
)brace
multiline_comment|/* while(forever) */
)brace
multiline_comment|/* FreeTxDescriptors */
multiline_comment|/*****************************************************************************&n; *&n; * &t;FillRxRing - fill the receive ring with valid descriptors&n; *&n; * Description:&n; *&t;This function fills the receive ring descriptors with data&n; *&t;segments and makes them valid for the BMU.&n; *&t;The active ring is filled completely, if possible.&n; *&t;The non-active ring is filled only partial to save memory.&n; *&n; * Description of rx ring structure:&n; *&t;head - points to the descriptor which will be used next by the BMU&n; *&t;tail - points to the next descriptor to give to the BMU&n; *&t;&n; * Returns:&t;N/A&n; */
DECL|function|FillRxRing
r_static
r_void
id|FillRxRing
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context */
id|RX_PORT
op_star
id|pRxPort
)paren
multiline_comment|/* ptr to port struct for which the ring&n;&t;&t;&t;&t;   should be filled */
(brace
r_int
r_int
id|Flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pRxPort-&gt;RxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pRxPort-&gt;RxdRingFree
OG
id|pRxPort-&gt;RxFillLimit
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|FillRxDescriptor
c_func
(paren
id|pAC
comma
id|pRxPort
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pRxPort-&gt;RxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
)brace
multiline_comment|/* FillRxRing */
multiline_comment|/*****************************************************************************&n; *&n; * &t;FillRxDescriptor - fill one buffer into the receive ring&n; *&n; * Description:&n; *&t;The function allocates a new receive buffer and&n; *&t;puts it into the next descriptor.&n; *&n; * Returns:&n; *&t;SK_TRUE - a buffer was added to the ring&n; *&t;SK_FALSE - a buffer could not be added&n; */
DECL|function|FillRxDescriptor
r_static
id|SK_BOOL
id|FillRxDescriptor
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context struct */
id|RX_PORT
op_star
id|pRxPort
)paren
multiline_comment|/* ptr to port struct of ring to fill */
(brace
r_struct
id|sk_buff
op_star
id|pMsgBlock
suffix:semicolon
multiline_comment|/* pointer to a new message block */
id|RXD
op_star
id|pRxd
suffix:semicolon
multiline_comment|/* the rxd to fill */
id|SK_U16
id|Length
suffix:semicolon
multiline_comment|/* data fragment length */
id|SK_U64
id|PhysAddr
suffix:semicolon
multiline_comment|/* physical address of a rx buffer */
id|pMsgBlock
op_assign
id|alloc_skb
c_func
(paren
id|pAC-&gt;RxBufSize
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsgBlock
op_eq
l_int|NULL
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;%s: Allocation of rx buffer failed !&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
)paren
suffix:semicolon
id|SK_PNMI_CNT_NO_RX_BUF
c_func
(paren
id|pAC
)paren
suffix:semicolon
r_return
id|SK_FALSE
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|pMsgBlock
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* to align IP frames */
multiline_comment|/* skb allocated ok, so add buffer */
id|pRxd
op_assign
id|pRxPort-&gt;pRxdRingTail
suffix:semicolon
id|pRxPort-&gt;pRxdRingTail
op_assign
id|pRxd-&gt;pNextRxd
suffix:semicolon
id|pRxPort-&gt;RxdRingFree
op_decrement
suffix:semicolon
id|Length
op_assign
id|pAC-&gt;RxBufSize
suffix:semicolon
id|PhysAddr
op_assign
(paren
id|SK_U64
)paren
id|pci_map_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|pMsgBlock-&gt;data
comma
id|pAC-&gt;RxBufSize
op_minus
l_int|2
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pRxd-&gt;VDataLow
op_assign
(paren
id|SK_U32
)paren
(paren
id|PhysAddr
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|pRxd-&gt;VDataHigh
op_assign
(paren
id|SK_U32
)paren
(paren
id|PhysAddr
op_rshift
l_int|32
)paren
suffix:semicolon
id|pRxd-&gt;pMBuf
op_assign
id|pMsgBlock
suffix:semicolon
id|pRxd-&gt;RBControl
op_assign
id|RX_CTRL_OWN_BMU
op_or
id|RX_CTRL_STF
op_or
id|RX_CTRL_EOF_IRQ
op_or
id|RX_CTRL_CHECK_CSUM
op_or
id|Length
suffix:semicolon
r_return
(paren
id|SK_TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/* FillRxDescriptor */
multiline_comment|/*****************************************************************************&n; *&n; * &t;ReQueueRxBuffer - fill one buffer back into the receive ring&n; *&n; * Description:&n; *&t;Fill a given buffer back into the rx ring. The buffer&n; *&t;has been previously allocated and aligned, and its phys.&n; *&t;address calculated, so this is no more necessary.&n; *&n; * Returns: N/A&n; */
DECL|function|ReQueueRxBuffer
r_static
r_void
id|ReQueueRxBuffer
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context struct */
id|RX_PORT
op_star
id|pRxPort
comma
multiline_comment|/* ptr to port struct of ring to fill */
r_struct
id|sk_buff
op_star
id|pMsg
comma
multiline_comment|/* pointer to the buffer */
id|SK_U32
id|PhysHigh
comma
multiline_comment|/* phys address high dword */
id|SK_U32
id|PhysLow
)paren
multiline_comment|/* phys address low dword */
(brace
id|RXD
op_star
id|pRxd
suffix:semicolon
multiline_comment|/* the rxd to fill */
id|SK_U16
id|Length
suffix:semicolon
multiline_comment|/* data fragment length */
id|pRxd
op_assign
id|pRxPort-&gt;pRxdRingTail
suffix:semicolon
id|pRxPort-&gt;pRxdRingTail
op_assign
id|pRxd-&gt;pNextRxd
suffix:semicolon
id|pRxPort-&gt;RxdRingFree
op_decrement
suffix:semicolon
id|Length
op_assign
id|pAC-&gt;RxBufSize
suffix:semicolon
id|pRxd-&gt;VDataLow
op_assign
id|PhysLow
suffix:semicolon
id|pRxd-&gt;VDataHigh
op_assign
id|PhysHigh
suffix:semicolon
id|pRxd-&gt;pMBuf
op_assign
id|pMsg
suffix:semicolon
id|pRxd-&gt;RBControl
op_assign
id|RX_CTRL_OWN_BMU
op_or
id|RX_CTRL_STF
op_or
id|RX_CTRL_EOF_IRQ
op_or
id|RX_CTRL_CHECK_CSUM
op_or
id|Length
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ReQueueRxBuffer */
multiline_comment|/*****************************************************************************&n; *&n; * &t;ReceiveIrq - handle a receive IRQ&n; *&n; * Description:&n; *&t;This function is called when a receive IRQ is set.&n; *&t;It walks the receive descriptor ring and sends up all&n; *&t;frames that are complete.&n; *&n; * Returns:&t;N/A&n; */
DECL|function|ReceiveIrq
r_static
r_void
id|ReceiveIrq
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|RX_PORT
op_star
id|pRxPort
)paren
multiline_comment|/* pointer to receive port struct */
(brace
id|RXD
op_star
id|pRxd
suffix:semicolon
multiline_comment|/* pointer to receive descriptors */
id|SK_U32
id|Control
suffix:semicolon
multiline_comment|/* control field of descriptor */
r_struct
id|sk_buff
op_star
id|pMsg
suffix:semicolon
multiline_comment|/* pointer to message holding frame */
r_struct
id|sk_buff
op_star
id|pNewMsg
suffix:semicolon
multiline_comment|/* pointer to a new message for copying frame */
r_int
id|FrameLength
suffix:semicolon
multiline_comment|/* total length of received frame */
id|SK_MBUF
op_star
id|pRlmtMbuf
suffix:semicolon
multiline_comment|/* ptr to a buffer for giving a frame to rlmt */
id|SK_EVPARA
id|EvPara
suffix:semicolon
multiline_comment|/* an event parameter union */
r_int
id|PortIndex
op_assign
id|pRxPort-&gt;PortIndex
suffix:semicolon
r_int
r_int
id|Offset
suffix:semicolon
r_int
r_int
id|NumBytes
suffix:semicolon
r_int
r_int
id|ForRlmt
suffix:semicolon
id|SK_BOOL
id|IsBc
suffix:semicolon
id|SK_BOOL
id|IsMc
suffix:semicolon
id|SK_U32
id|FrameStat
suffix:semicolon
r_int
r_int
id|Csum1
suffix:semicolon
r_int
r_int
id|Csum2
suffix:semicolon
r_int
r_int
id|Type
suffix:semicolon
r_int
id|Result
suffix:semicolon
id|SK_U64
id|PhysAddr
suffix:semicolon
id|rx_start
suffix:colon
multiline_comment|/* do forever; exit if RX_CTRL_OWN_BMU found */
r_while
c_loop
(paren
id|pRxPort-&gt;RxdRingFree
OL
id|pAC-&gt;RxDescrPerRing
)paren
(brace
id|pRxd
op_assign
id|pRxPort-&gt;pRxdRingHead
suffix:semicolon
id|Control
op_assign
id|pRxd-&gt;RBControl
suffix:semicolon
multiline_comment|/* check if this descriptor is ready */
r_if
c_cond
(paren
(paren
id|Control
op_amp
id|RX_CTRL_OWN_BMU
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* this descriptor is not yet ready */
id|FillRxRing
c_func
(paren
id|pAC
comma
id|pRxPort
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* get length of frame and check it */
id|FrameLength
op_assign
id|Control
op_amp
id|RX_CTRL_LEN_MASK
suffix:semicolon
r_if
c_cond
(paren
id|FrameLength
OG
id|pAC-&gt;RxBufSize
)paren
r_goto
id|rx_failed
suffix:semicolon
multiline_comment|/* check for STF and EOF */
r_if
c_cond
(paren
(paren
id|Control
op_amp
(paren
id|RX_CTRL_STF
op_or
id|RX_CTRL_EOF
)paren
)paren
op_ne
(paren
id|RX_CTRL_STF
op_or
id|RX_CTRL_EOF
)paren
)paren
r_goto
id|rx_failed
suffix:semicolon
multiline_comment|/* here we have a complete frame in the ring */
id|pMsg
op_assign
id|pRxd-&gt;pMBuf
suffix:semicolon
multiline_comment|/*&n;&t;&t; * if short frame then copy data to reduce memory waste&n;&t;&t; */
id|pNewMsg
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|FrameLength
OL
id|SK_COPY_THRESHOLD
)paren
(brace
id|pNewMsg
op_assign
id|alloc_skb
c_func
(paren
id|FrameLength
op_plus
l_int|2
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pNewMsg
op_ne
l_int|NULL
)paren
(brace
id|PhysAddr
op_assign
(paren
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataHigh
)paren
op_lshift
(paren
id|SK_U64
)paren
l_int|32
suffix:semicolon
id|PhysAddr
op_or_assign
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataLow
suffix:semicolon
multiline_comment|/* use new skb and copy data */
id|skb_reserve
c_func
(paren
id|pNewMsg
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|pNewMsg
comma
id|FrameLength
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
(paren
id|dma_addr_t
)paren
id|PhysAddr
comma
id|FrameLength
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|pNewMsg
comma
id|pMsg-&gt;data
comma
id|FrameLength
comma
l_int|0
)paren
suffix:semicolon
id|ReQueueRxBuffer
c_func
(paren
id|pAC
comma
id|pRxPort
comma
id|pMsg
comma
id|pRxd-&gt;VDataHigh
comma
id|pRxd-&gt;VDataLow
)paren
suffix:semicolon
id|pMsg
op_assign
id|pNewMsg
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * if large frame, or SKB allocation failed, pass&n;&t;&t; * the SKB directly to the networking&n;&t;&t; */
r_if
c_cond
(paren
id|pNewMsg
op_eq
l_int|NULL
)paren
(brace
id|PhysAddr
op_assign
(paren
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataHigh
)paren
op_lshift
(paren
id|SK_U64
)paren
l_int|32
suffix:semicolon
id|PhysAddr
op_or_assign
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataLow
suffix:semicolon
multiline_comment|/* release the DMA mapping */
id|pci_unmap_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PhysAddr
comma
id|pAC-&gt;RxBufSize
op_minus
l_int|2
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/* set length in message */
id|skb_put
c_func
(paren
id|pMsg
comma
id|FrameLength
)paren
suffix:semicolon
multiline_comment|/* hardware checksum */
id|Type
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
r_int
op_star
)paren
op_amp
id|pMsg-&gt;data
(braket
l_int|12
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Type
op_eq
l_int|0x800
)paren
(brace
id|Csum1
op_assign
id|le16_to_cpu
c_func
(paren
id|pRxd-&gt;TcpSums
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|Csum2
op_assign
id|le16_to_cpu
c_func
(paren
(paren
id|pRxd-&gt;TcpSums
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Csum1
op_amp
l_int|0xfffe
)paren
op_logical_and
(paren
id|Csum2
op_amp
l_int|0xfffe
)paren
)paren
(brace
id|Result
op_assign
id|SkCsGetReceiveInfo
c_func
(paren
id|pAC
comma
op_amp
id|pMsg-&gt;data
(braket
l_int|14
)braket
comma
id|Csum1
comma
id|Csum2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Result
op_eq
id|SKCS_STATUS_IP_FRAGMENT
op_logical_or
id|Result
op_eq
id|SKCS_STATUS_IP_CSUM_OK
op_logical_or
id|Result
op_eq
id|SKCS_STATUS_TCP_CSUM_OK
op_logical_or
id|Result
op_eq
id|SKCS_STATUS_UDP_CSUM_OK
)paren
(brace
id|pMsg-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
)brace
multiline_comment|/* checksum calculation valid */
)brace
multiline_comment|/* IP frame */
)brace
multiline_comment|/* frame &gt; SK_COPY_TRESHOLD */
id|FrameStat
op_assign
id|pRxd-&gt;FrameStat
suffix:semicolon
r_if
c_cond
(paren
(paren
id|FrameStat
op_amp
id|XMR_FS_LNG_ERR
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* jumbo frame, count to correct statistic */
id|SK_PNMI_CNT_RX_LONGFRAMES
c_func
(paren
id|pAC
comma
id|pRxPort-&gt;PortIndex
)paren
suffix:semicolon
)brace
id|pRxd
op_assign
id|pRxd-&gt;pNextRxd
suffix:semicolon
id|pRxPort-&gt;pRxdRingHead
op_assign
id|pRxd
suffix:semicolon
id|pRxPort-&gt;RxdRingFree
op_increment
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;Received frame of length %d on port %d&bslash;n&quot;
comma
id|FrameLength
comma
id|PortIndex
)paren
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;Number of free rx descriptors: %d&bslash;n&quot;
comma
id|pRxPort-&gt;RxdRingFree
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Control
op_amp
id|RX_CTRL_STAT_VALID
)paren
op_eq
id|RX_CTRL_STAT_VALID
op_logical_and
(paren
id|FrameStat
op_amp
id|XMR_FS_ANY_ERR
)paren
op_eq
l_int|0
)paren
(brace
singleline_comment|// was the following, changed to allow VLAN support
singleline_comment|// (XMR_FS_ANY_ERR | XMR_FS_1L_VLAN | XMR_FS_2L_VLAN)
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;V&quot;
)paren
)paren
suffix:semicolon
id|ForRlmt
op_assign
id|SK_RLMT_RX_PROTOCOL
suffix:semicolon
id|IsBc
op_assign
(paren
id|FrameStat
op_amp
id|XMR_FS_BC
)paren
op_eq
id|XMR_FS_BC
suffix:semicolon
id|SK_RLMT_PRE_LOOKAHEAD
c_func
(paren
id|pAC
comma
id|PortIndex
comma
id|FrameLength
comma
id|IsBc
comma
op_amp
id|Offset
comma
op_amp
id|NumBytes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NumBytes
op_ne
l_int|0
)paren
(brace
id|IsMc
op_assign
(paren
id|FrameStat
op_amp
id|XMR_FS_MC
)paren
op_eq
id|XMR_FS_MC
suffix:semicolon
id|SK_RLMT_LOOKAHEAD
c_func
(paren
id|pAC
comma
id|PortIndex
comma
op_amp
id|pMsg-&gt;data
(braket
id|Offset
)braket
comma
id|IsBc
comma
id|IsMc
comma
op_amp
id|ForRlmt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ForRlmt
op_eq
id|SK_RLMT_RX_PROTOCOL
)paren
(brace
multiline_comment|/* send up only frames from active port */
r_if
c_cond
(paren
id|PortIndex
op_eq
id|pAC-&gt;ActivePort
)paren
(brace
multiline_comment|/* frame for upper layer */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;U&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifdef DUMP_RX
id|DumpMsg
c_func
(paren
id|pMsg
comma
l_string|&quot;Rx&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pMsg-&gt;dev
op_assign
id|pAC-&gt;dev
suffix:semicolon
id|pMsg-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|pMsg
comma
id|pAC-&gt;dev
)paren
suffix:semicolon
id|SK_PNMI_CNT_RX_OCTETS_DELIVERED
c_func
(paren
id|pAC
comma
id|FrameLength
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|pMsg
)paren
suffix:semicolon
id|pAC-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* drop frame */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;D&quot;
)paren
)paren
suffix:semicolon
id|DEV_KFREE_SKB_IRQ
c_func
(paren
id|pMsg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* if not for rlmt */
r_else
(brace
multiline_comment|/* packet for rlmt */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;R&quot;
)paren
)paren
suffix:semicolon
id|pRlmtMbuf
op_assign
id|SkDrvAllocRlmtMbuf
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|FrameLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pRlmtMbuf
op_ne
l_int|NULL
)paren
(brace
id|pRlmtMbuf-&gt;pNext
op_assign
l_int|NULL
suffix:semicolon
id|pRlmtMbuf-&gt;Length
op_assign
id|FrameLength
suffix:semicolon
id|pRlmtMbuf-&gt;PortIdx
op_assign
id|PortIndex
suffix:semicolon
id|EvPara.pParaPtr
op_assign
id|pRlmtMbuf
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|pRlmtMbuf-&gt;pData
)paren
comma
(paren
r_char
op_star
)paren
(paren
id|pMsg-&gt;data
)paren
comma
id|FrameLength
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_PACKET_RECEIVED
comma
id|EvPara
)paren
suffix:semicolon
id|pAC-&gt;CheckQueue
op_assign
id|SK_TRUE
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;Q&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pAC-&gt;dev-&gt;flags
op_amp
(paren
id|IFF_PROMISC
op_or
id|IFF_ALLMULTI
)paren
)paren
op_ne
l_int|0
op_logical_or
(paren
id|ForRlmt
op_amp
id|SK_RLMT_RX_PROTOCOL
)paren
op_eq
id|SK_RLMT_RX_PROTOCOL
)paren
(brace
id|pMsg-&gt;dev
op_assign
id|pAC-&gt;dev
suffix:semicolon
id|pMsg-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|pMsg
comma
id|pAC-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|pMsg
)paren
suffix:semicolon
id|pAC-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
id|DEV_KFREE_SKB_IRQ
c_func
(paren
id|pMsg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* if packet for rlmt */
)brace
multiline_comment|/* if valid frame */
r_else
(brace
multiline_comment|/* there is a receive error in this frame */
r_if
c_cond
(paren
(paren
id|FrameStat
op_amp
id|XMR_FS_1L_VLAN
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Received frame&quot;
l_string|&quot; with VLAN Level 1 header, check&quot;
l_string|&quot; switch configuration&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|FrameStat
op_amp
id|XMR_FS_2L_VLAN
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Received frame&quot;
l_string|&quot; with VLAN Level 2 header, check&quot;
l_string|&quot; switch configuration&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_RX_PROGRESS
comma
(paren
l_string|&quot;skge: Error in received frame, dropped!&bslash;n&quot;
l_string|&quot;Control: %x&bslash;nRxStat: %x&bslash;n&quot;
comma
id|Control
comma
id|FrameStat
)paren
)paren
suffix:semicolon
id|DEV_KFREE_SKB_IRQ
c_func
(paren
id|pMsg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* while */
id|FillRxRing
c_func
(paren
id|pAC
comma
id|pRxPort
)paren
suffix:semicolon
multiline_comment|/* do not start if called from Close */
r_if
c_cond
(paren
id|pAC-&gt;BoardLevel
OG
l_int|0
)paren
(brace
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
id|PortIndex
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|rx_failed
suffix:colon
multiline_comment|/* remove error frame */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ERROR
comma
(paren
l_string|&quot;Schrottdescriptor, length: 0x%x&bslash;n&quot;
comma
id|FrameLength
)paren
)paren
suffix:semicolon
multiline_comment|/* release the DMA mapping */
id|PhysAddr
op_assign
(paren
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataHigh
)paren
op_lshift
(paren
id|SK_U64
)paren
l_int|32
suffix:semicolon
id|PhysAddr
op_or_assign
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataLow
suffix:semicolon
id|pci_unmap_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PhysAddr
comma
id|pAC-&gt;RxBufSize
op_minus
l_int|2
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|DEV_KFREE_SKB_IRQ
c_func
(paren
id|pRxd-&gt;pMBuf
)paren
suffix:semicolon
id|pRxd-&gt;pMBuf
op_assign
l_int|NULL
suffix:semicolon
id|pRxPort-&gt;RxdRingFree
op_increment
suffix:semicolon
id|pRxPort-&gt;pRxdRingHead
op_assign
id|pRxd-&gt;pNextRxd
suffix:semicolon
r_goto
id|rx_start
suffix:semicolon
)brace
multiline_comment|/* ReceiveIrq */
multiline_comment|/*****************************************************************************&n; *&n; * &t;ClearAndStartRx - give a start receive command to BMU, clear IRQ&n; *&n; * Description:&n; *&t;This function sends a start command and a clear interrupt&n; *&t;command for one receive queue to the BMU.&n; *&n; * Returns: N/A&n; *&t;none&n; */
DECL|function|ClearAndStartRx
r_static
r_void
id|ClearAndStartRx
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context */
r_int
id|PortIndex
)paren
multiline_comment|/* index of the receive port (XMAC) */
(brace
id|SK_OUT8
c_func
(paren
id|pAC-&gt;IoBase
comma
id|RxQueueAddr
(braket
id|PortIndex
)braket
op_plus
id|RX_Q_CTRL
comma
id|RX_Q_CTRL_START
op_or
id|RX_Q_CTRL_CLR_I_EOF
)paren
suffix:semicolon
)brace
multiline_comment|/* ClearAndStartRx */
multiline_comment|/*****************************************************************************&n; *&n; * &t;ClearTxIrq - give a clear transmit IRQ command to BMU&n; *&n; * Description:&n; *&t;This function sends a clear tx IRQ command for one&n; *&t;transmit queue to the BMU.&n; *&n; * Returns: N/A&n; */
DECL|function|ClearTxIrq
r_static
r_void
id|ClearTxIrq
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context */
r_int
id|PortIndex
comma
multiline_comment|/* index of the transmit port (XMAC) */
r_int
id|Prio
)paren
multiline_comment|/* priority or normal queue */
(brace
id|SK_OUT8
c_func
(paren
id|pAC-&gt;IoBase
comma
id|TxQueueAddr
(braket
id|PortIndex
)braket
(braket
id|Prio
)braket
op_plus
id|TX_Q_CTRL
comma
id|TX_Q_CTRL_CLR_I_EOF
)paren
suffix:semicolon
)brace
multiline_comment|/* ClearTxIrq */
multiline_comment|/*****************************************************************************&n; *&n; * &t;ClearRxRing - remove all buffers from the receive ring&n; *&n; * Description:&n; *&t;This function removes all receive buffers from the ring.&n; *&t;The receive BMU must be stopped before calling this function.&n; *&n; * Returns: N/A&n; */
DECL|function|ClearRxRing
r_static
r_void
id|ClearRxRing
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|RX_PORT
op_star
id|pRxPort
)paren
multiline_comment|/* pointer to rx port struct */
(brace
id|RXD
op_star
id|pRxd
suffix:semicolon
multiline_comment|/* pointer to the current descriptor */
r_int
r_int
id|Flags
suffix:semicolon
id|SK_U64
id|PhysAddr
suffix:semicolon
r_if
c_cond
(paren
id|pRxPort-&gt;RxdRingFree
op_eq
id|pAC-&gt;RxDescrPerRing
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pRxPort-&gt;RxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|pRxd
op_assign
id|pRxPort-&gt;pRxdRingHead
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|pRxd-&gt;pMBuf
op_ne
l_int|NULL
)paren
(brace
id|PhysAddr
op_assign
(paren
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataHigh
)paren
op_lshift
(paren
id|SK_U64
)paren
l_int|32
suffix:semicolon
id|PhysAddr
op_or_assign
(paren
id|SK_U64
)paren
id|pRxd-&gt;VDataLow
suffix:semicolon
id|pci_unmap_single
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PhysAddr
comma
id|pAC-&gt;RxBufSize
op_minus
l_int|2
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|DEV_KFREE_SKB
c_func
(paren
id|pRxd-&gt;pMBuf
)paren
suffix:semicolon
id|pRxd-&gt;pMBuf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pRxd-&gt;RBControl
op_and_assign
id|RX_CTRL_OWN_BMU
suffix:semicolon
id|pRxd
op_assign
id|pRxd-&gt;pNextRxd
suffix:semicolon
id|pRxPort-&gt;RxdRingFree
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pRxd
op_ne
id|pRxPort-&gt;pRxdRingTail
)paren
suffix:semicolon
id|pRxPort-&gt;pRxdRingTail
op_assign
id|pRxPort-&gt;pRxdRingHead
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pRxPort-&gt;RxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ClearRxRing */
multiline_comment|/*****************************************************************************&n; *&n; *&t;ClearTxRing - remove all buffers from the transmit ring&n; *&n; * Description:&n; *&t;This function removes all transmit buffers from the ring.&n; *&t;The transmit BMU must be stopped before calling this function&n; *&t;and transmitting at the upper level must be disabled.&n; *&t;The BMU own bit of all descriptors is cleared, the rest is&n; *&t;done by calling FreeTxDescriptors.&n; *&n; * Returns: N/A&n; */
DECL|function|ClearTxRing
r_static
r_void
id|ClearTxRing
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|TX_PORT
op_star
id|pTxPort
)paren
multiline_comment|/* pointer to tx prt struct */
(brace
id|TXD
op_star
id|pTxd
suffix:semicolon
multiline_comment|/* pointer to the current descriptor */
r_int
id|i
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pTxPort-&gt;TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|pTxd
op_assign
id|pTxPort-&gt;pTxdRingHead
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;TxDescrPerRing
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pTxd-&gt;TBControl
op_and_assign
op_complement
id|TX_CTRL_OWN_BMU
suffix:semicolon
id|pTxd
op_assign
id|pTxd-&gt;pNextTxd
suffix:semicolon
)brace
id|FreeTxDescriptors
c_func
(paren
id|pAC
comma
id|pTxPort
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pTxPort-&gt;TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ClearTxRing */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SetQueueSizes - configure the sizes of rx and tx queues&n; *&n; * Description:&n; *&t;This function assigns the sizes for active and passive port&n; *&t;to the appropriate HWinit structure variables.&n; *&t;The passive port(s) get standard values, all remaining RAM&n; *&t;is given to the active port.&n; *&t;The queue sizes are in kbyte and must be multiple of 8.&n; *&t;The limits for the number of buffers filled into the rx rings&n; *&t;is also set in this routine.&n; *&n; * Returns:&n; *&t;none&n; */
DECL|function|SetQueueSizes
r_static
r_void
id|SetQueueSizes
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
multiline_comment|/* pointer to the adapter context */
(brace
r_int
id|StandbyRam
suffix:semicolon
multiline_comment|/* adapter RAM used for a standby port */
r_int
id|RemainingRam
suffix:semicolon
multiline_comment|/* adapter RAM available for the active port */
r_int
id|RxRam
suffix:semicolon
multiline_comment|/* RAM used for the active port receive queue */
r_int
id|i
suffix:semicolon
multiline_comment|/* loop counter */
id|StandbyRam
op_assign
id|SK_RLMT_STANDBY_QRXSIZE
op_plus
id|SK_RLMT_STANDBY_QXASIZE
op_plus
id|SK_RLMT_STANDBY_QXSSIZE
suffix:semicolon
id|RemainingRam
op_assign
id|pAC-&gt;GIni.GIRamSize
op_minus
(paren
id|pAC-&gt;GIni.GIMacsFound
op_minus
l_int|1
)paren
op_star
id|StandbyRam
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PRxQSize
op_assign
id|SK_RLMT_STANDBY_QRXSIZE
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PXSQSize
op_assign
id|SK_RLMT_STANDBY_QXSSIZE
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PXAQSize
op_assign
id|SK_RLMT_STANDBY_QXASIZE
suffix:semicolon
)brace
id|RxRam
op_assign
(paren
id|RemainingRam
op_star
l_int|8
op_div
l_int|10
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
id|pAC-&gt;ActivePort
)braket
dot
id|PRxQSize
op_assign
id|RxRam
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
id|pAC-&gt;ActivePort
)braket
dot
id|PXSQSize
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
id|pAC-&gt;ActivePort
)braket
dot
id|PXAQSize
op_assign
(paren
id|RemainingRam
op_minus
id|RxRam
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
id|pAC-&gt;RxQueueSize
op_assign
id|RxRam
suffix:semicolon
id|pAC-&gt;TxSQueueSize
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;TxAQueueSize
op_assign
(paren
id|RemainingRam
op_minus
id|RxRam
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;queue sizes settings - rx:%d  txA:%d txS:%d&bslash;n&quot;
comma
id|pAC-&gt;RxQueueSize
comma
id|pAC-&gt;TxAQueueSize
comma
id|pAC-&gt;TxSQueueSize
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SK_MAX_MACS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxFillLimit
op_assign
id|pAC-&gt;RxDescrPerRing
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxFillLimit
op_assign
id|pAC-&gt;RxDescrPerRing
op_minus
l_int|100
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Do not set the Limit to 0, because this could cause&n;&t; * wrap around with ReQueue&squot;ed buffers (a buffer could&n;&t; * be requeued in the same position, made accessable to&n;&t; * the hardware, and the hardware could change its&n;&t; * contents!&n;&t; */
id|pAC-&gt;RxPort
(braket
id|pAC-&gt;ActivePort
)braket
dot
id|RxFillLimit
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_TX_PROGRESS
comma
(paren
l_string|&quot;i: %d,  RxQSize: %d,  PXSQsize: %d, PXAQSize: %d&bslash;n&quot;
comma
id|i
comma
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PRxQSize
comma
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PXSQSize
comma
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PXAQSize
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* SetQueueSizes */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeSetMacAddr - Set the hardware MAC address&n; *&n; * Description:&n; *&t;This function sets the MAC address used by the adapter.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|SkGeSetMacAddr
r_static
r_int
id|SkGeSetMacAddr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
(brace
id|SK_AC
op_star
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sockaddr
op_star
id|addr
op_assign
id|p
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeSetMacAddr starts now...&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|addr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|SkAddrOverride
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
(paren
id|SK_MAC_ADDR
op_star
)paren
id|dev-&gt;dev_addr
comma
id|SK_ADDR_VIRTUAL_ADDRESS
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkGeSetMacAddr */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeSetRxMode - set receive mode&n; *&n; * Description:&n; *&t;This function sets the receive mode of an adapter. The adapter&n; *&t;supports promiscuous mode, allmulticast mode and a number of&n; *&t;multicast addresses. If more multicast addresses the available&n; *&t;are selected, a hash function in the hardware is used.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|SkGeSetRxMode
r_static
r_void
id|SkGeSetRxMode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|pMcList
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeSetRxMode starts now... &quot;
)paren
)paren
suffix:semicolon
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;PROMISCUOUS mode&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SkAddrPromiscuousChange
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
id|SK_PROM_MODE_LLC
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;ALLMULTI mode&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SkAddrPromiscuousChange
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
id|SK_PROM_MODE_ALL_MC
)paren
suffix:semicolon
)brace
r_else
(brace
id|SkAddrPromiscuousChange
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
id|SK_PROM_MODE_NONE
)paren
suffix:semicolon
id|SkAddrMcClear
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
l_int|0
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;Number of MC entries: %d &quot;
comma
id|dev-&gt;mc_count
)paren
)paren
suffix:semicolon
id|pMcList
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|pMcList
op_assign
id|pMcList-&gt;next
)paren
(brace
id|SkAddrMcAdd
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
comma
(paren
id|SK_MAC_ADDR
op_star
)paren
id|pMcList-&gt;dmi_addr
comma
l_int|0
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_MCA
comma
(paren
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|pMcList-&gt;dmi_addr
(braket
l_int|0
)braket
comma
id|pMcList-&gt;dmi_addr
(braket
l_int|1
)braket
comma
id|pMcList-&gt;dmi_addr
(braket
l_int|2
)braket
comma
id|pMcList-&gt;dmi_addr
(braket
l_int|3
)braket
comma
id|pMcList-&gt;dmi_addr
(braket
l_int|4
)braket
comma
id|pMcList-&gt;dmi_addr
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
)brace
id|SkAddrMcUpdate
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pAC-&gt;ActivePort
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* SkGeSetRxMode */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeChangeMtu - set the MTU to another value&n; *&n; * Description:&n; *&t;This function sets is called whenever the MTU size is changed&n; *&t;(ifconfig mtu xxx dev ethX). If the MTU is bigger than standard&n; *&t;ethernet MTU size, long frame support is activated.&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|SkGeChangeMtu
r_static
r_int
id|SkGeChangeMtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|NewMtu
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SK_EVPARA
id|EvPara
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeChangeMtu starts now...&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|NewMtu
OL
l_int|68
)paren
op_logical_or
(paren
id|NewMtu
OG
id|SK_JUMBO_MTU
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pAC-&gt;RxBufSize
op_assign
id|NewMtu
op_plus
l_int|32
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|NewMtu
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;New MTU: %d&bslash;n&quot;
comma
id|NewMtu
)paren
)paren
suffix:semicolon
multiline_comment|/* prevent reconfiguration while changing the MTU */
multiline_comment|/* disable interrupts */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_STOP
comma
id|EvPara
)paren
suffix:semicolon
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|pAC-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * adjust number of rx buffers allocated&n;&t; */
r_if
c_cond
(paren
id|NewMtu
OG
l_int|1500
)paren
(brace
multiline_comment|/* use less rx buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|pAC-&gt;ActivePort
)paren
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxFillLimit
op_assign
id|pAC-&gt;RxDescrPerRing
op_minus
l_int|100
suffix:semicolon
r_else
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxFillLimit
op_assign
id|pAC-&gt;RxDescrPerRing
op_minus
l_int|10
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* use normal anoumt of rx buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|pAC-&gt;ActivePort
)paren
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxFillLimit
op_assign
l_int|1
suffix:semicolon
r_else
id|pAC-&gt;RxPort
(braket
id|i
)braket
dot
id|RxFillLimit
op_assign
id|pAC-&gt;RxDescrPerRing
op_minus
l_int|100
suffix:semicolon
)brace
)brace
id|SkGeDeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * enable/disable hardware support for long frames&n;&t; */
r_if
c_cond
(paren
id|NewMtu
OG
l_int|1500
)paren
(brace
id|pAC-&gt;GIni.GIPortUsage
op_assign
id|SK_JUMBO_LINK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PRxCmd
op_assign
id|XM_RX_STRIP_FCS
op_or
id|XM_RX_LENERR_OK
suffix:semicolon
)brace
)brace
r_else
(brace
id|pAC-&gt;GIni.GIPortUsage
op_assign
id|SK_RED_LINK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
id|i
)braket
dot
id|PRxCmd
op_assign
id|XM_RX_STRIP_FCS
op_or
id|XM_RX_LENERR_OK
suffix:semicolon
)brace
)brace
id|SkGeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkI2cInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkEventInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkPnmiInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkAddrInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkRlmtInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkTimerInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
id|SkGeInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkI2cInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkEventInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkPnmiInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkAddrInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkRlmtInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
id|SkTimerInit
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * clear and reinit the rx rings here&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pAC-&gt;GIni.GIMacsFound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
id|ClearRxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
id|FillRxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
singleline_comment|// Enable transmit descriptor polling.
id|SkGePollTxD
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|i
comma
id|SK_TRUE
)paren
suffix:semicolon
id|FillRxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
suffix:semicolon
id|SkGeYellowLED
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef USE_INT_MOD
(brace
r_int
r_int
id|ModBase
suffix:semicolon
id|ModBase
op_assign
l_int|53125000
op_div
id|INTS_PER_SEC
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B2_IRQM_INI
comma
id|ModBase
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B2_IRQM_MSK
comma
id|IRQ_MOD_MASK
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B2_IRQM_CTRL
comma
id|TIM_START
)paren
suffix:semicolon
)brace
macro_line|#endif
id|netif_start_queue
c_func
(paren
id|pAC-&gt;dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|pAC-&gt;GIni.GIMacsFound
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|i
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
)paren
suffix:semicolon
)brace
multiline_comment|/* enable Interrupts */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
id|IRQ_MASK
)paren
suffix:semicolon
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_HWE_IMSK
comma
id|IRQ_HWE_MASK
)paren
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_START
comma
id|EvPara
)paren
suffix:semicolon
id|SkEventDispatcher
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkGeChangeMtu */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeStats - return ethernet device statistics&n; *&n; * Description:&n; *&t;This function return statistic data about the ethernet device&n; *&t;to the operating system.&n; *&n; * Returns:&n; *&t;pointer to the statistic structure.&n; */
DECL|function|SkGeStats
r_static
r_struct
id|net_device_stats
op_star
id|SkGeStats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SK_AC
op_star
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SK_PNMI_STRUCT_DATA
op_star
id|pPnmiStruct
suffix:semicolon
multiline_comment|/* structure for all Pnmi-Data */
id|SK_PNMI_STAT
op_star
id|pPnmiStat
suffix:semicolon
multiline_comment|/* pointer to virtual XMAC stat. data */
id|SK_PNMI_CONF
op_star
id|pPnmiConf
suffix:semicolon
multiline_comment|/* pointer to virtual link config. */
r_int
r_int
id|Size
suffix:semicolon
multiline_comment|/* size of pnmi struct */
r_int
r_int
id|Flags
suffix:semicolon
multiline_comment|/* for spin lock */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeStats starts now...&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pPnmiStruct
op_assign
op_amp
id|pAC-&gt;PnmiStruct
suffix:semicolon
id|memset
c_func
(paren
id|pPnmiStruct
comma
l_int|0
comma
r_sizeof
(paren
id|SK_PNMI_STRUCT_DATA
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|Size
op_assign
id|SK_PNMI_STRUCT_SIZE
suffix:semicolon
id|SkPnmiGetStruct
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|pPnmiStruct
comma
op_amp
id|Size
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|pPnmiStat
op_assign
op_amp
id|pPnmiStruct-&gt;Stat
(braket
l_int|0
)braket
suffix:semicolon
id|pPnmiConf
op_assign
op_amp
id|pPnmiStruct-&gt;Conf
(braket
l_int|0
)braket
suffix:semicolon
id|pAC-&gt;stats.rx_packets
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStruct-&gt;RxDeliveredCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.tx_packets
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxOkCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_bytes
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStruct-&gt;RxOctetsDeliveredCts
suffix:semicolon
id|pAC-&gt;stats.tx_bytes
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxOctetsOkCts
suffix:semicolon
id|pAC-&gt;stats.rx_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStruct-&gt;InErrorsCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.tx_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxSingleCollisionCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_dropped
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStruct-&gt;RxNoBufCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.tx_dropped
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStruct-&gt;TxNoBufCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.multicast
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxMulticastOkCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.collisions
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxSingleCollisionCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* detailed rx_errors: */
id|pAC-&gt;stats.rx_length_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxRuntCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_over_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxFifoOverflowCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_crc_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxFcsCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_frame_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxFramingCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_fifo_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxFifoOverflowCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.rx_missed_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatRxMissedCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* detailed tx_errors */
id|pAC-&gt;stats.tx_aborted_errors
op_assign
(paren
id|SK_U32
)paren
l_int|0
suffix:semicolon
id|pAC-&gt;stats.tx_carrier_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxCarrierCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.tx_fifo_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxFifoUnderrunCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.tx_heartbeat_errors
op_assign
(paren
id|SK_U32
)paren
id|pPnmiStat-&gt;StatTxCarrierCts
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pAC-&gt;stats.tx_window_errors
op_assign
(paren
id|SK_U32
)paren
l_int|0
suffix:semicolon
r_return
op_amp
id|pAC-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* SkGeStats */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeIoctl - IO-control function&n; *&n; * Description:&n; *&t;This function is called if an ioctl is issued on the device.&n; *&t;There are three subfunction for reading, writing and test-writing&n; *&t;the private MIB data structure (usefull for SysKonnect-internal tools).&n; *&n; * Returns:&n; *&t;0, if everything is ok&n; *&t;!=0, on error&n; */
DECL|function|SkGeIoctl
r_static
r_int
id|SkGeIoctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|SK_AC
op_star
id|pAC
suffix:semicolon
id|SK_GE_IOCTL
id|Ioctl
suffix:semicolon
r_int
r_int
id|Err
op_assign
l_int|0
suffix:semicolon
r_int
id|Size
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeIoctl starts now...&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pAC
op_assign
(paren
id|SK_AC
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|Ioctl
comma
id|rq-&gt;ifr_data
comma
r_sizeof
(paren
id|SK_GE_IOCTL
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SK_IOCTL_SETMIB
suffix:colon
r_case
id|SK_IOCTL_PRESETMIB
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_case
id|SK_IOCTL_GETMIB
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|pAC-&gt;PnmiStruct
comma
id|Ioctl.pData
comma
id|Ioctl.Len
OL
r_sizeof
(paren
id|pAC-&gt;PnmiStruct
)paren
ques
c_cond
id|Ioctl.Len
suffix:colon
r_sizeof
(paren
id|pAC-&gt;PnmiStruct
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|Size
op_assign
id|SkGeIocMib
c_func
(paren
id|pAC
comma
id|Ioctl.Len
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|Ioctl.pData
comma
op_amp
id|pAC-&gt;PnmiStruct
comma
id|Ioctl.Len
OL
id|Size
ques
c_cond
id|Ioctl.Len
suffix:colon
id|Size
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|Ioctl.Len
op_assign
id|Size
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|rq-&gt;ifr_data
comma
op_amp
id|Ioctl
comma
r_sizeof
(paren
id|SK_GE_IOCTL
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|Err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|Err
suffix:semicolon
)brace
multiline_comment|/* SkGeIoctl */
multiline_comment|/*****************************************************************************&n; *&n; * &t;SkGeIocMib - handle a GetMib, SetMib- or PresetMib-ioctl message&n; *&n; * Description:&n; *&t;This function reads/writes the MIB data using PNMI (Private Network&n; *&t;Management Interface).&n; *&t;The destination for the data must be provided with the&n; *&t;ioctl call and is given to the driver in the form of&n; *&t;a user space address.&n; *&t;Copying from the user-provided data area into kernel messages&n; *&t;and back is done by copy_from_user and copy_to_user calls in&n; *&t;SkGeIoctl.&n; *&n; * Returns:&n; *&t;returned size from PNMI call&n; */
DECL|function|SkGeIocMib
r_static
r_int
id|SkGeIocMib
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to the adapter context */
r_int
r_int
id|Size
comma
multiline_comment|/* length of ioctl data */
r_int
id|mode
)paren
multiline_comment|/* flag for set/preset */
(brace
r_int
r_int
id|Flags
suffix:semicolon
multiline_comment|/* for spin lock */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;SkGeIocMib starts now...&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* access MIB */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|SK_IOCTL_GETMIB
suffix:colon
id|SkPnmiGetStruct
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
op_amp
id|pAC-&gt;PnmiStruct
comma
op_amp
id|Size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_IOCTL_PRESETMIB
suffix:colon
id|SkPnmiPreSetStruct
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
op_amp
id|pAC-&gt;PnmiStruct
comma
op_amp
id|Size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_IOCTL_SETMIB
suffix:colon
id|SkPnmiSetStruct
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
op_amp
id|pAC-&gt;PnmiStruct
comma
op_amp
id|Size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ENTRY
comma
(paren
l_string|&quot;MIB data access succeeded&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
id|Size
)paren
suffix:semicolon
)brace
multiline_comment|/* SkGeIocMib */
multiline_comment|/*****************************************************************************&n; *&n; * &t;GetConfiguration - read configuration information&n; *&n; * Description:&n; *&t;This function reads per-adapter configuration information from&n; *&t;the options provided on the command line.&n; *&n; * Returns:&n; *&t;none&n; */
DECL|function|GetConfiguration
r_static
r_void
id|GetConfiguration
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
multiline_comment|/* pointer to the adapter context structure */
(brace
id|SK_I32
id|Port
suffix:semicolon
multiline_comment|/* preferred port */
r_int
id|AutoNeg
suffix:semicolon
multiline_comment|/* auto negotiation off (0) or on (1) */
r_int
id|DuplexCap
suffix:semicolon
multiline_comment|/* duplex capabilities (0=both, 1=full, 2=half */
r_int
id|MSMode
suffix:semicolon
multiline_comment|/* master / slave mode selection */
id|SK_BOOL
id|AutoSet
suffix:semicolon
id|SK_BOOL
id|DupSet
suffix:semicolon
multiline_comment|/*&n; *&t;The two parameters AutoNeg. and DuplexCap. map to one configuration&n; *&t;parameter. The mapping is described by this table:&n; *&t;DuplexCap -&gt;&t;|&t;both&t;|&t;full&t;|&t;half&t;|&n; *&t;AutoNeg&t;&t;|&t;&t;|&t;&t;|&t;&t;|&n; *&t;-----------------------------------------------------------------&n; *&t;Off&t;&t;|    illegal&t;|&t;Full&t;|&t;Half&t;|&n; *&t;-----------------------------------------------------------------&n; *&t;On&t;&t;|   AutoBoth&t;|   AutoFull&t;|   AutoHalf&t;|&n; *&t;-----------------------------------------------------------------&n; *&t;Sense&t;&t;|   AutoSense&t;|   AutoSense&t;|   AutoSense&t;|&n; */
r_int
id|Capabilities
(braket
l_int|3
)braket
(braket
l_int|3
)braket
op_assign
(brace
(brace
op_minus
l_int|1
comma
id|SK_LMODE_FULL
comma
id|SK_LMODE_HALF
)brace
comma
(brace
id|SK_LMODE_AUTOBOTH
comma
id|SK_LMODE_AUTOFULL
comma
id|SK_LMODE_AUTOHALF
)brace
comma
(brace
id|SK_LMODE_AUTOSENSE
comma
id|SK_LMODE_AUTOSENSE
comma
id|SK_LMODE_AUTOSENSE
)brace
)brace
suffix:semicolon
DECL|macro|DC_BOTH
mdefine_line|#define DC_BOTH&t;0
DECL|macro|DC_FULL
mdefine_line|#define DC_FULL 1
DECL|macro|DC_HALF
mdefine_line|#define DC_HALF 2
DECL|macro|AN_OFF
mdefine_line|#define AN_OFF&t;0
DECL|macro|AN_ON
mdefine_line|#define AN_ON&t;1
DECL|macro|AN_SENS
mdefine_line|#define AN_SENS&t;2
multiline_comment|/* settings for port A */
id|AutoNeg
op_assign
id|AN_SENS
suffix:semicolon
multiline_comment|/* default: do auto Sense */
id|AutoSet
op_assign
id|SK_FALSE
suffix:semicolon
r_if
c_cond
(paren
id|AutoNeg_A
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|AutoNeg_A
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
id|AutoSet
op_assign
id|SK_TRUE
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoSet
op_assign
id|SK_FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;On&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoNeg
op_assign
id|AN_ON
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Off&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoNeg
op_assign
id|AN_OFF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Sense&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoNeg
op_assign
id|AN_SENS
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Illegal value for AutoNeg_A&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|DuplexCap
op_assign
id|DC_BOTH
suffix:semicolon
id|DupSet
op_assign
id|SK_FALSE
suffix:semicolon
r_if
c_cond
(paren
id|DupCap_A
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|DupCap_A
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
id|DupSet
op_assign
id|SK_TRUE
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DupSet
op_assign
id|SK_FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Both&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DuplexCap
op_assign
id|DC_BOTH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Full&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DuplexCap
op_assign
id|DC_FULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Half&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DuplexCap
op_assign
id|DC_HALF
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Illegal value for DupCap_A&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* check for illegal combinations */
r_if
c_cond
(paren
id|AutoSet
op_logical_and
id|AutoNeg
op_eq
id|AN_SENS
op_logical_and
id|DupSet
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port A: DuplexCapabilities&quot;
l_string|&quot; ignored using Sense mode&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AutoSet
op_logical_and
id|AutoNeg
op_eq
id|AN_OFF
op_logical_and
id|DupSet
op_logical_and
id|DuplexCap
op_eq
id|DC_BOTH
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port A: Illegal combination&quot;
l_string|&quot; of values AutoNeg. and DuplexCap.&bslash;n    Using &quot;
l_string|&quot;Full Duplex&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|DuplexCap
op_assign
id|DC_FULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AutoSet
op_logical_and
id|AutoNeg
op_eq
id|AN_OFF
op_logical_and
op_logical_neg
id|DupSet
)paren
(brace
id|DuplexCap
op_assign
id|DC_FULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|AutoSet
op_logical_and
id|DupSet
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port A: Duplex setting not&quot;
l_string|&quot; possible in&bslash;n    default AutoNegotiation mode&quot;
l_string|&quot; (Sense).&bslash;n    Using AutoNegotiation On&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|AutoNeg
op_assign
id|AN_ON
suffix:semicolon
)brace
multiline_comment|/* set the desired mode */
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PLinkModeConf
op_assign
id|Capabilities
(braket
id|AutoNeg
)braket
(braket
id|DuplexCap
)braket
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_SYM_OR_REM
suffix:semicolon
r_if
c_cond
(paren
id|FlowCtrl_A
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|FlowCtrl_A
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;SymOrRem&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_SYM_OR_REM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Sym&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_SYMMETRIC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;LocSend&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_LOC_SEND
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;None&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_NONE
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Illegal value for FlowCtrl_A&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AutoNeg
op_eq
id|AN_OFF
op_logical_and
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_ne
id|SK_FLOW_MODE_NONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port A: FlowControl&quot;
l_string|&quot; impossible without AutoNegotiation,&quot;
l_string|&quot; disabled&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_NONE
suffix:semicolon
)brace
id|MSMode
op_assign
id|SK_MS_MODE_AUTO
suffix:semicolon
multiline_comment|/* default: do auto select */
r_if
c_cond
(paren
id|Role_A
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|Role_A
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Auto&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|MSMode
op_assign
id|SK_MS_MODE_AUTO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Master&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|MSMode
op_assign
id|SK_MS_MODE_MASTER
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_A
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Slave&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|MSMode
op_assign
id|SK_MS_MODE_SLAVE
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Illegal value for Role_A&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|pAC-&gt;GIni.GP
(braket
l_int|0
)braket
dot
id|PMSMode
op_assign
id|MSMode
suffix:semicolon
multiline_comment|/* settings for port B */
id|AutoNeg
op_assign
id|AN_SENS
suffix:semicolon
multiline_comment|/* default: do auto Sense */
id|AutoSet
op_assign
id|SK_FALSE
suffix:semicolon
r_if
c_cond
(paren
id|AutoNeg_B
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|AutoNeg_B
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
id|AutoSet
op_assign
id|SK_TRUE
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoSet
op_assign
id|SK_FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;On&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoNeg
op_assign
id|AN_ON
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Off&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoNeg
op_assign
id|AN_OFF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|AutoNeg_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Sense&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|AutoNeg
op_assign
id|AN_SENS
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Illegal value for AutoNeg_B&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|DuplexCap
op_assign
id|DC_BOTH
suffix:semicolon
id|DupSet
op_assign
id|SK_FALSE
suffix:semicolon
r_if
c_cond
(paren
id|DupCap_B
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|DupCap_B
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
id|DupSet
op_assign
id|SK_TRUE
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DupSet
op_assign
id|SK_FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Both&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DuplexCap
op_assign
id|DC_BOTH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Full&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DuplexCap
op_assign
id|DC_FULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|DupCap_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Half&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|DuplexCap
op_assign
id|DC_HALF
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Illegal value for DupCap_B&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* check for illegal combinations */
r_if
c_cond
(paren
id|AutoSet
op_logical_and
id|AutoNeg
op_eq
id|AN_SENS
op_logical_and
id|DupSet
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port B: DuplexCapabilities&quot;
l_string|&quot; ignored using Sense mode&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AutoSet
op_logical_and
id|AutoNeg
op_eq
id|AN_OFF
op_logical_and
id|DupSet
op_logical_and
id|DuplexCap
op_eq
id|DC_BOTH
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port B: Illegal combination&quot;
l_string|&quot; of values AutoNeg. and DuplexCap.&bslash;n    Using &quot;
l_string|&quot;Full Duplex&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|DuplexCap
op_assign
id|DC_FULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AutoSet
op_logical_and
id|AutoNeg
op_eq
id|AN_OFF
op_logical_and
op_logical_neg
id|DupSet
)paren
(brace
id|DuplexCap
op_assign
id|DC_FULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|AutoSet
op_logical_and
id|DupSet
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port B: Duplex setting not&quot;
l_string|&quot; possible in&bslash;n    default AutoNegotiation mode&quot;
l_string|&quot; (Sense).&bslash;n    Using AutoNegotiation On&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|AutoNeg
op_assign
id|AN_ON
suffix:semicolon
)brace
multiline_comment|/* set the desired mode */
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PLinkModeConf
op_assign
id|Capabilities
(braket
id|AutoNeg
)braket
(braket
id|DuplexCap
)braket
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_SYM_OR_REM
suffix:semicolon
r_if
c_cond
(paren
id|FlowCtrl_B
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|FlowCtrl_B
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;SymOrRem&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_SYM_OR_REM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Sym&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_SYMMETRIC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;LocSend&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_LOC_SEND
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|FlowCtrl_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;None&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_NONE
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Illegal value for FlowCtrl_B&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AutoNeg
op_eq
id|AN_OFF
op_logical_and
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_ne
id|SK_FLOW_MODE_NONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, Port B: FlowControl&quot;
l_string|&quot; impossible without AutoNegotiation,&quot;
l_string|&quot; disabled&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PFlowCtrlMode
op_assign
id|SK_FLOW_MODE_NONE
suffix:semicolon
)brace
id|MSMode
op_assign
id|SK_MS_MODE_AUTO
suffix:semicolon
multiline_comment|/* default: do auto select */
r_if
c_cond
(paren
id|Role_B
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|Role_B
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Auto&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|MSMode
op_assign
id|SK_MS_MODE_AUTO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Master&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|MSMode
op_assign
id|SK_MS_MODE_MASTER
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|Role_B
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;Slave&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|MSMode
op_assign
id|SK_MS_MODE_SLAVE
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Illegal value for Role_B&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|pAC-&gt;GIni.GP
(braket
l_int|1
)braket
dot
id|PMSMode
op_assign
id|MSMode
suffix:semicolon
multiline_comment|/* settings for both ports */
id|pAC-&gt;ActivePort
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|PrefPort
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|PrefPort
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|PrefPort
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Auto */
id|pAC-&gt;ActivePort
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.MacPreferred
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* auto */
id|pAC-&gt;Rlmt.PrefPort
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|PrefPort
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;A&quot;
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * do not set ActivePort here, thus a port&n;&t;&t;&t; * switch is issued after net up.&n;&t;&t;&t; */
id|Port
op_assign
l_int|0
suffix:semicolon
id|pAC-&gt;Rlmt.MacPreferred
op_assign
id|Port
suffix:semicolon
id|pAC-&gt;Rlmt.PrefPort
op_assign
id|Port
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|PrefPort
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;B&quot;
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * do not set ActivePort here, thus a port&n;&t;&t;&t; * switch is issued after net up.&n;&t;&t;&t; */
id|Port
op_assign
l_int|1
suffix:semicolon
id|pAC-&gt;Rlmt.MacPreferred
op_assign
id|Port
suffix:semicolon
id|pAC-&gt;Rlmt.PrefPort
op_assign
id|Port
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Illegal value for PrefPort&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|RlmtMode
op_ne
l_int|NULL
op_logical_and
id|pAC-&gt;Index
OL
id|SK_MAX_CARD_PARAM
op_logical_and
id|RlmtMode
(braket
id|pAC-&gt;Index
)braket
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|RlmtMode
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;RlmtMode
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|RlmtMode
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;CheckLinkState&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;RlmtMode
op_assign
id|SK_RLMT_CHECK_LINK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|RlmtMode
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;CheckLocalPort&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;RlmtMode
op_assign
id|SK_RLMT_CHECK_LINK
op_or
id|SK_RLMT_CHECK_LOC_LINK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|RlmtMode
(braket
id|pAC-&gt;Index
)braket
comma
l_string|&quot;CheckSeg&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|pAC-&gt;RlmtMode
op_assign
id|SK_RLMT_CHECK_LINK
op_or
id|SK_RLMT_CHECK_LOC_LINK
op_or
id|SK_RLMT_CHECK_SEG
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Illegal value for&quot;
l_string|&quot; RlmtMode, using default&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
id|pAC-&gt;RlmtMode
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|pAC-&gt;RlmtMode
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* GetConfiguration */
multiline_comment|/*****************************************************************************&n; *&n; * &t;ProductStr - return a adapter identification string from vpd&n; *&n; * Description:&n; *&t;This function reads the product name string from the vpd area&n; *&t;and puts it the field pAC-&gt;DeviceString.&n; *&n; * Returns: N/A&n; */
DECL|function|ProductStr
r_static
r_void
id|ProductStr
c_func
(paren
id|SK_AC
op_star
id|pAC
multiline_comment|/* pointer to adapter context */
)paren
(brace
r_int
id|StrLen
op_assign
l_int|80
suffix:semicolon
multiline_comment|/* length of the string, defined in SK_AC */
r_char
id|Keyword
(braket
)braket
op_assign
id|VPD_NAME
suffix:semicolon
multiline_comment|/* vpd productname identifier */
r_int
id|ReturnCode
suffix:semicolon
multiline_comment|/* return code from vpd_read */
r_int
r_int
id|Flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
id|ReturnCode
op_assign
id|VpdRead
c_func
(paren
id|pAC
comma
id|pAC-&gt;IoBase
comma
id|Keyword
comma
id|pAC-&gt;DeviceStr
comma
op_amp
id|StrLen
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;SlowPathLock
comma
id|Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ReturnCode
op_ne
l_int|0
)paren
(brace
multiline_comment|/* there was an error reading the vpd data */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_ERROR
comma
(paren
l_string|&quot;Error reading VPD data: %d&bslash;n&quot;
comma
id|ReturnCode
)paren
)paren
suffix:semicolon
id|pAC-&gt;DeviceStr
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
multiline_comment|/* ProductStr */
multiline_comment|/****************************************************************************/
multiline_comment|/* functions for common modules *********************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkDrvAllocRlmtMbuf - allocate an RLMT mbuf&n; *&n; * Description:&n; *&t;This routine returns an RLMT mbuf or NULL. The RLMT Mbuf structure&n; *&t;is embedded into a socket buff data area.&n; *&n; * Context:&n; *&t;runtime&n; *&n; * Returns:&n; *&t;NULL or pointer to Mbuf.&n; */
DECL|function|SkDrvAllocRlmtMbuf
id|SK_MBUF
op_star
id|SkDrvAllocRlmtMbuf
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* the IO-context */
r_int
id|BufferSize
)paren
multiline_comment|/* size of the requested buffer */
(brace
id|SK_MBUF
op_star
id|pRlmtMbuf
suffix:semicolon
multiline_comment|/* pointer to a new rlmt-mbuf structure */
r_struct
id|sk_buff
op_star
id|pMsgBlock
suffix:semicolon
multiline_comment|/* pointer to a new message block */
id|pMsgBlock
op_assign
id|alloc_skb
c_func
(paren
id|BufferSize
op_plus
r_sizeof
(paren
id|SK_MBUF
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsgBlock
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|pRlmtMbuf
op_assign
(paren
id|SK_MBUF
op_star
)paren
id|pMsgBlock-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|pMsgBlock
comma
r_sizeof
(paren
id|SK_MBUF
)paren
)paren
suffix:semicolon
id|pRlmtMbuf-&gt;pNext
op_assign
l_int|NULL
suffix:semicolon
id|pRlmtMbuf-&gt;pOs
op_assign
id|pMsgBlock
suffix:semicolon
id|pRlmtMbuf-&gt;pData
op_assign
id|pMsgBlock-&gt;data
suffix:semicolon
multiline_comment|/* Data buffer. */
id|pRlmtMbuf-&gt;Size
op_assign
id|BufferSize
suffix:semicolon
multiline_comment|/* Data buffer size. */
id|pRlmtMbuf-&gt;Length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Length of packet (&lt;= Size). */
r_return
(paren
id|pRlmtMbuf
)paren
suffix:semicolon
)brace
multiline_comment|/* SkDrvAllocRlmtMbuf */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkDrvFreeRlmtMbuf - free an RLMT mbuf&n; *&n; * Description:&n; *&t;This routine frees one or more RLMT mbuf(s).&n; *&n; * Context:&n; *&t;runtime&n; *&n; * Returns:&n; *&t;Nothing&n; */
DECL|function|SkDrvFreeRlmtMbuf
r_void
id|SkDrvFreeRlmtMbuf
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* the IO-context */
id|SK_MBUF
op_star
id|pMbuf
)paren
multiline_comment|/* size of the requested buffer */
(brace
id|SK_MBUF
op_star
id|pFreeMbuf
suffix:semicolon
id|SK_MBUF
op_star
id|pNextMbuf
suffix:semicolon
id|pFreeMbuf
op_assign
id|pMbuf
suffix:semicolon
r_do
(brace
id|pNextMbuf
op_assign
id|pFreeMbuf-&gt;pNext
suffix:semicolon
id|DEV_KFREE_SKB_ANY
c_func
(paren
id|pFreeMbuf-&gt;pOs
)paren
suffix:semicolon
id|pFreeMbuf
op_assign
id|pNextMbuf
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pFreeMbuf
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* SkDrvFreeRlmtMbuf */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkOsGetTime - provide a time value&n; *&n; * Description:&n; *&t;This routine provides a time value. The unit is 1/HZ (defined by Linux).&n; *&t;It is not used for absolute time, but only for time differences.&n; *&n; *&n; * Returns:&n; *&t;Time value&n; */
DECL|function|SkOsGetTime
id|SK_U64
id|SkOsGetTime
c_func
(paren
id|SK_AC
op_star
id|pAC
)paren
(brace
r_return
id|jiffies
suffix:semicolon
)brace
multiline_comment|/* SkOsGetTime */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkPciReadCfgDWord - read a 32 bit value from pci config space&n; *&n; * Description:&n; *&t;This routine reads a 32 bit value from the pci configuration&n; *&t;space.&n; *&n; * Returns:&n; *&t;0 - indicate everything worked ok.&n; *&t;!= 0 - error indication&n; */
DECL|function|SkPciReadCfgDWord
r_int
id|SkPciReadCfgDWord
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapter Control structure pointer */
r_int
id|PciAddr
comma
multiline_comment|/* PCI register address */
id|SK_U32
op_star
id|pVal
)paren
multiline_comment|/* pointer to store the read value */
(brace
id|pci_read_config_dword
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PciAddr
comma
id|pVal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkPciReadCfgDWord */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkPciReadCfgWord - read a 16 bit value from pci config space&n; *&n; * Description:&n; *&t;This routine reads a 16 bit value from the pci configuration&n; *&t;space.&n; *&n; * Returns:&n; *&t;0 - indicate everything worked ok.&n; *&t;!= 0 - error indication&n; */
DECL|function|SkPciReadCfgWord
r_int
id|SkPciReadCfgWord
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapter Control structure pointer */
r_int
id|PciAddr
comma
multiline_comment|/* PCI register address */
id|SK_U16
op_star
id|pVal
)paren
multiline_comment|/* pointer to store the read value */
(brace
id|pci_read_config_word
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PciAddr
comma
id|pVal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkPciReadCfgWord */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkPciReadCfgByte - read a 8 bit value from pci config space&n; *&n; * Description:&n; *&t;This routine reads a 8 bit value from the pci configuration&n; *&t;space.&n; *&n; * Returns:&n; *&t;0 - indicate everything worked ok.&n; *&t;!= 0 - error indication&n; */
DECL|function|SkPciReadCfgByte
r_int
id|SkPciReadCfgByte
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapter Control structure pointer */
r_int
id|PciAddr
comma
multiline_comment|/* PCI register address */
id|SK_U8
op_star
id|pVal
)paren
multiline_comment|/* pointer to store the read value */
(brace
id|pci_read_config_byte
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PciAddr
comma
id|pVal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkPciReadCfgByte */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkPciWriteCfgDWord - write a 32 bit value to pci config space&n; *&n; * Description:&n; *&t;This routine writes a 32 bit value to the pci configuration&n; *&t;space.&n; *&n; * Returns:&n; *&t;0 - indicate everything worked ok.&n; *&t;!= 0 - error indication&n; */
DECL|function|SkPciWriteCfgDWord
r_int
id|SkPciWriteCfgDWord
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapter Control structure pointer */
r_int
id|PciAddr
comma
multiline_comment|/* PCI register address */
id|SK_U32
id|Val
)paren
multiline_comment|/* pointer to store the read value */
(brace
id|pci_write_config_dword
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PciAddr
comma
id|Val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkPciWriteCfgDWord */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkPciWriteCfgWord - write a 16 bit value to pci config space&n; *&n; * Description:&n; *&t;This routine writes a 16 bit value to the pci configuration&n; *&t;space. The flag PciConfigUp indicates whether the config space&n; *&t;is accesible or must be set up first.&n; *&n; * Returns:&n; *&t;0 - indicate everything worked ok.&n; *&t;!= 0 - error indication&n; */
DECL|function|SkPciWriteCfgWord
r_int
id|SkPciWriteCfgWord
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapter Control structure pointer */
r_int
id|PciAddr
comma
multiline_comment|/* PCI register address */
id|SK_U16
id|Val
)paren
multiline_comment|/* pointer to store the read value */
(brace
id|pci_write_config_word
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PciAddr
comma
id|Val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkPciWriteCfgWord */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkPciWriteCfgWord - write a 8 bit value to pci config space&n; *&n; * Description:&n; *&t;This routine writes a 8 bit value to the pci configuration&n; *&t;space. The flag PciConfigUp indicates whether the config space&n; *&t;is accesible or must be set up first.&n; *&n; * Returns:&n; *&t;0 - indicate everything worked ok.&n; *&t;!= 0 - error indication&n; */
DECL|function|SkPciWriteCfgByte
r_int
id|SkPciWriteCfgByte
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* Adapter Control structure pointer */
r_int
id|PciAddr
comma
multiline_comment|/* PCI register address */
id|SK_U8
id|Val
)paren
multiline_comment|/* pointer to store the read value */
(brace
id|pci_write_config_byte
c_func
(paren
op_amp
id|pAC-&gt;PciDev
comma
id|PciAddr
comma
id|Val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SkPciWriteCfgByte */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkDrvEvent - handle driver events&n; *&n; * Description:&n; *&t;This function handles events from all modules directed to the driver&n; *&n; * Context:&n; *&t;Is called under protection of slow path lock.&n; *&n; * Returns:&n; *&t;0 if everything ok&n; *&t;&lt; 0  on error&n; *&t;&n; */
DECL|function|SkDrvEvent
r_int
id|SkDrvEvent
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* pointer to adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* io-context */
id|SK_U32
id|Event
comma
multiline_comment|/* event-id */
id|SK_EVPARA
id|Param
)paren
multiline_comment|/* event-parameter */
(brace
id|SK_MBUF
op_star
id|pRlmtMbuf
suffix:semicolon
multiline_comment|/* pointer to a rlmt-mbuf structure */
r_struct
id|sk_buff
op_star
id|pMsg
suffix:semicolon
multiline_comment|/* pointer to a message block */
r_int
id|FromPort
suffix:semicolon
multiline_comment|/* the port from which we switch away */
r_int
id|ToPort
suffix:semicolon
multiline_comment|/* the port we switch to */
id|SK_EVPARA
id|NewPara
suffix:semicolon
multiline_comment|/* parameter for further events */
r_int
id|Stat
suffix:semicolon
r_int
r_int
id|Flags
suffix:semicolon
r_switch
c_cond
(paren
id|Event
)paren
(brace
r_case
id|SK_DRV_ADAP_FAIL
suffix:colon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;ADAPTER FAIL EVENT&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Adapter failed.&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|SK_OUT32
c_func
(paren
id|pAC-&gt;IoBase
comma
id|B0_IMSK
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* cgoos */
r_break
suffix:semicolon
r_case
id|SK_DRV_PORT_FAIL
suffix:colon
id|FromPort
op_assign
id|Param.Para32
(braket
l_int|0
)braket
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;PORT FAIL EVENT, Port: %d&bslash;n&quot;
comma
id|FromPort
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FromPort
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Port A failed.&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Port B failed.&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* cgoos */
r_break
suffix:semicolon
r_case
id|SK_DRV_PORT_RESET
suffix:colon
multiline_comment|/* SK_U32 PortIdx */
multiline_comment|/* action list 4 */
id|FromPort
op_assign
id|Param.Para32
(braket
l_int|0
)braket
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;PORT RESET EVENT, Port: %d &quot;
comma
id|FromPort
)paren
)paren
suffix:semicolon
id|NewPara.Para64
op_assign
id|FromPort
suffix:semicolon
id|SkPnmiEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_PNMI_EVT_XMAC_RESET
comma
id|NewPara
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|SkGeStopPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
comma
id|SK_STOP_ALL
comma
id|SK_HARD_RST
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
multiline_comment|/* clear rx ring from received frames */
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|FromPort
)braket
)paren
suffix:semicolon
id|ClearTxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|SkGeInitPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
)paren
suffix:semicolon
id|SkAddrMcUpdate
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
)paren
suffix:semicolon
id|PortReInitBmu
c_func
(paren
id|pAC
comma
id|FromPort
)paren
suffix:semicolon
id|SkGePollTxD
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
comma
id|SK_TRUE
)paren
suffix:semicolon
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
id|FromPort
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_DRV_NET_UP
suffix:colon
multiline_comment|/* SK_U32 PortIdx */
multiline_comment|/* action list 5 */
id|FromPort
op_assign
id|Param.Para32
(braket
l_int|0
)braket
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;NET UP EVENT, Port: %d &quot;
comma
id|Param.Para32
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: network connection up using&quot;
l_string|&quot; port %c&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
comma
l_char|&squot;A&squot;
op_plus
id|Param.Para32
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    speed:           1000&bslash;n&quot;
)paren
suffix:semicolon
id|Stat
op_assign
id|pAC-&gt;GIni.GP
(braket
id|FromPort
)braket
dot
id|PLinkModeStatus
suffix:semicolon
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_LMODE_STAT_AUTOHALF
op_logical_or
id|Stat
op_eq
id|SK_LMODE_STAT_AUTOFULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    autonegotiation: yes&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;    autonegotiation: no&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_LMODE_STAT_AUTOHALF
op_logical_or
id|Stat
op_eq
id|SK_LMODE_STAT_HALF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    duplex mode:     half&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;    duplex mode:     full&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|Stat
op_assign
id|pAC-&gt;GIni.GP
(braket
id|FromPort
)braket
dot
id|PFlowCtrlStatus
suffix:semicolon
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_FLOW_STAT_REM_SEND
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    flowctrl:        remote send&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_FLOW_STAT_LOC_SEND
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    flowctrl:        local send&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_FLOW_STAT_SYMMETRIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    flowctrl:        symmetric&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;    flowctrl:        none&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;GIni.GP
(braket
id|FromPort
)braket
dot
id|PhyType
op_ne
id|SK_PHY_XMAC
)paren
(brace
id|Stat
op_assign
id|pAC-&gt;GIni.GP
(braket
id|FromPort
)braket
dot
id|PMSStatus
suffix:semicolon
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_MS_STAT_MASTER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    role:            master&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|Stat
op_eq
id|SK_MS_STAT_SLAVE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    role:            slave&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;    role:            ???&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|Param.Para32
(braket
l_int|0
)braket
op_ne
id|pAC-&gt;ActivePort
)paren
(brace
id|NewPara.Para32
(braket
l_int|0
)braket
op_assign
id|pAC-&gt;ActivePort
suffix:semicolon
id|NewPara.Para32
(braket
l_int|1
)braket
op_assign
id|Param.Para32
(braket
l_int|0
)braket
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_DRV
comma
id|SK_DRV_SWITCH_INTERN
comma
id|NewPara
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SK_DRV_NET_DOWN
suffix:colon
multiline_comment|/* SK_U32 Reason */
multiline_comment|/* action list 7 */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;NET DOWN EVENT &quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: network connection down&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_DRV_SWITCH_HARD
suffix:colon
multiline_comment|/* SK_U32 FromPortIdx SK_U32 ToPortIdx */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;PORT SWITCH HARD &quot;
)paren
)paren
suffix:semicolon
r_case
id|SK_DRV_SWITCH_SOFT
suffix:colon
multiline_comment|/* SK_U32 FromPortIdx SK_U32 ToPortIdx */
multiline_comment|/* action list 6 */
id|printk
c_func
(paren
l_string|&quot;%s: switching to port %c&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
comma
l_char|&squot;A&squot;
op_plus
id|Param.Para32
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_case
id|SK_DRV_SWITCH_INTERN
suffix:colon
multiline_comment|/* SK_U32 FromPortIdx SK_U32 ToPortIdx */
id|FromPort
op_assign
id|Param.Para32
(braket
l_int|0
)braket
suffix:semicolon
id|ToPort
op_assign
id|Param.Para32
(braket
l_int|1
)braket
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;PORT SWITCH EVENT, From: %d  To: %d (Pref %d) &quot;
comma
id|FromPort
comma
id|ToPort
comma
id|pAC-&gt;Rlmt.PrefPort
)paren
)paren
suffix:semicolon
id|NewPara.Para64
op_assign
id|FromPort
suffix:semicolon
id|SkPnmiEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_PNMI_EVT_XMAC_RESET
comma
id|NewPara
)paren
suffix:semicolon
id|NewPara.Para64
op_assign
id|ToPort
suffix:semicolon
id|SkPnmiEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_PNMI_EVT_XMAC_RESET
comma
id|NewPara
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|ToPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|SkGeStopPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
comma
id|SK_STOP_ALL
comma
id|SK_SOFT_RST
)paren
suffix:semicolon
id|SkGeStopPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|ToPort
comma
id|SK_STOP_ALL
comma
id|SK_SOFT_RST
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|ToPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|FromPort
)braket
)paren
suffix:semicolon
multiline_comment|/* clears rx ring */
id|ReceiveIrq
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;RxPort
(braket
id|ToPort
)braket
)paren
suffix:semicolon
multiline_comment|/* clears rx ring */
id|ClearTxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|ClearTxRing
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|ToPort
)braket
(braket
id|TX_PRIO_LOW
)braket
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|ToPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|pAC-&gt;ActivePort
op_assign
id|ToPort
suffix:semicolon
id|SetQueueSizes
c_func
(paren
id|pAC
)paren
suffix:semicolon
id|SkGeInitPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
)paren
suffix:semicolon
id|SkGeInitPort
c_func
(paren
id|pAC
comma
id|IoC
comma
id|ToPort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Event
op_eq
id|SK_DRV_SWITCH_SOFT
)paren
(brace
id|SkXmRxTxEnable
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
)paren
suffix:semicolon
)brace
id|SkXmRxTxEnable
c_func
(paren
id|pAC
comma
id|IoC
comma
id|ToPort
)paren
suffix:semicolon
id|SkAddrSwap
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
comma
id|ToPort
)paren
suffix:semicolon
id|SkAddrMcUpdate
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
)paren
suffix:semicolon
id|SkAddrMcUpdate
c_func
(paren
id|pAC
comma
id|IoC
comma
id|ToPort
)paren
suffix:semicolon
id|PortReInitBmu
c_func
(paren
id|pAC
comma
id|FromPort
)paren
suffix:semicolon
id|PortReInitBmu
c_func
(paren
id|pAC
comma
id|ToPort
)paren
suffix:semicolon
id|SkGePollTxD
c_func
(paren
id|pAC
comma
id|IoC
comma
id|FromPort
comma
id|SK_TRUE
)paren
suffix:semicolon
id|SkGePollTxD
c_func
(paren
id|pAC
comma
id|IoC
comma
id|ToPort
comma
id|SK_TRUE
)paren
suffix:semicolon
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
id|FromPort
)paren
suffix:semicolon
id|ClearAndStartRx
c_func
(paren
id|pAC
comma
id|ToPort
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|ToPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pAC-&gt;TxPort
(braket
id|FromPort
)braket
(braket
id|TX_PRIO_LOW
)braket
dot
id|TxDesRingLock
comma
id|Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_DRV_RLMT_SEND
suffix:colon
multiline_comment|/* SK_MBUF *pMb */
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;RLS &quot;
)paren
)paren
suffix:semicolon
id|pRlmtMbuf
op_assign
(paren
id|SK_MBUF
op_star
)paren
id|Param.pParaPtr
suffix:semicolon
id|pMsg
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|pRlmtMbuf-&gt;pOs
suffix:semicolon
id|skb_put
c_func
(paren
id|pMsg
comma
id|pRlmtMbuf-&gt;Length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|XmitFrame
c_func
(paren
id|pAC
comma
op_amp
id|pAC-&gt;TxPort
(braket
id|pRlmtMbuf-&gt;PortIdx
)braket
(braket
id|TX_PRIO_LOW
)braket
comma
id|pMsg
)paren
OL
l_int|0
)paren
id|DEV_KFREE_SKB_ANY
c_func
(paren
id|pMsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
l_int|NULL
comma
id|SK_DBGMOD_DRV
comma
id|SK_DBGCAT_DRV_EVENT
comma
(paren
l_string|&quot;END EVENT &quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* SkDrvEvent */
multiline_comment|/*****************************************************************************&n; *&n; *&t;SkErrorLog - log errors&n; *&n; * Description:&n; *&t;This function logs errors to the system buffer and to the console&n; *&n; * Returns:&n; *&t;0 if everything ok&n; *&t;&lt; 0  on error&n; *&t;&n; */
DECL|function|SkErrorLog
r_void
id|SkErrorLog
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
r_int
id|ErrClass
comma
r_int
id|ErrNum
comma
r_char
op_star
id|pErrorMsg
)paren
(brace
r_char
id|ClassStr
(braket
l_int|80
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|ErrClass
)paren
(brace
r_case
id|SK_ERRCL_OTHER
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;Other error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_ERRCL_CONFIG
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;Configuration error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_ERRCL_INIT
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;Initialization error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_ERRCL_NORES
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;Out of resources error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_ERRCL_SW
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;internal Software error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_ERRCL_HW
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;Hardware failure&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_ERRCL_COMM
suffix:colon
id|strcpy
c_func
(paren
id|ClassStr
comma
l_string|&quot;Communication error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: -- ERROR --&bslash;n        Class:  %s&bslash;n&quot;
l_string|&quot;        Nr:  0x%x&bslash;n        Msg:  %s&bslash;n&quot;
comma
id|pAC-&gt;dev-&gt;name
comma
id|ClassStr
comma
id|ErrNum
comma
id|pErrorMsg
)paren
suffix:semicolon
)brace
multiline_comment|/* SkErrorLog */
macro_line|#ifdef DEBUG /***************************************************************/
multiline_comment|/* &quot;debug only&quot; section *****************************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/*****************************************************************************&n; *&n; *&t;DumpMsg - print a frame&n; *&n; * Description:&n; *&t;This function prints frames to the system logfile/to the console.&n; *&n; * Returns: N/A&n; *&t;&n; */
DECL|function|DumpMsg
r_static
r_void
id|DumpMsg
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|str
)paren
(brace
r_int
id|msglen
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DumpMsg(): NULL-Message&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;data
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DumpMsg(): Message empty&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|msglen
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|msglen
OG
l_int|64
)paren
id|msglen
op_assign
l_int|64
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;--- Begin of message from %s , len %d (from %d) ----&bslash;n&quot;
comma
id|str
comma
id|msglen
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|DumpData
c_func
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
comma
id|msglen
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;------- End of message ---------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* DumpMsg */
multiline_comment|/*****************************************************************************&n; *&n; *&t;DumpData - print a data area&n; *&n; * Description:&n; *&t;This function prints a area of data to the system logfile/to the &n; *&t;console.&n; *&n; * Returns: N/A&n; *&t;&n; */
DECL|function|DumpData
r_static
r_void
id|DumpData
c_func
(paren
r_char
op_star
id|p
comma
r_int
id|size
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_int
id|haddr
comma
id|addr
suffix:semicolon
r_char
id|hex_buffer
(braket
l_int|180
)braket
suffix:semicolon
r_char
id|asc_buffer
(braket
l_int|180
)braket
suffix:semicolon
r_char
id|HEXCHAR
(braket
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
suffix:semicolon
id|addr
op_assign
l_int|0
suffix:semicolon
id|haddr
op_assign
l_int|0
suffix:semicolon
id|hex_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|asc_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|p
op_le
l_char|&squot;z&squot;
)paren
id|asc_buffer
(braket
id|addr
)braket
op_assign
op_star
id|p
suffix:semicolon
r_else
id|asc_buffer
(braket
id|addr
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|addr
op_increment
suffix:semicolon
id|asc_buffer
(braket
id|addr
)braket
op_assign
l_int|0
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
op_star
id|p
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
op_star
id|p
op_amp
l_int|0x0f
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
l_int|0
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s  %s&bslash;n&quot;
comma
id|hex_buffer
comma
id|asc_buffer
)paren
suffix:semicolon
id|addr
op_assign
l_int|0
suffix:semicolon
id|haddr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* DumpData */
multiline_comment|/*****************************************************************************&n; *&n; *&t;DumpLong - print a data area as long values&n; *&n; * Description:&n; *&t;This function prints a area of data to the system logfile/to the &n; *&t;console.&n; *&n; * Returns: N/A&n; *&t;&n; */
DECL|function|DumpLong
r_static
r_void
id|DumpLong
c_func
(paren
r_char
op_star
id|pc
comma
r_int
id|size
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_int
id|haddr
comma
id|addr
suffix:semicolon
r_char
id|hex_buffer
(braket
l_int|180
)braket
suffix:semicolon
r_char
id|asc_buffer
(braket
l_int|180
)braket
suffix:semicolon
r_char
id|HEXCHAR
(braket
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
suffix:semicolon
r_int
op_star
id|p
suffix:semicolon
r_int
id|l
suffix:semicolon
id|addr
op_assign
l_int|0
suffix:semicolon
id|haddr
op_assign
l_int|0
suffix:semicolon
id|hex_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|asc_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
(paren
r_int
op_star
)paren
id|pc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
)paren
(brace
id|l
op_assign
(paren
r_int
)paren
op_star
id|p
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|28
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|24
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|20
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|16
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
(paren
id|l
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
id|HEXCHAR
(braket
id|l
op_amp
l_int|0x0f
)braket
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|haddr
op_increment
suffix:semicolon
id|hex_buffer
(braket
id|haddr
)braket
op_assign
l_int|0
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|8
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%4x %s&bslash;n&quot;
comma
(paren
id|i
op_minus
l_int|8
)paren
op_star
l_int|4
comma
id|hex_buffer
)paren
suffix:semicolon
id|haddr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;------------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* DumpLong */
macro_line|#endif /* DEBUG */
multiline_comment|/*&n; * Local variables:&n; * compile-command: &quot;make&quot;&n; * End:&n; */
eof
