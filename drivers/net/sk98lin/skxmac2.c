multiline_comment|/******************************************************************************&n; *&n; * Name:&t;skxmac2.c&n; * Project:&t;GEnesis, PCI Gigabit Ethernet Adapter&n; * Version:&t;$Revision: 1.53 $&n; * Date:&t;$Date: 2000/07/27 12:22:11 $&n; * Purpose:&t;Contains functions to initialize the XMAC II&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; *&t;(C)Copyright 1998,1999 SysKonnect,&n; *&t;a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;The information in this file is provided &quot;AS IS&quot; without warranty.&n; *&n; ******************************************************************************/
multiline_comment|/******************************************************************************&n; *&n; * History:&n; *&n; *&t;$Log: skxmac2.c,v $&n; *&t;Revision 1.53  2000/07/27 12:22:11  gklug&n; *&t;fix: possible endless loop in XmHardRst.&n; *&t;&n; *&t;Revision 1.52  2000/05/22 08:48:31  malthoff&n; *&t;Fix: #10523 errata valid for all BCOM PHYs.&n; *&t;&n; *&t;Revision 1.51  2000/05/17 12:52:18  malthoff&n; *&t;Fixes BCom link errata (#10523).&n; *&t;&n; *&t;Revision 1.50  1999/11/22 13:40:14  cgoos&n; *&t;Changed license header to GPL.&n; *&t;&n; *&t;Revision 1.49  1999/11/22 08:12:13  malthoff&n; *&t;Add workaround for power consumption feature of Bcom C0 chip.&n; *&t;&n; *&t;Revision 1.48  1999/11/16 08:39:01  malthoff&n; *&t;Fix: MDIO preamble suppression is port dependend.&n; *&t;&n; *&t;Revision 1.47  1999/08/27 08:55:35  malthoff&n; *&t;1000BT: Optimizing MDIO transfer by oppressing MDIO preamble.&n; *&t;&n; *&t;Revision 1.46  1999/08/13 11:01:12  malthoff&n; *&t;Fix for 1000BT: pFlowCtrlMode was not set correctly.&n; *&t;&n; *&t;Revision 1.45  1999/08/12 19:18:28  malthoff&n; *&t;1000BT Fixes: Do not owerwrite XM_MMU_CMD.&n; *&t;Do not execute BCOM A1 workaround for B1 chips.&n; *&t;Fix pause frame setting.&n; *&t;Always set PHY_B_AC_TX_TST in PHY_BCOM_AUX_CTRL.&n; *&t;&n; *&t;Revision 1.44  1999/08/03 15:23:48  cgoos&n; *&t;Fixed setting of PHY interrupt mask in half duplex mode.&n; *&t;&n; *&t;Revision 1.43  1999/08/03 15:22:17  cgoos&n; *&t;Added some debug output.&n; *&t;Disabled XMac GP0 interrupt for external PHYs.&n; *&t;&n; *&t;Revision 1.42  1999/08/02 08:39:23  malthoff&n; *&t;BCOM PHY: TX LED: To get the mono flop behaviour it is required&n; *&t;to set the LED Traffic Mode bit in PHY_BCOM_P_EXT_CTRL.&n; *&t;&n; *&t;Revision 1.41  1999/07/30 06:54:31  malthoff&n; *&t;Add temp. workarounds for the BCOM Phy revision A1.&n; *&t;&n; *&t;Revision 1.40  1999/06/01 07:43:26  cgoos&n; *&t;Changed Link Mode Status in SkXmAutoNegDone... from FULL/HALF to&n; *&t;AUTOFULL/AUTOHALF.&n; *&t;&n; *&t;Revision 1.39  1999/05/19 07:29:51  cgoos&n; *&t;Changes for 1000Base-T.&n; *&t;&n; *&t;Revision 1.38  1999/04/08 14:35:10  malthoff&n; *&t;Add code for enabling signal detect. Enabling signal&n; *&t;detect is disabled.&n; *&t;&n; *&t;Revision 1.37  1999/03/12 13:42:54  malthoff&n; *&t;Add: Jumbo Frame Support.&n; *&t;Add: Receive modes SK_LENERR_OK_ON/OFF and&n; *&t;SK_BIG_PK_OK_ON/OFF in SkXmSetRxCmd().&n; *&t;&n; *&t;Revision 1.36  1999/03/08 10:10:55  gklug&n; *&t;fix: AutoSensing did switch to next mode even if LiPa indicated offline&n; *&n; *&t;Revision 1.35  1999/02/22 15:16:41  malthoff&n; *&t;Remove some compiler warnings.&n; *&n; *&t;Revision 1.34  1999/01/22 09:19:59  gklug&n; *&t;fix: Init DupMode and InitPauseMd are now called in RxTxEnable&n; *&n; *&t;Revision 1.33  1998/12/11 15:19:11  gklug&n; *&t;chg: lipa autoneg stati&n; *&t;chg: debug messages&n; *&t;chg: do NOT use spurious XmIrq&n; *&n; *&t;Revision 1.32  1998/12/10 11:08:44  malthoff&n; *&t;bug fix: pAC has been used for IOs in SkXmHardRst().&n; *&t;SkXmInitPhy() is also called for the Diag in SkXmInitMac().&n; *&n; *&t;Revision 1.31  1998/12/10 10:39:11  gklug&n; *&t;fix: do 4 RESETS of the XMAC at the beginning&n; *&t;fix: dummy read interrupt source register BEFORE initializing the Phy&n; *&t;add: debug messages&n; *&t;fix: Linkpartners autoneg capability cannot be shown by TX_PAGE interrupt&n; *&n; *&t;Revision 1.30  1998/12/07 12:18:32  gklug&n; *&t;add: refinement of autosense mode: take into account the autoneg cap of LiPa&n; *&n; *&t;Revision 1.29  1998/12/07 07:12:29  gklug&n; *&t;fix: if page is received the link is  down.&n; *&n; *&t;Revision 1.28  1998/12/01 10:12:47  gklug&n; *&t;chg: if spurious IRQ from XMAC encountered, save it&n; *&n; *&t;Revision 1.27  1998/11/26 07:33:38  gklug&n; *&t;add: InitPhy call is now in XmInit function&n; *&n; *&t;Revision 1.26  1998/11/18 13:38:24  malthoff&n; *&t;&squot;Imsk&squot; is also unused in SkXmAutoNegDone.&n; *&n; *&t;Revision 1.25  1998/11/18 13:28:01  malthoff&n; *&t;Remove unused variable &squot;Reg&squot; in SkXmAutoNegDone().&n; *&n; *&t;Revision 1.24  1998/11/18 13:18:45  gklug&n; *&t;add: workaround for xmac errata #1&n; *&t;add: detect Link Down also when Link partner requested config&n; *&t;chg: XMIrq is only used when link is up&n; *&n; *&t;Revision 1.23  1998/11/04 07:07:04  cgoos&n; *&t;Added function SkXmRxTxEnable.&n; *&n; *&t;Revision 1.22  1998/10/30 07:35:54  gklug&n; *&t;fix: serve LinkDown interrupt when link is already down&n; *&n; *&t;Revision 1.21  1998/10/29 15:32:03  gklug&n; *&t;fix: Link Down signaling&n; *&n; *&t;Revision 1.20  1998/10/29 11:17:27  gklug&n; *&t;fix: AutoNegDone bug&n; *&n; *&t;Revision 1.19  1998/10/29 10:14:43  malthoff&n; *&t;Add endainesss comment for reading/writing MAC addresses.&n; *&n; *&t;Revision 1.18  1998/10/28 07:48:55  cgoos&n; *&t;Fix: ASS somtimes signaled although link is up.&n; *&n; *&t;Revision 1.17  1998/10/26 07:55:39  malthoff&n; *&t;Fix in SkXmInitPauseMd(): Pause Mode&n; *&t;was disabled and not enabled.&n; *&t;Fix in SkXmAutoNegDone(): Checking Mode bits&n; *&t;always failed, becaues of some missing braces.&n; *&n; *&t;Revision 1.16  1998/10/22 09:46:52  gklug&n; *&t;fix SysKonnectFileId typo&n; *&n; *&t;Revision 1.15  1998/10/21 05:51:37  gklug&n; *&t;add: para DoLoop to InitPhy function for loopback set-up&n; *&n; *&t;Revision 1.14  1998/10/16 10:59:23  malthoff&n; *&t;Remove Lint warning for dummy reads.&n; *&n; *&t;Revision 1.13  1998/10/15 14:01:20  malthoff&n; *&t;Fix: SkXmAutoNegDone() is (int) but does not return a value.&n; *&n; *&t;Revision 1.12  1998/10/14 14:45:04  malthoff&n; *&t;Remove SKERR_SIRQ_E0xx and SKERR_SIRQ_E0xxMSG by&n; *&t;SKERR_HWI_Exx and SKERR_HWI_E0xxMSG to be independant&n; *&t;from the Sirq module.&n; *&n; *&t;Revision 1.11  1998/10/14 13:59:01  gklug&n; *&t;add: InitPhy function&n; *&n; *&t;Revision 1.10  1998/10/14 11:20:57  malthoff&n; *&t;Make SkXmAutoNegDone() public, because it&squot;s&n; *&t;used in diagnostics, too.&n; *&t;The Link Up event to the RLMT is issued in&n; *&t;SkXmIrq(). SkXmIrq() is not available in&n; *&t;diagnostics. Use PHY_READ when reading&n; *&t;PHY registers.&n; *&n; *&t;Revision 1.9  1998/10/14 05:50:10  cgoos&n; *&t;Added definition for Para.&n; *&n; *&t;Revision 1.8  1998/10/14 05:41:28  gklug&n; *&t;add: Xmac IRQ&n; *&t;add: auto negotiation done function&n; *&n; *&t;Revision 1.7  1998/10/09 06:55:20  malthoff&n; *&t;The configuration of the XMACs Tx Request Threshold&n; *&t;depends from the drivers port usage now. The port&n; *&t;usage is configured in GIPortUsage.&n; *&n; *&t;Revision 1.6  1998/10/05 07:48:00  malthoff&n; *&t;minor changes&n; *&n; *&t;Revision 1.5  1998/10/01 07:03:54  gklug&n; *&t;add: dummy function for XMAC ISR&n; *&n; *&t;Revision 1.4  1998/09/30 12:37:44  malthoff&n; *&t;Add SkXmSetRxCmd() and related code.&n; *&n; *&t;Revision 1.3  1998/09/28 13:26:40  malthoff&n; *&t;Add SkXmInitMac(), SkXmInitDupMd(), and SkXmInitPauseMd()&n; *&n; *&t;Revision 1.2  1998/09/16 14:34:21  malthoff&n; *&t;Add SkXmClrExactAddr(), SkXmClrSrcCheck(),&n; *&t;SkXmClrHashAddr(), SkXmFlushTxFifo(),&n; *&t;SkXmFlushRxFifo(), and SkXmHardRst().&n; *&t;Finish Coding of SkXmSoftRst().&n; *&t;The sources may be compiled now.&n; *&n; *&t;Revision 1.1  1998/09/04 10:05:56  malthoff&n; *&t;Created.&n; *&n; *&n; ******************************************************************************/
macro_line|#include &quot;h/skdrv1st.h&quot;
macro_line|#include &quot;h/xmac_ii.h&quot;
macro_line|#include &quot;h/skdrv2nd.h&quot;
multiline_comment|/* defines ********************************************************************/
multiline_comment|/* typedefs *******************************************************************/
multiline_comment|/* global variables ***********************************************************/
multiline_comment|/* local variables ************************************************************/
DECL|variable|SysKonnectFileId
r_static
r_const
r_char
id|SysKonnectFileId
(braket
)braket
op_assign
l_string|&quot;@(#)$Id: skxmac2.c,v 1.53 2000/07/27 12:22:11 gklug Exp $ (C) SK &quot;
suffix:semicolon
multiline_comment|/* BCOM PHY magic pattern list */
DECL|struct|s_PhyHack
r_typedef
r_struct
id|s_PhyHack
(brace
DECL|member|PhyReg
r_int
id|PhyReg
suffix:semicolon
multiline_comment|/* Phy register */
DECL|member|PhyVal
id|SK_U16
id|PhyVal
suffix:semicolon
multiline_comment|/* Value to write */
DECL|typedef|BCOM_HACK
)brace
id|BCOM_HACK
suffix:semicolon
DECL|variable|BcomRegA1Hack
id|BCOM_HACK
id|BcomRegA1Hack
(braket
)braket
op_assign
(brace
(brace
l_int|0x18
comma
l_int|0x0c20
)brace
comma
(brace
l_int|0x17
comma
l_int|0x0012
)brace
comma
(brace
l_int|0x15
comma
l_int|0x1104
)brace
comma
(brace
l_int|0x17
comma
l_int|0x0013
)brace
comma
(brace
l_int|0x15
comma
l_int|0x0404
)brace
comma
(brace
l_int|0x17
comma
l_int|0x8006
)brace
comma
(brace
l_int|0x15
comma
l_int|0x0132
)brace
comma
(brace
l_int|0x17
comma
l_int|0x8006
)brace
comma
(brace
l_int|0x15
comma
l_int|0x0232
)brace
comma
(brace
l_int|0x17
comma
l_int|0x800D
)brace
comma
(brace
l_int|0x15
comma
l_int|0x000F
)brace
comma
(brace
l_int|0x18
comma
l_int|0x0420
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|BcomRegC0Hack
id|BCOM_HACK
id|BcomRegC0Hack
(braket
)braket
op_assign
(brace
(brace
l_int|0x18
comma
l_int|0x0c20
)brace
comma
(brace
l_int|0x17
comma
l_int|0x0012
)brace
comma
(brace
l_int|0x15
comma
l_int|0x1204
)brace
comma
(brace
l_int|0x17
comma
l_int|0x0013
)brace
comma
(brace
l_int|0x15
comma
l_int|0x0A04
)brace
comma
(brace
l_int|0x18
comma
l_int|0x0420
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* function prototypes ********************************************************/
r_static
r_void
id|SkXmInitPhyXmac
c_func
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
comma
id|SK_BOOL
)paren
suffix:semicolon
r_static
r_void
id|SkXmInitPhyBcom
c_func
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
comma
id|SK_BOOL
)paren
suffix:semicolon
r_static
r_void
id|SkXmInitPhyLone
c_func
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
comma
id|SK_BOOL
)paren
suffix:semicolon
r_static
r_void
id|SkXmInitPhyNat
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
comma
id|SK_BOOL
)paren
suffix:semicolon
r_static
r_int
id|SkXmAutoNegDoneXmac
c_func
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|SkXmAutoNegDoneBcom
c_func
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|SkXmAutoNegDoneLone
c_func
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|SkXmAutoNegDoneNat
(paren
id|SK_AC
op_star
comma
id|SK_IOC
comma
r_int
)paren
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmSetRxCmd() - Modify the value of the XMACs Rx Command Register&n; *&n; * Description:&n; *&t;The features&n; *&t; o FCS stripping,&t;&t;&t;SK_STRIP_FCS_ON/OFF&n; *&t; o pad byte stripping,&t;&t;&t;SK_STRIP_PAD_ON/OFF&n; *&t; o don&squot;t set XMR_FS_ERR in frame&t;SK_LENERR_OK_ON/OFF&n; *&t;   status for inrange length error&n; *&t;   frames, and&n; *&t; o don&squot;t set XMR_FS_ERR in frame&t;SK_BIG_PK_OK_ON/OFF&n; *&t;   status for frames &gt; 1514 bytes&n; *&n; *&t;for incomming packets may be enabled/disabled by this function.&n; *&t;Additional modes may be added later.&n; *&t;Multiple modes can be enabled/disabled at the same time.&n; *&t;The new configuration is stored into the HWAC port configuration&n; *&t;and is written to the Receive Command register immediatlely.&n; *&t;The new configuration is saved over any SkGePortStop() and&n; *&t;SkGeInitPort() calls. The configured value will be overwritten&n; *&t;when SkGeInit(Level 0) is executed.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmSetRxCmd
r_void
id|SkXmSetRxCmd
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* The XMAC to handle with belongs to this Port */
r_int
id|Mode
)paren
multiline_comment|/* Mode is SK_STRIP_FCS_ON/OFF, SK_STRIP_PAD_ON/OFF,&n;&t;&t;&t;&t;SK_LENERR_OK_ON/OFF, or SK_BIG_PK_OK_ON/OFF */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|OldRxMode
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
id|OldRxMode
op_assign
id|pPrt-&gt;PRxCmd
suffix:semicolon
r_switch
c_cond
(paren
id|Mode
op_amp
(paren
id|SK_STRIP_FCS_ON
op_or
id|SK_STRIP_FCS_OFF
)paren
)paren
(brace
r_case
id|SK_STRIP_FCS_ON
suffix:colon
id|pPrt-&gt;PRxCmd
op_or_assign
id|XM_RX_STRIP_FCS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_STRIP_FCS_OFF
suffix:colon
id|pPrt-&gt;PRxCmd
op_and_assign
op_complement
id|XM_RX_STRIP_FCS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|Mode
op_amp
(paren
id|SK_STRIP_PAD_ON
op_or
id|SK_STRIP_PAD_OFF
)paren
)paren
(brace
r_case
id|SK_STRIP_PAD_ON
suffix:colon
id|pPrt-&gt;PRxCmd
op_or_assign
id|XM_RX_STRIP_PAD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_STRIP_PAD_OFF
suffix:colon
id|pPrt-&gt;PRxCmd
op_and_assign
op_complement
id|XM_RX_STRIP_PAD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|Mode
op_amp
(paren
id|SK_LENERR_OK_ON
op_or
id|SK_LENERR_OK_OFF
)paren
)paren
(brace
r_case
id|SK_LENERR_OK_ON
suffix:colon
id|pPrt-&gt;PRxCmd
op_or_assign
id|XM_RX_LENERR_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LENERR_OK_OFF
suffix:colon
id|pPrt-&gt;PRxCmd
op_and_assign
op_complement
id|XM_RX_LENERR_OK
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|Mode
op_amp
(paren
id|SK_BIG_PK_OK_ON
op_or
id|SK_BIG_PK_OK_OFF
)paren
)paren
(brace
r_case
id|SK_BIG_PK_OK_ON
suffix:colon
id|pPrt-&gt;PRxCmd
op_or_assign
id|XM_RX_BIG_PK_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_BIG_PK_OK_OFF
suffix:colon
id|pPrt-&gt;PRxCmd
op_and_assign
op_complement
id|XM_RX_BIG_PK_OK
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Write the new mode to the receive command register if required */
r_if
c_cond
(paren
id|OldRxMode
op_ne
id|pPrt-&gt;PRxCmd
)paren
(brace
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_RX_CMD
comma
id|pPrt-&gt;PRxCmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmClrExactAddr() - Clear Exact Match Address Registers&n; *&n; * Description:&n; *&t;All Exact Match Address registers of the XMAC &squot;Port&squot; will be&n; *&t;cleared starting with &squot;StartNum&squot; up to (and including) the&n; *&t;Exact Match address number of &squot;StopNum&squot;.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmClrExactAddr
r_void
id|SkXmClrExactAddr
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* The XMAC to handle with belongs to this Port */
r_int
id|StartNum
comma
multiline_comment|/* Begin with this Address Register Index (0..15) */
r_int
id|StopNum
)paren
multiline_comment|/* Stop after finished with this Register Idx (0..15) */
(brace
r_int
id|i
suffix:semicolon
id|SK_U16
id|ZeroAddr
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
)brace
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|StartNum
OG
l_int|15
op_logical_or
(paren
r_int
)paren
id|StopNum
OG
l_int|15
op_logical_or
id|StartNum
OG
id|StopNum
)paren
(brace
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_HWI_E001
comma
id|SKERR_HWI_E001MSG
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|StartNum
suffix:semicolon
id|i
op_le
id|StopNum
suffix:semicolon
id|i
op_increment
)paren
(brace
id|XM_OUTADDR
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_EXM
c_func
(paren
id|i
)paren
comma
op_amp
id|ZeroAddr
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmClrSrcCheck() - Clear Source Check Address Register&n; *&n; * Description:&n; *&t;The Source Check Address Register of the XMAC &squot;Port&squot; number&n; *&t;will be cleared.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmClrSrcCheck
r_static
r_void
id|SkXmClrSrcCheck
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* The XMAC to handle with belongs to this Port (MAC_1 + n) */
(brace
id|SK_U16
id|ZeroAddr
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
)brace
suffix:semicolon
id|XM_OUTHASH
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_SRC_CHK
comma
op_amp
id|ZeroAddr
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmClrHashAddr() - Clear Hash Address Registers&n; *&n; * Description:&n; *&t;The Hash Address Register of the XMAC &squot;Port&squot; will be cleared.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmClrHashAddr
r_static
r_void
id|SkXmClrHashAddr
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* The XMAC to handle with belongs to this Port (MAC_1 + n) */
(brace
id|SK_U16
id|ZeroAddr
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
)brace
suffix:semicolon
id|XM_OUTHASH
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_HSM
comma
op_amp
id|ZeroAddr
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmFlushTxFifo() - Flush the XMACs transmit FIFO&n; *&n; * Description:&n; *&t;Flush the transmit FIFO of the XMAC specified by the index &squot;Port&squot;&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmFlushTxFifo
r_void
id|SkXmFlushTxFifo
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* The XMAC to handle with belongs to this Port (MAC_1 + n) */
(brace
id|SK_U32
id|MdReg
suffix:semicolon
id|XM_IN32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
op_amp
id|MdReg
)paren
suffix:semicolon
id|MdReg
op_or_assign
id|XM_MD_FTF
suffix:semicolon
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
id|MdReg
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmFlushRxFifo() - Flush the XMACs receive FIFO&n; *&n; * Description:&n; *&t;Flush the receive FIFO of the XMAC specified by the index &squot;Port&squot;&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmFlushRxFifo
r_void
id|SkXmFlushRxFifo
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* The XMAC to handle with belongs to this Port (MAC_1 + n) */
(brace
id|SK_U32
id|MdReg
suffix:semicolon
id|XM_IN32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
op_amp
id|MdReg
)paren
suffix:semicolon
id|MdReg
op_or_assign
id|XM_MD_FRF
suffix:semicolon
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
id|MdReg
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmSoftRst() - Do a XMAC software reset&n; *&n; * Description:&n; *&t;The PHY registers should not be destroyed during this&n; *&t;kind of software reset. Therefore the XMAC Software Reset&n; *&t;(XM_GP_RES_MAC bit in XM_GP_PORT) must not be used!&n; *&n; *&t;The software reset is done by&n; *&t;&t;- disabling the Rx and Tx state maschine,&n; *&t;&t;- reseting the statistics module,&n; *&t;&t;- clear all other significant XMAC Mode,&n; *&t;&t;  Command, and Control Registers&n; *&t;&t;- clearing the Hash Register and the&n; *&t;&t;  Exact Match Address registers, and&n; *&t;&t;- flushing the XMAC&squot;s Rx and Tx FIFOs.&n; *&n; * Note:&n; *&t;Another requirement when stopping the XMAC is to&n; *&t;avoid sending corrupted frames on the network.&n; *&t;Disabling the Tx state maschine will NOT interrupt&n; *&t;the currently transmitted frame. But we must take care&n; *&t;that the tx FIFO is cleared AFTER the current frame&n; *&t;is complete sent to the network.&n; *&n; *&t;It takes about 12ns to send a frame with 1538 bytes.&n; *&t;One PCI clock goes at least 15ns (66MHz). Therefore&n; *&t;after reading XM_GP_PORT back, we are sure that the&n; *&t;transmitter is disabled AND idle. And this means&n; *&t;we may flush the transmit FIFO now.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmSoftRst
r_void
id|SkXmSoftRst
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* port to stop (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|Word
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* disable the receiver and transmitter */
id|XM_IN16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
op_amp
id|Word
)paren
suffix:semicolon
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
id|Word
op_amp
op_complement
(paren
id|XM_MMU_ENA_RX
op_or
id|XM_MMU_ENA_TX
)paren
)paren
suffix:semicolon
multiline_comment|/* reset the statistics module */
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_GP_PORT
comma
id|XM_GP_RES_STAT
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * clear all other significant XMAC Mode,&n;&t; * Command, and Control Registers&n;&t; */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_IMSK
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* disable all IRQs */
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
l_int|0x00000000
)paren
suffix:semicolon
multiline_comment|/* clear Mode Reg */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_CMD
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* reset TX CMD Reg */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_RX_CMD
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* reset RX CMD Reg */
multiline_comment|/* disable all PHY IRQs */
r_switch
c_cond
(paren
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PhyType
)paren
(brace
r_case
id|SK_PHY_BCOM
suffix:colon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_INT_MASK
comma
l_int|0xffff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_LONE
suffix:colon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_INT_ENAB
comma
l_int|0x0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_NAT
suffix:colon
multiline_comment|/* todo: National&n;&t;&t;&t; PHY_WRITE(IoC, pPrt, Port, PHY_NAT_INT_MASK, &n;&t;&t;&t;&t;0xffff); */
r_break
suffix:semicolon
)brace
multiline_comment|/* clear the Hash Register */
id|SkXmClrHashAddr
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
multiline_comment|/* clear the Exact Match Address registers */
id|SkXmClrExactAddr
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
l_int|0
comma
l_int|15
)paren
suffix:semicolon
id|SkXmClrSrcCheck
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
multiline_comment|/* flush the XMAC&squot;s Rx and Tx FIFOs */
id|SkXmFlushTxFifo
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
id|SkXmFlushRxFifo
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PState
op_assign
id|SK_PRT_STOP
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmHardRst() - Do a XMAC hardware reset&n; *&n; * Description:&n; *&t;The XMAC of the specified &squot;Port&squot; and all connected devices&n; *&t;(PHY and SERDES) will receive a reset signal on its *Reset&n; *&t;pins.&n; *&t;External PHYs must be reset be clearing a bit in the GPIO&n; *&t;register (Timing requirements: Broadcom: 400ns, Level One:&n; *&t;none, National: 80ns).&n; *&n; * ATTENTION:&n; * &t;It is absolutely neccessary to reset the SW_RST Bit first&n; *&t;before calling this function.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmHardRst
r_void
id|SkXmHardRst
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* port to stop (MAC_1 + n) */
(brace
id|SK_U16
id|Word
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|TOut
suffix:semicolon
id|SK_U32
id|Reg
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* TX_MFF_CTRL1 is a 32 bit register but only the lowest 16 */
multiline_comment|/* bit contains buttoms to press */
id|SK_OUT16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|TX_MFF_CTRL1
)paren
comma
(paren
id|SK_U16
)paren
id|MFF_CLR_MAC_RST
)paren
suffix:semicolon
id|TOut
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|TOut
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|TOut
OG
l_int|10000
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Adapter seems to be in RESET state.&n;&t;&t;&t;&t; * Registers cannot be written.&n;&t;&t;&t;&t; */
r_return
suffix:semicolon
)brace
id|SK_OUT16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|TX_MFF_CTRL1
)paren
comma
(paren
id|SK_U16
)paren
id|MFF_SET_MAC_RST
)paren
suffix:semicolon
id|SK_IN16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|TX_MFF_CTRL1
)paren
comma
op_amp
id|Word
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|Word
op_amp
id|MFF_SET_MAC_RST
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* For external PHYs there must be special handling */
r_if
c_cond
(paren
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PhyType
op_ne
id|SK_PHY_XMAC
)paren
(brace
multiline_comment|/* reset external PHY */
id|SK_IN32
c_func
(paren
id|IoC
comma
id|B2_GP_IO
comma
op_amp
id|Reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Port
op_eq
l_int|0
)paren
(brace
id|Reg
op_or_assign
id|GP_DIR_0
suffix:semicolon
multiline_comment|/* set to output */
id|Reg
op_and_assign
op_complement
id|GP_IO_0
suffix:semicolon
)brace
r_else
(brace
id|Reg
op_or_assign
id|GP_DIR_2
suffix:semicolon
multiline_comment|/* set to output */
id|Reg
op_and_assign
op_complement
id|GP_IO_2
suffix:semicolon
)brace
id|SK_OUT32
c_func
(paren
id|IoC
comma
id|B2_GP_IO
comma
id|Reg
)paren
suffix:semicolon
multiline_comment|/* short delay */
id|SK_IN32
c_func
(paren
id|IoC
comma
id|B2_GP_IO
comma
op_amp
id|Reg
)paren
suffix:semicolon
)brace
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PState
op_assign
id|SK_PRT_RESET
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitMac() - Initialize the XMAC II&n; *&n; * Description:&n; *&t;Initialize all the XMAC of the specified port.&n; *&t;The XMAC must be reset or stopped before calling this function.&n; *&n; * Note:&n; *&t;The XMACs Rx and Tx state machine is still disabled when&n; *&t;returning.&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitMac
r_void
id|SkXmInitMac
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|SWord
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SK_U32
id|Reg
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PState
op_eq
id|SK_PRT_STOP
)paren
(brace
multiline_comment|/* Port State: SK_PRT_STOP */
multiline_comment|/* Verify that the reset bit is cleared */
id|SK_IN16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|TX_MFF_CTRL1
)paren
comma
op_amp
id|SWord
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SWord
op_amp
(paren
id|SK_U16
)paren
id|MFF_SET_MAC_RST
)paren
(brace
multiline_comment|/* PState does not match HW state */
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_HWI_E006
comma
id|SKERR_HWI_E006MSG
)paren
suffix:semicolon
multiline_comment|/* correct it */
id|pPrt-&gt;PState
op_assign
id|SK_PRT_RESET
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pPrt-&gt;PState
op_eq
id|SK_PRT_RESET
)paren
(brace
multiline_comment|/*&n;&t;&t; * clear HW reset&n;&t;&t; * Note: The SW reset is self clearing, therefore there is&n;&t;&t; *&t; nothing to do here.&n;&t;&t; */
id|SK_OUT16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|TX_MFF_CTRL1
)paren
comma
(paren
id|SK_U16
)paren
id|MFF_CLR_MAC_RST
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * clear PHY reset&n;&t;&t; */
r_if
c_cond
(paren
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PhyType
op_ne
id|SK_PHY_XMAC
)paren
(brace
id|SK_IN32
c_func
(paren
id|IoC
comma
id|B2_GP_IO
comma
op_amp
id|Reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Port
op_eq
l_int|0
)paren
(brace
id|Reg
op_or_assign
id|GP_DIR_0
suffix:semicolon
multiline_comment|/* set to output */
id|Reg
op_or_assign
id|GP_IO_0
suffix:semicolon
)brace
r_else
(brace
id|Reg
op_or_assign
id|GP_DIR_2
suffix:semicolon
multiline_comment|/* set to output */
id|Reg
op_or_assign
id|GP_IO_2
suffix:semicolon
)brace
id|SK_OUT32
c_func
(paren
id|IoC
comma
id|B2_GP_IO
comma
id|Reg
)paren
suffix:semicolon
multiline_comment|/* enable GMII interface */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_HW_CFG
comma
id|XM_HW_GMII_MD
)paren
suffix:semicolon
multiline_comment|/* optimize MDIO transfer by oppressing preamble */
id|XM_IN16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
op_amp
id|SWord
)paren
suffix:semicolon
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
id|SWord
op_or
id|XM_MMU_NO_PRE
)paren
suffix:semicolon
multiline_comment|/* Workaround BCOM Errata for the A1 type */
multiline_comment|/* Write magic patterns to reserved registers */
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_XMAC_ID1
comma
op_amp
id|SWord
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SWord
op_eq
l_int|0x6041
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|BcomRegA1Hack
(braket
id|i
)braket
dot
id|PhyReg
op_ne
l_int|0
)paren
(brace
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|BcomRegA1Hack
(braket
id|i
)braket
dot
id|PhyReg
comma
id|BcomRegA1Hack
(braket
id|i
)braket
dot
id|PhyVal
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Workaround BCOM Errata for the C0 type */
multiline_comment|/* Write magic patterns to reserved registers */
r_if
c_cond
(paren
id|SWord
op_eq
l_int|0x6044
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|BcomRegC0Hack
(braket
id|i
)braket
dot
id|PhyReg
op_ne
l_int|0
)paren
(brace
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|BcomRegC0Hack
(braket
id|i
)braket
dot
id|PhyReg
comma
id|BcomRegC0Hack
(braket
id|i
)braket
dot
id|PhyVal
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Workaround BCOM Errata (#10523) for all BCom PHYs*/
multiline_comment|/* Disable Power Management after reset */
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUX_CTRL
comma
op_amp
id|SWord
)paren
suffix:semicolon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUX_CTRL
comma
id|SWord
op_or
id|PHY_B_AC_DIS_PM
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * PHY LED initialization is performed in&n;&t;&t;&t; * SkGeXmitLED() (but not here).&n;&t;&t;&t; */
)brace
multiline_comment|/* Dummy read the Interrupt source register */
id|XM_IN16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_ISRC
comma
op_amp
id|SWord
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The autonegotiation process starts immediately after&n;&t;&t; * clearing the reset. Autonegotiation process should be&n;&t;&t; * started by the SIRQ, therefore stop it here immediately.&n;&t;&t; */
id|SkXmInitPhy
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
id|SK_FALSE
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* temp. code: enable signal detect */
multiline_comment|/* WARNING: do not override GMII setting above */
id|XM_OUT16
c_func
(paren
id|pAC
comma
id|Port
comma
id|XM_HW_CFG
comma
id|XM_HW_COM4SIG
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * configure the XMACs Station Address&n;&t; * B2_MAC_2 = xx xx xx xx xx x1 is programed to XMAC A&n;&t; * B2_MAC_3 = xx xx xx xx xx x2 is programed to XMAC B&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * The following 2 statements are together endianess&n;&t;&t; * independant. Remember this when changing.&n;&t;&t; */
id|SK_IN16
c_func
(paren
id|IoC
comma
(paren
id|B2_MAC_2
op_plus
id|Port
op_star
l_int|8
op_plus
id|i
op_star
l_int|2
)paren
comma
op_amp
id|SWord
)paren
suffix:semicolon
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
(paren
id|XM_SA
op_plus
id|i
op_star
l_int|2
)paren
comma
id|SWord
)paren
suffix:semicolon
)brace
multiline_comment|/* Tx Inter Packet Gap (XM_TX_IPG):&t;use default */
multiline_comment|/* Tx High Water Mark (XM_TX_HI_WM):&t;use default */
multiline_comment|/* Tx Low Water Mark (XM_TX_LO_WM):&t;use default */
multiline_comment|/* Host Request Threshold (XM_HT_THR):&t;use default */
multiline_comment|/* Rx Request Threshold (XM_RX_THR):&t;use default */
multiline_comment|/* Rx Low Water Mark (XM_RX_LO_WM):&t;use default */
multiline_comment|/* configure Rx High Water Mark (XM_RX_HI_WM) */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_RX_HI_WM
comma
l_int|0x05aa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIMacsFound
OG
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|pAC-&gt;GIni.GIPortUsage
)paren
(brace
r_case
id|SK_RED_LINK
suffix:colon
multiline_comment|/* Configure Tx Request Threshold for red. link */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_THR
comma
id|SK_XM_THR_REDL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_MUL_LINK
suffix:colon
multiline_comment|/* Configure Tx Request Threshold for load bal. */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_THR
comma
id|SK_XM_THR_MULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_JUMBO_LINK
suffix:colon
multiline_comment|/* Configure Tx Request Threshold for jumbo frames */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_THR
comma
id|SK_XM_THR_JUMBO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_HWI_E014
comma
id|SKERR_HWI_E014MSG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Configure Tx Request Threshold for single port */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_THR
comma
id|SK_XM_THR_SL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * setup register defaults for the Rx Command Register&n;&t; *&t;- Enable Automatic Frame Padding on Tx side&n;&t; */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_CMD
comma
id|XM_TX_AUTO_PAD
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * setup register defaults for the Rx Command Register,&n;&t; * program value of PRxCmd&n;&t; */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_RX_CMD
comma
id|pPrt-&gt;PRxCmd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * setup register defaults for the Mode Register&n;&t; *&t;- Don&squot;t strip error frames to avoid Store &amp; Forward&n;&t; *&t;  on the rx side.&n;&t; *&t;- Enable &squot;Check Station Address&squot; bit&n;&t; *&t;- Enable &squot;Check Address Array&squot; bit&n;&t; */
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
id|XM_DEF_MODE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the Receive Counter Event Mask (XM_RX_EV_MSK)&n;&t; *&t;- Enable all bits excepting &squot;Octets Rx OK Low CntOv&squot;&n;&t; *&t;  and &squot;Octets Rx OK Hi Cnt Ov&squot;.&n;&t; */
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_RX_EV_MSK
comma
id|XMR_DEF_MSK
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the Transmit Counter Event Mask (XM_TX_EV_MSK)&n;&t; *&t;- Enable all bits excepting &squot;Octets Tx OK Low CntOv&squot;&n;&t; *&t;  and &squot;Octets Tx OK Hi Cnt Ov&squot;.&n;&t; */
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_TX_EV_MSK
comma
id|XMT_DEF_MSK
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Do NOT init XMAC interrupt mask here.&n;&t; * All interrupts remain disable until link comes up!&n;&t; */
id|pPrt-&gt;PState
op_assign
id|SK_PRT_INIT
suffix:semicolon
multiline_comment|/*&n;&t; * Any additional configuration changes may be done now.&n;&t; * The last action is to enable the rx and tx state machine.&n;&t; * This should be done after the autonegotiation process&n;&t; * has been completed successfully.&n;&t; */
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitDupMd() - Initialize the XMACs Duplex Mode&n; *&n; * Description:&n; *&t;This function initilaizes the XMACs Duplex Mode.&n; *&t;It should be called after successfully finishing&n; *&t;the Autonegotiation Process&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitDupMd
r_void
id|SkXmInitDupMd
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
r_switch
c_cond
(paren
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PLinkModeStatus
)paren
(brace
r_case
id|SK_LMODE_STAT_AUTOHALF
suffix:colon
r_case
id|SK_LMODE_STAT_HALF
suffix:colon
multiline_comment|/* Configuration Actions for Half Duplex Mode */
multiline_comment|/*&n;&t;&t; * XM_BURST = default value. We are propable not quick&n;&t;&t; * &t;enough at the &squot;XMAC&squot; bus to burst 8kB.&n;&t;&t; *&t;The XMAC stopps bursting if no transmit frames&n;&t;&t; *&t;are available or the burst limit is exceeded.&n;&t;&t; */
multiline_comment|/* XM_TX_RT_LIM = default value (15) */
multiline_comment|/* XM_TX_STIME = default value (0xff = 4096 bit times) */
r_break
suffix:semicolon
r_case
id|SK_LMODE_STAT_AUTOFULL
suffix:colon
r_case
id|SK_LMODE_STAT_FULL
suffix:colon
multiline_comment|/* Configuration Actions for Full Duplex Mode */
multiline_comment|/*&n;&t;&t; * The duplex mode is configured by the PHY,&n;&t;&t; * therefore it seems to be that there is nothing&n;&t;&t; * to do here.&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|SK_LMODE_STAT_UNKNOWN
suffix:colon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
comma
id|SKERR_HWI_E007
comma
id|SKERR_HWI_E007MSG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitPauseMd() - initialize the Pause Mode to be used for this port&n; *&n; * Description:&n; *&t;This function initilaizes the Pause Mode which should&n; *&t;be used for this port.&n; *&t;It should be called after successfully finishing&n; *&t;the Autonegotiation Process&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitPauseMd
r_void
id|SkXmInitPauseMd
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|Word
suffix:semicolon
id|SK_U32
id|DWord
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PFlowCtrlStatus
op_eq
id|SK_FLOW_STAT_NONE
op_logical_or
id|pPrt-&gt;PFlowCtrlStatus
op_eq
id|SK_FLOW_STAT_LOC_SEND
)paren
(brace
multiline_comment|/* Disable Pause Frame Reception */
id|XM_IN16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
op_amp
id|Word
)paren
suffix:semicolon
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
id|Word
op_or
id|XM_MMU_IGN_PF
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * enabling pause frame reception is required for 1000BT &n;&t;&t; * because the XMAC is not reset if the link is going down&n;&t;&t; */
multiline_comment|/* Enable Pause Frame Reception */
id|XM_IN16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
op_amp
id|Word
)paren
suffix:semicolon
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
id|Word
op_amp
op_complement
id|XM_MMU_IGN_PF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pPrt-&gt;PFlowCtrlStatus
op_eq
id|SK_FLOW_STAT_SYMMETRIC
op_logical_or
id|pPrt-&gt;PFlowCtrlStatus
op_eq
id|SK_FLOW_STAT_LOC_SEND
)paren
(brace
multiline_comment|/*&n;&t;&t; * Configure Pause Frame Generation&n;&t;&t; * Use internal and external Pause Frame Generation.&n;&t;&t; * Sending pause frames is edge triggert. Send a&n;&t;&t; * Pause frame with the maximum pause time if&n;&t;&t; * internal oder external FIFO full condition&n;&t;&t; * occurs. Send a zero pause time frame to&n;&t;&t; * start transmission again.&n;&t;&t; */
multiline_comment|/* XM_PAUSE_DA = &squot;010000C28001&squot; (default) */
multiline_comment|/* XM_MAC_PTIME = 0xffff (maximum) */
multiline_comment|/* remember this value is defined in big endian (!) */
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MAC_PTIME
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Set Pause Mode in Mode Register */
id|XM_IN32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
op_amp
id|DWord
)paren
suffix:semicolon
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
id|DWord
op_or
id|XM_PAUSE_MODE
)paren
suffix:semicolon
multiline_comment|/* Set Pause Mode in MAC Rx FIFO */
id|SK_OUT16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|RX_MFF_CTRL1
)paren
comma
id|MFF_ENA_PAUSE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * disable pause frame generation is required for 1000BT &n;&t;&t; * because the XMAC is not reset if the link is going down&n;&t;&t; */
multiline_comment|/* Disable Pause Mode in Mode Register */
id|XM_IN32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
op_amp
id|DWord
)paren
suffix:semicolon
id|XM_OUT32
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MODE
comma
id|DWord
op_amp
op_complement
id|XM_PAUSE_MODE
)paren
suffix:semicolon
multiline_comment|/* Disable Pause Mode in MAC Rx FIFO */
id|SK_OUT16
c_func
(paren
id|IoC
comma
id|MR_ADDR
c_func
(paren
id|Port
comma
id|RX_MFF_CTRL1
)paren
comma
id|MFF_DIS_PAUSE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitPhy() - Initialize the XMAC II Phy registers&n; *&n; * Description:&n; *&t;Initialize all the XMACs Phy registers&n; *&n; * Note:&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitPhy
r_void
id|SkXmInitPhy
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_BOOL
id|DoLoop
)paren
multiline_comment|/* Should a Phy LOOback be set-up? */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pPrt-&gt;PhyType
)paren
(brace
r_case
id|SK_PHY_XMAC
suffix:colon
id|SkXmInitPhyXmac
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
id|DoLoop
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_BCOM
suffix:colon
id|SkXmInitPhyBcom
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
id|DoLoop
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_LONE
suffix:colon
id|SkXmInitPhyLone
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
id|DoLoop
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_NAT
suffix:colon
id|SkXmInitPhyNat
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
id|DoLoop
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitPhyXmac() - Initialize the XMAC II Phy registers&n; *&n; * Description:&n; *&t;Initialize all the XMACs Phy registers&n; *&n; * Note:&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitPhyXmac
r_static
r_void
id|SkXmInitPhyXmac
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_BOOL
id|DoLoop
)paren
multiline_comment|/* Should a Phy LOOback be set-up? */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|Crtl
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* Autonegotiation ? */
r_if
c_cond
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_HALF
op_logical_or
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_FULL
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;InitPhyXmac: no autonegotiation Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
multiline_comment|/* No Autonegiotiation */
multiline_comment|/* Set DuplexMode in Config register */
id|Crtl
op_assign
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_FULL
ques
c_cond
id|PHY_CT_DUP_MD
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Do NOT enable Autonegotiation here. This would hold&n;&t;&t; * the link down because no IDLES are transmitted&n;&t;&t; */
)brace
r_else
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;InitPhyXmac: with autonegotiation Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
multiline_comment|/* Set Autonegotiation advertisement */
id|Crtl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set Full/half duplex capabilities */
r_switch
c_cond
(paren
id|pPrt-&gt;PLinkMode
)paren
(brace
r_case
id|SK_LMODE_AUTOHALF
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_AN_HD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LMODE_AUTOFULL
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_AN_FD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LMODE_AUTOBOTH
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_AN_FD
op_or
id|PHY_X_AN_HD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E015
comma
id|SKERR_HWI_E015MSG
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pPrt-&gt;PFlowCtrlMode
)paren
(brace
r_case
id|SK_FLOW_MODE_NONE
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_P_NO_PAUSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_LOC_SEND
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_P_ASYM_MD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYMMETRIC
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_P_SYM_MD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYM_OR_REM
suffix:colon
id|Crtl
op_or_assign
id|PHY_X_P_BOTH_MD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E016
comma
id|SKERR_HWI_E016MSG
)paren
suffix:semicolon
)brace
multiline_comment|/* Write AutoNeg Advertisement Register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_XMAC_AUNE_ADV
comma
id|Crtl
)paren
suffix:semicolon
multiline_comment|/* Restart Autonegotiation */
id|Crtl
op_assign
id|PHY_CT_ANE
op_or
id|PHY_CT_RE_CFG
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DoLoop
)paren
(brace
multiline_comment|/* Set the Phy Loopback bit, too */
id|Crtl
op_or_assign
id|PHY_CT_LOOP
suffix:semicolon
)brace
multiline_comment|/* Write to the Phy control register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_XMAC_CTRL
comma
id|Crtl
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitPhyBcom() - Initialize the Broadcom Phy registers&n; *&n; * Description:&n; *&t;Initialize all the Broadcom Phy registers&n; *&n; * Note:&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitPhyBcom
r_static
r_void
id|SkXmInitPhyBcom
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_BOOL
id|DoLoop
)paren
multiline_comment|/* Should a Phy LOOback be set-up? */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|Crtl1
op_assign
id|PHY_B_CT_SP1000
suffix:semicolon
id|SK_U16
id|Crtl2
op_assign
l_int|0
suffix:semicolon
id|SK_U16
id|Crtl3
op_assign
id|PHY_SEL_TYPE
suffix:semicolon
id|SK_U16
id|Crtl4
op_assign
id|PHY_B_PEC_EN_LTR
suffix:semicolon
id|SK_U16
id|Crtl5
op_assign
id|PHY_B_AC_TX_TST
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* manuell Master/Slave ? */
r_if
c_cond
(paren
id|pPrt-&gt;PMSMode
op_ne
id|SK_MS_MODE_AUTO
)paren
(brace
id|Crtl2
op_or_assign
id|PHY_B_1000C_MSE
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PMSMode
op_eq
id|SK_MS_MODE_MASTER
)paren
(brace
id|Crtl2
op_or_assign
id|PHY_B_1000C_MSC
suffix:semicolon
)brace
)brace
multiline_comment|/* Autonegotiation ? */
r_if
c_cond
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_HALF
op_logical_or
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_FULL
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;InitPhyBcom: no autonegotiation Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
multiline_comment|/* No Autonegiotiation */
multiline_comment|/* Set DuplexMode in Config register */
id|Crtl1
op_or_assign
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_FULL
ques
c_cond
id|PHY_CT_DUP_MD
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Determine Master/Slave manuell if not already done */
r_if
c_cond
(paren
id|pPrt-&gt;PMSMode
op_eq
id|SK_MS_MODE_AUTO
)paren
(brace
id|Crtl2
op_or_assign
id|PHY_B_1000C_MSE
suffix:semicolon
multiline_comment|/* set it to Slave */
)brace
multiline_comment|/*&n;&t;&t; * Do NOT enable Autonegotiation here. This would hold&n;&t;&t; * the link down because no IDLES are transmitted&n;&t;&t; */
)brace
r_else
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;InitPhyBcom: with autonegotiation Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
multiline_comment|/* Set Autonegotiation advertisement */
multiline_comment|/* Set Full/half duplex capabilities */
r_switch
c_cond
(paren
id|pPrt-&gt;PLinkMode
)paren
(brace
r_case
id|SK_LMODE_AUTOHALF
suffix:colon
id|Crtl2
op_or_assign
id|PHY_B_1000C_AHD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LMODE_AUTOFULL
suffix:colon
id|Crtl2
op_or_assign
id|PHY_B_1000C_AFD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LMODE_AUTOBOTH
suffix:colon
id|Crtl2
op_or_assign
id|PHY_B_1000C_AFD
op_or
id|PHY_B_1000C_AHD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E015
comma
id|SKERR_HWI_E015MSG
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pPrt-&gt;PFlowCtrlMode
)paren
(brace
r_case
id|SK_FLOW_MODE_NONE
suffix:colon
id|Crtl3
op_or_assign
id|PHY_B_P_NO_PAUSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_LOC_SEND
suffix:colon
id|Crtl3
op_or_assign
id|PHY_B_P_ASYM_MD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYMMETRIC
suffix:colon
id|Crtl3
op_or_assign
id|PHY_B_P_SYM_MD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYM_OR_REM
suffix:colon
id|Crtl3
op_or_assign
id|PHY_B_P_BOTH_MD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E016
comma
id|SKERR_HWI_E016MSG
)paren
suffix:semicolon
)brace
multiline_comment|/* Restart Autonegotiation */
id|Crtl1
op_or_assign
id|PHY_CT_ANE
op_or
id|PHY_CT_RE_CFG
suffix:semicolon
)brace
multiline_comment|/* Initialize LED register here? */
multiline_comment|/* No. Please do it in SkDgXmitLed() (if required) and swap&n;&t;   init order of LEDs and XMAC. (MAl) */
multiline_comment|/* Write 1000Base-T Control Register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_1000T_CTRL
comma
id|Crtl2
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;1000Base-T Control Reg = %x&bslash;n&quot;
comma
id|Crtl2
)paren
)paren
suffix:semicolon
multiline_comment|/* Write AutoNeg Advertisement Register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUNE_ADV
comma
id|Crtl3
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNeg Advertisment Reg = %x&bslash;n&quot;
comma
id|Crtl3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DoLoop
)paren
(brace
multiline_comment|/* Set the Phy Loopback bit, too */
id|Crtl1
op_or_assign
id|PHY_CT_LOOP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIPortUsage
op_eq
id|SK_JUMBO_LINK
)paren
(brace
multiline_comment|/* configure fifo to high latency for xmission of ext. packets*/
id|Crtl4
op_or_assign
id|PHY_B_PEC_HIGH_LA
suffix:semicolon
multiline_comment|/* configure reception of extended packets */
id|Crtl5
op_or_assign
id|PHY_B_AC_LONG_PACK
suffix:semicolon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUX_CTRL
comma
id|Crtl5
)paren
suffix:semicolon
)brace
multiline_comment|/* Configure LED Traffic Mode and Jumbo Frame usage if specified */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_P_EXT_CTRL
comma
id|Crtl4
)paren
suffix:semicolon
multiline_comment|/* Write to the Phy control register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_CTRL
comma
id|Crtl1
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;PHY Control Reg = %x&bslash;n&quot;
comma
id|Crtl1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitPhyLone() - Initialize the Level One Phy registers&n; *&n; * Description:&n; *&t;Initialize all the Level One Phy registers&n; *&n; * Note:&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitPhyLone
r_static
r_void
id|SkXmInitPhyLone
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_BOOL
id|DoLoop
)paren
multiline_comment|/* Should a Phy LOOback be set-up? */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|Crtl1
op_assign
id|PHY_L_CT_SP1000
suffix:semicolon
id|SK_U16
id|Crtl2
op_assign
l_int|0
suffix:semicolon
id|SK_U16
id|Crtl3
op_assign
id|PHY_SEL_TYPE
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* manuell Master/Slave ? */
r_if
c_cond
(paren
id|pPrt-&gt;PMSMode
op_ne
id|SK_MS_MODE_AUTO
)paren
(brace
id|Crtl2
op_or_assign
id|PHY_L_1000C_MSE
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PMSMode
op_eq
id|SK_MS_MODE_MASTER
)paren
(brace
id|Crtl2
op_or_assign
id|PHY_L_1000C_MSC
suffix:semicolon
)brace
)brace
multiline_comment|/* Autonegotiation ? */
r_if
c_cond
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_HALF
op_logical_or
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_FULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * level one spec say: &quot;1000Mbps: manual mode not allowed&quot;&n;&t;&t; * but lets see what happens...&n;&t;&t; */
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
l_int|0
comma
l_string|&quot;Level One PHY only works with Autoneg&quot;
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;InitPhyLone: no autonegotiation Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
multiline_comment|/* No Autonegiotiation */
multiline_comment|/* Set DuplexMode in Config register */
id|Crtl1
op_assign
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_FULL
ques
c_cond
id|PHY_CT_DUP_MD
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Determine Master/Slave manuell if not already done */
r_if
c_cond
(paren
id|pPrt-&gt;PMSMode
op_eq
id|SK_MS_MODE_AUTO
)paren
(brace
id|Crtl2
op_or_assign
id|PHY_L_1000C_MSE
suffix:semicolon
multiline_comment|/* set it to Slave */
)brace
multiline_comment|/*&n;&t;&t; * Do NOT enable Autonegotiation here. This would hold&n;&t;&t; * the link down because no IDLES are transmitted&n;&t;&t; */
)brace
r_else
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;InitPhyLone: with autonegotiation Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
multiline_comment|/* Set Autonegotiation advertisement */
multiline_comment|/* Set Full/half duplex capabilities */
r_switch
c_cond
(paren
id|pPrt-&gt;PLinkMode
)paren
(brace
r_case
id|SK_LMODE_AUTOHALF
suffix:colon
id|Crtl2
op_or_assign
id|PHY_L_1000C_AHD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LMODE_AUTOFULL
suffix:colon
id|Crtl2
op_or_assign
id|PHY_L_1000C_AFD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_LMODE_AUTOBOTH
suffix:colon
id|Crtl2
op_or_assign
id|PHY_L_1000C_AFD
op_or
id|PHY_L_1000C_AHD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E015
comma
id|SKERR_HWI_E015MSG
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pPrt-&gt;PFlowCtrlMode
)paren
(brace
r_case
id|SK_FLOW_MODE_NONE
suffix:colon
id|Crtl3
op_or_assign
id|PHY_L_P_NO_PAUSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_LOC_SEND
suffix:colon
id|Crtl3
op_or_assign
id|PHY_L_P_ASYM_MD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYMMETRIC
suffix:colon
id|Crtl3
op_or_assign
id|PHY_L_P_SYM_MD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYM_OR_REM
suffix:colon
id|Crtl3
op_or_assign
id|PHY_L_P_BOTH_MD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E016
comma
id|SKERR_HWI_E016MSG
)paren
suffix:semicolon
)brace
multiline_comment|/* Restart Autonegotiation */
id|Crtl1
op_assign
id|PHY_CT_ANE
op_or
id|PHY_CT_RE_CFG
suffix:semicolon
)brace
multiline_comment|/* Initialize LED register here ? */
multiline_comment|/* No. Please do it in SkDgXmitLed() (if required) and swap&n;&t;   init order of LEDs and XMAC. (MAl) */
multiline_comment|/* Write 1000Base-T Control Register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_1000T_CTRL
comma
id|Crtl2
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;1000Base-T Control Reg = %x&bslash;n&quot;
comma
id|Crtl2
)paren
)paren
suffix:semicolon
multiline_comment|/* Write AutoNeg Advertisement Register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_AUNE_ADV
comma
id|Crtl3
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNeg Advertisment Reg = %x&bslash;n&quot;
comma
id|Crtl3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DoLoop
)paren
(brace
multiline_comment|/* Set the Phy Loopback bit, too */
id|Crtl1
op_or_assign
id|PHY_CT_LOOP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pAC-&gt;GIni.GIPortUsage
op_eq
id|SK_JUMBO_LINK
)paren
(brace
multiline_comment|/*&n;&t;&t; * nothing to do for Level one.&n;&t;&t; * PHY supports frames up to 10k.&n;&t;&t; */
)brace
multiline_comment|/* Write to the Phy control register */
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_CTRL
comma
id|Crtl1
)paren
suffix:semicolon
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;PHY Control Reg = %x&bslash;n&quot;
comma
id|Crtl1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmInitPhyNat() - Initialize the National Phy registers&n; *&n; * Description:&n; *&t;Initialize all the National Phy registers&n; *&n; * Note:&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmInitPhyNat
r_static
r_void
id|SkXmInitPhyNat
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_BOOL
id|DoLoop
)paren
multiline_comment|/* Should a Phy LOOback be set-up? */
(brace
multiline_comment|/* todo: National */
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegLipaXmac() - Decides whether Link Partner could do autoneg&n; *&n; *&t;This function analyses the Interrupt status word. If any of the&n; *&t;Autonegotiating interrupt bits are set, the PLipaAutoNeg variable&n; *&t;is set true.&n; */
DECL|function|SkXmAutoNegLipaXmac
r_void
id|SkXmAutoNegLipaXmac
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_U16
id|IStatus
)paren
multiline_comment|/* Interrupt Status word to analyse */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PLipaAutoNeg
op_ne
id|SK_LIPA_AUTO
op_logical_and
(paren
id|IStatus
op_amp
(paren
id|XM_IS_LIPA_RC
op_or
id|XM_IS_RX_PAGE
op_or
id|XM_IS_AND
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegLipa: AutoNeg detected on port %d %x&bslash;n&quot;
comma
id|Port
comma
id|IStatus
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PLipaAutoNeg
op_assign
id|SK_LIPA_AUTO
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegLipaBcom() - Decides whether Link Partner could do autoneg&n; *&n; *&t;This function analyses the PHY status word. If any of the&n; *&t;Autonegotiating bits are set, The PLipaAutoNeg variable&n; *&t;is set true.&n; */
DECL|function|SkXmAutoNegLipaBcom
r_void
id|SkXmAutoNegLipaBcom
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_U16
id|PhyStat
)paren
multiline_comment|/* PHY Status word to analyse */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PLipaAutoNeg
op_ne
id|SK_LIPA_AUTO
op_logical_and
(paren
id|PhyStat
op_amp
(paren
id|PHY_ST_AN_OVER
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegLipa: AutoNeg detected on port %d %x&bslash;n&quot;
comma
id|Port
comma
id|PhyStat
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PLipaAutoNeg
op_assign
id|SK_LIPA_AUTO
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegLipaLone() - Decides whether Link Partner could do autoneg&n; *&n; *&t;This function analyses the PHY status word. If any of the&n; *&t;Autonegotiating bits are set, The PLipaAutoNeg variable&n; *&t;is set true.&n; */
DECL|function|SkXmAutoNegLipaLone
r_void
id|SkXmAutoNegLipaLone
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_U16
id|PhyStat
)paren
multiline_comment|/* PHY Status word to analyse */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PLipaAutoNeg
op_ne
id|SK_LIPA_AUTO
op_logical_and
(paren
id|PhyStat
op_amp
(paren
id|PHY_ST_AN_OVER
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegLipa: AutoNeg detected on port %d %x&bslash;n&quot;
comma
id|Port
comma
id|PhyStat
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PLipaAutoNeg
op_assign
id|SK_LIPA_AUTO
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegLipaNat() - Decides whether Link Partner could do autoneg&n; *&n; *&t;This function analyses the PHY status word. If any of the&n; *&t;Autonegotiating bits are set, The PLipaAutoNeg variable&n; *&t;is set true.&n; */
DECL|function|SkXmAutoNegLipaNat
r_void
id|SkXmAutoNegLipaNat
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_U16
id|PhyStat
)paren
multiline_comment|/* PHY Status word to analyse */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PLipaAutoNeg
op_ne
id|SK_LIPA_AUTO
op_logical_and
(paren
id|PhyStat
op_amp
(paren
id|PHY_ST_AN_OVER
)paren
)paren
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegLipa: AutoNeg detected on port %d %x&bslash;n&quot;
comma
id|Port
comma
id|PhyStat
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PLipaAutoNeg
op_assign
id|SK_LIPA_AUTO
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegDone() - Auto negotiation handling&n; *&n; * Description:&n; *&t;This function handles the autonegotiation if the Done bit is set.&n; *&n; * Note:&n; *&t;o The XMACs interrupt source register is NOT read here.&n; *&t;o This function is public because it is used in the diagnostics&n; *&t;  tool, too.&n; *&n; * Returns:&n; *&t;SK_AND_OK&t;o.k.&n; *&t;SK_AND_DUP_CAP &t;Duplex capability error happened&n; *&t;SK_AND_OTHER &t;Other error happened&n; */
DECL|function|SkXmAutoNegDone
r_int
id|SkXmAutoNegDone
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pPrt-&gt;PhyType
)paren
(brace
r_case
id|SK_PHY_XMAC
suffix:colon
r_return
(paren
id|SkXmAutoNegDoneXmac
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
)paren
suffix:semicolon
r_case
id|SK_PHY_BCOM
suffix:colon
r_return
(paren
id|SkXmAutoNegDoneBcom
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
)paren
suffix:semicolon
r_case
id|SK_PHY_LONE
suffix:colon
r_return
(paren
id|SkXmAutoNegDoneLone
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
)paren
suffix:semicolon
r_case
id|SK_PHY_NAT
suffix:colon
r_return
(paren
id|SkXmAutoNegDoneNat
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
)paren
suffix:semicolon
)brace
r_return
id|SK_AND_OTHER
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegDoneXmac() - Auto negotiation handling&n; *&n; * Description:&n; *&t;This function handles the autonegotiation if the Done bit is set.&n; *&n; * Note:&n; *&t;o The XMACs interrupt source register is NOT read here.&n; *&n; * Returns:&n; *&t;SK_AND_OK&t;o.k.&n; *&t;SK_AND_DUP_CAP &t;Duplex capability error happened&n; *&t;SK_AND_OTHER &t;Other error happened&n; */
DECL|function|SkXmAutoNegDoneXmac
r_static
r_int
id|SkXmAutoNegDoneXmac
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|ResAb
suffix:semicolon
multiline_comment|/* Resolved Ability */
id|SK_U16
id|LPAb
suffix:semicolon
multiline_comment|/* Link Partner Ability */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegDoneXmac&quot;
l_string|&quot;Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* Get PHY parameters */
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_XMAC_AUNE_LP
comma
op_amp
id|LPAb
)paren
suffix:semicolon
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_XMAC_RES_ABI
comma
op_amp
id|ResAb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LPAb
op_amp
id|PHY_X_AN_RFB
)paren
(brace
multiline_comment|/* At least one of the remote fault bit is set */
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegFail: Remote fault bit set Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
r_return
(paren
id|SK_AND_OTHER
)paren
suffix:semicolon
)brace
multiline_comment|/* Check Duplex mismatch */
r_if
c_cond
(paren
(paren
id|ResAb
op_amp
(paren
id|PHY_X_RS_HD
op_or
id|PHY_X_RS_FD
)paren
)paren
op_eq
id|PHY_X_RS_FD
)paren
(brace
id|pPrt-&gt;PLinkModeStatus
op_assign
id|SK_LMODE_STAT_AUTOFULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ResAb
op_amp
(paren
id|PHY_X_RS_HD
op_or
id|PHY_X_RS_FD
)paren
)paren
op_eq
id|PHY_X_RS_HD
)paren
(brace
id|pPrt-&gt;PLinkModeStatus
op_assign
id|SK_LMODE_STAT_AUTOHALF
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegFail: Duplex mode mismatch port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
r_return
(paren
id|SK_AND_DUP_CAP
)paren
suffix:semicolon
)brace
multiline_comment|/* Check PAUSE mismatch */
multiline_comment|/* We are NOT using chapter 4.23 of the Xaqti manual */
multiline_comment|/* We are using IEEE 802.3z/D5.0 Table 37-4 */
r_if
c_cond
(paren
(paren
id|pPrt-&gt;PFlowCtrlMode
op_eq
id|SK_FLOW_MODE_SYMMETRIC
op_logical_or
id|pPrt-&gt;PFlowCtrlMode
op_eq
id|SK_FLOW_MODE_SYM_OR_REM
)paren
op_logical_and
(paren
id|LPAb
op_amp
id|PHY_X_P_SYM_MD
)paren
)paren
(brace
multiline_comment|/* Symmetric PAUSE */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_SYMMETRIC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pPrt-&gt;PFlowCtrlMode
op_eq
id|SK_FLOW_MODE_SYM_OR_REM
op_logical_and
(paren
id|LPAb
op_amp
id|PHY_X_RS_PAUSE
)paren
op_eq
id|PHY_X_P_ASYM_MD
)paren
(brace
multiline_comment|/* Enable PAUSE receive, disable PAUSE transmit */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_REM_SEND
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pPrt-&gt;PFlowCtrlMode
op_eq
id|SK_FLOW_MODE_LOC_SEND
op_logical_and
(paren
id|LPAb
op_amp
id|PHY_X_RS_PAUSE
)paren
op_eq
id|PHY_X_P_BOTH_MD
)paren
(brace
multiline_comment|/* Disable PAUSE receive, enable PAUSE transmit */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_LOC_SEND
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* PAUSE mismatch -&gt; no PAUSE */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_NONE
suffix:semicolon
)brace
multiline_comment|/* We checked everything and may now enable the link */
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_FALSE
suffix:semicolon
id|SkXmRxTxEnable
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
r_return
(paren
id|SK_AND_OK
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegDoneBcom() - Auto negotiation handling&n; *&n; * Description:&n; *&t;This function handles the autonegotiation if the Done bit is set.&n; *&n; * Note:&n; *&t;o The XMACs interrupt source register is NOT read here.&n; *&n; * Returns:&n; *&t;SK_AND_OK&t;o.k.&n; *&t;SK_AND_DUP_CAP &t;Duplex capability error happened&n; *&t;SK_AND_OTHER &t;Other error happened&n; */
DECL|function|SkXmAutoNegDoneBcom
r_static
r_int
id|SkXmAutoNegDoneBcom
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|ResAb
suffix:semicolon
multiline_comment|/* Resolved Ability */
id|SK_U16
id|LPAb
suffix:semicolon
multiline_comment|/* Link Partner Ability */
id|SK_U16
id|AuxStat
suffix:semicolon
multiline_comment|/* Auxiliary Status */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegDoneBcom,&quot;
l_string|&quot; Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* Get PHY parameters */
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUNE_LP
comma
op_amp
id|LPAb
)paren
suffix:semicolon
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_1000T_STAT
comma
op_amp
id|ResAb
)paren
suffix:semicolon
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUX_STAT
comma
op_amp
id|AuxStat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LPAb
op_amp
id|PHY_B_AN_RF
)paren
(brace
multiline_comment|/* Remote fault bit is set */
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegFail: Remote fault bit set Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
r_return
(paren
id|SK_AND_OTHER
)paren
suffix:semicolon
)brace
multiline_comment|/* Check Duplex mismatch */
r_if
c_cond
(paren
(paren
id|AuxStat
op_amp
id|PHY_B_AS_AN_RES
)paren
op_eq
id|PHY_B_RES_1000FD
)paren
(brace
id|pPrt-&gt;PLinkModeStatus
op_assign
id|SK_LMODE_STAT_AUTOFULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|AuxStat
op_amp
id|PHY_B_AS_AN_RES
)paren
op_eq
id|PHY_B_RES_1000HD
)paren
(brace
id|pPrt-&gt;PLinkModeStatus
op_assign
id|SK_LMODE_STAT_AUTOHALF
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegFail: Duplex mode mismatch port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
r_return
(paren
id|SK_AND_DUP_CAP
)paren
suffix:semicolon
)brace
multiline_comment|/* Check Master/Slave resolution */
r_if
c_cond
(paren
id|ResAb
op_amp
(paren
id|PHY_B_1000S_MSF
)paren
)paren
(brace
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Master/Slave Fault port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
id|pPrt-&gt;PMSStatus
op_assign
id|SK_MS_STAT_FAULT
suffix:semicolon
r_return
(paren
id|SK_AND_OTHER
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ResAb
op_amp
id|PHY_B_1000S_MSR
)paren
(brace
id|pPrt-&gt;PMSStatus
op_assign
id|SK_MS_STAT_MASTER
suffix:semicolon
)brace
r_else
(brace
id|pPrt-&gt;PMSStatus
op_assign
id|SK_MS_STAT_SLAVE
suffix:semicolon
)brace
multiline_comment|/* Check PAUSE mismatch */
multiline_comment|/* We are NOT using chapter 4.23 of the Xaqti manual */
multiline_comment|/* We are using IEEE 802.3z/D5.0 Table 37-4 */
r_if
c_cond
(paren
(paren
id|AuxStat
op_amp
(paren
id|PHY_B_AS_PRR
op_or
id|PHY_B_AS_PRT
)paren
)paren
op_eq
(paren
id|PHY_B_AS_PRR
op_or
id|PHY_B_AS_PRT
)paren
)paren
(brace
multiline_comment|/* Symmetric PAUSE */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_SYMMETRIC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|AuxStat
op_amp
(paren
id|PHY_B_AS_PRR
op_or
id|PHY_B_AS_PRT
)paren
)paren
op_eq
id|PHY_B_AS_PRR
)paren
(brace
multiline_comment|/* Enable PAUSE receive, disable PAUSE transmit */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_REM_SEND
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|AuxStat
op_amp
(paren
id|PHY_B_AS_PRR
op_or
id|PHY_B_AS_PRT
)paren
)paren
op_eq
id|PHY_B_AS_PRT
)paren
(brace
multiline_comment|/* Disable PAUSE receive, enable PAUSE transmit */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_LOC_SEND
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* PAUSE mismatch -&gt; no PAUSE */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_NONE
suffix:semicolon
)brace
multiline_comment|/* We checked everything and may now enable the link */
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_FALSE
suffix:semicolon
id|SkXmRxTxEnable
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
r_return
(paren
id|SK_AND_OK
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegDoneLone() - Auto negotiation handling&n; *&n; * Description:&n; *&t;This function handles the autonegotiation if the Done bit is set.&n; *&n; * Note:&n; *&t;o The XMACs interrupt source register is NOT read here.&n; *&n; * Returns:&n; *&t;SK_AND_OK&t;o.k.&n; *&t;SK_AND_DUP_CAP &t;Duplex capability error happened&n; *&t;SK_AND_OTHER &t;Other error happened&n; */
DECL|function|SkXmAutoNegDoneLone
r_static
r_int
id|SkXmAutoNegDoneLone
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|ResAb
suffix:semicolon
multiline_comment|/* Resolved Ability */
id|SK_U16
id|LPAb
suffix:semicolon
multiline_comment|/* Link Partner Ability */
id|SK_U16
id|QuickStat
suffix:semicolon
multiline_comment|/* Auxiliary Status */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegDoneLone&quot;
l_string|&quot;Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
multiline_comment|/* Get PHY parameters */
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_AUNE_LP
comma
op_amp
id|LPAb
)paren
suffix:semicolon
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_1000T_STAT
comma
op_amp
id|ResAb
)paren
suffix:semicolon
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_Q_STAT
comma
op_amp
id|QuickStat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LPAb
op_amp
id|PHY_L_AN_RF
)paren
(brace
multiline_comment|/* Remote fault bit is set */
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;AutoNegFail: Remote fault bit set Port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
r_return
(paren
id|SK_AND_OTHER
)paren
suffix:semicolon
)brace
multiline_comment|/* Check Duplex mismatch */
r_if
c_cond
(paren
id|QuickStat
op_amp
id|PHY_L_QS_DUP_MOD
)paren
(brace
id|pPrt-&gt;PLinkModeStatus
op_assign
id|SK_LMODE_STAT_AUTOFULL
suffix:semicolon
)brace
r_else
(brace
id|pPrt-&gt;PLinkModeStatus
op_assign
id|SK_LMODE_STAT_AUTOHALF
suffix:semicolon
)brace
multiline_comment|/* Check Master/Slave resolution */
r_if
c_cond
(paren
id|ResAb
op_amp
(paren
id|PHY_L_1000S_MSF
)paren
)paren
(brace
multiline_comment|/* Error */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_CTRL
comma
(paren
l_string|&quot;Master/Slave Fault port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_TRUE
suffix:semicolon
id|pPrt-&gt;PMSStatus
op_assign
id|SK_MS_STAT_FAULT
suffix:semicolon
r_return
(paren
id|SK_AND_OTHER
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ResAb
op_amp
id|PHY_L_1000S_MSR
)paren
(brace
id|pPrt-&gt;PMSStatus
op_assign
id|SK_MS_STAT_MASTER
suffix:semicolon
)brace
r_else
(brace
id|pPrt-&gt;PMSStatus
op_assign
id|SK_MS_STAT_SLAVE
suffix:semicolon
)brace
multiline_comment|/* Check PAUSE mismatch */
multiline_comment|/* We are NOT using chapter 4.23 of the Xaqti manual */
multiline_comment|/* We are using IEEE 802.3z/D5.0 Table 37-4 */
multiline_comment|/* we must manually resolve the abilities here */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_NONE
suffix:semicolon
r_switch
c_cond
(paren
id|pPrt-&gt;PFlowCtrlMode
)paren
(brace
r_case
id|SK_FLOW_MODE_NONE
suffix:colon
multiline_comment|/* default */
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_LOC_SEND
suffix:colon
r_if
c_cond
(paren
(paren
id|QuickStat
op_amp
(paren
id|PHY_L_QS_PAUSE
op_or
id|PHY_L_QS_AS_PAUSE
)paren
)paren
op_eq
(paren
id|PHY_L_QS_PAUSE
op_or
id|PHY_L_QS_AS_PAUSE
)paren
)paren
(brace
multiline_comment|/* Disable PAUSE receive, enable PAUSE transmit */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_LOC_SEND
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYMMETRIC
suffix:colon
r_if
c_cond
(paren
(paren
id|QuickStat
op_amp
id|PHY_L_QS_PAUSE
)paren
op_eq
id|PHY_L_QS_PAUSE
)paren
(brace
multiline_comment|/* Symmetric PAUSE */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_SYMMETRIC
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SK_FLOW_MODE_SYM_OR_REM
suffix:colon
r_if
c_cond
(paren
(paren
id|QuickStat
op_amp
(paren
id|PHY_L_QS_PAUSE
op_or
id|PHY_L_QS_AS_PAUSE
)paren
)paren
op_eq
id|PHY_L_QS_AS_PAUSE
)paren
(brace
multiline_comment|/* Enable PAUSE receive, disable PAUSE transmit */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_REM_SEND
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|QuickStat
op_amp
id|PHY_L_QS_PAUSE
)paren
op_eq
id|PHY_L_QS_PAUSE
)paren
(brace
multiline_comment|/* Symmetric PAUSE */
id|pPrt-&gt;PFlowCtrlStatus
op_assign
id|SK_FLOW_STAT_SYMMETRIC
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_SW
op_or
id|SK_ERRCL_INIT
comma
id|SKERR_HWI_E016
comma
id|SKERR_HWI_E016MSG
)paren
suffix:semicolon
)brace
multiline_comment|/* We checked everything and may now enable the link */
id|pPrt-&gt;PAutoNegFail
op_assign
id|SK_FALSE
suffix:semicolon
id|SkXmRxTxEnable
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
r_return
id|SK_AND_OK
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmAutoNegDoneNat() - Auto negotiation handling&n; *&n; * Description:&n; *&t;This function handles the autonegotiation if the Done bit is set.&n; *&n; * Note:&n; *&t;o The XMACs interrupt source register is NOT read here.&n; *&t;o This function is public because it is used in the diagnostics&n; *&t;  tool, too.&n; *&n; * Returns:&n; *&t;SK_AND_OK&t;o.k.&n; *&t;SK_AND_DUP_CAP &t;Duplex capability error happened&n; *&t;SK_AND_OTHER &t;Other error happened&n; */
DECL|function|SkXmAutoNegDoneNat
r_static
r_int
id|SkXmAutoNegDoneNat
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
multiline_comment|/* todo: National */
r_return
id|SK_AND_OK
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmRxTxEnable() - Enable RxTx activity if port is up&n; *&n; * Description:&n; *&n; * Note:&n; *&t;o The XMACs interrupt source register is NOT read here.&n; *&n; * Returns:&n; *&t;0&t;o.k.&n; *&t;!= 0&t;Error happened&n; */
DECL|function|SkXmRxTxEnable
r_int
id|SkXmRxTxEnable
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
)paren
multiline_comment|/* Port Index (MAC_1 + n) */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_U16
id|Reg
suffix:semicolon
multiline_comment|/* 16bit register value */
id|SK_U16
id|IntMask
suffix:semicolon
multiline_comment|/* XMac interrupt mask */
id|SK_U16
id|SWord
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pPrt-&gt;PHWLinkUp
)paren
(brace
multiline_comment|/* The Hardware link is NOT up */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_AUTOHALF
op_logical_or
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_AUTOFULL
op_logical_or
id|pPrt-&gt;PLinkMode
op_eq
id|SK_LMODE_AUTOBOTH
)paren
op_logical_and
id|pPrt-&gt;PAutoNegFail
)paren
(brace
multiline_comment|/* Autonegotiation is not done or failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Set Dup Mode and Pause Mode */
id|SkXmInitDupMd
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
id|SkXmInitPauseMd
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the Interrupt Mask Register. Default IRQs are...&n;&t; *&t;- Link Asynchronous Event&n;&t; *&t;- Link Partner requests config&n;&t; *&t;- Auto Negotiation Done&n;&t; *&t;- Rx Counter Event Overflow&n;&t; *&t;- Tx Counter Event Overflow&n;&t; *&t;- Transmit FIFO Underrun&n;&t; */
r_if
c_cond
(paren
id|pPrt-&gt;PhyType
op_eq
id|SK_PHY_XMAC
)paren
(brace
id|IntMask
op_assign
id|XM_DEF_MSK
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* disable GP0 interrupt bit */
id|IntMask
op_assign
id|XM_DEF_MSK
op_or
id|XM_IS_INP_ASS
suffix:semicolon
)brace
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_IMSK
comma
id|IntMask
)paren
suffix:semicolon
multiline_comment|/* RX/TX enable */
id|XM_IN16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
op_amp
id|Reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PhyType
op_ne
id|SK_PHY_XMAC
op_logical_and
(paren
id|pPrt-&gt;PLinkModeStatus
op_eq
id|SK_LMODE_STAT_FULL
op_logical_or
id|pPrt-&gt;PLinkModeStatus
op_eq
id|SK_LMODE_STAT_AUTOFULL
)paren
)paren
(brace
id|Reg
op_or_assign
id|XM_MMU_GMII_FD
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pPrt-&gt;PhyType
)paren
(brace
r_case
id|SK_PHY_BCOM
suffix:colon
multiline_comment|/* Workaround BCOM Errata (#10523) for all BCom Phys */
multiline_comment|/* Enable Power Management after link up */
id|PHY_READ
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUX_CTRL
comma
op_amp
id|SWord
)paren
suffix:semicolon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_AUX_CTRL
comma
id|SWord
op_amp
op_complement
id|PHY_B_AC_DIS_PM
)paren
suffix:semicolon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_BCOM_INT_MASK
comma
id|PHY_B_DEF_MSK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_LONE
suffix:colon
id|PHY_WRITE
c_func
(paren
id|IoC
comma
id|pPrt
comma
id|Port
comma
id|PHY_LONE_INT_ENAB
comma
id|PHY_L_DEF_MSK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SK_PHY_NAT
suffix:colon
multiline_comment|/* todo National:&n;&t;&t;PHY_WRITE(IoC, pPrt, Port, PHY_NAT_INT_MASK, &n;&t;&t;&t;PHY_N_DEF_MSK); */
multiline_comment|/* no interrupts possible from National ??? */
r_break
suffix:semicolon
)brace
id|XM_OUT16
c_func
(paren
id|IoC
comma
id|Port
comma
id|XM_MMU_CMD
comma
id|Reg
op_or
id|XM_MMU_ENA_RX
op_or
id|XM_MMU_ENA_TX
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifndef SK_DIAG
multiline_comment|/******************************************************************************&n; *&n; *&t;SkXmIrq() - Interrupt service routine&n; *&n; * Description:&n; *&t;Services an Interrupt of the XMAC II&n; *&n; * Note:&n; *&t;The XMACs interrupt source register is NOT read here.&n; *&t;With an external PHY, some interrupt bits are not meaningfull&n; *&t;any more:&n; *&t;- LinkAsyncEvent (bit #14)              XM_IS_LNK_AE&n; *&t;- LinkPartnerReqConfig (bit #10)&t;XM_IS_LIPA_RC&n; *&t;- Page Received (bit #9)&t;&t;XM_IS_RX_PAGE&n; *&t;- NextPageLoadedForXmt (bit #8)&t;&t;XM_IS_TX_PAGE&n; *&t;- AutoNegDone (bit #7)&t;&t;&t;XM_IS_AND&n; *&t;Also probably not valid any more is the GP0 input bit:&n; *&t;- GPRegisterBit0set&t;&t;&t;XM_IS_INP_ASS&n; *&n; * Returns:&n; *&t;nothing&n; */
DECL|function|SkXmIrq
r_void
id|SkXmIrq
c_func
(paren
id|SK_AC
op_star
id|pAC
comma
multiline_comment|/* adapter context */
id|SK_IOC
id|IoC
comma
multiline_comment|/* IO context */
r_int
id|Port
comma
multiline_comment|/* Port Index (MAC_1 + n) */
id|SK_U16
id|IStatus
)paren
multiline_comment|/* Interrupt status read from the XMAC */
(brace
id|SK_GEPORT
op_star
id|pPrt
suffix:semicolon
id|SK_EVPARA
id|Para
suffix:semicolon
id|pPrt
op_assign
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pPrt-&gt;PhyType
op_ne
id|SK_PHY_XMAC
)paren
(brace
multiline_comment|/* mask bits that are not used with ext. PHY */
id|IStatus
op_and_assign
op_complement
(paren
id|XM_IS_LNK_AE
op_or
id|XM_IS_LIPA_RC
op_or
id|XM_IS_RX_PAGE
op_or
id|XM_IS_TX_PAGE
op_or
id|XM_IS_AND
op_or
id|XM_IS_INP_ASS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * LinkPartner Autonegable ?&n;&t; */
r_if
c_cond
(paren
id|pPrt-&gt;PhyType
op_eq
id|SK_PHY_XMAC
)paren
(brace
id|SkXmAutoNegLipaXmac
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
comma
id|IStatus
)paren
suffix:semicolon
)brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_IRQ
comma
(paren
l_string|&quot;XmacIrq Port %d Isr %x&bslash;n&quot;
comma
id|Port
comma
id|IStatus
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pPrt-&gt;PHWLinkUp
)paren
(brace
multiline_comment|/* Spurious XMAC interrupt */
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_IRQ
comma
(paren
l_string|&quot;SkXmIrq: spurious interrupt on port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_LNK_AE
)paren
(brace
multiline_comment|/* not used GP0 is used instead */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_TX_ABORT
)paren
(brace
multiline_comment|/* not used */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_FRC_INT
)paren
(brace
multiline_comment|/* not used. use ASIC IRQ instead if needed */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
(paren
id|XM_IS_INP_ASS
op_or
id|XM_IS_LIPA_RC
op_or
id|XM_IS_RX_PAGE
)paren
)paren
(brace
id|SkHWLinkDown
c_func
(paren
id|pAC
comma
id|IoC
comma
id|Port
)paren
suffix:semicolon
multiline_comment|/* Signal to RLMT */
id|Para.Para32
(braket
l_int|0
)braket
op_assign
(paren
id|SK_U32
)paren
id|Port
suffix:semicolon
id|SkEventQueue
c_func
(paren
id|pAC
comma
id|SKGE_RLMT
comma
id|SK_RLMT_LINK_DOWN
comma
id|Para
)paren
suffix:semicolon
multiline_comment|/* Start workaround Errata #2 timer */
id|SkTimerStart
c_func
(paren
id|pAC
comma
id|IoC
comma
op_amp
id|pAC-&gt;GIni.GP
(braket
id|Port
)braket
dot
id|PWaTimer
comma
id|SK_WA_INA_TIME
comma
id|SKGE_HWAC
comma
id|SK_HWEV_WATIM
comma
id|Para
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_RX_PAGE
)paren
(brace
multiline_comment|/* not used */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_TX_PAGE
)paren
(brace
multiline_comment|/* not used */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_AND
)paren
(brace
id|SK_DBG_MSG
c_func
(paren
id|pAC
comma
id|SK_DBGMOD_HWM
comma
id|SK_DBGCAT_IRQ
comma
(paren
l_string|&quot;SkXmIrq: AND on link that is up port %d&bslash;n&quot;
comma
id|Port
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_TSC_OV
)paren
(brace
multiline_comment|/* not used */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_RXC_OV
)paren
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
(paren
id|SK_U32
)paren
id|Port
suffix:semicolon
id|Para.Para32
(braket
l_int|1
)braket
op_assign
(paren
id|SK_U32
)paren
id|IStatus
suffix:semicolon
id|SkPnmiEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_PNMI_EVT_SIRQ_OVERFLOW
comma
id|Para
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_TXC_OV
)paren
(brace
id|Para.Para32
(braket
l_int|0
)braket
op_assign
(paren
id|SK_U32
)paren
id|Port
suffix:semicolon
id|Para.Para32
(braket
l_int|1
)braket
op_assign
(paren
id|SK_U32
)paren
id|IStatus
suffix:semicolon
id|SkPnmiEvent
c_func
(paren
id|pAC
comma
id|IoC
comma
id|SK_PNMI_EVT_SIRQ_OVERFLOW
comma
id|Para
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_RXF_OV
)paren
(brace
multiline_comment|/* normal situation -&gt; no effect */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_TXF_UR
)paren
(brace
multiline_comment|/* may NOT happen -&gt; error log */
id|SK_ERR_LOG
c_func
(paren
id|pAC
comma
id|SK_ERRCL_HW
comma
id|SKERR_SIRQ_E020
comma
id|SKERR_SIRQ_E020MSG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_TX_COMP
)paren
(brace
multiline_comment|/* not served here */
)brace
r_if
c_cond
(paren
id|IStatus
op_amp
id|XM_IS_RX_COMP
)paren
(brace
multiline_comment|/* not served here */
)brace
)brace
macro_line|#endif /* !SK_DIAG */
multiline_comment|/* End of file */
eof
