multiline_comment|/*&n; * acenic.c: Linux driver for the Alteon AceNIC Gigabit Ethernet card&n; *           and other Tigon based cards.&n; *&n; * Copyright 1998 by Jes Sorensen, &lt;Jes.Sorensen@cern.ch&gt;.&n; *&n; * Thanks to Alteon and 3Com for providing hardware and documentation&n; * enabling me to write this driver.&n; *&n; * A mailing list for discussing the use of this driver has been&n; * setup, please subscribe to the lists if you have any questions&n; * about the driver. Send mail to linux-acenic-help@sunsite.auc.dk to&n; * see how to subscribe.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
DECL|macro|PKT_COPY_THRESHOLD
mdefine_line|#define PKT_COPY_THRESHOLD 300
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &quot;acenic.h&quot;
multiline_comment|/*&n; * These must be defined before the firmware is included.&n; */
DECL|macro|MAX_TEXT_LEN
mdefine_line|#define MAX_TEXT_LEN&t;96*1024
DECL|macro|MAX_RODATA_LEN
mdefine_line|#define MAX_RODATA_LEN&t;8*1024
DECL|macro|MAX_DATA_LEN
mdefine_line|#define MAX_DATA_LEN&t;2*1024
macro_line|#include &quot;acenic_firmware.h&quot;
multiline_comment|/*&n; * This driver currently supports Tigon I and Tigon II based cards&n; * including the Alteon AceNIC and the 3Com 3C985.&n; *&n; * This card is really neat, it supports receive hardware checksumming&n; * and jumbo frames (up to 9000 bytes) and does a lot of work in the&n; * firmware. Also the programming interface is quite neat, except for&n; * the parts dealing with the i2c eeprom on the card ;-)&n; *&n; * Using jumbo frames:&n; *&n; * To enable jumbo frames, simply specify an mtu between 1500 and 9000&n; * bytes to ifconfig. Jumbo frames can be enabled or disabled at any time&n; * by running `ifconfig eth&lt;X&gt; mtu &lt;MTU&gt;&squot; with &lt;X&gt; being the Ethernet&n; * interface number and &lt;MTU&gt; being the MTU value.&n; *&n; * Module parameters:&n; *&n; * When compiled as a loadable module, the driver allows for a number&n; * of module parameters to be specified. The driver supports the&n; * following module parameters:&n; *&n; *  trace=&lt;val&gt; - Firmware trace level. This requires special traced&n; *                firmware to replace the firmware supplied with&n; *                the driver - for debugging purposes only.&n; *&n; *  link=&lt;val&gt;  - Link state. Normally you want to use the default link&n; *                parameters set by the driver. This can be used to&n; *                override these in case your switch doesn&squot;t negotiate&n; *                the link properly. Valid values are:&n; *         0x0001 - Force half duplex link.&n; *         0x0002 - Do not negotiate line speed with the other end.&n; *         0x0010 - 10Mbit/sec link.&n; *         0x0020 - 100Mbit/sec link.&n; *         0x0040 - 1000Mbit/sec link.&n; *         0x0100 - Do not negotiate flow control.&n; *         0x0200 - Enable RX flow control Y&n; *         0x0400 - Enable TX flow control Y (Tigon II NICs only).&n; *                Default value is 0x0270, ie. enable link+flow&n; *                control negotiation. Negotiating the highest&n; *                possible link speed with RX flow control enabled.&n; *&n; *                When disabling link speed negotiation, only one link&n; *                speed is allowed to be specified!&n; *&n; *  tx_coal_tick=&lt;val&gt; - number of coalescing clock ticks (us) allowed&n; *                to wait for more packets to arive before&n; *                interrupting the host, from the time the first&n; *                packet arrives.&n; *&n; *  rx_coal_tick=&lt;val&gt; - number of coalescing clock ticks (us) allowed&n; *                to wait for more packets to arive in the transmit ring,&n; *                before interrupting the host, after transmitting the&n; *                first packet in the ring.&n; *&n; *  max_tx_desc=&lt;val&gt; - maximum number of transmit descriptors&n; *                (packets) transmitted before interrupting the host.&n; *&n; *  max_rx_desc=&lt;val&gt; - maximum number of receive descriptors&n; *                (packets) received before interrupting the host.&n; *&n; * If you use more than one NIC, specify the parameters for the&n; * individual NICs with a comma, ie. trace=0,0x00001fff,0 you want to&n; * run tracing on NIC #2 but not on NIC #1 and #3.&n; *&n; * TODO:&n; *&n; * - Add multicast support.&n; * - The Tigon II firmware fails to run in some PCs.&n; * - NIC dump support.&n; * - More tuning parameters.&n; */
DECL|variable|link
r_static
r_int
id|link
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|trace
r_static
r_int
id|trace
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|tx_coal_tick
r_static
r_int
id|tx_coal_tick
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|rx_coal_tick
r_static
r_int
id|rx_coal_tick
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|max_tx_desc
r_static
r_int
id|max_tx_desc
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|max_rx_desc
r_static
r_int
id|max_rx_desc
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;acenic.c: v0.22 01/07/99  Jes Sorensen (Jes.Sorensen@cern.ch)&bslash;n&quot;
suffix:semicolon
DECL|variable|root_dev
r_static
r_struct
id|device
op_star
id|root_dev
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|ace_load_firmware
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|acenic_probe
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_static
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|boards_found
op_assign
l_int|0
suffix:semicolon
r_int
id|version_disp
suffix:semicolon
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
id|u8
id|pci_latency
suffix:semicolon
macro_line|#if 0
id|u16
id|vendor
comma
id|device
suffix:semicolon
id|u8
id|pci_bus
suffix:semicolon
id|u8
id|pci_dev_fun
suffix:semicolon
id|u8
id|irq
suffix:semicolon
macro_line|#endif
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* is PCI support present? */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|version_disp
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_class
c_func
(paren
id|PCI_CLASS_NETWORK_ETHERNET
op_lshift
l_int|8
comma
id|pdev
)paren
)paren
)paren
(brace
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;vendor
op_ne
id|PCI_VENDOR_ID_ALTEON
)paren
op_logical_and
op_logical_neg
(paren
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_3COM
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_3COM_3C985
)paren
)paren
)paren
r_continue
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|ace_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to allocate etherdev &quot;
l_string|&quot;structure!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;priv
)paren
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ap
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ap
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ap-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ap-&gt;vendor
op_assign
id|pdev-&gt;vendor
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#ifdef __SMP__
id|spin_lock_init
c_func
(paren
op_amp
id|ap-&gt;lock
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;open
op_assign
op_amp
id|ace_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|ace_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|ace_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|ace_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|ace_set_multicast_list
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
op_amp
id|ace_set_mac_addr
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
op_amp
id|ace_change_mtu
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Dummy value.&n;&t;&t; */
id|dev-&gt;base_addr
op_assign
l_int|42
suffix:semicolon
multiline_comment|/* display version info if adapter is found */
r_if
c_cond
(paren
op_logical_neg
id|version_disp
)paren
(brace
multiline_comment|/* set display flag to TRUE so that */
multiline_comment|/* we only display this string ONCE */
id|version_disp
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|ap-&gt;pci_command
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|pci_latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_latency
op_le
l_int|0x40
)paren
(brace
id|pci_latency
op_assign
l_int|0x40
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
id|pci_latency
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ap-&gt;vendor
)paren
(brace
r_case
id|PCI_VENDOR_ID_ALTEON
suffix:colon
id|sprintf
c_func
(paren
id|ap-&gt;name
comma
l_string|&quot;AceNIC Gigabit Ethernet&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Alteon AceNIC &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_VENDOR_ID_3COM
suffix:colon
id|sprintf
c_func
(paren
id|ap-&gt;name
comma
l_string|&quot;3Com 3C985 Gigabit Ethernet&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 3Com 3C985 &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|ap-&gt;name
comma
l_string|&quot;Unknown AceNIC based Gigabit Ethernet&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown AceNIC &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Gigabit Ethernet at 0x%08lx, irq %i, PCI latency %i &quot;
l_string|&quot;clks&bslash;n&quot;
comma
id|pdev-&gt;base_address
(braket
l_int|0
)braket
comma
id|dev-&gt;irq
comma
id|pci_latency
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Remap the regs into kernel space.&n;&t;&t; */
id|ap-&gt;regs
op_assign
(paren
r_struct
id|ace_regs
op_star
)paren
id|ioremap
c_func
(paren
id|pdev-&gt;base_address
(braket
l_int|0
)braket
comma
l_int|0x4000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:  Unable to map I/O register, &quot;
l_string|&quot;AceNIC %i will be disabled.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|ace_init
c_func
(paren
id|dev
comma
id|boards_found
)paren
suffix:semicolon
macro_line|#else
id|ace_init
c_func
(paren
id|dev
comma
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|boards_found
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is bollocks, but we need to tell the net-init&n;&t;&t; * code that it shall go for the next device.&n;&t;&t; */
id|dev-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we&squot;re at this point we&squot;re going through ace_probe() for&n;&t; * the first time.  Return success (0) if we&squot;ve initialized 1&n;&t; * or more boards. Otherwise, return failure (-ENODEV).&n;&t; */
macro_line|#ifdef MODULE
r_return
id|boards_found
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|boards_found
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef MODULE
macro_line|#if LINUX_VERSION_CODE &gt; 0x20118
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jes Sorensen &lt;Jes.Sorensen@cern.ch&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;AceNIC/3C985 Gigabit Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|link
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|trace
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tx_coal_tick
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_tx_desc
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_coal_tick
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_rx_desc
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|cards
suffix:semicolon
id|root_dev
op_assign
l_int|NULL
suffix:semicolon
id|cards
op_assign
id|acenic_probe
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_return
id|cards
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|device
op_star
id|next
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|root_dev
)paren
(brace
id|next
op_assign
(paren
(paren
r_struct
id|ace_private
op_star
)paren
id|root_dev-&gt;priv
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|root_dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|regs-&gt;CpuCtrl
op_or_assign
id|CPU_HALT
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
id|regs-&gt;CpuBCtrl
op_or_assign
id|CPU_HALT
suffix:semicolon
id|regs-&gt;Mb0Lo
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Release the RX buffers.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_STD_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ap-&gt;rx_std_skbuff
(braket
id|i
)braket
)paren
(brace
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ap-&gt;rx_std_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|iounmap
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;trace_buf
)paren
(brace
id|kfree
c_func
(paren
id|ap-&gt;trace_buf
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ap-&gt;info
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|root_dev-&gt;irq
comma
id|root_dev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_dev
)paren
suffix:semicolon
id|root_dev
op_assign
id|next
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Commands are considered to be slow.&n; */
DECL|function|ace_issue_cmd
r_static
r_inline
r_void
id|ace_issue_cmd
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
comma
r_struct
id|cmd
op_star
id|cmd
)paren
(brace
id|u32
id|idx
suffix:semicolon
id|idx
op_assign
id|regs-&gt;CmdPrd
suffix:semicolon
id|regs-&gt;CmdRng
(braket
id|idx
)braket
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|CMD_RING_ENTRIES
suffix:semicolon
id|regs-&gt;CmdPrd
op_assign
id|idx
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|ace_init
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|board_idx
)paren
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|ace_info
op_star
id|info
suffix:semicolon
id|u32
id|tig_ver
comma
id|mac1
comma
id|mac2
comma
id|tmp
suffix:semicolon
r_int
r_int
id|tmp_ptr
comma
id|myjif
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ap
op_assign
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
macro_line|#if 0
id|regs-&gt;HostCtrl
op_or_assign
l_int|0x08
suffix:semicolon
id|regs-&gt;CpuCtrl
op_assign
id|CPU_RESET
suffix:semicolon
id|regs-&gt;CpuBCtrl
op_assign
id|CPU_RESET
suffix:semicolon
(brace
r_int
id|myjif
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|myjif
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Don&squot;t access any other registes before this point!&n;&t; */
macro_line|#ifdef __BIG_ENDIAN
id|regs-&gt;HostCtrl
op_assign
(paren
(paren
id|BYTE_SWAP
op_or
id|WORD_SWAP
op_or
id|CLR_INT
)paren
op_or
(paren
(paren
id|BYTE_SWAP
op_or
id|WORD_SWAP
op_or
id|CLR_INT
)paren
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
macro_line|#else
id|regs-&gt;HostCtrl
op_assign
(paren
id|CLR_INT
op_or
id|WORD_SWAP
op_or
(paren
(paren
id|CLR_INT
op_or
id|WORD_SWAP
)paren
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __LITTLE_ENDIAN
id|regs-&gt;ModeStat
op_assign
id|ACE_BYTE_SWAP_DATA
op_or
id|ACE_WARN
op_or
id|ACE_FATAL
op_or
id|ACE_WORD_SWAP
suffix:semicolon
macro_line|#else
macro_line|#error &quot;this driver doesn&squot;t run on big-endian machines yet!&quot;
macro_line|#endif
multiline_comment|/*&n;&t; * Stop the NIC CPU and clear pending interrupts&n;&t; */
id|regs-&gt;CpuCtrl
op_or_assign
id|CPU_HALT
suffix:semicolon
id|regs-&gt;Mb0Lo
op_assign
l_int|0
suffix:semicolon
id|tig_ver
op_assign
id|regs-&gt;HostCtrl
op_rshift
l_int|28
suffix:semicolon
r_switch
c_cond
(paren
id|tig_ver
)paren
(brace
r_case
l_int|4
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Tigon I (Rev. 4), Firmware: %i.%i.%i, &quot;
comma
id|tigonFwReleaseMajor
comma
id|tigonFwReleaseMinor
comma
id|tigonFwReleaseFix
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;version
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Tigon II (Rev. %i), Firmware: %i.%i.%i, &quot;
comma
id|tig_ver
comma
id|tigon2FwReleaseMajor
comma
id|tigon2FwReleaseMinor
comma
id|tigon2FwReleaseFix
)paren
suffix:semicolon
id|regs-&gt;CpuBCtrl
op_or_assign
id|CPU_HALT
suffix:semicolon
id|regs-&gt;LocalCtrl
op_assign
id|SRAM_BANK_512K
suffix:semicolon
id|regs-&gt;MiscCfg
op_assign
id|SYNC_SRAM_TIMING
suffix:semicolon
id|ap-&gt;version
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Unsupported Tigon version detected (%i), &quot;
comma
id|tig_ver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|mac1
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mac1
op_assign
id|mac1
op_lshift
l_int|8
suffix:semicolon
id|mac1
op_or_assign
id|read_eeprom_byte
c_func
(paren
id|regs
comma
l_int|0x8c
op_plus
id|i
)paren
suffix:semicolon
)brace
id|mac2
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mac2
op_assign
id|mac2
op_lshift
l_int|8
suffix:semicolon
id|mac2
op_or_assign
id|read_eeprom_byte
c_func
(paren
id|regs
comma
l_int|0x8c
op_plus
id|i
)paren
suffix:semicolon
)brace
id|regs-&gt;MacAddrHi
op_assign
id|mac1
suffix:semicolon
id|regs-&gt;MacAddrLo
op_assign
id|mac2
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MAC: %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
(paren
id|mac1
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|mac1
op_amp
l_int|0xff
comma
(paren
id|mac2
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
(paren
id|mac2
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
comma
(paren
id|mac2
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|mac2
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
(paren
id|mac1
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
id|mac1
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
(paren
id|mac2
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
(paren
id|mac2
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
(paren
id|mac2
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|mac2
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;&t; * Set the max DMA transfer size. Seems that for most systems&n;&t; * the performance is better when no MAX parameter is&n;&t; * set. However for systems enabling PCI write and invalidate,&n;&t; * DMA writes must be set to the L1 cache line size to get&n;&t; * optimal performance.&n;&t; */
id|tmp
op_assign
id|READ_CMD_MEM
op_or
id|WRITE_CMD_MEM
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
(brace
macro_line|#if 0
multiline_comment|/*&n;&t;&t; * According to the documentation this enables writes&n;&t;&t; * to all PCI regs - NOT good.&n;&t;&t; */
id|tmp
op_or_assign
id|DMA_WRITE_ALL_ALIGN
suffix:semicolon
macro_line|#endif
id|tmp
op_or_assign
id|MEM_READ_MULTIPLE
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;pci_command
op_amp
id|PCI_COMMAND_INVALIDATE
)paren
(brace
r_switch
c_cond
(paren
id|L1_CACHE_BYTES
)paren
(brace
r_case
l_int|16
suffix:colon
id|tmp
op_or_assign
id|DMA_WRITE_MAX_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|tmp
op_or_assign
id|DMA_WRITE_MAX_32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|tmp
op_or_assign
id|DMA_WRITE_MAX_64
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Cache line size %i not &quot;
l_string|&quot;supported, PCI write and invalidate &quot;
l_string|&quot;disabled&bslash;n&quot;
comma
id|L1_CACHE_BYTES
)paren
suffix:semicolon
id|ap-&gt;pci_command
op_and_assign
op_complement
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|ap-&gt;pdev
comma
id|PCI_COMMAND
comma
id|ap-&gt;pci_command
)paren
suffix:semicolon
)brace
)brace
)brace
id|regs-&gt;PciState
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ace_interrupt
comma
id|SA_SHIRQ
comma
id|ap-&gt;name
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Requested IRQ %d is busy&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Initialize the generic info block and the command+event rings&n;&t; * and the control blocks for the transmit and receive rings&n;&t; * as they need to be setup once and for all.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ace_info
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Register the device here to be able to catch allocated&n;&t; * interrupt handlers in case the firmware doesn&squot;t come up.&n;&t; */
id|ap-&gt;next
op_assign
id|root_dev
suffix:semicolon
id|root_dev
op_assign
id|dev
suffix:semicolon
id|ap-&gt;info
op_assign
id|info
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ace_info
)paren
)paren
suffix:semicolon
id|ace_load_firmware
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ap-&gt;fw_running
op_assign
l_int|0
suffix:semicolon
id|tmp_ptr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|info
)paren
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 64)
id|regs-&gt;InfoPtrHi
op_assign
(paren
id|tmp_ptr
op_rshift
l_int|32
)paren
suffix:semicolon
macro_line|#else
id|regs-&gt;InfoPtrHi
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|regs-&gt;InfoPtrLo
op_assign
(paren
(paren
id|tmp_ptr
)paren
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ap-&gt;evt_ring
comma
l_int|0
comma
id|EVT_RING_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|event
)paren
)paren
suffix:semicolon
id|info-&gt;evt_ctrl.rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|ap-&gt;evt_ring
)paren
suffix:semicolon
id|info-&gt;evt_ctrl.flags
op_assign
l_int|0
suffix:semicolon
id|info-&gt;evt_prd_ptr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ap-&gt;evt_prd
)paren
suffix:semicolon
id|ap-&gt;evt_prd
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;EvtCsm
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cmd_ctrl.flags
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cmd_ctrl.rngptr
op_assign
l_int|0x100
suffix:semicolon
id|info-&gt;cmd_ctrl.max_len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CMD_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|regs-&gt;CmdRng
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|regs-&gt;CmdPrd
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;CmdCsm
op_assign
l_int|0
suffix:semicolon
id|info-&gt;stats2_ptr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|info-&gt;s.stats
)paren
suffix:semicolon
id|info-&gt;rx_std_ctrl.max_len
op_assign
id|ACE_STD_MTU
op_plus
id|ETH_HLEN
op_plus
l_int|4
suffix:semicolon
id|info-&gt;rx_std_ctrl.rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|ap-&gt;rx_std_ring
)paren
suffix:semicolon
id|info-&gt;rx_std_ctrl.flags
op_assign
id|RX_TCP_UDP_SUM
suffix:semicolon
id|memset
c_func
(paren
id|ap-&gt;rx_std_ring
comma
l_int|0
comma
id|RX_STD_RING_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
)paren
suffix:semicolon
id|info-&gt;rx_jumbo_ctrl.max_len
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_jumbo_ctrl.rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|ap-&gt;rx_jumbo_ring
)paren
suffix:semicolon
id|info-&gt;rx_jumbo_ctrl.flags
op_assign
id|RX_TCP_UDP_SUM
suffix:semicolon
id|memset
c_func
(paren
id|ap-&gt;rx_jumbo_ring
comma
l_int|0
comma
id|RX_JUMBO_RING_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
)paren
suffix:semicolon
id|info-&gt;rx_return_ctrl.max_len
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_return_ctrl.rngptr
op_assign
id|virt_to_bus
c_func
(paren
id|ap-&gt;rx_return_ring
)paren
suffix:semicolon
id|info-&gt;rx_return_ctrl.flags
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|ap-&gt;rx_return_ring
comma
l_int|0
comma
id|RX_RETURN_RING_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
)paren
suffix:semicolon
id|info-&gt;rx_ret_prd_ptr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ap-&gt;rx_ret_prd
)paren
suffix:semicolon
id|regs-&gt;WinBase
op_assign
id|TX_RING_BASE
suffix:semicolon
id|ap-&gt;tx_ring
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|regs-&gt;Window
suffix:semicolon
id|memset
c_func
(paren
id|ap-&gt;tx_ring
comma
l_int|0
comma
id|TX_RING_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
)paren
suffix:semicolon
id|info-&gt;tx_ctrl.max_len
op_assign
id|TX_RING_ENTRIES
suffix:semicolon
id|info-&gt;tx_ctrl.flags
op_assign
l_int|0
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 64) &amp;&amp; defined(__BIG_ENDIAN)
id|info-&gt;tx_ctrl.rngptr
op_assign
id|TX_RING_BASE
op_lshift
l_int|32
suffix:semicolon
macro_line|#else
id|info-&gt;tx_ctrl.rngptr
op_assign
id|TX_RING_BASE
suffix:semicolon
macro_line|#endif
id|info-&gt;tx_csm_ptr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ap-&gt;tx_csm
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Potential item for tuning parameter&n;&t; */
id|regs-&gt;DmaReadCfg
op_assign
id|DMA_THRESH_8W
suffix:semicolon
id|regs-&gt;DmaWriteCfg
op_assign
id|DMA_THRESH_8W
suffix:semicolon
id|regs-&gt;MaskInt
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;IfIdx
op_assign
l_int|1
suffix:semicolon
id|regs-&gt;AssistState
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
(brace
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|regs-&gt;MacRxState
suffix:semicolon
id|tmp
op_and_assign
op_complement
l_int|4
suffix:semicolon
id|regs-&gt;MacRxState
op_assign
id|tmp
suffix:semicolon
)brace
macro_line|#endif
id|regs-&gt;TuneStatTicks
op_assign
l_int|2
op_star
id|TICKS_PER_SEC
suffix:semicolon
r_if
c_cond
(paren
id|board_idx
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|board_idx
OL
l_int|8
)paren
op_logical_and
id|tx_coal_tick
(braket
id|board_idx
)braket
)paren
id|regs-&gt;TuneTxCoalTicks
op_assign
id|tx_coal_tick
(braket
id|board_idx
)braket
op_star
id|TICKS_PER_SEC
op_div
l_int|1000
suffix:semicolon
r_else
id|regs-&gt;TuneTxCoalTicks
op_assign
id|TICKS_PER_SEC
op_div
l_int|500
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board_idx
OL
l_int|8
)paren
op_logical_and
id|max_tx_desc
(braket
id|board_idx
)braket
)paren
id|regs-&gt;TuneMaxTxDesc
op_assign
id|max_tx_desc
(braket
id|board_idx
)braket
suffix:semicolon
r_else
id|regs-&gt;TuneMaxTxDesc
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board_idx
OL
l_int|8
)paren
op_logical_and
id|rx_coal_tick
(braket
id|board_idx
)braket
)paren
id|regs-&gt;TuneRxCoalTicks
op_assign
id|rx_coal_tick
(braket
id|board_idx
)braket
op_star
id|TICKS_PER_SEC
op_div
l_int|1000
suffix:semicolon
r_else
id|regs-&gt;TuneRxCoalTicks
op_assign
id|TICKS_PER_SEC
op_div
l_int|10000
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board_idx
OL
l_int|8
)paren
op_logical_and
id|max_rx_desc
(braket
id|board_idx
)braket
)paren
id|regs-&gt;TuneMaxRxDesc
op_assign
id|max_rx_desc
(braket
id|board_idx
)braket
suffix:semicolon
r_else
id|regs-&gt;TuneMaxRxDesc
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|board_idx
OL
l_int|8
)paren
id|regs-&gt;TuneTrace
op_assign
id|trace
(braket
id|board_idx
)braket
suffix:semicolon
r_else
id|regs-&gt;TuneTrace
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|regs-&gt;TuneTxCoalTicks
op_assign
id|TICKS_PER_SEC
op_div
l_int|500
suffix:semicolon
id|regs-&gt;TuneMaxTxDesc
op_assign
l_int|7
suffix:semicolon
id|regs-&gt;TuneRxCoalTicks
op_assign
id|TICKS_PER_SEC
op_div
l_int|10000
suffix:semicolon
id|regs-&gt;TuneMaxRxDesc
op_assign
l_int|2
suffix:semicolon
id|regs-&gt;TuneTrace
op_assign
l_int|0
suffix:semicolon
)brace
id|tmp
op_assign
id|LNK_ENABLE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board_idx
OG
l_int|7
)paren
op_logical_or
(paren
id|board_idx
OL
l_int|0
)paren
op_logical_or
op_logical_neg
(paren
id|link
(braket
id|board_idx
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|board_idx
OG
l_int|7
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: more then 8 NICs detected, &quot;
l_string|&quot;ignoring link options!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * No link options specified, we go for the defaults&n;&t;&t; */
id|tmp
op_or_assign
id|LNK_FULL_DUPLEX
op_or
id|LNK_1000MB
op_or
id|LNK_100MB
op_or
id|LNK_10MB
op_or
id|LNK_RX_FLOW_CTL_Y
op_or
id|LNK_NEG_FCTL
op_or
id|LNK_NEGOTIATE
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
(brace
id|tmp
op_or_assign
id|LNK_TX_FLOW_CTL_Y
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|option
op_assign
id|link
(braket
id|board_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting half duplex link&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tmp
op_or_assign
id|LNK_FULL_DUPLEX
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|option
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
id|tmp
op_or_assign
id|LNK_NEGOTIATE
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
l_int|0x10
)paren
id|tmp
op_or_assign
id|LNK_10MB
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
l_int|0x20
)paren
id|tmp
op_or_assign
id|LNK_100MB
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
l_int|0x40
)paren
id|tmp
op_or_assign
id|LNK_1000MB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|option
op_amp
l_int|0x70
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: No media speed specified, &quot;
l_string|&quot;forcing auto negotiation&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tmp
op_or_assign
id|LNK_NEGOTIATE
op_or
id|LNK_1000MB
op_or
id|LNK_100MB
op_or
id|LNK_10MB
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|option
op_amp
l_int|0x100
)paren
op_eq
l_int|0
)paren
id|tmp
op_or_assign
id|LNK_NEG_FCTL
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Disabling flow control &quot;
l_string|&quot;negotiation&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
l_int|0x200
)paren
id|tmp
op_or_assign
id|LNK_RX_FLOW_CTL_Y
suffix:semicolon
r_if
c_cond
(paren
(paren
id|option
op_amp
l_int|0x400
)paren
op_logical_and
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling TX flow control&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tmp
op_or_assign
id|LNK_TX_FLOW_CTL_Y
suffix:semicolon
)brace
)brace
id|regs-&gt;TuneLink
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
id|regs-&gt;TuneFastLink
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|1
)paren
id|regs-&gt;Pc
op_assign
id|tigonFwStartAddr
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
id|regs-&gt;Pc
op_assign
id|tigon2FwStartAddr
suffix:semicolon
id|regs-&gt;Mb0Lo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Start the NIC CPU&n;&t; */
id|regs-&gt;CpuCtrl
op_assign
(paren
id|regs-&gt;CpuCtrl
op_amp
op_complement
(paren
id|CPU_HALT
op_or
id|CPU_TRACE
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for the firmware to spin up - max 3 seconds.&n;&t; */
id|myjif
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|myjif
)paren
op_logical_and
op_logical_neg
id|ap-&gt;fw_running
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap-&gt;fw_running
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Firmware NOT running!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ace_dump_trace
c_func
(paren
id|ap
)paren
suffix:semicolon
id|regs-&gt;CpuCtrl
op_or_assign
id|CPU_HALT
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We load the ring here as there seem to be no way to tell the&n;&t; * firmware to wipe the ring without re-initializing it.&n;&t; */
id|ace_load_std_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Monitor the card to detect hangs.&n; */
DECL|function|ace_timer
r_static
r_void
id|ace_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ace_private
op_star
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
multiline_comment|/*&n;&t; * We haven&squot;t received a stats update event for more than 2.5&n;&t; * seconds and there is data in the transmit queue, thus we&n;&t; * asume the card is stuck.&n;&t; */
r_if
c_cond
(paren
id|ap-&gt;tx_csm
op_ne
id|ap-&gt;tx_ret_csm
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmitter is stuck, %08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|regs-&gt;HostCtrl
)paren
suffix:semicolon
)brace
id|ap-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
l_int|5
op_div
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ap-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy the contents of the NIC&squot;s trace buffer to kernel memory.&n; */
DECL|function|ace_dump_trace
r_static
r_void
id|ace_dump_trace
c_func
(paren
r_struct
id|ace_private
op_star
id|ap
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ap-&gt;trace_buf
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|ap-&gt;trace_buf
op_assign
id|kmalloc
c_func
(paren
id|ACE_TRACE_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Load the standard rx ring.&n; */
DECL|function|ace_load_std_rx_ring
r_static
r_int
id|ace_load_std_rx_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|ace_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
id|info
op_assign
id|ap-&gt;info
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set tx_csm before we start receiving interrupts, otherwise&n;&t; * the interrupt handler might think it is supposed to process&n;&t; * tx ints before we are up and running, which may cause a null&n;&t; * pointer access in the int handler.&n;&t; */
id|ap-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;cur_rx
op_assign
id|ap-&gt;dirty_rx
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;tx_prd
op_assign
id|ap-&gt;tx_csm
op_assign
id|ap-&gt;tx_ret_csm
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;RxRetCsm
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_THRESH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|ACE_STD_MTU
op_plus
id|ETH_HLEN
op_plus
l_int|6
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|ap-&gt;rx_std_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Make sure the data contents end up on an aligned address&n;&t;&t; */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|size
op_assign
id|ACE_STD_MTU
op_plus
id|ETH_HLEN
op_plus
l_int|4
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|type
op_assign
id|DESC_RX
suffix:semicolon
id|ap-&gt;rx_std_ring
(braket
id|i
)braket
dot
id|idx
op_assign
id|i
suffix:semicolon
)brace
id|ap-&gt;rx_std_skbprd
op_assign
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * The last descriptor needs to be marked as being special.&n;&t; */
id|ap-&gt;rx_std_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|type
op_assign
id|DESC_END
suffix:semicolon
id|cmd.evt
op_assign
id|C_SET_RX_PRD_IDX
suffix:semicolon
id|cmd.code
op_assign
l_int|0
suffix:semicolon
id|cmd.idx
op_assign
id|ap-&gt;rx_std_skbprd
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Load the jumbo rx ring, this may happen at any time if the MTU&n; * is changed to a value &gt; 1500.&n; */
DECL|function|ace_load_jumbo_rx_ring
r_static
r_int
id|ace_load_jumbo_rx_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_THRESH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|ACE_JUMBO_MTU
op_plus
id|ETH_HLEN
op_plus
l_int|6
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|ap-&gt;rx_jumbo_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Make sure the data contents end up on an aligned address&n;&t;&t; */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|size
op_assign
id|ACE_JUMBO_MTU
op_plus
id|ETH_HLEN
op_plus
l_int|4
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|flags
op_assign
id|JUMBO_FLAG
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|type
op_assign
id|DESC_RX
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|idx
op_assign
id|i
suffix:semicolon
)brace
id|ap-&gt;rx_jumbo_skbprd
op_assign
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * The last descriptor needs to be marked as being special.&n;&t; */
id|ap-&gt;rx_jumbo_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|type
op_assign
id|DESC_END
suffix:semicolon
id|cmd.evt
op_assign
id|C_SET_RX_JUMBO_PRD_IDX
suffix:semicolon
id|cmd.code
op_assign
l_int|0
suffix:semicolon
id|cmd.idx
op_assign
id|ap-&gt;rx_jumbo_skbprd
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Tell the firmware not to accept jumbos and flush the jumbo ring.&n; * This function must be called with the spinlock held.&n; */
DECL|function|ace_flush_jumbo_rx_ring
r_static
r_int
id|ace_flush_jumbo_rx_ring
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;jumbo
)paren
(brace
id|cmd.evt
op_assign
id|C_RESET_JUMBO_RNG
suffix:semicolon
id|cmd.code
op_assign
l_int|0
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_JUMBO_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ap-&gt;rx_jumbo_skbuff
(braket
id|i
)braket
)paren
(brace
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;rx_jumbo_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ap-&gt;rx_jumbo_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Trying to flush Jumbo ring without &quot;
l_string|&quot;Jumbo support enabled&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * All events are considered to be slow (RX/TX ints do not generate&n; * events) and are handled here, outside the main interrupt handler,&n; * to reduce the size of the handler.&n; */
DECL|function|ace_handle_event
r_static
id|u32
id|ace_handle_event
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|evtcsm
comma
id|u32
id|evtprd
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_while
c_loop
(paren
id|evtcsm
op_ne
id|evtprd
)paren
(brace
r_switch
c_cond
(paren
id|ap-&gt;evt_ring
(braket
id|evtcsm
)braket
dot
id|evt
)paren
(brace
r_case
id|E_FW_RUNNING
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Firmware up and running&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ap-&gt;fw_running
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_STATS_UPDATED
suffix:colon
r_break
suffix:semicolon
r_case
id|E_LNK_STATE
suffix:colon
(brace
id|u16
id|code
op_assign
id|ap-&gt;evt_ring
(braket
id|evtcsm
)braket
dot
id|code
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|E_C_LINK_UP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Optical link UP&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|E_C_LINK_DOWN
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Optical link DOWN&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown optical link &quot;
l_string|&quot;state %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|code
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|E_ERROR
suffix:colon
r_switch
c_cond
(paren
id|ap-&gt;evt_ring
(braket
id|evtcsm
)braket
dot
id|code
)paren
(brace
r_case
id|E_C_ERR_INVAL_CMD
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid command error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_C_ERR_UNIMP_CMD
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unimplemented command &quot;
l_string|&quot;error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|E_C_ERR_BAD_CFG
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: bad config error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unknown error %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ap-&gt;evt_ring
(braket
id|evtcsm
)braket
dot
id|code
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|E_RESET_JUMBO_RNG
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unhandled event 0x%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ap-&gt;evt_ring
(braket
id|evtcsm
)braket
dot
id|evt
)paren
suffix:semicolon
)brace
id|evtcsm
op_assign
(paren
id|evtcsm
op_plus
l_int|1
)paren
op_mod
id|EVT_RING_ENTRIES
suffix:semicolon
)brace
r_return
id|evtcsm
suffix:semicolon
)brace
DECL|function|rx_int
r_static
r_int
id|rx_int
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|rxretprd
comma
id|u32
id|rxretcsm
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|idx
comma
id|oldidx
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
id|idx
op_assign
id|rxretcsm
suffix:semicolon
r_while
c_loop
(paren
id|idx
op_ne
id|rxretprd
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|newskb
comma
op_star
id|oldskb
suffix:semicolon
r_struct
id|rx_desc
op_star
id|newrxdesc
comma
op_star
id|oldrxdesc
suffix:semicolon
id|u32
id|prdidx
comma
id|size
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
id|u16
id|csum
suffix:semicolon
r_int
id|jumbo
suffix:semicolon
id|oldidx
op_assign
id|ap-&gt;rx_return_ring
(braket
id|idx
)braket
dot
id|idx
suffix:semicolon
id|jumbo
op_assign
id|ap-&gt;rx_return_ring
(braket
id|idx
)braket
dot
id|flags
op_amp
id|JUMBO_FLAG
suffix:semicolon
r_if
c_cond
(paren
id|jumbo
)paren
(brace
id|oldskb
op_assign
id|ap-&gt;rx_jumbo_skbuff
(braket
id|oldidx
)braket
suffix:semicolon
id|prdidx
op_assign
id|ap-&gt;rx_jumbo_skbprd
suffix:semicolon
id|newrxdesc
op_assign
op_amp
id|ap-&gt;rx_jumbo_ring
(braket
id|prdidx
)braket
suffix:semicolon
id|oldrxdesc
op_assign
op_amp
id|ap-&gt;rx_jumbo_ring
(braket
id|oldidx
)braket
suffix:semicolon
)brace
r_else
(brace
id|oldskb
op_assign
id|ap-&gt;rx_std_skbuff
(braket
id|oldidx
)braket
suffix:semicolon
id|prdidx
op_assign
id|ap-&gt;rx_std_skbprd
suffix:semicolon
id|newrxdesc
op_assign
op_amp
id|ap-&gt;rx_std_ring
(braket
id|prdidx
)braket
suffix:semicolon
id|oldrxdesc
op_assign
op_amp
id|ap-&gt;rx_std_ring
(braket
id|oldidx
)braket
suffix:semicolon
)brace
id|size
op_assign
id|oldrxdesc-&gt;size
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|PKT_COPY_THRESHOLD
)paren
(brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
op_plus
l_int|2
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Out of memory&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Make sure the real data is aligned&n;&t;&t;&t; */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|oldskb-&gt;data
comma
id|size
)paren
suffix:semicolon
id|addr
op_assign
id|oldrxdesc-&gt;addr
suffix:semicolon
id|newskb
op_assign
id|oldskb
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|oldskb
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
suffix:semicolon
id|newskb
op_assign
id|alloc_skb
c_func
(paren
id|size
op_plus
l_int|2
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newskb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Out of memory&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Make sure we DMA directly into nicely&n;&t;&t;&t; * aligned receive buffers&n;&t;&t;&t; */
id|skb_reserve
c_func
(paren
id|newskb
comma
l_int|2
)paren
suffix:semicolon
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|newskb-&gt;data
)paren
suffix:semicolon
)brace
id|newrxdesc-&gt;addr
op_assign
id|addr
suffix:semicolon
id|newrxdesc-&gt;size
op_assign
id|size
suffix:semicolon
id|newrxdesc-&gt;flags
op_assign
id|oldrxdesc-&gt;flags
suffix:semicolon
id|newrxdesc-&gt;idx
op_assign
id|prdidx
suffix:semicolon
id|newrxdesc-&gt;type
op_assign
id|DESC_RX
suffix:semicolon
macro_line|#if (BITS_PER_LONG == 32)
id|newrxdesc-&gt;zero
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|oldrxdesc-&gt;size
op_assign
l_int|0
suffix:semicolon
id|oldrxdesc-&gt;addr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|jumbo
)paren
(brace
id|ap-&gt;rx_jumbo_skbuff
(braket
id|oldidx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ap-&gt;rx_jumbo_skbuff
(braket
id|prdidx
)braket
op_assign
id|newskb
suffix:semicolon
id|prdidx
op_assign
(paren
id|prdidx
op_plus
l_int|1
)paren
op_mod
id|RX_JUMBO_RING_ENTRIES
suffix:semicolon
id|ap-&gt;rx_jumbo_skbprd
op_assign
id|prdidx
suffix:semicolon
)brace
r_else
(brace
id|ap-&gt;rx_std_skbuff
(braket
id|oldidx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ap-&gt;rx_std_skbuff
(braket
id|prdidx
)braket
op_assign
id|newskb
suffix:semicolon
id|prdidx
op_assign
(paren
id|prdidx
op_plus
l_int|1
)paren
op_mod
id|RX_STD_RING_ENTRIES
suffix:semicolon
id|ap-&gt;rx_std_skbprd
op_assign
id|prdidx
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Fly baby, fly!&n;&t;&t; */
id|csum
op_assign
id|ap-&gt;rx_return_ring
(braket
id|idx
)braket
dot
id|tcp_udp_csum
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If the checksum is correct and this is not a&n;&t;&t; * fragment, tell the stack that the data is correct.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|csum
op_xor
l_int|0xffff
)paren
op_logical_and
(paren
op_logical_neg
(paren
(paren
(paren
r_struct
id|iphdr
op_star
)paren
id|skb-&gt;data
)paren
op_member_access_from_pointer
id|frag_off
op_amp
id|__constant_htons
c_func
(paren
id|IP_MF
op_or
id|IP_OFFSET
)paren
)paren
)paren
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* send it up */
id|ap-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|ap-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|prdidx
op_amp
l_int|0x7
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|cmd
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|jumbo
)paren
id|cmd.evt
op_assign
id|C_SET_RX_JUMBO_PRD_IDX
suffix:semicolon
r_else
id|cmd.evt
op_assign
id|C_SET_RX_PRD_IDX
suffix:semicolon
id|cmd.code
op_assign
l_int|0
suffix:semicolon
id|cmd.idx
op_assign
id|prdidx
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|RX_RETURN_RING_ENTRIES
suffix:semicolon
)brace
id|out
suffix:colon
id|regs-&gt;RxRetCsm
op_assign
id|idx
suffix:semicolon
id|ap-&gt;cur_rx
op_assign
id|idx
suffix:semicolon
r_return
id|idx
suffix:semicolon
id|error
suffix:colon
id|idx
op_assign
id|rxretprd
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|ace_interrupt
r_static
r_void
id|ace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|txcsm
comma
id|rxretcsm
comma
id|rxretprd
suffix:semicolon
id|u32
id|evtcsm
comma
id|evtprd
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ap-&gt;lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * In case of PCI shared interrupts or spurious interrupts,&n;&t; * we want to make sure it is actually our interrupt before&n;&t; * spending any time in here.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|regs-&gt;HostCtrl
op_amp
id|IN_INT
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|ap-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Tell the card not to generate interrupts while we are in here.&n;&t; */
id|regs-&gt;Mb0Lo
op_assign
l_int|1
suffix:semicolon
id|txcsm
op_assign
id|ap-&gt;tx_csm
suffix:semicolon
r_if
c_cond
(paren
id|txcsm
op_ne
id|ap-&gt;tx_ret_csm
)paren
(brace
id|u32
id|idx
op_assign
id|ap-&gt;tx_ret_csm
suffix:semicolon
r_do
(brace
id|ap-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|ap-&gt;stats.tx_bytes
op_add_assign
id|ap-&gt;tx_skbuff
(braket
id|idx
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ap-&gt;tx_skbuff
(braket
id|idx
)braket
)paren
suffix:semicolon
id|ap-&gt;tx_skbuff
(braket
id|idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|idx
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|idx
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|idx
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
suffix:semicolon
)brace
r_while
c_loop
(paren
id|idx
op_ne
id|txcsm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;tx_full
op_logical_and
id|dev-&gt;tbusy
op_logical_and
(paren
(paren
(paren
id|ap-&gt;tx_prd
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
)paren
op_ne
id|txcsm
)paren
)paren
(brace
id|ap-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * TX ring is no longer full, aka the&n;&t;&t;&t; * transmitter is working fine - kill timer.&n;&t;&t;&t; */
id|del_timer
c_func
(paren
op_amp
id|ap-&gt;timer
)paren
suffix:semicolon
)brace
id|ap-&gt;tx_ret_csm
op_assign
id|txcsm
suffix:semicolon
)brace
id|rxretprd
op_assign
id|ap-&gt;rx_ret_prd
suffix:semicolon
id|rxretcsm
op_assign
id|ap-&gt;cur_rx
suffix:semicolon
r_if
c_cond
(paren
id|rxretprd
op_ne
id|rxretcsm
)paren
id|rxretprd
op_assign
id|rx_int
c_func
(paren
id|dev
comma
id|rxretprd
comma
id|rxretcsm
)paren
suffix:semicolon
id|evtcsm
op_assign
id|regs-&gt;EvtCsm
suffix:semicolon
id|evtprd
op_assign
id|ap-&gt;evt_prd
suffix:semicolon
r_if
c_cond
(paren
id|evtcsm
op_ne
id|evtprd
)paren
(brace
id|evtcsm
op_assign
id|ace_handle_event
c_func
(paren
id|dev
comma
id|evtcsm
comma
id|evtprd
)paren
suffix:semicolon
)brace
id|regs-&gt;EvtCsm
op_assign
id|evtcsm
suffix:semicolon
id|regs-&gt;Mb0Lo
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ap-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|ace_open
r_static
r_int
id|ace_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
id|ap
op_assign
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ap-&gt;fw_running
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: firmware not running!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|regs-&gt;IfMtu
op_assign
id|dev-&gt;mtu
op_plus
id|ETH_HLEN
op_plus
l_int|4
suffix:semicolon
id|cmd.evt
op_assign
id|C_HOST_STATE
suffix:semicolon
id|cmd.code
op_assign
id|C_C_STACK_UP
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;jumbo
)paren
id|ace_load_jumbo_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|cmd.evt
op_assign
id|C_SET_PROMISC_MODE
suffix:semicolon
id|cmd.code
op_assign
id|C_C_PROMISC_ENABLE
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|ap-&gt;promisc
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|ap-&gt;promisc
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
(brace
r_int
id|myjif
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|myjif
)paren
)paren
suffix:semicolon
)brace
id|cmd.evt
op_assign
id|C_LNK_NEGOTIATION
suffix:semicolon
id|cmd.code
op_assign
l_int|0
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the timer&n;&t; */
id|init_timer
c_func
(paren
op_amp
id|ap-&gt;timer
)paren
suffix:semicolon
id|ap-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|ap-&gt;timer.function
op_assign
id|ace_timer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ace_close
r_static
r_int
id|ace_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ap-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;promisc
)paren
(brace
id|cmd.evt
op_assign
id|C_SET_PROMISC_MODE
suffix:semicolon
id|cmd.code
op_assign
id|C_C_PROMISC_DISABLE
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|ap-&gt;promisc
op_assign
l_int|0
suffix:semicolon
)brace
id|cmd.evt
op_assign
id|C_HOST_STATE
suffix:semicolon
id|cmd.code
op_assign
id|C_C_STACK_DOWN
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ap-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
id|ap-&gt;tx_ring
(braket
id|i
)braket
dot
id|size
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ap-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ap-&gt;jumbo
)paren
id|ace_flush_jumbo_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ace_start_xmit
r_static
r_int
id|ace_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|idx
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|idx
op_assign
id|ap-&gt;tx_prd
suffix:semicolon
id|ap-&gt;tx_skbuff
(braket
id|idx
)braket
op_assign
id|skb
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|idx
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|idx
)braket
dot
id|size
op_assign
id|skb-&gt;len
suffix:semicolon
id|ap-&gt;tx_ring
(braket
id|idx
)braket
dot
id|flags
op_assign
id|DESC_END
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
suffix:semicolon
id|ap-&gt;tx_prd
op_assign
id|idx
suffix:semicolon
id|regs-&gt;TxPrd
op_assign
id|idx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|TX_RING_ENTRIES
op_eq
id|ap-&gt;tx_ret_csm
)paren
(brace
id|ap-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Queue is full, add timer to detect whether the&n;&t;&t; * transmitter is stuck.&n;&t;&t; */
id|ap-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ap-&gt;timer
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ace_change_mtu
r_static
r_int
id|ace_change_mtu
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
id|ACE_JUMBO_MTU
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|regs-&gt;IfMtu
op_assign
id|new_mtu
op_plus
id|ETH_HLEN
op_plus
l_int|4
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
OG
id|ACE_STD_MTU
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ap-&gt;jumbo
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling Jumbo frame &quot;
l_string|&quot;support&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ap-&gt;jumbo
op_assign
l_int|1
suffix:semicolon
id|ace_load_jumbo_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|ap-&gt;jumbo
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ap-&gt;jumbo
)paren
(brace
id|ace_flush_jumbo_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Disabling Jumbo frame support&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|ap-&gt;jumbo
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the hardware MAC address.&n; */
DECL|function|ace_set_mac_addr
r_static
r_int
id|ace_set_mac_addr
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|sockaddr
op_star
id|addr
op_assign
id|p
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
id|u16
op_star
id|da
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;start
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|addr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|da
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|regs
op_assign
(paren
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|regs
suffix:semicolon
id|regs-&gt;MacAddrHi
op_assign
id|da
(braket
l_int|0
)braket
suffix:semicolon
id|regs-&gt;MacAddrLo
op_assign
(paren
id|da
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
id|da
(braket
l_int|2
)braket
suffix:semicolon
id|cmd.evt
op_assign
id|C_SET_MAC_ADDR
suffix:semicolon
id|cmd.code
op_assign
l_int|0
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ace_set_multicast_list
r_static
r_void
id|ace_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_struct
id|cmd
id|cmd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_and
op_logical_neg
(paren
id|ap-&gt;promisc
)paren
)paren
(brace
id|cmd.evt
op_assign
id|C_SET_PROMISC_MODE
suffix:semicolon
id|cmd.code
op_assign
id|C_C_PROMISC_ENABLE
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|ap-&gt;promisc
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_and
(paren
id|ap-&gt;promisc
)paren
)paren
(brace
id|cmd.evt
op_assign
id|C_SET_PROMISC_MODE
suffix:semicolon
id|cmd.code
op_assign
id|C_C_PROMISC_DISABLE
suffix:semicolon
id|cmd.idx
op_assign
l_int|0
suffix:semicolon
id|ace_issue_cmd
c_func
(paren
id|regs
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|ap-&gt;promisc
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ace_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ace_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|ap-&gt;stats
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ace_copy
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
comma
r_void
op_star
id|src
comma
id|u32
id|dest
comma
r_int
id|size
)paren
)paren
(brace
r_int
id|tsize
suffix:semicolon
id|u32
id|tdest
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|tsize
op_assign
id|min
c_func
(paren
(paren
(paren
op_complement
id|dest
op_amp
(paren
id|ACE_WINDOW_SIZE
op_minus
l_int|1
)paren
)paren
op_plus
l_int|1
)paren
comma
id|min
c_func
(paren
id|size
comma
id|ACE_WINDOW_SIZE
)paren
)paren
suffix:semicolon
id|tdest
op_assign
id|dest
op_amp
(paren
id|ACE_WINDOW_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|regs-&gt;WinBase
op_assign
id|dest
op_amp
op_complement
(paren
id|ACE_WINDOW_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef __BIG_ENDIAN
macro_line|#error &quot;data must be swapped here&quot;
macro_line|#else
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;copying %04x from %08x to %06x (Window addr %08x), winbase %02x&bslash;n&quot;
comma
id|tsize
comma
(paren
r_int
)paren
id|src
comma
id|dest
comma
(paren
r_int
)paren
(paren
(paren
r_void
op_star
)paren
id|regs-&gt;Window
op_plus
id|tdest
)paren
comma
id|regs-&gt;WinBase
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
r_void
op_star
)paren
id|regs-&gt;Window
op_plus
id|tdest
)paren
comma
id|src
comma
id|tsize
)paren
suffix:semicolon
macro_line|#endif
id|dest
op_add_assign
id|tsize
suffix:semicolon
id|src
op_add_assign
id|tsize
suffix:semicolon
id|size
op_sub_assign
id|tsize
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ace_clear
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
comma
id|u32
id|dest
comma
r_int
id|size
)paren
)paren
(brace
r_int
id|tsize
op_assign
l_int|0
suffix:semicolon
id|u32
id|tdest
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|tsize
op_assign
id|min
c_func
(paren
(paren
(paren
op_complement
id|dest
op_amp
(paren
id|ACE_WINDOW_SIZE
op_minus
l_int|1
)paren
)paren
op_plus
l_int|1
)paren
comma
id|min
c_func
(paren
id|size
comma
id|ACE_WINDOW_SIZE
)paren
)paren
suffix:semicolon
id|tdest
op_assign
id|dest
op_amp
(paren
id|ACE_WINDOW_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|regs-&gt;WinBase
op_assign
id|dest
op_amp
op_complement
(paren
id|ACE_WINDOW_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
r_void
op_star
)paren
id|regs-&gt;Window
op_plus
id|tdest
)paren
comma
l_int|0
comma
id|tsize
)paren
suffix:semicolon
id|dest
op_add_assign
id|tsize
suffix:semicolon
id|size
op_sub_assign
id|tsize
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Download the firmware into the SRAM on the NIC&n; *&n; * This operation requires the NIC to be halted and is performed with&n; * interrupts disabled and with the spinlock hold.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|ace_load_firmware
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
)paren
(brace
r_struct
id|ace_private
op_star
id|ap
suffix:semicolon
r_struct
id|ace_regs
op_star
id|regs
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ace_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|regs
op_assign
id|ap-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|regs-&gt;CpuCtrl
op_amp
id|CPU_HALTED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: trying to download firmware while the &quot;
l_string|&quot;CPU is running!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ace_clear
c_func
(paren
id|regs
comma
l_int|0x2000
comma
l_int|0x100000
op_minus
l_int|0x2000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|1
)paren
(brace
id|ace_copy
c_func
(paren
id|regs
comma
id|tigonFwText
comma
id|tigonFwTextAddr
comma
id|tigonFwTextLen
)paren
suffix:semicolon
id|ace_copy
c_func
(paren
id|regs
comma
id|tigonFwData
comma
id|tigonFwDataAddr
comma
id|tigonFwDataLen
)paren
suffix:semicolon
id|ace_copy
c_func
(paren
id|regs
comma
id|tigonFwRodata
comma
id|tigonFwRodataAddr
comma
id|tigonFwRodataLen
)paren
suffix:semicolon
id|ace_clear
c_func
(paren
id|regs
comma
id|tigonFwBssAddr
comma
id|tigonFwBssLen
)paren
suffix:semicolon
id|ace_clear
c_func
(paren
id|regs
comma
id|tigonFwSbssAddr
comma
id|tigonFwSbssLen
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ap-&gt;version
op_eq
l_int|2
)paren
(brace
id|ace_clear
c_func
(paren
id|regs
comma
id|tigon2FwBssAddr
comma
id|tigon2FwBssLen
)paren
suffix:semicolon
id|ace_clear
c_func
(paren
id|regs
comma
id|tigon2FwSbssAddr
comma
id|tigon2FwSbssLen
)paren
suffix:semicolon
id|ace_copy
c_func
(paren
id|regs
comma
id|tigon2FwText
comma
id|tigon2FwTextAddr
comma
id|tigon2FwTextLen
)paren
suffix:semicolon
id|ace_copy
c_func
(paren
id|regs
comma
id|tigon2FwRodata
comma
id|tigon2FwRodataAddr
comma
id|tigon2FwRodataLen
)paren
suffix:semicolon
id|ace_copy
c_func
(paren
id|regs
comma
id|tigon2FwData
comma
id|tigon2FwDataAddr
comma
id|tigon2FwDataLen
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The eeprom on the AceNIC is an Atmel i2c EEPROM.&n; *&n; * Accessing the EEPROM is `interesting&squot; to say the least - don&squot;t read&n; * this code right after dinner.&n; *&n; * This is all about black magic and bit-banging the device .... I&n; * wonder in what hospital they have put the guy who designed the i2c&n; * specs.&n; *&n; * Oh yes, this is only the beginning!&n; */
DECL|function|eeprom_start
r_static
r_void
id|eeprom_start
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
(paren
id|EEPROM_DATA_OUT
op_or
id|EEPROM_WRITE_ENABLE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_CLK_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_DATA_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_CLK_OUT
suffix:semicolon
)brace
DECL|function|eeprom_prep
r_static
r_void
id|eeprom_prep
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
comma
id|u8
id|magic
)paren
(brace
r_int
id|i
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_DATA_OUT
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_WRITE_ENABLE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|magic
op_lshift_assign
l_int|1
)paren
(brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|magic
op_amp
l_int|0x80
)paren
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_DATA_OUT
suffix:semicolon
r_else
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_DATA_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_CLK_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
(paren
id|EEPROM_CLK_OUT
op_or
id|EEPROM_DATA_OUT
)paren
suffix:semicolon
)brace
)brace
DECL|function|eeprom_check_ack
r_static
r_int
id|eeprom_check_ack
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
)paren
(brace
r_int
id|state
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_WRITE_ENABLE
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_CLK_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* sample data in middle of high clk */
id|state
op_assign
(paren
id|regs-&gt;LocalCtrl
op_amp
id|EEPROM_DATA_IN
)paren
op_ne
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_CLK_OUT
suffix:semicolon
r_return
id|state
suffix:semicolon
)brace
DECL|function|eeprom_stop
r_static
r_void
id|eeprom_stop
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
)paren
(brace
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_WRITE_ENABLE
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_DATA_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_CLK_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_DATA_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_CLK_OUT
suffix:semicolon
)brace
multiline_comment|/*&n; * Read a whole byte from the EEPROM.&n; */
DECL|function|read_eeprom_byte
r_static
id|u8
id|read_eeprom_byte
c_func
(paren
r_struct
id|ace_regs
op_star
id|regs
comma
r_int
r_int
id|offset
)paren
(brace
id|u32
id|i
suffix:semicolon
id|u8
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No regs!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|eeprom_start
c_func
(paren
id|regs
)paren
suffix:semicolon
id|eeprom_prep
c_func
(paren
id|regs
comma
id|EEPROM_WRITE_SELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom_check_ack
c_func
(paren
id|regs
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to sync eeprom&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|eeprom_prep
c_func
(paren
id|regs
comma
(paren
id|offset
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom_check_ack
c_func
(paren
id|regs
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|eeprom_prep
c_func
(paren
id|regs
comma
id|offset
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom_check_ack
c_func
(paren
id|regs
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|eeprom_start
c_func
(paren
id|regs
)paren
suffix:semicolon
id|eeprom_prep
c_func
(paren
id|regs
comma
id|EEPROM_READ_SELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom_check_ack
c_func
(paren
id|regs
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_WRITE_ENABLE
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_CLK_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* sample data mid high clk */
id|result
op_assign
(paren
id|result
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|regs-&gt;LocalCtrl
op_amp
id|EEPROM_DATA_IN
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_CLK_OUT
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|7
)paren
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_WRITE_ENABLE
suffix:semicolon
)brace
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_DATA_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_or_assign
id|EEPROM_CLK_OUT
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|regs-&gt;LocalCtrl
op_and_assign
op_complement
id|EEPROM_CLK_OUT
suffix:semicolon
id|eeprom_stop
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; * compile-command: &quot;gcc -D__KERNEL__ -D__SMP__ -I/data/home/jes/linux/include -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer -pipe -fno-strength-reduce -m486 -malign-loops=2 -malign-jumps=2 -malign-functions=2 -DCPU=686 -DMODULE -DMODVERSIONS -include /data/home/jes/linux/include/linux/modversions.h   -c -o acenic.o acenic.c&quot;&n; * End:&n; */
eof
