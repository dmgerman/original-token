multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;soundmodem.c  -- soundcard radio modem driver.&n; *&n; *&t;Copyright (C) 1996  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Please note that the GPL allows you to use the driver, NOT the radio.&n; *  In order to use the radio, you need a license from the communications&n; *  authority of your country.&n; *&n; *&n; *  Command line options (insmod command line)&n; *&n; *  hardware hardware type; 0=sbc, 1=wss, any other value invalid&n; *  mode     mode type; 0=1200 baud AFSK, 1=9600 baud FSK, any other&n; *           value invalid&n; *  iobase   base address of the soundcard; common values are 0x220 for sbc,&n; *           0x530 for wss&n; *  irq      interrupt number; common values are 7 or 5 for sbc, 11 for wss&n; *  dma      dma number; common values are 0 or 1&n; *&n; *&n; *  History:&n; *   0.1  21.09.96  Started&n; *        18.10.96  Changed to new user space access routines (copy_{to,from}_user)&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;limits.h&gt;
macro_line|#include &lt;linux/hdlcdrv.h&gt;
macro_line|#include &lt;linux/soundmodem.h&gt;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_drvname
r_static
r_const
r_char
id|sm_drvname
(braket
)braket
op_assign
l_string|&quot;soundmodem&quot;
suffix:semicolon
DECL|variable|sm_drvinfo
r_static
r_const
r_char
id|sm_drvinfo
(braket
)braket
op_assign
id|KERN_INFO
l_string|&quot;soundmodem: (C) 1996 Thomas Sailer, HB9JNX/AE4WA&bslash;n&quot;
id|KERN_INFO
l_string|&quot;soundmodem: version 0.3 compiled &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
suffix:semicolon
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|NR_PORTS
mdefine_line|#define NR_PORTS 4
DECL|macro|SM_DEBUG
mdefine_line|#define SM_DEBUG
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_device
r_static
r_struct
id|device
id|sm_device
(braket
id|NR_PORTS
)braket
suffix:semicolon
r_static
r_struct
(brace
DECL|member|mode
r_char
op_star
id|mode
suffix:semicolon
DECL|member|iobase
DECL|member|irq
DECL|member|dma
DECL|member|dma2
DECL|member|seriobase
DECL|member|pariobase
DECL|member|midiiobase
r_int
id|iobase
comma
id|irq
comma
id|dma
comma
id|dma2
comma
id|seriobase
comma
id|pariobase
comma
id|midiiobase
suffix:semicolon
DECL|variable|sm_ports
)brace
id|sm_ports
(braket
id|NR_PORTS
)braket
op_assign
(brace
(brace
l_int|NULL
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|DMA_MODE_AUTOINIT
mdefine_line|#define DMA_MODE_AUTOINIT      0x10
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|UART_RBR
mdefine_line|#define UART_RBR(iobase) (iobase+0)
DECL|macro|UART_THR
mdefine_line|#define UART_THR(iobase) (iobase+0)
DECL|macro|UART_IER
mdefine_line|#define UART_IER(iobase) (iobase+1)
DECL|macro|UART_IIR
mdefine_line|#define UART_IIR(iobase) (iobase+2)
DECL|macro|UART_FCR
mdefine_line|#define UART_FCR(iobase) (iobase+2)
DECL|macro|UART_LCR
mdefine_line|#define UART_LCR(iobase) (iobase+3)
DECL|macro|UART_MCR
mdefine_line|#define UART_MCR(iobase) (iobase+4)
DECL|macro|UART_LSR
mdefine_line|#define UART_LSR(iobase) (iobase+5)
DECL|macro|UART_MSR
mdefine_line|#define UART_MSR(iobase) (iobase+6)
DECL|macro|UART_SCR
mdefine_line|#define UART_SCR(iobase) (iobase+7)
DECL|macro|UART_DLL
mdefine_line|#define UART_DLL(iobase) (iobase+0)
DECL|macro|UART_DLM
mdefine_line|#define UART_DLM(iobase) (iobase+1)
DECL|macro|SER_EXTENT
mdefine_line|#define SER_EXTENT 8
DECL|macro|LPT_DATA
mdefine_line|#define LPT_DATA(iobase)    (iobase+0)
DECL|macro|LPT_STATUS
mdefine_line|#define LPT_STATUS(iobase)  (iobase+1)
DECL|macro|LPT_CONTROL
mdefine_line|#define LPT_CONTROL(iobase) (iobase+2)
DECL|macro|LPT_IRQ_ENABLE
mdefine_line|#define LPT_IRQ_ENABLE      0x10
DECL|macro|LPT_EXTENT
mdefine_line|#define LPT_EXTENT 3
DECL|macro|MIDI_DATA
mdefine_line|#define MIDI_DATA(iobase)     (iobase)
DECL|macro|MIDI_STATUS
mdefine_line|#define MIDI_STATUS(iobase)   (iobase+1)
DECL|macro|MIDI_READ_FULL
mdefine_line|#define MIDI_READ_FULL 0x80   /* attention: negative logic!! */
DECL|macro|MIDI_WRITE_EMPTY
mdefine_line|#define MIDI_WRITE_EMPTY 0x40 /* attention: negative logic!! */
DECL|macro|MIDI_EXTENT
mdefine_line|#define MIDI_EXTENT 2
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|macro|PARAM_TXDELAY
mdefine_line|#define PARAM_TXDELAY   1
DECL|macro|PARAM_PERSIST
mdefine_line|#define PARAM_PERSIST   2
DECL|macro|PARAM_SLOTTIME
mdefine_line|#define PARAM_SLOTTIME  3
DECL|macro|PARAM_TXTAIL
mdefine_line|#define PARAM_TXTAIL    4
DECL|macro|PARAM_FULLDUP
mdefine_line|#define PARAM_FULLDUP   5
DECL|macro|PARAM_HARDWARE
mdefine_line|#define PARAM_HARDWARE  6
DECL|macro|PARAM_RETURN
mdefine_line|#define PARAM_RETURN    255
DECL|macro|SP_SER
mdefine_line|#define SP_SER  1
DECL|macro|SP_PAR
mdefine_line|#define SP_PAR  2
DECL|macro|SP_MIDI
mdefine_line|#define SP_MIDI 4
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/*&n; * Information that need to be kept for each board.&n; */
DECL|struct|sm_state
r_struct
id|sm_state
(brace
DECL|member|hdrv
r_struct
id|hdlcdrv_state
id|hdrv
suffix:semicolon
DECL|member|mode_tx
r_const
r_struct
id|modem_tx_info
op_star
id|mode_tx
suffix:semicolon
DECL|member|mode_rx
r_const
r_struct
id|modem_rx_info
op_star
id|mode_rx
suffix:semicolon
DECL|member|hwdrv
r_const
r_struct
id|hardware_info
op_star
id|hwdrv
suffix:semicolon
multiline_comment|/*&n;&t; * Hardware (soundcard) access routines state&n;&t; */
r_union
(brace
DECL|member|hw
r_int
id|hw
(braket
l_int|32
op_div
r_sizeof
(paren
r_int
)paren
)braket
suffix:semicolon
DECL|member|hw
)brace
id|hw
suffix:semicolon
multiline_comment|/*&n;&t; * state of the modem code&n;&t; */
r_union
(brace
DECL|member|m
r_int
id|m
(braket
l_int|32
op_div
r_sizeof
(paren
r_int
)paren
)braket
suffix:semicolon
DECL|member|m
)brace
id|m
suffix:semicolon
r_union
(brace
DECL|member|d
r_int
id|d
(braket
l_int|256
op_div
r_sizeof
(paren
r_int
)paren
)braket
suffix:semicolon
DECL|member|d
)brace
id|d
suffix:semicolon
DECL|macro|DIAGDATALEN
mdefine_line|#define DIAGDATALEN 64
DECL|struct|diag_data
r_struct
id|diag_data
(brace
DECL|member|mode
r_int
r_int
id|mode
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|ptr
r_volatile
r_int
id|ptr
suffix:semicolon
DECL|member|data
r_int
id|data
(braket
id|DIAGDATALEN
)braket
suffix:semicolon
DECL|member|diag
)brace
id|diag
suffix:semicolon
macro_line|#ifdef SM_DEBUG
DECL|struct|debug_vals
r_struct
id|debug_vals
(brace
DECL|member|last_jiffies
r_int
r_int
id|last_jiffies
suffix:semicolon
DECL|member|cur_intcnt
r_int
id|cur_intcnt
suffix:semicolon
DECL|member|last_intcnt
r_int
id|last_intcnt
suffix:semicolon
DECL|member|mod_cyc
r_int
id|mod_cyc
suffix:semicolon
DECL|member|demod_cyc
r_int
id|demod_cyc
suffix:semicolon
DECL|member|dma_residue
r_int
id|dma_residue
suffix:semicolon
DECL|member|debug_vals
)brace
id|debug_vals
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/*&n; * Mode definition structure&n; */
DECL|struct|modem_tx_info
r_struct
id|modem_tx_info
(brace
DECL|member|next
r_const
r_struct
id|modem_tx_info
op_star
id|next
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|loc_storage
r_int
r_int
id|loc_storage
suffix:semicolon
DECL|member|srate
r_int
id|srate
suffix:semicolon
DECL|member|bitrate
r_int
id|bitrate
suffix:semicolon
DECL|member|dmabuflenmodulo
r_int
r_int
id|dmabuflenmodulo
suffix:semicolon
DECL|member|modulator
r_void
(paren
op_star
id|modulator
)paren
(paren
r_struct
id|sm_state
op_star
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|init
r_void
(paren
op_star
id|init
)paren
(paren
r_struct
id|sm_state
op_star
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|NEXT_TX_INFO
mdefine_line|#define NEXT_TX_INFO NULL
r_extern
r_const
r_struct
id|modem_tx_info
op_star
id|modem_tx_base
suffix:semicolon
DECL|struct|modem_rx_info
r_struct
id|modem_rx_info
(brace
DECL|member|next
r_const
r_struct
id|modem_rx_info
op_star
id|next
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|loc_storage
r_int
r_int
id|loc_storage
suffix:semicolon
DECL|member|srate
r_int
id|srate
suffix:semicolon
DECL|member|bitrate
r_int
id|bitrate
suffix:semicolon
DECL|member|dmabuflenmodulo
r_int
r_int
id|dmabuflenmodulo
suffix:semicolon
DECL|member|sperbit
r_int
r_int
id|sperbit
suffix:semicolon
DECL|member|demodulator
r_void
(paren
op_star
id|demodulator
)paren
(paren
r_struct
id|sm_state
op_star
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|init
r_void
(paren
op_star
id|init
)paren
(paren
r_struct
id|sm_state
op_star
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|NEXT_RX_INFO
mdefine_line|#define NEXT_RX_INFO NULL
r_extern
r_const
r_struct
id|modem_rx_info
op_star
id|modem_rx_base
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/*&n; * Soundcard driver definition structure&n; */
DECL|struct|hardware_info
r_struct
id|hardware_info
(brace
DECL|member|next
r_const
r_struct
id|hardware_info
op_star
id|next
suffix:semicolon
DECL|member|hw_name
r_char
op_star
id|hw_name
suffix:semicolon
multiline_comment|/* used for request_{region,irq,dma} */
DECL|member|loc_storage
r_int
r_int
id|loc_storage
suffix:semicolon
multiline_comment|/*&n;&t; * mode specific open/close&n;&t; */
DECL|member|open
r_int
(paren
op_star
id|open
)paren
(paren
r_struct
id|device
op_star
comma
r_struct
id|sm_state
op_star
)paren
suffix:semicolon
DECL|member|close
r_int
(paren
op_star
id|close
)paren
(paren
r_struct
id|device
op_star
comma
r_struct
id|sm_state
op_star
)paren
suffix:semicolon
DECL|member|ioctl
r_int
(paren
op_star
id|ioctl
)paren
(paren
r_struct
id|device
op_star
comma
r_struct
id|sm_state
op_star
comma
r_struct
id|ifreq
op_star
comma
r_struct
id|hdlcdrv_ioctl
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|sethw
r_int
(paren
op_star
id|sethw
)paren
(paren
r_struct
id|device
op_star
comma
r_struct
id|sm_state
op_star
comma
r_char
op_star
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|NEXT_HW_INFO
mdefine_line|#define NEXT_HW_INFO NULL
r_extern
r_const
r_struct
id|hardware_info
op_star
id|hardware_base
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|min
mdefine_line|#define min(a, b) (((a) &lt; (b)) ? (a) : (b))
DECL|macro|max
mdefine_line|#define max(a, b) (((a) &gt; (b)) ? (a) : (b))
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sm_int_freq
r_static
r_void
r_inline
id|sm_int_freq
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
macro_line|#ifdef SM_DEBUG
r_int
r_int
id|cur_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;&t; * measure the interrupt frequency&n;&t; */
id|sm-&gt;debug_vals.cur_intcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cur_jiffies
op_minus
id|sm-&gt;debug_vals.last_jiffies
)paren
op_ge
id|HZ
)paren
(brace
id|sm-&gt;debug_vals.last_jiffies
op_assign
id|cur_jiffies
suffix:semicolon
id|sm-&gt;debug_vals.last_intcnt
op_assign
id|sm-&gt;debug_vals.cur_intcnt
suffix:semicolon
id|sm-&gt;debug_vals.cur_intcnt
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* SM_DEBUG */
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== port checking routines ========================&n; */
DECL|function|check_lpt
r_static
r_int
id|check_lpt
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|b1
comma
id|b2
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|LPT_EXTENT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|LPT_EXTENT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b2
op_assign
id|inb
c_func
(paren
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xaa
comma
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
op_eq
l_int|0xaa
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_and_assign
id|inb
c_func
(paren
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
op_eq
l_int|0x55
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0a
comma
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_and_assign
(paren
id|inb
c_func
(paren
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0x0a
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_and_assign
(paren
id|inb
c_func
(paren
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0x05
suffix:semicolon
id|outb
c_func
(paren
id|b1
comma
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|b2
comma
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_return
op_logical_neg
id|i
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|enum|uart
DECL|enumerator|c_uart_unknown
DECL|enumerator|c_uart_8250
r_enum
id|uart
(brace
id|c_uart_unknown
comma
id|c_uart_8250
comma
DECL|enumerator|c_uart_16450
DECL|enumerator|c_uart_16550
DECL|enumerator|c_uart_16550A
id|c_uart_16450
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
DECL|variable|uart_str
r_static
r_const
r_char
op_star
id|uart_str
(braket
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;8250&quot;
comma
l_string|&quot;16450&quot;
comma
l_string|&quot;16550&quot;
comma
l_string|&quot;16550A&quot;
)brace
suffix:semicolon
DECL|function|check_uart
r_static
r_enum
id|uart
id|check_uart
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|b1
comma
id|b2
comma
id|b3
suffix:semicolon
r_enum
id|uart
id|u
suffix:semicolon
r_enum
id|uart
id|uart_tab
(braket
)braket
op_assign
(brace
id|c_uart_16450
comma
id|c_uart_unknown
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|SER_EXTENT
)paren
r_return
id|c_uart_unknown
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|SER_EXTENT
)paren
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|b1
op_or
l_int|0x10
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* loopback mode */
id|b2
op_assign
id|inb
c_func
(paren
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x1a
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b3
op_assign
id|inb
c_func
(paren
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|outb
c_func
(paren
id|b1
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* restore old values */
id|outb
c_func
(paren
id|b2
comma
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b3
op_ne
l_int|0x90
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|inb
c_func
(paren
id|UART_RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|UART_RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|UART_FCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* enable FIFOs */
id|u
op_assign
id|uart_tab
(braket
(paren
id|inb
c_func
(paren
id|UART_IIR
c_func
(paren
id|iobase
)paren
)paren
op_rshift
l_int|6
)paren
op_amp
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
id|c_uart_16450
)paren
(brace
id|outb
c_func
(paren
l_int|0x5a
comma
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa5
comma
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b2
op_assign
id|inb
c_func
(paren
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b1
op_ne
l_int|0x5a
)paren
op_logical_or
(paren
id|b2
op_ne
l_int|0xa5
)paren
)paren
id|u
op_assign
id|c_uart_8250
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|check_midi
r_static
r_int
id|check_midi
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|b
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|MIDI_EXTENT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|MIDI_EXTENT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
op_amp
id|MIDI_WRITE_EMPTY
)paren
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|MIDI_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b
op_assign
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|MIDI_WRITE_EMPTY
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
op_amp
id|MIDI_WRITE_EMPTY
)paren
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_status
r_extern
r_void
r_inline
id|output_status
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
id|invert_dcd
op_assign
l_int|0
suffix:semicolon
r_int
id|invert_ptt
op_assign
l_int|0
suffix:semicolon
r_int
id|ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
op_xor
id|invert_ptt
suffix:semicolon
r_int
id|dcd
op_assign
(paren
op_logical_neg
op_logical_neg
id|sm-&gt;hdrv.hdlcrx.dcd
)paren
op_xor
id|invert_dcd
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_SER
)paren
(brace
id|outb
c_func
(paren
id|dcd
op_or
(paren
id|ptt
op_lshift
l_int|1
)paren
comma
id|UART_MCR
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x40
op_amp
(paren
op_minus
id|ptt
)paren
comma
id|UART_LCR
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_PAR
)paren
(brace
id|outb
c_func
(paren
id|ptt
op_or
(paren
id|dcd
op_lshift
l_int|1
)paren
comma
id|LPT_DATA
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_MIDI
op_logical_and
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|MIDI_DATA
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_open
r_static
r_void
id|output_open
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_enum
id|uart
id|u
op_assign
id|c_uart_unknown
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
OG
l_int|0
op_logical_and
id|sm-&gt;hdrv.ptt_out.seriobase
op_le
l_int|0x1000
op_minus
id|SER_EXTENT
op_logical_and
(paren
(paren
id|u
op_assign
id|check_uart
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
)paren
op_ne
id|c_uart_unknown
)paren
(brace
id|sm-&gt;hdrv.ptt_out.flags
op_or_assign
id|SP_SER
suffix:semicolon
id|request_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
comma
id|SER_EXTENT
comma
l_string|&quot;sm ser ptt&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|UART_IER
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
multiline_comment|/* 5 bits, 1 stop, no parity, no break, Div latch access */
id|outb
c_func
(paren
l_int|0x80
comma
id|UART_LCR
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|UART_DLM
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|UART_DLL
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
multiline_comment|/* as fast as possible */
multiline_comment|/* LCR and MCR set by output_status */
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
OG
l_int|0
op_logical_and
id|sm-&gt;hdrv.ptt_out.pariobase
op_le
l_int|0x1000
op_minus
id|LPT_EXTENT
op_logical_and
id|check_lpt
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
)paren
)paren
(brace
id|sm-&gt;hdrv.ptt_out.flags
op_or_assign
id|SP_PAR
suffix:semicolon
id|request_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
comma
id|LPT_EXTENT
comma
l_string|&quot;sm par ptt&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
OG
l_int|0
op_logical_and
id|sm-&gt;hdrv.ptt_out.midiiobase
op_le
l_int|0x1000
op_minus
id|MIDI_EXTENT
op_logical_and
id|check_midi
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
)paren
)paren
(brace
id|sm-&gt;hdrv.ptt_out.flags
op_or_assign
id|SP_MIDI
suffix:semicolon
id|request_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
comma
id|MIDI_EXTENT
comma
l_string|&quot;sm midi ptt&quot;
)paren
suffix:semicolon
)brace
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ptt output:&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_SER
)paren
id|printk
c_func
(paren
l_string|&quot; serial interface at 0x%x, uart %s&quot;
comma
id|sm-&gt;hdrv.ptt_out.seriobase
comma
id|uart_str
(braket
id|u
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_PAR
)paren
id|printk
c_func
(paren
l_string|&quot; parallel interface at 0x%x&quot;
comma
id|sm-&gt;hdrv.ptt_out.pariobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_MIDI
)paren
id|printk
c_func
(paren
l_string|&quot; mpu401 (midi) interface at 0x%x&quot;
comma
id|sm-&gt;hdrv.ptt_out.midiiobase
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;hdrv.ptt_out.flags
)paren
id|printk
c_func
(paren
l_string|&quot; none&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_close
r_static
r_void
id|output_close
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
multiline_comment|/* release regions used for PTT output */
id|sm-&gt;hdrv.hdlctx.ptt
op_assign
id|sm-&gt;hdrv.hdlctx.calibrate
op_assign
l_int|0
suffix:semicolon
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_SER
)paren
id|release_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
comma
id|SER_EXTENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_PAR
)paren
id|release_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
comma
id|LPT_EXTENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_MIDI
)paren
id|release_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
comma
id|MIDI_EXTENT
)paren
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.flags
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== diagnostics stuff ===============================&n; */
DECL|function|diag_trigger
r_extern
r_inline
r_void
id|diag_trigger
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;diag.flags
op_amp
id|SM_DIAGFLAG_DCDGATE
)paren
op_logical_or
id|sm-&gt;hdrv.hdlcrx.dcd
)paren
id|sm-&gt;diag.ptr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|diag_add
r_extern
r_inline
r_void
id|diag_add
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|valinp
comma
r_int
id|valdemod
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_INPUT
op_logical_and
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_DEMOD
)paren
op_logical_or
id|sm-&gt;diag.ptr
op_ge
id|DIAGDATALEN
op_logical_or
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_return
suffix:semicolon
id|val
op_assign
(paren
id|sm-&gt;diag.mode
op_eq
id|SM_DIAGMODE_DEMOD
)paren
ques
c_cond
id|valdemod
suffix:colon
id|valinp
suffix:semicolon
multiline_comment|/* clip */
r_if
c_cond
(paren
id|val
OG
id|SHRT_MAX
)paren
id|val
op_assign
id|SHRT_MAX
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
id|SHRT_MIN
)paren
id|val
op_assign
id|SHRT_MIN
suffix:semicolon
id|sm-&gt;diag.data
(braket
id|sm-&gt;diag.ptr
op_increment
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|diag_add_one
r_extern
r_inline
r_void
id|diag_add_one
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
(paren
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_INPUT
op_logical_and
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_DEMOD
)paren
op_logical_or
id|sm-&gt;diag.ptr
op_ge
id|DIAGDATALEN
op_logical_or
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* clip */
r_if
c_cond
(paren
id|val
OG
id|SHRT_MAX
)paren
id|val
op_assign
id|SHRT_MAX
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
id|SHRT_MIN
)paren
id|val
op_assign
id|SHRT_MIN
suffix:semicolon
id|sm-&gt;diag.data
(braket
id|sm-&gt;diag.ptr
op_increment
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|diag_add_constellation
r_static
r_inline
r_void
id|diag_add_constellation
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|vali
comma
r_int
id|valq
)paren
(brace
r_if
c_cond
(paren
(paren
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_CONSTELLATION
)paren
op_logical_or
id|sm-&gt;diag.ptr
op_ge
id|DIAGDATALEN
op_minus
l_int|1
op_logical_or
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* clip */
r_if
c_cond
(paren
id|vali
OG
id|SHRT_MAX
)paren
id|vali
op_assign
id|SHRT_MAX
suffix:semicolon
r_if
c_cond
(paren
id|vali
OL
id|SHRT_MIN
)paren
id|vali
op_assign
id|SHRT_MIN
suffix:semicolon
r_if
c_cond
(paren
id|valq
OG
id|SHRT_MAX
)paren
id|valq
op_assign
id|SHRT_MAX
suffix:semicolon
r_if
c_cond
(paren
id|valq
OL
id|SHRT_MIN
)paren
id|valq
op_assign
id|SHRT_MIN
suffix:semicolon
id|sm-&gt;diag.data
(braket
id|sm-&gt;diag.ptr
op_increment
)braket
op_assign
id|vali
suffix:semicolon
id|sm-&gt;diag.data
(braket
id|sm-&gt;diag.ptr
op_increment
)braket
op_assign
id|valq
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== utility functions ===============================&n; */
r_extern
r_inline
r_int
r_int
id|hweight32
c_func
(paren
r_int
r_int
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_extern
r_inline
r_int
r_int
id|hweight16
c_func
(paren
r_int
r_int
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_extern
r_inline
r_int
r_int
id|hweight8
c_func
(paren
r_int
r_char
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
DECL|function|hweight32
r_extern
r_inline
r_int
r_int
id|hweight32
c_func
(paren
r_int
r_int
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x55555555
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x55555555
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x33333333
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x33333333
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x0F0F0F0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F0F0F0F
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x00FF00FF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF00FF
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x0000FFFF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|16
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
)brace
DECL|function|hweight16
r_extern
r_inline
r_int
r_int
id|hweight16
c_func
(paren
r_int
r_int
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x5555
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x5555
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x3333
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x3333
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x0F0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F0F
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x00FF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
)paren
suffix:semicolon
)brace
DECL|function|hweight8
r_extern
r_inline
r_int
r_int
id|hweight8
c_func
(paren
r_int
r_char
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x55
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x55
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x33
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x33
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
)paren
suffix:semicolon
)brace
r_extern
r_inline
r_int
r_int
id|gcd
c_func
(paren
r_int
r_int
id|x
comma
r_int
r_int
id|y
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_extern
r_inline
r_int
r_int
id|lcm
c_func
(paren
r_int
r_int
id|x
comma
r_int
r_int
id|y
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
DECL|function|gcd
r_extern
r_inline
r_int
r_int
id|gcd
c_func
(paren
r_int
r_int
id|x
comma
r_int
r_int
id|y
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|x
)paren
r_return
id|y
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|y
)paren
r_return
id|x
suffix:semicolon
r_if
c_cond
(paren
id|x
OG
id|y
)paren
id|x
op_mod_assign
id|y
suffix:semicolon
r_else
id|y
op_mod_assign
id|x
suffix:semicolon
)brace
)brace
DECL|function|lcm
r_extern
r_inline
r_int
r_int
id|lcm
c_func
(paren
r_int
r_int
id|x
comma
r_int
r_int
id|y
)paren
(brace
r_return
id|x
op_star
id|y
op_div
id|gcd
c_func
(paren
id|x
comma
id|y
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== profiling =======================================&n; */
macro_line|#if defined(SM_DEBUG) &amp;&amp; (defined(CONFIG_M586) || defined(CONFIG_M686))
multiline_comment|/*&n; * only do 32bit cycle counter arithmetic; we hope we won&squot;t overflow :-)&n; * in fact, overflowing modems would require over 2THz clock speeds :-)&n; */
DECL|macro|time_exec
mdefine_line|#define time_exec(var,cmd)                                      &bslash;&n;({                                                              &bslash;&n;&t;unsigned int cnt1, cnt2, cnt3;                          &bslash;&n;&t;__asm__(&quot;.byte 0x0f,0x31&quot; : &quot;=a&quot; (cnt1), &quot;=d&quot; (cnt3));  &bslash;&n;&t;cmd;                                                    &bslash;&n;&t;__asm__(&quot;.byte 0x0f,0x31&quot; : &quot;=a&quot; (cnt2), &quot;=d&quot; (cnt3));  &bslash;&n;&t;var = cnt2-cnt1;                                        &bslash;&n;})
macro_line|#else /* defined(SM_DEBUG) &amp;&amp; (defined(CONFIG_M586) || defined(CONFIG_M686)) */
DECL|macro|time_exec
mdefine_line|#define time_exec(var,cmd) cmd
macro_line|#endif /* defined(SM_DEBUG) &amp;&amp; (defined(CONFIG_M586) || defined(CONFIG_M686)) */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef CONFIG_SOUNDMODEM_WSS
macro_line|#include &quot;sm_wss.h&quot;
macro_line|#endif /* CONFIG_SOUNDMODEM_WSS */
macro_line|#ifdef CONFIG_SOUNDMODEM_SBC
macro_line|#include &quot;sm_sbc.h&quot;
macro_line|#endif /* CONFIG_SOUNDMODEM_SBC */
macro_line|#ifdef CONFIG_SOUNDMODEM_AFSK1200
macro_line|#include &quot;sm_afsk1200.h&quot;
macro_line|#endif /* CONFIG_SOUNDMODEM_AFSK1200 */
macro_line|#ifdef CONFIG_SOUNDMODEM_FSK9600
macro_line|#include &quot;sm_fsk9600.h&quot;
macro_line|#endif /* CONFIG_SOUNDMODEM_FSK9600 */
macro_line|#ifdef CONFIG_SOUNDMODEM_AFSK2666
macro_line|#include &quot;sm_afsk2666.h&quot;
macro_line|#endif /* CONFIG_SOUNDMODEM_AFSK2666 */
macro_line|#ifdef CONFIG_SOUNDMODEM_PSK4800
macro_line|#include &quot;sm_psk4800.h&quot;
macro_line|#endif /* CONFIG_SOUNDMODEM_PSK4800 */
multiline_comment|/* --------------------------------------------------------------------- */
r_static
r_int
id|sm_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sm_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sm_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|modem_tx_base
r_const
r_struct
id|modem_tx_info
op_star
id|modem_tx_base
op_assign
id|NEXT_TX_INFO
suffix:semicolon
DECL|variable|modem_rx_base
r_const
r_struct
id|modem_rx_info
op_star
id|modem_rx_base
op_assign
id|NEXT_RX_INFO
suffix:semicolon
DECL|variable|hardware_base
r_const
r_struct
id|hardware_info
op_star
id|hardware_base
op_assign
id|NEXT_HW_INFO
suffix:semicolon
DECL|variable|sm_ops
r_static
r_const
r_struct
id|hdlcdrv_ops
id|sm_ops
op_assign
(brace
id|sm_drvname
comma
id|sm_drvinfo
comma
id|sm_open
comma
id|sm_close
comma
id|sm_ioctl
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sm_open
r_static
r_int
id|sm_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;priv
op_logical_or
(paren
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm_open: invalid device struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;mode_tx
op_logical_or
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
op_logical_neg
id|sm-&gt;hwdrv
op_logical_or
op_logical_neg
id|sm-&gt;hwdrv-&gt;open
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sm-&gt;hdrv.par.bitrate
op_assign
id|sm-&gt;mode_rx-&gt;bitrate
suffix:semicolon
id|err
op_assign
id|sm-&gt;hwdrv
op_member_access_from_pointer
id|open
c_func
(paren
id|dev
comma
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|output_open
c_func
(paren
id|sm
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s mode %s.%s at iobase 0x%lx irq %u dma %u&bslash;n&quot;
comma
id|sm_drvname
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|sm-&gt;mode_tx-&gt;name
comma
id|sm-&gt;mode_rx-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sm_close
r_static
r_int
id|sm_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;priv
op_logical_or
(paren
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm_close: invalid device struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hwdrv
op_logical_and
id|sm-&gt;hwdrv-&gt;close
)paren
id|err
op_assign
id|sm-&gt;hwdrv
op_logical_and
id|sm-&gt;hwdrv
op_member_access_from_pointer
id|close
c_func
(paren
id|dev
comma
id|sm
)paren
suffix:semicolon
id|output_close
c_func
(paren
id|sm
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: close %s at iobase 0x%lx irq %u dma %u&bslash;n&quot;
comma
id|sm_drvname
comma
id|sm-&gt;hwdrv-&gt;hw_name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sethw
r_static
r_int
id|sethw
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
comma
r_char
op_star
id|mode
)paren
(brace
r_char
op_star
id|cp
op_assign
id|strchr
c_func
(paren
id|mode
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_const
r_struct
id|hardware_info
op_star
id|hwp
op_assign
id|hardware_base
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cp
)paren
id|cp
op_assign
id|mode
suffix:semicolon
r_else
(brace
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_while
c_loop
(paren
id|hwp
op_logical_and
id|hwp-&gt;hw_name
op_logical_and
id|strcmp
c_func
(paren
id|hwp-&gt;hw_name
comma
id|mode
)paren
)paren
id|hwp
op_assign
id|hwp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwp
op_logical_or
op_logical_neg
id|hwp-&gt;hw_name
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|hwp-&gt;loc_storage
OG
r_sizeof
(paren
id|sm-&gt;hw
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient storage for hw driver %s (%d)&bslash;n&quot;
comma
id|sm_drvname
comma
id|hwp-&gt;hw_name
comma
id|hwp-&gt;loc_storage
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sm-&gt;hwdrv
op_assign
id|hwp
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|cp
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hwdrv
op_logical_and
id|sm-&gt;hwdrv-&gt;sethw
)paren
r_return
id|sm-&gt;hwdrv
op_member_access_from_pointer
id|sethw
c_func
(paren
id|dev
comma
id|sm
comma
id|cp
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sm_ioctl
r_static
r_int
id|sm_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|hdlcdrv_ioctl
op_star
id|hi
comma
r_int
id|cmd
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
suffix:semicolon
r_struct
id|sm_ioctl
id|bi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|newdiagmode
suffix:semicolon
r_int
r_int
id|newdiagflags
suffix:semicolon
r_char
op_star
id|cp
suffix:semicolon
r_const
r_struct
id|modem_tx_info
op_star
id|mtp
op_assign
id|modem_tx_base
suffix:semicolon
r_const
r_struct
id|modem_rx_info
op_star
id|mrp
op_assign
id|modem_rx_base
suffix:semicolon
r_const
r_struct
id|hardware_info
op_star
id|hwp
op_assign
id|hardware_base
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;priv
op_logical_or
(paren
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm_ioctl: invalid device struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;hwdrv
op_logical_or
op_logical_neg
id|sm-&gt;hwdrv-&gt;ioctl
)paren
r_return
id|sm-&gt;hwdrv
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|dev
comma
id|sm
comma
id|ifr
comma
id|hi
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hi-&gt;cmd
)paren
(brace
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|sm-&gt;hwdrv
op_logical_and
id|sm-&gt;hwdrv-&gt;ioctl
)paren
r_return
id|sm-&gt;hwdrv
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|dev
comma
id|sm
comma
id|ifr
comma
id|hi
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|HDLCDRVCTL_GETMODE
suffix:colon
id|cp
op_assign
id|hi-&gt;data.modename
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hwdrv
op_logical_and
id|sm-&gt;hwdrv-&gt;hw_name
)paren
id|cp
op_add_assign
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot;%s:&quot;
comma
id|sm-&gt;hwdrv-&gt;hw_name
)paren
suffix:semicolon
r_else
id|cp
op_add_assign
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot;&lt;unspec&gt;:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;mode_tx
op_logical_and
id|sm-&gt;mode_tx-&gt;name
)paren
id|cp
op_add_assign
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot;%s&quot;
comma
id|sm-&gt;mode_tx-&gt;name
)paren
suffix:semicolon
r_else
id|cp
op_add_assign
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot;&lt;unspec&gt;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
op_logical_neg
id|sm-&gt;mode_rx
op_logical_or
id|strcmp
c_func
(paren
id|sm-&gt;mode_rx-&gt;name
comma
id|sm-&gt;mode_tx-&gt;name
)paren
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;mode_rx
op_logical_and
id|sm-&gt;mode_rx-&gt;name
)paren
id|cp
op_add_assign
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot;,%s&quot;
comma
id|sm-&gt;mode_rx-&gt;name
)paren
suffix:semicolon
r_else
id|cp
op_add_assign
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot;,&lt;unspec&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|hi
comma
r_sizeof
(paren
op_star
id|hi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HDLCDRVCTL_SETMODE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
op_logical_or
id|dev-&gt;start
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|hi-&gt;data.modename
(braket
r_sizeof
(paren
id|hi-&gt;data.modename
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|sethw
c_func
(paren
id|dev
comma
id|sm
comma
id|hi-&gt;data.modename
)paren
suffix:semicolon
r_case
id|HDLCDRVCTL_MODELIST
suffix:colon
id|cp
op_assign
id|hi-&gt;data.modename
suffix:semicolon
r_while
c_loop
(paren
id|hwp
)paren
(brace
r_if
c_cond
(paren
id|hwp-&gt;hw_name
)paren
id|cp
op_add_assign
id|sprintf
c_func
(paren
l_string|&quot;%s:,&quot;
comma
id|hwp-&gt;hw_name
)paren
suffix:semicolon
id|hwp
op_assign
id|hwp-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mtp
)paren
(brace
r_if
c_cond
(paren
id|mtp-&gt;name
)paren
id|cp
op_add_assign
id|sprintf
c_func
(paren
l_string|&quot;&gt;%s,&quot;
comma
id|mtp-&gt;name
)paren
suffix:semicolon
id|mtp
op_assign
id|mtp-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mrp
)paren
(brace
r_if
c_cond
(paren
id|mrp-&gt;name
)paren
id|cp
op_add_assign
id|sprintf
c_func
(paren
l_string|&quot;&lt;%s,&quot;
comma
id|mrp-&gt;name
)paren
suffix:semicolon
id|mrp
op_assign
id|mrp-&gt;next
suffix:semicolon
)brace
id|cp
(braket
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
id|hi
comma
r_sizeof
(paren
op_star
id|hi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef SM_DEBUG
r_case
id|SMCTL_GETDEBUG
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|bi.data.dbg.int_rate
op_assign
id|sm-&gt;debug_vals.last_intcnt
suffix:semicolon
id|bi.data.dbg.mod_cycles
op_assign
id|sm-&gt;debug_vals.mod_cyc
suffix:semicolon
id|bi.data.dbg.demod_cycles
op_assign
id|sm-&gt;debug_vals.demod_cyc
suffix:semicolon
id|bi.data.dbg.dma_residue
op_assign
id|sm-&gt;debug_vals.dma_residue
suffix:semicolon
id|sm-&gt;debug_vals.mod_cyc
op_assign
id|sm-&gt;debug_vals.demod_cyc
op_assign
id|sm-&gt;debug_vals.dma_residue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
r_case
id|SMCTL_DIAGNOSE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|newdiagmode
op_assign
id|bi.data.diag.mode
suffix:semicolon
id|newdiagflags
op_assign
id|bi.data.diag.flags
suffix:semicolon
r_if
c_cond
(paren
id|newdiagmode
OG
id|SM_DIAGMODE_CONSTELLATION
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|bi.data.diag.mode
op_assign
id|sm-&gt;diag.mode
suffix:semicolon
id|bi.data.diag.flags
op_assign
id|sm-&gt;diag.flags
suffix:semicolon
id|bi.data.diag.samplesperbit
op_assign
id|sm-&gt;mode_rx-&gt;sperbit
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;diag.mode
op_ne
id|newdiagmode
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sm-&gt;diag.ptr
op_assign
op_minus
l_int|1
suffix:semicolon
id|sm-&gt;diag.flags
op_assign
id|newdiagflags
op_amp
op_complement
id|SM_DIAGFLAG_VALID
suffix:semicolon
id|sm-&gt;diag.mode
op_assign
id|newdiagmode
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;diag.ptr
OL
l_int|0
op_logical_or
id|sm-&gt;diag.mode
op_eq
id|SM_DIAGMODE_OFF
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.diag.datalen
OG
id|DIAGDATALEN
)paren
id|bi.data.diag.datalen
op_assign
id|DIAGDATALEN
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;diag.ptr
OL
id|bi.data.diag.datalen
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|bi.data.diag.data
comma
id|sm-&gt;diag.data
comma
id|bi.data.diag.datalen
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|bi.data.diag.flags
op_or_assign
id|SM_DIAGFLAG_VALID
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sm-&gt;diag.ptr
op_assign
op_minus
l_int|1
suffix:semicolon
id|sm-&gt;diag.flags
op_assign
id|newdiagflags
op_amp
op_complement
id|SM_DIAGFLAG_VALID
suffix:semicolon
id|sm-&gt;diag.mode
op_assign
id|newdiagmode
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
r_static
macro_line|#endif /* MODULE */
DECL|function|sm_init
r_int
id|sm_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_char
id|set_hw
op_assign
l_int|1
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
suffix:semicolon
r_char
id|ifname
(braket
id|HDLCDRV_IFNAMELEN
)braket
suffix:semicolon
id|printk
c_func
(paren
id|sm_drvinfo
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * register net devices&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|sm_device
op_plus
id|i
suffix:semicolon
id|sprintf
c_func
(paren
id|ifname
comma
l_string|&quot;sm%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sm_ports
(braket
id|i
)braket
dot
id|mode
)paren
id|set_hw
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|set_hw
)paren
id|sm_ports
(braket
id|i
)braket
dot
id|iobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|irq
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
id|hdlcdrv_register_hdlcdrv
c_func
(paren
id|dev
comma
op_amp
id|sm_ops
comma
r_sizeof
(paren
r_struct
id|sm_state
)paren
comma
id|ifname
comma
id|sm_ports
(braket
id|i
)braket
dot
id|iobase
comma
id|sm_ports
(braket
id|i
)braket
dot
id|irq
comma
id|sm_ports
(braket
id|i
)braket
dot
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
(brace
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.dma2
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|dma2
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.seriobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|seriobase
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.pariobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|pariobase
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.midiiobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|midiiobase
suffix:semicolon
r_if
c_cond
(paren
id|set_hw
op_logical_and
id|sethw
c_func
(paren
id|dev
comma
id|sm
comma
id|sm_ports
(braket
id|i
)braket
dot
id|mode
)paren
)paren
id|set_hw
op_assign
l_int|0
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cannot register net device&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
multiline_comment|/*&n; * command line settable parameters&n; */
DECL|variable|mode
r_char
op_star
id|mode
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|iobase
r_int
id|iobase
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_int
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma
r_int
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma2
r_int
id|dma2
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|serio
r_int
id|serio
op_assign
l_int|0
suffix:semicolon
DECL|variable|pario
r_int
id|pario
op_assign
l_int|0
suffix:semicolon
DECL|variable|midiio
r_int
id|midiio
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mode
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|iobase
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma2
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|serio
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pario
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|midiio
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mode
)paren
(brace
r_if
c_cond
(paren
id|iobase
op_eq
op_minus
l_int|1
)paren
id|iobase
op_assign
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|mode
comma
l_string|&quot;sbc&quot;
comma
l_int|3
)paren
)paren
ques
c_cond
l_int|0x220
suffix:colon
l_int|0x530
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
op_minus
l_int|1
)paren
id|irq
op_assign
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|mode
comma
l_string|&quot;sbc&quot;
comma
l_int|3
)paren
)paren
ques
c_cond
l_int|5
suffix:colon
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|dma
op_eq
op_minus
l_int|1
)paren
id|dma
op_assign
l_int|1
suffix:semicolon
)brace
id|sm_ports
(braket
l_int|0
)braket
dot
id|mode
op_assign
id|mode
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|iobase
op_assign
id|iobase
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|irq
op_assign
id|irq
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|dma
op_assign
id|dma
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|dma2
op_assign
id|dma2
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|seriobase
op_assign
id|serio
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|pariobase
op_assign
id|pario
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|midiiobase
op_assign
id|midiio
suffix:semicolon
id|sm_ports
(braket
l_int|1
)braket
dot
id|mode
op_assign
l_int|NULL
suffix:semicolon
r_return
id|sm_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: cleanup_module called&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|sm_device
op_plus
id|i
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|sm
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: invalid magic in &quot;
l_string|&quot;cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|hdlcdrv_unregister_hdlcdrv
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#else /* MODULE */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * format: sm=io,irq,dma[,dma2[,serio[,pario]]],mode&n; * mode: hw:modem&n; * hw: sbc, wss, wssfdx&n; * modem: afsk1200, fsk9600&n; */
DECL|function|sm_setup
r_void
id|sm_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|NR_PORTS
)paren
op_logical_and
(paren
id|sm_ports
(braket
id|i
)braket
dot
id|mode
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_ge
id|NR_PORTS
)paren
op_logical_or
(paren
id|ints
(braket
l_int|0
)braket
OL
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: too many or invalid interface &quot;
l_string|&quot;specifications&bslash;n&quot;
comma
id|sm_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sm_ports
(braket
id|i
)braket
dot
id|mode
op_assign
id|str
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|iobase
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|dma
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|dma2
op_assign
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|5
)paren
ques
c_cond
id|ints
(braket
l_int|4
)braket
suffix:colon
l_int|0
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|seriobase
op_assign
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|6
)paren
ques
c_cond
id|ints
(braket
l_int|5
)braket
suffix:colon
l_int|0
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|pariobase
op_assign
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|7
)paren
ques
c_cond
id|ints
(braket
l_int|6
)braket
suffix:colon
l_int|0
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|midiiobase
op_assign
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|8
)paren
ques
c_cond
id|ints
(braket
l_int|7
)braket
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|NR_PORTS
op_minus
l_int|1
)paren
id|sm_ports
(braket
id|i
op_plus
l_int|1
)braket
dot
id|mode
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/* --------------------------------------------------------------------- */
eof
