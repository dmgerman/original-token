multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;soundmodem.c  -- soundcard radio modem driver.&n; *&n; *&t;Copyright (C) 1996  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Please note that the GPL allows you to use the driver, NOT the radio.&n; *  In order to use the radio, you need a license from the communications&n; *  authority of your country.&n; *&n; *&n; *  Command line options (insmod command line)&n; * &n; *  hardware hardware type; 0=sbc, 1=wss, any other value invalid&n; *  mode     mode type; 0=1200 baud AFSK, 1=9600 baud FSK, any other&n; *           value invalid&n; *  iobase   base address of the soundcard; common values are 0x220 for sbc,&n; *           0x530 for wss&n; *  irq      interrupt number; common values are 7 or 5 for sbc, 11 for wss&n; *  dma      dma number; common values are 0 or 1&n; * &n; *&n; *  History:&n; *   0.1  21.09.96  Started&n; *        18.10.96  Changed to new user space access routines (copy_{to,from}_user)&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;limits.h&gt;
macro_line|#include &lt;linux/hdlcdrv.h&gt;
macro_line|#include &lt;linux/soundmodem.h&gt;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|NR_PORTS
mdefine_line|#define NR_PORTS 4
DECL|macro|SM_DEBUG
mdefine_line|#define SM_DEBUG
DECL|macro|ENABLE_SBC
mdefine_line|#define ENABLE_SBC
DECL|macro|ENABLE_WSS
mdefine_line|#define ENABLE_WSS
DECL|macro|ENABLE_WSSFDX
macro_line|#undef  ENABLE_WSSFDX
DECL|macro|ENABLE_AFSK1200
mdefine_line|#define ENABLE_AFSK1200
DECL|macro|ENABLE_FSK9600
mdefine_line|#define ENABLE_FSK9600
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#include &quot;sm_tables.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sm_device
r_static
r_struct
id|device
id|sm_device
(braket
id|NR_PORTS
)braket
suffix:semicolon
r_static
r_struct
(brace
DECL|member|hardware
DECL|member|mode
DECL|member|iobase
DECL|member|irq
DECL|member|dma
DECL|member|seriobase
DECL|member|pariobase
DECL|member|midiiobase
r_int
id|hardware
comma
id|mode
comma
id|iobase
comma
id|irq
comma
id|dma
comma
id|seriobase
comma
id|pariobase
comma
id|midiiobase
suffix:semicolon
DECL|variable|sm_ports
)brace
id|sm_ports
(braket
id|NR_PORTS
)braket
op_assign
(brace
(brace
id|SM_HARDWARE_INVALID
comma
id|SM_MODE_INVALID
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* &n; * the sbc converter&squot;s registers &n; */
DECL|macro|DSP_RESET
mdefine_line|#define DSP_RESET(iobase)        (iobase+0x6)
DECL|macro|DSP_READ_DATA
mdefine_line|#define DSP_READ_DATA(iobase)    (iobase+0xa)
DECL|macro|DSP_WRITE_DATA
mdefine_line|#define DSP_WRITE_DATA(iobase)   (iobase+0xc)
DECL|macro|DSP_WRITE_STATUS
mdefine_line|#define DSP_WRITE_STATUS(iobase) (iobase+0xc)
DECL|macro|DSP_DATA_AVAIL
mdefine_line|#define DSP_DATA_AVAIL(iobase)   (iobase+0xe)
DECL|macro|DSP_MIXER_ADDR
mdefine_line|#define DSP_MIXER_ADDR(iobase)   (iobase+0x4)
DECL|macro|DSP_MIXER_DATA
mdefine_line|#define DSP_MIXER_DATA(iobase)   (iobase+0x5)
DECL|macro|SBC_EXTENT
mdefine_line|#define SBC_EXTENT               16
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * SBC commands&n; */
DECL|macro|SBC_OUTPUT
mdefine_line|#define SBC_OUTPUT             0x14
DECL|macro|SBC_INPUT
mdefine_line|#define SBC_INPUT              0x24
DECL|macro|SBC_HISPEED
mdefine_line|#define SBC_HISPEED            0x48
DECL|macro|SBC_HI_OUTPUT
mdefine_line|#define SBC_HI_OUTPUT          0x91 
DECL|macro|SBC_HI_INPUT
mdefine_line|#define SBC_HI_INPUT           0x99 
DECL|macro|SBC_LO_OUTPUT_AUTOINIT
mdefine_line|#define SBC_LO_OUTPUT_AUTOINIT 0x1c
DECL|macro|SBC_LO_INPUT_AUTOINIT
mdefine_line|#define SBC_LO_INPUT_AUTOINIT  0x2c
DECL|macro|SBC_HI_OUTPUT_AUTOINIT
mdefine_line|#define SBC_HI_OUTPUT_AUTOINIT 0x90 
DECL|macro|SBC_HI_INPUT_AUTOINIT
mdefine_line|#define SBC_HI_INPUT_AUTOINIT  0x98
DECL|macro|SBC_IMMED_INT
mdefine_line|#define SBC_IMMED_INT          0xf2
DECL|macro|SBC_GET_REVISION
mdefine_line|#define SBC_GET_REVISION       0xe1
DECL|macro|ESS_GET_REVISION
mdefine_line|#define ESS_GET_REVISION       0xe7
DECL|macro|SBC_SPEAKER_ON
mdefine_line|#define SBC_SPEAKER_ON         0xd1
DECL|macro|SBC_SPEAKER_OFF
mdefine_line|#define SBC_SPEAKER_OFF        0xd3
DECL|macro|SBC_DMA_ON
mdefine_line|#define SBC_DMA_ON             0xd0
DECL|macro|SBC_DMA_OFF
mdefine_line|#define SBC_DMA_OFF            0xd4
DECL|macro|SBC_SAMPLE_RATE
mdefine_line|#define SBC_SAMPLE_RATE        0x40
DECL|macro|SBC_MONO_8BIT
mdefine_line|#define SBC_MONO_8BIT          0xa0
DECL|macro|SBC_MONO_16BIT
mdefine_line|#define SBC_MONO_16BIT         0xa4
DECL|macro|SBC_STEREO_8BIT
mdefine_line|#define SBC_STEREO_8BIT        0xa8
DECL|macro|SBC_STEREO_16BIT
mdefine_line|#define SBC_STEREO_16BIT       0xac
DECL|macro|DMA_MODE_AUTOINIT
mdefine_line|#define DMA_MODE_AUTOINIT      0x10
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|WSS_CONFIG
mdefine_line|#define WSS_CONFIG(iobase)       (iobase+0)
DECL|macro|WSS_STATUS
mdefine_line|#define WSS_STATUS(iobase)       (iobase+3)
DECL|macro|WSS_CODEC_IA
mdefine_line|#define WSS_CODEC_IA(iobase)     (iobase+4)
DECL|macro|WSS_CODEC_ID
mdefine_line|#define WSS_CODEC_ID(iobase)     (iobase+5)
DECL|macro|WSS_CODEC_STATUS
mdefine_line|#define WSS_CODEC_STATUS(iobase) (iobase+6)
DECL|macro|WSS_CODEC_DATA
mdefine_line|#define WSS_CODEC_DATA(iobase)   (iobase+7)
DECL|macro|WSS_EXTENT
mdefine_line|#define WSS_EXTENT   8
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|UART_RBR
mdefine_line|#define UART_RBR(iobase) (iobase+0)
DECL|macro|UART_THR
mdefine_line|#define UART_THR(iobase) (iobase+0)
DECL|macro|UART_IER
mdefine_line|#define UART_IER(iobase) (iobase+1)
DECL|macro|UART_IIR
mdefine_line|#define UART_IIR(iobase) (iobase+2)
DECL|macro|UART_FCR
mdefine_line|#define UART_FCR(iobase) (iobase+2)
DECL|macro|UART_LCR
mdefine_line|#define UART_LCR(iobase) (iobase+3)
DECL|macro|UART_MCR
mdefine_line|#define UART_MCR(iobase) (iobase+4)
DECL|macro|UART_LSR
mdefine_line|#define UART_LSR(iobase) (iobase+5)
DECL|macro|UART_MSR
mdefine_line|#define UART_MSR(iobase) (iobase+6)
DECL|macro|UART_SCR
mdefine_line|#define UART_SCR(iobase) (iobase+7)
DECL|macro|UART_DLL
mdefine_line|#define UART_DLL(iobase) (iobase+0)
DECL|macro|UART_DLM
mdefine_line|#define UART_DLM(iobase) (iobase+1)
DECL|macro|SER_EXTENT
mdefine_line|#define SER_EXTENT 8
DECL|macro|LPT_DATA
mdefine_line|#define LPT_DATA(iobase)    (iobase+0)
DECL|macro|LPT_STATUS
mdefine_line|#define LPT_STATUS(iobase)  (iobase+1)
DECL|macro|LPT_CONTROL
mdefine_line|#define LPT_CONTROL(iobase) (iobase+2)
DECL|macro|LPT_IRQ_ENABLE
mdefine_line|#define LPT_IRQ_ENABLE      0x10
DECL|macro|LPT_EXTENT
mdefine_line|#define LPT_EXTENT 3
DECL|macro|MIDI_DATA
mdefine_line|#define MIDI_DATA(iobase)     (iobase)
DECL|macro|MIDI_STATUS
mdefine_line|#define MIDI_STATUS(iobase)   (iobase+1)
DECL|macro|MIDI_READ_FULL
mdefine_line|#define MIDI_READ_FULL 0x80   /* attention: negative logic!! */
DECL|macro|MIDI_WRITE_EMPTY
mdefine_line|#define MIDI_WRITE_EMPTY 0x40 /* attention: negative logic!! */
DECL|macro|MIDI_EXTENT
mdefine_line|#define MIDI_EXTENT 2
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|macro|PARAM_TXDELAY
mdefine_line|#define PARAM_TXDELAY   1
DECL|macro|PARAM_PERSIST
mdefine_line|#define PARAM_PERSIST   2
DECL|macro|PARAM_SLOTTIME
mdefine_line|#define PARAM_SLOTTIME  3
DECL|macro|PARAM_TXTAIL
mdefine_line|#define PARAM_TXTAIL    4
DECL|macro|PARAM_FULLDUP
mdefine_line|#define PARAM_FULLDUP   5
DECL|macro|PARAM_HARDWARE
mdefine_line|#define PARAM_HARDWARE  6
DECL|macro|PARAM_RETURN
mdefine_line|#define PARAM_RETURN    255
DECL|macro|SP_SER
mdefine_line|#define SP_SER  1
DECL|macro|SP_PAR
mdefine_line|#define SP_PAR  2
DECL|macro|SP_MIDI
mdefine_line|#define SP_MIDI 4
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/*&n; * Information that need to be kept for each board. &n; */
DECL|struct|sm_state
r_struct
id|sm_state
(brace
DECL|member|hdrv
r_struct
id|hdlcdrv_state
id|hdrv
suffix:semicolon
DECL|struct|config
r_struct
id|config
(brace
DECL|member|hardware
r_int
id|hardware
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|member|config
)brace
id|config
suffix:semicolon
DECL|struct|modem_state
r_struct
id|modem_state
(brace
DECL|member|revhi
DECL|member|revlo
r_int
r_char
id|revhi
comma
id|revlo
suffix:semicolon
DECL|member|shreg
r_int
r_int
id|shreg
suffix:semicolon
DECL|member|last_sample
r_int
r_char
id|last_sample
suffix:semicolon
DECL|member|bit_pll
r_int
r_int
id|bit_pll
suffix:semicolon
DECL|member|dcd_shreg
r_int
r_int
id|dcd_shreg
suffix:semicolon
DECL|member|dcd_sum0
DECL|member|dcd_sum1
DECL|member|dcd_sum2
r_int
id|dcd_sum0
comma
id|dcd_sum1
comma
id|dcd_sum2
suffix:semicolon
DECL|member|dcd_time
r_int
r_int
id|dcd_time
suffix:semicolon
DECL|member|last_rxbit
r_int
r_char
id|last_rxbit
suffix:semicolon
DECL|member|tx_bit
r_int
r_char
id|tx_bit
suffix:semicolon
DECL|member|filt
r_int
r_char
id|filt
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|descram
r_int
r_int
id|descram
suffix:semicolon
DECL|member|scram
r_int
r_int
id|scram
suffix:semicolon
DECL|member|dmabufr
r_int
r_char
op_star
id|dmabufr
suffix:semicolon
DECL|member|dmabufw
r_int
r_char
op_star
id|dmabufw
suffix:semicolon
DECL|member|dmabufidx
r_int
r_char
id|dmabufidx
suffix:semicolon
DECL|member|oldptt
r_int
r_char
id|oldptt
suffix:semicolon
DECL|member|modem
)brace
id|modem
suffix:semicolon
DECL|macro|DIAGDATALEN
mdefine_line|#define DIAGDATALEN 64
DECL|struct|diag_data
r_struct
id|diag_data
(brace
DECL|member|mode
r_int
r_int
id|mode
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|ptr
r_volatile
r_int
id|ptr
suffix:semicolon
DECL|member|data
r_int
id|data
(braket
id|DIAGDATALEN
)braket
suffix:semicolon
DECL|member|diag
)brace
id|diag
suffix:semicolon
macro_line|#ifdef SM_DEBUG
DECL|struct|debug_vals
r_struct
id|debug_vals
(brace
DECL|member|last_jiffies
r_int
r_int
id|last_jiffies
suffix:semicolon
DECL|member|cur_intcnt
r_int
id|cur_intcnt
suffix:semicolon
DECL|member|last_intcnt
r_int
id|last_intcnt
suffix:semicolon
DECL|member|cur_pllcorr
r_int
id|cur_pllcorr
suffix:semicolon
DECL|member|last_pllcorr
r_int
id|last_pllcorr
suffix:semicolon
DECL|member|debug_vals
)brace
id|debug_vals
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|struct|modem_info
r_struct
id|modem_info
(brace
DECL|member|hops
r_struct
id|hdlcdrv_ops
id|hops
suffix:semicolon
DECL|member|samplerate
r_int
r_int
id|samplerate
suffix:semicolon
DECL|member|sbcmix
r_int
r_char
id|sbcmix
suffix:semicolon
DECL|member|sperbit
r_int
r_char
id|sperbit
suffix:semicolon
DECL|member|mode_name
r_char
op_star
id|mode_name
suffix:semicolon
multiline_comment|/* used for request_{region,irq,dma} */
multiline_comment|/*&n;&t; * low level chip informations&n;&t; */
DECL|member|data_fmt
r_int
r_char
id|data_fmt
suffix:semicolon
DECL|member|dmabuflen
r_int
r_int
id|dmabuflen
suffix:semicolon
DECL|member|modulator
r_void
(paren
op_star
id|modulator
)paren
(paren
r_struct
id|sm_state
op_star
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|demodulator
r_void
(paren
op_star
id|demodulator
)paren
(paren
r_struct
id|sm_state
op_star
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|min
mdefine_line|#define min(a, b) (((a) &lt; (b)) ? (a) : (b))
DECL|macro|max
mdefine_line|#define max(a, b) (((a) &gt; (b)) ? (a) : (b))
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sm_int_freq
r_static
r_void
r_inline
id|sm_int_freq
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
macro_line|#ifdef SM_DEBUG
r_int
r_int
id|cur_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* &n;&t; * measure the interrupt frequency&n;&t; */
id|sm-&gt;debug_vals.cur_intcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cur_jiffies
op_minus
id|sm-&gt;debug_vals.last_jiffies
)paren
op_ge
id|HZ
)paren
(brace
id|sm-&gt;debug_vals.last_jiffies
op_assign
id|cur_jiffies
suffix:semicolon
id|sm-&gt;debug_vals.last_intcnt
op_assign
id|sm-&gt;debug_vals.cur_intcnt
suffix:semicolon
id|sm-&gt;debug_vals.cur_intcnt
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* SM_DEBUG */
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== port checking routines ========================&n; */
DECL|function|check_lpt
r_static
r_int
r_inline
id|check_lpt
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|b1
comma
id|b2
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|LPT_EXTENT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|LPT_EXTENT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b2
op_assign
id|inb
c_func
(paren
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xaa
comma
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
op_eq
l_int|0xaa
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_and_assign
id|inb
c_func
(paren
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
op_eq
l_int|0x55
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0a
comma
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_and_assign
(paren
id|inb
c_func
(paren
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0x0a
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|i
op_and_assign
(paren
id|inb
c_func
(paren
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0x05
suffix:semicolon
id|outb
c_func
(paren
id|b1
comma
id|LPT_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|b2
comma
id|LPT_CONTROL
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_return
op_logical_neg
id|i
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|enum|uart
DECL|enumerator|c_uart_unknown
DECL|enumerator|c_uart_8250
r_enum
id|uart
(brace
id|c_uart_unknown
comma
id|c_uart_8250
comma
DECL|enumerator|c_uart_16450
DECL|enumerator|c_uart_16550
DECL|enumerator|c_uart_16550A
id|c_uart_16450
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
DECL|variable|uart_str
r_static
r_const
r_char
op_star
id|uart_str
(braket
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;8250&quot;
comma
l_string|&quot;16450&quot;
comma
l_string|&quot;16550&quot;
comma
l_string|&quot;16550A&quot;
)brace
suffix:semicolon
DECL|function|check_uart
r_static
r_enum
id|uart
r_inline
id|check_uart
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|b1
comma
id|b2
comma
id|b3
suffix:semicolon
r_enum
id|uart
id|u
suffix:semicolon
r_enum
id|uart
id|uart_tab
(braket
)braket
op_assign
(brace
id|c_uart_16450
comma
id|c_uart_unknown
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|SER_EXTENT
)paren
r_return
id|c_uart_unknown
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|SER_EXTENT
)paren
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|b1
op_or
l_int|0x10
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* loopback mode */
id|b2
op_assign
id|inb
c_func
(paren
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x1a
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b3
op_assign
id|inb
c_func
(paren
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|outb
c_func
(paren
id|b1
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* restore old values */
id|outb
c_func
(paren
id|b2
comma
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b3
op_ne
l_int|0x90
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|inb
c_func
(paren
id|UART_RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|UART_RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|UART_FCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* enable FIFOs */
id|u
op_assign
id|uart_tab
(braket
(paren
id|inb
c_func
(paren
id|UART_IIR
c_func
(paren
id|iobase
)paren
)paren
op_rshift
l_int|6
)paren
op_amp
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
id|c_uart_16450
)paren
(brace
id|outb
c_func
(paren
l_int|0x5a
comma
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa5
comma
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b2
op_assign
id|inb
c_func
(paren
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b1
op_ne
l_int|0x5a
)paren
op_logical_or
(paren
id|b2
op_ne
l_int|0xa5
)paren
)paren
id|u
op_assign
id|c_uart_8250
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|check_midi
r_static
r_int
r_inline
id|check_midi
c_func
(paren
r_int
r_int
id|iobase
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|b
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|MIDI_EXTENT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|MIDI_EXTENT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
op_amp
id|MIDI_WRITE_EMPTY
)paren
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|MIDI_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b
op_assign
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|MIDI_WRITE_EMPTY
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
op_amp
id|MIDI_WRITE_EMPTY
)paren
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_status
r_static
r_void
r_inline
id|output_status
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
id|invert_dcd
op_assign
l_int|0
suffix:semicolon
r_int
id|invert_ptt
op_assign
l_int|0
suffix:semicolon
r_int
id|ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
op_xor
id|invert_ptt
suffix:semicolon
r_int
id|dcd
op_assign
(paren
op_logical_neg
op_logical_neg
id|sm-&gt;hdrv.hdlcrx.dcd
)paren
op_xor
id|invert_dcd
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_SER
)paren
(brace
id|outb
c_func
(paren
id|dcd
op_or
(paren
id|ptt
op_lshift
l_int|1
)paren
comma
id|UART_MCR
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x40
op_amp
(paren
op_minus
id|ptt
)paren
comma
id|UART_LCR
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_PAR
)paren
(brace
id|outb
c_func
(paren
id|ptt
op_or
(paren
id|dcd
op_lshift
l_int|1
)paren
comma
id|LPT_DATA
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_MIDI
op_logical_and
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|MIDI_DATA
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_open
r_static
r_void
id|output_open
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_enum
id|uart
id|u
op_assign
id|c_uart_unknown
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
OG
l_int|0
op_logical_and
id|sm-&gt;hdrv.ptt_out.seriobase
op_le
l_int|0x1000
op_minus
id|SER_EXTENT
op_logical_and
(paren
(paren
id|u
op_assign
id|check_uart
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
)paren
op_ne
id|c_uart_unknown
)paren
(brace
id|sm-&gt;hdrv.ptt_out.flags
op_or_assign
id|SP_SER
suffix:semicolon
id|request_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
comma
id|SER_EXTENT
comma
l_string|&quot;sm ser ptt&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|UART_IER
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
multiline_comment|/* 5 bits, 1 stop, no parity, no break, Div latch access */
id|outb
c_func
(paren
l_int|0x80
comma
id|UART_LCR
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|UART_DLM
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|UART_DLL
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
)paren
)paren
suffix:semicolon
multiline_comment|/* as fast as possible */
multiline_comment|/* LCR and MCR set by output_status */
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
OG
l_int|0
op_logical_and
id|sm-&gt;hdrv.ptt_out.pariobase
op_le
l_int|0x1000
op_minus
id|LPT_EXTENT
op_logical_and
id|check_lpt
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
)paren
)paren
(brace
id|sm-&gt;hdrv.ptt_out.flags
op_or_assign
id|SP_PAR
suffix:semicolon
id|request_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
comma
id|LPT_EXTENT
comma
l_string|&quot;sm par ptt&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
OG
l_int|0
op_logical_and
id|sm-&gt;hdrv.ptt_out.midiiobase
op_le
l_int|0x1000
op_minus
id|MIDI_EXTENT
op_logical_and
id|check_midi
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
)paren
)paren
(brace
id|sm-&gt;hdrv.ptt_out.flags
op_or_assign
id|SP_MIDI
suffix:semicolon
id|request_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
comma
id|MIDI_EXTENT
comma
l_string|&quot;sm midi ptt&quot;
)paren
suffix:semicolon
)brace
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: ptt output:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_SER
)paren
id|printk
c_func
(paren
l_string|&quot; serial interface at 0x%x, uart %s&quot;
comma
id|sm-&gt;hdrv.ptt_out.seriobase
comma
id|uart_str
(braket
id|u
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_PAR
)paren
id|printk
c_func
(paren
l_string|&quot; parallel interface at 0x%x&quot;
comma
id|sm-&gt;hdrv.ptt_out.pariobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_MIDI
)paren
id|printk
c_func
(paren
l_string|&quot; mpu401 (midi) interface at 0x%x&quot;
comma
id|sm-&gt;hdrv.ptt_out.midiiobase
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;hdrv.ptt_out.flags
)paren
id|printk
c_func
(paren
l_string|&quot; none&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_close
r_static
r_void
id|output_close
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
multiline_comment|/* release regions used for PTT output */
id|sm-&gt;hdrv.hdlctx.ptt
op_assign
id|sm-&gt;hdrv.hdlctx.calibrate
op_assign
l_int|0
suffix:semicolon
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_SER
)paren
id|release_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.seriobase
comma
id|SER_EXTENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_PAR
)paren
id|release_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.pariobase
comma
id|LPT_EXTENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;hdrv.ptt_out.flags
op_amp
id|SP_MIDI
)paren
id|release_region
c_func
(paren
id|sm-&gt;hdrv.ptt_out.midiiobase
comma
id|MIDI_EXTENT
)paren
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.flags
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== diagnostics stuff ===============================&n; */
DECL|function|diag_trigger
r_static
r_inline
r_void
id|diag_trigger
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;diag.flags
op_amp
id|SM_DIAGFLAG_DCDGATE
)paren
op_logical_or
id|sm-&gt;hdrv.hdlcrx.dcd
)paren
id|sm-&gt;diag.ptr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|diag_add
r_static
r_inline
r_void
id|diag_add
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|valinp
comma
r_int
id|valdemod
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_INPUT
op_logical_and
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_DEMOD
)paren
op_logical_or
id|sm-&gt;diag.ptr
op_ge
id|DIAGDATALEN
op_logical_or
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_return
suffix:semicolon
id|val
op_assign
(paren
id|sm-&gt;diag.mode
op_eq
id|SM_DIAGMODE_DEMOD
)paren
ques
c_cond
id|valdemod
suffix:colon
id|valinp
suffix:semicolon
multiline_comment|/* clip */
r_if
c_cond
(paren
id|val
OG
id|SHRT_MAX
)paren
id|val
op_assign
id|SHRT_MAX
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
id|SHRT_MIN
)paren
id|val
op_assign
id|SHRT_MIN
suffix:semicolon
id|sm-&gt;diag.data
(braket
id|sm-&gt;diag.ptr
op_increment
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|diag_add_one
r_static
r_inline
r_void
id|diag_add_one
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
(paren
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_INPUT
op_logical_and
id|sm-&gt;diag.mode
op_ne
id|SM_DIAGMODE_DEMOD
)paren
op_logical_or
id|sm-&gt;diag.ptr
op_ge
id|DIAGDATALEN
op_logical_or
id|sm-&gt;diag.ptr
OL
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* clip */
r_if
c_cond
(paren
id|val
OG
id|SHRT_MAX
)paren
id|val
op_assign
id|SHRT_MAX
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
id|SHRT_MIN
)paren
id|val
op_assign
id|SHRT_MIN
suffix:semicolon
id|sm-&gt;diag.data
(braket
id|sm-&gt;diag.ptr
op_increment
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== modem routines 1200 baud =========================&n; */
r_static
r_inline
r_int
r_int
id|hweight32
c_func
(paren
r_int
r_int
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_static
r_inline
r_int
r_int
id|hweight16
c_func
(paren
r_int
r_int
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
r_static
r_inline
r_int
r_int
id|hweight8
c_func
(paren
r_int
r_char
id|w
)paren
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
suffix:semicolon
DECL|function|hweight32
r_static
r_inline
r_int
r_int
id|hweight32
c_func
(paren
r_int
r_int
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x55555555
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x55555555
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x33333333
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x33333333
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x0F0F0F0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F0F0F0F
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x00FF00FF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF00FF
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x0000FFFF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|16
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
)brace
DECL|function|hweight16
r_static
r_inline
r_int
r_int
id|hweight16
c_func
(paren
r_int
r_int
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x5555
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x5555
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x3333
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x3333
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x0F0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F0F
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x00FF
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
)paren
suffix:semicolon
)brace
DECL|function|hweight8
r_static
r_inline
r_int
r_int
id|hweight8
c_func
(paren
r_int
r_char
id|w
)paren
(brace
r_int
r_int
id|res
op_assign
(paren
id|w
op_amp
l_int|0x55
)paren
op_plus
(paren
(paren
id|w
op_rshift
l_int|1
)paren
op_amp
l_int|0x55
)paren
suffix:semicolon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x33
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|2
)paren
op_amp
l_int|0x33
)paren
suffix:semicolon
r_return
(paren
id|res
op_amp
l_int|0x0F
)paren
op_plus
(paren
(paren
id|res
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef ENABLE_AFSK1200
DECL|function|modulator_1200
r_static
r_void
id|modulator_1200
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_static
r_const
r_int
id|dds_inc
(braket
l_int|2
)braket
op_assign
(brace
l_int|8192
comma
l_int|15019
)brace
suffix:semicolon
r_int
id|j
comma
id|k
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|buflen
op_ge
l_int|8
suffix:semicolon
id|buflen
op_sub_assign
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;modem.shreg
op_le
l_int|1
)paren
id|sm-&gt;modem.shreg
op_assign
id|hdlcdrv_getbits
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
op_or
l_int|0x10000
suffix:semicolon
id|sm-&gt;modem.tx_bit
op_assign
(paren
id|sm-&gt;modem.tx_bit
op_xor
(paren
op_logical_neg
(paren
id|sm-&gt;modem.shreg
op_amp
l_int|1
)paren
)paren
)paren
op_amp
l_int|1
suffix:semicolon
id|sm-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
id|k
op_assign
id|dds_inc
(braket
id|sm-&gt;modem.tx_bit
op_amp
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|buf
op_increment
op_assign
id|sinetab
(braket
(paren
id|sm-&gt;modem.bit_pll
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
)braket
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
id|k
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|demodulator_1200
r_static
r_void
id|demodulator_1200
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_static
r_const
r_int
id|pll_corr
(braket
l_int|2
)braket
op_assign
(brace
op_minus
l_int|0x1000
comma
l_int|0x1000
)brace
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
r_char
op_star
id|fp
suffix:semicolon
r_const
r_int
r_char
op_star
id|coeffp
suffix:semicolon
r_int
id|sum1
comma
id|sum2
suffix:semicolon
r_int
r_char
id|newsample
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|buflen
OG
l_int|0
suffix:semicolon
id|buflen
op_decrement
comma
id|buf
op_increment
)paren
(brace
id|sm-&gt;modem.filt
(braket
l_int|8
)braket
op_assign
(paren
op_star
id|buf
op_minus
l_int|128
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sum1
op_assign
id|j
op_assign
l_int|0
comma
id|fp
op_assign
id|sm-&gt;modem.filt
op_plus
l_int|1
comma
id|coeffp
op_assign
id|tx_lo_i
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|fp
op_increment
comma
id|coeffp
op_increment
)paren
(brace
id|sum1
op_add_assign
(paren
op_star
id|coeffp
)paren
op_star
(paren
op_star
id|fp
)paren
suffix:semicolon
id|fp
(braket
op_minus
l_int|1
)braket
op_assign
id|fp
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|sum1
op_rshift_assign
l_int|7
suffix:semicolon
id|sum2
op_assign
id|sum1
op_star
id|sum1
suffix:semicolon
r_for
c_loop
(paren
id|sum1
op_assign
id|j
op_assign
l_int|0
comma
id|fp
op_assign
id|sm-&gt;modem.filt
comma
id|coeffp
op_assign
id|tx_lo_q
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|fp
op_increment
comma
id|coeffp
op_increment
)paren
id|sum1
op_add_assign
(paren
op_star
id|coeffp
)paren
op_star
(paren
op_star
id|fp
)paren
suffix:semicolon
id|sum1
op_rshift_assign
l_int|7
suffix:semicolon
id|sum2
op_add_assign
id|sum1
op_star
id|sum1
suffix:semicolon
r_for
c_loop
(paren
id|sum1
op_assign
id|j
op_assign
l_int|0
comma
id|fp
op_assign
id|sm-&gt;modem.filt
comma
id|coeffp
op_assign
id|tx_hi_i
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|fp
op_increment
comma
id|coeffp
op_increment
)paren
id|sum1
op_add_assign
(paren
op_star
id|coeffp
)paren
op_star
(paren
op_star
id|fp
)paren
suffix:semicolon
id|sum1
op_rshift_assign
l_int|7
suffix:semicolon
id|sum2
op_sub_assign
id|sum1
op_star
id|sum1
suffix:semicolon
r_for
c_loop
(paren
id|sum1
op_assign
id|j
op_assign
l_int|0
comma
id|fp
op_assign
id|sm-&gt;modem.filt
comma
id|coeffp
op_assign
id|tx_hi_q
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|fp
op_increment
comma
id|coeffp
op_increment
)paren
id|sum1
op_add_assign
(paren
op_star
id|coeffp
)paren
op_star
(paren
op_star
id|fp
)paren
suffix:semicolon
id|sum1
op_rshift_assign
l_int|7
suffix:semicolon
id|sum2
op_sub_assign
id|sum1
op_star
id|sum1
suffix:semicolon
id|sm-&gt;modem.dcd_shreg
op_lshift_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
l_int|0x2000
suffix:semicolon
id|newsample
op_assign
(paren
id|sum2
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.last_sample
op_xor
id|newsample
)paren
(brace
id|sm-&gt;modem.last_sample
op_assign
id|newsample
suffix:semicolon
id|sm-&gt;modem.dcd_shreg
op_or_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
id|pll_corr
(braket
id|sm-&gt;modem.bit_pll
OL
l_int|0x9000
)braket
suffix:semicolon
id|j
op_assign
l_int|4
op_star
id|hweight8
c_func
(paren
id|sm-&gt;modem.dcd_shreg
op_amp
l_int|0x38
)paren
op_minus
id|hweight16
c_func
(paren
id|sm-&gt;modem.dcd_shreg
op_amp
l_int|0x7c0
)paren
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_add_assign
id|j
suffix:semicolon
)brace
id|hdlcdrv_channelbit
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
id|sm-&gt;modem.last_sample
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|sm-&gt;modem.dcd_time
)paren
op_le
l_int|0
)paren
(brace
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
(paren
id|sm-&gt;modem.dcd_sum0
op_plus
id|sm-&gt;modem.dcd_sum1
op_plus
id|sm-&gt;modem.dcd_sum2
)paren
OL
l_int|0
)paren
suffix:semicolon
id|sm-&gt;modem.dcd_sum2
op_assign
id|sm-&gt;modem.dcd_sum1
suffix:semicolon
id|sm-&gt;modem.dcd_sum1
op_assign
id|sm-&gt;modem.dcd_sum0
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* slight bias */
id|sm-&gt;modem.dcd_time
op_assign
l_int|120
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;modem.bit_pll
op_ge
l_int|0x10000
)paren
(brace
id|sm-&gt;modem.bit_pll
op_and_assign
l_int|0xffff
suffix:semicolon
id|sm-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.shreg
op_or_assign
(paren
op_logical_neg
(paren
id|sm-&gt;modem.last_rxbit
op_xor
id|sm-&gt;modem.last_sample
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|sm-&gt;modem.last_rxbit
op_assign
id|sm-&gt;modem.last_sample
suffix:semicolon
id|diag_trigger
c_func
(paren
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.shreg
op_amp
l_int|1
)paren
(brace
id|hdlcdrv_putbits
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
id|sm-&gt;modem.shreg
op_rshift
l_int|1
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_assign
l_int|0x10000
suffix:semicolon
)brace
)brace
id|diag_add
c_func
(paren
id|sm
comma
id|sm-&gt;modem.filt
(braket
l_int|7
)braket
op_lshift
l_int|8
comma
id|sum2
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* ENABLE_AFSK1200 */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== modem routines 9600 baud =========================&n; */
macro_line|#ifdef ENABLE_FSK9600
DECL|macro|DESCRAM_TAP1
mdefine_line|#define DESCRAM_TAP1 0x20000
DECL|macro|DESCRAM_TAP2
mdefine_line|#define DESCRAM_TAP2 0x01000
DECL|macro|DESCRAM_TAP3
mdefine_line|#define DESCRAM_TAP3 0x00001
DECL|macro|DESCRAM_TAPSH1
mdefine_line|#define DESCRAM_TAPSH1 17
DECL|macro|DESCRAM_TAPSH2
mdefine_line|#define DESCRAM_TAPSH2 12
DECL|macro|DESCRAM_TAPSH3
mdefine_line|#define DESCRAM_TAPSH3 0
DECL|macro|SCRAM_TAP1
mdefine_line|#define SCRAM_TAP1 0x20000 /* X^17 */
DECL|macro|SCRAM_TAPN
mdefine_line|#define SCRAM_TAPN 0x00021 /* X^0+X^5 */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef ENABLE_SBC
DECL|function|modulator_9600_4
r_static
r_void
id|modulator_9600_4
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_int
id|j
suffix:semicolon
r_const
r_int
r_char
op_star
id|cp
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|buflen
op_ge
l_int|4
suffix:semicolon
id|buflen
op_sub_assign
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;modem.shreg
op_le
l_int|1
)paren
id|sm-&gt;modem.shreg
op_assign
id|hdlcdrv_getbits
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
op_or
l_int|0x10000
suffix:semicolon
id|sm-&gt;modem.scram
op_assign
(paren
(paren
id|sm-&gt;modem.scram
op_lshift
l_int|1
)paren
op_or
(paren
id|sm-&gt;modem.scram
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|sm-&gt;modem.scram
op_xor_assign
(paren
op_logical_neg
(paren
id|sm-&gt;modem.shreg
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.scram
op_amp
(paren
id|SCRAM_TAP1
op_lshift
l_int|1
)paren
)paren
id|sm-&gt;modem.scram
op_xor_assign
(paren
id|SCRAM_TAPN
op_lshift
l_int|1
)paren
suffix:semicolon
id|sm-&gt;modem.tx_bit
op_assign
(paren
id|sm-&gt;modem.tx_bit
op_lshift
l_int|1
)paren
op_or
(paren
op_logical_neg
op_logical_neg
(paren
id|sm-&gt;modem.scram
op_amp
(paren
id|SCRAM_TAP1
op_lshift
l_int|2
)paren
)paren
)paren
suffix:semicolon
id|cp
op_assign
id|tx_filter_9k6_4
op_plus
(paren
id|sm-&gt;modem.tx_bit
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|buf
op_increment
op_assign
op_star
id|cp
suffix:semicolon
id|cp
op_add_assign
l_int|0x100
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|demodulator_9600_4
r_static
r_void
id|demodulator_9600_4
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_static
r_const
r_int
id|pll_corr
(braket
l_int|2
)braket
op_assign
(brace
op_minus
l_int|0x1000
comma
l_int|0x1000
)brace
suffix:semicolon
r_int
r_char
id|curbit
suffix:semicolon
r_int
r_int
id|descx
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|buflen
OG
l_int|0
suffix:semicolon
id|buflen
op_decrement
comma
id|buf
op_increment
)paren
(brace
id|sm-&gt;modem.dcd_shreg
op_lshift_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
l_int|0x4000
suffix:semicolon
id|curbit
op_assign
(paren
op_star
id|buf
op_ge
l_int|0x80
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.last_sample
op_xor
id|curbit
)paren
(brace
id|sm-&gt;modem.dcd_shreg
op_or_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
id|pll_corr
(braket
id|sm-&gt;modem.bit_pll
OL
l_int|0xa000
)braket
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_add_assign
l_int|8
op_star
id|hweight8
c_func
(paren
id|sm-&gt;modem.dcd_shreg
op_amp
l_int|0x0c
)paren
op_minus
op_logical_neg
op_logical_neg
(paren
id|sm-&gt;modem.dcd_shreg
op_amp
l_int|0x10
)paren
suffix:semicolon
)brace
id|sm-&gt;modem.last_sample
op_assign
id|curbit
suffix:semicolon
id|hdlcdrv_channelbit
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
id|sm-&gt;modem.last_sample
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|sm-&gt;modem.dcd_time
)paren
op_le
l_int|0
)paren
(brace
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
(paren
id|sm-&gt;modem.dcd_sum0
op_plus
id|sm-&gt;modem.dcd_sum1
op_plus
id|sm-&gt;modem.dcd_sum2
)paren
OL
l_int|0
)paren
suffix:semicolon
id|sm-&gt;modem.dcd_sum2
op_assign
id|sm-&gt;modem.dcd_sum1
suffix:semicolon
id|sm-&gt;modem.dcd_sum1
op_assign
id|sm-&gt;modem.dcd_sum0
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* slight bias */
id|sm-&gt;modem.dcd_time
op_assign
l_int|240
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;modem.bit_pll
op_ge
l_int|0x10000
)paren
(brace
id|sm-&gt;modem.bit_pll
op_and_assign
l_int|0xffff
suffix:semicolon
id|sm-&gt;modem.descram
op_assign
(paren
id|sm-&gt;modem.descram
op_lshift
l_int|1
)paren
op_or
id|curbit
suffix:semicolon
id|descx
op_assign
id|sm-&gt;modem.descram
op_xor
(paren
id|sm-&gt;modem.descram
op_rshift
l_int|1
)paren
suffix:semicolon
id|descx
op_xor_assign
(paren
(paren
id|descx
op_rshift
id|DESCRAM_TAPSH1
)paren
op_xor
(paren
id|descx
op_rshift
id|DESCRAM_TAPSH2
)paren
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.shreg
op_or_assign
(paren
op_logical_neg
(paren
id|descx
op_amp
l_int|1
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.shreg
op_amp
l_int|1
)paren
(brace
id|hdlcdrv_putbits
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
id|sm-&gt;modem.shreg
op_rshift
l_int|1
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_assign
l_int|0x10000
suffix:semicolon
)brace
id|diag_trigger
c_func
(paren
id|sm
)paren
suffix:semicolon
)brace
id|diag_add_one
c_func
(paren
id|sm
comma
(paren
(paren
r_int
)paren
(paren
op_star
id|buf
op_minus
l_int|0x80
)paren
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* ENABLE_SBC */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#if defined(ENABLE_WSS) || defined(ENABLE_WSSFDX)
DECL|function|modulator_9600_5
r_static
r_void
id|modulator_9600_5
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_int
id|j
suffix:semicolon
r_const
r_int
r_char
op_star
id|cp
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|buflen
op_ge
l_int|5
suffix:semicolon
id|buflen
op_sub_assign
l_int|5
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;modem.shreg
op_le
l_int|1
)paren
id|sm-&gt;modem.shreg
op_assign
id|hdlcdrv_getbits
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
op_or
l_int|0x10000
suffix:semicolon
id|sm-&gt;modem.scram
op_assign
(paren
(paren
id|sm-&gt;modem.scram
op_lshift
l_int|1
)paren
op_or
(paren
id|sm-&gt;modem.scram
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|sm-&gt;modem.scram
op_xor_assign
(paren
op_logical_neg
(paren
id|sm-&gt;modem.shreg
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.scram
op_amp
(paren
id|SCRAM_TAP1
op_lshift
l_int|1
)paren
)paren
id|sm-&gt;modem.scram
op_xor_assign
(paren
id|SCRAM_TAPN
op_lshift
l_int|1
)paren
suffix:semicolon
id|sm-&gt;modem.tx_bit
op_assign
(paren
id|sm-&gt;modem.tx_bit
op_lshift
l_int|1
)paren
op_or
(paren
op_logical_neg
op_logical_neg
(paren
id|sm-&gt;modem.scram
op_amp
(paren
id|SCRAM_TAP1
op_lshift
l_int|2
)paren
)paren
)paren
suffix:semicolon
id|cp
op_assign
id|tx_filter_9k6_5
op_plus
(paren
id|sm-&gt;modem.tx_bit
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|5
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|buf
op_increment
op_assign
op_star
id|cp
suffix:semicolon
id|cp
op_add_assign
l_int|0x100
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|demodulator_9600_5
r_static
r_void
id|demodulator_9600_5
c_func
(paren
r_struct
id|sm_state
op_star
id|sm
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_static
r_const
r_int
id|pll_corr
(braket
l_int|2
)braket
op_assign
(brace
op_minus
l_int|0x1000
comma
l_int|0x1000
)brace
suffix:semicolon
r_int
r_char
id|curbit
suffix:semicolon
r_int
r_int
id|descx
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|buflen
OG
l_int|0
suffix:semicolon
id|buflen
op_decrement
comma
id|buf
op_increment
)paren
(brace
id|sm-&gt;modem.dcd_shreg
op_lshift_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
l_int|0x3333
suffix:semicolon
id|curbit
op_assign
(paren
op_star
id|buf
op_ge
l_int|0x80
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.last_sample
op_xor
id|curbit
)paren
(brace
id|sm-&gt;modem.dcd_shreg
op_or_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_add_assign
id|pll_corr
(braket
id|sm-&gt;modem.bit_pll
OL
l_int|0x9999
)braket
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_add_assign
l_int|16
op_star
id|hweight8
c_func
(paren
id|sm-&gt;modem.dcd_shreg
op_amp
l_int|0x0c
)paren
op_minus
id|hweight8
c_func
(paren
id|sm-&gt;modem.dcd_shreg
op_amp
l_int|0x70
)paren
suffix:semicolon
)brace
id|sm-&gt;modem.last_sample
op_assign
id|curbit
suffix:semicolon
id|hdlcdrv_channelbit
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
id|sm-&gt;modem.last_sample
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|sm-&gt;modem.dcd_time
)paren
op_le
l_int|0
)paren
(brace
id|hdlcdrv_setdcd
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
(paren
id|sm-&gt;modem.dcd_sum0
op_plus
id|sm-&gt;modem.dcd_sum1
op_plus
id|sm-&gt;modem.dcd_sum2
)paren
OL
l_int|0
)paren
suffix:semicolon
id|sm-&gt;modem.dcd_sum2
op_assign
id|sm-&gt;modem.dcd_sum1
suffix:semicolon
id|sm-&gt;modem.dcd_sum1
op_assign
id|sm-&gt;modem.dcd_sum0
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* slight bias */
id|sm-&gt;modem.dcd_time
op_assign
l_int|240
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;modem.bit_pll
op_ge
l_int|0x10000
)paren
(brace
id|sm-&gt;modem.bit_pll
op_and_assign
l_int|0xffff
suffix:semicolon
id|sm-&gt;modem.descram
op_assign
(paren
id|sm-&gt;modem.descram
op_lshift
l_int|1
)paren
op_or
id|curbit
suffix:semicolon
id|descx
op_assign
id|sm-&gt;modem.descram
op_xor
(paren
id|sm-&gt;modem.descram
op_rshift
l_int|1
)paren
suffix:semicolon
id|descx
op_xor_assign
(paren
(paren
id|descx
op_rshift
id|DESCRAM_TAPSH1
)paren
op_xor
(paren
id|descx
op_rshift
id|DESCRAM_TAPSH2
)paren
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_rshift_assign
l_int|1
suffix:semicolon
id|sm-&gt;modem.shreg
op_or_assign
(paren
op_logical_neg
(paren
id|descx
op_amp
l_int|1
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.shreg
op_amp
l_int|1
)paren
(brace
id|hdlcdrv_putbits
c_func
(paren
op_amp
id|sm-&gt;hdrv
comma
id|sm-&gt;modem.shreg
op_rshift
l_int|1
)paren
suffix:semicolon
id|sm-&gt;modem.shreg
op_assign
l_int|0x10000
suffix:semicolon
)brace
id|diag_trigger
c_func
(paren
id|sm
)paren
suffix:semicolon
)brace
id|diag_add_one
c_func
(paren
id|sm
comma
(paren
(paren
r_int
)paren
(paren
op_star
id|buf
op_minus
l_int|0x80
)paren
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* defined(ENABLE_WSS) || defined(ENABLE_WSSFDX) */
macro_line|#endif /* ENABLE_FSK9600 */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== soundblaster specific routines ===================&n; */
macro_line|#ifdef ENABLE_SBC
DECL|function|reset_dsp
r_static
r_int
r_inline
id|reset_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|DSP_RESET
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x100
suffix:semicolon
id|i
op_increment
)paren
id|SLOW_DOWN_IO
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|DSP_RESET
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_READ_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_eq
l_int|0xaa
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|write_dsp
r_static
r_void
r_inline
id|write_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|DSP_WRITE_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|outb
c_func
(paren
id|data
comma
id|DSP_WRITE_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|read_dsp
r_static
r_int
r_inline
id|read_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
(brace
op_star
id|data
op_assign
id|inb
c_func
(paren
id|DSP_READ_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_int_ack
r_static
r_void
r_inline
id|sbc_int_ack
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|setup_dma_dsp
r_static
r_void
id|setup_dma_dsp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|send
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbcmode
(braket
l_int|2
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|SBC_LO_INPUT_AUTOINIT
comma
id|SBC_LO_OUTPUT_AUTOINIT
)brace
comma
(brace
id|SBC_HI_INPUT_AUTOINIT
comma
id|SBC_HI_OUTPUT_AUTOINIT
)brace
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|dmamode
(braket
l_int|2
)braket
op_assign
(brace
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|sbcskr
(braket
l_int|2
)braket
op_assign
(brace
id|SBC_SPEAKER_OFF
comma
id|SBC_SPEAKER_ON
)brace
suffix:semicolon
r_int
r_int
id|dmabufaddr
op_assign
id|virt_to_bus
c_func
(paren
id|sm-&gt;modem.dmabufr
)paren
suffix:semicolon
id|send
op_assign
op_logical_neg
op_logical_neg
id|send
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: cannot reset sb dsp&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dmabufaddr
op_amp
l_int|0xffff
)paren
op_plus
id|mi-&gt;dmabuflen
OG
l_int|0x10000
)paren
id|panic
c_func
(paren
l_string|&quot;sm: DMA buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sbc_int_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_SAMPLE_RATE
)paren
suffix:semicolon
multiline_comment|/* set sampling rate */
id|write_dsp
c_func
(paren
id|dev
comma
id|mi-&gt;data_fmt
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|sbcskr
(braket
id|send
)braket
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|dmamode
(braket
id|send
)braket
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sbc_int_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_HISPEED
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
(paren
(paren
id|mi-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
(paren
(paren
id|mi-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|sbcmode
(braket
id|mi-&gt;samplerate
op_ge
l_int|13000
)braket
(braket
id|send
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#if 0
r_static
r_int
id|probe_int
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sm_state
op_star
id|sm
)paren
(brace
r_int
r_int
id|irqs
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
id|virt_to_bus
c_func
(paren
id|sm-&gt;modem.dmabufr
)paren
comma
l_int|4
comma
l_int|256
op_minus
l_int|77
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_interrupt
r_static
r_void
id|sbc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_char
id|new_ptt
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|new_ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|sbc_int_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
id|buf
op_assign
id|sm-&gt;modem.dmabufr
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.dmabufidx
)paren
id|buf
op_add_assign
id|mi-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
id|sm-&gt;modem.dmabufidx
op_assign
op_logical_neg
id|sm-&gt;modem.dmabufidx
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.oldptt
op_ne
id|new_ptt
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sm-&gt;modem.dmabufidx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_ptt
)paren
(brace
id|setup_dma_dsp
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|endint
suffix:semicolon
)brace
id|mi
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|sm-&gt;modem.dmabufr
op_plus
id|mi-&gt;dmabuflen
op_div
l_int|2
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
r_goto
id|endint
suffix:semicolon
)brace
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check if transmitter active&n;&t; */
r_if
c_cond
(paren
id|new_ptt
)paren
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|buf
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
r_else
(brace
id|mi
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
id|endint
suffix:colon
id|sm-&gt;modem.oldptt
op_assign
id|new_ptt
suffix:semicolon
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_open
r_static
r_int
id|sbc_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_char
id|revreq
op_assign
(paren
id|mi-&gt;samplerate
op_ge
l_int|13000
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|SBC_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|write_dsp
c_func
(paren
id|dev
comma
id|SBC_GET_REVISION
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;modem.revhi
)paren
op_logical_or
op_logical_neg
id|read_dsp
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;modem.revlo
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.revhi
OL
id|revreq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: sbc io 0x%lx: DSP rev %d.%02d too &quot;
l_string|&quot;old, at least %d.00 required&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|sm-&gt;modem.revhi
comma
id|sm-&gt;modem.revlo
comma
id|revreq
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;modem.dmabufr
op_assign
id|kmalloc
c_func
(paren
id|mi-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sm-&gt;modem.shreg
op_assign
id|sm-&gt;modem.last_sample
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_assign
id|sm-&gt;modem.dcd_shreg
op_assign
id|sm-&gt;modem.dcd_sum1
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dcd_sum2
op_assign
id|sm-&gt;modem.last_rxbit
op_assign
id|sm-&gt;modem.tx_bit
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dmabufidx
op_assign
id|sm-&gt;modem.oldptt
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dmabufw
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;modem.dcd_time
op_assign
l_int|120
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_assign
l_int|2
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
r_int
id|irq
op_assign
id|probe_int
c_func
(paren
id|dev
comma
id|sm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: irq autoprobe failed&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;mode_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|sbc_interrupt
comma
id|SA_INTERRUPT
comma
id|mi-&gt;mode_name
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
comma
id|mi-&gt;mode_name
)paren
suffix:semicolon
id|setup_dma_dsp
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|output_open
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: sbc at iobase 0x%lx irq %u dma &quot;
l_string|&quot;%u DSP revision %u.%02u&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
comma
(paren
r_int
r_int
)paren
id|sm-&gt;modem.revhi
comma
(paren
r_int
r_int
)paren
id|sm-&gt;modem.revlo
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sbc_close
r_static
r_int
id|sbc_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|reset_dsp
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|SBC_EXTENT
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;modem.dmabufr
)paren
suffix:semicolon
id|output_close
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: close sbc at iobase 0x%lx irq %u dma %u&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* ENABLE_SBC */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== Windows Sound System specific routines ==========&n; */
macro_line|#if defined(ENABLE_WSS) || defined(ENABLE_WSSFDX)
DECL|function|write_codec
r_static
r_void
id|write_codec
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|idx
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
multiline_comment|/* wait until codec ready */
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
id|outb
c_func
(paren
id|idx
comma
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
comma
id|WSS_CODEC_ID
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|read_codec
r_static
r_int
r_char
id|read_codec
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|idx
)paren
(brace
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
multiline_comment|/* wait until codec ready */
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
id|outb
c_func
(paren
id|idx
op_amp
l_int|0xf
comma
id|WSS_CODEC_IA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|WSS_CODEC_ID
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_ack_int
r_static
r_void
r_inline
id|wss_ack_int
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|WSS_CODEC_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_init_codec
r_static
r_int
id|wss_init_codec
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_char
id|sdc
comma
r_int
r_char
id|src_l
comma
r_int
r_char
id|src_r
comma
r_int
id|igain_l
comma
r_int
id|igain_r
comma
r_int
id|ogain_l
comma
r_int
id|ogain_r
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_char
id|tmp
comma
id|reg0
comma
id|reg1
comma
id|reg6
comma
id|reg7
suffix:semicolon
r_static
r_const
r_int
r_char
id|irqtab
(braket
l_int|16
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x10
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|dmatab
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
op_minus
l_int|1
comma
l_int|3
)brace
suffix:semicolon
r_int
r_int
id|time
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|WSS_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x0f
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: WSS card not found, address 0x%lx, ID &quot;
l_string|&quot;register 0x%02x&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
(paren
r_int
)paren
id|tmp
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x80
)paren
op_logical_and
(paren
(paren
id|dev-&gt;dma
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|dev-&gt;irq
op_ge
l_int|8
)paren
op_logical_and
(paren
id|dev-&gt;irq
op_ne
l_int|9
)paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: WSS: DMA0 and/or IRQ8..IRQ15 (except &quot;
l_string|&quot;IRQ9) cannot be used on an 8bit card&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
OG
l_int|15
op_logical_or
id|irqtab
(braket
id|dev-&gt;irq
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: WSS: invalid interrupt %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;dma
OG
l_int|3
op_logical_or
id|dmatab
(braket
id|dev-&gt;dma
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: WSS: invalid dma channel %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|tmp
op_assign
id|irqtab
(braket
id|dev-&gt;irq
)braket
op_or
id|dmatab
(braket
id|dev-&gt;dma
)braket
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
l_int|0x38
)paren
op_or
l_int|0x40
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* irq probe */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|WSS_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x40
)paren
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: WSS: IRQ%d is not free!&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|tmp
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * initialize the codec&n;&t; */
r_if
c_cond
(paren
id|igain_l
OL
l_int|0
)paren
id|igain_l
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|igain_r
OL
l_int|0
)paren
id|igain_r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ogain_l
OG
l_int|0
)paren
id|ogain_l
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ogain_r
OG
l_int|0
)paren
id|ogain_r
op_assign
l_int|0
suffix:semicolon
id|reg0
op_assign
(paren
id|src_l
op_lshift
l_int|6
)paren
op_amp
l_int|0xc0
suffix:semicolon
id|reg1
op_assign
(paren
id|src_r
op_lshift
l_int|6
)paren
op_amp
l_int|0xc0
suffix:semicolon
r_if
c_cond
(paren
id|reg0
op_eq
l_int|0x80
op_logical_and
id|igain_l
op_ge
l_int|20
)paren
(brace
id|reg0
op_or_assign
l_int|0x20
suffix:semicolon
id|igain_l
op_sub_assign
l_int|20
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg1
op_eq
l_int|0x80
op_logical_and
id|igain_r
op_ge
l_int|20
)paren
(brace
id|reg1
op_or_assign
l_int|0x20
suffix:semicolon
id|igain_r
op_sub_assign
l_int|20
suffix:semicolon
)brace
r_if
c_cond
(paren
id|igain_l
OG
l_int|23
)paren
id|igain_l
op_assign
l_int|23
suffix:semicolon
r_if
c_cond
(paren
id|igain_r
OG
l_int|23
)paren
id|igain_r
op_assign
l_int|23
suffix:semicolon
id|reg0
op_or_assign
id|igain_l
op_star
l_int|2
op_div
l_int|3
suffix:semicolon
id|reg1
op_or_assign
id|igain_r
op_star
l_int|2
op_div
l_int|3
suffix:semicolon
id|reg6
op_assign
(paren
id|ogain_l
OL
op_minus
l_int|95
)paren
ques
c_cond
l_int|0x80
suffix:colon
(paren
id|ogain_l
op_star
(paren
op_minus
l_int|2
)paren
op_div
l_int|3
)paren
suffix:semicolon
id|reg7
op_assign
(paren
id|ogain_r
OL
op_minus
l_int|95
)paren
ques
c_cond
l_int|0x80
suffix:colon
(paren
id|ogain_r
op_star
(paren
op_minus
l_int|2
)paren
op_div
l_int|3
)paren
suffix:semicolon
macro_line|#if 1
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
l_int|0xaa
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
l_int|0x55
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|15
)paren
op_ne
l_int|0xaa
)paren
op_logical_or
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|14
)paren
op_ne
l_int|0x55
)paren
)paren
r_goto
id|codec_err
suffix:semicolon
macro_line|#endif
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x48
comma
id|mi-&gt;data_fmt
)paren
suffix:semicolon
multiline_comment|/* Clock and data format register */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0x49
comma
id|sdc
ques
c_cond
l_int|0xc
suffix:colon
l_int|0x8
)paren
suffix:semicolon
multiline_comment|/* MCE and interface config reg */
multiline_comment|/* single DMA channel, disable both DMA */
multiline_comment|/* clear MCE and wait until ACI set */
id|time
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|4
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x0b
)paren
op_amp
l_int|0x20
)paren
op_logical_and
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|time
)paren
OL
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* wait until ACI cleared */
r_while
c_loop
(paren
(paren
id|read_codec
c_func
(paren
id|dev
comma
l_int|0x0b
)paren
op_amp
l_int|0x20
)paren
op_logical_and
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|time
)paren
OL
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|time
)paren
op_ge
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sm: ad1848 auto calibration timed out&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|codec_err
suffix:semicolon
)brace
id|write_codec
c_func
(paren
id|dev
comma
l_int|0
comma
id|reg0
)paren
suffix:semicolon
multiline_comment|/* left input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|1
comma
id|reg1
)paren
suffix:semicolon
multiline_comment|/* right input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|2
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* left aux#1 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|3
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* right aux#1 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|4
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* left aux#2 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|5
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* right aux#2 input control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|6
comma
id|reg6
)paren
suffix:semicolon
multiline_comment|/* left dac control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|7
comma
id|reg7
)paren
suffix:semicolon
multiline_comment|/* right dac control */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0xa
comma
l_int|0x2
)paren
suffix:semicolon
multiline_comment|/* pin control register */
id|write_codec
c_func
(paren
id|dev
comma
l_int|0xd
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* digital mix control */
id|sm-&gt;modem.revhi
op_assign
id|inb
c_func
(paren
id|WSS_STATUS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|sm-&gt;modem.revlo
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|0xc
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/*&n;&t; * print revisions&n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: WSS revision %d, CODEC revision %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|sm-&gt;modem.revhi
comma
(paren
r_int
)paren
id|sm-&gt;modem.revlo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|codec_err
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|WSS_CONFIG
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: no WSS soundcard found at address 0x%lx&bslash;n&quot;
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* defined(ENABLE_WSS) || defined(ENABLE_WSSFDX) */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef ENABLE_WSS
DECL|function|setup_dma_wss
r_static
r_void
id|setup_dma_wss
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|flg
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_static
r_const
r_int
r_char
id|codecmode
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x0e
comma
l_int|0x0d
)brace
suffix:semicolon
r_static
r_const
r_int
r_char
id|dmamode
(braket
l_int|2
)braket
op_assign
(brace
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)brace
suffix:semicolon
r_int
r_char
id|oldcodecmode
comma
id|codecdma
suffix:semicolon
r_int
id|abrt
suffix:semicolon
r_int
r_int
id|dmabufaddr
op_assign
id|virt_to_bus
c_func
(paren
id|sm-&gt;modem.dmabufr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabufaddr
op_amp
l_int|0xffff
)paren
op_plus
id|mi-&gt;dmabuflen
OG
l_int|0x10000
)paren
id|panic
c_func
(paren
l_string|&quot;sm: DMA buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
id|flg
op_assign
op_logical_neg
op_logical_neg
id|flg
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * perform the final DMA sequence to disable the codec request&n;&t; */
id|oldcodecmode
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|9
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0xc
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codecdma
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
)paren
op_amp
l_int|0x10
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|dmamode
(braket
id|oldcodecmode
op_amp
l_int|1
)braket
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|abrt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|codecdma
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
)paren
op_amp
l_int|0x10
)paren
op_logical_or
(paren
(paren
op_increment
id|abrt
)paren
op_ge
l_int|0x10000
)paren
)paren
suffix:semicolon
)brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|dmamode
(braket
id|flg
)braket
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
(paren
(paren
id|mi-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
(paren
(paren
id|mi-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
id|codecmode
(braket
id|flg
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_interrupt
r_static
r_void
id|wss_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_char
id|new_ptt
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|dmares
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|new_ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dmares
op_assign
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmares
op_le
l_int|0
)paren
id|dmares
op_assign
id|mi-&gt;dmabuflen
suffix:semicolon
id|buf
op_assign
id|sm-&gt;modem.dmabufr
suffix:semicolon
r_if
c_cond
(paren
id|dmares
OG
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
id|buf
op_add_assign
id|mi-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|dmares
OG
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
id|dmares
op_sub_assign
id|mi-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
macro_line|#ifdef SM_DEBUG
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;debug_vals.last_pllcorr
op_logical_or
id|dmares
OL
id|sm-&gt;debug_vals.last_pllcorr
)paren
id|sm-&gt;debug_vals.last_pllcorr
op_assign
id|dmares
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
id|dmares
op_decrement
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
id|dmares
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
id|dmares
op_rshift
l_int|8
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;modem.oldptt
op_ne
id|new_ptt
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|sm-&gt;modem.dmabufidx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_ptt
)paren
(brace
id|setup_dma_wss
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|endint
suffix:semicolon
)brace
id|mi
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|setup_dma_wss
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|sm-&gt;modem.dmabufr
op_plus
id|mi-&gt;dmabuflen
op_div
l_int|2
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
r_goto
id|endint
suffix:semicolon
)brace
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check if transmitter active&n;&t; */
r_if
c_cond
(paren
id|new_ptt
)paren
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|buf
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
r_else
(brace
id|mi
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|buf
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
id|endint
suffix:colon
id|sm-&gt;modem.oldptt
op_assign
id|new_ptt
suffix:semicolon
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_open
r_static
r_int
id|wss_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|WSS_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
id|wss_init_codec
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|45
comma
op_minus
l_int|45
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;modem.dmabufr
op_assign
id|kmalloc
c_func
(paren
id|mi-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sm-&gt;modem.shreg
op_assign
id|sm-&gt;modem.last_sample
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_assign
id|sm-&gt;modem.dcd_shreg
op_assign
id|sm-&gt;modem.dcd_sum1
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dcd_sum2
op_assign
id|sm-&gt;modem.last_rxbit
op_assign
id|sm-&gt;modem.tx_bit
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dmabufidx
op_assign
id|sm-&gt;modem.oldptt
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dmabufw
op_assign
l_int|NULL
suffix:semicolon
id|sm-&gt;modem.dcd_time
op_assign
l_int|120
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;mode_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|wss_interrupt
comma
id|SA_INTERRUPT
comma
id|mi-&gt;mode_name
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
comma
id|mi-&gt;mode_name
)paren
suffix:semicolon
id|setup_dma_wss
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|output_open
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: wss at iobase 0x%lx irq %u dma &quot;
l_string|&quot;%u&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wss_close
r_static
r_int
id|wss_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0xc
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|output_close
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: close wss at iobase 0x%lx irq %u&quot;
l_string|&quot; dma %u&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* ENABLE_WSS */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * =========== Windows Sound System Fullduplex specific routines ==========&n; */
multiline_comment|/*&n; * This does _not_ work on my hardware&n; */
macro_line|#ifdef ENABLE_WSSFDX
DECL|function|setup_dma_wssfdx
r_static
r_void
id|setup_dma_wssfdx
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|codecdma
suffix:semicolon
r_int
id|abrt
suffix:semicolon
r_int
r_int
id|dmabufraddr
op_assign
id|virt_to_bus
c_func
(paren
id|sm-&gt;modem.dmabufr
)paren
suffix:semicolon
r_int
r_int
id|dmabufwaddr
op_assign
id|virt_to_bus
c_func
(paren
id|sm-&gt;modem.dmabufw
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|dmabufraddr
op_amp
l_int|0xffff
)paren
op_plus
id|mi-&gt;dmabuflen
OG
l_int|0x10000
)paren
op_logical_or
(paren
(paren
id|dmabufwaddr
op_amp
l_int|0xffff
)paren
op_plus
id|mi-&gt;dmabuflen
OG
l_int|0x10000
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;sm: DMA buffer violates DMA boundary!&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * perform the final DMA sequence to disable the codec request&n;&t; */
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0x8
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codecdma
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
)paren
op_amp
l_int|0x10
)paren
(brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufwaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|dmabufraddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|abrt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|codecdma
op_assign
id|read_codec
c_func
(paren
id|dev
comma
l_int|11
)paren
)paren
op_amp
l_int|0x10
)paren
op_logical_or
(paren
(paren
op_increment
id|abrt
)paren
op_ge
l_int|0x10000
)paren
)paren
suffix:semicolon
)brace
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_WRITE
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dev-&gt;dma
comma
id|dmabufwaddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|DMA_MODE_READ
op_or
id|DMA_MODE_AUTOINIT
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|dmabufraddr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
(paren
(paren
id|mi-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
(paren
(paren
id|mi-&gt;dmabuflen
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0x0b
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|msgcnt
r_static
r_int
id|msgcnt
op_assign
l_int|10
suffix:semicolon
DECL|function|wssfdx_interrupt
r_static
r_void
id|wssfdx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
(paren
r_struct
id|device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_int
r_char
id|new_ptt
suffix:semicolon
r_int
r_char
op_star
id|bufr
suffix:semicolon
r_int
r_char
op_star
id|bufw
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|dmares
comma
id|dmares2
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
op_logical_or
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
r_return
suffix:semicolon
id|new_ptt
op_assign
id|hdlcdrv_ptt
c_func
(paren
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wss_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dmares
op_assign
id|get_dma_residue
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|dmares2
op_assign
id|get_dma_residue
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmares
op_le
l_int|0
)paren
id|dmares
op_assign
id|mi-&gt;dmabuflen
suffix:semicolon
r_if
c_cond
(paren
id|dmares2
op_le
l_int|0
)paren
id|dmares2
op_assign
id|mi-&gt;dmabuflen
suffix:semicolon
id|bufw
op_assign
id|sm-&gt;modem.dmabufw
suffix:semicolon
r_if
c_cond
(paren
id|dmares
OG
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
id|bufw
op_add_assign
id|mi-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
id|bufr
op_assign
id|sm-&gt;modem.dmabufr
suffix:semicolon
r_if
c_cond
(paren
id|dmares2
OG
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
id|bufr
op_add_assign
id|mi-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|dmares
)paren
OG
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
id|i
op_sub_assign
id|mi-&gt;dmabuflen
op_div
l_int|2
suffix:semicolon
macro_line|#ifdef SM_DEBUG
r_if
c_cond
(paren
op_logical_neg
id|sm-&gt;debug_vals.last_pllcorr
op_logical_or
id|i
OL
id|sm-&gt;debug_vals.last_pllcorr
)paren
id|sm-&gt;debug_vals.last_pllcorr
op_assign
id|i
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
id|i
op_decrement
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|15
comma
id|i
op_amp
l_int|0xff
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|14
comma
id|i
op_rshift
l_int|8
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sm_int_freq
c_func
(paren
id|sm
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgcnt
OG
l_int|0
)paren
(brace
id|msgcnt
op_decrement
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sm: DMA residue: playback: %d &quot;
l_string|&quot;capture: %d&bslash;n&quot;
comma
id|dmares
comma
id|dmares2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * check if transmitter active&n;&t; */
r_if
c_cond
(paren
id|new_ptt
)paren
id|mi
op_member_access_from_pointer
id|modulator
c_func
(paren
id|sm
comma
id|bufw
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|bufw
comma
l_int|0x80
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|mi
op_member_access_from_pointer
id|demodulator
c_func
(paren
id|sm
comma
id|bufr
comma
id|mi-&gt;dmabuflen
op_div
l_int|2
)paren
suffix:semicolon
id|hdlcdrv_arbitrate
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|sm-&gt;modem.oldptt
op_assign
id|new_ptt
suffix:semicolon
id|output_status
c_func
(paren
id|sm
)paren
suffix:semicolon
id|hdlcdrv_transmitter
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
id|hdlcdrv_receiver
c_func
(paren
id|dev
comma
op_amp
id|sm-&gt;hdrv
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_open
r_static
r_int
id|wssfdx_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|modem_info
op_star
id|mi
op_assign
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_le
l_int|0
op_logical_or
id|dev-&gt;base_addr
OG
l_int|0x1000
op_minus
id|WSS_EXTENT
op_logical_or
id|dev-&gt;irq
template_param
l_int|15
op_logical_or
id|dev-&gt;dma
OG
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t; * check if a card is available&n;&t; */
r_if
c_cond
(paren
id|wss_init_codec
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|45
comma
op_minus
l_int|45
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * initialize some variables&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;modem.dmabufr
op_assign
id|kmalloc
c_func
(paren
id|mi-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sm-&gt;modem.dmabufw
op_assign
id|kmalloc
c_func
(paren
id|mi-&gt;dmabuflen
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sm-&gt;modem.shreg
op_assign
id|sm-&gt;modem.last_sample
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.bit_pll
op_assign
id|sm-&gt;modem.dcd_shreg
op_assign
id|sm-&gt;modem.dcd_sum1
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dcd_sum2
op_assign
id|sm-&gt;modem.last_rxbit
op_assign
id|sm-&gt;modem.tx_bit
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dmabufidx
op_assign
id|sm-&gt;modem.oldptt
op_assign
l_int|0
suffix:semicolon
id|sm-&gt;modem.dcd_time
op_assign
l_int|120
suffix:semicolon
id|sm-&gt;modem.dcd_sum0
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
id|mi-&gt;mode_name
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufw
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
comma
id|mi-&gt;mode_name
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufw
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|wssfdx_interrupt
comma
id|SA_INTERRUPT
comma
id|mi-&gt;mode_name
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufr
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|sm-&gt;modem.dmabufw
comma
id|mi-&gt;dmabuflen
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
comma
id|mi-&gt;mode_name
)paren
suffix:semicolon
id|setup_dma_wssfdx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|output_open
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: wss fdx at iobase 0x%lx irq %u dma1 &quot;
l_string|&quot;%u dma2 %u&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
comma
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|wssfdx_close
r_static
r_int
id|wssfdx_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|sm
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupts&n;&t; */
id|disable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
l_int|9
comma
l_int|0x8
)paren
suffix:semicolon
multiline_comment|/* disable codec */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
op_logical_neg
id|dev-&gt;dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
id|WSS_EXTENT
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;modem.dmabufr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sm-&gt;modem.dmabufw
)paren
suffix:semicolon
id|output_close
c_func
(paren
id|sm
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: close wss fdx at iobase 0x%lx irq %u&quot;
l_string|&quot; dma %u&bslash;n&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* ENABLE_WSSFDX */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== hdlcdrv driver interface =========================&n; */
r_static
r_int
id|sm_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
DECL|macro|SBC1200_SRATE
mdefine_line|#define SBC1200_SRATE (256-104) /* the SBC sampling rate, 256-(1E6/srate) */
DECL|macro|SBC1200_DMABUFLEN
mdefine_line|#define SBC1200_DMABUFLEN 192   /* DMA buffer duration exactly 20ms */
DECL|macro|SBC9600_SRATE
mdefine_line|#define SBC9600_SRATE (256-26) /* the SBC sampling rate, 256-(1E6/srate) */
DECL|macro|SBC9600_DMABUFLEN
mdefine_line|#define SBC9600_DMABUFLEN 768    /* DMA buffer duration exactly 20ms */
DECL|macro|WSS1200_DATAFMT
mdefine_line|#define WSS1200_DATAFMT 0x0e   /* 8bit unsigned PCM, Mono, XTAL1, 9.6kHz */
DECL|macro|WSS1200_DMABUFLEN
mdefine_line|#define WSS1200_DMABUFLEN 192        /* DMA buffer duration exactly 20ms */
DECL|macro|WSS9600_DATAFMT
mdefine_line|#define WSS9600_DATAFMT 0x0c    /* 8bit unsigned PCM, Mono, XTAL1, 48kHz */
DECL|macro|WSS9600_DMABUFLEN
mdefine_line|#define WSS9600_DMABUFLEN 960        /* DMA buffer duration exactly 20ms */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef ENABLE_SBC
DECL|variable|sbc1200_ops
r_static
r_const
r_struct
id|modem_info
id|sbc1200_ops
op_assign
(brace
(brace
l_int|1200
comma
id|sbc_open
comma
id|sbc_close
comma
id|sm_ioctl
)brace
comma
l_int|9600
comma
l_int|1
comma
l_int|8
comma
l_string|&quot;sbc_1200&quot;
comma
id|SBC1200_SRATE
comma
id|SBC1200_DMABUFLEN
comma
id|modulator_1200
comma
id|demodulator_1200
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|sbc9600_ops
r_static
r_const
r_struct
id|modem_info
id|sbc9600_ops
op_assign
(brace
(brace
l_int|9600
comma
id|sbc_open
comma
id|sbc_close
comma
id|sm_ioctl
)brace
comma
l_int|38400
comma
l_int|1
comma
l_int|4
comma
l_string|&quot;sbc_9600&quot;
comma
id|SBC9600_SRATE
comma
id|SBC9600_DMABUFLEN
comma
id|modulator_9600_4
comma
id|demodulator_9600_4
)brace
suffix:semicolon
macro_line|#endif /* ENABLE_SBC */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef ENABLE_WSS
DECL|variable|wss1200_ops
r_static
r_const
r_struct
id|modem_info
id|wss1200_ops
op_assign
(brace
(brace
l_int|1200
comma
id|wss_open
comma
id|wss_close
comma
id|sm_ioctl
)brace
comma
l_int|9600
comma
l_int|0
comma
l_int|8
comma
l_string|&quot;wss_1200&quot;
comma
id|WSS1200_DATAFMT
comma
id|WSS1200_DMABUFLEN
comma
id|modulator_1200
comma
id|demodulator_1200
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|wss9600_ops
r_static
r_const
r_struct
id|modem_info
id|wss9600_ops
op_assign
(brace
(brace
l_int|9600
comma
id|wss_open
comma
id|wss_close
comma
id|sm_ioctl
)brace
comma
l_int|48000
comma
l_int|0
comma
l_int|5
comma
l_string|&quot;wss_9600&quot;
comma
id|WSS9600_DATAFMT
comma
id|WSS9600_DMABUFLEN
comma
id|modulator_9600_5
comma
id|demodulator_9600_5
)brace
suffix:semicolon
macro_line|#endif /* ENABLE_WSS */
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef ENABLE_WSSFDX
DECL|variable|wss1200fdx_ops
r_static
r_const
r_struct
id|modem_info
id|wss1200fdx_ops
op_assign
(brace
(brace
l_int|1200
comma
id|wssfdx_open
comma
id|wssfdx_close
comma
id|sm_ioctl
)brace
comma
l_int|9600
comma
l_int|0
comma
l_int|8
comma
l_string|&quot;wss_fdx_1200&quot;
comma
id|WSS1200_DATAFMT
comma
id|WSS1200_DMABUFLEN
comma
id|modulator_1200
comma
id|demodulator_1200
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|wss9600fdx_ops
r_static
r_const
r_struct
id|modem_info
id|wss9600fdx_ops
op_assign
(brace
(brace
l_int|9600
comma
id|wssfdx_open
comma
id|wssfdx_close
comma
id|sm_ioctl
)brace
comma
l_int|48000
comma
l_int|0
comma
l_int|5
comma
l_string|&quot;wss_fdx_9600&quot;
comma
id|WSS9600_DATAFMT
comma
id|WSS9600_DMABUFLEN
comma
id|modulator_9600_5
comma
id|demodulator_9600_5
)brace
suffix:semicolon
macro_line|#endif /* ENABLE_WSSFDX */
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|dummy_ops
r_static
r_const
r_struct
id|modem_info
id|dummy_ops
op_assign
(brace
(brace
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
id|sm_ioctl
)brace
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;none&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|ops_tab
r_static
r_const
r_struct
id|modem_info
op_star
id|ops_tab
(braket
l_int|3
)braket
(braket
l_int|2
)braket
op_assign
(brace
macro_line|#ifdef ENABLE_SBC
(brace
op_amp
id|sbc1200_ops
comma
op_amp
id|sbc9600_ops
)brace
comma
macro_line|#else /* ENABLE_SBC */
(brace
op_amp
id|dummy_ops
comma
op_amp
id|dummy_ops
)brace
comma
macro_line|#endif /* ENABLE_SBC */
macro_line|#ifdef ENABLE_WSS
(brace
op_amp
id|wss1200_ops
comma
op_amp
id|wss9600_ops
)brace
comma
macro_line|#else /* ENABLE_WSS */
(brace
op_amp
id|dummy_ops
comma
op_amp
id|dummy_ops
)brace
comma
macro_line|#endif /* ENABLE_WSS */
macro_line|#ifdef ENABLE_WSSFDX
(brace
op_amp
id|wss1200fdx_ops
comma
op_amp
id|wss9600fdx_ops
)brace
macro_line|#else /* ENABLE_WSSFDX */
(brace
op_amp
id|dummy_ops
comma
op_amp
id|dummy_ops
)brace
macro_line|#endif /* ENABLE_WSSFDX */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|sm_ioctl
r_static
r_int
id|sm_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
suffix:semicolon
r_struct
id|sm_ioctl
id|bi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|newdiagmode
suffix:semicolon
r_int
r_int
id|newdiagflags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;priv
op_logical_or
(paren
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm_ioctl: invalid device struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCDEVPRIVATE
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bi
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|bi.cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|SMCTL_GETMODEMTYPE
suffix:colon
id|bi.data.cfg.hardware
op_assign
id|sm-&gt;config.hardware
suffix:semicolon
id|bi.data.cfg.mode
op_assign
id|sm-&gt;config.mode
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMCTL_SETMODEMTYPE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
op_logical_or
id|dev-&gt;start
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|bi.data.cfg.hardware
template_param
id|SM_HARDWARE_WSSFDX
op_logical_or
id|bi.data.cfg.mode
template_param
id|SM_MODE_FSK9600
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sm-&gt;config.hardware
op_assign
id|bi.data.cfg.hardware
suffix:semicolon
id|sm-&gt;config.mode
op_assign
id|bi.data.cfg.mode
suffix:semicolon
r_if
c_cond
(paren
id|bi.data.cfg.hardware
op_eq
id|SM_HARDWARE_INVALID
op_logical_or
id|bi.data.cfg.mode
op_eq
id|SM_MODE_INVALID
)paren
id|sm-&gt;hdrv.ops
op_assign
op_amp
id|dummy_ops.hops
suffix:semicolon
r_else
(brace
id|sm-&gt;hdrv.ops
op_assign
op_amp
id|ops_tab
(braket
id|sm-&gt;config.hardware
)braket
(braket
id|sm-&gt;config.mode
)braket
op_member_access_from_pointer
id|hops
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
)paren
op_member_access_from_pointer
id|samplerate
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef SM_DEBUG
r_case
id|SMCTL_GETDEBUG
suffix:colon
id|bi.data.dbg.debug1
op_assign
id|sm-&gt;hdrv.ptt_keyed
suffix:semicolon
id|bi.data.dbg.debug2
op_assign
id|sm-&gt;debug_vals.last_intcnt
suffix:semicolon
id|bi.data.dbg.debug3
op_assign
id|sm-&gt;debug_vals.last_pllcorr
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* SM_DEBUG */
r_case
id|SMCTL_GETMIXER
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|bi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|bi.data.mix.sample_rate
op_assign
(paren
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
)paren
op_member_access_from_pointer
id|samplerate
suffix:semicolon
id|bi.data.mix.bit_rate
op_assign
id|sm-&gt;hdrv.ops-&gt;bitrate
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
)paren
op_member_access_from_pointer
id|sbcmix
)paren
(brace
r_switch
c_cond
(paren
id|sm-&gt;modem.revhi
)paren
(brace
r_case
l_int|2
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1335
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1345
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_CT1745
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_INVALID
op_logical_and
id|bi.data.mix.reg
OL
l_int|0x80
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.reg
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|bi.data.mix.data
op_assign
id|inb
c_func
(paren
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|bi.data.mix.mixer_type
op_assign
id|SM_MIXER_AD1848
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|0x20ff
op_rshift
id|bi.data.mix.reg
)paren
op_amp
l_int|1
)paren
(brace
id|bi.data.mix.data
op_assign
id|read_codec
c_func
(paren
id|dev
comma
id|bi.data.mix.reg
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|SMCTL_SETMIXER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
)paren
op_member_access_from_pointer
id|sbcmix
)paren
(brace
r_switch
c_cond
(paren
id|sm-&gt;modem.revhi
)paren
(brace
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1335
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1345
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_CT1745
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bi.data.mix.reg
op_ge
l_int|0x80
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.reg
comma
id|DSP_MIXER_ADDR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bi.data.mix.data
comma
id|DSP_MIXER_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|bi.data.mix.mixer_type
op_ne
id|SM_MIXER_AD1848
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|0x20ff
op_rshift
id|bi.data.mix.reg
)paren
op_amp
l_int|1
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|write_codec
c_func
(paren
id|dev
comma
id|bi.data.mix.reg
comma
id|bi.data.mix.data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SMCTL_DIAGNOSE
suffix:colon
id|newdiagmode
op_assign
id|bi.data.diag.mode
suffix:semicolon
id|newdiagflags
op_assign
id|bi.data.diag.flags
suffix:semicolon
r_if
c_cond
(paren
id|newdiagmode
OG
id|SM_DIAGMODE_DEMOD
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|bi.data.diag.mode
op_assign
id|sm-&gt;diag.mode
suffix:semicolon
id|bi.data.diag.flags
op_assign
id|sm-&gt;diag.flags
suffix:semicolon
id|bi.data.diag.samplesperbit
op_assign
(paren
(paren
r_struct
id|modem_info
op_star
)paren
id|sm-&gt;hdrv.ops
)paren
op_member_access_from_pointer
id|sperbit
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;diag.mode
op_ne
id|newdiagmode
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sm-&gt;diag.ptr
op_assign
op_minus
l_int|1
suffix:semicolon
id|sm-&gt;diag.flags
op_assign
id|newdiagflags
op_amp
op_complement
id|SM_DIAGFLAG_VALID
suffix:semicolon
id|sm-&gt;diag.mode
op_assign
id|newdiagmode
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sm-&gt;diag.ptr
OL
l_int|0
op_logical_or
id|sm-&gt;diag.mode
op_eq
id|SM_DIAGMODE_OFF
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|bi.data.diag.datalen
OG
id|DIAGDATALEN
)paren
id|bi.data.diag.datalen
op_assign
id|DIAGDATALEN
suffix:semicolon
r_if
c_cond
(paren
id|sm-&gt;diag.ptr
OL
id|bi.data.diag.datalen
)paren
r_break
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|bi.data.diag.data
comma
id|bi.data.diag.datalen
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|bi.data.diag.data
comma
id|sm-&gt;diag.data
comma
id|bi.data.diag.datalen
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|bi.data.diag.flags
op_or_assign
id|SM_DIAGFLAG_VALID
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sm-&gt;diag.ptr
op_assign
op_minus
l_int|1
suffix:semicolon
id|sm-&gt;diag.flags
op_assign
id|newdiagflags
op_amp
op_complement
id|SM_DIAGFLAG_VALID
suffix:semicolon
id|sm-&gt;diag.mode
op_assign
id|newdiagmode
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|bi
comma
r_sizeof
(paren
id|bi
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
r_static
macro_line|#endif /* MODULE */
DECL|function|sm_init
r_int
id|sm_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_char
id|set_hw
op_assign
l_int|1
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
suffix:semicolon
r_char
id|ifname
(braket
id|HDLCDRV_IFNAMELEN
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: compiled %s %s&bslash;n&quot;
comma
id|__TIME__
comma
id|__DATE__
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * register net devices&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|sm_device
op_plus
id|i
suffix:semicolon
id|sprintf
c_func
(paren
id|ifname
comma
l_string|&quot;sm%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sm_ports
(braket
id|i
)braket
dot
id|hardware
template_param
id|SM_HARDWARE_WSSFDX
op_logical_or
id|sm_ports
(braket
id|i
)braket
dot
id|mode
template_param
id|SM_MODE_FSK9600
)paren
id|set_hw
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_hw
)paren
(brace
id|j
op_assign
id|hdlcdrv_register_hdlcdrv
c_func
(paren
id|dev
comma
op_amp
id|ops_tab
(braket
id|sm_ports
(braket
id|i
)braket
dot
id|hardware
)braket
(braket
id|sm_ports
(braket
id|i
)braket
dot
id|mode
)braket
op_member_access_from_pointer
id|hops
comma
r_sizeof
(paren
r_struct
id|sm_state
)paren
comma
id|ifname
comma
id|sm_ports
(braket
id|i
)braket
dot
id|iobase
comma
id|sm_ports
(braket
id|i
)braket
dot
id|irq
comma
id|sm_ports
(braket
id|i
)braket
dot
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
(brace
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.seriobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|seriobase
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.pariobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|pariobase
suffix:semicolon
id|sm-&gt;hdrv.ptt_out.midiiobase
op_assign
id|sm_ports
(braket
id|i
)braket
dot
id|midiiobase
suffix:semicolon
)brace
)brace
r_else
id|j
op_assign
id|hdlcdrv_register_hdlcdrv
c_func
(paren
id|dev
comma
op_amp
id|dummy_ops.hops
comma
r_sizeof
(paren
r_struct
id|sm_state
)paren
comma
id|ifname
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sm: cannot register net &quot;
l_string|&quot;device&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|found
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
multiline_comment|/*&n; * command line settable parameters&n; */
DECL|variable|hardware
r_int
id|hardware
op_assign
id|SM_HARDWARE_INVALID
suffix:semicolon
DECL|variable|mode
r_int
id|mode
op_assign
id|SM_MODE_INVALID
suffix:semicolon
DECL|variable|iobase
r_int
id|iobase
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_int
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma
r_int
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|seriobase
r_int
id|seriobase
op_assign
l_int|0
suffix:semicolon
DECL|variable|pariobase
r_int
id|pariobase
op_assign
l_int|0
suffix:semicolon
DECL|variable|midiiobase
r_int
id|midiiobase
op_assign
l_int|0
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: v0.1 (C) 1996 Thomas Sailer HB9JNX/AE4WA&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hardware
op_ne
id|SM_HARDWARE_INVALID
)paren
(brace
r_if
c_cond
(paren
id|iobase
op_eq
op_minus
l_int|1
)paren
id|iobase
op_assign
(paren
id|hardware
op_eq
id|SM_HARDWARE_SBC
)paren
ques
c_cond
l_int|0x220
suffix:colon
l_int|0x530
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
op_minus
l_int|1
)paren
id|irq
op_assign
(paren
id|hardware
op_eq
id|SM_HARDWARE_SBC
)paren
ques
c_cond
l_int|5
suffix:colon
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|dma
op_eq
op_minus
l_int|1
)paren
id|dma
op_assign
l_int|1
suffix:semicolon
)brace
id|sm_ports
(braket
l_int|0
)braket
dot
id|hardware
op_assign
id|hardware
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|mode
op_assign
id|mode
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|iobase
op_assign
id|iobase
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|irq
op_assign
id|irq
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|dma
op_assign
id|dma
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|seriobase
op_assign
id|seriobase
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|pariobase
op_assign
id|pariobase
suffix:semicolon
id|sm_ports
(braket
l_int|0
)braket
dot
id|midiiobase
op_assign
id|midiiobase
suffix:semicolon
id|sm_ports
(braket
l_int|1
)braket
dot
id|hardware
op_assign
id|SM_HARDWARE_INVALID
suffix:semicolon
r_return
id|sm_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sm: cleanup_module called&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|sm_device
op_plus
id|i
suffix:semicolon
r_struct
id|sm_state
op_star
id|sm
op_assign
(paren
r_struct
id|sm_state
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|sm
)paren
(brace
r_if
c_cond
(paren
id|sm-&gt;hdrv.magic
op_ne
id|HDLCDRV_MAGIC
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sm: invalid magic in &quot;
l_string|&quot;cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|hdlcdrv_unregister_hdlcdrv
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#else /* MODULE */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * format: sm=hw,mode,io,irq,dma,serio,pario[,hw,mode,io,irq,dma,serio,pario]&n; * hw=0: SBC, hw=1: WSS; mode=0: AFSK1200, mode=1: FSK9600&n; */
DECL|function|sm_setup
r_void
id|sm_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|8
op_star
(paren
id|i
op_plus
l_int|1
)paren
)paren
(brace
id|sm_ports
(braket
id|i
)braket
dot
id|hardware
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|mode
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|2
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|iobase
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|3
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|irq
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|4
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|dma
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|5
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|seriobase
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|6
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|pariobase
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|7
)braket
suffix:semicolon
id|sm_ports
(braket
id|i
)braket
dot
id|midiiobase
op_assign
id|ints
(braket
l_int|8
op_star
id|i
op_plus
l_int|8
)braket
suffix:semicolon
)brace
r_else
id|sm_ports
(braket
id|i
)braket
dot
id|hardware
op_assign
id|SM_HARDWARE_INVALID
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/* --------------------------------------------------------------------- */
eof
