multiline_comment|/* 3c515.c: A 3Com ISA EtherLink XL &quot;Corkscrew&quot; ethernet driver for linux. */
multiline_comment|/*&n;&t;Written 1997-1998 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms&n;&t;of the GNU Public License, incorporated herein by reference.&n;&n;&t;This driver is for the 3Com ISA EtherLink XL &quot;Corkscrew&quot; 3c515 ethercard.&n;&n;&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n;&t;Center of Excellence in Space Data and Information Sciences&n;&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n;&n;&t;2/2/00- Added support for kernel-level ISAPnP &n;&t;&t;by Stephen Frost &lt;sfrost@snowman.net&gt; and Alessandro Zummo&n;&t;Cleaned up for 2.3.x/softnet by Jeff Garzik and Alan Cox.&n;*/
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;3c515.c:v0.99-sn 2000/02/12 becker@cesdis.gsfc.nasa.gov and others&bslash;n&quot;
suffix:semicolon
DECL|macro|CORKSCREW
mdefine_line|#define CORKSCREW 1
multiline_comment|/* &quot;Knobs&quot; that adjust features and parameters. */
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1512 effectively disables this feature. */
DECL|variable|rx_copybreak
r_static
r_const
r_int
id|rx_copybreak
op_assign
l_int|200
suffix:semicolon
multiline_comment|/* Allow setting MTU to a larger size, bypassing the normal ethernet setup. */
DECL|variable|mtu
r_static
r_const
r_int
id|mtu
op_assign
l_int|1500
suffix:semicolon
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* Enable the automatic media selection code -- usually set. */
DECL|macro|AUTOMEDIA
mdefine_line|#define AUTOMEDIA 1
multiline_comment|/* Allow the use of fragment bus master transfers instead of only&n;   programmed-I/O for Vortex cards.  Full-bus-master transfers are always&n;   enabled by default on Boomerang cards.  If VORTEX_BUS_MASTER is defined,&n;   the feature may be turned on using &squot;options&squot;. */
DECL|macro|VORTEX_BUS_MASTER
mdefine_line|#define VORTEX_BUS_MASTER
multiline_comment|/* A few values that may be tweaked. */
multiline_comment|/* Keep the ring sizes a power of two for efficiency. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;16
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;16
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;/* Size of each temporary Rx buffer. */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/isapnp.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
DECL|macro|NEW_MULTICAST
mdefine_line|#define NEW_MULTICAST
macro_line|#include &lt;linux/delay.h&gt;
multiline_comment|/* Kernel version compatibility functions. */
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
DECL|macro|REQUEST_IRQ
mdefine_line|#define REQUEST_IRQ(i,h,f,n, instance) request_irq(i,h,f,n, instance)
DECL|macro|IRQ
mdefine_line|#define IRQ(irq, dev_id, pt_regs) (irq, dev_id, pt_regs)
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;3Com 3c515 Corkscrew driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
l_int|8
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* &quot;Knobs&quot; for adjusting internal parameters. */
multiline_comment|/* Put out somewhat more debugging messages. (0 - no msg, 1 minimal msgs). */
DECL|macro|DRIVER_DEBUG
mdefine_line|#define DRIVER_DEBUG 1
multiline_comment|/* Some values here only for performance evaluation and path-coverage&n;   debugging. */
DECL|variable|rx_nocopy
DECL|variable|rx_copy
DECL|variable|queued_packet
r_static
r_int
id|rx_nocopy
comma
id|rx_copy
comma
id|queued_packet
suffix:semicolon
multiline_comment|/* Number of times to check to see if the Tx FIFO has space, used in some&n;   limited cases. */
DECL|macro|WAIT_TX_AVAIL
mdefine_line|#define WAIT_TX_AVAIL 200
multiline_comment|/* Operational parameter that usually are not changed. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  40&t;&t;/* Time in jiffies before concluding Tx hung */
multiline_comment|/* The size here is somewhat misleading: the Corkscrew also uses the ISA&n;   aliased registers at &lt;base&gt;+0x400.&n;   */
DECL|macro|CORKSCREW_TOTAL_SIZE
mdefine_line|#define CORKSCREW_TOTAL_SIZE 0x20
macro_line|#ifdef DRIVER_DEBUG
DECL|variable|corkscrew_debug
r_int
id|corkscrew_debug
op_assign
id|DRIVER_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|corkscrew_debug
r_int
id|corkscrew_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|macro|CORKSCREW_ID
mdefine_line|#define CORKSCREW_ID 10
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the 3Com 3c515 ISA Fast EtherLink XL,&n;3Com&squot;s ISA bus adapter for Fast Ethernet.  Due to the unique I/O port layout,&n;it&squot;s not practical to integrate this driver with the other EtherLink drivers.&n;&n;II. Board-specific settings&n;&n;The Corkscrew has an EEPROM for configuration, but no special settings are&n;needed for Linux.&n;&n;III. Driver operation&n;&n;The 3c515 series use an interface that&squot;s very similar to the 3c900 &quot;Boomerang&quot;&n;PCI cards, with the bus master interface extensively modified to work with&n;the ISA bus.&n;&n;The card is capable of full-bus-master transfers with separate&n;lists of transmit and receive descriptors, similar to the AMD LANCE/PCnet,&n;DEC Tulip and Intel Speedo3.&n;&n;This driver uses a &quot;RX_COPYBREAK&quot; scheme rather than a fixed intermediate&n;receive buffer.  This scheme allocates full-sized skbuffs as receive&n;buffers.  The value RX_COPYBREAK is used as the copying breakpoint: it is&n;chosen to trade-off the memory wasted by passing the full-sized skbuff to&n;the queue layer for all frames vs. the copying cost of copying a frame to a&n;correctly-sized skbuff.&n;&n;&n;IIIC. Synchronization&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the netif&n;layer.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and other software.&n;&n;IV. Notes&n;&n;Thanks to Terry Murphy of 3Com for providing documentation and a development&n;board.&n;&n;The names &quot;Vortex&quot;, &quot;Boomerang&quot; and &quot;Corkscrew&quot; are the internal 3Com&n;project names.  I use these names to eliminate confusion -- 3Com product&n;numbers and names are very similar and often confused.&n;&n;The new chips support both ethernet (1.5K) and FDDI (4.5K) frame sizes!&n;This driver only supports ethernet frames because of the recent MTU limit&n;of 1.5K, but the changes to support 4.5K are minimal.&n;*/
multiline_comment|/* Operational definitions.&n;   These are not used by other compilation units and thus are not&n;   exported in a &quot;.h&quot; file.&n;&n;   First the windows.  There are eight register windows, with the command&n;   and status registers available in each.&n;   */
DECL|macro|EL3WINDOW
mdefine_line|#define EL3WINDOW(win_num) outw(SelectWindow + (win_num), ioaddr + EL3_CMD)
DECL|macro|EL3_CMD
mdefine_line|#define EL3_CMD 0x0e
DECL|macro|EL3_STATUS
mdefine_line|#define EL3_STATUS 0x0e
multiline_comment|/* The top five bits written to EL3_CMD are a command, the lower&n;   11 bits are the parameter, if applicable.&n;   Note that 11 parameters bits was fine for ethernet, but the new chips&n;   can handle FDDI length frames (~4500 octets) and now parameters count&n;   32-bit &squot;Dwords&squot; rather than octets. */
DECL|enum|corkscrew_cmd
r_enum
id|corkscrew_cmd
(brace
DECL|enumerator|TotalReset
DECL|enumerator|SelectWindow
DECL|enumerator|StartCoax
id|TotalReset
op_assign
l_int|0
op_lshift
l_int|11
comma
id|SelectWindow
op_assign
l_int|1
op_lshift
l_int|11
comma
id|StartCoax
op_assign
l_int|2
op_lshift
l_int|11
comma
DECL|enumerator|RxDisable
DECL|enumerator|RxEnable
DECL|enumerator|RxReset
id|RxDisable
op_assign
l_int|3
op_lshift
l_int|11
comma
id|RxEnable
op_assign
l_int|4
op_lshift
l_int|11
comma
id|RxReset
op_assign
l_int|5
op_lshift
l_int|11
comma
DECL|enumerator|UpStall
DECL|enumerator|UpUnstall
id|UpStall
op_assign
l_int|6
op_lshift
l_int|11
comma
id|UpUnstall
op_assign
(paren
l_int|6
op_lshift
l_int|11
)paren
op_plus
l_int|1
comma
DECL|enumerator|DownStall
DECL|enumerator|DownUnstall
id|DownStall
op_assign
(paren
l_int|6
op_lshift
l_int|11
)paren
op_plus
l_int|2
comma
id|DownUnstall
op_assign
(paren
l_int|6
op_lshift
l_int|11
)paren
op_plus
l_int|3
comma
DECL|enumerator|RxDiscard
DECL|enumerator|TxEnable
DECL|enumerator|TxDisable
id|RxDiscard
op_assign
l_int|8
op_lshift
l_int|11
comma
id|TxEnable
op_assign
l_int|9
op_lshift
l_int|11
comma
id|TxDisable
op_assign
DECL|enumerator|TxReset
l_int|10
op_lshift
l_int|11
comma
id|TxReset
op_assign
l_int|11
op_lshift
l_int|11
comma
DECL|enumerator|FakeIntr
DECL|enumerator|AckIntr
DECL|enumerator|SetIntrEnb
id|FakeIntr
op_assign
l_int|12
op_lshift
l_int|11
comma
id|AckIntr
op_assign
l_int|13
op_lshift
l_int|11
comma
id|SetIntrEnb
op_assign
l_int|14
op_lshift
l_int|11
comma
DECL|enumerator|SetStatusEnb
DECL|enumerator|SetRxFilter
DECL|enumerator|SetRxThreshold
id|SetStatusEnb
op_assign
l_int|15
op_lshift
l_int|11
comma
id|SetRxFilter
op_assign
l_int|16
op_lshift
l_int|11
comma
id|SetRxThreshold
op_assign
l_int|17
op_lshift
l_int|11
comma
DECL|enumerator|SetTxThreshold
DECL|enumerator|SetTxStart
id|SetTxThreshold
op_assign
l_int|18
op_lshift
l_int|11
comma
id|SetTxStart
op_assign
l_int|19
op_lshift
l_int|11
comma
DECL|enumerator|StartDMAUp
DECL|enumerator|StartDMADown
DECL|enumerator|StatsEnable
id|StartDMAUp
op_assign
l_int|20
op_lshift
l_int|11
comma
id|StartDMADown
op_assign
(paren
l_int|20
op_lshift
l_int|11
)paren
op_plus
l_int|1
comma
id|StatsEnable
op_assign
l_int|21
op_lshift
l_int|11
comma
DECL|enumerator|StatsDisable
DECL|enumerator|StopCoax
id|StatsDisable
op_assign
l_int|22
op_lshift
l_int|11
comma
id|StopCoax
op_assign
l_int|23
op_lshift
l_int|11
comma
)brace
suffix:semicolon
multiline_comment|/* The SetRxFilter command accepts the following classes: */
DECL|enum|RxFilter
r_enum
id|RxFilter
(brace
DECL|enumerator|RxStation
DECL|enumerator|RxMulticast
DECL|enumerator|RxBroadcast
DECL|enumerator|RxProm
id|RxStation
op_assign
l_int|1
comma
id|RxMulticast
op_assign
l_int|2
comma
id|RxBroadcast
op_assign
l_int|4
comma
id|RxProm
op_assign
l_int|8
)brace
suffix:semicolon
multiline_comment|/* Bits in the general status register. */
DECL|enum|corkscrew_status
r_enum
id|corkscrew_status
(brace
DECL|enumerator|IntLatch
DECL|enumerator|AdapterFailure
DECL|enumerator|TxComplete
id|IntLatch
op_assign
l_int|0x0001
comma
id|AdapterFailure
op_assign
l_int|0x0002
comma
id|TxComplete
op_assign
l_int|0x0004
comma
DECL|enumerator|TxAvailable
DECL|enumerator|RxComplete
DECL|enumerator|RxEarly
id|TxAvailable
op_assign
l_int|0x0008
comma
id|RxComplete
op_assign
l_int|0x0010
comma
id|RxEarly
op_assign
l_int|0x0020
comma
DECL|enumerator|IntReq
DECL|enumerator|StatsFull
id|IntReq
op_assign
l_int|0x0040
comma
id|StatsFull
op_assign
l_int|0x0080
comma
DECL|enumerator|DMADone
DECL|enumerator|DownComplete
DECL|enumerator|UpComplete
id|DMADone
op_assign
l_int|1
op_lshift
l_int|8
comma
id|DownComplete
op_assign
l_int|1
op_lshift
l_int|9
comma
id|UpComplete
op_assign
l_int|1
op_lshift
l_int|10
comma
DECL|enumerator|DMAInProgress
id|DMAInProgress
op_assign
l_int|1
op_lshift
l_int|11
comma
multiline_comment|/* DMA controller is still busy. */
DECL|enumerator|CmdInProgress
id|CmdInProgress
op_assign
l_int|1
op_lshift
l_int|12
comma
multiline_comment|/* EL3_CMD is still busy. */
)brace
suffix:semicolon
multiline_comment|/* Register window 1 offsets, the window used in normal operation.&n;   On the Corkscrew this window is always mapped at offsets 0x10-0x1f. */
DECL|enum|Window1
r_enum
id|Window1
(brace
DECL|enumerator|TX_FIFO
DECL|enumerator|RX_FIFO
DECL|enumerator|RxErrors
id|TX_FIFO
op_assign
l_int|0x10
comma
id|RX_FIFO
op_assign
l_int|0x10
comma
id|RxErrors
op_assign
l_int|0x14
comma
DECL|enumerator|RxStatus
DECL|enumerator|Timer
DECL|enumerator|TxStatus
id|RxStatus
op_assign
l_int|0x18
comma
id|Timer
op_assign
l_int|0x1A
comma
id|TxStatus
op_assign
l_int|0x1B
comma
DECL|enumerator|TxFree
id|TxFree
op_assign
l_int|0x1C
comma
multiline_comment|/* Remaining free bytes in Tx buffer. */
)brace
suffix:semicolon
DECL|enum|Window0
r_enum
id|Window0
(brace
DECL|enumerator|Wn0IRQ
id|Wn0IRQ
op_assign
l_int|0x08
comma
macro_line|#if defined(CORKSCREW)
DECL|enumerator|Wn0EepromCmd
id|Wn0EepromCmd
op_assign
l_int|0x200A
comma
multiline_comment|/* Corkscrew EEPROM command register. */
DECL|enumerator|Wn0EepromData
id|Wn0EepromData
op_assign
l_int|0x200C
comma
multiline_comment|/* Corkscrew EEPROM results register. */
macro_line|#else
id|Wn0EepromCmd
op_assign
l_int|10
comma
multiline_comment|/* Window 0: EEPROM command register. */
id|Wn0EepromData
op_assign
l_int|12
comma
multiline_comment|/* Window 0: EEPROM results register. */
macro_line|#endif
)brace
suffix:semicolon
DECL|enum|Win0_EEPROM_bits
r_enum
id|Win0_EEPROM_bits
(brace
DECL|enumerator|EEPROM_Read
DECL|enumerator|EEPROM_WRITE
DECL|enumerator|EEPROM_ERASE
id|EEPROM_Read
op_assign
l_int|0x80
comma
id|EEPROM_WRITE
op_assign
l_int|0x40
comma
id|EEPROM_ERASE
op_assign
l_int|0xC0
comma
DECL|enumerator|EEPROM_EWENB
id|EEPROM_EWENB
op_assign
l_int|0x30
comma
multiline_comment|/* Enable erasing/writing for 10 msec. */
DECL|enumerator|EEPROM_EWDIS
id|EEPROM_EWDIS
op_assign
l_int|0x00
comma
multiline_comment|/* Disable EWENB before 10 msec timeout. */
)brace
suffix:semicolon
multiline_comment|/* EEPROM locations. */
DECL|enum|eeprom_offset
r_enum
id|eeprom_offset
(brace
DECL|enumerator|PhysAddr01
DECL|enumerator|PhysAddr23
DECL|enumerator|PhysAddr45
DECL|enumerator|ModelID
id|PhysAddr01
op_assign
l_int|0
comma
id|PhysAddr23
op_assign
l_int|1
comma
id|PhysAddr45
op_assign
l_int|2
comma
id|ModelID
op_assign
l_int|3
comma
DECL|enumerator|EtherLink3ID
id|EtherLink3ID
op_assign
l_int|7
comma
)brace
suffix:semicolon
DECL|enum|Window3
r_enum
id|Window3
(brace
multiline_comment|/* Window 3: MAC/config bits. */
DECL|enumerator|Wn3_Config
DECL|enumerator|Wn3_MAC_Ctrl
DECL|enumerator|Wn3_Options
id|Wn3_Config
op_assign
l_int|0
comma
id|Wn3_MAC_Ctrl
op_assign
l_int|6
comma
id|Wn3_Options
op_assign
l_int|8
comma
)brace
suffix:semicolon
DECL|union|wn3_config
r_union
id|wn3_config
(brace
DECL|member|i
r_int
id|i
suffix:semicolon
DECL|struct|w3_config_fields
r_struct
id|w3_config_fields
(brace
DECL|member|ram_size
DECL|member|ram_width
DECL|member|ram_speed
r_int
r_int
id|ram_size
suffix:colon
l_int|3
comma
id|ram_width
suffix:colon
l_int|1
comma
id|ram_speed
suffix:colon
l_int|2
comma
DECL|member|rom_size
id|rom_size
suffix:colon
l_int|2
suffix:semicolon
DECL|member|pad8
r_int
id|pad8
suffix:colon
l_int|8
suffix:semicolon
DECL|member|ram_split
DECL|member|pad18
DECL|member|xcvr
DECL|member|pad21
r_int
r_int
id|ram_split
suffix:colon
l_int|2
comma
id|pad18
suffix:colon
l_int|2
comma
id|xcvr
suffix:colon
l_int|3
comma
id|pad21
suffix:colon
l_int|1
comma
DECL|member|autoselect
id|autoselect
suffix:colon
l_int|1
suffix:semicolon
DECL|member|pad24
r_int
id|pad24
suffix:colon
l_int|7
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|Window4
r_enum
id|Window4
(brace
DECL|enumerator|Wn4_NetDiag
DECL|enumerator|Wn4_Media
id|Wn4_NetDiag
op_assign
l_int|6
comma
id|Wn4_Media
op_assign
l_int|10
comma
multiline_comment|/* Window 4: Xcvr/media bits. */
)brace
suffix:semicolon
DECL|enum|Win4_Media_bits
r_enum
id|Win4_Media_bits
(brace
DECL|enumerator|Media_SQE
id|Media_SQE
op_assign
l_int|0x0008
comma
multiline_comment|/* Enable SQE error counting for AUI. */
DECL|enumerator|Media_10TP
id|Media_10TP
op_assign
l_int|0x00C0
comma
multiline_comment|/* Enable link beat and jabber for 10baseT. */
DECL|enumerator|Media_Lnk
id|Media_Lnk
op_assign
l_int|0x0080
comma
multiline_comment|/* Enable just link beat for 100TX/100FX. */
DECL|enumerator|Media_LnkBeat
id|Media_LnkBeat
op_assign
l_int|0x0800
comma
)brace
suffix:semicolon
DECL|enum|Window7
r_enum
id|Window7
(brace
multiline_comment|/* Window 7: Bus Master control. */
DECL|enumerator|Wn7_MasterAddr
DECL|enumerator|Wn7_MasterLen
DECL|enumerator|Wn7_MasterStatus
id|Wn7_MasterAddr
op_assign
l_int|0
comma
id|Wn7_MasterLen
op_assign
l_int|6
comma
id|Wn7_MasterStatus
op_assign
l_int|12
comma
)brace
suffix:semicolon
multiline_comment|/* Boomerang-style bus master control registers.  Note ISA aliases! */
DECL|enum|MasterCtrl
r_enum
id|MasterCtrl
(brace
DECL|enumerator|PktStatus
DECL|enumerator|DownListPtr
DECL|enumerator|FragAddr
DECL|enumerator|FragLen
id|PktStatus
op_assign
l_int|0x400
comma
id|DownListPtr
op_assign
l_int|0x404
comma
id|FragAddr
op_assign
l_int|0x408
comma
id|FragLen
op_assign
l_int|0x40c
comma
DECL|enumerator|TxFreeThreshold
DECL|enumerator|UpPktStatus
DECL|enumerator|UpListPtr
id|TxFreeThreshold
op_assign
l_int|0x40f
comma
id|UpPktStatus
op_assign
l_int|0x410
comma
id|UpListPtr
op_assign
l_int|0x418
comma
)brace
suffix:semicolon
multiline_comment|/* The Rx and Tx descriptor lists.&n;   Caution Alpha hackers: these types are 32 bits!  Note also the 8 byte&n;   alignment contraint on tx_ring[] and rx_ring[]. */
DECL|struct|boom_rx_desc
r_struct
id|boom_rx_desc
(brace
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|length
id|s32
id|length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Values for the Rx status entry. */
DECL|enum|rx_desc_status
r_enum
id|rx_desc_status
(brace
DECL|enumerator|RxDComplete
DECL|enumerator|RxDError
id|RxDComplete
op_assign
l_int|0x00008000
comma
id|RxDError
op_assign
l_int|0x4000
comma
multiline_comment|/* See boomerang_rx() for actual error bits */
)brace
suffix:semicolon
DECL|struct|boom_tx_desc
r_struct
id|boom_tx_desc
(brace
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|status
id|s32
id|status
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|length
id|s32
id|length
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|corkscrew_private
r_struct
id|corkscrew_private
(brace
DECL|member|product_name
r_const
r_char
op_star
id|product_name
suffix:semicolon
DECL|member|next_module
r_struct
id|net_device
op_star
id|next_module
suffix:semicolon
multiline_comment|/* The Rx and Tx rings are here to keep them quad-word-aligned. */
DECL|member|rx_ring
r_struct
id|boom_rx_desc
id|rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_ring
r_struct
id|boom_tx_desc
id|tx_ring
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The addresses of transmit- and receive-in-place skbuffs. */
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|cur_rx
DECL|member|cur_tx
r_int
r_int
id|cur_rx
comma
id|cur_tx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_rx
DECL|member|dirty_tx
r_int
r_int
id|dirty_rx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_skb
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
multiline_comment|/* Packet being eaten by bus master ctrl.  */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
DECL|member|capabilities
r_int
id|capabilities
suffix:semicolon
multiline_comment|/* Adapter capabilities word. */
DECL|member|options
r_int
id|options
suffix:semicolon
multiline_comment|/* User-settable misc. driver options. */
DECL|member|last_rx_packets
r_int
id|last_rx_packets
suffix:semicolon
multiline_comment|/* For media autoselection. */
DECL|member|available_media
r_int
r_int
id|available_media
suffix:colon
l_int|8
comma
multiline_comment|/* From Wn3_Options */
DECL|member|media_override
id|media_override
suffix:colon
l_int|3
comma
multiline_comment|/* Passed-in media type. */
DECL|member|default_media
id|default_media
suffix:colon
l_int|3
comma
multiline_comment|/* Read from the EEPROM. */
DECL|member|full_duplex
DECL|member|autoselect
DECL|member|bus_master
id|full_duplex
suffix:colon
l_int|1
comma
id|autoselect
suffix:colon
l_int|1
comma
id|bus_master
suffix:colon
l_int|1
comma
multiline_comment|/* Vortex can only do a fragment bus-m. */
DECL|member|full_bus_master_tx
DECL|member|full_bus_master_rx
id|full_bus_master_tx
suffix:colon
l_int|1
comma
id|full_bus_master_rx
suffix:colon
l_int|1
comma
multiline_comment|/* Boomerang  */
DECL|member|tx_full
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The action to take with a media selection timer tick.&n;   Note that we deviate from the 3Com order by checking 10base2 before AUI.&n; */
DECL|enum|xcvr_types
r_enum
id|xcvr_types
(brace
DECL|enumerator|XCVR_10baseT
id|XCVR_10baseT
op_assign
DECL|enumerator|XCVR_AUI
DECL|enumerator|XCVR_10baseTOnly
DECL|enumerator|XCVR_10base2
DECL|enumerator|XCVR_100baseTx
l_int|0
comma
id|XCVR_AUI
comma
id|XCVR_10baseTOnly
comma
id|XCVR_10base2
comma
id|XCVR_100baseTx
comma
DECL|enumerator|XCVR_100baseFx
DECL|enumerator|XCVR_MII
DECL|enumerator|XCVR_Default
id|XCVR_100baseFx
comma
id|XCVR_MII
op_assign
l_int|6
comma
id|XCVR_Default
op_assign
l_int|8
comma
)brace
suffix:semicolon
DECL|struct|media_table
r_static
r_struct
id|media_table
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|media_bits
r_int
r_int
id|media_bits
suffix:colon
l_int|16
comma
multiline_comment|/* Bits to set in Wn4_Media register. */
DECL|member|mask
id|mask
suffix:colon
l_int|8
comma
multiline_comment|/* The transceiver-present bit in Wn3_Config. */
DECL|member|next
id|next
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* The media type to try next. */
DECL|member|wait
r_int
id|wait
suffix:semicolon
multiline_comment|/* Time before we check media status. */
DECL|variable|media_tbl
)brace
id|media_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;10baseT&quot;
comma
id|Media_10TP
comma
l_int|0x08
comma
id|XCVR_10base2
comma
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;10Mbs AUI&quot;
comma
id|Media_SQE
comma
l_int|0x20
comma
id|XCVR_Default
comma
(paren
l_int|1
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;undefined&quot;
comma
l_int|0
comma
l_int|0x80
comma
id|XCVR_10baseT
comma
l_int|10000
)brace
comma
(brace
l_string|&quot;10base2&quot;
comma
l_int|0
comma
l_int|0x10
comma
id|XCVR_AUI
comma
(paren
l_int|1
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;100baseTX&quot;
comma
id|Media_Lnk
comma
l_int|0x02
comma
id|XCVR_100baseFx
comma
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;100baseFX&quot;
comma
id|Media_Lnk
comma
l_int|0x04
comma
id|XCVR_MII
comma
(paren
l_int|14
op_star
id|HZ
)paren
op_div
l_int|10
)brace
comma
(brace
l_string|&quot;MII&quot;
comma
l_int|0
comma
l_int|0x40
comma
id|XCVR_10baseT
comma
l_int|3
op_star
id|HZ
)brace
comma
(brace
l_string|&quot;undefined&quot;
comma
l_int|0
comma
l_int|0x01
comma
id|XCVR_10baseT
comma
l_int|10000
)brace
comma
(brace
l_string|&quot;Default&quot;
comma
l_int|0
comma
l_int|0xFF
comma
id|XCVR_10baseT
comma
l_int|10000
)brace
comma
)brace
suffix:semicolon
macro_line|#ifdef __ISAPNP__
DECL|struct|corkscrew_isapnp_adapters_struct
r_struct
id|corkscrew_isapnp_adapters_struct
(brace
DECL|member|vendor
DECL|member|function
r_int
r_int
id|vendor
comma
id|function
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|corkscrew_isapnp_adapters
r_struct
id|corkscrew_isapnp_adapters_struct
id|corkscrew_isapnp_adapters
(braket
)braket
op_assign
(brace
(brace
id|ISAPNP_VENDOR
c_func
(paren
l_char|&squot;T&squot;
comma
l_char|&squot;C&squot;
comma
l_char|&squot;M&squot;
)paren
comma
id|ISAPNP_FUNCTION
c_func
(paren
l_int|0x5051
)paren
comma
l_string|&quot;3Com Fast EtherLink ISA&quot;
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|corkscrew_isapnp_phys_addr
r_int
id|corkscrew_isapnp_phys_addr
(braket
l_int|3
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|nopnp
r_static
r_int
id|nopnp
suffix:semicolon
macro_line|#endif
r_static
r_int
id|corkscrew_scan
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device
op_star
id|corkscrew_found_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|product_index
comma
r_int
id|options
)paren
suffix:semicolon
r_static
r_int
id|corkscrew_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|corkscrew_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|corkscrew_timer
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|corkscrew_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|corkscrew_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|corkscrew_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|boomerang_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|corkscrew_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|corkscrew_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|addr
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|corkscrew_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
"&f;"
multiline_comment|/* &n;   Unfortunately maximizing the shared code between the integrated and&n;   module version of the driver results in a complicated set of initialization&n;   procedures.&n;   init_module() -- modules /  tc59x_init()  -- built-in&n;&t;&t;The wrappers for corkscrew_scan()&n;   corkscrew_scan()  &t;&t; The common routine that scans for PCI and EISA cards&n;   corkscrew_found_device() Allocate a device structure when we find a card.&n;&t;&t;&t;&t;&t;Different versions exist for modules and built-in.&n;   corkscrew_probe1()&t;&t;Fill in the device structure -- this is separated&n;&t;&t;&t;&t;&t;so that the modules code can put it in dev-&gt;init.&n;*/
multiline_comment|/* This driver uses &squot;options&squot; to pass the media type, full-duplex flag, etc. */
multiline_comment|/* Note: this is the only limit on the number of cards supported!! */
DECL|variable|options
r_static
r_int
id|options
(braket
l_int|8
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|debug
r_static
r_int
id|debug
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* A list of all installed Vortex devices, for removing the driver module. */
DECL|variable|root_corkscrew_dev
r_static
r_struct
id|net_device
op_star
id|root_corkscrew_dev
op_assign
l_int|NULL
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|cards_found
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ge
l_int|0
)paren
id|corkscrew_debug
op_assign
id|debug
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|root_corkscrew_dev
op_assign
l_int|NULL
suffix:semicolon
id|cards_found
op_assign
id|corkscrew_scan
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#else
DECL|function|tc515_probe
r_int
id|tc515_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cards_found
op_assign
id|corkscrew_scan
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|0
op_logical_and
id|cards_found
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_return
id|cards_found
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* not MODULE */
DECL|function|corkscrew_scan
r_static
r_int
id|corkscrew_scan
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|ioaddr
suffix:semicolon
macro_line|#ifdef __ISAPNP__
r_int
id|i
suffix:semicolon
r_static
r_int
id|pnp_cards
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __ISAPNP__
r_if
c_cond
(paren
id|nopnp
op_eq
l_int|1
)paren
(brace
r_goto
id|no_pnp
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|corkscrew_isapnp_adapters
(braket
id|i
)braket
dot
id|vendor
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|pci_dev
op_star
id|idev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_while
c_loop
(paren
(paren
id|idev
op_assign
id|isapnp_find_dev
c_func
(paren
l_int|NULL
comma
id|corkscrew_isapnp_adapters
(braket
id|i
)braket
dot
id|vendor
comma
id|corkscrew_isapnp_adapters
(braket
id|i
)braket
dot
id|function
comma
id|idev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|idev-&gt;active
)paren
(brace
id|idev
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|idev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idev
op_member_access_from_pointer
id|prepare
c_func
(paren
id|idev
)paren
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|idev
op_member_access_from_pointer
id|activate
c_func
(paren
id|idev
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;isapnp configure failed (out of resources?)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_logical_or
id|check_region
c_func
(paren
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
l_int|16
)paren
)paren
r_continue
suffix:semicolon
id|ioaddr
op_assign
id|idev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|irq
op_assign
id|idev-&gt;irq_resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
)paren
(brace
id|printk
(paren
l_string|&quot;ISAPNP reports %s at i/o 0x%x, irq %d&bslash;n&quot;
comma
id|corkscrew_isapnp_adapters
(braket
id|i
)braket
dot
id|name
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2002
)paren
op_amp
l_int|0x1f0
)paren
op_ne
(paren
id|ioaddr
op_amp
l_int|0x1f0
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Verify by reading the device ID from the EEPROM. */
(brace
r_int
id|timer
suffix:semicolon
id|outw
c_func
(paren
id|EEPROM_Read
op_plus
l_int|7
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
multiline_comment|/* Pause for at least 162 us. for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|4
suffix:semicolon
id|timer
op_ge
l_int|0
suffix:semicolon
id|timer
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|162
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
op_amp
l_int|0x0200
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromData
)paren
op_ne
l_int|0x6d50
)paren
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3c515 Resource configuration register %#4.4x, DCR %4.4x.&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0x2002
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2000
)paren
)paren
suffix:semicolon
multiline_comment|/* irq = inw(ioaddr + 0x2002) &amp; 15; */
multiline_comment|/* Use the irq from isapnp */
id|corkscrew_isapnp_phys_addr
(braket
id|pnp_cards
)braket
op_assign
id|ioaddr
suffix:semicolon
id|corkscrew_found_device
c_func
(paren
id|dev
comma
id|ioaddr
comma
id|irq
comma
id|CORKSCREW_ID
comma
id|dev
op_logical_and
id|dev-&gt;mem_start
ques
c_cond
id|dev
op_member_access_from_pointer
id|mem_start
suffix:colon
id|options
(braket
id|cards_found
)braket
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|pnp_cards
op_increment
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
)brace
id|no_pnp
suffix:colon
macro_line|#endif /* not __ISAPNP__ */
multiline_comment|/* Check all locations on the ISA bus -- evil! */
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0x100
suffix:semicolon
id|ioaddr
OL
l_int|0x400
suffix:semicolon
id|ioaddr
op_add_assign
l_int|0x20
)paren
(brace
r_int
id|irq
suffix:semicolon
macro_line|#ifdef __ISAPNP__
multiline_comment|/* Make sure this was not already picked up by isapnp */
r_if
c_cond
(paren
id|ioaddr
op_eq
id|corkscrew_isapnp_phys_addr
(braket
l_int|0
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioaddr
op_eq
id|corkscrew_isapnp_phys_addr
(braket
l_int|1
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioaddr
op_eq
id|corkscrew_isapnp_phys_addr
(braket
l_int|2
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|CORKSCREW_TOTAL_SIZE
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Check the resource configuration for a matching ioaddr. */
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2002
)paren
op_amp
l_int|0x1f0
)paren
op_ne
(paren
id|ioaddr
op_amp
l_int|0x1f0
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Verify by reading the device ID from the EEPROM. */
(brace
r_int
id|timer
suffix:semicolon
id|outw
c_func
(paren
id|EEPROM_Read
op_plus
l_int|7
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
multiline_comment|/* Pause for at least 162 us. for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|4
suffix:semicolon
id|timer
op_ge
l_int|0
suffix:semicolon
id|timer
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|162
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
op_amp
l_int|0x0200
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromData
)paren
op_ne
l_int|0x6d50
)paren
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3c515 Resource configuration register %#4.4x, DCR %4.4x.&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0x2002
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2000
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2002
)paren
op_amp
l_int|15
suffix:semicolon
id|corkscrew_found_device
c_func
(paren
id|dev
comma
id|ioaddr
comma
id|irq
comma
id|CORKSCREW_ID
comma
id|dev
op_logical_and
id|dev-&gt;mem_start
ques
c_cond
id|dev
op_member_access_from_pointer
id|mem_start
suffix:colon
id|options
(braket
id|cards_found
)braket
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|corkscrew_debug
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%d 3c515 cards found.&bslash;n&quot;
comma
id|cards_found
)paren
suffix:semicolon
r_return
id|cards_found
suffix:semicolon
)brace
DECL|function|corkscrew_found_device
r_static
r_struct
id|net_device
op_star
id|corkscrew_found_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|product_index
comma
r_int
id|options
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* Allocate and fill new device structure. */
r_int
id|dev_size
op_assign
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
r_sizeof
(paren
r_struct
id|corkscrew_private
)paren
op_plus
l_int|15
suffix:semicolon
multiline_comment|/* Pad for alignment */
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev_size
)paren
suffix:semicolon
multiline_comment|/* Align the Rx and Tx ring entries.  */
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|dev
op_plus
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;dma
op_assign
(paren
id|product_index
op_eq
id|CORKSCREW_ID
ques
c_cond
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2000
)paren
op_amp
l_int|7
suffix:colon
l_int|0
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
id|corkscrew_probe1
suffix:semicolon
id|vp-&gt;product_name
op_assign
l_string|&quot;3c515&quot;
suffix:semicolon
id|vp-&gt;options
op_assign
id|options
suffix:semicolon
r_if
c_cond
(paren
id|options
op_ge
l_int|0
)paren
(brace
id|vp-&gt;media_override
op_assign
(paren
(paren
id|options
op_amp
l_int|7
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|options
op_amp
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
(paren
id|options
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
(paren
id|options
op_amp
l_int|16
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;media_override
op_assign
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
l_int|0
suffix:semicolon
)brace
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|vp-&gt;next_module
op_assign
id|root_corkscrew_dev
suffix:semicolon
id|root_corkscrew_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#else&t;&t;&t;&t;/* not a MODULE */
multiline_comment|/* Caution: quad-word alignment required for rings! */
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|corkscrew_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|corkscrew_private
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
r_sizeof
(paren
r_struct
id|corkscrew_private
)paren
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;dma
op_assign
(paren
id|product_index
op_eq
id|CORKSCREW_ID
ques
c_cond
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x2000
)paren
op_amp
l_int|7
suffix:colon
l_int|0
)paren
suffix:semicolon
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|vp-&gt;product_name
op_assign
l_string|&quot;3c515&quot;
suffix:semicolon
id|vp-&gt;options
op_assign
id|options
suffix:semicolon
r_if
c_cond
(paren
id|options
op_ge
l_int|0
)paren
(brace
id|vp-&gt;media_override
op_assign
(paren
(paren
id|options
op_amp
l_int|7
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|options
op_amp
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
(paren
id|options
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
(paren
id|options
op_amp
l_int|16
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;media_override
op_assign
l_int|7
suffix:semicolon
id|vp-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;bus_master
op_assign
l_int|0
suffix:semicolon
)brace
id|corkscrew_probe1
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MODULE */
r_return
id|dev
suffix:semicolon
)brace
DECL|function|corkscrew_probe1
r_static
r_int
id|corkscrew_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|eeprom
(braket
l_int|0x40
)braket
comma
id|checksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EEPROM contents */
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 3Com %s at %#3x,&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;product_name
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Read the station address from the EEPROM. */
id|EL3WINDOW
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x18
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
op_star
id|phys_addr
op_assign
(paren
r_int
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
r_int
id|timer
suffix:semicolon
id|outw
c_func
(paren
id|EEPROM_Read
op_plus
id|i
comma
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
suffix:semicolon
multiline_comment|/* Pause for at least 162 us. for the read to take place. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|4
suffix:semicolon
id|timer
op_ge
l_int|0
suffix:semicolon
id|timer
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|162
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromCmd
)paren
op_amp
l_int|0x0200
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|eeprom
(braket
id|i
)braket
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn0EepromData
)paren
suffix:semicolon
id|checksum
op_xor_assign
id|eeprom
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
id|phys_addr
(braket
id|i
)braket
op_assign
id|htons
c_func
(paren
id|eeprom
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|checksum
op_assign
(paren
id|checksum
op_xor
(paren
id|checksum
op_rshift
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0x00
)paren
id|printk
c_func
(paren
l_string|&quot; ***INVALID CHECKSUM %4.4x*** &quot;
comma
id|checksum
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c%2.2x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom
(braket
l_int|16
)braket
op_eq
l_int|0x11c7
)paren
(brace
multiline_comment|/* Corkscrew */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;dma
comma
l_string|&quot;3c515&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, DMA %d allocation failed&quot;
comma
id|dev-&gt;dma
)paren
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;, DMA %d&quot;
comma
id|dev-&gt;dma
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;, IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Tell them about an invalid IRQ. */
r_if
c_cond
(paren
id|corkscrew_debug
op_logical_and
(paren
id|dev-&gt;irq
op_le
l_int|0
op_logical_or
id|dev-&gt;irq
OG
l_int|15
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot; *** Warning: this IRQ is unlikely to work! ***&bslash;n&quot;
)paren
suffix:semicolon
(brace
r_char
op_star
id|ram_split
(braket
)braket
op_assign
(brace
l_string|&quot;5:3&quot;
comma
l_string|&quot;3:1&quot;
comma
l_string|&quot;1:1&quot;
comma
l_string|&quot;3:5&quot;
)brace
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|vp-&gt;available_media
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Options
)paren
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Internal config register is %4.4x, transceivers %#x.&bslash;n&quot;
comma
id|config.i
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Options
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  %dK %s-wide RAM %s Rx:Tx split, %s%s interface.&bslash;n&quot;
comma
l_int|8
op_lshift
id|config.u.ram_size
comma
id|config.u.ram_width
ques
c_cond
l_string|&quot;word&quot;
suffix:colon
l_string|&quot;byte&quot;
comma
id|ram_split
(braket
id|config.u.ram_split
)braket
comma
id|config.u.autoselect
ques
c_cond
l_string|&quot;autoselect/&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|media_tbl
(braket
id|config.u.xcvr
)braket
dot
id|name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|config.u.xcvr
suffix:semicolon
id|vp-&gt;default_media
op_assign
id|config.u.xcvr
suffix:semicolon
id|vp-&gt;autoselect
op_assign
id|config.u.autoselect
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vp-&gt;media_override
op_ne
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Media override to transceiver type %d (%s).&bslash;n&quot;
comma
id|vp-&gt;media_override
comma
id|media_tbl
(braket
id|vp-&gt;media_override
)braket
dot
id|name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|vp-&gt;media_override
suffix:semicolon
)brace
id|vp-&gt;capabilities
op_assign
id|eeprom
(braket
l_int|16
)braket
suffix:semicolon
id|vp-&gt;full_bus_master_tx
op_assign
(paren
id|vp-&gt;capabilities
op_amp
l_int|0x20
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Rx is broken at 10mbps, so we always disable it. */
multiline_comment|/* vp-&gt;full_bus_master_rx = 0; */
id|vp-&gt;full_bus_master_rx
op_assign
(paren
id|vp-&gt;capabilities
op_amp
l_int|0x20
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* We do a request_region() to register /proc/ioports info. */
id|request_region
c_func
(paren
id|ioaddr
comma
id|CORKSCREW_TOTAL_SIZE
comma
id|vp-&gt;product_name
)paren
suffix:semicolon
multiline_comment|/* The 3c51x-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|corkscrew_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|corkscrew_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|corkscrew_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
(paren
l_int|400
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|corkscrew_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|corkscrew_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
DECL|function|corkscrew_open
r_static
r_int
id|corkscrew_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_union
id|wn3_config
id|config
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Before initializing select the active media port. */
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_duplex
)paren
id|outb
c_func
(paren
l_int|0x20
comma
id|ioaddr
op_plus
id|Wn3_MAC_Ctrl
)paren
suffix:semicolon
multiline_comment|/* Set the full-duplex bit. */
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;media_override
op_ne
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Media override to transceiver %d (%s).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;media_override
comma
id|media_tbl
(braket
id|vp-&gt;media_override
)braket
dot
id|name
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|vp-&gt;media_override
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vp-&gt;autoselect
)paren
(brace
multiline_comment|/* Find first available media type, starting with 100baseTx. */
id|dev-&gt;if_port
op_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|vp-&gt;available_media
op_amp
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|mask
)paren
)paren
id|dev-&gt;if_port
op_assign
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|next
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Initial media type %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
id|vp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|wait
)paren
suffix:semicolon
id|vp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|vp-&gt;timer.function
op_assign
op_amp
id|corkscrew_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;if_port
op_assign
id|vp-&gt;default_media
suffix:semicolon
id|config.u.xcvr
op_assign
id|dev-&gt;if_port
suffix:semicolon
id|outl
c_func
(paren
id|config.i
comma
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: corkscrew_open() InternalConfig %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|config.i
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait a few ticks for the RxReset command to complete. */
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|SetStatusEnb
op_or
l_int|0x00
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Use the now-standard shared IRQ implementation. */
r_if
c_cond
(paren
id|vp-&gt;capabilities
op_eq
l_int|0x11c7
)paren
(brace
multiline_comment|/* Corkscrew: Cannot share ISA resources. */
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
l_int|0
op_logical_or
id|dev-&gt;dma
op_eq
l_int|0
op_logical_or
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|corkscrew_interrupt
comma
l_int|0
comma
id|vp-&gt;product_name
comma
id|dev
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|enable_dma
c_func
(paren
id|dev-&gt;dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dev-&gt;dma
comma
id|DMA_MODE_CASCADE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|corkscrew_interrupt
comma
id|SA_SHIRQ
comma
id|vp-&gt;product_name
comma
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
(brace
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: corkscrew_open() irq %d media status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the station address and mask in window 2 each time opened. */
id|EL3WINDOW
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|outw
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|3
)paren
multiline_comment|/* Start the thinnet transceiver. We should really wait 50ms... */
id|outw
c_func
(paren
id|StartCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
op_amp
op_complement
(paren
id|Media_10TP
op_or
id|Media_SQE
)paren
)paren
op_or
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|media_bits
comma
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
multiline_comment|/* Switch to the stats window, and clear all stats by reading. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* New: On the Vortex we must also clear the BadSSD counter. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* ..and on the Boomerang we enable the extra statistics bits. */
id|outw
c_func
(paren
l_int|0x0040
comma
id|ioaddr
op_plus
id|Wn4_NetDiag
)paren
suffix:semicolon
multiline_comment|/* Switch to register set 7 for normal use. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_rx
)paren
(brace
multiline_comment|/* Boomerang bus master. */
id|vp-&gt;cur_rx
op_assign
id|vp-&gt;dirty_rx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s:  Filling in the Rx ring.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
(paren
id|RX_RING_SIZE
op_minus
l_int|1
)paren
)paren
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;rx_ring
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
r_else
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear complete bit. */
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|length
op_assign
id|PKT_BUF_SZ
op_or
l_int|0x80000000
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Bad news!  */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|vp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
)brace
id|vp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;rx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Wrap the ring. */
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;rx_ring
(braket
l_int|0
)braket
)paren
comma
id|ioaddr
op_plus
id|UpListPtr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
multiline_comment|/* Boomerang bus master Tx. */
id|vp-&gt;cur_tx
op_assign
id|vp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|PKT_BUF_SZ
op_rshift
l_int|8
comma
id|ioaddr
op_plus
id|TxFreeThreshold
)paren
suffix:semicolon
multiline_comment|/* Room for a packet. */
multiline_comment|/* Clear the Tx ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
)brace
multiline_comment|/* Set receiver mode: presumably accept b-case and phys addr only. */
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|StatsEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Turn on statistics. */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable the receiver. */
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter. */
multiline_comment|/* Allow status bits to be seen. */
id|outw
c_func
(paren
id|SetStatusEnb
op_or
id|AdapterFailure
op_or
id|IntReq
op_or
id|StatsFull
op_or
(paren
id|vp-&gt;full_bus_master_tx
ques
c_cond
id|DownComplete
suffix:colon
id|TxAvailable
)paren
op_or
(paren
id|vp-&gt;full_bus_master_rx
ques
c_cond
id|UpComplete
suffix:colon
id|RxComplete
)paren
op_or
(paren
id|vp-&gt;bus_master
ques
c_cond
id|DMADone
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Ack all pending events, and set active indicator mask. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxEarly
op_or
id|IntReq
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
id|IntLatch
op_or
id|TxAvailable
op_or
id|RxComplete
op_or
id|StatsFull
op_or
(paren
id|vp-&gt;bus_master
ques
c_cond
id|DMADone
suffix:colon
l_int|0
)paren
op_or
id|UpComplete
op_or
id|DownComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corkscrew_timer
r_static
r_void
id|corkscrew_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
macro_line|#ifdef AUTOMEDIA
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media selection timer tick happened, %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
(brace
r_int
id|old_window
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_CMD
)paren
op_rshift
l_int|13
suffix:semicolon
r_int
id|media_status
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|media_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;if_port
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
multiline_comment|/* 10baseT, 100baseTX, 100baseFX  */
r_if
c_cond
(paren
id|media_status
op_amp
id|Media_LnkBeat
)paren
(brace
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media %s has link beat, %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
comma
id|media_status
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media %s is has no link beat, %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
comma
id|media_status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Other media types handled by Tx timeouts. */
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media %s is has no indication, %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
comma
id|media_status
)paren
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
r_union
id|wn3_config
id|config
suffix:semicolon
r_do
(brace
id|dev-&gt;if_port
op_assign
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|vp-&gt;available_media
op_amp
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|mask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|8
)paren
(brace
multiline_comment|/* Go back to default. */
id|dev-&gt;if_port
op_assign
id|vp-&gt;default_media
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media selection failing, using default %s port.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media selection failed, now trying %s port.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
id|vp-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|wait
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
(paren
id|media_status
op_amp
op_complement
(paren
id|Media_10TP
op_or
id|Media_SQE
)paren
)paren
op_or
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|media_bits
comma
id|ioaddr
op_plus
id|Wn4_Media
)paren
suffix:semicolon
id|EL3WINDOW
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|config.i
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
id|config.u.xcvr
op_assign
id|dev-&gt;if_port
suffix:semicolon
id|outl
c_func
(paren
id|config.i
comma
id|ioaddr
op_plus
id|Wn3_Config
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dev-&gt;if_port
op_eq
l_int|3
ques
c_cond
id|StartCoax
suffix:colon
id|StopCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|EL3WINDOW
c_func
(paren
id|old_window
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Media selection timer finished, %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|media_tbl
(braket
id|dev-&gt;if_port
)braket
dot
id|name
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* AUTOMEDIA */
r_return
suffix:semicolon
)brace
DECL|function|corkscrew_timeout
r_static
r_void
id|corkscrew_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, tx_status %2.2x status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
suffix:semicolon
multiline_comment|/* Slight code bloat to be user friendly. */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
op_amp
l_int|0x88
)paren
op_eq
l_int|0x88
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmitter encountered 16 collisions -- network&quot;
l_string|&quot; network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#ifndef final_version
id|printk
c_func
(paren
l_string|&quot;  Flags; bus-master %d, full %d; dirty %d current %d.&bslash;n&quot;
comma
id|vp-&gt;full_bus_master_tx
comma
id|vp-&gt;tx_full
comma
id|vp-&gt;dirty_tx
comma
id|vp-&gt;cur_tx
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  Down list %8.8x vs. %p.&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
comma
op_amp
id|vp-&gt;tx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  %d: %p  length %8.8x status %8.8x&bslash;n&quot;
comma
id|i
comma
op_amp
id|vp-&gt;tx_ring
(braket
id|i
)braket
comma
id|vp-&gt;tx_ring
(braket
id|i
)braket
dot
id|length
comma
id|vp-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Issue TX_RESET and TX_START commands. */
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|vp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|vp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|corkscrew_start_xmit
r_static
r_int
id|corkscrew_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Block a timer-based transmit from overlapping. */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
multiline_comment|/* BOOMERANG bus-master */
multiline_comment|/* Calculate the next Tx descriptor entry. */
r_int
id|entry
op_assign
id|vp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_struct
id|boom_tx_desc
op_star
id|prev_entry
suffix:semicolon
r_int
r_int
id|flags
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;tx_full
)paren
multiline_comment|/* No room to transmit with */
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cur_tx
op_ne
l_int|0
)paren
id|prev_entry
op_assign
op_amp
id|vp-&gt;tx_ring
(braket
(paren
id|vp-&gt;cur_tx
op_minus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)braket
suffix:semicolon
r_else
id|prev_entry
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Trying to send a packet, Tx index %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vp-&gt;cur_tx
)paren
suffix:semicolon
multiline_comment|/* vp-&gt;tx_full = 1; */
id|vp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|length
op_assign
id|skb-&gt;len
op_or
l_int|0x80000000
suffix:semicolon
id|vp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
id|skb-&gt;len
op_or
l_int|0x80000000
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|DownStall
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait for the stall to complete. */
r_for
c_loop
(paren
id|i
op_assign
l_int|20
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|prev_entry
)paren
id|prev_entry-&gt;next
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;tx_ring
(braket
id|entry
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
op_eq
l_int|0
)paren
(brace
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|vp-&gt;tx_ring
(braket
id|entry
)braket
)paren
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
id|queued_packet
op_increment
suffix:semicolon
)brace
id|outw
c_func
(paren
id|DownUnstall
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|vp-&gt;cur_tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;cur_tx
op_minus
id|vp-&gt;dirty_tx
OG
id|TX_RING_SIZE
op_minus
l_int|1
)paren
id|vp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
r_else
(brace
multiline_comment|/* Clear previous interrupt enable. */
r_if
c_cond
(paren
id|prev_entry
)paren
id|prev_entry-&gt;status
op_and_assign
op_complement
l_int|0x80000000
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Put out the doubleword header... */
id|outl
c_func
(paren
id|skb-&gt;len
comma
id|ioaddr
op_plus
id|TX_FIFO
)paren
suffix:semicolon
macro_line|#ifdef VORTEX_BUS_MASTER
r_if
c_cond
(paren
id|vp-&gt;bus_master
)paren
(brace
multiline_comment|/* Set the bus-master controller to transfer the packet. */
id|outl
c_func
(paren
(paren
r_int
)paren
(paren
id|skb-&gt;data
)paren
comma
id|ioaddr
op_plus
id|Wn7_MasterAddr
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
comma
id|ioaddr
op_plus
id|Wn7_MasterLen
)paren
suffix:semicolon
id|vp-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|outw
c_func
(paren
id|StartDMADown
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* queue will be woken at the DMADone interrupt. */
)brace
r_else
(brace
multiline_comment|/* ... and the packet rounded to a doubleword. */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
OG
l_int|1536
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
(paren
l_int|1536
op_rshift
l_int|2
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* ... and the packet rounded to a doubleword. */
id|outsl
c_func
(paren
id|ioaddr
op_plus
id|TX_FIFO
comma
id|skb-&gt;data
comma
(paren
id|skb-&gt;len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxFree
)paren
OG
l_int|1536
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Interrupt us when the FIFO has room for max-sized packet. */
id|outw
c_func
(paren
id|SetTxThreshold
op_plus
(paren
l_int|1536
op_rshift
l_int|2
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* bus master */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Clear the Tx status stack. */
(brace
r_int
id|tx_status
suffix:semicolon
r_int
id|i
op_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
op_logical_and
(paren
id|tx_status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x3C
)paren
(brace
multiline_comment|/* A Tx-disabling error occurred.  */
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Tx error, status %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x38
)paren
id|vp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x30
)paren
(brace
r_int
id|j
suffix:semicolon
id|outw
c_func
(paren
id|TxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|20
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
)brace
id|outw
c_func
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
multiline_comment|/* Pop the status stack. */
)brace
)brace
id|vp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|corkscrew_interrupt
r_static
r_void
id|corkscrew_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* Use the now-standard shared IRQ implementation. */
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|corkscrew_private
op_star
id|lp
suffix:semicolon
r_int
id|ioaddr
comma
id|status
suffix:semicolon
r_int
id|latency
suffix:semicolon
r_int
id|i
op_assign
id|max_interrupt_work
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|latency
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|Timer
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: interrupt, status %4.4x, timer %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|latency
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xE000
)paren
op_ne
l_int|0xE000
)paren
(brace
r_static
r_int
id|donedidthis
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Some interrupt controllers store a bogus interrupt from boot-time.&n;&t;&t;   Ignore a single early interrupt, but don&squot;t hang the machine for&n;&t;&t;   other interrupt problems. */
r_if
c_cond
(paren
id|donedidthis
op_increment
OG
l_int|100
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Bogus interrupt, bailing. Status %4.4x, start=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|netif_running
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_do
(brace
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;%s: In interrupt loop, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RxComplete
)paren
id|corkscrew_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TxAvailable
)paren
(brace
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|5
)paren
id|printk
(paren
l_string|&quot;&t;TX room bit was handled.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* There&squot;s room in the FIFO for a full-sized packet. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|TxAvailable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|DownComplete
)paren
(brace
r_int
r_int
id|dirty_tx
op_assign
id|lp-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|lp-&gt;cur_tx
op_minus
id|dirty_tx
OG
l_int|0
)paren
(brace
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DownListPtr
)paren
op_eq
id|virt_to_bus
c_func
(paren
op_amp
id|lp-&gt;tx_ring
(braket
id|entry
)braket
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been processed. */
r_if
c_cond
(paren
id|lp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|lp
op_member_access_from_pointer
id|tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|lp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|dirty_tx
op_increment
suffix:semicolon
)brace
id|lp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|DownComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;tx_full
op_logical_and
(paren
id|lp-&gt;cur_tx
op_minus
id|dirty_tx
op_le
id|TX_RING_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|lp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef VORTEX_BUS_MASTER
r_if
c_cond
(paren
id|status
op_amp
id|DMADone
)paren
(brace
id|outw
c_func
(paren
l_int|0x1000
comma
id|ioaddr
op_plus
id|Wn7_MasterStatus
)paren
suffix:semicolon
multiline_comment|/* Ack the event. */
id|dev_kfree_skb_irq
c_func
(paren
id|lp-&gt;tx_skb
)paren
suffix:semicolon
multiline_comment|/* Release the transfered buffer */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
id|UpComplete
)paren
(brace
id|boomerang_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|UpComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|AdapterFailure
op_or
id|RxEarly
op_or
id|StatsFull
)paren
)paren
(brace
multiline_comment|/* Handle all uncommon interrupts at once. */
r_if
c_cond
(paren
id|status
op_amp
id|RxEarly
)paren
(brace
multiline_comment|/* Rx early is unused. */
id|corkscrew_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
id|RxEarly
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|StatsFull
)paren
(brace
multiline_comment|/* Empty statistics. */
r_static
r_int
id|DoneDidThat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Updating stats.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* DEBUG HACK: Disable statistics as an interrupt source. */
multiline_comment|/* This occurs when we have the wrong media type! */
r_if
c_cond
(paren
id|DoneDidThat
op_eq
l_int|0
op_logical_and
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|StatsFull
)paren
(brace
r_int
id|win
comma
id|reg
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Updating stats failed, disabling stats as an&quot;
l_string|&quot; interrupt source.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|win
op_assign
l_int|0
suffix:semicolon
id|win
OL
l_int|8
suffix:semicolon
id|win
op_increment
)paren
(brace
id|EL3WINDOW
c_func
(paren
id|win
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n Vortex window %d:&quot;
comma
id|win
)paren
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
OL
l_int|16
suffix:semicolon
id|reg
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|reg
)paren
)paren
suffix:semicolon
)brace
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
id|TxAvailable
op_or
id|RxComplete
op_or
id|AdapterFailure
op_or
id|UpComplete
op_or
id|DownComplete
op_or
id|TxComplete
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|DoneDidThat
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|AdapterFailure
)paren
(brace
multiline_comment|/* Adapter failure requires Rx reset and reinit. */
id|outw
c_func
(paren
id|RxReset
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Set the Rx filter to the current state. */
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxEnable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Re-enable the receiver. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|AdapterFailure
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_decrement
id|i
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Too much work in interrupt, status %4.4x.  &quot;
l_string|&quot;Disabling functions (%4.4x).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|SetStatusEnb
op_or
(paren
(paren
op_complement
id|status
)paren
op_amp
l_int|0x7FE
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable all pending interrupts. */
id|outw
c_func
(paren
id|SetStatusEnb
op_or
(paren
(paren
op_complement
id|status
)paren
op_amp
l_int|0x7FE
)paren
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|AckIntr
op_or
l_int|0x7FF
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Acknowledge the IRQ. */
id|outw
c_func
(paren
id|AckIntr
op_or
id|IntReq
op_or
id|IntLatch
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
)paren
op_amp
(paren
id|IntLatch
op_or
id|RxComplete
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: exiting interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|corkscrew_rx
r_static
r_int
id|corkscrew_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;   In rx_packet(), status %4.4x, rx_status %4.4x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rx_status
op_amp
l_int|0x4000
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
r_char
id|rx_error
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|RxErrors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot; Rx error: status %2.2x.&bslash;n&quot;
comma
id|rx_error
)paren
suffix:semicolon
id|vp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x01
)paren
id|vp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x02
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x08
)paren
id|vp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x10
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The packet length: up to 4.5K!. */
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x1fff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|5
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb_put()&squot; points to the start of sk_buff data area. */
id|insl
c_func
(paren
id|ioaddr
op_plus
id|RX_FIFO
comma
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
(paren
id|pkt_len
op_plus
l_int|3
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Pop top Rx packet. */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|vp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|vp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Wait a limited time to go to next packet. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|corkscrew_debug
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Couldn&squot;t allocate a sk_buff of size %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pkt_len
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|RxDiscard
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|vp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Wait a limited time to skip this packet. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
op_amp
id|CmdInProgress
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|boomerang_rx
r_static
r_int
id|boomerang_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|vp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;   In boomerang_rx(), status %4.4x, rx_status %4.4x.&bslash;n&quot;
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rx_status
op_assign
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
)paren
op_amp
id|RxDComplete
)paren
(brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|RxDError
)paren
(brace
multiline_comment|/* Error, update stats. */
r_int
r_char
id|rx_error
op_assign
id|rx_status
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot; Rx error: status %2.2x.&bslash;n&quot;
comma
id|rx_error
)paren
suffix:semicolon
id|vp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x01
)paren
id|vp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x02
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x04
)paren
id|vp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x08
)paren
id|vp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_error
op_amp
l_int|0x10
)paren
id|vp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The packet length: up to 4.5K!. */
r_int
id|pkt_len
op_assign
id|rx_status
op_amp
l_int|0x1fff
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|vp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;Receiving packet size %d status %4.4x.&bslash;n&quot;
comma
id|pkt_len
comma
id|rx_status
)paren
suffix:semicolon
multiline_comment|/* Check if the packet is long enough to just accept without&n;&t;&t;&t;   copying to a properly sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|4
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
multiline_comment|/* &squot;skb_put()&squot; points to the start of sk_buff data area. */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|bus_to_virt
c_func
(paren
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
)paren
comma
id|pkt_len
)paren
suffix:semicolon
id|rx_copy
op_increment
suffix:semicolon
)brace
r_else
(brace
r_void
op_star
id|temp
suffix:semicolon
multiline_comment|/* Pass up the skbuff already on the Rx ring. */
id|skb
op_assign
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|temp
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Remove this checking code for final release. */
r_if
c_cond
(paren
id|bus_to_virt
c_func
(paren
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
)paren
op_ne
id|temp
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Warning -- the skbuff addresses do not match&quot;
l_string|&quot; in boomerang_rx: %p vs. %p / %p.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|bus_to_virt
c_func
(paren
id|vp
op_member_access_from_pointer
id|rx_ring
(braket
id|entry
)braket
dot
id|addr
)paren
comma
id|skb-&gt;head
comma
id|temp
)paren
suffix:semicolon
id|rx_nocopy
op_increment
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|vp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|vp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
id|vp-&gt;cur_rx
op_minus
id|vp-&gt;dirty_rx
OG
l_int|0
suffix:semicolon
id|vp-&gt;dirty_rx
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|vp-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Bad news!  */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;tail
)paren
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
)brace
id|vp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear complete bit. */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corkscrew_close
r_static
r_int
id|corkscrew_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: corkscrew_close() status %4.4x, Tx status %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|EL3_STATUS
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: corkscrew close stats: rx_nocopy %d rx_copy %d&quot;
l_string|&quot; tx_queued %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_nocopy
comma
id|rx_copy
comma
id|queued_packet
)paren
suffix:semicolon
)brace
id|del_timer
c_func
(paren
op_amp
id|vp-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Turn off statistics ASAP.  We update lp-&gt;stats below. */
id|outw
c_func
(paren
id|StatsDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
multiline_comment|/* Disable the receiver and transmitter. */
id|outw
c_func
(paren
id|RxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TxDisable
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
id|XCVR_10base2
)paren
multiline_comment|/* Turn off thinnet power.  Green! */
id|outw
c_func
(paren
id|StopCoax
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SetIntrEnb
op_or
l_int|0x0000
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|ioaddr
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_rx
)paren
(brace
multiline_comment|/* Free Boomerang bus master Rx buffers. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|UpListPtr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|vp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vp-&gt;full_bus_master_tx
)paren
(brace
multiline_comment|/* Free Boomerang bus master Tx buffers. */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DownListPtr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|vp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corkscrew_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|corkscrew_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|dev-&gt;base_addr
comma
id|dev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
op_amp
id|vp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*  Update statistics.&n;&t;Unlike with the EL3 we need not worry about interrupts changing&n;&t;the window setting from underneath us, but we must still guard&n;&t;against a race condition with a StatsUpdate interrupt updating the&n;&t;table.  This is done by checking that the ASM (!) code generated uses&n;&t;atomic updates with &squot;+=&squot;.&n;&t;*/
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_int
id|ioaddr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|corkscrew_private
op_star
id|vp
op_assign
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Unlike the 3c5x9 we need not turn off stats updates while reading. */
multiline_comment|/* Switch to the stats window, and read everything. */
id|EL3WINDOW
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|vp-&gt;stats.tx_carrier_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
suffix:semicolon
id|vp-&gt;stats.tx_heartbeat_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Multiple collisions. */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
suffix:semicolon
id|vp-&gt;stats.collisions
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
suffix:semicolon
id|vp-&gt;stats.tx_window_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
suffix:semicolon
id|vp-&gt;stats.rx_fifo_errors
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
suffix:semicolon
id|vp-&gt;stats.tx_packets
op_add_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
suffix:semicolon
id|vp-&gt;stats.tx_packets
op_add_assign
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|9
)paren
op_amp
l_int|0x30
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* Rx packets   */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Must read to clear */
multiline_comment|/* Tx deferrals */
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t bother with register 9, an extension of registers 6&amp;7.&n;&t;   If we do use the 6&amp;7 values the atomic update assumption above&n;&t;   is invalid. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Total Rx and Tx octets. */
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* New: On the Vortex we must also clear the BadSSD counter. */
id|EL3WINDOW
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* We change back to window 7 (not 1) with the Vortex. */
id|EL3WINDOW
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* This new version of set_rx_mode() supports v1.4 kernels.&n;   The Vortex chip has no documented multicast filter, so the only&n;   multicast setting is to receive all multicast frames.  At least&n;   the chip has a very clean way to set the mode, unlike many others. */
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|new_mode
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
r_if
c_cond
(paren
id|corkscrew_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Setting promiscuous mode.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|new_mode
op_assign
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
op_or
id|RxProm
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_list
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
id|new_mode
op_assign
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxMulticast
op_or
id|RxBroadcast
suffix:semicolon
)brace
r_else
id|new_mode
op_assign
id|SetRxFilter
op_or
id|RxStation
op_or
id|RxBroadcast
suffix:semicolon
id|outw
c_func
(paren
id|new_mode
comma
id|ioaddr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
)brace
"&f;"
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|next_dev
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_while
c_loop
(paren
id|root_corkscrew_dev
)paren
(brace
id|next_dev
op_assign
(paren
(paren
r_struct
id|corkscrew_private
op_star
)paren
id|root_corkscrew_dev
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|next_module
suffix:semicolon
r_if
c_cond
(paren
id|root_corkscrew_dev-&gt;dma
)paren
id|free_dma
c_func
(paren
id|root_corkscrew_dev-&gt;dma
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|root_corkscrew_dev
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TotalReset
comma
id|root_corkscrew_dev-&gt;base_addr
op_plus
id|EL3_CMD
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|root_corkscrew_dev-&gt;base_addr
comma
id|CORKSCREW_TOTAL_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root_corkscrew_dev
)paren
suffix:semicolon
id|root_corkscrew_dev
op_assign
id|next_dev
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -D__KERNEL__ -Wall -Wstrict-prototypes -O6 -c 3c515.c&quot;&n; *  c-indent-level: 4&n; *  tab-width: 4&n; * End:&n; */
eof
