multiline_comment|/*&n; *  linux/drivers/acorn/net/ether1.c&n; *&n; *  Copyright (C) 1996-2000 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  Acorn ether1 driver (82586 chip) for Acorn machines&n; *&n; * We basically keep two queues in the cards memory - one for transmit&n; * and one for receive.  Each has a head and a tail.  The head is where&n; * we/the chip adds packets to be transmitted/received, and the tail&n; * is where the transmitter has got to/where the receiver will stop.&n; * Both of these queues are circular, and since the chip is running&n; * all the time, we have to be careful when we modify the pointers etc&n; * so that the buffer memory contents is valid all the time.&n; *&n; * Change log:&n; * 1.00&t;RMK&t;&t;&t;Released&n; * 1.01&t;RMK&t;19/03/1996&t;Transfers the last odd byte onto/off of the card now.&n; * 1.02&t;RMK&t;25/05/1997&t;Added code to restart RU if it goes not ready&n; * 1.03&t;RMK&t;14/09/1997&t;Cleaned up the handling of a reset during the TX interrupt.&n; *&t;&t;&t;&t;Should prevent lockup.&n; * 1.04 RMK&t;17/09/1997&t;Added more info when initialsation of chip goes wrong.&n; *&t;&t;&t;&t;TDR now only reports failure when chip reports non-zero&n; *&t;&t;&t;&t;TDR time-distance.&n; * 1.05&t;RMK&t;31/12/1997&t;Removed calls to dev_tint for 2.1&n; * 1.06&t;RMK&t;10/02/2000&t;Updated for 2.3.43&n; * 1.07&t;RMK&t;13/05/2000&t;Updated for 2.3.99-pre8&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
DECL|macro|__ETHER1_C
mdefine_line|#define __ETHER1_C
macro_line|#include &quot;ether1.h&quot;
DECL|variable|net_debug
r_static
r_int
r_int
id|net_debug
op_assign
id|NET_DEBUG
suffix:semicolon
DECL|macro|BUFFER_SIZE
mdefine_line|#define BUFFER_SIZE&t;0x10000
DECL|macro|TX_AREA_START
mdefine_line|#define TX_AREA_START&t;0x00100
DECL|macro|TX_AREA_END
mdefine_line|#define TX_AREA_END&t;0x05000
DECL|macro|RX_AREA_START
mdefine_line|#define RX_AREA_START&t;0x05000
DECL|macro|RX_AREA_END
mdefine_line|#define RX_AREA_END&t;0x0fc00
r_static
r_int
id|ether1_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ether1_sendpacket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether1_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|ether1_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ether1_getstats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether1_setmulticastlist
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether1_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;ether1 ethernet driver (c) 2000 Russell King v1.07&bslash;n&quot;
suffix:semicolon
DECL|macro|BUS_16
mdefine_line|#define BUS_16 16
DECL|macro|BUS_8
mdefine_line|#define BUS_8  8
DECL|variable|ether1_cids
r_static
r_const
id|card_ids
id|__init
id|ether1_cids
(braket
)braket
op_assign
(brace
(brace
id|MANU_ACORN
comma
id|PROD_ACORN_ETHER1
)brace
comma
(brace
l_int|0xffff
comma
l_int|0xffff
)brace
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|macro|DISABLEIRQS
mdefine_line|#define DISABLEIRQS 1
DECL|macro|NORMALIRQS
mdefine_line|#define NORMALIRQS  0
DECL|macro|ether1_inw
mdefine_line|#define ether1_inw(dev, addr, type, offset, svflgs) ether1_inw_p (dev, addr + (int)(&amp;((type *)0)-&gt;offset), svflgs)
DECL|macro|ether1_outw
mdefine_line|#define ether1_outw(dev, val, addr, type, offset, svflgs) ether1_outw_p (dev, val, addr + (int)(&amp;((type *)0)-&gt;offset), svflgs)
r_static
r_inline
r_int
r_int
DECL|function|ether1_inw_p
id|ether1_inw_p
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|addr
comma
r_int
id|svflgs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|svflgs
)paren
(brace
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
)brace
id|outb
(paren
id|addr
op_rshift
l_int|12
comma
id|REG_PAGE
)paren
suffix:semicolon
id|ret
op_assign
id|inw
(paren
id|ETHER1_RAM
op_plus
(paren
(paren
id|addr
op_amp
l_int|4095
)paren
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svflgs
)paren
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ether1_outw_p
id|ether1_outw_p
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|val
comma
r_int
id|addr
comma
r_int
id|svflgs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|svflgs
)paren
(brace
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
)brace
id|outb
(paren
id|addr
op_rshift
l_int|12
comma
id|REG_PAGE
)paren
suffix:semicolon
id|outw
(paren
id|val
comma
id|ETHER1_RAM
op_plus
(paren
(paren
id|addr
op_amp
l_int|4095
)paren
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svflgs
)paren
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Some inline assembler to allow fast transfers on to/off of the card.&n; * Since this driver depends on some features presented by the ARM&n; * specific architecture, and that you can&squot;t configure this driver&n; * without specifiing ARM mode, this is not a problem.&n; *&n; * This routine is essentially an optimised memcpy from the card&squot;s&n; * onboard RAM to kernel memory.&n; */
r_static
r_void
DECL|function|ether1_writebuffer
id|ether1_writebuffer
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|data
comma
r_int
r_int
id|start
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|page
comma
id|thislen
comma
id|offset
comma
id|addr
suffix:semicolon
id|offset
op_assign
id|start
op_amp
l_int|4095
suffix:semicolon
id|page
op_assign
id|start
op_rshift
l_int|12
suffix:semicolon
id|addr
op_assign
id|ioaddr
c_func
(paren
id|ETHER1_RAM
op_plus
(paren
id|offset
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_plus
id|length
OG
l_int|4096
)paren
id|thislen
op_assign
l_int|4096
op_minus
id|offset
suffix:semicolon
r_else
id|thislen
op_assign
id|length
suffix:semicolon
r_do
(brace
r_int
id|used
suffix:semicolon
id|outb
c_func
(paren
id|page
comma
id|REG_PAGE
)paren
suffix:semicolon
id|length
op_sub_assign
id|thislen
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
l_int|1
suffix:colon
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#2
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsl
macro_line|#16
id|orr
op_mod
l_int|0
comma
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#16
id|str
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#2
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsl
macro_line|#16
id|orr
op_mod
l_int|0
comma
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#16
id|str
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#2
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsl
macro_line|#16
id|orr
op_mod
l_int|0
comma
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#16
id|str
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#2
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsl
macro_line|#16
id|orr
op_mod
l_int|0
comma
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#16
id|str
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bpl
l_int|1
id|b
l_int|2
suffix:colon
id|adds
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#1
id|ldreqb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
id|streqb
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
"&quot;"
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|used
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|data
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;r&quot;
(paren
id|thislen
)paren
comma
l_string|&quot;1&quot;
(paren
id|data
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|ioaddr
c_func
(paren
id|ETHER1_RAM
)paren
suffix:semicolon
id|thislen
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|thislen
OG
l_int|4096
)paren
id|thislen
op_assign
l_int|4096
suffix:semicolon
id|page
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|thislen
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether1_readbuffer
id|ether1_readbuffer
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|data
comma
r_int
r_int
id|start
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|page
comma
id|thislen
comma
id|offset
comma
id|addr
suffix:semicolon
id|offset
op_assign
id|start
op_amp
l_int|4095
suffix:semicolon
id|page
op_assign
id|start
op_rshift
l_int|12
suffix:semicolon
id|addr
op_assign
id|ioaddr
c_func
(paren
id|ETHER1_RAM
op_plus
(paren
id|offset
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_plus
id|length
OG
l_int|4096
)paren
id|thislen
op_assign
l_int|4096
op_minus
id|offset
suffix:semicolon
r_else
id|thislen
op_assign
id|length
suffix:semicolon
r_do
(brace
r_int
id|used
suffix:semicolon
id|outb
c_func
(paren
id|page
comma
id|REG_PAGE
)paren
suffix:semicolon
id|length
op_sub_assign
id|thislen
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
l_int|1
suffix:colon
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#8
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#8
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#8
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bmi
l_float|2f
id|ldr
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
comma
macro_line|#4
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|mov
op_mod
l_int|0
comma
op_mod
l_int|0
comma
id|lsr
macro_line|#8
id|strb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
comma
macro_line|#1
id|subs
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#2
id|bpl
l_int|1
id|b
l_int|2
suffix:colon
id|adds
op_mod
l_int|3
comma
op_mod
l_int|3
comma
macro_line|#1
id|ldreqb
op_mod
l_int|0
comma
(braket
op_mod
l_int|2
)braket
id|streqb
op_mod
l_int|0
comma
(braket
op_mod
l_int|1
)braket
"&quot;"
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|used
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|data
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;r&quot;
(paren
id|thislen
)paren
comma
l_string|&quot;1&quot;
(paren
id|data
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|ioaddr
c_func
(paren
id|ETHER1_RAM
)paren
suffix:semicolon
id|thislen
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|thislen
OG
l_int|4096
)paren
id|thislen
op_assign
l_int|4096
suffix:semicolon
id|page
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|thislen
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|ether1_ramtest
id|ether1_ramtest
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
id|byte
)paren
(brace
r_int
r_char
op_star
id|buffer
op_assign
id|kmalloc
(paren
id|BUFFER_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
id|BUFFER_SIZE
suffix:semicolon
r_int
id|max_errors
op_assign
l_int|15
suffix:semicolon
r_int
id|bad
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|bad_start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
l_int|1
suffix:semicolon
id|memset
(paren
id|buffer
comma
id|byte
comma
id|BUFFER_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
id|buffer
comma
l_int|0
comma
id|BUFFER_SIZE
)paren
suffix:semicolon
id|memset
(paren
id|buffer
comma
id|byte
op_xor
l_int|0xff
comma
id|BUFFER_SIZE
)paren
suffix:semicolon
id|ether1_readbuffer
(paren
id|dev
comma
id|buffer
comma
l_int|0
comma
id|BUFFER_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BUFFER_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
id|byte
)paren
(brace
r_if
c_cond
(paren
id|max_errors
op_ge
l_int|0
op_logical_and
id|bad
op_ne
id|buffer
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|bad
op_ne
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;%s: RAM failed with (%02X instead of %02X) at 0x%04X&quot;
comma
id|dev-&gt;name
comma
id|buffer
(braket
id|i
)braket
comma
id|byte
comma
id|i
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|max_errors
op_decrement
suffix:semicolon
id|bad
op_assign
id|buffer
(braket
id|i
)braket
suffix:semicolon
id|bad_start
op_assign
id|i
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|bad
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|bad_start
op_eq
id|i
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot; - 0x%04X&bslash;n&quot;
comma
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|bad
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|bad
op_ne
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot; - 0x%04X&bslash;n&quot;
comma
id|BUFFER_SIZE
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|ether1_reset
id|ether1_reset
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|outb
(paren
id|CTRL_RST
op_or
id|CTRL_ACK
comma
id|REG_CONTROL
)paren
suffix:semicolon
r_return
id|BUS_16
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|ether1_init_2
id|ether1_init_2
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|dev-&gt;mem_start
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|ether1_ramtest
(paren
id|dev
comma
l_int|0x5a
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
id|i
op_assign
id|ether1_ramtest
(paren
id|dev
comma
l_int|0x1e
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_le
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * These are the structures that are loaded into the ether RAM card to&n; * initialise the 82586&n; */
multiline_comment|/* at 0x0100 */
DECL|macro|NOP_ADDR
mdefine_line|#define NOP_ADDR&t;(TX_AREA_START)
DECL|macro|NOP_SIZE
mdefine_line|#define NOP_SIZE&t;(0x06)
DECL|variable|init_nop
r_static
id|nop_t
id|init_nop
op_assign
(brace
l_int|0
comma
id|CMD_NOP
comma
id|NOP_ADDR
)brace
suffix:semicolon
multiline_comment|/* at 0x003a */
DECL|macro|TDR_ADDR
mdefine_line|#define TDR_ADDR&t;(0x003a)
DECL|macro|TDR_SIZE
mdefine_line|#define TDR_SIZE&t;(0x08)
DECL|variable|init_tdr
r_static
id|tdr_t
id|init_tdr
op_assign
(brace
l_int|0
comma
id|CMD_TDR
op_or
id|CMD_INTR
comma
id|NOP_ADDR
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* at 0x002e */
DECL|macro|MC_ADDR
mdefine_line|#define MC_ADDR&t;&t;(0x002e)
DECL|macro|MC_SIZE
mdefine_line|#define MC_SIZE&t;&t;(0x0c)
DECL|variable|init_mc
r_static
id|mc_t
id|init_mc
op_assign
(brace
l_int|0
comma
id|CMD_SETMULTICAST
comma
id|TDR_ADDR
comma
l_int|0
comma
(brace
(brace
l_int|0
comma
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* at 0x0022 */
DECL|macro|SA_ADDR
mdefine_line|#define SA_ADDR&t;&t;(0x0022)
DECL|macro|SA_SIZE
mdefine_line|#define SA_SIZE&t;&t;(0x0c)
DECL|variable|init_sa
r_static
id|sa_t
id|init_sa
op_assign
(brace
l_int|0
comma
id|CMD_SETADDRESS
comma
id|MC_ADDR
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* at 0x0010 */
DECL|macro|CFG_ADDR
mdefine_line|#define CFG_ADDR&t;(0x0010)
DECL|macro|CFG_SIZE
mdefine_line|#define CFG_SIZE&t;(0x12)
DECL|variable|init_cfg
r_static
id|cfg_t
id|init_cfg
op_assign
(brace
l_int|0
comma
id|CMD_CONFIG
comma
id|SA_ADDR
comma
l_int|8
comma
l_int|8
comma
id|CFG8_SRDY
comma
id|CFG9_PREAMB8
op_or
id|CFG9_ADDRLENBUF
op_or
id|CFG9_ADDRLEN
c_func
(paren
l_int|6
)paren
comma
l_int|0
comma
l_int|0x60
comma
l_int|0
comma
id|CFG13_RETRY
c_func
(paren
l_int|15
)paren
op_or
id|CFG13_SLOTH
c_func
(paren
l_int|2
)paren
comma
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* at 0x0000 */
DECL|macro|SCB_ADDR
mdefine_line|#define SCB_ADDR&t;(0x0000)
DECL|macro|SCB_SIZE
mdefine_line|#define SCB_SIZE&t;(0x10)
DECL|variable|init_scb
r_static
id|scb_t
id|init_scb
op_assign
(brace
l_int|0
comma
id|SCB_CMDACKRNR
op_or
id|SCB_CMDACKCNA
op_or
id|SCB_CMDACKFR
op_or
id|SCB_CMDACKCX
comma
id|CFG_ADDR
comma
id|RX_AREA_START
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* at 0xffee */
DECL|macro|ISCP_ADDR
mdefine_line|#define ISCP_ADDR&t;(0xffee)
DECL|macro|ISCP_SIZE
mdefine_line|#define ISCP_SIZE&t;(0x08)
DECL|variable|init_iscp
r_static
id|iscp_t
id|init_iscp
op_assign
(brace
l_int|1
comma
id|SCB_ADDR
comma
l_int|0x0000
comma
l_int|0x0000
)brace
suffix:semicolon
multiline_comment|/* at 0xfff6 */
DECL|macro|SCP_ADDR
mdefine_line|#define SCP_ADDR&t;(0xfff6)
DECL|macro|SCP_SIZE
mdefine_line|#define SCP_SIZE&t;(0x0a)
DECL|variable|init_scp
r_static
id|scp_t
id|init_scp
op_assign
(brace
id|SCP_SY_16BBUS
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
id|ISCP_ADDR
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|RFD_SIZE
mdefine_line|#define RFD_SIZE&t;(0x16)
DECL|variable|init_rfd
r_static
id|rfd_t
id|init_rfd
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|RBD_SIZE
mdefine_line|#define RBD_SIZE&t;(0x0a)
DECL|variable|init_rbd
r_static
id|rbd_t
id|init_rbd
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|ETH_FRAME_LEN
op_plus
l_int|8
)brace
suffix:semicolon
DECL|macro|TX_SIZE
mdefine_line|#define TX_SIZE&t;&t;(0x08)
DECL|macro|TBD_SIZE
mdefine_line|#define TBD_SIZE&t;(0x08)
r_static
r_int
DECL|function|ether1_init_for_open
id|ether1_init_for_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|status
comma
id|addr
comma
id|next
comma
id|next2
suffix:semicolon
r_int
id|failures
op_assign
l_int|0
suffix:semicolon
id|outb
(paren
id|CTRL_RST
op_or
id|CTRL_ACK
comma
id|REG_CONTROL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|init_sa.sa_addr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* load data structures into ether1 RAM */
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_scp
comma
id|SCP_ADDR
comma
id|SCP_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_iscp
comma
id|ISCP_ADDR
comma
id|ISCP_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_scb
comma
id|SCB_ADDR
comma
id|SCB_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_cfg
comma
id|CFG_ADDR
comma
id|CFG_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_sa
comma
id|SA_ADDR
comma
id|SA_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_mc
comma
id|MC_ADDR
comma
id|MC_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_tdr
comma
id|TDR_ADDR
comma
id|TDR_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_nop
comma
id|NOP_ADDR
comma
id|NOP_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ether1_inw
(paren
id|dev
comma
id|CFG_ADDR
comma
id|cfg_t
comma
id|cfg_command
comma
id|NORMALIRQS
)paren
op_ne
id|CMD_CONFIG
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: detected either RAM fault or compiler bug&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * setup circularly linked list of { rfd, rbd, buffer }, with&n;&t; * all rfds circularly linked, rbds circularly linked.&n;&t; * First rfd is linked to scp, first rbd is linked to first&n;&t; * rfd.  Last rbd has a suspend command.&n;&t; */
id|addr
op_assign
id|RX_AREA_START
suffix:semicolon
r_do
(brace
id|next
op_assign
id|addr
op_plus
id|RFD_SIZE
op_plus
id|RBD_SIZE
op_plus
id|ETH_FRAME_LEN
op_plus
l_int|10
suffix:semicolon
id|next2
op_assign
id|next
op_plus
id|RFD_SIZE
op_plus
id|RBD_SIZE
op_plus
id|ETH_FRAME_LEN
op_plus
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|next2
op_ge
id|RX_AREA_END
)paren
(brace
id|next
op_assign
id|RX_AREA_START
suffix:semicolon
id|init_rfd.rfd_command
op_assign
id|RFD_CMDEL
op_or
id|RFD_CMDSUSPEND
suffix:semicolon
id|priv-&gt;rx_tail
op_assign
id|addr
suffix:semicolon
)brace
r_else
id|init_rfd.rfd_command
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|RX_AREA_START
)paren
id|init_rfd.rfd_rbdoffset
op_assign
id|addr
op_plus
id|RFD_SIZE
suffix:semicolon
r_else
id|init_rfd.rfd_rbdoffset
op_assign
l_int|0
suffix:semicolon
id|init_rfd.rfd_link
op_assign
id|next
suffix:semicolon
id|init_rbd.rbd_link
op_assign
id|next
op_plus
id|RFD_SIZE
suffix:semicolon
id|init_rbd.rbd_bufl
op_assign
id|addr
op_plus
id|RFD_SIZE
op_plus
id|RBD_SIZE
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_rfd
comma
id|addr
comma
id|RFD_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|init_rbd
comma
id|addr
op_plus
id|RFD_SIZE
comma
id|RBD_SIZE
)paren
suffix:semicolon
id|addr
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|next2
OL
id|RX_AREA_END
)paren
suffix:semicolon
id|priv-&gt;tx_link
op_assign
id|NOP_ADDR
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|NOP_ADDR
op_plus
id|NOP_SIZE
suffix:semicolon
id|priv-&gt;tx_tail
op_assign
id|TDR_ADDR
suffix:semicolon
id|priv-&gt;rx_head
op_assign
id|RX_AREA_START
suffix:semicolon
multiline_comment|/* release reset &amp; give 586 a prod */
id|priv-&gt;resetting
op_assign
l_int|1
suffix:semicolon
id|priv-&gt;initialising
op_assign
l_int|1
suffix:semicolon
id|outb
(paren
id|CTRL_RST
comma
id|REG_CONTROL
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|REG_CONTROL
)paren
suffix:semicolon
id|outb
(paren
id|CTRL_CA
comma
id|REG_CONTROL
)paren
suffix:semicolon
multiline_comment|/* 586 should now unset iscp.busy */
id|i
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|ether1_inw
(paren
id|dev
comma
id|ISCP_ADDR
comma
id|iscp_t
comma
id|iscp_busy
comma
id|DISABLEIRQS
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|i
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t initialise 82586: iscp is busy&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* check status of commands that we issued */
id|i
op_add_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|CFG_ADDR
comma
id|cfg_t
comma
id|cfg_status
comma
id|DISABLEIRQS
)paren
)paren
op_amp
id|STAT_COMPLETE
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|i
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
op_ne
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t initialise 82586: config status %04X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_cbl_offset
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_rfa_offset
comma
id|NORMALIRQS
)paren
)paren
suffix:semicolon
id|failures
op_add_assign
l_int|1
suffix:semicolon
)brace
id|i
op_add_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|SA_ADDR
comma
id|sa_t
comma
id|sa_status
comma
id|DISABLEIRQS
)paren
)paren
op_amp
id|STAT_COMPLETE
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|i
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
op_ne
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t initialise 82586: set address status %04X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_cbl_offset
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_rfa_offset
comma
id|NORMALIRQS
)paren
)paren
suffix:semicolon
id|failures
op_add_assign
l_int|1
suffix:semicolon
)brace
id|i
op_add_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|MC_ADDR
comma
id|mc_t
comma
id|mc_status
comma
id|DISABLEIRQS
)paren
)paren
op_amp
id|STAT_COMPLETE
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|i
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
op_ne
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t initialise 82586: set multicast status %04X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_cbl_offset
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_rfa_offset
comma
id|NORMALIRQS
)paren
)paren
suffix:semicolon
id|failures
op_add_assign
l_int|1
suffix:semicolon
)brace
id|i
op_add_assign
id|HZ
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|TDR_ADDR
comma
id|tdr_t
comma
id|tdr_status
comma
id|DISABLEIRQS
)paren
)paren
op_amp
id|STAT_COMPLETE
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|i
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
op_ne
(paren
id|STAT_COMPLETE
op_or
id|STAT_OK
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: can&squot;t tdr (ignored)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_cbl_offset
comma
id|NORMALIRQS
)paren
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_rfa_offset
comma
id|NORMALIRQS
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|TDR_ADDR
comma
id|tdr_t
comma
id|tdr_result
comma
id|DISABLEIRQS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TDR_XCVRPROB
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: i/f failed tdr: transceiver problem&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|TDR_SHORT
op_or
id|TDR_OPEN
)paren
)paren
op_logical_and
(paren
id|status
op_amp
id|TDR_TIME
)paren
)paren
(brace
macro_line|#ifdef FANCY
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: i/f failed tdr: cable %s %d.%d us away&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
op_amp
id|TDR_SHORT
ques
c_cond
l_string|&quot;short&quot;
suffix:colon
l_string|&quot;open&quot;
comma
(paren
id|status
op_amp
id|TDR_TIME
)paren
op_div
l_int|10
comma
(paren
id|status
op_amp
id|TDR_TIME
)paren
op_mod
l_int|10
)paren
suffix:semicolon
macro_line|#else
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: i/f failed tdr: cable %s %d clks away&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
op_amp
id|TDR_SHORT
ques
c_cond
l_string|&quot;short&quot;
suffix:colon
l_string|&quot;open&quot;
comma
(paren
id|status
op_amp
id|TDR_TIME
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|failures
)paren
id|ether1_reset
(paren
id|dev
)paren
suffix:semicolon
r_return
id|failures
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
r_static
r_int
DECL|function|ether1_txalloc
id|ether1_txalloc
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|size
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|start
comma
id|tail
suffix:semicolon
id|size
op_assign
(paren
id|size
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
id|tail
op_assign
id|priv-&gt;tx_tail
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_head
op_plus
id|size
OG
id|TX_AREA_END
)paren
(brace
r_if
c_cond
(paren
id|tail
OG
id|priv-&gt;tx_head
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|start
op_assign
id|TX_AREA_START
suffix:semicolon
r_if
c_cond
(paren
id|start
op_plus
id|size
OG
id|tail
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|start
op_plus
id|size
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|priv-&gt;tx_head
template_param
id|tail
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|start
op_assign
id|priv-&gt;tx_head
suffix:semicolon
id|priv-&gt;tx_head
op_add_assign
id|size
suffix:semicolon
)brace
r_return
id|start
suffix:semicolon
)brace
r_static
r_int
DECL|function|ether1_open
id|ether1_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ether1_interrupt
comma
l_int|0
comma
l_string|&quot;ether1&quot;
comma
id|dev
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|memset
(paren
op_amp
id|priv-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ether1_init_for_open
(paren
id|dev
)paren
)paren
(brace
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether1_timeout
id|ether1_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timeout, network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: resetting device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ether1_reset
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ether1_init_for_open
(paren
id|dev
)paren
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: unable to restart interface&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ether1_sendpacket
id|ether1_sendpacket
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
op_assign
(paren
id|ETH_ZLEN
OL
id|skb-&gt;len
)paren
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
id|tmp
comma
id|tst
comma
id|nopaddr
comma
id|txaddr
comma
id|tbdaddr
comma
id|dataddr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|tx_t
id|tx
suffix:semicolon
id|tbd_t
id|tbd
suffix:semicolon
id|nop_t
id|nop
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;restart
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: resetting device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ether1_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ether1_init_for_open
c_func
(paren
id|dev
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to restart interface&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|priv-&gt;restart
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * insert packet followed by a nop&n;&t; */
id|txaddr
op_assign
id|ether1_txalloc
(paren
id|dev
comma
id|TX_SIZE
)paren
suffix:semicolon
id|tbdaddr
op_assign
id|ether1_txalloc
(paren
id|dev
comma
id|TBD_SIZE
)paren
suffix:semicolon
id|dataddr
op_assign
id|ether1_txalloc
(paren
id|dev
comma
id|len
)paren
suffix:semicolon
id|nopaddr
op_assign
id|ether1_txalloc
(paren
id|dev
comma
id|NOP_SIZE
)paren
suffix:semicolon
id|tx.tx_status
op_assign
l_int|0
suffix:semicolon
id|tx.tx_command
op_assign
id|CMD_TX
op_or
id|CMD_INTR
suffix:semicolon
id|tx.tx_link
op_assign
id|nopaddr
suffix:semicolon
id|tx.tx_tbdoffset
op_assign
id|tbdaddr
suffix:semicolon
id|tbd.tbd_opts
op_assign
id|TBD_EOL
op_or
id|len
suffix:semicolon
id|tbd.tbd_link
op_assign
id|I82586_NULL
suffix:semicolon
id|tbd.tbd_bufl
op_assign
id|dataddr
suffix:semicolon
id|tbd.tbd_bufh
op_assign
l_int|0
suffix:semicolon
id|nop.nop_status
op_assign
l_int|0
suffix:semicolon
id|nop.nop_command
op_assign
id|CMD_NOP
suffix:semicolon
id|nop.nop_link
op_assign
id|nopaddr
suffix:semicolon
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|tx
comma
id|txaddr
comma
id|TX_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|tbd
comma
id|tbdaddr
comma
id|TBD_SIZE
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
id|skb-&gt;data
comma
id|dataddr
comma
id|len
)paren
suffix:semicolon
id|ether1_writebuffer
(paren
id|dev
comma
op_amp
id|nop
comma
id|nopaddr
comma
id|NOP_SIZE
)paren
suffix:semicolon
id|tmp
op_assign
id|priv-&gt;tx_link
suffix:semicolon
id|priv-&gt;tx_link
op_assign
id|nopaddr
suffix:semicolon
multiline_comment|/* now reset the previous nop pointer */
id|ether1_outw
(paren
id|dev
comma
id|txaddr
comma
id|tmp
comma
id|nop_t
comma
id|nop_link
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* handle transmit */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* check to see if we have room for a full sized ether frame */
id|tmp
op_assign
id|priv-&gt;tx_head
suffix:semicolon
id|tst
op_assign
id|ether1_txalloc
(paren
id|dev
comma
id|TX_SIZE
op_plus
id|TBD_SIZE
op_plus
id|NOP_SIZE
op_plus
id|ETH_FRAME_LEN
)paren
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|tmp
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tst
op_eq
op_minus
l_int|1
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether1_xmit_done
id|ether1_xmit_done
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|nop_t
id|nop
suffix:semicolon
r_int
id|caddr
comma
id|tst
suffix:semicolon
id|caddr
op_assign
id|priv-&gt;tx_tail
suffix:semicolon
id|again
suffix:colon
id|ether1_readbuffer
(paren
id|dev
comma
op_amp
id|nop
comma
id|caddr
comma
id|NOP_SIZE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|nop.nop_command
op_amp
id|CMD_MASK
)paren
(brace
r_case
id|CMD_TDR
suffix:colon
multiline_comment|/* special case */
r_if
c_cond
(paren
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_cbl_offset
comma
id|NORMALIRQS
)paren
op_ne
(paren
r_int
r_int
)paren
id|I82586_NULL
)paren
(brace
id|ether1_outw
c_func
(paren
id|dev
comma
id|SCB_CMDCUCSTART
op_or
id|SCB_CMDRXSTART
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|outb
(paren
id|CTRL_CA
comma
id|REG_CONTROL
)paren
suffix:semicolon
)brace
id|priv-&gt;tx_tail
op_assign
id|NOP_ADDR
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CMD_NOP
suffix:colon
r_if
c_cond
(paren
id|nop.nop_link
op_eq
id|caddr
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;initialising
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: strange command complete with no tx command!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|priv-&gt;initialising
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|caddr
op_eq
id|nop.nop_link
)paren
r_return
suffix:semicolon
id|caddr
op_assign
id|nop.nop_link
suffix:semicolon
r_goto
id|again
suffix:semicolon
r_case
id|CMD_TX
suffix:colon
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_COMPLETE
)paren
r_break
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: strange command complete without completed command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;restart
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: strange command %d complete! (offset %04X)&quot;
comma
id|dev-&gt;name
comma
id|nop.nop_command
op_amp
id|CMD_MASK
comma
id|caddr
)paren
suffix:semicolon
id|priv-&gt;restart
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nop.nop_status
op_amp
id|STAT_COMPLETE
)paren
(brace
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_OK
)paren
(brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.collisions
op_add_assign
(paren
id|nop.nop_status
op_amp
id|STAT_COLLISIONS
)paren
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_COLLAFTERTX
)paren
id|priv-&gt;stats.collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_NOCARRIER
)paren
id|priv-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_TXLOSTCTS
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: cts lost&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_TXSLOWDMA
)paren
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nop.nop_status
op_amp
id|STAT_COLLEXCESSIVE
)paren
id|priv-&gt;stats.collisions
op_add_assign
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nop.nop_link
op_eq
id|caddr
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: tx buffer chaining error: tx command points to itself&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|caddr
op_assign
id|nop.nop_link
suffix:semicolon
id|ether1_readbuffer
(paren
id|dev
comma
op_amp
id|nop
comma
id|caddr
comma
id|NOP_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nop.nop_command
op_amp
id|CMD_MASK
)paren
op_ne
id|CMD_NOP
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: tx buffer chaining error: no nop after tx command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|caddr
op_eq
id|nop.nop_link
)paren
r_break
suffix:semicolon
id|caddr
op_assign
id|nop.nop_link
suffix:semicolon
id|ether1_readbuffer
(paren
id|dev
comma
op_amp
id|nop
comma
id|caddr
comma
id|NOP_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nop.nop_command
op_amp
id|CMD_MASK
)paren
op_ne
id|CMD_TX
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: tx buffer chaining error: no tx command after nop&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|priv-&gt;tx_tail
op_assign
id|caddr
suffix:semicolon
id|caddr
op_assign
id|priv-&gt;tx_head
suffix:semicolon
id|tst
op_assign
id|ether1_txalloc
(paren
id|dev
comma
id|TX_SIZE
op_plus
id|TBD_SIZE
op_plus
id|NOP_SIZE
op_plus
id|ETH_FRAME_LEN
)paren
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|caddr
suffix:semicolon
r_if
c_cond
(paren
id|tst
op_ne
op_minus
l_int|1
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether1_recv_done
id|ether1_recv_done
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|nexttail
comma
id|rbdaddr
suffix:semicolon
id|rbd_t
id|rbd
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|priv-&gt;rx_head
comma
id|rfd_t
comma
id|rfd_status
comma
id|NORMALIRQS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RFD_COMPLETE
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|rbdaddr
op_assign
id|ether1_inw
(paren
id|dev
comma
id|priv-&gt;rx_head
comma
id|rfd_t
comma
id|rfd_rbdoffset
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|ether1_readbuffer
(paren
id|dev
comma
op_amp
id|rbd
comma
id|rbdaddr
comma
id|RBD_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rbd.rbd_status
op_amp
(paren
id|RBD_EOF
op_or
id|RBD_ACNTVALID
)paren
)paren
op_eq
(paren
id|RBD_EOF
op_or
id|RBD_ACNTVALID
)paren
)paren
(brace
r_int
id|length
op_assign
id|rbd.rbd_status
op_amp
id|RBD_ACNT
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|length
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
(paren
id|length
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|ether1_readbuffer
(paren
id|dev
comma
id|skb_put
(paren
id|skb
comma
id|length
)paren
comma
id|rbd.rbd_bufl
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|rbd.rbd_status
op_amp
id|RBD_EOF
)paren
ques
c_cond
l_string|&quot;oversized packet&quot;
suffix:colon
l_string|&quot;acnt not valid&quot;
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
id|nexttail
op_assign
id|ether1_inw
(paren
id|dev
comma
id|priv-&gt;rx_tail
comma
id|rfd_t
comma
id|rfd_link
comma
id|NORMALIRQS
)paren
suffix:semicolon
multiline_comment|/* nexttail should be rx_head */
r_if
c_cond
(paren
id|nexttail
op_ne
id|priv-&gt;rx_head
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: receiver buffer chaining error (%04X != %04X)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|nexttail
comma
id|priv-&gt;rx_head
)paren
suffix:semicolon
id|ether1_outw
(paren
id|dev
comma
id|RFD_CMDEL
op_or
id|RFD_CMDSUSPEND
comma
id|nexttail
comma
id|rfd_t
comma
id|rfd_command
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|ether1_outw
(paren
id|dev
comma
l_int|0
comma
id|priv-&gt;rx_tail
comma
id|rfd_t
comma
id|rfd_command
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|ether1_outw
(paren
id|dev
comma
l_int|0
comma
id|priv-&gt;rx_tail
comma
id|rfd_t
comma
id|rfd_status
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|ether1_outw
(paren
id|dev
comma
l_int|0
comma
id|priv-&gt;rx_tail
comma
id|rfd_t
comma
id|rfd_rbdoffset
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|priv-&gt;rx_tail
op_assign
id|nexttail
suffix:semicolon
id|priv-&gt;rx_head
op_assign
id|ether1_inw
(paren
id|dev
comma
id|priv-&gt;rx_head
comma
id|rfd_t
comma
id|rfd_link
comma
id|NORMALIRQS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether1_interrupt
id|ether1_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|ether1_outw
c_func
(paren
id|dev
comma
id|status
op_amp
(paren
id|SCB_STRNR
op_or
id|SCB_STCNA
op_or
id|SCB_STFR
op_or
id|SCB_STCX
)paren
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|outb
(paren
id|CTRL_CA
op_or
id|CTRL_ACK
comma
id|REG_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCB_STCX
)paren
(brace
id|ether1_xmit_done
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCB_STCNA
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;resetting
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: CU went not ready ???&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|priv-&gt;resetting
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_cbl_offset
comma
id|NORMALIRQS
)paren
op_ne
(paren
r_int
r_int
)paren
id|I82586_NULL
)paren
(brace
id|ether1_outw
(paren
id|dev
comma
id|SCB_CMDCUCSTART
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|outb
(paren
id|CTRL_CA
comma
id|REG_CONTROL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;resetting
op_eq
l_int|2
)paren
id|priv-&gt;resetting
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCB_STFR
)paren
(brace
id|ether1_recv_done
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCB_STRNR
)paren
(brace
r_if
c_cond
(paren
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
op_amp
id|SCB_STRXSUSP
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: RU went not ready: RU suspended&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ether1_outw
(paren
id|dev
comma
id|SCB_CMDRXRESUME
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_command
comma
id|NORMALIRQS
)paren
suffix:semicolon
id|outb
(paren
id|CTRL_CA
comma
id|REG_CONTROL
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
multiline_comment|/* we suspended due to lack of buffer space */
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: RU went not ready: %04X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_status
comma
id|NORMALIRQS
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;RU ptr = %04X&bslash;n&quot;
comma
id|ether1_inw
(paren
id|dev
comma
id|SCB_ADDR
comma
id|scb_t
comma
id|scb_rfa_offset
comma
id|NORMALIRQS
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
id|outb
(paren
id|CTRL_ACK
comma
id|REG_CONTROL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ether1_close
id|ether1_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ether1_reset
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|ether1_getstats
id|ether1_getstats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ether1_priv
op_star
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear the multicast filter for this adaptor.&n; * num_addrs == -1&t;Promiscuous mode, receive all packets.&n; * num_addrs == 0&t;Normal mode, clear multicast list.&n; * num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets, and do&n; *&t;&t;&t;best-effort filtering.&n; */
r_static
r_void
DECL|function|ether1_setmulticastlist
id|ether1_setmulticastlist
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|function|ether1_banner
r_static
r_void
id|__init
id|ether1_banner
c_func
(paren
r_void
)paren
(brace
r_static
r_int
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
)brace
DECL|function|ether1_init_one
r_static
r_struct
id|net_device
op_star
id|__init
id|ether1_init_one
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ether1_priv
op_star
id|priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ether1_banner
c_func
(paren
)paren
suffix:semicolon
id|ecard_claim
c_func
(paren
id|ec
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|ether1_priv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_IOC
comma
id|ECARD_FAST
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|ec-&gt;irq
suffix:semicolon
multiline_comment|/*&n;&t; * these will not fail - the nature of the bus ensures this&n;&t; */
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|16
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0x800
comma
l_int|4096
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|ether1_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;bus_type
op_assign
id|ether1_reset
c_func
(paren
id|dev
)paren
)paren
op_eq
l_int|0
)paren
r_goto
id|free_dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ether1 at %lx, IRQ%d, ether address &quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|IDPROM_ADDRESS
op_plus
id|i
)paren
suffix:semicolon
id|printk
(paren
id|i
op_eq
l_int|0
ques
c_cond
l_string|&quot; %02x&quot;
suffix:colon
id|i
op_eq
l_int|5
ques
c_cond
l_string|&quot;:%02x&bslash;n&quot;
suffix:colon
l_string|&quot;:%02x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ether1_init_2
c_func
(paren
id|dev
)paren
)paren
r_goto
id|free_dev
suffix:semicolon
id|dev-&gt;open
op_assign
id|ether1_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ether1_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ether1_sendpacket
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ether1_getstats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ether1_setmulticastlist
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ether1_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_dev
suffix:colon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|16
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
op_plus
l_int|0x800
comma
l_int|4096
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
id|ecard_release
c_func
(paren
id|ec
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
DECL|variable|e_card
r_static
r_struct
id|expansion_card
op_star
id|e_card
(braket
id|MAX_ECARDS
)braket
suffix:semicolon
DECL|variable|e_dev
r_static
r_struct
id|net_device
op_star
id|e_dev
(braket
id|MAX_ECARDS
)braket
suffix:semicolon
DECL|function|ether1_init
r_static
r_int
id|__init
id|ether1_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|ecard_startfind
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|expansion_card
op_star
id|ec
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|ec
op_assign
id|ecard_find
c_func
(paren
l_int|0
comma
id|ether1_cids
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|ether1_init_one
c_func
(paren
id|ec
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_break
suffix:semicolon
id|e_card
(braket
id|i
)braket
op_assign
id|ec
suffix:semicolon
id|e_dev
(braket
id|i
)braket
op_assign
id|dev
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ether1_exit
r_static
r_void
id|__exit
id|ether1_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|e_dev
(braket
id|i
)braket
)paren
(brace
id|unregister_netdev
c_func
(paren
id|e_dev
(braket
id|i
)braket
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|e_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
comma
l_int|16
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|e_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_plus
l_int|0x800
comma
l_int|4096
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e_dev
(braket
id|i
)braket
)paren
suffix:semicolon
id|e_dev
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e_card
(braket
id|i
)braket
)paren
(brace
id|ecard_release
c_func
(paren
id|e_card
(braket
id|i
)braket
)paren
suffix:semicolon
id|e_card
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|variable|ether1_init
id|module_init
c_func
(paren
id|ether1_init
)paren
suffix:semicolon
DECL|variable|ether1_exit
id|module_exit
c_func
(paren
id|ether1_exit
)paren
suffix:semicolon
eof
