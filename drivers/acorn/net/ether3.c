multiline_comment|/*&n; *  linux/drivers/acorn/net/ether3.c&n; *&n; *  Copyright (C) 1995-2000 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * SEEQ nq8005 ethernet driver for Acorn/ANT Ether3 card&n; *  for Acorn machines&n; *&n; * By Russell King, with some suggestions from borris@ant.co.uk&n; *&n; * Changelog:&n; * 1.04&t;RMK&t;29/02/1996&t;Won&squot;t pass packets that are from our ethernet&n; *&t;&t;&t;&t;address up to the higher levels - they&squot;re&n; *&t;&t;&t;&t;silently ignored.  I/F can now be put into&n; *&t;&t;&t;&t;multicast mode.  Receiver routine optimised.&n; * 1.05&t;RMK&t;30/02/1996&t;Now claims interrupt at open when part of&n; *&t;&t;&t;&t;the kernel rather than when a module.&n; * 1.06&t;RMK&t;02/03/1996&t;Various code cleanups&n; * 1.07&t;RMK&t;13/10/1996&t;Optimised interrupt routine and transmit&n; *&t;&t;&t;&t;routines.&n; * 1.08&t;RMK&t;14/10/1996&t;Fixed problem with too many packets,&n; *&t;&t;&t;&t;prevented the kernel message about dropped&n; *&t;&t;&t;&t;packets appearing too many times a second.&n; *&t;&t;&t;&t;Now does not disable all IRQs, only the IRQ&n; *&t;&t;&t;&t;used by this card.&n; * 1.09&t;RMK&t;10/11/1996&t;Only enables TX irq when buffer space is low,&n; *&t;&t;&t;&t;but we still service the TX queue if we get a&n; *&t;&t;&t;&t;RX interrupt.&n; * 1.10&t;RMK&t;15/07/1997&t;Fixed autoprobing of NQ8004.&n; * 1.11&t;RMK&t;16/11/1997&t;Fixed autoprobing of NQ8005A.&n; * 1.12&t;RMK&t;31/12/1997&t;Removed reference to dev_tint for Linux 2.1.&n; *      RMK&t;27/06/1998&t;Changed asm/delay.h to linux/delay.h.&n; * 1.13&t;RMK&t;29/06/1998&t;Fixed problem with transmission of packets.&n; *&t;&t;&t;&t;Chip seems to have a bug in, whereby if the&n; *&t;&t;&t;&t;packet starts two bytes from the end of the&n; *&t;&t;&t;&t;buffer, it corrupts the receiver chain, and&n; *&t;&t;&t;&t;never updates the transmit status correctly.&n; * 1.14&t;RMK&t;07/01/1998&t;Added initial code for ETHERB addressing.&n; * 1.15&t;RMK&t;30/04/1999&t;More fixes to the transmit routine for buggy&n; *&t;&t;&t;&t;hardware.&n; * 1.16&t;RMK&t;10/02/2000&t;Updated for 2.3.43&n; * 1.17&t;RMK&t;13/05/2000&t;Updated for 2.3.99-pre8&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;ether3 ethernet driver (c) 1995-2000 R.M.King v1.17&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;ether3.h&quot;
DECL|variable|net_debug
r_static
r_int
r_int
id|net_debug
op_assign
id|NET_DEBUG
suffix:semicolon
DECL|variable|ether3_cids
r_static
r_const
id|card_ids
id|__init
id|ether3_cids
(braket
)braket
op_assign
(brace
(brace
id|MANU_ANT2
comma
id|PROD_ANT_ETHER3
)brace
comma
(brace
id|MANU_ANT
comma
id|PROD_ANT_ETHER3
)brace
comma
(brace
id|MANU_ANT
comma
id|PROD_ANT_ETHERB
)brace
comma
multiline_comment|/* trial - will etherb work? */
(brace
l_int|0xffff
comma
l_int|0xffff
)brace
)brace
suffix:semicolon
r_static
r_void
id|ether3_setmulticastlist
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ether3_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
comma
r_int
r_int
id|maxcnt
)paren
suffix:semicolon
r_static
r_void
id|ether3_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
suffix:semicolon
r_static
r_int
id|ether3_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ether3_sendpacket
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether3_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|ether3_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ether3_getstats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether3_setmulticastlist
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether3_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|macro|BUS_16
mdefine_line|#define BUS_16&t;&t;2
DECL|macro|BUS_8
mdefine_line|#define BUS_8&t;&t;1
DECL|macro|BUS_UNKNOWN
mdefine_line|#define BUS_UNKNOWN&t;0
multiline_comment|/*&n; * I&squot;m not sure what address we should default to if the internal one&n; * is corrupted...&n; */
DECL|variable|def_eth_addr
r_int
r_char
id|def_eth_addr
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x00
comma
l_char|&squot;L&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;u&squot;
comma
l_char|&squot;x&squot;
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------- */
r_typedef
r_enum
(brace
DECL|enumerator|buffer_write
id|buffer_write
comma
DECL|enumerator|buffer_read
id|buffer_read
DECL|typedef|buffer_rw_t
)brace
id|buffer_rw_t
suffix:semicolon
multiline_comment|/*&n; * ether3 read/write.  Slow things down a bit...&n; * The SEEQ8005 doesn&squot;t like us writing to it&squot;s registers&n; * too quickly.&n; */
DECL|function|ether3_outb
r_static
r_inline
r_void
id|ether3_outb
c_func
(paren
r_int
id|v
comma
r_const
r_int
id|r
)paren
(brace
id|outb
c_func
(paren
id|v
comma
id|r
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ether3_outw
r_static
r_inline
r_void
id|ether3_outw
c_func
(paren
r_int
id|v
comma
r_const
r_int
id|r
)paren
(brace
id|outw
c_func
(paren
id|v
comma
id|r
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|macro|ether3_inb
mdefine_line|#define ether3_inb(r)&t;&t;({ unsigned int __v = inb((r)); udelay(1); __v; })
DECL|macro|ether3_inw
mdefine_line|#define ether3_inw(r)&t;&t;({ unsigned int __v = inw((r)); udelay(1); __v; })
r_static
r_int
DECL|function|ether3_setbuffer
id|ether3_setbuffer
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|buffer_rw_t
id|read
comma
r_int
id|start
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_LOCBUFMEM
comma
id|REG_CONFIG1
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
op_or
id|CMD_FIFOWRITE
comma
id|REG_COMMAND
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
op_amp
id|STAT_FIFOEMPTY
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: setbuffer broken&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;broken
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read
op_eq
id|buffer_read
)paren
(brace
id|ether3_outw
c_func
(paren
id|start
comma
id|REG_DMAADDR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
op_or
id|CMD_FIFOREAD
comma
id|REG_COMMAND
)paren
suffix:semicolon
)brace
r_else
(brace
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
op_or
id|CMD_FIFOWRITE
comma
id|REG_COMMAND
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|start
comma
id|REG_DMAADDR
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * write data to the buffer memory&n; */
DECL|macro|ether3_writebuffer
mdefine_line|#define ether3_writebuffer(dev,data,length)&t;&t;&t;&bslash;&n;&t;outsw(REG_BUFWIN, (data), (length) &gt;&gt; 1)
DECL|macro|ether3_writeword
mdefine_line|#define ether3_writeword(dev,data)&t;&t;&t;&t;&bslash;&n;&t;outw((data), REG_BUFWIN)
DECL|macro|ether3_writelong
mdefine_line|#define ether3_writelong(dev,data)&t;{&t;&t;&t;&bslash;&n;&t;unsigned long reg_bufwin = REG_BUFWIN;&t;&t;&t;&bslash;&n;&t;outw((data), reg_bufwin);&t;&t;&t;&t;&bslash;&n;&t;outw((data) &gt;&gt; 16, reg_bufwin);&t;&t;&t;&t;&bslash;&n;}
multiline_comment|/*&n; * read data from the buffer memory&n; */
DECL|macro|ether3_readbuffer
mdefine_line|#define ether3_readbuffer(dev,data,length)&t;&t;&t;&bslash;&n;&t;insw(REG_BUFWIN, (data), (length) &gt;&gt; 1)
DECL|macro|ether3_readword
mdefine_line|#define ether3_readword(dev)&t;&t;&t;&t;&t;&bslash;&n;&t;inw(REG_BUFWIN)
DECL|macro|ether3_readlong
mdefine_line|#define ether3_readlong(dev)&t; &t;&t;&t;&t;&bslash;&n;&t;inw(REG_BUFWIN) | (inw(REG_BUFWIN) &lt;&lt; 16)
multiline_comment|/*&n; * Switch LED off...&n; */
r_static
r_void
DECL|function|ether3_ledoff
id|ether3_ledoff
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config2
op_or_assign
id|CFG2_CTRLO
comma
id|REG_CONFIG2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * switch LED on...&n; */
r_static
r_inline
r_void
DECL|function|ether3_ledon
id|ether3_ledon
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
id|priv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|50
suffix:semicolon
multiline_comment|/* leave on for 1/50th second */
id|priv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|priv-&gt;timer.function
op_assign
id|ether3_ledoff
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;regs.config2
op_amp
id|CFG2_CTRLO
)paren
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config2
op_and_assign
op_complement
id|CFG2_CTRLO
comma
id|REG_CONFIG2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the ethernet address string from the on board rom.&n; * This is an ascii string!!!&n; */
r_static
r_void
id|__init
DECL|function|ether3_addr
id|ether3_addr
c_func
(paren
r_char
op_star
id|addr
comma
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_struct
id|in_chunk_dir
id|cd
suffix:semicolon
r_char
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|ecard_readchunk
c_func
(paren
op_amp
id|cd
comma
id|ec
comma
l_int|0xf5
comma
l_int|0
)paren
op_logical_and
(paren
id|s
op_assign
id|strchr
c_func
(paren
id|cd.d.string
comma
l_char|&squot;(&squot;
)paren
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|addr
(braket
id|i
)braket
op_assign
id|simple_strtoul
c_func
(paren
id|s
op_plus
l_int|1
comma
op_amp
id|s
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_ne
(paren
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot;)&squot;
suffix:colon
l_char|&squot;:&squot;
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|6
)paren
r_return
suffix:semicolon
)brace
multiline_comment|/* I wonder if we should even let the user continue in this case&n;&t; *   - no, it would be better to disable the device&n;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ether3: Couldn&squot;t read a valid MAC address from card.&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|addr
comma
id|def_eth_addr
comma
l_int|6
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------- */
r_static
r_int
id|__init
DECL|function|ether3_ramtest
id|ether3_ramtest
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
id|byte
)paren
(brace
r_int
r_char
op_star
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|RX_END
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|max_errors
op_assign
l_int|4
suffix:semicolon
r_int
id|bad
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
id|byte
comma
id|RX_END
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
l_int|0
)paren
suffix:semicolon
id|ether3_writebuffer
c_func
(paren
id|dev
comma
id|buffer
comma
id|TX_END
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
id|RX_START
)paren
suffix:semicolon
id|ether3_writebuffer
c_func
(paren
id|dev
comma
id|buffer
op_plus
id|RX_START
comma
id|RX_LEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
id|byte
op_xor
l_int|0xff
comma
id|RX_END
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_read
comma
l_int|0
)paren
suffix:semicolon
id|ether3_readbuffer
c_func
(paren
id|dev
comma
id|buffer
comma
id|TX_END
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_read
comma
id|RX_START
)paren
suffix:semicolon
id|ether3_readbuffer
c_func
(paren
id|dev
comma
id|buffer
op_plus
id|RX_START
comma
id|RX_LEN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_END
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
id|byte
)paren
(brace
r_if
c_cond
(paren
id|max_errors
OG
l_int|0
op_logical_and
id|bad
op_ne
id|buffer
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: RAM failed with (%02X instead of %02X) at 0x%04X&quot;
comma
id|dev-&gt;name
comma
id|buffer
(braket
id|i
)braket
comma
id|byte
comma
id|i
)paren
suffix:semicolon
id|ret
op_assign
l_int|2
suffix:semicolon
id|max_errors
op_decrement
suffix:semicolon
id|bad
op_assign
id|i
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|bad
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|bad
op_ne
id|i
op_minus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot; - 0x%04X&bslash;n&quot;
comma
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|bad
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|bad
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot; - 0xffff&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------------- */
r_static
r_int
id|__init
DECL|function|ether3_init_2
id|ether3_init_2
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|priv-&gt;regs.config1
op_assign
id|CFG1_RECVCOMPSTAT0
op_or
id|CFG1_DMABURST8
suffix:semicolon
id|priv-&gt;regs.config2
op_assign
id|CFG2_CTRLO
op_or
id|CFG2_RECVCRC
op_or
id|CFG2_ERRENCRC
suffix:semicolon
id|priv-&gt;regs.command
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Set up our hardware address&n;&t; */
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_BUFSELSTAT0
comma
id|REG_CONFIG1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|ether3_outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|REG_BUFWIN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|priv-&gt;regs.config1
op_or_assign
id|CFG1_RECVPROMISC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_MULTICAST
)paren
id|priv-&gt;regs.config1
op_or_assign
id|CFG1_RECVSPECBRMULTI
suffix:semicolon
r_else
id|priv-&gt;regs.config1
op_or_assign
id|CFG1_RECVSPECBROAD
suffix:semicolon
multiline_comment|/*&n;&t; * There is a problem with the NQ8005 in that it occasionally loses the&n;&t; * last two bytes.  To get round this problem, we receive the CRC as&n;&t; * well.  That way, if we do loose the last two, then it doesn&squot;t matter.&n;&t; */
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_TRANSEND
comma
id|REG_CONFIG1
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
(paren
id|TX_END
op_rshift
l_int|8
)paren
op_minus
l_int|1
comma
id|REG_BUFWIN
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;rx_head
comma
id|REG_RECVPTR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
l_int|0
comma
id|REG_TRANSMITPTR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;rx_head
op_rshift
l_int|8
comma
id|REG_RECVEND
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config2
comma
id|REG_CONFIG2
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_LOCBUFMEM
comma
id|REG_CONFIG1
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
comma
id|REG_COMMAND
)paren
suffix:semicolon
id|i
op_assign
id|ether3_ramtest
c_func
(paren
id|dev
comma
l_int|0x5A
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
id|i
op_assign
id|ether3_ramtest
c_func
(paren
id|dev
comma
l_int|0x1E
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
l_int|0
)paren
suffix:semicolon
id|ether3_writelong
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether3_init_for_open
id|ether3_init_for_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|priv-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset the chip */
id|ether3_outw
c_func
(paren
id|CFG2_RESET
comma
id|REG_CONFIG2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|priv-&gt;regs.command
op_assign
l_int|0
suffix:semicolon
id|ether3_outw
c_func
(paren
id|CMD_RXOFF
op_or
id|CMD_TXOFF
comma
id|REG_COMMAND
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
op_amp
(paren
id|STAT_RXON
op_or
id|STAT_TXON
)paren
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_BUFSELSTAT0
comma
id|REG_CONFIG1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|ether3_outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|REG_BUFWIN
)paren
suffix:semicolon
id|priv-&gt;tx_head
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_tail
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;regs.config2
op_or_assign
id|CFG2_CTRLO
suffix:semicolon
id|priv-&gt;rx_head
op_assign
id|RX_START
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_TRANSEND
comma
id|REG_CONFIG1
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
(paren
id|TX_END
op_rshift
l_int|8
)paren
op_minus
l_int|1
comma
id|REG_BUFWIN
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;rx_head
comma
id|REG_RECVPTR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;rx_head
op_rshift
l_int|8
comma
id|REG_RECVEND
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
l_int|0
comma
id|REG_TRANSMITPTR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config2
comma
id|REG_CONFIG2
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_LOCBUFMEM
comma
id|REG_CONFIG1
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
l_int|0
)paren
suffix:semicolon
id|ether3_writelong
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|priv-&gt;regs.command
op_assign
id|CMD_ENINTRX
op_or
id|CMD_ENINTTX
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
op_or
id|CMD_RXON
comma
id|REG_COMMAND
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|ether3_probe_bus_8
id|ether3_probe_bus_8
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|val
)paren
(brace
r_int
id|write_low
comma
id|write_high
comma
id|read_low
comma
id|read_high
suffix:semicolon
id|write_low
op_assign
id|val
op_amp
l_int|255
suffix:semicolon
id|write_high
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ether3_probe: write8 [%02X:%02X]&quot;
comma
id|write_high
comma
id|write_low
)paren
suffix:semicolon
id|ether3_outb
c_func
(paren
id|write_low
comma
id|REG_RECVPTR
)paren
suffix:semicolon
id|ether3_outb
c_func
(paren
id|write_high
comma
id|REG_RECVPTR
op_plus
l_int|1
)paren
suffix:semicolon
id|read_low
op_assign
id|ether3_inb
c_func
(paren
id|REG_RECVPTR
)paren
suffix:semicolon
id|read_high
op_assign
id|ether3_inb
c_func
(paren
id|REG_RECVPTR
op_plus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, read8 [%02X:%02X]&bslash;n&quot;
comma
id|read_high
comma
id|read_low
)paren
suffix:semicolon
r_return
id|read_low
op_eq
id|write_low
op_logical_and
id|read_high
op_eq
id|write_high
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|ether3_probe_bus_16
id|ether3_probe_bus_16
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|val
)paren
(brace
r_int
id|read_val
suffix:semicolon
id|ether3_outw
c_func
(paren
id|val
comma
id|REG_RECVPTR
)paren
suffix:semicolon
id|read_val
op_assign
id|ether3_inw
c_func
(paren
id|REG_RECVPTR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ether3_probe: write16 [%04X], read16 [%04X]&bslash;n&quot;
comma
id|val
comma
id|read_val
)paren
suffix:semicolon
r_return
id|read_val
op_eq
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the board.  This is called (in the current kernel)&n; * sometime after booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|ether3_open
id|ether3_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ether3_interrupt
comma
l_int|0
comma
l_string|&quot;ether3&quot;
comma
id|dev
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|ether3_init_for_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The inverse routine to ether3_open().&n; */
r_static
r_int
DECL|function|ether3_close
id|ether3_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|CMD_RXOFF
op_or
id|CMD_TXOFF
comma
id|REG_COMMAND
)paren
suffix:semicolon
id|priv-&gt;regs.command
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
op_amp
(paren
id|STAT_RXON
op_or
id|STAT_TXON
)paren
)paren
suffix:semicolon
id|ether3_outb
c_func
(paren
l_int|0x80
comma
id|REG_CONFIG2
op_plus
l_int|1
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
l_int|0
comma
id|REG_COMMAND
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics.&t;This may be called with the card open or&n; * closed.&n; */
DECL|function|ether3_getstats
r_static
r_struct
id|net_device_stats
op_star
id|ether3_getstats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear promiscuous/multicast mode filter for this adaptor.&n; *&n; * We don&squot;t attempt any packet filtering.  The card may have a SEEQ 8004&n; * in which does not have the other ethernet address registers present...&n; */
DECL|function|ether3_setmulticastlist
r_static
r_void
id|ether3_setmulticastlist
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|priv-&gt;regs.config1
op_and_assign
op_complement
id|CFG1_RECVPROMISC
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* promiscuous mode */
id|priv-&gt;regs.config1
op_or_assign
id|CFG1_RECVPROMISC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|priv-&gt;regs.config1
op_or_assign
id|CFG1_RECVSPECBRMULTI
suffix:semicolon
)brace
r_else
id|priv-&gt;regs.config1
op_or_assign
id|CFG1_RECVSPECBROAD
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config1
op_or
id|CFG1_LOCBUFMEM
comma
id|REG_CONFIG1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether3_timeout
id|ether3_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, network cable problem?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: state: { status=%04X cfg1=%04X cfg2=%04X }&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
comma
id|ether3_inw
c_func
(paren
id|REG_CONFIG1
)paren
comma
id|ether3_inw
c_func
(paren
id|REG_CONFIG2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: { rpr=%04X rea=%04X tpr=%04X }&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether3_inw
c_func
(paren
id|REG_RECVPTR
)paren
comma
id|ether3_inw
c_func
(paren
id|REG_RECVEND
)paren
comma
id|ether3_inw
c_func
(paren
id|REG_TRANSMITPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: tx head=%X tx tail=%X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;tx_head
comma
id|priv-&gt;tx_tail
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_read
comma
id|priv-&gt;tx_tail
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: packet status = %08X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ether3_readlong
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|priv-&gt;regs.config2
op_or_assign
id|CFG2_CTRLO
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_add_assign
l_int|1
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.config2
comma
id|REG_CONFIG2
)paren
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|priv-&gt;tx_tail
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a packet&n; */
r_static
r_int
DECL|function|ether3_sendpacket
id|ether3_sendpacket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|length
op_assign
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
suffix:semicolon
r_int
r_int
id|ptr
comma
id|next_ptr
suffix:semicolon
id|length
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;broken
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|next_ptr
op_assign
(paren
id|priv-&gt;tx_head
op_plus
l_int|1
)paren
op_amp
l_int|15
suffix:semicolon
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_tail
op_eq
id|next_ptr
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* unable to queue */
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ptr
op_assign
l_int|0x600
op_star
id|priv-&gt;tx_head
suffix:semicolon
id|priv-&gt;tx_head
op_assign
id|next_ptr
suffix:semicolon
id|next_ptr
op_mul_assign
l_int|0x600
suffix:semicolon
DECL|macro|TXHDR_FLAGS
mdefine_line|#define TXHDR_FLAGS (TXHDR_TRANSMIT|TXHDR_CHAINCONTINUE|TXHDR_DATAFOLLOWS|TXHDR_ENSUCCESS)
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
id|next_ptr
)paren
suffix:semicolon
id|ether3_writelong
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
id|ptr
)paren
suffix:semicolon
id|ether3_writelong
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|ether3_writebuffer
c_func
(paren
id|dev
comma
id|skb-&gt;data
comma
id|length
)paren
suffix:semicolon
id|ether3_writeword
c_func
(paren
id|dev
comma
id|htons
c_func
(paren
id|next_ptr
)paren
)paren
suffix:semicolon
id|ether3_writeword
c_func
(paren
id|dev
comma
id|TXHDR_CHAINCONTINUE
op_rshift
l_int|16
)paren
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_write
comma
id|ptr
)paren
suffix:semicolon
id|ether3_writeword
c_func
(paren
id|dev
comma
id|htons
c_func
(paren
(paren
id|ptr
op_plus
id|length
op_plus
l_int|4
)paren
)paren
)paren
suffix:semicolon
id|ether3_writeword
c_func
(paren
id|dev
comma
id|TXHDR_FLAGS
op_rshift
l_int|16
)paren
suffix:semicolon
id|ether3_ledon
c_func
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
op_amp
id|STAT_TXON
)paren
)paren
(brace
id|ether3_outw
c_func
(paren
id|ptr
comma
id|REG_TRANSMITPTR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
op_or
id|CMD_TXON
comma
id|REG_COMMAND
)paren
suffix:semicolon
)brace
id|next_ptr
op_assign
(paren
id|priv-&gt;tx_head
op_plus
l_int|1
)paren
op_amp
l_int|15
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_tail
op_eq
id|next_ptr
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ether3_interrupt
id|ether3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
macro_line|#if NET_DEBUG &gt; 1
r_if
c_cond
(paren
id|net_debug
op_amp
id|DEBUG_INT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eth3irq: %d &quot;
comma
id|irq
)paren
suffix:semicolon
)brace
macro_line|#endif
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status
op_assign
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|STAT_INTRX
)paren
(brace
id|ether3_outw
c_func
(paren
id|CMD_ACKINTRX
op_or
id|priv-&gt;regs.command
comma
id|REG_COMMAND
)paren
suffix:semicolon
id|ether3_rx
c_func
(paren
id|dev
comma
id|priv
comma
l_int|12
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STAT_INTTX
)paren
(brace
id|ether3_outw
c_func
(paren
id|CMD_ACKINTTX
op_or
id|priv-&gt;regs.command
comma
id|REG_COMMAND
)paren
suffix:semicolon
id|ether3_tx
c_func
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
)brace
macro_line|#if NET_DEBUG &gt; 1
r_if
c_cond
(paren
id|net_debug
op_amp
id|DEBUG_INT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * If we have a good packet(s), get it/them out of the buffers.&n; */
r_static
r_int
DECL|function|ether3_rx
id|ether3_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
comma
r_int
r_int
id|maxcnt
)paren
(brace
r_int
r_int
id|next_ptr
op_assign
id|priv-&gt;rx_head
comma
id|received
op_assign
l_int|0
suffix:semicolon
id|ether3_ledon
c_func
(paren
id|dev
comma
id|priv
)paren
suffix:semicolon
r_do
(brace
r_int
r_int
id|this_ptr
comma
id|status
suffix:semicolon
r_int
r_char
id|addrs
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * read the first 16 bytes from the buffer.&n;&t;&t; * This contains the status bytes etc and ethernet addresses,&n;&t;&t; * and we also check the source ethernet address to see if&n;&t;&t; * it originated from us.&n;&t;&t; */
(brace
r_int
r_int
id|temp_ptr
suffix:semicolon
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_read
comma
id|next_ptr
)paren
suffix:semicolon
id|temp_ptr
op_assign
id|ether3_readword
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|ether3_readword
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|RXSTAT_DONE
op_or
id|RXHDR_CHAINCONTINUE
op_or
id|RXHDR_RECEIVE
)paren
)paren
op_ne
(paren
id|RXSTAT_DONE
op_or
id|RXHDR_CHAINCONTINUE
)paren
op_logical_or
op_logical_neg
id|temp_ptr
)paren
r_break
suffix:semicolon
id|this_ptr
op_assign
id|next_ptr
op_plus
l_int|4
suffix:semicolon
id|next_ptr
op_assign
id|ntohs
c_func
(paren
id|temp_ptr
)paren
suffix:semicolon
)brace
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_read
comma
id|this_ptr
)paren
suffix:semicolon
id|ether3_readbuffer
c_func
(paren
id|dev
comma
id|addrs
op_plus
l_int|2
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_ptr
OL
id|RX_START
op_logical_or
id|next_ptr
op_ge
id|RX_END
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: bad next pointer @%04X: &quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;rx_head
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X %02X %02X %02X &quot;
comma
id|next_ptr
op_rshift
l_int|8
comma
id|next_ptr
op_amp
l_int|255
comma
id|status
op_amp
l_int|255
comma
id|status
op_rshift
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|addrs
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|next_ptr
op_assign
id|priv-&gt;rx_head
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n; &t;&t; * ignore our own packets...&n;&t; &t; */
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_xor
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|addrs
(braket
l_int|2
op_plus
l_int|6
)braket
)paren
op_logical_and
op_logical_neg
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_xor
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|addrs
(braket
l_int|2
op_plus
l_int|10
)braket
)paren
)paren
(brace
id|maxcnt
op_increment
suffix:semicolon
multiline_comment|/* compensate for loopedback packet */
id|ether3_outw
c_func
(paren
id|next_ptr
op_rshift
l_int|8
comma
id|REG_RECVEND
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
(paren
id|RXSTAT_OVERSIZE
op_or
id|RXSTAT_CRCERROR
op_or
id|RXSTAT_DRIBBLEERROR
op_or
id|RXSTAT_SHORTPACKET
)paren
)paren
)paren
(brace
r_int
r_int
id|length
op_assign
id|next_ptr
op_minus
id|this_ptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|next_ptr
op_le
id|this_ptr
)paren
id|length
op_add_assign
id|RX_END
op_minus
id|RX_START
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|length
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_int
r_char
op_star
id|buf
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|ether3_readbuffer
c_func
(paren
id|dev
comma
id|buf
op_plus
l_int|12
comma
id|length
op_minus
l_int|12
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|next_ptr
op_rshift
l_int|8
comma
id|REG_RECVEND
)paren
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|0
)paren
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|addrs
op_plus
l_int|2
)paren
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|2
)paren
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|addrs
op_plus
l_int|4
)paren
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|6
)paren
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|addrs
op_plus
l_int|8
)paren
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|10
)paren
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|addrs
op_plus
l_int|12
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|received
op_increment
suffix:semicolon
)brace
r_else
r_goto
id|dropping
suffix:semicolon
)brace
r_else
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|priv-&gt;stats
suffix:semicolon
id|ether3_outw
c_func
(paren
id|next_ptr
op_rshift
l_int|8
comma
id|REG_RECVEND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RXSTAT_OVERSIZE
)paren
id|stats-&gt;rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RXSTAT_CRCERROR
)paren
id|stats-&gt;rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RXSTAT_DRIBBLEERROR
)paren
id|stats-&gt;rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RXSTAT_SHORTPACKET
)paren
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|maxcnt
)paren
suffix:semicolon
id|done
suffix:colon
id|priv-&gt;stats.rx_packets
op_add_assign
id|received
suffix:semicolon
id|priv-&gt;rx_head
op_assign
id|next_ptr
suffix:semicolon
multiline_comment|/*&n;&t; * If rx went off line, then that means that the buffer may be full.  We&n;&t; * have dropped at least one packet.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ether3_inw
c_func
(paren
id|REG_STATUS
)paren
op_amp
id|STAT_RXON
)paren
)paren
(brace
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|ether3_outw
c_func
(paren
id|next_ptr
comma
id|REG_RECVPTR
)paren
suffix:semicolon
id|ether3_outw
c_func
(paren
id|priv-&gt;regs.command
op_or
id|CMD_RXON
comma
id|REG_COMMAND
)paren
suffix:semicolon
)brace
r_return
id|maxcnt
suffix:semicolon
id|dropping
suffix:colon
(brace
r_static
r_int
r_int
id|last_warned
suffix:semicolon
id|ether3_outw
c_func
(paren
id|next_ptr
op_rshift
l_int|8
comma
id|REG_RECVEND
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t print this message too many times...&n;&t; */
r_if
c_cond
(paren
id|jiffies
op_minus
id|last_warned
OG
l_int|30
op_star
id|HZ
)paren
(brace
id|last_warned
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Update stats for the transmitted packet(s)&n; */
r_static
r_void
DECL|function|ether3_tx
id|ether3_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dev_priv
op_star
id|priv
)paren
(brace
r_int
r_int
id|tx_tail
op_assign
id|priv-&gt;tx_tail
suffix:semicolon
r_int
id|max_work
op_assign
l_int|14
suffix:semicolon
r_do
(brace
r_int
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t;    &t; * Read the packet header&n;    &t;&t; */
id|ether3_setbuffer
c_func
(paren
id|dev
comma
id|buffer_read
comma
id|tx_tail
op_star
l_int|0x600
)paren
suffix:semicolon
id|status
op_assign
id|ether3_readlong
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check to see if this packet has been transmitted&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|TXSTAT_DONE
op_or
id|TXHDR_TRANSMIT
)paren
)paren
op_ne
(paren
id|TXSTAT_DONE
op_or
id|TXHDR_TRANSMIT
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Update errors&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
(paren
id|TXSTAT_BABBLED
op_or
id|TXSTAT_16COLLISIONS
)paren
)paren
)paren
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_else
(brace
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TXSTAT_16COLLISIONS
)paren
id|priv-&gt;stats.collisions
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TXSTAT_BABBLED
)paren
id|priv-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
id|tx_tail
op_assign
(paren
id|tx_tail
op_plus
l_int|1
)paren
op_amp
l_int|15
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|max_work
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_tail
op_ne
id|tx_tail
)paren
(brace
id|priv-&gt;tx_tail
op_assign
id|tx_tail
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|ether3_banner
r_static
r_void
id|__init
id|ether3_banner
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|net_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
r_static
r_const
r_char
op_star
id|__init
DECL|function|ether3_get_dev
id|ether3_get_dev
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_const
r_char
op_star
id|name
op_assign
l_string|&quot;ether3&quot;
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_MEMC
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|ec-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|ec-&gt;cid.manufacturer
op_eq
id|MANU_ANT
op_logical_and
id|ec-&gt;cid.product
op_eq
id|PROD_ANT_ETHERB
)paren
(brace
id|dev-&gt;base_addr
op_add_assign
l_int|0x200
suffix:semicolon
id|name
op_assign
l_string|&quot;etherb&quot;
suffix:semicolon
)brace
id|ec-&gt;irqaddr
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|ioaddr
c_func
(paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|ec-&gt;irqmask
op_assign
l_int|0xf0
suffix:semicolon
id|ether3_addr
c_func
(paren
id|dev-&gt;dev_addr
comma
id|ec
)paren
suffix:semicolon
r_return
id|name
suffix:semicolon
)brace
DECL|function|ether3_init_one
r_static
r_struct
id|net_device
op_star
id|__init
id|ether3_init_one
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|dev_priv
op_star
id|priv
suffix:semicolon
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|i
comma
id|bus_type
suffix:semicolon
id|ether3_banner
c_func
(paren
)paren
suffix:semicolon
id|ecard_claim
c_func
(paren
id|ec
)paren
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|dev_priv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|name
op_assign
id|ether3_get_dev
c_func
(paren
id|dev
comma
id|ec
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * this will not fail - the nature of the bus ensures this&n;&t; */
id|request_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|128
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Reset card...&n;&t; */
id|ether3_outb
c_func
(paren
l_int|0x80
comma
id|REG_CONFIG2
op_plus
l_int|1
)paren
suffix:semicolon
id|bus_type
op_assign
id|BUS_UNKNOWN
suffix:semicolon
id|udelay
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Test using Receive Pointer (16-bit register) to find out&n;&t; * how the ether3 is connected to the bus...&n;&t; */
r_if
c_cond
(paren
id|ether3_probe_bus_8
c_func
(paren
id|dev
comma
l_int|0x100
)paren
op_logical_and
id|ether3_probe_bus_8
c_func
(paren
id|dev
comma
l_int|0x201
)paren
)paren
id|bus_type
op_assign
id|BUS_8
suffix:semicolon
r_if
c_cond
(paren
id|bus_type
op_eq
id|BUS_UNKNOWN
op_logical_and
id|ether3_probe_bus_16
c_func
(paren
id|dev
comma
l_int|0x101
)paren
op_logical_and
id|ether3_probe_bus_16
c_func
(paren
id|dev
comma
l_int|0x201
)paren
)paren
id|bus_type
op_assign
id|BUS_16
suffix:semicolon
r_switch
c_cond
(paren
id|bus_type
)paren
(brace
r_case
id|BUS_UNKNOWN
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to identify bus width&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
r_case
id|BUS_8
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s found, but is an unsupported &quot;
l_string|&quot;8-bit card&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|name
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: %s at %lx, IRQ%d, ether address &quot;
comma
id|dev-&gt;name
comma
id|name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
id|i
op_eq
l_int|5
ques
c_cond
l_string|&quot;%2.2x&bslash;n&quot;
suffix:colon
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ether3_init_2
c_func
(paren
id|dev
)paren
)paren
r_goto
id|failed
suffix:semicolon
id|dev-&gt;open
op_assign
id|ether3_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ether3_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ether3_sendpacket
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ether3_getstats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ether3_setmulticastlist
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ether3_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|128
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
id|ecard_release
c_func
(paren
id|ec
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|variable|e_card
r_static
r_struct
id|expansion_card
op_star
id|e_card
(braket
id|MAX_ECARDS
)braket
suffix:semicolon
DECL|variable|e_dev
r_static
r_struct
id|net_device
op_star
id|e_dev
(braket
id|MAX_ECARDS
)braket
suffix:semicolon
DECL|function|ether3_init
r_static
r_int
id|ether3_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|ecard_startfind
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|expansion_card
op_star
id|ec
suffix:semicolon
id|ec
op_assign
id|ecard_find
c_func
(paren
l_int|0
comma
id|ether3_cids
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
r_break
suffix:semicolon
id|dev
op_assign
id|ether3_init_one
c_func
(paren
id|ec
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_break
suffix:semicolon
id|e_card
(braket
id|i
)braket
op_assign
id|ec
suffix:semicolon
id|e_dev
(braket
id|i
)braket
op_assign
id|dev
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ether3_exit
r_static
r_void
id|ether3_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|e_dev
(braket
id|i
)braket
)paren
(brace
id|unregister_netdev
c_func
(paren
id|e_dev
(braket
id|i
)braket
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|e_dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
comma
l_int|128
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e_dev
(braket
id|i
)braket
)paren
suffix:semicolon
id|e_dev
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e_card
(braket
id|i
)braket
)paren
(brace
id|ecard_release
c_func
(paren
id|e_card
(braket
id|i
)braket
)paren
suffix:semicolon
id|e_card
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|variable|ether3_init
id|module_init
c_func
(paren
id|ether3_init
)paren
suffix:semicolon
DECL|variable|ether3_exit
id|module_exit
c_func
(paren
id|ether3_exit
)paren
suffix:semicolon
eof
