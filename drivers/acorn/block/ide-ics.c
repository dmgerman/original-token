multiline_comment|/*&n; * linux/arch/arm/drivers/block/ide-ics.c&n; *&n; * Copyright (c) 1996,1997 Russell King.&n; *&n; * Changelog:&n; *  08-06-1996&t;RMK&t;Created&n; *  12-09-1997&t;RMK&t;Added interrupt enable/disable&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;../../block/ide.h&quot;
multiline_comment|/*&n; * Maximum number of interfaces per card&n; */
DECL|macro|MAX_IFS
mdefine_line|#define MAX_IFS&t;2
DECL|macro|ICS_IDENT_OFFSET
mdefine_line|#define ICS_IDENT_OFFSET&t;&t;0x8a0
DECL|macro|ICS_ARCIN_V5_INTROFFSET
mdefine_line|#define ICS_ARCIN_V5_INTROFFSET&t;&t;0x001
DECL|macro|ICS_ARCIN_V5_IDEOFFSET
mdefine_line|#define ICS_ARCIN_V5_IDEOFFSET&t;&t;0xa00
DECL|macro|ICS_ARCIN_V5_IDEALTOFFSET
mdefine_line|#define ICS_ARCIN_V5_IDEALTOFFSET&t;0xae0
DECL|macro|ICS_ARCIN_V5_IDESTEPPING
mdefine_line|#define ICS_ARCIN_V5_IDESTEPPING&t;4
DECL|macro|ICS_ARCIN_V6_IDEOFFSET_1
mdefine_line|#define ICS_ARCIN_V6_IDEOFFSET_1&t;0x800
DECL|macro|ICS_ARCIN_V6_INTROFFSET_1
mdefine_line|#define ICS_ARCIN_V6_INTROFFSET_1&t;0x880
DECL|macro|ICS_ARCIN_V6_IDEALTOFFSET_1
mdefine_line|#define ICS_ARCIN_V6_IDEALTOFFSET_1&t;0x8e0
DECL|macro|ICS_ARCIN_V6_IDEOFFSET_2
mdefine_line|#define ICS_ARCIN_V6_IDEOFFSET_2&t;0xc00
DECL|macro|ICS_ARCIN_V6_INTROFFSET_2
mdefine_line|#define ICS_ARCIN_V6_INTROFFSET_2&t;0xc80
DECL|macro|ICS_ARCIN_V6_IDEALTOFFSET_2
mdefine_line|#define ICS_ARCIN_V6_IDEALTOFFSET_2&t;0xce0
DECL|macro|ICS_ARCIN_V6_IDESTEPPING
mdefine_line|#define ICS_ARCIN_V6_IDESTEPPING&t;4
DECL|variable|icside_cids
r_static
r_const
id|card_ids
id|icside_cids
(braket
)braket
op_assign
(brace
(brace
id|MANU_ICS
comma
id|PROD_ICS_IDE
)brace
comma
(brace
l_int|0xffff
comma
l_int|0xffff
)brace
)brace
suffix:semicolon
r_typedef
r_enum
(brace
DECL|enumerator|ics_if_unknown
id|ics_if_unknown
comma
DECL|enumerator|ics_if_arcin_v5
id|ics_if_arcin_v5
comma
DECL|enumerator|ics_if_arcin_v6
id|ics_if_arcin_v6
DECL|typedef|iftype_t
)brace
id|iftype_t
suffix:semicolon
DECL|variable|ec
r_static
r_struct
id|expansion_card
op_star
id|ec
(braket
id|MAX_ECARDS
)braket
suffix:semicolon
DECL|variable|result
r_static
r_int
id|result
(braket
id|MAX_ECARDS
)braket
(braket
id|MAX_IFS
)braket
suffix:semicolon
multiline_comment|/* ---------------- Version 5 PCB Support Functions --------------------- */
multiline_comment|/* Prototype: icside_irqenable_arcin_v5 (struct expansion_card *ec, int irqnr)&n; * Purpose  : enable interrupts from card&n; */
DECL|function|icside_irqenable_arcin_v5
r_static
r_void
id|icside_irqenable_arcin_v5
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|memc_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|memc_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqdisable_arcin_v5 (struct expansion_card *ec, int irqnr)&n; * Purpose  : disable interrupts from card&n; */
DECL|function|icside_irqdisable_arcin_v5
r_static
r_void
id|icside_irqdisable_arcin_v5
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|memc_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|inb
(paren
id|memc_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
)brace
DECL|variable|icside_ops_arcin_v5
r_static
r_const
id|expansioncard_ops_t
id|icside_ops_arcin_v5
op_assign
(brace
id|icside_irqenable_arcin_v5
comma
id|icside_irqdisable_arcin_v5
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* ---------------- Version 6 PCB Support Functions --------------------- */
multiline_comment|/* Prototype: icside_irqenable_arcin_v6 (struct expansion_card *ec, int irqnr)&n; * Purpose  : enable interrupts from card&n; */
DECL|function|icside_irqenable_arcin_v6
r_static
r_void
id|icside_irqenable_arcin_v6
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|ide_base_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqdisable_arcin_v6 (struct expansion_card *ec, int irqnr)&n; * Purpose  : disable interrupts from card&n; */
DECL|function|icside_irqdisable_arcin_v6
r_static
r_void
id|icside_irqdisable_arcin_v6
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|ide_base_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|inb
(paren
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
(paren
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
)brace
DECL|variable|icside_ops_arcin_v6
r_static
r_const
id|expansioncard_ops_t
id|icside_ops_arcin_v6
op_assign
(brace
id|icside_irqenable_arcin_v6
comma
id|icside_irqdisable_arcin_v6
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Prototype: icside_identifyif (struct expansion_card *ec)&n; * Purpose  : identify IDE interface type&n; * Notes    : checks the description string&n; */
DECL|function|icside_identifyif
r_static
id|iftype_t
id|icside_identifyif
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|iftype_t
id|iftype
suffix:semicolon
r_int
id|id
op_assign
l_int|0
suffix:semicolon
id|iftype
op_assign
id|ics_if_unknown
suffix:semicolon
id|addr
op_assign
id|ecard_address
(paren
id|ec
comma
id|ECARD_IOC
comma
id|ECARD_FAST
)paren
op_plus
id|ICS_IDENT_OFFSET
suffix:semicolon
id|id
op_assign
id|inb
(paren
id|addr
)paren
op_amp
l_int|1
suffix:semicolon
id|id
op_or_assign
(paren
id|inb
(paren
id|addr
op_plus
l_int|1
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
id|id
op_or_assign
(paren
id|inb
(paren
id|addr
op_plus
l_int|2
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|2
suffix:semicolon
id|id
op_or_assign
(paren
id|inb
(paren
id|addr
op_plus
l_int|3
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|3
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* A3IN */
id|printk
(paren
l_string|&quot;icside: A3IN unsupported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* A3USER */
id|printk
(paren
l_string|&quot;icside: A3USER unsupported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* ARCIN V6 */
id|printk
(paren
l_string|&quot;icside: detected ARCIN V6 in slot %d&bslash;n&quot;
comma
id|ec-&gt;slot_no
)paren
suffix:semicolon
id|iftype
op_assign
id|ics_if_arcin_v6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
multiline_comment|/* ARCIN V5 (no id) */
id|printk
(paren
l_string|&quot;icside: detected ARCIN V5 in slot %d&bslash;n&quot;
comma
id|ec-&gt;slot_no
)paren
suffix:semicolon
id|iftype
op_assign
id|ics_if_arcin_v5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* we don&squot;t know - complain very loudly */
id|printk
(paren
l_string|&quot;icside: ***********************************&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;icside: *** UNKNOWN ICS INTERFACE id=%d ***&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;icside: ***********************************&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;icside: please report this to: linux@arm.uk.linux.org&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;icside: defaulting to ARCIN V5&bslash;n&quot;
)paren
suffix:semicolon
id|iftype
op_assign
id|ics_if_arcin_v5
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|iftype
suffix:semicolon
)brace
DECL|function|icside_register_port
r_static
r_int
id|icside_register_port
c_func
(paren
r_int
r_int
id|dataport
comma
r_int
r_int
id|ctrlport
comma
r_int
id|stepping
comma
r_int
id|irq
)paren
(brace
id|hw_regs_t
id|hw
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hw
comma
l_int|0
comma
r_sizeof
(paren
id|hw
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IDE_DATA_OFFSET
suffix:semicolon
id|i
op_le
id|IDE_STATUS_OFFSET
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hw.io_ports
(braket
id|i
)braket
op_assign
(paren
id|ide_ioreg_t
)paren
id|dataport
suffix:semicolon
id|dataport
op_add_assign
l_int|1
op_lshift
id|stepping
suffix:semicolon
)brace
id|hw.io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|ctrlport
suffix:semicolon
id|hw.irq
op_assign
id|irq
suffix:semicolon
r_return
id|ide_register_hw
c_func
(paren
op_amp
id|hw
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_register (struct expansion_card *ec)&n; * Purpose  : register an ICS IDE card with the IDE driver&n; * Notes    : we make sure that interrupts are disabled from the card&n; */
DECL|function|icside_register
r_static
r_inline
r_void
id|icside_register
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|index
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
id|result
(braket
id|index
)braket
(braket
l_int|0
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|result
(braket
id|index
)braket
(braket
l_int|1
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|icside_identifyif
(paren
id|ec
)paren
)paren
(brace
r_case
id|ics_if_unknown
suffix:colon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;** Warning: ICS IDE Interface unrecognised! **&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ics_if_arcin_v5
suffix:colon
id|port
op_assign
id|ecard_address
(paren
id|ec
comma
id|ECARD_MEMC
comma
l_int|0
)paren
suffix:semicolon
id|ec-&gt;irq_data
op_assign
(paren
r_void
op_star
)paren
id|port
suffix:semicolon
id|ec-&gt;ops
op_assign
(paren
id|expansioncard_ops_t
op_star
)paren
op_amp
id|icside_ops_arcin_v5
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Be on the safe side - disable interrupts&n;&t;&t; */
id|inb
(paren
id|port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
id|result
(braket
id|index
)braket
(braket
l_int|0
)braket
op_assign
id|icside_register_port
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V5_IDEOFFSET
comma
id|port
op_plus
id|ICS_ARCIN_V5_IDEALTOFFSET
comma
id|ICS_ARCIN_V5_IDESTEPPING
comma
id|ec-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ics_if_arcin_v6
suffix:colon
id|port
op_assign
id|ecard_address
(paren
id|ec
comma
id|ECARD_IOC
comma
id|ECARD_FAST
)paren
suffix:semicolon
id|ec-&gt;irq_data
op_assign
(paren
r_void
op_star
)paren
id|port
suffix:semicolon
id|ec-&gt;ops
op_assign
(paren
id|expansioncard_ops_t
op_star
)paren
op_amp
id|icside_ops_arcin_v6
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Be on the safe side - disable interrupts&n;&t;&t; */
id|inb
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
id|result
(braket
id|index
)braket
(braket
l_int|0
)braket
op_assign
id|icside_register_port
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V6_IDEOFFSET_1
comma
id|port
op_plus
id|ICS_ARCIN_V6_IDEALTOFFSET_1
comma
id|ICS_ARCIN_V6_IDESTEPPING
comma
id|ec-&gt;irq
)paren
suffix:semicolon
id|result
(braket
id|index
)braket
(braket
l_int|1
)braket
op_assign
id|icside_register_port
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V6_IDEOFFSET_2
comma
id|port
op_plus
id|ICS_ARCIN_V6_IDEALTOFFSET_2
comma
id|ICS_ARCIN_V6_IDESTEPPING
comma
id|ec-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|icside_init
r_int
id|icside_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
id|ec
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ecard_startfind
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ec
(braket
id|i
)braket
op_assign
id|ecard_find
(paren
l_int|0
comma
id|icside_cids
)paren
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|ecard_claim
(paren
id|ec
(braket
id|i
)braket
)paren
suffix:semicolon
id|icside_register
(paren
id|ec
(braket
id|i
)braket
comma
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ec
(braket
id|i
)braket
op_logical_and
id|result
(braket
id|i
)braket
(braket
l_int|0
)braket
OL
l_int|0
op_logical_and
id|result
(braket
id|i
)braket
(braket
l_int|1
)braket
OL
l_int|0
)paren
(brace
id|ecard_release
(paren
id|ec
(braket
id|i
)braket
)paren
suffix:semicolon
id|ec
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
(brace
r_return
id|icside_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ec
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|result
(braket
id|i
)braket
(braket
l_int|0
)braket
op_ge
l_int|0
)paren
id|ide_unregister
(paren
id|result
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
(braket
id|i
)braket
(braket
l_int|1
)braket
op_ge
l_int|0
)paren
id|ide_unregister
(paren
id|result
(braket
id|i
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ecard_release
(paren
id|ec
(braket
id|i
)braket
)paren
suffix:semicolon
id|ec
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
