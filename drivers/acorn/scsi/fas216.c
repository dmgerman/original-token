multiline_comment|/*&n; *  linux/arch/arm/drivers/scsi/fas216.c&n; *&n; *  Copyright (C) 1997-2000 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Based on information in qlogicfas.c by Tom Zerucha, Michael Griffith, and&n; * other sources, including:&n; *   the AMD Am53CF94 data sheet&n; *   the AMD Am53C94 data sheet &n; *&n; * This is a generic driver.  To use it, have a look at cumana_2.c.  You&n; * should define your own structure that overlays FAS216_Info, eg:&n; * struct my_host_data {&n; *    FAS216_Info info;&n; *    ... my host specific data ...&n; * };&n; *&n; * Changelog:&n; *  30-08-1997&t;RMK&t;Created&n; *  14-09-1997&t;RMK&t;Started disconnect support&n; *  08-02-1998&t;RMK&t;Corrected real DMA support&n; *  15-02-1998&t;RMK&t;Started sync xfer support&n; *  06-04-1998&t;RMK&t;Tightened conditions for printing incomplete&n; *&t;&t;&t;transfers&n; *  02-05-1998&t;RMK&t;Added extra checks in fas216_reset&n; *  24-05-1998&t;RMK&t;Fixed synchronous transfers with period &gt;= 200ns&n; *  27-06-1998&t;RMK&t;Changed asm/delay.h to linux/delay.h&n; *  26-08-1998&t;RMK&t;Improved message support wrt MESSAGE_REJECT&n; *  02-04-2000&t;RMK&t;Converted to use the new error handling, and&n; *&t;&t;&t;automatically request sense data upon check&n; *&t;&t;&t;condition status from targets.&n; *&n; * Todo:&n; *  - allow individual devices to enable sync xfers.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
DECL|macro|FAS216_C
mdefine_line|#define FAS216_C
macro_line|#include &quot;../../scsi/scsi.h&quot;
macro_line|#include &quot;../../scsi/hosts.h&quot;
macro_line|#include &quot;fas216.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Russell King&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Generic FAS216/NCR53C9x driver&quot;
)paren
suffix:semicolon
DECL|macro|VER_MAJOR
mdefine_line|#define VER_MAJOR&t;0
DECL|macro|VER_MINOR
mdefine_line|#define VER_MINOR&t;0
DECL|macro|VER_PATCH
mdefine_line|#define VER_PATCH&t;5
multiline_comment|/* NOTE: SCSI2 Synchronous transfers *require* DMA according to&n; *  the data sheet.  This restriction is crazy, especially when&n; *  you only want to send 16 bytes!  What were the guys who&n; *  designed this chip on at that time?  Did they read the SCSI2&n; *  spec at all?  The following sections are taken from the SCSI2&n; *  standard (s2r10) concerning this:&n; *&n; * &gt; IMPLEMENTORS NOTES:&n; * &gt;   (1)  Re-negotiation at every selection is not recommended, since a&n; * &gt;   significant performance impact is likely.&n; *&n; * &gt;  The implied synchronous agreement shall remain in effect until a BUS DEVICE&n; * &gt;  RESET message is received, until a hard reset condition occurs, or until one&n; * &gt;  of the two SCSI devices elects to modify the agreement.  The default data&n; * &gt;  transfer mode is asynchronous data transfer mode.  The default data transfer&n; * &gt;  mode is entered at power on, after a BUS DEVICE RESET message, or after a hard&n; * &gt;  reset condition.&n; *&n; *  In total, this means that once you have elected to use synchronous&n; *  transfers, you must always use DMA.&n; *&n; *  I was thinking that this was a good chip until I found this restriction ;(&n; */
DECL|macro|SCSI2_SYNC
mdefine_line|#define SCSI2_SYNC
DECL|macro|SCSI2_WIDE
macro_line|#undef  SCSI2_WIDE
DECL|macro|SCSI2_TAG
macro_line|#undef  SCSI2_TAG
DECL|macro|DEBUG_CONNECT
macro_line|#undef DEBUG_CONNECT
DECL|macro|DEBUG_BUSSERVICE
macro_line|#undef DEBUG_BUSSERVICE
DECL|macro|DEBUG_FUNCTIONDONE
macro_line|#undef DEBUG_FUNCTIONDONE
DECL|macro|DEBUG_MESSAGES
macro_line|#undef DEBUG_MESSAGES
DECL|macro|CHECK_STRUCTURE
macro_line|#undef CHECK_STRUCTURE
DECL|member|stat
DECL|member|ssr
DECL|member|isr
DECL|member|ph
DECL|variable|list
r_static
r_struct
(brace
r_int
id|stat
comma
id|ssr
comma
id|isr
comma
id|ph
suffix:semicolon
)brace
id|list
(braket
l_int|8
)braket
suffix:semicolon
DECL|variable|ptr
r_static
r_int
id|ptr
suffix:semicolon
DECL|function|fas216_dumpstate
r_static
r_void
id|fas216_dumpstate
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
r_char
id|is
comma
id|stat
comma
id|inst
suffix:semicolon
id|is
op_assign
id|inb
c_func
(paren
id|REG_IS
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|stat
op_assign
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|inst
op_assign
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FAS216: CTCL=%02X CTCM=%02X CMD=%02X STAT=%02X&quot;
l_string|&quot; INST=%02X IS=%02X CFIS=%02X&quot;
comma
id|inb
c_func
(paren
id|REG_CTCL
c_func
(paren
id|info
)paren
)paren
comma
id|inb
c_func
(paren
id|REG_CTCM
c_func
(paren
id|info
)paren
)paren
comma
id|inb
c_func
(paren
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
comma
id|stat
comma
id|inst
comma
id|is
comma
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; CNTL1=%02X CNTL2=%02X CNTL3=%02X CTCH=%02X&bslash;n&quot;
comma
id|inb
c_func
(paren
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
comma
id|inb
c_func
(paren
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
comma
id|inb
c_func
(paren
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
comma
id|inb
c_func
(paren
id|REG_CTCH
c_func
(paren
id|info
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|fas216_dumpinfo
r_static
r_void
id|fas216_dumpinfo
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_static
r_int
id|used
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|used
op_increment
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FAS216_Info=&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  { magic_start=%lX host=%p SCpnt=%p origSCpnt=%p&bslash;n&quot;
comma
id|info-&gt;magic_start
comma
id|info-&gt;host
comma
id|info-&gt;SCpnt
comma
id|info-&gt;origSCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    scsi={ io_port=%X io_shift=%X irq=%X cfg={ %X %X %X %X }&bslash;n&quot;
comma
id|info-&gt;scsi.io_port
comma
id|info-&gt;scsi.io_shift
comma
id|info-&gt;scsi.irq
comma
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|info-&gt;scsi.cfg
(braket
l_int|1
)braket
comma
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
comma
id|info-&gt;scsi.cfg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;           type=%p phase=%X reconnected={ target=%d lun=%d tag=%d }&bslash;n&quot;
comma
id|info-&gt;scsi.type
comma
id|info-&gt;scsi.phase
comma
id|info-&gt;scsi.reconnected.target
comma
id|info-&gt;scsi.reconnected.lun
comma
id|info-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;           SCp={ ptr=%p this_residual=%X buffer=%p buffers_residual=%X }&bslash;n&quot;
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
comma
id|info-&gt;scsi.SCp.buffer
comma
id|info-&gt;scsi.SCp.buffers_residual
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      msgs async_stp=%X disconnectable=%d aborting=%d }&bslash;n&quot;
comma
id|info-&gt;scsi.async_stp
comma
id|info-&gt;scsi.disconnectable
comma
id|info-&gt;scsi.aborting
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    stats={ queues=%X removes=%X fins=%X reads=%X writes=%X miscs=%X&bslash;n&quot;
l_string|&quot;            disconnects=%X aborts=%X bus_resets=%X host_resets=%X}&bslash;n&quot;
comma
id|info-&gt;stats.queues
comma
id|info-&gt;stats.removes
comma
id|info-&gt;stats.fins
comma
id|info-&gt;stats.reads
comma
id|info-&gt;stats.writes
comma
id|info-&gt;stats.miscs
comma
id|info-&gt;stats.disconnects
comma
id|info-&gt;stats.aborts
comma
id|info-&gt;stats.bus_resets
comma
id|info-&gt;stats.host_resets
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    ifcfg={ clockrate=%X select_timeout=%X asyncperiod=%X sync_max_depth=%X }&bslash;n&quot;
comma
id|info-&gt;ifcfg.clockrate
comma
id|info-&gt;ifcfg.select_timeout
comma
id|info-&gt;ifcfg.asyncperiod
comma
id|info-&gt;ifcfg.sync_max_depth
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    busyluns[%d]=%X dev[%d]={ disconnect_ok=%d stp=%X sof=%X sync_state=%X }&bslash;n&quot;
comma
id|i
comma
id|info-&gt;busyluns
(braket
id|i
)braket
comma
id|i
comma
id|info-&gt;device
(braket
id|i
)braket
dot
id|disconnect_ok
comma
id|info-&gt;device
(braket
id|i
)braket
dot
id|stp
comma
id|info-&gt;device
(braket
id|i
)braket
dot
id|sof
comma
id|info-&gt;device
(braket
id|i
)braket
dot
id|sync_state
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;    dma={ transfer_type=%X setup=%p pseudo=%p stop=%p }&bslash;n&quot;
comma
id|info-&gt;dma.transfer_type
comma
id|info-&gt;dma.setup
comma
id|info-&gt;dma.pseudo
comma
id|info-&gt;dma.stop
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    internal_done=%X magic_end=%lX }&bslash;n&quot;
comma
id|info-&gt;internal_done
comma
id|info-&gt;magic_end
)paren
suffix:semicolon
)brace
macro_line|#ifdef CHECK_STRUCTURE
DECL|function|__fas216_checkmagic
r_static
r_void
id|__fas216_checkmagic
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_const
r_char
op_star
id|func
)paren
(brace
r_int
id|corruption
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;magic_start
op_ne
id|MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;FAS216 Error: magic at start corrupted&bslash;n&quot;
)paren
suffix:semicolon
id|corruption
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;magic_end
op_ne
id|MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;FAS216 Error: magic at end corrupted&bslash;n&quot;
)paren
suffix:semicolon
id|corruption
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|corruption
)paren
(brace
id|fas216_dumpinfo
c_func
(paren
id|info
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;scsi memory space corrupted in %s&quot;
comma
id|func
)paren
suffix:semicolon
)brace
)brace
DECL|macro|fas216_checkmagic
mdefine_line|#define fas216_checkmagic(info) __fas216_checkmagic((info), __FUNCTION__)
macro_line|#else
DECL|macro|fas216_checkmagic
mdefine_line|#define fas216_checkmagic(info)
macro_line|#endif
DECL|function|fas216_bus_phase
r_static
r_const
r_char
op_star
id|fas216_bus_phase
c_func
(paren
r_int
id|stat
)paren
(brace
r_static
r_const
r_char
op_star
id|phases
(braket
)braket
op_assign
(brace
l_string|&quot;DATA OUT&quot;
comma
l_string|&quot;DATA IN&quot;
comma
l_string|&quot;COMMAND&quot;
comma
l_string|&quot;STATUS&quot;
comma
l_string|&quot;MISC OUT&quot;
comma
l_string|&quot;MISC IN&quot;
comma
l_string|&quot;MESG OUT&quot;
comma
l_string|&quot;MESG IN&quot;
)brace
suffix:semicolon
r_return
id|phases
(braket
id|stat
op_amp
id|STAT_BUSMASK
)braket
suffix:semicolon
)brace
DECL|function|fas216_drv_phase
r_static
r_const
r_char
op_star
id|fas216_drv_phase
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_IDLE
suffix:colon
r_return
l_string|&quot;idle&quot;
suffix:semicolon
r_case
id|PHASE_SELECTION
suffix:colon
r_return
l_string|&quot;selection&quot;
suffix:semicolon
r_case
id|PHASE_COMMAND
suffix:colon
r_return
l_string|&quot;command&quot;
suffix:semicolon
r_case
id|PHASE_RECONNECTED
suffix:colon
r_return
l_string|&quot;reconnected&quot;
suffix:semicolon
r_case
id|PHASE_DATAOUT
suffix:colon
r_return
l_string|&quot;data out&quot;
suffix:semicolon
r_case
id|PHASE_DATAIN
suffix:colon
r_return
l_string|&quot;data in&quot;
suffix:semicolon
r_case
id|PHASE_MSGIN
suffix:colon
r_return
l_string|&quot;message in&quot;
suffix:semicolon
r_case
id|PHASE_MSGIN_DISCONNECT
suffix:colon
r_return
l_string|&quot;disconnect&quot;
suffix:semicolon
r_case
id|PHASE_MSGOUT_EXPECT
suffix:colon
r_return
l_string|&quot;expect message out&quot;
suffix:semicolon
r_case
id|PHASE_MSGOUT
suffix:colon
r_return
l_string|&quot;message out&quot;
suffix:semicolon
r_case
id|PHASE_STATUS
suffix:colon
r_return
l_string|&quot;status&quot;
suffix:semicolon
r_case
id|PHASE_DONE
suffix:colon
r_return
l_string|&quot;done&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;???&quot;
suffix:semicolon
)brace
)brace
DECL|function|fas216_target
r_static
r_char
id|fas216_target
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;SCpnt
)paren
r_return
l_char|&squot;0&squot;
op_plus
id|info-&gt;SCpnt-&gt;target
suffix:semicolon
r_else
r_return
l_char|&squot;H&squot;
suffix:semicolon
)brace
DECL|function|add_debug_list
r_static
r_void
id|add_debug_list
c_func
(paren
r_int
id|stat
comma
r_int
id|ssr
comma
r_int
id|isr
comma
r_int
id|ph
)paren
(brace
id|list
(braket
id|ptr
)braket
dot
id|stat
op_assign
id|stat
suffix:semicolon
id|list
(braket
id|ptr
)braket
dot
id|ssr
op_assign
id|ssr
suffix:semicolon
id|list
(braket
id|ptr
)braket
dot
id|isr
op_assign
id|isr
suffix:semicolon
id|list
(braket
id|ptr
)braket
dot
id|ph
op_assign
id|ph
suffix:semicolon
id|ptr
op_assign
(paren
id|ptr
op_plus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
)brace
DECL|function|print_debug_list
r_static
r_void
id|print_debug_list
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|ptr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SCSI IRQ trail: &quot;
)paren
suffix:semicolon
r_do
(brace
id|printk
c_func
(paren
l_string|&quot;%02X:%02X:%02X:%1X &quot;
comma
id|list
(braket
id|i
)braket
dot
id|stat
comma
id|list
(braket
id|i
)braket
dot
id|ssr
comma
id|list
(braket
id|i
)braket
dot
id|isr
comma
id|list
(braket
id|i
)braket
dot
id|ph
)paren
suffix:semicolon
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ne
id|ptr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
id|fas216_done
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|result
)paren
suffix:semicolon
multiline_comment|/* Function: int fas216_clockrate(unsigned int clock)&n; * Purpose : calculate correct value to be written into clock conversion&n; *&t;     factor register.&n; * Params  : clock - clock speed in MHz&n; * Returns : CLKF_ value&n; */
DECL|function|fas216_clockrate
r_static
r_int
id|fas216_clockrate
c_func
(paren
r_int
id|clock
)paren
(brace
r_if
c_cond
(paren
id|clock
op_le
l_int|10
op_logical_or
id|clock
OG
l_int|40
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;fas216: invalid clock rate: check your driver!&bslash;n&quot;
)paren
suffix:semicolon
id|clock
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|clock
op_assign
(paren
(paren
id|clock
op_minus
l_int|1
)paren
op_div
l_int|5
op_plus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
r_return
id|clock
suffix:semicolon
)brace
multiline_comment|/* Function: unsigned short fas216_get_last_msg(FAS216_Info *info, int pos)&n; * Purpose : retrieve a last message from the list, using position in fifo&n; * Params  : info - interface to search&n; *         : pos  - current fifo position&n; */
r_static
r_inline
r_int
r_int
DECL|function|fas216_get_last_msg
id|fas216_get_last_msg
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|pos
)paren
(brace
r_int
r_int
id|packed_msg
op_assign
id|NOP
suffix:semicolon
r_struct
id|message
op_star
id|msg
suffix:semicolon
r_int
id|msgnr
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
id|msgnr
op_increment
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pos
op_ge
id|msg-&gt;fifo
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg
)paren
(brace
r_if
c_cond
(paren
id|msg-&gt;msg
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
id|packed_msg
op_assign
id|EXTENDED_MESSAGE
op_or
id|msg-&gt;msg
(braket
l_int|2
)braket
op_lshift
l_int|8
suffix:semicolon
r_else
id|packed_msg
op_assign
id|msg-&gt;msg
(braket
l_int|0
)braket
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MESSAGES
id|printk
c_func
(paren
l_string|&quot;Message: %04X found at position %02X&bslash;n&quot;
comma
id|packed_msg
comma
id|pos
)paren
suffix:semicolon
macro_line|#endif
r_return
id|packed_msg
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_syncperiod(FAS216_Info *info, int ns)&n; * Purpose : Calculate value to be loaded into the STP register&n; *           for a given period in ns&n; * Params  : info - state structure for interface connected to device&n; *         : ns   - period in ns (between subsequent bytes)&n; * Returns : Value suitable for REG_STP&n; */
r_static
r_int
DECL|function|fas216_syncperiod
id|fas216_syncperiod
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|ns
)paren
(brace
r_int
id|value
op_assign
(paren
id|info-&gt;ifcfg.clockrate
op_star
id|ns
)paren
op_div
l_int|1000
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|4
)paren
id|value
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|value
OG
l_int|35
)paren
id|value
op_assign
l_int|35
suffix:semicolon
r_return
id|value
op_amp
l_int|31
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_set_sync(FAS216_Info *info, int target)&n; * Purpose : Correctly setup FAS216 chip for specified transfer period.&n; * Params  : info   - state structure for interface&n; *         : target - target&n; * Notes   : we need to switch the chip out of FASTSCSI mode if we have&n; *           a transfer period &gt;= 200ns - otherwise the chip will violate&n; *           the SCSI timings.&n; */
r_static
r_void
DECL|function|fas216_set_sync
id|fas216_set_sync
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|target
)paren
(brace
id|outb
c_func
(paren
id|info-&gt;device
(braket
id|target
)braket
dot
id|sof
comma
id|REG_SOF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;device
(braket
id|target
)braket
dot
id|stp
comma
id|REG_STP
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|target
)braket
dot
id|period
op_ge
(paren
l_int|200
op_div
l_int|4
)paren
)paren
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
op_amp
op_complement
id|CNTL3_FASTSCSI
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Synchronous transfer support&n; *&n; * Note: The SCSI II r10 spec says (5.6.12):&n; *&n; *  (2)  Due to historical problems with early host adapters that could&n; *  not accept an SDTR message, some targets may not initiate synchronous&n; *  negotiation after a power cycle as required by this standard.  Host&n; *  adapters that support synchronous mode may avoid the ensuing failure&n; *  modes when the target is independently power cycled by initiating a&n; *  synchronous negotiation on each REQUEST SENSE and INQUIRY command.&n; *  This approach increases the SCSI bus overhead and is not recommended&n; *  for new implementations.  The correct method is to respond to an&n; *  SDTR message with a MESSAGE REJECT message if the either the&n; *  initiator or target devices does not support synchronous transfers&n; *  or does not want to negotiate for synchronous transfers at the time.&n; *  Using the correct method assures compatibility with wide data&n; *  transfers and future enhancements.&n; *&n; * We will always initiate a synchronous transfer negociation request on&n; * every INQUIRY or REQUEST SENSE message, unless the target itself has&n; * at some point performed a synchronous transfer negociation request, or&n; * we have synchronous transfers disabled for this device.&n; */
multiline_comment|/* Function: void fas216_handlesync(FAS216_Info *info, char *msg)&n; * Purpose : Handle a synchronous transfer message from the target&n; * Params  : info - state structure for interface&n; *         : msg  - message from target&n; */
r_static
r_void
DECL|function|fas216_handlesync
id|fas216_handlesync
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_char
op_star
id|msg
)paren
(brace
r_struct
id|fas216_device
op_star
id|dev
op_assign
op_amp
id|info-&gt;device
(braket
id|info-&gt;SCpnt-&gt;target
)braket
suffix:semicolon
r_enum
(brace
id|sync
comma
id|async
comma
id|none
comma
id|reject
)brace
id|res
op_assign
id|none
suffix:semicolon
macro_line|#ifdef SCSI2_SYNC
r_switch
c_cond
(paren
id|msg
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MESSAGE_REJECT
suffix:colon
multiline_comment|/* Synchronous transfer request failed.&n;&t;&t; * Note: SCSI II r10:&n;&t;&t; *&n;&t;&t; *  SCSI devices that are capable of synchronous&n;&t;&t; *  data transfers shall not respond to an SDTR&n;&t;&t; *  message with a MESSAGE REJECT message.&n;&t;&t; *&n;&t;&t; * Hence, if we get this condition, we disable&n;&t;&t; * negociation for this device.&n;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;sync_state
op_eq
id|neg_inprogress
)paren
(brace
id|dev-&gt;sync_state
op_assign
id|neg_invalid
suffix:semicolon
id|res
op_assign
id|async
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_switch
c_cond
(paren
id|dev-&gt;sync_state
)paren
(brace
multiline_comment|/* We don&squot;t accept synchronous transfer requests.&n;&t;&t; * Respond with a MESSAGE_REJECT to prevent a&n;&t;&t; * synchronous transfer agreement from being reached.&n;&t;&t; */
r_case
id|neg_invalid
suffix:colon
id|res
op_assign
id|reject
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* We were not negociating a synchronous transfer,&n;&t;&t; * but the device sent us a negociation request.&n;&t;&t; * Honour the request by sending back a SDTR&n;&t;&t; * message containing our capability, limited by&n;&t;&t; * the targets capability.&n;&t;&t; */
r_default
suffix:colon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
OG
id|info-&gt;ifcfg.sync_max_depth
)paren
id|msg
(braket
l_int|4
)braket
op_assign
id|info-&gt;ifcfg.sync_max_depth
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|3
)braket
OL
l_int|1000
op_div
id|info-&gt;ifcfg.clockrate
)paren
id|msg
(braket
l_int|3
)braket
op_assign
l_int|1000
op_div
id|info-&gt;ifcfg.clockrate
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|5
comma
id|EXTENDED_MESSAGE
comma
l_int|3
comma
id|EXTENDED_SDTR
comma
id|msg
(braket
l_int|3
)braket
comma
id|msg
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
multiline_comment|/* This is wrong.  The agreement is not in effect&n;&t;&t;&t; * until this message is accepted by the device&n;&t;&t;&t; */
id|dev-&gt;sync_state
op_assign
id|neg_targcomplete
suffix:semicolon
id|res
op_assign
id|sync
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* We initiated the synchronous transfer negociation,&n;&t;&t; * and have successfully received a response from the&n;&t;&t; * target.  The synchronous transfer agreement has been&n;&t;&t; * reached.  Note: if the values returned are out of our&n;&t;&t; * bounds, we must reject the message.&n;&t;&t; */
r_case
id|neg_inprogress
suffix:colon
id|res
op_assign
id|reject
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_le
id|info-&gt;ifcfg.sync_max_depth
op_logical_and
id|msg
(braket
l_int|3
)braket
op_ge
l_int|1000
op_div
id|info-&gt;ifcfg.clockrate
)paren
(brace
id|dev-&gt;sync_state
op_assign
id|neg_complete
suffix:semicolon
id|res
op_assign
id|sync
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
macro_line|#else
id|res
op_assign
id|reject
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|res
)paren
(brace
r_case
id|sync
suffix:colon
id|dev-&gt;period
op_assign
id|msg
(braket
l_int|3
)braket
suffix:semicolon
id|dev-&gt;sof
op_assign
id|msg
(braket
l_int|4
)braket
suffix:semicolon
id|dev-&gt;stp
op_assign
id|fas216_syncperiod
c_func
(paren
id|info
comma
id|msg
(braket
l_int|3
)braket
op_star
l_int|4
)paren
suffix:semicolon
id|fas216_set_sync
c_func
(paren
id|info
comma
id|info-&gt;SCpnt-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|reject
suffix:colon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
r_case
id|async
suffix:colon
id|dev-&gt;period
op_assign
id|info-&gt;ifcfg.asyncperiod
op_div
l_int|4
suffix:semicolon
id|dev-&gt;sof
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;stp
op_assign
id|info-&gt;scsi.async_stp
suffix:semicolon
id|fas216_set_sync
c_func
(paren
id|info
comma
id|info-&gt;SCpnt-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|none
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_handlewide(FAS216_Info *info, char *msg)&n; * Purpose : Handle a wide transfer message from the target&n; * Params  : info - state structure for interface&n; *         : msg  - message from target&n; */
r_static
r_void
DECL|function|fas216_handlewide
id|fas216_handlewide
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_char
op_star
id|msg
)paren
(brace
r_struct
id|fas216_device
op_star
id|dev
op_assign
op_amp
id|info-&gt;device
(braket
id|info-&gt;SCpnt-&gt;target
)braket
suffix:semicolon
r_enum
(brace
id|wide
comma
id|bit8
comma
id|none
comma
id|reject
)brace
id|res
op_assign
id|none
suffix:semicolon
macro_line|#ifdef SCSI2_WIDE
r_switch
c_cond
(paren
id|msg
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MESSAGE_REJECT
suffix:colon
multiline_comment|/* Wide transfer request failed.&n;&t;&t; * Note: SCSI II r10:&n;&t;&t; *&n;&t;&t; *  SCSI devices that are capable of wide&n;&t;&t; *  data transfers shall not respond to a&n;&t;&t; *  WDTR message with a MESSAGE REJECT message.&n;&t;&t; *&n;&t;&t; * Hence, if we get this condition, we never&n;&t;&t; * reattempt negociation for this device.&n;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;wide_state
op_eq
id|neg_inprogress
)paren
(brace
id|dev-&gt;wide_state
op_assign
id|neg_invalid
suffix:semicolon
id|res
op_assign
id|bit8
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_switch
c_cond
(paren
id|dev-&gt;wide_state
)paren
(brace
multiline_comment|/* We don&squot;t accept wide data transfer requests.&n;&t;&t; * Respond with a MESSAGE REJECT to prevent a&n;&t;&t; * wide data transfer agreement from being reached.&n;&t;&t; */
r_case
id|neg_invalid
suffix:colon
id|res
op_assign
id|reject
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* We were not negociating a wide data transfer,&n;&t;&t; * but the device sent is a negociation request.&n;&t;&t; * Honour the request by sending back a WDTR&n;&t;&t; * message containing our capability, limited by&n;&t;&t; * the targets capability.&n;&t;&t; */
r_default
suffix:colon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|3
)braket
OG
id|info-&gt;ifcfg.wide_max_size
)paren
id|msg
(braket
l_int|3
)braket
op_assign
id|info-&gt;ifcfg.wide_max_size
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|4
comma
id|EXTENDED_MESSAGE
comma
l_int|2
comma
id|EXTENDED_WDTR
comma
id|msg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
id|res
op_assign
id|wide
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* We initiated the wide data transfer negociation,&n;&t;&t; * and have successfully received a response from the&n;&t;&t; * target.  The synchronous transfer agreement has been&n;&t;&t; * reached.  Note: if the values returned are out of our&n;&t;&t; * bounds, we must reject the message.&n;&t;&t; */
r_case
id|neg_inprogress
suffix:colon
id|res
op_assign
id|reject
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|3
)braket
op_le
id|info-&gt;ifcfg.wide_max_size
)paren
(brace
id|dev-&gt;wide_state
op_assign
id|neg_complete
suffix:semicolon
id|res
op_assign
id|wide
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
macro_line|#else
id|res
op_assign
id|reject
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|res
)paren
(brace
r_case
id|wide
suffix:colon
id|dev-&gt;wide_xfer
op_assign
id|msg
(braket
l_int|3
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|reject
suffix:colon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
r_case
id|bit8
suffix:colon
id|dev-&gt;wide_xfer
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|none
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_updateptrs(FAS216_Info *info, int bytes_transferred)&n; * Purpose : update data pointers after transfer suspended/paused&n; * Params  : info              - interface&squot;s local pointer to update&n; *           bytes_transferred - number of bytes transferred&n; */
r_static
r_void
DECL|function|fas216_updateptrs
id|fas216_updateptrs
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|bytes_transferred
)paren
(brace
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|residual
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|ptr
op_assign
id|info-&gt;scsi.SCp.ptr
suffix:semicolon
id|residual
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
id|info-&gt;SCpnt-&gt;request_bufflen
op_sub_assign
id|bytes_transferred
suffix:semicolon
r_while
c_loop
(paren
id|residual
op_le
id|bytes_transferred
op_logical_and
id|bytes_transferred
)paren
(brace
multiline_comment|/* We have used up this buffer */
id|bytes_transferred
op_sub_assign
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.buffers_residual
)paren
(brace
id|info-&gt;scsi.SCp.buffer
op_increment
suffix:semicolon
id|info-&gt;scsi.SCp.buffers_residual
op_decrement
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|info-&gt;scsi.SCp.buffer-&gt;address
suffix:semicolon
id|residual
op_assign
id|info-&gt;scsi.SCp.buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|residual
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|residual
op_sub_assign
id|bytes_transferred
suffix:semicolon
id|ptr
op_add_assign
id|bytes_transferred
suffix:semicolon
r_if
c_cond
(paren
id|residual
op_eq
l_int|0
)paren
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;scsi.SCp.ptr
op_assign
id|ptr
suffix:semicolon
id|info-&gt;scsi.SCp.this_residual
op_assign
id|residual
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_pio(FAS216_Info *info, fasdmadir_t direction)&n; * Purpose : transfer data off of/on to card using programmed IO&n; * Params  : info      - interface to transfer data to/from&n; *           direction - direction to transfer data (DMA_OUT/DMA_IN)&n; * Notes   : this is incredibly slow&n; */
r_static
r_void
DECL|function|fas216_pio
id|fas216_pio
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|fasdmadir_t
id|direction
)paren
(brace
r_int
r_int
id|residual
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|residual
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
id|ptr
op_assign
id|info-&gt;scsi.SCp.ptr
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|DMA_OUT
)paren
id|outb
c_func
(paren
op_star
id|ptr
op_increment
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_else
op_star
id|ptr
op_increment
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|residual
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|residual
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.buffers_residual
)paren
(brace
id|info-&gt;scsi.SCp.buffer
op_increment
suffix:semicolon
id|info-&gt;scsi.SCp.buffers_residual
op_decrement
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|info-&gt;scsi.SCp.buffer-&gt;address
suffix:semicolon
id|residual
op_assign
id|info-&gt;scsi.SCp.buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|residual
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|info-&gt;scsi.SCp.ptr
op_assign
id|ptr
suffix:semicolon
id|info-&gt;scsi.SCp.this_residual
op_assign
id|residual
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_starttransfer(FAS216_Info *info,&n; *&t;&t;&t;&t;       fasdmadir_t direction)&n; * Purpose : Start a DMA/PIO transfer off of/on to card&n; * Params  : info      - interface from which device disconnected from&n; *           direction - transfer direction (DMA_OUT/DMA_IN)&n; */
r_static
r_void
DECL|function|fas216_starttransfer
id|fas216_starttransfer
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|fasdmadir_t
id|direction
comma
r_int
id|flush_fifo
)paren
(brace
id|fasdmatype_t
id|dmatype
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
(paren
id|direction
op_eq
id|DMA_OUT
)paren
ques
c_cond
id|PHASE_DATAOUT
suffix:colon
id|PHASE_DATAIN
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_ne
id|fasdma_none
op_logical_and
id|info-&gt;dma.transfer_type
op_ne
id|fasdma_pio
)paren
(brace
r_int
r_int
id|total
comma
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_all
)paren
id|total
op_assign
id|info-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
r_else
id|total
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
id|residual
op_assign
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_plus
id|inb
c_func
(paren
id|REG_CTCL
c_func
(paren
id|info
)paren
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCM
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCH
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|fas216_updateptrs
c_func
(paren
id|info
comma
id|total
op_minus
id|residual
)paren
suffix:semicolon
)brace
id|info-&gt;dma.transfer_type
op_assign
id|fasdma_none
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;scsi.SCp.ptr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: null buffer passed to &quot;
l_string|&quot;fas216_starttransfer&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* flush FIFO */
r_if
c_cond
(paren
id|flush_fifo
)paren
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Default to PIO mode or DMA mode if we have a synchronous&n;&t; * transfer agreement.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|info-&gt;SCpnt-&gt;target
)braket
dot
id|sof
op_logical_and
id|info-&gt;dma.setup
)paren
id|dmatype
op_assign
id|fasdma_real_all
suffix:semicolon
r_else
id|dmatype
op_assign
id|fasdma_pio
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.setup
)paren
id|dmatype
op_assign
id|info-&gt;dma
dot
id|setup
c_func
(paren
id|info-&gt;host
comma
op_amp
id|info-&gt;scsi.SCp
comma
id|direction
comma
id|dmatype
)paren
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|dmatype
suffix:semicolon
r_switch
c_cond
(paren
id|dmatype
)paren
(brace
r_case
id|fasdma_pio
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|REG_SOF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.async_stp
comma
id|REG_STP
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_pio
c_func
(paren
id|info
comma
id|direction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|fasdma_pseudo
suffix:colon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;dma
dot
id|pseudo
c_func
(paren
id|info-&gt;host
comma
op_amp
id|info-&gt;scsi.SCp
comma
id|direction
comma
id|info-&gt;SCpnt-&gt;transfersize
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|fasdma_real_block
suffix:colon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|fasdma_real_all
suffix:colon
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;request_bufflen
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;request_bufflen
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;request_bufflen
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%d: invalid FAS216 DMA type&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_stoptransfer(FAS216_Info *info)&n; * Purpose : Stop a DMA transfer onto / off of the card&n; * Params  : info      - interface from which device disconnected from&n; */
r_static
r_void
DECL|function|fas216_stoptransfer
id|fas216_stoptransfer
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_ne
id|fasdma_none
op_logical_and
id|info-&gt;dma.transfer_type
op_ne
id|fasdma_pio
)paren
(brace
r_int
r_int
id|total
comma
id|residual
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_all
op_logical_or
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_block
)paren
op_logical_and
id|info-&gt;dma.stop
)paren
id|info-&gt;dma
dot
id|stop
c_func
(paren
id|info-&gt;host
comma
op_amp
id|info-&gt;scsi.SCp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_all
)paren
id|total
op_assign
id|info-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
r_else
id|total
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
id|residual
op_assign
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_plus
id|inb
c_func
(paren
id|REG_CTCL
c_func
(paren
id|info
)paren
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCM
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCH
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|fas216_updateptrs
c_func
(paren
id|info
comma
id|total
op_minus
id|residual
)paren
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|fasdma_none
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;scsi.phase
op_eq
id|PHASE_DATAOUT
)paren
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_disconnected_intr(FAS216_Info *info)&n; * Purpose : handle device disconnection&n; * Params  : info - interface from which device disconnected from&n; */
r_static
r_void
DECL|function|fas216_disconnect_intr
id|fas216_disconnect_intr
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: disconnect phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_SELECTION
suffix:colon
multiline_comment|/* while selecting - no target&t;&t;*/
r_case
id|PHASE_SELSTEPS
suffix:colon
id|fas216_done
c_func
(paren
id|info
comma
id|DID_NO_CONNECT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_MSGIN_DISCONNECT
suffix:colon
multiline_comment|/* message in - disconnecting&t;&t;*/
id|outb
c_func
(paren
id|CMD_ENABLESEL
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.disconnectable
op_assign
l_int|1
suffix:semicolon
id|info-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
id|info-&gt;stats.disconnects
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_DONE
suffix:colon
multiline_comment|/* at end of command - complete&t;&t;*/
id|fas216_done
c_func
(paren
id|info
comma
id|DID_OK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_MSGOUT
suffix:colon
multiline_comment|/* message out - possible ABORT message&t;*/
r_if
c_cond
(paren
id|fas216_get_last_msg
c_func
(paren
id|info
comma
id|info-&gt;scsi.msgin_fifo
)paren
op_eq
id|ABORT
)paren
(brace
id|info-&gt;scsi.aborting
op_assign
l_int|0
suffix:semicolon
id|fas216_done
c_func
(paren
id|info
comma
id|DID_ABORT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* huh?&t;&t;&t;&t;&t;*/
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: unexpected disconnect in phase %s&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|fas216_drv_phase
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|print_debug_list
c_func
(paren
)paren
suffix:semicolon
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|fas216_done
c_func
(paren
id|info
comma
id|DID_ERROR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_reselected_intr(FAS216_Info *info)&n; * Purpose : Start reconnection of a device&n; * Params  : info - interface which was reselected&n; */
r_static
r_void
DECL|function|fas216_reselected_intr
id|fas216_reselected_intr
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
r_char
id|target
comma
id|identify_msg
comma
id|ok
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;scsi.phase
op_eq
id|PHASE_SELECTION
op_logical_or
id|info-&gt;scsi.phase
op_eq
id|PHASE_SELSTEPS
)paren
op_logical_and
id|info-&gt;SCpnt
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|info-&gt;SCpnt
suffix:semicolon
id|info-&gt;origSCpnt
op_assign
id|SCpnt
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|wide_state
op_eq
id|neg_inprogress
)paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|wide_state
op_assign
id|neg_wait
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|sync_state
op_eq
id|neg_inprogress
)paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|sync_state
op_assign
id|neg_wait
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reconnect phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_ne
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: incorrect number of bytes after reselect&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|INITIATOR_ERROR
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|target
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|identify_msg
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|target
op_amp
(paren
l_int|1
op_lshift
id|info-&gt;host-&gt;this_id
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: invalid host id on reselect&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|identify_msg
op_amp
l_int|0x80
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: no IDENTIFY message on reselect, got msg %02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|identify_msg
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
multiline_comment|/*&n;&t;&t; * Something went wrong - send an initiator error to&n;&t;&t; * the target.&n;&t;&t; */
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|INITIATOR_ERROR
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|target
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|info-&gt;host-&gt;this_id
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|target
)paren
(brace
r_case
l_int|1
suffix:colon
id|target
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|target
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|target
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|target
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|target
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|target
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|target
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|128
suffix:colon
id|target
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|target
op_assign
id|info-&gt;host-&gt;this_id
suffix:semicolon
r_break
suffix:semicolon
)brace
id|identify_msg
op_and_assign
l_int|7
suffix:semicolon
id|info-&gt;scsi.reconnected.target
op_assign
id|target
suffix:semicolon
id|info-&gt;scsi.reconnected.lun
op_assign
id|identify_msg
suffix:semicolon
id|info-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
op_logical_and
id|info-&gt;SCpnt
op_logical_and
id|info-&gt;SCpnt-&gt;target
op_eq
id|target
op_logical_and
id|info-&gt;SCpnt-&gt;lun
op_eq
id|identify_msg
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
op_logical_and
id|queue_probetgtlun
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|target
comma
id|identify_msg
)paren
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
(brace
id|info-&gt;scsi.phase
op_assign
id|PHASE_RECONNECTED
suffix:semicolon
id|outb
c_func
(paren
id|target
comma
id|REG_SDID
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Our command structure not found - abort the&n;&t;&t; * command on the target.  Since we have no&n;&t;&t; * record of this command, we can&squot;t send&n;&t;&t; * an INITIATOR DETECTED ERROR message.&n;&t;&t; */
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_finish_reconnect(FAS216_Info *info)&n; * Purpose : finish reconnection sequence for device&n; * Params  : info - interface which caused function done interrupt&n; */
r_static
r_void
DECL|function|fas216_finish_reconnect
id|fas216_finish_reconnect
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;Connected: %1X %1X %02X, reconnected: %1X %1X %02X&bslash;n&quot;
comma
id|info-&gt;SCpnt-&gt;target
comma
id|info-&gt;SCpnt-&gt;lun
comma
id|info-&gt;SCpnt-&gt;tag
comma
id|info-&gt;scsi.reconnected.target
comma
id|info-&gt;scsi.reconnected.lun
comma
id|info-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
op_logical_and
id|info-&gt;SCpnt
)paren
(brace
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;SCpnt-&gt;target
op_eq
id|info-&gt;scsi.reconnected.target
op_logical_and
id|info-&gt;SCpnt-&gt;lun
op_eq
id|info-&gt;scsi.reconnected.lun
op_logical_and
id|info-&gt;SCpnt-&gt;tag
op_eq
id|info-&gt;scsi.reconnected.tag
)paren
(brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reconnected&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|queue_add_cmd_tail
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|info-&gt;SCpnt
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: had to move command to disconnected queue&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;SCpnt
)paren
(brace
id|info-&gt;SCpnt
op_assign
id|queue_remove_tgtluntag
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|info-&gt;scsi.reconnected.target
comma
id|info-&gt;scsi.reconnected.lun
comma
id|info-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: had to get command&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;SCpnt
)paren
(brace
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|info-&gt;scsi.reconnected.tag
)paren
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|2
comma
id|ABORT_TAG
comma
id|info-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
r_else
macro_line|#endif
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Restore data pointer from SAVED data pointer&n;&t;&t; */
id|info-&gt;scsi.SCp
op_assign
id|info-&gt;SCpnt-&gt;SCp
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;, data pointers: [%p, %X]&quot;
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|fas216_wait_cmd
r_static
r_int
id|fas216_wait_cmd
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|cmd
)paren
(brace
r_int
id|tout
suffix:semicolon
r_int
id|stat
suffix:semicolon
id|outb
c_func
(paren
id|cmd
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tout
op_assign
l_int|1000
suffix:semicolon
id|tout
suffix:semicolon
id|tout
op_sub_assign
l_int|1
)paren
(brace
id|stat
op_assign
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_INT
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|stat
suffix:semicolon
)brace
DECL|function|fas216_get_msg_byte
r_static
r_int
id|fas216_get_msg_byte
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
id|stat
suffix:semicolon
id|stat
op_assign
id|fas216_wait_cmd
c_func
(paren
id|info
comma
id|CMD_MSGACCEPTED
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_INT
)paren
op_eq
l_int|0
)paren
r_goto
id|timedout
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
op_ne
id|STAT_MESGIN
)paren
r_goto
id|unexpected_phase_change
suffix:semicolon
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|stat
op_assign
id|fas216_wait_cmd
c_func
(paren
id|info
comma
id|CMD_TRANSFERINFO
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_INT
)paren
op_eq
l_int|0
)paren
r_goto
id|timedout
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
op_ne
id|STAT_MESGIN
)paren
r_goto
id|unexpected_phase_change
suffix:semicolon
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|timedout
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: timed out waiting for message byte&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
id|unexpected_phase_change
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: unexpected phase change: status = %02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|stat
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_message(FAS216_Info *info)&n; * Purpose : handle a function done interrupt from FAS216 chip&n; * Params  : info - interface which caused function done interrupt&n; */
DECL|function|fas216_message
r_static
r_void
id|fas216_message
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
r_char
op_star
id|message
op_assign
id|info-&gt;scsi.message
suffix:semicolon
r_int
r_int
id|msglen
op_assign
l_int|1
comma
id|i
suffix:semicolon
r_int
id|msgbyte
op_assign
l_int|0
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|message
(braket
l_int|0
)braket
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
id|msgbyte
op_assign
id|fas216_get_msg_byte
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgbyte
op_ge
l_int|0
)paren
(brace
id|message
(braket
l_int|1
)braket
op_assign
id|msgbyte
suffix:semicolon
r_for
c_loop
(paren
id|msglen
op_assign
l_int|2
suffix:semicolon
id|msglen
OL
id|message
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
id|msglen
op_increment
)paren
(brace
id|msgbyte
op_assign
id|fas216_get_msg_byte
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgbyte
op_ge
l_int|0
)paren
id|message
(braket
id|msglen
)braket
op_assign
id|msgbyte
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
)brace
)brace
id|info-&gt;scsi.msglen
op_assign
id|msglen
suffix:semicolon
macro_line|#ifdef DEBUG_MESSAGES
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: message in: &quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msglen
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|message
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;scsi.phase
op_eq
id|PHASE_RECONNECTED
)paren
(brace
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|SIMPLE_QUEUE_TAG
)paren
id|info-&gt;scsi.reconnected.tag
op_assign
id|message
(braket
l_int|1
)braket
suffix:semicolon
id|fas216_finish_reconnect
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|message
(braket
l_int|0
)braket
)paren
(brace
r_case
id|COMMAND_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|msglen
op_ne
l_int|1
)paren
r_goto
id|unrecognised
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: command complete with no &quot;
l_string|&quot;status in MESSAGE_IN?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
r_if
c_cond
(paren
id|msglen
op_ne
l_int|1
)paren
r_goto
id|unrecognised
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Save current data pointer to SAVED data pointer&n;&t;&t; * SCSI II standard says that we must not acknowledge&n;&t;&t; * this until we have really saved pointers.&n;&t;&t; * NOTE: we DO NOT save the command nor status pointers&n;&t;&t; * as required by the SCSI II standard.  These always&n;&t;&t; * point to the start of their respective areas.&n;&t;&t; */
id|info-&gt;SCpnt-&gt;SCp
op_assign
id|info-&gt;scsi.SCp
suffix:semicolon
id|info-&gt;SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined (DEBUG_MESSAGES) || defined (DEBUG_CONNECT)
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: save data pointers: [%p, %X]&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|RESTORE_POINTERS
suffix:colon
r_if
c_cond
(paren
id|msglen
op_ne
l_int|1
)paren
r_goto
id|unrecognised
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Restore current data pointer from SAVED data pointer&n;&t;&t; */
id|info-&gt;scsi.SCp
op_assign
id|info-&gt;SCpnt-&gt;SCp
suffix:semicolon
macro_line|#if defined (DEBUG_MESSAGES) || defined (DEBUG_CONNECT)
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: restore data pointers: [%p, %X]&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|DISCONNECT
suffix:colon
r_if
c_cond
(paren
id|msglen
op_ne
l_int|1
)paren
r_goto
id|unrecognised
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
r_if
c_cond
(paren
id|msglen
op_ne
l_int|1
)paren
r_goto
id|unrecognised
suffix:semicolon
r_switch
c_cond
(paren
id|fas216_get_last_msg
c_func
(paren
id|info
comma
id|info-&gt;scsi.msgin_fifo
)paren
)paren
(brace
r_case
id|EXTENDED_MESSAGE
op_or
id|EXTENDED_SDTR
op_lshift
l_int|8
suffix:colon
id|fas216_handlesync
c_func
(paren
id|info
comma
id|message
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
op_or
id|EXTENDED_WDTR
op_lshift
l_int|8
suffix:colon
id|fas216_handlewide
c_func
(paren
id|info
comma
id|message
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reject, last message %04X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|fas216_get_last_msg
c_func
(paren
id|info
comma
id|info-&gt;scsi.msgin_fifo
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|NOP
suffix:colon
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
r_if
c_cond
(paren
id|msglen
OL
l_int|2
)paren
r_goto
id|unrecognised
suffix:semicolon
multiline_comment|/* handled above - print a warning since this is untested */
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reconnect queue tag %02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|message
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_if
c_cond
(paren
id|msglen
OL
l_int|3
)paren
r_goto
id|unrecognised
suffix:semicolon
r_switch
c_cond
(paren
id|message
(braket
l_int|2
)braket
)paren
(brace
r_case
id|EXTENDED_SDTR
suffix:colon
multiline_comment|/* Sync transfer negociation request/reply */
id|fas216_handlesync
c_func
(paren
id|info
comma
id|message
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_WDTR
suffix:colon
multiline_comment|/* Wide transfer negociation request/reply */
id|fas216_handlewide
c_func
(paren
id|info
comma
id|message
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|unrecognised
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|unrecognised
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|unrecognised
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: unrecognised message, rejecting&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: message was&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msglen
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s%02X&quot;
comma
id|i
op_amp
l_int|31
ques
c_cond
l_string|&quot; &quot;
suffix:colon
l_string|&quot;&bslash;n  &quot;
comma
id|message
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Something strange seems to be happening here -&n;&t; * I can&squot;t use SETATN since the chip gives me an&n;&t; * invalid command interrupt when I do.  Weird.&n;&t; */
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_dumpstate
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
id|fas216_dumpstate
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_send_command(FAS216_Info *info)&n; * Purpose : send a command to a target after all message bytes have been sent&n; * Params  : info - interface which caused bus service&n; */
DECL|function|fas216_send_command
r_static
r_void
id|fas216_send_command
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* load command */
r_for
c_loop
(paren
id|i
op_assign
id|info-&gt;scsi.SCp.sent_command
suffix:semicolon
id|i
OL
id|info-&gt;SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;cmnd
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_COMMAND
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_send_messageout(FAS216_Info *info, int start)&n; * Purpose : handle bus service to send a message&n; * Params  : info - interface which caused bus service&n; * Note    : We do not allow the device to change the data direction!&n; */
DECL|function|fas216_send_messageout
r_static
r_void
id|fas216_send_messageout
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|start
)paren
(brace
r_int
r_int
id|tot_msglen
op_assign
id|msgqueue_msglength
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tot_msglen
)paren
(brace
r_struct
id|message
op_star
id|msg
suffix:semicolon
r_int
id|msgnr
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
id|msgnr
op_increment
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|start
suffix:semicolon
id|i
OL
id|msg-&gt;length
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|msg-&gt;msg
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msg-&gt;fifo
op_assign
id|tot_msglen
op_minus
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
suffix:semicolon
id|start
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
id|outb
c_func
(paren
id|NOP
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_busservice_intr(FAS216_Info *info, unsigned int stat, unsigned int ssr)&n; * Purpose : handle a bus service interrupt from FAS216 chip&n; * Params  : info - interface which caused bus service interrupt&n; *           stat - Status register contents&n; *           ssr  - SCSI Status register contents&n; */
DECL|function|fas216_busservice_intr
r_static
r_void
id|fas216_busservice_intr
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|stat
comma
r_int
r_int
id|ssr
)paren
(brace
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_BUSSERVICE
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: bus service: stat=%02X ssr=%02X phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|stat
comma
id|ssr
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_SELECTION
suffix:colon
r_if
c_cond
(paren
(paren
id|ssr
op_amp
id|IS_BITS
)paren
op_ne
l_int|1
)paren
r_goto
id|bad_is
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_SELSTEPS
suffix:colon
r_switch
c_cond
(paren
id|ssr
op_amp
id|IS_BITS
)paren
(brace
r_case
id|IS_SELARB
suffix:colon
r_case
id|IS_MSGBYTESENT
suffix:colon
r_goto
id|bad_is
suffix:semicolon
r_case
id|IS_NOTCOMMAND
suffix:colon
r_case
id|IS_EARLYPHASE
suffix:colon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
op_eq
id|STAT_MESGIN
)paren
r_break
suffix:semicolon
r_goto
id|bad_is
suffix:semicolon
r_case
id|IS_COMPLETE
suffix:colon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
DECL|macro|STATE
mdefine_line|#define STATE(st,ph) ((ph) &lt;&lt; 3 | (st))
multiline_comment|/* This table describes the legal SCSI state transitions,&n;&t; * as described by the SCSI II spec.&n;&t; */
r_switch
c_cond
(paren
id|STATE
c_func
(paren
id|stat
op_amp
id|STAT_BUSMASK
comma
id|info-&gt;scsi.phase
)paren
)paren
(brace
multiline_comment|/* Reselmsgin   -&gt; Data In&t;*/
r_case
id|STATE
c_func
(paren
id|STAT_DATAIN
comma
id|PHASE_RECONNECTED
)paren
suffix:colon
id|fas216_finish_reconnect
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_DATAIN
comma
id|PHASE_SELSTEPS
)paren
suffix:colon
multiline_comment|/* Sel w/ steps -&gt; Data In      */
r_case
id|STATE
c_func
(paren
id|STAT_DATAIN
comma
id|PHASE_DATAIN
)paren
suffix:colon
multiline_comment|/* Data In      -&gt; Data In      */
r_case
id|STATE
c_func
(paren
id|STAT_DATAIN
comma
id|PHASE_MSGOUT
)paren
suffix:colon
multiline_comment|/* Message Out  -&gt; Data In      */
r_case
id|STATE
c_func
(paren
id|STAT_DATAIN
comma
id|PHASE_COMMAND
)paren
suffix:colon
multiline_comment|/* Command      -&gt; Data In      */
r_case
id|STATE
c_func
(paren
id|STAT_DATAIN
comma
id|PHASE_MSGIN
)paren
suffix:colon
multiline_comment|/* Message In   -&gt; Data In      */
id|fas216_starttransfer
c_func
(paren
id|info
comma
id|DMA_IN
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_DATAOUT
comma
id|PHASE_DATAOUT
)paren
suffix:colon
multiline_comment|/* Data Out     -&gt; Data Out     */
id|fas216_starttransfer
c_func
(paren
id|info
comma
id|DMA_OUT
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Reselmsgin   -&gt; Data Out     */
r_case
id|STATE
c_func
(paren
id|STAT_DATAOUT
comma
id|PHASE_RECONNECTED
)paren
suffix:colon
id|fas216_finish_reconnect
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_DATAOUT
comma
id|PHASE_SELSTEPS
)paren
suffix:colon
multiline_comment|/* Sel w/ steps-&gt; Data Out     */
r_case
id|STATE
c_func
(paren
id|STAT_DATAOUT
comma
id|PHASE_MSGOUT
)paren
suffix:colon
multiline_comment|/* Message Out  -&gt; Data Out     */
r_case
id|STATE
c_func
(paren
id|STAT_DATAOUT
comma
id|PHASE_COMMAND
)paren
suffix:colon
multiline_comment|/* Command      -&gt; Data Out     */
r_case
id|STATE
c_func
(paren
id|STAT_DATAOUT
comma
id|PHASE_MSGIN
)paren
suffix:colon
multiline_comment|/* Message In   -&gt; Data Out     */
id|fas216_starttransfer
c_func
(paren
id|info
comma
id|DMA_OUT
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Reselmsgin   -&gt; Status       */
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_RECONNECTED
)paren
suffix:colon
id|fas216_finish_reconnect
c_func
(paren
id|info
)paren
suffix:semicolon
r_goto
id|status
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_DATAOUT
)paren
suffix:colon
multiline_comment|/* Data Out     -&gt; Status       */
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_DATAIN
)paren
suffix:colon
multiline_comment|/* Data In      -&gt; Status       */
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_SELSTEPS
)paren
suffix:colon
multiline_comment|/* Sel w/ steps -&gt; Status       */
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_MSGOUT
)paren
suffix:colon
multiline_comment|/* Message Out  -&gt; Status       */
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_COMMAND
)paren
suffix:colon
multiline_comment|/* Command      -&gt; Status       */
r_case
id|STATE
c_func
(paren
id|STAT_STATUS
comma
id|PHASE_MSGIN
)paren
suffix:colon
multiline_comment|/* Message In   -&gt; Status       */
id|status
suffix:colon
id|outb
c_func
(paren
id|CMD_INITCMDCOMPLETE
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_STATUS
suffix:semicolon
r_return
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_DATAOUT
)paren
suffix:colon
multiline_comment|/* Data Out     -&gt; Message In   */
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_DATAIN
)paren
suffix:colon
multiline_comment|/* Data In      -&gt; Message In   */
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_COMMAND
)paren
suffix:colon
multiline_comment|/* Command&t;-&gt; Message In&t;*/
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_SELSTEPS
)paren
suffix:colon
multiline_comment|/* Sel w/ steps -&gt; Message In   */
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_MSGOUT
)paren
suffix:colon
multiline_comment|/* Message Out  -&gt; Message In   */
id|info-&gt;scsi.msgin_fifo
op_assign
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
suffix:semicolon
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Reselmsgin   -&gt; Message In   */
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_RECONNECTED
)paren
suffix:colon
r_case
id|STATE
c_func
(paren
id|STAT_MESGIN
comma
id|PHASE_MSGIN
)paren
suffix:colon
id|info-&gt;scsi.msgin_fifo
op_assign
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Reselmsgin   -&gt; Command      */
r_case
id|STATE
c_func
(paren
id|STAT_COMMAND
comma
id|PHASE_RECONNECTED
)paren
suffix:colon
id|fas216_finish_reconnect
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|STATE
c_func
(paren
id|STAT_COMMAND
comma
id|PHASE_MSGOUT
)paren
suffix:colon
multiline_comment|/* Message Out  -&gt; Command      */
r_case
id|STATE
c_func
(paren
id|STAT_COMMAND
comma
id|PHASE_MSGIN
)paren
suffix:colon
multiline_comment|/* Message In   -&gt; Command      */
id|fas216_send_command
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_COMMAND
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Selection    -&gt; Message Out  */
r_case
id|STATE
c_func
(paren
id|STAT_MESGOUT
comma
id|PHASE_SELECTION
)paren
suffix:colon
id|fas216_send_messageout
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Any          -&gt; Message Out  */
r_case
id|STATE
c_func
(paren
id|STAT_MESGOUT
comma
id|PHASE_MSGOUT_EXPECT
)paren
suffix:colon
id|fas216_send_messageout
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Error recovery rules.&n;&t; *   These either attempt to abort or retry the operation.&n;&t; * TODO: we need more of these&n;&t; */
r_case
id|STATE
c_func
(paren
id|STAT_COMMAND
comma
id|PHASE_COMMAND
)paren
suffix:colon
multiline_comment|/* Command      -&gt; Command      */
multiline_comment|/* error - we&squot;ve sent out all the command bytes&n;&t;&t; * we have.&n;&t;&t; * NOTE: we need SAVE DATA POINTERS/RESTORE DATA POINTERS&n;&t;&t; * to include the command bytes sent for this to work&n;&t;&t; * correctly.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: &quot;
l_string|&quot;target trying to receive more command bytes&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|15
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_PADBYTES
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|INITIATOR_ERROR
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Selection    -&gt; Message Out  */
r_case
id|STATE
c_func
(paren
id|STAT_MESGOUT
comma
id|PHASE_SELSTEPS
)paren
suffix:colon
r_case
id|STATE
c_func
(paren
id|STAT_MESGOUT
comma
id|PHASE_MSGOUT
)paren
suffix:colon
multiline_comment|/* Message Out  -&gt; Message Out  */
multiline_comment|/* If we get another message out phase, this&n;&t;&t; * usually means some parity error occurred.&n;&t;&t; * Resend complete set of messages.  If we have&n;&t;&t; * more than 1 byte to send, we need to assert&n;&t;&t; * ATN again.&n;&t;&t; */
r_if
c_cond
(paren
id|msgqueue_msglength
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
OG
l_int|1
)paren
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_send_messageout
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;scsi.phase
op_eq
id|PHASE_MSGIN_DISCONNECT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: disconnect message received, but bus service %s?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|fas216_bus_phase
c_func
(paren
id|stat
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|INITIATOR_ERROR
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT_EXPECT
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: bus phase %s after %s?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|fas216_bus_phase
c_func
(paren
id|stat
)paren
comma
id|fas216_drv_phase
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|print_debug_list
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|bad_is
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: bus service at step %d?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|ssr
op_amp
id|IS_BITS
)paren
suffix:semicolon
id|print_debug_list
c_func
(paren
)paren
suffix:semicolon
id|fas216_done
c_func
(paren
id|info
comma
id|DID_ERROR
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_funcdone_intr(FAS216_Info *info, unsigned int stat, unsigned int ssr)&n; * Purpose : handle a function done interrupt from FAS216 chip&n; * Params  : info - interface which caused function done interrupt&n; *           stat - Status register contents&n; *           ssr  - SCSI Status register contents&n; */
DECL|function|fas216_funcdone_intr
r_static
r_void
id|fas216_funcdone_intr
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|stat
comma
r_int
r_int
id|ssr
)paren
(brace
r_int
id|status
comma
id|message
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_FUNCTIONDONE
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: function done: stat=%X ssr=%X phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|stat
comma
id|ssr
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_STATUS
suffix:colon
multiline_comment|/* status phase - read status and msg&t;*/
id|status
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|message
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.SCp.Message
op_assign
id|message
suffix:semicolon
id|info-&gt;scsi.SCp.Status
op_assign
id|status
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_DONE
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_IDLE
suffix:colon
multiline_comment|/* reselected?&t;&t;&t;&t;*/
r_case
id|PHASE_MSGIN
suffix:colon
multiline_comment|/* message in phase&t;&t;&t;*/
r_case
id|PHASE_RECONNECTED
suffix:colon
multiline_comment|/* reconnected command&t;&t;&t;*/
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
op_eq
id|STAT_MESGIN
)paren
(brace
id|info-&gt;scsi.msgin_fifo
op_assign
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
suffix:semicolon
id|fas216_message
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: internal phase %s for function done?&quot;
l_string|&quot;  What do I do with this?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|fas216_drv_phase
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_intr(struct Scsi_Host *instance)&n; * Purpose : handle interrupts from the interface to progress a command&n; * Params  : instance - interface to service&n; */
DECL|function|fas216_intr
r_void
id|fas216_intr
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
r_char
id|isr
comma
id|ssr
comma
id|stat
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|stat
op_assign
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|ssr
op_assign
id|inb
c_func
(paren
id|REG_IS
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|isr
op_assign
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|add_debug_list
c_func
(paren
id|stat
comma
id|ssr
comma
id|isr
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_INT
)paren
(brace
r_if
c_cond
(paren
id|isr
op_amp
id|INST_BUSRESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;scsi%d.H: bus reset detected&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|scsi_report_bus_reset
c_func
(paren
id|instance
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_ILLEGALCMD
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;scsi%d.H: illegal command given&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|fas216_dumpstate
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_DISCONNECT
)paren
id|fas216_disconnect_intr
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_RESELECTED
)paren
multiline_comment|/* reselected&t;&t;&t;*/
id|fas216_reselected_intr
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_BUSSERVICE
)paren
multiline_comment|/* bus service request&t;&t;*/
id|fas216_busservice_intr
c_func
(paren
id|info
comma
id|stat
comma
id|ssr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_FUNCDONE
)paren
multiline_comment|/* function done&t;&t;*/
id|fas216_funcdone_intr
c_func
(paren
id|info
comma
id|stat
comma
id|ssr
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: unknown interrupt received:&quot;
l_string|&quot; phase %s isr %02X ssr %02X stat %02X&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|fas216_drv_phase
c_func
(paren
id|info
)paren
comma
id|isr
comma
id|ssr
comma
id|stat
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_kick(FAS216_Info *info)&n; * Purpose : kick a command to the interface - interface should be idle&n; * Params  : info - our host interface to kick&n; * Notes   : Interrupts are always disabled!&n; */
DECL|function|fas216_kick
r_static
r_void
id|fas216_kick
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|tot_msglen
comma
id|from_queue
op_assign
l_int|0
comma
id|disconnect_ok
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Obtain the next command to process.&n;&t; */
r_do
(brace
r_if
c_cond
(paren
id|info-&gt;reqSCpnt
)paren
(brace
id|SCpnt
op_assign
id|info-&gt;reqSCpnt
suffix:semicolon
id|info-&gt;reqSCpnt
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;origSCpnt
)paren
(brace
id|SCpnt
op_assign
id|info-&gt;origSCpnt
suffix:semicolon
id|info-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* retrieve next command */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|SCpnt
op_assign
id|queue_remove_exclude
c_func
(paren
op_amp
id|info-&gt;queues.issue
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
id|from_queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
multiline_comment|/* no command pending - just exit */
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
op_logical_and
id|info-&gt;SCpnt
)paren
(brace
id|queue_add_cmd_tail
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|info-&gt;SCpnt
)paren
suffix:semicolon
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: moved command to disconnected queue&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * claim host busy&n;&t; */
id|info-&gt;scsi.phase
op_assign
id|PHASE_SELECTION
suffix:semicolon
id|info-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
id|info-&gt;scsi.SCp
op_assign
id|SCpnt-&gt;SCp
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|fasdma_none
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: starting cmd %02X&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|from_queue
)paren
(brace
macro_line|#ifdef SCSI2_TAG
multiline_comment|/*&n;&t;&t; * tagged queuing - allocate a new tag to this command&n;&t;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;tagged_queue
op_logical_and
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
op_logical_and
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|INQUIRY
)paren
(brace
id|SCpnt-&gt;device-&gt;current_tag
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;current_tag
op_eq
l_int|0
)paren
id|SCpnt-&gt;device-&gt;current_tag
op_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
id|SCpnt-&gt;device-&gt;current_tag
suffix:semicolon
)brace
r_else
macro_line|#endif
id|set_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
id|info-&gt;stats.removes
op_add_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
id|info-&gt;stats.writes
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|READ_12
suffix:colon
id|info-&gt;stats.reads
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info-&gt;stats.miscs
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Don&squot;t allow request sense commands to disconnect.&n;&t; */
id|disconnect_ok
op_assign
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
op_logical_and
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|disconnect_ok
suffix:semicolon
multiline_comment|/*&n;&t; * build outgoing message bytes&n;&t; */
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|IDENTIFY
c_func
(paren
id|disconnect_ok
comma
id|SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * add tag message if required&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;tag
)paren
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|2
comma
id|SIMPLE_QUEUE_TAG
comma
id|SCpnt-&gt;tag
)paren
suffix:semicolon
r_do
(brace
macro_line|#ifdef SCSI2_WIDE
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|wide_state
op_eq
id|neg_wait
)paren
(brace
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|wide_state
op_assign
id|neg_inprogress
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|4
comma
id|EXTENDED_MESSAGE
comma
l_int|2
comma
id|EXTENDED_WDTR
comma
id|info-&gt;ifcfg.wide_max_size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef SCSI2_SYNC
r_if
c_cond
(paren
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|sync_state
op_eq
id|neg_wait
op_logical_or
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|sync_state
op_eq
id|neg_complete
)paren
op_logical_and
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
op_logical_or
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
)paren
(brace
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|sync_state
op_assign
id|neg_inprogress
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|5
comma
id|EXTENDED_MESSAGE
comma
l_int|3
comma
id|EXTENDED_SDTR
comma
l_int|1000
op_div
id|info-&gt;ifcfg.clockrate
comma
id|info-&gt;ifcfg.sync_max_depth
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* following what the ESP driver says */
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* flush FIFO */
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* load bus-id and timeout */
id|outb
c_func
(paren
id|BUSID
c_func
(paren
id|SCpnt-&gt;target
)paren
comma
id|REG_SDID
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;ifcfg.select_timeout
comma
id|REG_STIM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* synchronous transfers */
id|fas216_set_sync
c_func
(paren
id|info
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|tot_msglen
op_assign
id|msgqueue_msglength
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MESSAGES
(brace
r_struct
id|message
op_star
id|msg
suffix:semicolon
r_int
id|msgnr
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: message out: &quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
id|msgnr
op_increment
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;{ &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msg-&gt;length
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|msg-&gt;msg
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;} &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|tot_msglen
op_eq
l_int|1
op_logical_or
id|tot_msglen
op_eq
l_int|3
)paren
(brace
multiline_comment|/*&n;&t;&t; * We have an easy message length to send...&n;&t;&t; */
r_struct
id|message
op_star
id|msg
suffix:semicolon
r_int
id|msgnr
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_SELSTEPS
suffix:semicolon
multiline_comment|/* load message bytes */
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
id|msgnr
op_increment
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msg-&gt;length
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|msg-&gt;msg
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msg-&gt;fifo
op_assign
id|tot_msglen
op_minus
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
suffix:semicolon
)brace
multiline_comment|/* load command */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tot_msglen
op_eq
l_int|1
)paren
id|outb
c_func
(paren
id|CMD_SELECTATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|CMD_SELECTATN3
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * We have an unusual number of message bytes to send.&n;&t;&t; *  Load first byte into fifo, and issue SELECT with ATN and&n;&t;&t; *  stop steps.&n;&t;&t; */
r_struct
id|message
op_star
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|msg-&gt;msg
(braket
l_int|0
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msg-&gt;fifo
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SELECTATNSTOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;, data pointers [%p, %X]&bslash;n&quot;
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* should now get either DISCONNECT or (FUNCTION DONE with BUS SERVICE) intr */
)brace
multiline_comment|/* Function: void fas216_rq_sns_done(info, SCpnt, result)&n; * Purpose : Finish processing automatic request sense command&n; * Params  : info   - interface that completed&n; *&t;     SCpnt  - command that completed&n; *&t;     result - driver byte of result&n; */
r_static
r_void
DECL|function|fas216_rq_sns_done
id|fas216_rq_sns_done
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|result
)paren
(brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: request sense complete, result=%04X%02X%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|result
comma
id|SCpnt-&gt;SCp.Message
comma
id|SCpnt-&gt;SCp.Status
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|result
op_ne
id|DID_OK
op_logical_or
id|SCpnt-&gt;SCp.Status
op_ne
id|GOOD
)paren
multiline_comment|/*&n;&t;&t; * Something went wrong.  Make sure that we don&squot;t&n;&t;&t; * have valid data in the sense buffer that could&n;&t;&t; * confuse the higher levels.&n;&t;&t; */
id|memset
c_func
(paren
id|SCpnt-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Note that we don&squot;t set SCpnt-&gt;result, since that should&n;&t; * reflect the status of the command that we were asked by&n;&t; * the upper layers to process.  This would have been set&n;&t; * correctly by fas216_std_done.&n;&t; */
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_std_done(info, SCpnt, result)&n; * Purpose : Finish processing of standard command&n; * Params  : info   - interface that completed&n; *&t;     SCpnt  - command that completed&n; *&t;     result - driver byte of result&n; */
r_static
r_void
DECL|function|fas216_std_done
id|fas216_std_done
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|result
)paren
(brace
id|info-&gt;stats.fins
op_add_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
op_lshift
l_int|16
op_or
id|info-&gt;scsi.SCp.Message
op_lshift
l_int|8
op_or
id|info-&gt;scsi.SCp.Status
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: command complete, result=%08X, command=&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;result
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * If the driver detected an error, or the command&n;&t; * was request sense, then we&squot;re all done.&n;&t; */
r_if
c_cond
(paren
id|result
op_ne
id|DID_OK
op_logical_or
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
r_goto
id|done
suffix:semicolon
multiline_comment|/*&n;&t; * If the command returned CHECK_CONDITION status,&n;&t; * request the sense information.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.Status
op_eq
id|CHECK_CONDITION
)paren
r_goto
id|request_sense
suffix:semicolon
multiline_comment|/*&n;&t; * If the command did not complete with GOOD status,&n;&t; * we are all done here.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.Status
op_ne
id|GOOD
)paren
r_goto
id|done
suffix:semicolon
multiline_comment|/*&n;&t; * We have successfully completed a command.  Make sure that&n;&t; * we do not have any buffers left to transfer.  The world&n;&t; * is not perfect, and we seem to occasionally hit this.&n;&t; * It can be indicative of a buggy driver, target or the upper&n;&t; * levels of the SCSI code.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.ptr
)paren
(brace
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|INQUIRY
suffix:colon
r_case
id|START_STOP
suffix:colon
singleline_comment|//&t;&t;case READ_CAPACITY:
r_case
id|MODE_SENSE
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: incomplete data transfer &quot;
l_string|&quot;detected: res=%08X ptr=%p len=%X command=&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;result
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
id|request_sense
suffix:colon
id|memset
c_func
(paren
id|SCpnt-&gt;cmnd
comma
l_int|0
comma
r_sizeof
(paren
id|SCpnt-&gt;cmnd
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
id|SCpnt-&gt;cmnd
(braket
l_int|1
)braket
op_assign
id|SCpnt-&gt;lun
op_lshift
l_int|5
suffix:semicolon
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
op_assign
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
id|SCpnt-&gt;cmd_len
op_assign
id|COMMAND_SIZE
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;sense_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;sc_data_direction
op_assign
id|SCSI_DATA_READ
suffix:semicolon
id|SCpnt-&gt;use_sg
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|fas216_rq_sns_done
suffix:semicolon
multiline_comment|/*&n;&t; * Place this command into the high priority &quot;request&n;&t; * sense&quot; slot.  This will be the very next command&n;&t; * executed, unless a target connects to us.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;reqSCpnt
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d.%c: loosing request command&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|info-&gt;reqSCpnt
op_assign
id|SCpnt
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_done(FAS216_Info *info, unsigned int result)&n; * Purpose : complete processing for current command&n; * Params  : info   - interface that completed&n; *&t;     result - driver byte of result&n; */
DECL|function|fas216_done
r_static
r_void
id|fas216_done
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|result
)paren
(brace
r_void
(paren
op_star
id|fn
)paren
(paren
id|FAS216_Info
op_star
comma
id|Scsi_Cmnd
op_star
comma
r_int
r_int
)paren
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;SCpnt
)paren
r_goto
id|no_command
suffix:semicolon
id|SCpnt
op_assign
id|info-&gt;SCpnt
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;scsi_done
)paren
r_goto
id|no_done
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.aborting
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: uncaught abort - returning DID_ABORT&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|result
op_assign
id|DID_ABORT
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Sanity check the completion - if we have zero bytes left&n;&t; * to transfer, we should not have a valid pointer.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.ptr
op_logical_and
id|info-&gt;scsi.SCp.this_residual
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: zero bytes left to transfer, but &quot;
l_string|&quot;buffer pointer still valid: ptr=%p len=%08x command=&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
id|info-&gt;scsi.SCp.ptr
op_assign
l_int|NULL
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Clear down this command as completed.  If we need to request&n;&t; * the sense information, fas216_kick will re-assert the busy&n;&t; * status.&n;&t; */
id|clear_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
id|fn
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
id|FAS216_Info
op_star
comma
id|Scsi_Cmnd
op_star
comma
r_int
r_int
)paren
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
id|fn
c_func
(paren
id|info
comma
id|SCpnt
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.irq
op_ne
id|NO_IRQ
)paren
id|fas216_kick
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
id|no_command
suffix:colon
id|panic
c_func
(paren
l_string|&quot;scsi%d.H: null command in fas216_done&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|no_done
suffix:colon
id|panic
c_func
(paren
l_string|&quot;scsi%d.H: null scsi_done function in fas216_done&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_queue_command(Scsi_Cmnd *SCpnt, void (*done)(Scsi_Cmnd *))&n; * Purpose : queue a command for adapter to process.&n; * Params  : SCpnt - Command to queue&n; *&t;     done  - done function to call once command is complete&n; * Returns : 0 - success, else error&n; * Notes   : io_request_lock is held, interrupts are disabled.&n; */
DECL|function|fas216_queue_command
r_int
id|fas216_queue_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|result
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: received queuable command (%p) %02X&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|fas216_std_done
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|buf
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Calculate correct buffer length.  Some commands&n;&t;&t; * come in with the wrong request_bufflen.&n;&t;&t; */
r_for
c_loop
(paren
id|buf
op_assign
l_int|0
suffix:semicolon
id|buf
op_le
id|SCpnt-&gt;SCp.buffers_residual
suffix:semicolon
id|buf
op_increment
)paren
id|len
op_add_assign
id|SCpnt-&gt;SCp.buffer
(braket
id|buf
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
op_ne
id|len
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d.%c: bad request buffer &quot;
l_string|&quot;length %d, should be %ld&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;request_bufflen
comma
id|len
)paren
suffix:semicolon
id|SCpnt-&gt;request_bufflen
op_assign
id|len
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If the upper SCSI layers pass a buffer, but zero length,&n;&t; * we aren&squot;t interested in the buffer pointer.&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;SCp.this_residual
op_eq
l_int|0
op_logical_and
id|SCpnt-&gt;SCp.ptr
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d.%c: zero length buffer passed for &quot;
l_string|&quot;command &quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;SCp.ptr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|info-&gt;stats.queues
op_add_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Add command into execute queue and let it complete under&n;&t; * whatever scheme we&squot;re using.&n;&t; */
id|result
op_assign
op_logical_neg
id|queue_add_cmd_ordered
c_func
(paren
op_amp
id|info-&gt;queues.issue
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we successfully added the command,&n;&t; * kick the interface to get it moving.&n;&t; */
r_if
c_cond
(paren
id|result
op_eq
l_int|0
op_logical_and
(paren
op_logical_neg
id|info-&gt;SCpnt
op_logical_or
id|info-&gt;scsi.disconnectable
)paren
)paren
id|fas216_kick
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_internal_done(Scsi_Cmnd *SCpnt)&n; * Purpose : trigger restart of a waiting thread in fas216_command&n; * Params  : SCpnt - Command to wake&n; */
DECL|function|fas216_internal_done
r_static
r_void
id|fas216_internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;internal_done
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_command(Scsi_Cmnd *SCpnt)&n; * Purpose : queue a command for adapter to process.&n; * Params  : SCpnt - Command to queue&n; * Returns : scsi result code&n; * Notes   : io_request_lock is held, interrupts are disabled.&n; */
DECL|function|fas216_command
r_int
id|fas216_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We should only be using this if we don&squot;t have an interrupt.&n;&t; * Provide some &quot;incentive&quot; to use the queueing code.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;scsi.irq
op_ne
id|NO_IRQ
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|info-&gt;internal_done
op_assign
l_int|0
suffix:semicolon
id|fas216_queue_command
c_func
(paren
id|SCpnt
comma
id|fas216_internal_done
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This wastes time, since we can&squot;t return until the command is&n;&t; * complete. We can&squot;t sleep either since we may get re-entered!&n;&t; * However, we must re-enable interrupts, or else we&squot;ll be&n;&t; * waiting forever.&n;&t; */
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|info-&gt;internal_done
)paren
(brace
multiline_comment|/*&n;&t;&t; * If we don&squot;t have an IRQ, then we must poll the card for&n;&t;&t; * it&squot;s interrupt, and use that to call this driver&squot;s&n;&t;&t; * interrupt routine.  That way, we keep the command&n;&t;&t; * progressing.  Maybe we can add some inteligence here&n;&t;&t; * and go to sleep if we know that the device is going&n;&t;&t; * to be some time (eg, disconnected).&n;&t;&t; */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
op_amp
id|STAT_INT
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|fas216_intr
c_func
(paren
id|info-&gt;host
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
DECL|enum|res_abort
r_enum
id|res_abort
(brace
DECL|enumerator|res_failed
id|res_failed
comma
multiline_comment|/* unable to abort&t;&t;*/
DECL|enumerator|res_success
id|res_success
comma
multiline_comment|/* command on issue queue&t;*/
DECL|enumerator|res_success_clear
id|res_success_clear
comma
multiline_comment|/* command marked tgt/lun busy&t;*/
DECL|enumerator|res_hw_abort
id|res_hw_abort
multiline_comment|/* command on disconnected dev&t;*/
)brace
suffix:semicolon
multiline_comment|/*&n; * Prototype: enum res_abort fas216_do_abort(FAS216_Info *info, Scsi_Cmnd *SCpnt)&n; * Purpose  : decide how to abort a command&n; * Params   : SCpnt - command to abort&n; * Returns  : abort status&n; */
r_static
r_enum
id|res_abort
DECL|function|fas216_do_abort
id|fas216_do_abort
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_enum
id|res_abort
id|res
op_assign
id|res_failed
suffix:semicolon
r_if
c_cond
(paren
id|queue_remove_cmd
c_func
(paren
op_amp
id|info-&gt;queues.issue
comma
id|SCpnt
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The command was on the issue queue, and has not been&n;&t;&t; * issued yet.  We can remove the command from the queue,&n;&t;&t; * and acknowledge the abort.  Neither the device nor the&n;&t;&t; * interface know about the command.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;on issue queue &quot;
)paren
suffix:semicolon
id|res
op_assign
id|res_success
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|queue_remove_cmd
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|SCpnt
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The command was on the disconnected queue.  We must&n;&t;&t; * reconnect with the device if possible, and send it&n;&t;&t; * an abort message.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;on disconnected queue &quot;
)paren
suffix:semicolon
id|res
op_assign
id|res_hw_abort
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;SCpnt
op_eq
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;executing &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
multiline_comment|/*&n;&t;&t; * If the interface is idle, and the command is &squot;disconnectable&squot;,&n;&t;&t; * then it is the same as on the disconnected queue.&n;&t;&t; */
r_case
id|PHASE_IDLE
suffix:colon
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
)paren
(brace
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|res_hw_abort
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;origSCpnt
op_eq
id|SCpnt
)paren
(brace
multiline_comment|/*&n;&t;&t; * The command will be executed next, but a command&n;&t;&t; * is currently using the interface.  This is similar to&n;&t;&t; * being on the issue queue, except the busylun bit has&n;&t;&t; * been set.&n;&t;&t; */
id|info-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;waiting for execution &quot;
)paren
suffix:semicolon
id|res
op_assign
id|res_success_clear
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;unknown &quot;
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_abort(Scsi_Cmnd *SCpnt)&n; * Purpose : abort this command&n; * Params  : SCpnt - command to abort&n; * Returns : FAILED if unable to abort&n; * Notes   : io_request_lock is taken, and irqs are disabled&n; */
DECL|function|fas216_eh_abort
r_int
id|fas216_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|result
op_assign
id|FAILED
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;stats.aborts
op_add_assign
l_int|1
suffix:semicolon
id|print_debug_list
c_func
(paren
)paren
suffix:semicolon
id|fas216_dumpstate
c_func
(paren
id|info
)paren
suffix:semicolon
id|fas216_dumpinfo
c_func
(paren
id|info
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d: abort &quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fas216_do_abort
c_func
(paren
id|info
comma
id|SCpnt
)paren
)paren
(brace
multiline_comment|/*&n;&t; * We managed to find the command and cleared it out.&n;&t; * We do not expect the command to be executing on the&n;&t; * target, but we have set the busylun bit.&n;&t; */
r_case
id|res_success_clear
suffix:colon
id|printk
c_func
(paren
l_string|&quot;clear &quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We found the command, and cleared it out.  Either&n;&t; * the command is still known to be executing on the&n;&t; * target, or the busylun bit is not set.&n;&t; */
r_case
id|res_success
suffix:colon
id|printk
c_func
(paren
l_string|&quot;success&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * We need to reconnect to the target and send it an&n;&t; * ABORT or ABORT_TAG message.  We can only do this&n;&t; * if the bus is free.&n;&t; */
r_case
id|res_hw_abort
suffix:colon
multiline_comment|/*&n;&t; * We are unable to abort the command for some reason.&n;&t; */
r_default
suffix:colon
r_case
id|res_failed
suffix:colon
id|printk
c_func
(paren
l_string|&quot;failed&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_reset_state(FAS216_Info *info)&n; * Purpose : Initialise driver internal state&n; * Params  : info - state to initialise&n; */
DECL|function|fas216_reset_state
r_static
r_void
id|fas216_reset_state
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|neg_t
id|sync_state
comma
id|wide_state
suffix:semicolon
r_int
id|i
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear out all stale info in our state structure&n;&t; */
id|memset
c_func
(paren
id|info-&gt;busyluns
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;busyluns
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|info-&gt;scsi.reconnected.target
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.reconnected.lun
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
id|info-&gt;scsi.async_stp
op_assign
id|fas216_syncperiod
c_func
(paren
id|info
comma
id|info-&gt;ifcfg.asyncperiod
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;ifcfg.wide_max_size
op_eq
l_int|0
)paren
id|wide_state
op_assign
id|neg_invalid
suffix:semicolon
r_else
macro_line|#ifdef SCSI2_WIDE
id|wide_state
op_assign
id|neg_wait
suffix:semicolon
macro_line|#else
id|wide_state
op_assign
id|neg_invalid
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;host-&gt;dma_channel
op_eq
id|NO_DMA
op_logical_or
op_logical_neg
id|info-&gt;dma.setup
)paren
id|sync_state
op_assign
id|neg_invalid
suffix:semicolon
r_else
macro_line|#ifdef SCSI2_SYNC
id|sync_state
op_assign
id|neg_wait
suffix:semicolon
macro_line|#else
id|sync_state
op_assign
id|neg_invalid
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info-&gt;device
(braket
id|i
)braket
dot
id|disconnect_ok
op_assign
id|info-&gt;ifcfg.disconnect_ok
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|sync_state
op_assign
id|sync_state
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|wide_state
op_assign
id|wide_state
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|period
op_assign
id|info-&gt;ifcfg.asyncperiod
op_div
l_int|4
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|stp
op_assign
id|info-&gt;scsi.async_stp
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|sof
op_assign
l_int|0
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|wide_xfer
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Drain all commands on disconnected queue&n;&t; */
r_while
c_loop
(paren
id|queue_remove
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Remove executing commands.&n;&t; */
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;reqSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_device_reset(Scsi_Cmnd *SCpnt)&n; * Purpose : Reset the device associated with this command&n; * Params  : SCpnt - command specifing device to reset&n; * Returns : FAILED if unable to reset&n; */
DECL|function|fas216_eh_device_reset
r_int
id|fas216_eh_device_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: &quot;
id|__FUNCTION__
l_string|&quot;: called&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_bus_reset(Scsi_Cmnd *SCpnt)&n; * Purpose : Reset the bus associated with the command&n; * Params  : SCpnt - command specifing bus to reset&n; * Returns : FAILED if unable to reset&n; * Notes   : io_request_lock is taken, and irqs are disabled&n; */
DECL|function|fas216_eh_bus_reset
r_int
id|fas216_eh_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|result
op_assign
id|FAILED
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;stats.bus_resets
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: &quot;
id|__FUNCTION__
l_string|&quot;: resetting bus&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Attempt to stop all activity on this interface.&n;&t; */
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear any pending interrupts&n;&t; */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
op_amp
id|STAT_INT
)paren
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the SCSI bus&n;&t; */
id|outb
c_func
(paren
id|CMD_RESETSCSI
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear reset interrupt&n;&t; */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
op_amp
id|STAT_INT
op_logical_and
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
op_amp
id|INST_BUSRESET
)paren
id|result
op_assign
id|SUCCESS
suffix:semicolon
id|fas216_reset_state
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_init_chip(FAS216_Info *info)&n; * Purpose : Initialise FAS216 state after reset&n; * Params  : info - state structure for interface&n; */
DECL|function|fas216_init_chip
r_static
r_void
id|fas216_init_chip
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|outb
c_func
(paren
id|fas216_clockrate
c_func
(paren
id|info-&gt;ifcfg.clockrate
)paren
comma
id|REG_CLKF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|1
)braket
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;ifcfg.select_timeout
comma
id|REG_STIM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_SOF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.async_stp
comma
id|REG_STP
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_host_reset(Scsi_Cmnd *SCpnt)&n; * Purpose : Reset the host associated with this command&n; * Params  : SCpnt - command specifing host to reset&n; * Returns : FAILED if unable to reset&n; * Notes   : io_request_lock is taken, and irqs are disabled&n; */
DECL|function|fas216_eh_host_reset
r_int
id|fas216_eh_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: &quot;
id|__FUNCTION__
l_string|&quot;: resetting host&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the SCSI chip.&n;&t; */
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ugly ugly ugly!&n;&t; * We need to release the io_request_lock and enable&n;&t; * IRQs if we sleep, but we must relock and disable&n;&t; * IRQs after the sleep.&n;&t; */
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|scsi_sleep
c_func
(paren
l_int|25
op_star
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Release the SCSI reset.&n;&t; */
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_init_chip
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|macro|TYPE_UNKNOWN
mdefine_line|#define TYPE_UNKNOWN&t;0
DECL|macro|TYPE_NCR53C90
mdefine_line|#define TYPE_NCR53C90&t;1
DECL|macro|TYPE_NCR53C90A
mdefine_line|#define TYPE_NCR53C90A&t;2
DECL|macro|TYPE_NCR53C9x
mdefine_line|#define TYPE_NCR53C9x&t;3
DECL|macro|TYPE_Am53CF94
mdefine_line|#define TYPE_Am53CF94&t;4
DECL|macro|TYPE_EmFAS216
mdefine_line|#define TYPE_EmFAS216&t;5
DECL|macro|TYPE_QLFAS216
mdefine_line|#define TYPE_QLFAS216&t;6
DECL|variable|chip_types
r_static
r_char
op_star
id|chip_types
(braket
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;NS NCR53C90&quot;
comma
l_string|&quot;NS NCR53C90A&quot;
comma
l_string|&quot;NS NCR53C9x&quot;
comma
l_string|&quot;AMD Am53CF94&quot;
comma
l_string|&quot;Emulex FAS216&quot;
comma
l_string|&quot;QLogic FAS216&quot;
)brace
suffix:semicolon
DECL|function|fas216_detect_type
r_static
r_int
id|fas216_detect_type
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
id|family
comma
id|rev
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the chip.&n;&t; */
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check to see if control reg 2 is present.&n;&t; */
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CNTL2_S2FE
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are unable to read back control reg 2&n;&t; * correctly, it is not present, and we have a&n;&t; * NCR53C90.&n;&t; */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
op_amp
(paren
op_complement
l_int|0xe0
)paren
)paren
op_ne
id|CNTL2_S2FE
)paren
r_return
id|TYPE_NCR53C90
suffix:semicolon
multiline_comment|/*&n;&t; * Now, check control register 3&n;&t; */
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|5
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are unable to read the register back&n;&t; * correctly, we have a NCR53C90A&n;&t; */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
op_ne
l_int|5
)paren
r_return
id|TYPE_NCR53C90A
suffix:semicolon
multiline_comment|/*&n;&t; * Now read the ID from the chip.&n;&t; */
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CNTL3_ADIDCHK
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_WITHDMA
op_or
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CNTL2_ENF
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|rev
op_assign
id|inb
c_func
(paren
id|REG1_ID
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|family
op_assign
id|rev
op_rshift
l_int|3
suffix:semicolon
id|rev
op_and_assign
l_int|7
suffix:semicolon
r_switch
c_cond
(paren
id|family
)paren
(brace
r_case
l_int|0x01
suffix:colon
r_if
c_cond
(paren
id|rev
op_eq
l_int|4
)paren
r_return
id|TYPE_Am53CF94
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
r_switch
c_cond
(paren
id|rev
)paren
(brace
r_case
l_int|2
suffix:colon
r_return
id|TYPE_EmFAS216
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
id|TYPE_QLFAS216
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;family %x rev %x&bslash;n&quot;
comma
id|family
comma
id|rev
)paren
suffix:semicolon
r_return
id|TYPE_NCR53C9x
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_init(struct Scsi_Host *instance)&n; * Purpose : initialise FAS/NCR/AMD SCSI ic.&n; * Params  : instance - a driver-specific filled-out structure&n; * Returns : 0 on success&n; */
DECL|function|fas216_init
r_int
id|fas216_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
id|type
suffix:semicolon
id|info-&gt;magic_start
op_assign
id|MAGIC
suffix:semicolon
id|info-&gt;magic_end
op_assign
id|MAGIC
suffix:semicolon
id|info-&gt;host
op_assign
id|instance
suffix:semicolon
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
op_assign
id|instance-&gt;this_id
suffix:semicolon
id|info-&gt;scsi.cfg
(braket
l_int|1
)braket
op_assign
id|CNTL2_ENF
op_or
id|CNTL2_S2FE
suffix:semicolon
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
op_assign
id|info-&gt;ifcfg.cntl3
op_or
id|CNTL3_ADIDCHK
op_or
id|CNTL3_G2CB
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;stats
)paren
)paren
suffix:semicolon
id|msgqueue_initialise
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_initialise
c_func
(paren
op_amp
id|info-&gt;queues.issue
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_initialise
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
)paren
)paren
(brace
id|queue_free
c_func
(paren
op_amp
id|info-&gt;queues.issue
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|fas216_reset_state
c_func
(paren
id|info
)paren
suffix:semicolon
id|type
op_assign
id|fas216_detect_type
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.type
op_assign
id|chip_types
(braket
id|type
)braket
suffix:semicolon
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialise the chip correctly.&n;&t; */
id|fas216_init_chip
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the SCSI bus.  We don&squot;t want to see&n;&t; * the resulting reset interrupt, so mask it&n;&t; * out.&n;&t; */
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
op_or
id|CNTL1_DISR
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETSCSI
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * scsi standard says wait 250ms&n;&t; */
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|scsi_sleep
c_func
(paren
l_int|25
op_star
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_release(struct Scsi_Host *instance)&n; * Purpose : release all resources and put everything to bed for&n; *           FAS/NCR/AMD SCSI ic.&n; * Params  : instance - a driver-specific filled-out structure&n; * Returns : 0 on success&n; */
DECL|function|fas216_release
r_int
id|fas216_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|fas216_checkmagic
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|queue_free
c_func
(paren
op_amp
id|info-&gt;queues.disconnected
)paren
suffix:semicolon
id|queue_free
c_func
(paren
op_amp
id|info-&gt;queues.issue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: int fas216_info(FAS216_Info *info, char *buffer)&n; * Purpose : generate a string containing information about this&n; *&t;     host.&n; * Params  : info   - FAS216 host information&n; *&t;     buffer - string buffer to build string&n; * Returns : size of built string&n; */
DECL|function|fas216_info
r_int
id|fas216_info
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_char
op_star
id|buffer
)paren
(brace
r_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;(%s) at port 0x%08lX &quot;
comma
id|info-&gt;scsi.type
comma
id|info-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;host-&gt;irq
op_ne
id|NO_IRQ
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;irq %d &quot;
comma
id|info-&gt;host-&gt;irq
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;no irq &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;host-&gt;dma_channel
op_ne
id|NO_DMA
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;dma %d &quot;
comma
id|info-&gt;host-&gt;dma_channel
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;no dma &quot;
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buffer
suffix:semicolon
)brace
DECL|function|fas216_print_host
r_int
id|fas216_print_host
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_char
op_star
id|buffer
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;n&quot;
l_string|&quot;Chip    : %s&bslash;n&quot;
l_string|&quot; Address: 0x%08lX&bslash;n&quot;
l_string|&quot; IRQ    : %d&bslash;n&quot;
l_string|&quot; DMA    : %d&bslash;n&quot;
comma
id|info-&gt;scsi.type
comma
id|info-&gt;host-&gt;io_port
comma
id|info-&gt;host-&gt;irq
comma
id|info-&gt;host-&gt;dma_channel
)paren
suffix:semicolon
)brace
DECL|function|fas216_print_stats
r_int
id|fas216_print_stats
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_char
op_star
id|buffer
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;n&quot;
l_string|&quot;Command Statistics:&bslash;n&quot;
l_string|&quot; Queued     : %u&bslash;n&quot;
l_string|&quot; Issued     : %u&bslash;n&quot;
l_string|&quot; Completed  : %u&bslash;n&quot;
l_string|&quot; Reads      : %u&bslash;n&quot;
l_string|&quot; Writes     : %u&bslash;n&quot;
l_string|&quot; Others     : %u&bslash;n&quot;
l_string|&quot; Disconnects: %u&bslash;n&quot;
l_string|&quot; Aborts     : %u&bslash;n&quot;
l_string|&quot; Bus resets : %u&bslash;n&quot;
l_string|&quot; Host resets: %u&bslash;n&quot;
comma
id|info-&gt;stats.queues
comma
id|info-&gt;stats.removes
comma
id|info-&gt;stats.fins
comma
id|info-&gt;stats.reads
comma
id|info-&gt;stats.writes
comma
id|info-&gt;stats.miscs
comma
id|info-&gt;stats.disconnects
comma
id|info-&gt;stats.aborts
comma
id|info-&gt;stats.bus_resets
comma
id|info-&gt;stats.host_resets
)paren
suffix:semicolon
)brace
DECL|function|fas216_print_device
r_int
id|fas216_print_device
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|Scsi_Device
op_star
id|scd
comma
r_char
op_star
id|buffer
)paren
(brace
r_struct
id|fas216_device
op_star
id|dev
op_assign
op_amp
id|info-&gt;device
(braket
id|scd-&gt;id
)braket
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|proc_print_scsidevice
c_func
(paren
id|scd
comma
id|buffer
comma
op_amp
id|len
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|buffer
op_plus
id|len
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;  Extensions: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scd-&gt;tagged_supported
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;TAG %sabled [%d] &quot;
comma
id|scd-&gt;tagged_queue
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
comma
id|scd-&gt;current_tag
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n  Transfers : %d-bit &quot;
comma
l_int|8
op_lshift
id|dev-&gt;wide_xfer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;sof
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;sync offset %d, %d ns&bslash;n&quot;
comma
id|dev-&gt;sof
comma
id|dev-&gt;period
op_star
l_int|4
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;async&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buffer
suffix:semicolon
)brace
DECL|variable|fas216_info
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_info
)paren
suffix:semicolon
DECL|variable|fas216_init
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_init
)paren
suffix:semicolon
DECL|variable|fas216_queue_command
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_queue_command
)paren
suffix:semicolon
DECL|variable|fas216_command
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_command
)paren
suffix:semicolon
DECL|variable|fas216_intr
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_intr
)paren
suffix:semicolon
DECL|variable|fas216_release
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_release
)paren
suffix:semicolon
DECL|variable|fas216_eh_abort
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_abort
)paren
suffix:semicolon
DECL|variable|fas216_eh_device_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_device_reset
)paren
suffix:semicolon
DECL|variable|fas216_eh_bus_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_bus_reset
)paren
suffix:semicolon
DECL|variable|fas216_eh_host_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_host_reset
)paren
suffix:semicolon
DECL|variable|fas216_print_host
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_print_host
)paren
suffix:semicolon
DECL|variable|fas216_print_stats
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_print_stats
)paren
suffix:semicolon
DECL|variable|fas216_print_device
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_print_device
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
eof
