multiline_comment|/*&n; * linux/arch/arm/drivers/scsi/fas216.c&n; *&n; * Copyright (C) 1997 Russell King&n; *&n; * Based in information in qlogicfas.c by Tom Zerucha, Michael Griffith, and&n; * other sources.&n; *&n; * This is a generic driver.  To use it, have a look at cumana_2.c.  You&n; * should define your own structure that overlays FAS216_Info, eg:&n; * struct my_host_data {&n; *    FAS216_Info info;&n; *    ... my host specific data ...&n; * };&n; *&n; * Changelog:&n; *  30-08-1997&t;RMK&t;Created&n; *  14-09-1997&t;RMK&t;Started disconnect support&n; *  08-02-1998&t;RMK&t;Corrected real DMA support&n; *  15-02-1998&t;RMK&t;Started sync xfer support&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
DECL|macro|FAS216_C
mdefine_line|#define FAS216_C
macro_line|#include &quot;../../scsi/scsi.h&quot;
macro_line|#include &quot;../../scsi/hosts.h&quot;
macro_line|#include &quot;fas216.h&quot;
DECL|macro|VER_MAJOR
mdefine_line|#define VER_MAJOR&t;0
DECL|macro|VER_MINOR
mdefine_line|#define VER_MINOR&t;0
DECL|macro|VER_PATCH
mdefine_line|#define VER_PATCH&t;2
DECL|macro|NO_DISCONNECTS
macro_line|#undef NO_DISCONNECTS
DECL|macro|DEBUG_CONNECT
macro_line|#undef DEBUG_CONNECT
DECL|macro|DEBUG_BUSSERVICE
macro_line|#undef DEBUG_BUSSERVICE
DECL|macro|DEBUG_FUNCTIONDONE
macro_line|#undef DEBUG_FUNCTIONDONE
DECL|macro|DEBUG_MESSAGES
macro_line|#undef DEBUG_MESSAGES
DECL|function|fas216_bus_phase
r_static
r_char
op_star
id|fas216_bus_phase
(paren
r_int
id|stat
)paren
(brace
r_static
r_char
op_star
id|phases
(braket
)braket
op_assign
(brace
l_string|&quot;DATA OUT&quot;
comma
l_string|&quot;DATA IN&quot;
comma
l_string|&quot;COMMAND&quot;
comma
l_string|&quot;STATUS&quot;
comma
l_string|&quot;MISC OUT&quot;
comma
l_string|&quot;MISC IN&quot;
comma
l_string|&quot;MESG OUT&quot;
comma
l_string|&quot;MESG IN&quot;
)brace
suffix:semicolon
r_return
id|phases
(braket
id|stat
op_amp
id|STAT_BUSMASK
)braket
suffix:semicolon
)brace
DECL|function|fas216_target
r_static
r_char
id|fas216_target
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;SCpnt
)paren
r_return
l_char|&squot;0&squot;
op_plus
id|info-&gt;SCpnt-&gt;target
suffix:semicolon
r_else
r_return
l_char|&squot;H&squot;
suffix:semicolon
)brace
r_static
r_void
id|fas216_done
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|result
)paren
suffix:semicolon
multiline_comment|/* Function: int fas216_clockrate (unsigned int clock)&n; * Purpose : calculate correct value to be written into clock conversion&n; *&t;     factor register.&n; * Params  : clock - clock speed in MHz&n; * Returns : CLKF_ value&n; */
DECL|function|fas216_clockrate
r_static
r_int
id|fas216_clockrate
(paren
r_int
id|clock
)paren
(brace
r_if
c_cond
(paren
id|clock
op_le
l_int|10
op_logical_or
id|clock
OG
l_int|40
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;fas216: invalid clock rate: check your driver!&bslash;n&quot;
)paren
suffix:semicolon
id|clock
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|clock
op_assign
(paren
(paren
id|clock
op_minus
l_int|1
)paren
op_div
l_int|5
op_plus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
r_return
id|clock
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_syncperiod(FAS216_Info *info, int ns)&n; * Purpose : Calculate value to be loaded into the STP register&n; *           for a given period in ns&n; * Params  : info - state structure for interface connected to device&n; *         : ns   - period in ns (between subsequent bytes)&n; * Returns : Value suitable for REG_STP&n; */
DECL|function|fas216_syncperiod
r_static
r_int
id|fas216_syncperiod
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|ns
)paren
(brace
r_int
id|value
op_assign
(paren
id|info-&gt;ifcfg.clockrate
op_star
id|ns
)paren
op_div
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|4
)paren
id|value
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|value
OG
l_int|35
)paren
id|value
op_assign
l_int|35
suffix:semicolon
r_return
id|value
op_amp
l_int|31
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_updateptrs (FAS216_Info *info, int bytes_transferred)&n; * Purpose : update data pointers after transfer suspended/paused&n; * Params  : info              - interface&squot;s local pointer to update&n; *           bytes_transferred - number of bytes transferred&n; */
r_static
r_void
DECL|function|fas216_updateptrs
id|fas216_updateptrs
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
id|bytes_transferred
)paren
(brace
r_int
r_char
op_star
id|ptr
op_assign
id|info-&gt;scsi.SCp.ptr
suffix:semicolon
r_int
r_int
id|residual
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
id|info-&gt;SCpnt-&gt;request_bufflen
op_sub_assign
id|bytes_transferred
suffix:semicolon
r_while
c_loop
(paren
id|residual
op_le
id|bytes_transferred
op_logical_and
id|bytes_transferred
)paren
(brace
multiline_comment|/* We have used up this buffer */
id|bytes_transferred
op_sub_assign
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.buffers_residual
)paren
(brace
id|info-&gt;scsi.SCp.buffer
op_increment
suffix:semicolon
id|info-&gt;scsi.SCp.buffers_residual
op_decrement
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|info-&gt;scsi.SCp.buffer-&gt;address
suffix:semicolon
id|residual
op_assign
id|info-&gt;scsi.SCp.buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|residual
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|residual
op_sub_assign
id|bytes_transferred
suffix:semicolon
id|ptr
op_add_assign
id|bytes_transferred
suffix:semicolon
id|info-&gt;scsi.SCp.ptr
op_assign
id|ptr
suffix:semicolon
id|info-&gt;scsi.SCp.this_residual
op_assign
id|residual
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_pio (FAS216_Info *info, fasdmadir_t direction)&n; * Purpose : transfer data off of/on to card using programmed IO&n; * Params  : info      - interface to transfer data to/from&n; *           direction - direction to transfer data (DMA_OUT/DMA_IN)&n; * Notes   : this is incredibly slow&n; */
r_static
r_void
DECL|function|fas216_pio
id|fas216_pio
(paren
id|FAS216_Info
op_star
id|info
comma
id|fasdmadir_t
id|direction
)paren
(brace
r_int
r_int
id|length
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
r_char
op_star
id|ptr
op_assign
id|info-&gt;scsi.SCp.ptr
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|DMA_OUT
)paren
(brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
OL
l_int|8
)paren
(brace
id|outb
c_func
(paren
op_star
id|ptr
op_increment
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
op_amp
id|STAT_INT
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_ne
l_int|0
)paren
(brace
op_star
id|ptr
op_increment
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
op_amp
id|STAT_INT
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.buffers_residual
)paren
(brace
id|info-&gt;scsi.SCp.buffer
op_increment
suffix:semicolon
id|info-&gt;scsi.SCp.buffers_residual
op_decrement
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|info-&gt;scsi.SCp.buffer-&gt;address
suffix:semicolon
id|length
op_assign
id|info-&gt;scsi.SCp.buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|info-&gt;scsi.SCp.ptr
op_assign
id|ptr
suffix:semicolon
id|info-&gt;scsi.SCp.this_residual
op_assign
id|length
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_starttransfer(FAS216_Info *info,&n; *&t;&t;&t;&t;       fasdmadir_t direction)&n; * Purpose : Start a DMA/PIO transfer off of/on to card&n; * Params  : info      - interface from which device disconnected from&n; *           direction - transfer direction (DMA_OUT/DMA_IN)&n; */
r_static
r_void
DECL|function|fas216_starttransfer
id|fas216_starttransfer
c_func
(paren
id|FAS216_Info
op_star
id|info
comma
id|fasdmadir_t
id|direction
)paren
(brace
id|fasdmatype_t
id|dmatype
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
(paren
id|direction
op_eq
id|DMA_OUT
)paren
ques
c_cond
id|PHASE_DATAOUT
suffix:colon
id|PHASE_DATAIN
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_block
op_logical_or
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_all
)paren
(brace
r_int
r_int
id|total
comma
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_block
)paren
id|total
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
r_else
id|total
op_assign
id|info-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
id|residual
op_assign
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_plus
id|inb
c_func
(paren
id|REG_CTCL
c_func
(paren
id|info
)paren
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCM
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCH
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|fas216_updateptrs
(paren
id|info
comma
id|total
op_minus
id|residual
)paren
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|fasdma_none
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;scsi.SCp.ptr
)paren
(brace
id|printk
(paren
l_string|&quot;scsi%d.%c: null buffer passed to &quot;
l_string|&quot;fas216_starttransfer&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dmatype
op_assign
id|fasdma_none
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.setup
)paren
id|dmatype
op_assign
id|info-&gt;dma
dot
id|setup
c_func
(paren
id|info-&gt;host
comma
op_amp
id|info-&gt;scsi.SCp
comma
id|direction
)paren
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|dmatype
suffix:semicolon
r_switch
c_cond
(paren
id|dmatype
)paren
(brace
r_case
id|fasdma_none
suffix:colon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_pio
(paren
id|info
comma
id|direction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|fasdma_pseudo
suffix:colon
(brace
r_int
id|transferred
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|transferred
op_assign
id|info-&gt;dma
dot
id|pseudo
c_func
(paren
id|info-&gt;host
comma
op_amp
id|info-&gt;scsi.SCp
comma
id|direction
comma
id|info-&gt;SCpnt-&gt;transfersize
)paren
suffix:semicolon
id|fas216_updateptrs
(paren
id|info
comma
id|transferred
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|fasdma_real_block
suffix:colon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.SCp.this_residual
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|fasdma_real_all
suffix:colon
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;request_bufflen
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;request_bufflen
op_rshift
l_int|8
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;SCpnt-&gt;request_bufflen
op_rshift
l_int|16
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_stoptransfer (FAS216_Info *info)&n; * Purpose : Stop a DMA transfer onto / off of the card&n; * Params  : info      - interface from which device disconnected from&n; */
r_static
r_void
DECL|function|fas216_stoptransfer
id|fas216_stoptransfer
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_block
op_logical_or
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_all
)paren
(brace
r_int
r_int
id|total
comma
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.stop
)paren
id|info-&gt;dma.stop
(paren
id|info-&gt;host
comma
op_amp
id|info-&gt;scsi.SCp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma.transfer_type
op_eq
id|fasdma_real_block
)paren
id|total
op_assign
id|info-&gt;scsi.SCp.this_residual
suffix:semicolon
r_else
id|total
op_assign
id|info-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
id|residual
op_assign
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_plus
id|inb
c_func
(paren
id|REG_CTCL
c_func
(paren
id|info
)paren
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCM
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|inb
c_func
(paren
id|REG_CTCH
c_func
(paren
id|info
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|fas216_updateptrs
(paren
id|info
comma
id|total
op_minus
id|residual
)paren
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|fasdma_none
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_disconnected_intr (FAS216_Info *info)&n; * Purpose : handle device disconnection&n; * Params  : info - interface from which device disconnected from&n; */
r_static
r_void
DECL|function|fas216_disconnect_intr
id|fas216_disconnect_intr
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: disconnect phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
id|msgqueue_flush
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_SELECTION
suffix:colon
multiline_comment|/* while selecting - no target&t;&t;*/
id|fas216_done
(paren
id|info
comma
id|DID_NO_CONNECT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_DISCONNECT
suffix:colon
multiline_comment|/* message in - disconnecting&t;&t;*/
id|outb
c_func
(paren
id|CMD_ENABLESEL
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.disconnectable
op_assign
l_int|1
suffix:semicolon
id|info-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
id|info-&gt;stats.disconnects
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_DONE
suffix:colon
multiline_comment|/* at end of command - complete&t;&t;*/
id|fas216_done
(paren
id|info
comma
id|DID_OK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_AFTERMSGOUT
suffix:colon
multiline_comment|/* message out - possible ABORT message&t;*/
r_if
c_cond
(paren
id|info-&gt;scsi.last_message
op_eq
id|ABORT
)paren
(brace
id|info-&gt;scsi.aborting
op_assign
l_int|0
suffix:semicolon
id|fas216_done
(paren
id|info
comma
id|DID_ABORT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* huh?&t;&t;&t;&t;&t;*/
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: unexpected disconnect in phase %d&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|fas216_done
(paren
id|info
comma
id|DID_ERROR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_reselected_intr (FAS216_Info *info)&n; * Purpose : Start reconnection of a device&n; * Params  : info - interface which was reselected&n; */
r_static
r_void
DECL|function|fas216_reselected_intr
id|fas216_reselected_intr
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
r_char
id|target
comma
id|identify_msg
comma
id|ok
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.phase
op_eq
id|PHASE_SELECTION
op_logical_and
id|info-&gt;SCpnt
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|info-&gt;SCpnt
suffix:semicolon
id|info-&gt;origSCpnt
op_assign
id|SCpnt
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|negstate
op_eq
id|syncneg_sent
)paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|negstate
op_assign
id|syncneg_start
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reconnect phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
id|msgqueue_flush
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|REG_CFIS
c_func
(paren
id|info
)paren
)paren
op_amp
id|CFIS_CF
)paren
op_ne
l_int|2
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: incorrect number of bytes after reselect&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|target
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|identify_msg
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|target
op_amp
(paren
l_int|1
op_lshift
id|info-&gt;host-&gt;this_id
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: invalid host id on reselect&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|identify_msg
op_amp
l_int|0x80
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: no IDENTIFY message on reselect, got msg %02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|identify_msg
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
multiline_comment|/*&n;&t; * Something went wrong - abort the command on&n;&t; * the target.  Should this be INITIATOR_ERROR ?&n;&t; */
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|target
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|info-&gt;host-&gt;this_id
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|target
)paren
(brace
r_case
l_int|1
suffix:colon
id|target
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|target
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|target
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|target
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|target
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|target
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|target
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|128
suffix:colon
id|target
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|target
op_assign
id|info-&gt;host-&gt;this_id
suffix:semicolon
r_break
suffix:semicolon
)brace
id|identify_msg
op_and_assign
l_int|7
suffix:semicolon
id|info-&gt;scsi.reconnected.target
op_assign
id|target
suffix:semicolon
id|info-&gt;scsi.reconnected.lun
op_assign
id|identify_msg
suffix:semicolon
id|info-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
op_logical_and
id|info-&gt;SCpnt
op_logical_and
id|info-&gt;SCpnt-&gt;target
op_eq
id|target
op_logical_and
id|info-&gt;SCpnt-&gt;lun
op_eq
id|identify_msg
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
op_logical_and
id|queue_probetgtlun
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|target
comma
id|identify_msg
)paren
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
(brace
id|info-&gt;scsi.phase
op_assign
id|PHASE_RECONNECTED
suffix:semicolon
id|outb
c_func
(paren
id|target
comma
id|REG_SDID
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t; * Our command structure not found - abort the command on the target&n;&t; * Should this be INITIATOR_ERROR ?&n;&t; */
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_finish_reconnect (FAS216_Info *info)&n; * Purpose : finish reconnection sequence for device&n; * Params  : info - interface which caused function done interrupt&n; */
r_static
r_void
DECL|function|fas216_finish_reconnect
id|fas216_finish_reconnect
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;Connected: %1X %1X %02X, reconnected: %1X %1X %02X&bslash;n&quot;
comma
id|info-&gt;SCpnt-&gt;target
comma
id|info-&gt;SCpnt-&gt;lun
comma
id|info-&gt;SCpnt-&gt;tag
comma
id|info-&gt;scsi.reconnected.target
comma
id|info-&gt;scsi.reconnected.lun
comma
id|info-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
op_logical_and
id|info-&gt;SCpnt
)paren
(brace
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;SCpnt-&gt;target
op_eq
id|info-&gt;scsi.reconnected.target
op_logical_and
id|info-&gt;SCpnt-&gt;lun
op_eq
id|info-&gt;scsi.reconnected.lun
op_logical_and
id|info-&gt;SCpnt-&gt;tag
op_eq
id|info-&gt;scsi.reconnected.tag
)paren
(brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;scsi%d.%c: reconnected&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|queue_add_cmd_tail
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|info-&gt;SCpnt
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;scsi%d.%c: had to move command to disconnected queue&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;SCpnt
)paren
(brace
id|info-&gt;SCpnt
op_assign
id|queue_remove_tgtluntag
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|info-&gt;scsi.reconnected.target
comma
id|info-&gt;scsi.reconnected.lun
comma
id|info-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;scsi%d.%c: had to get command&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;SCpnt
)paren
(brace
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t; * Restore data pointer from SAVED data pointer&n;&t; */
id|info-&gt;scsi.SCp
op_assign
id|info-&gt;SCpnt-&gt;SCp
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;, data pointers: [%p, %X]&quot;
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Function: void fas216_message (FAS216_Info *info)&n; * Purpose : handle a function done interrupt from FAS216 chip&n; * Params  : info - interface which caused function done interrupt&n; */
DECL|function|fas216_message
r_static
r_void
id|fas216_message
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
r_char
id|message
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|msglen
op_assign
l_int|1
suffix:semicolon
id|message
(braket
l_int|0
)braket
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
id|message
(braket
l_int|1
)braket
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|msglen
op_assign
l_int|2
suffix:semicolon
id|msglen
OL
id|message
(braket
l_int|1
)braket
suffix:semicolon
id|msglen
op_increment
)paren
id|message
(braket
id|msglen
)braket
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MESSAGES
(brace
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot;scsi%d.%c: message in: &quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msglen
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot;%02X &quot;
comma
id|message
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;scsi.phase
op_eq
id|PHASE_RECONNECTED
)paren
(brace
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|SIMPLE_QUEUE_TAG
)paren
id|info-&gt;scsi.reconnected.tag
op_assign
id|message
(braket
l_int|1
)braket
suffix:semicolon
id|fas216_finish_reconnect
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|message
(braket
l_int|0
)braket
)paren
(brace
r_case
id|COMMAND_COMPLETE
suffix:colon
id|printk
(paren
l_string|&quot;fas216: command complete with no status in MESSAGE_IN?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
multiline_comment|/*&n;&t; * Save current data pointer to SAVED data pointer&n;&t; */
id|info-&gt;SCpnt-&gt;SCp
op_assign
id|info-&gt;scsi.SCp
suffix:semicolon
macro_line|#if defined (DEBUG_MESSAGES) || defined (DEBUG_CONNECT)
id|printk
(paren
l_string|&quot;scsi%d.%c: save data pointers: [%p, %X]&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|RESTORE_POINTERS
suffix:colon
multiline_comment|/*&n;&t; * Restore current data pointer from SAVED data pointer&n;&t; */
id|info-&gt;scsi.SCp
op_assign
id|info-&gt;SCpnt-&gt;SCp
suffix:semicolon
macro_line|#if defined (DEBUG_MESSAGES) || defined (DEBUG_CONNECT)
id|printk
(paren
l_string|&quot;scsi%d.%c: restore data pointers: [%p, %X]&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|DISCONNECT
suffix:colon
id|info-&gt;scsi.phase
op_assign
id|PHASE_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: reject, last message %04X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.last_message
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
multiline_comment|/* handled above */
id|printk
(paren
l_string|&quot;scsi%d.%c: reconnect queue tag %02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|message
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_switch
c_cond
(paren
id|message
(braket
l_int|2
)braket
)paren
(brace
r_case
id|EXTENDED_SDTR
suffix:colon
multiline_comment|/* Sync transfer negociation request/reply */
r_case
id|EXTENDED_WDTR
suffix:colon
multiline_comment|/* Wide transfer negociation request/reply */
multiline_comment|/* We don&squot;t do wide transfers - reject message */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: unrecognised extended message %02X, rejecting&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|message
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|msgqueue_flush
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: unrecognised message %02X, rejecting&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|message
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|msgqueue_flush
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_busservice_intr (FAS216_Info *info, unsigned int stat, unsigned int ssr)&n; * Purpose : handle a bus service interrupt from FAS216 chip&n; * Params  : info - interface which caused bus service interrupt&n; *           stat - Status register contents&n; *           ssr  - SCSI Status register contents&n; */
DECL|function|fas216_busservice_intr
r_static
r_void
id|fas216_busservice_intr
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|stat
comma
r_int
r_int
id|ssr
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG_BUSSERVICE
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: bus service: stat=%02X ssr=%02X phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|stat
comma
id|ssr
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|ssr
op_amp
id|IS_BITS
)paren
(brace
r_case
id|IS_COMPLETE
suffix:colon
multiline_comment|/* last action completed&t;&t;*/
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_SELECTION
suffix:colon
multiline_comment|/* while selecting - selected target&t;*/
r_switch
c_cond
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
(brace
r_case
id|STAT_DATAOUT
suffix:colon
multiline_comment|/* data out phase&t;&t;&t;*/
id|fas216_starttransfer
(paren
id|info
comma
id|DMA_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_DATAIN
suffix:colon
multiline_comment|/* data in phase&t;&t;&t;*/
id|fas216_starttransfer
(paren
id|info
comma
id|DMA_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_STATUS
suffix:colon
multiline_comment|/* status phase&t;&t;&t;&t;*/
id|info-&gt;scsi.phase
op_assign
id|PHASE_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|CMD_INITCMDCOMPLETE
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_MESGIN
suffix:colon
multiline_comment|/* message in phase&t;&t;&t;*/
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* other&t;&t;&t;&t;*/
id|printk
(paren
l_string|&quot;scsi%d.%c: bus phase %s after connect?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_DATAIN
suffix:colon
multiline_comment|/* while transfering data in&t;&t;*/
r_switch
c_cond
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
(brace
r_case
id|STAT_DATAIN
suffix:colon
multiline_comment|/* continue data in phase&t;&t;*/
id|fas216_starttransfer
(paren
id|info
comma
id|DMA_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_STATUS
suffix:colon
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|CMD_INITCMDCOMPLETE
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_MESGIN
suffix:colon
multiline_comment|/* message in phase&t;&t;&t;*/
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: bus phase %s after data in?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_DATAOUT
suffix:colon
multiline_comment|/* while transfering data out&t;&t;*/
r_switch
c_cond
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
(brace
r_case
id|STAT_DATAOUT
suffix:colon
id|fas216_starttransfer
(paren
id|info
comma
id|DMA_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_STATUS
suffix:colon
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_INITCMDCOMPLETE
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_MESGIN
suffix:colon
multiline_comment|/* message in phase&t;&t;&t;*/
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: bus phase %s after data out?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_RECONNECTED
suffix:colon
multiline_comment|/* newly reconnected device&t;&t;*/
multiline_comment|/*&n;&t;     * Command reconnected - if MESGIN, get message - it may be&n;&t;     * the tag.  If not, get command out of the disconnected queue&n;&t;     */
r_switch
c_cond
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
(brace
r_case
id|STAT_MESGIN
suffix:colon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_STATUS
suffix:colon
id|fas216_finish_reconnect
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|CMD_INITCMDCOMPLETE
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_DATAOUT
suffix:colon
multiline_comment|/* data out phase&t;&t;&t;*/
id|fas216_finish_reconnect
(paren
id|info
)paren
suffix:semicolon
id|fas216_starttransfer
(paren
id|info
comma
id|DMA_OUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_DATAIN
suffix:colon
multiline_comment|/* data in phase&t;&t;&t;*/
id|fas216_finish_reconnect
(paren
id|info
)paren
suffix:semicolon
id|fas216_starttransfer
(paren
id|info
comma
id|DMA_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: bus phase %s after reconnect?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_MSGIN
suffix:colon
r_switch
c_cond
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
(brace
r_case
id|STAT_MESGIN
suffix:colon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: bus phase %s after message in?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_MSGOUT
suffix:colon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
op_ne
id|STAT_MESGOUT
)paren
(brace
id|printk
(paren
l_string|&quot;scsi%d.%c: didn&squot;t manage MESSAGE OUT phase&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|msglen
suffix:semicolon
id|msglen
op_assign
id|msgqueue_msglength
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msglen
op_eq
l_int|0
)paren
id|outb
c_func
(paren
id|NOP
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_else
(brace
r_char
op_star
id|msg
suffix:semicolon
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getnextmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
op_amp
id|msglen
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msglen
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|msg
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_AFTERMSGOUT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_AFTERMSGOUT
suffix:colon
r_switch
c_cond
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
(brace
r_case
id|STAT_MESGIN
suffix:colon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: bus phase %s after message out&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PHASE_DISCONNECT
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: disconnect message received, but bus service %s?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|fas216_bus_phase
(paren
id|stat
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_SETATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msgqueue_addmsg
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|CMD_TRANSFERINFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: internal phase %d for bus service?&quot;
l_string|&quot;  What do I do with this?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: bus service at step %d?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|ssr
op_amp
id|IS_BITS
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_funcdone_intr (FAS216_Info *info, unsigned int stat, unsigned int ssr)&n; * Purpose : handle a function done interrupt from FAS216 chip&n; * Params  : info - interface which caused function done interrupt&n; *           stat - Status register contents&n; *           ssr  - SCSI Status register contents&n; */
DECL|function|fas216_funcdone_intr
r_static
r_void
id|fas216_funcdone_intr
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|stat
comma
r_int
r_int
id|ssr
)paren
(brace
r_int
id|status
comma
id|message
suffix:semicolon
macro_line|#ifdef DEBUG_FUNCTIONDONE
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: function done: stat=%X ssr=%X phase=%02X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
c_func
(paren
id|info
)paren
comma
id|stat
comma
id|ssr
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|info-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_STATUS
suffix:colon
multiline_comment|/* status phase - read status and msg&t;*/
id|status
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|message
op_assign
id|inb
c_func
(paren
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.SCp.Message
op_assign
id|message
suffix:semicolon
id|info-&gt;scsi.SCp.Status
op_assign
id|status
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_DONE
suffix:semicolon
id|outb
c_func
(paren
id|CMD_MSGACCEPTED
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_IDLE
suffix:colon
multiline_comment|/* reselected?&t;&t;&t;&t;*/
r_case
id|PHASE_MSGIN
suffix:colon
multiline_comment|/* message in phase&t;&t;&t;*/
r_case
id|PHASE_RECONNECTED
suffix:colon
multiline_comment|/* reconnected command&t;&t;&t;*/
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|STAT_BUSMASK
)paren
op_eq
id|STAT_MESGIN
)paren
(brace
id|fas216_message
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
(paren
l_string|&quot;scsi%d.%c: internal phase %d for function done?&quot;
l_string|&quot;  What do I do with this?&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Function: void fas216_intr (struct Scsi_Host *instance)&n; * Purpose : handle interrupts from the interface to progress a command&n; * Params  : instance - interface to service&n; */
DECL|function|fas216_intr
r_void
id|fas216_intr
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
r_char
id|isr
comma
id|ssr
comma
id|stat
suffix:semicolon
id|stat
op_assign
id|inb
c_func
(paren
id|REG_STAT
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|ssr
op_assign
id|inb
c_func
(paren
id|REG_IS
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|isr
op_assign
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|INST_BUSRESET
)paren
id|printk
(paren
l_string|&quot;scsi%d.H: fas216: bus reset detected&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_ILLEGALCMD
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;scsi%d.H: illegal command given&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_DISCONNECT
)paren
id|fas216_disconnect_intr
(paren
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_RESELECTED
)paren
multiline_comment|/* reselected&t;&t;&t;*/
id|fas216_reselected_intr
(paren
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_BUSSERVICE
)paren
multiline_comment|/* bus service request&t;&t;*/
id|fas216_busservice_intr
(paren
id|info
comma
id|stat
comma
id|ssr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|INST_FUNCDONE
)paren
multiline_comment|/* function done&t;&t;*/
id|fas216_funcdone_intr
(paren
id|info
comma
id|stat
comma
id|ssr
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;scsi%d.%c: unknown interrupt received:&quot;
l_string|&quot; phase %d isr %02X ssr %02X stat %02X&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|info-&gt;scsi.phase
comma
id|isr
comma
id|ssr
comma
id|stat
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_kick (FAS216_Info *info)&n; * Purpose : kick a command to the interface - interface should be idle&n; * Params  : info - our host interface to kick&n; * Notes   : Interrupts are always disabled!&n; */
DECL|function|fas216_kick
r_static
r_void
id|fas216_kick
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_int
id|i
comma
id|msglen
comma
id|from_queue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;origSCpnt
)paren
(brace
id|SCpnt
op_assign
id|info-&gt;origSCpnt
suffix:semicolon
id|info-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* retrieve next command */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|SCpnt
op_assign
id|queue_remove_exclude
c_func
(paren
op_amp
id|info-&gt;queues.issue
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
id|from_queue
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
multiline_comment|/* no command pending - just exit */
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.disconnectable
op_logical_and
id|info-&gt;SCpnt
)paren
(brace
id|queue_add_cmd_tail
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|info-&gt;SCpnt
)paren
suffix:semicolon
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: moved command to disconnected queue&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * tagged queuing - allocate a new tag to this command&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;tagged_queue
op_logical_and
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
)paren
(brace
id|SCpnt-&gt;device-&gt;current_tag
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;current_tag
op_eq
l_int|0
)paren
id|SCpnt-&gt;device-&gt;current_tag
op_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
id|SCpnt-&gt;device-&gt;current_tag
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * claim host busy&n;&t; */
id|info-&gt;scsi.phase
op_assign
id|PHASE_SELECTION
suffix:semicolon
id|info-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
id|info-&gt;scsi.SCp
op_assign
id|SCpnt-&gt;SCp
suffix:semicolon
id|info-&gt;dma.transfer_type
op_assign
id|fasdma_none
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: starting cmd %02X&quot;
comma
id|info-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|from_queue
)paren
(brace
macro_line|#ifdef SCSI2_TAG
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;tagged_queue
op_logical_and
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
)paren
(brace
id|SCpnt-&gt;device-&gt;current_tag
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;current_tag
op_eq
l_int|0
)paren
id|SCpnt-&gt;device-&gt;current_tag
op_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
id|SCpnt-&gt;device-&gt;current_tag
suffix:semicolon
)brace
r_else
macro_line|#endif
id|set_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
id|info-&gt;stats.removes
op_add_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
id|info-&gt;stats.writes
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|READ_12
suffix:colon
id|info-&gt;stats.reads
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info-&gt;stats.miscs
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* build outgoing message bytes */
id|msgqueue_flush
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|disconnect_ok
)paren
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|IDENTIFY
c_func
(paren
l_int|1
comma
id|SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
r_else
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|1
comma
id|IDENTIFY
c_func
(paren
l_int|0
comma
id|SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/* add tag message if required */
r_if
c_cond
(paren
id|SCpnt-&gt;tag
)paren
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|2
comma
id|SIMPLE_QUEUE_TAG
comma
id|SCpnt-&gt;tag
)paren
suffix:semicolon
multiline_comment|/* add synchronous negociation */
r_if
c_cond
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|negstate
op_eq
id|syncneg_start
)paren
(brace
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|negstate
op_assign
id|syncneg_sent
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
l_int|5
comma
id|EXTENDED_MESSAGE
comma
l_int|3
comma
id|EXTENDED_SDTR
comma
l_int|1000
op_div
id|info-&gt;ifcfg.clockrate
comma
id|info-&gt;ifcfg.sync_max_depth
)paren
suffix:semicolon
)brace
multiline_comment|/* following what the ESP driver says */
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCL
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_STCH
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
op_or
id|CMD_WITHDMA
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* flush FIFO */
id|outb
c_func
(paren
id|CMD_FLUSHFIFO
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* load bus-id and timeout */
id|outb
c_func
(paren
id|BUSID
c_func
(paren
id|SCpnt-&gt;target
)paren
comma
id|REG_SDID
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;ifcfg.select_timeout
comma
id|REG_STIM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* synchronous transfers */
id|outb
c_func
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|sof
comma
id|REG_SOF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;device
(braket
id|SCpnt-&gt;target
)braket
dot
id|stp
comma
id|REG_STP
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|msglen
op_assign
id|msgqueue_msglength
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msglen
op_eq
l_int|1
op_logical_or
id|msglen
op_eq
l_int|3
)paren
(brace
r_char
op_star
id|msg
suffix:semicolon
multiline_comment|/* load message bytes */
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getnextmsg
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
comma
op_amp
id|msglen
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msglen
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|msg
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* load command */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
id|i
)braket
comma
id|REG_FF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msglen
op_eq
l_int|1
)paren
id|outb
c_func
(paren
id|CMD_SELECTATN
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|CMD_SELECTATN3
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
id|CMD_SELECTATNSTOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;, data pointers [%p, %X]&bslash;n&quot;
comma
id|info-&gt;scsi.SCp.ptr
comma
id|info-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* should now get either DISCONNECT or (FUNCTION DONE with BUS SERVICE) intr */
)brace
multiline_comment|/* Function: void fas216_done (FAS216_Info *info, unsigned int result)&n; * Purpose : complete processing for command&n; * Params  : info   - interface that completed&n; *&t;     result - driver byte of result&n; */
DECL|function|fas216_done
r_static
r_void
id|fas216_done
(paren
id|FAS216_Info
op_star
id|info
comma
r_int
r_int
id|result
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|info-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.aborting
)paren
(brace
id|printk
(paren
l_string|&quot;scsi%d.%c: uncaught abort - returning DID_ABORT&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
)paren
suffix:semicolon
id|result
op_assign
id|DID_ABORT
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|0
suffix:semicolon
)brace
id|info-&gt;stats.fins
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
id|info-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
op_lshift
l_int|16
op_or
id|info-&gt;scsi.SCp.Message
op_lshift
l_int|8
op_or
id|info-&gt;scsi.SCp.Status
suffix:semicolon
multiline_comment|/*&n;&t; * In theory, this should not happen, but just in case it does.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;scsi.SCp.ptr
op_logical_and
id|result
op_eq
id|DID_OK
)paren
(brace
r_switch
c_cond
(paren
id|status_byte
(paren
id|SCpnt-&gt;result
)paren
)paren
(brace
r_case
id|CHECK_CONDITION
suffix:colon
r_case
id|COMMAND_TERMINATED
suffix:colon
r_case
id|BUSY
suffix:colon
r_case
id|QUEUE_FULL
suffix:colon
r_case
id|RESERVATION_CONFLICT
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: incomplete data transfer &quot;
l_string|&quot;detected: result=%08X command=&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;result
)paren
suffix:semicolon
id|print_command
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_CONNECT
id|printk
(paren
l_string|&quot;scsi%d.%c: scsi command (%p) complete, result=%08X&bslash;n&quot;
comma
id|info-&gt;host-&gt;host_no
comma
id|fas216_target
(paren
id|info
)paren
comma
id|SCpnt
comma
id|SCpnt-&gt;result
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;scsi_done
)paren
id|panic
(paren
l_string|&quot;scsi%d.H: null scsi_done function in fas216_done&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|clear_bit
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|info-&gt;busyluns
)paren
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_else
id|panic
(paren
l_string|&quot;scsi%d.H: null command in fas216_done&quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.irq
op_ne
id|NO_IRQ
)paren
id|fas216_kick
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_queue_command (Scsi_Cmnd *SCpnt, void (*done)(Scsi_Cmnd *))&n; * Purpose : queue a command for adapter to process.&n; * Params  : SCpnt - Command to queue&n; *&t;     done  - done function to call once command is complete&n; * Returns : 0 - success, else error&n; */
DECL|function|fas216_queue_command
r_int
id|fas216_queue_command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
macro_line|#ifdef DEBUG_CONNECT
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: received queuable command (%p) %02X&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|buf
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Calculate correct buffer length&n;&t;&t; */
r_for
c_loop
(paren
id|buf
op_assign
l_int|0
suffix:semicolon
id|buf
op_le
id|SCpnt-&gt;SCp.buffers_residual
suffix:semicolon
id|buf
op_increment
)paren
id|len
op_add_assign
id|SCpnt-&gt;SCp.buffer
(braket
id|buf
)braket
dot
id|length
suffix:semicolon
id|SCpnt-&gt;request_bufflen
op_assign
id|len
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
)brace
id|info-&gt;stats.queues
op_add_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;scsi.irq
op_ne
id|NO_IRQ
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* add command into execute queue and let it complete under&n;&t;&t; * the drivers interrupts.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|queue_add_cmd_ordered
(paren
op_amp
id|info-&gt;queues.issue
comma
id|SCpnt
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|save_flags_cli
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;SCpnt
op_logical_or
id|info-&gt;scsi.disconnectable
)paren
id|fas216_kick
(paren
id|info
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no interrupts to rely on - we&squot;ll have to handle the&n;&t;&t; * command ourselves.  For now, we give up.&n;&t;&t; */
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_internal_done (Scsi_Cmnd *SCpnt)&n; * Purpose : trigger restart of a waiting thread in fas216_command&n; * Params  : SCpnt - Command to wake&n; */
DECL|function|fas216_internal_done
r_static
r_void
id|fas216_internal_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|info-&gt;internal_done
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_command (Scsi_Cmnd *SCpnt)&n; * Purpose : queue a command for adapter to process.&n; * Params  : SCpnt - Command to queue&n; * Returns : scsi result code&n; */
DECL|function|fas216_command
r_int
id|fas216_command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|info-&gt;internal_done
op_assign
l_int|0
suffix:semicolon
id|fas216_queue_command
(paren
id|SCpnt
comma
id|fas216_internal_done
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This wastes time, since we can&squot;t return until the command is&n;&t; * complete. We can&squot;t seep either since we may get re-entered!&n;&t; * However, we must re-enable interrupts, or else we&squot;ll be&n;&t; * waiting forever.&n;&t; */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|info-&gt;internal_done
)paren
id|barrier
(paren
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
multiline_comment|/* Prototype: void fas216_reportstatus(Scsi_Cmnd **SCpntp1,&n; *&t;&t;&t;&t;       Scsi_Cmnd **SCpntp2, int result)&n; * Purpose  : pass a result to *SCpntp1, and check if *SCpntp1 = *SCpntp2&n; * Params   : SCpntp1 - pointer to command to return&n; *&t;      SCpntp2 - pointer to command to check&n; *&t;      result  - result to pass back to mid-level done function&n; * Returns  : *SCpntp2 = NULL if *SCpntp1 is the same command&n; *&t;      structure as *SCpntp2.&n; */
DECL|function|fas216_reportstatus
r_static
r_void
id|fas216_reportstatus
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SCpntp1
comma
id|Scsi_Cmnd
op_star
op_star
id|SCpntp2
comma
r_int
id|result
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
op_star
id|SCpntp1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
op_star
id|SCpntp1
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCpnt
op_eq
op_star
id|SCpntp2
)paren
op_star
id|SCpntp2
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_abort(Scsi_Cmnd *SCpnt)&n; * Purpose : abort this command&n; * Params  : SCpnt - command to abort&n; * Returns : FAILED if unable to abort&n; */
DECL|function|fas216_eh_abort
r_int
id|fas216_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_device_reset(Scsi_Cmnd *SCpnt)&n; * Purpose : Reset the device associated with this command&n; * Params  : SCpnt - command specifing device to reset&n; * Returns : FAILED if unable to reset&n; */
DECL|function|fas216_eh_device_reset
r_int
id|fas216_eh_device_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_bus_reset(Scsi_Cmnd *SCpnt)&n; * Purpose : Reset the complete bus associated with this command&n; * Params  : SCpnt - command specifing bus to reset&n; * Returns : FAILED if unable to reset&n; */
DECL|function|fas216_eh_bus_reset
r_int
id|fas216_eh_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_eh_host_reset(Scsi_Cmnd *SCpnt)&n; * Purpose : Reset the host associated with this command&n; * Params  : SCpnt - command specifing host to reset&n; * Returns : FAILED if unable to reset&n; */
DECL|function|fas216_eh_host_reset
r_int
id|fas216_eh_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_abort (Scsi_Cmnd *SCpnt)&n; * Purpose : abort a command if something horrible happens.&n; * Params  : SCpnt - Command that is believed to be causing a problem.&n; * Returns : one of SCSI_ABORT_ macros.&n; */
DECL|function|fas216_abort
r_int
id|fas216_abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|result
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
id|info-&gt;stats.aborts
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d: fas216_abort: &quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* If command is waiting in the issue queue, then we can&n;&t;&t; * simply remove the command and return abort status&n;&t;&t; */
r_if
c_cond
(paren
id|queue_removecmd
(paren
op_amp
id|info-&gt;queues.issue
comma
id|SCpnt
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;command on issue queue&quot;
)paren
suffix:semicolon
id|result
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* If the command is on the disconencted queue, we need to&n;&t;&t; * reconnect to the device&n;&t;&t; */
r_if
c_cond
(paren
id|queue_cmdonqueue
(paren
op_amp
id|info-&gt;queues.disconnected
comma
id|SCpnt
)paren
)paren
id|printk
(paren
l_string|&quot;command on disconnected queue&quot;
)paren
suffix:semicolon
multiline_comment|/* If the command is connected, we need to flag that the&n;&t;&t; * command needs to be aborted&n;&t;&t; */
r_if
c_cond
(paren
id|info-&gt;SCpnt
op_eq
id|SCpnt
)paren
id|printk
(paren
l_string|&quot;command executing&quot;
)paren
suffix:semicolon
multiline_comment|/* If the command is pending for execution, then again&n;&t;&t; * this is simple - we remove it and report abort status&n;&t;&t; */
r_if
c_cond
(paren
id|info-&gt;origSCpnt
op_eq
id|SCpnt
)paren
(brace
id|info-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;command waiting for execution&quot;
)paren
suffix:semicolon
id|result
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Function: void fas216_reset_state(FAS216_Info *info)&n; * Purpose : Initialise driver internal state&n; * Params  : info - state to initialise&n; */
DECL|function|fas216_reset_state
r_static
r_void
id|fas216_reset_state
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Clear out all stale info in our state structure&n;&t; */
id|memset
(paren
id|info-&gt;busyluns
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;busyluns
)paren
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
id|info-&gt;scsi.reconnected.target
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.reconnected.lun
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.last_message
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.aborting
op_assign
l_int|0
suffix:semicolon
id|info-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifndef NO_DISCONNECTS
id|info-&gt;device
(braket
id|i
)braket
dot
id|disconnect_ok
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|info-&gt;device
(braket
id|i
)braket
dot
id|disconnect_ok
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|info-&gt;device
(braket
id|i
)braket
dot
id|stp
op_assign
id|fas216_syncperiod
c_func
(paren
id|info
comma
id|info-&gt;ifcfg.asyncperiod
)paren
suffix:semicolon
id|info-&gt;device
(braket
id|i
)braket
dot
id|sof
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SCSI2SYNC
id|info-&gt;device
(braket
id|i
)braket
dot
id|negstate
op_assign
id|syncneg_start
suffix:semicolon
macro_line|#else
id|info-&gt;device
(braket
id|i
)braket
dot
id|negstate
op_assign
id|syncneg_complete
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/* Function: void fas216_init_chip(FAS216_Info *info)&n; * Purpose : Initialise FAS216 state after reset&n; * Params  : info - state structure for interface&n; */
DECL|function|fas216_init_chip
r_static
r_void
id|fas216_init_chip
c_func
(paren
id|FAS216_Info
op_star
id|info
)paren
(brace
id|outb
c_func
(paren
id|fas216_clockrate
c_func
(paren
id|info-&gt;ifcfg.clockrate
)paren
comma
id|REG_CLKF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|1
)braket
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;ifcfg.select_timeout
comma
id|REG_STIM
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_SOF
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|fas216_syncperiod
c_func
(paren
id|info
comma
id|info-&gt;ifcfg.asyncperiod
)paren
comma
id|REG_STP
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_reset (Scsi_Cmnd *SCpnt, unsigned int reset_flags)&n; * Purpose : resets the adapter if something horrible happens.&n; * Params  : SCpnt - Command that is believed to be causing a problem.&n; *&t;     reset_flags - flags indicating reset type that is believed&n; *           to be required.&n; * Returns : one of SCSI_RESET_ macros, or&squot;d with the SCSI_RESET_*_RESET&n; *           macros.&n; */
DECL|function|fas216_reset
r_int
id|fas216_reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCptr
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|info-&gt;stats.resets
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d: fas216_reset: &quot;
comma
id|info-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|3
)braket
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|fas216_stoptransfer
c_func
(paren
id|info
)paren
suffix:semicolon
id|fas216_reset_state
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_flags
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
(brace
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|result
op_or_assign
id|SCSI_RESET_HOST_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reset_flags
op_amp
id|SCSI_RESET_SUGGEST_BUS_RESET
)paren
(brace
id|outb
c_func
(paren
id|CMD_RESETSCSI
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|result
op_or_assign
id|SCSI_RESET_BUS_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reset_flags
op_amp
(paren
id|SCSI_RESET_SUGGEST_BUS_RESET
op_or
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
)paren
)paren
(brace
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETSCSI
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|result
op_or_assign
id|SCSI_RESET_HOST_RESET
op_or
id|SCSI_RESET_BUS_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_amp
id|SCSI_RESET_HOST_RESET
)paren
id|fas216_init_chip
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Signal all commands in progress have been reset&n;&t; */
id|fas216_reportstatus
(paren
op_amp
id|info-&gt;SCpnt
comma
op_amp
id|SCpnt
comma
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|SCptr
op_assign
id|queue_remove
(paren
op_amp
id|info-&gt;queues.disconnected
)paren
)paren
op_ne
l_int|NULL
)paren
id|fas216_reportstatus
(paren
op_amp
id|SCptr
comma
op_amp
id|SCpnt
comma
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
multiline_comment|/*&n;&t;&t; * Command not found on disconnected queue, nor currently&n;&t;&t; * executing command - check pending commands&n;&t;&t; */
r_if
c_cond
(paren
id|info-&gt;origSCpnt
op_eq
id|SCpnt
)paren
id|info-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|queue_removecmd
c_func
(paren
op_amp
id|info-&gt;queues.issue
comma
id|SCpnt
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
op_or
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_init (struct Scsi_Host *instance)&n; * Purpose : initialise FAS/NCR/AMD SCSI ic.&n; * Params  : instance - a driver-specific filled-out structure&n; * Returns : 0 on success&n; */
DECL|function|fas216_init
r_int
id|fas216_init
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|target_jiffies
suffix:semicolon
id|info-&gt;host
op_assign
id|instance
suffix:semicolon
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
op_assign
id|instance-&gt;this_id
suffix:semicolon
id|info-&gt;scsi.cfg
(braket
l_int|1
)braket
op_assign
id|CNTL2_ENF
op_or
id|CNTL2_S2FE
suffix:semicolon
id|info-&gt;scsi.cfg
(braket
l_int|2
)braket
op_assign
id|CNTL3_ADIDCHK
op_or
id|CNTL3_G2CB
op_or
id|CNTL3_FASTSCSI
op_or
id|CNTL3_FASTCLK
suffix:semicolon
id|info-&gt;scsi.type
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
id|info-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|fas216_reset_state
c_func
(paren
id|info
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|info-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;stats
)paren
)paren
suffix:semicolon
id|msgqueue_initialise
(paren
op_amp
id|info-&gt;scsi.msgs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_initialise
(paren
op_amp
id|info-&gt;queues.issue
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_initialise
(paren
op_amp
id|info-&gt;queues.disconnected
)paren
)paren
(brace
id|queue_free
(paren
op_amp
id|info-&gt;queues.issue
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CNTL2_S2FE
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
op_amp
(paren
op_complement
l_int|0xe0
)paren
)paren
op_ne
id|CNTL2_S2FE
)paren
(brace
id|info-&gt;scsi.type
op_assign
l_string|&quot;NCR53C90&quot;
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|5
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
op_ne
l_int|5
)paren
(brace
id|info-&gt;scsi.type
op_assign
l_string|&quot;NCR53C90A&quot;
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;scsi.type
op_assign
l_string|&quot;NCR53C9x&quot;
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|CNTL3_ADIDCHK
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|REG_CNTL3
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_WITHDMA
op_or
id|CMD_NOP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CNTL2_ENF
comma
id|REG_CNTL2
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|inb
c_func
(paren
id|REG1_ID
c_func
(paren
id|info
)paren
)paren
)paren
(brace
r_case
l_int|12
suffix:colon
id|info-&gt;scsi.type
op_assign
l_string|&quot;Am53CF94&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|udelay
(paren
l_int|300
)paren
suffix:semicolon
multiline_comment|/* now for the real initialisation */
id|fas216_init_chip
c_func
(paren
id|info
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
op_or
id|CNTL1_DISR
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETSCSI
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* scsi standard says 250ms */
id|target_jiffies
op_assign
id|jiffies
op_plus
(paren
l_int|25
op_star
id|HZ
)paren
op_div
l_int|100
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|target_jiffies
)paren
id|barrier
(paren
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
id|info-&gt;scsi.cfg
(braket
l_int|0
)braket
comma
id|REG_CNTL1
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|REG_INST
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Function: int fas216_release (struct Scsi_Host *instance)&n; * Purpose : release all resources and put everything to bed for&n; *           FAS/NCR/AMD SCSI ic.&n; * Params  : instance - a driver-specific filled-out structure&n; * Returns : 0 on success&n; */
DECL|function|fas216_release
r_int
id|fas216_release
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|FAS216_Info
op_star
id|info
op_assign
(paren
id|FAS216_Info
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|outb
c_func
(paren
id|CMD_RESETCHIP
comma
id|REG_CMD
c_func
(paren
id|info
)paren
)paren
suffix:semicolon
id|queue_free
(paren
op_amp
id|info-&gt;queues.disconnected
)paren
suffix:semicolon
id|queue_free
(paren
op_amp
id|info-&gt;queues.issue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|fas216_init
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_init
)paren
suffix:semicolon
DECL|variable|fas216_abort
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_abort
)paren
suffix:semicolon
DECL|variable|fas216_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_reset
)paren
suffix:semicolon
DECL|variable|fas216_queue_command
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_queue_command
)paren
suffix:semicolon
DECL|variable|fas216_command
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_command
)paren
suffix:semicolon
DECL|variable|fas216_intr
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_intr
)paren
suffix:semicolon
DECL|variable|fas216_release
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_release
)paren
suffix:semicolon
DECL|variable|fas216_eh_abort
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_abort
)paren
suffix:semicolon
DECL|variable|fas216_eh_device_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_device_reset
)paren
suffix:semicolon
DECL|variable|fas216_eh_bus_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_bus_reset
)paren
suffix:semicolon
DECL|variable|fas216_eh_host_reset
id|EXPORT_SYMBOL
c_func
(paren
id|fas216_eh_host_reset
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
eof
