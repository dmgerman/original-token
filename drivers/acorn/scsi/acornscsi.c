multiline_comment|/*&n; *  linux/drivers/acorn/scsi/acornscsi.c&n; *&n; *  Acorn SCSI 3 driver&n; *  By R.M.King.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Abandoned using the Select and Transfer command since there were&n; * some nasty races between our software and the target devices that&n; * were not easy to solve, and the device errata had a lot of entries&n; * for this command, some of them quite nasty...&n; *&n; * Changelog:&n; *  26-Sep-1997&t;RMK&t;Re-jigged to use the queue module.&n; *&t;&t;&t;Re-coded state machine to be based on driver&n; *&t;&t;&t;state not scsi state.  Should be easier to debug.&n; *&t;&t;&t;Added acornscsi_release to clean up properly.&n; *&t;&t;&t;Updated proc/scsi reporting.&n; *  05-Oct-1997&t;RMK&t;Implemented writing to SCSI devices.&n; *  06-Oct-1997&t;RMK&t;Corrected small (non-serious) bug with the connect/&n; *&t;&t;&t;reconnect race condition causing a warning message.&n; *  12-Oct-1997&t;RMK&t;Added catch for re-entering interrupt routine.&n; *  15-Oct-1997&t;RMK&t;Improved handling of commands.&n; *  27-Jun-1998&t;RMK&t;Changed asm/delay.h to linux/delay.h.&n; *  13-Dec-1998&t;RMK&t;Better abort code and command handling.  Extra state&n; *&t;&t;&t;transitions added to allow dodgy devices to work.&n; */
DECL|macro|DEBUG_NO_WRITE
mdefine_line|#define DEBUG_NO_WRITE&t;1
DECL|macro|DEBUG_QUEUES
mdefine_line|#define DEBUG_QUEUES&t;2
DECL|macro|DEBUG_DMA
mdefine_line|#define DEBUG_DMA&t;4
DECL|macro|DEBUG_ABORT
mdefine_line|#define DEBUG_ABORT&t;8
DECL|macro|DEBUG_DISCON
mdefine_line|#define DEBUG_DISCON&t;16
DECL|macro|DEBUG_CONNECT
mdefine_line|#define DEBUG_CONNECT&t;32
DECL|macro|DEBUG_PHASES
mdefine_line|#define DEBUG_PHASES&t;64
DECL|macro|DEBUG_WRITE
mdefine_line|#define DEBUG_WRITE&t;128
DECL|macro|DEBUG_LINK
mdefine_line|#define DEBUG_LINK&t;256
DECL|macro|DEBUG_MESSAGES
mdefine_line|#define DEBUG_MESSAGES&t;512
DECL|macro|DEBUG_RESET
mdefine_line|#define DEBUG_RESET&t;1024
DECL|macro|DEBUG_ALL
mdefine_line|#define DEBUG_ALL&t;(DEBUG_RESET|DEBUG_MESSAGES|DEBUG_LINK|DEBUG_WRITE|&bslash;&n;&t;&t;&t; DEBUG_PHASES|DEBUG_CONNECT|DEBUG_DISCON|DEBUG_ABORT|&bslash;&n;&t;&t;&t; DEBUG_DMA|DEBUG_QUEUES)
multiline_comment|/* DRIVER CONFIGURATION&n; *&n; * SCSI-II Tagged queue support.&n; *&n; * I don&squot;t have any SCSI devices that support it, so it is totally untested&n; * (except to make sure that it doesn&squot;t interfere with any non-tagging&n; * devices).  It is not fully implemented either - what happens when a&n; * tagging device reconnects???&n; *&n; * You can tell if you have a device that supports tagged queueing my&n; * cating (eg) /proc/scsi/acornscsi/0 and see if the SCSI revision is reported&n; * as &squot;2 TAG&squot;.&n; *&n; * Also note that CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE is normally set in the config&n; * scripts, but disabled here.  Once debugged, remove the #undef, otherwise to debug,&n; * comment out the undef.&n; */
DECL|macro|CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
macro_line|#undef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
multiline_comment|/*&n; * SCSI-II Linked command support.&n; *&n; * The higher level code doesn&squot;t support linked commands yet, and so the option&n; * is undef&squot;d here.&n; */
DECL|macro|CONFIG_SCSI_ACORNSCSI_LINK
macro_line|#undef CONFIG_SCSI_ACORNSCSI_LINK
multiline_comment|/*&n; * SCSI-II Synchronous transfer support.&n; *&n; * Tried and tested...&n; *&n; * SDTR_SIZE&t;  - maximum number of un-acknowledged bytes (0 = off, 12 = max)&n; * SDTR_PERIOD&t;  - period of REQ signal (min=125, max=1020)&n; * DEFAULT_PERIOD - default REQ period.&n; */
DECL|macro|SDTR_SIZE
mdefine_line|#define SDTR_SIZE&t;12
DECL|macro|SDTR_PERIOD
mdefine_line|#define SDTR_PERIOD&t;125
DECL|macro|DEFAULT_PERIOD
mdefine_line|#define DEFAULT_PERIOD&t;500
multiline_comment|/*&n; * Debugging information&n; *&n; * DEBUG&t;  - bit mask from list above&n; * DEBUG_TARGET   - is defined to the target number if you want to debug&n; *&t;&t;    a specific target. [only recon/write/dma].&n; */
DECL|macro|DEBUG
mdefine_line|#define DEBUG (DEBUG_RESET|DEBUG_WRITE|DEBUG_NO_WRITE)
multiline_comment|/* only allow writing to SCSI device 0 */
DECL|macro|NO_WRITE
mdefine_line|#define NO_WRITE 0xFE
multiline_comment|/*#define DEBUG_TARGET 2*/
multiline_comment|/*&n; * Select timeout time (in 10ms units)&n; *&n; * This is the timeout used between the start of selection and the WD33C93&n; * chip deciding that the device isn&squot;t responding.&n; */
DECL|macro|TIMEOUT_TIME
mdefine_line|#define TIMEOUT_TIME 10
multiline_comment|/*&n; * Define this if you want to have verbose explaination of SCSI&n; * status/messages.&n; */
DECL|macro|CONFIG_ACORNSCSI_CONSTANTS
macro_line|#undef CONFIG_ACORNSCSI_CONSTANTS
multiline_comment|/*&n; * Define this if you want to use the on board DMAC [don&squot;t remove this option]&n; * If not set, then use PIO mode (not currently supported).&n; */
DECL|macro|USE_DMAC
mdefine_line|#define USE_DMAC
multiline_comment|/*&n; * List of devices that the driver will recognise&n; */
DECL|macro|ACORNSCSI_LIST
mdefine_line|#define ACORNSCSI_LIST { MANU_ACORN, PROD_ACORN_SCSI }
multiline_comment|/*&n; * ====================================================================================&n; */
macro_line|#ifdef DEBUG_TARGET
DECL|macro|DBG
mdefine_line|#define DBG(cmd,xxx...) &bslash;&n;  if (cmd-&gt;target == DEBUG_TARGET) { &bslash;&n;    xxx; &bslash;&n;  }
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(cmd,xxx...) xxx
macro_line|#endif
macro_line|#ifndef STRINGIFY
DECL|macro|STRINGIFY
mdefine_line|#define STRINGIFY(x) #x
macro_line|#endif
DECL|macro|STRx
mdefine_line|#define STRx(x) STRINGIFY(x)
DECL|macro|NO_WRITE_STR
mdefine_line|#define NO_WRITE_STR STRx(NO_WRITE)
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
macro_line|#include &quot;../../scsi/scsi.h&quot;
macro_line|#include &quot;../../scsi/hosts.h&quot;
macro_line|#include &quot;../../scsi/constants.h&quot;
macro_line|#include &quot;acornscsi.h&quot;
macro_line|#include &quot;msgqueue.h&quot;
DECL|macro|VER_MAJOR
mdefine_line|#define VER_MAJOR 2
DECL|macro|VER_MINOR
mdefine_line|#define VER_MINOR 0
DECL|macro|VER_PATCH
mdefine_line|#define VER_PATCH 6
macro_line|#ifndef ABORT_TAG
DECL|macro|ABORT_TAG
mdefine_line|#define ABORT_TAG 0xd
macro_line|#else
macro_line|#error &quot;Yippee!  ABORT TAG is now defined!  Remove this error!&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_LINK
macro_line|#error SCSI2 LINKed commands not supported (yet)!
macro_line|#endif
macro_line|#ifdef USE_DMAC
multiline_comment|/*&n; * DMAC setup parameters&n; */
DECL|macro|INIT_DEVCON0
mdefine_line|#define INIT_DEVCON0&t;(DEVCON0_RQL|DEVCON0_EXW|DEVCON0_CMP)
DECL|macro|INIT_DEVCON1
mdefine_line|#define INIT_DEVCON1&t;(DEVCON1_BHLD)
DECL|macro|DMAC_READ
mdefine_line|#define DMAC_READ&t;(MODECON_READ)
DECL|macro|DMAC_WRITE
mdefine_line|#define DMAC_WRITE&t;(MODECON_WRITE)
DECL|macro|INIT_SBICDMA
mdefine_line|#define INIT_SBICDMA&t;(CTRL_DMABURST)
DECL|macro|scsi_xferred
mdefine_line|#define scsi_xferred&t;have_data_in
multiline_comment|/*&n; * Size of on-board DMA buffer&n; */
DECL|macro|DMAC_BUFFER_SIZE
mdefine_line|#define DMAC_BUFFER_SIZE&t;65536
macro_line|#endif
DECL|macro|STATUS_BUFFER_TO_PRINT
mdefine_line|#define STATUS_BUFFER_TO_PRINT&t;24
DECL|variable|sdtr_period
r_int
r_int
id|sdtr_period
op_assign
id|SDTR_PERIOD
suffix:semicolon
DECL|variable|sdtr_size
r_int
r_int
id|sdtr_size
op_assign
id|SDTR_SIZE
suffix:semicolon
r_static
r_void
id|acornscsi_done
c_func
(paren
id|AS_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
op_star
id|SCpntp
comma
r_int
r_int
id|result
)paren
suffix:semicolon
r_static
r_int
id|acornscsi_reconnect_finish
c_func
(paren
id|AS_Host
op_star
id|host
)paren
suffix:semicolon
r_static
r_void
id|acornscsi_dma_cleanup
c_func
(paren
id|AS_Host
op_star
id|host
)paren
suffix:semicolon
r_static
r_void
id|acornscsi_abortcmd
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
r_char
id|tag
)paren
suffix:semicolon
multiline_comment|/* ====================================================================================&n; * Miscellaneous&n; */
r_static
r_inline
r_void
DECL|function|sbic_arm_write
id|sbic_arm_write
c_func
(paren
r_int
r_int
id|io_port
comma
r_int
id|reg
comma
r_int
id|value
)paren
(brace
id|outb_t
c_func
(paren
id|reg
comma
id|io_port
)paren
suffix:semicolon
id|outb_t
c_func
(paren
id|value
comma
id|io_port
op_plus
l_int|4
)paren
suffix:semicolon
)brace
DECL|macro|sbic_arm_writenext
mdefine_line|#define sbic_arm_writenext(io,val) &bslash;&n;&t;outb_t((val), (io) + 4)
r_static
r_inline
DECL|function|sbic_arm_read
r_int
id|sbic_arm_read
c_func
(paren
r_int
r_int
id|io_port
comma
r_int
id|reg
)paren
(brace
r_if
c_cond
(paren
id|reg
op_eq
id|ASR
)paren
(brace
r_return
id|inl_t
c_func
(paren
id|io_port
)paren
op_amp
l_int|255
suffix:semicolon
)brace
id|outb_t
c_func
(paren
id|reg
comma
id|io_port
)paren
suffix:semicolon
r_return
id|inl_t
c_func
(paren
id|io_port
op_plus
l_int|4
)paren
op_amp
l_int|255
suffix:semicolon
)brace
DECL|macro|sbic_arm_readnext
mdefine_line|#define sbic_arm_readnext(io) &bslash;&n;&t;inb_t((io) + 4)
macro_line|#ifdef USE_DMAC
DECL|macro|dmac_read
mdefine_line|#define dmac_read(io_port,reg) &bslash;&n;&t;inb((io_port) + (reg))
DECL|macro|dmac_write
mdefine_line|#define dmac_write(io_port,reg,value) &bslash;&n;&t;({ outb((value), (io_port) + (reg)); })
DECL|macro|dmac_clearintr
mdefine_line|#define dmac_clearintr(io_port) &bslash;&n;&t;({ outb(0, (io_port)); })
r_static
r_inline
DECL|function|dmac_address
r_int
r_int
id|dmac_address
c_func
(paren
r_int
r_int
id|io_port
)paren
(brace
r_return
id|dmac_read
c_func
(paren
id|io_port
comma
id|TXADRHI
)paren
op_lshift
l_int|16
op_or
id|dmac_read
c_func
(paren
id|io_port
comma
id|TXADRMD
)paren
op_lshift
l_int|8
op_or
id|dmac_read
c_func
(paren
id|io_port
comma
id|TXADRLO
)paren
suffix:semicolon
)brace
r_static
DECL|function|acornscsi_dumpdma
r_void
id|acornscsi_dumpdma
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_char
op_star
id|where
)paren
(brace
r_int
r_int
id|mode
comma
id|addr
comma
id|len
suffix:semicolon
id|mode
op_assign
id|dmac_read
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MODECON
)paren
suffix:semicolon
id|addr
op_assign
id|dmac_address
c_func
(paren
id|host-&gt;dma.io_port
)paren
suffix:semicolon
id|len
op_assign
id|dmac_read
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTHI
)paren
op_lshift
l_int|8
op_or
id|dmac_read
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTLO
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: %s: DMAC %02x @%06x+%04x msk %02x, &quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|where
comma
id|mode
comma
id|addr
comma
(paren
id|len
op_plus
l_int|1
)paren
op_amp
l_int|0xffff
comma
id|dmac_read
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMA @%06x, &quot;
comma
id|host-&gt;dma.start_addr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BH @%p +%04x, &quot;
comma
id|host-&gt;scsi.SCp.ptr
comma
id|host-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DT @+%04x ST @+%04x&quot;
comma
id|host-&gt;dma.transferred
comma
id|host-&gt;scsi.SCp.scsi_xferred
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
DECL|function|acornscsi_sbic_xfcount
r_int
r_int
id|acornscsi_sbic_xfcount
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|length
suffix:semicolon
id|length
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|TRANSCNTH
)paren
op_lshift
l_int|16
suffix:semicolon
id|length
op_or_assign
id|sbic_arm_readnext
c_func
(paren
id|host-&gt;scsi.io_port
)paren
op_lshift
l_int|8
suffix:semicolon
id|length
op_or_assign
id|sbic_arm_readnext
c_func
(paren
id|host-&gt;scsi.io_port
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornscsi_sbic_wait
id|acornscsi_sbic_wait
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
id|stat_mask
comma
r_int
id|stat
comma
r_int
id|timeout
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|asr
suffix:semicolon
r_do
(brace
id|asr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|asr
op_amp
id|stat_mask
)paren
op_eq
id|stat
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: timeout while %s&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|msg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
DECL|function|acornscsi_sbic_issuecmd
r_int
id|acornscsi_sbic_issuecmd
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
id|command
)paren
(brace
r_if
c_cond
(paren
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_CIP
comma
l_int|0
comma
l_int|1000
comma
l_string|&quot;issuing command&quot;
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CMND
comma
id|command
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|acornscsi_csdelay
id|acornscsi_csdelay
c_func
(paren
r_int
r_int
id|cs
)paren
(brace
r_int
r_int
id|target_jiffies
comma
id|flags
suffix:semicolon
id|target_jiffies
op_assign
id|jiffies
op_plus
l_int|1
op_plus
id|cs
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|target_jiffies
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
DECL|function|acornscsi_resetcard
r_void
id|acornscsi_resetcard
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|i
comma
id|timeout
suffix:semicolon
multiline_comment|/* assert reset line */
id|host-&gt;card.page_reg
op_assign
l_int|0x80
suffix:semicolon
id|outb
c_func
(paren
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
multiline_comment|/* wait 3 cs.  SCSI standard says 25ms. */
id|acornscsi_csdelay
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|host-&gt;card.page_reg
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
multiline_comment|/*&n;     * Should get a reset from the card&n;     */
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|host-&gt;card.io_intr
)paren
op_amp
l_int|8
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: timeout while resetting card&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
multiline_comment|/* setup sbic - WD33C93A */
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|OWNID
comma
id|OWNID_EAF
op_or
id|host-&gt;host-&gt;this_id
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CMND
comma
id|CMND_RESET
)paren
suffix:semicolon
multiline_comment|/*&n;     * Command should cause a reset interrupt&n;     */
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|host-&gt;card.io_intr
)paren
op_amp
l_int|8
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: timeout while resetting card&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
op_ne
l_int|0x01
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;scsi%d: WD33C93A didn&squot;t give enhanced reset interrupt&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CTRL
comma
id|INIT_SBICDMA
op_or
id|CTRL_IDI
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|TIMEOUT
comma
id|TIMEOUT_TIME
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SYNCHTRANSFER
comma
id|SYNCHTRANSFER_2DBA
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SOURCEID
comma
id|SOURCEID_ER
op_or
id|SOURCEID_DSP
)paren
suffix:semicolon
id|host-&gt;card.page_reg
op_assign
l_int|0x40
suffix:semicolon
id|outb
c_func
(paren
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
multiline_comment|/* setup dmac - uPC71071 */
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|INIT
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef USE_DMAC
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|INIT
comma
id|INIT_8BIT
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|CHANNEL
comma
id|CHANNEL_0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|DEVCON0
comma
id|INIT_DEVCON0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|DEVCON1
comma
id|INIT_DEVCON1
)paren
suffix:semicolon
macro_line|#endif
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
id|host-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|host-&gt;busyluns
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|host-&gt;device
(braket
id|i
)braket
dot
id|sync_state
op_assign
id|SYNC_NEGOCIATE
suffix:semicolon
id|host-&gt;device
(braket
id|i
)braket
dot
id|disconnect_ok
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* wait 25 cs.  SCSI standard says 250ms. */
id|acornscsi_csdelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
)brace
multiline_comment|/*=============================================================================================&n; * Utility routines (eg. debug)&n; */
macro_line|#ifdef CONFIG_ACORNSCSI_CONSTANTS
DECL|variable|acornscsi_interrupttype
r_static
r_char
op_star
id|acornscsi_interrupttype
(braket
)braket
op_assign
(brace
l_string|&quot;rst&quot;
comma
l_string|&quot;suc&quot;
comma
l_string|&quot;p/a&quot;
comma
l_string|&quot;3&quot;
comma
l_string|&quot;term&quot;
comma
l_string|&quot;5&quot;
comma
l_string|&quot;6&quot;
comma
l_string|&quot;7&quot;
comma
l_string|&quot;serv&quot;
comma
l_string|&quot;9&quot;
comma
l_string|&quot;a&quot;
comma
l_string|&quot;b&quot;
comma
l_string|&quot;c&quot;
comma
l_string|&quot;d&quot;
comma
l_string|&quot;e&quot;
comma
l_string|&quot;f&quot;
)brace
suffix:semicolon
DECL|variable|acornscsi_map
r_static
r_int
r_char
id|acornscsi_map
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|2
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|3
comma
op_minus
l_int|1
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|13
comma
l_int|14
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|15
comma
l_int|16
comma
l_int|17
comma
l_int|18
comma
l_int|19
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|20
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|21
comma
l_int|22
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|23
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|acornscsi_interruptcode
r_static
r_char
op_star
id|acornscsi_interruptcode
(braket
)braket
op_assign
(brace
multiline_comment|/* 0 */
l_string|&quot;reset - normal mode&quot;
comma
multiline_comment|/* 00 */
l_string|&quot;reset - advanced mode&quot;
comma
multiline_comment|/* 01 */
multiline_comment|/* 2 */
l_string|&quot;sel&quot;
comma
multiline_comment|/* 11 */
l_string|&quot;sel+xfer&quot;
comma
multiline_comment|/* 16 */
l_string|&quot;data-out&quot;
comma
multiline_comment|/* 18 */
l_string|&quot;data-in&quot;
comma
multiline_comment|/* 19 */
l_string|&quot;cmd&quot;
comma
multiline_comment|/* 1A */
l_string|&quot;stat&quot;
comma
multiline_comment|/* 1B */
l_string|&quot;??-out&quot;
comma
multiline_comment|/* 1C */
l_string|&quot;??-in&quot;
comma
multiline_comment|/* 1D */
l_string|&quot;msg-out&quot;
comma
multiline_comment|/* 1E */
l_string|&quot;msg-in&quot;
comma
multiline_comment|/* 1F */
multiline_comment|/* 12 */
l_string|&quot;/ACK asserted&quot;
comma
multiline_comment|/* 20 */
l_string|&quot;save-data-ptr&quot;
comma
multiline_comment|/* 21 */
l_string|&quot;{re}sel&quot;
comma
multiline_comment|/* 22 */
multiline_comment|/* 15 */
l_string|&quot;inv cmd&quot;
comma
multiline_comment|/* 40 */
l_string|&quot;unexpected disconnect&quot;
comma
multiline_comment|/* 41 */
l_string|&quot;sel timeout&quot;
comma
multiline_comment|/* 42 */
l_string|&quot;P err&quot;
comma
multiline_comment|/* 43 */
l_string|&quot;P err+ATN&quot;
comma
multiline_comment|/* 44 */
l_string|&quot;bad status byte&quot;
comma
multiline_comment|/* 47 */
multiline_comment|/* 21 */
l_string|&quot;resel, no id&quot;
comma
multiline_comment|/* 80 */
l_string|&quot;resel&quot;
comma
multiline_comment|/* 81 */
l_string|&quot;discon&quot;
comma
multiline_comment|/* 85 */
)brace
suffix:semicolon
r_static
DECL|function|print_scsi_status
r_void
id|print_scsi_status
c_func
(paren
r_int
r_int
id|ssr
)paren
(brace
r_if
c_cond
(paren
id|acornscsi_map
(braket
id|ssr
)braket
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s:%s&quot;
comma
id|acornscsi_interrupttype
(braket
(paren
id|ssr
op_rshift
l_int|4
)paren
)braket
comma
id|acornscsi_interruptcode
(braket
id|acornscsi_map
(braket
id|ssr
)braket
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%X:%X&quot;
comma
id|ssr
op_rshift
l_int|4
comma
id|ssr
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
DECL|function|print_sbic_status
r_void
id|print_sbic_status
c_func
(paren
r_int
id|asr
comma
r_int
id|ssr
comma
r_int
id|cmdphase
)paren
(brace
macro_line|#ifdef CONFIG_ACORNSCSI_CONSTANTS
id|printk
c_func
(paren
l_string|&quot;sbic: %c%c%c%c%c%c &quot;
comma
id|asr
op_amp
id|ASR_INT
ques
c_cond
l_char|&squot;I&squot;
suffix:colon
l_char|&squot;i&squot;
comma
id|asr
op_amp
id|ASR_LCI
ques
c_cond
l_char|&squot;L&squot;
suffix:colon
l_char|&squot;l&squot;
comma
id|asr
op_amp
id|ASR_BSY
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;b&squot;
comma
id|asr
op_amp
id|ASR_CIP
ques
c_cond
l_char|&squot;C&squot;
suffix:colon
l_char|&squot;c&squot;
comma
id|asr
op_amp
id|ASR_PE
ques
c_cond
l_char|&squot;P&squot;
suffix:colon
l_char|&squot;p&squot;
comma
id|asr
op_amp
id|ASR_DBR
ques
c_cond
l_char|&squot;D&squot;
suffix:colon
l_char|&squot;d&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi: &quot;
)paren
suffix:semicolon
id|print_scsi_status
c_func
(paren
id|ssr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; ph %02X&bslash;n&quot;
comma
id|cmdphase
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;sbic: %02X scsi: %X:%X ph: %02X&bslash;n&quot;
comma
id|asr
comma
(paren
id|ssr
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|ssr
op_amp
l_int|0x0f
comma
id|cmdphase
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|acornscsi_dumplogline
id|acornscsi_dumplogline
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
id|target
comma
r_int
id|line
)paren
(brace
r_int
r_int
id|prev
suffix:semicolon
r_int
r_int
id|ptr
suffix:semicolon
id|ptr
op_assign
id|host-&gt;status_ptr
(braket
id|target
)braket
op_minus
id|STATUS_BUFFER_TO_PRINT
suffix:semicolon
r_if
c_cond
(paren
id|ptr
OL
l_int|0
)paren
id|ptr
op_add_assign
id|STATUS_BUFFER_SIZE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c: %3s:&quot;
comma
id|target
op_eq
l_int|8
ques
c_cond
l_char|&squot;H&squot;
suffix:colon
l_char|&squot;0&squot;
op_plus
id|target
comma
id|line
op_eq
l_int|0
ques
c_cond
l_string|&quot;ph&quot;
suffix:colon
id|line
op_eq
l_int|1
ques
c_cond
l_string|&quot;ssr&quot;
suffix:colon
l_string|&quot;int&quot;
)paren
suffix:semicolon
id|prev
op_assign
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|when
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|ptr
op_ne
id|host-&gt;status_ptr
(braket
id|target
)braket
suffix:semicolon
id|ptr
op_assign
(paren
id|ptr
op_plus
l_int|1
)paren
op_amp
(paren
id|STATUS_BUFFER_SIZE
op_minus
l_int|1
)paren
)paren
(brace
r_int
r_int
id|time_diff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|when
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|line
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%c%02X&quot;
comma
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|irq
ques
c_cond
l_char|&squot;-&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|ph
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|ssr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|time_diff
op_assign
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|when
op_minus
id|prev
suffix:semicolon
id|prev
op_assign
id|host-&gt;status
(braket
id|target
)braket
(braket
id|ptr
)braket
dot
id|when
suffix:semicolon
r_if
c_cond
(paren
id|time_diff
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;==^&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|time_diff
op_ge
l_int|100
)paren
id|printk
c_func
(paren
l_string|&quot;   &quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot; %02ld&quot;
comma
id|time_diff
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
DECL|function|acornscsi_dumplog
r_void
id|acornscsi_dumplog
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
id|target
)paren
(brace
r_do
(brace
id|acornscsi_dumplogline
c_func
(paren
id|host
comma
id|target
comma
l_int|0
)paren
suffix:semicolon
id|acornscsi_dumplogline
c_func
(paren
id|host
comma
id|target
comma
l_int|1
)paren
suffix:semicolon
id|acornscsi_dumplogline
c_func
(paren
id|host
comma
id|target
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target
op_eq
l_int|8
)paren
r_break
suffix:semicolon
id|target
op_assign
l_int|8
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
DECL|function|acornscsi_target
r_char
id|acornscsi_target
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;SCpnt
)paren
r_return
l_char|&squot;0&squot;
op_plus
id|host-&gt;SCpnt-&gt;target
suffix:semicolon
r_return
l_char|&squot;H&squot;
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: cmdtype_t acornscsi_cmdtype(int command)&n; * Purpose  : differentiate READ from WRITE from other commands&n; * Params   : command - command to interpret&n; * Returns  : CMD_READ&t;- command reads data,&n; *&t;      CMD_WRITE - command writes data,&n; *&t;      CMD_MISC&t;- everything else&n; */
r_static
r_inline
DECL|function|acornscsi_cmdtype
id|cmdtype_t
id|acornscsi_cmdtype
c_func
(paren
r_int
id|command
)paren
(brace
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
r_return
id|CMD_WRITE
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|READ_12
suffix:colon
r_return
id|CMD_READ
suffix:semicolon
r_default
suffix:colon
r_return
id|CMD_MISC
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Prototype: int acornscsi_datadirection(int command)&n; * Purpose  : differentiate between commands that have a DATA IN phase&n; *&t;      and a DATA OUT phase&n; * Params   : command - command to interpret&n; * Returns  : DATADIR_OUT - data out phase expected&n; *&t;      DATADIR_IN  - data in phase expected&n; */
r_static
DECL|function|acornscsi_datadirection
id|datadir_t
id|acornscsi_datadirection
c_func
(paren
r_int
id|command
)paren
(brace
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|CHANGE_DEFINITION
suffix:colon
r_case
id|COMPARE
suffix:colon
r_case
id|COPY
suffix:colon
r_case
id|COPY_VERIFY
suffix:colon
r_case
id|LOG_SELECT
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SELECT_10
suffix:colon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_case
id|FORMAT_UNIT
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|SEARCH_EQUAL
suffix:colon
r_case
id|SEARCH_HIGH
suffix:colon
r_case
id|SEARCH_LOW
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_VERIFY
suffix:colon
r_case
id|UPDATE_BLOCK
suffix:colon
r_case
id|WRITE_LONG
suffix:colon
r_case
id|WRITE_SAME
suffix:colon
r_case
id|SEARCH_HIGH_12
suffix:colon
r_case
id|SEARCH_EQUAL_12
suffix:colon
r_case
id|SEARCH_LOW_12
suffix:colon
r_case
id|WRITE_12
suffix:colon
r_case
id|WRITE_VERIFY_12
suffix:colon
r_case
id|SET_WINDOW
suffix:colon
r_case
id|MEDIUM_SCAN
suffix:colon
r_case
id|SEND_VOLUME_TAG
suffix:colon
r_case
l_int|0xea
suffix:colon
r_return
id|DATADIR_OUT
suffix:semicolon
r_default
suffix:colon
r_return
id|DATADIR_IN
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Purpose  : provide values for synchronous transfers with 33C93.&n; * Copyright: Copyright (c) 1996 John Shifflett, GeoLog Consulting&n; *&t;Modified by Russell King for 8MHz WD33C93A&n; */
DECL|struct|sync_xfer_tbl
r_static
r_struct
id|sync_xfer_tbl
(brace
DECL|member|period_ns
r_int
r_int
id|period_ns
suffix:semicolon
DECL|member|reg_value
r_int
r_char
id|reg_value
suffix:semicolon
DECL|variable|sync_xfer_table
)brace
id|sync_xfer_table
(braket
)braket
op_assign
(brace
(brace
l_int|1
comma
l_int|0x20
)brace
comma
(brace
l_int|249
comma
l_int|0x20
)brace
comma
(brace
l_int|374
comma
l_int|0x30
)brace
comma
(brace
l_int|499
comma
l_int|0x40
)brace
comma
(brace
l_int|624
comma
l_int|0x50
)brace
comma
(brace
l_int|749
comma
l_int|0x60
)brace
comma
(brace
l_int|874
comma
l_int|0x70
)brace
comma
(brace
l_int|999
comma
l_int|0x00
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Prototype: int acornscsi_getperiod(unsigned char syncxfer)&n; * Purpose  : period for the synchronous transfer setting&n; * Params   : syncxfer SYNCXFER register value&n; * Returns  : period in ns.&n; */
r_static
DECL|function|acornscsi_getperiod
r_int
id|acornscsi_getperiod
c_func
(paren
r_int
r_char
id|syncxfer
)paren
(brace
r_int
id|i
suffix:semicolon
id|syncxfer
op_and_assign
l_int|0xf0
suffix:semicolon
r_if
c_cond
(paren
id|syncxfer
op_eq
l_int|0x10
)paren
id|syncxfer
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|sync_xfer_table
(braket
id|i
)braket
dot
id|period_ns
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|syncxfer
op_eq
id|sync_xfer_table
(braket
id|i
)braket
dot
id|reg_value
)paren
r_return
id|sync_xfer_table
(braket
id|i
)braket
dot
id|period_ns
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: int round_period(unsigned int period)&n; * Purpose  : return index into above table for a required REQ period&n; * Params   : period - time (ns) for REQ&n; * Returns  : table index&n; * Copyright: Copyright (c) 1996 John Shifflett, GeoLog Consulting&n; */
r_static
r_inline
DECL|function|round_period
r_int
id|round_period
c_func
(paren
r_int
r_int
id|period
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|sync_xfer_table
(braket
id|i
)braket
dot
id|period_ns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|period
op_le
id|sync_xfer_table
(braket
id|i
)braket
dot
id|period_ns
)paren
op_logical_and
(paren
id|period
OG
id|sync_xfer_table
(braket
id|i
op_minus
l_int|1
)braket
dot
id|period_ns
)paren
)paren
r_return
id|i
suffix:semicolon
)brace
r_return
l_int|7
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: unsigned char calc_sync_xfer(unsigned int period, unsigned int offset)&n; * Purpose  : calculate value for 33c93s SYNC register&n; * Params   : period - time (ns) for REQ&n; *&t;      offset - offset in bytes between REQ/ACK&n; * Returns  : value for SYNC register&n; * Copyright: Copyright (c) 1996 John Shifflett, GeoLog Consulting&n; */
r_static
DECL|function|calc_sync_xfer
r_int
r_char
id|calc_sync_xfer
c_func
(paren
r_int
r_int
id|period
comma
r_int
r_int
id|offset
)paren
(brace
r_return
id|sync_xfer_table
(braket
id|round_period
c_func
(paren
id|period
)paren
)braket
dot
id|reg_value
op_or
(paren
(paren
id|offset
OL
id|SDTR_SIZE
)paren
ques
c_cond
id|offset
suffix:colon
id|SDTR_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* ====================================================================================&n; * Command functions&n; */
multiline_comment|/*&n; * Function: acornscsi_kick(AS_Host *host)&n; * Purpose : kick next command to interface&n; * Params  : host - host to send command to&n; * Returns : INTR_IDLE if idle, otherwise INTR_PROCESSING&n; * Notes   : interrupts are always disabled!&n; */
r_static
DECL|function|acornscsi_kick
id|intr_ret_t
id|acornscsi_kick
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
id|from_queue
op_assign
l_int|0
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
multiline_comment|/* first check to see if a command is waiting to be executed */
id|SCpnt
op_assign
id|host-&gt;origSCpnt
suffix:semicolon
id|host-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* retrieve next command */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|SCpnt
op_assign
id|queue_remove_exclude
c_func
(paren
op_amp
id|host-&gt;queues.issue
comma
id|host-&gt;busyluns
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
id|INTR_IDLE
suffix:semicolon
id|from_queue
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|host-&gt;scsi.disconnectable
op_logical_and
id|host-&gt;SCpnt
)paren
(brace
id|queue_add_cmd_tail
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
comma
id|host-&gt;SCpnt
)paren
suffix:semicolon
id|host-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_QUEUES|DEBUG_DISCON))
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: moved command to disconnected queue&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;     * If we have an interrupt pending, then we may have been reselected.&n;     * In this case, we don&squot;t want to write to the registers&n;     */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
op_amp
(paren
id|ASR_INT
op_or
id|ASR_BSY
op_or
id|ASR_CIP
)paren
)paren
)paren
(brace
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DESTID
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CMND
comma
id|CMND_SELWITHATN
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * claim host busy - all of these must happen atomically wrt&n;     * our interrupt routine.  Failure means command loss.&n;     */
id|host-&gt;scsi.phase
op_assign
id|PHASE_CONNECTING
suffix:semicolon
id|host-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
id|host-&gt;scsi.SCp
op_assign
id|SCpnt-&gt;SCp
suffix:semicolon
id|host-&gt;dma.xfer_setup
op_assign
l_int|0
suffix:semicolon
id|host-&gt;dma.xfer_required
op_assign
l_int|0
suffix:semicolon
id|host-&gt;dma.xfer_done
op_assign
l_int|0
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_ABORT|DEBUG_CONNECT))
id|DBG
c_func
(paren
id|SCpnt
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: starting cmd %02X&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|from_queue
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
multiline_comment|/*&n;&t; * tagged queueing - allocate a new tag to this command&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;tagged_queue
)paren
(brace
id|SCpnt-&gt;device-&gt;current_tag
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;current_tag
op_eq
l_int|0
)paren
id|SCpnt-&gt;device-&gt;current_tag
op_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
id|SCpnt-&gt;device-&gt;current_tag
suffix:semicolon
)brace
r_else
macro_line|#endif
id|set_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|host-&gt;busyluns
)paren
suffix:semicolon
id|host-&gt;stats.removes
op_add_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|acornscsi_cmdtype
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
(brace
r_case
id|CMD_WRITE
suffix:colon
id|host-&gt;stats.writes
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_READ
suffix:colon
id|host-&gt;stats.reads
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_MISC
suffix:colon
id|host-&gt;stats.miscs
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: void acornscsi_done(AS_Host *host, Scsi_Cmnd **SCpntp, unsigned int result)&n; * Purpose : complete processing for command&n; * Params  : host   - interface that completed&n; *&t;     result - driver byte of result&n; */
r_static
DECL|function|acornscsi_done
r_void
id|acornscsi_done
c_func
(paren
id|AS_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
op_star
id|SCpntp
comma
r_int
r_int
id|result
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
op_star
id|SCpntp
suffix:semicolon
multiline_comment|/* clean up */
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SOURCEID
comma
id|SOURCEID_ER
op_or
id|SOURCEID_DSP
)paren
suffix:semicolon
id|host-&gt;stats.fins
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
op_star
id|SCpntp
op_assign
l_int|NULL
suffix:semicolon
id|acornscsi_dma_cleanup
c_func
(paren
id|host
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
op_lshift
l_int|16
op_or
id|host-&gt;scsi.SCp.Message
op_lshift
l_int|8
op_or
id|host-&gt;scsi.SCp.Status
suffix:semicolon
multiline_comment|/*&n;&t; * In theory, this should not happen.  In practice, it seems to.&n;&t; * Only trigger an error if the device attempts to report all happy&n;&t; * but with untransferred buffers...  If we don&squot;t do something, then&n;&t; * data loss will occur.  Should we check SCpnt-&gt;underflow here?&n;&t; * It doesn&squot;t appear to be set to something meaningful by the higher&n;&t; * levels all the time.&n;&t; */
r_if
c_cond
(paren
id|result
op_eq
id|DID_OK
)paren
(brace
r_int
id|xfer_warn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;underflow
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;scsi.SCp.ptr
op_logical_and
id|acornscsi_cmdtype
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
op_ne
id|CMD_MISC
)paren
id|xfer_warn
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|host-&gt;scsi.SCp.scsi_xferred
OL
id|SCpnt-&gt;underflow
op_logical_or
id|host-&gt;scsi.SCp.scsi_xferred
op_ne
id|host-&gt;dma.transferred
)paren
id|xfer_warn
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ANSI standard says: (SCSI-2 Rev 10c Sect 5.6.6)&n;&t;&t; *  Targets which break data transfers into multiple&n;&t;&t; *  connections shall end each successful connection&n;&t;&t; *  (except possibly the last) with a SAVE DATA&n;&t;&t; *  POINTER - DISCONNECT message sequence.&n;&t;&t; *&n;&t;&t; * This makes it difficult to ensure that a transfer has&n;&t;&t; * completed.  If we reach the end of a transfer during&n;&t;&t; * the command, then we can only have finished the transfer.&n;&t;&t; * therefore, if we seem to have some data remaining, this&n;&t;&t; * is not a problem.&n;&t;&t; */
r_if
c_cond
(paren
id|host-&gt;dma.xfer_done
)paren
id|xfer_warn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|xfer_warn
)paren
(brace
r_switch
c_cond
(paren
id|status_byte
c_func
(paren
id|SCpnt-&gt;result
)paren
)paren
(brace
r_case
id|CHECK_CONDITION
suffix:colon
r_case
id|COMMAND_TERMINATED
suffix:colon
r_case
id|BUSY
suffix:colon
r_case
id|QUEUE_FULL
suffix:colon
r_case
id|RESERVATION_CONFLICT
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.H: incomplete data transfer detected: result=%08X command=&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;result
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;done&quot;
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_and_assign
l_int|0xffff
suffix:semicolon
id|SCpnt-&gt;result
op_or_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;scsi_done
)paren
id|panic
c_func
(paren
l_string|&quot;scsi%d.H: null scsi_done function in acornscsi_done&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|host-&gt;busyluns
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;scsi%d: null command in acornscsi_done&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
)brace
multiline_comment|/* ====================================================================================&n; * DMA routines&n; */
multiline_comment|/*&n; * Purpose  : update SCSI Data Pointer&n; * Notes    : this will only be one SG entry or less&n; */
r_static
DECL|function|acornscsi_data_updateptr
r_void
id|acornscsi_data_updateptr
c_func
(paren
id|AS_Host
op_star
id|host
comma
id|Scsi_Pointer
op_star
id|SCp
comma
r_int
r_int
id|length
)paren
(brace
id|SCp-&gt;ptr
op_add_assign
id|length
suffix:semicolon
id|SCp-&gt;this_residual
op_sub_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCp-&gt;this_residual
)paren
(brace
r_if
c_cond
(paren
id|SCp-&gt;buffers_residual
)paren
(brace
id|SCp-&gt;buffer
op_increment
suffix:semicolon
id|SCp-&gt;buffers_residual
op_decrement
suffix:semicolon
id|SCp-&gt;ptr
op_assign
(paren
r_char
op_star
)paren
id|SCp-&gt;buffer-&gt;address
suffix:semicolon
id|SCp-&gt;this_residual
op_assign
id|SCp-&gt;buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|SCp-&gt;ptr
op_assign
l_int|NULL
suffix:semicolon
id|host-&gt;dma.xfer_done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Prototype: void acornscsi_data_read(AS_Host *host, char *ptr,&n; *&t;&t;&t;&t;unsigned int start_addr, unsigned int length)&n; * Purpose  : read data from DMA RAM&n; * Params   : host - host to transfer from&n; *&t;      ptr  - DRAM address&n; *&t;      start_addr - host mem address&n; *&t;      length - number of bytes to transfer&n; * Notes    : this will only be one SG entry or less&n; */
r_static
DECL|function|acornscsi_data_read
r_void
id|acornscsi_data_read
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_char
op_star
id|ptr
comma
r_int
r_int
id|start_addr
comma
r_int
r_int
id|length
)paren
(brace
r_extern
r_void
id|__acornscsi_in
c_func
(paren
r_int
id|port
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
r_int
r_int
id|page
comma
id|offset
comma
id|len
op_assign
id|length
suffix:semicolon
id|page
op_assign
(paren
id|start_addr
op_rshift
l_int|12
)paren
suffix:semicolon
id|offset
op_assign
id|start_addr
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|12
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|page
op_amp
l_int|0x3f
)paren
op_or
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
r_int
id|this_len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|offset
OG
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
id|this_len
op_assign
(paren
l_int|1
op_lshift
l_int|12
)paren
op_minus
id|offset
suffix:semicolon
r_else
id|this_len
op_assign
id|len
suffix:semicolon
id|__acornscsi_in
c_func
(paren
id|host-&gt;card.io_ram
op_plus
(paren
id|offset
op_lshift
l_int|1
)paren
comma
id|ptr
comma
id|this_len
)paren
suffix:semicolon
id|offset
op_add_assign
id|this_len
suffix:semicolon
id|ptr
op_add_assign
id|this_len
suffix:semicolon
id|len
op_sub_assign
id|this_len
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
(brace
id|offset
op_assign
l_int|0
suffix:semicolon
id|page
op_increment
suffix:semicolon
id|outb
c_func
(paren
(paren
id|page
op_amp
l_int|0x3f
)paren
op_or
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: void acornscsi_data_write(AS_Host *host, char *ptr,&n; *&t;&t;&t;&t;unsigned int start_addr, unsigned int length)&n; * Purpose  : write data to DMA RAM&n; * Params   : host - host to transfer from&n; *&t;      ptr  - DRAM address&n; *&t;      start_addr - host mem address&n; *&t;      length - number of bytes to transfer&n; * Notes    : this will only be one SG entry or less&n; */
r_static
DECL|function|acornscsi_data_write
r_void
id|acornscsi_data_write
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_char
op_star
id|ptr
comma
r_int
r_int
id|start_addr
comma
r_int
r_int
id|length
)paren
(brace
r_extern
r_void
id|__acornscsi_out
c_func
(paren
r_int
id|port
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
r_int
r_int
id|page
comma
id|offset
comma
id|len
op_assign
id|length
suffix:semicolon
id|page
op_assign
(paren
id|start_addr
op_rshift
l_int|12
)paren
suffix:semicolon
id|offset
op_assign
id|start_addr
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|12
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|page
op_amp
l_int|0x3f
)paren
op_or
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
r_int
id|this_len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|offset
OG
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
id|this_len
op_assign
(paren
l_int|1
op_lshift
l_int|12
)paren
op_minus
id|offset
suffix:semicolon
r_else
id|this_len
op_assign
id|len
suffix:semicolon
id|__acornscsi_out
c_func
(paren
id|host-&gt;card.io_ram
op_plus
(paren
id|offset
op_lshift
l_int|1
)paren
comma
id|ptr
comma
id|this_len
)paren
suffix:semicolon
id|offset
op_add_assign
id|this_len
suffix:semicolon
id|ptr
op_add_assign
id|this_len
suffix:semicolon
id|len
op_sub_assign
id|this_len
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
(brace
id|offset
op_assign
l_int|0
suffix:semicolon
id|page
op_increment
suffix:semicolon
id|outb
c_func
(paren
(paren
id|page
op_amp
l_int|0x3f
)paren
op_or
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|host-&gt;card.page_reg
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
)brace
multiline_comment|/* =========================================================================================&n; * On-board DMA routines&n; */
macro_line|#ifdef USE_DMAC
multiline_comment|/*&n; * Prototype: void acornscsi_dmastop(AS_Host *host)&n; * Purpose  : stop all DMA&n; * Params   : host - host on which to stop DMA&n; * Notes    : This is called when leaving DATA IN/OUT phase,&n; *&t;      or when interface is RESET&n; */
r_static
r_inline
DECL|function|acornscsi_dma_stop
r_void
id|acornscsi_dma_stop
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_ON
)paren
suffix:semicolon
id|dmac_clearintr
c_func
(paren
id|host-&gt;dma.io_intr_clear
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_DMA)
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;stop&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Function: void acornscsi_dma_setup(AS_Host *host, dmadir_t direction)&n; * Purpose : setup DMA controller for data transfer&n; * Params  : host - host to setup&n; *&t;     direction - data transfer direction&n; * Notes   : This is called when entering DATA I/O phase, not&n; *&t;     while we&squot;re in a DATA I/O phase&n; */
r_static
DECL|function|acornscsi_dma_setup
r_void
id|acornscsi_dma_setup
c_func
(paren
id|AS_Host
op_star
id|host
comma
id|dmadir_t
id|direction
)paren
(brace
r_int
r_int
id|address
comma
id|length
comma
id|mode
suffix:semicolon
id|host-&gt;dma.direction
op_assign
id|direction
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_ON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|DMA_OUT
)paren
(brace
macro_line|#if (DEBUG &amp; DEBUG_NO_WRITE)
r_if
c_cond
(paren
id|NO_WRITE
op_amp
(paren
l_int|1
op_lshift
id|host-&gt;SCpnt-&gt;target
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;scsi%d.%c: I can&squot;t handle DMA_OUT!&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|mode
op_assign
id|DMAC_WRITE
suffix:semicolon
)brace
r_else
id|mode
op_assign
id|DMAC_READ
suffix:semicolon
multiline_comment|/*&n;     * Allocate some buffer space, limited to half the buffer size&n;     */
id|length
op_assign
id|min
c_func
(paren
id|host-&gt;scsi.SCp.this_residual
comma
id|DMAC_BUFFER_SIZE
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
(brace
id|host-&gt;dma.start_addr
op_assign
id|address
op_assign
id|host-&gt;dma.free_addr
suffix:semicolon
id|host-&gt;dma.free_addr
op_assign
(paren
id|host-&gt;dma.free_addr
op_plus
id|length
)paren
op_amp
(paren
id|DMAC_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Transfer data to DMA memory&n;&t; */
r_if
c_cond
(paren
id|direction
op_eq
id|DMA_OUT
)paren
id|acornscsi_data_write
c_func
(paren
id|host
comma
id|host-&gt;scsi.SCp.ptr
comma
id|host-&gt;dma.start_addr
comma
id|length
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|1
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTLO
comma
id|length
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTHI
comma
id|length
op_rshift
l_int|8
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRLO
comma
id|address
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRMD
comma
id|address
op_rshift
l_int|8
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRHI
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MODECON
comma
id|mode
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_OFF
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_DMA)
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;strt&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
id|host-&gt;dma.xfer_setup
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function: void acornscsi_dma_cleanup(AS_Host *host)&n; * Purpose : ensure that all DMA transfers are up-to-date &amp; host-&gt;scsi.SCp is correct&n; * Params  : host - host to finish&n; * Notes   : This is called when a command is:&n; *&t;&t;terminating, RESTORE_POINTERS, SAVE_POINTERS, DISCONECT&n; *&t;   : This must not return until all transfers are completed.&n; */
r_static
DECL|function|acornscsi_dma_cleanup
r_void
id|acornscsi_dma_cleanup
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_ON
)paren
suffix:semicolon
id|dmac_clearintr
c_func
(paren
id|host-&gt;dma.io_intr_clear
)paren
suffix:semicolon
multiline_comment|/*&n;     * Check for a pending transfer&n;     */
r_if
c_cond
(paren
id|host-&gt;dma.xfer_required
)paren
(brace
id|host-&gt;dma.xfer_required
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;dma.direction
op_eq
id|DMA_IN
)paren
id|acornscsi_data_read
c_func
(paren
id|host
comma
id|host-&gt;dma.xfer_ptr
comma
id|host-&gt;dma.xfer_start
comma
id|host-&gt;dma.xfer_length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * Has a transfer been setup?&n;     */
r_if
c_cond
(paren
id|host-&gt;dma.xfer_setup
)paren
(brace
r_int
r_int
id|transferred
suffix:semicolon
id|host-&gt;dma.xfer_setup
op_assign
l_int|0
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_DMA)
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;cupi&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Calculate number of bytes transferred from DMA.&n;&t; */
id|transferred
op_assign
id|dmac_address
c_func
(paren
id|host-&gt;dma.io_port
)paren
op_minus
id|host-&gt;dma.start_addr
suffix:semicolon
id|host-&gt;dma.transferred
op_add_assign
id|transferred
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;dma.direction
op_eq
id|DMA_IN
)paren
id|acornscsi_data_read
c_func
(paren
id|host
comma
id|host-&gt;scsi.SCp.ptr
comma
id|host-&gt;dma.start_addr
comma
id|transferred
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Update SCSI pointers&n;&t; */
id|acornscsi_data_updateptr
c_func
(paren
id|host
comma
op_amp
id|host-&gt;scsi.SCp
comma
id|transferred
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_DMA)
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;cupo&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Function: void acornscsi_dmacintr(AS_Host *host)&n; * Purpose : handle interrupts from DMAC device&n; * Params  : host - host to process&n; * Notes   : If reading, we schedule the read to main memory &amp;&n; *&t;     allow the transfer to continue.&n; *&t;   : If writing, we fill the onboard DMA memory from main&n; *&t;     memory.&n; *&t;   : Called whenever DMAC finished it&squot;s current transfer.&n; */
r_static
DECL|function|acornscsi_dma_intr
r_void
id|acornscsi_dma_intr
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|address
comma
id|length
comma
id|transferred
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_DMA)
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;inti&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_ON
)paren
suffix:semicolon
id|dmac_clearintr
c_func
(paren
id|host-&gt;dma.io_intr_clear
)paren
suffix:semicolon
multiline_comment|/*&n;     * Calculate amount transferred via DMA&n;     */
id|transferred
op_assign
id|dmac_address
c_func
(paren
id|host-&gt;dma.io_port
)paren
op_minus
id|host-&gt;dma.start_addr
suffix:semicolon
id|host-&gt;dma.transferred
op_add_assign
id|transferred
suffix:semicolon
multiline_comment|/*&n;     * Schedule DMA transfer off board&n;     */
r_if
c_cond
(paren
id|host-&gt;dma.direction
op_eq
id|DMA_IN
)paren
(brace
id|host-&gt;dma.xfer_start
op_assign
id|host-&gt;dma.start_addr
suffix:semicolon
id|host-&gt;dma.xfer_length
op_assign
id|transferred
suffix:semicolon
id|host-&gt;dma.xfer_ptr
op_assign
id|host-&gt;scsi.SCp.ptr
suffix:semicolon
id|host-&gt;dma.xfer_required
op_assign
l_int|1
suffix:semicolon
)brace
id|acornscsi_data_updateptr
c_func
(paren
id|host
comma
op_amp
id|host-&gt;scsi.SCp
comma
id|transferred
)paren
suffix:semicolon
multiline_comment|/*&n;     * Allocate some buffer space, limited to half the on-board RAM size&n;     */
id|length
op_assign
id|min
c_func
(paren
id|host-&gt;scsi.SCp.this_residual
comma
id|DMAC_BUFFER_SIZE
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
(brace
id|host-&gt;dma.start_addr
op_assign
id|address
op_assign
id|host-&gt;dma.free_addr
suffix:semicolon
id|host-&gt;dma.free_addr
op_assign
(paren
id|host-&gt;dma.free_addr
op_plus
id|length
)paren
op_amp
(paren
id|DMAC_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Transfer data to DMA memory&n;&t; */
r_if
c_cond
(paren
id|host-&gt;dma.direction
op_eq
id|DMA_OUT
)paren
id|acornscsi_data_write
c_func
(paren
id|host
comma
id|host-&gt;scsi.SCp.ptr
comma
id|host-&gt;dma.start_addr
comma
id|length
)paren
suffix:semicolon
id|length
op_sub_assign
l_int|1
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTLO
comma
id|length
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTHI
comma
id|length
op_rshift
l_int|8
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRLO
comma
id|address
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRMD
comma
id|address
op_rshift
l_int|8
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRHI
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_OFF
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_DMA)
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;into&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|host-&gt;dma.xfer_setup
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
multiline_comment|/*&n;&t; * If the interface still wants more, then this is an error.&n;&t; * We give it another byte, but we also attempt to raise an&n;&t; * attention condition.  We continue giving one byte until&n;&t; * the device recognises the attention.&n;&t; */
r_if
c_cond
(paren
id|dmac_read
c_func
(paren
id|host-&gt;dma.io_port
comma
id|STATUS
)paren
op_amp
id|STATUS_RQ0
)paren
(brace
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTLO
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXCNTHI
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRLO
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRMD
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRHI
comma
l_int|0
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|MASKREG
comma
id|MASK_OFF
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Function: void acornscsi_dma_xfer(AS_Host *host)&n; * Purpose : transfer data between AcornSCSI and memory&n; * Params  : host - host to process&n; */
r_static
DECL|function|acornscsi_dma_xfer
r_void
id|acornscsi_dma_xfer
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|host-&gt;dma.xfer_required
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;dma.direction
op_eq
id|DMA_IN
)paren
id|acornscsi_data_read
c_func
(paren
id|host
comma
id|host-&gt;dma.xfer_ptr
comma
id|host-&gt;dma.xfer_start
comma
id|host-&gt;dma.xfer_length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: void acornscsi_dma_adjust(AS_Host *host)&n; * Purpose : adjust DMA pointers &amp; count for bytes transfered to&n; *&t;     SBIC but not SCSI bus.&n; * Params  : host - host to adjust DMA count for&n; */
r_static
DECL|function|acornscsi_dma_adjust
r_void
id|acornscsi_dma_adjust
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;dma.xfer_setup
)paren
(brace
r_int
r_int
id|transferred
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_DMA|DEBUG_WRITE))
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;adji&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Calculate correct DMA address - DMA is ahead of SCSI bus while&n;&t; * writing.&n;&t; *  host-&gt;scsi.SCp.scsi_xferred is the number of bytes&n;&t; *  actually transferred to/from the SCSI bus.&n;&t; *  host-&gt;dma.transferred is the number of bytes transferred&n;&t; *  over DMA since host-&gt;dma.start_addr was last set.&n;&t; *&n;&t; * real_dma_addr = host-&gt;dma.start_addr + host-&gt;scsi.SCp.scsi_xferred&n;&t; *&t;&t;   - host-&gt;dma.transferred&n;&t; */
id|transferred
op_assign
id|host-&gt;scsi.SCp.scsi_xferred
op_minus
id|host-&gt;dma.transferred
suffix:semicolon
r_if
c_cond
(paren
id|transferred
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: Ack! DMA write correction %ld &lt; 0!&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|transferred
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|transferred
op_eq
l_int|0
)paren
id|host-&gt;dma.xfer_setup
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|transferred
op_add_assign
id|host-&gt;dma.start_addr
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRLO
comma
id|transferred
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRMD
comma
id|transferred
op_rshift
l_int|8
)paren
suffix:semicolon
id|dmac_write
c_func
(paren
id|host-&gt;dma.io_port
comma
id|TXADRHI
comma
id|transferred
op_rshift
l_int|16
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_DMA|DEBUG_WRITE))
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|acornscsi_dumpdma
c_func
(paren
id|host
comma
l_string|&quot;adjo&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/* =========================================================================================&n; * Data I/O&n; */
r_static
r_int
DECL|function|acornscsi_write_pio
id|acornscsi_write_pio
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_char
op_star
id|bytes
comma
r_int
op_star
id|ptr
comma
r_int
id|len
comma
r_int
r_int
id|max_timeout
)paren
(brace
r_int
r_int
id|asr
comma
id|timeout
op_assign
id|max_timeout
suffix:semicolon
r_int
id|my_ptr
op_assign
op_star
id|ptr
suffix:semicolon
r_while
c_loop
(paren
id|my_ptr
OL
id|len
)paren
(brace
id|asr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|asr
op_amp
id|ASR_DBR
)paren
(brace
id|timeout
op_assign
id|max_timeout
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DATA
comma
id|bytes
(braket
id|my_ptr
op_increment
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|asr
op_amp
id|ASR_INT
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
op_star
id|ptr
op_assign
id|my_ptr
suffix:semicolon
r_return
(paren
id|timeout
op_eq
l_int|0
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: void acornscsi_sendcommand(AS_Host *host)&n; * Purpose : send a command to a target&n; * Params  : host - host which is connected to target&n; */
r_static
r_void
DECL|function|acornscsi_sendcommand
id|acornscsi_sendcommand
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|host-&gt;SCpnt
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|TRANSCNTH
comma
l_int|0
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
l_int|0
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SCpnt-&gt;cmd_len
op_minus
id|host-&gt;scsi.SCp.sent_command
)paren
suffix:semicolon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acornscsi_write_pio
c_func
(paren
id|host
comma
id|SCpnt-&gt;cmnd
comma
(paren
r_int
op_star
)paren
op_amp
id|host-&gt;scsi.SCp.sent_command
comma
id|SCpnt-&gt;cmd_len
comma
l_int|1000000
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: timeout while sending command&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_COMMAND
suffix:semicolon
)brace
r_static
DECL|function|acornscsi_sendmessage
r_void
id|acornscsi_sendmessage
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|message_length
op_assign
id|msgqueue_msglength
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
r_int
r_int
id|msgnr
suffix:semicolon
r_struct
id|message
op_star
id|msg
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_MESSAGES)
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: sending message &quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|message_length
)paren
(brace
r_case
l_int|0
suffix:colon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
op_or
id|CMND_SBT
)paren
suffix:semicolon
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_DBR
comma
id|ASR_DBR
comma
l_int|1000
comma
l_string|&quot;sending message 1&quot;
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DATA
comma
id|NOP
)paren
suffix:semicolon
id|host-&gt;scsi.last_message
op_assign
id|NOP
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_MESSAGES)
id|printk
c_func
(paren
l_string|&quot;NOP&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
op_or
id|CMND_SBT
)paren
suffix:semicolon
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|0
)paren
suffix:semicolon
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_DBR
comma
id|ASR_DBR
comma
l_int|1000
comma
l_string|&quot;sending message 2&quot;
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DATA
comma
id|msg-&gt;msg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|host-&gt;scsi.last_message
op_assign
id|msg-&gt;msg
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_MESSAGES)
id|print_msg
c_func
(paren
id|msg-&gt;msg
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t; * ANSI standard says: (SCSI-2 Rev 10c Sect 5.6.14)&n;&t; * &squot;When a target sends this (MESSAGE_REJECT) message, it&n;&t; *  shall change to MESSAGE IN phase and send this message&n;&t; *  prior to requesting additional message bytes from the&n;&t; *  initiator.  This provides an interlock so that the&n;&t; *  initiator can determine which message byte is rejected.&n;&t; */
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|TRANSCNTH
comma
l_int|0
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
l_int|0
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|message_length
)paren
suffix:semicolon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
)paren
suffix:semicolon
id|msgnr
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|msg
op_assign
id|msgqueue_getmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
id|msgnr
op_increment
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_MESSAGES)
id|print_msg
c_func
(paren
id|msg
)paren
suffix:semicolon
macro_line|#endif
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|acornscsi_write_pio
c_func
(paren
id|host
comma
id|msg-&gt;msg
comma
op_amp
id|i
comma
id|msg-&gt;length
comma
l_int|1000000
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: timeout while sending message&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|host-&gt;scsi.last_message
op_assign
id|msg-&gt;msg
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
id|host-&gt;scsi.last_message
op_or_assign
id|msg-&gt;msg
(braket
l_int|2
)braket
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|msg-&gt;length
)paren
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
macro_line|#if (DEBUG &amp; DEBUG_MESSAGES)
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Function: void acornscsi_readstatusbyte(AS_Host *host)&n; * Purpose : Read status byte from connected target&n; * Params  : host - host connected to target&n; */
r_static
DECL|function|acornscsi_readstatusbyte
r_void
id|acornscsi_readstatusbyte
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
op_or
id|CMND_SBT
)paren
suffix:semicolon
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_DBR
comma
id|ASR_DBR
comma
l_int|1000
comma
l_string|&quot;reading status byte&quot;
)paren
suffix:semicolon
id|host-&gt;scsi.SCp.Status
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DATA
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: unsigned char acornscsi_readmessagebyte(AS_Host *host)&n; * Purpose : Read one message byte from connected target&n; * Params  : host - host connected to target&n; */
r_static
DECL|function|acornscsi_readmessagebyte
r_int
r_char
id|acornscsi_readmessagebyte
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_char
id|message
suffix:semicolon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
op_or
id|CMND_SBT
)paren
suffix:semicolon
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_DBR
comma
id|ASR_DBR
comma
l_int|1000
comma
l_string|&quot;for message byte&quot;
)paren
suffix:semicolon
id|message
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DATA
)paren
suffix:semicolon
multiline_comment|/* wait for MSGIN-XFER-PAUSED */
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_INT
comma
id|ASR_INT
comma
l_int|1000
comma
l_string|&quot;for interrupt after message byte&quot;
)paren
suffix:semicolon
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
r_return
id|message
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: void acornscsi_message(AS_Host *host)&n; * Purpose : Read complete message from connected target &amp; action message&n; * Params  : host - host connected to target&n; */
r_static
DECL|function|acornscsi_message
r_void
id|acornscsi_message
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_char
id|message
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|msgidx
op_assign
l_int|0
comma
id|msglen
op_assign
l_int|1
suffix:semicolon
r_do
(brace
id|message
(braket
id|msgidx
)braket
op_assign
id|acornscsi_readmessagebyte
c_func
(paren
id|host
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|msgidx
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
op_logical_or
(paren
id|message
(braket
l_int|0
)braket
op_ge
l_int|0x20
op_logical_and
id|message
(braket
l_int|0
)braket
op_le
l_int|0x2f
)paren
)paren
id|msglen
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
id|msglen
op_add_assign
id|message
(braket
id|msgidx
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|msgidx
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|msgidx
OL
id|msglen
)paren
(brace
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_NEGATEACK
)paren
suffix:semicolon
multiline_comment|/* wait for next msg-in */
id|acornscsi_sbic_wait
c_func
(paren
id|host
comma
id|ASR_INT
comma
id|ASR_INT
comma
l_int|1000
comma
l_string|&quot;for interrupt after negate ack&quot;
)paren
suffix:semicolon
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|msgidx
OL
id|msglen
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_MESSAGES)
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: message in: &quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
id|print_msg
c_func
(paren
id|message
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|host-&gt;scsi.phase
op_eq
id|PHASE_RECONNECTED
)paren
(brace
multiline_comment|/*&n;&t; * ANSI standard says: (Section SCSI-2 Rev. 10c Sect 5.6.17)&n;&t; * &squot;Whenever a target reconnects to an initiator to continue&n;&t; *  a tagged I/O process, the SIMPLE QUEUE TAG message shall&n;&t; *  be sent immediately following the IDENTIFY message...&squot;&n;&t; */
r_if
c_cond
(paren
id|message
(braket
l_int|0
)braket
op_eq
id|SIMPLE_QUEUE_TAG
)paren
id|host-&gt;scsi.reconnected.tag
op_assign
id|message
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|acornscsi_reconnect_finish
c_func
(paren
id|host
)paren
)paren
id|host-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|message
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ABORT
suffix:colon
r_case
id|ABORT_TAG
suffix:colon
r_case
id|COMMAND_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|host-&gt;scsi.phase
op_ne
id|PHASE_STATUSIN
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: command complete following non-status in phase?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;target
)paren
suffix:semicolon
)brace
id|host-&gt;scsi.phase
op_assign
id|PHASE_DONE
suffix:semicolon
id|host-&gt;scsi.SCp.Message
op_assign
id|message
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
multiline_comment|/*&n;&t; * ANSI standard says: (Section SCSI-2 Rev. 10c Sect 5.6.20)&n;&t; * &squot;The SAVE DATA POINTER message is sent from a target to&n;&t; *  direct the initiator to copy the active data pointer to&n;&t; *  the saved data pointer for the current I/O process.&n;&t; */
id|acornscsi_dma_cleanup
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;SCpnt-&gt;SCp
op_assign
id|host-&gt;scsi.SCp
suffix:semicolon
id|host-&gt;SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESTORE_POINTERS
suffix:colon
multiline_comment|/*&n;&t; * ANSI standard says: (Section SCSI-2 Rev. 10c Sect 5.6.19)&n;&t; * &squot;The RESTORE POINTERS message is sent from a target to&n;&t; *  direct the initiator to copy the most recently saved&n;&t; *  command, data, and status pointers for the I/O process&n;&t; *  to the corresponding active pointers.  The command and&n;&t; *  status pointers shall be restored to the beginning of&n;&t; *  the present command and status areas.&squot;&n;&t; */
id|acornscsi_dma_cleanup
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.SCp
op_assign
id|host-&gt;SCpnt-&gt;SCp
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISCONNECT
suffix:colon
multiline_comment|/*&n;&t; * ANSI standard says: (Section SCSI-2 Rev. 10c Sect 6.4.2)&n;&t; * &squot;On those occasions when an error or exception condition occurs&n;&t; *  and the target elects to repeat the information transfer, the&n;&t; *  target may repeat the transfer either issuing a RESTORE POINTERS&n;&t; *  message or by disconnecting without issuing a SAVE POINTERS&n;&t; *  message.  When reconnection is completed, the most recent&n;&t; *  saved pointer values are restored.&squot;&n;&t; */
id|acornscsi_dma_cleanup
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
macro_line|#if 0 /* this isn&squot;t needed any more */
multiline_comment|/*&n;&t; * If we were negociating sync transfer, we don&squot;t yet know if&n;&t; * this REJECT is for the sync transfer or for the tagged queue/wide&n;&t; * transfer.  Re-initiate sync transfer negociation now, and if&n;&t; * we got a REJECT in response to SDTR, then it&squot;ll be set to DONE.&n;&t; */
r_if
c_cond
(paren
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_eq
id|SYNC_SENT_REQUEST
)paren
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_assign
id|SYNC_NEGOCIATE
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * If we have any messages waiting to go out, then assert ATN now&n;&t; */
r_if
c_cond
(paren
id|msgqueue_msglength
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
)paren
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_ASSERTATN
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|host-&gt;scsi.last_message
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
multiline_comment|/*&n;&t;     * ANSI standard says: (Section SCSI-2 Rev. 10c Sect 5.6.17)&n;&t;     *  If a target does not implement tagged queuing and a queue tag&n;&t;     *  message is received, it shall respond with a MESSAGE REJECT&n;&t;     *  message and accept the I/O process as if it were untagged.&n;&t;     */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d.%c: disabling tagged queueing&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
id|host-&gt;SCpnt-&gt;device-&gt;tagged_queue
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|host-&gt;SCpnt-&gt;target
op_star
l_int|8
op_plus
id|host-&gt;SCpnt-&gt;lun
comma
op_amp
id|host-&gt;busyluns
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|EXTENDED_MESSAGE
op_or
(paren
id|EXTENDED_SDTR
op_lshift
l_int|8
)paren
suffix:colon
multiline_comment|/*&n;&t;     * Target can&squot;t handle synchronous transfers&n;&t;     */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d.%c: Using asynchronous transfer&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_xfer
op_assign
id|SYNCHTRANSFER_2DBA
suffix:semicolon
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_assign
id|SYNC_ASYNCHRONOUS
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SYNCHTRANSFER
comma
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_xfer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|QUEUE_FULL
suffix:colon
multiline_comment|/* TODO: target queue is full */
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
multiline_comment|/* tag queue reconnect... message[1] = queue tag.  Print something to indicate something happened! */
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reconnect queue tag %02X&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|message
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_switch
c_cond
(paren
id|message
(braket
l_int|2
)braket
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_SYNC
r_case
id|EXTENDED_SDTR
suffix:colon
r_if
c_cond
(paren
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_eq
id|SYNC_SENT_REQUEST
)paren
(brace
multiline_comment|/*&n;&t;&t; * We requested synchronous transfers.  This isn&squot;t quite right...&n;&t;&t; * We can only say if this succeeded if we proceed on to execute the&n;&t;&t; * command from this message.  If we get a MESSAGE PARITY ERROR,&n;&t;&t; * and the target retries fail, then we fallback to asynchronous mode&n;&t;&t; */
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_assign
id|SYNC_COMPLETED
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d.%c: Using synchronous transfer, offset %d, %d ns&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|message
(braket
l_int|4
)braket
comma
id|message
(braket
l_int|3
)braket
op_star
l_int|4
)paren
suffix:semicolon
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_xfer
op_assign
id|calc_sync_xfer
c_func
(paren
id|message
(braket
l_int|3
)braket
op_star
l_int|4
comma
id|message
(braket
l_int|4
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|period
comma
id|length
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Target requested synchronous transfers.  The agreement is only&n;&t;&t; * to be in operation AFTER the target leaves message out phase.&n;&t;&t; */
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_ASSERTATN
)paren
suffix:semicolon
id|period
op_assign
id|max
c_func
(paren
id|message
(braket
l_int|3
)braket
comma
id|sdtr_period
op_div
l_int|4
)paren
suffix:semicolon
id|length
op_assign
id|min
c_func
(paren
id|message
(braket
l_int|4
)braket
comma
id|sdtr_size
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|5
comma
id|EXTENDED_MESSAGE
comma
l_int|3
comma
id|EXTENDED_SDTR
comma
id|period
comma
id|length
)paren
suffix:semicolon
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_xfer
op_assign
id|calc_sync_xfer
c_func
(paren
id|period
op_star
l_int|4
comma
id|length
)paren
suffix:semicolon
)brace
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SYNCHTRANSFER
comma
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_xfer
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
multiline_comment|/* We do not accept synchronous transfers.  Respond with a&n;&t;     * MESSAGE_REJECT.&n;&t;     */
macro_line|#endif
r_case
id|EXTENDED_WDTR
suffix:colon
multiline_comment|/* The WD33C93A is only 8-bit.  We respond with a MESSAGE_REJECT&n;&t;     * to a wide data transfer request.&n;&t;     */
r_default
suffix:colon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_ASSERTATN
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_LINK
r_case
id|LINKED_CMD_COMPLETE
suffix:colon
r_case
id|LINKED_FLG_CMD_COMPLETE
suffix:colon
multiline_comment|/*&n;&t; * We don&squot;t support linked commands yet&n;&t; */
r_if
c_cond
(paren
l_int|0
)paren
(brace
macro_line|#if (DEBUG &amp; DEBUG_LINK)
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: lun %d tag %d linked command complete&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;     * A linked command should only terminate with one of these messages&n;&t;     * if there are more linked commands available.&n;&t;     */
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;SCpnt-&gt;next_link
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d.%c: lun %d tag %d linked command complete, but no next_link&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_ASSERTATN
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
)brace
r_else
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|host-&gt;SCpnt
suffix:semicolon
id|acornscsi_dma_cleanup
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;SCpnt
op_assign
id|host-&gt;SCpnt-&gt;next_link
suffix:semicolon
id|host-&gt;SCpnt-&gt;tag
op_assign
id|SCpnt-&gt;tag
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_or
id|host-&gt;scsi.SCp.Message
op_lshift
l_int|8
op_or
id|host-&gt;Scsi.SCp.Status
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* initialise host-&gt;SCpnt-&gt;SCp */
)brace
r_break
suffix:semicolon
)brace
macro_line|#endif
r_default
suffix:colon
multiline_comment|/* reject message */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: unrecognised message %02X, rejecting&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|message
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_ASSERTATN
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|1
comma
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
r_break
suffix:semicolon
)brace
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_NEGATEACK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: int acornscsi_buildmessages(AS_Host *host)&n; * Purpose : build the connection messages for a host&n; * Params  : host - host to add messages to&n; */
r_static
DECL|function|acornscsi_buildmessages
r_void
id|acornscsi_buildmessages
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
macro_line|#if 0
multiline_comment|/* does the device need resetting? */
r_if
c_cond
(paren
id|cmd_reset
)paren
(brace
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|1
comma
id|BUS_DEVICE_RESET
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|1
comma
id|IDENTIFY
c_func
(paren
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|disconnect_ok
comma
id|host-&gt;SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* does the device need the current command aborted */
r_if
c_cond
(paren
id|cmd_aborted
)paren
(brace
id|acornscsi_abortcmd
c_func
(paren
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
r_if
c_cond
(paren
id|host-&gt;SCpnt-&gt;tag
)paren
(brace
r_int
r_int
id|tag_type
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
op_logical_or
id|host-&gt;SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
op_logical_or
id|host-&gt;SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
id|tag_type
op_assign
id|HEAD_OF_QUEUE_TAG
suffix:semicolon
r_else
id|tag_type
op_assign
id|SIMPLE_QUEUE_TAG
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|2
comma
id|tag_type
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_SYNC
r_if
c_cond
(paren
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_eq
id|SYNC_NEGOCIATE
)paren
(brace
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_state
op_assign
id|SYNC_SENT_REQUEST
suffix:semicolon
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|5
comma
id|EXTENDED_MESSAGE
comma
l_int|3
comma
id|EXTENDED_SDTR
comma
id|sdtr_period
op_div
l_int|4
comma
id|sdtr_size
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * Function: int acornscsi_starttransfer(AS_Host *host)&n; * Purpose : transfer data to/from connected target&n; * Params  : host - host to which target is connected&n; * Returns : 0 if failure&n; */
r_static
DECL|function|acornscsi_starttransfer
r_int
id|acornscsi_starttransfer
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
id|residual
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;scsi.SCp.ptr
multiline_comment|/*&amp;&amp; host-&gt;scsi.SCp.this_residual*/
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: null buffer passed to acornscsi_starttransfer&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|residual
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|host-&gt;scsi.SCp.scsi_xferred
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SYNCHTRANSFER
comma
id|host-&gt;device
(braket
id|host-&gt;SCpnt-&gt;target
)braket
dot
id|sync_xfer
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|residual
op_rshift
l_int|16
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|residual
op_rshift
l_int|8
)paren
suffix:semicolon
id|sbic_arm_writenext
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|residual
)paren
suffix:semicolon
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_XFERINFO
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* =========================================================================================&n; * Connection &amp; Disconnection&n; */
multiline_comment|/*&n; * Function : acornscsi_reconnect(AS_Host *host)&n; * Purpose  : reconnect a previously disconnected command&n; * Params   : host - host specific data&n; * Remarks  : SCSI spec says:&n; *&t;&t;&squot;The set of active pointers is restored from the set&n; *&t;&t; of saved pointers upon reconnection of the I/O process&squot;&n; */
r_static
DECL|function|acornscsi_reconnect
r_int
id|acornscsi_reconnect
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|target
comma
id|lun
comma
id|ok
op_assign
l_int|0
suffix:semicolon
id|target
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SOURCEID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|target
op_amp
l_int|8
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: invalid source id after reselection &quot;
l_string|&quot;- device fault?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|target
op_and_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;SCpnt
op_logical_and
op_logical_neg
id|host-&gt;scsi.disconnectable
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%d: reconnected while command in &quot;
l_string|&quot;progress to target %d?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|target
comma
id|host-&gt;SCpnt-&gt;target
)paren
suffix:semicolon
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
id|lun
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|DATA
)paren
op_amp
l_int|7
suffix:semicolon
id|host-&gt;scsi.reconnected.target
op_assign
id|target
suffix:semicolon
id|host-&gt;scsi.reconnected.lun
op_assign
id|lun
suffix:semicolon
id|host-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;scsi.disconnectable
op_logical_and
id|host-&gt;SCpnt
op_logical_and
id|host-&gt;SCpnt-&gt;target
op_eq
id|target
op_logical_and
id|host-&gt;SCpnt-&gt;lun
op_eq
id|lun
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
op_logical_and
id|queue_probetgtlun
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
comma
id|target
comma
id|lun
)paren
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
id|ADD_STATUS
c_func
(paren
id|target
comma
l_int|0x81
comma
id|host-&gt;scsi.phase
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
)paren
(brace
id|host-&gt;scsi.phase
op_assign
id|PHASE_RECONNECTED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* this doesn&squot;t seem to work */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: reselected with no command &quot;
l_string|&quot;to reconnect with&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|target
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|target
)paren
suffix:semicolon
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;SCpnt
)paren
(brace
id|queue_add_cmd_tail
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
comma
id|host-&gt;SCpnt
)paren
suffix:semicolon
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|acornscsi_sbic_issuecmd
c_func
(paren
id|host
comma
id|CMND_NEGATEACK
)paren
suffix:semicolon
r_return
op_logical_neg
id|ok
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: int acornscsi_reconect_finish(AS_Host *host)&n; * Purpose : finish reconnecting a command&n; * Params  : host - host to complete&n; * Returns : 0 if failed&n; */
r_static
DECL|function|acornscsi_reconnect_finish
r_int
id|acornscsi_reconnect_finish
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;scsi.disconnectable
op_logical_and
id|host-&gt;SCpnt
)paren
(brace
id|host-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;SCpnt-&gt;target
op_eq
id|host-&gt;scsi.reconnected.target
op_logical_and
id|host-&gt;SCpnt-&gt;lun
op_eq
id|host-&gt;scsi.reconnected.lun
op_logical_and
id|host-&gt;SCpnt-&gt;tag
op_eq
id|host-&gt;scsi.reconnected.tag
)paren
(brace
macro_line|#if (DEBUG &amp; (DEBUG_QUEUES|DEBUG_DISCON))
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: reconnected&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|queue_add_cmd_tail
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
comma
id|host-&gt;SCpnt
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_QUEUES|DEBUG_DISCON))
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: had to move command &quot;
l_string|&quot;to disconnected queue&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;SCpnt
)paren
(brace
id|host-&gt;SCpnt
op_assign
id|queue_remove_tgtluntag
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
comma
id|host-&gt;scsi.reconnected.target
comma
id|host-&gt;scsi.reconnected.lun
comma
id|host-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_QUEUES|DEBUG_DISCON))
id|DBG
c_func
(paren
id|host-&gt;SCpnt
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: had to get command&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;SCpnt
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;scsi.reconnected.tag
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t; * Restore data pointer from SAVED pointers.&n;&t; */
id|host-&gt;scsi.SCp
op_assign
id|host-&gt;SCpnt-&gt;SCp
suffix:semicolon
macro_line|#if (DEBUG &amp; (DEBUG_QUEUES|DEBUG_DISCON))
id|printk
c_func
(paren
l_string|&quot;, data pointers: [%p, %X]&quot;
comma
id|host-&gt;scsi.SCp.ptr
comma
id|host-&gt;scsi.SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if (DEBUG &amp; (DEBUG_QUEUES|DEBUG_DISCON))
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|host-&gt;dma.transferred
op_assign
id|host-&gt;scsi.SCp.scsi_xferred
suffix:semicolon
r_return
id|host-&gt;SCpnt
op_ne
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: void acornscsi_disconnect_unexpected(AS_Host *host)&n; * Purpose : handle an unexpected disconnect&n; * Params  : host - host on which disconnect occurred&n; */
r_static
DECL|function|acornscsi_disconnect_unexpected
r_void
id|acornscsi_disconnect_unexpected
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: unexpected disconnect&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_ABORT)
id|acornscsi_dumplog
c_func
(paren
id|host
comma
l_int|8
)paren
suffix:semicolon
macro_line|#endif
id|acornscsi_done
c_func
(paren
id|host
comma
op_amp
id|host-&gt;SCpnt
comma
id|DID_ERROR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: void acornscsi_abortcmd(AS_host *host, unsigned char tag)&n; * Purpose : abort a currently executing command&n; * Params  : host - host with connected command to abort&n; *&t;     tag  - tag to abort&n; */
r_static
DECL|function|acornscsi_abortcmd
r_void
id|acornscsi_abortcmd
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
r_char
id|tag
)paren
(brace
id|host-&gt;scsi.phase
op_assign
id|PHASE_ABORTED
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CMND
comma
id|CMND_ASSERTATN
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
r_if
c_cond
(paren
id|tag
)paren
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|2
comma
id|ABORT_TAG
comma
id|tag
)paren
suffix:semicolon
r_else
macro_line|#endif
id|msgqueue_addmsg
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
comma
l_int|1
comma
id|ABORT
)paren
suffix:semicolon
)brace
multiline_comment|/* ==========================================================================================&n; * Interrupt routines.&n; */
multiline_comment|/*&n; * Function: int acornscsi_sbicintr(AS_Host *host)&n; * Purpose : handle interrupts from SCSI device&n; * Params  : host - host to process&n; * Returns : INTR_PROCESS if expecting another SBIC interrupt&n; *&t;     INTR_IDLE if no interrupt&n; *&t;     INTR_NEXT_COMMAND if we have finished processing the command&n; */
r_static
DECL|function|acornscsi_sbicintr
id|intr_ret_t
id|acornscsi_sbicintr
c_func
(paren
id|AS_Host
op_star
id|host
comma
r_int
id|in_irq
)paren
(brace
r_int
r_int
id|asr
comma
id|ssr
suffix:semicolon
id|asr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|asr
op_amp
id|ASR_INT
)paren
)paren
r_return
id|INTR_IDLE
suffix:semicolon
id|ssr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_PHASES)
id|print_sbic_status
c_func
(paren
id|asr
comma
id|ssr
comma
id|host-&gt;scsi.phase
)paren
suffix:semicolon
macro_line|#endif
id|ADD_STATUS
c_func
(paren
l_int|8
comma
id|ssr
comma
id|host-&gt;scsi.phase
comma
id|in_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;SCpnt
op_logical_and
op_logical_neg
id|host-&gt;scsi.disconnectable
)paren
id|ADD_STATUS
c_func
(paren
id|host-&gt;SCpnt-&gt;target
comma
id|ssr
comma
id|host-&gt;scsi.phase
comma
id|in_irq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* reset state - not advanced&t;&t;&t;*/
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: reset in standard mode but wanted advanced mode.&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* setup sbic - WD33C93A */
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|OWNID
comma
id|OWNID_EAF
op_or
id|host-&gt;host-&gt;this_id
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CMND
comma
id|CMND_RESET
)paren
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* reset state - advanced&t;&t;&t;*/
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CTRL
comma
id|INIT_SBICDMA
op_or
id|CTRL_IDI
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|TIMEOUT
comma
id|TIMEOUT_TIME
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SYNCHTRANSFER
comma
id|SYNCHTRANSFER_2DBA
)paren
suffix:semicolon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SOURCEID
comma
id|SOURCEID_ER
op_or
id|SOURCEID_DSP
)paren
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x41
suffix:colon
multiline_comment|/* unexpected disconnect aborted command&t;*/
id|acornscsi_disconnect_unexpected
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
id|INTR_NEXT_COMMAND
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|host-&gt;scsi.phase
)paren
(brace
r_case
id|PHASE_CONNECTING
suffix:colon
multiline_comment|/* STATE: command removed from issue queue&t;*/
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x11
suffix:colon
multiline_comment|/* -&gt; PHASE_CONNECTED&t;&t;&t;&t;*/
multiline_comment|/* BUS FREE -&gt; SELECTION */
id|host-&gt;scsi.phase
op_assign
id|PHASE_CONNECTED
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
id|host-&gt;dma.transferred
op_assign
id|host-&gt;scsi.SCp.scsi_xferred
suffix:semicolon
multiline_comment|/* 33C93 gives next interrupt indicating bus phase */
id|asr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|asr
op_amp
id|ASR_INT
)paren
)paren
r_break
suffix:semicolon
id|ssr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
id|ADD_STATUS
c_func
(paren
l_int|8
comma
id|ssr
comma
id|host-&gt;scsi.phase
comma
l_int|1
)paren
suffix:semicolon
id|ADD_STATUS
c_func
(paren
id|host-&gt;SCpnt-&gt;target
comma
id|ssr
comma
id|host-&gt;scsi.phase
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|connected
suffix:semicolon
r_case
l_int|0x42
suffix:colon
multiline_comment|/* select timed out&t;&t;&t;&t;*/
multiline_comment|/* -&gt; PHASE_IDLE&t;&t;&t;&t;*/
id|acornscsi_done
c_func
(paren
id|host
comma
op_amp
id|host-&gt;SCpnt
comma
id|DID_NO_CONNECT
)paren
suffix:semicolon
r_return
id|INTR_NEXT_COMMAND
suffix:semicolon
r_case
l_int|0x81
suffix:colon
multiline_comment|/* -&gt; PHASE_RECONNECTED or PHASE_ABORTED&t;*/
multiline_comment|/* BUS FREE -&gt; RESELECTION */
id|host-&gt;origSCpnt
op_assign
id|host-&gt;SCpnt
suffix:semicolon
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|msgqueue_flush
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
id|acornscsi_reconnect
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_CONNECTING, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
id|connected
suffix:colon
r_case
id|PHASE_CONNECTED
suffix:colon
multiline_comment|/* STATE: device selected ok&t;&t;&t;*/
r_switch
c_cond
(paren
id|ssr
)paren
(brace
macro_line|#ifdef NONSTANDARD
r_case
l_int|0x8a
suffix:colon
multiline_comment|/* -&gt; PHASE_COMMAND, PHASE_COMMANDPAUSED&t;*/
multiline_comment|/* SELECTION -&gt; COMMAND */
id|acornscsi_sendcommand
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUS&t;&t;&t;&t;*/
multiline_comment|/* SELECTION -&gt; STATUS */
id|acornscsi_readstatusbyte
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_STATUSIN
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* SELECTION -&gt;MESSAGE OUT */
id|host-&gt;scsi.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
id|acornscsi_buildmessages
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* these should not happen */
r_case
l_int|0x85
suffix:colon
multiline_comment|/* target disconnected&t;&t;&t;&t;*/
id|acornscsi_done
c_func
(paren
id|host
comma
op_amp
id|host-&gt;SCpnt
comma
id|DID_ERROR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_CONNECTED, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_MSGOUT
suffix:colon
multiline_comment|/* STATE: connected &amp; sent IDENTIFY message&t;*/
multiline_comment|/*&n;&t; * SCSI standard says that MESSAGE OUT phases can be followed by a&n;&t; * DATA phase, STATUS phase, MESSAGE IN phase or COMMAND phase&n;&t; */
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x8a
suffix:colon
multiline_comment|/* -&gt; PHASE_COMMAND, PHASE_COMMANDPAUSED&t;*/
r_case
l_int|0x1a
suffix:colon
multiline_comment|/* -&gt; PHASE_COMMAND, PHASE_COMMANDPAUSED&t;*/
multiline_comment|/* MESSAGE OUT -&gt; COMMAND */
id|acornscsi_sendcommand
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUS&t;&t;&t;&t;*/
r_case
l_int|0x1b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUS&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE OUT -&gt; STATUS */
id|acornscsi_readstatusbyte
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_STATUSIN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE_OUT(MESSAGE_IN) -&gt;MESSAGE OUT */
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4f
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DISCONNECT&t;&t;*/
r_case
l_int|0x1f
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DISCONNECT&t;&t;*/
multiline_comment|/* MESSAGE OUT -&gt; MESSAGE IN */
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_MSGOUT, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_COMMAND
suffix:colon
multiline_comment|/* STATE: connected &amp; command sent&t;&t;*/
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x18
suffix:colon
multiline_comment|/* -&gt; PHASE_DATAOUT&t;&t;&t;&t;*/
multiline_comment|/* COMMAND -&gt; DATA OUT */
r_if
c_cond
(paren
id|host-&gt;scsi.SCp.sent_command
op_ne
id|host-&gt;SCpnt-&gt;cmd_len
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|acornscsi_dma_setup
c_func
(paren
id|host
comma
id|DMA_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acornscsi_starttransfer
c_func
(paren
id|host
)paren
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_DATAOUT
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x19
suffix:colon
multiline_comment|/* -&gt; PHASE_DATAIN&t;&t;&t;&t;*/
multiline_comment|/* COMMAND -&gt; DATA IN */
r_if
c_cond
(paren
id|host-&gt;scsi.SCp.sent_command
op_ne
id|host-&gt;SCpnt-&gt;cmd_len
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|acornscsi_dma_setup
c_func
(paren
id|host
comma
id|DMA_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acornscsi_starttransfer
c_func
(paren
id|host
)paren
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_DATAIN
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x1b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUS&t;&t;&t;&t;*/
multiline_comment|/* COMMAND -&gt; STATUS */
id|acornscsi_readstatusbyte
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_STATUSIN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* COMMAND -&gt; MESSAGE OUT */
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1f
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DISCONNECT&t;&t;*/
multiline_comment|/* COMMAND -&gt; MESSAGE IN */
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_COMMAND, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_DISCONNECT
suffix:colon
multiline_comment|/* STATE: connected, received DISCONNECT msg&t;*/
r_if
c_cond
(paren
id|ssr
op_eq
l_int|0x85
)paren
(brace
multiline_comment|/* -&gt; PHASE_IDLE&t;&t;&t;&t;*/
id|host-&gt;scsi.disconnectable
op_assign
l_int|1
suffix:semicolon
id|host-&gt;scsi.reconnected.tag
op_assign
l_int|0
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
id|host-&gt;stats.disconnects
op_add_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_DISCONNECT, SSR %02X instead of disconnect?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_NEXT_COMMAND
suffix:semicolon
r_case
id|PHASE_IDLE
suffix:colon
multiline_comment|/* STATE: disconnected&t;&t;&t;&t;*/
r_if
c_cond
(paren
id|ssr
op_eq
l_int|0x81
)paren
multiline_comment|/* -&gt; PHASE_RECONNECTED or PHASE_ABORTED&t;*/
id|acornscsi_reconnect
c_func
(paren
id|host
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_IDLE, SSR %02X while idle?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_RECONNECTED
suffix:colon
multiline_comment|/* STATE: device reconnected to initiator&t;*/
multiline_comment|/*&n;&t; * Command reconnected - if MESGIN, get message - it may be&n;&t; * the tag.  If not, get command out of disconnected queue&n;&t; */
multiline_comment|/*&n;&t; * If we reconnected and we&squot;re not in MESSAGE IN phase after IDENTIFY,&n;&t; * reconnect I_T_L command&n;&t; */
r_if
c_cond
(paren
id|ssr
op_ne
l_int|0x8f
op_logical_and
op_logical_neg
id|acornscsi_reconnect_finish
c_func
(paren
id|host
)paren
)paren
r_return
id|INTR_IDLE
suffix:semicolon
id|ADD_STATUS
c_func
(paren
id|host-&gt;SCpnt-&gt;target
comma
id|ssr
comma
id|host-&gt;scsi.phase
comma
id|in_irq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x88
suffix:colon
multiline_comment|/* data out phase&t;&t;&t;&t;*/
multiline_comment|/* -&gt; PHASE_DATAOUT&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE IN -&gt; DATA OUT */
id|acornscsi_dma_setup
c_func
(paren
id|host
comma
id|DMA_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acornscsi_starttransfer
c_func
(paren
id|host
)paren
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_DATAOUT
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x89
suffix:colon
multiline_comment|/* data in phase&t;&t;&t;&t;*/
multiline_comment|/* -&gt; PHASE_DATAIN&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE IN -&gt; DATA IN */
id|acornscsi_dma_setup
c_func
(paren
id|host
comma
id|DMA_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acornscsi_starttransfer
c_func
(paren
id|host
)paren
)paren
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_DATAIN
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x8a
suffix:colon
multiline_comment|/* command out&t;&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE IN -&gt; COMMAND */
id|acornscsi_sendcommand
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* -&gt; PHASE_COMMAND, PHASE_COMMANDPAUSED&t;*/
r_break
suffix:semicolon
r_case
l_int|0x8b
suffix:colon
multiline_comment|/* status in&t;&t;&t;&t;&t;*/
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE IN -&gt; STATUS */
id|acornscsi_readstatusbyte
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_STATUSIN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* message out&t;&t;&t;&t;&t;*/
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE IN -&gt; MESSAGE OUT */
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DISCONNECT&t;&t;*/
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_RECONNECTED, SSR %02X after reconnect?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_DATAIN
suffix:colon
multiline_comment|/* STATE: transferred data in&t;&t;&t;*/
multiline_comment|/*&n;&t; * This is simple - if we disconnect then the DMA address &amp; count is&n;&t; * correct.&n;&t; */
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x19
suffix:colon
multiline_comment|/* -&gt; PHASE_DATAIN&t;&t;&t;&t;*/
r_case
l_int|0x89
suffix:colon
multiline_comment|/* -&gt; PHASE_DATAIN&t;&t;&t;&t;*/
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x1b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
r_case
l_int|0x4b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
r_case
l_int|0x8b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
multiline_comment|/* DATA IN -&gt; STATUS */
id|host-&gt;scsi.SCp.scsi_xferred
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|acornscsi_sbic_xfcount
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_readstatusbyte
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_STATUSIN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x4e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* DATA IN -&gt; MESSAGE OUT */
id|host-&gt;scsi.SCp.scsi_xferred
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|acornscsi_sbic_xfcount
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
r_case
l_int|0x4f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
r_case
l_int|0x8f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
multiline_comment|/* DATA IN -&gt; MESSAGE IN */
id|host-&gt;scsi.SCp.scsi_xferred
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|acornscsi_sbic_xfcount
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DISCONNECT&t;&t;*/
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_DATAIN, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_DATAOUT
suffix:colon
multiline_comment|/* STATE: transferred data out&t;&t;&t;*/
multiline_comment|/*&n;&t; * This is more complicated - if we disconnect, the DMA could be 12&n;&t; * bytes ahead of us.  We need to correct this.&n;&t; */
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x18
suffix:colon
multiline_comment|/* -&gt; PHASE_DATAOUT&t;&t;&t;&t;*/
r_case
l_int|0x88
suffix:colon
multiline_comment|/* -&gt; PHASE_DATAOUT&t;&t;&t;&t;*/
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
r_return
id|INTR_IDLE
suffix:semicolon
r_case
l_int|0x1b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
r_case
l_int|0x4b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
r_case
l_int|0x8b
suffix:colon
multiline_comment|/* -&gt; PHASE_STATUSIN&t;&t;&t;&t;*/
multiline_comment|/* DATA OUT -&gt; STATUS */
id|host-&gt;scsi.SCp.scsi_xferred
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|acornscsi_sbic_xfcount
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_adjust
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_readstatusbyte
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_STATUSIN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x4e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* DATA OUT -&gt; MESSAGE OUT */
id|host-&gt;scsi.SCp.scsi_xferred
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|acornscsi_sbic_xfcount
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_adjust
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
r_case
l_int|0x4f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
r_case
l_int|0x8f
suffix:colon
multiline_comment|/* message in&t;&t;&t;&t;&t;*/
multiline_comment|/* DATA OUT -&gt; MESSAGE IN */
id|host-&gt;scsi.SCp.scsi_xferred
op_assign
id|host-&gt;SCpnt-&gt;request_bufflen
op_minus
id|acornscsi_sbic_xfcount
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_dma_adjust
c_func
(paren
id|host
)paren
suffix:semicolon
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DISCONNECT&t;&t;*/
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_DATAOUT, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_STATUSIN
suffix:colon
multiline_comment|/* STATE: status in complete&t;&t;&t;*/
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x1f
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DONE, PHASE_DISCONNECT */
r_case
l_int|0x8f
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DONE, PHASE_DISCONNECT */
multiline_comment|/* STATUS -&gt; MESSAGE IN */
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* STATUS -&gt; MESSAGE OUT */
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_STATUSIN, SSR %02X instead of MESSAGE_IN?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_MSGIN
suffix:colon
multiline_comment|/* STATE: message in&t;&t;&t;&t;*/
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x1e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x4e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
r_case
l_int|0x8e
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGOUT&t;&t;&t;&t;*/
multiline_comment|/* MESSAGE IN -&gt; MESSAGE OUT */
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1f
suffix:colon
multiline_comment|/* -&gt; PHASE_MSGIN, PHASE_DONE, PHASE_DISCONNECT */
r_case
l_int|0x2f
suffix:colon
r_case
l_int|0x4f
suffix:colon
r_case
l_int|0x8f
suffix:colon
id|acornscsi_message
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x85
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d.%c: strange message in disconnection&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
id|acornscsi_done
c_func
(paren
id|host
comma
op_amp
id|host-&gt;SCpnt
comma
id|DID_ERROR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_MSGIN, SSR %02X after message in?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_DONE
suffix:colon
multiline_comment|/* STATE: received status &amp; message&t;&t;*/
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x85
suffix:colon
multiline_comment|/* -&gt; PHASE_IDLE&t;&t;&t;&t;*/
id|acornscsi_done
c_func
(paren
id|host
comma
op_amp
id|host-&gt;SCpnt
comma
id|DID_OK
)paren
suffix:semicolon
r_return
id|INTR_NEXT_COMMAND
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
r_case
l_int|0x8e
suffix:colon
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_DONE, SSR %02X instead of disconnect?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_case
id|PHASE_ABORTED
suffix:colon
r_switch
c_cond
(paren
id|ssr
)paren
(brace
r_case
l_int|0x85
suffix:colon
r_if
c_cond
(paren
id|host-&gt;SCpnt
)paren
id|acornscsi_done
c_func
(paren
id|host
comma
op_amp
id|host-&gt;SCpnt
comma
id|DID_ABORT
)paren
suffix:semicolon
r_else
(brace
id|clear_bit
c_func
(paren
id|host-&gt;scsi.reconnected.target
op_star
l_int|8
op_plus
id|host-&gt;scsi.reconnected.lun
comma
id|host-&gt;busyluns
)paren
suffix:semicolon
id|host-&gt;scsi.phase
op_assign
id|PHASE_IDLE
suffix:semicolon
)brace
r_return
id|INTR_NEXT_COMMAND
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
r_case
l_int|0x2e
suffix:colon
r_case
l_int|0x4e
suffix:colon
r_case
l_int|0x8e
suffix:colon
id|acornscsi_sendmessage
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: PHASE_ABORTED, SSR %02X?&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d.%c: unknown driver phase %d&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
comma
id|acornscsi_target
c_func
(paren
id|host
)paren
comma
id|ssr
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|host-&gt;SCpnt
ques
c_cond
id|host-&gt;SCpnt-&gt;target
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|INTR_PROCESSING
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: void acornscsi_intr(int irq, void *dev_id, struct pt_regs *regs)&n; * Purpose  : handle interrupts from Acorn SCSI card&n; * Params   : irq    - interrupt number&n; *&t;      dev_id - device specific data (AS_Host structure)&n; *&t;      regs   - processor registers when interrupt occurred&n; */
r_static
DECL|function|acornscsi_intr
r_void
id|acornscsi_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|AS_Host
op_star
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|dev_id
suffix:semicolon
id|intr_ret_t
id|ret
suffix:semicolon
r_int
id|iostatus
suffix:semicolon
r_int
id|in_irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;scsi.interrupt
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: interrupt re-entered&bslash;n&quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|host-&gt;scsi.interrupt
op_assign
l_int|1
suffix:semicolon
r_do
(brace
id|ret
op_assign
id|INTR_IDLE
suffix:semicolon
id|iostatus
op_assign
id|inb
c_func
(paren
id|host-&gt;card.io_intr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iostatus
op_amp
l_int|2
)paren
(brace
id|acornscsi_dma_intr
c_func
(paren
id|host
)paren
suffix:semicolon
id|iostatus
op_assign
id|inb
c_func
(paren
id|host-&gt;card.io_intr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iostatus
op_amp
l_int|8
)paren
id|ret
op_assign
id|acornscsi_sbicintr
c_func
(paren
id|host
comma
id|in_irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we have a transfer pending, start it.&n;&t; * Only start it if the interface has already started transferring&n;&t; * it&squot;s data&n;&t; */
r_if
c_cond
(paren
id|host-&gt;dma.xfer_required
)paren
id|acornscsi_dma_xfer
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|INTR_NEXT_COMMAND
)paren
id|ret
op_assign
id|acornscsi_kick
c_func
(paren
id|host
)paren
suffix:semicolon
id|in_irq
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_ne
id|INTR_IDLE
)paren
suffix:semicolon
id|host-&gt;scsi.interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=============================================================================================&n; * Interfaces between interrupt handler and rest of scsi code&n; */
multiline_comment|/*&n; * Function : acornscsi_queuecmd(Scsi_Cmnd *cmd, void (*done)(Scsi_Cmnd *))&n; * Purpose  : queues a SCSI command&n; * Params   : cmd  - SCSI command&n; *&t;      done - function called on completion, with pointer to command descriptor&n; * Returns  : 0, or &lt; 0 on error.&n; */
DECL|function|acornscsi_queuecmd
r_int
id|acornscsi_queuecmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|AS_Host
op_star
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
multiline_comment|/* there should be some way of rejecting errors like this without panicing... */
id|panic
c_func
(paren
l_string|&quot;scsi%d: queuecommand called with NULL done function [cmd=%p]&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
comma
id|SCpnt
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if (DEBUG &amp; DEBUG_NO_WRITE)
r_if
c_cond
(paren
id|acornscsi_cmdtype
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
op_eq
id|CMD_WRITE
op_logical_and
(paren
id|NO_WRITE
op_amp
(paren
l_int|1
op_lshift
id|SCpnt-&gt;target
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;scsi%d.%c: WRITE attempted with NO_WRITE flag set&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
comma
l_char|&squot;0&squot;
op_plus
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;tag
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.phase
op_assign
(paren
r_int
)paren
id|acornscsi_datadirection
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.scsi_xferred
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
)brace
id|host-&gt;stats.queues
op_add_assign
l_int|1
suffix:semicolon
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_add_cmd_ordered
c_func
(paren
op_amp
id|host-&gt;queues.issue
comma
id|SCpnt
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;scsi.phase
op_eq
id|PHASE_IDLE
)paren
id|acornscsi_kick
c_func
(paren
id|host
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: void acornscsi_reportstatus(Scsi_Cmnd **SCpntp1, Scsi_Cmnd **SCpntp2, int result)&n; * Purpose  : pass a result to *SCpntp1, and check if *SCpntp1 = *SCpntp2&n; * Params   : SCpntp1 - pointer to command to return&n; *&t;      SCpntp2 - pointer to command to check&n; *&t;      result  - result to pass back to mid-level done function&n; * Returns  : *SCpntp2 = NULL if *SCpntp1 is the same command structure as *SCpntp2.&n; */
r_static
r_inline
DECL|function|acornscsi_reportstatus
r_void
id|acornscsi_reportstatus
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SCpntp1
comma
id|Scsi_Cmnd
op_star
op_star
id|SCpntp2
comma
r_int
id|result
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
op_star
id|SCpntp1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
op_star
id|SCpntp1
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCpnt
op_eq
op_star
id|SCpntp2
)paren
op_star
id|SCpntp2
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|enum|res_abort
DECL|enumerator|res_not_running
DECL|enumerator|res_success
DECL|enumerator|res_success_clear
DECL|enumerator|res_snooze
r_enum
id|res_abort
(brace
id|res_not_running
comma
id|res_success
comma
id|res_success_clear
comma
id|res_snooze
)brace
suffix:semicolon
multiline_comment|/*&n; * Prototype: enum res acornscsi_do_abort(Scsi_Cmnd *SCpnt)&n; * Purpose  : abort a command on this host&n; * Params   : SCpnt - command to abort&n; * Returns  : our abort status&n; */
r_static
r_enum
id|res_abort
DECL|function|acornscsi_do_abort
id|acornscsi_do_abort
c_func
(paren
id|AS_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_enum
id|res_abort
id|res
op_assign
id|res_not_running
suffix:semicolon
r_if
c_cond
(paren
id|queue_remove_cmd
c_func
(paren
op_amp
id|host-&gt;queues.issue
comma
id|SCpnt
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The command was on the issue queue, and has not been&n;&t;&t; * issued yet.  We can remove the command from the queue,&n;&t;&t; * and acknowledge the abort.  Neither the devices nor the&n;&t;&t; * interface know about the command.&n;&t;&t; */
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;on issue queue &quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|res
op_assign
id|res_success
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|queue_remove_cmd
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
comma
id|SCpnt
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The command was on the disconnected queue.  Simply&n;&t;&t; * acknowledge the abort condition, and when the target&n;&t;&t; * reconnects, we will give it an ABORT message.  The&n;&t;&t; * target should then disconnect, and we will clear&n;&t;&t; * the busylun bit.&n;&t;&t; */
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;on disconnected queue &quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|res
op_assign
id|res_success
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|host-&gt;SCpnt
op_eq
id|SCpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;executing &quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|host-&gt;scsi.phase
)paren
(brace
multiline_comment|/*&n;&t;&t; * If the interface is idle, and the command is &squot;disconnectable&squot;,&n;&t;&t; * then it is the same as on the disconnected queue.  We simply&n;&t;&t; * remove all traces of the command.  When the target reconnects,&n;&t;&t; * we will give it an ABORT message since the command could not&n;&t;&t; * be found.  When the target finally disconnects, we will clear&n;&t;&t; * the busylun bit.&n;&t;&t; */
r_case
id|PHASE_IDLE
suffix:colon
r_if
c_cond
(paren
id|host-&gt;scsi.disconnectable
)paren
(brace
id|host-&gt;scsi.disconnectable
op_assign
l_int|0
suffix:semicolon
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|res_success
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If the command has connected and done nothing further,&n;&t;&t; * simply force a disconnect.  We also need to clear the&n;&t;&t; * busylun bit.&n;&t;&t; */
r_case
id|PHASE_CONNECTED
suffix:colon
id|sbic_arm_write
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|CMND
comma
id|CMND_DISCONNECT
)paren
suffix:semicolon
id|host-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|res_success_clear
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|acornscsi_abortcmd
c_func
(paren
id|host
comma
id|host-&gt;SCpnt-&gt;tag
)paren
suffix:semicolon
id|res
op_assign
id|res_snooze
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|host-&gt;origSCpnt
op_eq
id|SCpnt
)paren
(brace
multiline_comment|/*&n;&t;&t; * The command will be executed next, but a command&n;&t;&t; * is currently using the interface.  This is similar to&n;&t;&t; * being on the issue queue, except the busylun bit has&n;&t;&t; * been set.&n;&t;&t; */
id|host-&gt;origSCpnt
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;waiting for execution &quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|res
op_assign
id|res_success_clear
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;unknown &quot;
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: int acornscsi_abort(Scsi_Cmnd *SCpnt)&n; * Purpose  : abort a command on this host&n; * Params   : SCpnt - command to abort&n; * Returns  : one of SCSI_ABORT_ macros&n; */
DECL|function|acornscsi_abort
r_int
id|acornscsi_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|AS_Host
op_star
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|result
suffix:semicolon
id|host-&gt;stats.aborts
op_add_assign
l_int|1
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_ABORT)
(brace
r_int
id|asr
comma
id|ssr
suffix:semicolon
id|asr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
id|ssr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;acornscsi_abort: &quot;
)paren
suffix:semicolon
id|print_sbic_status
c_func
(paren
id|asr
comma
id|ssr
comma
id|host-&gt;scsi.phase
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;scsi%d: &quot;
comma
id|host-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|acornscsi_do_abort
c_func
(paren
id|host
comma
id|SCpnt
)paren
)paren
(brace
multiline_comment|/*&n;&t; * We managed to find the command and cleared it out.&n;&t; * We do not expect the command to be executing on the&n;&t; * target, but we have set the busylun bit.&n;&t; */
r_case
id|res_success_clear
suffix:colon
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;clear &quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|clear_bit
c_func
(paren
id|SCpnt-&gt;target
op_star
l_int|8
op_plus
id|SCpnt-&gt;lun
comma
id|host-&gt;busyluns
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We found the command, and cleared it out.  Either&n;&t; * the command is still known to be executing on the&n;&t; * target, or the busylun bit is not set.&n;&t; */
r_case
id|res_success
suffix:colon
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;success&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|SCpnt-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|result
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * We did find the command, but unfortunately we couldn&squot;t&n;&t; * unhook it from ourselves.  Wait some more, and if it&n;&t; * still doesn&squot;t complete, reset the interface.&n;&t; */
r_case
id|res_snooze
suffix:colon
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;snooze&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//#endif
id|result
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * The command could not be found (either because it completed,&n;&t; * or it got dropped.&n;&t; */
r_default
suffix:colon
r_case
id|res_not_running
suffix:colon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_ABORT)
id|result
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
macro_line|#else
id|result
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
macro_line|#endif
singleline_comment|//#if (DEBUG &amp; DEBUG_ABORT)
id|printk
c_func
(paren
l_string|&quot;not running&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//#endif
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Prototype: int acornscsi_reset(Scsi_Cmnd *SCpnt, unsigned int reset_flags)&n; * Purpose  : reset a command on this host/reset this host&n; * Params   : SCpnt  - command causing reset&n; *&t;      result - what type of reset to perform&n; * Returns  : one of SCSI_RESET_ macros&n; */
DECL|function|acornscsi_reset
r_int
id|acornscsi_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|AS_Host
op_star
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCptr
suffix:semicolon
id|host-&gt;stats.resets
op_add_assign
l_int|1
suffix:semicolon
macro_line|#if (DEBUG &amp; DEBUG_RESET)
(brace
r_int
id|asr
comma
id|ssr
suffix:semicolon
id|asr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|ASR
)paren
suffix:semicolon
id|ssr
op_assign
id|sbic_arm_read
c_func
(paren
id|host-&gt;scsi.io_port
comma
id|SSR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;acornscsi_reset: &quot;
)paren
suffix:semicolon
id|print_sbic_status
c_func
(paren
id|asr
comma
id|ssr
comma
id|host-&gt;scsi.phase
)paren
suffix:semicolon
id|acornscsi_dumplog
c_func
(paren
id|host
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
)brace
macro_line|#endif
id|acornscsi_dma_stop
c_func
(paren
id|host
)paren
suffix:semicolon
id|SCptr
op_assign
id|host-&gt;SCpnt
suffix:semicolon
multiline_comment|/*&n;     * do hard reset.  This resets all devices on this host, and so we&n;     * must set the reset status on all commands.&n;     */
id|acornscsi_resetcard
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;     * report reset on commands current connected/disconnected&n;     */
id|acornscsi_reportstatus
c_func
(paren
op_amp
id|host-&gt;SCpnt
comma
op_amp
id|SCptr
comma
id|DID_RESET
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|SCptr
op_assign
id|queue_remove
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
)paren
)paren
op_ne
l_int|NULL
)paren
id|acornscsi_reportstatus
c_func
(paren
op_amp
id|SCptr
comma
op_amp
id|SCpnt
comma
id|DID_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_return
id|SCSI_RESET_BUS_RESET
op_or
id|SCSI_RESET_HOST_RESET
op_or
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*==============================================================================================&n; * initialisation &amp; miscellaneous support&n; */
DECL|variable|ecs
r_static
r_struct
id|expansion_card
op_star
id|ecs
(braket
id|MAX_ECARDS
)braket
suffix:semicolon
multiline_comment|/*&n; * Prototype: void acornscsi_init(AS_Host *host)&n; * Purpose  : initialise the AS_Host structure for one interface &amp; setup hardware&n; * Params   : host - host to setup&n; */
r_static
DECL|function|acornscsi_init
r_void
id|acornscsi_init
c_func
(paren
id|AS_Host
op_star
id|host
)paren
(brace
id|memset
c_func
(paren
op_amp
id|host-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|host-&gt;stats
)paren
)paren
suffix:semicolon
id|queue_initialise
c_func
(paren
op_amp
id|host-&gt;queues.issue
)paren
suffix:semicolon
id|queue_initialise
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
)paren
suffix:semicolon
id|msgqueue_initialise
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
id|acornscsi_resetcard
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
DECL|function|acornscsi_detect
r_int
id|acornscsi_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_static
r_const
id|card_ids
id|acornscsi_cids
(braket
)braket
op_assign
(brace
id|ACORNSCSI_LIST
comma
(brace
l_int|0xffff
comma
l_int|0xffff
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
id|AS_Host
op_star
id|host
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;acornscsi&quot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
id|ecs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ecard_startfind
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|ecs
(braket
id|count
)braket
op_assign
id|ecard_find
c_func
(paren
l_int|0
comma
id|acornscsi_cids
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ecs
(braket
id|count
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ecs
(braket
id|count
)braket
op_member_access_from_pointer
id|irq
op_eq
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi: WD33C93 does not have IRQ enabled - ignoring&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ecard_claim
c_func
(paren
id|ecs
(braket
id|count
)braket
)paren
suffix:semicolon
multiline_comment|/* Must claim here - card produces irq on reset */
id|instance
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
id|AS_Host
)paren
)paren
suffix:semicolon
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|instance-&gt;io_port
op_assign
id|ecard_address
c_func
(paren
id|ecs
(braket
id|count
)braket
comma
id|ECARD_MEMC
comma
l_int|0
)paren
suffix:semicolon
id|instance-&gt;irq
op_assign
id|ecs
(braket
id|count
)braket
op_member_access_from_pointer
id|irq
suffix:semicolon
id|host-&gt;host
op_assign
id|instance
suffix:semicolon
id|host-&gt;scsi.io_port
op_assign
id|ioaddr
c_func
(paren
id|instance-&gt;io_port
op_plus
l_int|0x800
)paren
suffix:semicolon
id|host-&gt;scsi.irq
op_assign
id|instance-&gt;irq
suffix:semicolon
id|host-&gt;card.io_intr
op_assign
id|POD_SPACE
c_func
(paren
id|instance-&gt;io_port
)paren
op_plus
l_int|0x800
suffix:semicolon
id|host-&gt;card.io_page
op_assign
id|POD_SPACE
c_func
(paren
id|instance-&gt;io_port
)paren
op_plus
l_int|0xc00
suffix:semicolon
id|host-&gt;card.io_ram
op_assign
id|ioaddr
c_func
(paren
id|instance-&gt;io_port
)paren
suffix:semicolon
id|host-&gt;dma.io_port
op_assign
id|instance-&gt;io_port
op_plus
l_int|0xc00
suffix:semicolon
id|host-&gt;dma.io_intr_clear
op_assign
id|POD_SPACE
c_func
(paren
id|instance-&gt;io_port
)paren
op_plus
l_int|0x800
suffix:semicolon
id|ecs
(braket
id|count
)braket
op_member_access_from_pointer
id|irqaddr
op_assign
(paren
r_char
op_star
)paren
id|ioaddr
c_func
(paren
id|host-&gt;card.io_intr
)paren
suffix:semicolon
id|ecs
(braket
id|count
)braket
op_member_access_from_pointer
id|irqmask
op_assign
l_int|0x0a
suffix:semicolon
id|request_region
c_func
(paren
id|instance-&gt;io_port
op_plus
l_int|0x800
comma
l_int|2
comma
l_string|&quot;acornscsi(sbic)&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|host-&gt;card.io_intr
comma
l_int|1
comma
l_string|&quot;acornscsi(intr)&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|host-&gt;card.io_page
comma
l_int|1
comma
l_string|&quot;acornscsi(page)&quot;
)paren
suffix:semicolon
macro_line|#ifdef USE_DMAC
id|request_region
c_func
(paren
id|host-&gt;dma.io_port
comma
l_int|256
comma
l_string|&quot;acornscsi(dmac)&quot;
)paren
suffix:semicolon
macro_line|#endif
id|request_region
c_func
(paren
id|instance-&gt;io_port
comma
l_int|2048
comma
l_string|&quot;acornscsi(ram)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|host-&gt;scsi.irq
comma
id|acornscsi_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;acornscsi&quot;
comma
id|host
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;scsi%d: IRQ%d not free, interrupts disabled&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|host-&gt;scsi.irq
)paren
suffix:semicolon
id|host-&gt;scsi.irq
op_assign
id|NO_IRQ
suffix:semicolon
)brace
id|acornscsi_init
c_func
(paren
id|host
)paren
suffix:semicolon
op_increment
id|count
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: int acornscsi_release(struct Scsi_Host *host)&n; * Purpose : release all resources used by this adapter&n; * Params  : host - driver structure to release&n; * Returns : nothing of any consequence&n; */
DECL|function|acornscsi_release
r_int
id|acornscsi_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|AS_Host
op_star
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;     * Put card into RESET state&n;     */
id|outb
c_func
(paren
l_int|0x80
comma
id|host-&gt;card.io_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;scsi.irq
op_ne
id|NO_IRQ
)paren
id|free_irq
c_func
(paren
id|host-&gt;scsi.irq
comma
id|host
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|instance-&gt;io_port
op_plus
l_int|0x800
comma
l_int|2
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|host-&gt;card.io_intr
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|host-&gt;card.io_page
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|host-&gt;dma.io_port
comma
l_int|256
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|instance-&gt;io_port
comma
l_int|2048
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ECARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ecs
(braket
id|i
)braket
op_logical_and
id|instance-&gt;io_port
op_eq
id|ecard_address
c_func
(paren
id|ecs
(braket
id|i
)braket
comma
id|ECARD_MEMC
comma
l_int|0
)paren
)paren
id|ecard_release
c_func
(paren
id|ecs
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgqueue_free
c_func
(paren
op_amp
id|host-&gt;scsi.msgs
)paren
suffix:semicolon
id|queue_free
c_func
(paren
op_amp
id|host-&gt;queues.disconnected
)paren
suffix:semicolon
id|queue_free
c_func
(paren
op_amp
id|host-&gt;queues.issue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: char *acornscsi_info(struct Scsi_Host *host)&n; * Purpose : return a string describing this interface&n; * Params  : host - host to give information on&n; * Returns : a constant string&n; */
r_const
DECL|function|acornscsi_info
r_char
op_star
id|acornscsi_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|string
(braket
l_int|100
)braket
comma
op_star
id|p
suffix:semicolon
id|p
op_assign
id|string
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|string
comma
l_string|&quot;%s at port %08lX irq %d v%d.%d.%d&quot;
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_SYNC
l_string|&quot; SYNC&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
l_string|&quot; TAG&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_LINK
l_string|&quot; LINK&quot;
macro_line|#endif
macro_line|#if (DEBUG &amp; DEBUG_NO_WRITE)
l_string|&quot; NOWRITE (&quot;
id|NO_WRITE_STR
l_string|&quot;)&quot;
macro_line|#endif
comma
id|host-&gt;hostt-&gt;name
comma
id|host-&gt;io_port
comma
id|host-&gt;irq
comma
id|VER_MAJOR
comma
id|VER_MINOR
comma
id|VER_PATCH
)paren
suffix:semicolon
r_return
id|string
suffix:semicolon
)brace
DECL|function|acornscsi_proc_info
r_int
id|acornscsi_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|host_no
comma
r_int
id|inout
)paren
(brace
r_int
id|pos
comma
id|begin
op_assign
l_int|0
comma
id|devidx
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
op_assign
id|scsi_hostlist
suffix:semicolon
id|Scsi_Device
op_star
id|scd
suffix:semicolon
id|AS_Host
op_star
id|host
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
r_for
c_loop
(paren
id|instance
op_assign
id|scsi_hostlist
suffix:semicolon
id|instance
op_logical_and
id|instance-&gt;host_no
op_ne
id|host_no
suffix:semicolon
id|instance
op_assign
id|instance-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inout
op_eq
l_int|1
op_logical_or
op_logical_neg
id|instance
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|host
op_assign
(paren
id|AS_Host
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AcornSCSI driver v%d.%d.%d&quot;
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_SYNC
l_string|&quot; SYNC&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_TAGGED_QUEUE
l_string|&quot; TAG&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_SCSI_ACORNSCSI_LINK
l_string|&quot; LINK&quot;
macro_line|#endif
macro_line|#if (DEBUG &amp; DEBUG_NO_WRITE)
l_string|&quot; NOWRITE (&quot;
id|NO_WRITE_STR
l_string|&quot;)&quot;
macro_line|#endif
l_string|&quot;&bslash;n&bslash;n&quot;
comma
id|VER_MAJOR
comma
id|VER_MINOR
comma
id|VER_PATCH
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;SBIC: WD33C93A  Address: %08X  IRQ : %d&bslash;n&quot;
comma
id|host-&gt;scsi.io_port
comma
id|host-&gt;scsi.irq
)paren
suffix:semicolon
macro_line|#ifdef USE_DMAC
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;DMAC: uPC71071  Address: %08X  IRQ : %d&bslash;n&bslash;n&quot;
comma
id|host-&gt;dma.io_port
comma
id|host-&gt;scsi.irq
)paren
suffix:semicolon
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Statistics:&bslash;n&quot;
l_string|&quot;Queued commands: %-10u    Issued commands: %-10u&bslash;n&quot;
l_string|&quot;Done commands  : %-10u    Reads          : %-10u&bslash;n&quot;
l_string|&quot;Writes         : %-10u    Others         : %-10u&bslash;n&quot;
l_string|&quot;Disconnects    : %-10u    Aborts         : %-10u&bslash;n&quot;
l_string|&quot;Resets         : %-10u&bslash;n&bslash;nLast phases:&quot;
comma
id|host-&gt;stats.queues
comma
id|host-&gt;stats.removes
comma
id|host-&gt;stats.fins
comma
id|host-&gt;stats.reads
comma
id|host-&gt;stats.writes
comma
id|host-&gt;stats.miscs
comma
id|host-&gt;stats.disconnects
comma
id|host-&gt;stats.aborts
comma
id|host-&gt;stats.resets
)paren
suffix:semicolon
r_for
c_loop
(paren
id|devidx
op_assign
l_int|0
suffix:semicolon
id|devidx
OL
l_int|9
suffix:semicolon
id|devidx
op_increment
)paren
(brace
r_int
r_int
id|statptr
comma
id|prev
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n%c:&quot;
comma
id|devidx
op_eq
l_int|8
ques
c_cond
l_char|&squot;H&squot;
suffix:colon
(paren
l_char|&squot;0&squot;
op_plus
id|devidx
)paren
)paren
suffix:semicolon
id|statptr
op_assign
id|host-&gt;status_ptr
(braket
id|devidx
)braket
op_minus
l_int|10
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|statptr
OL
l_int|0
)paren
id|statptr
op_add_assign
id|STATUS_BUFFER_SIZE
suffix:semicolon
id|prev
op_assign
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|when
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|statptr
op_ne
id|host-&gt;status_ptr
(braket
id|devidx
)braket
suffix:semicolon
id|statptr
op_assign
(paren
id|statptr
op_plus
l_int|1
)paren
op_amp
(paren
id|STATUS_BUFFER_SIZE
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|when
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%c%02X:%02X+%2ld&quot;
comma
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|irq
ques
c_cond
l_char|&squot;-&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|ph
comma
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|ssr
comma
(paren
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|when
op_minus
id|prev
)paren
OL
l_int|100
ques
c_cond
(paren
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|when
op_minus
id|prev
)paren
suffix:colon
l_int|99
)paren
suffix:semicolon
id|prev
op_assign
id|host-&gt;status
(braket
id|devidx
)braket
(braket
id|statptr
)braket
dot
id|when
suffix:semicolon
)brace
)brace
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;nAttached devices:%s&bslash;n&quot;
comma
id|instance-&gt;host_queue
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot; none&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|scd
op_assign
id|instance-&gt;host_queue
suffix:semicolon
id|scd
suffix:semicolon
id|scd
op_assign
id|scd-&gt;next
)paren
(brace
r_int
id|len
suffix:semicolon
id|proc_print_scsidevice
c_func
(paren
id|scd
comma
id|p
comma
op_amp
id|len
comma
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
id|len
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Extensions: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scd-&gt;tagged_supported
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;TAG %sabled [%d] &quot;
comma
id|scd-&gt;tagged_queue
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
comma
id|scd-&gt;current_tag
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;nTransfers: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;device
(braket
id|scd-&gt;id
)braket
dot
id|sync_xfer
op_amp
l_int|15
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;sync, offset %d, %d ns&bslash;n&quot;
comma
id|host-&gt;device
(braket
id|scd-&gt;id
)braket
dot
id|sync_xfer
op_amp
l_int|15
comma
id|acornscsi_getperiod
c_func
(paren
id|host-&gt;device
(braket
id|scd-&gt;id
)braket
dot
id|sync_xfer
)paren
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;async&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_assign
id|p
op_minus
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
id|begin
OL
id|offset
)paren
(brace
id|begin
op_add_assign
id|pos
suffix:semicolon
id|p
op_assign
id|buffer
suffix:semicolon
)brace
id|pos
op_assign
id|p
op_minus
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
id|begin
OG
id|offset
op_plus
id|length
)paren
r_break
suffix:semicolon
)brace
id|pos
op_assign
id|p
op_minus
id|buffer
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|pos
op_sub_assign
id|offset
op_minus
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|pos
OG
id|length
)paren
id|pos
op_assign
id|length
suffix:semicolon
r_return
id|pos
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|ACORNSCSI_3
suffix:semicolon
macro_line|#include &quot;../../scsi/scsi_module.c&quot;
macro_line|#endif
eof
