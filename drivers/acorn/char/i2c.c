multiline_comment|/*&n; *  linux/drivers/acorn/char/i2c.c&n; *&n; *  Copyright (C) 2000 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  ARM IOC/IOMD i2c driver.&n; *&n; *  On Acorn machines, the following i2c devices are on the bus:&n; *&t;- PCF8583 real time clock &amp; static RAM&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware/ioc.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;pcf8583.h&quot;
r_extern
r_int
r_int
id|mktime
c_func
(paren
r_int
r_int
id|year
comma
r_int
r_int
id|mon
comma
r_int
r_int
id|day
comma
r_int
r_int
id|hour
comma
r_int
r_int
id|min
comma
r_int
r_int
id|sec
)paren
suffix:semicolon
r_extern
r_int
(paren
op_star
id|set_rtc
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|rtc_client
r_static
r_struct
id|i2c_client
op_star
id|rtc_client
suffix:semicolon
DECL|function|rtc_command
r_static
r_inline
r_int
id|rtc_command
c_func
(paren
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|rtc_client
)paren
id|ret
op_assign
id|rtc_client-&gt;driver
op_member_access_from_pointer
id|command
c_func
(paren
id|rtc_client
comma
id|cmd
comma
id|data
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the current RTC time and date, and update xtime.&n; */
DECL|function|get_rtc_time
r_static
r_void
id|get_rtc_time
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|ctrl
suffix:semicolon
r_int
r_char
id|year
suffix:semicolon
r_struct
id|rtc_tm
id|rtctm
suffix:semicolon
r_struct
id|mem
id|rtcmem
op_assign
(brace
l_int|0xc0
comma
l_int|1
comma
op_amp
id|year
)brace
suffix:semicolon
multiline_comment|/*&n;&t; * Ensure that the RTC is running.&n;&t; */
id|rtc_command
c_func
(paren
id|RTC_GETCTRL
comma
op_amp
id|ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_amp
l_int|0xc0
)paren
(brace
r_int
r_char
id|new_ctrl
suffix:semicolon
id|new_ctrl
op_assign
id|ctrl
op_amp
op_complement
l_int|0xc0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RTC: resetting control %02X -&gt; %02X&bslash;n&quot;
comma
id|ctrl
comma
id|new_ctrl
)paren
suffix:semicolon
id|rtc_command
c_func
(paren
id|RTC_SETCTRL
comma
op_amp
id|new_ctrl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Acorn machines store the year in&n;&t; * the static RAM at location 192.&n;&t; */
r_if
c_cond
(paren
id|rtc_command
c_func
(paren
id|MEM_READ
comma
op_amp
id|rtcmem
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|rtc_command
c_func
(paren
id|RTC_GETDATETIME
comma
op_amp
id|rtctm
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|year
OL
l_int|70
)paren
id|year
op_add_assign
l_int|100
suffix:semicolon
id|xtime.tv_usec
op_assign
id|rtctm.cs
op_star
l_int|10000
suffix:semicolon
id|xtime.tv_sec
op_assign
id|mktime
c_func
(paren
l_int|1900
op_plus
id|year
comma
id|rtctm.mon
comma
id|rtctm.mday
comma
id|rtctm.hours
comma
id|rtctm.mins
comma
id|rtctm.secs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the RTC time only.  Note that&n; * we do not touch the date.&n; */
DECL|function|set_rtc_time
r_static
r_int
id|set_rtc_time
c_func
(paren
r_void
)paren
(brace
r_struct
id|rtc_tm
id|new_rtctm
comma
id|old_rtctm
suffix:semicolon
r_int
r_int
id|nowtime
op_assign
id|xtime.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|rtc_command
c_func
(paren
id|RTC_GETDATETIME
comma
op_amp
id|old_rtctm
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|new_rtctm.cs
op_assign
id|xtime.tv_usec
op_div
l_int|10000
suffix:semicolon
id|new_rtctm.secs
op_assign
id|nowtime
op_mod
l_int|60
suffix:semicolon
id|nowtime
op_div_assign
l_int|60
suffix:semicolon
id|new_rtctm.mins
op_assign
id|nowtime
op_mod
l_int|60
suffix:semicolon
id|nowtime
op_div_assign
l_int|60
suffix:semicolon
id|new_rtctm.hours
op_assign
id|nowtime
op_mod
l_int|24
suffix:semicolon
multiline_comment|/*&n;&t; * avoid writing when we&squot;re going to change the day&n;&t; * of the month.  We will retry in the next minute.&n;&t; * This basically means that if the RTC must not drift&n;&t; * by more than 1 minute in 11 minutes.&n;&t; *&n;&t; * [ rtc: 1/1/2000 23:58:00, real 2/1/2000 00:01:00,&n;&t; *   rtc gets set to 1/1/2000 00:01:00 ]&n;&t; */
r_if
c_cond
(paren
(paren
id|old_rtctm.hours
op_eq
l_int|23
op_logical_and
id|old_rtctm.mins
op_eq
l_int|59
)paren
op_logical_or
(paren
id|new_rtctm.hours
op_eq
l_int|23
op_logical_and
id|new_rtctm.mins
op_eq
l_int|59
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|rtc_command
c_func
(paren
id|RTC_SETTIME
comma
op_amp
id|new_rtctm
)paren
suffix:semicolon
)brace
DECL|macro|FORCE_ONES
mdefine_line|#define FORCE_ONES&t;0xdc
DECL|macro|SCL
mdefine_line|#define SCL&t;&t;0x02
DECL|macro|SDA
mdefine_line|#define SDA&t;&t;0x01
DECL|variable|ioc_control
r_static
r_int
id|ioc_control
suffix:semicolon
DECL|function|ioc_setscl
r_static
r_void
id|ioc_setscl
c_func
(paren
r_void
op_star
id|data
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|ioc_control
op_or_assign
id|SCL
suffix:semicolon
r_else
id|ioc_control
op_and_assign
op_complement
id|SCL
suffix:semicolon
id|outb
c_func
(paren
id|ioc_control
comma
id|IOC_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|ioc_setsda
r_static
r_void
id|ioc_setsda
c_func
(paren
r_void
op_star
id|data
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|ioc_control
op_or_assign
id|SDA
suffix:semicolon
r_else
id|ioc_control
op_and_assign
op_complement
id|SDA
suffix:semicolon
id|outb
c_func
(paren
id|ioc_control
comma
id|IOC_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|ioc_getscl
r_static
r_int
id|ioc_getscl
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_return
(paren
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
id|SCL
)paren
op_ne
l_int|0
suffix:semicolon
)brace
DECL|function|ioc_getsda
r_static
r_int
id|ioc_getsda
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_return
(paren
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
id|SDA
)paren
op_ne
l_int|0
suffix:semicolon
)brace
DECL|variable|ioc_data
r_static
r_struct
id|i2c_algo_bit_data
id|ioc_data
op_assign
(brace
l_int|NULL
comma
id|ioc_setsda
comma
id|ioc_setscl
comma
id|ioc_getsda
comma
id|ioc_getscl
comma
l_int|80
comma
l_int|80
comma
l_int|100
)brace
suffix:semicolon
DECL|function|ioc_client_reg
r_static
r_int
id|ioc_client_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_if
c_cond
(paren
id|client-&gt;id
op_eq
id|I2C_DRIVERID_PCF8583
op_logical_and
id|client-&gt;addr
op_eq
l_int|0x50
)paren
(brace
id|rtc_client
op_assign
id|client
suffix:semicolon
id|get_rtc_time
c_func
(paren
)paren
suffix:semicolon
id|set_rtc
op_assign
id|set_rtc_time
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioc_client_unreg
r_static
r_int
id|ioc_client_unreg
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_if
c_cond
(paren
id|client
op_eq
id|rtc_client
)paren
(brace
id|set_rtc
op_assign
l_int|NULL
suffix:semicolon
id|rtc_client
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ioc_ops
r_static
r_struct
id|i2c_adapter
id|ioc_ops
op_assign
(brace
l_string|&quot;IOC/IOMD&quot;
comma
id|I2C_HW_B_IOC
comma
l_int|NULL
comma
op_amp
id|ioc_data
comma
l_int|NULL
comma
l_int|NULL
comma
id|ioc_client_reg
comma
id|ioc_client_unreg
)brace
suffix:semicolon
DECL|function|i2c_ioc_init
r_static
r_int
id|__init
id|i2c_ioc_init
c_func
(paren
r_void
)paren
(brace
id|ioc_control
op_assign
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_or
id|FORCE_ONES
suffix:semicolon
id|ioc_setscl
c_func
(paren
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
id|ioc_setsda
c_func
(paren
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
r_return
id|i2c_bit_add_bus
c_func
(paren
op_amp
id|ioc_ops
)paren
suffix:semicolon
)brace
DECL|variable|i2c_ioc_init
id|__initcall
c_func
(paren
id|i2c_ioc_init
)paren
suffix:semicolon
eof
