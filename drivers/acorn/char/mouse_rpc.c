multiline_comment|/*&n; *  linux/drivers/char/mouse_rpc.c&n; *&n; *  Copyright (C) 1996-1998 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  This handles the Acorn RiscPCs mouse.  We basically have a couple&n; *  of hardware registers that track the sensor count for the X-Y movement&n; *  and another register holding the button state.  On every VSYNC interrupt&n; *  we read the complete state and then work out if something has changed.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware/iomd.h&gt;
macro_line|#include &quot;../../char/busmouse.h&quot;
DECL|variable|old_x
DECL|variable|old_y
DECL|variable|old_b
r_static
r_int
id|old_x
comma
id|old_y
comma
id|old_b
suffix:semicolon
DECL|variable|mousedev
r_static
r_int
id|mousedev
suffix:semicolon
r_void
DECL|function|mouse_rpc_irq
id|mouse_rpc_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|x
comma
id|y
comma
id|dx
comma
id|dy
suffix:semicolon
r_int
id|buttons
suffix:semicolon
id|x
op_assign
(paren
r_int
)paren
id|inl
c_func
(paren
id|IOMD_MOUSEX
)paren
suffix:semicolon
id|y
op_assign
(paren
r_int
)paren
id|inl
c_func
(paren
id|IOMD_MOUSEY
)paren
suffix:semicolon
id|buttons
op_assign
(paren
id|inl
(paren
l_int|0x800C4000
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|7
suffix:semicolon
id|dx
op_assign
id|x
op_minus
id|old_x
suffix:semicolon
id|old_x
op_assign
id|x
suffix:semicolon
id|dy
op_assign
id|y
op_minus
id|old_y
suffix:semicolon
id|old_y
op_assign
id|y
suffix:semicolon
r_if
c_cond
(paren
id|dx
op_logical_or
id|dy
op_logical_or
id|buttons
op_ne
id|old_b
)paren
(brace
id|busmouse_add_movementbuttons
c_func
(paren
id|mousedev
comma
id|dx
comma
id|dy
comma
id|buttons
)paren
suffix:semicolon
id|old_b
op_assign
id|buttons
suffix:semicolon
)brace
)brace
DECL|variable|rpcmouse
r_static
r_struct
id|busmouse
id|rpcmouse
op_assign
(brace
l_int|6
comma
l_string|&quot;arcmouse&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|7
)brace
suffix:semicolon
DECL|function|mouse_rpc_init
r_static
r_int
id|__init
id|mouse_rpc_init
c_func
(paren
r_void
)paren
(brace
id|mousedev
op_assign
id|register_busmouse
c_func
(paren
op_amp
id|rpcmouse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mousedev
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;rpcmouse: could not register mouse driver&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|old_x
op_assign
(paren
r_int
)paren
id|inl
c_func
(paren
id|IOMD_MOUSEX
)paren
suffix:semicolon
id|old_y
op_assign
(paren
r_int
)paren
id|inl
c_func
(paren
id|IOMD_MOUSEY
)paren
suffix:semicolon
id|old_b
op_assign
(paren
id|inl
(paren
l_int|0x800C4000
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_VSYNCPULSE
comma
id|mouse_rpc_irq
comma
id|SA_SHIRQ
comma
l_string|&quot;mouse&quot;
comma
op_amp
id|mousedev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rpcmouse: unable to allocate VSYNC interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_busmouse
c_func
(paren
id|mousedev
)paren
suffix:semicolon
id|mousedev
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|mousedev
op_ge
l_int|0
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|mouse_rpc_exit
r_static
r_void
id|__exit
id|mouse_rpc_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mousedev
op_ge
l_int|0
)paren
(brace
id|unregister_busmouse
c_func
(paren
id|mousedev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_VSYNCPULSE
comma
op_amp
id|mousedev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|mouse_rpc_init
id|module_init
c_func
(paren
id|mouse_rpc_init
)paren
suffix:semicolon
DECL|variable|mouse_rpc_exit
id|module_exit
c_func
(paren
id|mouse_rpc_exit
)paren
suffix:semicolon
eof
