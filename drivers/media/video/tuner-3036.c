multiline_comment|/*&n; * Driver for Philips SAB3036 &quot;CITAC&quot; tuner control chip.&n; *&n; * Author: Phil Blundell &lt;philb@gnu.org&gt;&n; *&n; * The SAB3036 is just about different enough from the chips that&n; * tuner.c copes with to make it not worth the effort to crowbar&n; * the support into that file.  So instead we have a separate driver. &n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &quot;tuner.h&quot;
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|variable|this_adap
r_static
r_int
id|this_adap
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
multiline_comment|/* Addresses to scan */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
l_int|0x60
comma
l_int|0x61
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe
r_static
r_int
r_int
id|probe
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe_range
r_static
r_int
r_int
id|probe_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore
r_static
r_int
r_int
id|ignore
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore_range
r_static
r_int
r_int
id|ignore_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|force
r_static
r_int
r_int
id|force
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|addr_data
r_static
r_struct
id|i2c_client_address_data
id|addr_data
op_assign
(brace
id|normal_i2c
comma
id|normal_i2c_range
comma
id|probe
comma
id|probe_range
comma
id|ignore
comma
id|ignore_range
comma
id|force
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
r_static
r_int
r_char
DECL|function|tuner_getstatus
id|tuner_getstatus
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_int
r_char
id|byte
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_recv
c_func
(paren
id|c
comma
op_amp
id|byte
comma
l_int|1
)paren
op_ne
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tuner-3036: I/O error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|byte
suffix:semicolon
)brace
DECL|macro|TUNER_FL
mdefine_line|#define TUNER_FL        0x80
r_static
r_int
DECL|function|tuner_islocked
id|tuner_islocked
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_return
(paren
id|tuner_getstatus
c_func
(paren
id|c
)paren
op_amp
id|TUNER_FL
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
r_static
r_void
DECL|function|set_tv_freq
id|set_tv_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
id|freq
)paren
(brace
id|u16
id|div
op_assign
(paren
(paren
id|freq
op_star
l_int|20
)paren
op_div
l_int|16
)paren
suffix:semicolon
r_int
r_int
id|give_up
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_int
r_char
id|buffer
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tuner: setting frequency %dMHz, divisor %x&bslash;n&quot;
comma
id|freq
op_div
l_int|16
comma
id|div
)paren
suffix:semicolon
multiline_comment|/* Select high tuning current */
id|buffer
(braket
l_int|0
)braket
op_assign
l_int|0x29
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
l_int|0x3e
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|c
comma
id|buffer
comma
l_int|2
)paren
op_ne
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;tuner: i2c i/o error 1&bslash;n&quot;
)paren
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
l_int|0x80
op_or
(paren
(paren
id|div
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|div
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|c
comma
id|buffer
comma
l_int|2
)paren
op_ne
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;tuner: i2c i/o error 2&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|tuner_islocked
c_func
(paren
id|c
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|give_up
)paren
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tuner_islocked
c_func
(paren
id|c
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tuner: failed to achieve PLL lock&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Select low tuning current and engage AFC */
id|buffer
(braket
l_int|0
)braket
op_assign
l_int|0x29
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
l_int|0xb2
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|c
comma
id|buffer
comma
l_int|2
)paren
op_ne
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;tuner: i2c i/o error 3&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tuner: status %02x&bslash;n&quot;
comma
id|tuner_getstatus
c_func
(paren
id|c
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
r_static
r_int
DECL|function|tuner_attach
id|tuner_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
r_int
id|flags
comma
r_int
id|kind
)paren
(brace
r_static
r_int
r_char
id|buffer
(braket
)braket
op_assign
(brace
l_int|0x29
comma
l_int|0x32
comma
l_int|0x2a
comma
l_int|0
comma
l_int|0x2b
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|i2c_client
op_star
id|client
suffix:semicolon
r_if
c_cond
(paren
id|this_adap
OG
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|this_adap
op_increment
suffix:semicolon
id|client_template.adapter
op_assign
id|adap
suffix:semicolon
id|client_template.addr
op_assign
id|addr
suffix:semicolon
id|client
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2c_client
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|client
comma
op_amp
id|client_template
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tuner: SAB3036 found, status %02x&bslash;n&quot;
comma
id|tuner_getstatus
c_func
(paren
id|client
)paren
)paren
suffix:semicolon
id|i2c_attach_client
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|client
comma
id|buffer
comma
l_int|2
)paren
op_ne
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;tuner: i2c i/o error 1&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|client
comma
id|buffer
op_plus
l_int|2
comma
l_int|2
)paren
op_ne
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;tuner: i2c i/o error 2&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|client
comma
id|buffer
op_plus
l_int|4
comma
l_int|2
)paren
op_ne
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;tuner: i2c i/o error 3&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tuner_detach
id|tuner_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tuner_command
id|tuner_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
op_star
id|iarg
op_assign
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TUNER_SET_TVFREQ
suffix:colon
id|set_tv_freq
c_func
(paren
id|client
comma
op_star
id|iarg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tuner_probe
id|tuner_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
id|this_adap
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|adap-&gt;id
op_eq
(paren
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_LP
)paren
)paren
r_return
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|tuner_attach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
r_static
r_struct
id|i2c_driver
DECL|variable|i2c_driver_tuner
id|i2c_driver_tuner
op_assign
(brace
l_string|&quot;sab3036&quot;
comma
multiline_comment|/* name       */
id|I2C_DRIVERID_SAB3036
comma
multiline_comment|/* ID         */
id|I2C_DF_NOTIFY
comma
id|tuner_probe
comma
id|tuner_detach
comma
id|tuner_command
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
l_string|&quot;SAB3036&quot;
comma
multiline_comment|/* name       */
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|i2c_driver_tuner
)brace
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_int
id|__init
DECL|function|tuner3036_init
id|tuner3036_init
c_func
(paren
r_void
)paren
(brace
id|i2c_add_driver
c_func
(paren
op_amp
id|i2c_driver_tuner
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|__exit
DECL|function|tuner3036_exit
id|tuner3036_exit
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|i2c_driver_tuner
)paren
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SAB3036 tuner driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Philip Blundell &lt;philb@gnu.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Enable debugging output&quot;
)paren
suffix:semicolon
DECL|variable|tuner3036_init
id|module_init
c_func
(paren
id|tuner3036_init
)paren
suffix:semicolon
DECL|variable|tuner3036_exit
id|module_exit
c_func
(paren
id|tuner3036_exit
)paren
suffix:semicolon
eof
