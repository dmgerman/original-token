multiline_comment|/* &n; * stradis.c - stradis 4:2:2 mpeg decoder driver&n; *&n; * Stradis 4:2:2 MPEG-2 Decoder Driver&n; * Copyright (C) 1999 Nathan Laredo &lt;laredo@gnu.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/i2c-old.h&gt;
macro_line|#include &quot;saa7146.h&quot;
macro_line|#include &quot;saa7146reg.h&quot;
macro_line|#include &quot;ibmmpeg2.h&quot;
macro_line|#include &quot;saa7121.h&quot;
macro_line|#include &quot;cs8420.h&quot;
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x) &t;&t;/* debug driver */
DECL|macro|IDEBUG
macro_line|#undef  IDEBUG(x) &t;&t;/* debug irq handler */
DECL|macro|MDEBUG
macro_line|#undef  MDEBUG(x) &t;&t;/* debug memory management */
DECL|macro|SAA7146_MAX
mdefine_line|#define SAA7146_MAX 6
DECL|variable|saa7146s
r_static
r_struct
id|saa7146
id|saa7146s
(braket
id|SAA7146_MAX
)braket
suffix:semicolon
DECL|variable|saa_num
r_static
r_int
id|saa_num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of SAA7146s in use */
DECL|macro|nDebNormal
mdefine_line|#define nDebNormal&t;0x00480000
DECL|macro|nDebNoInc
mdefine_line|#define nDebNoInc&t;0x00480000
DECL|macro|nDebVideo
mdefine_line|#define nDebVideo&t;0xd0480000
DECL|macro|nDebAudio
mdefine_line|#define nDebAudio&t;0xd0400000
DECL|macro|nDebDMA
mdefine_line|#define nDebDMA&t;&t;0x02c80000
DECL|macro|oDebNormal
mdefine_line|#define oDebNormal&t;0x13c80000
DECL|macro|oDebNoInc
mdefine_line|#define oDebNoInc&t;0x13c80000
DECL|macro|oDebVideo
mdefine_line|#define oDebVideo&t;0xd1080000
DECL|macro|oDebAudio
mdefine_line|#define oDebAudio&t;0xd1080000
DECL|macro|oDebDMA
mdefine_line|#define oDebDMA&t;&t;0x03080000
DECL|macro|NewCard
mdefine_line|#define NewCard&t;&t;(saa-&gt;boardcfg[3])
DECL|macro|ChipControl
mdefine_line|#define ChipControl&t;(saa-&gt;boardcfg[1])
DECL|macro|NTSCFirstActive
mdefine_line|#define NTSCFirstActive&t;(saa-&gt;boardcfg[4])
DECL|macro|PALFirstActive
mdefine_line|#define PALFirstActive&t;(saa-&gt;boardcfg[5])
DECL|macro|NTSCLastActive
mdefine_line|#define NTSCLastActive&t;(saa-&gt;boardcfg[54])
DECL|macro|PALLastActive
mdefine_line|#define PALLastActive&t;(saa-&gt;boardcfg[55])
DECL|macro|Have2MB
mdefine_line|#define Have2MB&t;&t;(saa-&gt;boardcfg[18] &amp; 0x40)
DECL|macro|HaveCS8420
mdefine_line|#define HaveCS8420&t;(saa-&gt;boardcfg[18] &amp; 0x04)
DECL|macro|IBMMPEGCD20
mdefine_line|#define IBMMPEGCD20&t;(saa-&gt;boardcfg[18] &amp; 0x20)
DECL|macro|HaveCS3310
mdefine_line|#define HaveCS3310&t;(saa-&gt;boardcfg[18] &amp; 0x01)
DECL|macro|CS3310MaxLvl
mdefine_line|#define CS3310MaxLvl&t;((saa-&gt;boardcfg[30] &lt;&lt; 8) | saa-&gt;boardcfg[31])
DECL|macro|HaveCS4341
mdefine_line|#define HaveCS4341&t;(saa-&gt;boardcfg[40] == 2)
DECL|macro|SDIType
mdefine_line|#define SDIType&t;&t;(saa-&gt;boardcfg[27])
DECL|macro|CurrentMode
mdefine_line|#define CurrentMode&t;(saa-&gt;boardcfg[2])
DECL|macro|debNormal
mdefine_line|#define debNormal&t;(NewCard ? nDebNormal : oDebNormal)
DECL|macro|debNoInc
mdefine_line|#define debNoInc&t;(NewCard ? nDebNoInc : oDebNoInc)
DECL|macro|debVideo
mdefine_line|#define debVideo&t;(NewCard ? nDebVideo : oDebVideo)
DECL|macro|debAudio
mdefine_line|#define debAudio&t;(NewCard ? nDebAudio : oDebAudio)
DECL|macro|debDMA
mdefine_line|#define debDMA&t;&t;(NewCard ? nDebDMA : oDebDMA)
macro_line|#ifdef DEBUG
DECL|function|stradis_driver
r_int
id|stradis_driver
c_func
(paren
r_void
)paren
multiline_comment|/* for the benefit of ksymoops */
(brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef USE_RESCUE_EEPROM_SDM275
DECL|variable|rescue_eeprom
r_static
r_int
r_char
id|rescue_eeprom
(braket
l_int|64
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x01
comma
l_int|0x04
comma
l_int|0x13
comma
l_int|0x26
comma
l_int|0x0f
comma
l_int|0x10
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x43
comma
l_int|0x63
comma
l_int|0x22
comma
l_int|0x01
comma
l_int|0x29
comma
l_int|0x15
comma
l_int|0x73
comma
l_int|0x00
comma
l_int|0x1f
comma
l_char|&squot;d&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot;c&squot;
comma
l_char|&squot;x&squot;
comma
l_char|&squot;l&squot;
comma
l_char|&squot;d&squot;
comma
l_char|&squot;v&squot;
comma
l_char|&squot;a&squot;
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0xcc
comma
l_int|0xa4
comma
l_int|0x63
comma
l_int|0x09
comma
l_int|0xe2
comma
l_int|0x10
comma
l_int|0x00
comma
l_int|0x0a
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x02
comma
l_char|&squot;d&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot;c&squot;
comma
l_char|&squot;x&squot;
comma
l_char|&squot;l&squot;
comma
l_char|&squot;a&squot;
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x42
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* ----------------------------------------------------------------------- */
multiline_comment|/* Hardware I2C functions */
DECL|function|I2CWipe
r_static
r_void
id|I2CWipe
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* set i2c to ~=100kHz, abort transfer, clear busy */
id|saawrite
c_func
(paren
l_int|0x600
op_or
id|SAA7146_I2C_ABORT
comma
id|SAA7146_I2C_STATUS
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_I2C
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_I2C
comma
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* wait for i2c registers to be programmed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
op_amp
id|SAA7146_MC2_UPLD_I2C
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x600
comma
id|SAA7146_I2C_STATUS
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_I2C
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_I2C
comma
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* wait for i2c registers to be programmed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
op_amp
id|SAA7146_MC2_UPLD_I2C
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x600
comma
id|SAA7146_I2C_STATUS
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_I2C
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_I2C
comma
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* wait for i2c registers to be programmed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
op_amp
id|SAA7146_MC2_UPLD_I2C
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* read I2C */
DECL|function|I2CRead
r_static
r_int
id|I2CRead
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
id|addr
comma
r_int
r_char
id|subaddr
comma
r_int
id|dosub
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_STATUS
)paren
op_amp
l_int|0x3c
)paren
id|I2CWipe
c_func
(paren
id|saa
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_STATUS
)paren
op_amp
id|SAA7146_I2C_BUSY
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
id|I2CWipe
c_func
(paren
id|saa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dosub
)paren
id|saawrite
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0xfe
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
(paren
id|addr
op_or
l_int|1
)paren
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|subaddr
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xed
comma
id|SAA7146_I2C_TRANSFER
)paren
suffix:semicolon
r_else
id|saawrite
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0xfe
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
(paren
id|addr
op_or
l_int|1
)paren
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xf1
comma
id|SAA7146_I2C_TRANSFER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_I2C
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_I2C
comma
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* wait for i2c registers to be programmed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
op_amp
id|SAA7146_MC2_UPLD_I2C
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for valid data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_STATUS
)paren
op_amp
id|SAA7146_I2C_BUSY
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_STATUS
)paren
op_amp
id|SAA7146_I2C_ERR
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
id|printk
c_func
(paren
l_string|&quot;i2c setup read timeout&bslash;n&quot;
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x41
comma
id|SAA7146_I2C_TRANSFER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_I2C
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_I2C
comma
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* wait for i2c registers to be programmed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
op_amp
id|SAA7146_MC2_UPLD_I2C
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for valid data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_TRANSFER
)paren
op_amp
id|SAA7146_I2C_BUSY
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_TRANSFER
)paren
op_amp
id|SAA7146_I2C_ERR
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
id|printk
c_func
(paren
l_string|&quot;i2c read timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_TRANSFER
)paren
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
DECL|function|I2CReadOld
r_static
r_int
id|I2CReadOld
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
id|addr
)paren
(brace
r_return
id|I2CRead
c_func
(paren
id|bus
comma
id|addr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* set both to write both bytes, reset it to write only b1 */
DECL|function|I2CWrite
r_static
r_int
id|I2CWrite
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
id|addr
comma
r_int
r_char
id|b1
comma
r_int
r_char
id|b2
comma
r_int
id|both
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_if
c_cond
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_STATUS
)paren
op_amp
l_int|0x3c
)paren
id|I2CWipe
c_func
(paren
id|saa
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
(paren
id|saaread
c_func
(paren
id|SAA7146_I2C_STATUS
)paren
op_amp
id|SAA7146_I2C_BUSY
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
id|I2CWipe
c_func
(paren
id|saa
)paren
suffix:semicolon
id|data
op_assign
(paren
(paren
id|addr
op_amp
l_int|0xfe
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|b1
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|both
)paren
id|data
op_or_assign
(paren
(paren
id|b2
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
l_int|0xe5
suffix:semicolon
r_else
id|data
op_or_assign
l_int|0xd1
suffix:semicolon
id|saawrite
c_func
(paren
id|data
comma
id|SAA7146_I2C_TRANSFER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_I2C
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_I2C
comma
id|SAA7146_MC2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|attach_inform
r_static
r_void
id|attach_inform
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|id
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;stradis%d: i2c: device found=%02x&bslash;n&quot;
comma
id|saa-&gt;nr
comma
id|id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
l_int|0xa0
)paren
(brace
multiline_comment|/* we have rev2 or later board, fill in info */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|saa-&gt;boardcfg
(braket
id|i
)braket
op_assign
id|I2CRead
c_func
(paren
id|bus
comma
l_int|0xa0
comma
id|i
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef USE_RESCUE_EEPROM_SDM275
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;stradis%d: WARNING: EEPROM STORED VALUES HAVE BEEN IGNORED&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|saa-&gt;boardcfg
(braket
id|i
)braket
op_assign
id|rescue_eeprom
(braket
id|i
)braket
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;stradis%d: config =&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|51
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|saa-&gt;boardcfg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|detach_inform
r_static
r_void
id|detach_inform
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|id
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
id|saa-&gt;nr
suffix:semicolon
)brace
DECL|function|I2CBusScan
r_static
r_void
id|I2CBusScan
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xff
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
r_if
c_cond
(paren
(paren
id|I2CRead
c_func
(paren
id|bus
comma
id|i
comma
l_int|0
comma
l_int|0
)paren
)paren
op_ge
l_int|0
)paren
id|attach_inform
c_func
(paren
id|bus
comma
id|i
)paren
suffix:semicolon
)brace
DECL|variable|saa7146_i2c_bus_template
r_static
r_struct
id|i2c_bus
id|saa7146_i2c_bus_template
op_assign
(brace
l_string|&quot;saa7146&quot;
comma
id|I2C_BUSID_BT848
comma
l_int|NULL
comma
id|SPIN_LOCK_UNLOCKED
comma
id|attach_inform
comma
id|detach_inform
comma
l_int|NULL
comma
l_int|NULL
comma
id|I2CReadOld
comma
id|I2CWrite
comma
)brace
suffix:semicolon
DECL|variable|debiwait_maxwait
r_static
r_int
id|debiwait_maxwait
op_assign
l_int|0
suffix:semicolon
DECL|function|wait_for_debi_done
r_static
r_int
id|wait_for_debi_done
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* wait for registers to be programmed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
op_amp
id|SAA7146_MC2_UPLD_DEBI
)paren
suffix:semicolon
id|i
op_increment
)paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* wait for transfer to complete */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|500000
op_logical_and
(paren
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
op_amp
id|SAA7146_PSR_DEBI_S
)paren
suffix:semicolon
id|i
op_increment
)paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|debiwait_maxwait
)paren
id|printk
c_func
(paren
l_string|&quot;wait-for-debi-done maxwait: %d&bslash;n&quot;
comma
id|debiwait_maxwait
op_assign
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|500000
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|debiwrite
r_static
r_int
id|debiwrite
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|config
comma
r_int
id|addr
comma
id|u32
id|val
comma
r_int
id|count
)paren
(brace
id|u32
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
op_logical_or
id|count
OG
l_int|32764
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_debi_done
c_func
(paren
id|saa
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|saawrite
c_func
(paren
id|config
comma
id|SAA7146_DEBI_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|4
)paren
multiline_comment|/* immediate transfer */
id|saawrite
c_func
(paren
id|val
comma
id|SAA7146_DEBI_AD
)paren
suffix:semicolon
r_else
multiline_comment|/* block transfer */
id|saawrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;dmadebi
)paren
comma
id|SAA7146_DEBI_AD
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|cmd
op_assign
(paren
id|count
op_lshift
l_int|17
)paren
op_or
(paren
id|addr
op_amp
l_int|0xffff
)paren
)paren
comma
id|SAA7146_DEBI_COMMAND
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_DEBI
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_DEBI
comma
id|SAA7146_MC2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|debiread
r_static
id|u32
id|debiread
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|config
comma
r_int
id|addr
comma
r_int
id|count
)paren
(brace
id|u32
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|32764
op_logical_or
id|count
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_debi_done
c_func
(paren
id|saa
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|saawrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;dmadebi
)paren
comma
id|SAA7146_DEBI_AD
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|count
op_lshift
l_int|17
)paren
op_or
l_int|0x10000
op_or
(paren
id|addr
op_amp
l_int|0xffff
)paren
comma
id|SAA7146_DEBI_COMMAND
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|config
comma
id|SAA7146_DEBI_CONFIG
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC2_UPLD_DEBI
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_DEBI
comma
id|SAA7146_MC2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|4
)paren
multiline_comment|/* not an immediate transfer */
r_return
id|count
suffix:semicolon
id|wait_for_debi_done
c_func
(paren
id|saa
)paren
suffix:semicolon
id|result
op_assign
id|saaread
c_func
(paren
id|SAA7146_DEBI_AD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|1
)paren
id|result
op_and_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|2
)paren
id|result
op_and_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|3
)paren
id|result
op_and_assign
l_int|0xffffff
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#if 0 /* unused */
multiline_comment|/* MUST be a multiple of 8 bytes and 8-byte aligned and &lt; 32768 bytes */
multiline_comment|/* data copied into saa-&gt;dmadebi buffer, caller must re-enable interrupts */
r_static
r_void
id|ibm_block_dram_read
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|address
comma
r_int
id|bytes
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
op_star
id|buf
suffix:semicolon
id|buf
op_assign
(paren
id|u32
op_star
)paren
id|saa-&gt;dmadebi
suffix:semicolon
r_if
c_cond
(paren
id|bytes
OG
l_int|0x7000
)paren
id|bytes
op_assign
l_int|0x7000
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
op_logical_and
(paren
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DRAM_CMD_STAT
comma
l_int|2
)paren
op_amp
l_int|0x8000
)paren
suffix:semicolon
id|i
op_increment
)paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: dram_busy never cleared&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_SRC_ADDR
comma
(paren
id|address
op_lshift
l_int|16
)paren
op_or
(paren
id|address
op_rshift
l_int|16
)paren
comma
l_int|4
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_BLOCK_SIZE
comma
id|bytes
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CMD_STAT
comma
l_int|0x8a10
comma
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|bytes
op_div
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
op_logical_and
(paren
op_logical_neg
(paren
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DRAM_CMD_STAT
comma
l_int|2
)paren
op_amp
l_int|0x4000
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
id|saaread
c_func
(paren
id|SAA7146_MC2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: dram_ready never set&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|buf
(braket
id|j
)braket
op_assign
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DRAM_DATA
comma
l_int|4
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* unused */
DECL|function|do_irq_send_data
r_static
r_void
id|do_irq_send_data
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
r_int
id|split
comma
id|audbytes
comma
id|vidbytes
suffix:semicolon
id|saawrite
c_func
(paren
id|SAA7146_PSR_PIN1
comma
id|SAA7146_IER
)paren
suffix:semicolon
multiline_comment|/* if special feature mode in effect, disable audio sending */
r_if
c_cond
(paren
id|saa-&gt;playmode
op_ne
id|VID_PLAY_NORMAL
)paren
id|saa-&gt;audtail
op_assign
id|saa-&gt;audhead
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;audhead
op_le
id|saa-&gt;audtail
)paren
id|audbytes
op_assign
id|saa-&gt;audtail
op_minus
id|saa-&gt;audhead
suffix:semicolon
r_else
id|audbytes
op_assign
l_int|65536
op_minus
(paren
id|saa-&gt;audhead
op_minus
id|saa-&gt;audtail
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;vidhead
op_le
id|saa-&gt;vidtail
)paren
id|vidbytes
op_assign
id|saa-&gt;vidtail
op_minus
id|saa-&gt;vidhead
suffix:semicolon
r_else
id|vidbytes
op_assign
l_int|524288
op_minus
(paren
id|saa-&gt;vidhead
op_minus
id|saa-&gt;vidtail
)paren
suffix:semicolon
r_if
c_cond
(paren
id|audbytes
op_eq
l_int|0
op_logical_and
id|vidbytes
op_eq
l_int|0
op_logical_and
id|saa-&gt;osdtail
op_eq
id|saa-&gt;osdhead
)paren
(brace
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* if at least 1 block audio waiting and audio fifo isn&squot;t full */
r_if
c_cond
(paren
id|audbytes
op_ge
l_int|2048
op_logical_and
(paren
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_FIFO
comma
l_int|2
)paren
op_amp
l_int|0xff
)paren
OL
l_int|60
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;audhead
OG
id|saa-&gt;audtail
)paren
id|split
op_assign
l_int|65536
op_minus
id|saa-&gt;audhead
suffix:semicolon
r_else
id|split
op_assign
l_int|0
suffix:semicolon
id|audbytes
op_assign
l_int|2048
suffix:semicolon
r_if
c_cond
(paren
id|split
OG
l_int|0
op_logical_and
id|split
OL
l_int|2048
)paren
(brace
id|memcpy
c_func
(paren
id|saa-&gt;dmadebi
comma
id|saa-&gt;audbuf
op_plus
id|saa-&gt;audhead
comma
id|split
)paren
suffix:semicolon
id|saa-&gt;audhead
op_assign
l_int|0
suffix:semicolon
id|audbytes
op_sub_assign
id|split
suffix:semicolon
)brace
r_else
id|split
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|saa-&gt;dmadebi
op_plus
id|split
comma
id|saa-&gt;audbuf
op_plus
id|saa-&gt;audhead
comma
id|audbytes
)paren
suffix:semicolon
id|saa-&gt;audhead
op_add_assign
id|audbytes
suffix:semicolon
id|saa-&gt;audhead
op_and_assign
l_int|0xffff
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debAudio
comma
(paren
id|NewCard
ques
c_cond
id|IBM_MP2_AUD_FIFO
suffix:colon
id|IBM_MP2_AUD_FIFOW
)paren
comma
l_int|0
comma
l_int|2048
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|saa-&gt;audq
)paren
suffix:semicolon
multiline_comment|/* if at least 1 block video waiting and video fifo isn&squot;t full */
)brace
r_else
r_if
c_cond
(paren
id|vidbytes
op_ge
l_int|30720
op_logical_and
(paren
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_FIFO
comma
l_int|2
)paren
)paren
OL
l_int|16384
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;vidhead
OG
id|saa-&gt;vidtail
)paren
id|split
op_assign
l_int|524288
op_minus
id|saa-&gt;vidhead
suffix:semicolon
r_else
id|split
op_assign
l_int|0
suffix:semicolon
id|vidbytes
op_assign
l_int|30720
suffix:semicolon
r_if
c_cond
(paren
id|split
OG
l_int|0
op_logical_and
id|split
OL
l_int|30720
)paren
(brace
id|memcpy
c_func
(paren
id|saa-&gt;dmadebi
comma
id|saa-&gt;vidbuf
op_plus
id|saa-&gt;vidhead
comma
id|split
)paren
suffix:semicolon
id|saa-&gt;vidhead
op_assign
l_int|0
suffix:semicolon
id|vidbytes
op_sub_assign
id|split
suffix:semicolon
)brace
r_else
id|split
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|saa-&gt;dmadebi
op_plus
id|split
comma
id|saa-&gt;vidbuf
op_plus
id|saa-&gt;vidhead
comma
id|vidbytes
)paren
suffix:semicolon
id|saa-&gt;vidhead
op_add_assign
id|vidbytes
suffix:semicolon
id|saa-&gt;vidhead
op_and_assign
l_int|0x7ffff
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debVideo
comma
(paren
id|NewCard
ques
c_cond
id|IBM_MP2_FIFO
suffix:colon
id|IBM_MP2_FIFOW
)paren
comma
l_int|0
comma
l_int|30720
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|saa-&gt;vidq
)paren
suffix:semicolon
)brace
id|saawrite
c_func
(paren
id|SAA7146_PSR_DEBI_S
op_or
id|SAA7146_PSR_PIN1
comma
id|SAA7146_IER
)paren
suffix:semicolon
)brace
DECL|function|send_osd_data
r_static
r_void
id|send_osd_data
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
r_int
id|size
op_assign
id|saa-&gt;osdtail
op_minus
id|saa-&gt;osdhead
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
l_int|30720
)paren
id|size
op_assign
l_int|30720
suffix:semicolon
multiline_comment|/* ensure some multiple of 8 bytes is transferred */
id|size
op_assign
l_int|8
op_star
(paren
(paren
id|size
op_plus
l_int|8
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
)paren
(brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_ADDR
comma
(paren
id|saa-&gt;osdhead
op_rshift
l_int|3
)paren
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|saa-&gt;dmadebi
comma
op_amp
id|saa-&gt;osdbuf
(braket
id|saa-&gt;osdhead
)braket
comma
id|size
)paren
suffix:semicolon
id|saa-&gt;osdhead
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* block transfer of next 8 bytes to ~32k bytes */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_DATA
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|saa-&gt;osdhead
op_ge
id|saa-&gt;osdtail
)paren
(brace
id|saa-&gt;osdhead
op_assign
id|saa-&gt;osdtail
op_assign
l_int|0
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_MASK0
comma
l_int|0xc00c
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
DECL|function|saa7146_irq
r_static
r_void
id|saa7146_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|stat
comma
id|astat
suffix:semicolon
r_int
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* get/clear interrupt status bits */
id|stat
op_assign
id|saaread
c_func
(paren
id|SAA7146_ISR
)paren
suffix:semicolon
id|astat
op_assign
id|stat
op_amp
id|saaread
c_func
(paren
id|SAA7146_IER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|astat
)paren
r_return
suffix:semicolon
id|saawrite
c_func
(paren
id|astat
comma
id|SAA7146_ISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_DEBI_S
)paren
(brace
id|do_irq_send_data
c_func
(paren
id|saa
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PIN1
)paren
(brace
r_int
id|istat
suffix:semicolon
multiline_comment|/* the following read will trigger DEBI_S */
id|istat
op_assign
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_HOST_INT
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|istat
op_amp
l_int|1
)paren
(brace
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|send_osd_data
c_func
(paren
id|saa
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|SAA7146_PSR_DEBI_S
op_or
id|SAA7146_PSR_PIN1
comma
id|SAA7146_IER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* Video Start */
id|saa-&gt;vidinfo.frame_count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x400
)paren
(brace
multiline_comment|/* Picture Start */
multiline_comment|/* update temporal reference */
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x200
)paren
(brace
multiline_comment|/* Picture Resolution Change */
multiline_comment|/* read new resolution */
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x100
)paren
(brace
multiline_comment|/* New User Data found */
multiline_comment|/* read new user data */
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x1000
)paren
(brace
multiline_comment|/* new GOP/SMPTE */
multiline_comment|/* read new SMPTE */
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* Sequence Start Code */
multiline_comment|/* reset frame counter, load sizes */
id|saa-&gt;vidinfo.frame_count
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;vidinfo.h_size
op_assign
l_int|704
suffix:semicolon
id|saa-&gt;vidinfo.v_size
op_assign
l_int|480
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|saa-&gt;endmarkhead
op_ne
id|saa-&gt;endmarktail
)paren
(brace
id|saa-&gt;audhead
op_assign
id|saa-&gt;endmark
(braket
id|saa-&gt;endmarkhead
)braket
suffix:semicolon
id|saa-&gt;endmarkhead
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;endmarkhead
op_ge
id|MAX_MARKS
)paren
id|saa-&gt;endmarkhead
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
r_if
c_cond
(paren
id|istat
op_amp
l_int|0x4000
)paren
(brace
multiline_comment|/* Sequence Error Code */
r_if
c_cond
(paren
id|saa-&gt;endmarkhead
op_ne
id|saa-&gt;endmarktail
)paren
(brace
id|saa-&gt;audhead
op_assign
id|saa-&gt;endmark
(braket
id|saa-&gt;endmarkhead
)braket
suffix:semicolon
id|saa-&gt;endmarkhead
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;endmarkhead
op_ge
id|MAX_MARKS
)paren
id|saa-&gt;endmarkhead
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef IDEBUG
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PPEF
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: PPEF&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PABO
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: PABO&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PPED
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: PPED&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_I1
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_I1&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_I0
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_I0&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_LATE1
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_LATE1&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_LATE0
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_LATE0&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_E1
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_E1&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_E0
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_E0&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_TO1
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_TO1&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_RPS_TO0
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: RPS_TO0&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_UPLD
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: UPLD&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_DEBI_E
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: DEBI_E&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_I2C_S
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: I2C_S&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_I2C_E
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: I2C_E&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_A2_IN
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: A2_IN&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_A2_OUT
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: A2_OUT&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_A1_IN
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: A1_IN&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_A1_OUT
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: A1_OUT&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_AFOU
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: AFOU&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_V_PE
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: V_PE&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_VFOU
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: VFOU&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_FIDA
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: FIDA&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_FIDB
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: FIDB&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PIN3
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: PIN3&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PIN2
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: PIN2&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_PIN0
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: PIN0&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_ECS
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: ECS&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_EC3S
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: EC3S&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|SAA7146_PSR_EC0S
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;stradis%d irq: EC0S&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|15
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;stradis%d: irq loop %d&bslash;n&quot;
comma
id|saa-&gt;nr
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: IRQ loop cleared&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|ibm_send_command
r_static
r_int
id|ibm_send_command
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|command
comma
r_int
id|data
comma
r_int
id|chain
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|chain
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_COMMAND
comma
(paren
id|command
op_lshift
l_int|1
)paren
op_or
l_int|1
comma
l_int|2
)paren
suffix:semicolon
r_else
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_COMMAND
comma
id|command
op_lshift
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CMD_DATA
comma
id|data
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CMD_STAT
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
op_logical_and
(paren
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CMD_STAT
comma
l_int|2
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cs4341_setlevel
r_static
r_void
id|cs4341_setlevel
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|left
comma
r_int
id|right
)paren
(brace
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x03
comma
id|left
OG
l_int|94
ques
c_cond
l_int|94
suffix:colon
id|left
comma
l_int|2
)paren
suffix:semicolon
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x04
comma
id|right
OG
l_int|94
ques
c_cond
l_int|94
suffix:colon
id|right
comma
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|initialize_cs4341
r_static
r_void
id|initialize_cs4341
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|200
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* auto mute off, power on, no de-emphasis */
multiline_comment|/* I2S data up to 24-bit 64xFs internal SCLK */
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x01
comma
l_int|0x11
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* ATAPI mixer setings */
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x02
comma
l_int|0x49
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* attenuation left 3db */
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* attenuation right 3db */
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x04
comma
l_int|0x00
comma
l_int|2
)paren
suffix:semicolon
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x01
comma
l_int|0x10
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x22
comma
l_int|0x02
comma
l_int|1
)paren
op_eq
l_int|0x49
)paren
r_break
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;stradis%d: CS4341 initialized (%d)&bslash;n&quot;
comma
id|saa-&gt;nr
comma
id|i
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|initialize_cs8420
r_static
r_void
id|initialize_cs8420
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|pro
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
op_star
id|sequence
suffix:semicolon
r_if
c_cond
(paren
id|pro
)paren
id|sequence
op_assign
id|mode8420pro
suffix:semicolon
r_else
id|sequence
op_assign
id|mode8420con
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|INIT8420LEN
suffix:semicolon
id|i
op_increment
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x20
comma
id|init8420
(braket
id|i
op_star
l_int|2
)braket
comma
id|init8420
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
comma
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MODE8420LEN
suffix:semicolon
id|i
op_increment
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x20
comma
id|sequence
(braket
id|i
op_star
l_int|2
)braket
comma
id|sequence
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
comma
l_int|2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;stradis%d: CS8420 initialized&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
)brace
DECL|function|initialize_saa7121
r_static
r_void
id|initialize_saa7121
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|dopal
)paren
(brace
r_int
id|i
comma
id|mod
suffix:semicolon
id|u8
op_star
id|sequence
suffix:semicolon
r_if
c_cond
(paren
id|dopal
)paren
id|sequence
op_assign
id|init7121pal
suffix:semicolon
r_else
id|sequence
op_assign
id|init7121ntsc
suffix:semicolon
id|mod
op_assign
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
op_amp
l_int|0x08
suffix:semicolon
multiline_comment|/* initialize PAL/NTSC video encoder */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|INIT7121LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|NewCard
)paren
(brace
multiline_comment|/* handle new card encoder differences */
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x3a
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x3a
comma
l_int|0x13
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x6b
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x6b
comma
l_int|0x20
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x6c
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x6c
comma
id|dopal
ques
c_cond
l_int|0x09
suffix:colon
l_int|0xf5
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x6d
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x6d
comma
id|dopal
ques
c_cond
l_int|0x20
suffix:colon
l_int|0x00
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x7a
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x7a
comma
id|dopal
ques
c_cond
(paren
id|PALFirstActive
op_minus
l_int|1
)paren
suffix:colon
(paren
id|NTSCFirstActive
op_minus
l_int|4
)paren
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x7b
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x7b
comma
id|dopal
ques
c_cond
id|PALLastActive
suffix:colon
id|NTSCLastActive
comma
l_int|2
)paren
suffix:semicolon
r_else
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
id|sequence
(braket
id|i
op_star
l_int|2
)braket
comma
id|sequence
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x6b
op_logical_and
id|mod
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x6b
comma
(paren
id|sequence
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
op_xor
l_int|0x09
)paren
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x7a
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x7a
comma
id|dopal
ques
c_cond
(paren
id|PALFirstActive
op_minus
l_int|1
)paren
suffix:colon
(paren
id|NTSCFirstActive
op_minus
l_int|4
)paren
comma
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sequence
(braket
id|i
op_star
l_int|2
)braket
op_eq
l_int|0x7b
)paren
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
l_int|0x7b
comma
id|dopal
ques
c_cond
id|PALLastActive
suffix:colon
id|NTSCLastActive
comma
l_int|2
)paren
suffix:semicolon
r_else
id|I2CWrite
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
l_int|0x88
comma
id|sequence
(braket
id|i
op_star
l_int|2
)braket
comma
id|sequence
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|set_genlock_offset
r_static
r_void
id|set_genlock_offset
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|noffset
)paren
(brace
r_int
id|nCode
suffix:semicolon
r_int
id|PixelsPerLine
op_assign
l_int|858
suffix:semicolon
r_if
c_cond
(paren
id|CurrentMode
op_eq
id|VIDEO_MODE_PAL
)paren
id|PixelsPerLine
op_assign
l_int|864
suffix:semicolon
r_if
c_cond
(paren
id|noffset
OG
l_int|500
)paren
id|noffset
op_assign
l_int|500
suffix:semicolon
r_else
r_if
c_cond
(paren
id|noffset
OL
op_minus
l_int|500
)paren
id|noffset
op_assign
op_minus
l_int|500
suffix:semicolon
id|nCode
op_assign
id|noffset
op_plus
l_int|0x100
suffix:semicolon
r_if
c_cond
(paren
id|nCode
op_eq
l_int|1
)paren
id|nCode
op_assign
l_int|0x401
suffix:semicolon
r_else
r_if
c_cond
(paren
id|nCode
OL
l_int|1
)paren
id|nCode
op_assign
l_int|0x400
op_plus
id|PixelsPerLine
op_plus
id|nCode
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_GLDELAY
comma
id|nCode
comma
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|set_out_format
r_static
r_void
id|set_out_format
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|mode
)paren
(brace
id|initialize_saa7121
c_func
(paren
id|saa
comma
(paren
id|mode
op_eq
id|VIDEO_MODE_NTSC
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
)paren
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|2
)braket
op_assign
id|mode
suffix:semicolon
multiline_comment|/* do not adjust analog video parameters here, use saa7121 init */
multiline_comment|/* you will affect the SDI output on the new card */
r_if
c_cond
(paren
id|mode
op_eq
id|VIDEO_MODE_PAL
)paren
(brace
multiline_comment|/* PAL */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x0808
comma
l_int|2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x012002c0
comma
id|SAA7146_NUM_LINE_BYTE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
(brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_MODE
comma
l_int|0xe100
comma
l_int|2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_MODE
comma
id|NewCard
ques
c_cond
l_int|0xe500
suffix:colon
l_int|0x6500
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_DLY
comma
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
id|NewCard
ques
c_cond
id|PALFirstActive
suffix:colon
id|PALFirstActive
op_minus
l_int|6
)paren
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* NTSC */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x0800
comma
l_int|2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00f002c0
comma
id|SAA7146_NUM_LINE_BYTE1
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_MODE
comma
id|NewCard
ques
c_cond
l_int|0xe100
suffix:colon
l_int|0x6100
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_DLY
comma
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
id|NewCard
ques
c_cond
id|NTSCFirstActive
suffix:colon
id|NTSCFirstActive
op_minus
l_int|6
)paren
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Intialize bitmangler to map from a byte value to the mangled word that&n; * must be output to program the Xilinx part through the DEBI port.&n; * Xilinx Data Bit-&gt;DEBI Bit: 0-&gt;15 1-&gt;7 2-&gt;6 3-&gt;12 4-&gt;11 5-&gt;2 6-&gt;1 7-&gt;0&n; * transfer FPGA code, init IBM chip, transfer IBM microcode&n; * rev2 card mangles: 0-&gt;7 1-&gt;6 2-&gt;5 3-&gt;4 4-&gt;3 5-&gt;2 6-&gt;1 7-&gt;0&n; */
DECL|variable|bitmangler
r_static
id|u16
id|bitmangler
(braket
l_int|256
)braket
suffix:semicolon
DECL|function|initialize_fpga
r_static
r_int
id|initialize_fpga
c_func
(paren
r_struct
id|video_code
op_star
id|bitdata
)paren
(brace
r_int
id|i
comma
id|num
comma
id|startindex
comma
id|failure
op_assign
l_int|0
comma
id|loadtwo
comma
id|loadfile
op_assign
l_int|0
suffix:semicolon
id|u16
op_star
id|dmabuf
suffix:semicolon
id|u8
op_star
id|newdma
suffix:semicolon
r_struct
id|saa7146
op_star
id|saa
suffix:semicolon
multiline_comment|/* verify fpga code */
r_for
c_loop
(paren
id|startindex
op_assign
l_int|0
suffix:semicolon
id|startindex
OL
id|bitdata-&gt;datasize
suffix:semicolon
id|startindex
op_increment
)paren
r_if
c_cond
(paren
id|bitdata-&gt;data
(braket
id|startindex
)braket
op_eq
l_int|255
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|startindex
op_eq
id|bitdata-&gt;datasize
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis: bad fpga code&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* initialize all detected cards */
r_for
c_loop
(paren
id|num
op_assign
l_int|0
suffix:semicolon
id|num
OL
id|saa_num
suffix:semicolon
id|num
op_increment
)paren
(brace
id|saa
op_assign
op_amp
id|saa7146s
(braket
id|num
)braket
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
OG
l_int|20
)paren
r_continue
suffix:semicolon
multiline_comment|/* card was programmed */
id|loadtwo
op_assign
(paren
id|saa-&gt;boardcfg
(braket
l_int|18
)braket
op_amp
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|NewCard
)paren
multiline_comment|/* we have an old board */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|bitmangler
(braket
id|i
)braket
op_assign
(paren
(paren
id|i
op_amp
l_int|0x01
)paren
op_lshift
l_int|15
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x02
)paren
op_lshift
l_int|6
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x04
)paren
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x08
)paren
op_lshift
l_int|9
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x10
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x20
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x40
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x80
)paren
op_rshift
l_int|7
)paren
suffix:semicolon
r_else
multiline_comment|/* else we have a new board */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|bitmangler
(braket
id|i
)braket
op_assign
(paren
(paren
id|i
op_amp
l_int|0x01
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x02
)paren
op_lshift
l_int|5
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x04
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x08
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x10
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x20
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x40
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x80
)paren
op_rshift
l_int|7
)paren
suffix:semicolon
id|dmabuf
op_assign
(paren
id|u16
op_star
)paren
id|saa-&gt;dmadebi
suffix:semicolon
id|newdma
op_assign
(paren
id|u8
op_star
)paren
id|saa-&gt;dmadebi
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
(brace
multiline_comment|/* SDM2xxx */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|bitdata-&gt;loadwhat
comma
l_string|&quot;decoder2&quot;
comma
l_int|8
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* fpga not for this card */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
op_amp
id|saa-&gt;boardcfg
(braket
l_int|42
)braket
comma
id|bitdata-&gt;loadwhat
comma
l_int|8
)paren
)paren
(brace
id|loadfile
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|loadtwo
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
op_amp
id|saa-&gt;boardcfg
(braket
l_int|19
)braket
comma
id|bitdata-&gt;loadwhat
comma
l_int|8
)paren
)paren
(brace
id|loadfile
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;boardcfg
(braket
l_int|42
)braket
op_logical_and
multiline_comment|/* special */
op_logical_neg
id|strncmp
c_func
(paren
l_string|&quot;decxl&quot;
comma
id|bitdata-&gt;loadwhat
comma
l_int|8
)paren
)paren
(brace
id|loadfile
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_continue
suffix:semicolon
multiline_comment|/* fpga not for this card */
r_if
c_cond
(paren
id|loadfile
op_ne
l_int|1
op_logical_and
id|loadfile
op_ne
l_int|2
)paren
(brace
r_continue
suffix:semicolon
multiline_comment|/* skip to next card */
)brace
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_logical_and
id|loadfile
op_eq
l_int|1
)paren
r_continue
suffix:semicolon
multiline_comment|/* skip to next card */
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_ne
l_int|1
op_logical_and
id|loadfile
op_eq
l_int|2
)paren
r_continue
suffix:semicolon
multiline_comment|/* skip to next card */
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_increment
suffix:semicolon
multiline_comment|/* mark fpga handled */
id|printk
c_func
(paren
l_string|&quot;stradis%d: loading %s&bslash;n&quot;
comma
id|saa-&gt;nr
comma
id|bitdata-&gt;loadwhat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loadtwo
op_logical_and
id|loadfile
op_eq
l_int|2
)paren
r_goto
id|send_fpga_stuff
suffix:semicolon
multiline_comment|/* turn on the Audio interface to set PROG low */
id|saawrite
c_func
(paren
l_int|0x00400040
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* ensure posted write */
multiline_comment|/* wait for everyone to reset */
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00400000
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* original card */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|bitdata-&gt;loadwhat
comma
l_string|&quot;decoder2&quot;
comma
l_int|8
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* fpga not for this card */
multiline_comment|/* Pull the Xilinx PROG signal WS3 low */
id|saawrite
c_func
(paren
l_int|0x02000200
comma
id|SAA7146_MC1
)paren
suffix:semicolon
multiline_comment|/* Turn on the Audio interface so can set PROG low */
id|saawrite
c_func
(paren
l_int|0x000000c0
comma
id|SAA7146_ACON1
)paren
suffix:semicolon
multiline_comment|/* Pull the Xilinx INIT signal (GPIO2) low */
id|saawrite
c_func
(paren
l_int|0x00400000
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
multiline_comment|/* Make sure everybody resets */
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* ensure posted write */
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Release the Xilinx PROG signal */
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_ACON1
)paren
suffix:semicolon
multiline_comment|/* Turn off the Audio interface */
id|saawrite
c_func
(paren
l_int|0x02000000
comma
id|SAA7146_MC1
)paren
suffix:semicolon
)brace
multiline_comment|/* Release Xilinx INIT signal (WS2) */
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
multiline_comment|/* Wait for the INIT to go High */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
op_amp
id|SAA7146_PSR_PIN2
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: no fpga INIT&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|send_fpga_stuff
suffix:colon
r_if
c_cond
(paren
id|NewCard
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|startindex
suffix:semicolon
id|i
OL
id|bitdata-&gt;datasize
suffix:semicolon
id|i
op_increment
)paren
id|newdma
(braket
id|i
op_minus
id|startindex
)braket
op_assign
id|bitmangler
(braket
id|bitdata-&gt;data
(braket
id|i
)braket
)braket
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
l_int|0x01420000
comma
l_int|0
comma
l_int|0
comma
(paren
(paren
id|bitdata-&gt;datasize
op_minus
id|startindex
)paren
op_plus
l_int|5
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loadtwo
)paren
(brace
r_if
c_cond
(paren
id|loadfile
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;stradis%d: &quot;
l_string|&quot;awaiting 2nd FPGA bitfile&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* skip to next card */
)brace
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
id|startindex
suffix:semicolon
id|i
OL
id|bitdata-&gt;datasize
suffix:semicolon
id|i
op_increment
)paren
id|dmabuf
(braket
id|i
op_minus
id|startindex
)braket
op_assign
id|bitmangler
(braket
id|bitdata-&gt;data
(braket
id|i
)braket
)braket
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
l_int|0x014a0000
comma
l_int|0
comma
l_int|0
comma
(paren
(paren
id|bitdata-&gt;datasize
op_minus
id|startindex
)paren
op_plus
l_int|5
)paren
op_star
l_int|2
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
op_amp
id|SAA7146_PSR_PIN2
)paren
suffix:semicolon
id|i
op_increment
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: FPGA load failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|failure
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|NewCard
)paren
(brace
multiline_comment|/* Pull the Xilinx INIT signal (GPIO2) low */
id|saawrite
c_func
(paren
l_int|0x00400000
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* ensure posted write */
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: FPGA Loaded&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_assign
l_int|26
suffix:semicolon
multiline_comment|/* mark fpga programmed */
multiline_comment|/* set VXCO to its lowest frequency */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_PWM
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
(brace
multiline_comment|/* mute CS3310 */
r_if
c_cond
(paren
id|HaveCS3310
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CS3310_CMPLT
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* set VXCO to PWM mode, release reset, blank on */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0xffc4
comma
l_int|2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* unmute CS3310 */
r_if
c_cond
(paren
id|HaveCS3310
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x2020
comma
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* set source Black */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x1707
comma
l_int|2
)paren
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|4
)braket
op_assign
l_int|22
suffix:semicolon
multiline_comment|/* set NTSC First Active Line */
id|saa-&gt;boardcfg
(braket
l_int|5
)braket
op_assign
l_int|23
suffix:semicolon
multiline_comment|/* set PAL First Active Line */
id|saa-&gt;boardcfg
(braket
l_int|54
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* set NTSC Last Active Line - 256 */
id|saa-&gt;boardcfg
(braket
l_int|55
)braket
op_assign
l_int|54
suffix:semicolon
multiline_comment|/* set PAL Last Active Line - 256 */
id|set_out_format
c_func
(paren
id|saa
comma
id|VIDEO_MODE_NTSC
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* begin IBM chip init */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|4
comma
l_int|2
)paren
suffix:semicolon
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* wait for reset */
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|0x10
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CMD_ADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_MODE
comma
l_int|0x2e
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
(brace
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* set i2s rate converter to 48KHz */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
l_int|0x80c0
comma
l_int|6
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* we must init CS8420 first since rev b pulls i2s */
multiline_comment|/* master clock low and CS4341 needs i2s master to */
multiline_comment|/* run the i2c port. */
r_if
c_cond
(paren
id|HaveCS8420
)paren
(brace
multiline_comment|/* 0=consumer, 1=pro */
id|initialize_cs8420
c_func
(paren
id|saa
comma
l_int|0
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HaveCS4341
)paren
id|initialize_cs4341
c_func
(paren
id|saa
)paren
suffix:semicolon
)brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_INFC_CTL
comma
l_int|0x48
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_BEEP_CTL
comma
l_int|0xa000
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_LBOR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_TBOR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
id|set_genlock_offset
c_func
(paren
id|saa
comma
l_int|0
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_FRNT_ATTEN
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* enable genlock */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x8000
comma
l_int|2
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* disable genlock */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x8080
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|failure
suffix:semicolon
)brace
DECL|function|do_ibm_reset
r_static
r_int
id|do_ibm_reset
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
multiline_comment|/* failure if decoder not previously programmed */
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
OL
l_int|37
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* mute CS3310 */
r_if
c_cond
(paren
id|HaveCS3310
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CS3310_CMPLT
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|saa-&gt;audhead
op_assign
id|saa-&gt;audtail
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;vidhead
op_assign
id|saa-&gt;vidtail
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* tristate debi bus, disable debi transfers */
id|saawrite
c_func
(paren
l_int|0x00880000
comma
id|SAA7146_MC1
)paren
suffix:semicolon
multiline_comment|/* ensure posted write */
id|saaread
c_func
(paren
id|SAA7146_MC1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* re-enable debi transfers */
id|saawrite
c_func
(paren
l_int|0x00880088
comma
id|SAA7146_MC1
)paren
suffix:semicolon
multiline_comment|/* set source Black */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x1707
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* begin IBM chip init */
id|set_out_format
c_func
(paren
id|saa
comma
id|CurrentMode
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|4
comma
l_int|2
)paren
suffix:semicolon
id|saaread
c_func
(paren
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* wait for reset */
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_MODE
comma
l_int|0x2e
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
(brace
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* set i2s rate converter to 48KHz */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
l_int|0x80c0
comma
l_int|6
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* we must init CS8420 first since rev b pulls i2s */
multiline_comment|/* master clock low and CS4341 needs i2s master to */
multiline_comment|/* run the i2c port. */
r_if
c_cond
(paren
id|HaveCS8420
)paren
(brace
multiline_comment|/* 0=consumer, 1=pro */
id|initialize_cs8420
c_func
(paren
id|saa
comma
l_int|1
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HaveCS4341
)paren
id|initialize_cs4341
c_func
(paren
id|saa
)paren
suffix:semicolon
)brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_INFC_CTL
comma
l_int|0x48
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_BEEP_CTL
comma
l_int|0xa000
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_LBOR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_TBOR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
id|set_genlock_offset
c_func
(paren
id|saa
comma
l_int|0
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_FRNT_ATTEN
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_SIZE
comma
l_int|0x2000
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_CTL
comma
l_int|0x4552
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_CONFIG_DECODER
comma
(paren
id|ChipControl
op_eq
l_int|0x43
ques
c_cond
l_int|0xe800
suffix:colon
l_int|0xe000
)paren
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: IBM config failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HaveCS3310
)paren
(brace
r_int
id|i
op_assign
id|CS3310MaxLvl
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CS3310_CMPLT
comma
(paren
(paren
id|i
op_lshift
l_int|8
)paren
op_or
id|i
)paren
comma
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* start video decoder */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 256k vid, 3520 bytes aud */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_RB_THRESHOLD
comma
l_int|0x4037
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_CTL
comma
l_int|0x4573
comma
l_int|2
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_PLAY
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* enable buffer threshold irq */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_MASK0
comma
l_int|0xc00c
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* clear pending interrupts */
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_HOST_INT
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x1711
comma
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* load the decoder microcode */
DECL|function|initialize_ibmmpeg2
r_static
r_int
id|initialize_ibmmpeg2
c_func
(paren
r_struct
id|video_code
op_star
id|microcode
)paren
(brace
r_int
id|i
comma
id|num
suffix:semicolon
r_struct
id|saa7146
op_star
id|saa
suffix:semicolon
r_for
c_loop
(paren
id|num
op_assign
l_int|0
suffix:semicolon
id|num
OL
id|saa_num
suffix:semicolon
id|num
op_increment
)paren
(brace
id|saa
op_assign
op_amp
id|saa7146s
(braket
id|num
)braket
suffix:semicolon
multiline_comment|/* check that FPGA is loaded */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_SIZE
comma
l_int|0xa55a
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_SIZE
comma
l_int|2
)paren
)paren
op_ne
l_int|0xa55a
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: %04x != 0xa55a&bslash;n&quot;
comma
id|saa-&gt;nr
comma
id|i
)paren
suffix:semicolon
macro_line|#if 0
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|microcode-&gt;loadwhat
comma
l_string|&quot;decoder.vid&quot;
comma
l_int|11
)paren
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
OG
l_int|27
)paren
r_continue
suffix:semicolon
multiline_comment|/* skip to next card */
multiline_comment|/* load video control store */
id|saa-&gt;boardcfg
(braket
l_int|1
)braket
op_assign
l_int|0x13
suffix:semicolon
multiline_comment|/* no-sync default */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_WR_PROT
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_PROC_IADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|microcode-&gt;datasize
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_PROC_IDATA
comma
(paren
id|microcode-&gt;data
(braket
id|i
op_star
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|microcode-&gt;data
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_PROC_IADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_WR_PROT
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_assign
l_int|28
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|microcode-&gt;loadwhat
comma
l_string|&quot;decoder.aud&quot;
comma
l_int|11
)paren
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
OG
l_int|35
)paren
r_continue
suffix:semicolon
multiline_comment|/* skip to next card */
multiline_comment|/* load audio control store */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_WR_PROT
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_IADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|microcode-&gt;datasize
suffix:semicolon
id|i
op_increment
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_IDATA
comma
id|microcode-&gt;data
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_IADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_WR_PROT
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_SIZE
comma
l_int|0x2000
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_CTL
comma
l_int|0x4552
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_CONFIG_DECODER
comma
l_int|0xe000
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: IBM config failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* set PWM to center value */
r_if
c_cond
(paren
id|NewCard
)paren
(brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_PWM
comma
id|saa-&gt;boardcfg
(braket
l_int|14
)braket
op_plus
(paren
id|saa-&gt;boardcfg
(braket
l_int|13
)braket
op_lshift
l_int|8
)paren
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_PWM
comma
l_int|0x46
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HaveCS3310
)paren
(brace
id|i
op_assign
id|CS3310MaxLvl
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CS3310_CMPLT
comma
(paren
(paren
id|i
op_lshift
l_int|8
)paren
op_or
id|i
)paren
comma
l_int|2
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: IBM MPEGCD%d Initialized&bslash;n&quot;
comma
id|saa-&gt;nr
comma
l_int|18
op_plus
(paren
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|2
)paren
op_rshift
l_int|12
)paren
)paren
suffix:semicolon
multiline_comment|/* start video decoder */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_RB_THRESHOLD
comma
l_int|0x4037
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 256k vid, 3520 bytes aud */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_AUD_CTL
comma
l_int|0x4573
comma
l_int|2
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_PLAY
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* enable buffer threshold irq */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_MASK0
comma
l_int|0xc00c
comma
l_int|2
)paren
suffix:semicolon
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_HOST_INT
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* enable gpio irq */
id|saawrite
c_func
(paren
l_int|0x00002000
comma
id|SAA7146_GPIO_CTRL
)paren
suffix:semicolon
multiline_comment|/* enable decoder output to HPS */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
l_int|0x1711
comma
l_int|2
)paren
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|0
)braket
op_assign
l_int|37
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|palette2fmt
r_static
id|u32
id|palette2fmt
(braket
)braket
op_assign
(brace
multiline_comment|/* some of these YUV translations are wrong */
l_int|0xffffffff
comma
l_int|0x86000000
comma
l_int|0x87000000
comma
l_int|0x80000000
comma
l_int|0x8100000
comma
l_int|0x82000000
comma
l_int|0x83000000
comma
l_int|0x00000000
comma
l_int|0x03000000
comma
l_int|0x03000000
comma
l_int|0x0a00000
comma
l_int|0x03000000
comma
l_int|0x06000000
comma
l_int|0x00000000
comma
l_int|0x03000000
comma
l_int|0x0a000000
comma
l_int|0x0300000
)brace
suffix:semicolon
DECL|variable|bpp2fmt
r_static
r_int
id|bpp2fmt
(braket
l_int|4
)braket
op_assign
(brace
id|VIDEO_PALETTE_HI240
comma
id|VIDEO_PALETTE_RGB565
comma
id|VIDEO_PALETTE_RGB24
comma
id|VIDEO_PALETTE_RGB32
)brace
suffix:semicolon
multiline_comment|/* I wish I could find a formula to calculate these... */
DECL|variable|h_prescale
r_static
id|u32
id|h_prescale
(braket
l_int|64
)braket
op_assign
(brace
l_int|0x10000000
comma
l_int|0x18040202
comma
l_int|0x18080000
comma
l_int|0x380c0606
comma
l_int|0x38100204
comma
l_int|0x38140808
comma
l_int|0x38180000
comma
l_int|0x381c0000
comma
l_int|0x3820161c
comma
l_int|0x38242a3b
comma
l_int|0x38281230
comma
l_int|0x382c4460
comma
l_int|0x38301040
comma
l_int|0x38340080
comma
l_int|0x38380000
comma
l_int|0x383c0000
comma
l_int|0x3840fefe
comma
l_int|0x3844ee9f
comma
l_int|0x3848ee9f
comma
l_int|0x384cee9f
comma
l_int|0x3850ee9f
comma
l_int|0x38542a3b
comma
l_int|0x38581230
comma
l_int|0x385c0000
comma
l_int|0x38600000
comma
l_int|0x38640000
comma
l_int|0x38680000
comma
l_int|0x386c0000
comma
l_int|0x38700000
comma
l_int|0x38740000
comma
l_int|0x38780000
comma
l_int|0x387c0000
comma
l_int|0x30800000
comma
l_int|0x38840000
comma
l_int|0x38880000
comma
l_int|0x388c0000
comma
l_int|0x38900000
comma
l_int|0x38940000
comma
l_int|0x38980000
comma
l_int|0x389c0000
comma
l_int|0x38a00000
comma
l_int|0x38a40000
comma
l_int|0x38a80000
comma
l_int|0x38ac0000
comma
l_int|0x38b00000
comma
l_int|0x38b40000
comma
l_int|0x38b80000
comma
l_int|0x38bc0000
comma
l_int|0x38c00000
comma
l_int|0x38c40000
comma
l_int|0x38c80000
comma
l_int|0x38cc0000
comma
l_int|0x38d00000
comma
l_int|0x38d40000
comma
l_int|0x38d80000
comma
l_int|0x38dc0000
comma
l_int|0x38e00000
comma
l_int|0x38e40000
comma
l_int|0x38e80000
comma
l_int|0x38ec0000
comma
l_int|0x38f00000
comma
l_int|0x38f40000
comma
l_int|0x38f80000
comma
l_int|0x38fc0000
comma
)brace
suffix:semicolon
DECL|variable|v_gain
r_static
id|u32
id|v_gain
(braket
l_int|64
)braket
op_assign
(brace
l_int|0x016000ff
comma
l_int|0x016100ff
comma
l_int|0x016100ff
comma
l_int|0x016200ff
comma
l_int|0x016200ff
comma
l_int|0x016200ff
comma
l_int|0x016200ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016300ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
l_int|0x016400ff
comma
)brace
suffix:semicolon
DECL|function|saa7146_set_winsize
r_static
r_void
id|saa7146_set_winsize
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
id|u32
id|format
suffix:semicolon
r_int
id|offset
comma
id|yacl
comma
id|ysci
suffix:semicolon
id|saa-&gt;win.color_fmt
op_assign
id|format
op_assign
(paren
id|saa-&gt;win.depth
op_eq
l_int|15
)paren
ques
c_cond
id|palette2fmt
(braket
id|VIDEO_PALETTE_RGB555
)braket
suffix:colon
id|palette2fmt
(braket
id|bpp2fmt
(braket
(paren
id|saa-&gt;win.bpp
op_minus
l_int|1
)paren
op_amp
l_int|3
)braket
)braket
suffix:semicolon
id|offset
op_assign
id|saa-&gt;win.x
op_star
id|saa-&gt;win.bpp
op_plus
id|saa-&gt;win.y
op_star
id|saa-&gt;win.bpl
suffix:semicolon
id|saawrite
c_func
(paren
id|saa-&gt;win.vidadr
op_plus
id|offset
comma
id|SAA7146_BASE_EVEN1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|saa-&gt;win.vidadr
op_plus
id|offset
op_plus
id|saa-&gt;win.bpl
comma
id|SAA7146_BASE_ODD1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|saa-&gt;win.bpl
op_star
l_int|2
comma
id|SAA7146_PITCH1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|saa-&gt;win.vidadr
op_plus
id|saa-&gt;win.bpl
op_star
id|saa-&gt;win.sheight
comma
id|SAA7146_PROT_ADDR1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_PAGE1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|format
op_or
l_int|0x60
comma
id|SAA7146_CLIP_FORMAT_CTRL
)paren
suffix:semicolon
id|offset
op_assign
(paren
l_int|704
op_div
(paren
id|saa-&gt;win.width
op_minus
l_int|1
)paren
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|saawrite
c_func
(paren
id|h_prescale
(braket
id|offset
)braket
comma
id|SAA7146_HPS_H_PRESCALE
)paren
suffix:semicolon
id|offset
op_assign
(paren
l_int|720896
op_div
id|saa-&gt;win.width
)paren
op_div
(paren
id|offset
op_plus
l_int|1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|offset
op_lshift
l_int|12
)paren
op_or
l_int|0x0c
comma
id|SAA7146_HPS_H_SCALE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CurrentMode
op_eq
id|VIDEO_MODE_NTSC
)paren
(brace
id|yacl
op_assign
multiline_comment|/*(480 / saa-&gt;win.height - 1) &amp; 0x3f*/
l_int|0
suffix:semicolon
id|ysci
op_assign
l_int|1024
op_minus
(paren
id|saa-&gt;win.height
op_star
l_int|1024
op_div
l_int|480
)paren
suffix:semicolon
)brace
r_else
(brace
id|yacl
op_assign
multiline_comment|/*(576 / saa-&gt;win.height - 1) &amp; 0x3f*/
l_int|0
suffix:semicolon
id|ysci
op_assign
l_int|1024
op_minus
(paren
id|saa-&gt;win.height
op_star
l_int|1024
op_div
l_int|576
)paren
suffix:semicolon
)brace
id|saawrite
c_func
(paren
(paren
l_int|1
op_lshift
l_int|31
)paren
op_or
(paren
id|ysci
op_lshift
l_int|21
)paren
op_or
(paren
id|yacl
op_lshift
l_int|15
)paren
comma
id|SAA7146_HPS_V_SCALE
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|v_gain
(braket
id|yacl
)braket
comma
id|SAA7146_HPS_V_GAIN
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
(paren
id|SAA7146_MC2_UPLD_DMA1
op_or
id|SAA7146_MC2_UPLD_HPS_V
op_or
id|SAA7146_MC2_UPLD_HPS_H
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|SAA7146_MC2_UPLD_DMA1
op_or
id|SAA7146_MC2_UPLD_HPS_V
op_or
id|SAA7146_MC2_UPLD_HPS_H
)paren
comma
id|SAA7146_MC2
)paren
suffix:semicolon
)brace
multiline_comment|/* clip_draw_rectangle(cm,x,y,w,h) -- handle clipping an area&n; * bitmap is fixed width, 128 bytes (1024 pixels represented) &n; * arranged most-sigificant-bit-left in 32-bit words &n; * based on saa7146 clipping hardware, it swaps bytes if LE &n; * much of this makes up for egcs brain damage -- so if you&n; * are wondering &quot;why did he do this?&quot; it is because the C&n; * was adjusted to generate the optimal asm output without&n; * writing non-portable __asm__ directives.&n; */
DECL|function|clip_draw_rectangle
r_static
r_void
id|clip_draw_rectangle
c_func
(paren
id|u32
op_star
id|clipmap
comma
r_int
id|x
comma
r_int
id|y
comma
r_int
id|w
comma
r_int
id|h
)paren
(brace
r_register
r_int
id|startword
comma
id|endword
suffix:semicolon
r_register
id|u32
id|bitsleft
comma
id|bitsright
suffix:semicolon
id|u32
op_star
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|x
OL
l_int|0
)paren
(brace
id|w
op_add_assign
id|x
suffix:semicolon
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
OL
l_int|0
)paren
(brace
id|h
op_add_assign
id|y
suffix:semicolon
id|y
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|w
op_le
l_int|0
op_logical_or
id|h
op_le
l_int|0
op_logical_or
id|x
OG
l_int|1023
op_logical_or
id|y
OG
l_int|639
)paren
r_return
suffix:semicolon
multiline_comment|/* throw away bad clips */
r_if
c_cond
(paren
id|x
op_plus
id|w
OG
l_int|1024
)paren
id|w
op_assign
l_int|1024
op_minus
id|x
suffix:semicolon
r_if
c_cond
(paren
id|y
op_plus
id|h
OG
l_int|640
)paren
id|h
op_assign
l_int|640
op_minus
id|y
suffix:semicolon
id|startword
op_assign
(paren
id|x
op_rshift
l_int|5
)paren
suffix:semicolon
id|endword
op_assign
(paren
(paren
id|x
op_plus
id|w
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|bitsleft
op_assign
(paren
l_int|0xffffffff
op_rshift
(paren
id|x
op_amp
l_int|31
)paren
)paren
suffix:semicolon
id|bitsright
op_assign
(paren
l_int|0xffffffff
op_lshift
(paren
op_complement
(paren
(paren
id|x
op_plus
id|w
)paren
op_minus
(paren
id|endword
op_lshift
l_int|5
)paren
)paren
)paren
)paren
suffix:semicolon
id|temp
op_assign
op_amp
id|clipmap
(braket
(paren
id|y
op_lshift
l_int|5
)paren
op_plus
id|startword
)braket
suffix:semicolon
id|w
op_assign
id|endword
op_minus
id|startword
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|w
)paren
(brace
id|bitsleft
op_or_assign
id|bitsright
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|h
suffix:semicolon
id|y
op_increment
)paren
(brace
op_star
id|temp
op_or_assign
id|bitsleft
suffix:semicolon
id|temp
op_add_assign
l_int|32
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|h
suffix:semicolon
id|y
op_increment
)paren
(brace
op_star
id|temp
op_increment
op_or_assign
id|bitsleft
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|1
suffix:semicolon
id|x
OL
id|w
suffix:semicolon
id|x
op_increment
)paren
op_star
id|temp
op_increment
op_assign
l_int|0xffffffff
suffix:semicolon
op_star
id|temp
op_or_assign
id|bitsright
suffix:semicolon
id|temp
op_add_assign
(paren
l_int|32
op_minus
id|w
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|make_clip_tab
r_static
r_void
id|make_clip_tab
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_struct
id|video_clip
op_star
id|cr
comma
r_int
id|ncr
)paren
(brace
r_int
id|i
comma
id|width
comma
id|height
suffix:semicolon
id|u32
op_star
id|clipmap
suffix:semicolon
id|clipmap
op_assign
id|saa-&gt;dmavid2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|width
op_assign
id|saa-&gt;win.width
)paren
OG
l_int|1023
)paren
(brace
id|width
op_assign
l_int|1023
suffix:semicolon
)brace
multiline_comment|/* sanity check */
r_if
c_cond
(paren
(paren
id|height
op_assign
id|saa-&gt;win.height
)paren
OG
l_int|640
)paren
(brace
id|height
op_assign
l_int|639
suffix:semicolon
)brace
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|ncr
OG
l_int|0
)paren
(brace
multiline_comment|/* rectangles pased */
multiline_comment|/* convert rectangular clips to a bitmap */
id|memset
c_func
(paren
id|clipmap
comma
l_int|0
comma
id|VIDEO_CLIPMAP_SIZE
)paren
suffix:semicolon
multiline_comment|/* clear map */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncr
suffix:semicolon
id|i
op_increment
)paren
id|clip_draw_rectangle
c_func
(paren
id|clipmap
comma
id|cr
(braket
id|i
)braket
dot
id|x
comma
id|cr
(braket
id|i
)braket
dot
id|y
comma
id|cr
(braket
id|i
)braket
dot
id|width
comma
id|cr
(braket
id|i
)braket
dot
id|height
)paren
suffix:semicolon
)brace
multiline_comment|/* clip against viewing window AND screen &n;&t;   so we do not have to rely on the user program&n;&t; */
id|clip_draw_rectangle
c_func
(paren
id|clipmap
comma
(paren
id|saa-&gt;win.x
op_plus
id|width
OG
id|saa-&gt;win.swidth
)paren
ques
c_cond
(paren
id|saa-&gt;win.swidth
op_minus
id|saa-&gt;win.x
)paren
suffix:colon
id|width
comma
l_int|0
comma
l_int|1024
comma
l_int|768
)paren
suffix:semicolon
id|clip_draw_rectangle
c_func
(paren
id|clipmap
comma
l_int|0
comma
(paren
id|saa-&gt;win.y
op_plus
id|height
OG
id|saa-&gt;win.sheight
)paren
ques
c_cond
(paren
id|saa-&gt;win.sheight
op_minus
id|saa-&gt;win.y
)paren
suffix:colon
id|height
comma
l_int|1024
comma
l_int|768
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.x
OL
l_int|0
)paren
id|clip_draw_rectangle
c_func
(paren
id|clipmap
comma
l_int|0
comma
l_int|0
comma
op_minus
(paren
id|saa-&gt;win.x
)paren
comma
l_int|768
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.y
OL
l_int|0
)paren
id|clip_draw_rectangle
c_func
(paren
id|clipmap
comma
l_int|0
comma
l_int|0
comma
l_int|1024
comma
op_minus
(paren
id|saa-&gt;win.y
)paren
)paren
suffix:semicolon
)brace
DECL|function|saa_ioctl
r_static
r_int
id|saa_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
id|saa-&gt;video_dev.name
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_CLIPPING
op_or
id|VID_TYPE_FRAMERAM
op_or
id|VID_TYPE_SCALES
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|1
suffix:semicolon
id|b.maxwidth
op_assign
l_int|768
suffix:semicolon
id|b.maxheight
op_assign
l_int|576
suffix:semicolon
id|b.minwidth
op_assign
l_int|32
suffix:semicolon
id|b.minheight
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
op_assign
id|saa-&gt;picture
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.depth
op_eq
l_int|8
)paren
id|p.palette
op_assign
id|VIDEO_PALETTE_HI240
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.depth
op_eq
l_int|15
)paren
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB555
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.depth
op_eq
l_int|16
)paren
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB565
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.depth
op_eq
l_int|24
)paren
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.depth
op_eq
l_int|32
)paren
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB32
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
id|u32
id|format
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|p.palette
OL
r_sizeof
(paren
id|palette2fmt
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
(brace
id|format
op_assign
id|palette2fmt
(braket
id|p.palette
)braket
suffix:semicolon
id|saa-&gt;win.color_fmt
op_assign
id|format
suffix:semicolon
id|saawrite
c_func
(paren
id|format
op_or
l_int|0x60
comma
id|SAA7146_CLIP_FORMAT_CTRL
)paren
suffix:semicolon
)brace
id|saawrite
c_func
(paren
(paren
(paren
id|p.brightness
op_amp
l_int|0xff00
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|p.contrast
op_amp
l_int|0xfe00
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|p.colour
op_amp
l_int|0xfe00
)paren
op_rshift
l_int|9
)paren
comma
id|SAA7146_BCS_CTRL
)paren
suffix:semicolon
id|saa-&gt;picture
op_assign
id|p
suffix:semicolon
multiline_comment|/* upload changed registers */
id|saawrite
c_func
(paren
(paren
(paren
id|SAA7146_MC2_UPLD_HPS_H
op_or
id|SAA7146_MC2_UPLD_HPS_V
)paren
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_HPS_H
op_or
id|SAA7146_MC2_UPLD_HPS_V
comma
id|SAA7146_MC2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_struct
id|video_clip
op_star
id|vcp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vw.flags
op_logical_or
id|vw.width
OL
l_int|16
op_logical_or
id|vw.height
OL
l_int|16
)paren
(brace
multiline_comment|/* stop capture */
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC1_TR_E_1
op_lshift
l_int|16
)paren
comma
id|SAA7146_MC1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|saa-&gt;win.bpp
OL
l_int|4
)paren
(brace
multiline_comment|/* 32-bit align start and adjust width */
r_int
id|i
op_assign
id|vw.x
suffix:semicolon
id|vw.x
op_assign
(paren
id|vw.x
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
id|i
op_assign
id|vw.x
op_minus
id|i
suffix:semicolon
id|vw.width
op_sub_assign
id|i
suffix:semicolon
)brace
id|saa-&gt;win.x
op_assign
id|vw.x
suffix:semicolon
id|saa-&gt;win.y
op_assign
id|vw.y
suffix:semicolon
id|saa-&gt;win.width
op_assign
id|vw.width
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;win.width
OG
l_int|768
)paren
id|saa-&gt;win.width
op_assign
l_int|768
suffix:semicolon
id|saa-&gt;win.height
op_assign
id|vw.height
suffix:semicolon
r_if
c_cond
(paren
id|CurrentMode
op_eq
id|VIDEO_MODE_NTSC
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;win.height
OG
l_int|480
)paren
id|saa-&gt;win.height
op_assign
l_int|480
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|saa-&gt;win.height
OG
l_int|576
)paren
id|saa-&gt;win.height
op_assign
l_int|576
suffix:semicolon
)brace
multiline_comment|/* stop capture */
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC1_TR_E_1
op_lshift
l_int|16
)paren
comma
id|SAA7146_MC1
)paren
suffix:semicolon
id|saa7146_set_winsize
c_func
(paren
id|saa
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *    Do any clips.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|vw.clipcount
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|saa-&gt;dmavid2
comma
id|vw.clips
comma
id|VIDEO_CLIPMAP_SIZE
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vw.clipcount
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|vcp
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
(paren
id|vw.clipcount
)paren
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|vcp
comma
id|vw.clips
comma
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
id|vw.clipcount
)paren
)paren
(brace
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* nothing clipped */
id|memset
c_func
(paren
id|saa-&gt;dmavid2
comma
l_int|0
comma
id|VIDEO_CLIPMAP_SIZE
)paren
suffix:semicolon
id|make_clip_tab
c_func
(paren
id|saa
comma
id|vcp
comma
id|vw.clipcount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
OG
l_int|0
)paren
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
multiline_comment|/* start capture &amp; clip dma if we have an address */
r_if
c_cond
(paren
(paren
id|saa-&gt;cap
op_amp
l_int|3
)paren
op_logical_and
id|saa-&gt;win.vidadr
op_ne
l_int|0
)paren
id|saawrite
c_func
(paren
(paren
(paren
id|SAA7146_MC1_TR_E_1
op_or
id|SAA7146_MC1_TR_E_2
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xffff
comma
id|SAA7146_MC1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|vw.x
op_assign
id|saa-&gt;win.x
suffix:semicolon
id|vw.y
op_assign
id|saa-&gt;win.y
suffix:semicolon
id|vw.width
op_assign
id|saa-&gt;win.width
suffix:semicolon
id|vw.height
op_assign
id|saa-&gt;win.height
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
l_int|0
)paren
(brace
id|saa-&gt;cap
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC1_TR_E_1
op_lshift
l_int|16
)paren
comma
id|SAA7146_MC1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|saa-&gt;win.vidadr
op_eq
l_int|0
op_logical_or
id|saa-&gt;win.width
op_eq
l_int|0
op_logical_or
id|saa-&gt;win.height
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|saa-&gt;cap
op_or_assign
l_int|1
suffix:semicolon
id|saawrite
c_func
(paren
(paren
id|SAA7146_MC1_TR_E_1
op_lshift
l_int|16
)paren
op_or
l_int|0xffff
comma
id|SAA7146_MC1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
id|v.base
op_assign
(paren
r_void
op_star
)paren
id|saa-&gt;win.vidadr
suffix:semicolon
id|v.height
op_assign
id|saa-&gt;win.sheight
suffix:semicolon
id|v.width
op_assign
id|saa-&gt;win.swidth
suffix:semicolon
id|v.depth
op_assign
id|saa-&gt;win.depth
suffix:semicolon
id|v.bytesperline
op_assign
id|saa-&gt;win.bpl
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.depth
op_ne
l_int|8
op_logical_and
id|v.depth
op_ne
l_int|15
op_logical_and
id|v.depth
op_ne
l_int|16
op_logical_and
id|v.depth
op_ne
l_int|24
op_logical_and
id|v.depth
op_ne
l_int|32
op_logical_and
id|v.width
OG
l_int|16
op_logical_and
id|v.height
OG
l_int|16
op_logical_and
id|v.bytesperline
OG
l_int|16
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|v.base
)paren
id|saa-&gt;win.vidadr
op_assign
(paren
r_int
r_int
)paren
id|v.base
suffix:semicolon
id|saa-&gt;win.sheight
op_assign
id|v.height
suffix:semicolon
id|saa-&gt;win.swidth
op_assign
id|v.width
suffix:semicolon
id|saa-&gt;win.bpp
op_assign
(paren
(paren
id|v.depth
op_plus
l_int|7
)paren
op_amp
l_int|0x38
)paren
op_div
l_int|8
suffix:semicolon
id|saa-&gt;win.depth
op_assign
id|v.depth
suffix:semicolon
id|saa-&gt;win.bpl
op_assign
id|v.bytesperline
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Display at %p is %d by %d, bytedepth %d, bpl %d&bslash;n&quot;
comma
id|v.base
comma
id|v.width
comma
id|v.height
comma
id|saa-&gt;win.bpp
comma
id|saa-&gt;win.bpl
)paren
)paren
suffix:semicolon
id|saa7146_set_winsize
c_func
(paren
id|saa
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
(brace
multiline_comment|/* Will be handled higher up .. */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
id|v
suffix:semicolon
id|v
op_assign
id|saa-&gt;audio_dev
suffix:semicolon
id|v.flags
op_and_assign
op_complement
(paren
id|VIDEO_AUDIO_MUTE
op_or
id|VIDEO_AUDIO_MUTABLE
)paren
suffix:semicolon
id|v.flags
op_or_assign
id|VIDEO_AUDIO_MUTABLE
op_or
id|VIDEO_AUDIO_VOLUME
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;MPEG&quot;
)paren
suffix:semicolon
id|v.mode
op_assign
id|VIDEO_SOUND_STEREO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
r_struct
id|video_audio
id|v
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|i
op_assign
(paren
op_complement
(paren
id|v.volume
op_rshift
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HaveCS4341
)paren
(brace
r_if
c_cond
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
(brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_FRNT_ATTEN
comma
l_int|0xffff
comma
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_FRNT_ATTEN
comma
l_int|0x0000
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_VOLUME
)paren
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_FRNT_ATTEN
comma
(paren
id|i
op_lshift
l_int|8
)paren
op_or
id|i
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
id|cs4341_setlevel
c_func
(paren
id|saa
comma
l_int|0xff
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
)paren
id|cs4341_setlevel
c_func
(paren
id|saa
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_VOLUME
)paren
id|cs4341_setlevel
c_func
(paren
id|saa
comma
id|i
comma
id|i
)paren
suffix:semicolon
)brace
id|saa-&gt;audio_dev
op_assign
id|v
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGUNIT
suffix:colon
(brace
r_struct
id|video_unit
id|vu
suffix:semicolon
id|vu.video
op_assign
id|saa-&gt;video_dev.minor
suffix:semicolon
id|vu.vbi
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.radio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.audio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.teletext
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vu
comma
r_sizeof
(paren
id|vu
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPLAYMODE
suffix:colon
(brace
r_struct
id|video_play_mode
id|pmode
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|pmode
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|video_play_mode
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|pmode.mode
)paren
(brace
r_case
id|VID_PLAY_VID_OUT_MODE
suffix:colon
r_if
c_cond
(paren
id|pmode.p1
op_ne
id|VIDEO_MODE_NTSC
op_logical_and
id|pmode.p1
op_ne
id|VIDEO_MODE_PAL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|set_out_format
c_func
(paren
id|saa
comma
id|pmode.p1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_GENLOCK
suffix:colon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|XILINX_CTL0
comma
(paren
id|pmode.p1
ques
c_cond
l_int|0x8000
suffix:colon
l_int|0x8080
)paren
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NewCard
)paren
id|set_genlock_offset
c_func
(paren
id|saa
comma
id|pmode.p2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_NORMAL
suffix:colon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_PLAY
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|pmode.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_PAUSE
suffix:colon
multiline_comment|/* IBM removed the PAUSE command */
multiline_comment|/* they say use SINGLE_FRAME now */
r_case
id|VID_PLAY_SINGLE_FRAME
suffix:colon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_SINGLE_FRAME
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;playmode
op_eq
id|pmode.mode
)paren
(brace
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
)brace
id|saa-&gt;playmode
op_assign
id|pmode.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_FAST_FORWARD
suffix:colon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_FAST_FORWARD
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|pmode.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_SLOW_MOTION
suffix:colon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_SLOW_MOTION
comma
id|pmode.p1
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|pmode.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_IMMEDIATE_NORMAL
suffix:colon
multiline_comment|/* ensure transfers resume */
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_IMED_NORM_PLAY
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|VID_PLAY_NORMAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_SWITCH_CHANNELS
suffix:colon
id|saa-&gt;audhead
op_assign
id|saa-&gt;audtail
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;vidhead
op_assign
id|saa-&gt;vidtail
op_assign
l_int|0
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_FREEZE_FRAME
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_RESET_AUD_RATE
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_CHANNEL_SWITCH
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_PLAY
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|VID_PLAY_NORMAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_FREEZE_FRAME
suffix:colon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_FREEZE_FRAME
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|pmode.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_STILL_MODE
suffix:colon
id|ibm_send_command
c_func
(paren
id|saa
comma
id|IBM_MP2_SET_STILL_MODE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|pmode.mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_MASTER_MODE
suffix:colon
r_if
c_cond
(paren
id|pmode.p1
op_eq
id|VID_PLAY_MASTER_NONE
)paren
id|saa-&gt;boardcfg
(braket
l_int|1
)braket
op_assign
l_int|0x13
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pmode.p1
op_eq
id|VID_PLAY_MASTER_VIDEO
)paren
id|saa-&gt;boardcfg
(braket
l_int|1
)braket
op_assign
l_int|0x23
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pmode.p1
op_eq
id|VID_PLAY_MASTER_AUDIO
)paren
id|saa-&gt;boardcfg
(braket
l_int|1
)braket
op_assign
l_int|0x43
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_CHIP_CONTROL
comma
id|ChipControl
comma
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VID_PLAY_ACTIVE_SCANLINES
suffix:colon
r_if
c_cond
(paren
id|CurrentMode
op_eq
id|VIDEO_MODE_PAL
)paren
(brace
r_if
c_cond
(paren
id|pmode.p1
template_param
l_int|625
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|5
)braket
op_assign
id|pmode.p1
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|55
)braket
op_assign
(paren
id|pmode.p1
op_plus
(paren
id|pmode.p2
op_div
l_int|2
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pmode.p1
template_param
l_int|525
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|4
)braket
op_assign
id|pmode.p1
suffix:semicolon
id|saa-&gt;boardcfg
(braket
l_int|54
)braket
op_assign
(paren
id|pmode.p1
op_plus
(paren
id|pmode.p2
op_div
l_int|2
)paren
op_minus
l_int|4
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
id|set_out_format
c_func
(paren
id|saa
comma
id|CurrentMode
)paren
suffix:semicolon
r_case
id|VID_PLAY_RESET
suffix:colon
r_return
id|do_ibm_reset
c_func
(paren
id|saa
)paren
suffix:semicolon
r_case
id|VID_PLAY_END_MARK
suffix:colon
r_if
c_cond
(paren
id|saa-&gt;endmarktail
OL
id|saa-&gt;endmarkhead
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;endmarkhead
op_minus
id|saa-&gt;endmarktail
OL
l_int|2
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|saa-&gt;endmarkhead
op_le
id|saa-&gt;endmarktail
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;endmarktail
op_minus
id|saa-&gt;endmarkhead
OG
(paren
id|MAX_MARKS
op_minus
l_int|2
)paren
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_else
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|saa-&gt;endmark
(braket
id|saa-&gt;endmarktail
)braket
op_assign
id|saa-&gt;audtail
suffix:semicolon
id|saa-&gt;endmarktail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;endmarktail
op_ge
id|MAX_MARKS
)paren
id|saa-&gt;endmarktail
op_assign
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|VIDIOCSWRITEMODE
suffix:colon
(brace
r_int
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mode
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|VID_WRITE_MPEG_AUD
op_logical_or
id|mode
op_eq
id|VID_WRITE_MPEG_VID
op_logical_or
id|mode
op_eq
id|VID_WRITE_CC
op_logical_or
id|mode
op_eq
id|VID_WRITE_TTX
op_logical_or
id|mode
op_eq
id|VID_WRITE_OSD
)paren
(brace
id|saa-&gt;writemode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|VIDIOCSMICROCODE
suffix:colon
(brace
r_struct
id|video_code
id|ucode
suffix:semicolon
id|__u8
op_star
id|udata
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ucode
comma
id|arg
comma
r_sizeof
(paren
id|ucode
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ucode.datasize
OG
l_int|65536
op_logical_or
id|ucode.datasize
OL
l_int|1024
op_logical_or
id|strncmp
c_func
(paren
id|ucode.loadwhat
comma
l_string|&quot;dec&quot;
comma
l_int|3
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|udata
op_assign
id|vmalloc
c_func
(paren
id|ucode.datasize
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|udata
comma
id|ucode.data
comma
id|ucode.datasize
)paren
)paren
(brace
id|vfree
c_func
(paren
id|udata
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ucode.data
op_assign
id|udata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|ucode.loadwhat
comma
l_string|&quot;decoder.aud&quot;
comma
l_int|11
)paren
op_logical_or
op_logical_neg
id|strncmp
c_func
(paren
id|ucode.loadwhat
comma
l_string|&quot;decoder.vid&quot;
comma
l_int|11
)paren
)paren
id|i
op_assign
id|initialize_ibmmpeg2
c_func
(paren
op_amp
id|ucode
)paren
suffix:semicolon
r_else
id|i
op_assign
id|initialize_fpga
c_func
(paren
op_amp
id|ucode
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|udata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
multiline_comment|/* this makes xawtv happy */
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|v.flags
op_assign
id|VIDEO_VC_AUDIO
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VID_TYPE_MPEG_DECODER
suffix:semicolon
id|v.norm
op_assign
id|CurrentMode
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;MPEG2&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
multiline_comment|/* this makes xawtv happy */
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* do nothing */
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa_mmap
r_static
r_int
id|saa_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;stradis%d: saa_mmap called&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|saa_read
r_static
r_int
id|saa_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|saa_write
r_static
r_int
id|saa_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|todo
op_assign
id|count
suffix:semicolon
r_int
id|blocksize
comma
id|split
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|todo
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|saa-&gt;writemode
op_eq
id|VID_WRITE_MPEG_AUD
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;audhead
op_le
id|saa-&gt;audtail
)paren
id|blocksize
op_assign
l_int|65536
op_minus
(paren
id|saa-&gt;audtail
op_minus
id|saa-&gt;audhead
)paren
suffix:semicolon
r_else
id|blocksize
op_assign
id|saa-&gt;audhead
op_minus
id|saa-&gt;audtail
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
OL
l_int|16384
)paren
(brace
id|saawrite
c_func
(paren
id|SAA7146_PSR_DEBI_S
op_or
id|SAA7146_PSR_PIN1
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|SAA7146_PSR_PIN1
comma
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* wait for buffer space to open */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|saa-&gt;audq
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;audhead
op_le
id|saa-&gt;audtail
)paren
(brace
id|blocksize
op_assign
l_int|65536
op_minus
(paren
id|saa-&gt;audtail
op_minus
id|saa-&gt;audhead
)paren
suffix:semicolon
id|split
op_assign
l_int|65536
op_minus
id|saa-&gt;audtail
suffix:semicolon
)brace
r_else
(brace
id|blocksize
op_assign
id|saa-&gt;audhead
op_minus
id|saa-&gt;audtail
suffix:semicolon
id|split
op_assign
l_int|65536
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|blocksize
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
OG
id|todo
)paren
id|blocksize
op_assign
id|todo
suffix:semicolon
multiline_comment|/* double check that we really have space */
r_if
c_cond
(paren
op_logical_neg
id|blocksize
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|split
OL
id|blocksize
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|saa-&gt;audbuf
op_plus
id|saa-&gt;audtail
comma
id|buf
comma
id|split
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buf
op_add_assign
id|split
suffix:semicolon
id|todo
op_sub_assign
id|split
suffix:semicolon
id|blocksize
op_sub_assign
id|split
suffix:semicolon
id|saa-&gt;audtail
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|saa-&gt;audbuf
op_plus
id|saa-&gt;audtail
comma
id|buf
comma
id|blocksize
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|saa-&gt;audtail
op_add_assign
id|blocksize
suffix:semicolon
id|todo
op_sub_assign
id|blocksize
suffix:semicolon
id|buf
op_add_assign
id|blocksize
suffix:semicolon
id|saa-&gt;audtail
op_and_assign
l_int|0xffff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|saa-&gt;writemode
op_eq
id|VID_WRITE_MPEG_VID
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;vidhead
op_le
id|saa-&gt;vidtail
)paren
id|blocksize
op_assign
l_int|524288
op_minus
(paren
id|saa-&gt;vidtail
op_minus
id|saa-&gt;vidhead
)paren
suffix:semicolon
r_else
id|blocksize
op_assign
id|saa-&gt;vidhead
op_minus
id|saa-&gt;vidtail
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
OL
l_int|65536
)paren
(brace
id|saawrite
c_func
(paren
id|SAA7146_PSR_DEBI_S
op_or
id|SAA7146_PSR_PIN1
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|SAA7146_PSR_PIN1
comma
id|SAA7146_PSR
)paren
suffix:semicolon
multiline_comment|/* wait for buffer space to open */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|saa-&gt;vidq
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;vidhead
op_le
id|saa-&gt;vidtail
)paren
(brace
id|blocksize
op_assign
l_int|524288
op_minus
(paren
id|saa-&gt;vidtail
op_minus
id|saa-&gt;vidhead
)paren
suffix:semicolon
id|split
op_assign
l_int|524288
op_minus
id|saa-&gt;vidtail
suffix:semicolon
)brace
r_else
(brace
id|blocksize
op_assign
id|saa-&gt;vidhead
op_minus
id|saa-&gt;vidtail
suffix:semicolon
id|split
op_assign
l_int|524288
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|saa-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|blocksize
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
OG
id|todo
)paren
id|blocksize
op_assign
id|todo
suffix:semicolon
multiline_comment|/* double check that we really have space */
r_if
c_cond
(paren
op_logical_neg
id|blocksize
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|split
OL
id|blocksize
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|saa-&gt;vidbuf
op_plus
id|saa-&gt;vidtail
comma
id|buf
comma
id|split
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buf
op_add_assign
id|split
suffix:semicolon
id|todo
op_sub_assign
id|split
suffix:semicolon
id|blocksize
op_sub_assign
id|split
suffix:semicolon
id|saa-&gt;vidtail
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|saa-&gt;vidbuf
op_plus
id|saa-&gt;vidtail
comma
id|buf
comma
id|blocksize
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|saa-&gt;vidtail
op_add_assign
id|blocksize
suffix:semicolon
id|todo
op_sub_assign
id|blocksize
suffix:semicolon
id|buf
op_add_assign
id|blocksize
suffix:semicolon
id|saa-&gt;vidtail
op_and_assign
l_int|0x7ffff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|saa-&gt;writemode
op_eq
id|VID_WRITE_OSD
)paren
(brace
r_if
c_cond
(paren
id|count
OG
l_int|131072
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|saa-&gt;osdbuf
comma
id|buf
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buf
op_add_assign
id|count
suffix:semicolon
id|saa-&gt;osdhead
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;osdtail
op_assign
id|count
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_ADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_OSD_LINK_ADDR
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_MASK0
comma
l_int|0xc00d
comma
l_int|2
)paren
suffix:semicolon
id|debiwrite
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_MODE
comma
id|debiread
c_func
(paren
id|saa
comma
id|debNormal
comma
id|IBM_MP2_DISP_MODE
comma
l_int|2
)paren
op_or
l_int|1
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* trigger osd data transfer */
id|saawrite
c_func
(paren
id|SAA7146_PSR_DEBI_S
op_or
id|SAA7146_PSR_PIN1
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|SAA7146_PSR_PIN1
comma
id|SAA7146_PSR
)paren
suffix:semicolon
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|saa_open
r_static
r_int
id|saa_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev
suffix:semicolon
id|saa-&gt;video_dev.busy
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;user
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;user
OG
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* device open already, don&squot;t reset */
id|saa-&gt;writemode
op_assign
id|VID_WRITE_MPEG_VID
suffix:semicolon
multiline_comment|/* default to video */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa_close
r_static
r_void
id|saa_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev
suffix:semicolon
id|saa-&gt;user
op_decrement
suffix:semicolon
id|saa-&gt;video_dev.busy
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;user
OG
l_int|0
)paren
multiline_comment|/* still someone using device */
r_return
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x007f0000
comma
id|SAA7146_MC1
)paren
suffix:semicolon
multiline_comment|/* stop all overlay dma */
)brace
multiline_comment|/* template for video_device-structure */
DECL|variable|saa_template
r_static
r_struct
id|video_device
id|saa_template
op_assign
(brace
id|name
suffix:colon
l_string|&quot;SAA7146A&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_OVERLAY
comma
id|hardware
suffix:colon
id|VID_HARDWARE_SAA7146
comma
id|open
suffix:colon
id|saa_open
comma
id|close
suffix:colon
id|saa_close
comma
id|read
suffix:colon
id|saa_read
comma
id|write
suffix:colon
id|saa_write
comma
id|ioctl
suffix:colon
id|saa_ioctl
comma
id|mmap
suffix:colon
id|saa_mmap
comma
)brace
suffix:semicolon
DECL|function|configure_saa7146
r_static
r_int
id|configure_saa7146
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|num
)paren
(brace
r_int
id|result
suffix:semicolon
r_struct
id|saa7146
op_star
id|saa
suffix:semicolon
id|saa
op_assign
op_amp
id|saa7146s
(braket
id|num
)braket
suffix:semicolon
id|saa-&gt;endmarkhead
op_assign
id|saa-&gt;endmarktail
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;win.x
op_assign
id|saa-&gt;win.y
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;win.width
op_assign
id|saa-&gt;win.cropwidth
op_assign
l_int|720
suffix:semicolon
id|saa-&gt;win.height
op_assign
id|saa-&gt;win.cropheight
op_assign
l_int|480
suffix:semicolon
id|saa-&gt;win.cropx
op_assign
id|saa-&gt;win.cropy
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;win.bpp
op_assign
l_int|2
suffix:semicolon
id|saa-&gt;win.depth
op_assign
l_int|16
suffix:semicolon
id|saa-&gt;win.color_fmt
op_assign
id|palette2fmt
(braket
id|VIDEO_PALETTE_RGB565
)braket
suffix:semicolon
id|saa-&gt;win.bpl
op_assign
l_int|1024
op_star
id|saa-&gt;win.bpp
suffix:semicolon
id|saa-&gt;win.swidth
op_assign
l_int|1024
suffix:semicolon
id|saa-&gt;win.sheight
op_assign
l_int|768
suffix:semicolon
id|saa-&gt;picture.brightness
op_assign
l_int|32768
suffix:semicolon
id|saa-&gt;picture.contrast
op_assign
l_int|38768
suffix:semicolon
id|saa-&gt;picture.colour
op_assign
l_int|32768
suffix:semicolon
id|saa-&gt;cap
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;dev
op_assign
id|dev
suffix:semicolon
id|saa-&gt;nr
op_assign
id|num
suffix:semicolon
id|saa-&gt;playmode
op_assign
id|VID_PLAY_NORMAL
suffix:semicolon
id|memset
c_func
(paren
id|saa-&gt;boardcfg
comma
l_int|0
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* clear board config area */
id|saa-&gt;saa7146_mem
op_assign
l_int|NULL
suffix:semicolon
id|saa-&gt;dmavid1
op_assign
id|saa-&gt;dmavid2
op_assign
id|saa-&gt;dmavid3
op_assign
id|saa-&gt;dmaa1in
op_assign
id|saa-&gt;dmaa1out
op_assign
id|saa-&gt;dmaa2in
op_assign
id|saa-&gt;dmaa2out
op_assign
id|saa-&gt;pagevid1
op_assign
id|saa-&gt;pagevid2
op_assign
id|saa-&gt;pagevid3
op_assign
id|saa-&gt;pagea1in
op_assign
id|saa-&gt;pagea1out
op_assign
id|saa-&gt;pagea2in
op_assign
id|saa-&gt;pagea2out
op_assign
id|saa-&gt;pagedebi
op_assign
id|saa-&gt;dmaRPS1
op_assign
id|saa-&gt;dmaRPS2
op_assign
id|saa-&gt;pageRPS1
op_assign
id|saa-&gt;pageRPS2
op_assign
l_int|NULL
suffix:semicolon
id|saa-&gt;audbuf
op_assign
id|saa-&gt;vidbuf
op_assign
id|saa-&gt;osdbuf
op_assign
id|saa-&gt;dmadebi
op_assign
l_int|NULL
suffix:semicolon
id|saa-&gt;audhead
op_assign
id|saa-&gt;vidtail
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|saa-&gt;i2cq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|saa-&gt;audq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|saa-&gt;debiq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|saa-&gt;vidq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|saa-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|saa-&gt;id
op_assign
id|dev-&gt;device
suffix:semicolon
id|saa-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|saa-&gt;video_dev.minor
op_assign
op_minus
l_int|1
suffix:semicolon
id|saa-&gt;saa7146_adr
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|saa-&gt;revision
)paren
suffix:semicolon
id|saa-&gt;saa7146_mem
op_assign
id|ioremap
c_func
(paren
id|saa-&gt;saa7146_adr
comma
l_int|0x200
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;saa7146_mem
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
comma
op_amp
id|saa7146_i2c_bus_template
comma
r_sizeof
(paren
r_struct
id|i2c_bus
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|saa-&gt;video_dev
comma
op_amp
id|saa_template
comma
r_sizeof
(paren
id|saa_template
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|saa-&gt;i2c.name
comma
l_string|&quot;stradis%d&quot;
comma
id|num
)paren
suffix:semicolon
id|saa-&gt;i2c.data
op_assign
id|saa
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
multiline_comment|/* turn off all interrupts */
id|result
op_assign
id|request_irq
c_func
(paren
id|saa-&gt;irq
comma
id|saa7146_irq
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
l_string|&quot;stradis&quot;
comma
(paren
r_void
op_star
)paren
id|saa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EINVAL
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: Bad irq number or handler&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EBUSY
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: IRQ %ld busy, change your PnP&quot;
l_string|&quot; config in BIOS&bslash;n&quot;
comma
id|num
comma
id|saa-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|saa-&gt;video_dev
comma
id|VFL_TYPE_GRABBER
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#if 0
multiline_comment|/* i2c generic interface is currently BROKEN */
id|i2c_register_bus
c_func
(paren
op_amp
id|saa-&gt;i2c
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|init_saa7146
r_static
r_int
id|init_saa7146
c_func
(paren
r_int
id|i
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
op_amp
id|saa7146s
(braket
id|i
)braket
suffix:semicolon
id|saa-&gt;user
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset the saa7146 */
id|saawrite
c_func
(paren
l_int|0xffff0000
comma
id|SAA7146_MC1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* enable debi and i2c transfers and pins */
id|saawrite
c_func
(paren
(paren
(paren
id|SAA7146_MC1_EDP
op_or
id|SAA7146_MC1_EI2C
op_or
id|SAA7146_MC1_TR_E_DEBI
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xffff
comma
id|SAA7146_MC1
)paren
suffix:semicolon
multiline_comment|/* ensure proper state of chip */
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_PAGE1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00f302c0
comma
id|SAA7146_NUM_LINE_BYTE1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_PAGE2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x01400080
comma
id|SAA7146_NUM_LINE_BYTE2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_DD1_INIT
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_DD1_STREAM_B
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_DD1_STREAM_A
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_BRS_CTRL
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x80400040
comma
id|SAA7146_BCS_CTRL
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x0000e000
multiline_comment|/*| (1&lt;&lt;29)*/
comma
id|SAA7146_HPS_CTRL
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000060
comma
id|SAA7146_CLIP_FORMAT_CTRL
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_ACON1
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000000
comma
id|SAA7146_ACON2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0x00000600
comma
id|SAA7146_I2C_STATUS
)paren
suffix:semicolon
id|saawrite
c_func
(paren
(paren
(paren
id|SAA7146_MC2_UPLD_D1_B
op_or
id|SAA7146_MC2_UPLD_D1_A
op_or
id|SAA7146_MC2_UPLD_BRS
op_or
id|SAA7146_MC2_UPLD_HPS_H
op_or
id|SAA7146_MC2_UPLD_HPS_V
op_or
id|SAA7146_MC2_UPLD_DMA2
op_or
id|SAA7146_MC2_UPLD_DMA1
op_or
id|SAA7146_MC2_UPLD_I2C
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xffff
comma
id|SAA7146_MC2
)paren
suffix:semicolon
multiline_comment|/* setup arbitration control registers */
id|saawrite
c_func
(paren
l_int|0x1412121a
comma
id|SAA7146_PCI_BT_V1
)paren
suffix:semicolon
multiline_comment|/* allocate 32k dma buffer + 4k for page table */
r_if
c_cond
(paren
(paren
id|saa-&gt;dmadebi
op_assign
id|kmalloc
c_func
(paren
l_int|32768
op_plus
l_int|4096
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: debi kmalloc failed&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#if 0
id|saa-&gt;pagedebi
op_assign
id|saa-&gt;dmadebi
op_plus
l_int|32768
suffix:semicolon
multiline_comment|/* top 4k is for mmu */
id|saawrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;pagedebi
)paren
multiline_comment|/*|0x800 */
comma
id|SAA7146_DEBI_PAGE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* setup mmu page table */
id|saa-&gt;pagedebi
(braket
id|i
)braket
op_assign
id|virt_to_bus
c_func
(paren
(paren
id|saa-&gt;dmadebi
op_plus
id|i
op_star
l_int|4096
)paren
)paren
suffix:semicolon
macro_line|#endif
id|saa-&gt;audhead
op_assign
id|saa-&gt;vidhead
op_assign
id|saa-&gt;osdhead
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;audtail
op_assign
id|saa-&gt;vidtail
op_assign
id|saa-&gt;osdtail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;vidbuf
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|saa-&gt;vidbuf
op_assign
id|vmalloc
c_func
(paren
l_int|524288
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: malloc failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|saa-&gt;audbuf
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|saa-&gt;audbuf
op_assign
id|vmalloc
c_func
(paren
l_int|65536
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: malloc failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|saa-&gt;vidbuf
)paren
suffix:semicolon
id|saa-&gt;vidbuf
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|saa-&gt;osdbuf
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|saa-&gt;osdbuf
op_assign
id|vmalloc
c_func
(paren
l_int|131072
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: malloc failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|saa-&gt;vidbuf
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|saa-&gt;audbuf
)paren
suffix:semicolon
id|saa-&gt;vidbuf
op_assign
id|saa-&gt;audbuf
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* allocate 81920 byte buffer for clipping */
r_if
c_cond
(paren
(paren
id|saa-&gt;dmavid2
op_assign
id|kmalloc
c_func
(paren
id|VIDEO_CLIPMAP_SIZE
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;stradis%d: clip kmalloc failed&bslash;n&quot;
comma
id|saa-&gt;nr
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|saa-&gt;vidbuf
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|saa-&gt;audbuf
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|saa-&gt;osdbuf
)paren
suffix:semicolon
id|saa-&gt;vidbuf
op_assign
id|saa-&gt;audbuf
op_assign
id|saa-&gt;osdbuf
op_assign
l_int|NULL
suffix:semicolon
id|saa-&gt;dmavid2
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|saa-&gt;dmavid2
comma
l_int|0x00
comma
id|VIDEO_CLIPMAP_SIZE
)paren
suffix:semicolon
multiline_comment|/* clip everything */
multiline_comment|/* setup clipping registers */
id|saawrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;dmavid2
)paren
comma
id|SAA7146_BASE_EVEN2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;dmavid2
)paren
op_plus
l_int|128
comma
id|SAA7146_BASE_ODD2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;dmavid2
)paren
op_plus
id|VIDEO_CLIPMAP_SIZE
comma
id|SAA7146_PROT_ADDR2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|256
comma
id|SAA7146_PITCH2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|4
comma
id|SAA7146_PAGE2
)paren
suffix:semicolon
multiline_comment|/* dma direction: read, no byteswap */
id|saawrite
c_func
(paren
(paren
(paren
id|SAA7146_MC2_UPLD_DMA2
)paren
op_lshift
l_int|16
)paren
op_or
id|SAA7146_MC2_UPLD_DMA2
comma
id|SAA7146_MC2
)paren
suffix:semicolon
id|I2CBusScan
c_func
(paren
op_amp
(paren
id|saa-&gt;i2c
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|release_saa
r_static
r_void
id|release_saa
c_func
(paren
r_void
)paren
(brace
id|u8
id|command
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|saa7146
op_star
id|saa
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|saa
op_assign
op_amp
id|saa7146s
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* turn off all capturing, DMA and IRQs */
id|saawrite
c_func
(paren
l_int|0xffff0000
comma
id|SAA7146_MC1
)paren
suffix:semicolon
multiline_comment|/* reset chip */
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_MC2
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0
comma
id|SAA7146_IER
)paren
suffix:semicolon
id|saawrite
c_func
(paren
l_int|0xffffffffUL
comma
id|SAA7146_ISR
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* unregister i2c_bus */
id|i2c_unregister_bus
c_func
(paren
(paren
op_amp
id|saa-&gt;i2c
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* disable PCI bus-mastering */
id|pci_read_config_byte
c_func
(paren
id|saa-&gt;dev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
multiline_comment|/* Should this be &amp;=~ ?? */
id|command
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|saa-&gt;dev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* unmap and free memory */
id|saa-&gt;audhead
op_assign
id|saa-&gt;audtail
op_assign
id|saa-&gt;osdhead
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;vidhead
op_assign
id|saa-&gt;vidtail
op_assign
id|saa-&gt;osdtail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;vidbuf
)paren
id|vfree
c_func
(paren
id|saa-&gt;vidbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;audbuf
)paren
id|vfree
c_func
(paren
id|saa-&gt;audbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;osdbuf
)paren
id|vfree
c_func
(paren
id|saa-&gt;osdbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmavid2
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmavid2
)paren
suffix:semicolon
id|saa-&gt;audbuf
op_assign
id|saa-&gt;vidbuf
op_assign
id|saa-&gt;osdbuf
op_assign
l_int|NULL
suffix:semicolon
id|saa-&gt;dmavid2
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmadebi
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmadebi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmavid1
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmavid1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmavid2
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmavid2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmavid3
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmavid3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmaa1in
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmaa1in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmaa1out
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmaa1out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmaa2in
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmaa2in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmaa2out
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmaa2out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmaRPS1
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmaRPS1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;dmaRPS2
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|saa-&gt;dmaRPS2
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|saa-&gt;irq
comma
id|saa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;saa7146_mem
)paren
id|iounmap
c_func
(paren
id|saa-&gt;saa7146_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;video_dev.minor
op_ne
op_minus
l_int|1
)paren
id|video_unregister_device
c_func
(paren
op_amp
id|saa-&gt;video_dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|stradis_init
r_static
r_int
id|__init
id|stradis_init
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|result
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|saa_num
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_PHILIPS
comma
id|PCI_DEVICE_ID_PHILIPS_SAA7146
comma
id|dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;subsystem_vendor
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: rev1 decoder&bslash;n&quot;
comma
id|saa_num
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis%d: SDM2xx found&bslash;n&quot;
comma
id|saa_num
)paren
suffix:semicolon
id|result
op_assign
id|configure_saa7146
c_func
(paren
id|dev
comma
id|saa_num
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|saa_num
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis: %d card(s) found.&bslash;n&quot;
comma
id|saa_num
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa_num
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|init_saa7146
c_func
(paren
id|i
)paren
OL
l_int|0
)paren
(brace
id|release_saa
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stradis_exit
r_static
r_void
id|__exit
id|stradis_exit
(paren
r_void
)paren
(brace
id|release_saa
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;stradis: module cleanup complete&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|stradis_init
id|module_init
c_func
(paren
id|stradis_init
)paren
suffix:semicolon
DECL|variable|stradis_exit
id|module_exit
c_func
(paren
id|stradis_exit
)paren
suffix:semicolon
eof
