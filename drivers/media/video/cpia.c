multiline_comment|/*&n; * cpia CPiA driver&n; *&n; * Supports CPiA based Video Camera&squot;s.&n; *&n; * (C) Copyright 1999-2000 Peter Pregler,&n; * (C) Copyright 1999-2000 Scott J. Bertin,&n; * (C) Copyright 1999-2000 Johannes Erdfelt, jerdfelt@valinux.com&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/* #define _CPIA_DEBUG_&t;&t;define for verbose debug output */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#ifdef CONFIG_KMOD
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#endif
macro_line|#include &quot;cpia.h&quot;
macro_line|#ifdef CONFIG_VIDEO_CPIA_PP
r_extern
r_int
id|cpia_pp_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_VIDEO_CPIA_USB
r_extern
r_int
id|cpia_usb_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Scott J. Bertin &lt;sbertin@mindspring.com&gt; &amp; Peter Pregler &lt;Peter_Pregler@email.com&gt; &amp; Johannes Erdfelt &lt;jerdfelt@valinux.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;V4L-driver for Vision CPiA based cameras&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;video&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|macro|ABOUT
mdefine_line|#define ABOUT &quot;V4L-Driver for Vision CPiA based cameras&quot;
macro_line|#ifndef VID_HARDWARE_CPIA
DECL|macro|VID_HARDWARE_CPIA
mdefine_line|#define VID_HARDWARE_CPIA 24    /* FIXME -&gt; from linux/videodev.h */
macro_line|#endif
DECL|macro|CPIA_MODULE_CPIA
mdefine_line|#define CPIA_MODULE_CPIA&t;&t;&t;(0&lt;&lt;5)
DECL|macro|CPIA_MODULE_SYSTEM
mdefine_line|#define CPIA_MODULE_SYSTEM&t;&t;&t;(1&lt;&lt;5)
DECL|macro|CPIA_MODULE_VP_CTRL
mdefine_line|#define CPIA_MODULE_VP_CTRL&t;&t;&t;(5&lt;&lt;5)
DECL|macro|CPIA_MODULE_CAPTURE
mdefine_line|#define CPIA_MODULE_CAPTURE&t;&t;&t;(6&lt;&lt;5)
DECL|macro|CPIA_MODULE_DEBUG
mdefine_line|#define CPIA_MODULE_DEBUG&t;&t;&t;(7&lt;&lt;5)
DECL|macro|INPUT
mdefine_line|#define INPUT (DATA_IN &lt;&lt; 8)
DECL|macro|OUTPUT
mdefine_line|#define OUTPUT (DATA_OUT &lt;&lt; 8)
DECL|macro|CPIA_COMMAND_GetCPIAVersion
mdefine_line|#define CPIA_COMMAND_GetCPIAVersion&t;(INPUT | CPIA_MODULE_CPIA | 1)
DECL|macro|CPIA_COMMAND_GetPnPID
mdefine_line|#define CPIA_COMMAND_GetPnPID&t;&t;(INPUT | CPIA_MODULE_CPIA | 2)
DECL|macro|CPIA_COMMAND_GetCameraStatus
mdefine_line|#define CPIA_COMMAND_GetCameraStatus&t;(INPUT | CPIA_MODULE_CPIA | 3)
DECL|macro|CPIA_COMMAND_GotoHiPower
mdefine_line|#define CPIA_COMMAND_GotoHiPower&t;(OUTPUT | CPIA_MODULE_CPIA | 4)
DECL|macro|CPIA_COMMAND_GotoLoPower
mdefine_line|#define CPIA_COMMAND_GotoLoPower&t;(OUTPUT | CPIA_MODULE_CPIA | 5)
DECL|macro|CPIA_COMMAND_GotoSuspend
mdefine_line|#define CPIA_COMMAND_GotoSuspend&t;(OUTPUT | CPIA_MODULE_CPIA | 7)
DECL|macro|CPIA_COMMAND_GotoPassThrough
mdefine_line|#define CPIA_COMMAND_GotoPassThrough&t;(OUTPUT | CPIA_MODULE_CPIA | 8)
DECL|macro|CPIA_COMMAND_ModifyCameraStatus
mdefine_line|#define CPIA_COMMAND_ModifyCameraStatus&t;(OUTPUT | CPIA_MODULE_CPIA | 10)
DECL|macro|CPIA_COMMAND_ReadVCRegs
mdefine_line|#define CPIA_COMMAND_ReadVCRegs&t;&t;(INPUT | CPIA_MODULE_SYSTEM | 1)
DECL|macro|CPIA_COMMAND_WriteVCReg
mdefine_line|#define CPIA_COMMAND_WriteVCReg&t;&t;(OUTPUT | CPIA_MODULE_SYSTEM | 2)
DECL|macro|CPIA_COMMAND_ReadMCPorts
mdefine_line|#define CPIA_COMMAND_ReadMCPorts&t;(INPUT | CPIA_MODULE_SYSTEM | 3)
DECL|macro|CPIA_COMMAND_WriteMCPort
mdefine_line|#define CPIA_COMMAND_WriteMCPort&t;(OUTPUT | CPIA_MODULE_SYSTEM | 4)
DECL|macro|CPIA_COMMAND_SetBaudRate
mdefine_line|#define CPIA_COMMAND_SetBaudRate&t;(OUTPUT | CPIA_MODULE_SYSTEM | 5)
DECL|macro|CPIA_COMMAND_SetECPTiming
mdefine_line|#define CPIA_COMMAND_SetECPTiming&t;(OUTPUT | CPIA_MODULE_SYSTEM | 6)
DECL|macro|CPIA_COMMAND_ReadIDATA
mdefine_line|#define CPIA_COMMAND_ReadIDATA&t;&t;(INPUT | CPIA_MODULE_SYSTEM | 7)
DECL|macro|CPIA_COMMAND_WriteIDATA
mdefine_line|#define CPIA_COMMAND_WriteIDATA&t;&t;(OUTPUT | CPIA_MODULE_SYSTEM | 8)
DECL|macro|CPIA_COMMAND_GenericCall
mdefine_line|#define CPIA_COMMAND_GenericCall&t;(OUTPUT | CPIA_MODULE_SYSTEM | 9)
DECL|macro|CPIA_COMMAND_I2CStart
mdefine_line|#define CPIA_COMMAND_I2CStart&t;&t;(OUTPUT | CPIA_MODULE_SYSTEM | 10)
DECL|macro|CPIA_COMMAND_I2CStop
mdefine_line|#define CPIA_COMMAND_I2CStop&t;&t;(OUTPUT | CPIA_MODULE_SYSTEM | 11)
DECL|macro|CPIA_COMMAND_I2CWrite
mdefine_line|#define CPIA_COMMAND_I2CWrite&t;&t;(OUTPUT | CPIA_MODULE_SYSTEM | 12)
DECL|macro|CPIA_COMMAND_I2CRead
mdefine_line|#define CPIA_COMMAND_I2CRead&t;&t;(INPUT | CPIA_MODULE_SYSTEM | 13)
DECL|macro|CPIA_COMMAND_GetVPVersion
mdefine_line|#define CPIA_COMMAND_GetVPVersion&t;(INPUT | CPIA_MODULE_VP_CTRL | 1)
DECL|macro|CPIA_COMMAND_SetColourParams
mdefine_line|#define CPIA_COMMAND_SetColourParams&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 3)
DECL|macro|CPIA_COMMAND_SetExposure
mdefine_line|#define CPIA_COMMAND_SetExposure&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 4)
DECL|macro|CPIA_COMMAND_SetColourBalance
mdefine_line|#define CPIA_COMMAND_SetColourBalance&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 6)
DECL|macro|CPIA_COMMAND_SetSensorFPS
mdefine_line|#define CPIA_COMMAND_SetSensorFPS&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 7)
DECL|macro|CPIA_COMMAND_SetVPDefaults
mdefine_line|#define CPIA_COMMAND_SetVPDefaults&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 8)
DECL|macro|CPIA_COMMAND_SetApcor
mdefine_line|#define CPIA_COMMAND_SetApcor&t;&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 9)
DECL|macro|CPIA_COMMAND_SetFlickerCtrl
mdefine_line|#define CPIA_COMMAND_SetFlickerCtrl&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 10)
DECL|macro|CPIA_COMMAND_SetVLOffset
mdefine_line|#define CPIA_COMMAND_SetVLOffset&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 11)
DECL|macro|CPIA_COMMAND_GetColourParams
mdefine_line|#define CPIA_COMMAND_GetColourParams&t;(INPUT | CPIA_MODULE_VP_CTRL | 16)
DECL|macro|CPIA_COMMAND_GetColourBalance
mdefine_line|#define CPIA_COMMAND_GetColourBalance&t;(INPUT | CPIA_MODULE_VP_CTRL | 17)
DECL|macro|CPIA_COMMAND_GetExposure
mdefine_line|#define CPIA_COMMAND_GetExposure&t;(INPUT | CPIA_MODULE_VP_CTRL | 18)
DECL|macro|CPIA_COMMAND_SetSensorMatrix
mdefine_line|#define CPIA_COMMAND_SetSensorMatrix&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 19)
DECL|macro|CPIA_COMMAND_ColourBars
mdefine_line|#define CPIA_COMMAND_ColourBars&t;&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 25)
DECL|macro|CPIA_COMMAND_ReadVPRegs
mdefine_line|#define CPIA_COMMAND_ReadVPRegs&t;&t;(INPUT | CPIA_MODULE_VP_CTRL | 30)
DECL|macro|CPIA_COMMAND_WriteVPReg
mdefine_line|#define CPIA_COMMAND_WriteVPReg&t;&t;(OUTPUT | CPIA_MODULE_VP_CTRL | 31)
DECL|macro|CPIA_COMMAND_GrabFrame
mdefine_line|#define CPIA_COMMAND_GrabFrame&t;&t;(OUTPUT | CPIA_MODULE_CAPTURE | 1)
DECL|macro|CPIA_COMMAND_UploadFrame
mdefine_line|#define CPIA_COMMAND_UploadFrame&t;(OUTPUT | CPIA_MODULE_CAPTURE | 2)
DECL|macro|CPIA_COMMAND_SetGrabMode
mdefine_line|#define CPIA_COMMAND_SetGrabMode&t;(OUTPUT | CPIA_MODULE_CAPTURE | 3)
DECL|macro|CPIA_COMMAND_InitStreamCap
mdefine_line|#define CPIA_COMMAND_InitStreamCap&t;(OUTPUT | CPIA_MODULE_CAPTURE | 4)
DECL|macro|CPIA_COMMAND_FiniStreamCap
mdefine_line|#define CPIA_COMMAND_FiniStreamCap&t;(OUTPUT | CPIA_MODULE_CAPTURE | 5)
DECL|macro|CPIA_COMMAND_StartStreamCap
mdefine_line|#define CPIA_COMMAND_StartStreamCap&t;(OUTPUT | CPIA_MODULE_CAPTURE | 6)
DECL|macro|CPIA_COMMAND_EndStreamCap
mdefine_line|#define CPIA_COMMAND_EndStreamCap&t;(OUTPUT | CPIA_MODULE_CAPTURE | 7)
DECL|macro|CPIA_COMMAND_SetFormat
mdefine_line|#define CPIA_COMMAND_SetFormat&t;&t;(OUTPUT | CPIA_MODULE_CAPTURE | 8)
DECL|macro|CPIA_COMMAND_SetROI
mdefine_line|#define CPIA_COMMAND_SetROI&t;&t;(OUTPUT | CPIA_MODULE_CAPTURE | 9)
DECL|macro|CPIA_COMMAND_SetCompression
mdefine_line|#define CPIA_COMMAND_SetCompression&t;(OUTPUT | CPIA_MODULE_CAPTURE | 10)
DECL|macro|CPIA_COMMAND_SetCompressionTarget
mdefine_line|#define CPIA_COMMAND_SetCompressionTarget (OUTPUT | CPIA_MODULE_CAPTURE | 11)
DECL|macro|CPIA_COMMAND_SetYUVThresh
mdefine_line|#define CPIA_COMMAND_SetYUVThresh&t;(OUTPUT | CPIA_MODULE_CAPTURE | 12)
DECL|macro|CPIA_COMMAND_SetCompressionParams
mdefine_line|#define CPIA_COMMAND_SetCompressionParams (OUTPUT | CPIA_MODULE_CAPTURE | 13)
DECL|macro|CPIA_COMMAND_DiscardFrame
mdefine_line|#define CPIA_COMMAND_DiscardFrame&t;(OUTPUT | CPIA_MODULE_CAPTURE | 14)
DECL|macro|CPIA_COMMAND_OutputRS232
mdefine_line|#define CPIA_COMMAND_OutputRS232&t;(OUTPUT | CPIA_MODULE_DEBUG | 1)
DECL|macro|CPIA_COMMAND_AbortProcess
mdefine_line|#define CPIA_COMMAND_AbortProcess&t;(OUTPUT | CPIA_MODULE_DEBUG | 4)
DECL|macro|CPIA_COMMAND_SetDramPage
mdefine_line|#define CPIA_COMMAND_SetDramPage&t;(OUTPUT | CPIA_MODULE_DEBUG | 5)
DECL|macro|CPIA_COMMAND_StartDramUpload
mdefine_line|#define CPIA_COMMAND_StartDramUpload&t;(OUTPUT | CPIA_MODULE_DEBUG | 6)
DECL|macro|CPIA_COMMAND_StartDummyDtream
mdefine_line|#define CPIA_COMMAND_StartDummyDtream&t;(OUTPUT | CPIA_MODULE_DEBUG | 8)
DECL|macro|CPIA_COMMAND_AbortStream
mdefine_line|#define CPIA_COMMAND_AbortStream&t;(OUTPUT | CPIA_MODULE_DEBUG | 9)
DECL|macro|CPIA_COMMAND_DownloadDRAM
mdefine_line|#define CPIA_COMMAND_DownloadDRAM&t;(OUTPUT | CPIA_MODULE_DEBUG | 10)
r_enum
(brace
DECL|enumerator|FRAME_READY
id|FRAME_READY
comma
multiline_comment|/* Ready to grab into */
DECL|enumerator|FRAME_GRABBING
id|FRAME_GRABBING
comma
multiline_comment|/* In the process of being grabbed into */
DECL|enumerator|FRAME_DONE
id|FRAME_DONE
comma
multiline_comment|/* Finished grabbing, but not been synced yet */
DECL|enumerator|FRAME_UNUSED
id|FRAME_UNUSED
comma
multiline_comment|/* Unused (no MCAPTURE) */
)brace
suffix:semicolon
DECL|macro|COMMAND_NONE
mdefine_line|#define COMMAND_NONE&t;&t;&t;0x0000
DECL|macro|COMMAND_SETCOMPRESSION
mdefine_line|#define COMMAND_SETCOMPRESSION&t;&t;0x0001
DECL|macro|COMMAND_SETCOMPRESSIONTARGET
mdefine_line|#define COMMAND_SETCOMPRESSIONTARGET&t;0x0002
DECL|macro|COMMAND_SETCOLOURPARAMS
mdefine_line|#define COMMAND_SETCOLOURPARAMS&t;&t;0x0004
DECL|macro|COMMAND_SETFORMAT
mdefine_line|#define COMMAND_SETFORMAT&t;&t;0x0008
DECL|macro|COMMAND_PAUSE
mdefine_line|#define COMMAND_PAUSE&t;&t;&t;0x0010
DECL|macro|COMMAND_RESUME
mdefine_line|#define COMMAND_RESUME&t;&t;&t;0x0020
DECL|macro|COMMAND_SETYUVTHRESH
mdefine_line|#define COMMAND_SETYUVTHRESH&t;&t;0x0040
DECL|macro|COMMAND_SETECPTIMING
mdefine_line|#define COMMAND_SETECPTIMING&t;&t;0x0080
DECL|macro|COMMAND_SETCOMPRESSIONPARAMS
mdefine_line|#define COMMAND_SETCOMPRESSIONPARAMS&t;0x0100
DECL|macro|COMMAND_SETEXPOSURE
mdefine_line|#define COMMAND_SETEXPOSURE&t;&t;0x0200
DECL|macro|COMMAND_SETCOLOURBALANCE
mdefine_line|#define COMMAND_SETCOLOURBALANCE&t;0x0400
DECL|macro|COMMAND_SETSENSORFPS
mdefine_line|#define COMMAND_SETSENSORFPS&t;&t;0x0800
DECL|macro|COMMAND_SETAPCOR
mdefine_line|#define COMMAND_SETAPCOR&t;&t;0x1000
DECL|macro|COMMAND_SETFLICKERCTRL
mdefine_line|#define COMMAND_SETFLICKERCTRL&t;&t;0x2000
DECL|macro|COMMAND_SETVLOFFSET
mdefine_line|#define COMMAND_SETVLOFFSET&t;&t;0x4000
multiline_comment|/* Developer&squot;s Guide Table 5 p 3-34&n; * indexed by [mains][sensorFps.baserate][sensorFps.divisor]*/
DECL|variable|flicker_jumps
r_static
id|u8
id|flicker_jumps
(braket
l_int|2
)braket
(braket
l_int|2
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
(brace
l_int|76
comma
l_int|38
comma
l_int|19
comma
l_int|9
)brace
comma
(brace
l_int|92
comma
l_int|46
comma
l_int|23
comma
l_int|11
)brace
)brace
comma
(brace
(brace
l_int|64
comma
l_int|32
comma
l_int|16
comma
l_int|8
)brace
comma
(brace
l_int|76
comma
l_int|38
comma
l_int|19
comma
l_int|9
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* forward declaration of local function */
r_static
r_void
id|reset_camera_struct
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
suffix:semicolon
multiline_comment|/**********************************************************************&n; *&n; * Memory management&n; *&n; * This is a shameless copy from the USB-cpia driver (linux kernel&n; * version 2.3.29 or so, I have no idea what this code actually does ;).&n; * Actually it seems to be a copy of a shameless copy of the bttv-driver.&n; * Or that is a copy of a shameless copy of ... (To the powers: is there&n; * no generic kernel-function to do this sort of stuff?)&n; *&n; * Yes, it was a shameless copy from the bttv-driver. IIRC, Alan says&n; * there will be one, but apparentely not yet - jerdfelt&n; *&n; **********************************************************************/
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
id|ret
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the&n; * area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
multiline_comment|/* Round it off to PAGE_SIZE */
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc_32
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * /proc interface&n; *&n; **********************************************************************/
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|cpia_proc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|cpia_proc_root
op_assign
l_int|NULL
suffix:semicolon
DECL|function|cpia_read_proc
r_static
r_int
id|cpia_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|len
comma
id|tmp
suffix:semicolon
r_struct
id|cam_data
op_star
id|cam
op_assign
id|data
suffix:semicolon
r_char
id|tmpstr
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/* IMPORTANT: This output MUST be kept under PAGE_SIZE&n;&t; *            or we need to get more sophisticated. */
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;read-only&bslash;n-----------------------&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;V4L Driver version:       %d.%d.%d&bslash;n&quot;
comma
id|CPIA_MAJ_VER
comma
id|CPIA_MIN_VER
comma
id|CPIA_PATCH_VER
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;CPIA Version:             %d.%02d (%d.%d)&bslash;n&quot;
comma
id|cam-&gt;params.version.firmwareVersion
comma
id|cam-&gt;params.version.firmwareRevision
comma
id|cam-&gt;params.version.vcVersion
comma
id|cam-&gt;params.version.vcRevision
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;CPIA PnP-ID:              %04x:%04x:%04x&bslash;n&quot;
comma
id|cam-&gt;params.pnpID.vendor
comma
id|cam-&gt;params.pnpID.product
comma
id|cam-&gt;params.pnpID.deviceRevision
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;VP-Version:               %d.%d %04x&bslash;n&quot;
comma
id|cam-&gt;params.vpVersion.vpVersion
comma
id|cam-&gt;params.vpVersion.vpRevision
comma
id|cam-&gt;params.vpVersion.cameraHeadID
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;system_state:             %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.systemState
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;grab_state:               %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.grabState
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;stream_state:             %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.streamState
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;fatal_error:              %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.fatalError
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;cmd_error:                %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.cmdError
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;debug_flags:              %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.debugFlags
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;vp_status:                %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.vpStatus
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;error_code:               %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.errorCode
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;video_size:               %s&bslash;n&quot;
comma
id|cam-&gt;params.format.videoSize
op_eq
id|VIDEOSIZE_CIF
ques
c_cond
l_string|&quot;CIF &quot;
suffix:colon
l_string|&quot;QCIF&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;sub_sample:               %s&bslash;n&quot;
comma
id|cam-&gt;params.format.subSample
op_eq
id|SUBSAMPLE_420
ques
c_cond
l_string|&quot;420&quot;
suffix:colon
l_string|&quot;422&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;yuv_order:                %s&bslash;n&quot;
comma
id|cam-&gt;params.format.yuvOrder
op_eq
id|YUVORDER_YUYV
ques
c_cond
l_string|&quot;YUYV&quot;
suffix:colon
l_string|&quot;UYVY&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;roi:                      (%3d, %3d) to (%3d, %3d)&bslash;n&quot;
comma
id|cam-&gt;params.roi.colStart
op_star
l_int|8
comma
id|cam-&gt;params.roi.rowStart
op_star
l_int|4
comma
id|cam-&gt;params.roi.colEnd
op_star
l_int|8
comma
id|cam-&gt;params.roi.rowEnd
op_star
l_int|4
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;actual_fps:               %3d&bslash;n&quot;
comma
id|cam-&gt;fps
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;transfer_rate:            %4dkB/s&bslash;n&quot;
comma
id|cam-&gt;transfer_rate
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;nread-write&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;-----------------------  current       min&quot;
l_string|&quot;       max   default  comment&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;brightness:             %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.colourParams.brightness
comma
l_int|0
comma
l_int|100
comma
l_int|50
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.version.firmwareVersion
op_eq
l_int|1
op_logical_and
id|cam-&gt;params.version.firmwareRevision
op_eq
l_int|2
)paren
multiline_comment|/* 1-02 firmware limits contrast to 80 */
id|tmp
op_assign
l_int|80
suffix:semicolon
r_else
id|tmp
op_assign
l_int|96
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;contrast:               %8d  %8d  %8d  %8d&quot;
l_string|&quot;  steps of 8&bslash;n&quot;
comma
id|cam-&gt;params.colourParams.contrast
comma
l_int|0
comma
id|tmp
comma
l_int|48
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;saturation:             %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.colourParams.saturation
comma
l_int|0
comma
l_int|100
comma
l_int|50
)paren
suffix:semicolon
id|tmp
op_assign
(paren
l_int|25000
op_plus
l_int|5000
op_star
id|cam-&gt;params.sensorFps.baserate
)paren
op_div
(paren
l_int|1
op_lshift
id|cam-&gt;params.sensorFps.divisor
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;sensor_fps:             %4d.%03d  %8d  %8d  %8d&bslash;n&quot;
comma
id|tmp
op_div
l_int|1000
comma
id|tmp
op_mod
l_int|1000
comma
l_int|3
comma
l_int|30
comma
l_int|15
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;stream_start_line:      %8d  %8d  %8d  %8d&bslash;n&quot;
comma
l_int|2
op_star
id|cam-&gt;params.streamStartLine
comma
l_int|0
comma
id|cam-&gt;params.format.videoSize
op_eq
id|VIDEOSIZE_CIF
ques
c_cond
l_int|288
suffix:colon
l_int|144
comma
id|cam-&gt;params.format.videoSize
op_eq
id|VIDEOSIZE_CIF
ques
c_cond
l_int|240
suffix:colon
l_int|120
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;ecp_timing:             %8s  %8s  %8s  %8s&bslash;n&quot;
comma
id|cam-&gt;params.ecpTiming
ques
c_cond
l_string|&quot;slow&quot;
suffix:colon
l_string|&quot;normal&quot;
comma
l_string|&quot;slow&quot;
comma
l_string|&quot;normal&quot;
comma
l_string|&quot;normal&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.colourBalance.balanceModeIsAuto
)paren
(brace
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;auto&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;manual&quot;
)paren
suffix:semicolon
)brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;color_balance_mode:     %8s  %8s  %8s&quot;
l_string|&quot;  %8s&bslash;n&quot;
comma
id|tmpstr
comma
l_string|&quot;manual&quot;
comma
l_string|&quot;auto&quot;
comma
l_string|&quot;auto&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;red_gain:               %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.colourBalance.redGain
comma
l_int|0
comma
l_int|212
comma
l_int|32
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;green_gain:             %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.colourBalance.greenGain
comma
l_int|0
comma
l_int|212
comma
l_int|6
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;blue_gain:              %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.colourBalance.blueGain
comma
l_int|0
comma
l_int|212
comma
l_int|92
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.version.firmwareVersion
op_eq
l_int|1
op_logical_and
id|cam-&gt;params.version.firmwareRevision
op_eq
l_int|2
)paren
multiline_comment|/* 1-02 firmware limits gain to 2 */
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;%8d  %8d&quot;
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;1,2,4,8&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.exposure.gainMode
op_eq
l_int|0
)paren
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;max_gain:                unknown  %18s&quot;
l_string|&quot;  %8d&bslash;n&quot;
comma
id|tmpstr
comma
l_int|2
)paren
suffix:semicolon
r_else
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;max_gain:               %8d  %18s  %8d&bslash;n&quot;
comma
l_int|1
op_lshift
(paren
id|cam-&gt;params.exposure.gainMode
op_minus
l_int|1
)paren
comma
id|tmpstr
comma
l_int|2
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cam-&gt;params.exposure.expMode
)paren
(brace
r_case
l_int|1
suffix:colon
r_case
l_int|3
suffix:colon
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;manual&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;auto&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|tmpstr
comma
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;exposure_mode:          %8s  %8s  %8s&quot;
l_string|&quot;  %8s&bslash;n&quot;
comma
id|tmpstr
comma
l_string|&quot;manual&quot;
comma
l_string|&quot;auto&quot;
comma
l_string|&quot;auto&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;centre_weight:          %8s  %8s  %8s  %8s&bslash;n&quot;
comma
(paren
l_int|2
op_minus
id|cam-&gt;params.exposure.centreWeight
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;on&quot;
comma
l_string|&quot;on&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;gain:                   %8d  %8d  max_gain  %8d  1,2,4,8 possible&bslash;n&quot;
comma
l_int|1
op_lshift
id|cam-&gt;params.exposure.gain
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.version.firmwareVersion
op_eq
l_int|1
op_logical_and
id|cam-&gt;params.version.firmwareRevision
op_eq
l_int|2
)paren
multiline_comment|/* 1-02 firmware limits fineExp to 127 */
id|tmp
op_assign
l_int|255
suffix:semicolon
r_else
id|tmp
op_assign
l_int|511
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;fine_exp:               %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.fineExp
op_star
l_int|2
comma
l_int|0
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.version.firmwareVersion
op_eq
l_int|1
op_logical_and
id|cam-&gt;params.version.firmwareRevision
op_eq
l_int|2
)paren
multiline_comment|/* 1-02 firmware limits coarseExpHi to 0 */
id|tmp
op_assign
l_int|255
suffix:semicolon
r_else
id|tmp
op_assign
l_int|65535
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;coarse_exp:             %8d  %8d  %8d&quot;
l_string|&quot;  %8d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.coarseExpLo
op_plus
l_int|256
op_star
id|cam-&gt;params.exposure.coarseExpHi
comma
l_int|0
comma
id|tmp
comma
l_int|185
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;red_comp:               %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.redComp
comma
l_int|220
comma
l_int|255
comma
l_int|220
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;green1_comp:            %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.green1Comp
comma
l_int|214
comma
l_int|255
comma
l_int|214
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;green2_comp:            %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.green2Comp
comma
l_int|214
comma
l_int|255
comma
l_int|214
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;blue_comp:              %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.blueComp
comma
l_int|230
comma
l_int|255
comma
l_int|230
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;apcor_gain1:            %#8x  %#8x  %#8x  %#8x&bslash;n&quot;
comma
id|cam-&gt;params.apcor.gain1
comma
l_int|0
comma
l_int|0xff
comma
l_int|0x1c
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;apcor_gain2:            %#8x  %#8x  %#8x  %#8x&bslash;n&quot;
comma
id|cam-&gt;params.apcor.gain2
comma
l_int|0
comma
l_int|0xff
comma
l_int|0x1a
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;apcor_gain4:            %#8x  %#8x  %#8x  %#8x&bslash;n&quot;
comma
id|cam-&gt;params.apcor.gain4
comma
l_int|0
comma
l_int|0xff
comma
l_int|0x2d
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;apcor_gain8:            %#8x  %#8x  %#8x  %#8x&bslash;n&quot;
comma
id|cam-&gt;params.apcor.gain8
comma
l_int|0
comma
l_int|0xff
comma
l_int|0x2a
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;vl_offset_gain1:        %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.vlOffset.gain1
comma
l_int|0
comma
l_int|255
comma
l_int|24
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;vl_offset_gain2:        %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.vlOffset.gain2
comma
l_int|0
comma
l_int|255
comma
l_int|28
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;vl_offset_gain4:        %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.vlOffset.gain4
comma
l_int|0
comma
l_int|255
comma
l_int|30
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;vl_offset_gain8:        %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.vlOffset.gain8
comma
l_int|0
comma
l_int|255
comma
l_int|30
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;flicker_control:        %8s  %8s  %8s  %8s&bslash;n&quot;
comma
id|cam-&gt;params.flickerControl.flickerMode
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;on&quot;
comma
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;mains_frequency:        %8d  %8d  %8d  %8d&quot;
l_string|&quot; only 50/60&bslash;n&quot;
comma
id|cam-&gt;mainsFreq
ques
c_cond
l_int|60
suffix:colon
l_int|50
comma
l_int|50
comma
l_int|60
comma
l_int|50
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;allowable_overexposure: %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.flickerControl.allowableOverExposure
comma
l_int|0
comma
l_int|255
comma
l_int|0
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;compression_mode:       &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cam-&gt;params.compression.mode
)paren
(brace
r_case
id|CPIA_COMPRESSION_NONE
suffix:colon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%8s&quot;
comma
l_string|&quot;none&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMPRESSION_AUTO
suffix:colon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%8s&quot;
comma
l_string|&quot;auto&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMPRESSION_MANUAL
suffix:colon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%8s&quot;
comma
l_string|&quot;manual&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%8s&quot;
comma
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;    none,auto,manual      auto&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;decimation_enable:      %8s  %8s  %8s  %8s&bslash;n&quot;
comma
id|cam-&gt;params.compression.decimation
op_eq
id|DECIMATION_ENAB
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;compression_target:    %9s %9s %9s %9s&bslash;n&quot;
comma
id|cam-&gt;params.compressionTarget.frTargeting
op_eq
id|CPIA_COMPRESSION_TARGET_FRAMERATE
ques
c_cond
l_string|&quot;framerate&quot;
suffix:colon
l_string|&quot;quality&quot;
comma
l_string|&quot;framerate&quot;
comma
l_string|&quot;quality&quot;
comma
l_string|&quot;quality&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;target_framerate:       %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionTarget.targetFR
comma
l_int|0
comma
l_int|30
comma
l_int|7
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;target_quality:         %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionTarget.targetQ
comma
l_int|0
comma
l_int|255
comma
l_int|10
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;y_threshold:            %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.yuvThreshold.yThreshold
comma
l_int|0
comma
l_int|31
comma
l_int|15
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;uv_threshold:           %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.yuvThreshold.uvThreshold
comma
l_int|0
comma
l_int|31
comma
l_int|15
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;hysteresis:             %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.hysteresis
comma
l_int|0
comma
l_int|255
comma
l_int|3
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;threshold_max:          %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.threshMax
comma
l_int|0
comma
l_int|255
comma
l_int|11
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;small_step:             %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.smallStep
comma
l_int|0
comma
l_int|255
comma
l_int|1
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;large_step:             %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.largeStep
comma
l_int|0
comma
l_int|255
comma
l_int|3
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;decimation_hysteresis:  %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.decimationHysteresis
comma
l_int|0
comma
l_int|255
comma
l_int|2
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;fr_diff_step_thresh:    %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.frDiffStepThresh
comma
l_int|0
comma
l_int|255
comma
l_int|5
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;q_diff_step_thresh:     %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.qDiffStepThresh
comma
l_int|0
comma
l_int|255
comma
l_int|3
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;decimation_thresh_mod:  %8d  %8d  %8d  %8d&bslash;n&quot;
comma
id|cam-&gt;params.compressionParams.decimationThreshMod
comma
l_int|0
comma
l_int|255
comma
l_int|2
)paren
suffix:semicolon
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|cpia_write_proc
r_static
r_int
id|cpia_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cam_data
op_star
id|cam
op_assign
id|data
suffix:semicolon
r_struct
id|cam_params
id|new_params
suffix:semicolon
r_int
id|retval
comma
id|find_colon
suffix:semicolon
r_int
id|size
op_assign
id|count
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|u32
id|command_flags
op_assign
l_int|0
suffix:semicolon
id|u8
id|new_mains
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
multiline_comment|/*&n;&t; * Skip over leading whitespace&n;&t; */
r_while
c_loop
(paren
id|count
op_logical_and
id|isspace
c_func
(paren
op_star
id|buffer
)paren
)paren
(brace
op_decrement
id|count
suffix:semicolon
op_increment
id|buffer
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|new_params
comma
op_amp
id|cam-&gt;params
comma
r_sizeof
(paren
r_struct
id|cam_params
)paren
)paren
suffix:semicolon
id|new_mains
op_assign
id|cam-&gt;mainsFreq
suffix:semicolon
DECL|macro|MATCH
mdefine_line|#define MATCH(x) &bslash;&n;&t;({ &bslash;&n;&t;&t;int _len = strlen(x), _ret, _colon_found; &bslash;&n;&t;&t;_ret = (_len &lt;= count &amp;&amp; strncmp(buffer, x, _len) == 0); &bslash;&n;&t;&t;if (_ret) { &bslash;&n;&t;&t;&t;buffer += _len; &bslash;&n;&t;&t;&t;count -= _len; &bslash;&n;&t;&t;&t;if (find_colon) { &bslash;&n;&t;&t;&t;&t;_colon_found = 0; &bslash;&n;&t;&t;&t;&t;while (count &amp;&amp; (*buffer == &squot; &squot; || *buffer == &squot;&bslash;t&squot; || &bslash;&n;&t;&t;&t;&t;       (!_colon_found &amp;&amp; *buffer == &squot;:&squot;))) { &bslash;&n;&t;&t;&t;&t;&t;if (*buffer == &squot;:&squot;)  &bslash;&n;&t;&t;&t;&t;&t;&t;_colon_found = 1; &bslash;&n;&t;&t;&t;&t;&t;--count; &bslash;&n;&t;&t;&t;&t;&t;++buffer; &bslash;&n;&t;&t;&t;&t;} &bslash;&n;&t;&t;&t;&t;if (!count || !_colon_found) &bslash;&n;&t;&t;&t;&t;&t;retval = -EINVAL; &bslash;&n;&t;&t;&t;&t;find_colon = 0; &bslash;&n;&t;&t;&t;} &bslash;&n;&t;&t;} &bslash;&n;&t;&t;_ret; &bslash;&n;&t;})
DECL|macro|FIRMWARE_VERSION
mdefine_line|#define FIRMWARE_VERSION(x,y) (new_params.version.firmwareVersion == (x) &amp;&amp; &bslash;&n;                               new_params.version.firmwareRevision == (y))
DECL|macro|VALUE
mdefine_line|#define VALUE &bslash;&n;&t;({ &bslash;&n;&t;&t;char *_p; &bslash;&n;&t;&t;unsigned long int _ret; &bslash;&n;&t;&t;_ret = simple_strtoul(buffer, &amp;_p, 0); &bslash;&n;&t;&t;if (_p == buffer) &bslash;&n;&t;&t;&t;retval = -EINVAL; &bslash;&n;&t;&t;else { &bslash;&n;&t;&t;&t;count -= _p - buffer; &bslash;&n;&t;&t;&t;buffer = _p; &bslash;&n;&t;&t;} &bslash;&n;&t;&t;_ret; &bslash;&n;&t;})
id|retval
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
op_logical_and
op_logical_neg
id|retval
)paren
(brace
id|find_colon
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;brightness&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|100
)paren
id|new_params.colourParams.brightness
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;contrast&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|100
)paren
(brace
multiline_comment|/* contrast is in steps of 8, so round*/
id|val
op_assign
(paren
(paren
id|val
op_plus
l_int|3
)paren
op_div
l_int|8
)paren
op_star
l_int|8
suffix:semicolon
multiline_comment|/* 1-02 firmware limits contrast to 80*/
r_if
c_cond
(paren
id|FIRMWARE_VERSION
c_func
(paren
l_int|1
comma
l_int|2
)paren
op_logical_and
id|val
OG
l_int|80
)paren
id|val
op_assign
l_int|80
suffix:semicolon
id|new_params.colourParams.contrast
op_assign
id|val
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;saturation&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|100
)paren
id|new_params.colourParams.saturation
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;sensor_fps&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
multiline_comment|/* find values so that sensorFPS is minimized,&n;&t;&t;&t;&t; * but &gt;= val */
r_if
c_cond
(paren
id|val
OG
l_int|30
)paren
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
OG
l_int|25
)paren
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|0
suffix:semicolon
id|new_params.sensorFps.baserate
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
OG
l_int|15
)paren
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|0
suffix:semicolon
id|new_params.sensorFps.baserate
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
OG
l_int|12
)paren
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|1
suffix:semicolon
id|new_params.sensorFps.baserate
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
OG
l_int|7
)paren
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|1
suffix:semicolon
id|new_params.sensorFps.baserate
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
OG
l_int|6
)paren
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|2
suffix:semicolon
id|new_params.sensorFps.baserate
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
OG
l_int|3
)paren
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|2
suffix:semicolon
id|new_params.sensorFps.baserate
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|new_params.sensorFps.divisor
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Either base rate would work here */
id|new_params.sensorFps.baserate
op_assign
l_int|1
suffix:semicolon
)brace
id|new_params.flickerControl.coarseJump
op_assign
id|flicker_jumps
(braket
id|new_mains
)braket
(braket
id|new_params.sensorFps.baserate
)braket
(braket
id|new_params.sensorFps.divisor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|new_params.flickerControl.flickerMode
)paren
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETSENSORFPS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;stream_start_line&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_int
id|max_line
op_assign
l_int|288
suffix:semicolon
r_if
c_cond
(paren
id|new_params.format.videoSize
op_eq
id|VIDEOSIZE_QCIF
)paren
id|max_line
op_assign
l_int|144
suffix:semicolon
r_if
c_cond
(paren
id|val
op_le
id|max_line
)paren
id|new_params.streamStartLine
op_assign
id|val
op_div
l_int|2
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;ecp_timing&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;normal&quot;
)paren
)paren
id|new_params.ecpTiming
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;slow&quot;
)paren
)paren
id|new_params.ecpTiming
op_assign
l_int|1
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETECPTIMING
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;color_balance_mode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;manual&quot;
)paren
)paren
id|new_params.colourBalance.balanceModeIsAuto
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;auto&quot;
)paren
)paren
id|new_params.colourBalance.balanceModeIsAuto
op_assign
l_int|1
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURBALANCE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;red_gain&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|212
)paren
id|new_params.colourBalance.redGain
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURBALANCE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;green_gain&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|212
)paren
id|new_params.colourBalance.greenGain
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURBALANCE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;blue_gain&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|212
)paren
id|new_params.colourBalance.blueGain
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOLOURBALANCE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;max_gain&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
multiline_comment|/* 1-02 firmware limits gain to 2 */
r_if
c_cond
(paren
id|FIRMWARE_VERSION
c_func
(paren
l_int|1
comma
l_int|2
)paren
op_logical_and
id|val
OG
l_int|2
)paren
id|val
op_assign
l_int|2
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
l_int|1
suffix:colon
id|new_params.exposure.gainMode
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|new_params.exposure.gainMode
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|new_params.exposure.gainMode
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|new_params.exposure.gainMode
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;exposure_mode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;auto&quot;
)paren
)paren
id|new_params.exposure.expMode
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;manual&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|new_params.exposure.expMode
op_eq
l_int|2
)paren
id|new_params.exposure.expMode
op_assign
l_int|3
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;centre_weight&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;on&quot;
)paren
)paren
id|new_params.exposure.centreWeight
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;off&quot;
)paren
)paren
id|new_params.exposure.centreWeight
op_assign
l_int|2
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;gain&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
l_int|1
suffix:colon
id|new_params.exposure.gain
op_assign
l_int|0
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|1
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|new_params.exposure.gain
op_assign
l_int|1
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|1
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|new_params.exposure.gain
op_assign
l_int|2
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|1
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|new_params.exposure.gain
op_assign
l_int|3
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|1
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
r_if
c_cond
(paren
id|new_params.exposure.gain
OG
id|new_params.exposure.gainMode
op_minus
l_int|1
)paren
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;fine_exp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
OL
l_int|256
)paren
(brace
multiline_comment|/* 1-02 firmware limits fineExp to 127*/
r_if
c_cond
(paren
id|FIRMWARE_VERSION
c_func
(paren
l_int|1
comma
l_int|2
)paren
op_logical_and
id|val
OG
l_int|127
)paren
id|val
op_assign
l_int|127
suffix:semicolon
id|new_params.exposure.fineExp
op_assign
id|val
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|1
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;coarse_exp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
OL
l_int|65536
)paren
(brace
multiline_comment|/* 1-02 firmware limits&n;&t;&t;&t;&t;&t; * coarseExp to 255 */
r_if
c_cond
(paren
id|FIRMWARE_VERSION
c_func
(paren
l_int|1
comma
l_int|2
)paren
op_logical_and
id|val
OG
l_int|255
)paren
id|val
op_assign
l_int|255
suffix:semicolon
id|new_params.exposure.coarseExpLo
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
id|new_params.exposure.coarseExpHi
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|1
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;red_comp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_ge
l_int|220
op_logical_and
id|val
op_le
l_int|255
)paren
(brace
id|new_params.exposure.redComp
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;green1_comp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_ge
l_int|214
op_logical_and
id|val
op_le
l_int|255
)paren
(brace
id|new_params.exposure.green1Comp
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;green2_comp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_ge
l_int|214
op_logical_and
id|val
op_le
l_int|255
)paren
(brace
id|new_params.exposure.green2Comp
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;blue_comp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_ge
l_int|230
op_logical_and
id|val
op_le
l_int|255
)paren
(brace
id|new_params.exposure.blueComp
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;apcor_gain1&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|command_flags
op_or_assign
id|COMMAND_SETAPCOR
suffix:semicolon
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.apcor.gain1
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;apcor_gain2&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|command_flags
op_or_assign
id|COMMAND_SETAPCOR
suffix:semicolon
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.apcor.gain2
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;apcor_gain4&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|command_flags
op_or_assign
id|COMMAND_SETAPCOR
suffix:semicolon
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.apcor.gain4
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;apcor_gain8&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|command_flags
op_or_assign
id|COMMAND_SETAPCOR
suffix:semicolon
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.apcor.gain8
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;vl_offset_gain1&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.vlOffset.gain1
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETVLOFFSET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;vl_offset_gain2&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.vlOffset.gain2
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETVLOFFSET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;vl_offset_gain4&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.vlOffset.gain4
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETVLOFFSET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;vl_offset_gain8&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.vlOffset.gain8
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETVLOFFSET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;flicker_control&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;on&quot;
)paren
)paren
(brace
id|new_params.flickerControl.flickerMode
op_assign
l_int|1
suffix:semicolon
id|new_params.exposure.expMode
op_assign
l_int|2
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;off&quot;
)paren
)paren
id|new_params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;mains_frequency&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;50&quot;
)paren
)paren
(brace
id|new_mains
op_assign
l_int|0
suffix:semicolon
id|new_params.flickerControl.coarseJump
op_assign
id|flicker_jumps
(braket
id|new_mains
)braket
(braket
id|new_params.sensorFps.baserate
)braket
(braket
id|new_params.sensorFps.divisor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|new_params.flickerControl.flickerMode
)paren
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;60&quot;
)paren
)paren
(brace
id|new_mains
op_assign
l_int|1
suffix:semicolon
id|new_params.flickerControl.coarseJump
op_assign
id|flicker_jumps
(braket
id|new_mains
)braket
(braket
id|new_params.sensorFps.baserate
)braket
(braket
id|new_params.sensorFps.divisor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|new_params.flickerControl.flickerMode
)paren
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;allowable_overexposure&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
(brace
id|new_params.flickerControl
dot
id|allowableOverExposure
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETFLICKERCTRL
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;compression_mode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;none&quot;
)paren
)paren
id|new_params.compression.mode
op_assign
id|CPIA_COMPRESSION_NONE
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;auto&quot;
)paren
)paren
id|new_params.compression.mode
op_assign
id|CPIA_COMPRESSION_AUTO
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;manual&quot;
)paren
)paren
id|new_params.compression.mode
op_assign
id|CPIA_COMPRESSION_MANUAL
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSION
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;decimation_enable&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;off&quot;
)paren
)paren
id|new_params.compression.decimation
op_assign
l_int|0
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSION
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;compression_target&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;quality&quot;
)paren
)paren
id|new_params.compressionTarget.frTargeting
op_assign
id|CPIA_COMPRESSION_TARGET_QUALITY
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|retval
op_logical_and
id|MATCH
c_func
(paren
l_string|&quot;framerate&quot;
)paren
)paren
id|new_params.compressionTarget.frTargeting
op_assign
id|CPIA_COMPRESSION_TARGET_FRAMERATE
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONTARGET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;target_framerate&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|new_params.compressionTarget.targetFR
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONTARGET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;target_quality&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|new_params.compressionTarget.targetQ
op_assign
id|val
suffix:semicolon
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONTARGET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;y_threshold&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
OL
l_int|32
)paren
id|new_params.yuvThreshold.yThreshold
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETYUVTHRESH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;uv_threshold&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
OL
l_int|32
)paren
id|new_params.yuvThreshold.uvThreshold
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETYUVTHRESH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;hysteresis&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.hysteresis
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;threshold_max&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.threshMax
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;small_step&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.smallStep
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;large_step&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.largeStep
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;decimation_hysteresis&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.decimationHysteresis
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;fr_diff_step_thresh&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.frDiffStepThresh
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;q_diff_step_thresh&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.qDiffStepThresh
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MATCH
c_func
(paren
l_string|&quot;decimation_thresh_mod&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|val
op_assign
id|VALUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|val
op_le
l_int|0xff
)paren
id|new_params.compressionParams.decimationThreshMod
op_assign
id|val
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|command_flags
op_or_assign
id|COMMAND_SETCOMPRESSIONPARAMS
suffix:semicolon
)brace
r_else
(brace
id|DBG
c_func
(paren
l_string|&quot;No match found&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_while
c_loop
(paren
id|count
op_logical_and
id|isspace
c_func
(paren
op_star
id|buffer
)paren
op_logical_and
op_star
id|buffer
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
op_decrement
id|count
suffix:semicolon
op_increment
id|buffer
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
(brace
r_if
c_cond
(paren
op_star
id|buffer
op_ne
l_char|&squot;&bslash;n&squot;
op_logical_and
op_star
id|buffer
op_ne
l_char|&squot;;&squot;
)paren
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
op_decrement
id|count
suffix:semicolon
op_increment
id|buffer
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|macro|MATCH
macro_line|#undef MATCH&t;
DECL|macro|FIRMWARE_VERSION
macro_line|#undef FIRMWARE_VERSION
DECL|macro|VALUE
macro_line|#undef VALUE
DECL|macro|FIND_VALUE
macro_line|#undef FIND_VALUE
DECL|macro|FIND_END
macro_line|#undef FIND_END
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|command_flags
op_amp
id|COMMAND_SETCOLOURPARAMS
)paren
(brace
multiline_comment|/* Adjust cam-&gt;vp to reflect these changes */
id|cam-&gt;vp.brightness
op_assign
id|new_params.colourParams.brightness
op_star
l_int|65535
op_div
l_int|100
suffix:semicolon
id|cam-&gt;vp.contrast
op_assign
id|new_params.colourParams.contrast
op_star
l_int|65535
op_div
l_int|100
suffix:semicolon
id|cam-&gt;vp.colour
op_assign
id|new_params.colourParams.saturation
op_star
l_int|65535
op_div
l_int|100
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|cam-&gt;params
comma
op_amp
id|new_params
comma
r_sizeof
(paren
r_struct
id|cam_params
)paren
)paren
suffix:semicolon
id|cam-&gt;mainsFreq
op_assign
id|new_mains
suffix:semicolon
id|cam-&gt;cmd_queue
op_or_assign
id|command_flags
suffix:semicolon
id|retval
op_assign
id|size
suffix:semicolon
)brace
r_else
id|DBG
c_func
(paren
l_string|&quot;error: %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|create_proc_cpia_cam
r_static
r_void
id|create_proc_cpia_cam
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_char
id|name
(braket
l_int|7
)braket
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia_proc_root
op_logical_or
op_logical_neg
id|cam
)paren
r_return
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;video%d&quot;
comma
id|cam-&gt;vdev.minor
)paren
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
id|name
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|cpia_proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
suffix:semicolon
id|ent-&gt;data
op_assign
id|cam
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|cpia_read_proc
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|cpia_write_proc
suffix:semicolon
id|ent-&gt;size
op_assign
l_int|3626
suffix:semicolon
id|cam-&gt;proc_entry
op_assign
id|ent
suffix:semicolon
)brace
DECL|function|destroy_proc_cpia_cam
r_static
r_void
id|destroy_proc_cpia_cam
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_char
id|name
(braket
l_int|7
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam
op_logical_or
op_logical_neg
id|cam-&gt;proc_entry
)paren
r_return
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;video%d&quot;
comma
id|cam-&gt;vdev.minor
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|name
comma
id|cpia_proc_root
)paren
suffix:semicolon
id|cam-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|proc_cpia_create
r_static
r_void
id|proc_cpia_create
c_func
(paren
r_void
)paren
(brace
id|cpia_proc_root
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;cpia&quot;
comma
id|S_IFDIR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpia_proc_root
)paren
id|cpia_proc_root-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
r_else
id|LOG
c_func
(paren
l_string|&quot;Unable to initialise /proc/cpia&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|proc_cpia_destroy
r_static
r_void
id|proc_cpia_destroy
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;cpia&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/* ----------------------- debug functions ---------------------- */
DECL|macro|printstatus
mdefine_line|#define printstatus(cam) &bslash;&n;  DBG(&quot;%02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;,&bslash;&n;&t;cam-&gt;params.status.systemState, cam-&gt;params.status.grabState, &bslash;&n;&t;cam-&gt;params.status.streamState, cam-&gt;params.status.fatalError, &bslash;&n;&t;cam-&gt;params.status.cmdError, cam-&gt;params.status.debugFlags, &bslash;&n;&t;cam-&gt;params.status.vpStatus, cam-&gt;params.status.errorCode);
multiline_comment|/* ----------------------- v4l helpers -------------------------- */
multiline_comment|/* supported frame palettes and depths */
DECL|function|valid_mode
r_static
r_inline
r_int
id|valid_mode
c_func
(paren
id|u16
id|palette
comma
id|u16
id|depth
)paren
(brace
r_return
(paren
id|palette
op_eq
id|VIDEO_PALETTE_GREY
op_logical_and
id|depth
op_eq
l_int|8
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_RGB555
op_logical_and
id|depth
op_eq
l_int|16
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_RGB565
op_logical_and
id|depth
op_eq
l_int|16
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_RGB24
op_logical_and
id|depth
op_eq
l_int|24
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_RGB32
op_logical_and
id|depth
op_eq
l_int|32
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_YUV422
op_logical_and
id|depth
op_eq
l_int|16
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_YUYV
op_logical_and
id|depth
op_eq
l_int|16
)paren
op_logical_or
(paren
id|palette
op_eq
id|VIDEO_PALETTE_UYVY
op_logical_and
id|depth
op_eq
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|match_videosize
r_static
r_int
id|match_videosize
c_func
(paren
r_int
id|width
comma
r_int
id|height
)paren
(brace
multiline_comment|/* return the best match, where &squot;best&squot; is as always&n;&t; * the largest that is not bigger than what is requested. */
r_if
c_cond
(paren
id|width
op_ge
l_int|352
op_logical_and
id|height
op_ge
l_int|288
)paren
r_return
id|VIDEOSIZE_352_288
suffix:semicolon
multiline_comment|/* CIF */
r_if
c_cond
(paren
id|width
op_ge
l_int|320
op_logical_and
id|height
op_ge
l_int|240
)paren
r_return
id|VIDEOSIZE_320_240
suffix:semicolon
multiline_comment|/* SIF */
r_if
c_cond
(paren
id|width
op_ge
l_int|288
op_logical_and
id|height
op_ge
l_int|216
)paren
r_return
id|VIDEOSIZE_288_216
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|256
op_logical_and
id|height
op_ge
l_int|192
)paren
r_return
id|VIDEOSIZE_256_192
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|224
op_logical_and
id|height
op_ge
l_int|168
)paren
r_return
id|VIDEOSIZE_224_168
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|192
op_logical_and
id|height
op_ge
l_int|144
)paren
r_return
id|VIDEOSIZE_192_144
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|176
op_logical_and
id|height
op_ge
l_int|144
)paren
r_return
id|VIDEOSIZE_176_144
suffix:semicolon
multiline_comment|/* QCIF */
r_if
c_cond
(paren
id|width
op_ge
l_int|160
op_logical_and
id|height
op_ge
l_int|120
)paren
r_return
id|VIDEOSIZE_160_120
suffix:semicolon
multiline_comment|/* QSIF */
r_if
c_cond
(paren
id|width
op_ge
l_int|128
op_logical_and
id|height
op_ge
l_int|96
)paren
r_return
id|VIDEOSIZE_128_96
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|88
op_logical_and
id|height
op_ge
l_int|72
)paren
r_return
id|VIDEOSIZE_88_72
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|64
op_logical_and
id|height
op_ge
l_int|48
)paren
r_return
id|VIDEOSIZE_64_48
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ge
l_int|48
op_logical_and
id|height
op_ge
l_int|48
)paren
r_return
id|VIDEOSIZE_48_48
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* these are the capture sizes we support */
DECL|function|set_vw_size
r_static
r_void
id|set_vw_size
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
multiline_comment|/* the col/row/start/end values are the result of simple math    */
multiline_comment|/* study the SetROI-command in cpia developers guide p 2-22      */
multiline_comment|/* streamStartLine is set to the recommended value in the cpia   */
multiline_comment|/*  developers guide p 3-37                                      */
r_switch
c_cond
(paren
id|cam-&gt;video_size
)paren
(brace
r_case
id|VIDEOSIZE_CIF
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|352
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|288
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|44
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|72
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|120
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_SIF
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|320
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|240
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|2
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|42
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|6
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|66
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|120
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_288_216
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|288
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|216
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|4
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|40
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|9
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|63
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|120
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_256_192
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|256
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|192
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|6
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|38
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|12
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|60
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|120
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_224_168
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|224
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|168
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|8
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|36
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|15
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|57
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|120
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_192_144
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|192
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|144
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|10
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|34
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|18
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|54
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|120
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_QCIF
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|176
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|144
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_QCIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|22
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|36
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_QSIF
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|160
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|120
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_QCIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|21
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|3
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|33
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_128_96
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|128
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|96
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_QCIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|3
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|19
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|6
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|30
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_88_72
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|88
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|72
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_QCIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|5
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|16
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|9
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|27
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_64_48
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|64
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|48
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_QCIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|7
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|15
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|12
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|24
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEOSIZE_48_48
suffix:colon
id|cam-&gt;vw.width
op_assign
l_int|48
suffix:semicolon
id|cam-&gt;vw.height
op_assign
l_int|48
suffix:semicolon
id|cam-&gt;params.format.videoSize
op_assign
id|VIDEOSIZE_QCIF
suffix:semicolon
id|cam-&gt;params.roi.colStart
op_assign
l_int|8
suffix:semicolon
id|cam-&gt;params.roi.colEnd
op_assign
l_int|14
suffix:semicolon
id|cam-&gt;params.roi.rowStart
op_assign
l_int|6
suffix:semicolon
id|cam-&gt;params.roi.rowEnd
op_assign
l_int|30
suffix:semicolon
id|cam-&gt;params.streamStartLine
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|LOG
c_func
(paren
l_string|&quot;bad videosize value: %d&bslash;n&quot;
comma
id|cam-&gt;video_size
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|allocate_frame_buf
r_static
r_int
id|allocate_frame_buf
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_int
id|i
suffix:semicolon
id|cam-&gt;frame_buf
op_assign
id|rvmalloc
c_func
(paren
id|FRAME_NUM
op_star
id|CPIA_MAX_FRAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;frame_buf
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAME_NUM
suffix:semicolon
id|i
op_increment
)paren
id|cam-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
id|cam-&gt;frame_buf
op_plus
id|i
op_star
id|CPIA_MAX_FRAME_SIZE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_frame_buf
r_static
r_int
id|free_frame_buf
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_int
id|i
suffix:semicolon
id|rvfree
c_func
(paren
id|cam-&gt;frame_buf
comma
id|FRAME_NUM
op_star
id|CPIA_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|cam-&gt;frame_buf
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAME_NUM
suffix:semicolon
id|i
op_increment
)paren
id|cam-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_frames
r_static
r_void
r_inline
id|free_frames
c_func
(paren
r_struct
id|cpia_frame
id|frame
(braket
id|FRAME_NUM
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAME_NUM
suffix:semicolon
id|i
op_increment
)paren
id|frame
(braket
id|i
)braket
dot
id|state
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * General functions&n; *&n; **********************************************************************/
multiline_comment|/* send an arbitrary command to the camera */
DECL|function|do_command
r_static
r_int
id|do_command
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
comma
id|u16
id|command
comma
id|u8
id|a
comma
id|u8
id|b
comma
id|u8
id|c
comma
id|u8
id|d
)paren
(brace
r_int
id|retval
comma
id|datasize
suffix:semicolon
id|u8
id|cmd
(braket
l_int|8
)braket
comma
id|data
(braket
l_int|8
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|CPIA_COMMAND_GetCPIAVersion
suffix:colon
r_case
id|CPIA_COMMAND_GetPnPID
suffix:colon
r_case
id|CPIA_COMMAND_GetCameraStatus
suffix:colon
r_case
id|CPIA_COMMAND_GetVPVersion
suffix:colon
id|datasize
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetColourParams
suffix:colon
r_case
id|CPIA_COMMAND_GetColourBalance
suffix:colon
r_case
id|CPIA_COMMAND_GetExposure
suffix:colon
id|down
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|datasize
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|datasize
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cmd
(braket
l_int|0
)braket
op_assign
id|command
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
id|command
op_amp
l_int|0xff
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|a
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|b
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|c
suffix:semicolon
id|cmd
(braket
l_int|5
)braket
op_assign
id|d
suffix:semicolon
id|cmd
(braket
l_int|6
)braket
op_assign
id|datasize
suffix:semicolon
id|cmd
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|cam-&gt;ops
op_member_access_from_pointer
id|transferCmd
c_func
(paren
id|cam-&gt;lowlevel_data
comma
id|cmd
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%x - failed, retval=%d&bslash;n&quot;
comma
id|command
comma
id|retval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
op_eq
id|CPIA_COMMAND_GetColourParams
op_logical_or
id|command
op_eq
id|CPIA_COMMAND_GetColourBalance
op_logical_or
id|command
op_eq
id|CPIA_COMMAND_GetExposure
)paren
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|CPIA_COMMAND_GetCPIAVersion
suffix:colon
id|cam-&gt;params.version.firmwareVersion
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|cam-&gt;params.version.firmwareRevision
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|cam-&gt;params.version.vcVersion
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|cam-&gt;params.version.vcRevision
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetPnPID
suffix:colon
id|cam-&gt;params.pnpID.vendor
op_assign
id|data
(braket
l_int|0
)braket
op_plus
(paren
(paren
(paren
id|u16
)paren
id|data
(braket
l_int|1
)braket
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|cam-&gt;params.pnpID.product
op_assign
id|data
(braket
l_int|2
)braket
op_plus
(paren
(paren
(paren
id|u16
)paren
id|data
(braket
l_int|3
)braket
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|cam-&gt;params.pnpID.deviceRevision
op_assign
id|data
(braket
l_int|4
)braket
op_plus
(paren
(paren
(paren
id|u16
)paren
id|data
(braket
l_int|5
)braket
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetCameraStatus
suffix:colon
id|cam-&gt;params.status.systemState
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|cam-&gt;params.status.grabState
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|cam-&gt;params.status.streamState
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|cam-&gt;params.status.fatalError
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|cam-&gt;params.status.cmdError
op_assign
id|data
(braket
l_int|4
)braket
suffix:semicolon
id|cam-&gt;params.status.debugFlags
op_assign
id|data
(braket
l_int|5
)braket
suffix:semicolon
id|cam-&gt;params.status.vpStatus
op_assign
id|data
(braket
l_int|6
)braket
suffix:semicolon
id|cam-&gt;params.status.errorCode
op_assign
id|data
(braket
l_int|7
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetVPVersion
suffix:colon
id|cam-&gt;params.vpVersion.vpVersion
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|cam-&gt;params.vpVersion.vpRevision
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|cam-&gt;params.vpVersion.cameraHeadID
op_assign
id|data
(braket
l_int|2
)braket
op_plus
(paren
(paren
(paren
id|u16
)paren
id|data
(braket
l_int|3
)braket
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetColourParams
suffix:colon
id|cam-&gt;params.colourParams.brightness
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|cam-&gt;params.colourParams.contrast
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|cam-&gt;params.colourParams.saturation
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetColourBalance
suffix:colon
id|cam-&gt;params.colourBalance.redGain
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|cam-&gt;params.colourBalance.greenGain
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|cam-&gt;params.colourBalance.blueGain
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIA_COMMAND_GetExposure
suffix:colon
id|cam-&gt;params.exposure.gain
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|cam-&gt;params.exposure.fineExp
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|cam-&gt;params.exposure.coarseExpLo
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|cam-&gt;params.exposure.coarseExpHi
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|cam-&gt;params.exposure.redComp
op_assign
id|data
(braket
l_int|4
)braket
suffix:semicolon
id|cam-&gt;params.exposure.green1Comp
op_assign
id|data
(braket
l_int|5
)braket
suffix:semicolon
id|cam-&gt;params.exposure.green2Comp
op_assign
id|data
(braket
l_int|6
)braket
suffix:semicolon
id|cam-&gt;params.exposure.blueComp
op_assign
id|data
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* If the *Comp parameters are wacko, generate&n;&t;&t;&t; * a warning, and reset them back to default&n;&t;&t;&t; * values.             - rich@annexia.org&n;&t;&t;&t; */
r_if
c_cond
(paren
id|cam-&gt;params.exposure.redComp
template_param
l_int|255
op_logical_or
id|cam-&gt;params.exposure.green1Comp
template_param
l_int|255
op_logical_or
id|cam-&gt;params.exposure.green2Comp
template_param
l_int|255
op_logical_or
id|cam-&gt;params.exposure.blueComp
template_param
l_int|255
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;*_comp parameters have gone AWOL (%d/%d/%d/%d) - reseting them&bslash;n&quot;
comma
id|cam-&gt;params.exposure.redComp
comma
id|cam-&gt;params.exposure.green1Comp
comma
id|cam-&gt;params.exposure.green2Comp
comma
id|cam-&gt;params.exposure.blueComp
)paren
suffix:semicolon
id|cam-&gt;params.exposure.redComp
op_assign
l_int|220
suffix:semicolon
id|cam-&gt;params.exposure.green1Comp
op_assign
l_int|214
suffix:semicolon
id|cam-&gt;params.exposure.green2Comp
op_assign
l_int|214
suffix:semicolon
id|cam-&gt;params.exposure.blueComp
op_assign
l_int|230
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* send a command  to the camera with an additional data transaction */
DECL|function|do_command_extended
r_static
r_int
id|do_command_extended
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
comma
id|u16
id|command
comma
id|u8
id|a
comma
id|u8
id|b
comma
id|u8
id|c
comma
id|u8
id|d
comma
id|u8
id|e
comma
id|u8
id|f
comma
id|u8
id|g
comma
id|u8
id|h
comma
id|u8
id|i
comma
id|u8
id|j
comma
id|u8
id|k
comma
id|u8
id|l
)paren
(brace
r_int
id|retval
suffix:semicolon
id|u8
id|cmd
(braket
l_int|8
)braket
comma
id|data
(braket
l_int|8
)braket
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|command
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
id|command
op_amp
l_int|0xff
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|a
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|b
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|c
suffix:semicolon
id|cmd
(braket
l_int|5
)braket
op_assign
id|d
suffix:semicolon
id|cmd
(braket
l_int|6
)braket
op_assign
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|e
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|f
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|g
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|h
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|i
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|j
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|k
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|l
suffix:semicolon
id|retval
op_assign
id|cam-&gt;ops
op_member_access_from_pointer
id|transferCmd
c_func
(paren
id|cam-&gt;lowlevel_data
comma
id|cmd
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|LOG
c_func
(paren
l_string|&quot;%x - failed&bslash;n&quot;
comma
id|command
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * Colorspace conversion&n; *&n; **********************************************************************/
DECL|macro|LIMIT
mdefine_line|#define LIMIT(x) ((((x)&gt;0xffffff)?0xff0000:(((x)&lt;=0xffff)?0:(x)&amp;0xff0000))&gt;&gt;16)
DECL|function|yuvconvert
r_static
r_int
id|yuvconvert
c_func
(paren
r_int
r_char
op_star
id|yuv
comma
r_int
r_char
op_star
id|rgb
comma
r_int
id|out_fmt
comma
r_int
id|in_uyvy
comma
r_int
id|mmap_kludge
)paren
(brace
r_int
id|y
comma
id|u
comma
id|v
comma
id|r
comma
id|g
comma
id|b
comma
id|y1
suffix:semicolon
r_switch
c_cond
(paren
id|out_fmt
)paren
(brace
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
r_if
c_cond
(paren
id|in_uyvy
)paren
(brace
id|u
op_assign
op_star
id|yuv
op_increment
op_minus
l_int|128
suffix:semicolon
id|y
op_assign
(paren
op_star
id|yuv
op_increment
op_minus
l_int|16
)paren
op_star
l_int|76310
suffix:semicolon
id|v
op_assign
op_star
id|yuv
op_increment
op_minus
l_int|128
suffix:semicolon
id|y1
op_assign
(paren
op_star
id|yuv
op_minus
l_int|16
)paren
op_star
l_int|76310
suffix:semicolon
)brace
r_else
(brace
id|y
op_assign
(paren
op_star
id|yuv
op_increment
op_minus
l_int|16
)paren
op_star
l_int|76310
suffix:semicolon
id|u
op_assign
op_star
id|yuv
op_increment
op_minus
l_int|128
suffix:semicolon
id|y1
op_assign
(paren
op_star
id|yuv
op_increment
op_minus
l_int|16
)paren
op_star
l_int|76310
suffix:semicolon
id|v
op_assign
op_star
id|yuv
op_minus
l_int|128
suffix:semicolon
)brace
id|r
op_assign
l_int|104635
op_star
id|v
suffix:semicolon
id|g
op_assign
op_minus
l_int|25690
op_star
id|u
op_plus
op_minus
l_int|53294
op_star
id|v
suffix:semicolon
id|b
op_assign
l_int|132278
op_star
id|u
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|y
op_assign
op_star
id|yuv
op_increment
suffix:semicolon
id|u
op_assign
op_star
id|yuv
op_increment
suffix:semicolon
id|y1
op_assign
op_star
id|yuv
op_increment
suffix:semicolon
id|v
op_assign
op_star
id|yuv
suffix:semicolon
multiline_comment|/* Just to avoid compiler warnings */
id|r
op_assign
l_int|0
suffix:semicolon
id|g
op_assign
l_int|0
suffix:semicolon
id|b
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|out_fmt
)paren
(brace
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
op_star
id|rgb
op_increment
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
op_amp
l_int|0xf8
)paren
op_lshift
l_int|2
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
op_amp
l_int|0xf8
)paren
op_rshift
l_int|1
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
op_amp
l_int|0xf8
)paren
op_lshift
l_int|2
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
op_star
id|rgb
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
op_amp
l_int|0xf8
)paren
op_rshift
l_int|1
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
r_return
l_int|4
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
op_star
id|rgb
op_increment
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
op_amp
l_int|0xfc
)paren
op_lshift
l_int|3
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
op_amp
l_int|0xf8
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
op_amp
l_int|0xfc
)paren
op_lshift
l_int|3
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
op_star
id|rgb
op_assign
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
op_amp
l_int|0xf8
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
r_return
l_int|4
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
r_if
c_cond
(paren
id|mmap_kludge
)paren
(brace
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
suffix:semicolon
)brace
r_return
l_int|6
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
r_if
c_cond
(paren
id|mmap_kludge
)paren
(brace
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
suffix:semicolon
id|rgb
op_increment
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
suffix:semicolon
id|rgb
op_increment
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|rgb
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
suffix:semicolon
)brace
r_return
l_int|8
suffix:semicolon
r_case
id|VIDEO_PALETTE_GREY
suffix:colon
op_star
id|rgb
op_increment
op_assign
id|y
suffix:semicolon
op_star
id|rgb
op_assign
id|y1
suffix:semicolon
r_return
l_int|2
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
op_star
id|rgb
op_increment
op_assign
id|y
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|u
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|y1
suffix:semicolon
op_star
id|rgb
op_assign
id|v
suffix:semicolon
r_return
l_int|4
suffix:semicolon
r_case
id|VIDEO_PALETTE_UYVY
suffix:colon
op_star
id|rgb
op_increment
op_assign
id|u
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|y
suffix:semicolon
op_star
id|rgb
op_increment
op_assign
id|v
suffix:semicolon
op_star
id|rgb
op_assign
id|y1
suffix:semicolon
r_return
l_int|4
suffix:semicolon
r_default
suffix:colon
id|DBG
c_func
(paren
l_string|&quot;Empty: %d&bslash;n&quot;
comma
id|out_fmt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|skipcount
r_static
r_int
id|skipcount
c_func
(paren
r_int
id|count
comma
r_int
id|fmt
)paren
(brace
r_switch
c_cond
(paren
id|fmt
)paren
(brace
r_case
id|VIDEO_PALETTE_GREY
suffix:colon
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
r_case
id|VIDEO_PALETTE_UYVY
suffix:colon
r_return
l_int|2
op_star
id|count
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
r_return
l_int|3
op_star
id|count
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
r_return
l_int|4
op_star
id|count
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|parse_picture
r_static
r_int
id|parse_picture
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
comma
r_int
id|size
)paren
(brace
id|u8
op_star
id|obuf
comma
op_star
id|ibuf
comma
op_star
id|end_obuf
suffix:semicolon
r_int
id|ll
comma
id|in_uyvy
comma
id|compressed
comma
id|origsize
comma
id|out_fmt
suffix:semicolon
multiline_comment|/* make sure params don&squot;t change while we are decoding */
id|down
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|obuf
op_assign
id|cam-&gt;decompressed_frame.data
suffix:semicolon
id|end_obuf
op_assign
id|obuf
op_plus
id|CPIA_MAX_FRAME_SIZE
suffix:semicolon
id|ibuf
op_assign
id|cam-&gt;raw_image
suffix:semicolon
id|origsize
op_assign
id|size
suffix:semicolon
id|out_fmt
op_assign
id|cam-&gt;vp.palette
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ibuf
(braket
l_int|0
)braket
op_ne
id|MAGIC_0
)paren
op_logical_or
(paren
id|ibuf
(braket
l_int|1
)braket
op_ne
id|MAGIC_1
)paren
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;header not found&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ibuf
(braket
l_int|16
)braket
op_ne
id|VIDEOSIZE_QCIF
)paren
op_logical_and
(paren
id|ibuf
(braket
l_int|16
)braket
op_ne
id|VIDEOSIZE_CIF
)paren
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;wrong video size&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ibuf
(braket
l_int|17
)braket
op_ne
id|SUBSAMPLE_422
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;illegal subtype %d&bslash;n&quot;
comma
id|ibuf
(braket
l_int|17
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ibuf
(braket
l_int|18
)braket
op_ne
id|YUVORDER_YUYV
op_logical_and
id|ibuf
(braket
l_int|18
)braket
op_ne
id|YUVORDER_UYVY
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;illegal yuvorder %d&bslash;n&quot;
comma
id|ibuf
(braket
l_int|18
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|in_uyvy
op_assign
id|ibuf
(braket
l_int|18
)braket
op_eq
id|YUVORDER_UYVY
suffix:semicolon
macro_line|#if 0
multiline_comment|/* FIXME: ROI mismatch occurs when switching capture sizes */
r_if
c_cond
(paren
(paren
id|ibuf
(braket
l_int|24
)braket
op_ne
id|cam-&gt;params.roi.colStart
)paren
op_logical_or
(paren
id|ibuf
(braket
l_int|25
)braket
op_ne
id|cam-&gt;params.roi.colEnd
)paren
op_logical_or
(paren
id|ibuf
(braket
l_int|26
)braket
op_ne
id|cam-&gt;params.roi.rowStart
)paren
op_logical_or
(paren
id|ibuf
(braket
l_int|27
)braket
op_ne
id|cam-&gt;params.roi.rowEnd
)paren
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;ROI mismatch&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|ibuf
(braket
l_int|28
)braket
op_ne
id|NOT_COMPRESSED
)paren
op_logical_and
(paren
id|ibuf
(braket
l_int|28
)braket
op_ne
id|COMPRESSED
)paren
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;illegal compression %d&bslash;n&quot;
comma
id|ibuf
(braket
l_int|28
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|compressed
op_assign
(paren
id|ibuf
(braket
l_int|28
)braket
op_eq
id|COMPRESSED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibuf
(braket
l_int|29
)braket
op_ne
id|NO_DECIMATION
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;decimation not supported&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cam-&gt;params.yuvThreshold.yThreshold
op_assign
id|ibuf
(braket
l_int|30
)braket
suffix:semicolon
id|cam-&gt;params.yuvThreshold.uvThreshold
op_assign
id|ibuf
(braket
l_int|31
)braket
suffix:semicolon
id|cam-&gt;params.status.systemState
op_assign
id|ibuf
(braket
l_int|32
)braket
suffix:semicolon
id|cam-&gt;params.status.grabState
op_assign
id|ibuf
(braket
l_int|33
)braket
suffix:semicolon
id|cam-&gt;params.status.streamState
op_assign
id|ibuf
(braket
l_int|34
)braket
suffix:semicolon
id|cam-&gt;params.status.fatalError
op_assign
id|ibuf
(braket
l_int|35
)braket
suffix:semicolon
id|cam-&gt;params.status.cmdError
op_assign
id|ibuf
(braket
l_int|36
)braket
suffix:semicolon
id|cam-&gt;params.status.debugFlags
op_assign
id|ibuf
(braket
l_int|37
)braket
suffix:semicolon
id|cam-&gt;params.status.vpStatus
op_assign
id|ibuf
(braket
l_int|38
)braket
suffix:semicolon
id|cam-&gt;params.status.errorCode
op_assign
id|ibuf
(braket
l_int|39
)braket
suffix:semicolon
id|cam-&gt;fps
op_assign
id|ibuf
(braket
l_int|41
)braket
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|ibuf
op_add_assign
id|FRAME_HEADER_SIZE
suffix:semicolon
id|size
op_sub_assign
id|FRAME_HEADER_SIZE
suffix:semicolon
id|ll
op_assign
id|ibuf
(braket
l_int|0
)braket
op_or
(paren
id|ibuf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|ibuf
op_add_assign
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|size
op_sub_assign
(paren
id|ll
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
l_int|0
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;Insufficient data in buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ll
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|compressed
op_logical_or
(paren
id|compressed
op_logical_and
op_logical_neg
(paren
op_star
id|ibuf
op_amp
l_int|1
)paren
)paren
)paren
(brace
id|obuf
op_add_assign
id|yuvconvert
c_func
(paren
id|ibuf
comma
id|obuf
comma
id|out_fmt
comma
id|in_uyvy
comma
id|cam-&gt;mmap_kludge
)paren
suffix:semicolon
id|ibuf
op_add_assign
l_int|4
suffix:semicolon
id|ll
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*skip compressed interval from previous frame*/
r_int
id|skipsize
op_assign
id|skipcount
c_func
(paren
op_star
id|ibuf
op_rshift
l_int|1
comma
id|out_fmt
)paren
suffix:semicolon
id|obuf
op_add_assign
id|skipsize
suffix:semicolon
r_if
c_cond
(paren
id|obuf
OG
id|end_obuf
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;Insufficient data in buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_increment
id|ibuf
suffix:semicolon
id|ll
op_decrement
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ll
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_star
id|ibuf
op_ne
id|EOL
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;EOL not found giving up after %d/%d&quot;
l_string|&quot; bytes&bslash;n&quot;
comma
id|origsize
op_minus
id|size
comma
id|origsize
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ibuf
op_increment
suffix:semicolon
multiline_comment|/* skip over EOL */
r_if
c_cond
(paren
(paren
id|size
OG
l_int|3
)paren
op_logical_and
(paren
id|ibuf
(braket
l_int|0
)braket
op_eq
id|EOI
)paren
op_logical_and
(paren
id|ibuf
(braket
l_int|1
)braket
op_eq
id|EOI
)paren
op_logical_and
(paren
id|ibuf
(braket
l_int|2
)braket
op_eq
id|EOI
)paren
op_logical_and
(paren
id|ibuf
(braket
l_int|3
)braket
op_eq
id|EOI
)paren
)paren
(brace
id|size
op_sub_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
l_int|1
)paren
(brace
id|ll
op_assign
id|ibuf
(braket
l_int|0
)braket
op_or
(paren
id|ibuf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|ibuf
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* skip over line length */
)brace
)brace
r_else
(brace
id|LOG
c_func
(paren
l_string|&quot;line length was not 1 but %d after %d/%d bytes&bslash;n&quot;
comma
id|ll
comma
id|origsize
op_minus
id|size
comma
id|origsize
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|cam-&gt;decompressed_frame.count
op_assign
id|obuf
op_minus
id|cam-&gt;decompressed_frame.data
suffix:semicolon
r_return
id|cam-&gt;decompressed_frame.count
suffix:semicolon
)brace
multiline_comment|/* InitStreamCap wrapper to select correct start line */
DECL|function|init_stream_cap
r_static
r_inline
r_int
id|init_stream_cap
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_return
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_InitStreamCap
comma
l_int|0
comma
id|cam-&gt;params.streamStartLine
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* update various camera modes and settings */
DECL|function|dispatch_commands
r_static
r_void
id|dispatch_commands
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
id|down
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_eq
id|COMMAND_NONE
)paren
(brace
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEB_BYTE
c_func
(paren
id|cam-&gt;cmd_queue
)paren
suffix:semicolon
id|DEB_BYTE
c_func
(paren
id|cam-&gt;cmd_queue
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETCOLOURPARAMS
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourParams
comma
id|cam-&gt;params.colourParams.brightness
comma
id|cam-&gt;params.colourParams.contrast
comma
id|cam-&gt;params.colourParams.saturation
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETCOMPRESSION
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetCompression
comma
id|cam-&gt;params.compression.mode
comma
id|cam-&gt;params.compression.decimation
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETFORMAT
)paren
(brace
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetFormat
comma
id|cam-&gt;params.format.videoSize
comma
id|cam-&gt;params.format.subSample
comma
id|cam-&gt;params.format.yuvOrder
comma
l_int|0
)paren
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetROI
comma
id|cam-&gt;params.roi.colStart
comma
id|cam-&gt;params.roi.colEnd
comma
id|cam-&gt;params.roi.rowStart
comma
id|cam-&gt;params.roi.rowEnd
)paren
suffix:semicolon
id|cam-&gt;first_frame
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETCOMPRESSIONTARGET
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetCompressionTarget
comma
id|cam-&gt;params.compressionTarget.frTargeting
comma
id|cam-&gt;params.compressionTarget.targetFR
comma
id|cam-&gt;params.compressionTarget.targetQ
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETYUVTHRESH
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetYUVThresh
comma
id|cam-&gt;params.yuvThreshold.yThreshold
comma
id|cam-&gt;params.yuvThreshold.uvThreshold
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETECPTIMING
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetECPTiming
comma
id|cam-&gt;params.ecpTiming
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETCOMPRESSIONPARAMS
)paren
id|do_command_extended
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetCompressionParams
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|cam-&gt;params.compressionParams.hysteresis
comma
id|cam-&gt;params.compressionParams.threshMax
comma
id|cam-&gt;params.compressionParams.smallStep
comma
id|cam-&gt;params.compressionParams.largeStep
comma
id|cam-&gt;params.compressionParams.decimationHysteresis
comma
id|cam-&gt;params.compressionParams.frDiffStepThresh
comma
id|cam-&gt;params.compressionParams.qDiffStepThresh
comma
id|cam-&gt;params.compressionParams.decimationThreshMod
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETEXPOSURE
)paren
id|do_command_extended
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetExposure
comma
id|cam-&gt;params.exposure.gainMode
comma
id|cam-&gt;params.exposure.expMode
comma
id|cam-&gt;params.exposure.compMode
comma
id|cam-&gt;params.exposure.centreWeight
comma
id|cam-&gt;params.exposure.gain
comma
id|cam-&gt;params.exposure.fineExp
comma
id|cam-&gt;params.exposure.coarseExpLo
comma
id|cam-&gt;params.exposure.coarseExpHi
comma
id|cam-&gt;params.exposure.redComp
comma
id|cam-&gt;params.exposure.green1Comp
comma
id|cam-&gt;params.exposure.green2Comp
comma
id|cam-&gt;params.exposure.blueComp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETCOLOURBALANCE
)paren
(brace
r_if
c_cond
(paren
id|cam-&gt;params.colourBalance.balanceModeIsAuto
)paren
(brace
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourBalance
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourBalance
comma
l_int|1
comma
id|cam-&gt;params.colourBalance.redGain
comma
id|cam-&gt;params.colourBalance.greenGain
comma
id|cam-&gt;params.colourBalance.blueGain
)paren
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourBalance
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETSENSORFPS
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetSensorFPS
comma
id|cam-&gt;params.sensorFps.divisor
comma
id|cam-&gt;params.sensorFps.baserate
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETAPCOR
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetApcor
comma
id|cam-&gt;params.apcor.gain1
comma
id|cam-&gt;params.apcor.gain2
comma
id|cam-&gt;params.apcor.gain4
comma
id|cam-&gt;params.apcor.gain8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETFLICKERCTRL
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetFlickerCtrl
comma
id|cam-&gt;params.flickerControl.flickerMode
comma
id|cam-&gt;params.flickerControl.coarseJump
comma
id|cam-&gt;params.flickerControl.allowableOverExposure
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETVLOFFSET
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetVLOffset
comma
id|cam-&gt;params.vlOffset.gain1
comma
id|cam-&gt;params.vlOffset.gain2
comma
id|cam-&gt;params.vlOffset.gain4
comma
id|cam-&gt;params.vlOffset.gain8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_PAUSE
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_EndStreamCap
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_RESUME
)paren
id|init_stream_cap
c_func
(paren
id|cam
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|cam-&gt;cmd_queue
op_assign
id|COMMAND_NONE
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* kernel thread function to read image from camera */
DECL|function|fetch_frame
r_static
r_void
id|fetch_frame
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|image_size
comma
id|retry
suffix:semicolon
r_struct
id|cam_data
op_star
id|cam
op_assign
(paren
r_struct
id|cam_data
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|oldjif
comma
id|rate
comma
id|diff
suffix:semicolon
multiline_comment|/* Allow up to two bad images in a row to be read and&n;&t; * ignored before an error is reported */
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|3
suffix:semicolon
op_increment
id|retry
)paren
(brace
r_if
c_cond
(paren
id|retry
)paren
id|DBG
c_func
(paren
l_string|&quot;retry=%d&bslash;n&quot;
comma
id|retry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;ops
)paren
r_continue
suffix:semicolon
multiline_comment|/* load first frame always uncompressed */
r_if
c_cond
(paren
id|cam-&gt;first_frame
op_logical_and
id|cam-&gt;params.compression.mode
op_ne
id|CPIA_COMPRESSION_NONE
)paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetCompression
comma
id|CPIA_COMPRESSION_NONE
comma
id|NO_DECIMATION
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* init camera upload */
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetGrabMode
comma
id|CPIA_GRAB_CONTINUOUS
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GrabFrame
comma
l_int|0
comma
id|cam-&gt;params.streamStartLine
comma
l_int|0
comma
l_int|0
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;ops-&gt;wait_for_stream_ready
)paren
(brace
multiline_comment|/* loop until image ready */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCameraStatus
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cam-&gt;params.status.streamState
op_ne
id|STREAM_READY
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
multiline_comment|/* sleep for 10 ms, hopefully ;) */
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCameraStatus
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* grab image from camera */
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|oldjif
op_assign
id|jiffies
suffix:semicolon
id|image_size
op_assign
id|cam-&gt;ops
op_member_access_from_pointer
id|streamRead
c_func
(paren
id|cam-&gt;lowlevel_data
comma
id|cam-&gt;raw_image
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|image_size
op_le
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;streamRead failed: %d&bslash;n&quot;
comma
id|image_size
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rate
op_assign
id|image_size
op_star
id|HZ
op_div
l_int|1024
suffix:semicolon
id|diff
op_assign
id|jiffies
op_minus
id|oldjif
suffix:semicolon
id|cam-&gt;transfer_rate
op_assign
id|diff
op_eq
l_int|0
ques
c_cond
id|rate
suffix:colon
id|rate
op_div
id|diff
suffix:semicolon
multiline_comment|/* diff==0 ? unlikely but possible */
multiline_comment|/* camera idle now so dispatch queued commands */
id|dispatch_commands
c_func
(paren
id|cam
)paren
suffix:semicolon
multiline_comment|/* Update our knowledge of the camera state - FIXME: necessary? */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetColourBalance
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetExposure
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* decompress and convert image to by copying it from&n;&t;&t; * raw_image to decompressed_frame&n;&t;&t; */
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|cam-&gt;image_size
op_assign
id|parse_picture
c_func
(paren
id|cam
comma
id|image_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;image_size
op_le
l_int|0
)paren
id|DBG
c_func
(paren
l_string|&quot;parse_picture failed %d&bslash;n&quot;
comma
id|cam-&gt;image_size
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry
OL
l_int|3
)paren
(brace
multiline_comment|/* FIXME: this only works for double buffering */
r_if
c_cond
(paren
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|state
op_eq
id|FRAME_READY
)paren
(brace
id|memcpy
c_func
(paren
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|data
comma
id|cam-&gt;decompressed_frame.data
comma
id|cam-&gt;decompressed_frame.count
)paren
suffix:semicolon
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|state
op_assign
id|FRAME_DONE
suffix:semicolon
)brace
r_else
id|cam-&gt;decompressed_frame.state
op_assign
id|FRAME_DONE
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|cam-&gt;first_frame
op_logical_and
id|cam-&gt;params.compression.mode
op_ne
id|CPIA_COMPRESSION_NONE
)paren
(brace
id|cam-&gt;first_frame
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;cmd_queue
op_or_assign
id|COMMAND_SETCOMPRESSION
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|cam-&gt;first_frame
)paren
(brace
id|cam-&gt;first_frame
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;cmd_queue
op_or_assign
id|COMMAND_SETCOMPRESSION
suffix:semicolon
id|cam-&gt;cmd_queue
op_or_assign
id|COMMAND_SETEXPOSURE
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
DECL|function|capture_frame
r_static
r_int
id|capture_frame
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
comma
r_struct
id|video_mmap
op_star
id|vm
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;frame_buf
)paren
(brace
multiline_comment|/* we do lazy allocation */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|allocate_frame_buf
c_func
(paren
id|cam
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* FIXME: the first frame seems to be captured by the camera&n;&t;   without regards to any initial settings, so we throw away&n;&t;   that one, the next one is generated with our settings&n;&t;   (exposure, color balance, ...)&n;&t;*/
r_if
c_cond
(paren
id|cam-&gt;first_frame
)paren
(brace
id|cam-&gt;curframe
op_assign
id|vm-&gt;frame
suffix:semicolon
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|state
op_assign
id|FRAME_READY
suffix:semicolon
id|fetch_frame
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|state
op_ne
id|FRAME_DONE
)paren
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|cam-&gt;curframe
op_assign
id|vm-&gt;frame
suffix:semicolon
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|state
op_assign
id|FRAME_READY
suffix:semicolon
id|fetch_frame
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;frame
(braket
id|cam-&gt;curframe
)braket
dot
id|state
op_ne
id|FRAME_DONE
)paren
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|goto_high_power
r_static
r_int
id|goto_high_power
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GotoHiPower
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* windows driver does it too */
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCameraStatus
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.status.systemState
op_eq
id|HI_POWER_STATE
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;camera now in HIGH power state&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printstatus
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|goto_low_power
r_static
r_int
id|goto_low_power
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GotoLoPower
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCameraStatus
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.status.systemState
op_eq
id|LO_POWER_STATE
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;camera now in LOW power state&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printstatus
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|save_camera_state
r_static
r_void
id|save_camera_state
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetColourBalance
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetExposure
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%d/%d/%d/%d/%d/%d/%d/%d&bslash;n&quot;
comma
id|cam-&gt;params.exposure.gain
comma
id|cam-&gt;params.exposure.fineExp
comma
id|cam-&gt;params.exposure.coarseExpLo
comma
id|cam-&gt;params.exposure.coarseExpHi
comma
id|cam-&gt;params.exposure.redComp
comma
id|cam-&gt;params.exposure.green1Comp
comma
id|cam-&gt;params.exposure.green2Comp
comma
id|cam-&gt;params.exposure.blueComp
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%d/%d/%d&bslash;n&quot;
comma
id|cam-&gt;params.colourBalance.redGain
comma
id|cam-&gt;params.colourBalance.greenGain
comma
id|cam-&gt;params.colourBalance.blueGain
)paren
suffix:semicolon
)brace
DECL|function|set_camera_state
r_static
r_void
id|set_camera_state
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_if
c_cond
(paren
id|cam-&gt;params.colourBalance.balanceModeIsAuto
)paren
(brace
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourBalance
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourBalance
comma
l_int|1
comma
id|cam-&gt;params.colourBalance.redGain
comma
id|cam-&gt;params.colourBalance.greenGain
comma
id|cam-&gt;params.colourBalance.blueGain
)paren
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetColourBalance
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|do_command_extended
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetExposure
comma
id|cam-&gt;params.exposure.gainMode
comma
l_int|1
comma
l_int|1
comma
id|cam-&gt;params.exposure.centreWeight
comma
id|cam-&gt;params.exposure.gain
comma
id|cam-&gt;params.exposure.fineExp
comma
id|cam-&gt;params.exposure.coarseExpLo
comma
id|cam-&gt;params.exposure.coarseExpHi
comma
id|cam-&gt;params.exposure.redComp
comma
id|cam-&gt;params.exposure.green1Comp
comma
id|cam-&gt;params.exposure.green2Comp
comma
id|cam-&gt;params.exposure.blueComp
)paren
suffix:semicolon
id|do_command_extended
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_SetExposure
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;params.exposure.gainMode
)paren
id|cam-&gt;params.exposure.gainMode
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;params.exposure.expMode
)paren
id|cam-&gt;params.exposure.expMode
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;params.exposure.centreWeight
)paren
id|cam-&gt;params.exposure.centreWeight
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;cmd_queue
op_assign
id|COMMAND_SETCOMPRESSION
op_or
id|COMMAND_SETCOMPRESSIONTARGET
op_or
id|COMMAND_SETCOLOURPARAMS
op_or
id|COMMAND_SETFORMAT
op_or
id|COMMAND_SETYUVTHRESH
op_or
id|COMMAND_SETECPTIMING
op_or
id|COMMAND_SETCOMPRESSIONPARAMS
op_or
macro_line|#if 0
id|COMMAND_SETEXPOSURE
op_or
macro_line|#endif
id|COMMAND_SETCOLOURBALANCE
op_or
id|COMMAND_SETSENSORFPS
op_or
id|COMMAND_SETAPCOR
op_or
id|COMMAND_SETFLICKERCTRL
op_or
id|COMMAND_SETVLOFFSET
suffix:semicolon
id|dispatch_commands
c_func
(paren
id|cam
)paren
suffix:semicolon
id|save_camera_state
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|get_version_information
r_static
r_void
id|get_version_information
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
multiline_comment|/* GetCPIAVersion */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCPIAVersion
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* GetPnPID */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetPnPID
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize camera */
DECL|function|reset_camera
r_static
r_int
id|reset_camera
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
multiline_comment|/* Start the camera in low power mode */
r_if
c_cond
(paren
id|goto_low_power
c_func
(paren
id|cam
)paren
)paren
(brace
r_if
c_cond
(paren
id|cam-&gt;params.status.systemState
op_ne
id|WARM_BOOT_STATE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* FIXME: this is just dirty trial and error */
id|reset_camera_struct
c_func
(paren
id|cam
)paren
suffix:semicolon
id|goto_high_power
c_func
(paren
id|cam
)paren
suffix:semicolon
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_DiscardFrame
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|goto_low_power
c_func
(paren
id|cam
)paren
)paren
r_return
op_minus
id|NODEV
suffix:semicolon
)brace
multiline_comment|/* procedure described in developer&squot;s guide p3-28 */
multiline_comment|/* Check the firmware version FIXME: should we check PNPID? */
id|cam-&gt;params.version.firmwareVersion
op_assign
l_int|0
suffix:semicolon
id|get_version_information
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.version.firmwareVersion
op_ne
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* The fatal error checking should be done after&n;&t; * the camera powers up (developer&squot;s guide p 3-38) */
multiline_comment|/* Set streamState before transition to high power to avoid bug&n;&t; * in firmware 1-02 */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_ModifyCameraStatus
comma
id|STREAMSTATE
comma
l_int|0
comma
id|STREAM_NOT_READY
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* GotoHiPower */
r_if
c_cond
(paren
id|goto_high_power
c_func
(paren
id|cam
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Check the camera status */
r_if
c_cond
(paren
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCameraStatus
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.status.fatalError
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;fatal_error:              %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.fatalError
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;vp_status:                %#04x&bslash;n&quot;
comma
id|cam-&gt;params.status.vpStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.status.fatalError
op_amp
op_complement
(paren
id|COM_FLAG
op_or
id|CPIA_FLAG
)paren
)paren
(brace
multiline_comment|/* Fatal error in camera */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cam-&gt;params.status.fatalError
op_amp
(paren
id|COM_FLAG
op_or
id|CPIA_FLAG
)paren
)paren
(brace
multiline_comment|/* Firmware 1-02 may do this for parallel port cameras,&n;&t;&t;&t; * just clear the flags (developer&squot;s guide p 3-38) */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_ModifyCameraStatus
comma
id|FATALERROR
comma
op_complement
(paren
id|COM_FLAG
op_or
id|CPIA_FLAG
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Check the camera status again */
r_if
c_cond
(paren
id|cam-&gt;params.status.fatalError
)paren
(brace
r_if
c_cond
(paren
id|cam-&gt;params.status.fatalError
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* VPVersion can&squot;t be retrieved before the camera is in HiPower,&n;&t; * so get it here instead of in get_version_information. */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetVPVersion
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set camera to a known state */
id|set_camera_state
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------- V4L interface --------------------- */
DECL|function|cpia_open
r_static
r_int
id|cpia_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|cam_data
op_star
id|cam
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal error, cam_data not found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cam-&gt;open_count
OG
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Camera already open&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;raw_image
)paren
(brace
id|cam-&gt;raw_image
op_assign
id|rvmalloc
c_func
(paren
id|CPIA_MAX_IMAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;raw_image
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;decompressed_frame.data
)paren
(brace
id|cam-&gt;decompressed_frame.data
op_assign
id|rvmalloc
c_func
(paren
id|CPIA_MAX_FRAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;decompressed_frame.data
)paren
(brace
id|rvfree
c_func
(paren
id|cam-&gt;raw_image
comma
id|CPIA_MAX_IMAGE_SIZE
)paren
suffix:semicolon
id|cam-&gt;raw_image
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
multiline_comment|/* open cpia */
r_if
c_cond
(paren
id|cam-&gt;ops
op_member_access_from_pointer
id|open
c_func
(paren
id|cam-&gt;lowlevel_data
)paren
)paren
(brace
id|rvfree
c_func
(paren
id|cam-&gt;decompressed_frame.data
comma
id|CPIA_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|cam-&gt;decompressed_frame.data
op_assign
l_int|NULL
suffix:semicolon
id|rvfree
c_func
(paren
id|cam-&gt;raw_image
comma
id|CPIA_MAX_IMAGE_SIZE
)paren
suffix:semicolon
id|cam-&gt;raw_image
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* reset the camera */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|reset_camera
c_func
(paren
id|cam
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|cam-&gt;ops
op_member_access_from_pointer
id|close
c_func
(paren
id|cam-&gt;lowlevel_data
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|cam-&gt;decompressed_frame.data
comma
id|CPIA_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|cam-&gt;decompressed_frame.data
op_assign
l_int|NULL
suffix:semicolon
id|rvfree
c_func
(paren
id|cam-&gt;raw_image
comma
id|CPIA_MAX_IMAGE_SIZE
)paren
suffix:semicolon
id|cam-&gt;raw_image
op_assign
l_int|NULL
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* Set ownership of /proc/cpia/videoX to current user */
r_if
c_cond
(paren
id|cam-&gt;proc_entry
)paren
(brace
id|cam-&gt;proc_entry-&gt;uid
op_assign
id|current-&gt;uid
suffix:semicolon
)brace
multiline_comment|/* set mark for loading first frame uncompressed */
id|cam-&gt;first_frame
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* init it to something */
id|cam-&gt;mmap_kludge
op_assign
l_int|0
suffix:semicolon
op_increment
id|cam-&gt;open_count
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_close
r_static
r_void
id|cpia_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|cam_data
op_star
id|cam
suffix:semicolon
id|cam
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;ops
)paren
(brace
multiline_comment|/* Return ownership of /proc/cpia/videoX to root */
r_if
c_cond
(paren
id|cam-&gt;proc_entry
)paren
(brace
id|cam-&gt;proc_entry-&gt;uid
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* save camera state for later open (developers guide ch 3.5.3) */
id|save_camera_state
c_func
(paren
id|cam
)paren
suffix:semicolon
multiline_comment|/* GotoLoPower */
id|goto_low_power
c_func
(paren
id|cam
)paren
suffix:semicolon
multiline_comment|/* Update the camera ststus */
id|do_command
c_func
(paren
id|cam
comma
id|CPIA_COMMAND_GetCameraStatus
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* cleanup internal state stuff */
id|free_frames
c_func
(paren
id|cam-&gt;frame
)paren
suffix:semicolon
multiline_comment|/* close cpia */
id|cam-&gt;ops
op_member_access_from_pointer
id|close
c_func
(paren
id|cam-&gt;lowlevel_data
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|cam-&gt;open_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/* clean up capture-buffers */
r_if
c_cond
(paren
id|cam-&gt;raw_image
)paren
(brace
id|rvfree
c_func
(paren
id|cam-&gt;raw_image
comma
id|CPIA_MAX_IMAGE_SIZE
)paren
suffix:semicolon
id|cam-&gt;raw_image
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cam-&gt;decompressed_frame.data
)paren
(brace
id|rvfree
c_func
(paren
id|cam-&gt;decompressed_frame.data
comma
id|CPIA_MAX_FRAME_SIZE
)paren
suffix:semicolon
id|cam-&gt;decompressed_frame.data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cam-&gt;frame_buf
)paren
id|free_frame_buf
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;ops
)paren
(brace
id|video_unregister_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
DECL|function|cpia_read
r_static
r_int
id|cpia_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_struct
id|cam_data
op_star
id|cam
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* make this _really_ smp and multithredi-safe */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;buf NULL&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;count 0&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;ops
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ops NULL&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* upload frame */
id|cam-&gt;decompressed_frame.state
op_assign
id|FRAME_READY
suffix:semicolon
id|cam-&gt;mmap_kludge
op_assign
l_int|0
suffix:semicolon
id|fetch_frame
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;decompressed_frame.state
op_ne
id|FRAME_DONE
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;upload failed %d/%d&bslash;n&quot;
comma
id|cam-&gt;decompressed_frame.count
comma
id|cam-&gt;decompressed_frame.state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|cam-&gt;decompressed_frame.state
op_assign
id|FRAME_UNUSED
suffix:semicolon
multiline_comment|/* copy data to user space */
r_if
c_cond
(paren
id|cam-&gt;decompressed_frame.count
OG
id|count
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;count wrong: %d, %lu&bslash;n&quot;
comma
id|cam-&gt;decompressed_frame.count
comma
id|count
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|cam-&gt;decompressed_frame.data
comma
id|cam-&gt;decompressed_frame.count
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;copy_to_user failed&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
id|cam-&gt;decompressed_frame.count
suffix:semicolon
)brace
DECL|function|cpia_ioctl
r_static
r_int
id|cpia_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|ioctlnr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|cam_data
op_star
id|cam
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam
op_logical_or
op_logical_neg
id|cam-&gt;ops
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* make this _really_ smp-safe */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
singleline_comment|//DBG(&quot;cpia_ioctl: %u&bslash;n&quot;, ioctlnr);
r_switch
c_cond
(paren
id|ioctlnr
)paren
(brace
multiline_comment|/* query capabilites */
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCGCAP&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
l_string|&quot;CPiA Camera&quot;
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
l_int|352
suffix:semicolon
multiline_comment|/* VIDEOSIZE_CIF */
id|b.maxheight
op_assign
l_int|288
suffix:semicolon
id|b.minwidth
op_assign
l_int|48
suffix:semicolon
multiline_comment|/* VIDEOSIZE_48_48 */
id|b.minheight
op_assign
l_int|48
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* get/set video source - we are a camera and nothing else */
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCGCHAN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.channel
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|v.channel
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|v.norm
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCSCHAN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
l_int|0
op_logical_and
id|v
op_ne
l_int|0
)paren
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* image properties */
r_case
id|VIDIOCGPICT
suffix:colon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCGPICT&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|cam-&gt;vp
comma
r_sizeof
(paren
r_struct
id|video_picture
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|vp
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCSPICT&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* copy_from_user */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vp
comma
id|arg
comma
r_sizeof
(paren
id|vp
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* check validity */
id|DBG
c_func
(paren
l_string|&quot;palette: %d&bslash;n&quot;
comma
id|vp.palette
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;depth: %d&bslash;n&quot;
comma
id|vp.depth
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid_mode
c_func
(paren
id|vp.palette
comma
id|vp.depth
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
multiline_comment|/* brightness, colour, contrast need no check 0-65535 */
id|memcpy
c_func
(paren
op_amp
id|cam-&gt;vp
comma
op_amp
id|vp
comma
r_sizeof
(paren
id|vp
)paren
)paren
suffix:semicolon
multiline_comment|/* update cam-&gt;params.colourParams */
id|cam-&gt;params.colourParams.brightness
op_assign
id|vp.brightness
op_star
l_int|100
op_div
l_int|65535
suffix:semicolon
id|cam-&gt;params.colourParams.contrast
op_assign
id|vp.contrast
op_star
l_int|100
op_div
l_int|65535
suffix:semicolon
id|cam-&gt;params.colourParams.saturation
op_assign
id|vp.colour
op_star
l_int|100
op_div
l_int|65535
suffix:semicolon
multiline_comment|/* contrast is in steps of 8, so round */
id|cam-&gt;params.colourParams.contrast
op_assign
(paren
(paren
id|cam-&gt;params.colourParams.contrast
op_plus
l_int|3
)paren
op_div
l_int|8
)paren
op_star
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;params.version.firmwareVersion
op_eq
l_int|1
op_logical_and
id|cam-&gt;params.version.firmwareRevision
op_eq
l_int|2
op_logical_and
id|cam-&gt;params.colourParams.contrast
OG
l_int|80
)paren
(brace
multiline_comment|/* 1-02 firmware limits contrast to 80 */
id|cam-&gt;params.colourParams.contrast
op_assign
l_int|80
suffix:semicolon
)brace
multiline_comment|/* queue command to update camera */
id|cam-&gt;cmd_queue
op_or_assign
id|COMMAND_SETCOLOURPARAMS
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCSPICT: %d / %d // %d / %d / %d / %d&bslash;n&quot;
comma
id|vp.depth
comma
id|vp.palette
comma
id|vp.brightness
comma
id|vp.hue
comma
id|vp.colour
comma
id|vp.contrast
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* get/set capture window */
r_case
id|VIDIOCGWIN
suffix:colon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCGWIN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|cam-&gt;vw
comma
r_sizeof
(paren
r_struct
id|video_window
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCSWIN
suffix:colon
(brace
multiline_comment|/* copy_from_user, check validity, copy to internal structure */
r_struct
id|video_window
id|vw
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCSWIN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.clipcount
op_ne
l_int|0
)paren
(brace
multiline_comment|/* clipping not supported */
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.clips
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* clipping not supported */
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* we set the video window to something smaller or equal to what&n;&t;&t;* is requested by the user???&n;&t;&t;*/
id|down
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vw.width
op_ne
id|cam-&gt;vw.width
op_logical_or
id|vw.height
op_ne
id|cam-&gt;vw.height
)paren
(brace
r_int
id|video_size
op_assign
id|match_videosize
c_func
(paren
id|vw.width
comma
id|vw.height
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_size
OL
l_int|0
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cam-&gt;video_size
op_assign
id|video_size
suffix:semicolon
id|set_vw_size
c_func
(paren
id|cam
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%d / %d&bslash;n&quot;
comma
id|cam-&gt;vw.width
comma
id|cam-&gt;vw.height
)paren
suffix:semicolon
id|cam-&gt;cmd_queue
op_or_assign
id|COMMAND_SETFORMAT
suffix:semicolon
)brace
singleline_comment|// FIXME needed??? memcpy(&amp;cam-&gt;vw, &amp;vw, sizeof(vw));
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
multiline_comment|/* setformat ignored by camera during streaming,&n;&t;&t; * so stop/dispatch/start */
r_if
c_cond
(paren
id|cam-&gt;cmd_queue
op_amp
id|COMMAND_SETFORMAT
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|dispatch_commands
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;%d/%d:%d&bslash;n&quot;
comma
id|cam-&gt;video_size
comma
id|cam-&gt;vw.width
comma
id|cam-&gt;vw.height
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* mmap interface */
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;VIDIOCGMBUF&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|CPIA_MAX_FRAME_SIZE
op_star
id|FRAME_NUM
suffix:semicolon
id|vm.frames
op_assign
id|FRAME_NUM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAME_NUM
suffix:semicolon
id|i
op_increment
)paren
id|vm.offsets
(braket
id|i
)braket
op_assign
id|CPIA_MAX_FRAME_SIZE
op_star
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_int
id|video_size
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 1
id|DBG
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: %d / %d / %dx%d&bslash;n&quot;
comma
id|vm.format
comma
id|vm.frame
comma
id|vm.width
comma
id|vm.height
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vm.frame
id|FRAME_NUM
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* set video format */
id|cam-&gt;vp.palette
op_assign
id|vm.format
suffix:semicolon
r_switch
c_cond
(paren
id|vm.format
)paren
(brace
r_case
id|VIDEO_PALETTE_GREY
suffix:colon
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
r_case
id|VIDEO_PALETTE_UYVY
suffix:colon
id|cam-&gt;vp.depth
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|cam-&gt;vp.depth
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
id|cam-&gt;vp.depth
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
r_break
suffix:semicolon
multiline_comment|/* set video size */
id|video_size
op_assign
id|match_videosize
c_func
(paren
id|vm.width
comma
id|vm.height
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;video_size
OL
l_int|0
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_size
op_ne
id|cam-&gt;video_size
)paren
(brace
id|cam-&gt;video_size
op_assign
id|video_size
suffix:semicolon
id|set_vw_size
c_func
(paren
id|cam
)paren
suffix:semicolon
id|cam-&gt;cmd_queue
op_or_assign
id|COMMAND_SETFORMAT
suffix:semicolon
id|dispatch_commands
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|DBG
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: %d / %d/%d&bslash;n&quot;
comma
id|cam-&gt;video_size
comma
id|cam-&gt;vw.width
comma
id|cam-&gt;vw.height
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* according to v4l-spec we must start streaming here */
id|cam-&gt;mmap_kludge
op_assign
l_int|1
suffix:semicolon
id|retval
op_assign
id|capture_frame
c_func
(paren
id|cam
comma
op_amp
id|vm
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|//DBG(&quot;VIDIOCSYNC: %d&bslash;n&quot;, frame);
r_if
c_cond
(paren
id|frame
OL
l_int|0
op_logical_or
id|frame
op_ge
id|FRAME_NUM
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cam-&gt;frame
(braket
id|frame
)braket
dot
id|state
)paren
(brace
r_case
id|FRAME_UNUSED
suffix:colon
r_case
id|FRAME_READY
suffix:colon
r_case
id|FRAME_GRABBING
suffix:colon
id|DBG
c_func
(paren
l_string|&quot;sync to unused frame %d&bslash;n&quot;
comma
id|frame
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRAME_DONE
suffix:colon
id|cam-&gt;frame
(braket
id|frame
)braket
dot
id|state
op_assign
id|FRAME_UNUSED
suffix:semicolon
singleline_comment|//DBG(&quot;VIDIOCSYNC: %d synced&bslash;n&quot;, frame);
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|EINTR
)paren
(brace
multiline_comment|/* FIXME - xawtv does not handle this nice */
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* pointless to implement overlay with this camera */
r_case
id|VIDIOCCAPTURE
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCGFBUF
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCSFBUF
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCKEY
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* tuner interface - we have none */
r_case
id|VIDIOCGTUNER
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCSTUNER
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCSFREQ
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* audio interface - we have none */
r_case
id|VIDIOCGAUDIO
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDIOCSAUDIO
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* FIXME */
DECL|function|cpia_mmap
r_static
r_int
id|cpia_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
r_struct
id|cam_data
op_star
id|cam
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam
op_logical_or
op_logical_neg
id|cam-&gt;ops
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;cpia_mmap: %ld&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|FRAME_NUM
op_star
id|CPIA_MAX_FRAME_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam
op_logical_or
op_logical_neg
id|cam-&gt;ops
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* make this _really_ smp-safe */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;frame_buf
)paren
(brace
multiline_comment|/* we do lazy allocation */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|allocate_frame_buf
c_func
(paren
id|cam
)paren
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
)brace
id|pos
op_assign
(paren
r_int
r_int
)paren
(paren
id|cam-&gt;frame_buf
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;cpia_mmap: %ld&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_video_init
r_int
id|cpia_video_init
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
id|create_proc_cpia_cam
c_func
(paren
id|vdev-&gt;priv
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cpia_template
r_static
r_struct
id|video_device
id|cpia_template
op_assign
(brace
id|name
suffix:colon
l_string|&quot;CPiA Camera&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_CPIA
comma
multiline_comment|/* FIXME */
id|open
suffix:colon
id|cpia_open
comma
id|close
suffix:colon
id|cpia_close
comma
id|read
suffix:colon
id|cpia_read
comma
id|ioctl
suffix:colon
id|cpia_ioctl
comma
id|mmap
suffix:colon
id|cpia_mmap
comma
id|initialize
suffix:colon
id|cpia_video_init
comma
id|minor
suffix:colon
op_minus
l_int|1
comma
)brace
suffix:semicolon
multiline_comment|/* initialise cam_data structure  */
DECL|function|reset_camera_struct
r_static
r_void
id|reset_camera_struct
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
multiline_comment|/* The following parameter values are the defaults from&n;&t; * &quot;Software Developer&squot;s Guide for CPiA Cameras&quot;.  Any changes&n;&t; * to the defaults are noted in comments. */
id|cam-&gt;params.colourParams.brightness
op_assign
l_int|50
suffix:semicolon
id|cam-&gt;params.colourParams.contrast
op_assign
l_int|48
suffix:semicolon
id|cam-&gt;params.colourParams.saturation
op_assign
l_int|50
suffix:semicolon
id|cam-&gt;params.exposure.gainMode
op_assign
l_int|2
suffix:semicolon
id|cam-&gt;params.exposure.expMode
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* AEC */
id|cam-&gt;params.exposure.compMode
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.exposure.centreWeight
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.exposure.gain
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.exposure.fineExp
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.exposure.coarseExpLo
op_assign
l_int|185
suffix:semicolon
id|cam-&gt;params.exposure.coarseExpHi
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.exposure.redComp
op_assign
l_int|220
suffix:semicolon
id|cam-&gt;params.exposure.green1Comp
op_assign
l_int|214
suffix:semicolon
id|cam-&gt;params.exposure.green2Comp
op_assign
l_int|214
suffix:semicolon
id|cam-&gt;params.exposure.blueComp
op_assign
l_int|230
suffix:semicolon
id|cam-&gt;params.colourBalance.balanceModeIsAuto
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.colourBalance.redGain
op_assign
l_int|32
suffix:semicolon
id|cam-&gt;params.colourBalance.greenGain
op_assign
l_int|6
suffix:semicolon
id|cam-&gt;params.colourBalance.blueGain
op_assign
l_int|92
suffix:semicolon
id|cam-&gt;params.apcor.gain1
op_assign
l_int|0x1c
suffix:semicolon
id|cam-&gt;params.apcor.gain2
op_assign
l_int|0x1a
suffix:semicolon
id|cam-&gt;params.apcor.gain4
op_assign
l_int|0x2d
suffix:semicolon
id|cam-&gt;params.apcor.gain8
op_assign
l_int|0x2a
suffix:semicolon
id|cam-&gt;params.flickerControl.flickerMode
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;params.flickerControl.coarseJump
op_assign
id|flicker_jumps
(braket
id|cam-&gt;mainsFreq
)braket
(braket
id|cam-&gt;params.sensorFps.baserate
)braket
(braket
id|cam-&gt;params.sensorFps.divisor
)braket
suffix:semicolon
id|cam-&gt;params.vlOffset.gain1
op_assign
l_int|24
suffix:semicolon
id|cam-&gt;params.vlOffset.gain2
op_assign
l_int|28
suffix:semicolon
id|cam-&gt;params.vlOffset.gain4
op_assign
l_int|30
suffix:semicolon
id|cam-&gt;params.vlOffset.gain8
op_assign
l_int|30
suffix:semicolon
id|cam-&gt;params.compressionParams.hysteresis
op_assign
l_int|3
suffix:semicolon
id|cam-&gt;params.compressionParams.threshMax
op_assign
l_int|11
suffix:semicolon
id|cam-&gt;params.compressionParams.smallStep
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.compressionParams.largeStep
op_assign
l_int|3
suffix:semicolon
id|cam-&gt;params.compressionParams.decimationHysteresis
op_assign
l_int|2
suffix:semicolon
id|cam-&gt;params.compressionParams.frDiffStepThresh
op_assign
l_int|5
suffix:semicolon
id|cam-&gt;params.compressionParams.qDiffStepThresh
op_assign
l_int|3
suffix:semicolon
id|cam-&gt;params.compressionParams.decimationThreshMod
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* End of default values from Software Developer&squot;s Guide */
id|cam-&gt;transfer_rate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set Sensor FPS to 15fps. This seems better than 30fps&n;&t; * for indoor lighting. */
id|cam-&gt;params.sensorFps.divisor
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.sensorFps.baserate
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;params.yuvThreshold.yThreshold
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* FIXME? */
id|cam-&gt;params.yuvThreshold.uvThreshold
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* FIXME? */
id|cam-&gt;params.format.subSample
op_assign
id|SUBSAMPLE_422
suffix:semicolon
id|cam-&gt;params.format.yuvOrder
op_assign
id|YUVORDER_YUYV
suffix:semicolon
id|cam-&gt;params.compression.mode
op_assign
id|CPIA_COMPRESSION_AUTO
suffix:semicolon
id|cam-&gt;params.compressionTarget.frTargeting
op_assign
id|CPIA_COMPRESSION_TARGET_QUALITY
suffix:semicolon
id|cam-&gt;params.compressionTarget.targetFR
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* FIXME? */
id|cam-&gt;params.compressionTarget.targetQ
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* FIXME? */
id|cam-&gt;video_size
op_assign
id|VIDEOSIZE_CIF
suffix:semicolon
id|cam-&gt;vp.colour
op_assign
l_int|32768
suffix:semicolon
multiline_comment|/* 50% */
id|cam-&gt;vp.hue
op_assign
l_int|32768
suffix:semicolon
multiline_comment|/* 50% */
id|cam-&gt;vp.brightness
op_assign
l_int|32768
suffix:semicolon
multiline_comment|/* 50% */
id|cam-&gt;vp.contrast
op_assign
l_int|32768
suffix:semicolon
multiline_comment|/* 50% */
id|cam-&gt;vp.whiteness
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not used -&gt; grayscale only */
id|cam-&gt;vp.depth
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: to be set by user? */
id|cam-&gt;vp.palette
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
multiline_comment|/* FIXME: to be set by user? */
id|cam-&gt;vw.x
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;vw.y
op_assign
l_int|0
suffix:semicolon
id|set_vw_size
c_func
(paren
id|cam
)paren
suffix:semicolon
id|cam-&gt;vw.chromakey
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PP NOTE: my extension to use vw.flags for this, bear it! */
id|cam-&gt;vw.flags
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;vw.clipcount
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;vw.clips
op_assign
l_int|NULL
suffix:semicolon
id|cam-&gt;cmd_queue
op_assign
id|COMMAND_NONE
suffix:semicolon
id|cam-&gt;first_frame
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* initialize cam_data structure  */
DECL|function|init_camera_struct
r_static
r_void
id|init_camera_struct
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
comma
r_struct
id|cpia_camera_ops
op_star
id|ops
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Default everything to 0 */
id|memset
c_func
(paren
id|cam
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cam_data
)paren
)paren
suffix:semicolon
id|cam-&gt;ops
op_assign
id|ops
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|cam-&gt;param_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|cam-&gt;busy_lock
)paren
suffix:semicolon
id|reset_camera_struct
c_func
(paren
id|cam
)paren
suffix:semicolon
id|cam-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|cam-&gt;vdev
comma
op_amp
id|cpia_template
comma
r_sizeof
(paren
id|cpia_template
)paren
)paren
suffix:semicolon
id|cam-&gt;vdev.priv
op_assign
id|cam
suffix:semicolon
id|cam-&gt;curframe
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAME_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cam-&gt;frame
(braket
id|i
)braket
dot
id|width
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;frame
(braket
id|i
)braket
dot
id|height
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;frame
(braket
id|i
)braket
dot
id|state
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|cam-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
)brace
id|cam-&gt;decompressed_frame.width
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;decompressed_frame.height
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;decompressed_frame.state
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|cam-&gt;decompressed_frame.data
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|cpia_register_camera
r_struct
id|cam_data
op_star
id|cpia_register_camera
c_func
(paren
r_struct
id|cpia_camera_ops
op_star
id|ops
comma
r_void
op_star
id|lowlevel
)paren
(brace
r_struct
id|cam_data
op_star
id|camera
suffix:semicolon
multiline_comment|/* Need a lock when adding/removing cameras.  This doesn&squot;t happen&n;&t; * often and doesn&squot;t take very long, so grabbing the kernel lock&n;&t; * should be OK. */
r_if
c_cond
(paren
(paren
id|camera
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cam_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|init_camera_struct
c_func
(paren
id|camera
comma
id|ops
)paren
suffix:semicolon
id|camera-&gt;lowlevel_data
op_assign
id|lowlevel
suffix:semicolon
multiline_comment|/* register v4l device */
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|camera-&gt;vdev
comma
id|VFL_TYPE_GRABBER
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|kfree
c_func
(paren
id|camera
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;video_register_device failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* get version information from camera: open/reset/close */
multiline_comment|/* open cpia */
r_if
c_cond
(paren
id|camera-&gt;ops
op_member_access_from_pointer
id|open
c_func
(paren
id|camera-&gt;lowlevel_data
)paren
)paren
r_return
id|camera
suffix:semicolon
multiline_comment|/* reset the camera */
r_if
c_cond
(paren
id|reset_camera
c_func
(paren
id|camera
)paren
op_ne
l_int|0
)paren
(brace
id|camera-&gt;ops
op_member_access_from_pointer
id|close
c_func
(paren
id|camera-&gt;lowlevel_data
)paren
suffix:semicolon
r_return
id|camera
suffix:semicolon
)brace
multiline_comment|/* close cpia */
id|camera-&gt;ops
op_member_access_from_pointer
id|close
c_func
(paren
id|camera-&gt;lowlevel_data
)paren
suffix:semicolon
multiline_comment|/* Eh? Feeling happy? - jerdfelt */
multiline_comment|/*&n;&t;camera-&gt;ops-&gt;open(camera-&gt;lowlevel_data);&n;&t;camera-&gt;ops-&gt;close(camera-&gt;lowlevel_data);&n;*/
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  CPiA Version: %d.%02d (%d.%d)&bslash;n&quot;
comma
id|camera-&gt;params.version.firmwareVersion
comma
id|camera-&gt;params.version.firmwareRevision
comma
id|camera-&gt;params.version.vcVersion
comma
id|camera-&gt;params.version.vcRevision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  CPiA PnP-ID: %04x:%04x:%04x&bslash;n&quot;
comma
id|camera-&gt;params.pnpID.vendor
comma
id|camera-&gt;params.pnpID.product
comma
id|camera-&gt;params.pnpID.deviceRevision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  VP-Version: %d.%d %04x&bslash;n&quot;
comma
id|camera-&gt;params.vpVersion.vpVersion
comma
id|camera-&gt;params.vpVersion.vpRevision
comma
id|camera-&gt;params.vpVersion.cameraHeadID
)paren
suffix:semicolon
r_return
id|camera
suffix:semicolon
)brace
DECL|function|cpia_unregister_camera
r_void
id|cpia_unregister_camera
c_func
(paren
r_struct
id|cam_data
op_star
id|cam
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;open_count
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;unregistering video&bslash;n&quot;
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|cam-&gt;vdev
)paren
suffix:semicolon
)brace
r_else
(brace
id|LOG
c_func
(paren
l_string|&quot;/dev/video%d removed while open, &quot;
l_string|&quot;deferring video_unregister_device&bslash;n&quot;
comma
id|cam-&gt;vdev.minor
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;camera open -- setting ops to NULL&bslash;n&quot;
)paren
suffix:semicolon
id|cam-&gt;ops
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
id|DBG
c_func
(paren
l_string|&quot;destroying /proc/cpia/video%d&bslash;n&quot;
comma
id|cam-&gt;vdev.minor
)paren
suffix:semicolon
id|destroy_proc_cpia_cam
c_func
(paren
id|cam
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;open_count
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;freeing camera&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************&n; *&n; *  Module routines&n; *&n; ***************************************************************************/
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s v%d.%d.%d&bslash;n&quot;
comma
id|ABOUT
comma
id|CPIA_MAJ_VER
comma
id|CPIA_MIN_VER
comma
id|CPIA_PATCH_VER
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_cpia_create
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_KMOD
macro_line|#ifdef CONFIG_VIDEO_CPIA_PP_MODULE
id|request_module
c_func
(paren
l_string|&quot;cpia_pp&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_VIDEO_CPIA_USB_MODULE
id|request_module
c_func
(paren
l_string|&quot;cpia_usb&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
id|proc_cpia_destroy
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#else
DECL|function|cpia_init
r_int
id|cpia_init
c_func
(paren
r_struct
id|video_init
op_star
id|unused
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s v%d.%d.%d&bslash;n&quot;
comma
id|ABOUT
comma
id|CPIA_MAJ_VER
comma
id|CPIA_MIN_VER
comma
id|CPIA_PATCH_VER
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_cpia_create
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_VIDEO_CPIA_PP
id|cpia_pp_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_KMOD
macro_line|#ifdef CONFIG_VIDEO_CPIA_PP_MODULE
id|request_module
c_func
(paren
l_string|&quot;cpia_pp&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_VIDEO_CPIA_USB_MODULE
id|request_module
c_func
(paren
l_string|&quot;cpia_usb&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif&t;/* CONFIG_KMOD */
macro_line|#ifdef CONFIG_VIDEO_CPIA_USB
id|cpia_usb_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Exported symbols for modules. */
DECL|variable|cpia_register_camera
id|EXPORT_SYMBOL
c_func
(paren
id|cpia_register_camera
)paren
suffix:semicolon
DECL|variable|cpia_unregister_camera
id|EXPORT_SYMBOL
c_func
(paren
id|cpia_unregister_camera
)paren
suffix:semicolon
macro_line|#endif
eof
