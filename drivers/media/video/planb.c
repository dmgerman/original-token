multiline_comment|/* &n;    planb - PlanB frame grabber driver&n;&n;    PlanB is used in the 7x00/8x00 series of PowerMacintosh&n;    Computers as video input DMA controller.&n;&n;    Copyright (C) 1998 Michel Lanners (mlan@cpu.lu)&n;&n;    Based largely on the bttv driver by Ralph Metzler (rjkm@thp.uni-koeln.de)&n;&n;    Additional debugging and coding by Takashi Oe (toe@unlserve.unl.edu)&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;*/
multiline_comment|/* $Id: planb.c,v 1.18 1999/05/02 17:36:34 mlan Exp $ */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;planb.h&quot;
macro_line|#include &quot;saa7196.h&quot;
multiline_comment|/* Would you mind for some ugly debugging? */
singleline_comment|//#define DEBUG(x...) printk(KERN_DEBUG ## x) /* Debug driver */
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x...) &t;&t;/* Don&squot;t debug driver */&t;
singleline_comment|//#define IDEBUG(x...) printk(KERN_DEBUG ## x) /* Debug interrupt part */
DECL|macro|IDEBUG
mdefine_line|#define IDEBUG(x...) &t;&t;/* Don&squot;t debug interrupt part */
multiline_comment|/* Ever seen a Mac with more than 1 of these? */
DECL|macro|PLANB_MAX
mdefine_line|#define PLANB_MAX 1
DECL|variable|planb_num
r_static
r_int
id|planb_num
suffix:semicolon
DECL|variable|planbs
r_static
r_struct
id|planb
id|planbs
(braket
id|PLANB_MAX
)braket
suffix:semicolon
DECL|variable|planb_regs
r_static
r_volatile
r_struct
id|planb_registers
op_star
id|planb_regs
suffix:semicolon
DECL|variable|def_norm
r_static
r_int
id|def_norm
op_assign
id|PLANB_DEF_NORM
suffix:semicolon
multiline_comment|/* default norm */
id|MODULE_PARM
c_func
(paren
id|def_norm
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|def_norm
comma
l_string|&quot;Default startup norm (0=PAL, 1=NTSC, 2=SECAM)&quot;
)paren
suffix:semicolon
multiline_comment|/* ------------------ PlanB Exported Functions ------------------ */
r_static
r_int
id|planb_write
c_func
(paren
r_struct
id|video_device
op_star
comma
r_const
r_char
op_star
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|planb_read
c_func
(paren
r_struct
id|video_device
op_star
comma
r_char
op_star
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|planb_open
c_func
(paren
r_struct
id|video_device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|planb_close
c_func
(paren
r_struct
id|video_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|planb_ioctl
c_func
(paren
r_struct
id|video_device
op_star
comma
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|planb_init_done
c_func
(paren
r_struct
id|video_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|planb_mmap
c_func
(paren
r_struct
id|video_device
op_star
comma
r_const
r_char
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|planb_irq
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|release_planb
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|init_planbs
c_func
(paren
r_struct
id|video_init
op_star
)paren
suffix:semicolon
multiline_comment|/* ------------------ PlanB Internal Functions ------------------ */
r_static
r_int
id|planb_prepare_open
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|planb_prepare_close
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|saa_write_reg
c_func
(paren
r_int
r_char
comma
r_int
r_char
)paren
suffix:semicolon
r_static
r_int
r_char
id|saa_status
c_func
(paren
r_int
comma
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|saa_set
c_func
(paren
r_int
r_char
comma
r_int
r_char
comma
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|saa_init_regs
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_int
id|grabbuf_alloc
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_int
id|vgrab
c_func
(paren
r_struct
id|planb
op_star
comma
r_struct
id|video_mmap
op_star
)paren
suffix:semicolon
r_static
r_void
id|add_clip
c_func
(paren
r_struct
id|planb
op_star
comma
r_struct
id|video_clip
op_star
)paren
suffix:semicolon
r_static
r_void
id|fill_cmd_buff
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|cmd_buff
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_volatile
r_struct
id|dbdma_cmd
op_star
id|setup_grab_cmd
c_func
(paren
r_int
comma
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|overlay_start
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_void
id|overlay_stop
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|tab_cmd_dbdma
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_inline
r_void
id|tab_cmd_store
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_inline
r_void
id|tab_cmd_gen
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
comma
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|init_planb
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_int
id|find_planb
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|planb_pre_capture
c_func
(paren
r_int
comma
r_int
comma
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cmd_geo_setup
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
comma
r_int
comma
r_int
comma
r_int
comma
r_int
comma
r_int
comma
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|planb_dbdma_stop
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
suffix:semicolon
r_static
r_int
r_int
id|saa_geo_setup
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
comma
r_struct
id|planb
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|overlay_is_active
c_func
(paren
r_struct
id|planb
op_star
)paren
suffix:semicolon
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
DECL|function|grabbuf_alloc
r_static
r_int
id|grabbuf_alloc
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|i
comma
id|npage
suffix:semicolon
id|npage
op_assign
id|MAX_GBUFFERS
op_star
(paren
(paren
id|PLANB_MAX_FBUF
op_div
id|PAGE_SIZE
op_plus
l_int|1
)paren
macro_line|#ifndef PLANB_GSCANLINE
op_plus
id|MAX_LNUM
macro_line|#endif /* PLANB_GSCANLINE */
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pb-&gt;rawbuf
op_assign
(paren
r_int
r_char
op_star
op_star
)paren
id|kmalloc
(paren
id|npage
op_star
r_sizeof
(paren
r_int
r_int
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npage
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pb-&gt;rawbuf
(braket
id|i
)braket
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pb-&gt;rawbuf
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_decrement
OL
id|npage
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PlanB: init_grab: grab buffer not allocated&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pb-&gt;rawbuf
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|pb-&gt;rawbuf_size
op_assign
id|npage
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************/
multiline_comment|/* Hardware access functions */
multiline_comment|/*****************************/
DECL|function|saa_write_reg
r_static
r_void
id|saa_write_reg
c_func
(paren
r_int
r_char
id|addr
comma
r_int
r_char
id|val
)paren
(brace
id|planb_regs-&gt;saa_addr
op_assign
id|addr
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|planb_regs-&gt;saa_regval
op_assign
id|val
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* return  status byte 0 or 1: */
DECL|function|saa_status
r_static
r_int
r_char
id|saa_status
c_func
(paren
r_int
id|byte
comma
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_STDC
)braket
op_assign
(paren
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_STDC
)braket
op_amp
op_complement
l_int|2
)paren
op_or
(paren
(paren
id|byte
op_amp
l_int|1
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|saa_write_reg
(paren
id|SAA7196_STDC
comma
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_STDC
)braket
)paren
suffix:semicolon
multiline_comment|/* Let&squot;s wait 30msec for this one */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x02017F
id|schedule_timeout
c_func
(paren
l_int|30
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
macro_line|#else
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
l_int|30
op_star
id|HZ
op_div
l_int|1000
suffix:semicolon
multiline_comment|/* 30 ms */
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_int
r_char
)paren
id|in_8
(paren
op_amp
id|planb_regs-&gt;saa_status
)paren
suffix:semicolon
)brace
DECL|function|saa_set
r_static
r_void
id|saa_set
c_func
(paren
r_int
r_char
id|addr
comma
r_int
r_char
id|val
comma
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_if
c_cond
(paren
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|addr
)braket
op_ne
id|val
)paren
(brace
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|addr
)braket
op_assign
id|val
suffix:semicolon
id|saa_write_reg
(paren
id|addr
comma
id|val
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|saa_init_regs
r_static
r_void
id|saa_init_regs
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SAA7196_NUMREGS
suffix:semicolon
id|i
op_increment
)paren
id|saa_write_reg
(paren
id|i
comma
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|function|saa_geo_setup
r_static
r_int
r_int
id|saa_geo_setup
c_func
(paren
r_int
id|width
comma
r_int
id|height
comma
r_int
id|interlace
comma
r_int
id|bpp
comma
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|ht
comma
id|norm
op_assign
id|pb-&gt;win.norm
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|2
suffix:colon
multiline_comment|/* RGB555+a 1x16-bit + 16-bit transparent */
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
op_and_assign
op_complement
l_int|0x3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|4
suffix:colon
multiline_comment|/* RGB888 1x24-bit + 8-bit transparent */
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
op_and_assign
op_complement
l_int|0x1
suffix:semicolon
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
op_or_assign
l_int|0x2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ht
op_assign
(paren
id|interlace
ques
c_cond
id|height
op_div
l_int|2
suffix:colon
id|height
)paren
suffix:semicolon
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_OUTPIX
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|width
op_amp
l_int|0x00ff
)paren
suffix:semicolon
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_HFILT
)braket
op_assign
(paren
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_HFILT
)braket
op_amp
op_complement
l_int|0x3
)paren
op_or
(paren
id|width
op_rshift
l_int|8
op_amp
l_int|0x3
)paren
suffix:semicolon
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_OUTLINE
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|ht
op_amp
l_int|0xff
)paren
suffix:semicolon
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_VYP
)braket
op_assign
(paren
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_VYP
)braket
op_amp
op_complement
l_int|0x3
)paren
op_or
(paren
id|ht
op_rshift
l_int|8
op_amp
l_int|0x3
)paren
suffix:semicolon
multiline_comment|/* feed both fields if interlaced, or else feed only even fields */
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
op_assign
(paren
id|interlace
)paren
ques
c_cond
(paren
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
op_amp
op_complement
l_int|0x60
)paren
suffix:colon
(paren
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
op_or
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* transparent mode; extended format enabled */
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_DPATH
)braket
op_or_assign
l_int|0x3
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************/
multiline_comment|/* DBDMA support functions */
multiline_comment|/***************************/
DECL|function|planb_dbdma_restart
r_static
r_inline
r_void
id|planb_dbdma_restart
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|ch
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|ch-&gt;control
comma
id|PLANB_CLR
c_func
(paren
id|RUN
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|ch-&gt;control
comma
id|PLANB_SET
c_func
(paren
id|RUN
op_or
id|WAKE
)paren
op_or
id|PLANB_CLR
c_func
(paren
id|PAUSE
)paren
)paren
suffix:semicolon
)brace
DECL|function|planb_dbdma_stop
r_static
r_inline
r_void
id|planb_dbdma_stop
c_func
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
id|ch
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|ch-&gt;control
comma
id|PLANB_CLR
c_func
(paren
id|RUN
)paren
op_or
id|PLANB_SET
c_func
(paren
id|FLUSH
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_le32
c_func
(paren
op_amp
id|ch-&gt;status
)paren
op_eq
(paren
id|ACTIVE
op_or
id|FLUSH
)paren
)paren
op_logical_and
(paren
id|i
OL
l_int|999
)paren
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: waiting for DMA to stop&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
DECL|function|tab_cmd_dbdma
r_static
r_inline
r_void
id|tab_cmd_dbdma
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|ch
comma
r_int
r_int
id|command
comma
r_int
r_int
id|cmd_dep
)paren
(brace
id|st_le16
c_func
(paren
op_amp
id|ch-&gt;command
comma
id|command
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|ch-&gt;cmd_dep
comma
id|cmd_dep
)paren
suffix:semicolon
)brace
DECL|function|tab_cmd_store
r_static
r_inline
r_void
id|tab_cmd_store
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|ch
comma
r_int
r_int
id|phy_addr
comma
r_int
r_int
id|cmd_dep
)paren
(brace
id|st_le16
c_func
(paren
op_amp
id|ch-&gt;command
comma
id|STORE_WORD
op_or
id|KEY_SYSTEM
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|ch-&gt;req_count
comma
l_int|4
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|ch-&gt;phy_addr
comma
id|phy_addr
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|ch-&gt;cmd_dep
comma
id|cmd_dep
)paren
suffix:semicolon
)brace
DECL|function|tab_cmd_gen
r_static
r_inline
r_void
id|tab_cmd_gen
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|ch
comma
r_int
r_int
id|command
comma
r_int
r_int
id|req_count
comma
r_int
r_int
id|phy_addr
comma
r_int
r_int
id|cmd_dep
)paren
(brace
id|st_le16
c_func
(paren
op_amp
id|ch-&gt;command
comma
id|command
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|ch-&gt;req_count
comma
id|req_count
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|ch-&gt;phy_addr
comma
id|phy_addr
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|ch-&gt;cmd_dep
comma
id|cmd_dep
)paren
suffix:semicolon
)brace
DECL|function|cmd_geo_setup
r_static
r_volatile
r_struct
id|dbdma_cmd
op_star
id|cmd_geo_setup
c_func
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
id|c1
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|interlace
comma
r_int
id|bpp
comma
r_int
id|clip
comma
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|norm
op_assign
id|pb-&gt;win.norm
suffix:semicolon
r_if
c_cond
(paren
(paren
id|saa_geo_setup
c_func
(paren
id|width
comma
id|height
comma
id|interlace
comma
id|bpp
comma
id|pb
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_addr
)paren
comma
id|SAA7196_FMTS
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_regval
)paren
comma
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_FMTS
)braket
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_addr
)paren
comma
id|SAA7196_DPATH
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_regval
)paren
comma
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_DPATH
)braket
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;even
)paren
comma
id|bpp
op_or
(paren
(paren
id|clip
)paren
ques
c_cond
id|PLANB_CLIPMASK
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;odd
)paren
comma
id|bpp
op_or
(paren
(paren
id|clip
)paren
ques
c_cond
id|PLANB_CLIPMASK
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_addr
)paren
comma
id|SAA7196_OUTPIX
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_regval
)paren
comma
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_OUTPIX
)braket
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_addr
)paren
comma
id|SAA7196_HFILT
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_regval
)paren
comma
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_HFILT
)braket
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_addr
)paren
comma
id|SAA7196_OUTLINE
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_regval
)paren
comma
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_OUTLINE
)braket
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_addr
)paren
comma
id|SAA7196_VYP
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;saa_regval
)paren
comma
id|saa_regs
(braket
id|norm
)braket
(braket
id|SAA7196_VYP
)braket
)paren
suffix:semicolon
r_return
id|c1
suffix:semicolon
)brace
multiline_comment|/******************************/
multiline_comment|/* misc. supporting functions */
multiline_comment|/******************************/
DECL|function|__planb_wait
r_static
r_void
id|__planb_wait
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|pb-&gt;lockq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|repeat
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;lock
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|pb-&gt;lockq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
DECL|function|planb_wait
r_static
r_inline
r_void
id|planb_wait
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: planb_wait&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;lock
)paren
(brace
id|__planb_wait
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
)brace
DECL|function|planb_lock
r_static
r_inline
r_void
id|planb_lock
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: planb_lock&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;lock
)paren
(brace
id|__planb_wait
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
id|pb-&gt;lock
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|planb_unlock
r_static
r_inline
r_void
id|planb_unlock
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: planb_unlock&bslash;n&quot;
)paren
suffix:semicolon
id|pb-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pb-&gt;lockq
)paren
suffix:semicolon
)brace
multiline_comment|/***************/
multiline_comment|/* Driver Core */
multiline_comment|/***************/
DECL|function|planb_prepare_open
r_static
r_int
id|planb_prepare_open
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|i
comma
id|size
suffix:semicolon
multiline_comment|/* allocate memory for two plus alpha command buffers (size: max lines,&n;&t;   plus 40 commands handling, plus 1 alignment), plus dummy command buf,&n;&t;   plus clipmask buffer, plus frame grabbing status */
id|size
op_assign
(paren
id|pb-&gt;tab_size
op_star
(paren
l_int|2
op_plus
id|MAX_GBUFFERS
op_star
id|TAB_FACTOR
)paren
op_plus
l_int|1
op_plus
id|MAX_GBUFFERS
op_star
id|PLANB_DUMMY
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
op_plus
(paren
id|PLANB_MAXLINES
op_star
(paren
(paren
id|PLANB_MAXPIXELS
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
)paren
op_div
l_int|8
op_plus
id|MAX_GBUFFERS
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pb-&gt;priv_space
op_assign
id|kmalloc
(paren
id|size
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;priv_space
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|pb-&gt;overlay_last1
op_assign
id|pb-&gt;ch1_cmd
op_assign
(paren
r_volatile
r_struct
id|dbdma_cmd
op_star
)paren
id|DBDMA_ALIGN
(paren
id|pb-&gt;priv_space
)paren
suffix:semicolon
id|pb-&gt;overlay_last2
op_assign
id|pb-&gt;ch2_cmd
op_assign
id|pb-&gt;ch1_cmd
op_plus
id|pb-&gt;tab_size
suffix:semicolon
id|pb-&gt;ch1_cmd_phys
op_assign
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
suffix:semicolon
id|pb-&gt;cap_cmd
(braket
l_int|0
)braket
op_assign
id|pb-&gt;ch2_cmd
op_plus
id|pb-&gt;tab_size
suffix:semicolon
id|pb-&gt;pre_cmd
(braket
l_int|0
)braket
op_assign
id|pb-&gt;cap_cmd
(braket
l_int|0
)braket
op_plus
id|pb-&gt;tab_size
op_star
id|TAB_FACTOR
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pb-&gt;cap_cmd
(braket
id|i
)braket
op_assign
id|pb-&gt;pre_cmd
(braket
id|i
op_minus
l_int|1
)braket
op_plus
id|PLANB_DUMMY
suffix:semicolon
id|pb-&gt;pre_cmd
(braket
id|i
)braket
op_assign
id|pb-&gt;cap_cmd
(braket
id|i
)braket
op_plus
id|pb-&gt;tab_size
op_star
id|TAB_FACTOR
suffix:semicolon
)brace
id|pb-&gt;frame_stat
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|pb-&gt;pre_cmd
(braket
id|MAX_GBUFFERS
op_minus
l_int|1
)braket
op_plus
id|PLANB_DUMMY
)paren
suffix:semicolon
id|pb-&gt;mask
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|pb-&gt;frame_stat
op_plus
id|MAX_GBUFFERS
)paren
suffix:semicolon
id|pb-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|pb-&gt;rawbuf_size
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;grabbing
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pb-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_UNUSED
suffix:semicolon
id|pb-&gt;gwidth
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;gheight
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;gfmt
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;gnorm_switch
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef PLANB_GSCANLINE
id|pb-&gt;lsize
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;lnum
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* PLANB_GSCANLINE */
)brace
id|pb-&gt;gcount
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;suspend
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;last_fr
op_assign
op_minus
l_int|999
suffix:semicolon
id|pb-&gt;prev_last_fr
op_assign
op_minus
l_int|999
suffix:semicolon
multiline_comment|/* Reset DMA controllers */
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|planb_prepare_close
r_static
r_void
id|planb_prepare_close
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* make sure the dma&squot;s are idle */
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
multiline_comment|/* free kernel memory of command buffers */
r_if
c_cond
(paren
id|pb-&gt;priv_space
op_ne
l_int|0
)paren
(brace
id|kfree
(paren
id|pb-&gt;priv_space
)paren
suffix:semicolon
id|pb-&gt;priv_space
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;cmd_buff_inited
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pb-&gt;rawbuf
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pb-&gt;rawbuf_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pb-&gt;rawbuf
)paren
suffix:semicolon
)brace
id|pb-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*****************************/
multiline_comment|/* overlay support functions */
multiline_comment|/*****************************/
DECL|function|overlay_start
r_static
r_void
id|overlay_start
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: overlay_start()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACTIVE
op_amp
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: presumably, grabbing is in progress...&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch2_cmd
)paren
)paren
suffix:semicolon
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|st_le16
(paren
op_amp
id|pb-&gt;ch1_cmd-&gt;command
comma
id|DBDMA_NOP
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;last_fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|pb-&gt;prev_last_fr
op_assign
id|pb-&gt;last_fr
suffix:semicolon
id|pb-&gt;last_fr
op_assign
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ACTIVE
op_amp
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
)paren
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: became inactive &quot;
l_string|&quot;in the mean time... reactivating&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: currently idle, so can do whatever&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|st_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch2_cmd
)paren
)paren
suffix:semicolon
id|st_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
id|out_le16
(paren
op_amp
id|pb-&gt;ch1_cmd-&gt;command
comma
id|DBDMA_NOP
)paren
suffix:semicolon
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|pb-&gt;last_fr
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|overlay_stop
r_static
r_void
id|overlay_stop
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: overlay_stop()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;last_fr
op_eq
op_minus
l_int|1
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: no grabbing, it seems...&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|pb-&gt;last_fr
op_assign
op_minus
l_int|999
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pb-&gt;last_fr
op_eq
op_minus
l_int|2
)paren
(brace
r_int
r_int
id|cmd_dep
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|pb-&gt;prev_last_fr
)braket
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmd_dep
op_assign
(paren
r_int
r_int
)paren
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|overlay_is_active
c_func
(paren
id|pb
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: overlay is currently active&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_dep
op_ne
id|pb-&gt;ch1_cmd_phys
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;overlay_last1
)paren
)paren
suffix:semicolon
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
)brace
)brace
id|pb-&gt;last_fr
op_assign
id|pb-&gt;prev_last_fr
suffix:semicolon
id|pb-&gt;prev_last_fr
op_assign
op_minus
l_int|999
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|suspend_overlay
r_static
r_void
id|suspend_overlay
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|fr
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|dbdma_cmd
id|last
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: suspend_overlay: %d&bslash;n&quot;
comma
id|pb-&gt;suspend
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;suspend
op_increment
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ACTIVE
op_amp
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
)paren
(brace
r_if
c_cond
(paren
id|pb-&gt;last_fr
op_eq
op_minus
l_int|2
)paren
(brace
id|fr
op_assign
id|pb-&gt;prev_last_fr
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|last
comma
(paren
r_void
op_star
)paren
id|pb-&gt;last_cmd
(braket
id|fr
)braket
comma
r_sizeof
(paren
id|last
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|fr
)braket
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|overlay_is_active
c_func
(paren
id|pb
)paren
)paren
(brace
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|pb-&gt;suspended.overlay
op_assign
l_int|1
suffix:semicolon
id|pb-&gt;suspended.frame
op_assign
id|fr
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pb-&gt;suspended.cmd
comma
op_amp
id|last
comma
r_sizeof
(paren
id|last
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|pb-&gt;suspended.overlay
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;suspended.frame
op_assign
id|fr
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pb-&gt;suspended.cmd
comma
op_amp
id|last
comma
r_sizeof
(paren
id|last
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|resume_overlay
r_static
r_void
id|resume_overlay
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: resume_overlay: %d&bslash;n&quot;
comma
id|pb-&gt;suspend
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;suspend
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pb-&gt;suspended.frame
op_ne
op_minus
l_int|1
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;suspended.frame
)braket
comma
op_amp
id|pb-&gt;suspended.cmd
comma
r_sizeof
(paren
id|pb-&gt;suspended.cmd
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ACTIVE
op_amp
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
)paren
(brace
r_goto
id|finish
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pb-&gt;suspended.overlay
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: overlay being resumed&bslash;n&quot;
)paren
suffix:semicolon
id|st_le16
(paren
op_amp
id|pb-&gt;ch1_cmd-&gt;command
comma
id|DBDMA_NOP
)paren
suffix:semicolon
id|st_le16
(paren
op_amp
id|pb-&gt;ch2_cmd-&gt;command
comma
id|DBDMA_NOP
)paren
suffix:semicolon
multiline_comment|/* Set command buffer addresses */
id|st_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;overlay_last1
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;overlay_last2
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the DMA controller */
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2.control
comma
id|PLANB_CLR
c_func
(paren
id|PAUSE
)paren
op_or
id|PLANB_SET
c_func
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.control
comma
id|PLANB_CLR
c_func
(paren
id|PAUSE
)paren
op_or
id|PLANB_SET
c_func
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pb-&gt;suspended.frame
op_ne
op_minus
l_int|1
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;suspended.frame
)braket
)paren
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.control
comma
id|PLANB_CLR
c_func
(paren
id|PAUSE
)paren
op_or
id|PLANB_SET
c_func
(paren
id|RUN
op_or
id|WAKE
)paren
)paren
suffix:semicolon
)brace
id|finish
suffix:colon
id|pb-&gt;suspend
op_decrement
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|pb-&gt;suspendq
)paren
suffix:semicolon
)brace
DECL|function|add_clip
r_static
r_void
id|add_clip
c_func
(paren
r_struct
id|planb
op_star
id|pb
comma
r_struct
id|video_clip
op_star
id|clip
)paren
(brace
r_volatile
r_int
r_char
op_star
id|base
suffix:semicolon
r_int
id|xc
op_assign
id|clip-&gt;x
comma
id|yc
op_assign
id|clip-&gt;y
suffix:semicolon
r_int
id|wc
op_assign
id|clip-&gt;width
comma
id|hc
op_assign
id|clip-&gt;height
suffix:semicolon
r_int
id|ww
op_assign
id|pb-&gt;win.width
comma
id|hw
op_assign
id|pb-&gt;win.height
suffix:semicolon
r_int
id|x
comma
id|y
comma
id|xtmp1
comma
id|xtmp2
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: clip %dx%d+%d+%d&bslash;n&quot;
comma
id|wc
comma
id|hc
comma
id|xc
comma
id|yc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xc
OL
l_int|0
)paren
(brace
id|wc
op_add_assign
id|xc
suffix:semicolon
id|xc
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|yc
OL
l_int|0
)paren
(brace
id|hc
op_add_assign
id|yc
suffix:semicolon
id|yc
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xc
op_plus
id|wc
OG
id|ww
)paren
(brace
id|wc
op_assign
id|ww
op_minus
id|xc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wc
op_le
l_int|0
)paren
(brace
multiline_comment|/* Nothing to do */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|yc
op_plus
id|hc
OG
id|hw
)paren
(brace
id|hc
op_assign
id|hw
op_minus
id|yc
suffix:semicolon
)brace
r_for
c_loop
(paren
id|y
op_assign
id|yc
suffix:semicolon
id|y
OL
id|yc
op_plus
id|hc
suffix:semicolon
id|y
op_increment
)paren
(brace
id|xtmp1
op_assign
id|xc
op_rshift
l_int|3
suffix:semicolon
id|xtmp2
op_assign
(paren
id|xc
op_plus
id|wc
)paren
op_rshift
l_int|3
suffix:semicolon
id|base
op_assign
id|pb-&gt;mask
op_plus
id|y
op_star
l_int|96
suffix:semicolon
r_if
c_cond
(paren
id|xc
op_ne
l_int|0
op_logical_or
id|wc
op_ge
l_int|8
)paren
(brace
op_star
(paren
id|base
op_plus
id|xtmp1
)paren
op_and_assign
(paren
r_int
r_char
)paren
(paren
l_int|0x00ff
op_amp
(paren
l_int|0xff00
op_rshift
(paren
id|xc
op_amp
l_int|7
)paren
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|x
op_assign
id|xtmp1
op_plus
l_int|1
suffix:semicolon
id|x
OL
id|xtmp2
suffix:semicolon
id|x
op_increment
)paren
(brace
op_star
(paren
id|base
op_plus
id|x
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xc
OL
(paren
id|ww
op_amp
op_complement
l_int|0x7
)paren
)paren
(brace
op_star
(paren
id|base
op_plus
id|xtmp2
)paren
op_and_assign
(paren
r_int
r_char
)paren
(paren
l_int|0x00ff
op_rshift
(paren
(paren
id|xc
op_plus
id|wc
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|fill_cmd_buff
r_static
r_void
id|fill_cmd_buff
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|restore
op_assign
l_int|0
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
id|last
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: fill_cmd_buff()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;overlay_last1
op_ne
id|pb-&gt;ch1_cmd
)paren
(brace
id|restore
op_assign
l_int|1
suffix:semicolon
id|last
op_assign
op_star
(paren
id|pb-&gt;overlay_last1
)paren
suffix:semicolon
)brace
id|memset
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;ch1_cmd
comma
l_int|0
comma
l_int|2
op_star
id|pb-&gt;tab_size
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
id|cmd_buff
(paren
id|pb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restore
)paren
(brace
op_star
(paren
id|pb-&gt;overlay_last1
)paren
op_assign
id|last
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pb-&gt;suspended.overlay
)paren
(brace
r_int
r_int
id|jump_addr
op_assign
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jump_addr
op_ne
id|pb-&gt;ch1_cmd_phys
)paren
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: adjusting ch1&squot;s jump address&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pb-&gt;need_pre_capture
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|jump_addr
op_eq
id|virt_to_bus
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|i
)braket
)paren
)paren
(brace
r_goto
id|found
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|jump_addr
op_eq
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|i
)braket
)paren
)paren
(brace
r_goto
id|found
suffix:semicolon
)brace
)brace
)brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: not found...&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|found
suffix:colon
r_if
c_cond
(paren
id|pb-&gt;need_pre_capture
(braket
id|i
)braket
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;pre_cmd
(braket
id|i
)braket
op_member_access_from_pointer
id|phy_addr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;overlay_last1
)paren
)paren
suffix:semicolon
)brace
r_else
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;cap_cmd
(braket
id|i
)braket
op_member_access_from_pointer
id|phy_addr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;overlay_last1
)paren
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|pb-&gt;cmd_buff_inited
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cmd_buff
r_static
r_void
id|cmd_buff
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|i
comma
id|bpp
comma
id|count
comma
id|nlines
comma
id|stepsize
comma
id|interlace
suffix:semicolon
r_int
r_int
id|base
comma
id|jump
comma
id|addr_com
comma
id|addr_dep
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|c1
op_assign
id|pb-&gt;ch1_cmd
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|c2
op_assign
id|pb-&gt;ch2_cmd
suffix:semicolon
id|interlace
op_assign
id|pb-&gt;win.interlace
suffix:semicolon
id|bpp
op_assign
id|pb-&gt;win.bpp
suffix:semicolon
id|count
op_assign
(paren
id|bpp
op_star
(paren
(paren
id|pb-&gt;win.x
op_plus
id|pb-&gt;win.width
OG
id|pb-&gt;win.swidth
)paren
ques
c_cond
(paren
id|pb-&gt;win.swidth
op_minus
id|pb-&gt;win.x
)paren
suffix:colon
id|pb-&gt;win.width
)paren
)paren
suffix:semicolon
id|nlines
op_assign
(paren
(paren
id|pb-&gt;win.y
op_plus
id|pb-&gt;win.height
OG
id|pb-&gt;win.sheight
)paren
ques
c_cond
(paren
id|pb-&gt;win.sheight
op_minus
id|pb-&gt;win.y
)paren
suffix:colon
id|pb-&gt;win.height
)paren
suffix:semicolon
multiline_comment|/* Do video in: */
multiline_comment|/* Preamble commands: */
id|addr_com
op_assign
id|virt_to_bus
c_func
(paren
id|c1
)paren
suffix:semicolon
id|addr_dep
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|c1-&gt;cmd_dep
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|c1
op_plus
l_int|16
)paren
suffix:semicolon
multiline_comment|/* 14 by cmd_geo_setup() and 2 for padding */
r_if
c_cond
(paren
(paren
id|c1
op_assign
id|cmd_geo_setup
c_func
(paren
id|c1
comma
id|pb-&gt;win.width
comma
id|pb-&gt;win.height
comma
id|interlace
comma
id|bpp
comma
l_int|1
comma
id|pb
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PlanB: encountered serious problems&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;ch1_cmd
op_plus
l_int|1
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;ch2_cmd
op_plus
l_int|1
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
id|addr_com
comma
(paren
r_int
)paren
(paren
id|DBDMA_NOP
op_or
id|BR_ALWAYS
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
id|addr_dep
comma
id|jump
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.wait_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|FIELD_SYNC
)paren
)paren
suffix:semicolon
multiline_comment|/* (1) wait for field sync to be set */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for field sync to be cleared */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFSET
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if not odd field, wait until field sync is set again */
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_IFSET
comma
id|virt_to_bus
c_func
(paren
id|c1
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
multiline_comment|/* assert ch_sync to ch2 */
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.control
)paren
comma
id|PLANB_SET
c_func
(paren
id|CH_SYNC
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
id|base
op_assign
(paren
id|pb-&gt;frame_buffer_phys
op_plus
id|pb-&gt;offset
op_plus
id|pb-&gt;win.y
op_star
(paren
id|pb-&gt;win.bpl
op_plus
id|pb-&gt;win.pad
)paren
op_plus
id|pb-&gt;win.x
op_star
id|bpp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interlace
)paren
(brace
id|stepsize
op_assign
l_int|2
suffix:semicolon
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|c1
op_plus
(paren
id|nlines
op_plus
l_int|1
)paren
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|stepsize
op_assign
l_int|1
suffix:semicolon
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|c1
op_plus
id|nlines
)paren
suffix:semicolon
)brace
multiline_comment|/* even field data: */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nlines
suffix:semicolon
id|i
op_add_assign
id|stepsize
comma
id|c1
op_increment
)paren
id|tab_cmd_gen
c_func
(paren
id|c1
comma
id|INPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
id|count
comma
id|base
op_plus
id|i
op_star
(paren
id|pb-&gt;win.bpl
op_plus
id|pb-&gt;win.pad
)paren
comma
id|jump
)paren
suffix:semicolon
multiline_comment|/* For non-interlaced, we use even fields only */
r_if
c_cond
(paren
op_logical_neg
id|interlace
)paren
r_goto
id|cmd_tab_data_end
suffix:semicolon
multiline_comment|/* Resync to odd field */
multiline_comment|/* (2) wait for field sync to be set */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for field sync to be cleared */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFSET
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if not odd field, wait until field sync is set again */
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_IFCLR
comma
id|virt_to_bus
c_func
(paren
id|c1
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
multiline_comment|/* assert ch_sync to ch2 */
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.control
)paren
comma
id|PLANB_SET
c_func
(paren
id|CH_SYNC
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
multiline_comment|/* odd field data: */
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|c1
op_plus
id|nlines
op_div
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nlines
suffix:semicolon
id|i
op_add_assign
id|stepsize
comma
id|c1
op_increment
)paren
id|tab_cmd_gen
c_func
(paren
id|c1
comma
id|INPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
id|count
comma
id|base
op_plus
id|i
op_star
(paren
id|pb-&gt;win.bpl
op_plus
id|pb-&gt;win.pad
)paren
comma
id|jump
)paren
suffix:semicolon
multiline_comment|/* And jump back to the start */
id|cmd_tab_data_end
suffix:colon
id|pb-&gt;overlay_last1
op_assign
id|c1
suffix:semicolon
multiline_comment|/* keep a pointer to the last command */
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Clipmask command buffer */
multiline_comment|/* Preamble commands: */
id|tab_cmd_dbdma
c_func
(paren
id|c2
op_increment
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.wait_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|CH_SYNC
)paren
)paren
suffix:semicolon
multiline_comment|/* wait until ch1 asserts ch_sync */
id|tab_cmd_dbdma
c_func
(paren
id|c2
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* clear ch_sync asserted by ch1 */
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.control
)paren
comma
id|PLANB_CLR
c_func
(paren
id|CH_SYNC
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.wait_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|FIELD_SYNC
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
multiline_comment|/* jump to end of even field if appropriate */
multiline_comment|/* this points to (interlace)? pos. C: pos. B */
id|jump
op_assign
(paren
id|interlace
)paren
ques
c_cond
id|virt_to_bus
c_func
(paren
id|c2
op_plus
(paren
id|nlines
op_plus
l_int|1
)paren
op_div
l_int|2
op_plus
l_int|2
)paren
suffix:colon
id|virt_to_bus
c_func
(paren
id|c2
op_plus
id|nlines
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* if odd field, skip over to odd field clipmasking */
id|tab_cmd_dbdma
c_func
(paren
id|c2
op_increment
comma
id|DBDMA_NOP
op_or
id|BR_IFSET
comma
id|jump
)paren
suffix:semicolon
multiline_comment|/* even field mask: */
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
multiline_comment|/* this points to pos. B */
id|jump
op_assign
(paren
id|interlace
)paren
ques
c_cond
id|virt_to_bus
c_func
(paren
id|c2
op_plus
id|nlines
op_plus
l_int|1
)paren
suffix:colon
id|virt_to_bus
c_func
(paren
id|c2
op_plus
id|nlines
)paren
suffix:semicolon
id|base
op_assign
id|virt_to_bus
c_func
(paren
id|pb-&gt;mask
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nlines
suffix:semicolon
id|i
op_add_assign
id|stepsize
comma
id|c2
op_increment
)paren
id|tab_cmd_gen
c_func
(paren
id|c2
comma
id|OUTPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
l_int|96
comma
id|base
op_plus
id|i
op_star
l_int|96
comma
id|jump
)paren
suffix:semicolon
multiline_comment|/* For non-interlaced, we use only even fields */
r_if
c_cond
(paren
op_logical_neg
id|interlace
)paren
(brace
r_goto
id|cmd_tab_mask_end
suffix:semicolon
)brace
multiline_comment|/* odd field mask: */
multiline_comment|/* C */
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch2.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
multiline_comment|/* this points to pos. B */
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|c2
op_plus
id|nlines
op_div
l_int|2
)paren
suffix:semicolon
id|base
op_assign
id|virt_to_bus
c_func
(paren
id|pb-&gt;mask
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nlines
suffix:semicolon
id|i
op_add_assign
l_int|2
comma
id|c2
op_increment
)paren
multiline_comment|/* abort if set */
id|tab_cmd_gen
c_func
(paren
id|c2
comma
id|OUTPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
l_int|96
comma
id|base
op_plus
id|i
op_star
l_int|96
comma
id|jump
)paren
suffix:semicolon
multiline_comment|/* Inform channel 1 and jump back to start */
id|cmd_tab_mask_end
suffix:colon
multiline_comment|/* ok, I just realized this is kind of flawed. */
multiline_comment|/* this part is reached only after odd field clipmasking. */
multiline_comment|/* wanna clean up? */
multiline_comment|/* wait for field sync to be set */
multiline_comment|/* corresponds to fsync (1) of ch1 */
multiline_comment|/* B */
id|tab_cmd_dbdma
c_func
(paren
id|c2
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* restart ch1, meant to clear any dead bit or something */
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.control
)paren
comma
id|PLANB_CLR
c_func
(paren
id|RUN
)paren
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c2
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.control
)paren
comma
id|PLANB_SET
c_func
(paren
id|RUN
)paren
)paren
suffix:semicolon
id|pb-&gt;overlay_last2
op_assign
id|c2
suffix:semicolon
multiline_comment|/* keep a pointer to the last command */
multiline_comment|/* start over even field clipmasking */
id|tab_cmd_dbdma
c_func
(paren
id|c2
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch2_cmd
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*********************************/
multiline_comment|/* grabdisplay support functions */
multiline_comment|/*********************************/
DECL|variable|palette2fmt
r_static
r_int
id|palette2fmt
(braket
)braket
op_assign
(brace
l_int|0
comma
id|PLANB_GRAY
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|PLANB_COLOUR32
comma
id|PLANB_COLOUR15
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|macro|PLANB_PALETTE_MAX
mdefine_line|#define PLANB_PALETTE_MAX 15
DECL|function|overlay_is_active
r_static
r_inline
r_int
id|overlay_is_active
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
r_int
id|size
op_assign
id|pb-&gt;tab_size
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
suffix:semicolon
r_int
r_int
id|caddr
op_assign
(paren
r_int
)paren
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
)paren
suffix:semicolon
r_return
(paren
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
)paren
op_eq
id|pb-&gt;ch1_cmd_phys
)paren
op_logical_and
(paren
id|caddr
OL
(paren
id|pb-&gt;ch1_cmd_phys
op_plus
id|size
)paren
)paren
op_logical_and
(paren
id|caddr
op_ge
(paren
r_int
)paren
id|pb-&gt;ch1_cmd_phys
)paren
suffix:semicolon
)brace
DECL|function|vgrab
r_static
r_int
id|vgrab
c_func
(paren
r_struct
id|planb
op_star
id|pb
comma
r_struct
id|video_mmap
op_star
id|mp
)paren
(brace
r_int
r_int
id|fr
op_assign
id|mp-&gt;frame
suffix:semicolon
r_int
r_int
id|format
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;rawbuf
op_eq
l_int|NULL
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|grabbuf_alloc
c_func
(paren
id|pb
)paren
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: grab %d: %dx%d(%u)&bslash;n&quot;
comma
id|pb-&gt;grabbing
comma
id|mp-&gt;width
comma
id|mp-&gt;height
comma
id|fr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;grabbing
op_ge
id|MAX_GBUFFERS
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fr
OG
(paren
id|MAX_GBUFFERS
op_minus
l_int|1
)paren
op_logical_or
id|fr
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;height
op_le
l_int|0
op_logical_or
id|mp-&gt;width
op_le
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;format
OL
l_int|0
op_logical_or
id|mp-&gt;format
op_ge
id|PLANB_PALETTE_MAX
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|format
op_assign
id|palette2fmt
(braket
id|mp-&gt;format
)braket
)paren
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;height
op_star
id|mp-&gt;width
op_star
id|format
OG
id|PLANB_MAX_FBUF
)paren
multiline_comment|/* format = bpp */
r_return
op_minus
id|EINVAL
suffix:semicolon
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;width
op_ne
id|pb-&gt;gwidth
(braket
id|fr
)braket
op_logical_or
id|mp-&gt;height
op_ne
id|pb-&gt;gheight
(braket
id|fr
)braket
op_logical_or
id|format
op_ne
id|pb-&gt;gfmt
(braket
id|fr
)braket
op_logical_or
(paren
id|pb-&gt;gnorm_switch
(braket
id|fr
)braket
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifndef PLANB_GSCANLINE
r_int
r_int
id|osize
op_assign
id|pb-&gt;gwidth
(braket
id|fr
)braket
op_star
id|pb-&gt;gheight
(braket
id|fr
)braket
op_star
id|pb-&gt;gfmt
(braket
id|fr
)braket
suffix:semicolon
r_int
r_int
id|nsize
op_assign
id|mp-&gt;width
op_star
id|mp-&gt;height
op_star
id|format
suffix:semicolon
macro_line|#endif
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: gwidth = %d, gheight = %d, mp-&gt;format = %u&bslash;n&quot;
comma
id|mp-&gt;width
comma
id|mp-&gt;height
comma
id|mp-&gt;format
)paren
suffix:semicolon
macro_line|#ifndef PLANB_GSCANLINE
r_if
c_cond
(paren
id|pb-&gt;gnorm_switch
(braket
id|fr
)braket
)paren
(brace
id|nsize
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nsize
OL
id|osize
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|pb-&gt;gbuf_idx
(braket
id|fr
)braket
suffix:semicolon
id|osize
OG
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|osize
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
id|pb-&gt;l_fr_addr_idx
(braket
id|fr
)braket
suffix:semicolon
id|i
OL
id|pb-&gt;l_fr_addr_idx
(braket
id|fr
)braket
op_plus
id|pb-&gt;lnum
(braket
id|fr
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* XXX TODO */
multiline_comment|/*&n;&t;&t;if(pb-&gt;gnorm_switch[fr])&n;&t;&t;&t;memset((void *)pb-&gt;gbuffer[fr], 0,&n;&t;&t;&t;&t;&t;pb-&gt;gbytes_per_line * pb-&gt;gheight[fr]);&n;&t;&t;else {&n;&t;&t;&t;if(mp-&gt;&n;&t;&t;&t;for(i = 0; i &lt; pb-&gt;gheight[fr]; i++) {&n;&t;&t;&t;&t;memset((void *)(pb-&gt;gbuffer[fr]&n;&t;&t;&t;&t;&t;+ pb-&gt;gbytes_per_line * i&n;&t;&t;&t;}&n;&t;&t;}&n;*/
macro_line|#endif
id|pb-&gt;gwidth
(braket
id|fr
)braket
op_assign
id|mp-&gt;width
suffix:semicolon
id|pb-&gt;gheight
(braket
id|fr
)braket
op_assign
id|mp-&gt;height
suffix:semicolon
id|pb-&gt;gfmt
(braket
id|fr
)braket
op_assign
id|format
suffix:semicolon
id|pb-&gt;last_cmd
(braket
id|fr
)braket
op_assign
id|setup_grab_cmd
c_func
(paren
id|fr
comma
id|pb
)paren
suffix:semicolon
id|planb_pre_capture
c_func
(paren
id|fr
comma
id|pb-&gt;gfmt
(braket
id|fr
)braket
comma
id|pb
)paren
suffix:semicolon
multiline_comment|/* gfmt = bpp */
id|pb-&gt;need_pre_capture
(braket
id|fr
)braket
op_assign
l_int|1
suffix:semicolon
id|pb-&gt;gnorm_switch
(braket
id|fr
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|pb-&gt;need_pre_capture
(braket
id|fr
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;frame_stat
(braket
id|fr
)braket
op_assign
id|GBUFFER_GRABBING
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ACTIVE
op_amp
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
)paren
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: ch1 inactive, initiating grabbing&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;need_pre_capture
(braket
id|fr
)braket
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: padding pre-capture sequence&bslash;n&quot;
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|fr
)braket
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* let&squot;s be on the safe side. here is not timing critical. */
id|tab_cmd_dbdma
c_func
(paren
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
)paren
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
)brace
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|pb-&gt;last_fr
op_assign
id|fr
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: ch1 active, grabbing being queued&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pb-&gt;last_fr
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
(paren
id|pb-&gt;last_fr
op_eq
op_minus
l_int|2
)paren
op_logical_and
id|overlay_is_active
c_func
(paren
id|pb
)paren
)paren
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: overlay is active, grabbing defered&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;need_pre_capture
(braket
id|fr
)braket
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: padding pre-capture sequence&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
comma
id|virt_to_bus
c_func
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
)paren
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tab_cmd_store
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
comma
id|virt_to_bus
c_func
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
)paren
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
)paren
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;overlay_last1-&gt;cmd_dep
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|overlay_is_active
c_func
(paren
id|pb
)paren
op_logical_and
id|i
OL
l_int|999
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: waiting for overlay done&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;ch1_cmd
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
id|pb-&gt;prev_last_fr
op_assign
id|fr
suffix:semicolon
id|pb-&gt;last_fr
op_assign
op_minus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pb-&gt;last_fr
op_eq
op_minus
l_int|2
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: mixed mode detected, grabbing&quot;
l_string|&quot; will be done before activating overlay&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;ch1_cmd
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;need_pre_capture
(braket
id|fr
)braket
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: padding pre-capture sequence&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;prev_last_fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;gwidth
(braket
id|pb-&gt;prev_last_fr
)braket
op_ne
id|pb-&gt;gwidth
(braket
id|fr
)braket
op_logical_or
id|pb-&gt;gheight
(braket
id|pb-&gt;prev_last_fr
)braket
op_ne
id|pb-&gt;gheight
(braket
id|fr
)braket
op_logical_or
id|pb-&gt;gfmt
(braket
id|pb-&gt;prev_last_fr
)braket
op_ne
id|pb-&gt;gfmt
(braket
id|fr
)braket
)paren
(brace
id|tab_cmd_dbdma
c_func
(paren
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
)paren
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|tab_cmd_dbdma
c_func
(paren
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
)paren
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;prev_last_fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;ch1_cmd
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|pb-&gt;prev_last_fr
op_assign
id|fr
suffix:semicolon
id|pb-&gt;last_fr
op_assign
op_minus
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: active grabbing session detected&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;need_pre_capture
(braket
id|fr
)braket
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: padding pre-capture sequence&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;last_fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|fr
)braket
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;gwidth
(braket
id|pb-&gt;last_fr
)braket
op_ne
id|pb-&gt;gwidth
(braket
id|fr
)braket
op_logical_or
id|pb-&gt;gheight
(braket
id|pb-&gt;last_fr
)braket
op_ne
id|pb-&gt;gheight
(braket
id|fr
)braket
op_logical_or
id|pb-&gt;gfmt
(braket
id|pb-&gt;last_fr
)braket
op_ne
id|pb-&gt;gfmt
(braket
id|fr
)braket
)paren
(brace
id|tab_cmd_dbdma
c_func
(paren
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
)paren
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|tab_cmd_dbdma
c_func
(paren
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
)paren
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;last_cmd
(braket
id|pb-&gt;last_fr
)braket
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
id|pb-&gt;last_fr
op_assign
id|fr
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ACTIVE
op_amp
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
)paren
)paren
(brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: became inactive in the mean time...&quot;
l_string|&quot;reactivating&bslash;n&quot;
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.cmdptr
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
id|planb_dbdma_restart
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
)brace
)brace
id|pb-&gt;grabbing
op_increment
suffix:semicolon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|planb_pre_capture
r_static
r_void
id|planb_pre_capture
c_func
(paren
r_int
id|fr
comma
r_int
id|bpp
comma
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_volatile
r_struct
id|dbdma_cmd
op_star
id|c1
op_assign
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
suffix:semicolon
r_int
id|interlace
op_assign
(paren
id|pb-&gt;gheight
(braket
id|fr
)braket
OG
id|pb-&gt;maxlines
op_div
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c1
op_assign
id|cmd_geo_setup
c_func
(paren
id|c1
comma
id|pb-&gt;gwidth
(braket
id|fr
)braket
comma
id|pb-&gt;gheight
(braket
id|fr
)braket
comma
id|interlace
comma
id|bpp
comma
l_int|0
comma
id|pb
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PlanB: encountered some problems&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;pre_cmd
(braket
id|fr
)braket
op_plus
l_int|1
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Sync to even field */
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.wait_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|FIELD_SYNC
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFSET
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_IFSET
comma
id|virt_to_bus
c_func
(paren
id|c1
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|INTR_ALWAYS
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
multiline_comment|/* For non-interlaced, we use even fields only */
r_if
c_cond
(paren
id|pb-&gt;gheight
(braket
id|fr
)braket
op_le
id|pb-&gt;maxlines
op_div
l_int|2
)paren
r_goto
id|cmd_tab_data_end
suffix:semicolon
multiline_comment|/* Sync to odd field */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFSET
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_IFCLR
comma
id|virt_to_bus
c_func
(paren
id|c1
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
id|cmd_tab_data_end
suffix:colon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
)paren
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|setup_grab_cmd
r_static
r_volatile
r_struct
id|dbdma_cmd
op_star
id|setup_grab_cmd
c_func
(paren
r_int
id|fr
comma
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
id|i
comma
id|bpp
comma
id|count
comma
id|nlines
comma
id|stepsize
comma
id|interlace
suffix:semicolon
macro_line|#ifdef PLANB_GSCANLINE
r_int
id|scanline
suffix:semicolon
macro_line|#else
r_int
id|nlpp
comma
id|leftover1
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
macro_line|#endif
r_int
r_int
id|jump
suffix:semicolon
r_int
id|pagei
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|c1
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
op_star
id|jump_addr
suffix:semicolon
id|c1
op_assign
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
suffix:semicolon
id|interlace
op_assign
(paren
id|pb-&gt;gheight
(braket
id|fr
)braket
OG
id|pb-&gt;maxlines
op_div
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|bpp
op_assign
id|pb-&gt;gfmt
(braket
id|fr
)braket
suffix:semicolon
multiline_comment|/* gfmt = bpp */
id|count
op_assign
id|bpp
op_star
id|pb-&gt;gwidth
(braket
id|fr
)braket
suffix:semicolon
id|nlines
op_assign
id|pb-&gt;gheight
(braket
id|fr
)braket
suffix:semicolon
macro_line|#ifdef PLANB_GSCANLINE
id|scanline
op_assign
id|pb-&gt;gbytes_per_line
suffix:semicolon
macro_line|#else
id|pb-&gt;lsize
(braket
id|fr
)braket
op_assign
id|count
suffix:semicolon
id|pb-&gt;lnum
(braket
id|fr
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Do video in: */
multiline_comment|/* Preamble commands: */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|virt_to_bus
c_func
(paren
id|c1
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c1
op_assign
id|cmd_geo_setup
c_func
(paren
id|c1
comma
id|pb-&gt;gwidth
(braket
id|fr
)braket
comma
id|pb-&gt;gheight
(braket
id|fr
)braket
comma
id|interlace
comma
id|bpp
comma
l_int|0
comma
id|pb
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PlanB: encountered serious problems&bslash;n&quot;
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|1
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|pb-&gt;cap_cmd
(braket
id|fr
)braket
op_plus
l_int|2
)paren
suffix:semicolon
)brace
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.wait_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|FIELD_SYNC
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFSET
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_IFSET
comma
id|virt_to_bus
c_func
(paren
id|c1
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|INTR_ALWAYS
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interlace
)paren
(brace
id|stepsize
op_assign
l_int|2
suffix:semicolon
id|jump_addr
op_assign
id|c1
op_plus
id|TAB_FACTOR
op_star
(paren
id|nlines
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|stepsize
op_assign
l_int|1
suffix:semicolon
id|jump_addr
op_assign
id|c1
op_plus
id|TAB_FACTOR
op_star
id|nlines
suffix:semicolon
)brace
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|jump_addr
)paren
suffix:semicolon
multiline_comment|/* even field data: */
id|pagei
op_assign
id|pb-&gt;gbuf_idx
(braket
id|fr
)braket
suffix:semicolon
macro_line|#ifdef PLANB_GSCANLINE
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nlines
suffix:semicolon
id|i
op_add_assign
id|stepsize
)paren
(brace
id|tab_cmd_gen
c_func
(paren
id|c1
op_increment
comma
id|INPUT_MORE
op_or
id|BR_IFSET
comma
id|count
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pagei
op_plus
id|i
op_star
id|scanline
op_div
id|PAGE_SIZE
)braket
)paren
comma
id|jump
)paren
suffix:semicolon
)brace
macro_line|#else
id|i
op_assign
l_int|0
suffix:semicolon
id|leftover1
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_int
id|j
suffix:semicolon
id|base
op_assign
id|virt_to_bus
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pagei
)braket
)paren
suffix:semicolon
id|nlpp
op_assign
(paren
id|PAGE_SIZE
op_minus
id|leftover1
)paren
op_div
id|count
op_div
id|stepsize
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|nlpp
op_logical_and
id|i
OL
id|nlines
suffix:semicolon
id|j
op_increment
comma
id|i
op_add_assign
id|stepsize
comma
id|c1
op_increment
)paren
(brace
id|tab_cmd_gen
c_func
(paren
id|c1
comma
id|INPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
id|count
comma
id|base
op_plus
id|count
op_star
id|j
op_star
id|stepsize
op_plus
id|leftover1
comma
id|jump
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|nlines
)paren
(brace
r_int
id|lov0
op_assign
id|PAGE_SIZE
op_minus
id|count
op_star
id|nlpp
op_star
id|stepsize
op_minus
id|leftover1
suffix:semicolon
r_if
c_cond
(paren
id|lov0
op_eq
l_int|0
)paren
(brace
id|leftover1
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lov0
op_ge
id|count
)paren
(brace
id|tab_cmd_gen
c_func
(paren
id|c1
op_increment
comma
id|INPUT_MORE
op_or
id|BR_IFSET
comma
id|count
comma
id|base
op_plus
id|count
op_star
id|nlpp
op_star
id|stepsize
op_plus
id|leftover1
comma
id|jump
)paren
suffix:semicolon
)brace
r_else
(brace
id|pb-&gt;l_to_addr
(braket
id|fr
)braket
(braket
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
op_assign
id|pb-&gt;rawbuf
(braket
id|pagei
)braket
op_plus
id|count
op_star
id|nlpp
op_star
id|stepsize
op_plus
id|leftover1
suffix:semicolon
id|pb-&gt;l_to_next_idx
(braket
id|fr
)braket
(braket
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
op_assign
id|pagei
op_plus
l_int|1
suffix:semicolon
id|pb-&gt;l_to_next_size
(braket
id|fr
)braket
(braket
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
op_assign
id|count
op_minus
id|lov0
suffix:semicolon
id|tab_cmd_gen
c_func
(paren
id|c1
op_increment
comma
id|INPUT_MORE
op_or
id|BR_IFSET
comma
id|count
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pb-&gt;l_fr_addr_idx
(braket
id|fr
)braket
op_plus
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
)paren
comma
id|jump
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|pb-&gt;lnum
(braket
id|fr
)braket
OG
id|MAX_LNUM
)paren
(brace
id|pb-&gt;lnum
(braket
id|fr
)braket
op_decrement
suffix:semicolon
)brace
)brace
id|leftover1
op_assign
id|count
op_star
id|stepsize
op_minus
id|lov0
suffix:semicolon
id|i
op_add_assign
id|stepsize
suffix:semicolon
)brace
)brace
id|pagei
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|nlines
)paren
(brace
suffix:semicolon
)brace
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|jump
)paren
suffix:semicolon
id|c1
op_assign
id|jump_addr
suffix:semicolon
macro_line|#endif /* PLANB_GSCANLINE */
multiline_comment|/* For non-interlaced, we use even fields only */
r_if
c_cond
(paren
op_logical_neg
id|interlace
)paren
r_goto
id|cmd_tab_data_end
suffix:semicolon
multiline_comment|/* Sync to odd field */
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFCLR
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|ODD_FIELD
)paren
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
op_increment
comma
id|DBDMA_NOP
op_or
id|WAIT_IFSET
comma
l_int|0
)paren
suffix:semicolon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_IFCLR
comma
id|virt_to_bus
c_func
(paren
id|c1
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|c1
op_increment
suffix:semicolon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;ch1.br_sel
)paren
comma
id|PLANB_SET
c_func
(paren
id|DMA_ABORT
)paren
)paren
suffix:semicolon
multiline_comment|/* odd field data: */
id|jump_addr
op_assign
id|c1
op_plus
id|TAB_FACTOR
op_star
id|nlines
op_div
l_int|2
suffix:semicolon
id|jump
op_assign
id|virt_to_bus
c_func
(paren
id|jump_addr
)paren
suffix:semicolon
macro_line|#ifdef PLANB_GSCANLINE
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nlines
suffix:semicolon
id|i
op_add_assign
id|stepsize
)paren
(brace
id|tab_cmd_gen
c_func
(paren
id|c1
op_increment
comma
id|INPUT_MORE
op_or
id|BR_IFSET
comma
id|count
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pagei
op_plus
id|i
op_star
id|scanline
op_div
id|PAGE_SIZE
)braket
)paren
comma
id|jump
)paren
suffix:semicolon
)brace
macro_line|#else
id|i
op_assign
l_int|1
suffix:semicolon
id|leftover1
op_assign
l_int|0
suffix:semicolon
id|pagei
op_assign
id|pb-&gt;gbuf_idx
(braket
id|fr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nlines
op_le
l_int|1
)paren
(brace
r_goto
id|skip
suffix:semicolon
)brace
r_do
(brace
r_int
id|j
suffix:semicolon
id|base
op_assign
id|virt_to_bus
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pagei
)braket
)paren
suffix:semicolon
id|nlpp
op_assign
(paren
id|PAGE_SIZE
op_minus
id|leftover1
)paren
op_div
id|count
op_div
id|stepsize
suffix:semicolon
r_if
c_cond
(paren
id|leftover1
op_ge
id|count
)paren
(brace
id|tab_cmd_gen
c_func
(paren
id|c1
op_increment
comma
id|INPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
id|count
comma
id|base
op_plus
id|leftover1
op_minus
id|count
comma
id|jump
)paren
suffix:semicolon
id|i
op_add_assign
id|stepsize
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|nlpp
op_logical_and
id|i
OL
id|nlines
suffix:semicolon
id|j
op_increment
comma
id|i
op_add_assign
id|stepsize
comma
id|c1
op_increment
)paren
(brace
id|tab_cmd_gen
c_func
(paren
id|c1
comma
id|INPUT_MORE
op_or
id|KEY_STREAM0
op_or
id|BR_IFSET
comma
id|count
comma
id|base
op_plus
id|count
op_star
(paren
id|j
op_star
id|stepsize
op_plus
l_int|1
)paren
op_plus
id|leftover1
comma
id|jump
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|nlines
)paren
(brace
r_int
id|lov0
op_assign
id|PAGE_SIZE
op_minus
id|count
op_star
id|nlpp
op_star
id|stepsize
op_minus
id|leftover1
suffix:semicolon
r_if
c_cond
(paren
id|lov0
op_eq
l_int|0
)paren
(brace
id|leftover1
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lov0
OG
id|count
)paren
(brace
id|pb-&gt;l_to_addr
(braket
id|fr
)braket
(braket
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
op_assign
id|pb-&gt;rawbuf
(braket
id|pagei
)braket
op_plus
id|count
op_star
(paren
id|nlpp
op_star
id|stepsize
op_plus
l_int|1
)paren
op_plus
id|leftover1
suffix:semicolon
id|pb-&gt;l_to_next_idx
(braket
id|fr
)braket
(braket
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
op_assign
id|pagei
op_plus
l_int|1
suffix:semicolon
id|pb-&gt;l_to_next_size
(braket
id|fr
)braket
(braket
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
op_assign
id|count
op_star
id|stepsize
op_minus
id|lov0
suffix:semicolon
id|tab_cmd_gen
c_func
(paren
id|c1
op_increment
comma
id|INPUT_MORE
op_or
id|BR_IFSET
comma
id|count
comma
id|virt_to_bus
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pb-&gt;l_fr_addr_idx
(braket
id|fr
)braket
op_plus
id|pb-&gt;lnum
(braket
id|fr
)braket
)braket
)paren
comma
id|jump
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|pb-&gt;lnum
(braket
id|fr
)braket
OG
id|MAX_LNUM
)paren
(brace
id|pb-&gt;lnum
(braket
id|fr
)braket
op_decrement
suffix:semicolon
)brace
id|i
op_add_assign
id|stepsize
suffix:semicolon
)brace
id|leftover1
op_assign
id|count
op_star
id|stepsize
op_minus
id|lov0
suffix:semicolon
)brace
)brace
id|pagei
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|nlines
)paren
(brace
suffix:semicolon
)brace
id|skip
suffix:colon
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_NOP
op_or
id|BR_ALWAYS
comma
id|jump
)paren
suffix:semicolon
id|c1
op_assign
id|jump_addr
suffix:semicolon
macro_line|#endif /* PLANB_GSCANLINE */
id|cmd_tab_data_end
suffix:colon
id|tab_cmd_store
c_func
(paren
id|c1
op_increment
comma
(paren
r_int
)paren
(paren
op_amp
id|pb-&gt;planb_base_phys-&gt;intr_stat
)paren
comma
(paren
id|fr
op_lshift
l_int|9
)paren
op_or
id|PLANB_FRM_IRQ
op_or
id|PLANB_GEN_IRQ
)paren
suffix:semicolon
multiline_comment|/* stop it */
id|tab_cmd_dbdma
c_func
(paren
id|c1
comma
id|DBDMA_STOP
comma
l_int|0
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_return
id|c1
suffix:semicolon
)brace
DECL|function|planb_irq
r_static
r_void
id|planb_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|stat
comma
id|astat
suffix:semicolon
r_struct
id|planb
op_star
id|pb
op_assign
(paren
r_struct
id|planb
op_star
)paren
id|dev_id
suffix:semicolon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: planb_irq()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* get/clear interrupt status bits */
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|stat
op_assign
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;intr_stat
)paren
suffix:semicolon
id|astat
op_assign
id|stat
op_amp
id|pb-&gt;intr_mask
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;intr_stat
comma
id|PLANB_FRM_IRQ
op_amp
op_complement
id|astat
op_amp
id|stat
op_amp
op_complement
id|PLANB_GEN_IRQ
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: stat = %X, astat = %X&bslash;n&quot;
comma
id|stat
comma
id|astat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|astat
op_amp
id|PLANB_FRM_IRQ
)paren
(brace
r_int
r_int
id|fr
op_assign
id|stat
op_rshift
l_int|9
suffix:semicolon
macro_line|#ifndef PLANB_GSCANLINE
r_int
id|i
suffix:semicolon
macro_line|#endif
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: PLANB_FRM_IRQ&bslash;n&quot;
)paren
suffix:semicolon
id|pb-&gt;gcount
op_increment
suffix:semicolon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: grab %d: fr = %d, gcount = %d&bslash;n&quot;
comma
id|pb-&gt;grabbing
comma
id|fr
comma
id|pb-&gt;gcount
)paren
suffix:semicolon
macro_line|#ifndef PLANB_GSCANLINE
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: %d * %d bytes are being copied over&bslash;n&quot;
comma
id|pb-&gt;lnum
(braket
id|fr
)braket
comma
id|pb-&gt;lsize
(braket
id|fr
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pb-&gt;lnum
(braket
id|fr
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|first
op_assign
id|pb-&gt;lsize
(braket
id|fr
)braket
op_minus
id|pb-&gt;l_to_next_size
(braket
id|fr
)braket
(braket
id|i
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|pb-&gt;l_to_addr
(braket
id|fr
)braket
(braket
id|i
)braket
comma
id|pb-&gt;rawbuf
(braket
id|pb-&gt;l_fr_addr_idx
(braket
id|fr
)braket
op_plus
id|i
)braket
comma
id|first
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pb-&gt;rawbuf
(braket
id|pb-&gt;l_to_next_idx
(braket
id|fr
)braket
(braket
id|i
)braket
)braket
comma
id|pb-&gt;rawbuf
(braket
id|pb-&gt;l_fr_addr_idx
(braket
id|fr
)braket
op_plus
id|i
)braket
op_plus
id|first
comma
id|pb-&gt;l_to_next_size
(braket
id|fr
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|pb-&gt;frame_stat
(braket
id|fr
)braket
op_assign
id|GBUFFER_DONE
suffix:semicolon
id|pb-&gt;grabbing
op_decrement
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|pb-&gt;capq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* incorrect interrupts? */
id|pb-&gt;intr_mask
op_assign
id|PLANB_CLR_IRQ
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;intr_stat
comma
id|PLANB_CLR_IRQ
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PlanB: IRQ lockup, cleared intrrupts&quot;
l_string|&quot; unconditionally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************&n; * Device Operations functions *&n; *******************************/
DECL|function|planb_open
r_static
r_int
id|planb_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|mode
)paren
(brace
r_struct
id|planb
op_star
id|pb
op_assign
(paren
r_struct
id|planb
op_star
)paren
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;user
op_eq
l_int|0
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|planb_prepare_open
c_func
(paren
id|pb
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|pb-&gt;user
op_increment
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: device opened&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|planb_close
r_static
r_void
id|planb_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|planb
op_star
id|pb
op_assign
(paren
r_struct
id|planb
op_star
)paren
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;user
OL
l_int|1
)paren
(brace
multiline_comment|/* ??? */
r_return
suffix:semicolon
)brace
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;user
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|pb-&gt;overlay
)paren
(brace
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|pb-&gt;overlay
op_assign
l_int|0
suffix:semicolon
)brace
id|planb_prepare_close
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
id|pb-&gt;user
op_decrement
suffix:semicolon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: device closed&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|planb_read
r_static
r_int
id|planb_read
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;planb: read request&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|planb_write
r_static
r_int
id|planb_write
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;planb: write request&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|planb_ioctl
r_static
r_int
id|planb_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|planb
op_star
id|pb
op_assign
(paren
r_struct
id|planb
op_star
)paren
id|dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGCAP&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
(paren
id|b.name
comma
id|pb-&gt;video_dev.name
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_CLIPPING
op_or
id|VID_TYPE_FRAMERAM
op_or
id|VID_TYPE_SCALES
op_or
id|VID_TYPE_CAPTURE
suffix:semicolon
id|b.channels
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* composite &amp; svhs */
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
id|PLANB_MAXPIXELS
suffix:semicolon
id|b.maxheight
op_assign
id|PLANB_MAXLINES
suffix:semicolon
id|b.minwidth
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* wild guess */
id|b.minheight
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
r_int
r_int
id|bpp
suffix:semicolon
r_int
r_int
id|fmt
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSFBUF&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|v.depth
)paren
(brace
r_case
l_int|8
suffix:colon
id|bpp
op_assign
l_int|1
suffix:semicolon
id|fmt
op_assign
id|PLANB_GRAY
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
id|bpp
op_assign
l_int|2
suffix:semicolon
id|fmt
op_assign
id|PLANB_COLOUR15
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|bpp
op_assign
l_int|4
suffix:semicolon
id|fmt
op_assign
id|PLANB_COLOUR32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bpp
op_star
id|v.width
OG
id|v.bytesperline
)paren
(brace
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pb-&gt;win.bpp
op_assign
id|bpp
suffix:semicolon
id|pb-&gt;win.color_fmt
op_assign
id|fmt
suffix:semicolon
id|pb-&gt;frame_buffer_phys
op_assign
(paren
r_int
r_int
)paren
id|v.base
suffix:semicolon
id|pb-&gt;win.sheight
op_assign
id|v.height
suffix:semicolon
id|pb-&gt;win.swidth
op_assign
id|v.width
suffix:semicolon
id|pb-&gt;picture.depth
op_assign
id|pb-&gt;win.depth
op_assign
id|v.depth
suffix:semicolon
id|pb-&gt;win.bpl
op_assign
id|pb-&gt;win.bpp
op_star
id|pb-&gt;win.swidth
suffix:semicolon
id|pb-&gt;win.pad
op_assign
id|v.bytesperline
op_minus
id|pb-&gt;win.bpl
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: Display at %p is %d by %d, bytedepth %d,&quot;
l_string|&quot; bpl %d (+ %d)&bslash;n&quot;
comma
id|v.base
comma
id|v.width
comma
id|v.height
comma
id|pb-&gt;win.bpp
comma
id|pb-&gt;win.bpl
comma
id|pb-&gt;win.pad
)paren
suffix:semicolon
id|pb-&gt;cmd_buff_inited
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;overlay
)paren
(brace
id|suspend_overlay
c_func
(paren
id|pb
)paren
suffix:semicolon
id|fill_cmd_buff
c_func
(paren
id|pb
)paren
suffix:semicolon
id|resume_overlay
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGFBUF&bslash;n&quot;
)paren
suffix:semicolon
id|v.base
op_assign
(paren
r_void
op_star
)paren
id|pb-&gt;frame_buffer_phys
suffix:semicolon
id|v.height
op_assign
id|pb-&gt;win.sheight
suffix:semicolon
id|v.width
op_assign
id|pb-&gt;win.swidth
suffix:semicolon
id|v.depth
op_assign
id|pb-&gt;win.depth
suffix:semicolon
id|v.bytesperline
op_assign
id|pb-&gt;win.bpl
op_plus
id|pb-&gt;win.pad
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|arg
comma
r_sizeof
(paren
id|i
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCCAPTURE Stop&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pb-&gt;overlay
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
id|pb-&gt;overlay
op_assign
l_int|0
suffix:semicolon
id|overlay_stop
c_func
(paren
id|pb
)paren
suffix:semicolon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCCAPTURE Start&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;frame_buffer_phys
op_eq
l_int|0
op_logical_or
id|pb-&gt;win.width
op_eq
l_int|0
op_logical_or
id|pb-&gt;win.height
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;overlay
)paren
r_return
l_int|0
suffix:semicolon
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
id|pb-&gt;overlay
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pb-&gt;cmd_buff_inited
)paren
)paren
(brace
id|fill_cmd_buff
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
id|overlay_start
c_func
(paren
id|pb
)paren
suffix:semicolon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGCHAN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|v.norm
op_assign
id|pb-&gt;win.norm
suffix:semicolon
r_switch
c_cond
(paren
id|v.channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Composite&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;SVHS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSCHAN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.norm
op_ne
id|pb-&gt;win.norm
)paren
(brace
r_int
id|i
comma
id|maxlines
suffix:semicolon
r_switch
c_cond
(paren
id|v.norm
)paren
(brace
r_case
id|VIDEO_MODE_PAL
suffix:colon
r_case
id|VIDEO_MODE_SECAM
suffix:colon
id|maxlines
op_assign
id|PLANB_MAXLINES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_MODE_NTSC
suffix:colon
id|maxlines
op_assign
id|PLANB_NTSC_MAXLINES
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
multiline_comment|/* empty the grabbing queue */
r_while
c_loop
(paren
id|pb-&gt;grabbing
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|pb-&gt;capq
)paren
suffix:semicolon
)brace
id|pb-&gt;maxlines
op_assign
id|maxlines
suffix:semicolon
id|pb-&gt;win.norm
op_assign
id|v.norm
suffix:semicolon
multiline_comment|/* Stop overlay if running */
id|suspend_overlay
c_func
(paren
id|pb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pb-&gt;gnorm_switch
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* I know it&squot;s an overkill, but.... */
id|fill_cmd_buff
c_func
(paren
id|pb
)paren
suffix:semicolon
multiline_comment|/* ok, now init it accordingly */
id|saa_init_regs
(paren
id|pb
)paren
suffix:semicolon
multiline_comment|/* restart overlay if it was running */
id|resume_overlay
c_func
(paren
id|pb
)paren
suffix:semicolon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|v.channel
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Composite&t;*/
id|saa_set
(paren
id|SAA7196_IOCC
comma
(paren
(paren
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_IOCC
)braket
op_amp
op_complement
l_int|7
)paren
op_or
l_int|3
)paren
comma
id|pb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* SVHS&t;&t;*/
id|saa_set
(paren
id|SAA7196_IOCC
comma
(paren
(paren
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_IOCC
)braket
op_amp
op_complement
l_int|7
)paren
op_or
l_int|4
)paren
comma
id|pb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|vp
op_assign
id|pb-&gt;picture
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGPICT&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pb-&gt;win.color_fmt
)paren
(brace
r_case
id|PLANB_GRAY
suffix:colon
id|vp.palette
op_assign
id|VIDEO_PALETTE_GREY
suffix:semicolon
r_case
id|PLANB_COLOUR15
suffix:colon
id|vp.palette
op_assign
id|VIDEO_PALETTE_RGB555
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PLANB_COLOUR32
suffix:colon
id|vp.palette
op_assign
id|VIDEO_PALETTE_RGB32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|vp.palette
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vp
comma
r_sizeof
(paren
id|vp
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|vp
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSPICT&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vp
comma
id|arg
comma
r_sizeof
(paren
id|vp
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|pb-&gt;picture
op_assign
id|vp
suffix:semicolon
multiline_comment|/* Should we do sanity checks here? */
id|saa_set
(paren
id|SAA7196_BRIG
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|pb-&gt;picture.brightness
)paren
op_rshift
l_int|8
)paren
comma
id|pb
)paren
suffix:semicolon
id|saa_set
(paren
id|SAA7196_HUEC
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|pb-&gt;picture.hue
)paren
op_rshift
l_int|8
)paren
op_xor
l_int|0x80
comma
id|pb
)paren
suffix:semicolon
id|saa_set
(paren
id|SAA7196_CSAT
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|pb-&gt;picture.colour
)paren
op_rshift
l_int|9
)paren
comma
id|pb
)paren
suffix:semicolon
id|saa_set
(paren
id|SAA7196_CONT
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|pb-&gt;picture.contrast
)paren
op_rshift
l_int|9
)paren
comma
id|pb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_struct
id|video_clip
id|clip
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSWIN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|planb_lock
c_func
(paren
id|pb
)paren
suffix:semicolon
multiline_comment|/* Stop overlay if running */
id|suspend_overlay
c_func
(paren
id|pb
)paren
suffix:semicolon
id|pb-&gt;win.interlace
op_assign
(paren
id|vw.height
OG
id|pb-&gt;maxlines
op_div
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;win.x
op_ne
id|vw.x
op_logical_or
id|pb-&gt;win.y
op_ne
id|vw.y
op_logical_or
id|pb-&gt;win.width
op_ne
id|vw.width
op_logical_or
id|pb-&gt;win.height
op_ne
id|vw.height
op_logical_or
op_logical_neg
id|pb-&gt;cmd_buff_inited
)paren
(brace
id|pb-&gt;win.x
op_assign
id|vw.x
suffix:semicolon
id|pb-&gt;win.y
op_assign
id|vw.y
suffix:semicolon
id|pb-&gt;win.width
op_assign
id|vw.width
suffix:semicolon
id|pb-&gt;win.height
op_assign
id|vw.height
suffix:semicolon
id|fill_cmd_buff
c_func
(paren
id|pb
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset clip mask */
id|memset
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;mask
comma
l_int|0xff
comma
(paren
id|pb-&gt;maxlines
op_star
(paren
(paren
id|PLANB_MAXPIXELS
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
)paren
op_div
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Add any clip rects */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vw.clipcount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|clip
comma
id|vw.clips
op_plus
id|i
comma
r_sizeof
(paren
r_struct
id|video_clip
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|add_clip
c_func
(paren
id|pb
comma
op_amp
id|clip
)paren
suffix:semicolon
)brace
multiline_comment|/* restart overlay if it was running */
id|resume_overlay
c_func
(paren
id|pb
)paren
suffix:semicolon
id|planb_unlock
c_func
(paren
id|pb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGWIN&bslash;n&quot;
)paren
suffix:semicolon
id|vw.x
op_assign
id|pb-&gt;win.x
suffix:semicolon
id|vw.y
op_assign
id|pb-&gt;win.y
suffix:semicolon
id|vw.width
op_assign
id|pb-&gt;win.width
suffix:semicolon
id|vw.height
op_assign
id|pb-&gt;win.height
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;win.interlace
)paren
(brace
id|vw.flags
op_or_assign
id|VIDEO_WINDOW_INTERLACE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|i
suffix:semicolon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSYNC&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|i
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: sync to frame %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
(paren
id|MAX_GBUFFERS
op_minus
l_int|1
)paren
op_logical_or
id|i
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|chk_grab
suffix:colon
r_switch
c_cond
(paren
id|pb-&gt;frame_stat
(braket
id|i
)braket
)paren
(brace
r_case
id|GBUFFER_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|GBUFFER_GRABBING
suffix:colon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: waiting for grab&quot;
l_string|&quot; done (%d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|pb-&gt;capq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_goto
id|chk_grab
suffix:semicolon
r_case
id|GBUFFER_DONE
suffix:colon
id|pb-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_UNUSED
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_volatile
r_int
r_int
id|status
suffix:semicolon
id|IDEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCMCAPTURE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|status
op_assign
id|pb-&gt;frame_stat
(braket
id|vm.frame
)braket
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|GBUFFER_UNUSED
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
id|vgrab
c_func
(paren
id|pb
comma
op_amp
id|vm
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_struct
id|video_mbuf
id|vm
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGMBUF&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|PLANB_MAX_FBUF
op_star
id|MAX_GBUFFERS
suffix:semicolon
id|vm.frames
op_assign
id|MAX_GBUFFERS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vm.offsets
(braket
id|i
)braket
op_assign
id|PLANB_MAX_FBUF
op_star
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PLANBIOCGSAAREGS
suffix:colon
(brace
r_struct
id|planb_saa_regs
id|preg
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANBIOCGSAAREGS&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|preg
comma
id|arg
comma
r_sizeof
(paren
id|preg
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|preg.addr
op_ge
id|SAA7196_NUMREGS
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|preg.val
op_assign
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|preg.addr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|preg
comma
r_sizeof
(paren
id|preg
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PLANBIOCSSAAREGS
suffix:colon
(brace
r_struct
id|planb_saa_regs
id|preg
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANBIOCSSAAREGS&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|preg
comma
id|arg
comma
r_sizeof
(paren
id|preg
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|preg.addr
op_ge
id|SAA7196_NUMREGS
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|saa_set
(paren
id|preg.addr
comma
id|preg.val
comma
id|pb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PLANBIOCGSTAT
suffix:colon
(brace
r_struct
id|planb_stat_regs
id|pstat
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANBIOCGSTAT&bslash;n&quot;
)paren
suffix:semicolon
id|pstat.ch1_stat
op_assign
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1.status
)paren
suffix:semicolon
id|pstat.ch2_stat
op_assign
id|in_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2.status
)paren
suffix:semicolon
id|pstat.saa_stat0
op_assign
id|saa_status
c_func
(paren
l_int|0
comma
id|pb
)paren
suffix:semicolon
id|pstat.saa_stat1
op_assign
id|saa_status
c_func
(paren
l_int|1
comma
id|pb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|pstat
comma
r_sizeof
(paren
id|pstat
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PLANBIOCSMODE
suffix:colon
(brace
r_int
id|v
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANBIOCSMODE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|v
)paren
(brace
r_case
id|PLANB_TV_MODE
suffix:colon
id|saa_set
(paren
id|SAA7196_STDC
comma
(paren
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_STDC
)braket
op_amp
l_int|0x7f
)paren
comma
id|pb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PLANB_VTR_MODE
suffix:colon
id|saa_set
(paren
id|SAA7196_STDC
comma
(paren
id|saa_regs
(braket
id|pb-&gt;win.norm
)braket
(braket
id|SAA7196_STDC
)braket
op_or
l_int|0x80
)paren
comma
id|pb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pb-&gt;win.mode
op_assign
id|v
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PLANBIOCGMODE
suffix:colon
(brace
r_int
id|v
op_assign
id|pb-&gt;win.mode
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANBIOCGMODE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef PLANB_GSCANLINE
r_case
id|PLANBG_GRAB_BPL
suffix:colon
(brace
r_int
id|v
op_assign
id|pb-&gt;gbytes_per_line
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANBG_GRAB_BPL&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* PLANB_GSCANLINE */
r_case
id|PLANB_INTR_DEBUG
suffix:colon
(brace
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANB_INTR_DEBUG&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|arg
comma
r_sizeof
(paren
id|i
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* avoid hang ups all together */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pb-&gt;frame_stat
(braket
id|i
)braket
op_eq
id|GBUFFER_GRABBING
)paren
(brace
id|pb-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_DONE
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pb-&gt;grabbing
)paren
(brace
id|pb-&gt;grabbing
op_decrement
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|pb-&gt;capq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PLANB_INV_REGS
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_struct
id|planb_any_regs
id|any
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL PLANB_INV_REGS&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|any
comma
id|arg
comma
r_sizeof
(paren
id|any
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|any.offset
template_param
l_int|0x400
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|any.bytes
OG
l_int|128
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|any.bytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|any.data
(braket
id|i
)braket
op_assign
id|in_8
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|pb-&gt;planb_base
op_plus
id|any.offset
op_plus
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|any
comma
r_sizeof
(paren
id|any
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: Unimplemented IOCTL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/* Some IOCTLs are currently unsupported on PlanB */
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGTUNER&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSTUNER&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
r_case
id|VIDIOCSFREQ
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSFREQ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
r_case
id|VIDIOCGFREQ
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGFREQ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCKEY&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCSAUDIO&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: IOCTL VIDIOCGAUDIO&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unimplemented
suffix:semicolon
)brace
id|unimplemented
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;       Unimplemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|planb_mmap
r_static
r_int
id|planb_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|planb
op_star
id|pb
op_assign
(paren
r_struct
id|planb
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_GBUFFERS
op_star
id|PLANB_MAX_FBUF
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pb-&gt;rawbuf
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|grabbuf_alloc
c_func
(paren
id|pb
)paren
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pb-&gt;rawbuf_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;rawbuf
(braket
id|i
)braket
)paren
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
id|PAGE_SIZE
)paren
r_break
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|planb_template
r_static
r_struct
id|video_device
id|planb_template
op_assign
(brace
id|name
suffix:colon
id|PLANB_DEVICE_NAME
comma
id|type
suffix:colon
id|VID_TYPE_OVERLAY
comma
id|hardware
suffix:colon
id|VID_HARDWARE_PLANB
comma
id|open
suffix:colon
id|planb_open
comma
id|close
suffix:colon
id|planb_close
comma
id|read
suffix:colon
id|planb_read
comma
id|write
suffix:colon
id|planb_write
comma
id|ioctl
suffix:colon
id|planb_ioctl
comma
id|mmap
suffix:colon
id|planb_mmap
comma
multiline_comment|/* mmap? */
)brace
suffix:semicolon
DECL|function|init_planb
r_static
r_int
id|init_planb
c_func
(paren
r_struct
id|planb
op_star
id|pb
)paren
(brace
r_int
r_char
id|saa_rev
suffix:semicolon
r_int
id|i
comma
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|pb-&gt;win
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|planb_window
)paren
)paren
suffix:semicolon
multiline_comment|/* Simple sanity check */
r_if
c_cond
(paren
id|def_norm
op_ge
id|NUM_SUPPORTED_NORM
op_logical_or
id|def_norm
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PlanB: Option(s) invalid&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
id|pb-&gt;win.norm
op_assign
id|def_norm
suffix:semicolon
id|pb-&gt;win.mode
op_assign
id|PLANB_TV_MODE
suffix:semicolon
multiline_comment|/* TV mode */
id|pb-&gt;win.interlace
op_assign
l_int|1
suffix:semicolon
id|pb-&gt;win.x
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;win.y
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;win.width
op_assign
l_int|768
suffix:semicolon
multiline_comment|/* 640 */
id|pb-&gt;win.height
op_assign
l_int|576
suffix:semicolon
multiline_comment|/* 480 */
id|pb-&gt;maxlines
op_assign
l_int|576
suffix:semicolon
macro_line|#if 0
id|btv-&gt;win.cropwidth
op_assign
l_int|768
suffix:semicolon
multiline_comment|/* 640 */
id|btv-&gt;win.cropheight
op_assign
l_int|576
suffix:semicolon
multiline_comment|/* 480 */
id|btv-&gt;win.cropx
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.cropy
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|pb-&gt;win.pad
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;win.bpp
op_assign
l_int|4
suffix:semicolon
id|pb-&gt;win.depth
op_assign
l_int|32
suffix:semicolon
id|pb-&gt;win.color_fmt
op_assign
id|PLANB_COLOUR32
suffix:semicolon
id|pb-&gt;win.bpl
op_assign
l_int|1024
op_star
id|pb-&gt;win.bpp
suffix:semicolon
id|pb-&gt;win.swidth
op_assign
l_int|1024
suffix:semicolon
id|pb-&gt;win.sheight
op_assign
l_int|768
suffix:semicolon
macro_line|#ifdef PLANB_GSCANLINE
r_if
c_cond
(paren
(paren
id|pb-&gt;gbytes_per_line
op_assign
id|PLANB_MAXPIXELS
op_star
l_int|4
)paren
OG
id|PAGE_SIZE
op_logical_or
(paren
id|pb-&gt;gbytes_per_line
op_le
l_int|0
)paren
)paren
(brace
r_return
op_minus
l_int|3
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* page align pb-&gt;gbytes_per_line for DMA purpose */
r_for
c_loop
(paren
id|i
op_assign
id|PAGE_SIZE
suffix:semicolon
id|pb-&gt;gbytes_per_line
OL
(paren
id|i
op_rshift
l_int|1
)paren
suffix:semicolon
)paren
(brace
id|i
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|pb-&gt;gbytes_per_line
op_assign
id|i
suffix:semicolon
)brace
macro_line|#endif
id|pb-&gt;tab_size
op_assign
id|PLANB_MAXLINES
op_plus
l_int|40
suffix:semicolon
id|pb-&gt;suspend
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|pb-&gt;lockq
)paren
suffix:semicolon
id|pb-&gt;ch1_cmd
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;ch2_cmd
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;mask
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;priv_space
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;user
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;overlay
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|pb-&gt;suspendq
)paren
suffix:semicolon
id|pb-&gt;cmd_buff_inited
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;frame_buffer_phys
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset DMA controllers */
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
id|saa_rev
op_assign
(paren
id|saa_status
c_func
(paren
l_int|0
comma
id|pb
)paren
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PlanB: SAA7196 video processor rev. %d&bslash;n&quot;
comma
id|saa_rev
)paren
suffix:semicolon
multiline_comment|/* Initialize the SAA registers in memory and on chip */
id|saa_init_regs
(paren
id|pb
)paren
suffix:semicolon
multiline_comment|/* clear interrupt mask */
id|pb-&gt;intr_mask
op_assign
id|PLANB_CLR_IRQ
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|result
op_assign
id|request_irq
c_func
(paren
id|pb-&gt;irq
comma
id|planb_irq
comma
l_int|0
comma
l_string|&quot;PlanB&quot;
comma
(paren
r_void
op_star
)paren
id|pb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EINVAL
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PlanB: Bad irq number (%d) &quot;
l_string|&quot;or handler&bslash;n&quot;
comma
(paren
r_int
)paren
id|pb-&gt;irq
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EBUSY
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PlanB: I don&squot;t know why, &quot;
l_string|&quot;but IRQ %d is busy&bslash;n&quot;
comma
(paren
r_int
)paren
id|pb-&gt;irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|disable_irq
c_func
(paren
id|pb-&gt;irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Now add the template and register the device unit. */
id|memcpy
c_func
(paren
op_amp
id|pb-&gt;video_dev
comma
op_amp
id|planb_template
comma
r_sizeof
(paren
id|planb_template
)paren
)paren
suffix:semicolon
id|pb-&gt;picture.brightness
op_assign
l_int|0x90
op_lshift
l_int|8
suffix:semicolon
id|pb-&gt;picture.contrast
op_assign
l_int|0x70
op_lshift
l_int|8
suffix:semicolon
id|pb-&gt;picture.colour
op_assign
l_int|0x70
op_lshift
l_int|8
suffix:semicolon
id|pb-&gt;picture.hue
op_assign
l_int|0x8000
suffix:semicolon
id|pb-&gt;picture.whiteness
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;picture.depth
op_assign
id|pb-&gt;win.depth
suffix:semicolon
id|pb-&gt;frame_stat
op_assign
l_int|NULL
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|pb-&gt;capq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pb-&gt;gbuf_idx
(braket
id|i
)braket
op_assign
id|PLANB_MAX_FBUF
op_star
id|i
op_div
id|PAGE_SIZE
suffix:semicolon
id|pb-&gt;gwidth
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;gheight
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;gfmt
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;cap_cmd
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifndef PLANB_GSCANLINE
id|pb-&gt;l_fr_addr_idx
(braket
id|i
)braket
op_assign
id|MAX_GBUFFERS
op_star
(paren
id|PLANB_MAX_FBUF
op_div
id|PAGE_SIZE
op_plus
l_int|1
)paren
op_plus
id|MAX_LNUM
op_star
id|i
suffix:semicolon
id|pb-&gt;lsize
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pb-&gt;lnum
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|pb-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|pb-&gt;grabbing
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* enable interrupts */
id|out_le32
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;intr_stat
comma
id|PLANB_CLR_IRQ
)paren
suffix:semicolon
id|pb-&gt;intr_mask
op_assign
id|PLANB_FRM_IRQ
suffix:semicolon
id|enable_irq
c_func
(paren
id|pb-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|pb-&gt;video_dev
comma
id|VFL_TYPE_GRABBER
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Scan for a PlanB controller, request the irq and map the io memory &n; */
DECL|function|find_planb
r_static
r_int
id|find_planb
c_func
(paren
r_void
)paren
(brace
r_struct
id|planb
op_star
id|pb
suffix:semicolon
r_struct
id|device_node
op_star
id|planb_devices
suffix:semicolon
r_int
r_char
id|dev_fn
comma
id|confreg
comma
id|bus
suffix:semicolon
r_int
r_int
id|old_base
comma
id|new_base
suffix:semicolon
r_int
r_int
id|irq
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_ne
id|_MACH_Pmac
)paren
r_return
l_int|0
suffix:semicolon
id|planb_devices
op_assign
id|find_devices
c_func
(paren
l_string|&quot;planb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|planb_devices
op_eq
l_int|0
)paren
(brace
id|planb_num
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PlanB: no device found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|planb_num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|planb_devices-&gt;next
op_ne
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Warning: only using first PlanB device!&bslash;n&quot;
)paren
suffix:semicolon
id|pb
op_assign
op_amp
id|planbs
(braket
l_int|0
)braket
suffix:semicolon
id|planb_num
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|planb_devices-&gt;n_addrs
op_ne
l_int|1
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;PlanB: expecting 1 address for planb &quot;
l_string|&quot;(got %d)&quot;
comma
id|planb_devices-&gt;n_addrs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|planb_devices-&gt;n_intrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PlanB: no intrs for device %s&bslash;n&quot;
comma
id|planb_devices-&gt;full_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|irq
op_assign
id|planb_devices-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
)brace
multiline_comment|/* Initialize PlanB&squot;s PCI registers */
multiline_comment|/* There is a bug with the way OF assigns addresses&n;&t;   to the devices behind the chaos bridge.&n;&t;   control needs only 0x1000 of space, but decodes only&n;&t;   the upper 16 bits. It therefore occupies a full 64K.&n;&t;   OF assigns the planb controller memory within this space;&n;&t;   so we need to change that here in order to access planb. */
multiline_comment|/* We remap to 0xf1000000 in hope that nobody uses it ! */
id|bus
op_assign
(paren
id|planb_devices-&gt;addrs
(braket
l_int|0
)braket
dot
id|space
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev_fn
op_assign
(paren
id|planb_devices-&gt;addrs
(braket
l_int|0
)braket
dot
id|space
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|confreg
op_assign
id|planb_devices-&gt;addrs
(braket
l_int|0
)braket
dot
id|space
op_amp
l_int|0xff
suffix:semicolon
id|old_base
op_assign
id|planb_devices-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|new_base
op_assign
l_int|0xf1000000
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;PlanB: Found on bus %d, dev %d, func %d, &quot;
l_string|&quot;membase 0x%x (base reg. 0x%x)&bslash;n&quot;
comma
id|bus
comma
id|PCI_SLOT
c_func
(paren
id|dev_fn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev_fn
)paren
comma
id|old_base
comma
id|confreg
)paren
suffix:semicolon
id|pdev
op_assign
id|pci_find_slot
(paren
id|bus
comma
id|dev_fn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot find slot&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX handle error */
)brace
multiline_comment|/* Enable response in memory space, bus mastering,&n;&t;   use memory write and invalidate */
id|pci_write_config_word
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
)paren
suffix:semicolon
multiline_comment|/* Set PCI Cache line size &amp; latency timer */
id|pci_write_config_byte
(paren
id|pdev
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|0x8
)paren
suffix:semicolon
id|pci_write_config_byte
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Set the new base address */
id|pci_write_config_dword
(paren
id|pdev
comma
id|confreg
comma
id|new_base
)paren
suffix:semicolon
id|planb_regs
op_assign
(paren
r_volatile
r_struct
id|planb_registers
op_star
)paren
id|ioremap
(paren
id|new_base
comma
l_int|0x400
)paren
suffix:semicolon
id|pb-&gt;planb_base
op_assign
id|planb_regs
suffix:semicolon
id|pb-&gt;planb_base_phys
op_assign
(paren
r_struct
id|planb_registers
op_star
)paren
id|new_base
suffix:semicolon
id|pb-&gt;irq
op_assign
id|irq
suffix:semicolon
r_return
id|planb_num
suffix:semicolon
)brace
DECL|function|release_planb
r_static
r_void
id|release_planb
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|planb
op_star
id|pb
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|planb_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pb
op_assign
op_amp
id|planbs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* stop and flash DMAs unconditionally */
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch2
)paren
suffix:semicolon
id|planb_dbdma_stop
c_func
(paren
op_amp
id|pb-&gt;planb_base-&gt;ch1
)paren
suffix:semicolon
multiline_comment|/* clear and free interrupts */
id|pb-&gt;intr_mask
op_assign
id|PLANB_CLR_IRQ
suffix:semicolon
id|out_le32
(paren
op_amp
id|pb-&gt;planb_base-&gt;intr_stat
comma
id|PLANB_CLR_IRQ
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|pb-&gt;irq
comma
id|pb
)paren
suffix:semicolon
multiline_comment|/* make sure all allocated memory are freed */
id|planb_prepare_close
c_func
(paren
id|pb
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PlanB: unregistering with v4l&bslash;n&quot;
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|pb-&gt;video_dev
)paren
suffix:semicolon
multiline_comment|/* note that iounmap() does nothing on the PPC right now */
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|pb-&gt;planb_base
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#else
r_int
id|__init
id|init_planbs
c_func
(paren
r_struct
id|video_init
op_star
id|unused
)paren
(brace
macro_line|#endif
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|find_planb
c_func
(paren
)paren
op_le
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|planb_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|init_planb
c_func
(paren
op_amp
id|planbs
(braket
id|i
)braket
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PlanB: error registering device %d&quot;
l_string|&quot; with v4l&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|release_planb
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PlanB: registered device %d with v4l&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|release_planb
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
