multiline_comment|/*&n; * for the TEA6420 chip (only found on 3DFX (STB) TV/FM cards to the best&n; * of my knowledge)&n; * Copyright (C) 2000 Dave Stuart &lt;justdave@ynn.com&gt;&n; * This code is placed under the terms of the GNU General Public License&n; * Code liberally copied from tea6300 by . . .&n; *&n; * Copyright (c) 1998 Greg Alexander &lt;galexand@acm.org&gt;&n; * This code is placed under the terms of the GNU General Public License&n; * Code liberally copied from msp3400.c, which is by Gerd Knorr&n; *&n; * Changes:&n; * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt; - 08/14/2000&n; * - resource allocation fixes in tea6300_attach&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &quot;bttv.h&quot;
macro_line|#include &quot;audiochip.h&quot;
multiline_comment|/* Addresses to scan */
DECL|macro|I2C_TEA6420
mdefine_line|#define I2C_TEA6420&t;0x98
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_TEA6420
op_rshift
l_int|1
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe
r_static
r_int
r_int
id|probe
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe_range
r_static
r_int
r_int
id|probe_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore
r_static
r_int
r_int
id|ignore
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore_range
r_static
r_int
r_int
id|ignore_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|force
r_static
r_int
r_int
id|force
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|addr_data
r_static
r_struct
id|i2c_client_address_data
id|addr_data
op_assign
(brace
id|normal_i2c
comma
id|normal_i2c_range
comma
id|probe
comma
id|probe_range
comma
id|ignore
comma
id|ignore_range
comma
id|force
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|macro|dprintk
mdefine_line|#define dprintk  if (debug) printk
DECL|struct|tea6420
r_struct
id|tea6420
(brace
DECL|member|mode
r_int
id|mode
suffix:semicolon
multiline_comment|/* set to AUDIO_{OFF,TUNER,RADIO,EXTERN} */
DECL|member|stereo
r_int
id|stereo
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
DECL|macro|TEA6420_S_SA
mdefine_line|#define TEA6420_S_SA       0x00  /* stereo A input */
DECL|macro|TEA6420_S_SB
mdefine_line|#define TEA6420_S_SB       0x01  /* stereo B */
DECL|macro|TEA6420_S_SC
mdefine_line|#define TEA6420_S_SC       0x02  /* stereo C */
DECL|macro|TEA6420_S_SD
mdefine_line|#define TEA6420_S_SD       0x03  /* stereo D */
DECL|macro|TEA6420_S_SE
mdefine_line|#define TEA6420_S_SE       0x04  /* stereo E */
DECL|macro|TEA6420_S_GMU
mdefine_line|#define TEA6420_S_GMU      0x05  /* general mute */
multiline_comment|/* ******************************** *&n; * functions for talking to TEA6420 *&n; * ******************************** */
DECL|function|tea6420_write
r_static
r_int
id|tea6420_write
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|val
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|result
suffix:semicolon
multiline_comment|/*&t;buffer[0] = addr; */
id|buffer
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
id|result
op_assign
id|i2c_master_send
c_func
(paren
id|client
comma
id|buffer
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_ne
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
"&quot;"
id|tea6420
suffix:colon
id|I
op_div
id|O
id|error
comma
id|trying
(paren
id|write
l_int|0
id|x
op_mod
id|x
)paren
id|result
op_assign
op_mod
id|d
"&bslash;"
id|n
"&quot;"
comma
id|val
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_tea6420_init
r_static
r_void
id|do_tea6420_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tea6420
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
id|tea-&gt;mode
op_assign
id|AUDIO_OFF
suffix:semicolon
id|tea-&gt;stereo
op_assign
l_int|1
suffix:semicolon
id|tea6420_write
c_func
(paren
id|client
comma
id|TEA6420_S_GMU
)paren
suffix:semicolon
multiline_comment|/* mute */
)brace
DECL|function|tea6420_audio
r_static
r_void
id|tea6420_audio
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|mode
)paren
(brace
r_struct
id|tea6420
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
multiline_comment|/* valid for AUDIO_TUNER, RADIO, EXTERN, OFF */
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tea6420_audio:%d (T,R,E,I,O)&bslash;n&quot;
comma
id|mode
)paren
suffix:semicolon
id|tea-&gt;mode
op_assign
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|AUDIO_OFF
)paren
(brace
multiline_comment|/* just mute it */
id|tea6420_write
c_func
(paren
id|client
comma
id|TEA6420_S_GMU
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|AUDIO_TUNER
suffix:colon
id|tea6420_write
c_func
(paren
id|client
comma
id|TEA6420_S_SA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_RADIO
suffix:colon
id|tea6420_write
c_func
(paren
id|client
comma
id|TEA6420_S_SB
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_EXTERN
suffix:colon
id|tea6420_write
c_func
(paren
id|client
comma
id|TEA6420_S_SC
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* *********************** *&n; * i2c interface functions *&n; * *********************** */
DECL|function|tea6420_attach
r_static
r_int
id|tea6420_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
r_int
id|flags
comma
r_int
id|kind
)paren
(brace
r_struct
id|tea6420
op_star
id|tea
suffix:semicolon
r_struct
id|i2c_client
op_star
id|client
suffix:semicolon
id|client
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|client
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|client
comma
op_amp
id|client_template
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|client-&gt;adapter
op_assign
id|adap
suffix:semicolon
id|client-&gt;addr
op_assign
id|addr
suffix:semicolon
id|client-&gt;data
op_assign
id|tea
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|tea
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tea
)paren
(brace
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tea
comma
l_int|0
comma
r_sizeof
op_star
id|tea
)paren
suffix:semicolon
id|do_tea6420_init
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|strcpy
c_func
(paren
id|client-&gt;name
comma
l_string|&quot;TEA6420&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tea6420: initialized&bslash;n&quot;
)paren
suffix:semicolon
id|i2c_attach_client
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tea6420_probe
r_static
r_int
id|tea6420_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_if
c_cond
(paren
id|adap-&gt;id
op_eq
(paren
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_BT848
)paren
)paren
r_return
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|tea6420_attach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tea6420_detach
r_static
r_int
id|tea6420_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tea6420
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
id|do_tea6420_init
c_func
(paren
id|client
)paren
suffix:semicolon
id|i2c_detach_client
c_func
(paren
id|client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tea
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tea6420_command
id|tea6420_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
id|__u16
op_star
id|sarg
op_assign
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AUDC_SET_RADIO
suffix:colon
id|tea6420_audio
c_func
(paren
id|client
comma
id|AUDIO_RADIO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_INPUT
suffix:colon
id|tea6420_audio
c_func
(paren
id|client
comma
op_star
id|sarg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* --- v4l ioctls --- */
multiline_comment|/* take care: bttv does userspace copying, we&squot;ll get a&n;&t;   kernel pointer here... */
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
id|va-&gt;flags
op_or_assign
id|VIDEO_AUDIO_VOLUME
op_or
id|VIDEO_AUDIO_BASS
op_or
id|VIDEO_AUDIO_TREBLE
suffix:semicolon
multiline_comment|/*&t;&t;va-&gt;volume=MAX(tea-&gt;left,tea-&gt;right);&n;&t;&t;va-&gt;balance=(32768*MIN(tea-&gt;left,tea-&gt;right))/&n;&t;&t;&t;(va-&gt;volume ? va-&gt;volume : 1);&n;&t;&t;va-&gt;balance=(tea-&gt;left&lt;tea-&gt;right)?&n;&t;&t;&t;(65535-va-&gt;balance) : va-&gt;balance;&n;&t;&t;va-&gt;bass = tea-&gt;bass;&n;&t;&t;va-&gt;treble = tea-&gt;treble;&n;*/
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
multiline_comment|/*&t;&t;tea-&gt;left = (MIN(65536 - va-&gt;balance,32768) *&n;&t;&t;&t;     va-&gt;volume) / 32768;&n;&t;&t;tea-&gt;right = (MIN(va-&gt;balance,32768) *&n;&t;&t;&t;      va-&gt;volume) / 32768;&n;&t;&t;tea-&gt;bass = va-&gt;bass;&n;&t;&t;tea-&gt;treble = va-&gt;treble;&n;&t;&t;tea6420_set(client);&n;*/
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* nothing */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
l_string|&quot;i2c tea6420 driver&quot;
comma
id|I2C_DRIVERID_TEA6420
comma
id|I2C_DF_NOTIFY
comma
id|tea6420_probe
comma
id|tea6420_detach
comma
id|tea6420_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
l_string|&quot;(unset)&quot;
comma
multiline_comment|/* name */
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|driver
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|tea6420_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
