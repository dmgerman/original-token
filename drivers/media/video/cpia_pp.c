multiline_comment|/*&n; * cpia_pp CPiA Parallel Port driver&n; *&n; * Supports CPiA based parallel port Video Camera&squot;s.&n; *&n; * (C) Copyright 1999 Bas Huisman &lt;bhuism@cs.utwente.nl&gt;&n; * (C) Copyright 1999-2000 Scott J. Bertin &lt;sbertin@mindspring.com&gt;,&n; * (C) Copyright 1999-2000 Peter Pregler &lt;Peter_Pregler@email.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/parport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#ifdef CONFIG_KMOD
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#endif
multiline_comment|/* #define _CPIA_DEBUG_&t;&t;define for verbose debug output */
macro_line|#include &quot;cpia.h&quot;
r_static
r_int
id|cpia_pp_open
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_registerCallback
c_func
(paren
r_void
op_star
id|privdata
comma
r_void
(paren
op_star
id|cb
)paren
(paren
r_void
op_star
id|cbdata
)paren
comma
r_void
op_star
id|cbdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_transferCmd
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|command
comma
id|u8
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_streamStart
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_streamStop
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_streamRead
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|buffer
comma
r_int
id|noblock
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_close
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
DECL|macro|ABOUT
mdefine_line|#define ABOUT &quot;Parallel port driver for Vision CPiA based cameras&quot;
multiline_comment|/* IEEE 1284 Compatiblity Mode signal names &t;*/
DECL|macro|nStrobe
mdefine_line|#define nStrobe&t;&t;PARPORT_CONTROL_STROBE&t;  /* inverted */
DECL|macro|nAutoFd
mdefine_line|#define nAutoFd&t;&t;PARPORT_CONTROL_AUTOFD&t;  /* inverted */
DECL|macro|nInit
mdefine_line|#define nInit&t;&t;PARPORT_CONTROL_INIT
DECL|macro|nSelectIn
mdefine_line|#define nSelectIn&t;PARPORT_CONTROL_SELECT
DECL|macro|IntrEnable
mdefine_line|#define IntrEnable&t;PARPORT_CONTROL_INTEN&t;  /* normally zero for no IRQ */
DECL|macro|DirBit
mdefine_line|#define DirBit&t;&t;PARPORT_CONTROL_DIRECTION /* 0 = Forward, 1 = Reverse&t;*/
DECL|macro|nFault
mdefine_line|#define nFault&t;&t;PARPORT_STATUS_ERROR
DECL|macro|Select
mdefine_line|#define Select&t;&t;PARPORT_STATUS_SELECT
DECL|macro|PError
mdefine_line|#define PError&t;&t;PARPORT_STATUS_PAPEROUT
DECL|macro|nAck
mdefine_line|#define nAck&t;&t;PARPORT_STATUS_ACK
DECL|macro|Busy
mdefine_line|#define Busy&t;&t;PARPORT_STATUS_BUSY&t;  /* inverted */&t;
multiline_comment|/* some more */
DECL|macro|HostClk
mdefine_line|#define HostClk&t;&t;nStrobe
DECL|macro|HostAck
mdefine_line|#define HostAck&t;&t;nAutoFd
DECL|macro|nReverseRequest
mdefine_line|#define nReverseRequest&t;nInit
DECL|macro|Active_1284
mdefine_line|#define Active_1284&t;nSelectIn
DECL|macro|nPeriphRequest
mdefine_line|#define nPeriphRequest&t;nFault
DECL|macro|XFlag
mdefine_line|#define XFlag&t;&t;Select
DECL|macro|nAckReverse
mdefine_line|#define nAckReverse&t;PError
DECL|macro|PeriphClk
mdefine_line|#define PeriphClk&t;nAck
DECL|macro|PeriphAck
mdefine_line|#define PeriphAck&t;Busy
multiline_comment|/* these can be used to correct for the inversion on some bits */
DECL|macro|STATUS_INVERSION_MASK
mdefine_line|#define STATUS_INVERSION_MASK&t;(Busy)
DECL|macro|CONTROL_INVERSION_MASK
mdefine_line|#define CONTROL_INVERSION_MASK&t;(nStrobe|nAutoFd|nSelectIn)
DECL|macro|ECR_empty
mdefine_line|#define ECR_empty&t;0x01
DECL|macro|ECR_full
mdefine_line|#define ECR_full&t;0x02
DECL|macro|ECR_serviceIntr
mdefine_line|#define ECR_serviceIntr 0x04
DECL|macro|ECR_dmaEn
mdefine_line|#define ECR_dmaEn&t;0x08
DECL|macro|ECR_nErrIntrEn
mdefine_line|#define ECR_nErrIntrEn&t;0x10
DECL|macro|ECR_mode_mask
mdefine_line|#define ECR_mode_mask&t;0xE0
DECL|macro|ECR_SPP_mode
mdefine_line|#define ECR_SPP_mode&t;0x00
DECL|macro|ECR_PS2_mode
mdefine_line|#define ECR_PS2_mode&t;0x20
DECL|macro|ECR_FIFO_mode
mdefine_line|#define ECR_FIFO_mode&t;0x40
DECL|macro|ECR_ECP_mode
mdefine_line|#define ECR_ECP_mode&t;0x60
DECL|macro|ECP_FIFO_SIZE
mdefine_line|#define ECP_FIFO_SIZE&t;16
DECL|macro|DMA_BUFFER_SIZE
mdefine_line|#define DMA_BUFFER_SIZE               PAGE_SIZE
multiline_comment|/* for 16bit DMA make sure DMA_BUFFER_SIZE is 16 bit aligned */
DECL|macro|PARPORT_CHUNK_SIZE
mdefine_line|#define PARPORT_CHUNK_SIZE&t;PAGE_SIZE/* &gt;=2.3.x */
multiline_comment|/* we read this many bytes at once */
DECL|macro|GetECRMasked
mdefine_line|#define GetECRMasked(port,mask)&t;(parport_read_econtrol(port) &amp; (mask))
DECL|macro|GetStatus
mdefine_line|#define GetStatus(port)&t;&t;((parport_read_status(port)^STATUS_INVERSION_MASK)&amp;(0xf8))
DECL|macro|SetStatus
mdefine_line|#define SetStatus(port,val)&t;parport_write_status(port,(val)^STATUS_INVERSION_MASK)
DECL|macro|GetControl
mdefine_line|#define GetControl(port)&t;((parport_read_control(port)^CONTROL_INVERSION_MASK)&amp;(0x3f))
DECL|macro|SetControl
mdefine_line|#define SetControl(port,val)&t;parport_write_control(port,(val)^CONTROL_INVERSION_MASK)
DECL|macro|GetStatusMasked
mdefine_line|#define GetStatusMasked(port,mask)&t;(GetStatus(port) &amp; (mask))
DECL|macro|GetControlMasked
mdefine_line|#define GetControlMasked(port,mask)&t;(GetControl(port) &amp; (mask))
DECL|macro|SetControlMasked
mdefine_line|#define SetControlMasked(port,mask)&t;SetControl(port,GetControl(port) | (mask));
DECL|macro|ClearControlMasked
mdefine_line|#define ClearControlMasked(port,mask)&t;SetControl(port,GetControl(port)&amp;~(mask));
DECL|macro|FrobControlBit
mdefine_line|#define FrobControlBit(port,mask,value)&t;SetControl(port,(GetControl(port)&amp;~(mask))|((value)&amp;(mask)));
DECL|macro|PACKET_LENGTH
mdefine_line|#define PACKET_LENGTH &t;8
multiline_comment|/* Magic numbers for defining port-device mappings */
DECL|macro|PPCPIA_PARPORT_UNSPEC
mdefine_line|#define PPCPIA_PARPORT_UNSPEC -4
DECL|macro|PPCPIA_PARPORT_AUTO
mdefine_line|#define PPCPIA_PARPORT_AUTO -3
DECL|macro|PPCPIA_PARPORT_OFF
mdefine_line|#define PPCPIA_PARPORT_OFF -2
DECL|macro|PPCPIA_PARPORT_NONE
mdefine_line|#define PPCPIA_PARPORT_NONE -1
macro_line|#ifdef MODULE
DECL|variable|parport_nr
r_static
r_int
id|parport_nr
(braket
id|PARPORT_MAX
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|PARPORT_MAX
op_minus
l_int|1
)braket
op_assign
id|PPCPIA_PARPORT_UNSPEC
)brace
suffix:semicolon
DECL|variable|parport
r_static
r_char
op_star
id|parport
(braket
id|PARPORT_MAX
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;B. Huisman &lt;bhuism@cs.utwente.nl&gt; &amp; Peter Pregler &lt;Peter_Pregler@email.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Parallel port driver for Vision CPiA based cameras&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|parport
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|PARPORT_MAX
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|parport
comma
l_string|&quot;&squot;auto&squot; or a list of parallel port numbers. Just like lp.&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|variable|__initdata
r_static
r_int
id|parport_nr
(braket
id|PARPORT_MAX
)braket
id|__initdata
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|PARPORT_MAX
op_minus
l_int|1
)braket
op_assign
id|PPCPIA_PARPORT_UNSPEC
)brace
suffix:semicolon
DECL|variable|parport_ptr
r_static
r_int
id|parport_ptr
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|struct|pp_cam_entry
r_struct
id|pp_cam_entry
(brace
DECL|member|pdev
r_struct
id|pardevice
op_star
id|pdev
suffix:semicolon
DECL|member|port
r_struct
id|parport
op_star
id|port
suffix:semicolon
DECL|member|cb_task
r_struct
id|tq_struct
id|cb_task
suffix:semicolon
DECL|member|open_count
r_int
id|open_count
suffix:semicolon
DECL|member|wq_stream
id|wait_queue_head_t
id|wq_stream
suffix:semicolon
multiline_comment|/* image state flags */
DECL|member|image_ready
r_int
id|image_ready
suffix:semicolon
multiline_comment|/* we got an interrupt */
DECL|member|image_complete
r_int
id|image_complete
suffix:semicolon
multiline_comment|/* we have seen 4 EOI */
DECL|member|streaming
r_int
id|streaming
suffix:semicolon
multiline_comment|/* we are in streaming mode */
DECL|member|stream_irq
r_int
id|stream_irq
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cpia_pp_ops
r_static
r_struct
id|cpia_camera_ops
id|cpia_pp_ops
op_assign
(brace
id|cpia_pp_open
comma
id|cpia_pp_registerCallback
comma
id|cpia_pp_transferCmd
comma
id|cpia_pp_streamStart
comma
id|cpia_pp_streamStop
comma
id|cpia_pp_streamRead
comma
id|cpia_pp_close
comma
l_int|1
)brace
suffix:semicolon
DECL|variable|cam_list
r_static
r_struct
id|cam_data
op_star
id|cam_list
suffix:semicolon
macro_line|#ifdef _CPIA_DEBUG_
DECL|macro|DEB_PORT
mdefine_line|#define DEB_PORT(port) { &bslash;&n;u8 controll = GetControl(port); &bslash;&n;u8 statusss = GetStatus(port); &bslash;&n;DBG(&quot;nsel %c per %c naut %c nstrob %c nak %c busy %c nfaul %c sel %c init %c dir %c&bslash;n&quot;,&bslash;&n;((controll &amp; nSelectIn)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((statusss &amp; PError)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((controll &amp; nAutoFd)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((controll &amp; nStrobe)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((statusss &amp; nAck)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((statusss &amp; Busy)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((statusss &amp; nFault)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((statusss &amp; Select)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((controll &amp; nInit)&t;? &squot;U&squot; : &squot;D&squot;), &bslash;&n;((controll &amp; DirBit)&t;? &squot;R&squot; : &squot;F&squot;)  &bslash;&n;); }
macro_line|#else
DECL|macro|DEB_PORT
mdefine_line|#define DEB_PORT(port) {}
macro_line|#endif
DECL|macro|WHILE_OUT_TIMEOUT
mdefine_line|#define WHILE_OUT_TIMEOUT (HZ/10)
DECL|macro|DMA_TIMEOUT
mdefine_line|#define DMA_TIMEOUT 10*HZ
multiline_comment|/* FIXME */
DECL|function|cpia_parport_enable_irq
r_static
r_void
id|cpia_parport_enable_irq
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
id|parport_enable_irq
c_func
(paren
id|port
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cpia_parport_disable_irq
r_static
r_void
id|cpia_parport_disable_irq
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
id|parport_disable_irq
c_func
(paren
id|port
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  EndTransferMode&n; *&n; ***************************************************************************/
DECL|function|EndTransferMode
r_static
r_void
id|EndTransferMode
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
)paren
(brace
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|IEEE1284_MODE_COMPAT
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  ForwardSetup&n; *&n; ***************************************************************************/
DECL|function|ForwardSetup
r_static
r_int
id|ForwardSetup
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
)paren
(brace
r_int
id|retry
suffix:semicolon
multiline_comment|/* After some commands the camera needs extra time before&n;&t; * it will respond again, so we try up to 3 times */
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|3
suffix:semicolon
op_increment
id|retry
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|IEEE1284_MODE_ECP
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|retry
op_eq
l_int|3
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Unable to negotiate ECP mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  ReverseSetup&n; *&n; ***************************************************************************/
DECL|function|ReverseSetup
r_static
r_int
id|ReverseSetup
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
comma
r_int
id|extensibility
)paren
(brace
r_int
id|retry
suffix:semicolon
r_int
id|mode
op_assign
id|IEEE1284_MODE_ECP
suffix:semicolon
r_if
c_cond
(paren
id|extensibility
)paren
(brace
id|mode
op_assign
l_int|8
op_or
l_int|3
op_or
id|IEEE1284_EXT_LINK
suffix:semicolon
)brace
multiline_comment|/* After some commands the camera needs extra time before&n;&t; * it will respond again, so we try up to 3 times */
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|3
suffix:semicolon
op_increment
id|retry
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|mode
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|retry
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|extensibility
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Unable to negotiate extensibility mode&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|DBG
c_func
(paren
l_string|&quot;Unable to negotiate ECP mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|extensibility
)paren
(brace
id|cam-&gt;port-&gt;ieee1284.mode
op_assign
id|IEEE1284_MODE_ECP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  WritePacket&n; *&n; ***************************************************************************/
DECL|function|WritePacket
r_static
r_int
id|WritePacket
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
comma
r_const
id|u8
op_star
id|packet
comma
r_int
id|size
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|size_written
suffix:semicolon
r_if
c_cond
(paren
id|packet
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ForwardSetup
c_func
(paren
id|cam
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Write failed in setup&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|size_written
op_assign
id|parport_write
c_func
(paren
id|cam-&gt;port
comma
id|packet
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_written
op_ne
id|size
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Write failed, wrote %d/%d&bslash;n&quot;
comma
id|size_written
comma
id|size
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|EndTransferMode
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  ReadPacket&n; *&n; ***************************************************************************/
DECL|function|ReadPacket
r_static
r_int
id|ReadPacket
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
comma
id|u8
op_star
id|packet
comma
r_int
id|size
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|packet
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ReverseSetup
c_func
(paren
id|cam
comma
l_int|0
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|parport_read
c_func
(paren
id|cam-&gt;port
comma
id|packet
comma
id|size
)paren
op_ne
id|size
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|EndTransferMode
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_streamStart&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_streamStart
r_static
r_int
id|cpia_pp_streamStart
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|cam-&gt;streaming
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;image_ready
op_assign
l_int|0
suffix:semicolon
singleline_comment|//if (ReverseSetup(cam,1)) return -EIO;
r_if
c_cond
(paren
id|cam-&gt;stream_irq
)paren
(brace
id|cpia_parport_enable_irq
c_func
(paren
id|cam-&gt;port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_streamStop&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_streamStop
r_static
r_int
id|cpia_pp_streamStop
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|cam-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|cpia_parport_disable_irq
c_func
(paren
id|cam-&gt;port
)paren
suffix:semicolon
singleline_comment|//EndTransferMode(cam);
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_pp_read
r_static
r_int
id|cpia_pp_read
c_func
(paren
r_struct
id|parport
op_star
id|port
comma
id|u8
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_int
id|bytes_read
comma
id|new_bytes
suffix:semicolon
r_for
c_loop
(paren
id|bytes_read
op_assign
l_int|0
suffix:semicolon
id|bytes_read
OL
id|len
suffix:semicolon
id|bytes_read
op_add_assign
id|new_bytes
)paren
(brace
id|new_bytes
op_assign
id|parport_read
c_func
(paren
id|port
comma
id|buffer
op_plus
id|bytes_read
comma
id|len
op_minus
id|bytes_read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_bytes
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|bytes_read
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_streamRead&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_streamRead
r_static
r_int
id|cpia_pp_streamRead
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|buffer
comma
r_int
id|noblock
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_int
id|read_bytes
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|endseen
comma
id|block_size
comma
id|new_bytes
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: cam is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: buffer is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|//if(cam-&gt;streaming) DBG(&quot;%d / %d&bslash;n&quot;, cam-&gt;image_ready, noblock);
r_if
c_cond
(paren
id|cam-&gt;stream_irq
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|cam-&gt;image_ready
)paren
suffix:semicolon
id|cam-&gt;image_ready
op_decrement
suffix:semicolon
)brace
id|cam-&gt;image_complete
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|0
multiline_comment|/*cam-&gt;streaming*/
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;image_ready
)paren
(brace
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|cam-&gt;wq_stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|cam-&gt;image_ready
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ReverseSetup
c_func
(paren
id|cam
comma
l_int|1
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;unable to ReverseSetup&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|endseen
op_assign
l_int|0
suffix:semicolon
id|block_size
op_assign
id|PARPORT_CHUNK_SIZE
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cam-&gt;image_complete
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|new_bytes
op_assign
id|cpia_pp_read
c_func
(paren
id|cam-&gt;port
comma
id|buffer
comma
id|block_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_bytes
op_le
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|i
OL
id|new_bytes
op_logical_and
id|endseen
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
op_star
id|buffer
op_eq
id|EOI
)paren
(brace
id|endseen
op_increment
suffix:semicolon
)brace
r_else
(brace
id|endseen
op_assign
l_int|0
suffix:semicolon
)brace
id|buffer
op_increment
suffix:semicolon
)brace
id|read_bytes
op_add_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|endseen
op_eq
l_int|4
)paren
(brace
id|cam-&gt;image_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CPIA_MAX_IMAGE_SIZE
op_minus
id|read_bytes
op_le
id|PARPORT_CHUNK_SIZE
)paren
(brace
id|block_size
op_assign
id|CPIA_MAX_IMAGE_SIZE
op_minus
id|read_bytes
suffix:semicolon
)brace
)brace
id|EndTransferMode
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|cam-&gt;image_complete
ques
c_cond
id|read_bytes
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_transferCmd&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_transferCmd
r_static
r_int
id|cpia_pp_transferCmd
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|command
comma
id|u8
op_star
id|data
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|databytes
suffix:semicolon
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: cam is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: command is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|databytes
op_assign
(paren
(paren
(paren
r_int
)paren
id|command
(braket
l_int|7
)braket
)paren
op_lshift
l_int|8
)paren
op_or
id|command
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|WritePacket
c_func
(paren
id|cam
comma
id|command
comma
id|PACKET_LENGTH
)paren
)paren
OL
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Error writing command&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
(braket
l_int|0
)braket
op_eq
id|DATA_IN
)paren
(brace
id|u8
id|buffer
(braket
l_int|8
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: data is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ReadPacket
c_func
(paren
id|cam
comma
id|buffer
comma
l_int|8
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Error reading command result&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|data
comma
id|buffer
comma
id|databytes
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|command
(braket
l_int|0
)braket
op_eq
id|DATA_OUT
)paren
(brace
r_if
c_cond
(paren
id|databytes
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: data is NULL&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|WritePacket
c_func
(paren
id|cam
comma
id|data
comma
id|databytes
)paren
)paren
OL
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Error writing command data&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
id|DBG
c_func
(paren
l_string|&quot;Unexpected first byte of command: %x&bslash;n&quot;
comma
id|command
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_open&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_open
r_static
r_int
id|cpia_pp_open
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
(paren
r_struct
id|pp_cam_entry
op_star
)paren
id|privdata
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;open_count
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|parport_claim
c_func
(paren
id|cam-&gt;pdev
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;failed to claim the port&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|IEEE1284_MODE_COMPAT
)paren
suffix:semicolon
id|parport_data_forward
c_func
(paren
id|cam-&gt;port
)paren
suffix:semicolon
id|parport_write_control
c_func
(paren
id|cam-&gt;port
comma
id|PARPORT_CONTROL_SELECT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|parport_write_control
c_func
(paren
id|cam-&gt;port
comma
id|PARPORT_CONTROL_SELECT
op_or
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
)brace
op_increment
id|cam-&gt;open_count
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_registerCallback&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_registerCallback
r_static
r_int
id|cpia_pp_registerCallback
c_func
(paren
r_void
op_star
id|privdata
comma
r_void
(paren
op_star
id|cb
)paren
(paren
r_void
op_star
id|cbdata
)paren
comma
r_void
op_star
id|cbdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;port-&gt;irq
op_ne
id|PARPORT_IRQ_NONE
)paren
(brace
id|cam-&gt;cb_task.routine
op_assign
id|cb
suffix:semicolon
id|cam-&gt;cb_task.data
op_assign
id|cbdata
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_close&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_close
r_static
r_int
id|cpia_pp_close
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|cam-&gt;open_count
op_eq
l_int|0
)paren
(brace
id|parport_release
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_register&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_register
r_static
r_int
id|cpia_pp_register
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_struct
id|pardevice
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pp_cam_entry
op_star
id|cam
suffix:semicolon
r_struct
id|cam_data
op_star
id|cpia
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;modes
op_amp
id|PARPORT_MODE_ECP
)paren
op_logical_and
op_logical_neg
(paren
id|port-&gt;modes
op_amp
id|PARPORT_MODE_TRISTATE
)paren
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;port is not ECP capable&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|cam
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pp_cam_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;failed to allocate camera structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cam
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pp_cam_entry
)paren
)paren
suffix:semicolon
id|pdev
op_assign
id|parport_register_device
c_func
(paren
id|port
comma
l_string|&quot;cpia_pp&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;failed to parport_register_device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|cam-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|cam-&gt;port
op_assign
id|port
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cam-&gt;wq_stream
)paren
suffix:semicolon
id|cam-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;stream_irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpia
op_assign
id|cpia_register_camera
c_func
(paren
op_amp
id|cpia_pp_ops
comma
id|cam
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;failed to cpia_register_camera&bslash;n&quot;
)paren
suffix:semicolon
id|parport_unregister_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|ADD_TO_LIST
c_func
(paren
id|cam_list
comma
id|cpia
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_pp_detach
r_static
r_void
id|cpia_pp_detach
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_struct
id|cam_data
op_star
id|cpia
suffix:semicolon
r_for
c_loop
(paren
id|cpia
op_assign
id|cam_list
suffix:semicolon
id|cpia
op_ne
l_int|NULL
suffix:semicolon
id|cpia
op_assign
id|cpia-&gt;next
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|cpia-&gt;lowlevel_data
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_logical_and
id|cam-&gt;port-&gt;number
op_eq
id|port-&gt;number
)paren
(brace
id|REMOVE_FROM_LIST
c_func
(paren
id|cpia
)paren
suffix:semicolon
id|cpia_unregister_camera
c_func
(paren
id|cpia
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;open_count
OG
l_int|0
)paren
(brace
id|cpia_pp_close
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
id|parport_unregister_device
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
id|cpia-&gt;lowlevel_data
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|cpia_pp_attach
r_static
r_void
id|cpia_pp_attach
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|parport_nr
(braket
l_int|0
)braket
)paren
(brace
r_case
id|PPCPIA_PARPORT_UNSPEC
suffix:colon
r_case
id|PPCPIA_PARPORT_AUTO
suffix:colon
r_if
c_cond
(paren
id|port-&gt;probe_info
(braket
l_int|0
)braket
dot
r_class
op_ne
id|PARPORT_CLASS_MEDIA
op_logical_or
id|port-&gt;probe_info
(braket
l_int|0
)braket
dot
id|cmdset
op_eq
l_int|NULL
op_logical_or
id|strncmp
c_func
(paren
id|port-&gt;probe_info
(braket
l_int|0
)braket
dot
id|cmdset
comma
l_string|&quot;CPIA_1&quot;
comma
l_int|6
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|cpia_pp_register
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PARPORT_MAX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;number
op_eq
id|parport_nr
(braket
id|i
)braket
)paren
(brace
id|cpia_pp_register
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|variable|cpia_pp_driver
r_static
r_struct
id|parport_driver
id|cpia_pp_driver
op_assign
(brace
l_string|&quot;cpia_pp&quot;
comma
id|cpia_pp_attach
comma
id|cpia_pp_detach
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|cpia_pp_init
r_int
id|cpia_pp_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s v%d.%d.%d&bslash;n&quot;
comma
id|ABOUT
comma
id|CPIA_PP_MAJ_VER
comma
id|CPIA_PP_MIN_VER
comma
id|CPIA_PP_PATCH_VER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_nr
(braket
l_int|0
)braket
op_eq
id|PPCPIA_PARPORT_OFF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|parport_register_driver
(paren
op_amp
id|cpia_pp_driver
)paren
)paren
(brace
id|LOG
(paren
l_string|&quot;unable to register with parport&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|parport
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* The user gave some parameters.  Let&squot;s see what they were. */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|parport
(braket
l_int|0
)braket
comma
l_string|&quot;auto&quot;
comma
l_int|4
)paren
)paren
(brace
id|parport_nr
(braket
l_int|0
)braket
op_assign
id|PPCPIA_PARPORT_AUTO
suffix:semicolon
)brace
r_else
(brace
r_int
id|n
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|PARPORT_MAX
op_logical_and
id|parport
(braket
id|n
)braket
suffix:semicolon
id|n
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|parport
(braket
id|n
)braket
comma
l_string|&quot;none&quot;
comma
l_int|4
)paren
)paren
(brace
id|parport_nr
(braket
id|n
)braket
op_assign
id|PPCPIA_PARPORT_NONE
suffix:semicolon
)brace
r_else
(brace
r_char
op_star
id|ep
suffix:semicolon
r_int
r_int
id|r
op_assign
id|simple_strtoul
c_func
(paren
id|parport
(braket
id|n
)braket
comma
op_amp
id|ep
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_ne
id|parport
(braket
id|n
)braket
)paren
(brace
id|parport_nr
(braket
id|n
)braket
op_assign
id|r
suffix:semicolon
)brace
r_else
(brace
id|LOG
c_func
(paren
l_string|&quot;bad port specifier `%s&squot;&bslash;n&quot;
comma
id|parport
(braket
id|n
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
macro_line|#if defined(CONFIG_KMOD) &amp;&amp; defined(CONFIG_PNP_PARPORT_MODULE)
r_if
c_cond
(paren
id|parport_enumerate
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|parport_enumerate
c_func
(paren
)paren
op_member_access_from_pointer
id|probe_info.model
)paren
(brace
id|request_module
c_func
(paren
l_string|&quot;parport_probe&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|cpia_pp_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|parport_unregister_driver
(paren
op_amp
id|cpia_pp_driver
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#else /* !MODULE */
DECL|function|cpia_pp_setup
r_static
r_int
id|__init
id|cpia_pp_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
macro_line|#if 0
multiline_comment|/* Is this only a 2.2ism? -jerdfelt */
r_if
c_cond
(paren
op_logical_neg
id|str
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_or
id|ints
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
(brace
multiline_comment|/* disable driver on &quot;cpia_pp=&quot; or &quot;cpia_pp=0&quot; */
id|parport_nr
(braket
l_int|0
)braket
op_assign
id|PPCPIA_PARPORT_OFF
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;parport&quot;
comma
l_int|7
)paren
)paren
(brace
r_int
id|n
op_assign
id|simple_strtoul
c_func
(paren
id|str
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_ptr
OL
id|PARPORT_MAX
)paren
(brace
id|parport_nr
(braket
id|parport_ptr
op_increment
)braket
op_assign
id|n
suffix:semicolon
)brace
r_else
(brace
id|LOG
c_func
(paren
l_string|&quot;too many ports, %s ignored.&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;auto&quot;
)paren
)paren
(brace
id|parport_nr
(braket
l_int|0
)braket
op_assign
id|PPCPIA_PARPORT_AUTO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;none&quot;
)paren
)paren
(brace
id|parport_nr
(braket
id|parport_ptr
op_increment
)braket
op_assign
id|PPCPIA_PARPORT_NONE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;cpia_pp=&quot;
comma
id|cpia_pp_setup
)paren
suffix:semicolon
macro_line|#endif /* !MODULE */
eof
