DECL|macro|MAX_KMALLOC_MEM
mdefine_line|#define MAX_KMALLOC_MEM (512*1024)
multiline_comment|/*&n;   buz - Iomega Buz driver version 1.0&n;&n;   Copyright (C) 1999 Rainer Johanni &lt;Rainer@Johanni.de&gt;&n;&n;   based on&n;&n;   buz.0.0.3 Copyright (C) 1998 Dave Perks &lt;dperks@ibm.net&gt;&n;&n;   and&n;&n;   bttv - Bt848 frame grabber driver&n;&n;   Copyright (C) 1996,97,98 Ralph  Metzler (rjkm@thp.uni-koeln.de)&n;   &amp; Marcus Metzler (mocm@thp.uni-koeln.de)&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License as published by&n;   the Free Software Foundation; either version 2 of the License, or&n;   (at your option) any later version.&n;&n;   This program is distributed in the hope that it will be useful,&n;   but WITHOUT ANY WARRANTY; without even the implied warranty of&n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;   GNU General Public License for more details.&n;&n;   You should have received a copy of the GNU General Public License&n;   along with this program; if not, write to the Free Software&n;   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/i2c-old.h&gt;
macro_line|#include &quot;buz.h&quot;
macro_line|#include &lt;linux/video_decoder.h&gt;
macro_line|#include &lt;linux/video_encoder.h&gt;
DECL|macro|IRQ_MASK
mdefine_line|#define IRQ_MASK ( ZR36057_ISR_GIRQ0 | /* ZR36057_ISR_GIRQ1 | ZR36057_ISR_CodRepIRQ | */ ZR36057_ISR_JPEGRepIRQ )
DECL|macro|GPIO_MASK
mdefine_line|#define GPIO_MASK 0xdf
multiline_comment|/*&n; &n; BUZ&n; &n;   GPIO0 = 1, take board out of reset&n;   GPIO1 = 1, take JPEG codec out of sleep mode&n;   GPIO3 = 1, deassert FRAME# to 36060&n;   &n;&n;   GIRQ0 signals a vertical sync of the video signal&n;   GIRQ1 signals that ZR36060&squot;s DATERR# line is asserted.&n;&n;   SAA7111A&n;&n;   In their infinite wisdom, the Iomega engineers decided to&n;   use the same input line for composite and S-Video Color,&n;   although there are two entries not connected at all!&n;   Through this ingenious strike, it is not possible to&n;   keep two running video sources connected at the same time&n;   to Composite and S-VHS input!&n;&n;   mode 0 - N/C&n;   mode 1 - S-Video Y&n;   mode 2 - noise or something I don&squot;t know&n;   mode 3 - Composite and S-Video C&n;   mode 4 - N/C&n;   mode 5 - S-Video (gain C independently selectable of gain Y)&n;   mode 6 - N/C&n;   mode 7 - S-Video (gain C adapted to gain Y)&n; */
DECL|macro|MAJOR_VERSION
mdefine_line|#define MAJOR_VERSION 1&t;&t;/* driver major version */
DECL|macro|MINOR_VERSION
mdefine_line|#define MINOR_VERSION 0&t;&t;/* driver minor version */
DECL|macro|BUZ_NAME
mdefine_line|#define BUZ_NAME      &quot;Iomega BUZ V-1.0&quot;&t;/* name of the driver */
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;&t;/* Debug driver */
DECL|macro|IDEBUG
mdefine_line|#define IDEBUG(x)&t;&t;/* Debug interrupt handler */
DECL|macro|IOCTL_DEBUG
mdefine_line|#define IOCTL_DEBUG(x)
multiline_comment|/* The parameters for this driver */
multiline_comment|/*&n;   The video mem address of the video card.&n;   The driver has a little database for some videocards&n;   to determine it from there. If your video card is not in there&n;   you have either to give it to the driver as a parameter&n;   or set in in a VIDIOCSFBUF ioctl&n; */
DECL|variable|vidmem
r_static
r_int
r_int
id|vidmem
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Video memory base address */
multiline_comment|/* Special purposes only: */
DECL|variable|triton
r_static
r_int
id|triton
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0=no, 1=yes */
DECL|variable|natoma
r_static
r_int
id|natoma
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0=no, 1=yes */
multiline_comment|/*&n;   Number and size of grab buffers for Video 4 Linux&n;   The vast majority of applications should not need more than 2,&n;   the very popular BTTV driver actually does ONLY have 2.&n;   Time sensitive applications might need more, the maximum&n;   is VIDEO_MAX_FRAME (defined in &lt;linux/videodev.h&gt;).&n;&n;   The size is set so that the maximum possible request&n;   can be satisfied. Decrease  it, if bigphys_area alloc&squot;d&n;   memory is low. If you don&squot;t have the bigphys_area patch,&n;   set it to 128 KB. Will you allow only to grab small&n;   images with V4L, but that&squot;s better than nothing.&n;&n;   v4l_bufsize has to be given in KB !&n;&n; */
DECL|variable|v4l_nbufs
r_static
r_int
id|v4l_nbufs
op_assign
l_int|2
suffix:semicolon
DECL|variable|v4l_bufsize
r_static
r_int
id|v4l_bufsize
op_assign
l_int|128
suffix:semicolon
multiline_comment|/* Everybody should be able to work with this setting */
multiline_comment|/*&n;   Default input and video norm at startup of the driver.&n; */
DECL|variable|default_input
r_static
r_int
id|default_input
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0=Composite, 1=S-VHS */
DECL|variable|default_norm
r_static
r_int
id|default_norm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0=PAL, 1=NTSC */
id|MODULE_PARM
c_func
(paren
id|vidmem
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|triton
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|natoma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|v4l_nbufs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|v4l_bufsize
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|default_input
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|default_norm
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Anybody who uses more than four? */
DECL|macro|BUZ_MAX
mdefine_line|#define BUZ_MAX 4
DECL|variable|zoran_num
r_static
r_int
id|zoran_num
suffix:semicolon
multiline_comment|/* number of Buzs in use */
DECL|variable|zoran
r_static
r_struct
id|zoran
id|zoran
(braket
id|BUZ_MAX
)braket
suffix:semicolon
multiline_comment|/* forward references */
r_static
r_void
id|v4l_fbuffer_free
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
suffix:semicolon
r_static
r_void
id|jpg_fbuffer_free
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
suffix:semicolon
r_static
r_void
id|zoran_feed_stat_com
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
suffix:semicolon
multiline_comment|/*&n; *   Allocate the V4L grab buffers&n; *&n; *   These have to be pysically contiguous.&n; *   If v4l_bufsize &lt;= MAX_KMALLOC_MEM we use kmalloc&n; */
DECL|function|v4l_fbuffer_alloc
r_static
r_int
id|v4l_fbuffer_alloc
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
comma
id|off
suffix:semicolon
r_int
r_char
op_star
id|mem
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v4l_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: v4l_fbuffer_alloc: buffer %d allready allocated ?&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v4l_bufsize
op_le
id|MAX_KMALLOC_MEM
)paren
(brace
multiline_comment|/* Use kmalloc */
id|mem
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|v4l_bufsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: kmalloc for V4L bufs failed&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
id|v4l_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
op_assign
id|mem
suffix:semicolon
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer_phys
op_assign
id|virt_to_phys
c_func
(paren
id|mem
)paren
suffix:semicolon
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer_bus
op_assign
id|virt_to_bus
c_func
(paren
id|mem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|v4l_bufsize
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|BUZ_INFO
l_string|&quot;: V4L frame %d mem 0x%x (bus: 0x%x=%d)&bslash;n&quot;
comma
id|i
comma
id|mem
comma
id|virt_to_bus
c_func
(paren
id|mem
)paren
comma
id|virt_to_bus
c_func
(paren
id|mem
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|v4l_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free the V4L grab buffers */
DECL|function|v4l_fbuffer_free
r_static
r_void
id|v4l_fbuffer_free
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
comma
id|off
suffix:semicolon
r_int
r_char
op_star
id|mem
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v4l_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
)paren
r_continue
suffix:semicolon
id|mem
op_assign
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|v4l_bufsize
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
)paren
suffix:semicolon
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *   Allocate the MJPEG grab buffers.&n; *&n; *   If the requested buffer size is smaller than MAX_KMALLOC_MEM,&n; *   kmalloc is used to request a physically contiguous area,&n; *   else we allocate the memory in framgents with get_free_page.&n; *&n; *   If a Natoma chipset is present and this is a revision 1 zr36057,&n; *   each MJPEG buffer needs to be physically contiguous.&n; *   (RJ: This statement is from Dave Perks&squot; original driver,&n; *   I could never check it because I have a zr36067)&n; *   The driver cares about this because it reduces the buffer&n; *   size to MAX_KMALLOC_MEM in that case (which forces contiguous allocation).&n; *&n; *   RJ: The contents grab buffers needs never be accessed in the driver.&n; *       Therefore there is no need to allocate them with vmalloc in order&n; *       to get a contiguous virtual memory space.&n; *       I don&squot;t understand why many other drivers first allocate them with&n; *       vmalloc (which uses internally also get_free_page, but delivers you&n; *       virtual addresses) and then again have to make a lot of efforts&n; *       to get the physical address.&n; *&n; */
DECL|function|jpg_fbuffer_alloc
r_static
r_int
id|jpg_fbuffer_alloc
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
comma
id|j
comma
id|off
comma
id|alloc_contig
suffix:semicolon
r_int
r_int
id|mem
suffix:semicolon
multiline_comment|/* Decide if we should alloc contiguous or fragmented memory */
multiline_comment|/* This has to be identical in jpg_fbuffer_alloc and jpg_fbuffer_free */
id|alloc_contig
op_assign
(paren
id|zr-&gt;jpg_bufsize
OL
id|MAX_KMALLOC_MEM
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zr-&gt;jpg_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: jpg_fbuffer_alloc: buffer %d allready allocated ???&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Allocate fragment table for this buffer */
id|mem
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: jpg_fbuffer_alloc: get_free_page (frag_tab) failed for buffer %d&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|i
)paren
suffix:semicolon
id|jpg_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
op_assign
(paren
id|u32
op_star
)paren
id|mem
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab_bus
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_contig
)paren
(brace
id|mem
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|zr-&gt;jpg_bufsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|jpg_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|zr-&gt;jpg_bufsize
op_div
l_int|4
)paren
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|zr-&gt;jpg_bufsize
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* jpg_bufsize is alreay page aligned */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|zr-&gt;jpg_bufsize
op_div
id|PAGE_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mem
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|jpg_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
op_assign
(paren
id|PAGE_SIZE
op_div
l_int|4
)paren
op_lshift
l_int|1
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|mem
)paren
)paren
suffix:semicolon
)brace
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_minus
l_int|1
)braket
op_or_assign
l_int|1
suffix:semicolon
)brace
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;jpg_fbuffer_alloc: %d KB allocated&bslash;n&quot;
comma
(paren
id|zr-&gt;jpg_nbufs
op_star
id|zr-&gt;jpg_bufsize
)paren
op_rshift
l_int|10
)paren
)paren
suffix:semicolon
id|zr-&gt;jpg_buffers_allocated
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free the MJPEG grab buffers */
DECL|function|jpg_fbuffer_free
r_static
r_void
id|jpg_fbuffer_free
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
comma
id|j
comma
id|off
comma
id|alloc_contig
suffix:semicolon
r_int
r_char
op_star
id|mem
suffix:semicolon
multiline_comment|/* Decide if we should alloc contiguous or fragmented memory */
multiline_comment|/* This has to be identical in jpg_fbuffer_alloc and jpg_fbuffer_free */
id|alloc_contig
op_assign
(paren
id|zr-&gt;jpg_bufsize
OL
id|MAX_KMALLOC_MEM
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zr-&gt;jpg_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|alloc_contig
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
)paren
(brace
id|mem
op_assign
(paren
r_int
r_char
op_star
)paren
id|bus_to_virt
c_func
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|zr-&gt;jpg_bufsize
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|zr-&gt;jpg_bufsize
op_div
id|PAGE_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
r_break
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|bus_to_virt
c_func
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
)paren
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|bus_to_virt
c_func
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
)paren
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
)paren
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
op_assign
l_int|NULL
suffix:semicolon
)brace
id|zr-&gt;jpg_buffers_allocated
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
multiline_comment|/* I2C functions                                                           */
DECL|macro|I2C_DELAY
mdefine_line|#define I2C_DELAY   10
multiline_comment|/* software I2C functions */
DECL|function|i2c_setlines
r_static
r_void
id|i2c_setlines
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|ctrl
comma
r_int
id|data
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|bus-&gt;data
suffix:semicolon
id|btwrite
c_func
(paren
(paren
id|data
op_lshift
l_int|1
)paren
op_or
id|ctrl
comma
id|ZR36057_I2CBR
)paren
suffix:semicolon
id|btread
c_func
(paren
id|ZR36057_I2CBR
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|I2C_DELAY
)paren
suffix:semicolon
)brace
DECL|function|i2c_getdataline
r_static
r_int
id|i2c_getdataline
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_return
(paren
id|btread
c_func
(paren
id|ZR36057_I2CBR
)paren
op_rshift
l_int|1
)paren
op_amp
l_int|1
suffix:semicolon
)brace
DECL|function|attach_inform
r_static
r_void
id|attach_inform
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|id
)paren
(brace
id|DEBUG
c_func
(paren
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|bus-&gt;data
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|BUZ_DEBUG
l_string|&quot;-%u: i2c attach %02x&bslash;n&quot;
comma
id|zr-&gt;id
comma
id|id
)paren
)paren
suffix:semicolon
)brace
DECL|function|detach_inform
r_static
r_void
id|detach_inform
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|id
)paren
(brace
id|DEBUG
c_func
(paren
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|bus-&gt;data
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|BUZ_DEBUG
l_string|&quot;-%u: i2c detach %02x&bslash;n&quot;
comma
id|zr-&gt;id
comma
id|id
)paren
)paren
suffix:semicolon
)brace
DECL|variable|zoran_i2c_bus_template
r_static
r_struct
id|i2c_bus
id|zoran_i2c_bus_template
op_assign
(brace
l_string|&quot;zr36057&quot;
comma
id|I2C_BUSID_BT848
comma
l_int|NULL
comma
id|SPIN_LOCK_UNLOCKED
comma
id|attach_inform
comma
id|detach_inform
comma
id|i2c_setlines
comma
id|i2c_getdataline
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|function|GPIO
r_static
r_void
id|GPIO
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|bit
comma
r_int
id|value
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|u32
id|mask
suffix:semicolon
id|mask
op_assign
l_int|1
op_lshift
(paren
l_int|24
op_plus
id|bit
)paren
suffix:semicolon
id|reg
op_assign
id|btread
c_func
(paren
id|ZR36057_GPPGCR1
)paren
op_amp
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|reg
op_or_assign
id|mask
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_GPPGCR1
)paren
suffix:semicolon
multiline_comment|/* Stop any PCI posting on the GPIO bus */
id|btread
c_func
(paren
id|ZR36057_I2CBR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *   Set the registers for the size we have specified. Don&squot;t bother&n; *   trying to understand this without the ZR36057 manual in front of&n; *   you [AC].&n; *&n; *   PS: The manual is free for download in .pdf format from&n; *   www.zoran.com - nicely done those folks.&n; */
DECL|struct|tvnorm
r_struct
id|tvnorm
(brace
DECL|member|Wt
DECL|member|Wa
DECL|member|Ht
DECL|member|Ha
DECL|member|HStart
DECL|member|VStart
id|u16
id|Wt
comma
id|Wa
comma
id|Ht
comma
id|Ha
comma
id|HStart
comma
id|VStart
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|tvnorms
r_static
r_struct
id|tvnorm
id|tvnorms
(braket
)braket
op_assign
(brace
multiline_comment|/* PAL-BDGHI */
(brace
l_int|864
comma
l_int|720
comma
l_int|625
comma
l_int|576
comma
l_int|31
comma
l_int|16
)brace
comma
multiline_comment|/* NTSC */
(brace
l_int|858
comma
l_int|720
comma
l_int|525
comma
l_int|480
comma
l_int|21
comma
l_int|8
)brace
comma
)brace
suffix:semicolon
DECL|macro|TVNORMS
mdefine_line|#define TVNORMS (sizeof(tvnorms) / sizeof(tvnorm))
DECL|function|format2bpp
r_static
r_int
id|format2bpp
c_func
(paren
r_int
id|format
)paren
(brace
r_int
id|bpp
suffix:semicolon
multiline_comment|/* Determine the number of bytes per pixel for the video format requested */
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
id|bpp
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
id|bpp
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
id|bpp
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|bpp
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
id|bpp
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bpp
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|bpp
suffix:semicolon
)brace
multiline_comment|/*&n; * set geometry&n; */
DECL|function|zr36057_set_vfe
r_static
r_void
id|zr36057_set_vfe
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|video_width
comma
r_int
id|video_height
comma
r_int
r_int
id|video_format
)paren
(brace
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
r_int
id|HStart
comma
id|HEnd
comma
id|VStart
comma
id|VEnd
suffix:semicolon
r_int
id|DispMode
suffix:semicolon
r_int
id|VidWinWid
comma
id|VidWinHt
suffix:semicolon
r_int
id|hcrop1
comma
id|hcrop2
comma
id|vcrop1
comma
id|vcrop2
suffix:semicolon
r_int
id|Wa
comma
id|We
comma
id|Ha
comma
id|He
suffix:semicolon
r_int
id|X
comma
id|Y
comma
id|HorDcm
comma
id|VerDcm
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|mask_line_size
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;params.norm
template_param
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: set_vfe: video_norm = %d not valid&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|zr-&gt;params.norm
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_width
OL
id|BUZ_MIN_WIDTH
op_logical_or
id|video_height
OL
id|BUZ_MIN_HEIGHT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: set_vfe: w=%d h=%d not valid&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|video_width
comma
id|video_height
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tvn
op_assign
op_amp
id|tvnorms
(braket
id|zr-&gt;params.norm
)braket
suffix:semicolon
id|Wa
op_assign
id|tvn-&gt;Wa
suffix:semicolon
id|Ha
op_assign
id|tvn-&gt;Ha
suffix:semicolon
multiline_comment|/* if window has more than half of active height,&n;&t;   switch on interlacing - we want the full information */
id|zr-&gt;video_interlace
op_assign
(paren
id|video_height
OG
id|Ha
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/**** zr36057 ****/
multiline_comment|/* horizontal */
id|VidWinWid
op_assign
id|video_width
suffix:semicolon
id|X
op_assign
(paren
id|VidWinWid
op_star
l_int|64
op_plus
id|tvn-&gt;Wa
op_minus
l_int|1
)paren
op_div
id|tvn-&gt;Wa
suffix:semicolon
id|We
op_assign
(paren
id|VidWinWid
op_star
l_int|64
)paren
op_div
id|X
suffix:semicolon
id|HorDcm
op_assign
l_int|64
op_minus
id|X
suffix:semicolon
id|hcrop1
op_assign
l_int|2
op_star
(paren
(paren
id|tvn-&gt;Wa
op_minus
id|We
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|hcrop2
op_assign
id|tvn-&gt;Wa
op_minus
id|We
op_minus
id|hcrop1
suffix:semicolon
id|HStart
op_assign
id|tvn-&gt;HStart
op_or
l_int|1
suffix:semicolon
id|HEnd
op_assign
id|HStart
op_plus
id|tvn-&gt;Wa
op_minus
l_int|1
suffix:semicolon
id|HStart
op_add_assign
id|hcrop1
suffix:semicolon
id|HEnd
op_sub_assign
id|hcrop2
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|HStart
op_amp
id|ZR36057_VFEHCR_Hmask
)paren
op_lshift
id|ZR36057_VFEHCR_HStart
)paren
op_or
(paren
(paren
id|HEnd
op_amp
id|ZR36057_VFEHCR_Hmask
)paren
op_lshift
id|ZR36057_VFEHCR_HEnd
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VFEHCR_HSPol
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
multiline_comment|/* Vertical */
id|DispMode
op_assign
op_logical_neg
id|zr-&gt;video_interlace
suffix:semicolon
id|VidWinHt
op_assign
id|DispMode
ques
c_cond
id|video_height
suffix:colon
id|video_height
op_div
l_int|2
suffix:semicolon
id|Y
op_assign
(paren
id|VidWinHt
op_star
l_int|64
op_star
l_int|2
op_plus
id|tvn-&gt;Ha
op_minus
l_int|1
)paren
op_div
id|tvn-&gt;Ha
suffix:semicolon
id|He
op_assign
(paren
id|VidWinHt
op_star
l_int|64
)paren
op_div
id|Y
suffix:semicolon
id|VerDcm
op_assign
l_int|64
op_minus
id|Y
suffix:semicolon
id|vcrop1
op_assign
(paren
id|tvn-&gt;Ha
op_div
l_int|2
op_minus
id|He
)paren
op_div
l_int|2
suffix:semicolon
id|vcrop2
op_assign
id|tvn-&gt;Ha
op_div
l_int|2
op_minus
id|He
op_minus
id|vcrop1
suffix:semicolon
id|VStart
op_assign
id|tvn-&gt;VStart
suffix:semicolon
id|VEnd
op_assign
id|VStart
op_plus
id|tvn-&gt;Ha
op_div
l_int|2
op_minus
l_int|1
suffix:semicolon
id|VStart
op_add_assign
id|vcrop1
suffix:semicolon
id|VEnd
op_sub_assign
id|vcrop2
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|VStart
op_amp
id|ZR36057_VFEVCR_Vmask
)paren
op_lshift
id|ZR36057_VFEVCR_VStart
)paren
op_or
(paren
(paren
id|VEnd
op_amp
id|ZR36057_VFEVCR_Vmask
)paren
op_lshift
id|ZR36057_VFEVCR_VEnd
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VFEVCR_VSPol
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFEVCR
)paren
suffix:semicolon
multiline_comment|/* scaler and pixel format */
id|reg
op_assign
l_int|0
singleline_comment|// ZR36057_VFESPFR_ExtFl /* Trying to live without ExtFl */
op_or
(paren
id|HorDcm
op_lshift
id|ZR36057_VFESPFR_HorDcm
)paren
op_or
(paren
id|VerDcm
op_lshift
id|ZR36057_VFESPFR_VerDcm
)paren
op_or
(paren
id|DispMode
op_lshift
id|ZR36057_VFESPFR_DispMode
)paren
op_or
id|ZR36057_VFESPFR_LittleEndian
suffix:semicolon
multiline_comment|/* RJ: I don&squot;t know, why the following has to be the opposite&n;&t;   of the corresponding ZR36060 setting, but only this way&n;&t;   we get the correct colors when uncompressing to the screen  */
id|reg
op_or_assign
id|ZR36057_VFESPFR_VCLKPol
suffix:semicolon
multiline_comment|/* RJ: Don&squot;t know if that is needed for NTSC also */
id|reg
op_or_assign
id|ZR36057_VFESPFR_TopField
suffix:semicolon
r_switch
c_cond
(paren
id|video_format
)paren
(brace
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_YUV422
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB555
op_or
id|ZR36057_VFESPFR_ErrDif
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB565
op_or
id|ZR36057_VFESPFR_ErrDif
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB888
op_or
id|ZR36057_VFESPFR_Pack24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB888
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown color_fmt=%x&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|video_format
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HorDcm
op_ge
l_int|48
)paren
(brace
id|reg
op_or_assign
l_int|3
op_lshift
id|ZR36057_VFESPFR_HFilter
suffix:semicolon
multiline_comment|/* 5 tap filter */
)brace
r_else
r_if
c_cond
(paren
id|HorDcm
op_ge
l_int|32
)paren
(brace
id|reg
op_or_assign
l_int|2
op_lshift
id|ZR36057_VFESPFR_HFilter
suffix:semicolon
multiline_comment|/* 4 tap filter */
)brace
r_else
r_if
c_cond
(paren
id|HorDcm
op_ge
l_int|16
)paren
(brace
id|reg
op_or_assign
l_int|1
op_lshift
id|ZR36057_VFESPFR_HFilter
suffix:semicolon
multiline_comment|/* 3 tap filter */
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
multiline_comment|/* display configuration */
id|reg
op_assign
(paren
l_int|16
op_lshift
id|ZR36057_VDCR_MinPix
)paren
op_or
(paren
id|VidWinHt
op_lshift
id|ZR36057_VDCR_VidWinHt
)paren
op_or
(paren
id|VidWinWid
op_lshift
id|ZR36057_VDCR_VidWinWid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|triton
)paren
id|reg
op_and_assign
op_complement
id|ZR36057_VDCR_Triton
suffix:semicolon
r_else
id|reg
op_or_assign
id|ZR36057_VDCR_Triton
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
multiline_comment|/* Write overlay clipping mask data, but don&squot;t enable overlay clipping */
multiline_comment|/* RJ: since this makes only sense on the screen, we use &n;&t;   zr-&gt;window.width instead of video_width */
id|mask_line_size
op_assign
(paren
id|BUZ_MAX_WIDTH
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
id|reg
op_assign
id|virt_to_bus
c_func
(paren
id|zr-&gt;overlay_mask
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_MMTR
)paren
suffix:semicolon
id|reg
op_assign
id|virt_to_bus
c_func
(paren
id|zr-&gt;overlay_mask
op_plus
id|mask_line_size
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_MMBR
)paren
suffix:semicolon
id|reg
op_assign
id|mask_line_size
op_minus
(paren
id|zr-&gt;window.width
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|DispMode
op_eq
l_int|0
)paren
id|reg
op_add_assign
id|mask_line_size
suffix:semicolon
id|reg
op_lshift_assign
id|ZR36057_OCR_MaskStride
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_OCR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Switch overlay on or off&n; */
DECL|function|zr36057_overlay
r_static
r_void
id|zr36057_overlay
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|on
)paren
(brace
r_int
id|fmt
comma
id|bpp
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
multiline_comment|/* do the necessary settings ... */
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
multiline_comment|/* switch it off first */
r_switch
c_cond
(paren
id|zr-&gt;buffer.depth
)paren
(brace
r_case
l_int|15
suffix:colon
id|fmt
op_assign
id|VIDEO_PALETTE_RGB555
suffix:semicolon
id|bpp
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|fmt
op_assign
id|VIDEO_PALETTE_RGB565
suffix:semicolon
id|bpp
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|fmt
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
id|bpp
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|fmt
op_assign
id|VIDEO_PALETTE_RGB32
suffix:semicolon
id|bpp
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|fmt
op_assign
l_int|0
suffix:semicolon
id|bpp
op_assign
l_int|0
suffix:semicolon
)brace
id|zr36057_set_vfe
c_func
(paren
id|zr
comma
id|zr-&gt;window.width
comma
id|zr-&gt;window.height
comma
id|fmt
)paren
suffix:semicolon
multiline_comment|/* Start and length of each line MUST be 4-byte aligned.&n;&t;&t;   This should be allready checked before the call to this routine.&n;&t;&t;   All error messages are internal driver checking only! */
multiline_comment|/* video display top and bottom registers */
id|reg
op_assign
(paren
id|u32
)paren
id|zr-&gt;buffer.base
op_plus
id|zr-&gt;window.x
op_star
id|bpp
op_plus
id|zr-&gt;window.y
op_star
id|zr-&gt;buffer.bytesperline
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: zr36057_overlay: video_address not aligned&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;video_interlace
)paren
id|reg
op_add_assign
id|zr-&gt;buffer.bytesperline
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDBR
)paren
suffix:semicolon
multiline_comment|/* video stride, status, and frame grab register */
id|reg
op_assign
id|zr-&gt;buffer.bytesperline
op_minus
id|zr-&gt;window.width
op_star
id|bpp
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;video_interlace
)paren
id|reg
op_add_assign
id|zr-&gt;buffer.bytesperline
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: zr36057_overlay: video_stride not aligned&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_lshift
id|ZR36057_VSSFGR_DispStride
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_VidOvf
suffix:semicolon
multiline_comment|/* clear overflow status */
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
multiline_comment|/* Set overlay clipping */
r_if
c_cond
(paren
id|zr-&gt;window.clipcount
)paren
id|btor
c_func
(paren
id|ZR36057_OCR_OvlEnable
comma
id|ZR36057_OCR
)paren
suffix:semicolon
multiline_comment|/* ... and switch it on */
id|btor
c_func
(paren
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Switch it off */
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The overlay mask has one bit for each pixel on a scan line,&n; *  and the maximum window size is BUZ_MAX_WIDTH * BUZ_MAX_HEIGHT pixels.&n; */
DECL|function|write_overlay_mask
r_static
r_void
id|write_overlay_mask
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_struct
id|video_clip
op_star
id|vp
comma
r_int
id|count
)paren
(brace
r_int
id|mask_line_size
op_assign
(paren
id|BUZ_MAX_WIDTH
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
id|u32
op_star
id|mask
suffix:semicolon
r_int
id|x
comma
id|y
comma
id|width
comma
id|height
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|u32
id|reg
suffix:semicolon
multiline_comment|/* fill mask with one bits */
id|memset
c_func
(paren
id|zr-&gt;overlay_mask
comma
op_complement
l_int|0
comma
id|mask_line_size
op_star
l_int|4
op_star
id|BUZ_MAX_HEIGHT
)paren
suffix:semicolon
id|reg
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/* pick up local copy of clip */
id|x
op_assign
id|vp
(braket
id|i
)braket
dot
id|x
suffix:semicolon
id|y
op_assign
id|vp
(braket
id|i
)braket
dot
id|y
suffix:semicolon
id|width
op_assign
id|vp
(braket
id|i
)braket
dot
id|width
suffix:semicolon
id|height
op_assign
id|vp
(braket
id|i
)braket
dot
id|height
suffix:semicolon
multiline_comment|/* trim clips that extend beyond the window */
r_if
c_cond
(paren
id|x
OL
l_int|0
)paren
(brace
id|width
op_add_assign
id|x
suffix:semicolon
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
OL
l_int|0
)paren
(brace
id|height
op_add_assign
id|y
suffix:semicolon
id|y
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_plus
id|width
OG
id|zr-&gt;window.width
)paren
(brace
id|width
op_assign
id|zr-&gt;window.width
op_minus
id|x
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
op_plus
id|height
OG
id|zr-&gt;window.height
)paren
(brace
id|height
op_assign
id|zr-&gt;window.height
op_minus
id|y
suffix:semicolon
)brace
multiline_comment|/* ignore degenerate clips */
r_if
c_cond
(paren
id|height
op_le
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|width
op_le
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* apply clip for each scan line */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|height
suffix:semicolon
op_increment
id|j
)paren
(brace
multiline_comment|/* reset bit for each pixel */
multiline_comment|/* this can be optimized later if need be */
id|mask
op_assign
id|zr-&gt;overlay_mask
op_plus
(paren
id|y
op_plus
id|j
)paren
op_star
id|mask_line_size
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|width
suffix:semicolon
op_increment
id|k
)paren
(brace
id|mask
(braket
(paren
id|x
op_plus
id|k
)paren
op_div
l_int|32
)braket
op_and_assign
op_complement
(paren
(paren
id|u32
)paren
l_int|1
op_lshift
(paren
id|x
op_plus
id|k
)paren
op_mod
l_int|32
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Enable/Disable uncompressed memory grabbing of the 36057 */
DECL|function|zr36057_set_memgrab
r_static
r_void
id|zr36057_set_memgrab
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
id|mode
)paren
(brace
r_if
c_cond
(paren
id|btread
c_func
(paren
id|ZR36057_VSSFGR
)paren
op_amp
(paren
id|ZR36057_VSSFGR_SnapShot
op_or
id|ZR36057_VSSFGR_FrameGrab
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: zr36057_set_memgrab_on with SnapShot or FrameGrab on ???&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
multiline_comment|/* switch on VSync interrupts */
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
singleline_comment|// Clear Interrupts
id|btor
c_func
(paren
id|ZR36057_ICR_GIRQ0
comma
id|ZR36057_ICR
)paren
suffix:semicolon
multiline_comment|/* enable SnapShot */
id|btor
c_func
(paren
id|ZR36057_VSSFGR_SnapShot
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
multiline_comment|/* Set zr36057 video front end  and enable video */
macro_line|#ifdef XAWTV_HACK
id|zr36057_set_vfe
c_func
(paren
id|zr
comma
id|zr-&gt;gwidth
OG
l_int|720
ques
c_cond
l_int|720
suffix:colon
id|zr-&gt;gwidth
comma
id|zr-&gt;gheight
comma
id|zr-&gt;gformat
)paren
suffix:semicolon
macro_line|#else
id|zr36057_set_vfe
c_func
(paren
id|zr
comma
id|zr-&gt;gwidth
comma
id|zr-&gt;gheight
comma
id|zr-&gt;gformat
)paren
suffix:semicolon
macro_line|#endif
id|zr-&gt;v4l_memgrab_active
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|zr-&gt;v4l_memgrab_active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* switch off VSync interrupts */
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_GIRQ0
comma
id|ZR36057_ICR
)paren
suffix:semicolon
multiline_comment|/* reenable grabbing to screen if it was running */
r_if
c_cond
(paren
id|zr-&gt;v4l_overlay_active
)paren
(brace
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_VSSFGR_SnapShot
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|wait_grab_pending
r_static
r_int
id|wait_grab_pending
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* wait until all pending grabs are finished */
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|zr-&gt;v4l_pend_tail
op_ne
id|zr-&gt;v4l_pend_head
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   V4L Buffer grabbing&n; */
DECL|function|v4l_grab
r_static
r_int
id|v4l_grab
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_struct
id|video_mmap
op_star
id|mp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|res
comma
id|bpp
suffix:semicolon
multiline_comment|/*&n;&t; * There is a long list of limitations to what is allowed to be grabbed&n;&t; * We don&squot;t output error messages her, since some programs (e.g. xawtv)&n;&t; * just try several settings to find out what is valid or not.&n;&t; */
multiline_comment|/* No grabbing outside the buffer range! */
r_if
c_cond
(paren
id|mp-&gt;frame
op_ge
id|v4l_nbufs
op_logical_or
id|mp-&gt;frame
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Check size and format of the grab wanted */
r_if
c_cond
(paren
id|mp-&gt;height
OL
id|BUZ_MIN_HEIGHT
op_logical_or
id|mp-&gt;width
OL
id|BUZ_MIN_WIDTH
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;height
OG
id|BUZ_MAX_HEIGHT
op_logical_or
id|mp-&gt;width
OG
id|BUZ_MAX_WIDTH
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|bpp
op_assign
id|format2bpp
c_func
(paren
id|mp-&gt;format
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bpp
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Check against available buffer size */
r_if
c_cond
(paren
id|mp-&gt;height
op_star
id|mp-&gt;width
op_star
id|bpp
OG
id|v4l_bufsize
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* The video front end needs 4-byte alinged line sizes */
r_if
c_cond
(paren
(paren
id|bpp
op_eq
l_int|2
op_logical_and
(paren
id|mp-&gt;width
op_amp
l_int|1
)paren
)paren
op_logical_or
(paren
id|bpp
op_eq
l_int|3
op_logical_and
(paren
id|mp-&gt;width
op_amp
l_int|3
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * To minimize the time spent in the IRQ routine, we avoid setting up&n;&t; * the video front end there.&n;&t; * If this grab has different parameters from a running streaming capture&n;&t; * we stop the streaming capture and start it over again.&n;&t; */
r_if
c_cond
(paren
id|zr-&gt;v4l_memgrab_active
op_logical_and
(paren
id|zr-&gt;gwidth
op_ne
id|mp-&gt;width
op_logical_or
id|zr-&gt;gheight
op_ne
id|mp-&gt;height
op_logical_or
id|zr-&gt;gformat
op_ne
id|mp-&gt;format
)paren
)paren
(brace
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
)brace
id|zr-&gt;gwidth
op_assign
id|mp-&gt;width
suffix:semicolon
id|zr-&gt;gheight
op_assign
id|mp-&gt;height
suffix:semicolon
id|zr-&gt;gformat
op_assign
id|mp-&gt;format
suffix:semicolon
id|zr-&gt;gbpl
op_assign
id|bpp
op_star
id|zr-&gt;gwidth
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* make sure a grab isn&squot;t going on currently with this buffer */
r_switch
c_cond
(paren
id|zr-&gt;v4l_gbuf
(braket
id|mp-&gt;frame
)braket
dot
id|state
)paren
(brace
r_default
suffix:colon
r_case
id|BUZ_STATE_PEND
suffix:colon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* what are you doing? */
r_break
suffix:semicolon
r_case
id|BUZ_STATE_USER
suffix:colon
r_case
id|BUZ_STATE_DONE
suffix:colon
multiline_comment|/* since there is at least one unused buffer there&squot;s room for at least one more pend[] entry */
id|zr-&gt;v4l_pend
(braket
id|zr-&gt;v4l_pend_head
op_increment
op_amp
id|V4L_MASK_FRAME
)braket
op_assign
id|mp-&gt;frame
suffix:semicolon
id|zr-&gt;v4l_gbuf
(braket
id|mp-&gt;frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_PEND
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* put the 36057 into frame grabbing mode */
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * Sync on a V4L buffer&n; */
DECL|function|v4l_sync
r_static
r_int
id|v4l_sync
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|frame
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* check passed-in frame number */
r_if
c_cond
(paren
id|frame
op_ge
id|v4l_nbufs
op_logical_or
id|frame
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: v4l_sync: frame %d is invalid&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|frame
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Check if is buffer was queued at all */
r_if
c_cond
(paren
id|zr-&gt;v4l_gbuf
(braket
id|frame
)braket
dot
id|state
op_eq
id|BUZ_STATE_USER
)paren
(brace
singleline_comment|//&t;&t;printk(KERN_ERR &quot;%s: v4l_sync: Trying to sync on a buffer which was not queued?&bslash;n&quot;, zr-&gt;name);
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* wait on this buffer to get ready */
r_while
c_loop
(paren
id|zr-&gt;v4l_gbuf
(braket
id|frame
)braket
dot
id|state
op_eq
id|BUZ_STATE_PEND
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
multiline_comment|/* buffer should now be in BUZ_STATE_DONE */
r_if
c_cond
(paren
id|zr-&gt;v4l_gbuf
(braket
id|frame
)braket
dot
id|state
op_ne
id|BUZ_STATE_DONE
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: v4l_sync - internal error&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Check if streaming capture has finished */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_pend_tail
op_eq
id|zr-&gt;v4l_pend_head
)paren
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *                                                                           *&n; *  Set up the Buz-specific MJPEG part                                       *&n; *                                                                           *&n; *****************************************************************************/
multiline_comment|/*&n; *&t;Wait til post office is no longer busy &n; */
DECL|function|post_office_wait
r_static
r_int
id|post_office_wait
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|por
suffix:semicolon
id|u32
id|ct
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|por
op_assign
id|btread
c_func
(paren
id|ZR36057_POR
)paren
)paren
op_amp
(paren
id|ZR36057_POR_POPen
op_or
id|ZR36057_POR_POTime
)paren
)paren
op_eq
id|ZR36057_POR_POPen
)paren
(brace
id|ct
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ct
OG
l_int|100000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: timeout on post office.&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* wait for something to happen */
)brace
r_if
c_cond
(paren
(paren
id|por
op_amp
id|ZR36057_POR_POPen
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: pop pending %08x&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|por
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|por
op_amp
(paren
id|ZR36057_POR_POTime
op_or
id|ZR36057_POR_POPen
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: pop timeout %08x&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|por
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|post_office_write
r_static
r_int
id|post_office_write
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|guest
comma
r_int
id|reg
comma
r_int
id|value
)paren
(brace
id|u32
id|por
suffix:semicolon
id|post_office_wait
c_func
(paren
id|zr
)paren
suffix:semicolon
id|por
op_assign
id|ZR36057_POR_PODir
op_or
id|ZR36057_POR_POTime
op_or
(paren
(paren
id|guest
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|7
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|value
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|por
comma
id|ZR36057_POR
)paren
suffix:semicolon
r_return
id|post_office_wait
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
DECL|function|post_office_read
r_static
r_int
id|post_office_read
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|guest
comma
r_int
id|reg
)paren
(brace
id|u32
id|por
suffix:semicolon
id|post_office_wait
c_func
(paren
id|zr
)paren
suffix:semicolon
id|por
op_assign
id|ZR36057_POR_POTime
op_or
(paren
(paren
id|guest
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|por
comma
id|ZR36057_POR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|post_office_wait
c_func
(paren
id|zr
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|btread
c_func
(paren
id|ZR36057_POR
)paren
op_amp
l_int|0xFF
suffix:semicolon
)brace
DECL|function|zr36060_write_8
r_static
r_int
id|zr36060_write_8
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|post_office_wait
c_func
(paren
id|zr
)paren
op_logical_or
id|post_office_write
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|1
comma
id|reg
op_rshift
l_int|8
)paren
op_logical_or
id|post_office_write
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|2
comma
id|reg
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|post_office_write
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|3
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|zr36060_write_16
r_static
r_int
id|zr36060_write_16
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|reg
op_plus
l_int|0
comma
id|val
op_rshift
l_int|8
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|reg
op_plus
l_int|1
comma
id|val
op_rshift
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|zr36060_write_24
r_static
r_int
id|zr36060_write_24
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|reg
op_plus
l_int|0
comma
id|val
op_rshift
l_int|16
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|zr36060_write_16
c_func
(paren
id|zr
comma
id|reg
op_plus
l_int|1
comma
id|val
op_rshift
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|zr36060_write_32
r_static
r_int
id|zr36060_write_32
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|zr36060_write_16
c_func
(paren
id|zr
comma
id|reg
op_plus
l_int|0
comma
id|val
op_rshift
l_int|16
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|zr36060_write_16
c_func
(paren
id|zr
comma
id|reg
op_plus
l_int|2
comma
id|val
op_rshift
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|zr36060_read_8
r_static
id|u32
id|zr36060_read_8
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|reg
)paren
(brace
r_if
c_cond
(paren
id|post_office_wait
c_func
(paren
id|zr
)paren
op_logical_or
id|post_office_write
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|1
comma
id|reg
op_rshift
l_int|8
)paren
op_logical_or
id|post_office_write
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|2
comma
id|reg
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|post_office_read
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|3
)paren
op_amp
l_int|0xFF
suffix:semicolon
)brace
DECL|function|zr36060_reset
r_static
r_int
id|zr36060_reset
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_return
id|post_office_write
c_func
(paren
id|zr
comma
l_int|3
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|zr36060_sleep
r_static
r_void
id|zr36060_sleep
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|sleep
)paren
(brace
id|GPIO
c_func
(paren
id|zr
comma
l_int|1
comma
op_logical_neg
id|sleep
)paren
suffix:semicolon
)brace
DECL|function|zr36060_set_jpg
r_static
r_void
id|zr36060_set_jpg
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|size
suffix:semicolon
id|reg
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
multiline_comment|/* CodeMstr */
op_or
(paren
l_int|0
op_lshift
l_int|2
)paren
multiline_comment|/* CFIS=0 */
op_or
(paren
l_int|0
op_lshift
l_int|6
)paren
multiline_comment|/* Endian=0 */
op_or
(paren
l_int|0
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Code16=0 */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x002
comma
id|reg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
r_case
id|BUZ_MODE_STILL_DECOMPRESS
suffix:colon
id|reg
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Codec mode = decompression */
r_break
suffix:semicolon
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
r_case
id|BUZ_MODE_STILL_COMPRESS
suffix:colon
r_default
suffix:colon
id|reg
op_assign
l_int|0xa4
suffix:semicolon
multiline_comment|/* Codec mode = compression with variable scale factor */
r_break
suffix:semicolon
)brace
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x003
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* reserved, mbz */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x004
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* 510 bits/block */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x005
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* JPEG markers */
id|reg
op_assign
(paren
id|zr-&gt;params.jpeg_markers
)paren
op_amp
l_int|0x38
suffix:semicolon
multiline_comment|/* DRI, DQT, DHT */
r_if
c_cond
(paren
id|zr-&gt;params.COM_len
)paren
id|reg
op_or_assign
id|JPEG_MARKER_COM
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;params.APP_len
)paren
id|reg
op_or_assign
id|JPEG_MARKER_APP
suffix:semicolon
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x006
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
l_int|0
op_lshift
l_int|3
)paren
multiline_comment|/* DATERR=0 */
op_or
(paren
l_int|0
op_lshift
l_int|2
)paren
multiline_comment|/* END=0 */
op_or
(paren
l_int|0
op_lshift
l_int|1
)paren
multiline_comment|/* EOI=0 */
op_or
(paren
l_int|0
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* EOAV=0 */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x007
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* code volume */
multiline_comment|/* Target field size in pixels: */
id|tvn
op_assign
op_amp
id|tvnorms
(braket
id|zr-&gt;params.norm
)braket
suffix:semicolon
id|size
op_assign
(paren
id|tvn-&gt;Ha
op_div
l_int|2
)paren
op_star
(paren
id|tvn-&gt;Wa
)paren
op_div
(paren
id|zr-&gt;params.HorDcm
)paren
op_div
(paren
id|zr-&gt;params.VerDcm
)paren
suffix:semicolon
multiline_comment|/* Target compressed field size in bits: */
id|size
op_assign
id|size
op_star
l_int|16
suffix:semicolon
multiline_comment|/* uncompressed size in bits */
id|size
op_assign
id|size
op_star
id|zr-&gt;params.quality
op_div
l_int|400
suffix:semicolon
multiline_comment|/* quality = 100 is a compression ratio 1:4 */
multiline_comment|/* Lower limit (arbitrary, 1 KB) */
r_if
c_cond
(paren
id|size
OL
l_int|8192
)paren
id|size
op_assign
l_int|8192
suffix:semicolon
multiline_comment|/* Upper limit: 7/8 of the code buffers */
r_if
c_cond
(paren
id|size
op_star
id|zr-&gt;params.field_per_buff
OG
id|zr-&gt;jpg_bufsize
op_star
l_int|7
)paren
id|size
op_assign
id|zr-&gt;jpg_bufsize
op_star
l_int|7
op_div
id|zr-&gt;params.field_per_buff
suffix:semicolon
id|reg
op_assign
id|size
suffix:semicolon
id|zr36060_write_32
c_func
(paren
id|zr
comma
l_int|0x009
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* how do we set initial SF as a function of quality parameter? */
id|reg
op_assign
l_int|0x0100
suffix:semicolon
multiline_comment|/* SF=1.0 */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x011
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x00ffffff
suffix:semicolon
multiline_comment|/* AF=max */
id|zr36060_write_24
c_func
(paren
id|zr
comma
l_int|0x013
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* test */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x024
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|zr36060_set_video
r_static
r_void
id|zr36060_set_video
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|reg
op_assign
(paren
l_int|0
op_lshift
l_int|7
)paren
multiline_comment|/* Video8=0 */
op_or
(paren
l_int|0
op_lshift
l_int|6
)paren
multiline_comment|/* Range=0 */
op_or
(paren
l_int|0
op_lshift
l_int|3
)paren
multiline_comment|/* FlDet=0 */
op_or
(paren
l_int|1
op_lshift
l_int|2
)paren
multiline_comment|/* FlVedge=1 */
op_or
(paren
l_int|0
op_lshift
l_int|1
)paren
multiline_comment|/* FlExt=0 */
op_or
(paren
l_int|0
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SyncMstr=0 */
multiline_comment|/* According to ZR36067 documentation, FlDet should correspond&n;&t;   to the odd_even flag of the ZR36067 */
r_if
c_cond
(paren
id|zr-&gt;params.odd_even
)paren
id|reg
op_or_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|BUZ_MODE_STILL_DECOMPRESS
)paren
(brace
multiline_comment|/* limit pixels to range 16..235 as per CCIR-601 */
id|reg
op_or_assign
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Range=1 */
)brace
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x030
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
l_int|0
op_lshift
l_int|7
)paren
multiline_comment|/* VCLKPol=0 */
op_or
(paren
l_int|0
op_lshift
l_int|6
)paren
multiline_comment|/* PValPol=0 */
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
multiline_comment|/* PoePol=1 */
op_or
(paren
l_int|0
op_lshift
l_int|4
)paren
multiline_comment|/* SImgPol=0 */
op_or
(paren
l_int|0
op_lshift
l_int|3
)paren
multiline_comment|/* BLPol=0 */
op_or
(paren
l_int|0
op_lshift
l_int|2
)paren
multiline_comment|/* FlPol=0 */
op_or
(paren
l_int|0
op_lshift
l_int|1
)paren
multiline_comment|/* HSPol=0, sync on falling edge */
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* VSPol=1 */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x031
comma
id|reg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|zr-&gt;params.HorDcm
)paren
(brace
r_default
suffix:colon
r_case
l_int|1
suffix:colon
id|reg
op_assign
(paren
l_int|0
op_lshift
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HScale = 0 */
r_case
l_int|2
suffix:colon
id|reg
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HScale = 1 */
r_case
l_int|4
suffix:colon
id|reg
op_assign
(paren
l_int|2
op_lshift
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HScale = 2 */
)brace
r_if
c_cond
(paren
id|zr-&gt;params.VerDcm
op_eq
l_int|2
)paren
id|reg
op_or_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:semicolon
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x032
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* BackY */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x033
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0xe0
suffix:semicolon
multiline_comment|/* BackU */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x034
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0xe0
suffix:semicolon
multiline_comment|/* BackV */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x035
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* sync generator */
id|tvn
op_assign
op_amp
id|tvnorms
(braket
id|zr-&gt;params.norm
)braket
suffix:semicolon
id|reg
op_assign
id|tvn-&gt;Ht
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Vtotal */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x036
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|tvn-&gt;Wt
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Htotal */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x038
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|6
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* VsyncSize */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x03a
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|100
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* HsyncSize */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x03b
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|tvn-&gt;VStart
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* BVstart */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x03c
comma
id|reg
)paren
suffix:semicolon
id|reg
op_add_assign
id|tvn-&gt;Ha
op_div
l_int|2
suffix:semicolon
multiline_comment|/* BVend */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x03e
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|tvn-&gt;HStart
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* BHstart */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x03d
comma
id|reg
)paren
suffix:semicolon
id|reg
op_add_assign
id|tvn-&gt;Wa
suffix:semicolon
multiline_comment|/* BHend */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x040
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* active area */
id|reg
op_assign
id|zr-&gt;params.img_y
op_plus
id|tvn-&gt;VStart
suffix:semicolon
multiline_comment|/* Vstart */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x042
comma
id|reg
)paren
suffix:semicolon
id|reg
op_add_assign
id|zr-&gt;params.img_height
suffix:semicolon
multiline_comment|/* Vend */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x044
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|zr-&gt;params.img_x
op_plus
id|tvn-&gt;HStart
suffix:semicolon
multiline_comment|/* Hstart */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x046
comma
id|reg
)paren
suffix:semicolon
id|reg
op_add_assign
id|zr-&gt;params.img_width
suffix:semicolon
multiline_comment|/* Hend */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x048
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* subimage area */
id|reg
op_assign
id|zr-&gt;params.img_y
op_plus
id|tvn-&gt;VStart
suffix:semicolon
multiline_comment|/* SVstart */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x04a
comma
id|reg
)paren
suffix:semicolon
id|reg
op_add_assign
id|zr-&gt;params.img_height
suffix:semicolon
multiline_comment|/* SVend */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x04c
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|zr-&gt;params.img_x
op_plus
id|tvn-&gt;HStart
suffix:semicolon
multiline_comment|/* SHstart */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x04e
comma
id|reg
)paren
suffix:semicolon
id|reg
op_add_assign
id|zr-&gt;params.img_width
suffix:semicolon
multiline_comment|/* SHend */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x050
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|zr36060_set_jpg_SOF
r_static
r_void
id|zr36060_set_jpg_SOF
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|reg
op_assign
l_int|0xffc0
suffix:semicolon
multiline_comment|/* SOF marker */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x060
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* SOF length */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x062
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* precision 8 bits */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x064
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|zr-&gt;params.img_height
op_div
id|zr-&gt;params.VerDcm
suffix:semicolon
multiline_comment|/* image height */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x065
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|zr-&gt;params.img_width
op_div
id|zr-&gt;params.HorDcm
suffix:semicolon
multiline_comment|/* image width */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x067
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 3 color components */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x069
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x002100
suffix:semicolon
multiline_comment|/* Y component */
id|zr36060_write_24
c_func
(paren
id|zr
comma
l_int|0x06a
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x011101
suffix:semicolon
multiline_comment|/* U component */
id|zr36060_write_24
c_func
(paren
id|zr
comma
l_int|0x06d
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x021101
suffix:semicolon
multiline_comment|/* V component */
id|zr36060_write_24
c_func
(paren
id|zr
comma
l_int|0x070
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|zr36060_set_jpg_SOS
r_static
r_void
id|zr36060_set_jpg_SOS
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|reg
op_assign
l_int|0xffda
suffix:semicolon
multiline_comment|/* SOS marker */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x07a
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* SOS length */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x07c
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 3 color components */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x07e
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* Y component */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x07f
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x0111
suffix:semicolon
multiline_comment|/* U component */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x081
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x0211
suffix:semicolon
multiline_comment|/* V component */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x083
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x003f00
suffix:semicolon
multiline_comment|/* Start, end spectral scans */
id|zr36060_write_24
c_func
(paren
id|zr
comma
l_int|0x085
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|zr36060_set_jpg_DRI
r_static
r_void
id|zr36060_set_jpg_DRI
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|reg
op_assign
l_int|0xffdd
suffix:semicolon
multiline_comment|/* DRI marker */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x0c0
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* DRI length */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x0c2
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* length in MCUs */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x0c4
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|zr36060_set_jpg_DQT
r_static
r_void
id|zr36060_set_jpg_DQT
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|adr
suffix:semicolon
r_static
r_const
id|u8
id|dqt
(braket
)braket
op_assign
(brace
l_int|0xff
comma
l_int|0xdb
comma
multiline_comment|/* DHT marker */
l_int|0x00
comma
l_int|0x84
comma
multiline_comment|/* DHT length */
l_int|0x00
comma
multiline_comment|/* table ID 0 */
l_int|0x10
comma
l_int|0x0b
comma
l_int|0x0c
comma
l_int|0x0e
comma
l_int|0x0c
comma
l_int|0x0a
comma
l_int|0x10
comma
l_int|0x0e
comma
l_int|0x0d
comma
l_int|0x0e
comma
l_int|0x12
comma
l_int|0x11
comma
l_int|0x10
comma
l_int|0x13
comma
l_int|0x18
comma
l_int|0x28
comma
l_int|0x1a
comma
l_int|0x18
comma
l_int|0x16
comma
l_int|0x16
comma
l_int|0x18
comma
l_int|0x31
comma
l_int|0x23
comma
l_int|0x25
comma
l_int|0x1d
comma
l_int|0x28
comma
l_int|0x3a
comma
l_int|0x33
comma
l_int|0x3d
comma
l_int|0x3c
comma
l_int|0x39
comma
l_int|0x33
comma
l_int|0x38
comma
l_int|0x37
comma
l_int|0x40
comma
l_int|0x48
comma
l_int|0x5c
comma
l_int|0x4e
comma
l_int|0x40
comma
l_int|0x44
comma
l_int|0x57
comma
l_int|0x45
comma
l_int|0x37
comma
l_int|0x38
comma
l_int|0x50
comma
l_int|0x6d
comma
l_int|0x51
comma
l_int|0x57
comma
l_int|0x5f
comma
l_int|0x62
comma
l_int|0x67
comma
l_int|0x68
comma
l_int|0x67
comma
l_int|0x3e
comma
l_int|0x4d
comma
l_int|0x71
comma
l_int|0x79
comma
l_int|0x70
comma
l_int|0x64
comma
l_int|0x78
comma
l_int|0x5c
comma
l_int|0x65
comma
l_int|0x67
comma
l_int|0x63
comma
l_int|0x01
comma
multiline_comment|/* table ID 1 */
l_int|0x11
comma
l_int|0x12
comma
l_int|0x12
comma
l_int|0x18
comma
l_int|0x15
comma
l_int|0x18
comma
l_int|0x2f
comma
l_int|0x1a
comma
l_int|0x1a
comma
l_int|0x2f
comma
l_int|0x63
comma
l_int|0x42
comma
l_int|0x38
comma
l_int|0x42
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
)brace
suffix:semicolon
multiline_comment|/* write fixed quantitization tables */
id|adr
op_assign
l_int|0x0cc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dqt
)paren
suffix:semicolon
op_increment
id|i
)paren
(brace
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|adr
op_increment
comma
id|dqt
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|zr36060_set_jpg_DHT
r_static
r_void
id|zr36060_set_jpg_DHT
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|adr
suffix:semicolon
r_static
r_const
id|u8
id|dht
(braket
)braket
op_assign
(brace
l_int|0xff
comma
l_int|0xc4
comma
multiline_comment|/* DHT marker */
l_int|0x01
comma
l_int|0xa2
comma
multiline_comment|/* DHT length */
l_int|0x00
comma
multiline_comment|/* table class 0, ID 0 */
l_int|0x00
comma
l_int|0x01
comma
l_int|0x05
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
multiline_comment|/* # codes of length 1..8 */
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* # codes of length 8..16 */
l_int|0x00
comma
multiline_comment|/* values for codes of length 2 */
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x05
comma
multiline_comment|/* values for codes of length 3 */
l_int|0x06
comma
multiline_comment|/* values for codes of length 4 */
l_int|0x07
comma
multiline_comment|/* values for codes of length 5 */
l_int|0x08
comma
multiline_comment|/* values for codes of length 6 */
l_int|0x09
comma
multiline_comment|/* values for codes of length 7 */
l_int|0x0a
comma
multiline_comment|/* values for codes of length 8 */
l_int|0x0b
comma
multiline_comment|/* values for codes of length 9 */
l_int|0x01
comma
multiline_comment|/* table class 0, ID 1 */
l_int|0x00
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
multiline_comment|/* # codes of length 1..8 */
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* # codes of length 9..16 */
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
multiline_comment|/* values for codes of length 2 */
l_int|0x03
comma
multiline_comment|/* values for codes of length 3 */
l_int|0x04
comma
multiline_comment|/* values for codes of length 4 */
l_int|0x05
comma
multiline_comment|/* values for codes of length 5 */
l_int|0x06
comma
multiline_comment|/* values for codes of length 6 */
l_int|0x07
comma
multiline_comment|/* values for codes of length 7 */
l_int|0x08
comma
multiline_comment|/* values for codes of length 8 */
l_int|0x09
comma
multiline_comment|/* values for codes of length 9 */
l_int|0x0a
comma
multiline_comment|/* values for codes of length 10 */
l_int|0x0b
comma
multiline_comment|/* values for codes of length 11 */
l_int|0x10
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x7d
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0x11
comma
l_int|0x05
comma
l_int|0x12
comma
l_int|0x21
comma
l_int|0x31
comma
l_int|0x41
comma
l_int|0x06
comma
l_int|0x13
comma
l_int|0x51
comma
l_int|0x61
comma
l_int|0x07
comma
l_int|0x22
comma
l_int|0x71
comma
l_int|0x14
comma
l_int|0x32
comma
l_int|0x81
comma
l_int|0x91
comma
l_int|0xa1
comma
l_int|0x08
comma
l_int|0x23
comma
l_int|0x42
comma
l_int|0xb1
comma
l_int|0xc1
comma
l_int|0x15
comma
l_int|0x52
comma
l_int|0xd1
comma
l_int|0xf0
comma
l_int|0x24
comma
l_int|0x33
comma
l_int|0x62
comma
l_int|0x72
comma
l_int|0x82
comma
l_int|0x09
comma
l_int|0x0a
comma
l_int|0x16
comma
l_int|0x17
comma
l_int|0x18
comma
l_int|0x19
comma
l_int|0x1a
comma
l_int|0x25
comma
l_int|0x26
comma
l_int|0x27
comma
l_int|0x28
comma
l_int|0x29
comma
l_int|0x2a
comma
l_int|0x34
comma
l_int|0x35
comma
l_int|0x36
comma
l_int|0x37
comma
l_int|0x38
comma
l_int|0x39
comma
l_int|0x3a
comma
l_int|0x43
comma
l_int|0x44
comma
l_int|0x45
comma
l_int|0x46
comma
l_int|0x47
comma
l_int|0x48
comma
l_int|0x49
comma
l_int|0x4a
comma
l_int|0x53
comma
l_int|0x54
comma
l_int|0x55
comma
l_int|0x56
comma
l_int|0x57
comma
l_int|0x58
comma
l_int|0x59
comma
l_int|0x5a
comma
l_int|0x63
comma
l_int|0x64
comma
l_int|0x65
comma
l_int|0x66
comma
l_int|0x67
comma
l_int|0x68
comma
l_int|0x69
comma
l_int|0x6a
comma
l_int|0x73
comma
l_int|0x74
comma
l_int|0x75
comma
l_int|0x76
comma
l_int|0x77
comma
l_int|0x78
comma
l_int|0x79
comma
l_int|0x7a
comma
l_int|0x83
comma
l_int|0x84
comma
l_int|0x85
comma
l_int|0x86
comma
l_int|0x87
comma
l_int|0x88
comma
l_int|0x89
comma
l_int|0x8a
comma
l_int|0x92
comma
l_int|0x93
comma
l_int|0x94
comma
l_int|0x95
comma
l_int|0x96
comma
l_int|0x97
comma
l_int|0x98
comma
l_int|0x99
comma
l_int|0x9a
comma
l_int|0xa2
comma
l_int|0xa3
comma
l_int|0xa4
comma
l_int|0xa5
comma
l_int|0xa6
comma
l_int|0xa7
comma
l_int|0xa8
comma
l_int|0xa9
comma
l_int|0xaa
comma
l_int|0xb2
comma
l_int|0xb3
comma
l_int|0xb4
comma
l_int|0xb5
comma
l_int|0xb6
comma
l_int|0xb7
comma
l_int|0xb8
comma
l_int|0xb9
comma
l_int|0xba
comma
l_int|0xc2
comma
l_int|0xc3
comma
l_int|0xc4
comma
l_int|0xc5
comma
l_int|0xc6
comma
l_int|0xc7
comma
l_int|0xc8
comma
l_int|0xc9
comma
l_int|0xca
comma
l_int|0xd2
comma
l_int|0xd3
comma
l_int|0xd4
comma
l_int|0xd5
comma
l_int|0xd6
comma
l_int|0xd7
comma
l_int|0xd8
comma
l_int|0xd9
comma
l_int|0xda
comma
l_int|0xe1
comma
l_int|0xe2
comma
l_int|0xe3
comma
l_int|0xe4
comma
l_int|0xe5
comma
l_int|0xe6
comma
l_int|0xe7
comma
l_int|0xe8
comma
l_int|0xe9
comma
l_int|0xea
comma
l_int|0xf1
comma
l_int|0xf2
comma
l_int|0xf3
comma
l_int|0xf4
comma
l_int|0xf5
comma
l_int|0xf6
comma
l_int|0xf7
comma
l_int|0xf8
comma
l_int|0xf9
comma
l_int|0xfa
comma
l_int|0x11
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x07
comma
l_int|0x05
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x77
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x11
comma
l_int|0x04
comma
l_int|0x05
comma
l_int|0x21
comma
l_int|0x31
comma
l_int|0x06
comma
l_int|0x12
comma
l_int|0x41
comma
l_int|0x51
comma
l_int|0x07
comma
l_int|0x61
comma
l_int|0x71
comma
l_int|0x13
comma
l_int|0x22
comma
l_int|0x32
comma
l_int|0x81
comma
l_int|0x08
comma
l_int|0x14
comma
l_int|0x42
comma
l_int|0x91
comma
l_int|0xa1
comma
l_int|0xb1
comma
l_int|0xc1
comma
l_int|0x09
comma
l_int|0x23
comma
l_int|0x33
comma
l_int|0x52
comma
l_int|0xf0
comma
l_int|0x15
comma
l_int|0x62
comma
l_int|0x72
comma
l_int|0xd1
comma
l_int|0x0a
comma
l_int|0x16
comma
l_int|0x24
comma
l_int|0x34
comma
l_int|0xe1
comma
l_int|0x25
comma
l_int|0xf1
comma
l_int|0x17
comma
l_int|0x18
comma
l_int|0x19
comma
l_int|0x1a
comma
l_int|0x26
comma
l_int|0x27
comma
l_int|0x28
comma
l_int|0x29
comma
l_int|0x2a
comma
l_int|0x35
comma
l_int|0x36
comma
l_int|0x37
comma
l_int|0x38
comma
l_int|0x39
comma
l_int|0x3a
comma
l_int|0x43
comma
l_int|0x44
comma
l_int|0x45
comma
l_int|0x46
comma
l_int|0x47
comma
l_int|0x48
comma
l_int|0x49
comma
l_int|0x4a
comma
l_int|0x53
comma
l_int|0x54
comma
l_int|0x55
comma
l_int|0x56
comma
l_int|0x57
comma
l_int|0x58
comma
l_int|0x59
comma
l_int|0x5a
comma
l_int|0x63
comma
l_int|0x64
comma
l_int|0x65
comma
l_int|0x66
comma
l_int|0x67
comma
l_int|0x68
comma
l_int|0x69
comma
l_int|0x6a
comma
l_int|0x73
comma
l_int|0x74
comma
l_int|0x75
comma
l_int|0x76
comma
l_int|0x77
comma
l_int|0x78
comma
l_int|0x79
comma
l_int|0x7a
comma
l_int|0x82
comma
l_int|0x83
comma
l_int|0x84
comma
l_int|0x85
comma
l_int|0x86
comma
l_int|0x87
comma
l_int|0x88
comma
l_int|0x89
comma
l_int|0x8a
comma
l_int|0x92
comma
l_int|0x93
comma
l_int|0x94
comma
l_int|0x95
comma
l_int|0x96
comma
l_int|0x97
comma
l_int|0x98
comma
l_int|0x99
comma
l_int|0x9a
comma
l_int|0xa2
comma
l_int|0xa3
comma
l_int|0xa4
comma
l_int|0xa5
comma
l_int|0xa6
comma
l_int|0xa7
comma
l_int|0xa8
comma
l_int|0xa9
comma
l_int|0xaa
comma
l_int|0xb2
comma
l_int|0xb3
comma
l_int|0xb4
comma
l_int|0xb5
comma
l_int|0xb6
comma
l_int|0xb7
comma
l_int|0xb8
comma
l_int|0xb9
comma
l_int|0xba
comma
l_int|0xc2
comma
l_int|0xc3
comma
l_int|0xc4
comma
l_int|0xc5
comma
l_int|0xc6
comma
l_int|0xc7
comma
l_int|0xc8
comma
l_int|0xc9
comma
l_int|0xca
comma
l_int|0xd2
comma
l_int|0xd3
comma
l_int|0xd4
comma
l_int|0xd5
comma
l_int|0xd6
comma
l_int|0xd7
comma
l_int|0xd8
comma
l_int|0xd9
comma
l_int|0xda
comma
l_int|0xe2
comma
l_int|0xe3
comma
l_int|0xe4
comma
l_int|0xe5
comma
l_int|0xe6
comma
l_int|0xe7
comma
l_int|0xe8
comma
l_int|0xe9
comma
l_int|0xea
comma
l_int|0xf2
comma
l_int|0xf3
comma
l_int|0xf4
comma
l_int|0xf5
comma
l_int|0xf6
comma
l_int|0xf7
comma
l_int|0xf8
comma
l_int|0xf9
comma
l_int|0xfa
)brace
suffix:semicolon
multiline_comment|/* write fixed Huffman tables */
id|adr
op_assign
l_int|0x1d4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dht
)paren
suffix:semicolon
op_increment
id|i
)paren
(brace
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|adr
op_increment
comma
id|dht
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|zr36060_set_jpg_APP
r_static
r_void
id|zr36060_set_jpg_APP
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|adr
suffix:semicolon
r_int
id|len
comma
id|i
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|len
op_assign
id|zr-&gt;params.APP_len
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|60
)paren
id|len
op_assign
l_int|60
suffix:semicolon
id|i
op_assign
id|zr-&gt;params.APPn
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|15
)paren
id|i
op_assign
l_int|15
suffix:semicolon
id|reg
op_assign
l_int|0xffe0
op_plus
id|i
suffix:semicolon
multiline_comment|/* APPn marker */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x380
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* APPn len */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x382
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* write APPn data */
id|adr
op_assign
l_int|0x384
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|60
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|adr
op_increment
comma
(paren
id|i
OL
id|len
ques
c_cond
id|zr-&gt;params.APP_data
(braket
id|i
)braket
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|zr36060_set_jpg_COM
r_static
r_void
id|zr36060_set_jpg_COM
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|adr
suffix:semicolon
r_int
id|len
comma
id|i
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|len
op_assign
id|zr-&gt;params.COM_len
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|60
)paren
id|len
op_assign
l_int|60
suffix:semicolon
id|reg
op_assign
l_int|0xfffe
suffix:semicolon
multiline_comment|/* COM marker */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x3c0
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* COM len */
id|zr36060_write_16
c_func
(paren
id|zr
comma
l_int|0x3c2
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* write COM data */
id|adr
op_assign
l_int|0x3c4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|60
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr36060_write_8
c_func
(paren
id|zr
comma
id|adr
op_increment
comma
(paren
id|i
OL
id|len
ques
c_cond
id|zr-&gt;params.COM_data
(braket
id|i
)braket
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|zr36060_set_cap
r_static
r_void
id|zr36060_set_cap
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|zr36060_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|reg
op_assign
(paren
l_int|0
op_lshift
l_int|7
)paren
multiline_comment|/* Load=0 */
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SynRst=1 */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x000
comma
id|reg
)paren
suffix:semicolon
id|zr36060_set_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
id|zr36060_set_video
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
id|zr36060_set_jpg_SOF
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36060_set_jpg_SOS
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36060_set_jpg_DRI
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36060_set_jpg_DQT
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36060_set_jpg_DHT
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36060_set_jpg_APP
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36060_set_jpg_COM
c_func
(paren
id|zr
)paren
suffix:semicolon
id|reg
op_assign
(paren
l_int|1
op_lshift
l_int|7
)paren
multiline_comment|/* Load=1 */
op_or
(paren
l_int|0
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SynRst=0 */
id|zr36060_write_8
c_func
(paren
id|zr
comma
l_int|0x000
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* wait for codec to unbusy */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
op_increment
id|i
)paren
(brace
id|reg
op_assign
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x001
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_amp
(paren
l_int|1
op_lshift
l_int|7
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;060: loaded, loops=%u&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;060: stuck busy, statux=%02x&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|zr36057_set_jpg
r_static
r_void
id|zr36057_set_jpg
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tvn
op_assign
op_amp
id|tvnorms
(braket
id|zr-&gt;params.norm
)braket
suffix:semicolon
multiline_comment|/* assert P_Reset */
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_JPC
)paren
suffix:semicolon
multiline_comment|/* re-initialize DMA ring stuff */
id|zr-&gt;jpg_que_head
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_dma_head
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_dma_tail
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_que_tail
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_seq_num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BUZ_NUM_STAT_COM
suffix:semicolon
op_increment
id|i
)paren
(brace
id|zr-&gt;stat_com
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* mark as unavailable to zr36057 */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zr-&gt;jpg_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
multiline_comment|/* nothing going on */
)brace
multiline_comment|/* MJPEG compression mode */
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
r_default
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_MJPGCmpMode
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_MJPGExpMode
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_JMC_SyncMstr
suffix:semicolon
multiline_comment|/* RJ: The following is experimental - improves the output to screen */
r_if
c_cond
(paren
id|zr-&gt;params.VFIFO_FB
)paren
id|reg
op_or_assign
id|ZR36057_JMC_VFIFO_FB
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_STILL_COMPRESS
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_JPGCmpMode
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_STILL_DECOMPRESS
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_JPGExpMode
suffix:semicolon
r_break
suffix:semicolon
)brace
id|reg
op_or_assign
id|ZR36057_JMC_JPG
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;params.field_per_buff
op_eq
l_int|1
)paren
id|reg
op_or_assign
id|ZR36057_JMC_Fld_per_buff
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JMC
)paren
suffix:semicolon
multiline_comment|/* vertical */
id|btor
c_func
(paren
id|ZR36057_VFEVCR_VSPol
comma
id|ZR36057_VFEVCR
)paren
suffix:semicolon
id|reg
op_assign
(paren
l_int|6
op_lshift
id|ZR36057_VSP_VsyncSize
)paren
op_or
(paren
id|tvn-&gt;Ht
op_lshift
id|ZR36057_VSP_FrmTot
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VSP
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|zr-&gt;params.img_y
op_plus
id|tvn-&gt;VStart
)paren
op_lshift
id|ZR36057_FVAP_NAY
)paren
op_or
(paren
id|zr-&gt;params.img_height
op_lshift
id|ZR36057_FVAP_PAY
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_FVAP
)paren
suffix:semicolon
multiline_comment|/* horizontal */
id|btor
c_func
(paren
id|ZR36057_VFEHCR_HSPol
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|tvn-&gt;Wt
op_minus
l_int|100
)paren
op_lshift
id|ZR36057_HSP_HsyncStart
)paren
op_or
(paren
id|tvn-&gt;Wt
op_lshift
id|ZR36057_HSP_LineTot
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_HSP
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|zr-&gt;params.img_x
op_plus
id|tvn-&gt;HStart
)paren
op_lshift
id|ZR36057_FHAP_NAX
)paren
op_or
(paren
id|zr-&gt;params.img_width
op_lshift
id|ZR36057_FHAP_PAX
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_FHAP
)paren
suffix:semicolon
multiline_comment|/* field process parameters */
r_if
c_cond
(paren
id|zr-&gt;params.odd_even
)paren
id|reg
op_assign
id|ZR36057_FPP_Odd_Even
suffix:semicolon
r_else
id|reg
op_assign
l_int|0
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_FPP
)paren
suffix:semicolon
multiline_comment|/* Set proper VCLK Polarity, else colors will be wrong during playback */
id|btor
c_func
(paren
id|ZR36057_VFESPFR_VCLKPol
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
multiline_comment|/* code base address and FIFO threshold */
id|reg
op_assign
id|virt_to_bus
c_func
(paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JCBA
)paren
suffix:semicolon
id|reg
op_assign
l_int|0x50
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JCFT
)paren
suffix:semicolon
multiline_comment|/* JPEG codec guest ID */
id|reg
op_assign
(paren
l_int|1
op_lshift
id|ZR36057_JCGI_JPEGuestID
)paren
op_or
(paren
l_int|0
op_lshift
id|ZR36057_JCGI_JPEGuestReg
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JCGI
)paren
suffix:semicolon
multiline_comment|/* Code transfer guest ID */
id|reg
op_assign
(paren
l_int|0
op_lshift
id|ZR36057_MCTCR_CodGuestID
)paren
op_or
(paren
l_int|3
op_lshift
id|ZR36057_MCTCR_CodGuestReg
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_MCTCR_CFlush
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
multiline_comment|/* deassert P_Reset */
id|btwrite
c_func
(paren
id|ZR36057_JPC_P_Reset
comma
id|ZR36057_JPC
)paren
suffix:semicolon
)brace
DECL|function|zr36057_enable_jpg
r_static
r_void
id|zr36057_enable_jpg
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_static
r_int
id|zero
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|one
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
id|zr36060_set_cap
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
id|zr36057_set_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|one
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEOENCODER
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
multiline_comment|/* deassert P_Reset, assert Code transfer enable */
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEOENCODER
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|one
)paren
suffix:semicolon
id|zr36060_set_cap
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
id|zr36057_set_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
multiline_comment|/* deassert P_Reset, assert Code transfer enable */
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_IDLE
suffix:colon
r_default
suffix:colon
multiline_comment|/* shut down processing */
id|btor
c_func
(paren
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|ZR36057_JPC_P_Reset
comma
id|ZR36057_JPC
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_VFIFO_FB
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_SyncMstr
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_Go_en
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|zr36060_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|one
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEOENCODER
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|zr-&gt;codec_mode
op_assign
id|mode
suffix:semicolon
)brace
multiline_comment|/*&n; *   Queue a MJPEG buffer for capture/playback&n; */
DECL|function|jpg_qbuf
r_static
r_int
id|jpg_qbuf
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|frame
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|res
suffix:semicolon
multiline_comment|/* Check if buffers are allocated */
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;jpg_buffers_allocated
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: jpg_qbuf: buffers not yet allocated&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Does the user want to stop streaming? */
r_if
c_cond
(paren
id|frame
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|mode
)paren
(brace
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: jpg_qbuf - stop streaming but not in streaming mode&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* No grabbing outside the buffer range! */
r_if
c_cond
(paren
id|frame
op_ge
id|zr-&gt;jpg_nbufs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: jpg_qbuf: buffer %d out of range&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|frame
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* what is the codec mode right now? */
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_IDLE
)paren
(brace
multiline_comment|/* Ok load up the zr36060 and go */
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|mode
)paren
(brace
multiline_comment|/* wrong codec mode active - invalid */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: jpg_qbuf - codec in wrong mode&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* make sure a grab isn&squot;t going on currently with this buffer */
r_switch
c_cond
(paren
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|state
)paren
(brace
r_default
suffix:colon
r_case
id|BUZ_STATE_DMA
suffix:colon
r_case
id|BUZ_STATE_PEND
suffix:colon
r_case
id|BUZ_STATE_DONE
suffix:colon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* what are you doing? */
r_break
suffix:semicolon
r_case
id|BUZ_STATE_USER
suffix:colon
multiline_comment|/* since there is at least one unused buffer there&squot;s room for at least one more pend[] entry */
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_que_head
op_increment
op_amp
id|BUZ_MASK_FRAME
)braket
op_assign
id|frame
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_PEND
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Start the zr36060 when the first frame is queued  */
r_if
c_cond
(paren
id|zr-&gt;jpg_que_head
op_eq
l_int|1
)paren
(brace
id|btor
c_func
(paren
id|ZR36057_JMC_Go_en
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|ZR36057_JPC_P_Reset
op_or
id|ZR36057_JPC_CodTrnsEn
op_or
id|ZR36057_JPC_Active
comma
id|ZR36057_JPC
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; *   Sync on a MJPEG buffer&n; */
DECL|function|jpg_sync
r_static
r_int
id|jpg_sync
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_struct
id|zoran_sync
op_star
id|bs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|frame
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_MOTION_DECOMPRESS
op_logical_and
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|zr-&gt;jpg_que_tail
op_eq
id|zr-&gt;jpg_dma_tail
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_que_tail
op_increment
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
multiline_comment|/* buffer should now be in BUZ_STATE_DONE */
r_if
c_cond
(paren
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|state
op_ne
id|BUZ_STATE_DONE
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: jpg_sync - internal error&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
op_star
id|bs
op_assign
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|bs
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* when this is called the spinlock must be held */
DECL|function|zoran_feed_stat_com
r_static
r_void
id|zoran_feed_stat_com
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
multiline_comment|/* move frames from pending queue to DMA */
r_int
id|frame
comma
id|i
comma
id|max_stat_com
suffix:semicolon
id|max_stat_com
op_assign
(paren
id|zr-&gt;params.TmpDcm
op_eq
l_int|1
)paren
ques
c_cond
id|BUZ_NUM_STAT_COM
suffix:colon
(paren
id|BUZ_NUM_STAT_COM
op_rshift
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|zr-&gt;jpg_dma_head
op_minus
id|zr-&gt;jpg_dma_tail
)paren
OL
id|max_stat_com
op_logical_and
id|zr-&gt;jpg_dma_head
op_ne
id|zr-&gt;jpg_que_head
)paren
(brace
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_dma_head
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;params.TmpDcm
op_eq
l_int|1
)paren
(brace
multiline_comment|/* fill 1 stat_com entry */
id|i
op_assign
id|zr-&gt;jpg_dma_head
op_amp
id|BUZ_MASK_STAT_COM
suffix:semicolon
id|zr-&gt;stat_com
(braket
id|i
)braket
op_assign
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|frag_tab_bus
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fill 2 stat_com entries */
id|i
op_assign
(paren
id|zr-&gt;jpg_dma_head
op_amp
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
id|zr-&gt;stat_com
(braket
id|i
)braket
op_assign
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|frag_tab_bus
suffix:semicolon
id|zr-&gt;stat_com
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|frag_tab_bus
suffix:semicolon
)brace
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_DMA
suffix:semicolon
id|zr-&gt;jpg_dma_head
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* when this is called the spinlock must be held */
DECL|function|zoran_reap_stat_com
r_static
r_void
id|zoran_reap_stat_com
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
multiline_comment|/* move frames from DMA queue to done queue */
r_int
id|i
suffix:semicolon
id|u32
id|stat_com
suffix:semicolon
r_int
r_int
id|seq
suffix:semicolon
r_int
r_int
id|dif
suffix:semicolon
r_int
id|frame
suffix:semicolon
r_struct
id|zoran_gbuffer
op_star
id|gbuf
suffix:semicolon
multiline_comment|/* In motion decompress we don&squot;t have a hardware frame counter,&n;&t;   we just count the interrupts here */
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
id|zr-&gt;jpg_seq_num
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|zr-&gt;jpg_dma_tail
op_ne
id|zr-&gt;jpg_dma_head
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;params.TmpDcm
op_eq
l_int|1
)paren
id|i
op_assign
id|zr-&gt;jpg_dma_tail
op_amp
id|BUZ_MASK_STAT_COM
suffix:semicolon
r_else
id|i
op_assign
(paren
id|zr-&gt;jpg_dma_tail
op_amp
l_int|1
)paren
op_star
l_int|2
op_plus
l_int|1
suffix:semicolon
id|stat_com
op_assign
id|zr-&gt;stat_com
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat_com
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_dma_tail
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
id|gbuf
op_assign
op_amp
id|zr-&gt;jpg_gbuf
(braket
id|frame
)braket
suffix:semicolon
id|get_fast_time
c_func
(paren
op_amp
id|gbuf-&gt;bs.timestamp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
id|gbuf-&gt;bs.length
op_assign
(paren
id|stat_com
op_amp
l_int|0x7fffff
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* update sequence number with the help of the counter in stat_com */
id|seq
op_assign
id|stat_com
op_rshift
l_int|24
suffix:semicolon
id|dif
op_assign
(paren
id|seq
op_minus
id|zr-&gt;jpg_seq_num
)paren
op_amp
l_int|0xff
suffix:semicolon
id|zr-&gt;jpg_seq_num
op_add_assign
id|dif
suffix:semicolon
)brace
r_else
(brace
id|gbuf-&gt;bs.length
op_assign
l_int|0
suffix:semicolon
)brace
id|gbuf-&gt;bs.seq
op_assign
id|zr-&gt;params.TmpDcm
op_eq
l_int|2
ques
c_cond
(paren
id|zr-&gt;jpg_seq_num
op_rshift
l_int|1
)paren
suffix:colon
id|zr-&gt;jpg_seq_num
suffix:semicolon
id|gbuf-&gt;state
op_assign
id|BUZ_STATE_DONE
suffix:semicolon
id|zr-&gt;jpg_dma_tail
op_increment
suffix:semicolon
)brace
)brace
DECL|function|zoran_irq
r_static
r_void
id|zoran_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|stat
comma
id|astat
suffix:semicolon
r_int
id|count
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|dev_id
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* get/clear interrupt status bits */
id|stat
op_assign
id|btread
c_func
(paren
id|ZR36057_ISR
)paren
suffix:semicolon
id|astat
op_assign
id|stat
op_amp
id|IRQ_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|astat
)paren
(brace
r_break
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|astat
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
id|BUZ_DEBUG
l_string|&quot;-%u: astat %08x stat %08x&bslash;n&quot;
comma
id|zr-&gt;id
comma
id|astat
comma
id|stat
)paren
)paren
suffix:semicolon
macro_line|#if (IRQ_MASK &amp; ZR36057_ISR_GIRQ0)
r_if
c_cond
(paren
id|astat
op_amp
id|ZR36057_ISR_GIRQ0
)paren
(brace
multiline_comment|/* Interrupts may still happen when zr-&gt;v4l_memgrab_active is switched off.&n;&t;&t;&t;   We simply ignore them */
r_if
c_cond
(paren
id|zr-&gt;v4l_memgrab_active
)paren
(brace
multiline_comment|/* A lot more checks should be here ... */
r_if
c_cond
(paren
(paren
id|btread
c_func
(paren
id|ZR36057_VSSFGR
)paren
op_amp
id|ZR36057_VSSFGR_SnapShot
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: BuzIRQ with SnapShot off ???&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_grab_frame
op_ne
id|NO_GRAB_ACTIVE
)paren
(brace
multiline_comment|/* There is a grab on a frame going on, check if it has finished */
r_if
c_cond
(paren
(paren
id|btread
c_func
(paren
id|ZR36057_VSSFGR
)paren
op_amp
id|ZR36057_VSSFGR_FrameGrab
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* it is finished, notify the user */
id|zr-&gt;v4l_gbuf
(braket
id|zr-&gt;v4l_grab_frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_DONE
suffix:semicolon
id|zr-&gt;v4l_grab_frame
op_assign
id|NO_GRAB_ACTIVE
suffix:semicolon
id|zr-&gt;v4l_grab_seq
op_increment
suffix:semicolon
id|zr-&gt;v4l_pend_tail
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|zr-&gt;v4l_grab_frame
op_eq
id|NO_GRAB_ACTIVE
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
multiline_comment|/* Check if there is another grab queued */
r_if
c_cond
(paren
id|zr-&gt;v4l_grab_frame
op_eq
id|NO_GRAB_ACTIVE
op_logical_and
id|zr-&gt;v4l_pend_tail
op_ne
id|zr-&gt;v4l_pend_head
)paren
(brace
r_int
id|frame
op_assign
id|zr-&gt;v4l_pend
(braket
id|zr-&gt;v4l_pend_tail
op_amp
id|V4L_MASK_FRAME
)braket
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|zr-&gt;v4l_grab_frame
op_assign
id|frame
suffix:semicolon
multiline_comment|/* Set zr36057 video front end and enable video */
multiline_comment|/* Buffer address */
id|reg
op_assign
id|zr-&gt;v4l_gbuf
(braket
id|frame
)braket
dot
id|fbuffer_bus
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;video_interlace
)paren
id|reg
op_add_assign
id|zr-&gt;gbpl
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDBR
)paren
suffix:semicolon
multiline_comment|/* video stride, status, and frame grab register */
macro_line|#ifdef XAWTV_HACK
id|reg
op_assign
(paren
id|zr-&gt;gwidth
OG
l_int|720
)paren
ques
c_cond
(paren
(paren
id|zr-&gt;gwidth
op_amp
op_complement
l_int|3
)paren
op_minus
l_int|720
)paren
op_star
id|zr-&gt;gbpl
op_div
id|zr-&gt;gwidth
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
id|reg
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|zr-&gt;video_interlace
)paren
id|reg
op_add_assign
id|zr-&gt;gbpl
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_lshift
id|ZR36057_VSSFGR_DispStride
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_VidOvf
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_SnapShot
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_FrameGrab
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
id|btor
c_func
(paren
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* (IRQ_MASK &amp; ZR36057_ISR_GIRQ0) */
macro_line|#if (IRQ_MASK &amp; ZR36057_ISR_GIRQ1)
r_if
c_cond
(paren
id|astat
op_amp
id|ZR36057_ISR_GIRQ1
)paren
(brace
r_int
id|csr
op_assign
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x001
)paren
suffix:semicolon
r_int
id|isr
op_assign
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x008
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: ZR36057_ISR_GIRQ1 60_code=%02x 60_intr=%02x&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|csr
comma
id|isr
)paren
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_GIRQ1
comma
id|ZR36057_ICR
)paren
suffix:semicolon
id|zoran_reap_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* (IRQ_MASK &amp; ZR36057_ISR_GIRQ1) */
macro_line|#if (IRQ_MASK &amp; ZR36057_ISR_CodRepIRQ)
r_if
c_cond
(paren
id|astat
op_amp
id|ZR36057_ISR_CodRepIRQ
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: ZR36057_ISR_CodRepIRQ&bslash;n&quot;
comma
id|zr-&gt;name
)paren
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_CodRepIRQ
comma
id|ZR36057_ICR
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* (IRQ_MASK &amp; ZR36057_ISR_CodRepIRQ) */
macro_line|#if (IRQ_MASK &amp; ZR36057_ISR_JPEGRepIRQ)
r_if
c_cond
(paren
(paren
id|astat
op_amp
id|ZR36057_ISR_JPEGRepIRQ
)paren
op_logical_and
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
op_logical_or
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
)paren
(brace
id|zoran_reap_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* (IRQ_MASK &amp; ZR36057_ISR_JPEGRepIRQ) */
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: irq loop %d&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_ICR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: IRQ lockup, cleared int mask&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Check a zoran_params struct for correctness, insert default params */
DECL|function|zoran_check_params
r_static
r_int
id|zoran_check_params
c_func
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_struct
id|zoran_params
op_star
id|params
)paren
(brace
r_int
id|err
op_assign
l_int|0
comma
id|err0
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insert constant params */
id|params-&gt;major_version
op_assign
id|MAJOR_VERSION
suffix:semicolon
id|params-&gt;minor_version
op_assign
id|MINOR_VERSION
suffix:semicolon
multiline_comment|/* Check input and norm */
r_if
c_cond
(paren
id|params-&gt;input
op_ne
l_int|0
op_logical_and
id|params-&gt;input
op_ne
l_int|1
)paren
(brace
id|err
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|params-&gt;norm
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|params-&gt;norm
op_ne
id|VIDEO_MODE_NTSC
)paren
(brace
id|err
op_increment
suffix:semicolon
)brace
multiline_comment|/* Check decimation, set default values for decimation = 1, 2, 4 */
r_switch
c_cond
(paren
id|params-&gt;decimation
)paren
(brace
r_case
l_int|1
suffix:colon
id|params-&gt;HorDcm
op_assign
l_int|1
suffix:semicolon
id|params-&gt;VerDcm
op_assign
l_int|1
suffix:semicolon
id|params-&gt;TmpDcm
op_assign
l_int|1
suffix:semicolon
id|params-&gt;field_per_buff
op_assign
l_int|2
suffix:semicolon
id|params-&gt;img_x
op_assign
l_int|0
suffix:semicolon
id|params-&gt;img_y
op_assign
l_int|0
suffix:semicolon
id|params-&gt;img_width
op_assign
l_int|720
suffix:semicolon
id|params-&gt;img_height
op_assign
id|tvnorms
(braket
id|params-&gt;norm
)braket
dot
id|Ha
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|params-&gt;HorDcm
op_assign
l_int|2
suffix:semicolon
id|params-&gt;VerDcm
op_assign
l_int|1
suffix:semicolon
id|params-&gt;TmpDcm
op_assign
l_int|2
suffix:semicolon
id|params-&gt;field_per_buff
op_assign
l_int|1
suffix:semicolon
id|params-&gt;img_x
op_assign
l_int|8
suffix:semicolon
id|params-&gt;img_y
op_assign
l_int|0
suffix:semicolon
id|params-&gt;img_width
op_assign
l_int|704
suffix:semicolon
id|params-&gt;img_height
op_assign
id|tvnorms
(braket
id|params-&gt;norm
)braket
dot
id|Ha
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|params-&gt;HorDcm
op_assign
l_int|4
suffix:semicolon
id|params-&gt;VerDcm
op_assign
l_int|2
suffix:semicolon
id|params-&gt;TmpDcm
op_assign
l_int|2
suffix:semicolon
id|params-&gt;field_per_buff
op_assign
l_int|1
suffix:semicolon
id|params-&gt;img_x
op_assign
l_int|8
suffix:semicolon
id|params-&gt;img_y
op_assign
l_int|0
suffix:semicolon
id|params-&gt;img_width
op_assign
l_int|704
suffix:semicolon
id|params-&gt;img_height
op_assign
id|tvnorms
(braket
id|params-&gt;norm
)braket
dot
id|Ha
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* We have to check the data the user has set */
r_if
c_cond
(paren
id|params-&gt;HorDcm
op_ne
l_int|1
op_logical_and
id|params-&gt;HorDcm
op_ne
l_int|2
op_logical_and
id|params-&gt;HorDcm
op_ne
l_int|4
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;VerDcm
op_ne
l_int|1
op_logical_and
id|params-&gt;VerDcm
op_ne
l_int|2
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;TmpDcm
op_ne
l_int|1
op_logical_and
id|params-&gt;TmpDcm
op_ne
l_int|2
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;field_per_buff
op_ne
l_int|1
op_logical_and
id|params-&gt;field_per_buff
op_ne
l_int|2
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_x
OL
l_int|0
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_y
OL
l_int|0
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_width
OL
l_int|0
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_height
OL
l_int|0
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_x
op_plus
id|params-&gt;img_width
OG
l_int|720
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_y
op_plus
id|params-&gt;img_height
OG
id|tvnorms
(braket
id|params-&gt;norm
)braket
dot
id|Ha
op_div
l_int|2
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_width
op_mod
(paren
l_int|16
op_star
id|params-&gt;HorDcm
)paren
op_ne
l_int|0
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;img_height
op_mod
(paren
l_int|8
op_star
id|params-&gt;VerDcm
)paren
op_ne
l_int|0
)paren
id|err0
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err0
)paren
(brace
id|err
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|params-&gt;quality
OG
l_int|100
)paren
id|params-&gt;quality
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;quality
OL
l_int|5
)paren
id|params-&gt;quality
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;APPn
OL
l_int|0
)paren
id|params-&gt;APPn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;APPn
OG
l_int|15
)paren
id|params-&gt;APPn
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;APP_len
OL
l_int|0
)paren
id|params-&gt;APP_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;APP_len
OG
l_int|60
)paren
id|params-&gt;APP_len
op_assign
l_int|60
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;COM_len
OL
l_int|0
)paren
id|params-&gt;COM_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;COM_len
OG
l_int|60
)paren
id|params-&gt;COM_len
op_assign
l_int|60
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|zoran_open_init_params
r_static
r_void
id|zoran_open_init_params
c_func
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Per default, map the V4L Buffers */
id|zr-&gt;map_mjpeg_buffers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* User must explicitly set a window */
id|zr-&gt;window_set
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.x
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.y
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.width
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.height
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.chromakey
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.flags
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.clips
op_assign
l_int|NULL
suffix:semicolon
id|zr-&gt;window.clipcount
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;video_interlace
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_memgrab_active
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_overlay_active
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_grab_frame
op_assign
id|NO_GRAB_ACTIVE
suffix:semicolon
id|zr-&gt;v4l_grab_seq
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;gwidth
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;gheight
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;gformat
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;gbpl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DMA ring stuff for V4L */
id|zr-&gt;v4l_pend_tail
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_pend_head
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v4l_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
multiline_comment|/* nothing going on */
)brace
multiline_comment|/* Set necessary params and call zoran_check_params to set the defaults */
id|zr-&gt;params.decimation
op_assign
l_int|1
suffix:semicolon
id|zr-&gt;params.quality
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* default compression factor 8 */
id|zr-&gt;params.odd_even
op_assign
l_int|1
suffix:semicolon
id|zr-&gt;params.APPn
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;params.APP_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No APPn marker */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|60
suffix:semicolon
id|i
op_increment
)paren
id|zr-&gt;params.APP_data
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;params.COM_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No COM marker */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|60
suffix:semicolon
id|i
op_increment
)paren
id|zr-&gt;params.COM_data
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;params.VFIFO_FB
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|zr-&gt;params.reserved
comma
l_int|0
comma
r_sizeof
(paren
id|zr-&gt;params.reserved
)paren
)paren
suffix:semicolon
id|zr-&gt;params.jpeg_markers
op_assign
id|JPEG_MARKER_DHT
op_or
id|JPEG_MARKER_DQT
suffix:semicolon
id|i
op_assign
id|zoran_check_params
c_func
(paren
id|zr
comma
op_amp
id|zr-&gt;params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: zoran_open_init_params internal error&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *   Open a buz card. Right now the flags stuff is just playing&n; */
DECL|function|zoran_open
r_static
r_int
id|zoran_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|dev
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;: zoran_open&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|flags
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|zr-&gt;user
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|zr-&gt;user
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|v4l_fbuffer_alloc
c_func
(paren
id|zr
)paren
OL
l_int|0
)paren
(brace
id|zr-&gt;user
op_decrement
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* default setup */
id|zoran_open_init_params
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
singleline_comment|// Clears interrupts
id|btor
c_func
(paren
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|zoran_close
r_static
r_void
id|zoran_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|dev
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;: zoran_close&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
multiline_comment|/* wake up sleeping beauties */
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_overlay_active
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;user
op_decrement
suffix:semicolon
id|v4l_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
id|jpg_fbuffer_free
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr-&gt;jpg_nbufs
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;: zoran_close done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|zoran_read
r_static
r_int
id|zoran_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|zoran_write
r_static
r_int
id|zoran_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; *   ioctl routine&n; */
DECL|function|zoran_ioctl
r_static
r_int
id|zoran_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGCAP&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|b.name
comma
id|zr-&gt;video_dev.name
comma
r_sizeof
(paren
id|b.name
)paren
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_CLIPPING
op_or
id|VID_TYPE_FRAMERAM
op_or
id|VID_TYPE_SCALES
suffix:semicolon
multiline_comment|/* theoretically we could also flag VID_TYPE_SUBCAPTURE&n;&t;&t;&t;   but this is not even implemented in the BTTV driver */
id|b.channels
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* composite, svhs */
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
id|b.maxheight
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
id|b.minwidth
op_assign
id|BUZ_MIN_WIDTH
suffix:semicolon
id|b.minheight
op_assign
id|BUZ_MIN_HEIGHT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGCHAN for channel %d&bslash;n&quot;
comma
id|v.channel
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|v.channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Composite&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;SVHS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|v.norm
op_assign
id|zr-&gt;params.norm
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* RJ: the documentation at http://roadrunner.swansea.linux.org.uk/v4lapi.shtml says:&n;&n;&t;&t; * &quot;The VIDIOCSCHAN ioctl takes an integer argument and switches the capture to this input.&quot;&n;&t;&t; *                                 ^^^^^^^&n;&t;&t; * The famos BTTV driver has it implemented with a struct video_channel argument&n;&t;&t; * and we follow it for compatibility reasons&n;&t;&t; *&n;&t;&t; * BTW: this is the only way the user can set the norm!&n;&t;&t; */
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_int
id|input
suffix:semicolon
r_int
id|on
comma
id|res
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCSCHAN: channel=%d, norm=%d&bslash;n&quot;
comma
id|v.channel
comma
id|v.norm
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|v.channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|input
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|input
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.norm
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|v.norm
op_ne
id|VIDEO_MODE_NTSC
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|zr-&gt;params.norm
op_assign
id|v.norm
suffix:semicolon
id|zr-&gt;params.input
op_assign
id|v.channel
suffix:semicolon
multiline_comment|/* We switch overlay off and on since a change in the norm&n;&t;&t;&t;   needs different VFE settings */
id|on
op_assign
id|zr-&gt;v4l_overlay_active
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_INPUT
comma
op_amp
id|input
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEOENCODER
comma
id|ENCODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Make sure the changes come into effect */
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
r_case
id|VIDIOCSTUNER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
op_assign
id|zr-&gt;picture
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGPICT&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|p.depth
op_assign
id|zr-&gt;buffer.depth
suffix:semicolon
r_switch
c_cond
(paren
id|zr-&gt;buffer.depth
)paren
(brace
r_case
l_int|15
suffix:colon
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB555
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB565
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB32
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_PICTURE
comma
op_amp
id|p
)paren
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCSPICT bri=%d hue=%d col=%d con=%d dep=%d pal=%d&bslash;n&quot;
comma
id|p.brightness
comma
id|p.hue
comma
id|p.colour
comma
id|p.contrast
comma
id|p.depth
comma
id|p.palette
)paren
)paren
suffix:semicolon
multiline_comment|/* The depth and palette values have no meaning to us,&n;&t;&t;&t;   should we return  -EINVAL if they don&squot;t fit ? */
id|zr-&gt;picture
op_assign
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
r_int
id|v
comma
id|res
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCCAPTURE: %d&bslash;n&quot;
comma
id|v
)paren
)paren
suffix:semicolon
multiline_comment|/* If there is nothing to do, return immediatly */
r_if
c_cond
(paren
(paren
id|v
op_logical_and
id|zr-&gt;v4l_overlay_active
)paren
op_logical_or
(paren
op_logical_neg
id|v
op_logical_and
op_logical_neg
id|zr-&gt;v4l_overlay_active
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
l_int|0
)paren
(brace
id|zr-&gt;v4l_overlay_active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* When a grab is running, the video simply won&squot;t be switched on any more */
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;buffer_set
op_logical_or
op_logical_neg
id|zr-&gt;window_set
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|zr-&gt;v4l_overlay_active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* When a grab is running, the video will be switched on when grab is finished */
)brace
multiline_comment|/* Make sure the changes come into effect */
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGWIN&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|zr-&gt;window
comma
r_sizeof
(paren
id|zr-&gt;window
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_clip
op_star
id|vcp
suffix:semicolon
r_struct
id|video_window
id|vw
suffix:semicolon
r_int
id|on
comma
id|end
comma
id|res
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCSWIN: x=%d y=%d w=%d h=%d clipcount=%d&bslash;n&quot;
comma
id|vw.x
comma
id|vw.y
comma
id|vw.width
comma
id|vw.height
comma
id|vw.clipcount
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;buffer_set
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * The video front end needs 4-byte alinged line sizes, we correct that&n;&t;&t;&t; * silently here if necessary&n;&t;&t;&t; */
r_if
c_cond
(paren
id|zr-&gt;buffer.depth
op_eq
l_int|15
op_logical_or
id|zr-&gt;buffer.depth
op_eq
l_int|16
)paren
(brace
id|end
op_assign
(paren
id|vw.x
op_plus
id|vw.width
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
multiline_comment|/* round down */
id|vw.x
op_assign
(paren
id|vw.x
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
multiline_comment|/* round up */
id|vw.width
op_assign
id|end
op_minus
id|vw.x
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;buffer.depth
op_eq
l_int|24
)paren
(brace
id|end
op_assign
(paren
id|vw.x
op_plus
id|vw.width
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* round down */
id|vw.x
op_assign
(paren
id|vw.x
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* round up */
id|vw.width
op_assign
id|end
op_minus
id|vw.x
suffix:semicolon
)brace
macro_line|#if 0
singleline_comment|// At least xawtv seems to care about the following - just leave it away
multiline_comment|/*&n;&t;&t;&t; * Also corrected silently (as long as window fits at all):&n;&t;&t;&t; * video not fitting the screen&n;&t;&t;&t; */
macro_line|#if 0
r_if
c_cond
(paren
id|vw.x
template_param
id|zr-&gt;buffer.height
)paren
(brace
id|printk
c_func
(paren
id|BUZ_ERR
l_string|&quot;: VIDIOCSWIN: window does not fit frame buffer: %dx%d+%d*%d&bslash;n&quot;
comma
id|vw.width
comma
id|vw.height
comma
id|vw.x
comma
id|vw.y
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|vw.x
OL
l_int|0
)paren
id|vw.x
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vw.y
OL
l_int|0
)paren
id|vw.y
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vw.x
op_plus
id|vw.width
OG
id|zr-&gt;buffer.width
)paren
id|vw.width
op_assign
id|zr-&gt;buffer.width
op_minus
id|vw.x
suffix:semicolon
r_if
c_cond
(paren
id|vw.y
op_plus
id|vw.height
OG
id|zr-&gt;buffer.height
)paren
id|vw.height
op_assign
id|zr-&gt;buffer.height
op_minus
id|vw.y
suffix:semicolon
macro_line|#endif
macro_line|#endif
multiline_comment|/* Check for vaild parameters */
r_if
c_cond
(paren
id|vw.width
template_param
id|BUZ_MAX_HEIGHT
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef XAWTV_HACK
r_if
c_cond
(paren
id|vw.width
OG
l_int|720
)paren
id|vw.width
op_assign
l_int|720
suffix:semicolon
macro_line|#endif
id|zr-&gt;window.x
op_assign
id|vw.x
suffix:semicolon
id|zr-&gt;window.y
op_assign
id|vw.y
suffix:semicolon
id|zr-&gt;window.width
op_assign
id|vw.width
suffix:semicolon
id|zr-&gt;window.height
op_assign
id|vw.height
suffix:semicolon
id|zr-&gt;window.chromakey
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;window.flags
op_assign
l_int|0
suffix:semicolon
singleline_comment|// RJ: Is this intended for interlace on/off ?
id|zr-&gt;window.clips
op_assign
l_int|NULL
suffix:semicolon
id|zr-&gt;window.clipcount
op_assign
id|vw.clipcount
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * If an overlay is running, we have to switch it off&n;&t;&t;&t; * and switch it on again in order to get the new settings in effect.&n;&t;&t;&t; *&n;&t;&t;&t; * We also want to avoid that the overlay mask is written&n;&t;&t;&t; * when an overlay is running.&n;&t;&t;&t; */
id|on
op_assign
id|zr-&gt;v4l_overlay_active
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *   Write the overlay mask if clips are wanted.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|vw.clipcount
)paren
(brace
id|vcp
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
(paren
id|vw.clipcount
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcp
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|vcp
comma
id|vw.clips
comma
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
id|vw.clipcount
)paren
)paren
(brace
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|write_overlay_mask
c_func
(paren
id|zr
comma
id|vcp
comma
id|vw.clipcount
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|zr-&gt;window_set
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Make sure the changes come into effect */
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGFBUF&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|zr-&gt;buffer
comma
r_sizeof
(paren
id|zr-&gt;buffer
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCSFBUF: base=0x%x w=%d h=%d depth=%d bpl=%d&bslash;n&quot;
comma
(paren
id|u32
)paren
id|v.base
comma
id|v.width
comma
id|v.height
comma
id|v.depth
comma
id|v.bytesperline
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_overlay_active
)paren
(brace
multiline_comment|/* Has the user gotten crazy ... ? */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.depth
op_ne
l_int|15
op_logical_and
id|v.depth
op_ne
l_int|16
op_logical_and
id|v.depth
op_ne
l_int|24
op_logical_and
id|v.depth
op_ne
l_int|32
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.height
op_le
l_int|0
op_logical_or
id|v.width
op_le
l_int|0
op_logical_or
id|v.bytesperline
op_le
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.bytesperline
op_amp
l_int|3
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.base
)paren
(brace
id|zr-&gt;buffer.base
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|v.base
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
)brace
id|zr-&gt;buffer.height
op_assign
id|v.height
suffix:semicolon
id|zr-&gt;buffer.width
op_assign
id|v.width
suffix:semicolon
id|zr-&gt;buffer.depth
op_assign
id|v.depth
suffix:semicolon
id|zr-&gt;buffer.bytesperline
op_assign
id|v.bytesperline
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;buffer.base
)paren
id|zr-&gt;buffer_set
op_assign
l_int|1
suffix:semicolon
id|zr-&gt;window_set
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The user should set new window parameters */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* RJ: what is VIDIOCKEY intended to do ??? */
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCSYNC %d&bslash;n&quot;
comma
id|v
)paren
)paren
suffix:semicolon
r_return
id|v4l_sync
c_func
(paren
id|zr
comma
id|v
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCMCAPTURE frame=%d geom=%dx%d fmt=%d&bslash;n&quot;
comma
id|vm.frame
comma
id|vm.height
comma
id|vm.width
comma
id|vm.format
)paren
)paren
suffix:semicolon
r_return
id|v4l_grab
c_func
(paren
id|zr
comma
op_amp
id|vm
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
r_int
id|i
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGMBUF&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|v4l_nbufs
op_star
id|v4l_bufsize
suffix:semicolon
id|vm.frames
op_assign
id|v4l_nbufs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v4l_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vm.offsets
(braket
id|i
)braket
op_assign
id|i
op_star
id|v4l_bufsize
suffix:semicolon
)brace
multiline_comment|/* The next mmap will map the V4L buffers */
id|zr-&gt;map_mjpeg_buffers
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGUNIT
suffix:colon
(brace
r_struct
id|video_unit
id|vu
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl VIDIOCGUNIT&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|vu.video
op_assign
id|zr-&gt;video_dev.minor
suffix:semicolon
id|vu.vbi
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.radio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.audio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.teletext
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vu
comma
r_sizeof
(paren
id|vu
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * RJ: In principal we could support subcaptures for V4L grabbing.&n;&t;&t; *     Not even the famous BTTV driver has them, however.&n;&t;&t; *     If there should be a strong demand, one could consider&n;&t;&t; *     to implement them.&n;&t;&t; */
r_case
id|VIDIOCGCAPTURE
suffix:colon
r_case
id|VIDIOCSCAPTURE
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|BUZIOC_G_PARAMS
suffix:colon
(brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_G_PARAMS&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
(paren
id|zr-&gt;params
)paren
comma
r_sizeof
(paren
id|zr-&gt;params
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|BUZIOC_S_PARAMS
suffix:colon
(brace
r_struct
id|zoran_params
id|bp
suffix:semicolon
r_int
id|input
comma
id|on
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_IDLE
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bp
comma
id|arg
comma
r_sizeof
(paren
id|bp
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_S_PARAMS&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Check the params first before overwriting our internal values */
r_if
c_cond
(paren
id|zoran_check_params
c_func
(paren
id|zr
comma
op_amp
id|bp
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|zr-&gt;params
op_assign
id|bp
suffix:semicolon
multiline_comment|/* Make changes of input and norm go into effect immediatly */
multiline_comment|/* We switch overlay off and on since a change in the norm&n;&t;&t;&t;   needs different VFE settings */
id|on
op_assign
id|zr-&gt;v4l_overlay_active
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|input
op_assign
id|zr-&gt;params.input
op_eq
l_int|0
ques
c_cond
l_int|3
suffix:colon
l_int|7
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_INPUT
comma
op_amp
id|input
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEOENCODER
comma
id|ENCODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|bp
comma
r_sizeof
(paren
id|bp
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|BUZIOC_REQBUFS
suffix:colon
(brace
r_struct
id|zoran_requestbuffers
id|br
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_buffers_allocated
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|br
comma
id|arg
comma
r_sizeof
(paren
id|br
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_REQBUFS count = %lu size=%lu&bslash;n&quot;
comma
id|br.count
comma
id|br.size
)paren
)paren
suffix:semicolon
multiline_comment|/* Enforce reasonable lower and upper limits */
r_if
c_cond
(paren
id|br.count
OL
l_int|4
)paren
id|br.count
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Could be choosen smaller */
r_if
c_cond
(paren
id|br.count
OG
id|BUZ_MAX_FRAME
)paren
id|br.count
op_assign
id|BUZ_MAX_FRAME
suffix:semicolon
id|br.size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|br.size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|br.size
OL
l_int|8192
)paren
id|br.size
op_assign
l_int|8192
suffix:semicolon
multiline_comment|/* Arbitrary */
multiline_comment|/* br.size is limited by 1 page for the stat_com tables to a Maximum of 2 MB */
r_if
c_cond
(paren
id|br.size
OG
(paren
l_int|512
op_star
l_int|1024
)paren
)paren
id|br.size
op_assign
(paren
l_int|512
op_star
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* 512 K should be enough */
r_if
c_cond
(paren
id|zr-&gt;need_contiguous
op_logical_and
id|br.size
OG
id|MAX_KMALLOC_MEM
)paren
id|br.size
op_assign
id|MAX_KMALLOC_MEM
suffix:semicolon
id|zr-&gt;jpg_nbufs
op_assign
id|br.count
suffix:semicolon
id|zr-&gt;jpg_bufsize
op_assign
id|br.size
suffix:semicolon
r_if
c_cond
(paren
id|jpg_fbuffer_alloc
c_func
(paren
id|zr
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* The next mmap will map the MJPEG buffers */
id|zr-&gt;map_mjpeg_buffers
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|br
comma
r_sizeof
(paren
id|br
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|BUZIOC_QBUF_CAPT
suffix:colon
(brace
r_int
id|nb
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|nb
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_QBUF_CAPT %d&bslash;n&quot;
comma
id|nb
)paren
)paren
suffix:semicolon
r_return
id|jpg_qbuf
c_func
(paren
id|zr
comma
id|nb
comma
id|BUZ_MODE_MOTION_COMPRESS
)paren
suffix:semicolon
)brace
r_case
id|BUZIOC_QBUF_PLAY
suffix:colon
(brace
r_int
id|nb
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|nb
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_QBUF_PLAY %d&bslash;n&quot;
comma
id|nb
)paren
)paren
suffix:semicolon
r_return
id|jpg_qbuf
c_func
(paren
id|zr
comma
id|nb
comma
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
suffix:semicolon
)brace
r_case
id|BUZIOC_SYNC
suffix:colon
(brace
r_struct
id|zoran_sync
id|bs
suffix:semicolon
r_int
id|res
suffix:semicolon
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_SYNC&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|jpg_sync
c_func
(paren
id|zr
comma
op_amp
id|bs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|bs
comma
r_sizeof
(paren
id|bs
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_case
id|BUZIOC_G_STATUS
suffix:colon
(brace
r_struct
id|zoran_status
id|bs
suffix:semicolon
r_int
id|norm
comma
id|input
comma
id|status
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_IDLE
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|bs
comma
id|arg
comma
r_sizeof
(paren
id|bs
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|IOCTL_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;buz ioctl BUZIOC_G_STATUS&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bs.input
)paren
(brace
r_case
l_int|0
suffix:colon
id|input
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|input
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Set video norm to VIDEO_MODE_AUTO */
id|norm
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_INPUT
comma
op_amp
id|input
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_NORM
comma
op_amp
id|norm
)paren
suffix:semicolon
multiline_comment|/* sleep 1 second */
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Get status of video decoder */
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_GET_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
id|bs.signal
op_assign
(paren
id|status
op_amp
id|DECODER_STATUS_GOOD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|bs.norm
op_assign
(paren
id|status
op_amp
id|DECODER_STATUS_NTSC
)paren
ques
c_cond
id|VIDEO_MODE_NTSC
suffix:colon
id|VIDEO_MODE_PAL
suffix:semicolon
id|bs.color
op_assign
(paren
id|status
op_amp
id|DECODER_STATUS_COLOR
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* restore previous input and norm */
id|input
op_assign
id|zr-&gt;params.input
op_eq
l_int|0
ques
c_cond
l_int|3
suffix:colon
l_int|7
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_INPUT
comma
op_amp
id|input
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|bs
comma
r_sizeof
(paren
id|bs
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   This maps the buffers to user space.&n; *&n; *   Depending on the state of zr-&gt;map_mjpeg_buffers&n; *   the V4L or the MJPEG buffers are mapped&n; *&n; */
DECL|function|zoran_mmap
r_static
r_int
id|zoran_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
comma
id|todo
comma
id|fraglen
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;map_mjpeg_buffers
)paren
(brace
multiline_comment|/* Map the MJPEG buffers */
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;jpg_buffers_allocated
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
id|zr-&gt;jpg_nbufs
op_star
id|zr-&gt;jpg_bufsize
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zr-&gt;jpg_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|zr-&gt;jpg_bufsize
op_div
id|PAGE_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
id|fraglen
op_assign
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
id|todo
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|todo
OG
id|fraglen
)paren
id|todo
op_assign
id|fraglen
suffix:semicolon
id|pos
op_assign
(paren
r_int
r_int
)paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
suffix:semicolon
id|page
op_assign
id|virt_to_phys
c_func
(paren
id|bus_to_virt
c_func
(paren
id|pos
)paren
)paren
suffix:semicolon
multiline_comment|/* should just be pos on i386 */
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|todo
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: zoran_mmap(V4L): remap_page_range failed&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|size
op_sub_assign
id|todo
suffix:semicolon
id|start
op_add_assign
id|todo
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_gbuf
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
op_amp
l_int|1
)paren
r_break
suffix:semicolon
multiline_comment|/* was last fragment */
)brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Map the V4L buffers */
r_if
c_cond
(paren
id|size
OG
id|v4l_nbufs
op_star
id|v4l_bufsize
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v4l_nbufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|todo
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|todo
OG
id|v4l_bufsize
)paren
id|todo
op_assign
id|v4l_bufsize
suffix:semicolon
id|page
op_assign
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer_phys
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;V4L remap page range %d 0x%x %d to 0x%x&bslash;n&quot;
comma
id|i
comma
id|page
comma
id|todo
comma
id|start
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|todo
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: zoran_mmap(V4L): remap_page_range failed&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|size
op_sub_assign
id|todo
suffix:semicolon
id|start
op_add_assign
id|todo
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|zoran_template
r_static
r_struct
id|video_device
id|zoran_template
op_assign
(brace
id|name
suffix:colon
id|BUZ_NAME
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_CLIPPING
op_or
id|VID_TYPE_FRAMERAM
op_or
id|VID_TYPE_SCALES
op_or
id|VID_TYPE_SUBCAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_ZR36067
comma
id|open
suffix:colon
id|zoran_open
comma
id|close
suffix:colon
id|zoran_close
comma
id|read
suffix:colon
id|zoran_read
comma
id|write
suffix:colon
id|zoran_write
comma
id|ioctl
suffix:colon
id|zoran_ioctl
comma
id|mmap
suffix:colon
id|zoran_mmap
comma
)brace
suffix:semicolon
DECL|function|zr36057_init
r_static
r_int
id|zr36057_init
c_func
(paren
r_int
id|i
)paren
(brace
r_struct
id|zoran
op_star
id|zr
op_assign
op_amp
id|zoran
(braket
id|i
)braket
suffix:semicolon
r_int
r_int
id|mem
suffix:semicolon
r_int
id|mem_needed
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
id|rev
suffix:semicolon
multiline_comment|/* reset zr36057 */
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* default setup of all parameters which will persist beetween opens */
id|zr-&gt;user
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
id|zr-&gt;map_mjpeg_buffers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Map V4L buffers by default */
id|zr-&gt;jpg_nbufs
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_bufsize
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_buffers_allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;buffer_set
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flag if frame buffer has been set */
id|zr-&gt;buffer.base
op_assign
(paren
r_void
op_star
)paren
id|vidmem
suffix:semicolon
id|zr-&gt;buffer.width
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;buffer.height
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;buffer.depth
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;buffer.bytesperline
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;params.norm
op_assign
id|default_norm
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Avoid nonsense settings from user */
id|zr-&gt;params.input
op_assign
id|default_input
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Avoid nonsense settings from user */
id|zr-&gt;video_interlace
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Should the following be reset at every open ? */
id|zr-&gt;picture.colour
op_assign
l_int|32768
suffix:semicolon
id|zr-&gt;picture.brightness
op_assign
l_int|32768
suffix:semicolon
id|zr-&gt;picture.hue
op_assign
l_int|32768
suffix:semicolon
id|zr-&gt;picture.contrast
op_assign
l_int|32768
suffix:semicolon
id|zr-&gt;picture.whiteness
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;picture.depth
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;picture.palette
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|j
op_increment
)paren
(brace
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer_phys
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_gbuf
(braket
id|i
)braket
dot
id|fbuffer_bus
op_assign
l_int|0
suffix:semicolon
)brace
id|zr-&gt;stat_com
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default setup (will be repeated at every open) */
id|zoran_open_init_params
c_func
(paren
id|zr
)paren
suffix:semicolon
multiline_comment|/* allocate memory *before* doing anything to the hardware in case allocation fails */
multiline_comment|/* STAT_COM table and overlay mask */
id|mem_needed
op_assign
(paren
id|BUZ_NUM_STAT_COM
op_plus
(paren
(paren
id|BUZ_MAX_WIDTH
op_plus
l_int|31
)paren
op_div
l_int|32
)paren
op_star
id|BUZ_MAX_HEIGHT
)paren
op_star
l_int|4
suffix:semicolon
id|mem
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|mem_needed
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
comma
l_int|0
comma
id|mem_needed
)paren
suffix:semicolon
id|zr-&gt;stat_com
op_assign
(paren
id|u32
op_star
)paren
id|mem
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|BUZ_NUM_STAT_COM
suffix:semicolon
id|j
op_increment
)paren
(brace
id|zr-&gt;stat_com
(braket
id|j
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* mark as unavailable to zr36057 */
)brace
id|zr-&gt;overlay_mask
op_assign
(paren
id|u32
op_star
)paren
(paren
id|mem
op_plus
id|BUZ_NUM_STAT_COM
op_star
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Initialize zr-&gt;jpg_gbuf */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|BUZ_MAX_FRAME
suffix:semicolon
id|j
op_increment
)paren
(brace
id|zr-&gt;jpg_gbuf
(braket
id|j
)braket
dot
id|frag_tab
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|j
)braket
dot
id|frag_tab_bus
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|j
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
id|zr-&gt;jpg_gbuf
(braket
id|j
)braket
dot
id|bs.frame
op_assign
id|j
suffix:semicolon
)brace
multiline_comment|/* take zr36057 out of reset now */
id|btwrite
c_func
(paren
id|ZR36057_SPGPPCR_SoftReset
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* stop all DMA processes */
id|btwrite
c_func
(paren
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
multiline_comment|/* assert P_Reset */
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_JPC
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|zr-&gt;board
)paren
(brace
r_case
id|BOARD_BUZ
suffix:colon
multiline_comment|/* set up GPIO direction */
id|btwrite
c_func
(paren
id|ZR36057_SPGPPCR_SoftReset
op_or
l_int|0
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
multiline_comment|/* Set up guest bus timing - Guests 0..3 Tdur=12, Trec=3 */
id|btwrite
c_func
(paren
(paren
id|GPIO_MASK
op_lshift
l_int|24
)paren
op_or
l_int|0x8888
comma
id|ZR36057_GPPGCR1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* reset video decoder */
id|GPIO
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|GPIO
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* reset JPEG codec */
id|zr36060_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|zr36060_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* display codec revision */
r_if
c_cond
(paren
(paren
id|rev
op_assign
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x022
)paren
)paren
op_eq
l_int|0x33
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Zoran ZR36060 (rev %d)&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x023
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Zoran ZR36060 not found (Rev=%d)&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|rev
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BOARD_LML33
suffix:colon
singleline_comment|//&t;&t;&t;btwrite(btread(ZR36057_SPGPPCR)&amp;~ZR36057_SPGPPCR_SoftReset , ZR36057_SPGPPCR);
singleline_comment|//&t;&t;&t;udelay(100);
singleline_comment|//&t;&t;&t;btwrite(btread(ZR36057_SPGPPCR)|ZR36057_SPGPPCR_SoftReset , ZR36057_SPGPPCR);
singleline_comment|//&t;&t;&t;udelay(1000);
multiline_comment|/*&n;&t;&t;&t; *&t;Set up the GPIO direction&n;&t;&t;&t; */
id|btwrite
c_func
(paren
id|btread
c_func
(paren
id|ZR36057_SPGPPCR_SoftReset
)paren
op_or
l_int|0
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
multiline_comment|/* Set up guest bus timing - Guests 0..2 Tdur=12, Trec=3 */
id|btwrite
c_func
(paren
l_int|0xFF00F888
comma
id|ZR36057_GPPGCR1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|GPIO
c_func
(paren
id|zr
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Analog video bypass */
id|udelay
c_func
(paren
l_int|3000
)paren
suffix:semicolon
id|GPIO
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset 819 */
id|udelay
c_func
(paren
l_int|3000
)paren
suffix:semicolon
id|GPIO
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 819 back */
id|udelay
c_func
(paren
l_int|3000
)paren
suffix:semicolon
multiline_comment|/* reset JPEG codec */
id|zr36060_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|3000
)paren
suffix:semicolon
id|zr36060_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|3000
)paren
suffix:semicolon
multiline_comment|/* display codec revision */
r_if
c_cond
(paren
(paren
id|rev
op_assign
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x022
)paren
)paren
op_eq
l_int|0x33
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Zoran ZR36060 (rev %d)&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|zr36060_read_8
c_func
(paren
id|zr
comma
l_int|0x023
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Zoran ZR36060 not found (rev=%d)&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|rev
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* i2c */
id|memcpy
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
op_amp
id|zoran_i2c_bus_template
comma
r_sizeof
(paren
r_struct
id|i2c_bus
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|zr-&gt;i2c.name
comma
l_string|&quot;zoran%u&quot;
comma
id|zr-&gt;id
)paren
suffix:semicolon
id|zr-&gt;i2c.data
op_assign
id|zr
suffix:semicolon
r_if
c_cond
(paren
id|i2c_register_bus
c_func
(paren
op_amp
id|zr-&gt;i2c
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *   Now add the template and register the device unit.&n;&t; */
id|memcpy
c_func
(paren
op_amp
id|zr-&gt;video_dev
comma
op_amp
id|zoran_template
comma
r_sizeof
(paren
id|zoran_template
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|zr-&gt;video_dev.name
comma
l_string|&quot;zoran%u&quot;
comma
id|zr-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|zr-&gt;video_dev
comma
id|VFL_TYPE_GRABBER
)paren
OL
l_int|0
)paren
(brace
id|i2c_unregister_bus
c_func
(paren
op_amp
id|zr-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* toggle JPEG codec sleep to sync PLL */
id|zr36060_sleep
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|zr36060_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Enable bus-mastering */
id|pci_set_master
c_func
(paren
id|zr-&gt;pci_dev
)paren
suffix:semicolon
id|j
op_assign
id|zr-&gt;params.input
op_eq
l_int|0
ques
c_cond
l_int|3
suffix:colon
l_int|7
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_INPUT
comma
op_amp
id|j
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEODECODER
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
id|zr-&gt;i2c
comma
id|I2C_DRIVERID_VIDEOENCODER
comma
id|ENCODER_SET_NORM
comma
op_amp
id|zr-&gt;params.norm
)paren
suffix:semicolon
multiline_comment|/* set individual interrupt enables (without GIRQ0)&n;&t;   but don&squot;t global enable until zoran_open() */
id|btwrite
c_func
(paren
id|IRQ_MASK
op_amp
op_complement
id|ZR36057_ISR_GIRQ0
comma
id|ZR36057_ICR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|zr-&gt;pci_dev-&gt;irq
comma
id|zoran_irq
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
id|zr-&gt;name
comma
(paren
r_void
op_star
)paren
id|zr
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t assign irq.&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|zr-&gt;video_dev
)paren
suffix:semicolon
id|i2c_unregister_bus
c_func
(paren
op_amp
id|zr-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|zr-&gt;initialized
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|release_zoran
r_static
r_void
id|release_zoran
c_func
(paren
r_void
)paren
(brace
id|u8
id|command
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr
op_assign
op_amp
id|zoran
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;initialized
)paren
r_continue
suffix:semicolon
multiline_comment|/* unregister i2c_bus */
id|i2c_unregister_bus
c_func
(paren
(paren
op_amp
id|zr-&gt;i2c
)paren
)paren
suffix:semicolon
multiline_comment|/* disable PCI bus-mastering */
id|pci_read_config_byte
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* put chip into reset */
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|zr-&gt;pci_dev-&gt;irq
comma
id|zr
)paren
suffix:semicolon
multiline_comment|/* unmap and free memory */
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|zr-&gt;zr36057_mem
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|zr-&gt;video_dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *   Scan for a Buz card (actually for the PCI controller ZR36057),&n; *   request the irq and map the io memory&n; */
DECL|function|find_zr36057
r_static
r_int
id|find_zr36057
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|latency
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|zoran_num
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|zoran_num
OL
id|BUZ_MAX
op_logical_and
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_ZORAN
comma
id|PCI_DEVICE_ID_ZORAN_36057
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|zr
op_assign
op_amp
id|zoran
(braket
id|zoran_num
)braket
suffix:semicolon
id|zr-&gt;pci_dev
op_assign
id|dev
suffix:semicolon
id|zr-&gt;zr36057_mem
op_assign
l_int|NULL
suffix:semicolon
id|zr-&gt;id
op_assign
id|zoran_num
suffix:semicolon
id|sprintf
c_func
(paren
id|zr-&gt;name
comma
l_string|&quot;zoran%u&quot;
comma
id|zr-&gt;id
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|zr-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
r_continue
suffix:semicolon
id|zr-&gt;zr36057_adr
op_assign
id|pci_resource_start
c_func
(paren
id|zr-&gt;pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|zr-&gt;revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;revision
OL
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Zoran ZR36057 (rev %d) irq: %d, memory: 0x%08x.&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|zr-&gt;revision
comma
id|zr-&gt;pci_dev-&gt;irq
comma
id|zr-&gt;zr36057_adr
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|ss_vendor_id
comma
id|ss_id
suffix:semicolon
id|ss_vendor_id
op_assign
id|zr-&gt;pci_dev-&gt;subsystem_vendor
suffix:semicolon
id|ss_id
op_assign
id|zr-&gt;pci_dev-&gt;subsystem_device
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Zoran ZR36067 (rev %d) irq: %d, memory: 0x%08x&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|zr-&gt;revision
comma
id|zr-&gt;pci_dev-&gt;irq
comma
id|zr-&gt;zr36057_adr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: subsystem vendor=0x%04x id=0x%04x&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|ss_vendor_id
comma
id|ss_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ss_vendor_id
op_eq
l_int|0xFF10
op_logical_and
id|ss_id
op_eq
l_int|0xDE41
)paren
(brace
id|zr-&gt;board
op_assign
id|BOARD_LML33
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LML33 detected.&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
)brace
)brace
id|zr-&gt;zr36057_mem
op_assign
id|ioremap
c_func
(paren
id|zr-&gt;zr36057_adr
comma
l_int|0x1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;zr36057_mem
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: ioremap failed&bslash;n&quot;
comma
id|zr-&gt;name
)paren
suffix:semicolon
multiline_comment|/* XXX handle error */
)brace
multiline_comment|/* set PCI latency timer */
id|pci_read_config_byte
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|latency
op_ne
l_int|48
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Changing PCI latency from %d to 48.&bslash;n&quot;
comma
id|zr-&gt;name
comma
id|latency
)paren
suffix:semicolon
id|latency
op_assign
l_int|48
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_LATENCY_TIMER
comma
id|latency
)paren
suffix:semicolon
)brace
id|zoran_num
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zoran_num
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;zoran: no cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|zoran_num
suffix:semicolon
)brace
DECL|function|handle_chipset
r_static
r_void
id|handle_chipset
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_FAIL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;buz: This configuration is known to have PCI to PCI DMA problems&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;buz: You may not be able to use overlay mode.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_TRITON
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;buz: Enabling Triton support.&bslash;n&quot;
)paren
suffix:semicolon
id|triton
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_NATOMA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;buz: Enabling Natoma workaround.&bslash;n&quot;
)paren
suffix:semicolon
id|natoma
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|init_zoran_cards
c_func
(paren
r_struct
id|video_init
op_star
id|unused
)paren
macro_line|#endif
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Zoran driver 1.00 (c) 1999 Rainer Johanni, Dave Perks.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Look for Buz cards */
r_if
c_cond
(paren
id|find_zr36057
c_func
(paren
)paren
op_le
l_int|0
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;zoran: %d zoran card(s) found&bslash;n&quot;
comma
id|zoran_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zoran_num
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* check the parameters we have been given, adjust if necessary */
r_if
c_cond
(paren
id|v4l_nbufs
OL
l_int|0
)paren
id|v4l_nbufs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v4l_nbufs
OG
id|VIDEO_MAX_FRAME
)paren
id|v4l_nbufs
op_assign
id|VIDEO_MAX_FRAME
suffix:semicolon
multiline_comment|/* The user specfies the in KB, we want them in byte (and page aligned) */
id|v4l_bufsize
op_assign
id|PAGE_ALIGN
c_func
(paren
id|v4l_bufsize
op_star
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v4l_bufsize
OL
l_int|32768
)paren
id|v4l_bufsize
op_assign
l_int|32768
suffix:semicolon
multiline_comment|/* 2 MB is arbitrary but sufficient for the maximum possible images */
r_if
c_cond
(paren
id|v4l_bufsize
OG
l_int|2048
op_star
l_int|1024
)paren
id|v4l_bufsize
op_assign
l_int|2048
op_star
l_int|1024
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;zoran: using %d V4L buffers of size %d KB&bslash;n&quot;
comma
id|v4l_nbufs
comma
id|v4l_bufsize
op_rshift
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Use parameter for vidmem or try to find a video card */
r_if
c_cond
(paren
id|vidmem
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;zoran: Using supplied video memory base address @ 0x%lx&bslash;n&quot;
comma
id|vidmem
)paren
suffix:semicolon
)brace
multiline_comment|/* check if we have a Triton or Natome chipset */
id|handle_chipset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* take care of Natoma chipset and a revision 1 zr36057 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|natoma
op_logical_and
id|zoran
(braket
id|i
)braket
dot
id|revision
op_le
l_int|1
)paren
(brace
id|zoran
(braket
id|i
)braket
dot
id|need_contiguous
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ZR36057/Natome bug, max. buffer size is 128K&bslash;n&quot;
comma
id|zoran
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_else
(brace
id|zoran
(braket
id|i
)braket
dot
id|need_contiguous
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* initialize the Buzs */
multiline_comment|/* We have to know which ones must be released if an error occurs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num
suffix:semicolon
id|i
op_increment
)paren
id|zoran
(braket
id|i
)braket
dot
id|initialized
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zr36057_init
c_func
(paren
id|i
)paren
OL
l_int|0
)paren
(brace
id|release_zoran
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|release_zoran
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
