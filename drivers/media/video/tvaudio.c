multiline_comment|/*&n; * experimental driver for simple i2c audio chips.&n; *&n; * Copyright (c) 2000 Gerd Knorr&n; * based on code by:&n; *   Eric Sandeen (eric_sandeen@bigfoot.com) &n; *   Steve VanDeBogart (vandebo@uclink.berkeley.edu)&n; *   Greg Alexander (galexand@acm.org)&n; *&n; * This code is placed under the terms of the GNU General Public License&n; * &n; * OPTIONS:&n; *   debug - set to 1 if you&squot;d like to see debug messages&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &quot;audiochip.h&quot;
macro_line|#include &quot;tvaudio.h&quot;
macro_line|#include &quot;id.h&quot;
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* insmod args                                                            */
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|macro|dprintk
mdefine_line|#define dprintk  if (debug) printk
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* our structs                                                            */
DECL|macro|MAXREGS
mdefine_line|#define MAXREGS 64
r_struct
id|CHIPSTATE
suffix:semicolon
DECL|typedef|getvalue
r_typedef
r_int
(paren
op_star
id|getvalue
)paren
(paren
r_int
)paren
suffix:semicolon
DECL|typedef|checkit
r_typedef
r_int
(paren
op_star
id|checkit
)paren
(paren
r_struct
id|CHIPSTATE
op_star
)paren
suffix:semicolon
DECL|typedef|getmode
r_typedef
r_int
(paren
op_star
id|getmode
)paren
(paren
r_struct
id|CHIPSTATE
op_star
)paren
suffix:semicolon
DECL|typedef|setmode
r_typedef
r_void
(paren
op_star
id|setmode
)paren
(paren
r_struct
id|CHIPSTATE
op_star
comma
r_int
id|mode
)paren
suffix:semicolon
DECL|typedef|checkmode
r_typedef
r_void
(paren
op_star
id|checkmode
)paren
(paren
r_struct
id|CHIPSTATE
op_star
)paren
suffix:semicolon
multiline_comment|/* i2c command */
DECL|struct|AUDIOCMD
r_typedef
r_struct
id|AUDIOCMD
(brace
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* # of bytes to send */
DECL|member|bytes
r_int
r_char
id|bytes
(braket
id|MAXREGS
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* addr, data, data, ... */
DECL|typedef|audiocmd
)brace
id|audiocmd
suffix:semicolon
multiline_comment|/* chip description */
DECL|struct|CHIPDESC
r_struct
id|CHIPDESC
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/* chip name         */
DECL|member|id
r_int
id|id
suffix:semicolon
multiline_comment|/* ID */
DECL|member|addr_lo
DECL|member|addr_hi
r_int
id|addr_lo
comma
id|addr_hi
suffix:semicolon
multiline_comment|/* i2c address range */
DECL|member|registers
r_int
id|registers
suffix:semicolon
multiline_comment|/* # of registers    */
DECL|member|insmodopt
r_int
op_star
id|insmodopt
suffix:semicolon
DECL|member|checkit
id|checkit
id|checkit
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|macro|CHIP_HAS_VOLUME
mdefine_line|#define CHIP_HAS_VOLUME      1
DECL|macro|CHIP_HAS_BASSTREBLE
mdefine_line|#define CHIP_HAS_BASSTREBLE  2
DECL|macro|CHIP_HAS_INPUTSEL
mdefine_line|#define CHIP_HAS_INPUTSEL    4
multiline_comment|/* various i2c command sequences */
DECL|member|init
id|audiocmd
id|init
suffix:semicolon
multiline_comment|/* which register has which value */
DECL|member|leftreg
DECL|member|rightreg
DECL|member|treblereg
DECL|member|bassreg
r_int
id|leftreg
comma
id|rightreg
comma
id|treblereg
comma
id|bassreg
suffix:semicolon
multiline_comment|/* initialize with (defaults to 65535/65535/32768/32768 */
DECL|member|leftinit
DECL|member|rightinit
DECL|member|trebleinit
DECL|member|bassinit
r_int
id|leftinit
comma
id|rightinit
comma
id|trebleinit
comma
id|bassinit
suffix:semicolon
multiline_comment|/* functions to convert the values (v4l -&gt; chip) */
DECL|member|volfunc
DECL|member|treblefunc
DECL|member|bassfunc
id|getvalue
id|volfunc
comma
id|treblefunc
comma
id|bassfunc
suffix:semicolon
multiline_comment|/* get/set mode */
DECL|member|getmode
id|getmode
id|getmode
suffix:semicolon
DECL|member|setmode
id|setmode
id|setmode
suffix:semicolon
multiline_comment|/* check / autoswitch audio after channel switches */
DECL|member|checkmode
id|checkmode
id|checkmode
suffix:semicolon
multiline_comment|/* input switch register + values for v4l inputs */
DECL|member|inputreg
r_int
id|inputreg
suffix:semicolon
DECL|member|inputmap
r_int
id|inputmap
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|inputmute
r_int
id|inputmute
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|chiplist
r_static
r_struct
id|CHIPDESC
id|chiplist
(braket
)braket
suffix:semicolon
multiline_comment|/* current state of the chip */
DECL|struct|CHIPSTATE
r_struct
id|CHIPSTATE
(brace
DECL|member|c
r_struct
id|i2c_client
id|c
suffix:semicolon
multiline_comment|/* index into CHIPDESC array */
DECL|member|type
r_int
id|type
suffix:semicolon
multiline_comment|/* shadow register set */
DECL|member|shadow
id|audiocmd
id|shadow
suffix:semicolon
multiline_comment|/* current settings */
DECL|member|left
DECL|member|right
DECL|member|treble
DECL|member|bass
id|__u16
id|left
comma
id|right
comma
id|treble
comma
id|bass
suffix:semicolon
multiline_comment|/* thread */
DECL|member|thread
r_struct
id|task_struct
op_star
id|thread
suffix:semicolon
DECL|member|notify
r_struct
id|semaphore
op_star
id|notify
suffix:semicolon
DECL|member|wq
id|wait_queue_head_t
id|wq
suffix:semicolon
DECL|member|wake
DECL|member|done
r_int
id|wake
comma
id|done
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* i2c adresses                                                           */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_TDA8425
op_rshift
l_int|1
comma
id|I2C_TEA6300
op_rshift
l_int|1
comma
id|I2C_TEA6420
op_rshift
l_int|1
comma
id|I2C_TDA9840
op_rshift
l_int|1
comma
id|I2C_TDA985x_L
op_rshift
l_int|1
comma
id|I2C_TDA985x_H
op_rshift
l_int|1
comma
id|I2C_PIC16C54
op_rshift
l_int|1
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe
r_static
r_int
r_int
id|probe
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe_range
r_static
r_int
r_int
id|probe_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore
r_static
r_int
r_int
id|ignore
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore_range
r_static
r_int
r_int
id|ignore_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|force
r_static
r_int
r_int
id|force
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|addr_data
r_static
r_struct
id|i2c_client_address_data
id|addr_data
op_assign
(brace
id|normal_i2c
comma
id|normal_i2c_range
comma
id|probe
comma
id|probe_range
comma
id|ignore
comma
id|ignore_range
comma
id|force
)brace
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* i2c I/O functions                                                      */
DECL|function|chip_write
r_static
r_int
id|chip_write
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
comma
r_int
id|subaddr
comma
r_int
id|val
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_minus
l_int|1
op_eq
id|subaddr
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s: chip_write: 0x%x&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|val
)paren
suffix:semicolon
id|chip-&gt;shadow.bytes
(braket
l_int|1
)braket
op_assign
id|val
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_ne
id|i2c_master_send
c_func
(paren
op_amp
id|chip-&gt;c
comma
id|buffer
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: I/O error (write 0x%x)&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s: chip_write: reg%d=0x%x&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|subaddr
comma
id|val
)paren
suffix:semicolon
id|chip-&gt;shadow.bytes
(braket
id|subaddr
op_plus
l_int|1
)braket
op_assign
id|val
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
id|subaddr
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
id|i2c_master_send
c_func
(paren
op_amp
id|chip-&gt;c
comma
id|buffer
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: I/O error (write reg%d=0x%x)&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|subaddr
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chip_read
r_static
r_int
id|chip_read
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
)paren
(brace
r_int
r_char
id|buffer
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_ne
id|i2c_master_recv
c_func
(paren
op_amp
id|chip-&gt;c
comma
op_amp
id|buffer
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: I/O error (read)&bslash;n&quot;
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s: chip_read: 0x%x&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|buffer
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
DECL|function|chip_read2
r_static
r_int
id|chip_read2
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
comma
r_int
id|subaddr
)paren
(brace
r_int
r_char
id|write
(braket
l_int|1
)braket
suffix:semicolon
r_int
r_char
id|read
(braket
l_int|1
)braket
suffix:semicolon
r_struct
id|i2c_msg
id|msgs
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|chip-&gt;c.addr
comma
l_int|0
comma
l_int|1
comma
id|write
)brace
comma
(brace
id|chip-&gt;c.addr
comma
id|I2C_M_RD
comma
l_int|1
comma
id|read
)brace
)brace
suffix:semicolon
id|write
(braket
l_int|1
)braket
op_assign
id|subaddr
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
id|i2c_transfer
c_func
(paren
id|chip-&gt;c.adapter
comma
id|msgs
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: I/O error (read2)&bslash;n&quot;
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s: chip_read2: reg%d=0x%x&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|subaddr
comma
id|read
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|read
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|chip_cmd
r_static
r_int
id|chip_cmd
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
comma
r_char
op_star
id|name
comma
id|audiocmd
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|cmd-&gt;count
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* update our shadow register set; print bytes if (debug &gt; 0) */
id|dprintk
c_func
(paren
l_string|&quot;%s: chip_cmd(%s): reg=%d, data:&quot;
comma
id|chip-&gt;c.name
comma
id|name
comma
id|cmd-&gt;bytes
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|cmd-&gt;count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot; 0x%x&quot;
comma
id|cmd-&gt;bytes
(braket
id|i
)braket
)paren
suffix:semicolon
id|chip-&gt;shadow.bytes
(braket
id|i
op_plus
id|cmd-&gt;bytes
(braket
l_int|0
)braket
)braket
op_assign
id|cmd-&gt;bytes
(braket
id|i
)braket
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* send data to the chip */
r_if
c_cond
(paren
id|cmd-&gt;count
op_ne
id|i2c_master_send
c_func
(paren
op_amp
id|chip-&gt;c
comma
id|cmd-&gt;bytes
comma
id|cmd-&gt;count
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: I/O error (%s)&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* kernel thread for doing i2c stuff asyncronly&n; *   right now it is used only to check the audio mode (mono/stereo/whatever)&n; *   some time after switching to another TV channel, then turn on stereo&n; *   if available, ...&n; */
DECL|function|chip_thread
r_static
r_int
id|chip_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|CHIPSTATE
op_star
id|chip
op_assign
id|data
suffix:semicolon
r_struct
id|CHIPDESC
op_star
id|desc
op_assign
id|chiplist
op_plus
id|chip-&gt;type
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
id|chip-&gt;thread
op_assign
id|current
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|dprintk
c_func
(paren
l_string|&quot;%s: thread started&bslash;n&quot;
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;notify
op_ne
l_int|NULL
)paren
(brace
id|up
c_func
(paren
id|chip-&gt;notify
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;done
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;wake
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: thread wakeup&bslash;n&quot;
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;done
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
)brace
id|chip-&gt;wake
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wait some time -- let the audio hardware&n;&t;&t;   figure the current mode */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;wake
)paren
r_continue
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: thread checkmode&bslash;n&quot;
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
id|desc
op_member_access_from_pointer
id|checkmode
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
id|chip-&gt;thread
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: thread exiting&bslash;n&quot;
comma
id|chip-&gt;c.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;notify
op_ne
l_int|NULL
)paren
(brace
id|up_and_exit
c_func
(paren
id|chip-&gt;notify
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - defines+functions for tda9840                */
DECL|macro|TDA9840_SW
mdefine_line|#define TDA9840_SW         0x00
DECL|macro|TDA9840_LVADJ
mdefine_line|#define TDA9840_LVADJ      0x02
DECL|macro|TDA9840_STADJ
mdefine_line|#define TDA9840_STADJ      0x03
DECL|macro|TDA9840_TEST
mdefine_line|#define TDA9840_TEST       0x04
DECL|macro|TDA9840_MONO
mdefine_line|#define TDA9840_MONO       0x10
DECL|macro|TDA9840_STEREO
mdefine_line|#define TDA9840_STEREO     0x2a
DECL|macro|TDA9840_DUALA
mdefine_line|#define TDA9840_DUALA      0x12
DECL|macro|TDA9840_DUALB
mdefine_line|#define TDA9840_DUALB      0x1e
DECL|macro|TDA9840_DUALAB
mdefine_line|#define TDA9840_DUALAB     0x1a
DECL|macro|TDA9840_DUALBA
mdefine_line|#define TDA9840_DUALBA     0x16
DECL|macro|TDA9840_EXTERNAL
mdefine_line|#define TDA9840_EXTERNAL   0x7a
DECL|function|tda9840_getmode
r_int
id|tda9840_getmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
)paren
(brace
r_return
id|VIDEO_SOUND_MONO
op_or
id|VIDEO_SOUND_STEREO
op_or
id|VIDEO_SOUND_LANG1
op_or
id|VIDEO_SOUND_LANG2
suffix:semicolon
)brace
DECL|function|tda9840_setmode
r_void
id|tda9840_setmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
comma
r_int
id|mode
)paren
(brace
r_int
id|update
op_assign
l_int|1
suffix:semicolon
r_int
id|t
op_assign
id|chip-&gt;shadow.bytes
(braket
id|TDA9840_SW
op_plus
l_int|1
)braket
op_amp
op_complement
l_int|0x7e
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VIDEO_SOUND_MONO
suffix:colon
id|t
op_or_assign
id|TDA9840_MONO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|t
op_or_assign
id|TDA9840_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
id|t
op_or_assign
id|TDA9840_DUALA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG2
suffix:colon
id|t
op_or_assign
id|TDA9840_DUALB
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|update
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update
)paren
id|chip_write
c_func
(paren
id|chip
comma
id|TDA9840_SW
comma
id|t
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - defines+functions for tda985x                */
multiline_comment|/* subaddresses for TDA9855 */
DECL|macro|TDA9855_VR
mdefine_line|#define TDA9855_VR&t;0x00 /* Volume, right */
DECL|macro|TDA9855_VL
mdefine_line|#define TDA9855_VL&t;0x01 /* Volume, left */
DECL|macro|TDA9855_BA
mdefine_line|#define TDA9855_BA&t;0x02 /* Bass */
DECL|macro|TDA9855_TR
mdefine_line|#define TDA9855_TR&t;0x03 /* Treble */
DECL|macro|TDA9855_SW
mdefine_line|#define TDA9855_SW&t;0x04 /* Subwoofer - not connected on DTV2000 */
multiline_comment|/* subaddresses for TDA9850 */
DECL|macro|TDA9850_C4
mdefine_line|#define TDA9850_C4&t;0x04 /* Control 1 for TDA9850 */
multiline_comment|/* subaddesses for both chips */
DECL|macro|TDA985x_C5
mdefine_line|#define TDA985x_C5&t;0x05 /* Control 2 for TDA9850, Control 1 for TDA9855 */
DECL|macro|TDA985x_C6
mdefine_line|#define TDA985x_C6&t;0x06 /* Control 3 for TDA9850, Control 2 for TDA9855 */
DECL|macro|TDA985x_C7
mdefine_line|#define TDA985x_C7&t;0x07 /* Control 4 for TDA9850, Control 3 for TDA9855 */
DECL|macro|TDA985x_A1
mdefine_line|#define TDA985x_A1&t;0x08 /* Alignment 1 for both chips */
DECL|macro|TDA985x_A2
mdefine_line|#define TDA985x_A2&t;0x09 /* Alignment 2 for both chips */
DECL|macro|TDA985x_A3
mdefine_line|#define TDA985x_A3&t;0x0a /* Alignment 3 for both chips */
multiline_comment|/* Masks for bits in TDA9855 subaddresses */
multiline_comment|/* 0x00 - VR in TDA9855 */
multiline_comment|/* 0x01 - VL in TDA9855 */
multiline_comment|/* lower 7 bits control gain from -71dB (0x28) to 16dB (0x7f)&n; * in 1dB steps - mute is 0x27 */
multiline_comment|/* 0x02 - BA in TDA9855 */
multiline_comment|/* lower 5 bits control bass gain from -12dB (0x06) to 16.5dB (0x19)&n; * in .5dB steps - 0 is 0x0E */
multiline_comment|/* 0x03 - TR in TDA9855 */
multiline_comment|/* 4 bits &lt;&lt; 1 control treble gain from -12dB (0x3) to 12dB (0xb)&n; * in 3dB steps - 0 is 0x7 */
multiline_comment|/* Masks for bits in both chips&squot; subaddresses */
multiline_comment|/* 0x04 - SW in TDA9855, C4/Control 1 in TDA9850 */
multiline_comment|/* Unique to TDA9855: */
multiline_comment|/* 4 bits &lt;&lt; 2 control subwoofer/surround gain from -14db (0x1) to 14db (0xf)&n; * in 3dB steps - mute is 0x0 */
multiline_comment|/* Unique to TDA9850: */
multiline_comment|/* lower 4 bits control stereo noise threshold, over which stereo turns off&n; * set to values of 0x00 through 0x0f for Ster1 through Ster16 */
multiline_comment|/* 0x05 - C5 - Control 1 in TDA9855 , Control 2 in TDA9850*/
multiline_comment|/* Unique to TDA9855: */
DECL|macro|TDA9855_MUTE
mdefine_line|#define TDA9855_MUTE&t;1&lt;&lt;7 /* GMU, Mute at outputs */
DECL|macro|TDA9855_AVL
mdefine_line|#define TDA9855_AVL&t;1&lt;&lt;6 /* AVL, Automatic Volume Level */
DECL|macro|TDA9855_LOUD
mdefine_line|#define TDA9855_LOUD&t;1&lt;&lt;5 /* Loudness, 1==off */
DECL|macro|TDA9855_SUR
mdefine_line|#define TDA9855_SUR&t;1&lt;&lt;3 /* Surround / Subwoofer 1==.5(L-R) 0==.5(L+R) */
multiline_comment|/* Bits 0 to 3 select various combinations&n;                              * of line in and line out, only the &n;                              * interesting ones are defined */
DECL|macro|TDA9855_EXT
mdefine_line|#define TDA9855_EXT&t;1&lt;&lt;2 /* Selects inputs LIR and LIL.  Pins 41 &amp; 12 */
DECL|macro|TDA9855_INT
mdefine_line|#define TDA9855_INT&t;0    /* Selects inputs LOR and LOL.  (internal) */
multiline_comment|/* Unique to TDA9850:  */
multiline_comment|/* lower 4 bits contol SAP noise threshold, over which SAP turns off&n; * set to values of 0x00 through 0x0f for SAP1 through SAP16 */
multiline_comment|/* 0x06 - C6 - Control 2 in TDA9855, Control 3 in TDA9850 */
multiline_comment|/* Common to TDA9855 and TDA9850: */
DECL|macro|TDA985x_SAP
mdefine_line|#define TDA985x_SAP&t;3&lt;&lt;6 /* Selects SAP output, mute if not received */
DECL|macro|TDA985x_STEREO
mdefine_line|#define TDA985x_STEREO&t;1&lt;&lt;6 /* Selects Stereo ouput, mono if not received */
DECL|macro|TDA985x_MONO
mdefine_line|#define TDA985x_MONO&t;0    /* Forces Mono output */
DECL|macro|TDA985x_LMU
mdefine_line|#define TDA985x_LMU&t;1&lt;&lt;3 /* Mute (LOR/LOL for 9855, OUTL/OUTR for 9850) */
multiline_comment|/* Unique to TDA9855: */
DECL|macro|TDA9855_TZCM
mdefine_line|#define TDA9855_TZCM&t;1&lt;&lt;5 /* If set, don&squot;t mute till zero crossing */
DECL|macro|TDA9855_VZCM
mdefine_line|#define TDA9855_VZCM&t;1&lt;&lt;4 /* If set, don&squot;t change volume till zero crossing*/
DECL|macro|TDA9855_LINEAR
mdefine_line|#define TDA9855_LINEAR&t;0    /* Linear Stereo */
DECL|macro|TDA9855_PSEUDO
mdefine_line|#define TDA9855_PSEUDO&t;1    /* Pseudo Stereo */
DECL|macro|TDA9855_SPAT_30
mdefine_line|#define TDA9855_SPAT_30&t;2    /* Spatial Stereo, 30% anti-phase crosstalk */
DECL|macro|TDA9855_SPAT_50
mdefine_line|#define TDA9855_SPAT_50&t;3    /* Spatial Stereo, 52% anti-phase crosstalk */
DECL|macro|TDA9855_E_MONO
mdefine_line|#define TDA9855_E_MONO&t;7    /* Forced mono - mono select elseware, so useless*/
multiline_comment|/* 0x07 - C7 - Control 3 in TDA9855, Control 4 in TDA9850 */
multiline_comment|/* Common to both TDA9855 and TDA9850: */
multiline_comment|/* lower 4 bits control input gain from -3.5dB (0x0) to 4dB (0xF)&n; * in .5dB steps -  0dB is 0x7 */
multiline_comment|/* 0x08, 0x09 - A1 and A2 (read/write) */
multiline_comment|/* Common to both TDA9855 and TDA9850: */
multiline_comment|/* lower 5 bites are wideband and spectral expander alignment&n; * from 0x00 to 0x1f - nominal at 0x0f and 0x10 (read/write) */
DECL|macro|TDA985x_STP
mdefine_line|#define TDA985x_STP&t;1&lt;&lt;5 /* Stereo Pilot/detect (read-only) */
DECL|macro|TDA985x_SAPP
mdefine_line|#define TDA985x_SAPP&t;1&lt;&lt;6 /* SAP Pilot/detect (read-only) */
DECL|macro|TDA985x_STS
mdefine_line|#define TDA985x_STS&t;1&lt;&lt;7 /* Stereo trigger 1= &lt;35mV 0= &lt;30mV (write-only)*/
multiline_comment|/* 0x0a - A3 */
multiline_comment|/* Common to both TDA9855 and TDA9850: */
multiline_comment|/* lower 3 bits control timing current for alignment: -30% (0x0), -20% (0x1),&n; * -10% (0x2), nominal (0x3), +10% (0x6), +20% (0x5), +30% (0x4) */
DECL|macro|TDA985x_ADJ
mdefine_line|#define TDA985x_ADJ&t;1&lt;&lt;7 /* Stereo adjust on/off (wideband and spectral */
DECL|function|tda9855_volume
r_int
id|tda9855_volume
c_func
(paren
r_int
id|val
)paren
(brace
r_return
id|val
op_div
l_int|0x2e8
op_plus
l_int|0x27
suffix:semicolon
)brace
DECL|function|tda9855_bass
r_int
id|tda9855_bass
c_func
(paren
r_int
id|val
)paren
(brace
r_return
id|val
op_div
l_int|0xccc
op_plus
l_int|0x06
suffix:semicolon
)brace
DECL|function|tda9855_treble
r_int
id|tda9855_treble
c_func
(paren
r_int
id|val
)paren
(brace
r_return
(paren
id|val
op_div
l_int|0x1c71
op_plus
l_int|0x3
)paren
op_lshift
l_int|1
suffix:semicolon
)brace
DECL|function|tda985x_getmode
r_int
id|tda985x_getmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
)paren
(brace
r_int
id|mode
suffix:semicolon
id|mode
op_assign
(paren
(paren
id|TDA985x_STP
op_or
id|TDA985x_SAPP
)paren
op_amp
id|chip_read
c_func
(paren
id|chip
)paren
)paren
op_rshift
l_int|4
suffix:semicolon
multiline_comment|/* Add mono mode regardless of SAP and stereo */
multiline_comment|/* Allows forced mono */
r_return
id|mode
op_or
id|VIDEO_SOUND_MONO
suffix:semicolon
)brace
DECL|function|tda985x_setmode
r_void
id|tda985x_setmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
comma
r_int
id|mode
)paren
(brace
r_int
id|update
op_assign
l_int|1
suffix:semicolon
r_int
id|c6
op_assign
id|chip-&gt;shadow.bytes
(braket
id|TDA985x_C6
op_plus
l_int|1
)braket
op_amp
l_int|0x3f
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VIDEO_SOUND_MONO
suffix:colon
id|c6
op_or_assign
id|TDA985x_MONO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|c6
op_or_assign
id|TDA985x_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
id|c6
op_or_assign
id|TDA985x_SAP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|update
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update
)paren
id|chip_write
c_func
(paren
id|chip
comma
id|TDA985x_C6
comma
id|c6
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - defines+functions for tda9873h               */
multiline_comment|/* Subaddresses for TDA9873H */
DECL|macro|TDA9873_SW
mdefine_line|#define TDA9873_SW&t;0x00 /* Switching                    */
DECL|macro|TDA9873_AD
mdefine_line|#define TDA9873_AD&t;0x01 /* Adjust                       */
DECL|macro|TDA9873_PT
mdefine_line|#define TDA9873_PT&t;0x02 /* Port                         */
multiline_comment|/* Subaddress 0x00: Switching Data &n; * B7..B0:&n; *&n; * B1, B0: Input source selection&n; *  0,  0  internal&n; *  1,  0  external stereo&n; *  0,  1  external mono&n; */
DECL|macro|TDA9873_INTERNAL
mdefine_line|#define TDA9873_INTERNAL    0
DECL|macro|TDA9873_EXT_STEREO
mdefine_line|#define TDA9873_EXT_STEREO  2
DECL|macro|TDA9873_EXT_MONO
mdefine_line|#define TDA9873_EXT_MONO    1
multiline_comment|/*    B3, B2: output signal select&n; * B4    : transmission mode &n; *  0, 0, 1   Mono&n; *  1, 0, 0   Stereo&n; *  1, 1, 1   Stereo (reversed channel)    &n; *  0, 0, 0   Dual AB&n; *  0, 0, 1   Dual AA&n; *  0, 1, 0   Dual BB&n; *  0, 1, 1   Dual BA&n; */
DECL|macro|TDA9873_TR_MONO
mdefine_line|#define TDA9873_TR_MONO     4
DECL|macro|TDA9873_TR_STEREO
mdefine_line|#define TDA9873_TR_STEREO   1 &lt;&lt; 4
DECL|macro|TDA9873_TR_REVERSE
mdefine_line|#define TDA9873_TR_REVERSE  (1 &lt;&lt; 3) &amp; (1 &lt;&lt; 2)
DECL|macro|TDA9873_TR_DUALA
mdefine_line|#define TDA9873_TR_DUALA    1 &lt;&lt; 2
DECL|macro|TDA9873_TR_DUALB
mdefine_line|#define TDA9873_TR_DUALB    1 &lt;&lt; 3
multiline_comment|/* output level controls&n; * B5:  output level switch (0 = reduced gain, 1 = normal gain)&n; * B6:  mute                (1 = muted)&n; * B7:  auto-mute           (1 = auto-mute enabled)&n; */
DECL|macro|TDA9873_GAIN_NORMAL
mdefine_line|#define TDA9873_GAIN_NORMAL 1 &lt;&lt; 5
DECL|macro|TDA9873_MUTE
mdefine_line|#define TDA9873_MUTE        1 &lt;&lt; 6
DECL|macro|TDA9873_AUTOMUTE
mdefine_line|#define TDA9873_AUTOMUTE    1 &lt;&lt; 7
multiline_comment|/* Subaddress 0x01:  Adjust/standard */
multiline_comment|/* Lower 4 bits (C3..C0) control stereo adjustment on R channel (-0.6 - +0.7 dB)&n; * Recommended value is +0 dB&n; */
DECL|macro|TDA9873_STEREO_ADJ
mdefine_line|#define&t;TDA9873_STEREO_ADJ&t;0x06 /* 0dB gain */
multiline_comment|/* Bits C6..C4 control FM stantard  &n; * C6, C5, C4&n; *  0,  0,  0   B/G (PAL FM)&n; *  0,  0,  1   M&n; *  0,  1,  0   D/K(1)&n; *  0,  1,  1   D/K(2)&n; *  1,  0,  0   D/K(3)&n; *  1,  0,  1   I&n; */
DECL|macro|TDA9873_BG
mdefine_line|#define TDA9873_BG&t;&t;0
DECL|macro|TDA9873_M
mdefine_line|#define TDA9873_M       1
DECL|macro|TDA9873_DK1
mdefine_line|#define TDA9873_DK1     2
DECL|macro|TDA9873_DK2
mdefine_line|#define TDA9873_DK2     3
DECL|macro|TDA9873_DK3
mdefine_line|#define TDA9873_DK3     4
DECL|macro|TDA9873_I
mdefine_line|#define TDA9873_I       5
multiline_comment|/* C7 controls identification response time (1=fast/0=normal)&n; */
DECL|macro|TDA9873_IDR_NORM
mdefine_line|#define TDA9873_IDR_NORM 0
DECL|macro|TDA9873_IDR_FAST
mdefine_line|#define TDA9873_IDR_FAST 1 &lt;&lt; 7
multiline_comment|/* Subaddress 0x02: Port data */
multiline_comment|/* E1, E0   free programmable ports P1/P2&n;    0,  0   both ports low&n;    0,  1   P1 high&n;    1,  0   P2 high&n;    1,  1   both ports high&n;*/
DECL|macro|TDA9873_PORTS
mdefine_line|#define TDA9873_PORTS    3
multiline_comment|/* E2: test port */
DECL|macro|TDA9873_TST_PORT
mdefine_line|#define TDA9873_TST_PORT 1 &lt;&lt; 2
multiline_comment|/* E5..E3 control mono output channel (together with transmission mode bit B4)&n; *&n; * E5 E4 E3 B4     OUTM&n; *  0  0  0  0     mono&n; *  0  0  1  0     DUAL B&n; *  0  1  0  1     mono (from stereo decoder)&n; */
DECL|macro|TDA9873_MOUT_MONO
mdefine_line|#define TDA9873_MOUT_MONO   0
DECL|macro|TDA9873_MOUT_FMONO
mdefine_line|#define TDA9873_MOUT_FMONO  0
DECL|macro|TDA9873_MOUT_DUALA
mdefine_line|#define TDA9873_MOUT_DUALA  0 
DECL|macro|TDA9873_MOUT_DUALB
mdefine_line|#define TDA9873_MOUT_DUALB  1 &lt;&lt; 3 
DECL|macro|TDA9873_MOUT_ST
mdefine_line|#define TDA9873_MOUT_ST     1 &lt;&lt; 4 
DECL|macro|TDA9873_MOUT_EXTM
mdefine_line|#define TDA9873_MOUT_EXTM   (1 &lt;&lt; 4 ) &amp; (1 &lt;&lt; 3)
DECL|macro|TDA9873_MOUT_EXTL
mdefine_line|#define TDA9873_MOUT_EXTL   1 &lt;&lt; 5 
DECL|macro|TDA9873_MOUT_EXTR
mdefine_line|#define TDA9873_MOUT_EXTR   (1 &lt;&lt; 5 ) &amp; (1 &lt;&lt; 3)
DECL|macro|TDA9873_MOUT_EXTLR
mdefine_line|#define TDA9873_MOUT_EXTLR  (1 &lt;&lt; 5 ) &amp; (1 &lt;&lt; 4)
DECL|macro|TDA9873_MOUT_MUTE
mdefine_line|#define TDA9873_MOUT_MUTE   (1 &lt;&lt; 5 ) &amp; (1 &lt;&lt; 4) &amp; (1 &lt;&lt; 3)
multiline_comment|/* Status bits: (chip read) */
DECL|macro|TDA9873_PONR
mdefine_line|#define TDA9873_PONR        0 /* Power-on reset detected if = 1 */
DECL|macro|TDA9873_STEREO
mdefine_line|#define TDA9873_STEREO      2 /* Stereo sound is identified     */
DECL|macro|TDA9873_DUAL
mdefine_line|#define TDA9873_DUAL        4 /* Dual sound is identified       */
DECL|function|tda9873_getmode
r_int
id|tda9873_getmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
)paren
(brace
r_int
id|val
comma
id|mode
suffix:semicolon
id|val
op_assign
id|chip_read
c_func
(paren
id|chip
)paren
suffix:semicolon
id|mode
op_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|TDA9873_STEREO
)paren
id|mode
op_or_assign
id|VIDEO_SOUND_STEREO
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|TDA9873_DUAL
)paren
id|mode
op_or_assign
id|VIDEO_SOUND_LANG1
op_or
id|VIDEO_SOUND_LANG2
suffix:semicolon
id|dprintk
(paren
l_string|&quot;tda9873_getmode(): raw chip read: %d, return: %d&bslash;n&quot;
comma
id|val
comma
id|mode
)paren
suffix:semicolon
r_return
id|mode
suffix:semicolon
)brace
DECL|function|tda9873_setmode
r_void
id|tda9873_setmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
comma
r_int
id|mode
)paren
(brace
r_int
id|sw_data
op_assign
id|chip-&gt;shadow.bytes
(braket
id|TDA9873_SW
op_plus
l_int|1
)braket
op_amp
l_int|0xe3
suffix:semicolon
multiline_comment|/*&t;int adj_data = chip-&gt;shadow.bytes[TDA9873_AD+1] ; */
id|dprintk
c_func
(paren
l_string|&quot;tda9873_setmode(): chip-&gt;shadow.bytes[%d] = %d&bslash;n&quot;
comma
id|TDA9873_SW
op_plus
l_int|1
comma
id|chip-&gt;shadow.bytes
(braket
id|TDA9873_SW
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tda9873_setmode(): sw_data  = %d&bslash;n&quot;
comma
id|sw_data
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VIDEO_SOUND_MONO
suffix:colon
id|sw_data
op_or_assign
id|TDA9873_TR_MONO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|sw_data
op_or_assign
id|TDA9873_TR_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
id|sw_data
op_or_assign
id|TDA9873_TR_DUALA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG2
suffix:colon
id|sw_data
op_or_assign
id|TDA9873_TR_DUALB
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;tda9873_setmode(): req. mode %d; chip_write: %d&bslash;n&quot;
comma
id|mode
comma
id|sw_data
)paren
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|TDA9873_SW
comma
id|sw_data
)paren
suffix:semicolon
)brace
DECL|function|tda9873_checkmode
r_void
id|tda9873_checkmode
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
)paren
(brace
r_int
id|mode
op_assign
id|tda9873_getmode
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|VIDEO_SOUND_STEREO
)paren
id|tda9873_setmode
c_func
(paren
id|chip
comma
id|VIDEO_SOUND_STEREO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|VIDEO_SOUND_LANG1
)paren
id|tda9873_setmode
c_func
(paren
id|chip
comma
id|VIDEO_SOUND_LANG1
)paren
suffix:semicolon
)brace
DECL|function|tda9873_checkit
r_int
id|tda9873_checkit
c_func
(paren
r_struct
id|CHIPSTATE
op_star
id|chip
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_minus
l_int|1
op_eq
(paren
id|rc
op_assign
id|chip_read2
c_func
(paren
id|chip
comma
l_int|254
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
(paren
id|rc
op_amp
op_complement
l_int|0x1f
)paren
op_eq
l_int|0x80
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - defines+functions for tea6420                */
DECL|macro|TEA6300_VL
mdefine_line|#define TEA6300_VL         0x00  /* volume left */
DECL|macro|TEA6300_VR
mdefine_line|#define TEA6300_VR         0x01  /* volume right */
DECL|macro|TEA6300_BA
mdefine_line|#define TEA6300_BA         0x02  /* bass */
DECL|macro|TEA6300_TR
mdefine_line|#define TEA6300_TR         0x03  /* treble */
DECL|macro|TEA6300_FA
mdefine_line|#define TEA6300_FA         0x04  /* fader control */
DECL|macro|TEA6300_S
mdefine_line|#define TEA6300_S          0x05  /* switch register */
multiline_comment|/* values for those registers: */
DECL|macro|TEA6300_S_SA
mdefine_line|#define TEA6300_S_SA       0x01  /* stereo A input */
DECL|macro|TEA6300_S_SB
mdefine_line|#define TEA6300_S_SB       0x02  /* stereo B */
DECL|macro|TEA6300_S_SC
mdefine_line|#define TEA6300_S_SC       0x04  /* stereo C */
DECL|macro|TEA6300_S_GMU
mdefine_line|#define TEA6300_S_GMU      0x80  /* general mute */
DECL|macro|TEA6420_S_SA
mdefine_line|#define TEA6420_S_SA       0x00  /* stereo A input */
DECL|macro|TEA6420_S_SB
mdefine_line|#define TEA6420_S_SB       0x01  /* stereo B */
DECL|macro|TEA6420_S_SC
mdefine_line|#define TEA6420_S_SC       0x02  /* stereo C */
DECL|macro|TEA6420_S_SD
mdefine_line|#define TEA6420_S_SD       0x03  /* stereo D */
DECL|macro|TEA6420_S_SE
mdefine_line|#define TEA6420_S_SE       0x04  /* stereo E */
DECL|macro|TEA6420_S_GMU
mdefine_line|#define TEA6420_S_GMU      0x05  /* general mute */
DECL|function|tea6300_shift10
r_int
id|tea6300_shift10
c_func
(paren
r_int
id|val
)paren
(brace
r_return
id|val
op_rshift
l_int|10
suffix:semicolon
)brace
DECL|function|tea6300_shift12
r_int
id|tea6300_shift12
c_func
(paren
r_int
id|val
)paren
(brace
r_return
id|val
op_rshift
l_int|12
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - defines+functions for tda8425                */
DECL|macro|TDA8425_VL
mdefine_line|#define TDA8425_VL         0x00  /* volume left */
DECL|macro|TDA8425_VR
mdefine_line|#define TDA8425_VR         0x01  /* volume right */
DECL|macro|TDA8425_BA
mdefine_line|#define TDA8425_BA         0x02  /* bass */
DECL|macro|TDA8425_TR
mdefine_line|#define TDA8425_TR         0x03  /* treble */
DECL|macro|TDA8425_S1
mdefine_line|#define TDA8425_S1         0x08  /* switch functions */
multiline_comment|/* values for those registers: */
DECL|macro|TDA8425_S1_OFF
mdefine_line|#define TDA8425_S1_OFF     0xEE  /* audio off (mute on) */
DECL|macro|TDA8425_S1_ON
mdefine_line|#define TDA8425_S1_ON      0xCE  /* audio on (mute off) - &quot;linear stereo&quot; mode */
DECL|function|tda8425_shift10
r_int
id|tda8425_shift10
c_func
(paren
r_int
id|val
)paren
(brace
r_return
id|val
op_rshift
l_int|10
op_or
l_int|0xc0
suffix:semicolon
)brace
DECL|function|tda8425_shift12
r_int
id|tda8425_shift12
c_func
(paren
r_int
id|val
)paren
(brace
r_return
id|val
op_rshift
l_int|12
op_or
l_int|0xf0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - defines+functions for pic16c54 (PV951)       */
multiline_comment|/* the registers of 16C54, I2C sub address. */
DECL|macro|PIC16C54_REG_KEY_CODE
mdefine_line|#define PIC16C54_REG_KEY_CODE     0x01&t;       /* Not use. */
DECL|macro|PIC16C54_REG_MISC
mdefine_line|#define PIC16C54_REG_MISC         0x02
multiline_comment|/* bit definition of the RESET register, I2C data. */
DECL|macro|PIC16C54_MISC_RESET_REMOTE_CTL
mdefine_line|#define PIC16C54_MISC_RESET_REMOTE_CTL 0x01 /* bit 0, Reset to receive the key */
multiline_comment|/*        code of remote controller */
DECL|macro|PIC16C54_MISC_MTS_MAIN
mdefine_line|#define PIC16C54_MISC_MTS_MAIN         0x02 /* bit 1 */
DECL|macro|PIC16C54_MISC_MTS_SAP
mdefine_line|#define PIC16C54_MISC_MTS_SAP          0x04 /* bit 2 */
DECL|macro|PIC16C54_MISC_MTS_BOTH
mdefine_line|#define PIC16C54_MISC_MTS_BOTH         0x08 /* bit 3 */
DECL|macro|PIC16C54_MISC_SND_MUTE
mdefine_line|#define PIC16C54_MISC_SND_MUTE         0x10 /* bit 4, Mute Audio(Line-in and Tuner) */
DECL|macro|PIC16C54_MISC_SND_NOTMUTE
mdefine_line|#define PIC16C54_MISC_SND_NOTMUTE      0x20 /* bit 5 */
DECL|macro|PIC16C54_MISC_SWITCH_TUNER
mdefine_line|#define PIC16C54_MISC_SWITCH_TUNER     0x40 /* bit 6&t;, Switch to Line-in */
DECL|macro|PIC16C54_MISC_SWITCH_LINE
mdefine_line|#define PIC16C54_MISC_SWITCH_LINE      0x80 /* bit 7&t;, Switch to Tuner */
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* audio chip descriptions - struct CHIPDESC                              */
multiline_comment|/* insmod options to enable/disable individual audio chips */
DECL|variable|tda8425
r_int
id|tda8425
op_assign
l_int|1
suffix:semicolon
DECL|variable|tda9840
r_int
id|tda9840
op_assign
l_int|1
suffix:semicolon
DECL|variable|tda9850
r_int
id|tda9850
op_assign
l_int|1
suffix:semicolon
DECL|variable|tda9855
r_int
id|tda9855
op_assign
l_int|1
suffix:semicolon
DECL|variable|tda9873
r_int
id|tda9873
op_assign
l_int|1
suffix:semicolon
DECL|variable|tea6300
r_int
id|tea6300
op_assign
l_int|0
suffix:semicolon
DECL|variable|tea6420
r_int
id|tea6420
op_assign
l_int|1
suffix:semicolon
DECL|variable|pic16c54
r_int
id|pic16c54
op_assign
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda8425
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda9840
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda9850
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda9855
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda9873
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tea6300
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tea6420
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pic16c54
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|chiplist
r_static
r_struct
id|CHIPDESC
id|chiplist
(braket
)braket
op_assign
(brace
(brace
id|name
suffix:colon
l_string|&quot;tda9840&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TDA9840
comma
id|insmodopt
suffix:colon
op_amp
id|tda9840
comma
id|addr_lo
suffix:colon
id|I2C_TDA9840
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TDA9840
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|5
comma
id|getmode
suffix:colon
id|tda9840_getmode
comma
id|setmode
suffix:colon
id|tda9840_setmode
comma
id|init
suffix:colon
(brace
l_int|2
comma
(brace
id|TDA9840_SW
comma
l_int|0x2a
)brace
)brace
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;tda9873h&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TDA9873
comma
id|checkit
suffix:colon
id|tda9873_checkit
comma
id|insmodopt
suffix:colon
op_amp
id|tda9873
comma
id|addr_lo
suffix:colon
id|I2C_TDA985x_L
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TDA985x_H
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|3
comma
id|getmode
suffix:colon
id|tda9873_getmode
comma
id|setmode
suffix:colon
id|tda9873_setmode
comma
id|checkmode
suffix:colon
id|tda9873_checkmode
comma
id|init
suffix:colon
(brace
l_int|4
comma
(brace
id|TDA9873_SW
comma
l_int|0xa0
comma
l_int|0x06
comma
l_int|0x03
)brace
)brace
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;tda9850&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TDA9850
comma
id|insmodopt
suffix:colon
op_amp
id|tda9850
comma
id|addr_lo
suffix:colon
id|I2C_TDA985x_L
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TDA985x_H
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|11
comma
id|getmode
suffix:colon
id|tda985x_getmode
comma
id|setmode
suffix:colon
id|tda985x_setmode
comma
id|init
suffix:colon
(brace
l_int|8
comma
(brace
id|TDA9850_C4
comma
l_int|0x08
comma
l_int|0x08
comma
id|TDA985x_STEREO
comma
l_int|0x07
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x03
)brace
)brace
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;tda9855&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TDA9855
comma
id|insmodopt
suffix:colon
op_amp
id|tda9855
comma
id|addr_lo
suffix:colon
id|I2C_TDA985x_L
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TDA985x_H
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|11
comma
id|flags
suffix:colon
id|CHIP_HAS_VOLUME
op_or
id|CHIP_HAS_BASSTREBLE
comma
id|leftreg
suffix:colon
id|TDA9855_VR
comma
id|rightreg
suffix:colon
id|TDA9855_VL
comma
id|bassreg
suffix:colon
id|TDA9855_BA
comma
id|treblereg
suffix:colon
id|TDA9855_TR
comma
id|volfunc
suffix:colon
id|tda9855_volume
comma
id|bassfunc
suffix:colon
id|tda9855_bass
comma
id|treblefunc
suffix:colon
id|tda9855_treble
comma
id|getmode
suffix:colon
id|tda985x_getmode
comma
id|setmode
suffix:colon
id|tda985x_setmode
comma
id|init
suffix:colon
(brace
l_int|12
comma
(brace
l_int|0
comma
l_int|0x6f
comma
l_int|0x6f
comma
l_int|0x0e
comma
l_int|0x07
op_lshift
l_int|1
comma
l_int|0x8
op_lshift
l_int|2
comma
id|TDA9855_MUTE
op_or
id|TDA9855_AVL
op_or
id|TDA9855_LOUD
op_or
id|TDA9855_INT
comma
id|TDA985x_STEREO
op_or
id|TDA9855_LINEAR
op_or
id|TDA9855_TZCM
op_or
id|TDA9855_VZCM
comma
l_int|0x07
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x03
)brace
)brace
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;tea6300&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TEA6300
comma
id|insmodopt
suffix:colon
op_amp
id|tea6300
comma
id|addr_lo
suffix:colon
id|I2C_TEA6300
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TEA6300
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|6
comma
id|flags
suffix:colon
id|CHIP_HAS_VOLUME
op_or
id|CHIP_HAS_BASSTREBLE
op_or
id|CHIP_HAS_INPUTSEL
comma
id|leftreg
suffix:colon
id|TEA6300_VR
comma
id|rightreg
suffix:colon
id|TEA6300_VL
comma
id|bassreg
suffix:colon
id|TEA6300_BA
comma
id|treblereg
suffix:colon
id|TEA6300_TR
comma
id|volfunc
suffix:colon
id|tea6300_shift10
comma
id|bassfunc
suffix:colon
id|tea6300_shift12
comma
id|treblefunc
suffix:colon
id|tea6300_shift12
comma
id|inputreg
suffix:colon
id|TEA6300_S
comma
id|inputmap
suffix:colon
(brace
id|TEA6300_S_SA
comma
id|TEA6300_S_SB
comma
id|TEA6300_S_SC
)brace
comma
id|inputmute
suffix:colon
id|TEA6300_S_GMU
comma
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;tea6420&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TEA6420
comma
id|insmodopt
suffix:colon
op_amp
id|tea6420
comma
id|addr_lo
suffix:colon
id|I2C_TEA6420
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TEA6420
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|1
comma
id|flags
suffix:colon
id|CHIP_HAS_INPUTSEL
comma
id|inputreg
suffix:colon
op_minus
l_int|1
comma
id|inputmap
suffix:colon
(brace
id|TEA6420_S_SA
comma
id|TEA6420_S_SB
comma
id|TEA6420_S_SC
)brace
comma
id|inputmute
suffix:colon
id|TEA6300_S_GMU
comma
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;tda8425&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TDA8425
comma
id|insmodopt
suffix:colon
op_amp
id|tda8425
comma
id|addr_lo
suffix:colon
id|I2C_TDA8425
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_TDA8425
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|9
comma
id|flags
suffix:colon
id|CHIP_HAS_VOLUME
op_or
id|CHIP_HAS_BASSTREBLE
op_or
id|CHIP_HAS_INPUTSEL
comma
id|leftreg
suffix:colon
id|TDA8425_VR
comma
id|rightreg
suffix:colon
id|TDA8425_VL
comma
id|bassreg
suffix:colon
id|TDA8425_BA
comma
id|treblereg
suffix:colon
id|TDA8425_TR
comma
id|volfunc
suffix:colon
id|tda8425_shift10
comma
id|bassfunc
suffix:colon
id|tda8425_shift12
comma
id|treblefunc
suffix:colon
id|tda8425_shift12
comma
id|inputreg
suffix:colon
id|TDA8425_S1
comma
id|inputmap
suffix:colon
(brace
id|TDA8425_S1_ON
comma
id|TDA8425_S1_ON
comma
id|TDA8425_S1_ON
)brace
comma
id|inputmute
suffix:colon
id|TDA8425_S1_OFF
comma
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;pic16c54 (PV951)&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_PIC16C54_PV951
comma
id|insmodopt
suffix:colon
op_amp
id|pic16c54
comma
id|addr_lo
suffix:colon
id|I2C_PIC16C54
op_rshift
l_int|1
comma
id|addr_hi
suffix:colon
id|I2C_PIC16C54
op_rshift
l_int|1
comma
id|registers
suffix:colon
l_int|2
comma
id|flags
suffix:colon
id|CHIP_HAS_INPUTSEL
comma
id|inputreg
suffix:colon
id|PIC16C54_REG_MISC
comma
id|inputmap
suffix:colon
(brace
id|PIC16C54_MISC_SND_NOTMUTE
op_or
id|PIC16C54_MISC_SWITCH_TUNER
comma
id|PIC16C54_MISC_SND_NOTMUTE
op_or
id|PIC16C54_MISC_SWITCH_LINE
)brace
comma
id|inputmute
suffix:colon
id|PIC16C54_MISC_SND_MUTE
comma
)brace
comma
(brace
id|name
suffix:colon
l_int|NULL
)brace
multiline_comment|/* EOF */
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* i2c registration                                                       */
DECL|function|chip_attach
r_static
r_int
id|chip_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
r_int
id|flags
comma
r_int
id|kind
)paren
(brace
r_struct
id|CHIPSTATE
op_star
id|chip
suffix:semicolon
r_struct
id|CHIPDESC
op_star
id|desc
suffix:semicolon
id|chip
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chip
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|chip
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|chip-&gt;c
comma
op_amp
id|client_template
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|chip-&gt;c.adapter
op_assign
id|adap
suffix:semicolon
id|chip-&gt;c.addr
op_assign
id|addr
suffix:semicolon
id|chip-&gt;c.data
op_assign
id|chip
suffix:semicolon
multiline_comment|/* find description for the chip */
id|dprintk
c_func
(paren
l_string|&quot;tvaudio: chip @ addr=0x%x&bslash;n&quot;
comma
id|addr
op_lshift
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|desc
op_assign
id|chiplist
suffix:semicolon
id|desc-&gt;name
op_ne
l_int|NULL
suffix:semicolon
id|desc
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
op_star
(paren
id|desc-&gt;insmodopt
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|addr
template_param
id|desc-&gt;addr_hi
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;checkit
op_logical_and
op_logical_neg
id|desc
op_member_access_from_pointer
id|checkit
c_func
(paren
id|chip
)paren
)paren
r_continue
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;name
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;tvaudio: no matching chip description found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;tvaudio: %s matches:%s%s%s&bslash;n&quot;
comma
id|desc-&gt;name
comma
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_VOLUME
)paren
ques
c_cond
l_string|&quot; volume&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_BASSTREBLE
)paren
ques
c_cond
l_string|&quot; bass/treble&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_INPUTSEL
)paren
ques
c_cond
l_string|&quot; audiomux&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* fill required data structures */
id|strcpy
c_func
(paren
id|chip-&gt;c.name
comma
id|desc-&gt;name
)paren
suffix:semicolon
id|chip-&gt;type
op_assign
id|desc
op_minus
id|chiplist
suffix:semicolon
id|chip-&gt;shadow.count
op_assign
id|desc-&gt;registers
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* register */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|i2c_attach_client
c_func
(paren
op_amp
id|chip-&gt;c
)paren
suffix:semicolon
multiline_comment|/* initialization  */
id|chip_cmd
c_func
(paren
id|chip
comma
l_string|&quot;init&quot;
comma
op_amp
id|desc-&gt;init
)paren
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_VOLUME
)paren
(brace
id|chip-&gt;left
op_assign
id|desc-&gt;leftinit
ques
c_cond
id|desc-&gt;leftinit
suffix:colon
l_int|65536
suffix:semicolon
id|chip-&gt;right
op_assign
id|desc-&gt;rightinit
ques
c_cond
id|desc-&gt;rightinit
suffix:colon
l_int|65536
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;leftreg
comma
id|desc
op_member_access_from_pointer
id|volfunc
c_func
(paren
id|chip-&gt;left
)paren
)paren
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;rightreg
comma
id|desc
op_member_access_from_pointer
id|volfunc
c_func
(paren
id|chip-&gt;right
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_BASSTREBLE
)paren
(brace
id|chip-&gt;treble
op_assign
id|desc-&gt;trebleinit
ques
c_cond
id|desc-&gt;trebleinit
suffix:colon
l_int|32768
suffix:semicolon
id|chip-&gt;bass
op_assign
id|desc-&gt;bassinit
ques
c_cond
id|desc-&gt;bassinit
suffix:colon
l_int|32768
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;bassreg
comma
id|desc
op_member_access_from_pointer
id|bassfunc
c_func
(paren
id|chip-&gt;bass
)paren
)paren
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;treblereg
comma
id|desc
op_member_access_from_pointer
id|treblefunc
c_func
(paren
id|chip-&gt;treble
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;checkmode
)paren
(brace
multiline_comment|/* start async thread */
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
id|chip-&gt;notify
op_assign
op_amp
id|sem
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|kernel_thread
c_func
(paren
id|chip_thread
comma
(paren
r_void
op_star
)paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|chip-&gt;notify
op_assign
l_int|NULL
suffix:semicolon
id|chip-&gt;wake
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chip_probe
r_static
r_int
id|chip_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_if
c_cond
(paren
id|adap-&gt;id
op_eq
(paren
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_BT848
)paren
)paren
r_return
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|chip_attach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chip_detach
r_static
r_int
id|chip_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|CHIPSTATE
op_star
id|chip
op_assign
id|client-&gt;data
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|chip-&gt;thread
)paren
(brace
multiline_comment|/* shutdown async thread */
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
id|chip-&gt;notify
op_assign
op_amp
id|sem
suffix:semicolon
id|chip-&gt;done
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|chip-&gt;notify
op_assign
l_int|NULL
suffix:semicolon
)brace
id|i2c_detach_client
c_func
(paren
op_amp
id|chip-&gt;c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* video4linux interface                                                  */
DECL|function|chip_command
r_static
r_int
id|chip_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
id|__u16
op_star
id|sarg
op_assign
id|arg
suffix:semicolon
r_struct
id|CHIPSTATE
op_star
id|chip
op_assign
id|client-&gt;data
suffix:semicolon
r_struct
id|CHIPDESC
op_star
id|desc
op_assign
id|chiplist
op_plus
id|chip-&gt;type
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: chip_command 0x%x&bslash;n&quot;
comma
id|chip-&gt;c.name
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AUDC_SET_INPUT
suffix:colon
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_INPUTSEL
)paren
(brace
r_if
c_cond
(paren
op_star
id|sarg
op_amp
l_int|0x80
)paren
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;inputreg
comma
id|desc-&gt;inputmute
)paren
suffix:semicolon
r_else
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;inputreg
comma
id|desc-&gt;inputmap
(braket
op_star
id|sarg
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* --- v4l ioctls --- */
multiline_comment|/* take care: bttv does userspace copying, we&squot;ll get a&n;&t;   kernel pointer here... */
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_VOLUME
)paren
(brace
id|va-&gt;flags
op_or_assign
id|VIDEO_AUDIO_VOLUME
suffix:semicolon
id|va-&gt;volume
op_assign
id|MAX
c_func
(paren
id|chip-&gt;left
comma
id|chip-&gt;right
)paren
suffix:semicolon
id|va-&gt;balance
op_assign
(paren
l_int|32768
op_star
id|MIN
c_func
(paren
id|chip-&gt;left
comma
id|chip-&gt;right
)paren
)paren
op_div
(paren
id|va-&gt;volume
ques
c_cond
id|va-&gt;volume
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_BASSTREBLE
)paren
(brace
id|va-&gt;flags
op_or_assign
id|VIDEO_AUDIO_BASS
op_or
id|VIDEO_AUDIO_TREBLE
suffix:semicolon
id|va-&gt;bass
op_assign
id|chip-&gt;bass
suffix:semicolon
id|va-&gt;treble
op_assign
id|chip-&gt;treble
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;getmode
)paren
id|va-&gt;mode
op_assign
id|desc
op_member_access_from_pointer
id|getmode
c_func
(paren
id|chip
)paren
suffix:semicolon
r_else
id|va-&gt;mode
op_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_VOLUME
)paren
(brace
id|chip-&gt;left
op_assign
(paren
id|MIN
c_func
(paren
l_int|65536
op_minus
id|va-&gt;balance
comma
l_int|32768
)paren
op_star
id|va-&gt;volume
)paren
op_div
l_int|32768
suffix:semicolon
id|chip-&gt;right
op_assign
(paren
id|MIN
c_func
(paren
id|va-&gt;balance
comma
l_int|32768
)paren
op_star
id|va-&gt;volume
)paren
op_div
l_int|32768
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;leftreg
comma
id|desc
op_member_access_from_pointer
id|volfunc
c_func
(paren
id|chip-&gt;left
)paren
)paren
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;rightreg
comma
id|desc
op_member_access_from_pointer
id|volfunc
c_func
(paren
id|chip-&gt;right
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;flags
op_amp
id|CHIP_HAS_BASSTREBLE
)paren
(brace
id|chip-&gt;bass
op_assign
id|va-&gt;bass
suffix:semicolon
id|chip-&gt;treble
op_assign
id|va-&gt;treble
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;bassreg
comma
id|desc
op_member_access_from_pointer
id|bassfunc
c_func
(paren
id|chip-&gt;bass
)paren
)paren
suffix:semicolon
id|chip_write
c_func
(paren
id|chip
comma
id|desc-&gt;treblereg
comma
id|desc
op_member_access_from_pointer
id|treblefunc
c_func
(paren
id|chip-&gt;treble
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc-&gt;setmode
op_logical_and
id|va-&gt;mode
)paren
id|desc
op_member_access_from_pointer
id|setmode
c_func
(paren
id|chip
comma
id|va-&gt;mode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCSFREQ
suffix:colon
(brace
r_if
c_cond
(paren
id|desc-&gt;checkmode
)paren
(brace
id|desc
op_member_access_from_pointer
id|setmode
c_func
(paren
id|chip
comma
id|VIDEO_SOUND_MONO
)paren
suffix:semicolon
id|chip-&gt;wake
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
multiline_comment|/* the thread will call checkmode() a second later */
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;generic i2c audio driver&quot;
comma
id|id
suffix:colon
id|I2C_DRIVERID_TVAUDIO
comma
multiline_comment|/* FIXME */
id|flags
suffix:colon
id|I2C_DF_NOTIFY
comma
id|attach_adapter
suffix:colon
id|chip_probe
comma
id|detach_client
suffix:colon
id|chip_detach
comma
id|command
suffix:colon
id|chip_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
id|name
suffix:colon
l_string|&quot;(unset)&quot;
comma
id|driver
suffix:colon
op_amp
id|driver
comma
)brace
suffix:semicolon
DECL|function|audiochip_init_module
r_int
id|audiochip_init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|CHIPDESC
op_star
id|desc
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tvaudio: TV audio decoder + audio/video mux driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tvaudio: known chips: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|desc
op_assign
id|chiplist
suffix:semicolon
id|desc-&gt;name
op_ne
l_int|NULL
suffix:semicolon
id|desc
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s%s&quot;
comma
(paren
id|desc
op_eq
id|chiplist
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;,&quot;
comma
id|desc-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|audiochip_cleanup_module
r_void
id|audiochip_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|variable|audiochip_init_module
id|module_init
c_func
(paren
id|audiochip_init_module
)paren
suffix:semicolon
DECL|variable|audiochip_cleanup_module
id|module_exit
c_func
(paren
id|audiochip_cleanup_module
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
