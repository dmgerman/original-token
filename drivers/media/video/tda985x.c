multiline_comment|/*&n; * For the TDA9850 and TDA9855 chips&n; * (The TDA9855 is used on the Diamond DTV2000 and the TDA9850 is used &n; * on STB cards.  Other cards probably use these chips as well.)&n; * This driver will not complain if used with any &n; * other i2c device with the same address.&n; *&n; * Copyright (c) 1999 Gerd Knorr&n; * TDA9850 code and TDA9855.c merger by Eric Sandeen (eric_sandeen@bigfoot.com) &n; * This code is placed under the terms of the GNU General Public License&n; * Based on tda9855.c by Steve VanDeBogart (vandebo@uclink.berkeley.edu)&n; * Which was based on tda8425.c by Greg Alexander (c) 1998&n; *&n; * Contributors:&n; * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; *&n; * OPTIONS:&n; * debug   - set to 1 if you&squot;d like to see debug messages&n; *         - set to 2 if you&squot;d like to be flooded with debug messages&n; * chip    - set to 9850 or 9855 to select your chip (default 9855)&n; *&n; * TODO:&n; *   Fix channel change bug - sound goes out when changeing channels, mute&n; *                            and unmote to fix. - Is this still here?&n; *   Fine tune sound&n; *   Get rest of capabilities into video_audio struct...&n; *&n; *  Revision  0.6 - resource allocation fixes in tda985x_attach (08/14/2000)&n; *  Revision  0.5 - cleaned up debugging messages, added debug level=2 &n; *  Revision: 0.4 - check for correct chip= insmod value&n; *                  also cleaned up comments a bit&n; *  Revision: 0.3 - took out extraneous tda985x_write in tda985x_command&n; *  Revision: 0.2 - added insmod option chip=&n; *  Revision: 0.1 - original version&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &quot;bttv.h&quot;
macro_line|#include &quot;audiochip.h&quot;
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|chip
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|chip
comma
l_string|&quot;Type of chip to handle: 9850 or 9855&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|variable|chip
r_static
r_int
id|chip
op_assign
l_int|9855
suffix:semicolon
multiline_comment|/* insmod parameter */
multiline_comment|/* Addresses to scan */
DECL|macro|I2C_TDA985x_L
mdefine_line|#define I2C_TDA985x_L        0xb4
DECL|macro|I2C_TDA985x_H
mdefine_line|#define I2C_TDA985x_H        0xb6
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
id|I2C_TDA985x_L
op_rshift
l_int|1
comma
id|I2C_TDA985x_H
op_rshift
l_int|1
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe
r_static
r_int
r_int
id|probe
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe_range
r_static
r_int
r_int
id|probe_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore
r_static
r_int
r_int
id|ignore
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore_range
r_static
r_int
r_int
id|ignore_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|force
r_static
r_int
r_int
id|force
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|addr_data
r_static
r_struct
id|i2c_client_address_data
id|addr_data
op_assign
(brace
id|normal_i2c
comma
id|normal_i2c_range
comma
id|probe
comma
id|probe_range
comma
id|ignore
comma
id|ignore_range
comma
id|force
)brace
suffix:semicolon
multiline_comment|/* This is a superset of the TDA9850 and TDA9855 members */
DECL|struct|tda985x
r_struct
id|tda985x
(brace
DECL|member|addr
r_int
id|addr
suffix:semicolon
DECL|member|rvol
DECL|member|lvol
r_int
id|rvol
comma
id|lvol
suffix:semicolon
DECL|member|bass
DECL|member|treble
DECL|member|sub
r_int
id|bass
comma
id|treble
comma
id|sub
suffix:semicolon
DECL|member|c4
DECL|member|c5
DECL|member|c6
DECL|member|c7
r_int
id|c4
comma
id|c5
comma
id|c6
comma
id|c7
suffix:semicolon
DECL|member|a1
DECL|member|a2
DECL|member|a3
r_int
id|a1
comma
id|a2
comma
id|a3
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk  if (debug) printk
DECL|macro|d2printk
mdefine_line|#define d2printk if (debug == 2) printk
multiline_comment|/* The TDA9850 and TDA9855 are both made by Philips Semiconductor&n; * http://www.semiconductors.philips.com&n; * TDA9850: I2C-bus controlled BTSC stereo/SAP decoder&n; * TDA9855: I2C-bus controlled BTSC stereo/SAP decoder and audio processor&n; *&n; * The TDA9850 has more or less a subset of the functions that the TDA9855&n; * has.  As a result, we can re-use many of these defines.  Anything with&n; * TDA9855 is specific to that chip, anything with TDA9850 is specific&n; * to that chip, and anything with TDA985x is valid for either.&n; *&n; * To complicate things further, the TDA9850 uses labels C1 through C4&n; * for subaddresses 0x04 through 0x07, while the TDA9855 uses&n; * C1 through C3 for subadresses 0x05 through 0x07 - quite confusing.&n; * To help keep things straight, I have renamed the various C[1,4] labels&n; * to C[4,7] so that the numerical label matches the hex value of the&n; * subaddress for both chips.  At least the A[1,3] labels line up.  :)&n; */
multiline_comment|/* subaddresses for TDA9855 */
DECL|macro|TDA9855_VR
mdefine_line|#define TDA9855_VR&t;0x00 /* Volume, right */
DECL|macro|TDA9855_VL
mdefine_line|#define TDA9855_VL&t;0x01 /* Volume, left */
DECL|macro|TDA9855_BA
mdefine_line|#define TDA9855_BA&t;0x02 /* Bass */
DECL|macro|TDA9855_TR
mdefine_line|#define TDA9855_TR&t;0x03 /* Treble */
DECL|macro|TDA9855_SW
mdefine_line|#define TDA9855_SW&t;0x04 /* Subwoofer - not connected on DTV2000 */
multiline_comment|/* subaddresses for TDA9850 */
DECL|macro|TDA9850_C4
mdefine_line|#define TDA9850_C4&t;0x04 /* Control 1 for TDA9850 */
multiline_comment|/* subaddesses for both chips */
DECL|macro|TDA985x_C5
mdefine_line|#define TDA985x_C5&t;0x05 /* Control 2 for TDA9850, Control 1 for TDA9855 */
DECL|macro|TDA985x_C6
mdefine_line|#define TDA985x_C6&t;0x06 /* Control 3 for TDA9850, Control 2 for TDA9855 */
DECL|macro|TDA985x_C7
mdefine_line|#define TDA985x_C7&t;0x07 /* Control 4 for TDA9850, Control 3 for TDA9855 */
DECL|macro|TDA985x_A1
mdefine_line|#define TDA985x_A1&t;0x08 /* Alignment 1 for both chips */
DECL|macro|TDA985x_A2
mdefine_line|#define TDA985x_A2&t;0x09 /* Alignment 2 for both chips */
DECL|macro|TDA985x_A3
mdefine_line|#define TDA985x_A3&t;0x0a /* Alignment 3 for both chips */
multiline_comment|/* Masks for bits in TDA9855 subaddresses */
multiline_comment|/* 0x00 - VR in TDA9855 */
multiline_comment|/* 0x01 - VL in TDA9855 */
multiline_comment|/* lower 7 bits control gain from -71dB (0x28) to 16dB (0x7f)&n; * in 1dB steps - mute is 0x27 */
multiline_comment|/* 0x02 - BA in TDA9855 */
multiline_comment|/* lower 5 bits control bass gain from -12dB (0x06) to 16.5dB (0x19)&n; * in .5dB steps - 0 is 0x0E */
multiline_comment|/* 0x03 - TR in TDA9855 */
multiline_comment|/* 4 bits &lt;&lt; 1 control treble gain from -12dB (0x3) to 12dB (0xb)&n; * in 3dB steps - 0 is 0x7 */
multiline_comment|/* Masks for bits in both chips&squot; subaddresses */
multiline_comment|/* 0x04 - SW in TDA9855, C4/Control 1 in TDA9850 */
multiline_comment|/* Unique to TDA9855: */
multiline_comment|/* 4 bits &lt;&lt; 2 control subwoofer/surround gain from -14db (0x1) to 14db (0xf)&n; * in 3dB steps - mute is 0x0 */
multiline_comment|/* Unique to TDA9850: */
multiline_comment|/* lower 4 bits control stereo noise threshold, over which stereo turns off&n; * set to values of 0x00 through 0x0f for Ster1 through Ster16 */
multiline_comment|/* 0x05 - C5 - Control 1 in TDA9855 , Control 2 in TDA9850*/
multiline_comment|/* Unique to TDA9855: */
DECL|macro|TDA9855_MUTE
mdefine_line|#define TDA9855_MUTE&t;1&lt;&lt;7 /* GMU, Mute at outputs */
DECL|macro|TDA9855_AVL
mdefine_line|#define TDA9855_AVL&t;1&lt;&lt;6 /* AVL, Automatic Volume Level */
DECL|macro|TDA9855_LOUD
mdefine_line|#define TDA9855_LOUD&t;1&lt;&lt;5 /* Loudness, 1==off */
DECL|macro|TDA9855_SUR
mdefine_line|#define TDA9855_SUR&t;1&lt;&lt;3 /* Surround / Subwoofer 1==.5(L-R) 0==.5(L+R) */
multiline_comment|/* Bits 0 to 3 select various combinations&n;                              * of line in and line out, only the &n;                              * interesting ones are defined */
DECL|macro|TDA9855_EXT
mdefine_line|#define TDA9855_EXT&t;1&lt;&lt;2 /* Selects inputs LIR and LIL.  Pins 41 &amp; 12 */
DECL|macro|TDA9855_INT
mdefine_line|#define TDA9855_INT&t;0    /* Selects inputs LOR and LOL.  (internal) */
multiline_comment|/* Unique to TDA9850:  */
multiline_comment|/* lower 4 bits contol SAP noise threshold, over which SAP turns off&n; * set to values of 0x00 through 0x0f for SAP1 through SAP16 */
multiline_comment|/* 0x06 - C6 - Control 2 in TDA9855, Control 3 in TDA9850 */
multiline_comment|/* Common to TDA9855 and TDA9850: */
DECL|macro|TDA985x_SAP
mdefine_line|#define TDA985x_SAP&t;3&lt;&lt;6 /* Selects SAP output, mute if not received */
DECL|macro|TDA985x_STEREO
mdefine_line|#define TDA985x_STEREO&t;1&lt;&lt;6 /* Selects Stereo ouput, mono if not received */
DECL|macro|TDA985x_MONO
mdefine_line|#define TDA985x_MONO&t;0    /* Forces Mono output */
DECL|macro|TDA985x_LMU
mdefine_line|#define TDA985x_LMU&t;1&lt;&lt;3 /* Mute (LOR/LOL for 9855, OUTL/OUTR for 9850) */
multiline_comment|/* Unique to TDA9855: */
DECL|macro|TDA9855_TZCM
mdefine_line|#define TDA9855_TZCM&t;1&lt;&lt;5 /* If set, don&squot;t mute till zero crossing */
DECL|macro|TDA9855_VZCM
mdefine_line|#define TDA9855_VZCM&t;1&lt;&lt;4 /* If set, don&squot;t change volume till zero crossing*/
DECL|macro|TDA9855_LINEAR
mdefine_line|#define TDA9855_LINEAR&t;0    /* Linear Stereo */
DECL|macro|TDA9855_PSEUDO
mdefine_line|#define TDA9855_PSEUDO&t;1    /* Pseudo Stereo */
DECL|macro|TDA9855_SPAT_30
mdefine_line|#define TDA9855_SPAT_30&t;2    /* Spatial Stereo, 30% anti-phase crosstalk */
DECL|macro|TDA9855_SPAT_50
mdefine_line|#define TDA9855_SPAT_50&t;3    /* Spatial Stereo, 52% anti-phase crosstalk */
DECL|macro|TDA9855_E_MONO
mdefine_line|#define TDA9855_E_MONO&t;7    /* Forced mono - mono select elseware, so useless*/
multiline_comment|/* 0x07 - C7 - Control 3 in TDA9855, Control 4 in TDA9850 */
multiline_comment|/* Common to both TDA9855 and TDA9850: */
multiline_comment|/* lower 4 bits control input gain from -3.5dB (0x0) to 4dB (0xF)&n; * in .5dB steps -  0dB is 0x7 */
multiline_comment|/* 0x08, 0x09 - A1 and A2 (read/write) */
multiline_comment|/* Common to both TDA9855 and TDA9850: */
multiline_comment|/* lower 5 bites are wideband and spectral expander alignment&n; * from 0x00 to 0x1f - nominal at 0x0f and 0x10 (read/write) */
DECL|macro|TDA985x_STP
mdefine_line|#define TDA985x_STP&t;1&lt;&lt;5 /* Stereo Pilot/detect (read-only) */
DECL|macro|TDA985x_SAPP
mdefine_line|#define TDA985x_SAPP&t;1&lt;&lt;6 /* SAP Pilot/detect (read-only) */
DECL|macro|TDA985x_STS
mdefine_line|#define TDA985x_STS&t;1&lt;&lt;7 /* Stereo trigger 1= &lt;35mV 0= &lt;30mV (write-only)*/
multiline_comment|/* 0x0a - A3 */
multiline_comment|/* Common to both TDA9855 and TDA9850: */
multiline_comment|/* lower 3 bits control timing current for alignment: -30% (0x0), -20% (0x1),&n; * -10% (0x2), nominal (0x3), +10% (0x6), +20% (0x5), +30% (0x4) */
DECL|macro|TDA985x_ADJ
mdefine_line|#define TDA985x_ADJ&t;1&lt;&lt;7 /* Stereo adjust on/off (wideband and spectral */
multiline_comment|/* Unique to TDA9855: */
multiline_comment|/* 2 bits &lt;&lt; 5 control AVL attack time: 420ohm (0x0), 730ohm (0x2), &n; * 1200ohm (0x1), 2100ohm (0x3) */
multiline_comment|/* Begin code */
DECL|function|tda985x_write
r_static
r_int
id|tda985x_write
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|subaddr
comma
r_int
id|val
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|2
)braket
suffix:semicolon
id|d2printk
c_func
(paren
l_string|&quot;tda985x: In tda985x_write&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tda985x: Writing %d 0x%x&bslash;n&quot;
comma
id|subaddr
comma
id|val
)paren
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
id|subaddr
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
id|i2c_master_send
c_func
(paren
id|client
comma
id|buffer
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tda985x: I/O error, trying (write %d 0x%x)&bslash;n&quot;
comma
id|subaddr
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda985x_read
r_static
r_int
id|tda985x_read
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
r_char
id|buffer
suffix:semicolon
id|d2printk
c_func
(paren
l_string|&quot;tda985x: In tda985x_read&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_ne
id|i2c_master_recv
c_func
(paren
id|client
comma
op_amp
id|buffer
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tda985x: I/O error, trying (read)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;tda985x: Read 0x%02x&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
DECL|function|tda985x_set
r_static
r_int
id|tda985x_set
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tda985x
op_star
id|t
op_assign
id|client-&gt;data
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|16
)braket
suffix:semicolon
id|d2printk
c_func
(paren
l_string|&quot;tda985x: In tda985x_set&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|9855
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;tda985x: tda985x_set(0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x)&bslash;n&quot;
comma
id|t-&gt;rvol
comma
id|t-&gt;lvol
comma
id|t-&gt;bass
comma
id|t-&gt;treble
comma
id|t-&gt;sub
comma
id|t-&gt;c5
comma
id|t-&gt;c6
comma
id|t-&gt;c7
comma
id|t-&gt;a1
comma
id|t-&gt;a2
comma
id|t-&gt;a3
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|TDA9855_VR
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|t-&gt;rvol
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|t-&gt;lvol
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
id|t-&gt;bass
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
id|t-&gt;treble
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
id|t-&gt;sub
suffix:semicolon
id|buf
(braket
l_int|6
)braket
op_assign
id|t-&gt;c5
suffix:semicolon
id|buf
(braket
l_int|7
)braket
op_assign
id|t-&gt;c6
suffix:semicolon
id|buf
(braket
l_int|8
)braket
op_assign
id|t-&gt;c7
suffix:semicolon
id|buf
(braket
l_int|9
)braket
op_assign
id|t-&gt;a1
suffix:semicolon
id|buf
(braket
l_int|10
)braket
op_assign
id|t-&gt;a2
suffix:semicolon
id|buf
(braket
l_int|11
)braket
op_assign
id|t-&gt;a3
suffix:semicolon
r_if
c_cond
(paren
l_int|12
op_ne
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|12
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tda985x: I/O error, trying tda985x_set&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|chip
op_eq
l_int|9850
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;tda986x: tda985x_set(0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x)&bslash;n&quot;
comma
id|t-&gt;c4
comma
id|t-&gt;c5
comma
id|t-&gt;c6
comma
id|t-&gt;c7
comma
id|t-&gt;a1
comma
id|t-&gt;a2
comma
id|t-&gt;a3
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|TDA9850_C4
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|t-&gt;c4
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|t-&gt;c5
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
id|t-&gt;c6
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
id|t-&gt;c7
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
id|t-&gt;a1
suffix:semicolon
id|buf
(braket
l_int|6
)braket
op_assign
id|t-&gt;a2
suffix:semicolon
id|buf
(braket
l_int|7
)braket
op_assign
id|t-&gt;a3
suffix:semicolon
r_if
c_cond
(paren
l_int|8
op_ne
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tda985x: I/O error, trying tda985x_set&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_tda985x_init
r_static
r_void
id|do_tda985x_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tda985x
op_star
id|t
op_assign
id|client-&gt;data
suffix:semicolon
id|d2printk
c_func
(paren
l_string|&quot;tda985x: In tda985x_init&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|9855
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tda985x: Using tda9855 options&bslash;n&quot;
)paren
suffix:semicolon
id|t-&gt;rvol
op_assign
l_int|0x6f
suffix:semicolon
multiline_comment|/* 0dB */
id|t-&gt;lvol
op_assign
l_int|0x6f
suffix:semicolon
multiline_comment|/* 0dB */
id|t-&gt;bass
op_assign
l_int|0x0e
suffix:semicolon
multiline_comment|/* 0dB */
id|t-&gt;treble
op_assign
(paren
l_int|0x07
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 0dB */
id|t-&gt;sub
op_assign
l_int|0x8
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* 0dB */
id|t-&gt;c5
op_assign
id|TDA9855_MUTE
op_or
id|TDA9855_AVL
op_or
id|TDA9855_LOUD
op_or
id|TDA9855_INT
suffix:semicolon
multiline_comment|/* Set Mute, AVL, Loudness off, Internal sound */
id|t-&gt;c6
op_assign
id|TDA985x_STEREO
op_or
id|TDA9855_LINEAR
op_or
id|TDA9855_TZCM
op_or
id|TDA9855_VZCM
suffix:semicolon
multiline_comment|/* Stereo linear mode, also wait til zero crossings  */
id|t-&gt;c7
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 0dB input gain */
)brace
r_else
r_if
c_cond
(paren
id|chip
op_eq
l_int|9850
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tda985x: Using tda9850 options&bslash;n&quot;
)paren
suffix:semicolon
id|t-&gt;c4
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* Set stereo noise thresh to nominal */
id|t-&gt;c5
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* Set SAP noise threshold to nominal */
id|t-&gt;c6
op_assign
id|TDA985x_STEREO
suffix:semicolon
multiline_comment|/* Select Stereo mode for decoder */
id|t-&gt;c7
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 0dB input gain */
)brace
multiline_comment|/* The following is valid for both chip types */
id|t-&gt;a1
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Select nominal wideband expander */
id|t-&gt;a2
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Select nominal spectral expander and 30mV trigger */
id|t-&gt;a3
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* Set: nominal timing current, 420ohm AVL attack */
id|tda985x_set
c_func
(paren
id|client
)paren
suffix:semicolon
)brace
multiline_comment|/* *********************** *&n; * i2c interface functions *&n; * *********************** */
DECL|function|tda985x_attach
r_static
r_int
id|tda985x_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
r_int
id|flags
comma
r_int
id|kind
)paren
(brace
r_struct
id|tda985x
op_star
id|t
suffix:semicolon
r_struct
id|i2c_client
op_star
id|client
suffix:semicolon
id|d2printk
c_func
(paren
l_string|&quot;tda985x: In tda985x_attach&bslash;n&quot;
)paren
suffix:semicolon
id|client
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|client
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|client
comma
op_amp
id|client_template
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|client-&gt;adapter
op_assign
id|adap
suffix:semicolon
id|client-&gt;addr
op_assign
id|addr
suffix:semicolon
id|client-&gt;data
op_assign
id|t
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|t
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t
)paren
(brace
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|t
comma
l_int|0
comma
r_sizeof
op_star
id|t
)paren
suffix:semicolon
id|do_tda985x_init
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|strcpy
c_func
(paren
id|client-&gt;name
comma
l_string|&quot;TDA985x&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tda985x: init&bslash;n&quot;
)paren
suffix:semicolon
id|i2c_attach_client
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda985x_probe
r_static
r_int
id|tda985x_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_if
c_cond
(paren
id|adap-&gt;id
op_eq
(paren
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_BT848
)paren
)paren
r_return
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|tda985x_attach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda985x_detach
r_static
r_int
id|tda985x_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tda985x
op_star
id|t
op_assign
id|client-&gt;data
suffix:semicolon
id|do_tda985x_init
c_func
(paren
id|client
)paren
suffix:semicolon
id|i2c_detach_client
c_func
(paren
id|client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|t
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda985x_command
r_static
r_int
id|tda985x_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|tda985x
op_star
id|t
op_assign
id|client-&gt;data
suffix:semicolon
id|d2printk
c_func
(paren
l_string|&quot;tda985x: In tda985x_command&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|__u16
op_star
id|sarg
op_assign
id|arg
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* --- v4l ioctls --- */
multiline_comment|/* take care: bttv does userspace copying, we&squot;ll get a&n;&t;   kernel pointer here... */
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tda985x: VIDIOCGAUDIO&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|9855
)paren
(brace
r_int
id|left
comma
id|right
suffix:semicolon
id|va-&gt;flags
op_or_assign
id|VIDEO_AUDIO_VOLUME
op_or
id|VIDEO_AUDIO_BASS
op_or
id|VIDEO_AUDIO_TREBLE
suffix:semicolon
multiline_comment|/* min is 0x27 max is 0x7f, vstep is 2e8 */
id|left
op_assign
(paren
id|t-&gt;lvol
op_minus
l_int|0x27
)paren
op_star
l_int|0x2e8
suffix:semicolon
id|right
op_assign
(paren
id|t-&gt;rvol
op_minus
l_int|0x27
)paren
op_star
l_int|0x2e8
suffix:semicolon
id|va-&gt;volume
op_assign
id|MAX
c_func
(paren
id|left
comma
id|right
)paren
suffix:semicolon
id|va-&gt;balance
op_assign
(paren
l_int|32768
op_star
id|MIN
c_func
(paren
id|left
comma
id|right
)paren
)paren
op_div
(paren
id|va-&gt;volume
ques
c_cond
id|va-&gt;volume
suffix:colon
l_int|1
)paren
suffix:semicolon
id|va-&gt;balance
op_assign
(paren
id|left
OL
id|right
)paren
ques
c_cond
(paren
l_int|65535
op_minus
id|va-&gt;balance
)paren
suffix:colon
id|va-&gt;balance
suffix:semicolon
id|va-&gt;bass
op_assign
(paren
id|t-&gt;bass
op_minus
l_int|0x6
)paren
op_star
l_int|0xccc
suffix:semicolon
multiline_comment|/* min 0x6 max 0x19 */
id|va-&gt;treble
op_assign
(paren
(paren
id|t-&gt;treble
op_rshift
l_int|1
)paren
op_minus
l_int|0x3
)paren
op_star
l_int|0x1c71
suffix:semicolon
)brace
multiline_comment|/* Valid for both chips: */
(brace
id|va-&gt;mode
op_assign
(paren
(paren
id|TDA985x_STP
op_or
id|TDA985x_SAPP
)paren
op_amp
id|tda985x_read
c_func
(paren
id|client
)paren
)paren
op_rshift
l_int|4
suffix:semicolon
multiline_comment|/* Add mono mode regardless of SAP and stereo */
multiline_comment|/* Allows forced mono */
id|va-&gt;mode
op_or_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* VIDIOCGAUDIO case */
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tda985x: VIDEOCSAUDIO&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|9855
)paren
(brace
r_int
id|left
comma
id|right
suffix:semicolon
id|left
op_assign
(paren
id|MIN
c_func
(paren
l_int|65536
op_minus
id|va-&gt;balance
comma
l_int|32768
)paren
op_star
id|va-&gt;volume
)paren
op_div
l_int|32768
suffix:semicolon
id|right
op_assign
(paren
id|MIN
c_func
(paren
id|va-&gt;balance
comma
l_int|32768
)paren
op_star
id|va-&gt;volume
)paren
op_div
l_int|32768
suffix:semicolon
id|t-&gt;lvol
op_assign
id|left
op_div
l_int|0x2e8
op_plus
l_int|0x27
suffix:semicolon
id|t-&gt;rvol
op_assign
id|right
op_div
l_int|0x2e8
op_plus
l_int|0x27
suffix:semicolon
id|t-&gt;bass
op_assign
id|va-&gt;bass
op_div
l_int|0xccc
op_plus
l_int|0x6
suffix:semicolon
id|t-&gt;treble
op_assign
(paren
id|va-&gt;treble
op_div
l_int|0x1c71
op_plus
l_int|0x3
)paren
op_lshift
l_int|1
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA9855_VL
comma
id|t-&gt;lvol
)paren
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA9855_VR
comma
id|t-&gt;rvol
)paren
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA9855_BA
comma
id|t-&gt;bass
)paren
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA9855_TR
comma
id|t-&gt;treble
)paren
suffix:semicolon
)brace
multiline_comment|/* The following is valid for both chips */
r_switch
c_cond
(paren
id|va-&gt;mode
)paren
(brace
r_case
id|VIDEO_SOUND_MONO
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;tda985x: VIDEO_SOUND_MONO&bslash;n&quot;
)paren
suffix:semicolon
id|t-&gt;c6
op_assign
id|TDA985x_MONO
op_or
(paren
id|t-&gt;c6
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA985x_C6
comma
id|t-&gt;c6
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;tda985x: VIDEO_SOUND_STEREO&bslash;n&quot;
)paren
suffix:semicolon
id|t-&gt;c6
op_assign
id|TDA985x_STEREO
op_or
(paren
id|t-&gt;c6
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA985x_C6
comma
id|t-&gt;c6
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;tda985x: VIDEO_SOUND_LANG1&bslash;n&quot;
)paren
suffix:semicolon
id|t-&gt;c6
op_assign
id|TDA985x_SAP
op_or
(paren
id|t-&gt;c6
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|tda985x_write
c_func
(paren
id|client
comma
id|TDA985x_C6
comma
id|t-&gt;c6
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* End of (va-&gt;mode) switch */
r_break
suffix:semicolon
)brace
multiline_comment|/* end of VIDEOCSAUDIO case */
r_default
suffix:colon
multiline_comment|/* Not VIDEOCGAUDIO or VIDEOCSAUDIO */
multiline_comment|/* nothing */
id|d2printk
c_func
(paren
l_string|&quot;tda985x: Default&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end of (cmd) switch */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
l_string|&quot;i2c tda985x driver&quot;
comma
id|I2C_DRIVERID_TDA9855
comma
multiline_comment|/* Get new one for TDA985x? */
id|I2C_DF_NOTIFY
comma
id|tda985x_probe
comma
id|tda985x_detach
comma
id|tda985x_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
l_string|&quot;(unset)&quot;
comma
multiline_comment|/* name */
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|driver
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|tda985x_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_if
c_cond
(paren
(paren
id|chip
op_ne
l_int|9850
)paren
op_logical_and
(paren
id|chip
op_ne
l_int|9855
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tda985x: chip parameter must be 9850 or 9855&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
