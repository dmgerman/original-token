multiline_comment|/*&n; *&t;Media Vision Pro Movie Studio&n; *&t;&t;&t;or&n; *&t;&quot;all you need is an I2C bus some RAM and a prayer&quot;&n; *&n; *&t;This draws heavily on code&n; *&n; *&t;(c) Wolfgang Koehler,  wolf@first.gmd.de, Dec. 1994&n; *&t;Kiefernring 15&n; *&t;14478 Potsdam, Germany&n; *&n; *&t;Most of this code is directly derived from his userspace driver.&n; *&t;His driver works so send any reports to alan@redhat.com unless the&n; *&t;userspace driver also doesnt work for you...&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|MOTOROLA
mdefine_line|#define MOTOROLA&t;1
DECL|macro|PHILIPS2
mdefine_line|#define PHILIPS2&t;2
DECL|macro|PHILIPS1
mdefine_line|#define PHILIPS1&t;3
DECL|macro|MVVMEMORYWIDTH
mdefine_line|#define MVVMEMORYWIDTH&t;0x40&t;&t;/* 512 bytes */
DECL|struct|pms_device
r_struct
id|pms_device
(brace
DECL|member|v
r_struct
id|video_device
id|v
suffix:semicolon
DECL|member|picture
r_struct
id|video_picture
id|picture
suffix:semicolon
DECL|member|height
r_int
id|height
suffix:semicolon
DECL|member|width
r_int
id|width
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|i2c_info
r_struct
id|i2c_info
(brace
DECL|member|slave
id|u8
id|slave
suffix:semicolon
DECL|member|sub
id|u8
id|sub
suffix:semicolon
DECL|member|data
id|u8
id|data
suffix:semicolon
DECL|member|hits
id|u8
id|hits
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|i2c_count
r_static
r_int
id|i2c_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|i2cinfo
r_static
r_struct
id|i2c_info
id|i2cinfo
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|decoder
r_static
r_int
id|decoder
op_assign
id|PHILIPS2
suffix:semicolon
DECL|variable|standard
r_static
r_int
id|standard
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0 - auto 1 - ntsc 2 - pal 3 - secam */
multiline_comment|/*&n; *&t;I/O ports and Shared Memory&n; */
DECL|variable|io_port
r_static
r_int
id|io_port
op_assign
l_int|0x250
suffix:semicolon
DECL|variable|data_port
r_static
r_int
id|data_port
op_assign
l_int|0x251
suffix:semicolon
DECL|variable|mem_base
r_static
r_int
id|mem_base
op_assign
l_int|0xC8000
suffix:semicolon
DECL|function|mvv_write
r_extern
id|__inline__
r_void
id|mvv_write
c_func
(paren
id|u8
id|index
comma
id|u8
id|value
)paren
(brace
id|outw
c_func
(paren
id|index
op_or
(paren
id|value
op_lshift
l_int|8
)paren
comma
id|io_port
)paren
suffix:semicolon
)brace
DECL|function|mvv_read
r_extern
id|__inline__
id|u8
id|mvv_read
c_func
(paren
id|u8
id|index
)paren
(brace
id|outb
c_func
(paren
id|index
comma
id|io_port
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|data_port
)paren
suffix:semicolon
)brace
DECL|function|pms_i2c_stat
r_static
r_int
id|pms_i2c_stat
c_func
(paren
id|u8
id|slave
)paren
(brace
r_int
id|counter
suffix:semicolon
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
l_int|0x28
comma
id|io_port
)paren
suffix:semicolon
id|counter
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_port
)paren
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|counter
op_increment
op_eq
l_int|256
)paren
(brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_port
)paren
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|counter
op_increment
op_eq
l_int|256
)paren
(brace
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|slave
comma
id|io_port
)paren
suffix:semicolon
id|counter
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_port
)paren
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|counter
op_increment
op_eq
l_int|256
)paren
(brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_port
)paren
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|counter
op_increment
op_eq
l_int|256
)paren
(brace
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|st
op_assign
id|inb
c_func
(paren
id|data_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|st
op_amp
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|st
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
l_int|0x29
comma
id|io_port
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|data_port
)paren
suffix:semicolon
)brace
DECL|function|pms_i2c_write
r_static
r_int
id|pms_i2c_write
c_func
(paren
id|u16
id|slave
comma
id|u16
id|sub
comma
id|u16
id|data
)paren
(brace
r_int
id|skip
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|i2c_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i2cinfo
(braket
id|i
)braket
dot
id|slave
op_eq
id|slave
)paren
op_logical_and
(paren
id|i2cinfo
(braket
id|i
)braket
dot
id|sub
op_eq
id|sub
)paren
)paren
(brace
r_if
c_cond
(paren
id|i2cinfo
(braket
id|i
)braket
dot
id|data
op_eq
id|data
)paren
(brace
id|skip
op_assign
l_int|1
suffix:semicolon
)brace
id|i2cinfo
(braket
id|i
)braket
dot
id|data
op_assign
id|data
suffix:semicolon
id|i
op_assign
id|i2c_count
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|i2c_count
op_logical_and
id|i2c_count
OL
l_int|64
)paren
(brace
id|i2cinfo
(braket
id|i2c_count
)braket
dot
id|slave
op_assign
id|slave
suffix:semicolon
id|i2cinfo
(braket
id|i2c_count
)braket
dot
id|sub
op_assign
id|sub
suffix:semicolon
id|i2cinfo
(braket
id|i2c_count
)braket
dot
id|data
op_assign
id|data
suffix:semicolon
id|i2c_count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skip
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|mvv_write
c_func
(paren
l_int|0x29
comma
id|sub
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x2A
comma
id|data
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x28
comma
id|slave
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x28
comma
id|io_port
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_port
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|count
OG
l_int|255
)paren
(brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|data_port
)paren
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|count
OG
l_int|255
)paren
(brace
r_break
suffix:semicolon
)brace
id|count
op_assign
id|inb
c_func
(paren
id|data_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_amp
l_int|2
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|pms_i2c_read
r_static
r_int
id|pms_i2c_read
c_func
(paren
r_int
id|slave
comma
r_int
id|sub
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|i2c_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2cinfo
(braket
id|i
)braket
dot
id|slave
op_eq
id|slave
op_logical_and
id|i2cinfo
(braket
id|i
)braket
dot
id|sub
op_eq
id|sub
)paren
(brace
r_return
id|i2cinfo
(braket
id|i
)braket
dot
id|data
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pms_i2c_andor
r_static
r_void
id|pms_i2c_andor
c_func
(paren
r_int
id|slave
comma
r_int
id|sub
comma
r_int
op_logical_and
comma
r_int
op_logical_or
)paren
(brace
id|u8
id|tmp
suffix:semicolon
id|tmp
op_assign
id|pms_i2c_read
c_func
(paren
id|slave
comma
id|sub
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|tmp
op_amp
op_logical_and
)paren
op_or
op_logical_or
suffix:semicolon
id|pms_i2c_write
c_func
(paren
id|slave
comma
id|sub
comma
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Control functions&n; */
DECL|function|pms_videosource
r_static
r_void
id|pms_videosource
c_func
(paren
r_int
id|source
)paren
(brace
id|mvv_write
c_func
(paren
l_int|0x2E
comma
id|source
ques
c_cond
l_int|0x31
suffix:colon
l_int|0x30
)paren
suffix:semicolon
)brace
DECL|function|pms_hue
r_static
r_void
id|pms_hue
c_func
(paren
r_int
id|hue
)paren
(brace
r_switch
c_cond
(paren
id|decoder
)paren
(brace
r_case
id|MOTOROLA
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x00
comma
id|hue
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHILIPS2
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x07
comma
id|hue
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHILIPS1
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x07
comma
id|hue
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|pms_colour
r_static
r_void
id|pms_colour
c_func
(paren
r_int
id|colour
)paren
(brace
r_switch
c_cond
(paren
id|decoder
)paren
(brace
r_case
id|MOTOROLA
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x00
comma
id|colour
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHILIPS1
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x12
comma
id|colour
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|pms_contrast
r_static
r_void
id|pms_contrast
c_func
(paren
r_int
id|contrast
)paren
(brace
r_switch
c_cond
(paren
id|decoder
)paren
(brace
r_case
id|MOTOROLA
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x00
comma
id|contrast
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHILIPS1
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x13
comma
id|contrast
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|pms_brightness
r_static
r_void
id|pms_brightness
c_func
(paren
r_int
id|brightness
)paren
(brace
r_switch
c_cond
(paren
id|decoder
)paren
(brace
r_case
id|MOTOROLA
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x00
comma
id|brightness
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x00
comma
id|brightness
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x00
comma
id|brightness
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHILIPS1
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x19
comma
id|brightness
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|pms_format
r_static
r_void
id|pms_format
c_func
(paren
r_int
id|format
)paren
(brace
r_int
id|target
suffix:semicolon
id|standard
op_assign
id|format
suffix:semicolon
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|target
op_assign
l_int|0x42
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|target
op_assign
l_int|0x8A
suffix:semicolon
)brace
r_else
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Auto */
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0D
comma
l_int|0xFE
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0F
comma
l_int|0x3F
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* NTSC */
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0D
comma
l_int|0xFE
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0F
comma
l_int|0x3F
comma
l_int|0x40
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* PAL */
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0D
comma
l_int|0xFE
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0F
comma
l_int|0x3F
comma
l_int|0x00
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* SECAM */
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0D
comma
l_int|0xFE
comma
l_int|0x01
)paren
suffix:semicolon
id|pms_i2c_andor
c_func
(paren
id|target
comma
l_int|0x0F
comma
l_int|0x3F
comma
l_int|0x00
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#ifdef FOR_FUTURE_EXPANSION
multiline_comment|/*&n; *&t;These features of the PMS card are not currently exposes. They&n; *&t;could become a private v4l ioctl for PMSCONFIG or somesuch if &n; *&t;people need it. We also don&squot;t yet use the PMS interrupt.&n; */
DECL|function|pms_hstart
r_static
r_void
id|pms_hstart
c_func
(paren
r_int
id|start
)paren
(brace
r_switch
c_cond
(paren
id|decoder
)paren
(brace
r_case
id|PHILIPS1
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x05
comma
id|start
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x18
comma
id|start
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHILIPS2
suffix:colon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x05
comma
id|start
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x18
comma
id|start
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Bandpass filters&n; */
DECL|function|pms_bandpass
r_static
r_void
id|pms_bandpass
c_func
(paren
r_int
id|pass
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x06
comma
l_int|0xCF
comma
(paren
id|pass
op_amp
l_int|0x03
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x06
comma
l_int|0xCF
comma
(paren
id|pass
op_amp
l_int|0x03
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_antisnow
r_static
r_void
id|pms_antisnow
c_func
(paren
r_int
id|snow
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x06
comma
l_int|0xF3
comma
(paren
id|snow
op_amp
l_int|0x03
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x06
comma
l_int|0xF3
comma
(paren
id|snow
op_amp
l_int|0x03
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_sharpness
r_static
r_void
id|pms_sharpness
c_func
(paren
r_int
id|sharp
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x06
comma
l_int|0xFC
comma
id|sharp
op_amp
l_int|0x03
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x06
comma
l_int|0xFC
comma
id|sharp
op_amp
l_int|0x03
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_chromaagc
r_static
r_void
id|pms_chromaagc
c_func
(paren
r_int
id|agc
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x0C
comma
l_int|0x9F
comma
(paren
id|agc
op_amp
l_int|0x03
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x0C
comma
l_int|0x9F
comma
(paren
id|agc
op_amp
l_int|0x03
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_vertnoise
r_static
r_void
id|pms_vertnoise
c_func
(paren
r_int
id|noise
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x10
comma
l_int|0xFC
comma
id|noise
op_amp
l_int|3
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x10
comma
l_int|0xFC
comma
id|noise
op_amp
l_int|3
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_forcecolour
r_static
r_void
id|pms_forcecolour
c_func
(paren
r_int
id|colour
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x0C
comma
l_int|0x7F
comma
(paren
id|colour
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x0C
comma
l_int|0x7
comma
(paren
id|colour
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_antigamma
r_static
r_void
id|pms_antigamma
c_func
(paren
r_int
id|gamma
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0xB8
comma
l_int|0x00
comma
l_int|0x7F
comma
(paren
id|gamma
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x20
comma
l_int|0x7
comma
(paren
id|gamma
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_prefilter
r_static
r_void
id|pms_prefilter
c_func
(paren
r_int
id|filter
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x06
comma
l_int|0xBF
comma
(paren
id|filter
op_amp
l_int|1
)paren
op_lshift
l_int|6
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x06
comma
l_int|0xBF
comma
(paren
id|filter
op_amp
l_int|1
)paren
op_lshift
l_int|6
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_hfilter
r_static
r_void
id|pms_hfilter
c_func
(paren
r_int
id|filter
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0xB8
comma
l_int|0x04
comma
l_int|0x1F
comma
(paren
id|filter
op_amp
l_int|7
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x24
comma
l_int|0x1F
comma
(paren
id|filter
op_amp
l_int|7
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_vfilter
r_static
r_void
id|pms_vfilter
c_func
(paren
r_int
id|filter
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0xB8
comma
l_int|0x08
comma
l_int|0x9F
comma
(paren
id|filter
op_amp
l_int|3
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x28
comma
l_int|0x9F
comma
(paren
id|filter
op_amp
l_int|3
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_killcolour
r_static
r_void
id|pms_killcolour
c_func
(paren
r_int
id|colour
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x08
comma
l_int|0x07
comma
(paren
id|colour
op_amp
l_int|0x1F
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x09
comma
l_int|0x07
comma
(paren
id|colour
op_amp
l_int|0x1F
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x08
comma
l_int|0x07
comma
(paren
id|colour
op_amp
l_int|0x1F
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x09
comma
l_int|0x07
comma
(paren
id|colour
op_amp
l_int|0x1F
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_chromagain
r_static
r_void
id|pms_chromagain
c_func
(paren
r_int
id|chroma
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x11
comma
id|chroma
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x11
comma
id|chroma
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_spacialcompl
r_static
r_void
id|pms_spacialcompl
c_func
(paren
r_int
id|data
)paren
(brace
id|mvv_write
c_func
(paren
l_int|0x3B
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|pms_spacialcomph
r_static
r_void
id|pms_spacialcomph
c_func
(paren
r_int
id|data
)paren
(brace
id|mvv_write
c_func
(paren
l_int|0x3A
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|pms_vstart
r_static
r_void
id|pms_vstart
c_func
(paren
r_int
id|start
)paren
(brace
id|mvv_write
c_func
(paren
l_int|0x16
comma
id|start
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x17
comma
(paren
id|start
op_rshift
l_int|8
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|pms_secamcross
r_static
r_void
id|pms_secamcross
c_func
(paren
r_int
id|cross
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x0F
comma
l_int|0xDF
comma
(paren
id|cross
op_amp
l_int|1
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x0F
comma
l_int|0xDF
comma
(paren
id|cross
op_amp
l_int|1
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_swsense
r_static
r_void
id|pms_swsense
c_func
(paren
r_int
id|sense
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x0A
comma
id|sense
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
l_int|0x0B
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x0A
comma
id|sense
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0x42
comma
l_int|0x0B
comma
id|sense
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_framerate
r_static
r_void
id|pms_framerate
c_func
(paren
r_int
id|frr
)paren
(brace
r_int
id|fps
op_assign
(paren
id|standard
op_eq
l_int|1
)paren
ques
c_cond
l_int|30
suffix:colon
l_int|25
suffix:semicolon
r_if
c_cond
(paren
id|frr
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|fps
op_assign
id|fps
op_div
id|frr
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x14
comma
l_int|0x80
op_or
id|fps
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x15
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|pms_vert
r_static
r_void
id|pms_vert
c_func
(paren
id|u8
id|deciden
comma
id|u8
id|decinum
)paren
(brace
id|mvv_write
c_func
(paren
l_int|0x1C
comma
id|deciden
)paren
suffix:semicolon
multiline_comment|/* Denominator */
id|mvv_write
c_func
(paren
l_int|0x1D
comma
id|decinum
)paren
suffix:semicolon
multiline_comment|/* Numerator */
)brace
multiline_comment|/*&n; *&t;Turn 16bit ratios into best small ratio the chipset can grok&n; */
DECL|function|pms_vertdeci
r_static
r_void
id|pms_vertdeci
c_func
(paren
r_int
r_int
id|decinum
comma
r_int
r_int
id|deciden
)paren
(brace
multiline_comment|/* Knock it down by /5 once */
r_if
c_cond
(paren
id|decinum
op_mod
l_int|5
op_eq
l_int|0
)paren
(brace
id|deciden
op_div_assign
l_int|5
suffix:semicolon
id|decinum
op_div_assign
l_int|5
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;3&squot;s&n;&t; */
r_while
c_loop
(paren
id|decinum
op_mod
l_int|3
op_eq
l_int|0
op_logical_and
id|deciden
op_mod
l_int|3
op_eq
l_int|0
)paren
(brace
id|deciden
op_div_assign
l_int|3
suffix:semicolon
id|decinum
op_div_assign
l_int|3
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;2&squot;s&n;&t; */
r_while
c_loop
(paren
id|decinum
op_mod
l_int|2
op_eq
l_int|0
op_logical_and
id|deciden
op_mod
l_int|2
op_eq
l_int|0
)paren
(brace
id|decinum
op_div_assign
l_int|2
suffix:semicolon
id|deciden
op_div_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Fudgyify&n;&t; */
r_while
c_loop
(paren
id|deciden
OG
l_int|32
)paren
(brace
id|deciden
op_div_assign
l_int|2
suffix:semicolon
id|decinum
op_assign
(paren
id|decinum
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|deciden
op_eq
l_int|32
)paren
(brace
id|deciden
op_decrement
suffix:semicolon
)brace
id|pms_vert
c_func
(paren
id|deciden
comma
id|decinum
)paren
suffix:semicolon
)brace
DECL|function|pms_horzdeci
r_static
r_void
id|pms_horzdeci
c_func
(paren
r_int
id|decinum
comma
r_int
id|deciden
)paren
(brace
r_if
c_cond
(paren
id|decinum
op_le
l_int|512
)paren
(brace
r_if
c_cond
(paren
id|decinum
op_mod
l_int|5
op_eq
l_int|0
)paren
(brace
id|decinum
op_div_assign
l_int|5
suffix:semicolon
id|deciden
op_div_assign
l_int|5
suffix:semicolon
)brace
)brace
r_else
(brace
id|decinum
op_assign
l_int|512
suffix:semicolon
id|deciden
op_assign
l_int|640
suffix:semicolon
multiline_comment|/* 768 would be ideal */
)brace
r_while
c_loop
(paren
(paren
(paren
id|decinum
op_or
id|deciden
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|decinum
op_rshift_assign
l_int|1
suffix:semicolon
id|deciden
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|deciden
OG
l_int|32
)paren
(brace
id|deciden
op_rshift_assign
l_int|1
suffix:semicolon
id|decinum
op_assign
(paren
id|decinum
op_plus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|deciden
op_eq
l_int|32
)paren
(brace
id|deciden
op_decrement
suffix:semicolon
)brace
id|mvv_write
c_func
(paren
l_int|0x24
comma
l_int|0x80
op_or
id|deciden
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x25
comma
id|decinum
)paren
suffix:semicolon
)brace
DECL|function|pms_resolution
r_static
r_void
id|pms_resolution
c_func
(paren
r_int
id|width
comma
r_int
id|height
)paren
(brace
r_int
id|fg_height
suffix:semicolon
id|fg_height
op_assign
id|height
suffix:semicolon
r_if
c_cond
(paren
id|fg_height
OG
l_int|280
)paren
(brace
id|fg_height
op_assign
l_int|280
suffix:semicolon
)brace
id|mvv_write
c_func
(paren
l_int|0x18
comma
id|fg_height
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x19
comma
id|fg_height
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|standard
op_eq
l_int|1
)paren
(brace
id|mvv_write
c_func
(paren
l_int|0x1A
comma
l_int|0xFC
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x1B
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|height
OG
id|fg_height
)paren
(brace
id|pms_vertdeci
c_func
(paren
l_int|240
comma
l_int|240
)paren
suffix:semicolon
)brace
r_else
id|pms_vertdeci
c_func
(paren
id|fg_height
comma
l_int|240
)paren
suffix:semicolon
)brace
r_else
(brace
id|mvv_write
c_func
(paren
l_int|0x1A
comma
l_int|0x1A
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x1B
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fg_height
OG
l_int|256
)paren
(brace
id|pms_vertdeci
c_func
(paren
l_int|270
comma
l_int|270
)paren
suffix:semicolon
)brace
r_else
id|pms_vertdeci
c_func
(paren
id|fg_height
comma
l_int|270
)paren
suffix:semicolon
)brace
id|mvv_write
c_func
(paren
l_int|0x12
comma
l_int|0
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x13
comma
id|MVVMEMORYWIDTH
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x42
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x43
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x44
comma
id|MVVMEMORYWIDTH
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x22
comma
id|width
op_plus
l_int|8
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x23
comma
(paren
id|width
op_plus
l_int|8
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|standard
op_eq
l_int|1
)paren
(brace
id|pms_horzdeci
c_func
(paren
id|width
comma
l_int|640
)paren
suffix:semicolon
)brace
r_else
id|pms_horzdeci
c_func
(paren
id|width
op_plus
l_int|8
comma
l_int|768
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x30
comma
id|mvv_read
c_func
(paren
l_int|0x30
)paren
op_amp
l_int|0xFE
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x08
comma
id|mvv_read
c_func
(paren
l_int|0x08
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x01
comma
id|mvv_read
c_func
(paren
l_int|0x01
)paren
op_amp
l_int|0xFD
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x32
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x33
comma
id|MVVMEMORYWIDTH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set Input&n; */
DECL|function|pms_vcrinput
r_static
r_void
id|pms_vcrinput
c_func
(paren
r_int
id|input
)paren
(brace
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS2
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
l_int|0x0D
comma
l_int|0x7F
comma
(paren
id|input
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|decoder
op_eq
id|PHILIPS1
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x42
comma
l_int|0x0D
comma
l_int|0x7F
comma
(paren
id|input
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
)brace
DECL|function|pms_capture
r_static
r_int
id|pms_capture
c_func
(paren
r_struct
id|pms_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|rgb555
comma
r_int
id|count
)paren
(brace
r_int
id|y
suffix:semicolon
r_int
id|dw
op_assign
l_int|2
op_star
id|dev-&gt;width
suffix:semicolon
id|u32
id|src
op_assign
id|mem_base
suffix:semicolon
r_char
id|tmp
(braket
id|dw
op_plus
l_int|32
)braket
suffix:semicolon
multiline_comment|/* using a temp buffer is faster than direct  */
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|r8
op_assign
l_int|0x5
suffix:semicolon
multiline_comment|/* value for reg8  */
r_if
c_cond
(paren
id|rgb555
)paren
id|r8
op_or_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* else use untranslated rgb = 565 */
id|mvv_write
c_func
(paren
l_int|0x08
comma
id|r8
)paren
suffix:semicolon
multiline_comment|/* capture rgb555/565, init DRAM, PC enable */
multiline_comment|/*&t;printf(&quot;%d %d %d %d %d %x %x&bslash;n&quot;,width,height,voff,nom,den,mvv_buf); */
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|dev-&gt;height
suffix:semicolon
id|y
op_increment
)paren
(brace
id|isa_writeb
c_func
(paren
l_int|0
comma
id|src
)paren
suffix:semicolon
multiline_comment|/* synchronisiert neue Zeile */
multiline_comment|/*&n;&t;&t; *&t;This is in truth a fifo, be very careful as if you&n;&t;&t; *&t;forgot this odd things will occur 8)&n;&t;&t; */
id|isa_memcpy_fromio
c_func
(paren
id|tmp
comma
id|src
comma
id|dw
op_plus
l_int|32
)paren
suffix:semicolon
multiline_comment|/* discard 16 word   */
id|cnt
op_sub_assign
id|dev-&gt;height
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_le
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Don&squot;t copy too far&n;&t;&t;&t; */
r_int
id|dt
op_assign
id|dw
suffix:semicolon
r_if
c_cond
(paren
id|dt
op_plus
id|len
OG
id|count
)paren
(brace
id|dt
op_assign
id|count
op_minus
id|len
suffix:semicolon
)brace
id|cnt
op_add_assign
id|dev-&gt;height
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
id|tmp
op_plus
l_int|32
comma
id|dt
)paren
suffix:semicolon
id|buf
op_add_assign
id|dt
suffix:semicolon
id|len
op_add_assign
id|dt
suffix:semicolon
)brace
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Video4linux interfacing&n; */
DECL|function|pms_open
r_static
r_int
id|pms_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pms_close
r_static
r_void
id|pms_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|pms_write
r_static
r_int
id|pms_write
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pms_ioctl
r_static
r_int
id|pms_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|pms_device
op_star
id|pd
op_assign
(paren
r_struct
id|pms_device
op_star
)paren
id|dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
l_string|&quot;Mediavision PMS&quot;
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SCALES
suffix:semicolon
id|b.channels
op_assign
l_int|4
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
l_int|640
suffix:semicolon
id|b.maxheight
op_assign
l_int|480
suffix:semicolon
id|b.minwidth
op_assign
l_int|16
suffix:semicolon
id|b.minheight
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.channel
l_int|3
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Good question.. its composite or SVHS so.. */
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
r_switch
c_cond
(paren
id|v.channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Composite&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;SVideo&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Composite(VCR)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;SVideo(VCR)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v
l_int|3
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pms_videosource
c_func
(paren
id|v
op_amp
l_int|1
)paren
suffix:semicolon
id|pms_vcrinput
c_func
(paren
id|v
op_rshift
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.tuner
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Format&quot;
)paren
suffix:semicolon
id|v.rangelow
op_assign
l_int|0
suffix:semicolon
id|v.rangehigh
op_assign
l_int|0
suffix:semicolon
id|v.flags
op_assign
id|VIDEO_TUNER_PAL
op_or
id|VIDEO_TUNER_NTSC
op_or
id|VIDEO_TUNER_SECAM
suffix:semicolon
r_switch
c_cond
(paren
id|standard
)paren
(brace
r_case
l_int|0
suffix:colon
id|v.mode
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|v.mode
op_assign
id|VIDEO_MODE_NTSC
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|v.mode
op_assign
id|VIDEO_MODE_PAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|v.mode
op_assign
id|VIDEO_MODE_SECAM
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.tuner
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|v.mode
)paren
(brace
r_case
id|VIDEO_MODE_AUTO
suffix:colon
id|pms_framerate
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|pms_secamcross
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pms_format
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_MODE_NTSC
suffix:colon
id|pms_framerate
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|pms_secamcross
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pms_format
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_MODE_PAL
suffix:colon
id|pms_framerate
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|pms_secamcross
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pms_format
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_MODE_SECAM
suffix:colon
id|pms_framerate
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|pms_secamcross
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pms_format
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
op_assign
id|pd-&gt;picture
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|p.palette
op_eq
id|VIDEO_PALETTE_RGB565
op_logical_and
id|p.depth
op_eq
l_int|16
)paren
op_logical_or
(paren
id|p.palette
op_eq
id|VIDEO_PALETTE_RGB555
op_logical_and
id|p.depth
op_eq
l_int|15
)paren
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pd-&gt;picture
op_assign
id|p
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Now load the card.&n;&t;&t;&t; */
id|pms_brightness
c_func
(paren
id|p.brightness
op_rshift
l_int|8
)paren
suffix:semicolon
id|pms_hue
c_func
(paren
id|p.hue
op_rshift
l_int|8
)paren
suffix:semicolon
id|pms_colour
c_func
(paren
id|p.colour
op_rshift
l_int|8
)paren
suffix:semicolon
id|pms_contrast
c_func
(paren
id|p.contrast
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.flags
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.clipcount
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.height
l_int|480
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.width
l_int|640
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pd-&gt;width
op_assign
id|vw.width
suffix:semicolon
id|pd-&gt;height
op_assign
id|vw.height
suffix:semicolon
id|pms_resolution
c_func
(paren
id|pd-&gt;width
comma
id|pd-&gt;height
)paren
suffix:semicolon
multiline_comment|/* Ok we figured out what to use from our wide choice */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|vw.x
op_assign
l_int|0
suffix:semicolon
id|vw.y
op_assign
l_int|0
suffix:semicolon
id|vw.width
op_assign
id|pd-&gt;width
suffix:semicolon
id|vw.height
op_assign
id|pd-&gt;height
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCKEY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pms_read
r_static
r_int
id|pms_read
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_struct
id|pms_device
op_star
id|pd
op_assign
(paren
r_struct
id|pms_device
op_star
)paren
id|v
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* FIXME: semaphore this */
id|len
op_assign
id|pms_capture
c_func
(paren
id|pd
comma
id|buf
comma
(paren
id|pd-&gt;picture.depth
op_eq
l_int|16
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
comma
id|count
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|pms_template
r_struct
id|video_device
id|pms_template
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Mediavision PMS&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_PMS
comma
id|open
suffix:colon
id|pms_open
comma
id|close
suffix:colon
id|pms_close
comma
id|read
suffix:colon
id|pms_read
comma
id|write
suffix:colon
id|pms_write
comma
id|ioctl
suffix:colon
id|pms_ioctl
comma
)brace
suffix:semicolon
DECL|variable|pms_device
r_struct
id|pms_device
id|pms_device
suffix:semicolon
multiline_comment|/*&n; *&t;Probe for and initialise the Mediavision PMS&n; */
DECL|function|init_mediavision
r_static
r_int
id|init_mediavision
c_func
(paren
r_void
)paren
(brace
r_int
id|id
suffix:semicolon
r_int
id|idec
comma
id|decst
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|i2c_defs
(braket
)braket
op_assign
initialization_block
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
l_int|0x9A01
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mediavision: unable to detect: 0x9A01 in use.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_port
comma
l_int|3
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mediavision: I/O port %d in use.&bslash;n&quot;
comma
id|io_port
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0xB8
comma
l_int|0x9A01
)paren
suffix:semicolon
multiline_comment|/* Unlock */
id|outb
c_func
(paren
id|io_port
op_rshift
l_int|4
comma
l_int|0x9A01
)paren
suffix:semicolon
multiline_comment|/* Set IO port */
id|id
op_assign
id|mvv_read
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|decst
op_assign
id|pms_i2c_stat
c_func
(paren
l_int|0x43
)paren
suffix:semicolon
r_if
c_cond
(paren
id|decst
op_ne
op_minus
l_int|1
)paren
(brace
id|idec
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pms_i2c_stat
c_func
(paren
l_int|0xb9
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|idec
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pms_i2c_stat
c_func
(paren
l_int|0x8b
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|idec
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|idec
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PMS type is %d&bslash;n&quot;
comma
id|idec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idec
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Ok we have a PMS of some sort&n;&t; */
id|request_region
c_func
(paren
id|io_port
comma
l_int|3
comma
l_string|&quot;Mediavision PMS&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x9A01
comma
l_int|1
comma
l_string|&quot;Mediavision PMS config&quot;
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x04
comma
id|mem_base
op_rshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Set the memory area */
multiline_comment|/* Ok now load the defaults */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x19
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2c_defs
(braket
id|i
)braket
op_eq
l_int|0xFF
)paren
(brace
id|pms_i2c_andor
c_func
(paren
l_int|0x8A
comma
id|i
comma
l_int|0x07
comma
l_int|0x00
)paren
suffix:semicolon
)brace
r_else
id|pms_i2c_write
c_func
(paren
l_int|0x8A
comma
id|i
comma
id|i2c_defs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x00
comma
l_int|0x12
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x04
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x07
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x08
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x09
comma
l_int|0xFF
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x0A
comma
l_int|0x00
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x0B
comma
l_int|0x10
)paren
suffix:semicolon
id|pms_i2c_write
c_func
(paren
l_int|0xB8
comma
l_int|0x10
comma
l_int|0x03
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x01
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x05
comma
l_int|0xA0
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x08
comma
l_int|0x25
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x09
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x0A
comma
l_int|0x20
op_or
id|MVVMEMORYWIDTH
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x10
comma
l_int|0x02
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x1E
comma
l_int|0x0C
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x1F
comma
l_int|0x03
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x26
comma
l_int|0x06
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x2B
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x2C
comma
l_int|0x20
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x2D
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x2F
comma
l_int|0x70
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x32
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x33
comma
id|MVVMEMORYWIDTH
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x34
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x35
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x3A
comma
l_int|0x80
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x3B
comma
l_int|0x10
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x20
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x21
comma
l_int|0x00
)paren
suffix:semicolon
id|mvv_write
c_func
(paren
l_int|0x30
comma
l_int|0x22
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialization and module stuff&n; */
DECL|function|init_pms_cards
r_static
r_int
id|__init
id|init_pms_cards
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Mediavision Pro Movie Studio driver 0.02&bslash;n&quot;
)paren
suffix:semicolon
id|data_port
op_assign
id|io_port
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|init_mediavision
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Board not found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|pms_device
comma
op_amp
id|pms_template
comma
r_sizeof
(paren
id|pms_template
)paren
)paren
suffix:semicolon
id|pms_device.height
op_assign
l_int|240
suffix:semicolon
id|pms_device.width
op_assign
l_int|320
suffix:semicolon
id|pms_swsense
c_func
(paren
l_int|75
)paren
suffix:semicolon
id|pms_resolution
c_func
(paren
l_int|320
comma
l_int|240
)paren
suffix:semicolon
r_return
id|video_register_device
c_func
(paren
(paren
r_struct
id|video_device
op_star
)paren
op_amp
id|pms_device
comma
id|VFL_TYPE_GRABBER
)paren
suffix:semicolon
)brace
id|MODULE_PARM
c_func
(paren
id|io_port
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem_base
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|shutdown_mediavision
r_static
r_void
id|__exit
id|shutdown_mediavision
c_func
(paren
r_void
)paren
(brace
id|release_region
c_func
(paren
id|io_port
comma
l_int|3
)paren
suffix:semicolon
id|release_region
c_func
(paren
l_int|0x9A01
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|cleanup_pms_module
r_static
r_void
id|__exit
id|cleanup_pms_module
c_func
(paren
r_void
)paren
(brace
id|shutdown_mediavision
c_func
(paren
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
(paren
r_struct
id|video_device
op_star
)paren
op_amp
id|pms_device
)paren
suffix:semicolon
)brace
DECL|variable|init_pms_cards
id|module_init
c_func
(paren
id|init_pms_cards
)paren
suffix:semicolon
DECL|variable|cleanup_pms_module
id|module_exit
c_func
(paren
id|cleanup_pms_module
)paren
suffix:semicolon
eof
