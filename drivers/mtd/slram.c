multiline_comment|/*======================================================================&n;&n;  $Id: slram.c,v 1.10 2000/07/03 10:01:38 dwmw2 Exp $&n;&n;======================================================================*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
DECL|struct|mypriv
r_struct
id|mypriv
(brace
DECL|member|start
id|u_char
op_star
id|start
suffix:semicolon
DECL|member|end
id|u_char
op_star
id|end
suffix:semicolon
)brace
suffix:semicolon
r_int
id|physmem_erase
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
suffix:semicolon
r_int
id|physmem_point
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
op_star
id|mtdbuf
)paren
suffix:semicolon
r_void
id|physmem_unpoint
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|u_char
op_star
id|addr
)paren
suffix:semicolon
r_int
id|physmem_read
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_int
id|physmem_write
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
suffix:semicolon
DECL|function|physmem_erase
r_int
id|physmem_erase
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
id|priv-&gt;start
op_plus
id|instr-&gt;addr
comma
l_int|0xff
comma
id|instr-&gt;len
)paren
suffix:semicolon
multiline_comment|/* This&squot;ll catch a few races. Free the thing before returning :) &n;&t; * I don&squot;t feel at all ashamed. This kind of thing is possible anyway&n;&t; * with flash, but unlikely.&n;&t; */
id|instr-&gt;state
op_assign
id|MTD_ERASE_DONE
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;callback
)paren
(paren
op_star
(paren
id|instr-&gt;callback
)paren
)paren
(paren
id|instr
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|instr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|physmem_point
r_int
id|physmem_point
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
op_star
id|mtdbuf
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
(paren
r_struct
id|mypriv
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
op_star
id|mtdbuf
op_assign
id|priv-&gt;start
op_plus
id|from
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|physmem_unpoint
r_void
id|physmem_unpoint
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|u_char
op_star
id|addr
)paren
(brace
)brace
DECL|function|physmem_read
r_int
id|physmem_read
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
(paren
r_struct
id|mypriv
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
id|memcpy
(paren
id|buf
comma
id|priv-&gt;start
op_plus
id|from
comma
id|len
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|physmem_write
r_int
id|physmem_write
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
(paren
r_struct
id|mypriv
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
id|memcpy
(paren
id|priv-&gt;start
op_plus
id|to
comma
id|buf
comma
id|len
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
multiline_comment|/* Place your defaults here */
DECL|variable|start
r_static
id|u_long
id|start
op_assign
l_int|100663296
suffix:semicolon
DECL|variable|length
r_static
id|u_long
id|length
op_assign
l_int|33554432
suffix:semicolon
DECL|variable|end
r_static
id|u_long
id|end
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x20300
macro_line|#ifdef MODULE
DECL|macro|init_slram
mdefine_line|#define init_slram init_module
DECL|macro|cleanup_slram
mdefine_line|#define cleanup_slram cleanup_module
macro_line|#endif
DECL|macro|__exit
mdefine_line|#define __exit
macro_line|#endif
macro_line|#ifdef MODULE
id|MODULE_PARM
c_func
(paren
id|start
comma
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|length
comma
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|end
comma
l_string|&quot;l&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|mymtd
r_struct
id|mtd_info
op_star
id|mymtd
suffix:semicolon
DECL|function|mtd_slram_setup
r_void
id|__init
id|mtd_slram_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|start
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
)paren
id|length
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
)brace
DECL|function|init_slram
r_int
id|init_slram
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;physmem: No start address for memory device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|length
op_logical_and
op_logical_neg
id|end
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;physmem: No length or endpointer given.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|end
)paren
id|end
op_assign
id|start
op_plus
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|length
)paren
id|length
op_assign
id|end
op_minus
id|start
suffix:semicolon
r_if
c_cond
(paren
id|start
op_plus
id|length
op_ne
id|end
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;physmem: start(%lx) + length(%lx) != end(%lx) !&bslash;n&quot;
comma
id|start
comma
id|length
comma
id|end
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mymtd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtd_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mymtd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mymtd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mymtd
)paren
(brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|mymtd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mtd_info
)paren
)paren
suffix:semicolon
id|mymtd-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|mypriv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mymtd-&gt;priv
)paren
(brace
id|kfree
c_func
(paren
id|mymtd
)paren
suffix:semicolon
id|mymtd
op_assign
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mymtd-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mypriv
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mymtd
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;physmem: Cannot allocate new MTD device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
(paren
(paren
r_struct
id|mypriv
op_star
)paren
id|mymtd-&gt;priv
)paren
op_member_access_from_pointer
id|start
op_assign
id|ioremap
c_func
(paren
id|start
comma
id|length
)paren
suffix:semicolon
(paren
(paren
r_struct
id|mypriv
op_star
)paren
id|mymtd-&gt;priv
)paren
op_member_access_from_pointer
id|end
op_assign
(paren
(paren
r_struct
id|mypriv
op_star
)paren
id|mymtd-&gt;priv
)paren
op_member_access_from_pointer
id|start
op_plus
id|length
suffix:semicolon
id|mymtd-&gt;name
op_assign
l_string|&quot;Raw memory&quot;
suffix:semicolon
id|mymtd-&gt;size
op_assign
id|length
suffix:semicolon
id|mymtd-&gt;flags
op_assign
id|MTD_CLEAR_BITS
op_or
id|MTD_SET_BITS
op_or
id|MTD_WRITEB_WRITEABLE
op_or
id|MTD_VOLATILE
suffix:semicolon
id|mymtd-&gt;erase
op_assign
id|physmem_erase
suffix:semicolon
id|mymtd-&gt;point
op_assign
id|physmem_point
suffix:semicolon
id|mymtd-&gt;unpoint
op_assign
id|physmem_unpoint
suffix:semicolon
id|mymtd-&gt;read
op_assign
id|physmem_read
suffix:semicolon
id|mymtd-&gt;write
op_assign
id|physmem_write
suffix:semicolon
id|mymtd-&gt;module
op_assign
id|THIS_MODULE
suffix:semicolon
id|mymtd-&gt;type
op_assign
id|MTD_RAM
suffix:semicolon
id|mymtd-&gt;erasesize
op_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|add_mtd_device
c_func
(paren
id|mymtd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to register new device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mymtd-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mymtd
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Registered physmem device from %dKb to %dKb&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|start
op_div
l_int|1024
)paren
comma
(paren
r_int
)paren
(paren
id|end
op_div
l_int|1024
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Mapped from 0x%p to 0x%p&bslash;n&quot;
comma
(paren
(paren
r_struct
id|mypriv
op_star
)paren
id|mymtd-&gt;priv
)paren
op_member_access_from_pointer
id|start
comma
(paren
(paren
r_struct
id|mypriv
op_star
)paren
id|mymtd-&gt;priv
)paren
op_member_access_from_pointer
id|end
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_slram
r_static
r_void
id|__exit
id|cleanup_slram
c_func
(paren
r_void
)paren
(brace
id|iounmap
c_func
(paren
(paren
(paren
r_struct
id|mypriv
op_star
)paren
id|mymtd-&gt;priv
)paren
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
id|kfree
(paren
id|mymtd-&gt;priv
)paren
suffix:semicolon
id|del_mtd_device
c_func
(paren
id|mymtd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mymtd
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt; 0x20300
DECL|variable|init_slram
id|module_init
c_func
(paren
id|init_slram
)paren
suffix:semicolon
DECL|variable|cleanup_slram
id|module_exit
c_func
(paren
id|cleanup_slram
)paren
suffix:semicolon
macro_line|#endif
eof
