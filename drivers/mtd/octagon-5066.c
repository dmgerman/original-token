singleline_comment|// $Id: octagon-5066.c,v 1.12 2000/11/27 08:50:22 dwmw2 Exp $
multiline_comment|/* ######################################################################&n;&n;   Octagon 5066 MTD Driver. &n;  &n;   The Octagon 5066 is a SBC based on AMD&squot;s 586-WB running at 133 MHZ. It&n;   comes with a builtin AMD 29F016 flash chip and a socketed EEPROM that&n;   is replacable by flash. Both units are mapped through a multiplexer&n;   into a 32k memory window at 0xe8000. The control register for the &n;   multiplexing unit is located at IO 0x208 with a bit map of&n;     0-5 Page Selection in 32k increments&n;     6-7 Device selection:&n;        00 SSD off&n;        01 SSD 0 (Socket)&n;        10 SSD 1 (Flash chip)&n;        11 undefined&n;  &n;   On each SSD, the first 128k is reserved for use by the bios&n;   (actually it IS the bios..) This only matters if you are booting off the &n;   flash, you must not put a file system starting there.&n;   &n;   The driver tries to do a detection algorithm to guess what sort of devices&n;   are plugged into the sockets.&n;   &n;   ##################################################################### */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
DECL|macro|WINDOW_START
mdefine_line|#define WINDOW_START 0xe8000
DECL|macro|WINDOW_LENGTH
mdefine_line|#define WINDOW_LENGTH 0x8000
DECL|macro|WINDOW_SHIFT
mdefine_line|#define WINDOW_SHIFT 27
DECL|macro|WINDOW_MASK
mdefine_line|#define WINDOW_MASK 0x7FFF
DECL|macro|PAGE_IO
mdefine_line|#define PAGE_IO 0x208
DECL|variable|page_n_dev
r_static
r_volatile
r_char
id|page_n_dev
op_assign
l_int|0
suffix:semicolon
DECL|variable|iomapadr
r_static
r_int
r_int
id|iomapadr
suffix:semicolon
DECL|variable|oct5066_spin
r_static
id|spinlock_t
id|oct5066_spin
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * We use map_priv_1 to identify which device we are.&n; */
DECL|function|__oct5066_page
r_static
r_void
id|__oct5066_page
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u8
id|byte
)paren
(brace
id|outb
c_func
(paren
id|byte
comma
id|PAGE_IO
)paren
suffix:semicolon
id|page_n_dev
op_assign
id|byte
suffix:semicolon
)brace
DECL|function|oct5066_page
r_static
r_inline
r_void
id|oct5066_page
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u8
id|byte
op_assign
id|map-&gt;map_priv_1
op_or
(paren
id|ofs
op_rshift
id|WINDOW_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page_n_dev
op_ne
id|byte
)paren
id|__oct5066_page
c_func
(paren
id|map
comma
id|byte
)paren
suffix:semicolon
)brace
DECL|function|oct5066_read8
r_static
id|__u8
id|oct5066_read8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u8
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
id|ret
op_assign
id|readb
c_func
(paren
id|iomapadr
op_plus
(paren
id|ofs
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|oct5066_read16
r_static
id|__u16
id|oct5066_read16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u16
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
id|ret
op_assign
id|readw
c_func
(paren
id|iomapadr
op_plus
(paren
id|ofs
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|oct5066_read32
r_static
id|__u32
id|oct5066_read32
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u32
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
id|ret
op_assign
id|readl
c_func
(paren
id|iomapadr
op_plus
(paren
id|ofs
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|oct5066_copy_from
r_static
r_void
id|oct5066_copy_from
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_void
op_star
id|to
comma
r_int
r_int
id|from
comma
id|ssize_t
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
r_int
id|thislen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
(paren
id|WINDOW_LENGTH
op_minus
(paren
id|from
op_amp
id|WINDOW_MASK
)paren
)paren
)paren
id|thislen
op_assign
id|WINDOW_LENGTH
op_minus
(paren
id|from
op_amp
id|WINDOW_MASK
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|from
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|to
comma
id|iomapadr
op_plus
id|from
comma
id|thislen
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|to
op_add_assign
id|thislen
suffix:semicolon
id|from
op_add_assign
id|thislen
suffix:semicolon
id|len
op_sub_assign
id|thislen
suffix:semicolon
)brace
)brace
DECL|function|oct5066_write8
r_static
r_void
id|oct5066_write8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u8
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|d
comma
id|iomapadr
op_plus
(paren
id|adr
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
)brace
DECL|function|oct5066_write16
r_static
r_void
id|oct5066_write16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u16
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|d
comma
id|iomapadr
op_plus
(paren
id|adr
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
)brace
DECL|function|oct5066_write32
r_static
r_void
id|oct5066_write32
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|d
comma
id|iomapadr
op_plus
(paren
id|adr
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
)brace
DECL|function|oct5066_copy_to
r_static
r_void
id|oct5066_copy_to
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|to
comma
r_const
r_void
op_star
id|from
comma
id|ssize_t
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
r_int
id|thislen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
(paren
id|WINDOW_LENGTH
op_minus
(paren
id|to
op_amp
id|WINDOW_MASK
)paren
)paren
)paren
id|thislen
op_assign
id|WINDOW_LENGTH
op_minus
(paren
id|to
op_amp
id|WINDOW_MASK
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|oct5066_page
c_func
(paren
id|map
comma
id|to
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|iomapadr
op_plus
id|to
comma
id|from
comma
id|thislen
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|oct5066_spin
)paren
suffix:semicolon
id|to
op_add_assign
id|thislen
suffix:semicolon
id|from
op_add_assign
id|thislen
suffix:semicolon
id|len
op_sub_assign
id|thislen
suffix:semicolon
)brace
)brace
DECL|variable|oct5066_map
r_static
r_struct
id|map_info
id|oct5066_map
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|name
suffix:colon
l_string|&quot;Octagon 5066 Socket&quot;
comma
id|size
suffix:colon
l_int|512
op_star
l_int|1024
comma
id|buswidth
suffix:colon
l_int|1
comma
id|read8
suffix:colon
id|oct5066_read8
comma
id|read16
suffix:colon
id|oct5066_read16
comma
id|read32
suffix:colon
id|oct5066_read32
comma
id|copy_from
suffix:colon
id|oct5066_copy_from
comma
id|write8
suffix:colon
id|oct5066_write8
comma
id|write16
suffix:colon
id|oct5066_write16
comma
id|write32
suffix:colon
id|oct5066_write32
comma
id|copy_to
suffix:colon
id|oct5066_copy_to
comma
id|map_priv_1
suffix:colon
l_int|1
op_lshift
l_int|6
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;Octagon 5066 Internal Flash&quot;
comma
id|size
suffix:colon
l_int|2
op_star
l_int|1024
op_star
l_int|1024
comma
id|buswidth
suffix:colon
l_int|1
comma
id|read8
suffix:colon
id|oct5066_read8
comma
id|read16
suffix:colon
id|oct5066_read16
comma
id|read32
suffix:colon
id|oct5066_read32
comma
id|copy_from
suffix:colon
id|oct5066_copy_from
comma
id|write8
suffix:colon
id|oct5066_write8
comma
id|write16
suffix:colon
id|oct5066_write16
comma
id|write32
suffix:colon
id|oct5066_write32
comma
id|copy_to
suffix:colon
id|oct5066_copy_to
comma
id|map_priv_1
suffix:colon
l_int|2
op_lshift
l_int|6
)brace
)brace
suffix:semicolon
DECL|variable|oct5066_mtd
r_static
r_struct
id|mtd_info
op_star
id|oct5066_mtd
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
singleline_comment|// OctProbe - Sense if this is an octagon card
singleline_comment|// ---------------------------------------------------------------------
multiline_comment|/* Perform a simple validity test, we map the window select SSD0 and&n;   change pages while monitoring the window. A change in the window, &n;   controlled by the PAGE_IO port is a functioning 5066 board. This will&n;   fail if the thing in the socket is set to a uniform value. */
DECL|function|OctProbe
r_static
r_int
id|__init
id|OctProbe
c_func
(paren
)paren
(brace
r_int
r_int
id|Base
op_assign
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
r_int
r_int
id|I
suffix:semicolon
r_int
r_int
id|Values
(braket
l_int|10
)braket
suffix:semicolon
r_for
c_loop
(paren
id|I
op_assign
l_int|0
suffix:semicolon
id|I
op_ne
l_int|20
suffix:semicolon
id|I
op_increment
)paren
(brace
id|outb
c_func
(paren
id|Base
op_plus
(paren
id|I
op_mod
l_int|10
)paren
comma
id|PAGE_IO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I
OL
l_int|10
)paren
(brace
singleline_comment|// Record the value and check for uniqueness
id|Values
(braket
id|I
op_mod
l_int|10
)braket
op_assign
id|readl
c_func
(paren
id|iomapadr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I
OG
l_int|0
op_logical_and
id|Values
(braket
id|I
op_mod
l_int|10
)braket
op_eq
id|Values
(braket
l_int|0
)braket
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Make sure we get the same values on the second pass
r_if
c_cond
(paren
id|Values
(braket
id|I
op_mod
l_int|10
)braket
op_ne
id|readl
c_func
(paren
id|iomapadr
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x20212 &amp;&amp; defined(MODULE)
DECL|macro|init_oct5066
mdefine_line|#define init_oct5066 init_module
DECL|macro|cleanup_oct5066
mdefine_line|#define cleanup_oct5066 cleanup_module
macro_line|#endif
DECL|function|cleanup_oct5066
r_void
id|cleanup_oct5066
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|oct5066_mtd
(braket
id|i
)braket
)paren
(brace
id|del_mtd_device
c_func
(paren
id|oct5066_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|oct5066_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|iomapadr
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PAGE_IO
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|init_oct5066
r_int
id|__init
id|init_oct5066
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
singleline_comment|// Do an autoprobe sequence
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|PAGE_IO
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;5066: Page Register in Use&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|iomapadr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|WINDOW_START
comma
id|WINDOW_LENGTH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iomapadr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to ioremap memory region&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|OctProbe
c_func
(paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;5066: Octagon Probe Failed, is this an Octagon 5066 SBC?&bslash;n&quot;
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|iomapadr
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|PAGE_IO
comma
l_int|1
comma
l_string|&quot;Octagon SSD&quot;
)paren
suffix:semicolon
singleline_comment|// Print out our little header..
id|printk
c_func
(paren
l_string|&quot;Octagon 5066 SSD IO:0x%x MEM:0x%x-0x%x&bslash;n&quot;
comma
id|PAGE_IO
comma
id|WINDOW_START
comma
id|WINDOW_START
op_plus
id|WINDOW_LENGTH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|oct5066_mtd
(braket
id|i
)braket
op_assign
id|do_cfi_probe
c_func
(paren
op_amp
id|oct5066_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oct5066_mtd
(braket
id|i
)braket
)paren
id|oct5066_mtd
(braket
id|i
)braket
op_assign
id|do_jedec_probe
c_func
(paren
op_amp
id|oct5066_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oct5066_mtd
(braket
id|i
)braket
)paren
id|oct5066_mtd
(braket
id|i
)braket
op_assign
id|do_ram_probe
c_func
(paren
op_amp
id|oct5066_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oct5066_mtd
(braket
id|i
)braket
)paren
id|oct5066_mtd
(braket
id|i
)braket
op_assign
id|do_rom_probe
c_func
(paren
op_amp
id|oct5066_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oct5066_mtd
(braket
id|i
)braket
)paren
(brace
id|oct5066_mtd
(braket
id|i
)braket
op_member_access_from_pointer
id|module
op_assign
id|THIS_MODULE
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|oct5066_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|oct5066_mtd
(braket
l_int|1
)braket
op_logical_and
op_logical_neg
id|oct5066_mtd
(braket
l_int|2
)braket
)paren
(brace
id|cleanup_oct5066
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_oct5066
id|module_init
c_func
(paren
id|init_oct5066
)paren
suffix:semicolon
DECL|variable|cleanup_oct5066
id|module_exit
c_func
(paren
id|cleanup_oct5066
)paren
suffix:semicolon
eof
