singleline_comment|// $Id: vmax301.c,v 1.15 2000/11/27 08:50:22 dwmw2 Exp $
multiline_comment|/* ######################################################################&n;&n;   Tempustech VMAX SBC301 MTD Driver.&n;  &n;   The VMAx 301 is a SBC based on . It&n;   comes with three builtin AMD 29F016B flash chips and a socket for SRAM or&n;   more flash. Each unit has it&squot;s own 8k mapping into a settable region &n;   (0xD8000). There are two 8k mappings for each MTD, the first is always set&n;   to the lower 8k of the device the second is paged. Writing a 16 bit page&n;   value to anywhere in the first 8k will cause the second 8k to page around.&n;&n;   To boot the device a bios extension must be installed into the first 8k &n;   of flash that is smart enough to copy itself down, page in the rest of &n;   itself and begin executing.&n;   &n;   ##################################################################### */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
DECL|macro|WINDOW_START
mdefine_line|#define WINDOW_START 0xd8000
DECL|macro|WINDOW_LENGTH
mdefine_line|#define WINDOW_LENGTH 0x2000
DECL|macro|WINDOW_SHIFT
mdefine_line|#define WINDOW_SHIFT 25
DECL|macro|WINDOW_MASK
mdefine_line|#define WINDOW_MASK 0x1FFF
multiline_comment|/* Actually we could use two spinlocks, but we&squot;d have to have&n;   more private space in the struct map_info. We lose a little&n;   performance like this, but we&squot;d probably lose more by having&n;   the extra indirection from having one of the map-&gt;map_priv &n;   fields pointing to yet another private struct.&n;*/
DECL|variable|vmax301_spin
r_static
id|spinlock_t
id|vmax301_spin
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|__vmax301_page
r_static
r_void
id|__vmax301_page
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|page
)paren
(brace
id|writew
c_func
(paren
id|page
comma
id|map-&gt;map_priv_2
op_minus
id|WINDOW_LENGTH
)paren
suffix:semicolon
id|map-&gt;map_priv_1
op_assign
id|page
suffix:semicolon
)brace
DECL|function|vmax301_page
r_static
r_inline
r_void
id|vmax301_page
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
r_int
r_int
id|page
op_assign
(paren
id|ofs
op_rshift
id|WINDOW_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;map_priv_1
op_ne
id|page
)paren
id|__vmax301_page
c_func
(paren
id|map
comma
id|page
)paren
suffix:semicolon
)brace
DECL|function|vmax301_read8
r_static
id|__u8
id|vmax301_read8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u8
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
id|ret
op_assign
id|readb
c_func
(paren
id|map-&gt;map_priv_2
op_plus
(paren
id|ofs
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vmax301_read16
r_static
id|__u16
id|vmax301_read16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u16
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
id|ret
op_assign
id|readw
c_func
(paren
id|map-&gt;map_priv_2
op_plus
(paren
id|ofs
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vmax301_read32
r_static
id|__u32
id|vmax301_read32
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|__u32
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
id|ret
op_assign
id|readl
c_func
(paren
id|map-&gt;map_priv_2
op_plus
(paren
id|ofs
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vmax301_copy_from
r_static
r_void
id|vmax301_copy_from
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_void
op_star
id|to
comma
r_int
r_int
id|from
comma
id|ssize_t
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
r_int
id|thislen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
(paren
id|WINDOW_LENGTH
op_minus
(paren
id|from
op_amp
id|WINDOW_MASK
)paren
)paren
)paren
id|thislen
op_assign
id|WINDOW_LENGTH
op_minus
(paren
id|from
op_amp
id|WINDOW_MASK
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|from
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|to
comma
id|map-&gt;map_priv_2
op_plus
id|from
comma
id|thislen
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|to
op_add_assign
id|thislen
suffix:semicolon
id|from
op_add_assign
id|thislen
suffix:semicolon
id|len
op_sub_assign
id|thislen
suffix:semicolon
)brace
)brace
DECL|function|vmax301_write8
r_static
r_void
id|vmax301_write8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u8
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|d
comma
id|map-&gt;map_priv_2
op_plus
(paren
id|adr
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
)brace
DECL|function|vmax301_write16
r_static
r_void
id|vmax301_write16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u16
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|d
comma
id|map-&gt;map_priv_2
op_plus
(paren
id|adr
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
)brace
DECL|function|vmax301_write32
r_static
r_void
id|vmax301_write32
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|d
comma
id|map-&gt;map_priv_2
op_plus
(paren
id|adr
op_amp
id|WINDOW_MASK
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
)brace
DECL|function|vmax301_copy_to
r_static
r_void
id|vmax301_copy_to
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|to
comma
r_const
r_void
op_star
id|from
comma
id|ssize_t
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
r_int
id|thislen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
(paren
id|WINDOW_LENGTH
op_minus
(paren
id|to
op_amp
id|WINDOW_MASK
)paren
)paren
)paren
id|thislen
op_assign
id|WINDOW_LENGTH
op_minus
(paren
id|to
op_amp
id|WINDOW_MASK
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|vmax301_page
c_func
(paren
id|map
comma
id|to
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|map-&gt;map_priv_2
op_plus
id|to
comma
id|from
comma
id|thislen
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vmax301_spin
)paren
suffix:semicolon
id|to
op_add_assign
id|thislen
suffix:semicolon
id|from
op_add_assign
id|thislen
suffix:semicolon
id|len
op_sub_assign
id|thislen
suffix:semicolon
)brace
)brace
DECL|variable|vmax_map
r_static
r_struct
id|map_info
id|vmax_map
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|name
suffix:colon
l_string|&quot;VMAX301 Internal Flash&quot;
comma
id|size
suffix:colon
l_int|3
op_star
l_int|2
op_star
l_int|1024
op_star
l_int|1024
comma
id|buswidth
suffix:colon
l_int|1
comma
id|read8
suffix:colon
id|vmax301_read8
comma
id|read16
suffix:colon
id|vmax301_read16
comma
id|read32
suffix:colon
id|vmax301_read32
comma
id|copy_from
suffix:colon
id|vmax301_copy_from
comma
id|write8
suffix:colon
id|vmax301_write8
comma
id|write16
suffix:colon
id|vmax301_write16
comma
id|write32
suffix:colon
id|vmax301_write32
comma
id|copy_to
suffix:colon
id|vmax301_copy_to
comma
id|map_priv_1
suffix:colon
id|WINDOW_START
op_plus
id|WINDOW_LENGTH
comma
id|map_priv_2
suffix:colon
l_int|0xFFFFFFFF
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;VMAX301 Socket&quot;
comma
id|size
suffix:colon
l_int|0
comma
id|buswidth
suffix:colon
l_int|1
comma
id|read8
suffix:colon
id|vmax301_read8
comma
id|read16
suffix:colon
id|vmax301_read16
comma
id|read32
suffix:colon
id|vmax301_read32
comma
id|copy_from
suffix:colon
id|vmax301_copy_from
comma
id|write8
suffix:colon
id|vmax301_write8
comma
id|write16
suffix:colon
id|vmax301_write16
comma
id|write32
suffix:colon
id|vmax301_write32
comma
id|copy_to
suffix:colon
id|vmax301_copy_to
comma
id|map_priv_1
suffix:colon
id|WINDOW_START
op_plus
(paren
l_int|3
op_star
id|WINDOW_LENGTH
)paren
comma
id|map_priv_2
suffix:colon
l_int|0xFFFFFFFF
)brace
)brace
suffix:semicolon
DECL|variable|vmax_mtd
r_static
r_struct
id|mtd_info
op_star
id|vmax_mtd
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x20212 &amp;&amp; defined(MODULE)
DECL|macro|init_vmax301
mdefine_line|#define init_vmax301 init_module
DECL|macro|cleanup_vmax301
mdefine_line|#define cleanup_vmax301 cleanup_module
macro_line|#endif
DECL|function|cleanup_vmax301
r_static
r_void
id|__exit
id|cleanup_vmax301
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|vmax_mtd
(braket
id|i
)braket
)paren
(brace
id|del_mtd_device
c_func
(paren
id|vmax_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|vmax_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|vmax_map
(braket
l_int|0
)braket
dot
id|map_priv_1
op_minus
id|WINDOW_START
)paren
suffix:semicolon
)brace
DECL|function|init_vmax301
r_int
id|__init
id|init_vmax301
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|iomapadr
suffix:semicolon
singleline_comment|// Print out our little header..
id|printk
c_func
(paren
l_string|&quot;Tempustech VMAX 301 MEM:0x%x-0x%x&bslash;n&quot;
comma
id|WINDOW_START
comma
id|WINDOW_START
op_plus
l_int|4
op_star
id|WINDOW_LENGTH
)paren
suffix:semicolon
id|iomapadr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|WINDOW_START
comma
id|WINDOW_LENGTH
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iomapadr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to ioremap memory region&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Put the address in the map&squot;s private data area.&n;&t;   We store the actual MTD IO address rather than the &n;&t;   address of the first half, because it&squot;s used more&n;&t;   often. &n;&t;*/
id|vmax_map
(braket
l_int|0
)braket
dot
id|map_priv_1
op_assign
id|iomapadr
op_plus
id|WINDOW_START
suffix:semicolon
id|vmax_map
(braket
l_int|1
)braket
dot
id|map_priv_1
op_assign
id|iomapadr
op_plus
(paren
l_int|3
op_star
id|WINDOW_START
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vmax_mtd
(braket
id|i
)braket
op_assign
id|do_cfi_probe
c_func
(paren
op_amp
id|vmax_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vmax_mtd
(braket
id|i
)braket
)paren
id|vmax_mtd
(braket
id|i
)braket
op_assign
id|do_jedec_probe
c_func
(paren
op_amp
id|vmax_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vmax_mtd
(braket
id|i
)braket
)paren
id|vmax_mtd
(braket
id|i
)braket
op_assign
id|do_ram_probe
c_func
(paren
op_amp
id|vmax_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vmax_mtd
(braket
id|i
)braket
)paren
id|vmax_mtd
(braket
id|i
)braket
op_assign
id|do_rom_probe
c_func
(paren
op_amp
id|vmax_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vmax_mtd
(braket
id|i
)braket
)paren
(brace
id|vmax_mtd
(braket
id|i
)braket
op_member_access_from_pointer
id|module
op_assign
id|THIS_MODULE
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|vmax_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|vmax_mtd
(braket
l_int|1
)braket
op_logical_and
op_logical_neg
id|vmax_mtd
(braket
l_int|2
)braket
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_vmax301
id|module_init
c_func
(paren
id|init_vmax301
)paren
suffix:semicolon
DECL|variable|cleanup_vmax301
id|module_exit
c_func
(paren
id|cleanup_vmax301
)paren
suffix:semicolon
eof
