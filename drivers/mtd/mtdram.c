multiline_comment|/* &n; * mtdram - a test mtd device&n; * $Id: mtdram.c,v 1.15 2000/07/13 12:40:46 scote1 Exp $&n; * Author: Alexander Larsson &lt;alex@cendio.se&gt; &n; *&n; * Copyright (c) 1999 Alexander Larsson &lt;alex@cendio.se&gt;&n; *&n; * This code is GPL&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mtd/compatmac.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
DECL|macro|MTDRAM_TOTAL_SIZE
mdefine_line|#define MTDRAM_TOTAL_SIZE (CONFIG_MTDRAM_TOTAL_SIZE * 1024)
DECL|macro|MTDRAM_ERASE_SIZE
mdefine_line|#define MTDRAM_ERASE_SIZE (CONFIG_MTDRAM_ERASE_SIZE * 1024)
singleline_comment|// We could store these in the mtd structure, but we only support 1 device..
DECL|variable|mtd_info
r_static
r_struct
id|mtd_info
op_star
id|mtd_info
suffix:semicolon
r_static
r_int
DECL|function|ram_erase
id|ram_erase
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_if
c_cond
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|mtd-&gt;priv
op_plus
id|instr-&gt;addr
comma
l_int|0xff
comma
id|instr-&gt;len
)paren
suffix:semicolon
id|instr-&gt;state
op_assign
id|MTD_ERASE_DONE
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;callback
)paren
(paren
op_star
(paren
id|instr-&gt;callback
)paren
)paren
(paren
id|instr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ram_point
r_static
r_int
id|ram_point
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
op_star
id|mtdbuf
)paren
(brace
r_if
c_cond
(paren
id|from
op_plus
id|len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|mtdbuf
op_assign
id|mtd-&gt;priv
op_plus
id|from
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ram_unpoint
r_static
r_void
id|ram_unpoint
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|u_char
op_star
id|addr
)paren
(brace
)brace
DECL|function|ram_read
r_static
r_int
id|ram_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|from
op_plus
id|len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|mtd-&gt;priv
op_plus
id|from
comma
id|len
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ram_write
r_static
r_int
id|ram_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|to
op_plus
id|len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|mtd-&gt;priv
op_plus
id|to
comma
id|buf
comma
id|len
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x20300
macro_line|#ifdef MODULE
DECL|macro|init_mtdram
mdefine_line|#define init_mtdram init_module
DECL|macro|cleanup_mtdram
mdefine_line|#define cleanup_mtdram cleanup_module
macro_line|#endif
macro_line|#endif
singleline_comment|//static void __exit cleanup_mtdram(void)
DECL|function|cleanup_mtdram
id|mod_exit_t
id|cleanup_mtdram
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mtd_info
)paren
(brace
id|del_mtd_device
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtd_info-&gt;priv
)paren
id|vfree
c_func
(paren
id|mtd_info-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
)brace
)brace
r_extern
r_struct
id|module
id|__this_module
suffix:semicolon
DECL|function|init_mtdram
id|mod_init_t
id|init_mtdram
c_func
(paren
r_void
)paren
(brace
singleline_comment|// Allocate some memory
id|mtd_info
op_assign
(paren
r_struct
id|mtd_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtd_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtd_info
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|mtd_info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mtd_info
)paren
)paren
suffix:semicolon
singleline_comment|// Setup the MTD structure
id|mtd_info-&gt;name
op_assign
l_string|&quot;mtdram test device&quot;
suffix:semicolon
id|mtd_info-&gt;type
op_assign
id|MTD_RAM
suffix:semicolon
id|mtd_info-&gt;flags
op_assign
id|MTD_CAP_RAM
suffix:semicolon
id|mtd_info-&gt;size
op_assign
id|MTDRAM_TOTAL_SIZE
suffix:semicolon
id|mtd_info-&gt;erasesize
op_assign
id|MTDRAM_ERASE_SIZE
suffix:semicolon
id|mtd_info-&gt;priv
op_assign
id|vmalloc
c_func
(paren
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mtd_info-&gt;priv
comma
l_int|0xff
comma
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,2,0)
id|mtd_info-&gt;module
op_assign
id|THIS_MODULE
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mtd_info-&gt;priv
)paren
(brace
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
id|mtd_info
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|mtd_info-&gt;erase
op_assign
id|ram_erase
suffix:semicolon
id|mtd_info-&gt;point
op_assign
id|ram_point
suffix:semicolon
id|mtd_info-&gt;unpoint
op_assign
id|ram_unpoint
suffix:semicolon
id|mtd_info-&gt;read
op_assign
id|ram_read
suffix:semicolon
id|mtd_info-&gt;write
op_assign
id|ram_write
suffix:semicolon
r_if
c_cond
(paren
id|add_mtd_device
c_func
(paren
id|mtd_info
)paren
)paren
(brace
id|vfree
c_func
(paren
id|mtd_info-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
id|mtd_info
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt; 0x20300
DECL|variable|init_mtdram
id|module_init
c_func
(paren
id|init_mtdram
)paren
suffix:semicolon
DECL|variable|cleanup_mtdram
id|module_exit
c_func
(paren
id|cleanup_mtdram
)paren
suffix:semicolon
macro_line|#endif
eof
