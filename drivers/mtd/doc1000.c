multiline_comment|/*======================================================================&n;&n;  $Id: doc1000.c,v 1.11 2000/11/24 13:43:16 dwmw2 Exp $&n;&n;======================================================================*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/iflash.h&gt;
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
DECL|variable|base
r_static
id|u_long
id|base
op_assign
l_int|0xe0000
suffix:semicolon
DECL|variable|erase_timeout
r_static
r_int
id|erase_timeout
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
multiline_comment|/* in ticks */
DECL|variable|retry_limit
r_static
r_int
id|retry_limit
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* write retries */
DECL|variable|max_tries
r_static
id|u_long
id|max_tries
op_assign
l_int|4096
suffix:semicolon
multiline_comment|/* status polling */
id|MODULE_PARM
c_func
(paren
id|base
comma
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|erase_timeout
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|retry_limit
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_tries
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|WINDOW_SIZE
mdefine_line|#define WINDOW_SIZE 0x2000
DECL|macro|WINDOW_MASK
mdefine_line|#define WINDOW_MASK (WINDOW_SIZE - 1)
DECL|macro|PAGEREG_LO
mdefine_line|#define PAGEREG_LO (WINDOW_SIZE)
DECL|macro|PAGEREG_HI
mdefine_line|#define PAGEREG_HI (WINDOW_SIZE + 2)
DECL|variable|mymtd
r_static
r_struct
id|mtd_info
op_star
id|mymtd
suffix:semicolon
DECL|variable|flashcard_timer
r_static
r_struct
id|timer_list
id|flashcard_timer
suffix:semicolon
DECL|macro|MAX_CELLS
mdefine_line|#define MAX_CELLS&t;&t;32
DECL|macro|MAX_FLASH_DEVICES
mdefine_line|#define MAX_FLASH_DEVICES       8
multiline_comment|/* A flash region is composed of one or more &quot;cells&quot;, where we allow&n;   simultaneous erases if they are in different cells */
DECL|struct|mypriv
r_struct
id|mypriv
(brace
DECL|member|baseaddr
id|u_char
op_star
id|baseaddr
suffix:semicolon
DECL|member|curpage
id|u_short
id|curpage
suffix:semicolon
DECL|member|locked
id|u_char
id|locked
suffix:semicolon
DECL|member|numdevices
id|u_short
id|numdevices
suffix:semicolon
DECL|member|interleave
id|u_char
id|interleave
suffix:semicolon
DECL|member|cur_erases
r_struct
id|erase_info
op_star
id|cur_erases
suffix:semicolon
DECL|member|wq
id|wait_queue_head_t
id|wq
suffix:semicolon
DECL|member|devstat
id|u_char
id|devstat
(braket
id|MAX_FLASH_DEVICES
)braket
suffix:semicolon
DECL|member|devshift
id|u_long
id|devshift
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|flashcard_periodic
c_func
(paren
id|u_long
id|data
)paren
suffix:semicolon
r_static
r_int
id|flashcard_erase
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
suffix:semicolon
r_static
r_int
id|flashcard_read
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|flashcard_write
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_void
id|flashcard_sync
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
r_static
r_inline
r_void
id|resume_erase
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_inline
r_int
id|suspend_erase
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_inline
r_int
id|byte_write
(paren
r_volatile
id|u_char
op_star
id|addr
comma
id|u_char
id|byte
)paren
suffix:semicolon
r_static
r_inline
r_int
id|word_write
(paren
r_volatile
id|u_char
op_star
id|addr
comma
id|__u16
id|word
)paren
suffix:semicolon
r_static
r_inline
r_int
id|check_write
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_inline
r_void
id|block_erase
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_inline
r_int
id|check_erase
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
macro_line|#warning This is definitely not SMP safe. Lock the paging mechanism.
macro_line|#endif
DECL|function|pagein
r_static
id|u_char
op_star
id|pagein
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|u_long
id|addr
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
id|mtd-&gt;priv
suffix:semicolon
id|u_short
id|page
op_assign
id|addr
op_rshift
l_int|13
suffix:semicolon
id|priv-&gt;baseaddr
(braket
id|PAGEREG_LO
)braket
op_assign
id|page
op_amp
l_int|0xff
suffix:semicolon
id|priv-&gt;baseaddr
(braket
id|PAGEREG_HI
)braket
op_assign
id|page
op_rshift
l_int|8
suffix:semicolon
id|priv-&gt;curpage
op_assign
id|page
suffix:semicolon
r_return
op_amp
id|priv-&gt;baseaddr
(braket
id|addr
op_amp
id|WINDOW_MASK
)braket
suffix:semicolon
)brace
DECL|function|flashcard_sync
r_void
id|flashcard_sync
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
id|mtd-&gt;priv
suffix:semicolon
id|flashcard_periodic
c_func
(paren
(paren
id|u_long
)paren
id|mtd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sync...&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;cur_erases
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|priv-&gt;wq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|flashcard_erase
r_int
id|flashcard_erase
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
id|u_char
op_star
id|pageaddr
suffix:semicolon
r_struct
id|mypriv
op_star
id|priv
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|erase_info
op_star
op_star
id|tmp
op_assign
op_amp
id|priv-&gt;cur_erases
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;len
op_ne
id|mtd-&gt;erasesize
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pageaddr
op_assign
id|pagein
c_func
(paren
id|mtd
comma
id|instr-&gt;addr
)paren
suffix:semicolon
id|instr-&gt;mtd
op_assign
id|mtd
suffix:semicolon
id|instr-&gt;dev
op_assign
id|instr-&gt;addr
op_rshift
id|priv-&gt;devshift
suffix:semicolon
id|instr-&gt;cell
op_assign
(paren
id|instr-&gt;addr
op_minus
(paren
id|instr-&gt;dev
op_lshift
id|priv-&gt;devshift
)paren
)paren
op_div
id|mtd-&gt;erasesize
suffix:semicolon
id|instr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|instr-&gt;state
op_assign
id|MTD_ERASE_PENDING
suffix:semicolon
r_while
c_loop
(paren
op_star
id|tmp
)paren
(brace
id|tmp
op_assign
op_amp
(paren
(paren
op_star
id|tmp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
op_star
id|tmp
op_assign
id|instr
suffix:semicolon
id|flashcard_periodic
c_func
(paren
(paren
id|u_long
)paren
id|mtd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|flashcard_read
r_int
id|flashcard_read
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
id|u_char
op_star
id|pageaddr
op_assign
id|pagein
c_func
(paren
id|mtd
comma
id|from
)paren
suffix:semicolon
r_struct
id|mypriv
op_star
id|priv
op_assign
id|mtd-&gt;priv
suffix:semicolon
id|u_char
id|device
op_assign
id|from
op_rshift
id|priv-&gt;devshift
suffix:semicolon
id|u_char
id|cell
op_assign
(paren
r_int
)paren
(paren
id|from
op_minus
(paren
id|device
op_lshift
id|priv-&gt;devshift
)paren
)paren
op_div
id|mtd-&gt;erasesize
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|timeron
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|from
op_amp
id|WINDOW_MASK
)paren
op_plus
id|len
op_le
id|WINDOW_SIZE
)paren
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_else
op_star
id|retlen
op_assign
id|WINDOW_SIZE
op_minus
(paren
id|from
op_amp
id|WINDOW_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;devstat
(braket
id|device
)braket
)paren
(brace
multiline_comment|/* There is an erase in progress or pending for this device. Stop it */
id|timeron
op_assign
id|del_timer
c_func
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;cur_erases
op_logical_and
id|priv-&gt;cur_erases-&gt;cell
op_eq
id|cell
)paren
(brace
multiline_comment|/* The erase is on the current cell. Just return all 0xff */
id|add_timer
c_func
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cell %d currently erasing. Setting to all 0xff&bslash;n&quot;
comma
id|cell
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0xff
comma
op_star
id|retlen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;devstat
(braket
id|device
)braket
op_eq
id|MTD_ERASING
)paren
(brace
id|ret
op_assign
id|suspend_erase
c_func
(paren
id|pageaddr
)paren
suffix:semicolon
id|priv-&gt;devstat
(braket
id|device
)braket
op_assign
id|MTD_ERASE_SUSPEND
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;flashcard: failed to suspend erase&bslash;n&quot;
)paren
suffix:semicolon
id|add_timer
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
)brace
id|writew
c_func
(paren
id|IF_READ_ARRAY
comma
(paren
id|u_long
)paren
id|pageaddr
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|buf
comma
id|pageaddr
comma
op_star
id|retlen
)paren
suffix:semicolon
id|writew
c_func
(paren
id|IF_READ_CSR
comma
(paren
id|u_long
)paren
id|pageaddr
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;devstat
(braket
id|device
)braket
op_amp
id|MTD_ERASE_SUSPEND
)paren
(brace
id|resume_erase
c_func
(paren
id|pageaddr
)paren
suffix:semicolon
id|priv-&gt;devstat
(braket
id|device
)braket
op_assign
id|MTD_ERASING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeron
)paren
id|add_timer
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|flashcard_write
r_int
id|flashcard_write
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
op_assign
(paren
r_struct
id|mypriv
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
id|u_char
op_star
id|endaddr
comma
op_star
id|startaddr
suffix:semicolon
r_register
id|u_char
op_star
id|pageaddr
suffix:semicolon
id|u_char
id|device
op_assign
id|to
op_rshift
id|priv-&gt;devshift
suffix:semicolon
multiline_comment|/*&t;jiffies_t oldj=jiffies;*/
r_int
id|ret
suffix:semicolon
r_while
c_loop
(paren
id|priv-&gt;devstat
(braket
id|device
)braket
)paren
(brace
id|flashcard_sync
c_func
(paren
id|mtd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|to
op_amp
id|WINDOW_MASK
)paren
op_plus
id|len
op_le
id|WINDOW_SIZE
)paren
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_else
op_star
id|retlen
op_assign
id|WINDOW_SIZE
op_minus
(paren
id|to
op_amp
id|WINDOW_MASK
)paren
suffix:semicolon
id|pageaddr
op_assign
id|pagein
c_func
(paren
id|mtd
comma
id|to
)paren
suffix:semicolon
id|startaddr
op_assign
(paren
id|u_char
op_star
)paren
(paren
(paren
id|u_long
)paren
id|pageaddr
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|endaddr
op_assign
id|pageaddr
op_plus
(paren
op_star
id|retlen
)paren
suffix:semicolon
multiline_comment|/* Set up to read */
id|writew
c_func
(paren
id|IF_READ_CSR
comma
id|startaddr
)paren
suffix:semicolon
multiline_comment|/* Make sure it&squot;s aligned by reading the first byte if necessary */
r_if
c_cond
(paren
id|to
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Unaligned access */
id|u_char
id|cbuf
suffix:semicolon
id|cbuf
op_assign
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|u_long
)paren
id|pageaddr
op_amp
l_int|0xf
)paren
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|byte_write
c_func
(paren
id|pageaddr
comma
id|cbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|pageaddr
op_increment
suffix:semicolon
id|buf
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|pageaddr
op_plus
l_int|1
OL
id|endaddr
suffix:semicolon
id|buf
op_add_assign
l_int|2
comma
id|pageaddr
op_add_assign
l_int|2
)paren
(brace
multiline_comment|/* if ((u_long)pageaddr &amp; 0xf) schedule();*/
id|ret
op_assign
id|word_write
c_func
(paren
id|pageaddr
comma
op_star
(paren
id|__u16
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pageaddr
op_ne
id|endaddr
)paren
(brace
multiline_comment|/* One more byte to write at the end. */
id|u_char
id|cbuf
suffix:semicolon
id|cbuf
op_assign
op_star
id|buf
suffix:semicolon
id|ret
op_assign
id|byte_write
c_func
(paren
id|pageaddr
comma
id|cbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
r_return
id|check_write
c_func
(paren
id|startaddr
)paren
suffix:semicolon
multiline_comment|/*&t;printk(&quot;Time taken in flashcard_write: %lx jiffies&bslash;n&quot;,jiffies - oldj);*/
)brace
multiline_comment|/*====================================================================*/
DECL|function|byte_write
r_static
r_inline
r_int
id|byte_write
(paren
r_volatile
id|u_char
op_star
id|addr
comma
id|u_char
id|byte
)paren
(brace
r_register
id|u_char
id|status
suffix:semicolon
r_register
id|u_short
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|status
op_assign
id|readb
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CSR_WR_READY
)paren
(brace
id|writeb
c_func
(paren
id|IF_WRITE
op_amp
l_int|0xff
comma
id|addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|byte
comma
id|addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|max_tries
)paren
(brace
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: byte_write timed out, status 0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|word_write
r_static
r_inline
r_int
id|word_write
(paren
r_volatile
id|u_char
op_star
id|addr
comma
id|__u16
id|word
)paren
(brace
r_register
id|u_short
id|status
suffix:semicolon
r_register
id|u_short
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|status
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|CSR_WR_READY
)paren
op_eq
id|CSR_WR_READY
)paren
(brace
id|writew
c_func
(paren
id|IF_WRITE
comma
id|addr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|word
comma
id|addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|max_tries
)paren
(brace
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: word_write timed out at %p, status 0x%x&bslash;n&quot;
comma
id|addr
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|block_erase
r_static
r_inline
r_void
id|block_erase
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
(brace
id|writew
c_func
(paren
id|IF_BLOCK_ERASE
comma
id|addr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|IF_CONFIRM
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|check_erase
r_static
r_inline
r_int
id|check_erase
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
(brace
id|__u16
id|status
suffix:semicolon
multiline_comment|/*&t;writew(IF_READ_CSR, addr);*/
id|status
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|CSR_WR_READY
)paren
op_ne
id|CSR_WR_READY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|CSR_ERA_ERR
op_or
id|CSR_VPP_LOW
op_or
id|CSR_WR_ERR
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: erase failed, status 0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|suspend_erase
r_static
r_inline
r_int
id|suspend_erase
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
(brace
id|__u16
id|status
suffix:semicolon
id|u_long
id|i
op_assign
l_int|0
suffix:semicolon
id|writew
c_func
(paren
id|IF_ERASE_SUSPEND
comma
id|addr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|IF_READ_CSR
comma
id|addr
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|CSR_WR_READY
)paren
op_eq
id|CSR_WR_READY
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|max_tries
)paren
(brace
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: suspend_erase timed out, status 0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|resume_erase
r_static
r_inline
r_void
id|resume_erase
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
(brace
id|__u16
id|status
suffix:semicolon
id|writew
c_func
(paren
id|IF_READ_CSR
comma
id|addr
)paren
suffix:semicolon
id|status
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* Only give resume signal if the erase is really suspended */
r_if
c_cond
(paren
id|status
op_amp
id|CSR_ERA_SUSPEND
)paren
id|writew
c_func
(paren
id|IF_CONFIRM
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|reset_block
r_static
r_inline
r_void
id|reset_block
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
(brace
id|u_short
id|i
suffix:semicolon
id|__u16
id|status
suffix:semicolon
id|writew
c_func
(paren
id|IF_CLEAR_CSR
comma
id|addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writew
c_func
(paren
id|IF_READ_CSR
comma
id|addr
)paren
suffix:semicolon
id|status
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0xffff
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
id|IF_READ_CSR
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|check_write
r_static
r_inline
r_int
id|check_write
c_func
(paren
r_volatile
id|u_char
op_star
id|addr
)paren
(brace
id|u_short
id|status
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|writew
c_func
(paren
id|IF_READ_CSR
comma
id|addr
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|CSR_WR_ERR
op_or
id|CSR_VPP_LOW
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: write failure at %p, status 0x%x&bslash;n&quot;
comma
id|addr
comma
id|status
)paren
suffix:semicolon
id|reset_block
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|CSR_WR_READY
)paren
op_eq
id|CSR_WR_READY
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|max_tries
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: write timed out at %p, status 0x%x&bslash;n&quot;
comma
id|addr
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|flashcard_periodic
r_static
r_void
id|flashcard_periodic
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_register
r_struct
id|mtd_info
op_star
id|mtd
op_assign
(paren
r_struct
id|mtd_info
op_star
)paren
id|data
suffix:semicolon
r_register
r_struct
id|mypriv
op_star
id|priv
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|erase_info
op_star
id|erase
op_assign
id|priv-&gt;cur_erases
suffix:semicolon
id|u_char
op_star
id|pageaddr
suffix:semicolon
id|del_timer
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|erase
)paren
r_return
suffix:semicolon
id|pageaddr
op_assign
id|pagein
c_func
(paren
id|mtd
comma
id|erase-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erase-&gt;state
op_eq
id|MTD_ERASE_PENDING
)paren
(brace
id|block_erase
c_func
(paren
id|pageaddr
)paren
suffix:semicolon
id|priv-&gt;devstat
(braket
id|erase-&gt;dev
)braket
op_assign
id|erase-&gt;state
op_assign
id|MTD_ERASING
suffix:semicolon
id|erase-&gt;time
op_assign
id|jiffies
suffix:semicolon
id|erase-&gt;retries
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erase-&gt;state
op_eq
id|MTD_ERASING
)paren
(brace
multiline_comment|/* It&squot;s trying to erase. Check whether it&squot;s finished */
r_int
id|ret
op_assign
id|check_erase
c_func
(paren
id|pageaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
multiline_comment|/* It&squot;s finished OK */
id|priv-&gt;devstat
(braket
id|erase-&gt;dev
)braket
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;cur_erases
op_assign
id|erase-&gt;next
suffix:semicolon
id|erase-&gt;state
op_assign
id|MTD_ERASE_DONE
suffix:semicolon
r_if
c_cond
(paren
id|erase-&gt;callback
)paren
(paren
op_star
(paren
id|erase-&gt;callback
)paren
)paren
(paren
id|erase
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|erase
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EIO
)paren
(brace
r_if
c_cond
(paren
op_increment
id|erase-&gt;retries
OG
id|retry_limit
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed too many times. Giving up&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;cur_erases
op_assign
id|erase-&gt;next
suffix:semicolon
id|priv-&gt;devstat
(braket
id|erase-&gt;dev
)braket
op_assign
l_int|0
suffix:semicolon
id|erase-&gt;state
op_assign
id|MTD_ERASE_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|erase-&gt;callback
)paren
(paren
op_star
(paren
id|erase-&gt;callback
)paren
)paren
(paren
id|erase
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|erase
)paren
suffix:semicolon
)brace
r_else
id|priv-&gt;devstat
(braket
id|erase-&gt;dev
)braket
op_assign
id|erase-&gt;state
op_assign
id|MTD_ERASE_PENDING
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erase-&gt;time
op_plus
id|erase_timeout
OL
id|jiffies
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Flash erase timed out. The world is broken.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Just ignore and hope it goes away. For a while, read ops will give the CSR&n;&t;&t;&t;   and writes won&squot;t work. */
id|priv-&gt;cur_erases
op_assign
id|erase-&gt;next
suffix:semicolon
id|priv-&gt;devstat
(braket
id|erase-&gt;dev
)braket
op_assign
l_int|0
suffix:semicolon
id|erase-&gt;state
op_assign
id|MTD_ERASE_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|erase-&gt;callback
)paren
(paren
op_star
(paren
id|erase-&gt;callback
)paren
)paren
(paren
id|erase
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|erase
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|priv-&gt;cur_erases
)paren
(brace
id|flashcard_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
)brace
r_else
id|wake_up_interruptible
c_func
(paren
op_amp
id|priv-&gt;wq
)paren
suffix:semicolon
)brace
macro_line|#if defined (MODULE) &amp;&amp; LINUX_VERSION_CODE &lt; 0x20211
DECL|macro|init_doc1000
mdefine_line|#define init_doc1000 init_module
DECL|macro|cleanup_doc1000
mdefine_line|#define cleanup_doc1000 cleanup_module
macro_line|#endif
DECL|function|init_doc1000
r_int
id|__init
id|init_doc1000
c_func
(paren
r_void
)paren
(brace
r_struct
id|mypriv
op_star
id|priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;flashcard: No start address for memory device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mymtd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtd_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mymtd
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;physmem: Cannot allocate memory for new MTD device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mymtd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mtd_info
)paren
)paren
suffix:semicolon
id|mymtd-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|mypriv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mymtd-&gt;priv
)paren
(brace
id|kfree
c_func
(paren
id|mymtd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;physmem: Cannot allocate memory for new MTD device&squot;s private data.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|priv
op_assign
id|mymtd-&gt;priv
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|priv-&gt;wq
)paren
suffix:semicolon
id|memset
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mypriv
)paren
)paren
suffix:semicolon
id|priv-&gt;baseaddr
op_assign
id|phys_to_virt
c_func
(paren
id|base
)paren
suffix:semicolon
id|priv-&gt;numdevices
op_assign
l_int|4
suffix:semicolon
id|mymtd-&gt;name
op_assign
l_string|&quot;M-Systems DiskOnChip 1000&quot;
suffix:semicolon
id|mymtd-&gt;size
op_assign
l_int|0x100000
suffix:semicolon
id|mymtd-&gt;flags
op_assign
id|MTD_CLEAR_BITS
op_or
id|MTD_ERASEABLE
suffix:semicolon
id|mymtd-&gt;erase
op_assign
id|flashcard_erase
suffix:semicolon
id|mymtd-&gt;point
op_assign
l_int|NULL
suffix:semicolon
id|mymtd-&gt;unpoint
op_assign
l_int|NULL
suffix:semicolon
id|mymtd-&gt;read
op_assign
id|flashcard_read
suffix:semicolon
id|mymtd-&gt;write
op_assign
id|flashcard_write
suffix:semicolon
id|mymtd-&gt;sync
op_assign
id|flashcard_sync
suffix:semicolon
id|mymtd-&gt;erasesize
op_assign
l_int|0x10000
suffix:semicolon
singleline_comment|//&t;mymtd-&gt;interleave = 2;
id|priv-&gt;devshift
op_assign
l_int|24
suffix:semicolon
id|mymtd-&gt;type
op_assign
id|MTD_NORFLASH
suffix:semicolon
r_if
c_cond
(paren
id|add_mtd_device
c_func
(paren
id|mymtd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;MTD device registration failed!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mymtd-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mymtd
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|flashcard_timer
)paren
suffix:semicolon
id|flashcard_timer.function
op_assign
id|flashcard_periodic
suffix:semicolon
id|flashcard_timer.data
op_assign
(paren
id|u_long
)paren
id|mymtd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_doc1000
r_static
r_void
id|__init
id|cleanup_doc1000
c_func
(paren
r_void
)paren
(brace
id|kfree
(paren
id|mymtd-&gt;priv
)paren
suffix:semicolon
id|del_mtd_device
c_func
(paren
id|mymtd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mymtd
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20211
DECL|variable|init_doc1000
id|module_init
c_func
(paren
id|init_doc1000
)paren
suffix:semicolon
DECL|variable|cleanup_doc1000
id|module_exit
c_func
(paren
id|cleanup_doc1000
)paren
suffix:semicolon
macro_line|#endif
eof
