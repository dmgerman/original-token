multiline_comment|/*&n; * Device driver for the via-pmu on Apple Powermacs.&n; *&n; * The VIA (versatile interface adapter) interfaces to the PMU,&n; * a 6805 microprocessor core whose primary function is to control&n; * battery charging and system power on the PowerBook 3400 and 2400.&n; * The PMU also controls the ADB (Apple Desktop Bus) which connects&n; * to the keyboard and mouse, as well as the non-volatile RAM&n; * and the RTC (real time clock) chip.&n; *&n; * Copyright (C) 1998 Paul Mackerras and Fabio Riccardi.&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/adb.h&gt;
macro_line|#include &lt;asm/pmu.h&gt;
macro_line|#include &lt;asm/cuda.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/init.h&gt;
DECL|variable|via
r_static
r_volatile
r_int
r_char
op_star
id|via
suffix:semicolon
multiline_comment|/* VIA registers - spaced 0x200 bytes apart */
DECL|macro|RS
mdefine_line|#define RS&t;&t;0x200&t;&t;/* skip between registers */
DECL|macro|B
mdefine_line|#define B&t;&t;0&t;&t;/* B-side data */
DECL|macro|A
mdefine_line|#define A&t;&t;RS&t;&t;/* A-side data */
DECL|macro|DIRB
mdefine_line|#define DIRB&t;&t;(2*RS)&t;&t;/* B-side direction (1=output) */
DECL|macro|DIRA
mdefine_line|#define DIRA&t;&t;(3*RS)&t;&t;/* A-side direction (1=output) */
DECL|macro|T1CL
mdefine_line|#define T1CL&t;&t;(4*RS)&t;&t;/* Timer 1 ctr/latch (low 8 bits) */
DECL|macro|T1CH
mdefine_line|#define T1CH&t;&t;(5*RS)&t;&t;/* Timer 1 counter (high 8 bits) */
DECL|macro|T1LL
mdefine_line|#define T1LL&t;&t;(6*RS)&t;&t;/* Timer 1 latch (low 8 bits) */
DECL|macro|T1LH
mdefine_line|#define T1LH&t;&t;(7*RS)&t;&t;/* Timer 1 latch (high 8 bits) */
DECL|macro|T2CL
mdefine_line|#define T2CL&t;&t;(8*RS)&t;&t;/* Timer 2 ctr/latch (low 8 bits) */
DECL|macro|T2CH
mdefine_line|#define T2CH&t;&t;(9*RS)&t;&t;/* Timer 2 counter (high 8 bits) */
DECL|macro|SR
mdefine_line|#define SR&t;&t;(10*RS)&t;&t;/* Shift register */
DECL|macro|ACR
mdefine_line|#define ACR&t;&t;(11*RS)&t;&t;/* Auxiliary control register */
DECL|macro|PCR
mdefine_line|#define PCR&t;&t;(12*RS)&t;&t;/* Peripheral control register */
DECL|macro|IFR
mdefine_line|#define IFR&t;&t;(13*RS)&t;&t;/* Interrupt flag register */
DECL|macro|IER
mdefine_line|#define IER&t;&t;(14*RS)&t;&t;/* Interrupt enable register */
DECL|macro|ANH
mdefine_line|#define ANH&t;&t;(15*RS)&t;&t;/* A-side data, no handshake */
multiline_comment|/* Bits in B data register: both active low */
DECL|macro|TACK
mdefine_line|#define TACK&t;&t;0x08&t;&t;/* Transfer acknowledge (input) */
DECL|macro|TREQ
mdefine_line|#define TREQ&t;&t;0x10&t;&t;/* Transfer request (output) */
multiline_comment|/* Bits in ACR */
DECL|macro|SR_CTRL
mdefine_line|#define SR_CTRL&t;&t;0x1c&t;&t;/* Shift register control bits */
DECL|macro|SR_EXT
mdefine_line|#define SR_EXT&t;&t;0x0c&t;&t;/* Shift on external clock */
DECL|macro|SR_OUT
mdefine_line|#define SR_OUT&t;&t;0x10&t;&t;/* Shift out if 1 */
multiline_comment|/* Bits in IFR and IER */
DECL|macro|IER_SET
mdefine_line|#define IER_SET&t;&t;0x80&t;&t;/* set bits in IER */
DECL|macro|IER_CLR
mdefine_line|#define IER_CLR&t;&t;0&t;&t;/* clear bits in IER */
DECL|macro|SR_INT
mdefine_line|#define SR_INT&t;&t;0x04&t;&t;/* Shift register full/empty */
DECL|macro|CB1_INT
mdefine_line|#define CB1_INT&t;&t;0x10&t;&t;/* transition on CB1 input */
DECL|enum|pmu_state
r_static
r_enum
id|pmu_state
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|sending
id|sending
comma
DECL|enumerator|intack
id|intack
comma
DECL|enumerator|reading
id|reading
comma
DECL|enumerator|reading_intr
id|reading_intr
comma
DECL|variable|pmu_state
)brace
id|pmu_state
suffix:semicolon
DECL|variable|current_req
r_static
r_struct
id|adb_request
op_star
id|current_req
suffix:semicolon
DECL|variable|last_req
r_static
r_struct
id|adb_request
op_star
id|last_req
suffix:semicolon
DECL|variable|req_awaiting_reply
r_static
r_struct
id|adb_request
op_star
id|req_awaiting_reply
suffix:semicolon
DECL|variable|interrupt_data
r_static
r_int
r_char
id|interrupt_data
(braket
l_int|32
)braket
suffix:semicolon
DECL|variable|reply_ptr
r_static
r_int
r_char
op_star
id|reply_ptr
suffix:semicolon
DECL|variable|data_index
r_static
r_int
id|data_index
suffix:semicolon
DECL|variable|data_len
r_static
r_int
id|data_len
suffix:semicolon
DECL|variable|adb_int_pending
r_static
r_int
id|adb_int_pending
suffix:semicolon
DECL|variable|pmu_adb_flags
r_static
r_int
id|pmu_adb_flags
suffix:semicolon
DECL|variable|adb_dev_map
r_static
r_int
id|adb_dev_map
op_assign
l_int|0
suffix:semicolon
DECL|variable|bright_req_1
DECL|variable|bright_req_2
r_static
r_struct
id|adb_request
id|bright_req_1
comma
id|bright_req_2
suffix:semicolon
DECL|variable|vias
r_static
r_struct
id|device_node
op_star
id|vias
suffix:semicolon
r_static
r_int
id|init_pmu
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pmu_queue_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
suffix:semicolon
r_static
r_void
id|pmu_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|via_pmu_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|pmu_adb_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
suffix:semicolon
r_static
r_int
id|pmu_adb_autopoll
c_func
(paren
r_int
id|on
)paren
suffix:semicolon
r_static
r_void
id|send_byte
c_func
(paren
r_int
id|x
)paren
suffix:semicolon
r_static
r_void
id|recv_byte
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pmu_sr_intr
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|pmu_done
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
suffix:semicolon
r_static
r_void
id|pmu_handle_data
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|set_brightness
c_func
(paren
r_int
id|level
)paren
suffix:semicolon
r_static
r_void
id|set_volume
c_func
(paren
r_int
id|level
)paren
suffix:semicolon
multiline_comment|/*&n; * This table indicates for each PMU opcode:&n; * - the number of data bytes to be sent with the command, or -1&n; *   if a length byte should be sent,&n; * - the number of response bytes which the PMU will return, or&n; *   -1 if it will send a length byte.&n; */
DECL|variable|pmu_data_len
r_static
id|s8
id|pmu_data_len
(braket
l_int|256
)braket
(braket
l_int|2
)braket
op_assign
(brace
multiline_comment|/*&t;   0&t;   1&t;   2&t;   3&t;   4&t;   5&t;   6&t;   7  */
multiline_comment|/*00*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*08*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*10*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*18*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*20*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*28*/
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*30*/
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|20
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|3
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*38*/
(brace
l_int|0
comma
l_int|4
)brace
comma
(brace
l_int|0
comma
l_int|20
)brace
comma
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|2
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*40*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*48*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*50*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|3
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*58*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*60*/
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*68*/
(brace
l_int|0
comma
l_int|3
)brace
comma
(brace
l_int|0
comma
l_int|3
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
l_int|8
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*70*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*78*/
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|1
)brace
comma
multiline_comment|/*80*/
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*88*/
(brace
l_int|0
comma
l_int|5
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*90*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*98*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*a0*/
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*a8*/
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|3
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*b0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*b8*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*c0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*c8*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*d0*/
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*d8*/
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*e0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*e8*/
(brace
l_int|3
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*f0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*f8*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
)brace
suffix:semicolon
id|__openfirmware
r_void
DECL|function|find_via_pmu
id|find_via_pmu
c_func
(paren
)paren
(brace
id|vias
op_assign
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|vias-&gt;next
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Warning: only using 1st via-pmu&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;via_pmu_init: node = %p, addrs =&quot;
comma
id|vias-&gt;node
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vias-&gt;n_addrs
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x(%x)&quot;
comma
id|vias-&gt;addrs
(braket
id|i
)braket
dot
id|address
comma
id|vias-&gt;addrs
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, intrs =&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vias-&gt;n_intrs
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|vias-&gt;intrs
(braket
id|i
)braket
dot
id|line
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|vias-&gt;n_addrs
op_ne
l_int|1
op_logical_or
id|vias-&gt;n_intrs
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;via-pmu: %d addresses, %d interrupts!&bslash;n&quot;
comma
id|vias-&gt;n_addrs
comma
id|vias-&gt;n_intrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias-&gt;n_addrs
OL
l_int|1
op_logical_or
id|vias-&gt;n_intrs
OL
l_int|1
)paren
r_return
suffix:semicolon
)brace
id|via
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|vias-&gt;addrs-&gt;address
comma
l_int|0x2000
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|IER_CLR
op_or
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* disable all intrs */
id|pmu_state
op_assign
id|idle
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_pmu
c_func
(paren
)paren
)paren
id|via
op_assign
l_int|NULL
suffix:semicolon
id|adb_hardware
op_assign
id|ADB_VIAPMU
suffix:semicolon
)brace
r_void
DECL|function|via_pmu_init
id|via_pmu_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|bright_req_1.complete
op_assign
l_int|1
suffix:semicolon
id|bright_req_2.complete
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|vias-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
comma
id|via_pmu_interrupt
comma
l_int|0
comma
l_string|&quot;VIA-PMU&quot;
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VIA-PMU: can&squot;t get irq %d&bslash;n&quot;
comma
id|vias-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|IER_SET
op_or
id|SR_INT
op_or
id|CB1_INT
)paren
suffix:semicolon
multiline_comment|/* Set function pointers */
id|adb_send_request
op_assign
id|pmu_adb_send_request
suffix:semicolon
id|adb_autopoll
op_assign
id|pmu_adb_autopoll
suffix:semicolon
)brace
r_static
r_int
DECL|function|init_pmu
id|init_pmu
c_func
(paren
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_struct
id|adb_request
id|req
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|via
(braket
id|B
)braket
op_or
id|TREQ
)paren
suffix:semicolon
multiline_comment|/* negate TREQ */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|DIRB
)braket
comma
(paren
id|via
(braket
id|DIRB
)braket
op_or
id|TREQ
)paren
op_amp
op_complement
id|TACK
)paren
suffix:semicolon
multiline_comment|/* TACK in, TREQ out */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
l_int|0xff
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;init_pmu: no response from PMU&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ack all pending interrupts */
id|timeout
op_assign
l_int|100000
suffix:semicolon
id|interrupt_data
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|interrupt_data
(braket
l_int|0
)braket
op_logical_or
id|pmu_state
op_ne
id|idle
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;init_pmu: timed out acking intrs&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pmu_state
op_eq
id|idle
)paren
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Send an ADB command */
r_static
r_int
DECL|function|pmu_adb_send_request
id|pmu_adb_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
id|req-&gt;data
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|req-&gt;data
(braket
id|i
)braket
suffix:semicolon
id|req-&gt;data
(braket
l_int|3
)braket
op_assign
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
id|req-&gt;data
(braket
l_int|2
)braket
op_assign
id|pmu_adb_flags
suffix:semicolon
id|req-&gt;data
(braket
l_int|1
)braket
op_assign
id|req-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
id|PMU_ADB_CMD
suffix:semicolon
id|req-&gt;nbytes
op_add_assign
l_int|3
suffix:semicolon
id|req-&gt;reply_expected
op_assign
l_int|1
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|req-&gt;complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Enable/disable autopolling */
r_static
r_int
DECL|function|pmu_adb_autopoll
id|pmu_adb_autopoll
c_func
(paren
r_int
id|on
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_ADB_CMD
comma
l_int|0
comma
l_int|0x86
comma
id|adb_dev_map
op_rshift
l_int|8
comma
id|adb_dev_map
)paren
suffix:semicolon
id|pmu_adb_flags
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|1
comma
id|PMU_ADB_POLL_OFF
)paren
suffix:semicolon
id|pmu_adb_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Construct and send a pmu request */
r_int
DECL|function|pmu_request
id|pmu_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|adb_request
op_star
)paren
comma
r_int
id|nbytes
comma
dot
dot
dot
)paren
(brace
id|va_list
id|list
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
template_param
l_int|32
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmu_request: bad nbytes (%d)&bslash;n&quot;
comma
id|nbytes
)paren
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req-&gt;nbytes
op_assign
id|nbytes
suffix:semicolon
id|req-&gt;done
op_assign
id|done
suffix:semicolon
id|va_start
c_func
(paren
id|list
comma
id|nbytes
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nbytes
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_int
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|req-&gt;reply
(braket
l_int|0
)braket
op_assign
id|ADB_RET_OK
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply_expected
op_assign
l_int|0
suffix:semicolon
r_return
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This procedure handles requests written to /dev/adb where the&n; * first byte is CUDA_PACKET or PMU_PACKET.  For CUDA_PACKET, we&n; * emulate a few CUDA requests.&n; */
r_int
DECL|function|pmu_send_request
id|pmu_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;data
(braket
l_int|0
)braket
)paren
(brace
r_case
id|PMU_PACKET
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|req-&gt;data
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
op_decrement
id|req-&gt;nbytes
suffix:semicolon
r_if
c_cond
(paren
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|req-&gt;reply
(braket
l_int|0
)braket
op_assign
id|ADB_RET_OK
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
r_return
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_case
id|CUDA_PACKET
suffix:colon
r_switch
c_cond
(paren
id|req-&gt;data
(braket
l_int|1
)braket
)paren
(brace
r_case
id|CUDA_GET_TIME
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nbytes
op_ne
l_int|2
)paren
r_break
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
id|PMU_READ_RTC
suffix:semicolon
id|req-&gt;nbytes
op_assign
l_int|1
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|3
suffix:semicolon
id|req-&gt;reply
(braket
l_int|0
)braket
op_assign
id|CUDA_PACKET
suffix:semicolon
id|req-&gt;reply
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply
(braket
l_int|2
)braket
op_assign
id|CUDA_GET_TIME
suffix:semicolon
r_return
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_case
id|CUDA_SET_TIME
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nbytes
op_ne
l_int|6
)paren
r_break
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
id|PMU_SET_RTC
suffix:semicolon
id|req-&gt;nbytes
op_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|4
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|req-&gt;data
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
r_return
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_int
DECL|function|pmu_queue_request
id|pmu_queue_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nsend
suffix:semicolon
r_if
c_cond
(paren
id|via
op_eq
l_int|NULL
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;nbytes
op_le
l_int|0
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|nsend
op_assign
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nsend
op_ge
l_int|0
op_logical_and
id|req-&gt;nbytes
op_ne
id|nsend
op_plus
l_int|1
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req-&gt;next
op_assign
l_int|0
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|0
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_req
op_ne
l_int|0
)paren
(brace
id|last_req-&gt;next
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|current_req
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
r_if
c_cond
(paren
id|pmu_state
op_eq
id|idle
)paren
id|pmu_start
c_func
(paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|send_byte
id|send_byte
c_func
(paren
r_int
id|x
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|ACR
)braket
comma
l_int|0x1c
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|SR
)braket
comma
id|x
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|via
(braket
id|B
)braket
op_amp
op_complement
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* assert TREQ */
)brace
r_static
r_void
DECL|function|recv_byte
id|recv_byte
c_func
(paren
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|ACR
)braket
comma
l_int|0x0c
)paren
suffix:semicolon
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|SR
)braket
)paren
suffix:semicolon
multiline_comment|/* resets SR */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|via
(braket
id|B
)braket
op_amp
op_complement
l_int|0x10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pmu_start
id|pmu_start
c_func
(paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
multiline_comment|/* assert pmu_state == idle */
multiline_comment|/* get the packet to send */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|0
op_logical_or
id|pmu_state
op_ne
id|idle
op_logical_or
(paren
id|req-&gt;reply_expected
op_logical_and
id|req_awaiting_reply
)paren
)paren
r_goto
id|out
suffix:semicolon
id|pmu_state
op_assign
id|sending
suffix:semicolon
id|data_index
op_assign
l_int|1
suffix:semicolon
id|data_len
op_assign
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* set the shift register to shift out and send a byte */
id|send_byte
c_func
(paren
id|req-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|out
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|pmu_poll
id|pmu_poll
c_func
(paren
)paren
(brace
r_int
id|ie
suffix:semicolon
id|ie
op_assign
id|_disable_interrupts
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|via
(braket
id|IFR
)braket
op_amp
(paren
id|SR_INT
op_or
id|CB1_INT
)paren
)paren
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|_enable_interrupts
c_func
(paren
id|ie
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|via_pmu_interrupt
id|via_pmu_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|intr
suffix:semicolon
r_int
id|nloop
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|intr
op_assign
(paren
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
)paren
op_amp
(paren
id|SR_INT
op_or
id|CB1_INT
)paren
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_increment
id|nloop
OG
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PMU: stuck in intr loop, &quot;
l_string|&quot;intr=%x pmu_state=%d&bslash;n&quot;
comma
id|intr
comma
id|pmu_state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr
op_amp
id|SR_INT
)paren
id|pmu_sr_intr
c_func
(paren
id|regs
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|intr
op_amp
id|CB1_INT
)paren
(brace
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
comma
id|CB1_INT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pmu_state
op_eq
id|idle
)paren
(brace
r_if
c_cond
(paren
id|adb_int_pending
)paren
(brace
id|pmu_state
op_assign
id|intack
suffix:semicolon
id|send_byte
c_func
(paren
id|PMU_INT_ACK
)paren
suffix:semicolon
id|adb_int_pending
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current_req
)paren
(brace
id|pmu_start
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|pmu_sr_intr
id|pmu_sr_intr
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
r_int
id|bite
comma
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|via
(braket
id|B
)braket
op_amp
id|TACK
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PMU: sr_intr but ack still high! (%x)&bslash;n&quot;
comma
id|via
(braket
id|B
)braket
)paren
suffix:semicolon
multiline_comment|/* if reading grab the byte, and reset the interrupt */
r_if
c_cond
(paren
(paren
id|via
(braket
id|ACR
)braket
op_amp
id|SR_OUT
)paren
op_eq
l_int|0
)paren
id|bite
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|SR
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
comma
id|SR_INT
)paren
suffix:semicolon
multiline_comment|/* reset TREQ and wait for TACK to go high */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|via
(braket
id|B
)braket
op_or
id|TREQ
)paren
suffix:semicolon
id|timeout
op_assign
l_int|3200
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
)paren
op_amp
id|TACK
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU not responding (!ack)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pmu_state
)paren
(brace
r_case
id|sending
suffix:colon
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OL
l_int|0
)paren
(brace
id|data_len
op_assign
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
id|send_byte
c_func
(paren
id|data_len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_index
op_le
id|data_len
)paren
(brace
id|send_byte
c_func
(paren
id|req-&gt;data
(braket
id|data_index
op_increment
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req-&gt;sent
op_assign
l_int|1
suffix:semicolon
id|data_len
op_assign
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data_len
op_eq
l_int|0
)paren
(brace
id|pmu_state
op_assign
id|idle
suffix:semicolon
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply_expected
)paren
id|req_awaiting_reply
op_assign
id|req
suffix:semicolon
r_else
id|pmu_done
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
id|pmu_state
op_assign
id|reading
suffix:semicolon
id|data_index
op_assign
l_int|0
suffix:semicolon
id|reply_ptr
op_assign
id|req-&gt;reply
op_plus
id|req-&gt;reply_len
suffix:semicolon
id|recv_byte
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|intack
suffix:colon
id|data_index
op_assign
l_int|0
suffix:semicolon
id|data_len
op_assign
op_minus
l_int|1
suffix:semicolon
id|pmu_state
op_assign
id|reading_intr
suffix:semicolon
id|reply_ptr
op_assign
id|interrupt_data
suffix:semicolon
id|recv_byte
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|reading
suffix:colon
r_case
id|reading_intr
suffix:colon
r_if
c_cond
(paren
id|data_len
op_eq
op_minus
l_int|1
)paren
(brace
id|data_len
op_assign
id|bite
suffix:semicolon
r_if
c_cond
(paren
id|bite
OG
l_int|32
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU: bad reply len %d&bslash;n&quot;
comma
id|bite
)paren
suffix:semicolon
)brace
r_else
(brace
id|reply_ptr
(braket
id|data_index
op_increment
)braket
op_assign
id|bite
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_index
OL
id|data_len
)paren
(brace
id|recv_byte
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pmu_state
op_eq
id|reading_intr
)paren
(brace
id|pmu_handle_data
c_func
(paren
id|interrupt_data
comma
id|data_index
comma
id|regs
)paren
suffix:semicolon
)brace
r_else
(brace
id|req
op_assign
id|current_req
suffix:semicolon
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
id|req-&gt;reply_len
op_add_assign
id|data_index
suffix:semicolon
id|pmu_done
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
id|pmu_state
op_assign
id|idle
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;via_pmu_interrupt: unknown state %d?&bslash;n&quot;
comma
id|pmu_state
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|pmu_done
id|pmu_done
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;done
)paren
(paren
op_star
id|req-&gt;done
)paren
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* Interrupt data could be the result data from an ADB cmd */
r_static
r_void
DECL|function|pmu_handle_data
id|pmu_handle_data
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_static
r_int
id|show_pmu_ints
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|1
)paren
(brace
id|adb_int_pending
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_amp
id|PMU_INT_ADB
)paren
(brace
r_if
c_cond
(paren
(paren
id|data
(braket
l_int|0
)braket
op_amp
id|PMU_INT_ADB_AUTO
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|adb_request
op_star
id|req
op_assign
id|req_awaiting_reply
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU: extra ADB reply&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req_awaiting_reply
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|2
)paren
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|req-&gt;reply
comma
id|data
op_plus
l_int|1
comma
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|req-&gt;reply_len
op_assign
id|len
op_minus
l_int|1
suffix:semicolon
)brace
id|pmu_done
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
id|adb_input
c_func
(paren
id|data
op_plus
l_int|1
comma
id|len
op_minus
l_int|1
comma
id|regs
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
l_int|0x08
op_logical_and
id|len
op_eq
l_int|3
)paren
(brace
multiline_comment|/* sound/brightness buttons pressed */
id|set_brightness
c_func
(paren
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|set_volume
c_func
(paren
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|show_pmu_ints
op_logical_and
op_logical_neg
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|PMU_INT_TICK
op_logical_and
id|len
op_eq
l_int|1
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pmu intr&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %.2x&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|backlight_bright
r_int
id|backlight_bright
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|backlight_enabled
r_int
id|backlight_enabled
op_assign
l_int|0
suffix:semicolon
DECL|macro|LEVEL_TO_BRIGHT
mdefine_line|#define LEVEL_TO_BRIGHT(lev)&t;((lev) &lt; 8? 0x7f: 0x4a - ((lev) &gt;&gt; 2))
r_void
DECL|function|pmu_enable_backlight
id|pmu_enable_backlight
c_func
(paren
r_int
id|on
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
r_if
c_cond
(paren
id|backlight_bright
OL
l_int|0
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
l_int|0xd9
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
id|backlight_bright
op_assign
id|LEVEL_TO_BRIGHT
c_func
(paren
id|req.reply
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_BACKLIGHT_BRIGHT
comma
id|backlight_bright
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_BACKLIGHT_CTRL
comma
id|on
ques
c_cond
l_int|0x81
suffix:colon
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
id|backlight_enabled
op_assign
id|on
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_brightness
id|set_brightness
c_func
(paren
r_int
id|level
)paren
(brace
id|backlight_bright
op_assign
id|LEVEL_TO_BRIGHT
c_func
(paren
id|level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bright_req_1.complete
)paren
id|pmu_request
c_func
(paren
op_amp
id|bright_req_1
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_BACKLIGHT_BRIGHT
comma
id|backlight_bright
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bright_req_2.complete
)paren
(brace
id|backlight_enabled
op_assign
id|backlight_bright
OL
l_int|0x7f
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|bright_req_2
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_BACKLIGHT_CTRL
comma
id|backlight_enabled
ques
c_cond
l_int|0x81
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|set_volume
id|set_volume
c_func
(paren
r_int
id|level
)paren
(brace
)brace
eof
