multiline_comment|/*&n; * I/O Processor (IOP) ADB Driver&n; * Written and (C) 1999 by Joshua M. Thompson (funaho@jurai.org)&n; * Based on via-cuda.c by Paul Mackerras.&n; *&n; * 1999-07-01 (jmt) - First implementation for new driver architecture.&n; *&n; * 1999-07-31 (jmt) - First working version.&n; *&n; * TODO:&n; *&n; * o Implement SRQ handling.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt; 
macro_line|#include &lt;asm/macintosh.h&gt; 
macro_line|#include &lt;asm/macints.h&gt; 
macro_line|#include &lt;asm/mac_iop.h&gt;
macro_line|#include &lt;asm/mac_oss.h&gt;
macro_line|#include &lt;asm/adb_iop.h&gt;
macro_line|#include &lt;linux/adb.h&gt; 
multiline_comment|/*#define DEBUG_ADB_IOP*/
r_extern
r_void
id|iop_ism_irq
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|variable|current_req
r_static
r_struct
id|adb_request
op_star
id|current_req
suffix:semicolon
DECL|variable|last_req
r_static
r_struct
id|adb_request
op_star
id|last_req
suffix:semicolon
macro_line|#if 0
r_static
r_int
r_char
id|reply_buff
(braket
l_int|16
)braket
suffix:semicolon
r_static
r_int
r_char
op_star
id|reply_ptr
suffix:semicolon
macro_line|#endif
DECL|enum|adb_iop_state
r_static
r_enum
id|adb_iop_state
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|sending
id|sending
comma
DECL|enumerator|awaiting_reply
id|awaiting_reply
DECL|variable|adb_iop_state
)brace
id|adb_iop_state
suffix:semicolon
r_static
r_void
id|adb_iop_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|adb_iop_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|adb_iop_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|adb_iop_send_request
c_func
(paren
r_struct
id|adb_request
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|adb_iop_write
c_func
(paren
r_struct
id|adb_request
op_star
)paren
suffix:semicolon
r_static
r_int
id|adb_iop_autopoll
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|adb_iop_poll
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|adb_iop_reset_bus
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|adb_iop_driver
r_struct
id|adb_driver
id|adb_iop_driver
op_assign
(brace
l_string|&quot;ISM IOP&quot;
comma
id|adb_iop_probe
comma
id|adb_iop_init
comma
id|adb_iop_send_request
comma
id|adb_iop_autopoll
comma
id|adb_iop_poll
comma
id|adb_iop_reset_bus
)brace
suffix:semicolon
DECL|function|adb_iop_end_req
r_static
r_void
id|adb_iop_end_req
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|state
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;done
)paren
(paren
op_star
id|req-&gt;done
)paren
(paren
id|req
)paren
suffix:semicolon
id|adb_iop_state
op_assign
id|state
suffix:semicolon
)brace
multiline_comment|/*&n; * Completion routine for ADB commands sent to the IOP.&n; *&n; * This will be called when a packet has been successfully sent.&n; */
DECL|function|adb_iop_complete
r_static
r_void
id|adb_iop_complete
c_func
(paren
r_struct
id|iop_msg
op_star
id|msg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
id|uint
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adb_iop_state
op_eq
id|sending
)paren
op_logical_and
id|req
op_logical_and
id|req-&gt;reply_expected
)paren
(brace
id|adb_iop_state
op_assign
id|awaiting_reply
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Listen for ADB messages from the IOP.&n; *&n; * This will be called when unsolicited messages (usually replies to TALK&n; * commands or autopoll packets) are received.&n; */
DECL|function|adb_iop_listen
r_static
r_void
id|adb_iop_listen
c_func
(paren
r_struct
id|iop_msg
op_star
id|msg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|adb_iopmsg
op_star
id|amsg
op_assign
(paren
r_struct
id|adb_iopmsg
op_star
)paren
id|msg-&gt;message
suffix:semicolon
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
id|uint
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|req
op_assign
id|current_req
suffix:semicolon
macro_line|#ifdef DEBUG_ADB_IOP
id|printk
c_func
(paren
l_string|&quot;adb_iop_listen: rcvd packet, %d bytes: %02X %02X&quot;
comma
(paren
id|uint
)paren
id|amsg-&gt;count
op_plus
l_int|2
comma
(paren
id|uint
)paren
id|amsg-&gt;flags
comma
(paren
id|uint
)paren
id|amsg-&gt;cmd
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|amsg-&gt;count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
(paren
id|uint
)paren
id|amsg-&gt;data
(braket
id|i
op_increment
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Handle a timeout. Timeout packets seem to occur even after */
multiline_comment|/* we&squot;ve gotten a valid reply to a TALK, so I&squot;m assuming that */
multiline_comment|/* a &quot;timeout&quot; is actually more like an &quot;end-of-data&quot; signal. */
multiline_comment|/* We need to send back a timeout packet to the IOP to shut   */
multiline_comment|/* it up, plus complete the current request, if any.          */
r_if
c_cond
(paren
id|amsg-&gt;flags
op_amp
id|ADB_IOP_TIMEOUT
)paren
(brace
id|msg-&gt;reply
(braket
l_int|0
)braket
op_assign
id|ADB_IOP_TIMEOUT
op_or
id|ADB_IOP_AUTOPOLL
suffix:semicolon
id|msg-&gt;reply
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|msg-&gt;reply
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|req
op_logical_and
(paren
id|adb_iop_state
op_ne
id|idle
)paren
)paren
(brace
id|adb_iop_end_req
c_func
(paren
id|req
comma
id|idle
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* TODO: is it possible for more tha one chunk of data  */
multiline_comment|/*       to arrive before the timeout? If so we need to */
multiline_comment|/*       use reply_ptr here like the other drivers do.  */
r_if
c_cond
(paren
(paren
id|adb_iop_state
op_eq
id|awaiting_reply
)paren
op_logical_and
(paren
id|amsg-&gt;flags
op_amp
id|ADB_IOP_EXPLICIT
)paren
)paren
(brace
id|req-&gt;reply_len
op_assign
id|amsg-&gt;count
op_plus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|req-&gt;reply
comma
op_amp
id|amsg-&gt;cmd
comma
id|req-&gt;reply_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|adb_input
c_func
(paren
op_amp
id|amsg-&gt;cmd
comma
id|amsg-&gt;count
op_plus
l_int|1
comma
id|regs
comma
id|amsg-&gt;flags
op_amp
id|ADB_IOP_AUTOPOLL
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|msg-&gt;reply
comma
id|msg-&gt;message
comma
id|IOP_MSG_LEN
)paren
suffix:semicolon
)brace
id|iop_complete_message
c_func
(paren
id|msg
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Start sending an ADB packet, IOP style&n; *&n; * There isn&squot;t much to do other than hand the packet over to the IOP&n; * after encapsulating it in an adb_iopmsg.&n; */
DECL|function|adb_iop_start
r_static
r_void
id|adb_iop_start
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
r_struct
id|adb_iopmsg
id|amsg
suffix:semicolon
multiline_comment|/* get the packet to send */
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_ADB_IOP
id|printk
c_func
(paren
l_string|&quot;adb_iop_start: sending packet, %d bytes:&quot;
comma
id|req-&gt;nbytes
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;nbytes
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
(paren
id|uint
)paren
id|req-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* The IOP takes MacII-style packets, so */
multiline_comment|/* strip the initial ADB_PACKET byte.    */
id|amsg.flags
op_assign
id|ADB_IOP_EXPLICIT
suffix:semicolon
id|amsg.count
op_assign
id|req-&gt;nbytes
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* amsg.data immediately follows amsg.cmd, effectively making */
multiline_comment|/* amsg.cmd a pointer to the beginning of a full ADB packet.  */
id|memcpy
c_func
(paren
op_amp
id|amsg.cmd
comma
id|req-&gt;data
op_plus
l_int|1
comma
id|req-&gt;nbytes
op_minus
l_int|1
)paren
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|1
suffix:semicolon
id|adb_iop_state
op_assign
id|sending
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Now send it. The IOP manager will call adb_iop_complete */
multiline_comment|/* when the packet has been sent.                          */
id|iop_send_message
c_func
(paren
id|ADB_IOP
comma
id|ADB_CHAN
comma
id|req
comma
r_sizeof
(paren
id|amsg
)paren
comma
(paren
id|__u8
op_star
)paren
op_amp
id|amsg
comma
id|adb_iop_complete
)paren
suffix:semicolon
)brace
DECL|function|adb_iop_probe
r_int
id|adb_iop_probe
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|iop_ism_present
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adb_iop_init
r_int
id|adb_iop_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;adb: IOP ISM driver v0.4 for Unified ADB.&bslash;n&quot;
)paren
suffix:semicolon
id|iop_listen
c_func
(paren
id|ADB_IOP
comma
id|ADB_CHAN
comma
id|adb_iop_listen
comma
l_string|&quot;ADB&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adb_iop_send_request
r_int
id|adb_iop_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|adb_iop_write
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|req-&gt;complete
)paren
id|adb_iop_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adb_iop_write
r_static
r_int
id|adb_iop_write
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|req-&gt;nbytes
OL
l_int|2
)paren
op_logical_or
(paren
id|req-&gt;data
(braket
l_int|0
)braket
op_ne
id|ADB_PACKET
)paren
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;next
op_assign
l_int|0
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|0
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|current_req
op_ne
l_int|0
)paren
(brace
id|last_req-&gt;next
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|current_req
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adb_iop_state
op_eq
id|idle
)paren
id|adb_iop_start
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adb_iop_autopoll
r_int
id|adb_iop_autopoll
c_func
(paren
r_int
id|devs
)paren
(brace
multiline_comment|/* TODO: how do we enable/disable autopoll? */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adb_iop_poll
r_void
id|adb_iop_poll
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|adb_iop_state
op_eq
id|idle
)paren
id|adb_iop_start
c_func
(paren
)paren
suffix:semicolon
id|iop_ism_irq
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|ADB_IOP
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|adb_iop_reset_bus
r_int
id|adb_iop_reset_bus
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.nbytes
op_assign
l_int|2
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|ADB_PACKET
suffix:semicolon
id|req.data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET */
id|adb_iop_write
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|adb_iop_poll
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
