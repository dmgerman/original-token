multiline_comment|/*&n; * Driver for the ADB controller in the Mac I/O (Hydra) chip.&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/hydra.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|struct|preg
r_struct
id|preg
(brace
DECL|member|r
r_int
r_char
id|r
suffix:semicolon
DECL|member|pad
r_char
id|pad
(braket
l_int|15
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|adb_regs
r_struct
id|adb_regs
(brace
DECL|member|intr
r_struct
id|preg
id|intr
suffix:semicolon
DECL|member|data
r_struct
id|preg
id|data
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|intr_enb
r_struct
id|preg
id|intr_enb
suffix:semicolon
DECL|member|dcount
r_struct
id|preg
id|dcount
suffix:semicolon
DECL|member|error
r_struct
id|preg
id|error
suffix:semicolon
DECL|member|ctrl
r_struct
id|preg
id|ctrl
suffix:semicolon
DECL|member|autopoll
r_struct
id|preg
id|autopoll
suffix:semicolon
DECL|member|active_hi
r_struct
id|preg
id|active_hi
suffix:semicolon
DECL|member|active_lo
r_struct
id|preg
id|active_lo
suffix:semicolon
DECL|member|test
r_struct
id|preg
id|test
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Bits in intr and intr_enb registers */
DECL|macro|DFB
mdefine_line|#define DFB&t;1&t;&t;/* data from bus */
DECL|macro|TAG
mdefine_line|#define TAG&t;2&t;&t;/* transfer access grant */
multiline_comment|/* Bits in dcount register */
DECL|macro|HMB
mdefine_line|#define HMB&t;0x0f&t;&t;/* how many bytes */
DECL|macro|APD
mdefine_line|#define APD&t;0x10&t;&t;/* auto-poll data */
multiline_comment|/* Bits in error register */
DECL|macro|NRE
mdefine_line|#define NRE&t;1&t;&t;/* no response error */
DECL|macro|DLE
mdefine_line|#define DLE&t;2&t;&t;/* data lost error */
multiline_comment|/* Bits in ctrl register */
DECL|macro|TAR
mdefine_line|#define TAR&t;1&t;&t;/* transfer access request */
DECL|macro|DTB
mdefine_line|#define DTB&t;2&t;&t;/* data to bus */
DECL|macro|CRE
mdefine_line|#define CRE&t;4&t;&t;/* command response expected */
DECL|macro|ADB_RST
mdefine_line|#define ADB_RST&t;8&t;&t;/* ADB reset */
multiline_comment|/* Bits in autopoll register */
DECL|macro|APE
mdefine_line|#define APE&t;1&t;&t;/* autopoll enable */
DECL|variable|adb
r_static
r_volatile
r_struct
id|adb_regs
op_star
id|adb
suffix:semicolon
DECL|variable|current_req
DECL|variable|last_req
r_static
r_struct
id|adb_request
op_star
id|current_req
comma
op_star
id|last_req
suffix:semicolon
DECL|variable|adb_rbuf
r_static
r_int
r_char
id|adb_rbuf
(braket
l_int|16
)braket
suffix:semicolon
r_static
r_int
id|macio_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|macio_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|macio_adb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|macio_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
suffix:semicolon
r_static
r_int
id|macio_adb_autopoll
c_func
(paren
r_int
id|devs
)paren
suffix:semicolon
r_static
r_void
id|macio_adb_poll
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|macio_adb_reset_bus
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|completed
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|macio_adb_driver
r_struct
id|adb_driver
id|macio_adb_driver
op_assign
(brace
l_string|&quot;MACIO&quot;
comma
id|macio_probe
comma
id|macio_init
comma
id|macio_send_request
comma
multiline_comment|/*macio_write,*/
id|macio_adb_autopoll
comma
id|macio_adb_poll
comma
id|macio_adb_reset_bus
)brace
suffix:semicolon
DECL|function|macio_probe
r_int
id|macio_probe
c_func
(paren
r_void
)paren
(brace
r_return
id|find_compatible_devices
c_func
(paren
l_string|&quot;adb&quot;
comma
l_string|&quot;chrp,adb0&quot;
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|macio_init
r_int
id|macio_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|adbs
suffix:semicolon
id|adbs
op_assign
id|find_compatible_devices
c_func
(paren
l_string|&quot;adb&quot;
comma
l_string|&quot;chrp,adb0&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adbs
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macio_adb_init: node = %p, addrs =&quot;
comma
id|adbs-&gt;node
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adbs-&gt;n_addrs
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x(%x)&quot;
comma
id|adbs-&gt;addrs
(braket
id|i
)braket
dot
id|address
comma
id|adbs-&gt;addrs
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, intrs =&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adbs-&gt;n_intrs
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|adbs-&gt;intrs
(braket
id|i
)braket
dot
id|line
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|adb
op_assign
(paren
r_volatile
r_struct
id|adb_regs
op_star
)paren
id|ioremap
c_func
(paren
id|adbs-&gt;addrs-&gt;address
comma
r_sizeof
(paren
r_struct
id|adb_regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|adbs-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
comma
id|macio_adb_interrupt
comma
l_int|0
comma
l_string|&quot;ADB&quot;
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ADB: can&squot;t get irq %d&bslash;n&quot;
comma
id|adbs-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;intr.r
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;error.r
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;active_hi.r
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* for now, set all devices active */
id|out_8
c_func
(paren
op_amp
id|adb-&gt;active_lo.r
comma
l_int|0xff
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;autopoll.r
comma
id|APE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;intr_enb.r
comma
id|DFB
op_or
id|TAG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;adb: mac-io driver 1.0 for unified ADB&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macio_adb_autopoll
r_static
r_int
id|macio_adb_autopoll
c_func
(paren
r_int
id|devs
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;active_hi.r
comma
id|devs
op_rshift
l_int|8
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;active_lo.r
comma
id|devs
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;autopoll.r
comma
id|devs
ques
c_cond
id|APE
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macio_adb_reset_bus
r_static
r_int
id|macio_adb_reset_bus
c_func
(paren
r_void
)paren
(brace
r_int
id|timeout
op_assign
l_int|1000000
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
id|in_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
)paren
op_or
id|ADB_RST
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
)paren
op_amp
id|ADB_RST
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
id|in_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
)paren
op_amp
op_complement
id|ADB_RST
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Send an ADB command */
DECL|function|macio_send_request
r_static
r_int
id|macio_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
(brace
r_int
r_int
id|mflags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;data
(braket
l_int|0
)braket
op_ne
id|ADB_PACKET
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|req-&gt;data
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
op_decrement
id|req-&gt;nbytes
suffix:semicolon
id|req-&gt;next
op_assign
l_int|0
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|0
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|mflags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_req
op_ne
l_int|0
)paren
(brace
id|last_req-&gt;next
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|current_req
op_assign
id|last_req
op_assign
id|req
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
id|in_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
)paren
op_or
id|TAR
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|mflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|req-&gt;complete
)paren
id|macio_adb_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macio_adb_interrupt
r_static
r_void
id|macio_adb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
comma
id|n
comma
id|err
suffix:semicolon
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|adb-&gt;intr.r
)paren
op_amp
id|TAG
)paren
(brace
r_if
c_cond
(paren
(paren
id|req
op_assign
id|current_req
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* put the current request in */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;nbytes
suffix:semicolon
op_increment
id|i
)paren
id|out_8
c_func
(paren
op_amp
id|adb-&gt;data
(braket
id|i
)braket
dot
id|r
comma
id|req-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;dcount.r
comma
id|req-&gt;nbytes
op_amp
id|HMB
)paren
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply_expected
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
id|DTB
op_plus
id|CRE
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
id|DTB
)paren
suffix:semicolon
id|completed
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;intr.r
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|adb-&gt;intr.r
)paren
op_amp
id|DFB
)paren
(brace
id|err
op_assign
id|in_8
c_func
(paren
op_amp
id|adb-&gt;error.r
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_req
op_logical_and
id|current_req-&gt;sent
)paren
(brace
multiline_comment|/* this is the response to a command */
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
id|req-&gt;reply_len
op_assign
id|in_8
c_func
(paren
op_amp
id|adb-&gt;dcount.r
)paren
op_amp
id|HMB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;reply_len
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;reply
(braket
id|i
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|adb-&gt;data
(braket
id|i
)braket
dot
id|r
)paren
suffix:semicolon
)brace
id|completed
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
multiline_comment|/* autopoll data */
id|n
op_assign
id|in_8
c_func
(paren
op_amp
id|adb-&gt;dcount.r
)paren
op_amp
id|HMB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
op_increment
id|i
)paren
id|adb_rbuf
(braket
id|i
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|adb-&gt;data
(braket
id|i
)braket
dot
id|r
)paren
suffix:semicolon
id|adb_input
c_func
(paren
id|adb_rbuf
comma
id|n
comma
id|regs
comma
id|in_8
c_func
(paren
op_amp
id|adb-&gt;dcount.r
)paren
op_amp
id|APD
)paren
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|adb-&gt;error.r
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|adb-&gt;intr.r
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|completed
r_static
r_void
id|completed
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
op_star
id|req
op_assign
id|current_req
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|current_req
)paren
id|out_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
comma
id|in_8
c_func
(paren
op_amp
id|adb-&gt;ctrl.r
)paren
op_or
id|TAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;done
)paren
(paren
op_star
id|req-&gt;done
)paren
(paren
id|req
)paren
suffix:semicolon
)brace
DECL|function|macio_adb_poll
r_static
r_void
id|macio_adb_poll
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|adb-&gt;intr.r
)paren
op_ne
l_int|0
)paren
id|macio_adb_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
