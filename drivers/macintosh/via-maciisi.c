multiline_comment|/*&n; * Device driver for the IIsi-style ADB on some Mac LC and II-class machines&n; *&n; * Based on via-cuda.c and via-macii.c, as well as the original&n; * adb-bus.c, which in turn is somewhat influenced by (but uses no&n; * code from) the NetBSD HWDIRECT ADB code.  Original IIsi driver work&n; * was done by Robert Thompson and integrated into the old style&n; * driver by Michael Schmitz.&n; *&n; * Original sources (c) Alan Cox, Paul Mackerras, and others.&n; *&n; * Rewritten for Unified ADB by David Huggins-Daines &lt;dhd@debian.org&gt; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/cuda.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/macintosh.h&gt;
macro_line|#include &lt;asm/macints.h&gt;
macro_line|#include &lt;asm/machw.h&gt;
macro_line|#include &lt;asm/mac_via.h&gt;
DECL|variable|via
r_static
r_volatile
r_int
r_char
op_star
id|via
suffix:semicolon
multiline_comment|/* VIA registers - spaced 0x200 bytes apart - only the ones we actually use */
DECL|macro|RS
mdefine_line|#define RS&t;&t;0x200&t;&t;/* skip between registers */
DECL|macro|B
mdefine_line|#define B&t;&t;0&t;&t;/* B-side data */
DECL|macro|A
mdefine_line|#define A&t;&t;RS&t;&t;/* A-side data */
DECL|macro|DIRB
mdefine_line|#define DIRB&t;&t;(2*RS)&t;&t;/* B-side direction (1=output) */
DECL|macro|DIRA
mdefine_line|#define DIRA&t;&t;(3*RS)&t;&t;/* A-side direction (1=output) */
DECL|macro|SR
mdefine_line|#define SR&t;&t;(10*RS)&t;&t;/* Shift register */
DECL|macro|ACR
mdefine_line|#define ACR&t;&t;(11*RS)&t;&t;/* Auxiliary control register */
DECL|macro|IFR
mdefine_line|#define IFR&t;&t;(13*RS)&t;&t;/* Interrupt flag register */
DECL|macro|IER
mdefine_line|#define IER&t;&t;(14*RS)&t;&t;/* Interrupt enable register */
multiline_comment|/* Bits in B data register: all active low */
DECL|macro|TREQ
mdefine_line|#define TREQ&t;&t;0x08&t;&t;/* Transfer request (input) */
DECL|macro|TACK
mdefine_line|#define TACK&t;&t;0x10&t;&t;/* Transfer acknowledge (output) */
DECL|macro|TIP
mdefine_line|#define TIP&t;&t;0x20&t;&t;/* Transfer in progress (output) */
DECL|macro|ST_MASK
mdefine_line|#define ST_MASK&t;&t;0x30&t;&t;/* mask for selecting ADB state bits */
multiline_comment|/* Bits in ACR */
DECL|macro|SR_CTRL
mdefine_line|#define SR_CTRL&t;&t;0x1c&t;&t;/* Shift register control bits */
DECL|macro|SR_EXT
mdefine_line|#define SR_EXT&t;&t;0x0c&t;&t;/* Shift on external clock */
DECL|macro|SR_OUT
mdefine_line|#define SR_OUT&t;&t;0x10&t;&t;/* Shift out if 1 */
multiline_comment|/* Bits in IFR and IER */
DECL|macro|IER_SET
mdefine_line|#define IER_SET&t;&t;0x80&t;&t;/* set bits in IER */
DECL|macro|IER_CLR
mdefine_line|#define IER_CLR&t;&t;0&t;&t;/* clear bits in IER */
DECL|macro|SR_INT
mdefine_line|#define SR_INT&t;&t;0x04&t;&t;/* Shift register full/empty */
DECL|macro|SR_DATA
mdefine_line|#define SR_DATA&t;&t;0x08&t;&t;/* Shift register data */
DECL|macro|SR_CLOCK
mdefine_line|#define SR_CLOCK&t;0x10&t;&t;/* Shift register clock */
DECL|macro|ADB_DELAY
mdefine_line|#define ADB_DELAY 150
DECL|variable|current_req
r_static
r_struct
id|adb_request
op_star
id|current_req
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|last_req
r_static
r_struct
id|adb_request
op_star
id|last_req
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|maciisi_rbuf
r_static
r_int
r_char
id|maciisi_rbuf
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|reply_ptr
r_static
r_int
r_char
op_star
id|reply_ptr
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|data_index
r_static
r_int
id|data_index
suffix:semicolon
DECL|variable|reading_reply
r_static
r_int
id|reading_reply
suffix:semicolon
DECL|variable|reply_len
r_static
r_int
id|reply_len
suffix:semicolon
DECL|enum|maciisi_state
r_static
r_enum
id|maciisi_state
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|sending
id|sending
comma
DECL|enumerator|reading
id|reading
comma
DECL|variable|maciisi_state
)brace
id|maciisi_state
suffix:semicolon
r_static
r_int
id|maciisi_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|maciisi_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|maciisi_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
suffix:semicolon
r_static
r_int
id|maciisi_write
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
suffix:semicolon
r_static
r_void
id|maciisi_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|maciisi_input
c_func
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|nb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|maciisi_init_via
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|maciisi_poll
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|maciisi_start
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|via_maciisi_driver
r_struct
id|adb_driver
id|via_maciisi_driver
op_assign
(brace
l_string|&quot;Mac IIsi&quot;
comma
id|maciisi_probe
comma
id|maciisi_init
comma
id|maciisi_send_request
comma
l_int|NULL
comma
multiline_comment|/* maciisi_adb_autopoll, */
id|maciisi_poll
comma
l_int|NULL
multiline_comment|/* maciisi_reset_adb_bus */
)brace
suffix:semicolon
r_static
r_int
DECL|function|maciisi_probe
id|maciisi_probe
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|macintosh_config-&gt;adb_type
op_ne
id|MAC_ADB_IISI
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|via
op_assign
id|via1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|maciisi_init
id|maciisi_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|via
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|maciisi_init_via
c_func
(paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maciisi_init: maciisi_init_via() failed, code %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|via
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_MAC_ADB
comma
id|maciisi_interrupt
comma
id|IRQ_FLG_LOCK
comma
l_string|&quot;ADB&quot;
comma
id|maciisi_interrupt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maciisi_init: can&squot;t get irq %d&bslash;n&quot;
comma
id|IRQ_MAC_ADB
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;adb: Mac IIsi driver v0.1 for Unified ADB.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|maciisi_stfu
id|maciisi_stfu
c_func
(paren
r_void
)paren
(brace
r_int
id|status
op_assign
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TREQ
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_stfu called with TREQ high!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* start transfer */
id|via
(braket
id|B
)braket
op_or_assign
id|TIP
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|TREQ
)paren
)paren
(brace
r_int
id|poll_timeout
op_assign
id|ADB_DELAY
op_star
l_int|5
suffix:semicolon
multiline_comment|/* Poll for SR interrupt */
r_while
c_loop
(paren
op_logical_neg
(paren
id|via
(braket
id|IFR
)braket
op_amp
id|SR_INT
)paren
op_logical_and
id|poll_timeout
op_decrement
OG
l_int|0
)paren
id|status
op_assign
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
suffix:semicolon
id|via
(braket
id|SR
)braket
suffix:semicolon
multiline_comment|/* Clear shift register */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_stfu: status %x timeout %d&bslash;n&quot;
comma
id|status
comma
id|poll_timeout
)paren
suffix:semicolon
multiline_comment|/* ACK on-off */
id|via
(braket
id|B
)braket
op_or_assign
id|TACK
suffix:semicolon
id|udelay
c_func
(paren
id|ADB_DELAY
)paren
suffix:semicolon
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TACK
suffix:semicolon
)brace
multiline_comment|/* end frame */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TIP
suffix:semicolon
)brace
multiline_comment|/* All specifically VIA-related initialization goes here */
r_static
r_int
DECL|function|maciisi_init_via
id|maciisi_init_via
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Set the lines up. We want TREQ as input TACK|TIP as output */
id|via
(braket
id|DIRB
)braket
op_assign
(paren
id|via
(braket
id|DIRB
)braket
op_or
id|TACK
op_or
id|TIP
)paren
op_amp
op_complement
id|TREQ
suffix:semicolon
multiline_comment|/* Shift register on input */
id|via
(braket
id|ACR
)braket
op_assign
(paren
id|via
(braket
id|ACR
)braket
op_amp
op_complement
id|SR_CTRL
)paren
op_or
id|SR_EXT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_init_via: initial status %x&bslash;n&quot;
comma
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
)paren
suffix:semicolon
multiline_comment|/* Set initial state: idle */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
(paren
id|TACK
op_or
id|TIP
)paren
suffix:semicolon
multiline_comment|/* Wipe any pending data and int */
id|via
(braket
id|SR
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|via
(braket
id|B
)braket
op_amp
id|TREQ
)paren
)paren
id|maciisi_stfu
c_func
(paren
)paren
suffix:semicolon
id|via
(braket
id|IER
)braket
op_assign
id|IER_SET
op_or
id|SR_INT
suffix:semicolon
id|maciisi_state
op_assign
id|idle
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Send a request, possibly waiting for a reply */
r_static
r_int
DECL|function|maciisi_send_request
id|maciisi_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|dump_packet
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|via
op_eq
l_int|NULL
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dump_packet
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_send_request:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;nbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %.2x&quot;
comma
id|req-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|req-&gt;reply_expected
op_assign
l_int|1
suffix:semicolon
id|i
op_assign
id|maciisi_write
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|req-&gt;complete
)paren
(brace
id|maciisi_poll
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Enqueue a request, and run the queue if possible */
r_static
r_int
DECL|function|maciisi_write
id|maciisi_write
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_write called, state=%d ifr=%x&bslash;n&quot;
comma
id|maciisi_state
comma
id|via
(braket
id|IFR
)braket
)paren
suffix:semicolon
multiline_comment|/* We will accept CUDA packets - the VIA sends them to us, so&n;           it figures that we should be able to send them to it */
r_if
c_cond
(paren
id|req-&gt;nbytes
template_param
id|CUDA_PACKET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maciisi_write: packet too small or not an ADB or CUDA packet&bslash;n&quot;
)paren
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req-&gt;next
op_assign
l_int|0
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|0
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_req
)paren
(brace
id|last_req-&gt;next
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|current_req
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
r_if
c_cond
(paren
id|maciisi_state
op_eq
id|idle
)paren
id|maciisi_start
c_func
(paren
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_write: would start, but state is %d&bslash;n&quot;
comma
id|maciisi_state
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|maciisi_start
id|maciisi_start
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
r_int
id|status
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_start called, state=%d, ifr=%x&bslash;n&quot;
comma
id|maciisi_state
comma
id|via
(braket
id|IFR
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maciisi_state
op_ne
id|idle
)paren
(brace
multiline_comment|/* shouldn&squot;t happen */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maciisi_start: maciisi_start called when driver busy!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|status
op_assign
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|TREQ
)paren
)paren
(brace
multiline_comment|/* Bus is busy, set up for reading */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_start: bus busy - aborting&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Okay, send */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_start: sending&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set state to active */
id|via
(braket
id|B
)braket
op_or_assign
id|TIP
suffix:semicolon
multiline_comment|/* ACK off */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TACK
suffix:semicolon
multiline_comment|/* Shift out and send */
id|via
(braket
id|ACR
)braket
op_or_assign
id|SR_OUT
suffix:semicolon
id|via
(braket
id|SR
)braket
op_assign
id|req-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
id|data_index
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ACK on */
id|via
(braket
id|B
)braket
op_or_assign
id|TACK
suffix:semicolon
id|maciisi_state
op_assign
id|sending
suffix:semicolon
)brace
r_void
DECL|function|maciisi_poll
id|maciisi_poll
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|via
(braket
id|IFR
)braket
op_amp
id|SR_INT
)paren
(brace
id|maciisi_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Shift register interrupt - this is *supposed* to mean that the&n;   register is either full or empty. In practice, I have no idea what&n;   it means :( */
r_static
r_void
DECL|function|maciisi_interrupt
id|maciisi_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
r_static
r_int
id|dump_reply
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|via
(braket
id|IFR
)braket
op_amp
id|SR_INT
)paren
)paren
(brace
multiline_comment|/* Shouldn&squot;t happen, we hope */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: called without interrupt flag set&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|status
op_assign
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;state %d status %x ifr %x&bslash;n&quot;
comma
id|maciisi_state
comma
id|status
comma
id|via
(braket
id|IFR
)braket
)paren
suffix:semicolon
id|switch_start
suffix:colon
r_switch
c_cond
(paren
id|maciisi_state
)paren
(brace
r_case
id|idle
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: state=idle, status %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TIP
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: state is idle but TIP asserted!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ADB_DELAY
)paren
suffix:semicolon
multiline_comment|/* Shift in */
id|via
(braket
id|ACR
)braket
op_and_assign
op_complement
id|SR_OUT
suffix:semicolon
multiline_comment|/* Signal start of frame */
id|via
(braket
id|B
)braket
op_or_assign
id|TIP
suffix:semicolon
multiline_comment|/* Clear the interrupt (throw this value on the floor, it&squot;s useless) */
id|via
(braket
id|SR
)braket
suffix:semicolon
multiline_comment|/* ACK adb chip, high-low */
id|via
(braket
id|B
)braket
op_or_assign
id|TACK
suffix:semicolon
id|udelay
c_func
(paren
id|ADB_DELAY
)paren
suffix:semicolon
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TACK
suffix:semicolon
id|reply_len
op_assign
l_int|0
suffix:semicolon
id|maciisi_state
op_assign
id|reading
suffix:semicolon
r_if
c_cond
(paren
id|reading_reply
)paren
(brace
id|reply_ptr
op_assign
id|current_req-&gt;reply
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: received unsolicited packet&bslash;n&quot;
)paren
suffix:semicolon
id|reply_ptr
op_assign
id|maciisi_rbuf
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|sending
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: state=sending, status=%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt */
id|via
(braket
id|SR
)braket
suffix:semicolon
multiline_comment|/* Set ACK off */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TACK
suffix:semicolon
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|TREQ
)paren
)paren
(brace
multiline_comment|/* collision */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: send collision&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set idle and input */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TIP
suffix:semicolon
id|via
(braket
id|ACR
)braket
op_and_assign
op_complement
id|SR_OUT
suffix:semicolon
multiline_comment|/* Must re-send */
id|reading_reply
op_assign
l_int|0
suffix:semicolon
id|reply_len
op_assign
l_int|0
suffix:semicolon
id|maciisi_state
op_assign
id|idle
suffix:semicolon
multiline_comment|/* process this now, because the IFR has been cleared */
r_goto
id|switch_start
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_index
op_ge
id|req-&gt;nbytes
)paren
(brace
multiline_comment|/* Sent the whole packet, put the bus back in idle state */
multiline_comment|/* Shift in, we are about to read a reply (hopefully) */
id|via
(braket
id|ACR
)braket
op_and_assign
op_complement
id|SR_OUT
suffix:semicolon
multiline_comment|/* End of frame */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TIP
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|1
suffix:semicolon
id|maciisi_state
op_assign
id|idle
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply_expected
)paren
(brace
multiline_comment|/* Note: only set this once we&squot;ve&n;                                   successfully sent the packet */
id|reading_reply
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;done
)paren
(paren
op_star
id|req-&gt;done
)paren
(paren
id|req
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Sending more stuff */
multiline_comment|/* Shift out */
id|via
(braket
id|ACR
)braket
op_or_assign
id|SR_OUT
suffix:semicolon
multiline_comment|/* Delay */
id|udelay
c_func
(paren
id|ADB_DELAY
)paren
suffix:semicolon
multiline_comment|/* Write */
id|via
(braket
id|SR
)braket
op_assign
id|req-&gt;data
(braket
id|data_index
op_increment
)braket
suffix:semicolon
multiline_comment|/* Signal &squot;byte ready&squot; */
id|via
(braket
id|B
)braket
op_or_assign
id|TACK
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|reading
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: state=reading, status=%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Shift in */
id|via
(braket
id|ACR
)braket
op_and_assign
op_complement
id|SR_OUT
suffix:semicolon
r_if
c_cond
(paren
id|reply_len
op_increment
OG
l_int|16
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maciisi_interrupt: reply too long, aborting read&bslash;n&quot;
)paren
suffix:semicolon
id|via
(braket
id|B
)braket
op_or_assign
id|TACK
suffix:semicolon
id|udelay
c_func
(paren
id|ADB_DELAY
)paren
suffix:semicolon
id|via
(braket
id|B
)braket
op_and_assign
op_complement
(paren
id|TACK
op_or
id|TIP
)paren
suffix:semicolon
id|maciisi_state
op_assign
id|idle
suffix:semicolon
id|maciisi_start
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|reply_ptr
op_increment
op_assign
id|via
(braket
id|SR
)braket
suffix:semicolon
id|status
op_assign
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
suffix:semicolon
multiline_comment|/* ACK on/off */
id|via
(braket
id|B
)braket
op_or_assign
id|TACK
suffix:semicolon
id|udelay
c_func
(paren
id|ADB_DELAY
)paren
suffix:semicolon
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TACK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|TREQ
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* more stuff to deal with */
multiline_comment|/* end of frame */
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TIP
suffix:semicolon
multiline_comment|/* end of packet, deal with it */
r_if
c_cond
(paren
id|reading_reply
)paren
(brace
id|req
op_assign
id|current_req
suffix:semicolon
id|req-&gt;reply_len
op_assign
id|reply_ptr
op_minus
id|req-&gt;reply
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;data
(braket
l_int|0
)braket
op_eq
id|ADB_PACKET
)paren
(brace
multiline_comment|/* Have to adjust the reply from ADB commands */
r_if
c_cond
(paren
id|req-&gt;reply_len
op_le
l_int|2
op_logical_or
(paren
id|req-&gt;reply
(braket
l_int|1
)braket
op_amp
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* the 0x2 bit indicates no response */
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* leave just the command and result bytes in the reply */
id|req-&gt;reply_len
op_sub_assign
l_int|2
suffix:semicolon
id|memmove
c_func
(paren
id|req-&gt;reply
comma
id|req-&gt;reply
op_plus
l_int|2
comma
id|req-&gt;reply_len
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dump_reply
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maciisi_interrupt: reply is &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;reply_len
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %.2x&quot;
comma
id|req-&gt;reply
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;done
)paren
(paren
op_star
id|req-&gt;done
)paren
(paren
id|req
)paren
suffix:semicolon
multiline_comment|/* Obviously, we got it */
id|reading_reply
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|maciisi_input
c_func
(paren
id|maciisi_rbuf
comma
id|reply_ptr
op_minus
id|maciisi_rbuf
comma
id|regs
)paren
suffix:semicolon
)brace
id|maciisi_state
op_assign
id|idle
suffix:semicolon
id|status
op_assign
id|via
(braket
id|B
)braket
op_amp
(paren
id|TIP
op_or
id|TREQ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|TREQ
)paren
)paren
(brace
multiline_comment|/* Timeout?! */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;extra data after packet: status %x ifr %x&bslash;n&quot;
comma
id|status
comma
id|via
(braket
id|IFR
)braket
)paren
suffix:semicolon
id|maciisi_stfu
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Do any queued requests now if possible */
id|maciisi_start
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;maciisi_interrupt: unknown maciisi_state %d?&bslash;n&quot;
comma
id|maciisi_state
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|maciisi_input
id|maciisi_input
c_func
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|nb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|buf
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ADB_PACKET
suffix:colon
id|adb_input
c_func
(paren
id|buf
op_plus
l_int|2
comma
id|nb
op_minus
l_int|2
comma
id|regs
comma
id|buf
(braket
l_int|1
)braket
op_amp
l_int|0x40
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;data from IIsi ADB (%d bytes):&quot;
comma
id|nb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nb
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %.2x&quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
eof
