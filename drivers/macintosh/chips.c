multiline_comment|/*&n; * chips.c: Console support for PowerBook 3400/2400 chips65550 display adaptor.&n; *&n; * Copyright (C) 1997 Fabio Riccardi.&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vc_ioctl.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/adb.h&gt;
macro_line|#include &lt;asm/cuda.h&gt;
macro_line|#include &lt;asm/pmu.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/init.h&gt;
macro_line|#include &quot;pmac-cons.h&quot;
macro_line|#include &quot;chips.h&quot;
DECL|variable|frame_buffer
r_static
r_int
r_char
op_star
id|frame_buffer
suffix:semicolon
DECL|variable|blitter_regs
r_static
r_int
r_char
op_star
id|blitter_regs
suffix:semicolon
DECL|variable|io_space
r_static
r_int
r_char
op_star
id|io_space
suffix:semicolon
DECL|variable|chips_base_phys
r_static
r_int
r_int
id|chips_base_phys
suffix:semicolon
DECL|variable|chips_io_phys
r_static
r_int
r_int
id|chips_io_phys
suffix:semicolon
id|__openfirmware
r_void
DECL|function|map_chips_display
id|map_chips_display
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
r_int
r_char
id|bus
comma
id|devfn
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
id|addr
op_assign
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|chips_base_phys
op_assign
id|addr
suffix:semicolon
id|frame_buffer
op_assign
id|__ioremap
c_func
(paren
id|addr
op_plus
l_int|0x800000
comma
l_int|0x100000
comma
id|_PAGE_WRITETHRU
)paren
suffix:semicolon
id|blitter_regs
op_assign
id|ioremap
c_func
(paren
id|addr
op_plus
l_int|0xC00000
comma
l_int|4096
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Mapped chips65550 frame buffer at %p, blitter at %p&bslash;n&quot;
comma
id|frame_buffer
comma
id|blitter_regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_device_loc
c_func
(paren
id|dp
comma
op_amp
id|bus
comma
op_amp
id|devfn
)paren
op_eq
l_int|0
)paren
(brace
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
l_int|3
suffix:semicolon
singleline_comment|// enable memory and IO space
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
id|io_space
op_assign
(paren
r_int
r_char
op_star
)paren
id|pci_io_base
c_func
(paren
id|bus
)paren
suffix:semicolon
multiline_comment|/* XXX really want the physical address here */
id|chips_io_phys
op_assign
(paren
r_int
r_int
)paren
id|pci_io_base
c_func
(paren
id|bus
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Chips65550 IO space at %p&bslash;n&quot;
comma
id|io_space
)paren
suffix:semicolon
)brace
id|video_mode
op_assign
id|VMODE_800_600_60
suffix:semicolon
id|color_mode
op_assign
id|CMODE_8
suffix:semicolon
)brace
DECL|macro|write_xr
mdefine_line|#define write_xr(num,val)&t;{ out_8(io_space + 0x3D6, num); out_8(io_space + 0x3D7, val); }
DECL|macro|read_xr
mdefine_line|#define read_xr(num,var)&t;{ out_8(io_space + 0x3D6, num); var = in_8(io_space + 0x3D7); }
DECL|macro|write_fr
mdefine_line|#define write_fr(num,val)&t;{ out_8(io_space + 0x3D0, num); out_8(io_space + 0x3D1, val); }
DECL|macro|read_fr
mdefine_line|#define read_fr(num,var)&t;{ out_8(io_space + 0x3D0, num); var = in_8(io_space + 0x3D1); }
DECL|macro|write_cr
mdefine_line|#define write_cr(num,val)&t;{ out_8(io_space + 0x3D4, num); out_8(io_space + 0x3D5, val); }
DECL|macro|read_cr
mdefine_line|#define read_cr(num,var)&t;{ out_8(io_space + 0x3D4, num); var = in_8(io_space + 0x3D5); }
r_void
DECL|function|chips_init
id|chips_init
c_func
(paren
)paren
(brace
r_int
op_star
id|p
suffix:semicolon
r_int
id|i
comma
id|hres
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_ne
id|VMODE_800_600_60
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;chips65550: display mode %d not supported&quot;
comma
id|video_mode
)paren
suffix:semicolon
id|video_mode
op_assign
id|VMODE_800_600_60
suffix:semicolon
)brace
r_if
c_cond
(paren
id|color_mode
op_ne
id|CMODE_8
op_logical_and
id|color_mode
op_ne
id|CMODE_16
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;chips65550: color mode %d not supported&quot;
comma
id|color_mode
)paren
suffix:semicolon
id|color_mode
op_assign
id|CMODE_8
suffix:semicolon
)brace
id|n_scanlines
op_assign
l_int|600
suffix:semicolon
id|hres
op_assign
l_int|800
suffix:semicolon
id|pixel_size
op_assign
l_int|1
op_lshift
id|color_mode
suffix:semicolon
id|line_pitch
op_assign
id|hres
op_star
id|pixel_size
suffix:semicolon
id|row_pitch
op_assign
id|line_pitch
op_star
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|color_mode
op_eq
id|CMODE_16
)paren
(brace
id|write_cr
c_func
(paren
l_int|0x13
comma
l_int|200
)paren
suffix:semicolon
singleline_comment|// 16 bit display width (decimal)
id|write_xr
c_func
(paren
l_int|0x81
comma
l_int|0x14
)paren
suffix:semicolon
singleline_comment|// 15 bit (TrueColor) color mode
id|write_xr
c_func
(paren
l_int|0x82
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// disable palettes
id|write_xr
c_func
(paren
l_int|0x20
comma
l_int|0x10
)paren
suffix:semicolon
singleline_comment|// 16 bit blitter mode
singleline_comment|// write_xr(0x80, 0x00);&t;// 6 bit DAC
singleline_comment|// write_fr(0x11, 0X50);&t;// No dither, 5 bits/color
)brace
r_else
r_if
c_cond
(paren
id|color_mode
op_eq
id|CMODE_8
)paren
(brace
id|write_cr
c_func
(paren
l_int|0x13
comma
l_int|100
)paren
suffix:semicolon
singleline_comment|// 8 bit display width (decimal)
id|write_xr
c_func
(paren
l_int|0x81
comma
l_int|0x12
)paren
suffix:semicolon
singleline_comment|// 8 bit color mode
id|write_xr
c_func
(paren
l_int|0x82
comma
l_int|0x08
)paren
suffix:semicolon
singleline_comment|// Graphics gamma enable
id|write_xr
c_func
(paren
l_int|0x20
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// 8 bit blitter mode
singleline_comment|// write_xr(0x80, 0x82);&t;// 8 bit DAC, CRT overscan
singleline_comment|// write_fr(0x11, 0XE0);&t;// Res Dither on, 6 bits/pixel
)brace
id|pmac_init_palette
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize colormap */
id|fb_start
op_assign
id|frame_buffer
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;hres = %d height = %d pitch = %d&bslash;n&quot;
comma
id|hres
comma
id|n_scanlines
comma
id|line_pitch
)paren
suffix:semicolon
id|display_info.height
op_assign
id|n_scanlines
suffix:semicolon
id|display_info.width
op_assign
id|hres
suffix:semicolon
id|display_info.depth
op_assign
id|pixel_size
op_star
l_int|8
suffix:semicolon
id|display_info.pitch
op_assign
id|line_pitch
suffix:semicolon
id|display_info.mode
op_assign
id|video_mode
suffix:semicolon
id|strncpy
c_func
(paren
id|display_info.name
comma
l_string|&quot;chips65550&quot;
comma
r_sizeof
(paren
id|display_info.name
)paren
)paren
suffix:semicolon
id|display_info.fb_address
op_assign
id|chips_base_phys
op_plus
l_int|0x800000
suffix:semicolon
id|display_info.cmap_adr_address
op_assign
id|chips_io_phys
op_plus
l_int|0x3c8
suffix:semicolon
id|display_info.cmap_data_address
op_assign
id|chips_io_phys
op_plus
l_int|0x3c9
suffix:semicolon
id|display_info.disp_reg_address
op_assign
id|chips_base_phys
op_plus
l_int|0xC00000
suffix:semicolon
multiline_comment|/* Clear screen */
id|p
op_assign
(paren
r_int
op_star
)paren
id|frame_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|n_scanlines
op_star
id|line_pitch
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn on backlight */
id|pmu_enable_backlight
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_int
DECL|function|chips_setmode
id|chips_setmode
c_func
(paren
r_struct
id|vc_mode
op_star
id|mode
comma
r_int
id|doit
)paren
(brace
r_int
id|cmode
suffix:semicolon
r_switch
c_cond
(paren
id|mode-&gt;depth
)paren
(brace
r_case
l_int|16
suffix:colon
id|cmode
op_assign
id|CMODE_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_case
l_int|0
suffix:colon
multiline_comment|/* (default) */
id|cmode
op_assign
id|CMODE_8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode-&gt;mode
op_ne
id|VMODE_800_600_60
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|doit
)paren
(brace
id|video_mode
op_assign
id|mode-&gt;mode
suffix:semicolon
id|color_mode
op_assign
id|cmode
suffix:semicolon
id|chips_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|chips_set_palette
id|chips_set_palette
c_func
(paren
r_int
r_char
id|red
(braket
)braket
comma
r_int
r_char
id|green
(braket
)braket
comma
r_int
r_char
id|blue
(braket
)braket
comma
r_int
id|index
comma
r_int
id|ncolors
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncolors
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|io_space
(braket
l_int|0x3C8
)braket
comma
id|index
op_plus
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|io_space
(braket
l_int|0x3C9
)braket
comma
id|red
(braket
id|i
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|io_space
(braket
l_int|0x3C9
)braket
comma
id|green
(braket
id|i
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|io_space
(braket
l_int|0x3C9
)braket
comma
id|blue
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|chips_set_blanking
id|chips_set_blanking
c_func
(paren
r_int
id|blank_mode
)paren
(brace
id|pmu_enable_backlight
c_func
(paren
id|blank_mode
op_eq
id|VESA_NO_BLANKING
)paren
suffix:semicolon
)brace
eof
