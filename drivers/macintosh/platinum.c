multiline_comment|/*&n; * platinum.c: Console support for PowerMac &quot;platinum&quot; display adaptor.&n; *&n; * Copyright (C) 1996 Paul Mackerras and Mark Abene.&n; *&t;&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vc_ioctl.h&gt;
macro_line|#include &lt;linux/nvram.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &quot;pmac-cons.h&quot;
macro_line|#include &quot;platinum.h&quot;
multiline_comment|/*&n; * Structure of the registers for the DACula colormap device.&n; */
DECL|struct|cmap_regs
r_struct
id|cmap_regs
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|pad1
r_char
id|pad1
(braket
l_int|15
)braket
suffix:semicolon
DECL|member|d1
r_int
r_char
id|d1
suffix:semicolon
DECL|member|pad2
r_char
id|pad2
(braket
l_int|15
)braket
suffix:semicolon
DECL|member|d2
r_int
r_char
id|d2
suffix:semicolon
DECL|member|pad3
r_char
id|pad3
(braket
l_int|15
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
DECL|member|pad4
r_char
id|pad4
(braket
l_int|15
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Structure of the registers for the &quot;platinum&quot; display adaptor&quot;.&n; */
DECL|macro|PAD
mdefine_line|#define PAD(x)&t;char x[12]
DECL|struct|preg
r_struct
id|preg
(brace
multiline_comment|/* padded register */
DECL|member|r
r_int
id|r
suffix:semicolon
DECL|member|pad
r_char
id|pad
(braket
l_int|12
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|platinum_regs
r_struct
id|platinum_regs
(brace
DECL|member|reg
r_struct
id|preg
id|reg
(braket
l_int|128
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|set_platinum_clock
c_func
(paren
r_int
r_char
op_star
id|clksel
)paren
suffix:semicolon
r_static
r_int
id|read_platinum_sense
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|platinum_vram_reqd
c_func
(paren
r_int
id|vmode
comma
r_int
id|cmode
)paren
suffix:semicolon
DECL|variable|total_vram
r_static
r_int
id|total_vram
suffix:semicolon
multiline_comment|/* total amount of video memory, bytes */
DECL|variable|frame_buffer
r_static
r_int
r_char
op_star
id|frame_buffer
suffix:semicolon
DECL|variable|base_frame_buffer
r_static
r_int
r_char
op_star
id|base_frame_buffer
suffix:semicolon
DECL|variable|cmap_regs
r_static
r_struct
id|cmap_regs
op_star
id|cmap_regs
suffix:semicolon
DECL|variable|plat_regs
r_static
r_volatile
r_struct
id|platinum_regs
op_star
id|plat_regs
suffix:semicolon
multiline_comment|/*&n; * Register initialization tables for the platinum display.&n; *&n; * It seems that there are two different types of platinum display&n; * out there.  Older ones use the values in clocksel[1], for which&n; * the formula for the clock frequency seems to be&n; *&t;F = 14.3MHz * c0 / (c1 &amp; 0x1f) / (1 &lt;&lt; (c1 &gt;&gt; 5))&n; * Newer ones use the values in clocksel[0], for which the formula&n; * seems to be&n; *&t;F = 15MHz * c0 / ((c1 &amp; 0x1f) + 2) / (1 &lt;&lt; (c1 &gt;&gt; 5))&n; */
DECL|struct|plat_regvals
r_struct
id|plat_regvals
(brace
DECL|member|fb_offset
r_int
id|fb_offset
suffix:semicolon
DECL|member|pitch
r_int
id|pitch
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|regs
r_int
id|regs
(braket
l_int|26
)braket
suffix:semicolon
DECL|member|plat_offset
r_int
r_char
id|plat_offset
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|mode
r_int
r_char
id|mode
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|dacula_ctrl
r_int
r_char
id|dacula_ctrl
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|clocksel
r_int
r_char
id|clocksel
(braket
l_int|2
)braket
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DIV2
mdefine_line|#define DIV2&t;0x20
DECL|macro|DIV4
mdefine_line|#define DIV4&t;0x40
DECL|macro|DIV8
mdefine_line|#define DIV8&t;0x60
DECL|macro|DIV16
mdefine_line|#define DIV16&t;0x80
multiline_comment|/* 1280x1024, 75Hz (20) */
DECL|variable|platinum_reg_init_20
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_20
op_assign
(brace
l_int|0x5c00
comma
(brace
l_int|1312
comma
l_int|2592
comma
l_int|2592
)brace
comma
(brace
l_int|0xffc
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x428
comma
l_int|0
comma
l_int|0
comma
l_int|0xb3
comma
l_int|0xd3
comma
l_int|0x12
comma
l_int|0x1a5
comma
l_int|0x23
comma
l_int|0x28
comma
l_int|0x2d
comma
l_int|0x5e
comma
l_int|0x19e
comma
l_int|0x1a4
comma
l_int|0x854
comma
l_int|0x852
comma
l_int|4
comma
l_int|9
comma
l_int|0x50
comma
l_int|0x850
comma
l_int|0x851
)brace
comma
(brace
l_int|0x58
comma
l_int|0x5d
comma
l_int|0x5d
)brace
comma
(brace
l_int|0
comma
l_int|0xff
comma
l_int|0xff
)brace
comma
(brace
l_int|0x51
comma
l_int|0x55
comma
l_int|0x55
)brace
comma
(brace
(brace
l_int|45
comma
l_int|3
)brace
comma
(brace
l_int|66
comma
l_int|7
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 1280x960, 75Hz (19) */
DECL|variable|platinum_reg_init_19
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_19
op_assign
(brace
l_int|0x5c00
comma
(brace
l_int|1312
comma
l_int|2592
comma
l_int|2592
)brace
comma
(brace
l_int|0xffc
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x428
comma
l_int|0
comma
l_int|0
comma
l_int|0xb2
comma
l_int|0xd2
comma
l_int|0x12
comma
l_int|0x1a3
comma
l_int|0x23
comma
l_int|0x28
comma
l_int|0x2d
comma
l_int|0x5c
comma
l_int|0x19c
comma
l_int|0x1a2
comma
l_int|0x7d0
comma
l_int|0x7ce
comma
l_int|4
comma
l_int|9
comma
l_int|0x4c
comma
l_int|0x7cc
comma
l_int|0x7cd
)brace
comma
(brace
l_int|0x56
comma
l_int|0x5b
comma
l_int|0x5b
)brace
comma
(brace
l_int|0
comma
l_int|0xff
comma
l_int|0xff
)brace
comma
(brace
l_int|0x51
comma
l_int|0x55
comma
l_int|0x55
)brace
comma
(brace
(brace
l_int|42
comma
l_int|3
)brace
comma
(brace
l_int|44
comma
l_int|5
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 1152x870, 75Hz (18) */
DECL|variable|platinum_reg_init_18
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_18
op_assign
(brace
l_int|0x11b0
comma
(brace
l_int|1184
comma
l_int|2336
comma
l_int|4640
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x38f
comma
l_int|0
comma
l_int|0
comma
l_int|0x294
comma
l_int|0x16c
comma
l_int|0x20
comma
l_int|0x2d7
comma
l_int|0x3f
comma
l_int|0x49
comma
l_int|0x53
comma
l_int|0x82
comma
l_int|0x2c2
comma
l_int|0x2d6
comma
l_int|0x726
comma
l_int|0x724
comma
l_int|4
comma
l_int|9
comma
l_int|0x52
comma
l_int|0x71e
comma
l_int|0x722
)brace
comma
(brace
l_int|0x74
comma
l_int|0x7c
comma
l_int|0x81
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|26
comma
l_int|0
op_plus
id|DIV2
)brace
comma
(brace
l_int|42
comma
l_int|6
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 1024x768, 75Hz (17) */
DECL|variable|platinum_reg_init_17
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_17
op_assign
(brace
l_int|0x10b0
comma
(brace
l_int|1056
comma
l_int|2080
comma
l_int|4128
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x254
comma
l_int|0x14b
comma
l_int|0x18
comma
l_int|0x295
comma
l_int|0x2f
comma
l_int|0x32
comma
l_int|0x3b
comma
l_int|0x80
comma
l_int|0x280
comma
l_int|0x296
comma
l_int|0x648
comma
l_int|0x646
comma
l_int|4
comma
l_int|9
comma
l_int|0x40
comma
l_int|0x640
comma
l_int|0x644
)brace
comma
(brace
l_int|0x72
comma
l_int|0x7a
comma
l_int|0x7f
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|54
comma
l_int|3
op_plus
id|DIV2
)brace
comma
(brace
l_int|67
comma
l_int|12
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 1024x768, 75Hz (16) */
DECL|variable|platinum_reg_init_16
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_16
op_assign
(brace
l_int|0x10b0
comma
(brace
l_int|1056
comma
l_int|2080
comma
l_int|4128
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x250
comma
l_int|0x147
comma
l_int|0x17
comma
l_int|0x28f
comma
l_int|0x2f
comma
l_int|0x35
comma
l_int|0x47
comma
l_int|0x82
comma
l_int|0x282
comma
l_int|0x28e
comma
l_int|0x640
comma
l_int|0x63e
comma
l_int|4
comma
l_int|9
comma
l_int|0x3c
comma
l_int|0x63c
comma
l_int|0x63d
)brace
comma
(brace
l_int|0x74
comma
l_int|0x7c
comma
l_int|0x81
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|20
comma
l_int|0
op_plus
id|DIV2
)brace
comma
(brace
l_int|11
comma
l_int|2
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 1024x768, 70Hz (15) */
DECL|variable|platinum_reg_init_15
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_15
op_assign
(brace
l_int|0x10b0
comma
(brace
l_int|1056
comma
l_int|2080
comma
l_int|4128
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x254
comma
l_int|0x14b
comma
l_int|0x22
comma
l_int|0x297
comma
l_int|0x43
comma
l_int|0x49
comma
l_int|0x5b
comma
l_int|0x86
comma
l_int|0x286
comma
l_int|0x296
comma
l_int|0x64c
comma
l_int|0x64a
comma
l_int|0xa
comma
l_int|0xf
comma
l_int|0x44
comma
l_int|0x644
comma
l_int|0x646
)brace
comma
(brace
l_int|0x78
comma
l_int|0x80
comma
l_int|0x85
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|19
comma
l_int|0
op_plus
id|DIV2
)brace
comma
(brace
l_int|110
comma
l_int|21
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 1024x768, 60Hz (14) */
DECL|variable|platinum_reg_init_14
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_14
op_assign
(brace
l_int|0x10b0
comma
(brace
l_int|1056
comma
l_int|2080
comma
l_int|4128
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x25a
comma
l_int|0x14f
comma
l_int|0x22
comma
l_int|0x29f
comma
l_int|0x43
comma
l_int|0x49
comma
l_int|0x5b
comma
l_int|0x8e
comma
l_int|0x28e
comma
l_int|0x29e
comma
l_int|0x64c
comma
l_int|0x64a
comma
l_int|0xa
comma
l_int|0xf
comma
l_int|0x44
comma
l_int|0x644
comma
l_int|0x646
)brace
comma
(brace
l_int|0x80
comma
l_int|0x88
comma
l_int|0x8d
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|71
comma
l_int|6
op_plus
id|DIV2
)brace
comma
(brace
l_int|118
comma
l_int|13
op_plus
id|DIV2
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 832x624, 75Hz (13) */
DECL|variable|platinum_reg_init_13
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_13
op_assign
(brace
l_int|0x70
comma
(brace
l_int|864
comma
l_int|1680
comma
l_int|3360
)brace
comma
multiline_comment|/* MacOS does 1680 instead of 1696 to fit 16bpp in 1MB */
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x299
comma
l_int|0
comma
l_int|0
comma
l_int|0x21e
comma
l_int|0x120
comma
l_int|0x10
comma
l_int|0x23f
comma
l_int|0x1f
comma
l_int|0x25
comma
l_int|0x37
comma
l_int|0x8a
comma
l_int|0x22a
comma
l_int|0x23e
comma
l_int|0x536
comma
l_int|0x534
comma
l_int|4
comma
l_int|9
comma
l_int|0x52
comma
l_int|0x532
comma
l_int|0x533
)brace
comma
(brace
l_int|0x7c
comma
l_int|0x84
comma
l_int|0x89
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|30
comma
l_int|0
op_plus
id|DIV4
)brace
comma
(brace
l_int|56
comma
l_int|7
op_plus
id|DIV2
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 800x600, 75Hz (12) */
DECL|variable|platinum_reg_init_12
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_12
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|832
comma
l_int|1632
comma
l_int|3232
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x1ce
comma
l_int|0x108
comma
l_int|0x14
comma
l_int|0x20f
comma
l_int|0x27
comma
l_int|0x30
comma
l_int|0x39
comma
l_int|0x72
comma
l_int|0x202
comma
l_int|0x20e
comma
l_int|0x4e2
comma
l_int|0x4e0
comma
l_int|4
comma
l_int|9
comma
l_int|0x2e
comma
l_int|0x4de
comma
l_int|0x4df
)brace
comma
(brace
l_int|0x64
comma
l_int|0x6c
comma
l_int|0x71
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|122
comma
l_int|7
op_plus
id|DIV4
)brace
comma
(brace
l_int|62
comma
l_int|9
op_plus
id|DIV2
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 800x600, 72Hz (11) */
DECL|variable|platinum_reg_init_11
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_11
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|832
comma
l_int|1632
comma
l_int|3232
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x1ca
comma
l_int|0x104
comma
l_int|0x1e
comma
l_int|0x207
comma
l_int|0x3b
comma
l_int|0x44
comma
l_int|0x4d
comma
l_int|0x56
comma
l_int|0x1e6
comma
l_int|0x206
comma
l_int|0x534
comma
l_int|0x532
comma
l_int|0xa
comma
l_int|0xe
comma
l_int|0x38
comma
l_int|0x4e8
comma
l_int|0x4ec
)brace
comma
(brace
l_int|0x48
comma
l_int|0x50
comma
l_int|0x55
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|26
comma
l_int|0
op_plus
id|DIV4
)brace
comma
(brace
l_int|42
comma
l_int|6
op_plus
id|DIV2
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 800x600, 60Hz (10) */
DECL|variable|platinum_reg_init_10
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_10
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|832
comma
l_int|1632
comma
l_int|3232
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x1ce
comma
l_int|0x108
comma
l_int|0x20
comma
l_int|0x20f
comma
l_int|0x3f
comma
l_int|0x45
comma
l_int|0x5d
comma
l_int|0x66
comma
l_int|0x1f6
comma
l_int|0x20e
comma
l_int|0x4e8
comma
l_int|0x4e6
comma
l_int|6
comma
l_int|0xa
comma
l_int|0x34
comma
l_int|0x4e4
comma
l_int|0x4e5
)brace
comma
(brace
l_int|0x58
comma
l_int|0x60
comma
l_int|0x65
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|54
comma
l_int|3
op_plus
id|DIV4
)brace
comma
(brace
l_int|95
comma
l_int|1
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 800x600, 56Hz (9) --unsupported? copy of mode 10 for now... */
DECL|variable|platinum_reg_init_9
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_9
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|832
comma
l_int|1632
comma
l_int|3232
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x1ce
comma
l_int|0x108
comma
l_int|0x20
comma
l_int|0x20f
comma
l_int|0x3f
comma
l_int|0x45
comma
l_int|0x5d
comma
l_int|0x66
comma
l_int|0x1f6
comma
l_int|0x20e
comma
l_int|0x4e8
comma
l_int|0x4e6
comma
l_int|6
comma
l_int|0xa
comma
l_int|0x34
comma
l_int|0x4e4
comma
l_int|0x4e5
)brace
comma
(brace
l_int|0x58
comma
l_int|0x60
comma
l_int|0x65
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|54
comma
l_int|3
op_plus
id|DIV4
)brace
comma
(brace
l_int|88
comma
l_int|1
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 768x576, 50Hz Interlaced-PAL (8) */
DECL|variable|platinum_reg_init_8
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_8
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|800
comma
l_int|1568
comma
l_int|3104
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0xc8
comma
l_int|0xec
comma
l_int|0x11
comma
l_int|0x1d7
comma
l_int|0x22
comma
l_int|0x25
comma
l_int|0x36
comma
l_int|0x47
comma
l_int|0x1c7
comma
l_int|0x1d6
comma
l_int|0x271
comma
l_int|0x270
comma
l_int|4
comma
l_int|9
comma
l_int|0x27
comma
l_int|0x267
comma
l_int|0x26b
)brace
comma
(brace
l_int|0x39
comma
l_int|0x41
comma
l_int|0x46
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|31
comma
l_int|0
op_plus
id|DIV16
)brace
comma
(brace
l_int|74
comma
l_int|9
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 640x870, 75Hz Portrait (7) */
DECL|variable|platinum_reg_init_7
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_7
op_assign
(brace
l_int|0xb10
comma
(brace
l_int|672
comma
l_int|1312
comma
l_int|2592
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x176
comma
l_int|0xd0
comma
l_int|0x14
comma
l_int|0x19f
comma
l_int|0x27
comma
l_int|0x2d
comma
l_int|0x3f
comma
l_int|0x4a
comma
l_int|0x18a
comma
l_int|0x19e
comma
l_int|0x72c
comma
l_int|0x72a
comma
l_int|4
comma
l_int|9
comma
l_int|0x58
comma
l_int|0x724
comma
l_int|0x72a
)brace
comma
(brace
l_int|0x3c
comma
l_int|0x44
comma
l_int|0x49
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|30
comma
l_int|0
op_plus
id|DIV4
)brace
comma
(brace
l_int|56
comma
l_int|7
op_plus
id|DIV2
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 640x480, 67Hz (6) */
DECL|variable|platinum_reg_init_6
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_6
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|672
comma
l_int|1312
comma
l_int|2592
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x209
comma
l_int|0
comma
l_int|0
comma
l_int|0x18e
comma
l_int|0xd8
comma
l_int|0x10
comma
l_int|0x1af
comma
l_int|0x1f
comma
l_int|0x25
comma
l_int|0x37
comma
l_int|0x4a
comma
l_int|0x18a
comma
l_int|0x1ae
comma
l_int|0x41a
comma
l_int|0x418
comma
l_int|4
comma
l_int|9
comma
l_int|0x52
comma
l_int|0x412
comma
l_int|0x416
)brace
comma
(brace
l_int|0x3c
comma
l_int|0x44
comma
l_int|0x49
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|99
comma
l_int|4
op_plus
id|DIV8
)brace
comma
(brace
l_int|42
comma
l_int|5
op_plus
id|DIV4
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 640x480, 60Hz (5) */
DECL|variable|platinum_reg_init_5
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_5
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|672
comma
l_int|1312
comma
l_int|2592
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x15e
comma
l_int|0xc8
comma
l_int|0x18
comma
l_int|0x18f
comma
l_int|0x2f
comma
l_int|0x35
comma
l_int|0x3e
comma
l_int|0x42
comma
l_int|0x182
comma
l_int|0x18e
comma
l_int|0x41a
comma
l_int|0x418
comma
l_int|2
comma
l_int|7
comma
l_int|0x44
comma
l_int|0x404
comma
l_int|0x408
)brace
comma
(brace
l_int|0x34
comma
l_int|0x3c
comma
l_int|0x41
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|26
comma
l_int|0
op_plus
id|DIV8
)brace
comma
(brace
l_int|14
comma
l_int|2
op_plus
id|DIV4
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 640x480, 60Hz Interlaced-NTSC (4) */
DECL|variable|platinum_reg_init_4
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_4
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|672
comma
l_int|1312
comma
l_int|2592
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0xa5
comma
l_int|0xc3
comma
l_int|0xe
comma
l_int|0x185
comma
l_int|0x1c
comma
l_int|0x1f
comma
l_int|0x30
comma
l_int|0x37
comma
l_int|0x177
comma
l_int|0x184
comma
l_int|0x20d
comma
l_int|0x20c
comma
l_int|5
comma
l_int|0xb
comma
l_int|0x23
comma
l_int|0x203
comma
l_int|0x206
)brace
comma
(brace
l_int|0x29
comma
l_int|0x31
comma
l_int|0x36
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|94
comma
l_int|5
op_plus
id|DIV16
)brace
comma
(brace
l_int|48
comma
l_int|7
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 640x480, 50Hz Interlaced-PAL (3) */
DECL|variable|platinum_reg_init_3
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_3
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|672
comma
l_int|1312
comma
l_int|2592
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0xc8
comma
l_int|0xec
comma
l_int|0x11
comma
l_int|0x1d7
comma
l_int|0x22
comma
l_int|0x25
comma
l_int|0x36
comma
l_int|0x67
comma
l_int|0x1a7
comma
l_int|0x1d6
comma
l_int|0x271
comma
l_int|0x270
comma
l_int|4
comma
l_int|9
comma
l_int|0x57
comma
l_int|0x237
comma
l_int|0x26b
)brace
comma
(brace
l_int|0x59
comma
l_int|0x61
comma
l_int|0x66
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|31
comma
l_int|0
op_plus
id|DIV16
)brace
comma
(brace
l_int|74
comma
l_int|9
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 512x384, 60Hz (2) */
DECL|variable|platinum_reg_init_2
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_2
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|544
comma
l_int|1056
comma
l_int|2080
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0x25c
comma
l_int|0x140
comma
l_int|0x10
comma
l_int|0x27f
comma
l_int|0x1f
comma
l_int|0x2b
comma
l_int|0x4f
comma
l_int|0x68
comma
l_int|0x268
comma
l_int|0x27e
comma
l_int|0x32e
comma
l_int|0x32c
comma
l_int|4
comma
l_int|9
comma
l_int|0x2a
comma
l_int|0x32a
comma
l_int|0x32b
)brace
comma
(brace
l_int|0x5a
comma
l_int|0x62
comma
l_int|0x67
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|33
comma
l_int|2
op_plus
id|DIV8
)brace
comma
(brace
l_int|79
comma
l_int|9
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/* 512x384, 60Hz Interlaced-NTSC (1) */
DECL|variable|platinum_reg_init_1
r_static
r_struct
id|plat_regvals
id|platinum_reg_init_1
op_assign
(brace
l_int|0x1010
comma
(brace
l_int|544
comma
l_int|1056
comma
l_int|2080
)brace
comma
(brace
l_int|0xff0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x320
comma
l_int|0
comma
l_int|0
comma
l_int|0xa5
comma
l_int|0xc3
comma
l_int|0xe
comma
l_int|0x185
comma
l_int|0x1c
comma
l_int|0x1f
comma
l_int|0x30
comma
l_int|0x57
comma
l_int|0x157
comma
l_int|0x184
comma
l_int|0x20d
comma
l_int|0x20c
comma
l_int|5
comma
l_int|0xb
comma
l_int|0x53
comma
l_int|0x1d3
comma
l_int|0x206
)brace
comma
(brace
l_int|0x49
comma
l_int|0x51
comma
l_int|0x56
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0xff
)brace
comma
(brace
l_int|0x11
comma
l_int|0x15
comma
l_int|0x19
)brace
comma
(brace
(brace
l_int|94
comma
l_int|5
op_plus
id|DIV16
)brace
comma
(brace
l_int|48
comma
l_int|7
op_plus
id|DIV8
)brace
)brace
)brace
suffix:semicolon
DECL|variable|platinum_reg_init
r_static
r_struct
id|plat_regvals
op_star
id|platinum_reg_init
(braket
id|VMODE_MAX
)braket
op_assign
(brace
op_amp
id|platinum_reg_init_1
comma
op_amp
id|platinum_reg_init_2
comma
op_amp
id|platinum_reg_init_3
comma
op_amp
id|platinum_reg_init_4
comma
op_amp
id|platinum_reg_init_5
comma
op_amp
id|platinum_reg_init_6
comma
op_amp
id|platinum_reg_init_7
comma
op_amp
id|platinum_reg_init_8
comma
op_amp
id|platinum_reg_init_9
comma
op_amp
id|platinum_reg_init_10
comma
op_amp
id|platinum_reg_init_11
comma
op_amp
id|platinum_reg_init_12
comma
op_amp
id|platinum_reg_init_13
comma
op_amp
id|platinum_reg_init_14
comma
op_amp
id|platinum_reg_init_15
comma
op_amp
id|platinum_reg_init_16
comma
op_amp
id|platinum_reg_init_17
comma
op_amp
id|platinum_reg_init_18
comma
op_amp
id|platinum_reg_init_19
comma
op_amp
id|platinum_reg_init_20
)brace
suffix:semicolon
multiline_comment|/*&n; * Get the monitor sense value.&n; */
r_static
r_int
DECL|function|read_platinum_sense
id|read_platinum_sense
c_func
(paren
)paren
(brace
r_int
id|sense
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* turn off drivers */
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_assign
(paren
op_complement
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_amp
l_int|7
)paren
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* drive each sense line low in turn and collect the other 2 */
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* drive A low */
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
op_complement
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_amp
l_int|3
)paren
op_lshift
l_int|4
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* drive B low */
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
op_complement
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_amp
l_int|4
)paren
op_lshift
l_int|1
suffix:semicolon
id|sense
op_or_assign
(paren
op_complement
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_amp
l_int|1
)paren
op_lshift
l_int|2
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* drive C low */
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
op_complement
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_amp
l_int|6
)paren
op_rshift
l_int|1
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* turn off drivers */
r_return
id|sense
suffix:semicolon
)brace
DECL|function|platinum_vram_reqd
r_static
r_inline
r_int
id|platinum_vram_reqd
c_func
(paren
r_int
id|vmode
comma
r_int
id|cmode
)paren
(brace
r_return
id|vmode_attrs
(braket
id|vmode
op_minus
l_int|1
)braket
dot
id|vres
op_star
id|platinum_reg_init
(braket
id|vmode
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|pitch
(braket
id|cmode
)braket
suffix:semicolon
)brace
r_void
DECL|function|map_platinum
id|map_platinum
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
r_int
id|i
comma
id|sense
suffix:semicolon
r_int
r_int
id|addr
comma
id|size
suffix:semicolon
r_int
id|bank0
comma
id|bank1
comma
id|bank2
comma
id|bank3
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;next
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Warning: only using first platinum display device&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;n_addrs
op_ne
l_int|2
)paren
id|panic
c_func
(paren
l_string|&quot;expecting 2 addresses for platinum (got %d)&quot;
comma
id|dp-&gt;n_addrs
)paren
suffix:semicolon
multiline_comment|/* Map in frame buffer and registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dp-&gt;n_addrs
suffix:semicolon
op_increment
id|i
)paren
(brace
id|addr
op_assign
id|dp-&gt;addrs
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|size
op_assign
id|dp-&gt;addrs
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
l_int|0x400000
)paren
(brace
multiline_comment|/* frame buffer - map only 4MB */
id|frame_buffer
op_assign
id|ioremap
c_func
(paren
id|addr
comma
l_int|0x400000
)paren
suffix:semicolon
id|base_frame_buffer
op_assign
id|frame_buffer
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* registers */
id|plat_regs
op_assign
id|ioremap
c_func
(paren
id|addr
comma
id|size
)paren
suffix:semicolon
)brace
)brace
id|cmap_regs
op_assign
id|ioremap
c_func
(paren
l_int|0xf301b000
comma
l_int|0x1000
)paren
suffix:semicolon
multiline_comment|/* XXX not in prom? */
multiline_comment|/* Grok total video ram */
id|plat_regs-&gt;reg
(braket
l_int|16
)braket
dot
id|r
op_assign
(paren
r_int
)paren
id|frame_buffer
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|20
)braket
dot
id|r
op_assign
l_int|0x1011
suffix:semicolon
multiline_comment|/* select max vram */
id|plat_regs-&gt;reg
(braket
l_int|24
)braket
dot
id|r
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* switch in vram */
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|frame_buffer
(braket
l_int|0x100000
)braket
op_assign
l_int|0x34
suffix:semicolon
id|frame_buffer
(braket
l_int|0x200000
)braket
op_assign
l_int|0x56
suffix:semicolon
id|frame_buffer
(braket
l_int|0x300000
)braket
op_assign
l_int|0x78
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|bank0
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* builtin 1MB vram, always there */
id|bank1
op_assign
id|frame_buffer
(braket
l_int|0x100000
)braket
op_eq
l_int|0x34
suffix:semicolon
id|bank2
op_assign
id|frame_buffer
(braket
l_int|0x200000
)braket
op_eq
l_int|0x56
suffix:semicolon
id|bank3
op_assign
id|frame_buffer
(braket
l_int|0x300000
)braket
op_eq
l_int|0x78
suffix:semicolon
id|total_vram
op_assign
(paren
id|bank0
op_plus
id|bank1
op_plus
id|bank2
op_plus
id|bank3
)paren
op_star
l_int|0x100000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Total VRAM = %dMB&bslash;n&quot;
comma
id|total_vram
op_div
l_int|1024
op_div
l_int|1024
)paren
suffix:semicolon
id|sense
op_assign
id|read_platinum_sense
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_eq
id|VMODE_NVRAM
)paren
(brace
id|video_mode
op_assign
id|nvram_read_byte
c_func
(paren
id|NV_VMODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_le
l_int|0
op_logical_or
id|video_mode
OG
id|VMODE_MAX
op_logical_or
id|platinum_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
id|video_mode
op_assign
id|VMODE_CHOOSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_mode
op_eq
id|VMODE_CHOOSE
)paren
id|video_mode
op_assign
id|map_monitor_sense
c_func
(paren
id|sense
)paren
suffix:semicolon
r_if
c_cond
(paren
id|platinum_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
id|video_mode
op_assign
id|VMODE_640_480_60
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Monitor sense value = 0x%x, &quot;
comma
id|sense
)paren
suffix:semicolon
r_if
c_cond
(paren
id|color_mode
op_eq
id|CMODE_NVRAM
)paren
id|color_mode
op_assign
id|nvram_read_byte
c_func
(paren
id|NV_CMODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|color_mode
template_param
id|CMODE_32
)paren
id|color_mode
op_assign
id|CMODE_8
suffix:semicolon
multiline_comment|/*&n;&t; * Reduce the pixel size if we don&squot;t have enough VRAM.&n;&t; */
r_while
c_loop
(paren
id|color_mode
OG
id|CMODE_8
op_logical_and
id|platinum_vram_reqd
c_func
(paren
id|video_mode
comma
id|color_mode
)paren
OG
id|total_vram
)paren
op_decrement
id|color_mode
suffix:semicolon
multiline_comment|/*&n;&t; * Reduce the video mode if we don&squot;t have enough VRAM.&n;&t; */
r_while
c_loop
(paren
id|platinum_vram_reqd
c_func
(paren
id|video_mode
comma
id|color_mode
)paren
OG
id|total_vram
)paren
op_decrement
id|video_mode
suffix:semicolon
)brace
DECL|macro|STORE_D2
mdefine_line|#define STORE_D2(a, v) { &bslash;&n;&t;out_8(&amp;cmap_regs-&gt;addr, (a+32)); &bslash;&n;&t;out_8(&amp;cmap_regs-&gt;d2, (v)); &bslash;&n;}
r_static
r_void
DECL|function|set_platinum_clock
id|set_platinum_clock
c_func
(paren
r_int
r_char
op_star
id|clksel
)paren
(brace
id|STORE_D2
c_func
(paren
l_int|6
comma
l_int|0xc6
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|cmap_regs-&gt;addr
comma
l_int|3
op_plus
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmap_regs-&gt;d2
op_eq
l_int|2
)paren
(brace
id|STORE_D2
c_func
(paren
l_int|7
comma
id|clksel
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|8
comma
id|clksel
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|3
comma
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
id|STORE_D2
c_func
(paren
l_int|4
comma
id|clksel
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|5
comma
id|clksel
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|3
comma
l_int|2
)paren
suffix:semicolon
)brace
id|__delay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|9
comma
l_int|0xa6
)paren
suffix:semicolon
)brace
r_void
DECL|function|platinum_init
id|platinum_init
c_func
(paren
)paren
(brace
r_int
id|i
comma
id|yoff
comma
id|width
comma
id|clkmode
comma
id|dtype
suffix:semicolon
r_struct
id|plat_regvals
op_star
id|init
suffix:semicolon
r_int
op_star
id|p
suffix:semicolon
r_int
id|one_mb
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|total_vram
op_eq
l_int|0x100000
)paren
id|one_mb
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_le
l_int|0
op_logical_or
id|video_mode
OG
id|VMODE_MAX
op_logical_or
(paren
id|init
op_assign
id|platinum_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
)paren
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;platinum: video mode %d not supported&quot;
comma
id|video_mode
)paren
suffix:semicolon
id|frame_buffer
op_assign
id|base_frame_buffer
op_plus
id|init-&gt;fb_offset
suffix:semicolon
multiline_comment|/* printk(&quot;Frame buffer start address is %p&bslash;n&quot;, frame_buffer); */
id|pixel_size
op_assign
l_int|1
op_lshift
id|color_mode
suffix:semicolon
id|line_pitch
op_assign
id|init-&gt;pitch
(braket
id|color_mode
)braket
suffix:semicolon
id|width
op_assign
id|vmode_attrs
(braket
id|video_mode
op_minus
l_int|1
)braket
dot
id|hres
suffix:semicolon
id|n_scanlines
op_assign
id|vmode_attrs
(braket
id|video_mode
op_minus
l_int|1
)braket
dot
id|vres
suffix:semicolon
id|row_pitch
op_assign
id|line_pitch
op_star
l_int|16
suffix:semicolon
multiline_comment|/* Initialize display timing registers */
id|out_be32
c_func
(paren
op_amp
id|plat_regs-&gt;reg
(braket
l_int|24
)braket
dot
id|r
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* turn display off */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|26
suffix:semicolon
op_increment
id|i
)paren
id|plat_regs-&gt;reg
(braket
id|i
op_plus
l_int|32
)braket
dot
id|r
op_assign
id|init-&gt;regs
(braket
id|i
)braket
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|26
op_plus
l_int|32
)braket
dot
id|r
op_assign
(paren
id|one_mb
ques
c_cond
id|init-&gt;plat_offset
(braket
id|color_mode
)braket
op_plus
l_int|4
op_minus
id|color_mode
suffix:colon
id|init-&gt;plat_offset
(braket
id|color_mode
)braket
)paren
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|16
)braket
dot
id|r
op_assign
(paren
r_int
)paren
id|frame_buffer
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|18
)braket
dot
id|r
op_assign
id|line_pitch
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|19
)braket
dot
id|r
op_assign
(paren
id|one_mb
ques
c_cond
id|init-&gt;mode
(braket
id|color_mode
op_plus
l_int|1
)braket
suffix:colon
id|init-&gt;mode
(braket
id|color_mode
)braket
)paren
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|20
)braket
dot
id|r
op_assign
(paren
id|one_mb
ques
c_cond
l_int|0x11
suffix:colon
l_int|0x1011
)paren
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|21
)braket
dot
id|r
op_assign
l_int|0x100
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|22
)braket
dot
id|r
op_assign
l_int|1
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|23
)braket
dot
id|r
op_assign
l_int|1
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|26
)braket
dot
id|r
op_assign
l_int|0xc00
suffix:semicolon
id|plat_regs-&gt;reg
(braket
l_int|27
)braket
dot
id|r
op_assign
l_int|0x235
suffix:semicolon
multiline_comment|/* plat_regs-&gt;reg[27].r = 0x2aa; */
id|STORE_D2
c_func
(paren
l_int|0
comma
(paren
id|one_mb
ques
c_cond
id|init-&gt;dacula_ctrl
(braket
id|color_mode
)braket
op_amp
l_int|0xf
suffix:colon
id|init-&gt;dacula_ctrl
(braket
id|color_mode
)braket
)paren
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|1
comma
l_int|4
)paren
suffix:semicolon
id|STORE_D2
c_func
(paren
l_int|2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Try to determine whether we have an old or a new DACula.&n;&t; */
id|out_8
c_func
(paren
op_amp
id|cmap_regs-&gt;addr
comma
l_int|0x40
)paren
suffix:semicolon
id|dtype
op_assign
id|cmap_regs-&gt;d2
suffix:semicolon
r_switch
c_cond
(paren
id|dtype
)paren
(brace
r_case
l_int|0x3c
suffix:colon
id|clkmode
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x84
suffix:colon
id|clkmode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|clkmode
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Unknown DACula type: %x&bslash;n&quot;
comma
id|cmap_regs-&gt;d2
)paren
suffix:semicolon
)brace
id|set_platinum_clock
c_func
(paren
id|init-&gt;clocksel
(braket
id|clkmode
)braket
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|plat_regs-&gt;reg
(braket
l_int|24
)braket
dot
id|r
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* turn display on */
id|pmac_init_palette
c_func
(paren
)paren
suffix:semicolon
id|yoff
op_assign
(paren
id|n_scanlines
op_mod
l_int|16
)paren
op_div
l_int|2
suffix:semicolon
id|fb_start
op_assign
id|frame_buffer
op_plus
id|yoff
op_star
id|line_pitch
op_plus
l_int|0x10
suffix:semicolon
multiline_comment|/* Clear screen */
id|p
op_assign
(paren
r_int
op_star
)paren
(paren
id|frame_buffer
op_plus
l_int|0x10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|n_scanlines
op_star
id|line_pitch
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|display_info.height
op_assign
id|n_scanlines
suffix:semicolon
id|display_info.width
op_assign
id|width
suffix:semicolon
id|display_info.depth
op_assign
l_int|8
op_star
id|pixel_size
suffix:semicolon
id|display_info.pitch
op_assign
id|line_pitch
suffix:semicolon
id|display_info.mode
op_assign
id|video_mode
suffix:semicolon
id|strncpy
c_func
(paren
id|display_info.name
comma
l_string|&quot;platinum&quot;
comma
r_sizeof
(paren
id|display_info.name
)paren
)paren
suffix:semicolon
id|display_info.fb_address
op_assign
(paren
r_int
r_int
)paren
id|frame_buffer
op_plus
l_int|0x10
suffix:semicolon
id|display_info.cmap_adr_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|cmap_regs-&gt;addr
suffix:semicolon
id|display_info.cmap_data_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|cmap_regs-&gt;lut
suffix:semicolon
id|display_info.disp_reg_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|plat_regs
suffix:semicolon
)brace
r_int
DECL|function|platinum_setmode
id|platinum_setmode
c_func
(paren
r_struct
id|vc_mode
op_star
id|mode
comma
r_int
id|doit
)paren
(brace
r_int
id|cmode
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;mode
op_le
l_int|0
op_logical_or
id|mode-&gt;mode
OG
id|VMODE_MAX
op_logical_or
id|platinum_reg_init
(braket
id|mode-&gt;mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;depth
op_ne
l_int|8
op_logical_and
id|mode-&gt;depth
op_ne
l_int|16
op_logical_and
id|mode-&gt;depth
op_ne
l_int|24
op_logical_and
id|mode-&gt;depth
op_ne
l_int|32
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|mode-&gt;depth
)paren
(brace
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|cmode
op_assign
id|CMODE_32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|cmode
op_assign
id|CMODE_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|cmode
op_assign
id|CMODE_8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|platinum_vram_reqd
c_func
(paren
id|mode-&gt;mode
comma
id|cmode
)paren
OG
id|total_vram
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|doit
)paren
(brace
id|video_mode
op_assign
id|mode-&gt;mode
suffix:semicolon
id|color_mode
op_assign
id|cmode
suffix:semicolon
id|platinum_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|platinum_set_palette
id|platinum_set_palette
c_func
(paren
r_int
r_char
id|red
(braket
)braket
comma
r_int
r_char
id|green
(braket
)braket
comma
r_int
r_char
id|blue
(braket
)braket
comma
r_int
id|index
comma
r_int
id|ncolors
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncolors
suffix:semicolon
op_increment
id|i
)paren
(brace
id|cmap_regs-&gt;addr
op_assign
id|index
op_plus
id|i
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs-&gt;lut
op_assign
id|red
(braket
id|i
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs-&gt;lut
op_assign
id|green
(braket
id|i
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs-&gt;lut
op_assign
id|blue
(braket
id|i
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|platinum_set_blanking
id|platinum_set_blanking
c_func
(paren
r_int
id|blank_mode
)paren
(brace
)brace
eof
