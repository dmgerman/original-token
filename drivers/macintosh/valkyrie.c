multiline_comment|/*&n; * valkyrie.c: Console support for PowerMac &quot;valkyrie&quot; display adaptor.&n; *&n; * Copyright (C) 1997 Paul Mackerras.&n; *&t;&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vc_ioctl.h&gt;
macro_line|#include &lt;linux/nvram.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/cuda.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &quot;pmac-cons.h&quot;
macro_line|#include &quot;valkyrie.h&quot;
multiline_comment|/*&n; * Structure of the registers for the Valkyrie colormap registers.&n; */
DECL|struct|cmap_regs
r_struct
id|cmap_regs
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|pad1
r_char
id|pad1
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Structure of the registers for the &quot;valkyrie&quot; display adaptor.&n; */
DECL|macro|PAD
mdefine_line|#define PAD(x)&t;char x[7]
DECL|struct|valkyrie_regs
r_struct
id|valkyrie_regs
(brace
DECL|member|mode
r_int
r_char
id|mode
suffix:semicolon
id|PAD
c_func
(paren
id|pad0
)paren
suffix:semicolon
DECL|member|depth
r_int
r_char
id|depth
suffix:semicolon
id|PAD
c_func
(paren
id|pad1
)paren
suffix:semicolon
DECL|member|status
r_int
r_char
id|status
suffix:semicolon
id|PAD
c_func
(paren
id|pad2
)paren
suffix:semicolon
DECL|member|reg3
r_int
r_char
id|reg3
suffix:semicolon
id|PAD
c_func
(paren
id|pad3
)paren
suffix:semicolon
DECL|member|intr
r_int
r_char
id|intr
suffix:semicolon
id|PAD
c_func
(paren
id|pad4
)paren
suffix:semicolon
DECL|member|reg5
r_int
r_char
id|reg5
suffix:semicolon
id|PAD
c_func
(paren
id|pad5
)paren
suffix:semicolon
DECL|member|intr_enb
r_int
r_char
id|intr_enb
suffix:semicolon
id|PAD
c_func
(paren
id|pad6
)paren
suffix:semicolon
DECL|member|msense
r_int
r_char
id|msense
suffix:semicolon
id|PAD
c_func
(paren
id|pad7
)paren
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|set_valkyrie_clock
c_func
(paren
r_int
r_char
op_star
id|params
)paren
suffix:semicolon
r_static
r_int
id|read_valkyrie_sense
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|frame_buffer
r_static
r_int
r_char
op_star
id|frame_buffer
suffix:semicolon
DECL|variable|cmap_regs
r_static
r_struct
id|cmap_regs
op_star
id|cmap_regs
suffix:semicolon
DECL|variable|disp_regs
r_static
r_struct
id|valkyrie_regs
op_star
id|disp_regs
suffix:semicolon
multiline_comment|/*&n; * Register initialization tables for the valkyrie display.&n; *&n; * Dot clock rate is&n; * 3.9064MHz * 2**clock_params[2] * clock_params[1] / clock_params[0].&n; */
DECL|struct|valkyrie_regvals
r_struct
id|valkyrie_regvals
(brace
DECL|member|mode
r_int
r_char
id|mode
suffix:semicolon
DECL|member|clock_params
r_int
r_char
id|clock_params
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|pitch
r_int
id|pitch
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* bytes/line, indexed by color_mode */
)brace
suffix:semicolon
multiline_comment|/* Register values for 1024x768, 72Hz mode (15) */
DECL|variable|valkyrie_reg_init_15
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_15
op_assign
(brace
l_int|15
comma
(brace
l_int|12
comma
l_int|30
comma
l_int|3
)brace
comma
multiline_comment|/* pixel clock = 78.12MHz for V=72.12Hz */
(brace
l_int|1024
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 1024x768, 60Hz mode (14) */
DECL|variable|valkyrie_reg_init_14
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_14
op_assign
(brace
l_int|14
comma
(brace
l_int|15
comma
l_int|31
comma
l_int|3
)brace
comma
multiline_comment|/* pixel clock = 64.58MHz for V=59.62Hz */
(brace
l_int|1024
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 832x624, 75Hz mode (13) */
DECL|variable|valkyrie_reg_init_13
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_13
op_assign
(brace
l_int|9
comma
(brace
l_int|23
comma
l_int|42
comma
l_int|3
)brace
comma
multiline_comment|/* pixel clock = 57.07MHz for V=74.27Hz */
(brace
l_int|832
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 800x600, 72Hz mode (11) */
DECL|variable|valkyrie_reg_init_11
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_11
op_assign
(brace
l_int|13
comma
(brace
l_int|17
comma
l_int|27
comma
l_int|3
)brace
comma
multiline_comment|/* pixel clock = 49.63MHz for V=71.66Hz */
(brace
l_int|800
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 800x600, 60Hz mode (10) */
DECL|variable|valkyrie_reg_init_10
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_10
op_assign
(brace
l_int|12
comma
(brace
l_int|20
comma
l_int|53
comma
l_int|2
)brace
comma
multiline_comment|/* pixel clock = 41.41MHz for V=59.78Hz */
(brace
l_int|800
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 640x480, 67Hz mode (6) */
DECL|variable|valkyrie_reg_init_6
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_6
op_assign
(brace
l_int|6
comma
(brace
l_int|14
comma
l_int|27
comma
l_int|2
)brace
comma
multiline_comment|/* pixel clock = 30.13MHz for V=66.43Hz */
(brace
l_int|640
comma
l_int|1280
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 640x480, 60Hz mode (5) */
DECL|variable|valkyrie_reg_init_5
r_static
r_struct
id|valkyrie_regvals
id|valkyrie_reg_init_5
op_assign
(brace
l_int|11
comma
(brace
l_int|23
comma
l_int|37
comma
l_int|2
)brace
comma
multiline_comment|/* pixel clock = 25.14MHz for V=59.85Hz */
(brace
l_int|640
comma
l_int|1280
)brace
)brace
suffix:semicolon
DECL|variable|valkyrie_reg_init
r_static
r_struct
id|valkyrie_regvals
op_star
id|valkyrie_reg_init
(braket
l_int|20
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|valkyrie_reg_init_5
comma
op_amp
id|valkyrie_reg_init_6
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|valkyrie_reg_init_10
comma
op_amp
id|valkyrie_reg_init_11
comma
l_int|NULL
comma
op_amp
id|valkyrie_reg_init_13
comma
op_amp
id|valkyrie_reg_init_14
comma
op_amp
id|valkyrie_reg_init_15
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * Get the monitor sense value.&n; */
r_static
r_int
DECL|function|read_valkyrie_sense
id|read_valkyrie_sense
c_func
(paren
)paren
(brace
r_int
id|sense
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* release all lines */
id|__delay
c_func
(paren
l_int|20000
)paren
suffix:semicolon
id|sense
op_assign
(paren
id|in_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
)paren
op_amp
l_int|0x70
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* drive each sense line low in turn and collect the other 2 */
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* drive A low */
id|__delay
c_func
(paren
l_int|20000
)paren
suffix:semicolon
id|sense
op_or_assign
id|in_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
)paren
op_amp
l_int|0x30
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* drive B low */
id|__delay
c_func
(paren
l_int|20000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
)paren
op_amp
l_int|0x40
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
)paren
op_amp
l_int|0x10
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* drive C low */
id|__delay
c_func
(paren
l_int|20000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
id|in_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
)paren
op_amp
l_int|0x60
)paren
op_rshift
l_int|5
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;msense
comma
l_int|7
)paren
suffix:semicolon
r_return
id|sense
suffix:semicolon
)brace
r_void
DECL|function|map_valkyrie_display
id|map_valkyrie_display
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
r_int
id|sense
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;next
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Warning: only using first valkyrie display device&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;n_addrs
op_ne
l_int|1
)paren
id|panic
c_func
(paren
l_string|&quot;expecting 1 address for valkyrie (got %d)&quot;
comma
id|dp-&gt;n_addrs
)paren
suffix:semicolon
multiline_comment|/* Map in frame buffer and registers */
id|addr
op_assign
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|frame_buffer
op_assign
id|ioremap
c_func
(paren
id|addr
comma
l_int|0x100000
)paren
suffix:semicolon
id|disp_regs
op_assign
id|ioremap
c_func
(paren
id|addr
op_plus
l_int|0x30a000
comma
l_int|4096
)paren
suffix:semicolon
id|cmap_regs
op_assign
id|ioremap
c_func
(paren
id|addr
op_plus
l_int|0x304000
comma
l_int|4096
)paren
suffix:semicolon
multiline_comment|/* Read the monitor sense value and choose the video mode */
id|sense
op_assign
id|read_valkyrie_sense
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_eq
id|VMODE_NVRAM
)paren
(brace
id|video_mode
op_assign
id|nvram_read_byte
c_func
(paren
id|NV_VMODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_le
l_int|0
op_logical_or
id|video_mode
OG
id|VMODE_MAX
op_logical_or
id|valkyrie_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
id|video_mode
op_assign
id|VMODE_CHOOSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_mode
op_eq
id|VMODE_CHOOSE
)paren
id|video_mode
op_assign
id|map_monitor_sense
c_func
(paren
id|sense
)paren
suffix:semicolon
r_if
c_cond
(paren
id|valkyrie_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
id|video_mode
op_assign
id|VMODE_640_480_60
suffix:semicolon
multiline_comment|/*&n;&t; * Reduce the pixel size if we don&squot;t have enough VRAM.&n;&t; */
r_if
c_cond
(paren
id|color_mode
op_eq
id|CMODE_NVRAM
)paren
id|color_mode
op_assign
id|nvram_read_byte
c_func
(paren
id|NV_CMODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|color_mode
template_param
id|CMODE_16
op_logical_or
id|valkyrie_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|pitch
(braket
id|color_mode
)braket
op_eq
l_int|0
)paren
id|color_mode
op_assign
id|CMODE_8
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Monitor sense value = 0x%x, &quot;
comma
id|sense
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_valkyrie_clock
id|set_valkyrie_clock
c_func
(paren
r_int
r_char
op_star
id|params
)paren
(brace
r_struct
id|cuda_request
id|req
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
op_increment
id|i
)paren
(brace
id|cuda_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|CUDA_PACKET
comma
id|CUDA_GET_SET_IIC
comma
l_int|0x50
comma
id|i
op_plus
l_int|1
comma
id|params
(braket
id|i
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.got_reply
)paren
id|cuda_poll
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|valkyrie_init
id|valkyrie_init
c_func
(paren
)paren
(brace
r_int
id|i
comma
id|yoff
comma
id|hres
suffix:semicolon
r_int
op_star
id|p
suffix:semicolon
r_struct
id|valkyrie_regvals
op_star
id|init
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_le
l_int|0
op_logical_or
id|video_mode
OG
id|VMODE_MAX
op_logical_or
(paren
id|init
op_assign
id|valkyrie_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
)paren
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;valkyrie: display mode %d not supported&quot;
comma
id|video_mode
)paren
suffix:semicolon
id|n_scanlines
op_assign
id|vmode_attrs
(braket
id|video_mode
op_minus
l_int|1
)braket
dot
id|vres
suffix:semicolon
id|hres
op_assign
id|vmode_attrs
(braket
id|video_mode
op_minus
l_int|1
)braket
dot
id|hres
suffix:semicolon
id|pixel_size
op_assign
l_int|1
op_lshift
id|color_mode
suffix:semicolon
id|line_pitch
op_assign
id|init-&gt;pitch
(braket
id|color_mode
)braket
suffix:semicolon
id|row_pitch
op_assign
id|line_pitch
op_star
l_int|16
suffix:semicolon
multiline_comment|/* Reset the valkyrie */
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;status
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Initialize display timing registers */
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;mode
comma
id|init-&gt;mode
op_or
l_int|0x80
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;depth
comma
id|color_mode
op_plus
l_int|3
)paren
suffix:semicolon
id|set_valkyrie_clock
c_func
(paren
id|init-&gt;clock_params
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|pmac_init_palette
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize colormap */
multiline_comment|/* Turn on display */
id|out_8
c_func
(paren
op_amp
id|disp_regs-&gt;mode
comma
id|init-&gt;mode
)paren
suffix:semicolon
id|yoff
op_assign
(paren
id|n_scanlines
op_mod
l_int|16
)paren
op_div
l_int|2
suffix:semicolon
id|fb_start
op_assign
id|frame_buffer
op_plus
id|yoff
op_star
id|line_pitch
op_plus
l_int|0x1000
suffix:semicolon
multiline_comment|/* Clear screen */
id|p
op_assign
(paren
r_int
op_star
)paren
(paren
id|frame_buffer
op_plus
l_int|0x1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|n_scanlines
op_star
id|line_pitch
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|display_info.height
op_assign
id|n_scanlines
suffix:semicolon
id|display_info.width
op_assign
id|hres
suffix:semicolon
id|display_info.depth
op_assign
id|pixel_size
op_star
l_int|8
suffix:semicolon
id|display_info.pitch
op_assign
id|line_pitch
suffix:semicolon
id|display_info.mode
op_assign
id|video_mode
suffix:semicolon
id|strncpy
c_func
(paren
id|display_info.name
comma
l_string|&quot;valkyrie&quot;
comma
r_sizeof
(paren
id|display_info.name
)paren
)paren
suffix:semicolon
id|display_info.fb_address
op_assign
(paren
r_int
r_int
)paren
id|frame_buffer
op_plus
l_int|0x1000
suffix:semicolon
id|display_info.cmap_adr_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|cmap_regs-&gt;addr
suffix:semicolon
id|display_info.cmap_data_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|cmap_regs-&gt;lut
suffix:semicolon
id|display_info.disp_reg_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|disp_regs
suffix:semicolon
)brace
r_int
DECL|function|valkyrie_setmode
id|valkyrie_setmode
c_func
(paren
r_struct
id|vc_mode
op_star
id|mode
comma
r_int
id|doit
)paren
(brace
r_int
id|cmode
suffix:semicolon
r_switch
c_cond
(paren
id|mode-&gt;depth
)paren
(brace
r_case
l_int|16
suffix:colon
id|cmode
op_assign
id|CMODE_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_case
l_int|0
suffix:colon
multiline_comment|/* (default) */
id|cmode
op_assign
id|CMODE_8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode-&gt;mode
op_le
l_int|0
op_logical_or
id|mode-&gt;mode
OG
id|VMODE_MAX
op_logical_or
id|valkyrie_reg_init
(braket
id|mode-&gt;mode
op_minus
l_int|1
)braket
op_eq
l_int|0
op_logical_or
id|valkyrie_reg_init
(braket
id|mode-&gt;mode
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|pitch
(braket
id|cmode
)braket
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|doit
)paren
(brace
id|video_mode
op_assign
id|mode-&gt;mode
suffix:semicolon
id|color_mode
op_assign
id|cmode
suffix:semicolon
id|valkyrie_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|valkyrie_set_palette
id|valkyrie_set_palette
c_func
(paren
r_int
r_char
id|red
(braket
)braket
comma
r_int
r_char
id|green
(braket
)braket
comma
r_int
r_char
id|blue
(braket
)braket
comma
r_int
id|index
comma
r_int
id|ncolors
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncolors
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|cmap_regs-&gt;addr
comma
id|index
op_plus
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|cmap_regs-&gt;lut
comma
id|red
(braket
id|i
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|cmap_regs-&gt;lut
comma
id|green
(braket
id|i
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|cmap_regs-&gt;lut
comma
id|blue
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|valkyrie_set_blanking
id|valkyrie_set_blanking
c_func
(paren
r_int
id|blank_mode
)paren
(brace
multiline_comment|/* don&squot;t know how to do this yet */
)brace
eof
