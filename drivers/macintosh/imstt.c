multiline_comment|/*&n; * imstt.c: Console support for PowerMac &quot;imstt&quot; display adaptor.&n; *&n; * Copyright (C) 1997 Sigurdur Asgeirsson&n; *&t;&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vc_ioctl.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/nvram.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &quot;pmac-cons.h&quot;
macro_line|#include &quot;imstt.h&quot;
r_enum
(brace
DECL|enumerator|S1SA
id|S1SA
op_assign
l_int|0
comma
multiline_comment|/* 0x00 */
DECL|enumerator|S2SA
id|S2SA
op_assign
l_int|1
comma
multiline_comment|/* 0x04 */
DECL|enumerator|SP
id|SP
op_assign
l_int|2
comma
multiline_comment|/* 0x08 */
DECL|enumerator|DSA
id|DSA
op_assign
l_int|3
comma
multiline_comment|/* 0x0C */
DECL|enumerator|CNT
id|CNT
op_assign
l_int|4
comma
multiline_comment|/* 0x10 */
DECL|enumerator|DP_OCTRL
id|DP_OCTRL
op_assign
l_int|5
comma
multiline_comment|/* 0x14 */
DECL|enumerator|BLTCTL
id|BLTCTL
op_assign
l_int|10
comma
multiline_comment|/* 0x28 */
singleline_comment|//&t;Scan Timing Generator Registers
DECL|enumerator|HES
id|HES
op_assign
l_int|12
comma
multiline_comment|/* 0x30 */
DECL|enumerator|HEB
id|HEB
op_assign
l_int|13
comma
multiline_comment|/* 0x34 */
DECL|enumerator|HSB
id|HSB
op_assign
l_int|14
comma
multiline_comment|/* 0x38 */
DECL|enumerator|HT
id|HT
op_assign
l_int|15
comma
multiline_comment|/* 0x3C */
DECL|enumerator|VES
id|VES
op_assign
l_int|16
comma
multiline_comment|/* 0x40 */
DECL|enumerator|VEB
id|VEB
op_assign
l_int|17
comma
multiline_comment|/* 0x44 */
DECL|enumerator|VSB
id|VSB
op_assign
l_int|18
comma
multiline_comment|/* 0x48 */
DECL|enumerator|VT
id|VT
op_assign
l_int|19
comma
multiline_comment|/* 0x4C */
DECL|enumerator|HCIV
id|HCIV
op_assign
l_int|20
comma
multiline_comment|/* 0x50 */
DECL|enumerator|VCIV
id|VCIV
op_assign
l_int|21
comma
multiline_comment|/* 0x54 */
DECL|enumerator|TCDR
id|TCDR
op_assign
l_int|22
comma
multiline_comment|/* 0x58 */
DECL|enumerator|VIL
id|VIL
op_assign
l_int|23
comma
multiline_comment|/* 0x5C */
DECL|enumerator|STGCTL
id|STGCTL
op_assign
l_int|24
comma
multiline_comment|/* 0x60 */
singleline_comment|//&t;Screen Refresh Generator Registers
DECL|enumerator|SSR
id|SSR
op_assign
l_int|25
comma
multiline_comment|/* 0x64 */
DECL|enumerator|HRIR
id|HRIR
op_assign
l_int|26
comma
multiline_comment|/* 0x68 */
DECL|enumerator|SPR
id|SPR
op_assign
l_int|27
comma
multiline_comment|/* 0x6C */
DECL|enumerator|CMR
id|CMR
op_assign
l_int|28
comma
multiline_comment|/* 0x70 */
DECL|enumerator|SRGCTL
id|SRGCTL
op_assign
l_int|29
comma
multiline_comment|/* 0x74 */
singleline_comment|//&t;RAM Refresh Generator Registers
DECL|enumerator|RRCIV
id|RRCIV
op_assign
l_int|30
comma
multiline_comment|/* 0x78 */
DECL|enumerator|RRSC
id|RRSC
op_assign
l_int|31
comma
multiline_comment|/* 0x7C */
DECL|enumerator|RRCR
id|RRCR
op_assign
l_int|34
comma
multiline_comment|/* 0x88 */
singleline_comment|//&t;System Registers
DECL|enumerator|GIOE
id|GIOE
op_assign
l_int|32
comma
multiline_comment|/* 0x80 */
DECL|enumerator|GIO
id|GIO
op_assign
l_int|33
comma
multiline_comment|/* 0x84 */
DECL|enumerator|SCR
id|SCR
op_assign
l_int|35
comma
multiline_comment|/* 0x8C */
DECL|enumerator|SSTATUS
id|SSTATUS
op_assign
l_int|36
comma
multiline_comment|/* 0x90 */
DECL|enumerator|PRC
id|PRC
op_assign
l_int|37
comma
multiline_comment|/* 0x94 */
macro_line|#if 0&t;
singleline_comment|//&t;PCI Registers
id|DVID
op_assign
l_int|0x00000000L
comma
id|SC
op_assign
l_int|0x00000004L
comma
id|CCR
op_assign
l_int|0x00000008L
comma
id|OG
op_assign
l_int|0x0000000CL
comma
id|BARM
op_assign
l_int|0x00000010L
comma
id|BARER
op_assign
l_int|0x00000030L
comma
macro_line|#endif
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|PADDRW
id|PADDRW
op_assign
l_int|0x00
comma
DECL|enumerator|PDATA
id|PDATA
op_assign
l_int|0x04
comma
DECL|enumerator|PPMASK
id|PPMASK
op_assign
l_int|0x08
comma
DECL|enumerator|PADDRR
id|PADDRR
op_assign
l_int|0x0C
comma
DECL|enumerator|PIDXLO
id|PIDXLO
op_assign
l_int|0x10
comma
DECL|enumerator|PIDXHI
id|PIDXHI
op_assign
l_int|0x14
comma
DECL|enumerator|PIDXDATA
id|PIDXDATA
op_assign
l_int|0x18
comma
DECL|enumerator|PIDXCTL
id|PIDXCTL
op_assign
l_int|0x1C
comma
DECL|enumerator|PPIXREP
id|PPIXREP
op_assign
l_int|0x0A
comma
DECL|enumerator|PM0
id|PM0
op_assign
l_int|0x20
comma
DECL|enumerator|PN0
id|PN0
op_assign
l_int|0x21
comma
DECL|enumerator|PP0
id|PP0
op_assign
l_int|0x22
comma
DECL|enumerator|PC0
id|PC0
op_assign
l_int|0x23
)brace
suffix:semicolon
DECL|struct|initvalues
r_struct
id|initvalues
(brace
DECL|member|addr
DECL|member|value
r_int
r_char
id|addr
comma
id|value
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|initregs
r_static
r_struct
id|initvalues
id|initregs
(braket
)braket
op_assign
(brace
(brace
l_int|0x02
comma
l_int|0x21
)brace
comma
multiline_comment|/* (0x01) Miscellaneous Clock Control */
(brace
l_int|0x03
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Sync Control */
(brace
l_int|0x04
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Horizontal Sync Position */
(brace
l_int|0x05
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Power Management */
(brace
l_int|0x06
comma
l_int|0x0B
)brace
comma
multiline_comment|/* (0x02) DAC Operation */
(brace
l_int|0x07
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Palette Control */
(brace
l_int|0x08
comma
l_int|0x01
)brace
comma
multiline_comment|/* (0x01) System Clock Control */
(brace
l_int|0x0B
comma
l_int|0x00
)brace
comma
multiline_comment|/* (U) 8 BPP Control */
(brace
l_int|0x0C
comma
l_int|0xC4
)brace
comma
multiline_comment|/* (U) 16 BPP Control */
(brace
l_int|0x0D
comma
l_int|0x00
)brace
comma
multiline_comment|/* (U) 24 BPP Packed Control */
(brace
l_int|0x0E
comma
l_int|0x03
)brace
comma
multiline_comment|/* (U) 32 BPP Control */
(brace
l_int|0x10
comma
l_int|0x05
)brace
comma
multiline_comment|/* (0x00) Pixel PLL Control 1 */
(brace
l_int|0x11
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Pixel PLL Control 2 */
(brace
l_int|0x15
comma
l_int|0x08
)brace
comma
multiline_comment|/* (0x08) SYSCLK N (System PLL Reference Divider) */
(brace
l_int|0x16
comma
l_int|0x57
)brace
comma
multiline_comment|/* (0x41) SYSCLK M (System PLL VCO Divider) */
(brace
l_int|0x17
comma
l_int|0x00
)brace
comma
multiline_comment|/* (U) SYSCLK P */
(brace
l_int|0x18
comma
l_int|0x00
)brace
comma
multiline_comment|/* (U) SYSCLK C */
(brace
l_int|0x30
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Cursor Control */
(brace
l_int|0x60
comma
l_int|0xFF
)brace
comma
multiline_comment|/* (U) Border Color Red */
(brace
l_int|0x61
comma
l_int|0xFF
)brace
comma
multiline_comment|/* (U) Border Color Green */
(brace
l_int|0x62
comma
l_int|0xFF
)brace
comma
multiline_comment|/* (U) Border Color Blue */
(brace
l_int|0x70
comma
l_int|0x01
)brace
comma
multiline_comment|/* (0x00) Miscellaneous Control 1 */
(brace
l_int|0x71
comma
l_int|0x45
)brace
comma
multiline_comment|/* (0x00) Miscellaneous Control 2 */
(brace
l_int|0x72
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Miscellaneous Control 3 */
(brace
l_int|0x78
comma
l_int|0x00
)brace
comma
multiline_comment|/* (0x00) Key Control/DB Operation */
)brace
suffix:semicolon
r_static
r_void
id|set_imstt_clock
c_func
(paren
r_int
r_char
op_star
id|params
)paren
suffix:semicolon
r_static
r_int
id|read_imstt_sense
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|imstt_vram_reqd
c_func
(paren
r_int
id|vmode
comma
r_int
id|cmode
)paren
suffix:semicolon
DECL|variable|total_vram
r_static
r_int
id|total_vram
op_assign
l_int|2
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* total amount of video memory, bytes */
DECL|variable|frame_buffer
r_static
r_int
r_char
op_star
id|frame_buffer
suffix:semicolon
DECL|variable|cmap_regs
r_static
r_int
r_char
op_star
id|cmap_regs
suffix:semicolon
DECL|variable|dc_regs
r_static
r_int
op_star
id|dc_regs
suffix:semicolon
multiline_comment|/*&n; * Register initialization tables for the imstt display.&n; *&n; * Dot clock rate is 20MHz * (m + 1) / ((n + 1) * (p ? 2 * p : 1)&n; * where m = clk[0], n = clk[1], p = clk[2]&n; * clk[3] is c, charge pump bias which depends on the VCO frequency  &n; */
DECL|struct|imstt_regvals
r_struct
id|imstt_regvals
(brace
DECL|member|cfg
r_int
r_int
id|cfg
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|clk
r_int
r_char
id|clk
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|pitch
r_int
r_int
id|pitch
(braket
l_int|3
)braket
suffix:semicolon
DECL|variable|imsttmode
)brace
id|imsttmode
suffix:semicolon
multiline_comment|/* Register values for 1024x768, 75Hz mode (17) */
DECL|variable|imstt_reg_init_17
r_static
r_struct
id|imstt_regvals
id|imstt_reg_init_17
op_assign
(brace
(brace
l_int|0x0A
comma
l_int|0x1C
comma
l_int|0x9C
comma
l_int|0xA6
comma
l_int|0x0003
comma
l_int|0x0020
comma
l_int|0x0320
comma
l_int|0x0323
)brace
comma
(brace
l_int|0x07
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
)brace
comma
(brace
l_int|0x0400
comma
l_int|0x0800
comma
l_int|0x1000
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 832x624, 75Hz mode (13) */
DECL|variable|imstt_reg_init_13
r_static
r_struct
id|imstt_regvals
id|imstt_reg_init_13
op_assign
(brace
(brace
l_int|0x05
comma
l_int|0x20
comma
l_int|0x88
comma
l_int|0x90
comma
l_int|0x0003
comma
l_int|0x0028
comma
l_int|0x0298
comma
l_int|0x029B
)brace
comma
(brace
l_int|0x3E
comma
l_int|0x0A
comma
l_int|0x01
comma
l_int|0x02
)brace
comma
(brace
l_int|832
comma
l_int|832
op_star
l_int|2
comma
l_int|832
op_star
l_int|4
)brace
)brace
suffix:semicolon
multiline_comment|/* Register values for 640x480, 67Hz mode (6) */
DECL|variable|imstt_reg_init_6
r_static
r_struct
id|imstt_regvals
id|imstt_reg_init_6
op_assign
(brace
(brace
l_int|0x08
comma
l_int|0x12
comma
l_int|0x62
comma
l_int|0x6C
comma
l_int|0x0003
comma
l_int|0x002A
comma
l_int|0x020A
comma
l_int|0x020C
)brace
comma
(brace
l_int|0x78
comma
l_int|0x13
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|640
comma
l_int|640
op_star
l_int|2
comma
l_int|640
op_star
l_int|4
)brace
)brace
suffix:semicolon
DECL|variable|imstt_reg_init
r_static
r_struct
id|imstt_regvals
op_star
id|imstt_reg_init
(braket
l_int|20
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|imstt_reg_init_6
comma
singleline_comment|// fake&squot;m out
op_amp
id|imstt_reg_init_6
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|imstt_reg_init_13
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|imstt_reg_init_17
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * Get the monitor sense value.&n; * Note that this can be called before calibrate_delay,&n; * so we can&squot;t use udelay.&n; */
r_static
r_int
DECL|function|read_imstt_sense
id|read_imstt_sense
c_func
(paren
)paren
(brace
macro_line|#if 0
r_int
id|sense
suffix:semicolon
r_int
id|gio
comma
id|gioe
suffix:semicolon
id|gio
op_assign
id|ld_le32
c_func
(paren
id|dc_regs
op_plus
id|GIO
)paren
op_amp
op_complement
l_int|0x0038
suffix:semicolon
id|gioe
op_assign
id|ld_le32
(paren
id|dc_
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* drive all lines high */
id|__delay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
comma
l_int|077
)paren
suffix:semicolon
multiline_comment|/* turn off drivers */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_assign
(paren
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
)paren
op_amp
l_int|0x1c0
)paren
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* drive each sense line low in turn and collect the other 2 */
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
comma
l_int|033
)paren
suffix:semicolon
multiline_comment|/* drive A low */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
)paren
op_amp
l_int|0xc0
)paren
op_rshift
l_int|2
suffix:semicolon
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
comma
l_int|055
)paren
suffix:semicolon
multiline_comment|/* drive B low */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
(paren
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
)paren
op_amp
l_int|0x100
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
)paren
op_amp
l_int|0x40
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
comma
l_int|066
)paren
suffix:semicolon
multiline_comment|/* drive C low */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
)paren
op_amp
l_int|0x180
)paren
op_rshift
l_int|7
suffix:semicolon
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|GIOE
comma
l_int|077
)paren
suffix:semicolon
multiline_comment|/* turn off drivers */
r_return
id|sense
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|imstt_vram_reqd
r_static
r_inline
r_int
id|imstt_vram_reqd
c_func
(paren
r_int
id|vmode
comma
r_int
id|cmode
)paren
(brace
r_return
id|vmode_attrs
(braket
id|vmode
op_minus
l_int|1
)braket
dot
id|vres
op_star
id|imstt_reg_init
(braket
id|vmode
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|pitch
(braket
id|cmode
)braket
suffix:semicolon
)brace
r_void
DECL|function|map_imstt_display
id|map_imstt_display
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
r_int
id|i
comma
id|sense
suffix:semicolon
r_int
r_int
id|addr
comma
id|size
comma
id|tmp
suffix:semicolon
r_int
r_char
id|bus
comma
id|devfn
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;next
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Warning: only using first imstt display device&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 1
id|printk
c_func
(paren
l_string|&quot;pmac_display_init: node = %p, addrs =&quot;
comma
id|dp-&gt;node
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dp-&gt;n_addrs
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x(%x)&quot;
comma
id|dp-&gt;addrs
(braket
id|i
)braket
dot
id|address
comma
id|dp-&gt;addrs
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, intrs =&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dp-&gt;n_intrs
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|dp-&gt;intrs
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Map in frame buffer and registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dp-&gt;n_addrs
suffix:semicolon
op_increment
id|i
)paren
(brace
id|addr
op_assign
id|dp-&gt;addrs
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|size
op_assign
id|dp-&gt;addrs
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
l_int|0x02000000
)paren
(brace
id|frame_buffer
op_assign
id|ioremap
c_func
(paren
id|addr
comma
id|size
)paren
suffix:semicolon
id|dc_regs
op_assign
(paren
r_int
op_star
)paren
(paren
id|frame_buffer
op_plus
l_int|0x00800000
)paren
suffix:semicolon
id|cmap_regs
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|frame_buffer
op_plus
l_int|0x00840000
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mapped frame_buffer=%x(%x)&quot;
comma
(paren
r_int
)paren
id|frame_buffer
comma
(paren
r_int
)paren
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; dc_regs=%x, cmap_regs=%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|dc_regs
comma
(paren
r_int
)paren
id|cmap_regs
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* enable memory-space accesses using config-space command register */
r_if
c_cond
(paren
id|pci_device_loc
c_func
(paren
id|dp
comma
op_amp
id|bus
comma
op_amp
id|devfn
)paren
op_eq
l_int|0
)paren
(brace
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;command word 0x%04X&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
l_int|0xffff
)paren
(brace
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;unable to find pci device&bslash;n&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|SSTATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;chip version %ld, &quot;
comma
(paren
id|tmp
op_amp
l_int|0x0F00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|tmp
op_assign
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|PRC
)paren
suffix:semicolon
id|total_vram
op_assign
(paren
id|tmp
op_amp
l_int|0x0004
)paren
ques
c_cond
l_int|0x000400000L
suffix:colon
l_int|0x000200000L
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VRAM size %ldM&bslash;n&quot;
comma
id|total_vram
op_div
l_int|0x000100000L
)paren
suffix:semicolon
id|sense
op_assign
id|read_imstt_sense
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Monitor sense value = 0x%x, &quot;
comma
id|sense
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|video_mode
op_eq
id|VMODE_NVRAM
)paren
(brace
id|video_mode
op_assign
id|nvram_read_byte
c_func
(paren
id|NV_VMODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_le
l_int|0
op_logical_or
id|video_mode
OG
id|VMODE_MAX
op_logical_or
id|imstt_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
id|video_mode
op_assign
id|VMODE_CHOOSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_mode
op_eq
id|VMODE_CHOOSE
)paren
id|video_mode
op_assign
id|map_monitor_sense
c_func
(paren
id|sense
)paren
suffix:semicolon
r_if
c_cond
(paren
id|imstt_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
id|video_mode
op_assign
id|VMODE_640_480_67
suffix:semicolon
multiline_comment|/*&n;&t; * Reduce the pixel size if we don&squot;t have enough VRAM.&n;&t; */
r_if
c_cond
(paren
id|color_mode
op_eq
id|CMODE_NVRAM
)paren
id|color_mode
op_assign
id|nvram_read_byte
c_func
(paren
id|NV_CMODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|color_mode
template_param
id|CMODE_32
)paren
id|color_mode
op_assign
id|CMODE_8
suffix:semicolon
r_while
c_loop
(paren
id|color_mode
OG
id|CMODE_8
op_logical_and
id|imstt_vram_reqd
c_func
(paren
id|video_mode
comma
id|color_mode
)paren
OG
id|total_vram
)paren
op_decrement
id|color_mode
suffix:semicolon
macro_line|#endif
id|video_mode
op_assign
id|VMODE_640_480_67
suffix:semicolon
id|color_mode
op_assign
id|CMODE_8
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_imstt_clock
id|set_imstt_clock
c_func
(paren
r_int
r_char
op_star
id|params
)paren
(brace
id|cmap_regs
(braket
id|PIDXHI
)braket
op_assign
l_int|0
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXLO
)braket
op_assign
id|PM0
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXDATA
)braket
op_assign
id|params
(braket
l_int|0
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXLO
)braket
op_assign
id|PN0
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXDATA
)braket
op_assign
id|params
(braket
l_int|1
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXLO
)braket
op_assign
id|PP0
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXDATA
)braket
op_assign
id|params
(braket
l_int|2
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXLO
)braket
op_assign
id|PC0
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXDATA
)braket
op_assign
id|params
(braket
l_int|3
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|imstt_init
id|imstt_init
c_func
(paren
)paren
(brace
r_int
id|i
comma
id|yoff
comma
id|hres
suffix:semicolon
r_int
r_int
id|ctl
comma
id|pitch
comma
id|tmp
suffix:semicolon
r_int
r_char
id|pformat
suffix:semicolon
r_int
op_star
id|p
suffix:semicolon
r_struct
id|imstt_regvals
op_star
id|init
suffix:semicolon
r_if
c_cond
(paren
id|video_mode
op_le
l_int|0
op_logical_or
id|video_mode
OG
id|VMODE_MAX
op_logical_or
(paren
id|init
op_assign
id|imstt_reg_init
(braket
id|video_mode
op_minus
l_int|1
)braket
)paren
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;imstt: display mode %d not supported&quot;
comma
id|video_mode
)paren
suffix:semicolon
id|n_scanlines
op_assign
id|vmode_attrs
(braket
id|video_mode
op_minus
l_int|1
)braket
dot
id|vres
suffix:semicolon
id|hres
op_assign
id|vmode_attrs
(braket
id|video_mode
op_minus
l_int|1
)braket
dot
id|hres
suffix:semicolon
id|pixel_size
op_assign
l_int|1
op_lshift
id|color_mode
suffix:semicolon
id|line_pitch
op_assign
id|init-&gt;pitch
(braket
id|color_mode
)braket
suffix:semicolon
id|row_pitch
op_assign
id|line_pitch
op_star
l_int|16
suffix:semicolon
multiline_comment|/* initialize the card */
id|tmp
op_assign
id|in_le32
c_func
(paren
id|dc_regs
op_plus
id|STGCTL
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|STGCTL
comma
id|tmp
op_amp
op_complement
l_int|0x1
)paren
suffix:semicolon
macro_line|#if 0
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|SCR
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|cmap_regs
(braket
id|PPMASK
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* set default values for DAC registers */
id|cmap_regs
(braket
id|PIDXHI
)braket
op_assign
l_int|0
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|initregs
)paren
op_div
r_sizeof
(paren
op_star
id|initregs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cmap_regs
(braket
id|PIDXLO
)braket
op_assign
id|initregs
(braket
id|i
)braket
dot
id|addr
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXDATA
)braket
op_assign
id|initregs
(braket
id|i
)braket
dot
id|value
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_imstt_clock
c_func
(paren
id|init-&gt;clk
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|color_mode
)paren
(brace
r_case
id|CMODE_32
suffix:colon
id|ctl
op_assign
l_int|0x17b5
suffix:semicolon
id|pitch
op_assign
id|init-&gt;pitch
(braket
l_int|2
)braket
op_div
l_int|4
suffix:semicolon
id|pformat
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMODE_16
suffix:colon
id|ctl
op_assign
l_int|0x17b3
suffix:semicolon
id|pitch
op_assign
id|init-&gt;pitch
(braket
l_int|1
)braket
op_div
l_int|4
suffix:semicolon
id|pformat
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMODE_8
suffix:colon
r_default
suffix:colon
id|ctl
op_assign
l_int|0x17b1
suffix:semicolon
id|pitch
op_assign
id|init-&gt;pitch
(braket
l_int|0
)braket
op_div
l_int|4
suffix:semicolon
id|pformat
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|HES
)braket
comma
id|init-&gt;cfg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|HEB
)braket
comma
id|init-&gt;cfg
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|HSB
)braket
comma
id|init-&gt;cfg
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|HT
)braket
comma
id|init-&gt;cfg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|VES
)braket
comma
id|init-&gt;cfg
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|VEB
)braket
comma
id|init-&gt;cfg
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|VSB
)braket
comma
id|init-&gt;cfg
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|VT
)braket
comma
id|init-&gt;cfg
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|HCIV
)braket
comma
l_int|1
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|VCIV
)braket
comma
l_int|1
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|TCDR
)braket
comma
l_int|4
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|VIL
)braket
comma
l_int|0
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|SSR
)braket
comma
l_int|0
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|HRIR
)braket
comma
l_int|0x0200
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|CMR
)braket
comma
l_int|0x01FF
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|SRGCTL
)braket
comma
l_int|0x0003
)paren
suffix:semicolon
r_if
c_cond
(paren
id|total_vram
op_eq
l_int|0x000200000
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|SCR
)braket
comma
l_int|0x0059D
)paren
suffix:semicolon
)brace
r_else
(brace
id|pitch
op_div_assign
l_int|2
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|SCR
)braket
comma
l_int|0x00D0DC
)paren
suffix:semicolon
)brace
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|SPR
)braket
comma
id|pitch
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXLO
)braket
op_assign
id|PPIXREP
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PIDXDATA
)braket
op_assign
id|pformat
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|pmac_init_palette
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize colormap */
id|out_le32
c_func
(paren
op_amp
id|dc_regs
(braket
id|STGCTL
)braket
comma
id|ctl
)paren
suffix:semicolon
id|yoff
op_assign
(paren
id|n_scanlines
op_mod
l_int|16
)paren
op_div
l_int|2
suffix:semicolon
id|fb_start
op_assign
id|frame_buffer
op_plus
id|yoff
op_star
id|line_pitch
suffix:semicolon
multiline_comment|/* Clear screen */
id|p
op_assign
(paren
r_int
op_star
)paren
id|frame_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|n_scanlines
op_star
id|line_pitch
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|display_info.height
op_assign
id|n_scanlines
suffix:semicolon
id|display_info.width
op_assign
id|hres
suffix:semicolon
id|display_info.depth
op_assign
id|pixel_size
op_star
l_int|8
suffix:semicolon
id|display_info.pitch
op_assign
id|line_pitch
suffix:semicolon
id|display_info.mode
op_assign
id|video_mode
suffix:semicolon
id|strncpy
c_func
(paren
id|display_info.name
comma
l_string|&quot;IMS,tt128mb&quot;
comma
r_sizeof
(paren
id|display_info.name
)paren
)paren
suffix:semicolon
id|display_info.fb_address
op_assign
(paren
r_int
r_int
)paren
id|frame_buffer
suffix:semicolon
id|display_info.cmap_adr_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|cmap_regs
(braket
id|PADDRW
)braket
suffix:semicolon
id|display_info.cmap_data_address
op_assign
(paren
r_int
r_int
)paren
op_amp
id|cmap_regs
(braket
id|PDATA
)braket
suffix:semicolon
id|display_info.disp_reg_address
op_assign
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|imstt_setmode
id|imstt_setmode
c_func
(paren
r_struct
id|vc_mode
op_star
id|mode
comma
r_int
id|doit
)paren
(brace
r_int
id|cmode
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;mode
op_le
l_int|0
op_logical_or
id|mode-&gt;mode
OG
id|VMODE_MAX
op_logical_or
id|imstt_reg_init
(braket
id|mode-&gt;mode
op_minus
l_int|1
)braket
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|mode-&gt;depth
)paren
(brace
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|cmode
op_assign
id|CMODE_32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|cmode
op_assign
id|CMODE_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_case
l_int|0
suffix:colon
multiline_comment|/* (default) */
id|cmode
op_assign
id|CMODE_8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|imstt_vram_reqd
c_func
(paren
id|mode-&gt;mode
comma
id|cmode
)paren
OG
id|total_vram
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|doit
)paren
(brace
id|video_mode
op_assign
id|mode-&gt;mode
suffix:semicolon
id|color_mode
op_assign
id|cmode
suffix:semicolon
id|imstt_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|imstt_set_palette
id|imstt_set_palette
c_func
(paren
r_int
r_char
id|red
(braket
)braket
comma
r_int
r_char
id|green
(braket
)braket
comma
r_int
r_char
id|blue
(braket
)braket
comma
r_int
id|index
comma
r_int
id|ncolors
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncolors
suffix:semicolon
op_increment
id|i
)paren
(brace
id|cmap_regs
(braket
id|PADDRW
)braket
op_assign
id|index
op_plus
id|i
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PDATA
)braket
op_assign
id|red
(braket
id|i
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PDATA
)braket
op_assign
id|green
(braket
id|i
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cmap_regs
(braket
id|PDATA
)braket
op_assign
id|blue
(braket
id|i
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|imstt_set_blanking
id|imstt_set_blanking
c_func
(paren
r_int
id|blank_mode
)paren
(brace
r_int
id|ctrl
suffix:semicolon
id|ctrl
op_assign
id|ld_le32
c_func
(paren
id|dc_regs
op_plus
id|STGCTL
)paren
op_or
l_int|0x0030
suffix:semicolon
r_if
c_cond
(paren
id|blank_mode
op_amp
id|VESA_VSYNC_SUSPEND
)paren
id|ctrl
op_and_assign
op_complement
l_int|0x0020
suffix:semicolon
r_if
c_cond
(paren
id|blank_mode
op_amp
id|VESA_HSYNC_SUSPEND
)paren
id|ctrl
op_and_assign
op_complement
l_int|0x0010
suffix:semicolon
id|out_le32
c_func
(paren
id|dc_regs
op_plus
id|STGCTL
comma
id|ctrl
)paren
suffix:semicolon
)brace
eof
