multiline_comment|/******************************************************************************&n; *&n; * Module Name: dsopcode - Dispatcher Op Region support&n; *                          and handling of &quot;control&quot; opcodes&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;parser.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;dispatch.h&quot;
macro_line|#include &quot;interp.h&quot;
macro_line|#include &quot;namesp.h&quot;
macro_line|#include &quot;events.h&quot;
macro_line|#include &quot;tables.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          DISPATCHER
id|MODULE_NAME
(paren
l_string|&quot;dsopcode&quot;
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_get_region_arguments&n; *&n; * PARAMETERS:  Rgn_desc        - A valid region object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get region address and length.  This implements the late&n; *              evaluation of these region attributes.&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ds_get_region_arguments
id|acpi_ds_get_region_arguments
(paren
id|ACPI_OBJECT_INTERNAL
op_star
id|rgn_desc
)paren
(brace
id|ACPI_OBJECT_INTERNAL
op_star
id|method_desc
suffix:semicolon
id|ACPI_NAMED_OBJECT
op_star
id|entry
suffix:semicolon
id|ACPI_GENERIC_OP
op_star
id|op
suffix:semicolon
id|ACPI_GENERIC_OP
op_star
id|region_op
suffix:semicolon
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_TABLE_DESC
op_star
id|table_desc
suffix:semicolon
r_if
c_cond
(paren
id|rgn_desc-&gt;region.region_flags
op_amp
id|REGION_AGRUMENT_DATA_VALID
)paren
(brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|method_desc
op_assign
id|rgn_desc-&gt;region.method
suffix:semicolon
id|entry
op_assign
id|rgn_desc-&gt;region.nte
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate a new parser op to be the root of the parsed&n;&t; * Op_region tree&n;&t; */
id|op
op_assign
id|acpi_ps_alloc_op
(paren
id|AML_REGION_OP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
r_return
id|AE_NO_MEMORY
suffix:semicolon
)brace
multiline_comment|/* Save the NTE for use in Acpi_ps_parse_aml */
id|op-&gt;acpi_named_object
op_assign
id|acpi_ns_get_parent_entry
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/* Get a handle to the parent ACPI table */
id|status
op_assign
id|acpi_tb_handle_to_object
(paren
id|entry-&gt;owner_id
comma
op_amp
id|table_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Parse the entire Op_region declaration, creating a parse tree */
id|status
op_assign
id|acpi_ps_parse_aml
(paren
id|op
comma
id|method_desc-&gt;method.pcode
comma
id|method_desc-&gt;method.pcode_length
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/* Get and init the actual Region_op created above */
id|region_op
op_assign
id|op-&gt;value.arg
suffix:semicolon
id|region_op-&gt;acpi_named_object
op_assign
id|entry
suffix:semicolon
multiline_comment|/* Acpi_evaluate the address and length arguments for the Op_region */
id|acpi_ps_walk_parsed_aml
(paren
id|region_op
comma
id|region_op
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
id|table_desc-&gt;table_id
comma
id|acpi_ds_exec_begin_op
comma
id|acpi_ds_exec_end_op
)paren
suffix:semicolon
)brace
multiline_comment|/* All done with the parse tree, delete it */
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_initialize_region&n; *&n; * PARAMETERS:  Op              - A valid region Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ds_initialize_region
id|acpi_ds_initialize_region
(paren
id|ACPI_HANDLE
id|obj_handle
)paren
(brace
id|ACPI_OBJECT_INTERNAL
op_star
id|obj_desc
suffix:semicolon
id|ACPI_STATUS
id|status
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|obj_handle
)paren
suffix:semicolon
multiline_comment|/* Namespace is NOT locked */
id|status
op_assign
id|acpi_ev_initialize_region
(paren
id|obj_desc
comma
id|FALSE
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_eval_region_operands&n; *&n; * PARAMETERS:  Op              - A valid region Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Get region address and length&n; *              Called from Acpi_ds_exec_end_op during Op_region parse tree walk&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ds_eval_region_operands
id|acpi_ds_eval_region_operands
(paren
id|ACPI_WALK_STATE
op_star
id|walk_state
comma
id|ACPI_GENERIC_OP
op_star
id|op
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_OBJECT_INTERNAL
op_star
id|obj_desc
suffix:semicolon
id|ACPI_OBJECT_INTERNAL
op_star
id|region_desc
suffix:semicolon
id|ACPI_NAMED_OBJECT
op_star
id|entry
suffix:semicolon
id|ACPI_GENERIC_OP
op_star
id|next_op
suffix:semicolon
multiline_comment|/*&n;&t; * This is where we evaluate the address and length fields of the Op_region declaration&n;&t; */
id|entry
op_assign
id|op-&gt;acpi_named_object
suffix:semicolon
multiline_comment|/* Next_op points to the op that holds the Space_iD */
id|next_op
op_assign
id|op-&gt;value.arg
suffix:semicolon
multiline_comment|/* Next_op points to address op */
id|next_op
op_assign
id|next_op-&gt;next
suffix:semicolon
multiline_comment|/* Acpi_evaluate/create the address and length operands */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|next_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|region_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_desc
)paren
(brace
r_return
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the length and save it */
multiline_comment|/* Top of stack */
id|obj_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|1
)braket
suffix:semicolon
id|region_desc-&gt;region.length
op_assign
id|obj_desc-&gt;number.value
suffix:semicolon
id|acpi_cm_remove_reference
(paren
id|obj_desc
)paren
suffix:semicolon
multiline_comment|/* Get the address and save it */
multiline_comment|/* Top of stack - 1 */
id|obj_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|2
)braket
suffix:semicolon
id|region_desc-&gt;region.address
op_assign
id|obj_desc-&gt;number.value
suffix:semicolon
id|acpi_cm_remove_reference
(paren
id|obj_desc
)paren
suffix:semicolon
multiline_comment|/* Now the address and length are valid for this opregion */
id|region_desc-&gt;region.region_flags
op_or_assign
id|REGION_AGRUMENT_DATA_VALID
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_exec_begin_control_op&n; *&n; * PARAMETERS:  Walk_list       - The list that owns the walk stack&n; *              Op              - The control Op&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Handles all control ops encountered during control method&n; *              execution.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ds_exec_begin_control_op
id|acpi_ds_exec_begin_control_op
(paren
id|ACPI_WALK_STATE
op_star
id|walk_state
comma
id|ACPI_GENERIC_OP
op_star
id|op
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ACPI_GENERIC_STATE
op_star
id|control_state
suffix:semicolon
r_switch
c_cond
(paren
id|op-&gt;opcode
)paren
(brace
r_case
id|AML_IF_OP
suffix:colon
r_case
id|AML_WHILE_OP
suffix:colon
multiline_comment|/*&n;&t;&t; * IF/WHILE: Create a new control state to manage these&n;&t;&t; * constructs. We need to manage these as a stack, in order&n;&t;&t; * to handle nesting.&n;&t;&t; */
id|control_state
op_assign
id|acpi_cm_create_control_state
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|control_state
)paren
(brace
id|status
op_assign
id|AE_NO_MEMORY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|acpi_cm_push_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
comma
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_ELSE_OP
suffix:colon
multiline_comment|/* Predicate is in the state object */
multiline_comment|/* If predicate is true, the IF was executed, ignore ELSE part */
r_if
c_cond
(paren
id|walk_state-&gt;last_predicate
)paren
(brace
id|status
op_assign
id|AE_CTRL_TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|AML_RETURN_OP
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_exec_end_control_op&n; *&n; * PARAMETERS:  Walk_list       - The list that owns the walk stack&n; *              Op              - The control Op&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Handles all control ops encountered during control method&n; *              execution.&n; *&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ds_exec_end_control_op
id|acpi_ds_exec_end_control_op
(paren
id|ACPI_WALK_STATE
op_star
id|walk_state
comma
id|ACPI_GENERIC_OP
op_star
id|op
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ACPI_GENERIC_STATE
op_star
id|control_state
suffix:semicolon
r_switch
c_cond
(paren
id|op-&gt;opcode
)paren
(brace
r_case
id|AML_IF_OP
suffix:colon
multiline_comment|/*&n;&t;&t; * Save the result of the predicate in case there is an&n;&t;&t; * ELSE to come&n;&t;&t; */
id|walk_state-&gt;last_predicate
op_assign
(paren
id|u8
)paren
id|walk_state-&gt;control_state-&gt;common.value
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Pop the control state that was created at the start&n;&t;&t; * of the IF and free it&n;&t;&t; */
id|control_state
op_assign
id|acpi_cm_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|acpi_cm_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_ELSE_OP
suffix:colon
r_break
suffix:semicolon
r_case
id|AML_WHILE_OP
suffix:colon
r_if
c_cond
(paren
id|walk_state-&gt;control_state-&gt;common.value
)paren
(brace
multiline_comment|/* Predicate was true, go back and evaluate it again! */
id|status
op_assign
id|AE_CTRL_TRUE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Pop this control state and free it */
id|control_state
op_assign
id|acpi_cm_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|acpi_cm_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|AML_RETURN_OP
suffix:colon
multiline_comment|/* One optional operand -- the return value */
r_if
c_cond
(paren
id|op-&gt;value.arg
)paren
(brace
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|op-&gt;value.arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * TBD: [Restructure] Just check for NULL arg&n;&t;&t;&t; * to signify no return value???&n;&t;&t;&t; */
multiline_comment|/*&n;&t;&t;&t; * If value being returned is a Reference (such as&n;&t;&t;&t; * an arg or local), resolve it now because it may&n;&t;&t;&t; * cease to exist at the end of the method.&n;&t;&t;&t; */
id|status
op_assign
id|acpi_aml_resolve_to_value
(paren
op_amp
id|walk_state-&gt;operands
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Get the return value and save as the last result&n;&t;&t;&t; * value&n;&t;&t;&t; * This is the only place where Walk_state-&gt;Return_desc&n;&t;&t;&t; * is set to anything other than zero!&n;&t;&t;&t; */
id|walk_state-&gt;return_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No return operand */
id|acpi_cm_remove_reference
(paren
id|walk_state-&gt;operands
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|walk_state-&gt;operands
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|walk_state-&gt;num_operands
op_assign
l_int|0
suffix:semicolon
id|walk_state-&gt;return_desc
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* End the control method execution right now */
id|status
op_assign
id|AE_CTRL_TERMINATE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_NOOP_CODE
suffix:colon
multiline_comment|/* Just do nothing! */
r_break
suffix:semicolon
r_case
id|AML_BREAK_POINT_OP
suffix:colon
multiline_comment|/* Call up to the OS dependent layer to handle this */
id|acpi_os_breakpoint
(paren
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* If it returns, we are done! */
r_break
suffix:semicolon
r_case
id|AML_BREAK_OP
suffix:colon
multiline_comment|/*&n;&t;&t; * As per the ACPI specification:&n;&t;&t; *      &quot;The break operation causes the current package&n;&t;&t; *          execution to complete&quot;&n;&t;&t; *      &quot;Break -- Stop executing the current code package&n;&t;&t; *          at this point&quot;&n;&t;&t; *&n;&t;&t; * Returning AE_FALSE here will cause termination of&n;&t;&t; * the current package, and execution will continue one&n;&t;&t; * level up, starting with the completion of the parent Op.&n;&t;&t; */
id|status
op_assign
id|AE_CTRL_FALSE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
id|AE_AML_BAD_OPCODE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
eof
