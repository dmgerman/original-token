multiline_comment|/*&n; *  cpu.c - Processor handling&n; *&n; *  Copyright (C) 2000 Andrew Henroid&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;cpu&quot;
)paren
DECL|variable|acpi_c2_exit_latency
r_int
r_int
id|acpi_c2_exit_latency
op_assign
id|ACPI_INFINITE
suffix:semicolon
DECL|variable|acpi_c3_exit_latency
r_int
r_int
id|acpi_c3_exit_latency
op_assign
id|ACPI_INFINITE
suffix:semicolon
DECL|variable|acpi_c2_enter_latency
r_int
r_int
id|acpi_c2_enter_latency
op_assign
id|ACPI_INFINITE
suffix:semicolon
DECL|variable|acpi_c3_enter_latency
r_int
r_int
id|acpi_c3_enter_latency
op_assign
id|ACPI_INFINITE
suffix:semicolon
DECL|variable|acpi_pblk
r_static
r_int
r_int
id|acpi_pblk
op_assign
id|ACPI_INVALID
suffix:semicolon
DECL|variable|acpi_c2_tested
r_static
r_int
id|acpi_c2_tested
op_assign
l_int|0
suffix:semicolon
DECL|variable|acpi_c3_tested
r_static
r_int
id|acpi_c3_tested
op_assign
l_int|0
suffix:semicolon
DECL|variable|acpi_max_c_state
r_static
r_int
id|acpi_max_c_state
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n; * Clear busmaster activity flag&n; */
r_static
r_inline
r_void
DECL|function|acpi_clear_bm_activity
id|acpi_clear_bm_activity
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
)paren
(brace
id|acpi_write_pm1_status
c_func
(paren
id|facp
comma
id|ACPI_BM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns 1 if there has been busmaster activity&n; */
r_static
r_inline
r_int
DECL|function|acpi_bm_activity
id|acpi_bm_activity
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
)paren
(brace
r_return
id|acpi_read_pm1_status
c_func
(paren
id|facp
)paren
op_amp
id|ACPI_BM
suffix:semicolon
)brace
multiline_comment|/*&n; * Set system to sleep through busmaster requests&n; */
r_static
r_void
DECL|function|acpi_sleep_on_busmaster
id|acpi_sleep_on_busmaster
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
)paren
(brace
id|u32
id|pm1_cntr
op_assign
id|acpi_read_pm1_control
c_func
(paren
id|facp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pm1_cntr
op_amp
id|ACPI_BM_RLD
)paren
(brace
id|pm1_cntr
op_and_assign
op_complement
id|ACPI_BM_RLD
suffix:semicolon
id|acpi_write_pm1_control
c_func
(paren
id|facp
comma
id|pm1_cntr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set system to wake on busmaster requests&n; */
r_static
r_void
DECL|function|acpi_wake_on_busmaster
id|acpi_wake_on_busmaster
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
)paren
(brace
id|u32
id|pm1_cntr
op_assign
id|acpi_read_pm1_control
c_func
(paren
id|facp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pm1_cntr
op_amp
id|ACPI_BM_RLD
)paren
)paren
(brace
id|pm1_cntr
op_or_assign
id|ACPI_BM_RLD
suffix:semicolon
id|acpi_write_pm1_control
c_func
(paren
id|facp
comma
id|pm1_cntr
)paren
suffix:semicolon
)brace
id|acpi_clear_bm_activity
c_func
(paren
id|facp
)paren
suffix:semicolon
)brace
multiline_comment|/* The ACPI timer is just the low 24 bits */
DECL|macro|TIME_BEGIN
mdefine_line|#define TIME_BEGIN(tmr) inl(tmr)
DECL|macro|TIME_END
mdefine_line|#define TIME_END(tmr, begin) ((inl(tmr) - (begin)) &amp; 0x00ffffff)
multiline_comment|/*&n; * Idle loop (uniprocessor only)&n; */
r_static
r_void
DECL|function|acpi_idle
id|acpi_idle
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|sleep_level
op_assign
l_int|1
suffix:semicolon
r_struct
id|acpi_facp
op_star
id|facp
op_assign
op_amp
id|acpi_facp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|facp
op_logical_or
id|facp-&gt;hdr.signature
op_ne
id|ACPI_FACP_SIG
op_logical_or
op_logical_neg
id|facp-&gt;pm_tmr
op_logical_or
op_logical_neg
id|acpi_pblk
)paren
r_goto
id|not_initialized
suffix:semicolon
multiline_comment|/*&n;&t; * start from the previous sleep level..&n;&t; */
r_if
c_cond
(paren
id|sleep_level
op_eq
l_int|1
op_logical_or
id|acpi_max_c_state
OL
l_int|2
)paren
r_goto
id|sleep1
suffix:semicolon
r_if
c_cond
(paren
id|sleep_level
op_eq
l_int|2
op_logical_or
id|acpi_max_c_state
OL
l_int|3
)paren
r_goto
id|sleep2
suffix:semicolon
id|sleep3
suffix:colon
id|sleep_level
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_c3_tested
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ACPI C3 works&bslash;n&quot;
)paren
suffix:semicolon
id|acpi_c3_tested
op_assign
l_int|1
suffix:semicolon
)brace
id|acpi_wake_on_busmaster
c_func
(paren
id|facp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|facp-&gt;pm2_cnt
)paren
r_goto
id|sleep3_with_arbiter
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
r_int
id|pm_tmr
op_assign
id|facp-&gt;pm_tmr
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bm_activity
c_func
(paren
id|facp
)paren
)paren
r_goto
id|sleep2
suffix:semicolon
id|time
op_assign
id|TIME_BEGIN
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|inb
c_func
(paren
id|acpi_pblk
op_plus
id|ACPI_P_LVL3
)paren
suffix:semicolon
multiline_comment|/* Dummy read, force synchronization with the PMU */
id|inl
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|time
op_assign
id|TIME_END
c_func
(paren
id|pm_tmr
comma
id|time
)paren
suffix:semicolon
id|__sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time
OL
id|acpi_c3_exit_latency
)paren
r_goto
id|sleep2
suffix:semicolon
)brace
id|sleep3_with_arbiter
suffix:colon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
id|u8
id|arbiter
suffix:semicolon
r_int
r_int
id|pm2_cntr
op_assign
id|facp-&gt;pm2_cnt
suffix:semicolon
r_int
r_int
id|pm_tmr
op_assign
id|facp-&gt;pm_tmr
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bm_activity
c_func
(paren
id|facp
)paren
)paren
r_goto
id|sleep2
suffix:semicolon
id|time
op_assign
id|TIME_BEGIN
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|arbiter
op_assign
id|inb
c_func
(paren
id|pm2_cntr
)paren
op_amp
op_complement
id|ACPI_ARB_DIS
suffix:semicolon
multiline_comment|/* Disable arbiter, park on CPU */
id|outb
c_func
(paren
id|arbiter
op_or
id|ACPI_ARB_DIS
comma
id|pm2_cntr
)paren
suffix:semicolon
id|inb
c_func
(paren
id|acpi_pblk
op_plus
id|ACPI_P_LVL3
)paren
suffix:semicolon
multiline_comment|/* Dummy read, force synchronization with the PMU */
id|inl
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|time
op_assign
id|TIME_END
c_func
(paren
id|pm_tmr
comma
id|time
)paren
suffix:semicolon
multiline_comment|/* Enable arbiter again.. */
id|outb
c_func
(paren
id|arbiter
comma
id|pm2_cntr
)paren
suffix:semicolon
id|__sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time
OL
id|acpi_c3_exit_latency
)paren
r_goto
id|sleep2
suffix:semicolon
)brace
id|sleep2
suffix:colon
id|sleep_level
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_c2_tested
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ACPI C2 works&bslash;n&quot;
)paren
suffix:semicolon
id|acpi_c2_tested
op_assign
l_int|1
suffix:semicolon
)brace
id|acpi_wake_on_busmaster
c_func
(paren
id|facp
)paren
suffix:semicolon
multiline_comment|/* Required to track BM activity.. */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
r_int
id|pm_tmr
op_assign
id|facp-&gt;pm_tmr
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
r_goto
id|out
suffix:semicolon
id|time
op_assign
id|TIME_BEGIN
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|inb
c_func
(paren
id|acpi_pblk
op_plus
id|ACPI_P_LVL2
)paren
suffix:semicolon
multiline_comment|/* Dummy read, force synchronization with the PMU */
id|inl
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|time
op_assign
id|TIME_END
c_func
(paren
id|pm_tmr
comma
id|time
)paren
suffix:semicolon
id|__sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time
OL
id|acpi_c2_exit_latency
)paren
r_goto
id|sleep1
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bm_activity
c_func
(paren
id|facp
)paren
)paren
(brace
id|acpi_clear_bm_activity
c_func
(paren
id|facp
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time
OG
id|acpi_c3_enter_latency
op_logical_and
id|acpi_max_c_state
op_ge
l_int|3
)paren
r_goto
id|sleep3
suffix:semicolon
)brace
id|sleep1
suffix:colon
id|sleep_level
op_assign
l_int|1
suffix:semicolon
id|acpi_sleep_on_busmaster
c_func
(paren
id|facp
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
r_int
id|pm_tmr
op_assign
id|facp-&gt;pm_tmr
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
r_goto
id|out
suffix:semicolon
id|time
op_assign
id|TIME_BEGIN
c_func
(paren
id|pm_tmr
)paren
suffix:semicolon
id|safe_halt
c_func
(paren
)paren
suffix:semicolon
id|time
op_assign
id|TIME_END
c_func
(paren
id|pm_tmr
comma
id|time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time
OG
id|acpi_c2_enter_latency
op_logical_and
id|acpi_max_c_state
op_ge
l_int|2
)paren
r_goto
id|sleep2
suffix:semicolon
)brace
id|not_initialized
suffix:colon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|__cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
r_goto
id|out
suffix:semicolon
id|safe_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|__sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get processor information&n; */
r_static
id|ACPI_STATUS
DECL|function|acpi_find_cpu
id|acpi_find_cpu
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctx
comma
r_void
op_star
op_star
id|value
)paren
(brace
id|ACPI_OBJECT
id|obj
suffix:semicolon
id|ACPI_CX_STATE
id|lat
(braket
l_int|4
)braket
suffix:semicolon
id|ACPI_CPU_THROTTLING_STATE
id|throttle
(braket
id|ACPI_MAX_THROTTLE
)braket
suffix:semicolon
id|ACPI_BUFFER
id|buf
suffix:semicolon
r_int
id|i
comma
id|count
suffix:semicolon
id|buf.length
op_assign
r_sizeof
(paren
id|obj
)paren
suffix:semicolon
id|buf.pointer
op_assign
op_amp
id|obj
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: PBLK %d @ 0x%04x:%d&bslash;n&quot;
comma
id|obj.processor.proc_id
comma
id|obj.processor.pblk_address
comma
id|obj.processor.pblk_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_pblk
op_ne
id|ACPI_INVALID
op_logical_or
op_logical_neg
id|obj.processor.pblk_address
op_logical_or
id|obj.processor.pblk_length
op_ne
l_int|6
)paren
r_return
id|AE_OK
suffix:semicolon
id|acpi_pblk
op_assign
id|obj.processor.pblk_address
suffix:semicolon
id|buf.length
op_assign
r_sizeof
(paren
id|lat
)paren
suffix:semicolon
id|buf.pointer
op_assign
id|lat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_processor_cx_info
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
id|lat
(braket
l_int|2
)braket
dot
id|latency
OL
id|MAX_CX_STATE_LATENCY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: C2&quot;
)paren
suffix:semicolon
id|acpi_c2_exit_latency
op_assign
id|lat
(braket
l_int|2
)braket
dot
id|latency
suffix:semicolon
id|acpi_max_c_state
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|lat
(braket
l_int|3
)braket
dot
id|latency
OL
id|MAX_CX_STATE_LATENCY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, C3 supported&bslash;n&quot;
)paren
suffix:semicolon
id|acpi_c3_exit_latency
op_assign
id|lat
(braket
l_int|3
)braket
dot
id|latency
suffix:semicolon
id|acpi_max_c_state
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot; supported&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|throttle
comma
l_int|0
comma
r_sizeof
(paren
id|throttle
)paren
)paren
suffix:semicolon
id|buf.length
op_assign
r_sizeof
(paren
id|throttle
)paren
suffix:semicolon
id|buf.pointer
op_assign
id|throttle
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_processor_throttling_info
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_MAX_THROTTLE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|throttle
(braket
id|i
)braket
dot
id|percent_of_clock
)paren
id|count
op_increment
suffix:semicolon
)brace
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: %d throttling states&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_int
DECL|function|acpi_cpu_init
id|acpi_cpu_init
c_func
(paren
r_void
)paren
(brace
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_PROCESSOR
comma
id|ACPI_ROOT_OBJECT
comma
id|ACPI_UINT32_MAX
comma
id|acpi_find_cpu
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
id|smp_num_cpus
op_eq
l_int|1
)paren
id|pm_idle
op_assign
id|acpi_idle
suffix:semicolon
macro_line|#else
id|pm_idle
op_assign
id|acpi_idle
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
eof
