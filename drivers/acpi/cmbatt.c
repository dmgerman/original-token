multiline_comment|/*&n; *  cmbatt.c - Control Method Battery driver&n; *&n; *  Copyright (C) 2000 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
multiline_comment|/*&n; * Changes:&n; * Brendan Burns &lt;bburns@wso.williams.edu&gt; 2000-11-15&n; * - added proc battery interface&n; * - parse returned data from _BST and _BIF&n; * Andy Grover &lt;andrew.grover@intel.com&gt; 2000-12-8&n; * - improved proc interface&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;cmbatt&quot;
)paren
multiline_comment|/* ACPI-specific defines */
DECL|macro|ACPI_CMBATT_HID
mdefine_line|#define ACPI_CMBATT_HID&t;&t;&quot;PNP0C0A&quot;
DECL|macro|ACPI_BATT_PRESENT
mdefine_line|#define ACPI_BATT_PRESENT&t;0x10
DECL|macro|ACPI_BATT_UNKNOWN
mdefine_line|#define ACPI_BATT_UNKNOWN&t;0xFFFFFFFF
multiline_comment|/* driver-specific defines */
DECL|macro|MAX_CM_BATTERIES
mdefine_line|#define MAX_CM_BATTERIES&t;0x8
DECL|macro|MAX_BATT_STRLEN
mdefine_line|#define MAX_BATT_STRLEN&t;&t;0x20
DECL|struct|cmbatt_info
r_struct
id|cmbatt_info
(brace
DECL|member|power_unit
id|u32
id|power_unit
suffix:semicolon
DECL|member|design_capacity
id|u32
id|design_capacity
suffix:semicolon
DECL|member|last_full_capacity
id|u32
id|last_full_capacity
suffix:semicolon
DECL|member|battery_technology
id|u32
id|battery_technology
suffix:semicolon
DECL|member|design_voltage
id|u32
id|design_voltage
suffix:semicolon
DECL|member|design_capacity_warning
id|u32
id|design_capacity_warning
suffix:semicolon
DECL|member|design_capacity_low
id|u32
id|design_capacity_low
suffix:semicolon
DECL|member|battery_capacity_granularity_1
id|u32
id|battery_capacity_granularity_1
suffix:semicolon
DECL|member|battery_capacity_granularity_2
id|u32
id|battery_capacity_granularity_2
suffix:semicolon
DECL|member|model_number
r_char
id|model_number
(braket
id|MAX_BATT_STRLEN
)braket
suffix:semicolon
DECL|member|serial_number
r_char
id|serial_number
(braket
id|MAX_BATT_STRLEN
)braket
suffix:semicolon
DECL|member|battery_type
r_char
id|battery_type
(braket
id|MAX_BATT_STRLEN
)braket
suffix:semicolon
DECL|member|oem_info
r_char
id|oem_info
(braket
id|MAX_BATT_STRLEN
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|cmbatt_context
r_struct
id|cmbatt_context
(brace
DECL|member|is_present
id|u32
id|is_present
suffix:semicolon
DECL|member|handle
id|ACPI_HANDLE
id|handle
suffix:semicolon
DECL|member|UID
r_char
id|UID
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|power_unit
r_char
op_star
id|power_unit
suffix:semicolon
DECL|member|info
r_struct
id|cmbatt_info
id|info
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|cmbatt_status
r_struct
id|cmbatt_status
(brace
DECL|member|state
id|u32
id|state
suffix:semicolon
DECL|member|present_rate
id|u32
id|present_rate
suffix:semicolon
DECL|member|remaining_capacity
id|u32
id|remaining_capacity
suffix:semicolon
DECL|member|present_voltage
id|u32
id|present_voltage
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|batt_count
r_static
id|u32
id|batt_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|batt_list
r_static
r_struct
id|cmbatt_context
id|batt_list
(braket
id|MAX_CM_BATTERIES
)braket
suffix:semicolon
r_static
id|ACPI_STATUS
DECL|function|acpi_get_battery_status
id|acpi_get_battery_status
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
r_struct
id|cmbatt_status
op_star
id|result
)paren
(brace
id|ACPI_OBJECT
op_star
id|obj
suffix:semicolon
id|ACPI_OBJECT
op_star
id|objs
suffix:semicolon
id|ACPI_BUFFER
id|buf
suffix:semicolon
id|buf.length
op_assign
l_int|0
suffix:semicolon
id|buf.pointer
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* determine buffer length needed */
r_if
c_cond
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_BST&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
op_ne
id|AE_BUFFER_OVERFLOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: Could not get battery status struct length&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_NOT_FOUND
suffix:semicolon
)brace
id|buf.pointer
op_assign
id|kmalloc
c_func
(paren
id|buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf.pointer
)paren
r_return
id|AE_NO_MEMORY
suffix:semicolon
multiline_comment|/* get the data */
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_BST&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: Could not get battery status&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_NOT_FOUND
suffix:semicolon
)brace
id|obj
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|buf.pointer
suffix:semicolon
id|objs
op_assign
id|obj-&gt;package.elements
suffix:semicolon
id|result-&gt;state
op_assign
id|objs
(braket
l_int|0
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;present_rate
op_assign
id|objs
(braket
l_int|1
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;remaining_capacity
op_assign
id|objs
(braket
l_int|2
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;present_voltage
op_assign
id|objs
(braket
l_int|3
)braket
dot
id|number.value
suffix:semicolon
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|acpi_get_battery_info
id|acpi_get_battery_info
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
r_struct
id|cmbatt_info
op_star
id|result
)paren
(brace
id|ACPI_OBJECT
op_star
id|obj
suffix:semicolon
id|ACPI_OBJECT
op_star
id|objs
suffix:semicolon
id|ACPI_BUFFER
id|buf
suffix:semicolon
id|buf.length
op_assign
l_int|0
suffix:semicolon
id|buf.pointer
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* determine the length of the data */
r_if
c_cond
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_BIF&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
op_ne
id|AE_BUFFER_OVERFLOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: Could not get battery info struct length&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_NOT_FOUND
suffix:semicolon
)brace
id|buf.pointer
op_assign
id|kmalloc
c_func
(paren
id|buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf.pointer
)paren
r_return
id|AE_NO_MEMORY
suffix:semicolon
multiline_comment|/* get the data */
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_BIF&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: Could not get battery info&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_NOT_FOUND
suffix:semicolon
)brace
id|obj
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|buf.pointer
suffix:semicolon
id|objs
op_assign
id|obj-&gt;package.elements
suffix:semicolon
id|result-&gt;power_unit
op_assign
id|objs
(braket
l_int|0
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;design_capacity
op_assign
id|objs
(braket
l_int|1
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;last_full_capacity
op_assign
id|objs
(braket
l_int|2
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;battery_technology
op_assign
id|objs
(braket
l_int|3
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;design_voltage
op_assign
id|objs
(braket
l_int|4
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;design_capacity_warning
op_assign
id|objs
(braket
l_int|5
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;design_capacity_low
op_assign
id|objs
(braket
l_int|6
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;battery_capacity_granularity_1
op_assign
id|objs
(braket
l_int|7
)braket
dot
id|number.value
suffix:semicolon
id|result-&gt;battery_capacity_granularity_2
op_assign
id|objs
(braket
l_int|8
)braket
dot
id|number.value
suffix:semicolon
multiline_comment|/* BUG: trailing NULL issue */
id|strncpy
c_func
(paren
id|result-&gt;model_number
comma
id|objs
(braket
l_int|9
)braket
dot
id|string.pointer
comma
id|MAX_BATT_STRLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|result-&gt;serial_number
comma
id|objs
(braket
l_int|10
)braket
dot
id|string.pointer
comma
id|MAX_BATT_STRLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|result-&gt;battery_type
comma
id|objs
(braket
l_int|11
)braket
dot
id|string.pointer
comma
id|MAX_BATT_STRLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|result-&gt;oem_info
comma
id|objs
(braket
l_int|12
)braket
dot
id|string.pointer
comma
id|MAX_BATT_STRLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
multiline_comment|/*&n; * We found a device with the correct HID&n; */
r_static
id|ACPI_STATUS
DECL|function|acpi_found_cmbatt
id|acpi_found_cmbatt
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctx
comma
r_void
op_star
op_star
id|value
)paren
(brace
id|ACPI_DEVICE_INFO
id|info
suffix:semicolon
r_if
c_cond
(paren
id|batt_count
op_ge
id|MAX_CM_BATTERIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: MAX_CM_BATTERIES exceeded&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_object_info
c_func
(paren
id|handle
comma
op_amp
id|info
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: Could not get battery object info&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.valid
op_amp
id|ACPI_VALID_UID
)paren
(brace
id|strncpy
c_func
(paren
id|batt_list
(braket
id|batt_count
)braket
dot
id|UID
comma
id|info.unique_id
comma
l_int|9
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|batt_count
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Cmbatt: No UID but more than 1 battery&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info.valid
op_amp
id|ACPI_VALID_STA
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: Battery _STA invalid&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info.current_status
op_amp
id|ACPI_BATT_PRESENT
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cmbatt: Battery socket %d empty&bslash;n&quot;
comma
id|batt_count
)paren
suffix:semicolon
id|batt_list
(braket
id|batt_count
)braket
dot
id|is_present
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cmbatt: Battery socket %d occupied&bslash;n&quot;
comma
id|batt_count
)paren
suffix:semicolon
id|batt_list
(braket
id|batt_count
)braket
dot
id|is_present
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|acpi_get_battery_info
c_func
(paren
id|handle
comma
op_amp
id|batt_list
(braket
id|batt_count
)braket
dot
id|info
)paren
op_ne
id|AE_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acpi_get_battery_info failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|batt_list
(braket
id|batt_count
)braket
dot
id|power_unit
op_assign
(paren
id|batt_list
(braket
id|batt_count
)braket
dot
id|info.power_unit
)paren
ques
c_cond
l_string|&quot;mA&quot;
suffix:colon
l_string|&quot;mW&quot;
suffix:semicolon
)brace
id|batt_list
(braket
id|batt_count
)braket
dot
id|handle
op_assign
id|handle
suffix:semicolon
id|batt_count
op_increment
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_static
r_int
DECL|function|proc_read_batt_info
id|proc_read_batt_info
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cmbatt_info
op_star
id|info
suffix:semicolon
id|u32
id|batt_num
op_assign
(paren
id|u32
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
suffix:semicolon
id|info
op_assign
op_amp
id|batt_list
(braket
id|batt_num
)braket
dot
id|info
suffix:semicolon
multiline_comment|/* don&squot;t get info more than once for a single proc read */
r_if
c_cond
(paren
id|off
op_ne
l_int|0
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|batt_list
(braket
id|batt_num
)braket
dot
id|is_present
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;battery %d not present&bslash;n&quot;
comma
id|batt_num
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;last_full_capacity
op_eq
id|ACPI_BATT_UNKNOWN
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Unknown last full capacity&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Last Full Capacity %x %s /hr&bslash;n&quot;
comma
id|info-&gt;last_full_capacity
comma
id|batt_list
(braket
id|batt_num
)braket
dot
id|power_unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;design_capacity
op_eq
id|ACPI_BATT_UNKNOWN
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Unknown Design Capacity&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Design Capacity %x %s /hr&bslash;n&quot;
comma
id|info-&gt;design_capacity
comma
id|batt_list
(braket
id|batt_num
)braket
dot
id|power_unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;battery_technology
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Secondary Battery Technology&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Primary Battery Technology&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;design_voltage
op_eq
id|ACPI_BATT_UNKNOWN
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Unknown Design Voltage&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Design Voltage %x mV&bslash;n&quot;
comma
id|info-&gt;design_voltage
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Design Capacity Warning %d&bslash;n&quot;
comma
id|info-&gt;design_capacity_warning
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Design Capacity Low %d&bslash;n&quot;
comma
id|info-&gt;design_capacity_low
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery Capacity Granularity 1 %d&bslash;n&quot;
comma
id|info-&gt;battery_capacity_granularity_1
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery Capacity Granularity 2 %d&bslash;n&quot;
comma
id|info-&gt;battery_capacity_granularity_2
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;model number %s&bslash;nserial number %s&bslash;nbattery type %s&bslash;nOEM info %s&bslash;n&quot;
comma
id|info-&gt;model_number
comma
id|info-&gt;serial_number
comma
id|info-&gt;battery_type
comma
id|info-&gt;oem_info
)paren
suffix:semicolon
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
DECL|function|proc_read_batt_status
id|proc_read_batt_status
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cmbatt_status
id|status
suffix:semicolon
id|u32
id|batt_num
op_assign
(paren
id|u32
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* don&squot;t get status more than once for a single proc read */
r_if
c_cond
(paren
id|off
op_ne
l_int|0
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|batt_list
(braket
id|batt_num
)braket
dot
id|is_present
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;battery %d not present&bslash;n&quot;
comma
id|batt_num
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;getting batt status&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_get_battery_status
c_func
(paren
id|batt_list
(braket
id|batt_num
)braket
dot
id|handle
comma
op_amp
id|status
)paren
op_ne
id|AE_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cmbatt: acpi_get_battery_status failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Remaining Capacity: %x&bslash;n&quot;
comma
id|status.remaining_capacity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.state
op_amp
l_int|0x1
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery discharging&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.state
op_amp
l_int|0x2
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery charging&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.state
op_amp
l_int|0x4
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery critically low&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.present_rate
op_eq
id|ACPI_BATT_UNKNOWN
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery rate unknown&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery rate %x&bslash;n&quot;
comma
id|status.present_rate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.remaining_capacity
op_eq
id|ACPI_BATT_UNKNOWN
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery capacity unknown&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery capacity %x %s&bslash;n&quot;
comma
id|status.remaining_capacity
comma
id|batt_list
(braket
id|batt_num
)braket
dot
id|power_unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.present_voltage
op_eq
id|ACPI_BATT_UNKNOWN
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery voltage unknown&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery voltage %x volts&bslash;n&quot;
comma
id|status.present_voltage
)paren
suffix:semicolon
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_int
DECL|function|acpi_cmbatt_init
id|acpi_cmbatt_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|acpi_get_devices
c_func
(paren
id|ACPI_CMBATT_HID
comma
id|acpi_found_cmbatt
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|batt_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|batt_name
(braket
l_int|20
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|batt_name
comma
l_string|&quot;power/batt%d_info&quot;
comma
id|i
)paren
suffix:semicolon
id|create_proc_read_entry
c_func
(paren
id|batt_name
comma
l_int|0
comma
l_int|NULL
comma
id|proc_read_batt_info
comma
(paren
r_void
op_star
)paren
id|i
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|batt_name
comma
l_string|&quot;power/batt%d_status&quot;
comma
id|i
)paren
suffix:semicolon
id|create_proc_read_entry
c_func
(paren
id|batt_name
comma
l_int|0
comma
l_int|NULL
comma
id|proc_read_batt_status
comma
(paren
r_void
op_star
)paren
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|acpi_cmbatt_terminate
id|acpi_cmbatt_terminate
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|batt_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|batt_name
(braket
l_int|20
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|batt_name
comma
l_string|&quot;power/batt%d_info&quot;
comma
id|i
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|batt_name
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|batt_name
comma
l_string|&quot;power/batt%d_status&quot;
comma
id|i
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|batt_name
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
