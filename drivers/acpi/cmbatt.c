multiline_comment|/*&n; *  cmbatt.c - Control Method Battery driver&n; *&n; *  Copyright (C) 2000 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;cmbatt&quot;
)paren
DECL|macro|ACPI_CMBATT_HID
mdefine_line|#define ACPI_CMBATT_HID&t;&t;&quot;PNP0C0A&quot;
DECL|macro|ACPI_BATT_PRESENT
mdefine_line|#define ACPI_BATT_PRESENT&t;0x10
DECL|macro|ACPI_MAX_BATTERIES
mdefine_line|#define ACPI_MAX_BATTERIES&t;0x8
DECL|struct|cmbatt_context
r_struct
id|cmbatt_context
(brace
DECL|member|UID
r_char
id|UID
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|is_present
id|u8
id|is_present
suffix:semicolon
DECL|member|handle
id|ACPI_HANDLE
id|handle
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|cmbatt_status
r_struct
id|cmbatt_status
(brace
DECL|member|state
id|u32
id|state
suffix:semicolon
DECL|member|present_rate
id|u32
id|present_rate
suffix:semicolon
DECL|member|remaining_capacity
id|u32
id|remaining_capacity
suffix:semicolon
DECL|member|present_voltage
id|u32
id|present_voltage
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|batt_count
r_static
id|u32
id|batt_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|batt_list
r_static
r_struct
id|cmbatt_context
id|batt_list
(braket
id|ACPI_MAX_BATTERIES
)braket
suffix:semicolon
multiline_comment|/*&n; * We found a device with the correct HID&n; */
r_static
id|ACPI_STATUS
DECL|function|acpi_found_cmbatt
id|acpi_found_cmbatt
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctx
comma
r_void
op_star
op_star
id|value
)paren
(brace
id|ACPI_DEVICE_INFO
id|info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_object_info
c_func
(paren
id|handle
comma
op_amp
id|info
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not get battery object info&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.valid
op_amp
id|ACPI_VALID_UID
)paren
(brace
id|strncpy
c_func
(paren
id|batt_list
(braket
id|batt_count
)braket
dot
id|UID
comma
id|info.unique_id
comma
l_int|9
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|batt_count
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ACPI: No UID but more than 1 battery&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info.valid
op_amp
id|ACPI_VALID_STA
)paren
op_logical_and
(paren
id|info.current_status
op_amp
id|ACPI_BATT_PRESENT
)paren
)paren
(brace
id|ACPI_BUFFER
id|buf
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ACPI: Found a battery&bslash;n&quot;
)paren
suffix:semicolon
id|batt_list
(braket
id|batt_count
)braket
dot
id|is_present
op_assign
id|TRUE
suffix:semicolon
id|buf.length
op_assign
l_int|0
suffix:semicolon
id|buf.pointer
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* determine buffer length needed */
r_if
c_cond
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_BST&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
op_ne
id|AE_BUFFER_OVERFLOW
)paren
r_return
id|AE_OK
suffix:semicolon
id|buf.pointer
op_assign
id|kmalloc
c_func
(paren
id|buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf.pointer
)paren
r_return
id|AE_NO_MEMORY
suffix:semicolon
multiline_comment|/* get the data */
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_BST&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not get battery status&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
multiline_comment|/* TODO: parse the battery data */
multiline_comment|/* TODO: add proc interface */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ACPI: Found an empty battery socket&bslash;n&quot;
)paren
suffix:semicolon
id|batt_list
(braket
id|batt_count
)braket
dot
id|is_present
op_assign
id|FALSE
suffix:semicolon
)brace
id|batt_list
(braket
id|batt_count
)braket
dot
id|handle
op_assign
id|handle
suffix:semicolon
id|batt_count
op_increment
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_int
DECL|function|acpi_cmbatt_init
id|acpi_cmbatt_init
c_func
(paren
r_void
)paren
(brace
id|acpi_get_devices
c_func
(paren
id|ACPI_CMBATT_HID
comma
id|acpi_found_cmbatt
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|acpi_cmbatt_terminate
id|acpi_cmbatt_terminate
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* TODO */
multiline_comment|/* walk list of batteries */
multiline_comment|/* free their context and release resources */
r_return
l_int|0
suffix:semicolon
)brace
eof
