multiline_comment|/*&n; *  tables.c - ACPI tables, chipset, and errata handling&n; *&n; *  Copyright (C) 2000 Andrew Henroid&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|variable|acpi_facp
r_struct
id|acpi_facp
id|acpi_facp
suffix:semicolon
DECL|macro|ACPI_DUMMY_CHECKSUM
mdefine_line|#define ACPI_DUMMY_CHECKSUM 9
DECL|macro|ACPI_DUMMY_PBLK
mdefine_line|#define ACPI_DUMMY_PBLK 51
DECL|variable|acpi_dummy_dsdt
r_static
id|u8
id|acpi_dummy_dsdt
(braket
)braket
op_assign
(brace
l_int|0x44
comma
l_int|0x53
comma
l_int|0x44
comma
l_int|0x54
comma
singleline_comment|// &quot;DSDT&quot;
l_int|0x38
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// length
l_int|0x01
comma
singleline_comment|// revision
l_int|0x00
comma
singleline_comment|// checksum
l_int|0x4c
comma
l_int|0x49
comma
l_int|0x4e
comma
l_int|0x55
comma
l_int|0x58
comma
l_int|0x00
comma
singleline_comment|// &quot;LINUX&quot;
l_int|0x44
comma
l_int|0x55
comma
l_int|0x4d
comma
l_int|0x4d
comma
l_int|0x59
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// &quot;DUMMY&quot;
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// OEM rev
l_int|0x4c
comma
l_int|0x4e
comma
l_int|0x55
comma
l_int|0x58
comma
singleline_comment|// &quot;LNUX&quot;
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// creator rev
l_int|0x10
comma
singleline_comment|// Scope
l_int|0x13
comma
singleline_comment|//   PkgLength
l_int|0x5c
comma
l_int|0x5f
comma
l_int|0x50
comma
l_int|0x52
comma
l_int|0x5f
comma
singleline_comment|//   &bslash;_PR_
l_int|0x5b
comma
l_int|0x83
comma
singleline_comment|//   Processor
l_int|0x0b
comma
singleline_comment|//     PkgLength
l_int|0x43
comma
l_int|0x50
comma
l_int|0x55
comma
l_int|0x30
comma
singleline_comment|//     CPU0
l_int|0x00
comma
singleline_comment|//     ID
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|//     PBLK
l_int|0x06
singleline_comment|//     PBLK size
)brace
suffix:semicolon
multiline_comment|/*&n; * Calculate and set ACPI table checksum&n; */
r_static
r_void
DECL|function|acpi_set_checksum
id|acpi_set_checksum
c_func
(paren
id|u8
op_star
id|table
comma
r_int
id|size
)paren
(brace
r_int
id|i
comma
id|sum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
id|sum
op_add_assign
(paren
r_int
)paren
id|table
(braket
id|i
)braket
suffix:semicolon
id|sum
op_assign
(paren
l_int|0x100
op_minus
(paren
(paren
id|sum
op_minus
id|table
(braket
id|ACPI_DUMMY_CHECKSUM
)braket
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|table
(braket
id|ACPI_DUMMY_CHECKSUM
)braket
op_assign
id|sum
suffix:semicolon
)brace
multiline_comment|/*&n; * Init PIIX4 device, create a fake FACP&n; */
r_static
r_int
DECL|function|acpi_init_piix4
id|acpi_init_piix4
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u32
id|base
comma
id|pblk
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
id|u8
id|pmregmisc
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd
op_amp
id|PCI_COMMAND_IO
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|ACPI_PIIX4_PMREGMISC
comma
op_amp
id|pmregmisc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pmregmisc
op_amp
id|ACPI_PIIX4_PMIOSE
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|base
op_assign
id|pci_resource_start
(paren
id|dev
comma
id|PCI_BRIDGE_RESOURCES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: found &bslash;&quot;%s&bslash;&quot; at 0x%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|base
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|acpi_facp
comma
l_int|0
comma
r_sizeof
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
id|acpi_facp.hdr.signature
op_assign
id|ACPI_FACP_SIG
suffix:semicolon
id|acpi_facp.hdr.length
op_assign
r_sizeof
(paren
id|acpi_facp
)paren
suffix:semicolon
id|acpi_facp.int_model
op_assign
id|ACPI_PIIX4_INT_MODEL
suffix:semicolon
id|acpi_facp.sci_int
op_assign
id|ACPI_PIIX4_SCI_INT
suffix:semicolon
id|acpi_facp.smi_cmd
op_assign
id|ACPI_PIIX4_SMI_CMD
suffix:semicolon
id|acpi_facp.acpi_enable
op_assign
id|ACPI_PIIX4_ACPI_ENABLE
suffix:semicolon
id|acpi_facp.acpi_disable
op_assign
id|ACPI_PIIX4_ACPI_DISABLE
suffix:semicolon
id|acpi_facp.s4bios_req
op_assign
id|ACPI_PIIX4_S4BIOS_REQ
suffix:semicolon
id|acpi_facp.pm1a_evt
op_assign
id|base
op_plus
id|ACPI_PIIX4_PM1_EVT
suffix:semicolon
id|acpi_facp.pm1a_cnt
op_assign
id|base
op_plus
id|ACPI_PIIX4_PM1_CNT
suffix:semicolon
id|acpi_facp.pm2_cnt
op_assign
id|ACPI_PIIX4_PM2_CNT
suffix:semicolon
id|acpi_facp.pm_tmr
op_assign
id|base
op_plus
id|ACPI_PIIX4_PM_TMR
suffix:semicolon
id|acpi_facp.gpe0
op_assign
id|base
op_plus
id|ACPI_PIIX4_GPE0
suffix:semicolon
id|acpi_facp.pm1_evt_len
op_assign
id|ACPI_PIIX4_PM1_EVT_LEN
suffix:semicolon
id|acpi_facp.pm1_cnt_len
op_assign
id|ACPI_PIIX4_PM1_CNT_LEN
suffix:semicolon
id|acpi_facp.pm2_cnt_len
op_assign
id|ACPI_PIIX4_PM2_CNT_LEN
suffix:semicolon
id|acpi_facp.pm_tm_len
op_assign
id|ACPI_PIIX4_PM_TM_LEN
suffix:semicolon
id|acpi_facp.gpe0_len
op_assign
id|ACPI_PIIX4_GPE0_LEN
suffix:semicolon
id|acpi_facp.p_lvl2_lat
op_assign
(paren
id|__u16
)paren
id|ACPI_INFINITE_LAT
suffix:semicolon
id|acpi_facp.p_lvl3_lat
op_assign
(paren
id|__u16
)paren
id|ACPI_INFINITE_LAT
suffix:semicolon
id|acpi_set_checksum
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|acpi_facp
comma
r_sizeof
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
id|acpi_load_table
c_func
(paren
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
op_amp
id|acpi_facp
)paren
suffix:semicolon
id|pblk
op_assign
id|base
op_plus
id|ACPI_PIIX4_P_BLK
suffix:semicolon
id|memcpy
c_func
(paren
id|acpi_dummy_dsdt
op_plus
id|ACPI_DUMMY_PBLK
comma
op_amp
id|pblk
comma
r_sizeof
(paren
id|pblk
)paren
)paren
suffix:semicolon
id|acpi_set_checksum
c_func
(paren
id|acpi_dummy_dsdt
comma
r_sizeof
(paren
id|acpi_dummy_dsdt
)paren
)paren
suffix:semicolon
id|acpi_load_table
c_func
(paren
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|acpi_dummy_dsdt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Init VIA ACPI device and create a fake FACP&n; */
r_static
r_int
DECL|function|acpi_init_via
id|acpi_init_via
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u32
id|base
comma
id|pblk
suffix:semicolon
id|u8
id|tmp
comma
id|irq
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
id|PCI_BRIDGE_RESOURCES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x42
comma
op_amp
id|irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: found &bslash;&quot;%s&bslash;&quot; at 0x%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|base
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|acpi_facp
comma
l_int|0
comma
r_sizeof
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
id|acpi_facp.hdr.signature
op_assign
id|ACPI_FACP_SIG
suffix:semicolon
id|acpi_facp.hdr.length
op_assign
r_sizeof
(paren
id|acpi_facp
)paren
suffix:semicolon
id|acpi_facp.int_model
op_assign
id|ACPI_VIA_INT_MODEL
suffix:semicolon
id|acpi_facp.sci_int
op_assign
id|irq
suffix:semicolon
id|acpi_facp.smi_cmd
op_assign
id|base
op_plus
id|ACPI_VIA_SMI_CMD
suffix:semicolon
id|acpi_facp.acpi_enable
op_assign
id|ACPI_VIA_ACPI_ENABLE
suffix:semicolon
id|acpi_facp.acpi_disable
op_assign
id|ACPI_VIA_ACPI_DISABLE
suffix:semicolon
id|acpi_facp.pm1a_evt
op_assign
id|base
op_plus
id|ACPI_VIA_PM1_EVT
suffix:semicolon
id|acpi_facp.pm1a_cnt
op_assign
id|base
op_plus
id|ACPI_VIA_PM1_CNT
suffix:semicolon
id|acpi_facp.pm_tmr
op_assign
id|base
op_plus
id|ACPI_VIA_PM_TMR
suffix:semicolon
id|acpi_facp.gpe0
op_assign
id|base
op_plus
id|ACPI_VIA_GPE0
suffix:semicolon
id|acpi_facp.pm1_evt_len
op_assign
id|ACPI_VIA_PM1_EVT_LEN
suffix:semicolon
id|acpi_facp.pm1_cnt_len
op_assign
id|ACPI_VIA_PM1_CNT_LEN
suffix:semicolon
id|acpi_facp.pm_tm_len
op_assign
id|ACPI_VIA_PM_TM_LEN
suffix:semicolon
id|acpi_facp.gpe0_len
op_assign
id|ACPI_VIA_GPE0_LEN
suffix:semicolon
id|acpi_facp.p_lvl2_lat
op_assign
(paren
id|__u16
)paren
id|ACPI_INFINITE_LAT
suffix:semicolon
id|acpi_facp.p_lvl3_lat
op_assign
(paren
id|__u16
)paren
id|ACPI_INFINITE_LAT
suffix:semicolon
id|acpi_facp.duty_offset
op_assign
id|ACPI_VIA_DUTY_OFFSET
suffix:semicolon
id|acpi_facp.duty_width
op_assign
id|ACPI_VIA_DUTY_WIDTH
suffix:semicolon
id|acpi_facp.day_alarm
op_assign
id|ACPI_VIA_DAY_ALARM
suffix:semicolon
id|acpi_facp.mon_alarm
op_assign
id|ACPI_VIA_MON_ALARM
suffix:semicolon
id|acpi_facp.century
op_assign
id|ACPI_VIA_CENTURY
suffix:semicolon
id|acpi_set_checksum
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|acpi_facp
comma
r_sizeof
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
id|acpi_load_table
c_func
(paren
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
op_amp
id|acpi_facp
)paren
suffix:semicolon
id|pblk
op_assign
id|base
op_plus
id|ACPI_VIA_P_BLK
suffix:semicolon
id|memcpy
c_func
(paren
id|acpi_dummy_dsdt
op_plus
id|ACPI_DUMMY_PBLK
comma
op_amp
id|pblk
comma
r_sizeof
(paren
id|pblk
)paren
)paren
suffix:semicolon
id|acpi_set_checksum
c_func
(paren
id|acpi_dummy_dsdt
comma
r_sizeof
(paren
id|acpi_dummy_dsdt
)paren
)paren
suffix:semicolon
id|acpi_load_table
c_func
(paren
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|acpi_dummy_dsdt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_typedef
r_enum
(brace
DECL|enumerator|CH_UNKNOWN
id|CH_UNKNOWN
op_assign
l_int|0
comma
DECL|enumerator|CH_INTEL_PIIX4
id|CH_INTEL_PIIX4
comma
DECL|enumerator|CH_VIA_586
id|CH_VIA_586
comma
DECL|enumerator|CH_VIA_686A
id|CH_VIA_686A
comma
DECL|typedef|acpi_chip_t
)brace
id|acpi_chip_t
suffix:semicolon
multiline_comment|/* indexed by value of each enum in acpi_chip_t */
r_const
r_static
r_struct
(brace
DECL|member|chip_init
r_int
(paren
op_star
id|chip_init
)paren
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|acpi_chip_info
)brace
id|acpi_chip_info
(braket
)braket
op_assign
(brace
(brace
l_int|NULL
comma
)brace
comma
(brace
id|acpi_init_piix4
)brace
comma
(brace
id|acpi_init_via
)brace
comma
(brace
id|acpi_init_via
)brace
comma
)brace
suffix:semicolon
DECL|variable|acpi_pci_tbl
r_static
r_struct
id|pci_device_id
id|acpi_pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_int|0x8086
comma
l_int|0x7113
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_INTEL_PIIX4
)brace
comma
(brace
l_int|0x1106
comma
l_int|0x3040
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_VIA_586
)brace
comma
(brace
l_int|0x1106
comma
l_int|0x3057
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_VIA_686A
)brace
comma
(brace
l_int|0
comma
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
r_static
r_int
DECL|function|acpi_probe
id|acpi_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_return
id|acpi_chip_info
(braket
id|id-&gt;driver_data
)braket
dot
id|chip_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|acpi_driver
r_static
r_struct
id|pci_driver
id|acpi_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;acpi&quot;
comma
id|id_table
suffix:colon
id|acpi_pci_tbl
comma
id|probe
suffix:colon
id|acpi_probe
comma
)brace
suffix:semicolon
DECL|variable|acpi_driver_registered
r_static
r_int
id|acpi_driver_registered
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Locate a known ACPI chipset&n; */
r_static
r_int
DECL|function|acpi_find_chipset
id|acpi_find_chipset
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pci_register_driver
c_func
(paren
op_amp
id|acpi_driver
)paren
OL
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|acpi_driver_registered
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Fetch the FACP information&n; */
r_static
r_int
DECL|function|acpi_fetch_facp
id|acpi_fetch_facp
c_func
(paren
r_void
)paren
(brace
id|ACPI_BUFFER
id|buffer
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|acpi_facp
comma
l_int|0
comma
r_sizeof
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
id|buffer.pointer
op_assign
op_amp
id|acpi_facp
suffix:semicolon
id|buffer.length
op_assign
r_sizeof
(paren
id|acpi_facp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_table
c_func
(paren
id|ACPI_TABLE_FACP
comma
l_int|1
comma
op_amp
id|buffer
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: missing FACP&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_facp.p_lvl2_lat
op_logical_and
id|acpi_facp.p_lvl2_lat
op_le
id|ACPI_MAX_P_LVL2_LAT
)paren
(brace
id|acpi_c2_exit_latency
op_assign
id|ACPI_uS_TO_TMR_TICKS
c_func
(paren
id|acpi_facp.p_lvl2_lat
)paren
suffix:semicolon
id|acpi_c2_enter_latency
op_assign
id|ACPI_uS_TO_TMR_TICKS
c_func
(paren
id|ACPI_TMR_HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_facp.p_lvl3_lat
op_logical_and
id|acpi_facp.p_lvl3_lat
op_le
id|ACPI_MAX_P_LVL3_LAT
)paren
(brace
id|acpi_c3_exit_latency
op_assign
id|ACPI_uS_TO_TMR_TICKS
c_func
(paren
id|acpi_facp.p_lvl3_lat
)paren
suffix:semicolon
id|acpi_c3_enter_latency
op_assign
id|ACPI_uS_TO_TMR_TICKS
c_func
(paren
id|acpi_facp.p_lvl3_lat
op_star
l_int|5
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Find and load ACPI tables&n; */
r_int
DECL|function|acpi_load_tables
id|acpi_load_tables
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_load_firmware_tables
c_func
(paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: support found&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acpi_find_chipset
c_func
(paren
)paren
)paren
(brace
id|acpi_terminate
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_fetch_facp
c_func
(paren
)paren
)paren
(brace
id|acpi_terminate
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_load_namespace
c_func
(paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: namespace load failed&bslash;n&quot;
)paren
suffix:semicolon
id|acpi_terminate
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
