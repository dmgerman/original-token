multiline_comment|/******************************************************************************&n; *&n; * Module Name: amfield - ACPI AML (p-code) execution - field manipulation&n; *              $Revision: 74 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acdispat.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;achware.h&quot;
macro_line|#include &quot;acevents.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          INTERPRETER
id|MODULE_NAME
(paren
l_string|&quot;amfield&quot;
)paren
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_setup_field&n; *&n; * PARAMETERS:  *Obj_desc           - Field to be read or written&n; *              *Rgn_desc           - Region containing field&n; *              Field_bit_width     - Field Width in bits (8, 16, or 32)&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Common processing for Acpi_aml_read_field and Acpi_aml_write_field&n; *&n; *  ACPI SPECIFICATION REFERENCES:&n; *  Each of the Type1_opcodes is defined as specified in in-line&n; *  comments below. For each one, use the following definitions.&n; *&n; *  Def_bit_field   :=  Bit_field_op    Src_buf Bit_idx Destination&n; *  Def_byte_field  :=  Byte_field_op   Src_buf Byte_idx Destination&n; *  Def_create_field := Create_field_op Src_buf Bit_idx Num_bits Name_string&n; *  Def_dWord_field :=  DWord_field_op  Src_buf Byte_idx Destination&n; *  Def_word_field  :=  Word_field_op   Src_buf Byte_idx Destination&n; *  Bit_index       :=  Term_arg=&gt;Integer&n; *  Byte_index      :=  Term_arg=&gt;Integer&n; *  Destination     :=  Name_string&n; *  Num_bits        :=  Term_arg=&gt;Integer&n; *  Source_buf      :=  Term_arg=&gt;Buffer&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_aml_setup_field
id|acpi_aml_setup_field
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|obj_desc
comma
id|ACPI_OPERAND_OBJECT
op_star
id|rgn_desc
comma
id|u32
id|field_bit_width
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u32
id|field_byte_width
suffix:semicolon
multiline_comment|/* Parameter validation */
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
op_logical_or
op_logical_neg
id|rgn_desc
)paren
(brace
r_return
(paren
id|AE_AML_NO_OPERAND
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ACPI_TYPE_REGION
op_ne
id|rgn_desc-&gt;common.type
)paren
(brace
r_return
(paren
id|AE_AML_OPERAND_TYPE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * TBD: [Future] Acpi 2.0 supports Qword fields&n;&t; *&n;&t; * Init and validate Field width&n;&t; * Possible values are 1, 2, 4&n;&t; */
id|field_byte_width
op_assign
id|DIV_8
(paren
id|field_bit_width
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|field_bit_width
op_ne
l_int|8
)paren
op_logical_and
(paren
id|field_bit_width
op_ne
l_int|16
)paren
op_logical_and
(paren
id|field_bit_width
op_ne
l_int|32
)paren
)paren
(brace
r_return
(paren
id|AE_AML_OPERAND_VALUE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If the Region Address and Length have not been previously evaluated,&n;&t; * evaluate them and save the results.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|rgn_desc-&gt;region.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
)paren
(brace
id|status
op_assign
id|acpi_ds_get_region_arguments
(paren
id|rgn_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|obj_desc-&gt;common.type
op_eq
id|ACPI_TYPE_FIELD_UNIT
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|obj_desc-&gt;common.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Field Buffer and Index have not been previously evaluated,&n;&t;&t; */
r_return
(paren
id|AE_AML_INTERNAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rgn_desc-&gt;region.length
OL
(paren
id|obj_desc-&gt;field.offset
op_amp
op_complement
(paren
(paren
id|u32
)paren
id|field_byte_width
op_minus
l_int|1
)paren
)paren
op_plus
id|field_byte_width
)paren
(brace
multiline_comment|/*&n;&t;&t; * Offset rounded up to next multiple of field width&n;&t;&t; * exceeds region length, indicate an error&n;&t;&t; */
r_return
(paren
id|AE_AML_REGION_LIMIT
)paren
suffix:semicolon
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_access_named_field&n; *&n; * PARAMETERS:  Mode                - ACPI_READ or ACPI_WRITE&n; *              Named_field         - Handle for field to be accessed&n; *              *Buffer             - Value(s) to be read or written&n; *              Buffer_length         - Number of bytes to transfer&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Read or write a named field&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_aml_access_named_field
id|acpi_aml_access_named_field
(paren
id|u32
id|mode
comma
id|ACPI_HANDLE
id|named_field
comma
r_void
op_star
id|buffer
comma
id|u32
id|buffer_length
)paren
(brace
id|ACPI_OPERAND_OBJECT
op_star
id|obj_desc
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u8
id|locked
op_assign
id|FALSE
suffix:semicolon
id|u32
id|bit_granularity
op_assign
l_int|0
suffix:semicolon
id|u32
id|byte_granularity
suffix:semicolon
id|u32
id|datum_length
suffix:semicolon
id|u32
id|actual_byte_length
suffix:semicolon
id|u32
id|byte_field_length
suffix:semicolon
multiline_comment|/* Basic data checking */
r_if
c_cond
(paren
(paren
op_logical_neg
id|named_field
)paren
op_logical_or
(paren
id|ACPI_READ
op_eq
id|mode
op_logical_and
op_logical_neg
id|buffer
)paren
)paren
(brace
r_return
(paren
id|AE_AML_INTERNAL
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the attached field object */
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|named_field
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
r_return
(paren
id|AE_AML_INTERNAL
)paren
suffix:semicolon
)brace
multiline_comment|/* Check the type */
r_if
c_cond
(paren
id|INTERNAL_TYPE_DEF_FIELD
op_ne
id|acpi_ns_get_type
(paren
id|named_field
)paren
)paren
(brace
r_return
(paren
id|AE_AML_OPERAND_TYPE
)paren
suffix:semicolon
)brace
multiline_comment|/* Obj_desc valid and Named_field is a defined field */
multiline_comment|/* Double-check that the attached object is also a field */
r_if
c_cond
(paren
id|INTERNAL_TYPE_DEF_FIELD
op_ne
id|obj_desc-&gt;common.type
)paren
(brace
r_return
(paren
id|AE_AML_OPERAND_TYPE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Granularity was decoded from the field access type&n;&t; * (Any_acc will be the same as Byte_acc)&n;&t; */
id|bit_granularity
op_assign
id|obj_desc-&gt;field_unit.granularity
suffix:semicolon
id|byte_granularity
op_assign
id|DIV_8
(paren
id|bit_granularity
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check if request is too large for the field, and silently truncate&n;&t; * if necessary&n;&t; */
multiline_comment|/* TBD: [Errors] should an error be returned in this case? */
id|byte_field_length
op_assign
(paren
id|u32
)paren
id|DIV_8
(paren
id|obj_desc-&gt;field_unit.length
op_plus
l_int|7
)paren
suffix:semicolon
id|actual_byte_length
op_assign
id|buffer_length
suffix:semicolon
r_if
c_cond
(paren
id|buffer_length
OG
id|byte_field_length
)paren
(brace
id|actual_byte_length
op_assign
id|byte_field_length
suffix:semicolon
)brace
multiline_comment|/* TBD: should these round down to a power of 2? */
r_if
c_cond
(paren
id|DIV_8
c_func
(paren
id|bit_granularity
)paren
OG
id|byte_field_length
)paren
(brace
id|bit_granularity
op_assign
id|MUL_8
c_func
(paren
id|byte_field_length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|byte_granularity
OG
id|byte_field_length
)paren
(brace
id|byte_granularity
op_assign
id|byte_field_length
suffix:semicolon
)brace
multiline_comment|/* Convert byte count to datum count, round up if necessary */
id|datum_length
op_assign
(paren
id|actual_byte_length
op_plus
(paren
id|byte_granularity
op_minus
l_int|1
)paren
)paren
op_div
id|byte_granularity
suffix:semicolon
multiline_comment|/* Get the global lock if needed */
id|locked
op_assign
id|acpi_aml_acquire_global_lock
(paren
id|obj_desc-&gt;field_unit.lock_rule
)paren
suffix:semicolon
multiline_comment|/* Perform the actual read or write of the buffer */
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|ACPI_READ
suffix:colon
id|status
op_assign
id|acpi_aml_read_field
(paren
id|obj_desc
comma
id|buffer
comma
id|buffer_length
comma
id|actual_byte_length
comma
id|datum_length
comma
id|bit_granularity
comma
id|byte_granularity
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_WRITE
suffix:colon
id|status
op_assign
id|acpi_aml_write_field
(paren
id|obj_desc
comma
id|buffer
comma
id|buffer_length
comma
id|actual_byte_length
comma
id|datum_length
comma
id|bit_granularity
comma
id|byte_granularity
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
id|AE_BAD_PARAMETER
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Release global lock if we acquired it earlier */
id|acpi_aml_release_global_lock
(paren
id|locked
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
eof
