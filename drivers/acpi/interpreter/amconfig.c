multiline_comment|/******************************************************************************&n; *&n; * Module Name: amconfig - Namespace reconfiguration (Load/Unload opcodes)&n; *              $Revision: 26 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acparser.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;acevents.h&quot;
macro_line|#include &quot;actables.h&quot;
macro_line|#include &quot;acdispat.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          INTERPRETER
id|MODULE_NAME
(paren
l_string|&quot;amconfig&quot;
)paren
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_exec_load_table&n; *&n; * PARAMETERS:  Rgn_desc        - Op region where the table will be obtained&n; *              Ddb_handle      - Where a handle to the table will be returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Load an ACPI table&n; *&n; ****************************************************************************/
r_static
id|ACPI_STATUS
DECL|function|acpi_aml_exec_load_table
id|acpi_aml_exec_load_table
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|rgn_desc
comma
id|ACPI_HANDLE
op_star
id|ddb_handle
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_OPERAND_OBJECT
op_star
id|table_desc
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|table_ptr
suffix:semicolon
id|u8
op_star
id|table_data_ptr
suffix:semicolon
id|ACPI_TABLE_HEADER
id|table_header
suffix:semicolon
id|ACPI_TABLE_DESC
id|table_info
suffix:semicolon
id|u32
id|i
suffix:semicolon
multiline_comment|/* TBD: [Unhandled] Object can be either a field or an opregion */
multiline_comment|/* Get the table header */
id|table_header.length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ACPI_TABLE_HEADER
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|acpi_ev_address_space_dispatch
(paren
id|rgn_desc
comma
id|ADDRESS_SPACE_READ
comma
id|i
comma
l_int|8
comma
(paren
id|u32
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
op_amp
id|table_header
op_plus
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Allocate a buffer for the entire table */
id|table_ptr
op_assign
id|acpi_cm_allocate
(paren
id|table_header.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|table_ptr
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy the header to the buffer */
id|MEMCPY
(paren
id|table_ptr
comma
op_amp
id|table_header
comma
r_sizeof
(paren
id|ACPI_TABLE_HEADER
)paren
)paren
suffix:semicolon
id|table_data_ptr
op_assign
id|table_ptr
op_plus
r_sizeof
(paren
id|ACPI_TABLE_HEADER
)paren
suffix:semicolon
multiline_comment|/* Get the table from the op region */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|table_header.length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|acpi_ev_address_space_dispatch
(paren
id|rgn_desc
comma
id|ADDRESS_SPACE_READ
comma
id|i
comma
l_int|8
comma
(paren
id|u32
op_star
)paren
(paren
id|table_data_ptr
op_plus
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
multiline_comment|/* Table must be either an SSDT or a PSDT */
r_if
c_cond
(paren
(paren
op_logical_neg
id|STRNCMP
(paren
id|table_header.signature
comma
id|acpi_gbl_acpi_table_data
(braket
id|ACPI_TABLE_PSDT
)braket
dot
id|signature
comma
id|acpi_gbl_acpi_table_data
(braket
id|ACPI_TABLE_PSDT
)braket
dot
id|sig_length
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|STRNCMP
(paren
id|table_header.signature
comma
id|acpi_gbl_acpi_table_data
(braket
id|ACPI_TABLE_SSDT
)braket
dot
id|signature
comma
id|acpi_gbl_acpi_table_data
(braket
id|ACPI_TABLE_SSDT
)braket
dot
id|sig_length
)paren
)paren
)paren
(brace
id|status
op_assign
id|AE_BAD_SIGNATURE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Create an object to be the table handle */
id|table_desc
op_assign
id|acpi_cm_create_internal_object
(paren
id|INTERNAL_TYPE_REFERENCE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|table_desc
)paren
(brace
id|status
op_assign
id|AE_NO_MEMORY
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Install the new table into the local data structures */
id|table_info.pointer
op_assign
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|table_ptr
suffix:semicolon
id|table_info.length
op_assign
id|table_header.length
suffix:semicolon
id|table_info.allocation
op_assign
id|ACPI_MEM_ALLOCATED
suffix:semicolon
id|table_info.base_pointer
op_assign
id|table_ptr
suffix:semicolon
id|status
op_assign
id|acpi_tb_install_table
(paren
l_int|NULL
comma
op_amp
id|table_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Add the table to the namespace */
multiline_comment|/* TBD: [Restructure] - change to whatever new interface is appropriate */
multiline_comment|/*&n;&t;Status = Acpi_load_namespace ();&n;&t;if (ACPI_FAILURE (Status)) {&n;*/
multiline_comment|/* TBD: [Errors] Unload the table on failure ? */
multiline_comment|/*&n;&t;&t;goto Cleanup;&n;&t;}&n;*/
multiline_comment|/* TBD: [Investigate] we need a pointer to the table desc */
multiline_comment|/* Init the table handle */
id|table_desc-&gt;reference.op_code
op_assign
id|AML_LOAD_OP
suffix:semicolon
id|table_desc-&gt;reference.object
op_assign
id|table_info.installed_desc
suffix:semicolon
op_star
id|ddb_handle
op_assign
id|table_desc
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
id|cleanup
suffix:colon
id|acpi_cm_free
(paren
id|table_desc
)paren
suffix:semicolon
id|acpi_cm_free
(paren
id|table_ptr
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_exec_unload_table&n; *&n; * PARAMETERS:  Ddb_handle          - Handle to a previously loaded table&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Unload an ACPI table&n; *&n; ****************************************************************************/
r_static
id|ACPI_STATUS
DECL|function|acpi_aml_exec_unload_table
id|acpi_aml_exec_unload_table
(paren
id|ACPI_HANDLE
id|ddb_handle
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_NOT_IMPLEMENTED
suffix:semicolon
id|ACPI_OPERAND_OBJECT
op_star
id|table_desc
op_assign
(paren
id|ACPI_OPERAND_OBJECT
op_star
)paren
id|ddb_handle
suffix:semicolon
id|ACPI_TABLE_DESC
op_star
id|table_info
suffix:semicolon
multiline_comment|/* Validate the handle */
multiline_comment|/* Although the handle is partially validated in Acpi_aml_exec_reconfiguration(),&n;&t; *  when it calls Acpi_aml_resolve_operands(), the handle is more completely&n;&t; *  validated here.&n;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|ddb_handle
)paren
op_logical_or
(paren
op_logical_neg
id|VALID_DESCRIPTOR_TYPE
(paren
id|ddb_handle
comma
id|ACPI_DESC_TYPE_INTERNAL
)paren
)paren
op_logical_or
(paren
(paren
(paren
id|ACPI_OPERAND_OBJECT
op_star
)paren
id|ddb_handle
)paren
op_member_access_from_pointer
id|common.type
op_ne
id|INTERNAL_TYPE_REFERENCE
)paren
)paren
(brace
r_return
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the actual table descriptor from the Ddb_handle */
id|table_info
op_assign
(paren
id|ACPI_TABLE_DESC
op_star
)paren
id|table_desc-&gt;reference.object
suffix:semicolon
multiline_comment|/*&n;&t; * Delete the entire namespace under this table Node&n;&t; * (Offset contains the Table_id)&n;&t; */
id|status
op_assign
id|acpi_ns_delete_namespace_by_owner
(paren
id|table_info-&gt;table_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Delete the table itself */
id|acpi_tb_uninstall_table
(paren
id|table_info-&gt;installed_desc
)paren
suffix:semicolon
multiline_comment|/* Delete the table descriptor (Ddb_handle) */
id|acpi_cm_remove_reference
(paren
id|table_desc
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_exec_reconfiguration&n; *&n; * PARAMETERS:  Opcode              - The opcode to be executed&n; *              Walk_state          - Current state of the parse tree walk&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Reconfiguration opcodes such as LOAD and UNLOAD&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_aml_exec_reconfiguration
id|acpi_aml_exec_reconfiguration
(paren
id|u16
id|opcode
comma
id|ACPI_WALK_STATE
op_star
id|walk_state
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_OPERAND_OBJECT
op_star
id|region_desc
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_HANDLE
op_star
id|ddb_handle
suffix:semicolon
multiline_comment|/* Resolve the operands */
id|status
op_assign
id|acpi_aml_resolve_operands
(paren
id|opcode
comma
id|WALK_OPERANDS
comma
id|walk_state
)paren
suffix:semicolon
multiline_comment|/* Get the table handle, common for both opcodes */
id|status
op_or_assign
id|acpi_ds_obj_stack_pop_object
(paren
(paren
id|ACPI_OPERAND_OBJECT
op_star
op_star
)paren
op_amp
id|ddb_handle
comma
id|walk_state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|AML_LOAD_OP
suffix:colon
multiline_comment|/* Get the region or field descriptor */
id|status
op_or_assign
id|acpi_ds_obj_stack_pop_object
(paren
op_amp
id|region_desc
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_cm_remove_reference
(paren
id|region_desc
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_aml_exec_load_table
(paren
id|region_desc
comma
id|ddb_handle
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_UNLOAD_OP
suffix:colon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_aml_exec_unload_table
(paren
id|ddb_handle
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
id|AE_AML_BAD_OPCODE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
eof
