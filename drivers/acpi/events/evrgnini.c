multiline_comment|/******************************************************************************&n; *&n; * Module Name: evrgnini- ACPI Address_space / Op_region init&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;events.h&quot;
macro_line|#include &quot;namesp.h&quot;
macro_line|#include &quot;interp.h&quot;
macro_line|#include &quot;amlcode.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          EVENT_HANDLING
id|MODULE_NAME
(paren
l_string|&quot;evrgnini&quot;
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_system_memory_region_setup&n; *&n; * PARAMETERS:  Region_obj          - region we are interested in&n; *              Function            - start or stop&n; *              Handler_context     - Address space handler context&n; *              Returned context    - context to be used with each call to the&n; *                                    handler for this region&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling, a nop for now&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ev_system_memory_region_setup
id|acpi_ev_system_memory_region_setup
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|return_context
)paren
(brace
id|MEM_HANDLER_CONTEXT
op_star
id|mem_context
suffix:semicolon
id|ACPI_OBJECT_INTERNAL
op_star
id|region_obj
op_assign
(paren
id|ACPI_OBJECT_INTERNAL
op_star
)paren
id|handle
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
id|region_obj-&gt;region.region_flags
op_and_assign
op_complement
(paren
id|REGION_INITIALIZED
)paren
suffix:semicolon
op_star
id|return_context
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|handler_context
)paren
(brace
id|mem_context
op_assign
id|handler_context
suffix:semicolon
op_star
id|return_context
op_assign
id|mem_context-&gt;handler_context
suffix:semicolon
id|acpi_cm_free
(paren
id|mem_context
)paren
suffix:semicolon
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Activate.  Create a new context */
id|mem_context
op_assign
id|acpi_cm_callocate
(paren
r_sizeof
(paren
id|MEM_HANDLER_CONTEXT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_context
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Init.  (Mapping fields are all set to zeros above) */
id|mem_context-&gt;handler_context
op_assign
id|handler_context
suffix:semicolon
id|region_obj-&gt;region.region_flags
op_or_assign
id|REGION_INITIALIZED
suffix:semicolon
op_star
id|return_context
op_assign
id|mem_context
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_io_space_region_setup&n; *&n; * PARAMETERS:  Region_obj          - region we are interested in&n; *              Function            - start or stop&n; *              Handler_context     - Address space handler context&n; *              Returned context    - context to be used with each call to the&n; *                                    handler for this region&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ev_io_space_region_setup
id|acpi_ev_io_space_region_setup
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|return_context
)paren
(brace
id|ACPI_OBJECT_INTERNAL
op_star
id|region_obj
op_assign
(paren
id|ACPI_OBJECT_INTERNAL
op_star
)paren
id|handle
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
id|region_obj-&gt;region.region_flags
op_and_assign
op_complement
(paren
id|REGION_INITIALIZED
)paren
suffix:semicolon
op_star
id|return_context
op_assign
id|handler_context
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Activate the region */
id|region_obj-&gt;region.region_flags
op_or_assign
id|REGION_INITIALIZED
suffix:semicolon
op_star
id|return_context
op_assign
id|handler_context
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_pci_config_region_setup&n; *&n; * PARAMETERS:  Region_obj          - region we are interested in&n; *              Function            - start or stop&n; *              Handler_context     - Address space handler context&n; *              Returned context    - context to be used with each call to the&n; *                                    handler for this region&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; * MUTEX:       Assumes namespace is locked&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ev_pci_config_region_setup
id|acpi_ev_pci_config_region_setup
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|return_context
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u32
id|temp
suffix:semicolon
id|PCI_HANDLER_CONTEXT
op_star
id|pci_context
suffix:semicolon
id|ACPI_OBJECT_INTERNAL
op_star
id|handler_obj
suffix:semicolon
id|ACPI_NAMED_OBJECT
op_star
id|search_scope
suffix:semicolon
id|ACPI_OBJECT_INTERNAL
op_star
id|region_obj
op_assign
(paren
id|ACPI_OBJECT_INTERNAL
op_star
)paren
id|handle
suffix:semicolon
id|handler_obj
op_assign
id|region_obj-&gt;region.addr_handler
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|handler_obj
)paren
(brace
multiline_comment|/*&n;&t;&t; *  No installed handler. This shouldn&squot;t happen because the dispatch&n;&t;&t; *  routine checks before we get here, but we check again just in case.&n;&t;&t; */
r_return
id|AE_EXIST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
id|region_obj-&gt;region.region_flags
op_and_assign
op_complement
(paren
id|REGION_INITIALIZED
)paren
suffix:semicolon
op_star
id|return_context
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|handler_context
)paren
(brace
id|pci_context
op_assign
id|handler_context
suffix:semicolon
op_star
id|return_context
op_assign
id|pci_context-&gt;handler_context
suffix:semicolon
id|acpi_cm_free
(paren
id|pci_context
)paren
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Create a new context */
id|pci_context
op_assign
id|acpi_cm_allocate
(paren
r_sizeof
(paren
id|PCI_HANDLER_CONTEXT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_context
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  For PCI Config space access, we have to pass the segment, bus,&n;&t; *  device and function numbers.  This routine must acquire those.&n;&t; */
multiline_comment|/*&n;&t; *  First get device and function numbers from the _ADR object&n;&t; *  in the parent&squot;s scope.&n;&t; */
id|ACPI_ASSERT
c_func
(paren
id|region_obj-&gt;region.nte
)paren
suffix:semicolon
id|search_scope
op_assign
id|acpi_ns_get_parent_entry
(paren
id|region_obj-&gt;region.nte
)paren
suffix:semicolon
id|acpi_cm_release_mutex
(paren
id|ACPI_MTX_NAMESPACE
)paren
suffix:semicolon
multiline_comment|/* Acpi_evaluate the _ADR object */
id|status
op_assign
id|acpi_cm_evaluate_numeric_object
(paren
id|METHOD_NAME__ADR
comma
id|search_scope
comma
op_amp
id|temp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  The default is zero, since the allocation above zeroed the data, just&n;&t; *  do nothing on failures.&n;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Got it..&n;&t;&t; */
id|pci_context-&gt;dev_func
op_assign
id|temp
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Get the _SEG and _BBN values from the device upon which the handler&n;&t; *  is installed.&n;&t; *&n;&t; *  We need to get the _SEG and _BBN objects relative to the PCI BUS device.&n;&t; *  This is the device the handler has been registered to handle.&n;&t; */
id|search_scope
op_assign
id|handler_obj-&gt;addr_handler.nte
suffix:semicolon
id|status
op_assign
id|acpi_cm_evaluate_numeric_object
(paren
id|METHOD_NAME__SEG
comma
id|search_scope
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Got it..&n;&t;&t; */
id|pci_context-&gt;seg
op_assign
id|temp
suffix:semicolon
)brace
id|status
op_assign
id|acpi_cm_evaluate_numeric_object
(paren
id|METHOD_NAME__BBN
comma
id|search_scope
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Got it..&n;&t;&t; */
id|pci_context-&gt;bus
op_assign
id|temp
suffix:semicolon
)brace
id|acpi_cm_acquire_mutex
(paren
id|ACPI_MTX_NAMESPACE
)paren
suffix:semicolon
op_star
id|return_context
op_assign
id|pci_context
suffix:semicolon
id|region_obj-&gt;region.region_flags
op_or_assign
id|REGION_INITIALIZED
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_default_region_setup&n; *&n; * PARAMETERS:  Region_obj          - region we are interested in&n; *              Function            - start or stop&n; *              Handler_context     - Address space handler context&n; *              Returned context    - context to be used with each call to the&n; *                                    handler for this region&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; ****************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ev_default_region_setup
id|acpi_ev_default_region_setup
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|return_context
)paren
(brace
id|ACPI_OBJECT_INTERNAL
op_star
id|region_obj
op_assign
(paren
id|ACPI_OBJECT_INTERNAL
op_star
)paren
id|handle
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
id|region_obj-&gt;region.region_flags
op_and_assign
op_complement
(paren
id|REGION_INITIALIZED
)paren
suffix:semicolon
op_star
id|return_context
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|region_obj-&gt;region.region_flags
op_or_assign
id|REGION_INITIALIZED
suffix:semicolon
op_star
id|return_context
op_assign
id|handler_context
suffix:semicolon
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_initialize_region&n; *&n; * PARAMETERS:  Region_obj - Region we are initializing&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Initializes the region, finds any _REG methods and saves them&n; *              for execution at a later time&n; *&n; *              Get the appropriate address space handler for a newly&n; *              created region.&n; *&n; *              This also performs address space specific intialization.  For&n; *              example, PCI regions must have an _ADR object that contains&n; *              a PCI address in the scope of the defintion.  This address is&n; *              required to perform an access to PCI config space.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ev_initialize_region
id|acpi_ev_initialize_region
(paren
id|ACPI_OBJECT_INTERNAL
op_star
id|region_obj
comma
id|u8
id|acpi_ns_locked
)paren
(brace
id|ACPI_OBJECT_INTERNAL
op_star
id|handler_obj
suffix:semicolon
id|ACPI_OBJECT_INTERNAL
op_star
id|obj_desc
suffix:semicolon
id|u32
id|space_id
suffix:semicolon
id|ACPI_NAMED_OBJECT
op_star
id|entry
suffix:semicolon
multiline_comment|/* Namespace Object */
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_NAMED_OBJECT
op_star
id|reg_entry
suffix:semicolon
id|ACPI_NAME
op_star
id|reg_name_ptr
op_assign
(paren
id|ACPI_NAME
op_star
)paren
id|METHOD_NAME__REG
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_obj
)paren
(brace
r_return
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|ACPI_ASSERT
c_func
(paren
id|region_obj-&gt;region.nte
)paren
suffix:semicolon
id|entry
op_assign
id|acpi_ns_get_parent_entry
(paren
id|region_obj-&gt;region.nte
)paren
suffix:semicolon
id|space_id
op_assign
id|region_obj-&gt;region.space_id
suffix:semicolon
id|region_obj-&gt;region.addr_handler
op_assign
l_int|NULL
suffix:semicolon
id|region_obj-&gt;region.REGmethod
op_assign
l_int|NULL
suffix:semicolon
id|region_obj-&gt;region.region_flags
op_assign
id|INITIAL_REGION_FLAGS
suffix:semicolon
multiline_comment|/*&n;&t; *  Find any &quot;_REG&quot; associated with this region definition&n;&t; */
id|status
op_assign
id|acpi_ns_search_one_scope
(paren
op_star
id|reg_name_ptr
comma
id|entry-&gt;child_table
comma
id|ACPI_TYPE_METHOD
comma
op_amp
id|reg_entry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|AE_OK
)paren
(brace
multiline_comment|/*&n;&t;&t; *  The _REG method is optional and there can be only one per region&n;&t;&t; *  definition.  This will be executed when the handler is attached&n;&t;&t; *  or removed&n;&t;&t; */
id|region_obj-&gt;region.REGmethod
op_assign
id|reg_entry
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  The following loop depends upon the root nte having no parent&n;&t; *  ie: Acpi_gbl_Root_object-&gt;Parent_entry being set to NULL&n;&t; */
r_while
c_loop
(paren
id|entry
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Check to see if a handler exists&n;&t;&t; */
id|handler_obj
op_assign
l_int|NULL
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
(paren
id|ACPI_HANDLE
)paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  can only be a handler if the object exists&n;&t;&t;&t; */
r_switch
c_cond
(paren
id|entry-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_DEVICE
suffix:colon
id|handler_obj
op_assign
id|obj_desc-&gt;device.addr_handler
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PROCESSOR
suffix:colon
id|handler_obj
op_assign
id|obj_desc-&gt;processor.addr_handler
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_THERMAL
suffix:colon
id|handler_obj
op_assign
id|obj_desc-&gt;thermal_zone.addr_handler
suffix:semicolon
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|handler_obj
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *  This guy has at least one address handler&n;&t;&t;&t;&t; *  see if it has the type we want&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|handler_obj-&gt;addr_handler.space_id
op_eq
id|space_id
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; *  Found it! Now update the region and the handler&n;&t;&t;&t;&t;&t; */
id|acpi_ev_associate_region_and_handler
c_func
(paren
id|handler_obj
comma
id|region_obj
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|handler_obj
op_assign
id|handler_obj-&gt;addr_handler.link
suffix:semicolon
)brace
multiline_comment|/* while handlerobj */
)brace
multiline_comment|/*&n;&t;&t; *  This one does not have the handler we need&n;&t;&t; *  Pop up one level&n;&t;&t; */
id|entry
op_assign
id|acpi_ns_get_parent_entry
(paren
id|entry
)paren
suffix:semicolon
)brace
multiline_comment|/* while Entry != ROOT */
multiline_comment|/*&n;&t; *  If we get here, there is no handler for this region&n;&t; */
r_return
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
eof
