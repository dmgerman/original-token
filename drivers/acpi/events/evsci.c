multiline_comment|/*******************************************************************************&n; *&n; * Module Name: evsci - System Control Interrupt configuration and&n; *                      legacy to ACPI mode state transition functions&n; *              $Revision: 67 $&n; *&n; ******************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;achware.h&quot;
macro_line|#include &quot;acevents.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          EVENT_HANDLING
id|MODULE_NAME
(paren
l_string|&quot;evsci&quot;
)paren
multiline_comment|/*&n; * Elements correspond to counts for TMR, NOT_USED, GBL, PWR_BTN, SLP_BTN, RTC,&n; * and GENERAL respectively.  These counts are modified by the ACPI interrupt&n; * handler.&n; *&n; * TBD: [Investigate] Note that GENERAL should probably be split out into&n; * one element for each bit in the GPE registers&n; */
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_sci_handler&n; *&n; * PARAMETERS:  Context   - Calling Context&n; *&n; * RETURN:      Status code indicates whether interrupt was handled.&n; *&n; * DESCRIPTION: Interrupt handler that will figure out what function or&n; *              control method to call to deal with a SCI.  Installed&n; *              using BU interrupt support.&n; *&n; ******************************************************************************/
r_static
id|u32
DECL|function|acpi_ev_sci_handler
id|acpi_ev_sci_handler
(paren
r_void
op_star
id|context
)paren
(brace
id|u32
id|interrupt_handled
op_assign
id|INTERRUPT_NOT_HANDLED
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure that ACPI is enabled by checking SCI_EN.  Note that we are&n;&t; * required to treat the SCI interrupt as sharable, level, active low.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|acpi_hw_register_bit_access
(paren
id|ACPI_READ
comma
id|ACPI_MTX_DO_NOT_LOCK
comma
id|SCI_EN
)paren
)paren
(brace
multiline_comment|/* ACPI is not enabled;  this interrupt cannot be for us */
r_return
(paren
id|INTERRUPT_NOT_HANDLED
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Fixed Acpi_events:&n;&t; * -------------&n;&t; * Check for and dispatch any Fixed Acpi_events that have occurred&n;&t; */
id|interrupt_handled
op_or_assign
id|acpi_ev_fixed_event_detect
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * GPEs:&n;&t; * -----&n;&t; * Check for and dispatch any GPEs that have occurred&n;&t; */
id|interrupt_handled
op_or_assign
id|acpi_ev_gpe_detect
(paren
)paren
suffix:semicolon
r_return
(paren
id|interrupt_handled
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_install_sci_handler&n; *&n; * PARAMETERS:  none&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Installs SCI handler.&n; *&n; ******************************************************************************/
id|u32
DECL|function|acpi_ev_install_sci_handler
id|acpi_ev_install_sci_handler
(paren
r_void
)paren
(brace
id|u32
id|except
op_assign
id|AE_OK
suffix:semicolon
id|except
op_assign
id|acpi_os_install_interrupt_handler
(paren
(paren
id|u32
)paren
id|acpi_gbl_FADT-&gt;sci_int
comma
id|acpi_ev_sci_handler
comma
l_int|NULL
)paren
suffix:semicolon
r_return
(paren
id|except
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n;&n; *&n; * FUNCTION:    Acpi_ev_remove_sci_handler&n; *&n; * PARAMETERS:  none&n; *&n; * RETURN:      E_OK if handler uninstalled OK, E_ERROR if handler was not&n; *              installed to begin with&n; *&n; * DESCRIPTION: Restores original status of all fixed event enable bits and&n; *              removes SCI handler.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_ev_remove_sci_handler
id|acpi_ev_remove_sci_handler
(paren
r_void
)paren
(brace
macro_line|#if 0
multiline_comment|/* TBD:[Investigate] Figure this out!!  Disable all events first ???  */
r_if
c_cond
(paren
id|original_fixed_enable_bit_status
op_xor
l_int|1
op_lshift
id|acpi_event_index
(paren
id|TMR_FIXED_EVENT
)paren
)paren
(brace
id|acpi_event_disable_event
(paren
id|TMR_FIXED_EVENT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|original_fixed_enable_bit_status
op_xor
l_int|1
op_lshift
id|acpi_event_index
(paren
id|GBL_FIXED_EVENT
)paren
)paren
(brace
id|acpi_event_disable_event
(paren
id|GBL_FIXED_EVENT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|original_fixed_enable_bit_status
op_xor
l_int|1
op_lshift
id|acpi_event_index
(paren
id|PWR_BTN_FIXED_EVENT
)paren
)paren
(brace
id|acpi_event_disable_event
(paren
id|PWR_BTN_FIXED_EVENT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|original_fixed_enable_bit_status
op_xor
l_int|1
op_lshift
id|acpi_event_index
(paren
id|SLP_BTN_FIXED_EVENT
)paren
)paren
(brace
id|acpi_event_disable_event
(paren
id|SLP_BTN_FIXED_EVENT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|original_fixed_enable_bit_status
op_xor
l_int|1
op_lshift
id|acpi_event_index
(paren
id|RTC_FIXED_EVENT
)paren
)paren
(brace
id|acpi_event_disable_event
(paren
id|RTC_FIXED_EVENT
)paren
suffix:semicolon
)brace
id|original_fixed_enable_bit_status
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|acpi_os_remove_interrupt_handler
(paren
(paren
id|u32
)paren
id|acpi_gbl_FADT-&gt;sci_int
comma
id|acpi_ev_sci_handler
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_sci_count&n; *&n; * PARAMETERS:  Event       Event that generated an SCI.&n; *&n; * RETURN:      Number of SCI&squot;s for requested event since last time&n; *              Sci_occured() was called for this event.&n; *&n; * DESCRIPTION: Checks to see if SCI has been generated from requested source&n; *              since the last time this function was called.&n; *&n; ******************************************************************************/
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_restore_acpi_state&n; *&n; * PARAMETERS:  none&n; *&n; * RETURN:      none&n; *&n; * DESCRIPTION: Restore the original ACPI state of the machine&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ev_restore_acpi_state
id|acpi_ev_restore_acpi_state
(paren
r_void
)paren
(brace
id|u32
id|index
suffix:semicolon
multiline_comment|/* Restore the state of the chipset enable bits. */
r_if
c_cond
(paren
id|acpi_gbl_restore_acpi_chipset
op_eq
id|TRUE
)paren
(brace
multiline_comment|/* Restore the fixed events */
r_if
c_cond
(paren
id|acpi_hw_register_read
(paren
id|ACPI_MTX_LOCK
comma
id|PM1_EN
)paren
op_ne
id|acpi_gbl_pm1_enable_register_save
)paren
(brace
id|acpi_hw_register_write
(paren
id|ACPI_MTX_LOCK
comma
id|PM1_EN
comma
id|acpi_gbl_pm1_enable_register_save
)paren
suffix:semicolon
)brace
multiline_comment|/* Ensure that all status bits are clear */
id|acpi_hw_clear_acpi_status
(paren
)paren
suffix:semicolon
multiline_comment|/* Now restore the GPEs */
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|DIV_2
(paren
id|acpi_gbl_FADT-&gt;gpe0blk_len
)paren
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
id|acpi_hw_register_read
(paren
id|ACPI_MTX_LOCK
comma
id|GPE0_EN_BLOCK
op_or
id|index
)paren
op_ne
id|acpi_gbl_gpe0enable_register_save
(braket
id|index
)braket
)paren
(brace
id|acpi_hw_register_write
(paren
id|ACPI_MTX_LOCK
comma
id|GPE0_EN_BLOCK
op_or
id|index
comma
id|acpi_gbl_gpe0enable_register_save
(braket
id|index
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* GPE 1 present? */
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;gpe1_blk_len
)paren
(brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|DIV_2
(paren
id|acpi_gbl_FADT-&gt;gpe1_blk_len
)paren
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
id|acpi_hw_register_read
(paren
id|ACPI_MTX_LOCK
comma
id|GPE1_EN_BLOCK
op_or
id|index
)paren
op_ne
id|acpi_gbl_gpe1_enable_register_save
(braket
id|index
)braket
)paren
(brace
id|acpi_hw_register_write
(paren
id|ACPI_MTX_LOCK
comma
id|GPE1_EN_BLOCK
op_or
id|index
comma
id|acpi_gbl_gpe1_enable_register_save
(braket
id|index
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|acpi_hw_get_mode
c_func
(paren
)paren
op_ne
id|acpi_gbl_original_mode
)paren
(brace
id|acpi_hw_set_mode
(paren
id|acpi_gbl_original_mode
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_terminate&n; *&n; * PARAMETERS:  none&n; *&n; * RETURN:      none&n; *&n; * DESCRIPTION: free memory allocated for table storage.&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ev_terminate
id|acpi_ev_terminate
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Free global tables, etc.&n;&t; */
r_if
c_cond
(paren
id|acpi_gbl_gpe_registers
)paren
(brace
id|acpi_cm_free
(paren
id|acpi_gbl_gpe_registers
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_gbl_gpe_info
)paren
(brace
id|acpi_cm_free
(paren
id|acpi_gbl_gpe_info
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
eof
