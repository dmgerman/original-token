multiline_comment|/******************************************************************************&n; *&n; * Module Name: cmcopy - Internal to external object translation utilities&n; *              $Revision: 61 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          MISCELLANEOUS
id|MODULE_NAME
(paren
l_string|&quot;cmcopy&quot;
)paren
DECL|struct|search_st
r_typedef
r_struct
id|search_st
(brace
DECL|member|internal_obj
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
suffix:semicolon
DECL|member|index
id|u32
id|index
suffix:semicolon
DECL|member|external_obj
id|ACPI_OBJECT
op_star
id|external_obj
suffix:semicolon
DECL|typedef|PKG_SEARCH_INFO
)brace
id|PKG_SEARCH_INFO
suffix:semicolon
multiline_comment|/* Used to traverse nested packages */
DECL|variable|level
id|PKG_SEARCH_INFO
id|level
(braket
id|MAX_PACKAGE_DEPTH
)braket
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_cm_build_external_simple_object&n; *&n; * PARAMETERS:  *Internal_obj   - Pointer to the object we are examining&n; *              *Buffer         - Where the object is returned&n; *              *Space_used     - Where the data length is returned&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: This function is called to place a simple object in a user&n; *                  buffer.&n; *&n; *              The buffer is assumed to have sufficient space for the object.&n; *&n; ******************************************************************************/
r_static
id|ACPI_STATUS
DECL|function|acpi_cm_build_external_simple_object
id|acpi_cm_build_external_simple_object
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
comma
id|ACPI_OBJECT
op_star
id|external_obj
comma
id|u8
op_star
id|data_space
comma
id|u32
op_star
id|buffer_space_used
)paren
(brace
id|u32
id|length
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|source_ptr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Check for NULL object case (could be an uninitialized&n;&t; * package element&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|internal_obj
)paren
(brace
op_star
id|buffer_space_used
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Always clear the external object */
id|MEMSET
(paren
id|external_obj
comma
l_int|0
comma
r_sizeof
(paren
id|ACPI_OBJECT
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * In general, the external object will be the same type as&n;&t; * the internal object&n;&t; */
id|external_obj-&gt;type
op_assign
id|internal_obj-&gt;common.type
suffix:semicolon
multiline_comment|/* However, only a limited number of external types are supported */
r_switch
c_cond
(paren
id|external_obj-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_STRING
suffix:colon
id|length
op_assign
id|internal_obj-&gt;string.length
op_plus
l_int|1
suffix:semicolon
id|external_obj-&gt;string.length
op_assign
id|internal_obj-&gt;string.length
suffix:semicolon
id|external_obj-&gt;string.pointer
op_assign
(paren
id|NATIVE_CHAR
op_star
)paren
id|data_space
suffix:semicolon
id|source_ptr
op_assign
(paren
id|u8
op_star
)paren
id|internal_obj-&gt;string.pointer
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
id|length
op_assign
id|internal_obj-&gt;buffer.length
suffix:semicolon
id|external_obj-&gt;buffer.length
op_assign
id|internal_obj-&gt;buffer.length
suffix:semicolon
id|external_obj-&gt;buffer.pointer
op_assign
id|data_space
suffix:semicolon
id|source_ptr
op_assign
(paren
id|u8
op_star
)paren
id|internal_obj-&gt;buffer.pointer
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_NUMBER
suffix:colon
id|external_obj-&gt;number.value
op_assign
id|internal_obj-&gt;number.value
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INTERNAL_TYPE_REFERENCE
suffix:colon
multiline_comment|/*&n;&t;&t; * This is an object reference.  We use the object type of &quot;Any&quot;&n;&t;&t; * to indicate a reference object containing a handle to an ACPI&n;&t;&t; * named object.&n;&t;&t; */
id|external_obj-&gt;type
op_assign
id|ACPI_TYPE_ANY
suffix:semicolon
id|external_obj-&gt;reference.handle
op_assign
id|internal_obj-&gt;reference.node
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PROCESSOR
suffix:colon
id|external_obj-&gt;processor.proc_id
op_assign
id|internal_obj-&gt;processor.proc_id
suffix:semicolon
id|external_obj-&gt;processor.pblk_address
op_assign
id|internal_obj-&gt;processor.address
suffix:semicolon
id|external_obj-&gt;processor.pblk_length
op_assign
id|internal_obj-&gt;processor.length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_POWER
suffix:colon
id|external_obj-&gt;power_resource.system_level
op_assign
id|internal_obj-&gt;power_resource.system_level
suffix:semicolon
id|external_obj-&gt;power_resource.resource_order
op_assign
id|internal_obj-&gt;power_resource.resource_order
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|AE_CTRL_RETURN_VALUE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Copy data if necessary (strings or buffers) */
r_if
c_cond
(paren
id|length
)paren
(brace
multiline_comment|/*&n;&t;&t; * Copy the return data to the caller&squot;s buffer&n;&t;&t; */
id|MEMCPY
(paren
(paren
r_void
op_star
)paren
id|data_space
comma
(paren
r_void
op_star
)paren
id|source_ptr
comma
id|length
)paren
suffix:semicolon
)brace
op_star
id|buffer_space_used
op_assign
(paren
id|u32
)paren
id|ROUND_UP_TO_NATIVE_WORD
(paren
id|length
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_cm_build_external_package_object&n; *&n; * PARAMETERS:  *Internal_obj   - Pointer to the object we are returning&n; *              *Buffer         - Where the object is returned&n; *              *Space_used     - Where the object length is returned&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: This function is called to place a package object in a user&n; *              buffer.  A package object by definition contains other objects.&n; *&n; *              The buffer is assumed to have sufficient space for the object.&n; *              The caller must have verified the buffer length needed using the&n; *              Acpi_cm_get_object_size function before calling this function.&n; *&n; ******************************************************************************/
r_static
id|ACPI_STATUS
DECL|function|acpi_cm_build_external_package_object
id|acpi_cm_build_external_package_object
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
comma
id|u8
op_star
id|buffer
comma
id|u32
op_star
id|space_used
)paren
(brace
id|u8
op_star
id|free_space
suffix:semicolon
id|ACPI_OBJECT
op_star
id|external_obj
suffix:semicolon
id|u32
id|current_depth
op_assign
l_int|0
suffix:semicolon
id|ACPI_STATUS
id|status
suffix:semicolon
id|u32
id|length
op_assign
l_int|0
suffix:semicolon
id|u32
id|this_index
suffix:semicolon
id|u32
id|object_space
suffix:semicolon
id|ACPI_OPERAND_OBJECT
op_star
id|this_internal_obj
suffix:semicolon
id|ACPI_OBJECT
op_star
id|this_external_obj
suffix:semicolon
id|PKG_SEARCH_INFO
op_star
id|level_ptr
suffix:semicolon
multiline_comment|/*&n;&t; * First package at head of the buffer&n;&t; */
id|external_obj
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|buffer
suffix:semicolon
multiline_comment|/*&n;&t; * Free space begins right after the first package&n;&t; */
id|free_space
op_assign
id|buffer
op_plus
id|ROUND_UP_TO_NATIVE_WORD
(paren
r_sizeof
(paren
id|ACPI_OBJECT
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the working variables&n;&t; */
id|MEMSET
(paren
(paren
r_void
op_star
)paren
id|level
comma
l_int|0
comma
r_sizeof
(paren
id|level
)paren
)paren
suffix:semicolon
id|level
(braket
l_int|0
)braket
dot
id|internal_obj
op_assign
id|internal_obj
suffix:semicolon
id|level
(braket
l_int|0
)braket
dot
id|external_obj
op_assign
id|external_obj
suffix:semicolon
id|level
(braket
l_int|0
)braket
dot
id|index
op_assign
l_int|0
suffix:semicolon
id|level_ptr
op_assign
op_amp
id|level
(braket
l_int|0
)braket
suffix:semicolon
id|current_depth
op_assign
l_int|0
suffix:semicolon
id|external_obj-&gt;type
op_assign
id|internal_obj-&gt;common.type
suffix:semicolon
id|external_obj-&gt;package.count
op_assign
id|internal_obj-&gt;package.count
suffix:semicolon
id|external_obj-&gt;package.elements
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|free_space
suffix:semicolon
multiline_comment|/*&n;&t; * Build an array of ACPI_OBJECTS in the buffer&n;&t; * and move the free space past it&n;&t; */
id|free_space
op_add_assign
id|external_obj-&gt;package.count
op_star
id|ROUND_UP_TO_NATIVE_WORD
(paren
r_sizeof
(paren
id|ACPI_OBJECT
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|this_index
op_assign
id|level_ptr-&gt;index
suffix:semicolon
id|this_internal_obj
op_assign
(paren
id|ACPI_OPERAND_OBJECT
op_star
)paren
id|level_ptr-&gt;internal_obj-&gt;package.elements
(braket
id|this_index
)braket
suffix:semicolon
id|this_external_obj
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
op_amp
id|level_ptr-&gt;external_obj-&gt;package.elements
(braket
id|this_index
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check for&n;&t;&t; * 1) Null object -- OK, this can happen if package&n;&t;&t; *              element is never initialized&n;&t;&t; * 2) Not an internal object - can be Node instead&n;&t;&t; * 3) Any internal object other than a package.&n;&t;&t; *&n;&t;&t; * The more complex package case is handled later&n;&t;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|this_internal_obj
)paren
op_logical_or
(paren
op_logical_neg
id|VALID_DESCRIPTOR_TYPE
(paren
id|this_internal_obj
comma
id|ACPI_DESC_TYPE_INTERNAL
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|IS_THIS_OBJECT_TYPE
(paren
id|this_internal_obj
comma
id|ACPI_TYPE_PACKAGE
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * This is a simple or null object -- get the size&n;&t;&t;&t; */
id|status
op_assign
id|acpi_cm_build_external_simple_object
(paren
id|this_internal_obj
comma
id|this_external_obj
comma
id|free_space
comma
op_amp
id|object_space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|free_space
op_add_assign
id|object_space
suffix:semicolon
id|length
op_add_assign
id|object_space
suffix:semicolon
id|level_ptr-&gt;index
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|level_ptr-&gt;index
op_ge
id|level_ptr-&gt;internal_obj-&gt;package.count
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We&squot;ve handled all of the objects at this&n;&t;&t;&t;&t; * level.  This means that we have just&n;&t;&t;&t;&t; * completed a package.  That package may&n;&t;&t;&t;&t; * have contained one or more packages&n;&t;&t;&t;&t; * itself&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|current_depth
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * We have handled all of the objects&n;&t;&t;&t;&t;&t; * in the top level package just add&n;&t;&t;&t;&t;&t; * the length of the package objects&n;&t;&t;&t;&t;&t; * and get out&n;&t;&t;&t;&t;&t; */
op_star
id|space_used
op_assign
id|length
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * go back up a level and move the index&n;&t;&t;&t;&t; * past the just completed package object.&n;&t;&t;&t;&t; */
id|current_depth
op_decrement
suffix:semicolon
id|level_ptr
op_assign
op_amp
id|level
(braket
id|current_depth
)braket
suffix:semicolon
id|level_ptr-&gt;index
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * This object is a package&n;&t;&t;&t; * -- we must go one level deeper&n;&t;&t;&t; */
r_if
c_cond
(paren
id|current_depth
op_ge
id|MAX_PACKAGE_DEPTH
op_minus
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Too many nested levels of packages&n;&t;&t;&t;&t; * for us to handle&n;&t;&t;&t;&t; */
r_return
(paren
id|AE_LIMIT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Build the package object&n;&t;&t;&t; */
id|this_external_obj-&gt;type
op_assign
id|ACPI_TYPE_PACKAGE
suffix:semicolon
id|this_external_obj-&gt;package.count
op_assign
id|this_internal_obj-&gt;package.count
suffix:semicolon
id|this_external_obj-&gt;package.elements
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|free_space
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Save space for the array of objects (Package elements)&n;&t;&t;&t; * update the buffer length counter&n;&t;&t;&t; */
id|object_space
op_assign
(paren
id|u32
)paren
id|ROUND_UP_TO_NATIVE_WORD
(paren
id|this_external_obj-&gt;package.count
op_star
r_sizeof
(paren
id|ACPI_OBJECT
)paren
)paren
suffix:semicolon
id|free_space
op_add_assign
id|object_space
suffix:semicolon
id|length
op_add_assign
id|object_space
suffix:semicolon
id|current_depth
op_increment
suffix:semicolon
id|level_ptr
op_assign
op_amp
id|level
(braket
id|current_depth
)braket
suffix:semicolon
id|level_ptr-&gt;internal_obj
op_assign
id|this_internal_obj
suffix:semicolon
id|level_ptr-&gt;external_obj
op_assign
id|this_external_obj
suffix:semicolon
id|level_ptr-&gt;index
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_cm_build_external_object&n; *&n; * PARAMETERS:  *Internal_obj   - The internal object to be converted&n; *              *Buffer_ptr     - Where the object is returned&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: This function is called to build an API object to be returned to&n; *              the caller.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_cm_build_external_object
id|acpi_cm_build_external_object
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
comma
id|ACPI_BUFFER
op_star
id|ret_buffer
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
r_if
c_cond
(paren
id|IS_THIS_OBJECT_TYPE
(paren
id|internal_obj
comma
id|ACPI_TYPE_PACKAGE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Package objects contain other objects (which can be objects)&n;&t;&t; * buildpackage does it all&n;&t;&t; */
id|status
op_assign
id|acpi_cm_build_external_package_object
(paren
id|internal_obj
comma
id|ret_buffer-&gt;pointer
comma
op_amp
id|ret_buffer-&gt;length
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Build a simple object (no nested objects)&n;&t;&t; */
id|status
op_assign
id|acpi_cm_build_external_simple_object
(paren
id|internal_obj
comma
(paren
id|ACPI_OBJECT
op_star
)paren
id|ret_buffer-&gt;pointer
comma
(paren
(paren
id|u8
op_star
)paren
id|ret_buffer-&gt;pointer
op_plus
id|ROUND_UP_TO_NATIVE_WORD
(paren
r_sizeof
(paren
id|ACPI_OBJECT
)paren
)paren
)paren
comma
op_amp
id|ret_buffer-&gt;length
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * build simple does not include the object size in the length&n;&t;&t; * so we add it in here&n;&t;&t; */
id|ret_buffer-&gt;length
op_add_assign
r_sizeof
(paren
id|ACPI_OBJECT
)paren
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_cm_build_internal_simple_object&n; *&n; * PARAMETERS:  *External_obj   - The external object to be converted&n; *              *Internal_obj   - Where the internal object is returned&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: This function copies an external object to an internal one.&n; *              NOTE: Pointers can be copied, we don&squot;t need to copy data.&n; *              (The pointers have to be valid in our address space no matter&n; *              what we do with them!)&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_cm_build_internal_simple_object
id|acpi_cm_build_internal_simple_object
(paren
id|ACPI_OBJECT
op_star
id|external_obj
comma
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
)paren
(brace
id|internal_obj-&gt;common.type
op_assign
(paren
id|u8
)paren
id|external_obj-&gt;type
suffix:semicolon
r_switch
c_cond
(paren
id|external_obj-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_STRING
suffix:colon
id|internal_obj-&gt;string.length
op_assign
id|external_obj-&gt;string.length
suffix:semicolon
id|internal_obj-&gt;string.pointer
op_assign
id|external_obj-&gt;string.pointer
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
id|internal_obj-&gt;buffer.length
op_assign
id|external_obj-&gt;buffer.length
suffix:semicolon
id|internal_obj-&gt;buffer.pointer
op_assign
id|external_obj-&gt;buffer.pointer
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_NUMBER
suffix:colon
multiline_comment|/*&n;&t;&t; * Number is included in the object itself&n;&t;&t; */
id|internal_obj-&gt;number.value
op_assign
id|external_obj-&gt;number.value
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|AE_CTRL_RETURN_VALUE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
macro_line|#ifdef ACPI_FUTURE_IMPLEMENTATION
multiline_comment|/* Code to convert packages that are parameters to control methods */
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_cm_build_internal_package_object&n; *&n; * PARAMETERS:  *Internal_obj   - Pointer to the object we are returning&n; *              *Buffer         - Where the object is returned&n; *              *Space_used     - Where the length of the object is returned&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: This function is called to place a package object in a user&n; *              buffer.  A package object by definition contains other objects.&n; *&n; *              The buffer is assumed to have sufficient space for the object.&n; *              The caller must have verified the buffer length needed using the&n; *              Acpi_cm_get_object_size function before calling this function.&n; *&n; ******************************************************************************/
r_static
id|ACPI_STATUS
DECL|function|acpi_cm_build_internal_package_object
id|acpi_cm_build_internal_package_object
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
comma
id|u8
op_star
id|buffer
comma
id|u32
op_star
id|space_used
)paren
(brace
id|u8
op_star
id|free_space
suffix:semicolon
id|ACPI_OBJECT
op_star
id|external_obj
suffix:semicolon
id|u32
id|current_depth
op_assign
l_int|0
suffix:semicolon
id|u32
id|length
op_assign
l_int|0
suffix:semicolon
id|u32
id|this_index
suffix:semicolon
id|u32
id|object_space
op_assign
l_int|0
suffix:semicolon
id|ACPI_OPERAND_OBJECT
op_star
id|this_internal_obj
suffix:semicolon
id|ACPI_OBJECT
op_star
id|this_external_obj
suffix:semicolon
id|PKG_SEARCH_INFO
op_star
id|level_ptr
suffix:semicolon
multiline_comment|/*&n;&t; * First package at head of the buffer&n;&t; */
id|external_obj
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|buffer
suffix:semicolon
multiline_comment|/*&n;&t; * Free space begins right after the first package&n;&t; */
id|free_space
op_assign
id|buffer
op_plus
r_sizeof
(paren
id|ACPI_OBJECT
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the working variables&n;&t; */
id|MEMSET
(paren
(paren
r_void
op_star
)paren
id|level
comma
l_int|0
comma
r_sizeof
(paren
id|level
)paren
)paren
suffix:semicolon
id|level
(braket
l_int|0
)braket
dot
id|internal_obj
op_assign
id|internal_obj
suffix:semicolon
id|level
(braket
l_int|0
)braket
dot
id|external_obj
op_assign
id|external_obj
suffix:semicolon
id|level_ptr
op_assign
op_amp
id|level
(braket
l_int|0
)braket
suffix:semicolon
id|current_depth
op_assign
l_int|0
suffix:semicolon
id|external_obj-&gt;type
op_assign
id|internal_obj-&gt;common.type
suffix:semicolon
id|external_obj-&gt;package.count
op_assign
id|internal_obj-&gt;package.count
suffix:semicolon
id|external_obj-&gt;package.elements
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|free_space
suffix:semicolon
multiline_comment|/*&n;&t; * Build an array of ACPI_OBJECTS in the buffer&n;&t; * and move the free space past it&n;&t; */
id|free_space
op_add_assign
id|external_obj-&gt;package.count
op_star
r_sizeof
(paren
id|ACPI_OBJECT
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|this_index
op_assign
id|level_ptr-&gt;index
suffix:semicolon
id|this_internal_obj
op_assign
(paren
id|ACPI_OPERAND_OBJECT
op_star
)paren
op_amp
id|level_ptr-&gt;internal_obj-&gt;package.elements
(braket
id|this_index
)braket
suffix:semicolon
id|this_external_obj
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
op_amp
id|level_ptr-&gt;external_obj-&gt;package.elements
(braket
id|this_index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|IS_THIS_OBJECT_TYPE
(paren
id|this_internal_obj
comma
id|ACPI_TYPE_PACKAGE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If this object is a package then we go one deeper&n;&t;&t;&t; */
r_if
c_cond
(paren
id|current_depth
op_ge
id|MAX_PACKAGE_DEPTH
op_minus
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Too many nested levels of packages for us to handle&n;&t;&t;&t;&t; */
r_return
(paren
id|AE_LIMIT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Build the package object&n;&t;&t;&t; */
id|this_external_obj-&gt;type
op_assign
id|ACPI_TYPE_PACKAGE
suffix:semicolon
id|this_external_obj-&gt;package.count
op_assign
id|this_internal_obj-&gt;package.count
suffix:semicolon
id|this_external_obj-&gt;package.elements
op_assign
(paren
id|ACPI_OBJECT
op_star
)paren
id|free_space
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Save space for the array of objects (Package elements)&n;&t;&t;&t; * update the buffer length counter&n;&t;&t;&t; */
id|object_space
op_assign
id|this_external_obj-&gt;package.count
op_star
r_sizeof
(paren
id|ACPI_OBJECT
)paren
suffix:semicolon
id|free_space
op_add_assign
id|object_space
suffix:semicolon
id|length
op_add_assign
id|object_space
suffix:semicolon
id|current_depth
op_increment
suffix:semicolon
id|level_ptr
op_assign
op_amp
id|level
(braket
id|current_depth
)braket
suffix:semicolon
id|level_ptr-&gt;internal_obj
op_assign
id|this_internal_obj
suffix:semicolon
id|level_ptr-&gt;external_obj
op_assign
id|this_external_obj
suffix:semicolon
id|level_ptr-&gt;index
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if object is a package */
r_else
(brace
id|free_space
op_add_assign
id|object_space
suffix:semicolon
id|length
op_add_assign
id|object_space
suffix:semicolon
id|level_ptr-&gt;index
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|level_ptr-&gt;index
op_ge
id|level_ptr-&gt;internal_obj-&gt;package.count
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We&squot;ve handled all of the objects at&n;&t;&t;&t;&t; * this level,  This means that we have&n;&t;&t;&t;&t; * just completed a package.  That package&n;&t;&t;&t;&t; * may have contained one or more packages&n;&t;&t;&t;&t; * itself&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|current_depth
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * We have handled all of the objects&n;&t;&t;&t;&t;&t; * in the top level package just add&n;&t;&t;&t;&t;&t; * the length of the package objects&n;&t;&t;&t;&t;&t; * and get out&n;&t;&t;&t;&t;&t; */
op_star
id|space_used
op_assign
id|length
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * go back up a level and move the index&n;&t;&t;&t;&t; * past the just completed package object.&n;&t;&t;&t;&t; */
id|current_depth
op_decrement
suffix:semicolon
id|level_ptr
op_assign
op_amp
id|level
(braket
id|current_depth
)braket
suffix:semicolon
id|level_ptr-&gt;index
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* else object is NOT a package */
)brace
multiline_comment|/* while (1)  */
)brace
macro_line|#endif /* Future implementation */
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_cm_build_internal_object&n; *&n; * PARAMETERS:  *Internal_obj   - The external object to be converted&n; *              *Buffer_ptr     - Where the internal object is returned&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: Converts an external object to an internal object.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_cm_build_internal_object
id|acpi_cm_build_internal_object
(paren
id|ACPI_OBJECT
op_star
id|external_obj
comma
id|ACPI_OPERAND_OBJECT
op_star
id|internal_obj
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
r_if
c_cond
(paren
id|external_obj-&gt;type
op_eq
id|ACPI_TYPE_PACKAGE
)paren
(brace
multiline_comment|/*&n;&t;&t; * Package objects contain other objects (which can be objects)&n;&t;&t; * buildpackage does it all&n;&t;&t; *&n;&t;&t; * TBD: Package conversion must be completed and tested&n;&t;&t; * NOTE: this code converts packages as input parameters to&n;&t;&t; * control methods only.  This is a very, very rare case.&n;&t;&t; */
multiline_comment|/*&n;&t;&t;Status = Acpi_cm_build_internal_package_object(Internal_obj,&n;&t;&t;&t;&t; Ret_buffer-&gt;Pointer,&n;&t;&t;&t;&t; &amp;Ret_buffer-&gt;Length);&n;*/
r_return
(paren
id|AE_NOT_IMPLEMENTED
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Build a simple object (no nested objects)&n;&t;&t; */
id|status
op_assign
id|acpi_cm_build_internal_simple_object
(paren
id|external_obj
comma
id|internal_obj
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * build simple does not include the object size in the length&n;&t;&t; * so we add it in here&n;&t;&t; */
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
eof
