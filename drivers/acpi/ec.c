multiline_comment|/*&n; *&t;ec.c - Embedded controller support&n; *&n; *&t;Copyright (C) 2000 Andrew Henroid&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;ec&quot;
)paren
DECL|macro|ACPI_EC_HID
mdefine_line|#define ACPI_EC_HID&t;&quot;PNP0A09&quot;
r_enum
(brace
DECL|enumerator|ACPI_EC_SMI
id|ACPI_EC_SMI
op_assign
l_int|0x40
comma
DECL|enumerator|ACPI_EC_SCI
id|ACPI_EC_SCI
op_assign
l_int|0x20
comma
DECL|enumerator|ACPI_EC_BURST
id|ACPI_EC_BURST
op_assign
l_int|0x10
comma
DECL|enumerator|ACPI_EC_CMD
id|ACPI_EC_CMD
op_assign
l_int|0x08
comma
DECL|enumerator|ACPI_EC_IBF
id|ACPI_EC_IBF
op_assign
l_int|0x02
comma
DECL|enumerator|ACPI_EC_OBF
id|ACPI_EC_OBF
op_assign
l_int|0x01
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|ACPI_EC_READ
id|ACPI_EC_READ
op_assign
l_int|0x80
comma
DECL|enumerator|ACPI_EC_WRITE
id|ACPI_EC_WRITE
op_assign
l_int|0x81
comma
DECL|enumerator|ACPI_EC_BURST_ENABLE
id|ACPI_EC_BURST_ENABLE
op_assign
l_int|0x82
comma
DECL|enumerator|ACPI_EC_BURST_DISABLE
id|ACPI_EC_BURST_DISABLE
op_assign
l_int|0x83
comma
DECL|enumerator|ACPI_EC_QUERY
id|ACPI_EC_QUERY
op_assign
l_int|0x84
comma
)brace
suffix:semicolon
DECL|variable|acpi_ec_data
r_static
r_int
id|acpi_ec_data
op_assign
l_int|0
suffix:semicolon
DECL|variable|acpi_ec_status
r_static
r_int
id|acpi_ec_status
op_assign
l_int|0
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|acpi_ec_wait
)paren
suffix:semicolon
multiline_comment|/*&n; * handle GPE&n; */
r_static
r_void
DECL|function|acpi_ec_gpe
id|acpi_ec_gpe
c_func
(paren
r_void
op_star
id|context
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: EC GPE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|acpi_ec_wait
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|acpi_ec_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * wait for read/write status to clear&n; */
r_static
r_void
DECL|function|acpi_ec_wait_control
id|acpi_ec_wait_control
c_func
(paren
r_void
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|acpi_ec_status
)paren
op_amp
id|ACPI_EC_IBF
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * read a byte from the EC&n; */
r_int
DECL|function|acpi_ec_read
id|acpi_ec_read
c_func
(paren
r_int
id|addr
comma
r_int
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|acpi_ec_data
op_logical_or
op_logical_neg
id|acpi_ec_status
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|ACPI_EC_READ
comma
id|acpi_ec_status
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr
comma
id|acpi_ec_data
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|acpi_ec_wait
)paren
suffix:semicolon
op_star
id|value
op_assign
id|inb
c_func
(paren
id|acpi_ec_data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * write a byte to the EC&n; */
r_int
DECL|function|acpi_ec_write
id|acpi_ec_write
c_func
(paren
r_int
id|addr
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|acpi_ec_data
op_logical_or
op_logical_neg
id|acpi_ec_status
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|ACPI_EC_WRITE
comma
id|acpi_ec_status
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr
comma
id|acpi_ec_data
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|acpi_ec_data
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|acpi_ec_wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get Embedded Controller information&n; */
r_static
id|ACPI_STATUS
DECL|function|acpi_find_ec
id|acpi_find_ec
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctx
comma
r_void
op_star
op_star
id|value
)paren
(brace
id|ACPI_DEVICE_INFO
id|dev_info
suffix:semicolon
id|ACPI_OBJECT
id|obj
suffix:semicolon
id|ACPI_BUFFER
id|buf
suffix:semicolon
id|RESOURCE
op_star
id|res
suffix:semicolon
r_int
id|gpe
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_object_info
c_func
(paren
id|handle
comma
op_amp
id|dev_info
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|dev_info.valid
op_amp
id|ACPI_VALID_HID
)paren
op_logical_or
l_int|0
op_ne
id|STRCMP
c_func
(paren
id|dev_info.hardware_id
comma
id|ACPI_EC_HID
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
id|buf.length
op_assign
l_int|0
suffix:semicolon
id|buf.pointer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|acpi_get_current_resources
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
op_ne
id|AE_BUFFER_OVERFLOW
)paren
r_return
id|AE_OK
suffix:semicolon
id|buf.pointer
op_assign
id|kmalloc
c_func
(paren
id|buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf.pointer
)paren
r_return
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_current_resources
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|res
op_assign
(paren
id|RESOURCE
op_star
)paren
id|buf.pointer
suffix:semicolon
id|acpi_ec_data
op_assign
(paren
r_int
)paren
id|res-&gt;data.io.min_base_address
suffix:semicolon
id|res
op_assign
(paren
id|RESOURCE
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|buf.pointer
op_plus
id|res-&gt;length
)paren
suffix:semicolon
id|acpi_ec_status
op_assign
(paren
r_int
)paren
id|res-&gt;data.io.min_base_address
suffix:semicolon
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
id|buf.length
op_assign
r_sizeof
(paren
id|obj
)paren
suffix:semicolon
id|buf.pointer
op_assign
op_amp
id|obj
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_GPE&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
op_logical_or
id|obj.type
op_ne
id|ACPI_TYPE_NUMBER
)paren
r_return
id|AE_OK
suffix:semicolon
id|gpe
op_assign
(paren
r_int
)paren
id|obj.number.value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: found EC @ (0x%02x,0x%02x,%d)&bslash;n&quot;
comma
id|acpi_ec_data
comma
id|acpi_ec_status
comma
id|gpe
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_install_gpe_handler
c_func
(paren
id|gpe
comma
(paren
id|ACPI_EVENT_LEVEL_TRIGGERED
op_or
id|ACPI_EVENT_EDGE_TRIGGERED
)paren
comma
id|acpi_ec_gpe
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_ERROR
comma
(paren
l_string|&quot;Could not install GPE handler for EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
r_int
DECL|function|acpi_ec_init
id|acpi_ec_init
c_func
(paren
r_void
)paren
(brace
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|ACPI_ROOT_OBJECT
comma
id|ACPI_UINT32_MAX
comma
id|acpi_find_ec
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
