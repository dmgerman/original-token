multiline_comment|/*&n; *  ec.c - Embedded controller support&n; *&n; *  Copyright (C) 2000 Andrew Henroid&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;ec&quot;
)paren
DECL|macro|ACPI_EC_HID
mdefine_line|#define ACPI_EC_HID&t;&quot;PNP0C09&quot;
r_enum
(brace
DECL|enumerator|ACPI_EC_SMI
id|ACPI_EC_SMI
op_assign
l_int|0x40
comma
DECL|enumerator|ACPI_EC_SCI
id|ACPI_EC_SCI
op_assign
l_int|0x20
comma
DECL|enumerator|ACPI_EC_BURST
id|ACPI_EC_BURST
op_assign
l_int|0x10
comma
DECL|enumerator|ACPI_EC_CMD
id|ACPI_EC_CMD
op_assign
l_int|0x08
comma
DECL|enumerator|ACPI_EC_IBF
id|ACPI_EC_IBF
op_assign
l_int|0x02
comma
DECL|enumerator|ACPI_EC_OBF
id|ACPI_EC_OBF
op_assign
l_int|0x01
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|ACPI_EC_READ
id|ACPI_EC_READ
op_assign
l_int|0x80
comma
DECL|enumerator|ACPI_EC_WRITE
id|ACPI_EC_WRITE
op_assign
l_int|0x81
comma
DECL|enumerator|ACPI_EC_BURST_ENABLE
id|ACPI_EC_BURST_ENABLE
op_assign
l_int|0x82
comma
DECL|enumerator|ACPI_EC_BURST_DISABLE
id|ACPI_EC_BURST_DISABLE
op_assign
l_int|0x83
comma
DECL|enumerator|ACPI_EC_QUERY
id|ACPI_EC_QUERY
op_assign
l_int|0x84
comma
)brace
suffix:semicolon
DECL|struct|ec_context
r_struct
id|ec_context
(brace
DECL|member|gpe_bit
id|u32
id|gpe_bit
suffix:semicolon
DECL|member|status_port
id|ACPI_IO_ADDRESS
id|status_port
suffix:semicolon
DECL|member|data_port
id|ACPI_IO_ADDRESS
id|data_port
suffix:semicolon
DECL|member|need_global_lock
id|u32
id|need_global_lock
suffix:semicolon
)brace
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|acpi_ec_wait
)paren
suffix:semicolon
multiline_comment|/*&n; * handle GPE&n; */
r_static
r_void
DECL|function|acpi_ec_gpe
id|acpi_ec_gpe
c_func
(paren
r_void
op_star
id|context
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: EC GPE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TODO fix this to use per-device sem */
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|acpi_ec_wait
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|acpi_ec_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * wait for read/write status to clear&n; */
r_static
r_void
DECL|function|acpi_ec_wait_control
id|acpi_ec_wait_control
c_func
(paren
r_struct
id|ec_context
op_star
id|ec_cxt
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|ec_cxt-&gt;status_port
)paren
op_amp
id|ACPI_EC_IBF
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * read a byte from the EC&n; */
r_int
DECL|function|acpi_ec_read
id|acpi_ec_read
c_func
(paren
r_struct
id|ec_context
op_star
id|ec_cxt
comma
r_int
id|addr
comma
r_int
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ec_cxt-&gt;data_port
op_logical_or
op_logical_neg
id|ec_cxt-&gt;status_port
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ec_cxt-&gt;need_global_lock
)paren
id|acpi_acquire_global_lock
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ACPI_EC_READ
comma
id|ec_cxt-&gt;status_port
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
id|ec_cxt
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr
comma
id|ec_cxt-&gt;data_port
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
id|ec_cxt
)paren
suffix:semicolon
multiline_comment|/*interruptible_sleep_on(&amp;acpi_ec_wait);*/
op_star
id|value
op_assign
id|inb
c_func
(paren
id|ec_cxt-&gt;data_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_cxt-&gt;need_global_lock
)paren
id|acpi_release_global_lock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * write a byte to the EC&n; */
r_int
DECL|function|acpi_ec_write
id|acpi_ec_write
c_func
(paren
r_struct
id|ec_context
op_star
id|ec_cxt
comma
r_int
id|addr
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ec_cxt-&gt;data_port
op_logical_or
op_logical_neg
id|ec_cxt-&gt;status_port
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ec_cxt-&gt;need_global_lock
)paren
id|acpi_acquire_global_lock
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ACPI_EC_WRITE
comma
id|ec_cxt-&gt;status_port
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
id|ec_cxt
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr
comma
id|ec_cxt-&gt;data_port
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
id|ec_cxt
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|ec_cxt-&gt;data_port
)paren
suffix:semicolon
id|acpi_ec_wait_control
c_func
(paren
id|ec_cxt
)paren
suffix:semicolon
multiline_comment|/*interruptible_sleep_on(&amp;acpi_ec_wait);*/
r_if
c_cond
(paren
id|ec_cxt-&gt;need_global_lock
)paren
id|acpi_release_global_lock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|acpi_ec_region_setup
id|acpi_ec_region_setup
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_ec_region_setup&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;acpi_ec_region_setup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
r_if
c_cond
(paren
op_star
id|region_context
)paren
(brace
id|acpi_cm_free
(paren
op_star
id|region_context
)paren
suffix:semicolon
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|acpi_ec_region_handler
id|acpi_ec_region_handler
(paren
id|u32
id|function
comma
id|ACPI_PHYSICAL_ADDRESS
id|address
comma
id|u32
id|bitwidth
comma
id|u32
op_star
id|value
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
id|region_context
)paren
(brace
r_struct
id|ec_context
op_star
id|ec_cxt
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_ec_region_handler&quot;
)paren
suffix:semicolon
id|ec_cxt
op_assign
id|handler_context
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ADDRESS_SPACE_READ
)paren
(brace
op_star
id|value
op_assign
l_int|0
suffix:semicolon
id|acpi_ec_read
c_func
(paren
id|ec_cxt
comma
id|address
comma
id|value
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;EC read %x from %x&bslash;n&quot;, *value, address);*/
)brace
r_else
(brace
id|acpi_ec_write
c_func
(paren
id|ec_cxt
comma
id|address
comma
op_star
id|value
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;EC write value %x to %x&bslash;n&quot;, *value, address);*/
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get Embedded Controller information&n; */
r_static
id|ACPI_STATUS
DECL|function|acpi_found_ec
id|acpi_found_ec
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctx
comma
r_void
op_star
op_star
id|value
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_OBJECT
id|obj
suffix:semicolon
id|ACPI_BUFFER
id|buf
suffix:semicolon
id|RESOURCE
op_star
id|res
suffix:semicolon
r_struct
id|ec_context
op_star
id|ec_cxt
suffix:semicolon
id|buf.length
op_assign
l_int|0
suffix:semicolon
id|buf.pointer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|acpi_get_current_resources
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
op_ne
id|AE_BUFFER_OVERFLOW
)paren
r_return
id|AE_OK
suffix:semicolon
id|buf.pointer
op_assign
id|kmalloc
c_func
(paren
id|buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf.pointer
)paren
r_return
id|AE_NO_MEMORY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_current_resources
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|ec_cxt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ec_context
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec_cxt
)paren
(brace
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_NO_MEMORY
suffix:semicolon
)brace
id|res
op_assign
(paren
id|RESOURCE
op_star
)paren
id|buf.pointer
suffix:semicolon
id|ec_cxt-&gt;data_port
op_assign
id|res-&gt;data.io.min_base_address
suffix:semicolon
id|res
op_assign
id|NEXT_RESOURCE
c_func
(paren
id|res
)paren
suffix:semicolon
id|ec_cxt-&gt;status_port
op_assign
(paren
r_int
)paren
id|res-&gt;data.io.min_base_address
suffix:semicolon
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
multiline_comment|/* determine GPE bit */
multiline_comment|/* BUG: in acpi 2.0 this could return a package */
id|buf.length
op_assign
r_sizeof
(paren
id|obj
)paren
suffix:semicolon
id|buf.pointer
op_assign
op_amp
id|obj
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_GPE&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
op_logical_or
id|obj.type
op_ne
id|ACPI_TYPE_NUMBER
)paren
r_return
id|AE_OK
suffix:semicolon
id|ec_cxt-&gt;gpe_bit
op_assign
id|obj.number.value
suffix:semicolon
multiline_comment|/* determine if we need the Global Lock when accessing */
id|buf.length
op_assign
r_sizeof
(paren
id|obj
)paren
suffix:semicolon
id|buf.pointer
op_assign
op_amp
id|obj
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_GLK&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|AE_NOT_FOUND
)paren
id|ec_cxt-&gt;need_global_lock
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
op_logical_or
id|obj.type
op_ne
id|ACPI_TYPE_NUMBER
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_ERROR
comma
(paren
l_string|&quot;_GLK failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|ec_cxt-&gt;need_global_lock
op_assign
id|obj.number.value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: found EC @ (0x%02x,0x%02x,gpe %d GL %d)&bslash;n&quot;
comma
id|ec_cxt-&gt;data_port
comma
id|ec_cxt-&gt;status_port
comma
id|ec_cxt-&gt;gpe_bit
comma
id|ec_cxt-&gt;need_global_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_install_gpe_handler
c_func
(paren
id|ec_cxt-&gt;gpe_bit
comma
(paren
id|ACPI_EVENT_LEVEL_TRIGGERED
op_or
id|ACPI_EVENT_EDGE_TRIGGERED
)paren
comma
id|acpi_ec_gpe
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|REPORT_ERROR
c_func
(paren
(paren
l_string|&quot;Could not install GPE handler for EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|status
op_assign
id|acpi_install_address_space_handler
(paren
id|handle
comma
id|ADDRESS_SPACE_EC
comma
id|acpi_ec_region_handler
comma
id|acpi_ec_region_setup
comma
id|ec_cxt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|REPORT_ERROR
c_func
(paren
(paren
l_string|&quot;Could not install EC address &quot;
l_string|&quot;space handler, error %s&bslash;n&quot;
comma
id|acpi_cm_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
r_int
DECL|function|acpi_ec_init
id|acpi_ec_init
c_func
(paren
r_void
)paren
(brace
id|acpi_get_devices
c_func
(paren
id|ACPI_EC_HID
comma
id|acpi_found_ec
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|acpi_ec_terminate
id|acpi_ec_terminate
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* TODO */
multiline_comment|/* walk list of EC&squot;s */
multiline_comment|/* free their context and release resources */
r_return
l_int|0
suffix:semicolon
)brace
eof
