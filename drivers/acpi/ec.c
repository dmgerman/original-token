multiline_comment|/*&n; *  ec.c - Embedded controller support&n; *&n; *  Copyright (C) 2000 Andrew Henroid&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
macro_line|#include &quot;ec.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;ec&quot;
)paren
DECL|macro|ACPI_EC_HID
mdefine_line|#define ACPI_EC_HID&t;&quot;PNP0C09&quot;
r_enum
(brace
DECL|enumerator|ACPI_EC_SMI
id|ACPI_EC_SMI
op_assign
l_int|0x40
comma
DECL|enumerator|ACPI_EC_SCI
id|ACPI_EC_SCI
op_assign
l_int|0x20
comma
DECL|enumerator|ACPI_EC_BURST
id|ACPI_EC_BURST
op_assign
l_int|0x10
comma
DECL|enumerator|ACPI_EC_CMD
id|ACPI_EC_CMD
op_assign
l_int|0x08
comma
DECL|enumerator|ACPI_EC_IBF
id|ACPI_EC_IBF
op_assign
l_int|0x02
comma
DECL|enumerator|ACPI_EC_OBF
id|ACPI_EC_OBF
op_assign
l_int|0x01
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|ACPI_EC_READ
id|ACPI_EC_READ
op_assign
l_int|0x80
comma
DECL|enumerator|ACPI_EC_WRITE
id|ACPI_EC_WRITE
op_assign
l_int|0x81
comma
DECL|enumerator|ACPI_EC_BURST_ENABLE
id|ACPI_EC_BURST_ENABLE
op_assign
l_int|0x82
comma
DECL|enumerator|ACPI_EC_BURST_DISABLE
id|ACPI_EC_BURST_DISABLE
op_assign
l_int|0x83
comma
DECL|enumerator|ACPI_EC_QUERY
id|ACPI_EC_QUERY
op_assign
l_int|0x84
comma
)brace
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|acpi_handle
id|ACPI_HANDLE
id|acpi_handle
suffix:semicolon
DECL|member|gpe_bit
id|u32
id|gpe_bit
suffix:semicolon
DECL|member|status_port
id|ACPI_IO_ADDRESS
id|status_port
suffix:semicolon
DECL|member|data_port
id|ACPI_IO_ADDRESS
id|data_port
suffix:semicolon
DECL|member|need_global_lock
id|u32
id|need_global_lock
suffix:semicolon
DECL|typedef|ec_context_t
)brace
id|ec_context_t
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ec
id|ec_context_t
op_star
id|ec
suffix:semicolon
DECL|member|data
id|u8
id|data
suffix:semicolon
DECL|typedef|EC_QUERY_DATA
)brace
id|EC_QUERY_DATA
suffix:semicolon
DECL|variable|object_name
r_static
r_char
id|object_name
(braket
)braket
op_assign
(brace
l_char|&squot;_&squot;
comma
l_char|&squot;Q&squot;
comma
l_char|&squot;0&squot;
comma
l_char|&squot;0&squot;
comma
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
DECL|variable|hex
r_static
r_char
id|hex
(braket
)braket
op_assign
(brace
l_char|&squot;0&squot;
comma
l_char|&squot;1&squot;
comma
l_char|&squot;2&squot;
comma
l_char|&squot;3&squot;
comma
l_char|&squot;4&squot;
comma
l_char|&squot;5&squot;
comma
l_char|&squot;6&squot;
comma
l_char|&squot;7&squot;
comma
l_char|&squot;8&squot;
comma
l_char|&squot;9&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;B&squot;
comma
l_char|&squot;C&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;E&squot;
comma
l_char|&squot;F&squot;
)brace
suffix:semicolon
r_static
id|ACPI_STATUS
DECL|function|ec_io_wait
id|ec_io_wait
(paren
id|ec_context_t
op_star
id|ec
comma
id|EC_EVENT
id|wait_event
)paren
(brace
id|EC_STATUS
id|ec_status
op_assign
l_int|0
suffix:semicolon
id|UINT32
id|i
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
(paren
(paren
id|wait_event
op_ne
id|EC_EVENT_OUTPUT_BUFFER_FULL
)paren
op_logical_and
(paren
id|wait_event
op_ne
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
)paren
)paren
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
multiline_comment|/* &n;     * Wait for Event:&n;     * ---------------&n;     * Poll the EC status register waiting for the event to occur.&n;     * Note that we&squot;ll wait a maximum of 1ms in 10us chunks.&n;     */
r_switch
c_cond
(paren
id|wait_event
)paren
(brace
r_case
id|EC_EVENT_OUTPUT_BUFFER_FULL
suffix:colon
r_do
(brace
id|ec_status
op_assign
id|acpi_os_in8
c_func
(paren
id|ec-&gt;status_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_status
op_amp
id|EC_FLAG_OUTPUT_BUFFER
)paren
r_return
id|AE_OK
suffix:semicolon
id|acpi_os_sleep_usec
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC_EVENT_INPUT_BUFFER_EMPTY
suffix:colon
r_do
(brace
id|ec_status
op_assign
id|acpi_os_in8
c_func
(paren
id|ec-&gt;status_port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ec_status
op_amp
id|EC_FLAG_INPUT_BUFFER
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
id|acpi_os_sleep_usec
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|AE_TIME
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_io_read
id|ec_io_read
(paren
id|ec_context_t
op_star
id|ec
comma
id|ACPI_IO_ADDRESS
id|io_port
comma
id|UINT8
op_star
id|data
comma
id|EC_EVENT
id|wait_event
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
op_logical_neg
id|data
)paren
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
op_star
id|data
op_assign
id|acpi_os_in8
c_func
(paren
id|io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event
)paren
id|status
op_assign
id|ec_io_wait
c_func
(paren
id|ec
comma
id|wait_event
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_io_write
id|ec_io_write
(paren
id|ec_context_t
op_star
id|ec
comma
id|ACPI_IO_ADDRESS
id|io_port
comma
id|UINT8
id|data
comma
id|EC_EVENT
id|wait_event
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
id|acpi_os_out8
c_func
(paren
id|io_port
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event
)paren
id|status
op_assign
id|ec_io_wait
c_func
(paren
id|ec
comma
id|wait_event
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_read
id|ec_read
(paren
id|ec_context_t
op_star
id|ec
comma
id|UINT8
id|address
comma
id|UINT8
op_star
id|data
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_read&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
op_logical_neg
id|data
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;status_port
comma
id|EC_COMMAND_READ
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Unable to send &squot;read command&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|address
comma
id|EC_EVENT_OUTPUT_BUFFER_FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Unable to send &squot;read address&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_read
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|data
comma
id|EC_EVENT_NONE
)paren
suffix:semicolon
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;Read data[0x%02x] from address[0x%02x] on ec.&bslash;n&quot;
comma
(paren
op_star
id|data
)paren
comma
id|address
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_write
id|ec_write
(paren
id|ec_context_t
op_star
id|ec
comma
id|UINT8
id|address
comma
id|UINT8
id|data
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_write&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;status_port
comma
id|EC_COMMAND_WRITE
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Unable to send &squot;write command&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|address
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Unable to send &squot;write address&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|data
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Unable to send &squot;write data&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;Wrote data[0x%02x] to address[0x%02x] on ec.&bslash;n&quot;
comma
id|data
comma
id|address
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_transaction
id|ec_transaction
(paren
id|ec_context_t
op_star
id|ec
comma
id|EC_REQUEST
op_star
id|request
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_transaction&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
op_logical_neg
id|request
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
multiline_comment|/*&n;     * Obtaining semaphore (mutex) to serialize all EC transactions.&n;     */
multiline_comment|/*&n;    DEBUG_PRINT(ACPI_INFO, (&quot;Calling acpi_os_wait_semaphore(%p, 1, %d)&bslash;n&quot;, ec-&gt;mutex, EC_DEFAULT_TIMEOUT));&n;    status = acpi_os_wait_semaphore(ec-&gt;mutex, 1, EC_DEFAULT_TIMEOUT);&n;    if (ACPI_FAILURE(status))&n;        return_ACPI_STATUS(status);&n;    */
multiline_comment|/*&n;     * Perform the transaction.&n;     */
r_switch
c_cond
(paren
id|request-&gt;command
)paren
(brace
r_case
id|EC_COMMAND_READ
suffix:colon
id|status
op_assign
id|ec_read
c_func
(paren
id|ec
comma
id|request-&gt;address
comma
op_amp
(paren
id|request-&gt;data
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC_COMMAND_WRITE
suffix:colon
id|status
op_assign
id|ec_write
c_func
(paren
id|ec
comma
id|request-&gt;address
comma
id|request-&gt;data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
id|AE_SUPPORT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;     * Signal the semaphore (mutex) to indicate transaction completion.&n;     */
multiline_comment|/*&n;    DEBUG_PRINT(ACPI_INFO, (&quot;Calling acpi_os_signal_semaphore(%p, 1)&bslash;n&quot;, ec-&gt;mutex));&n;    acpi_os_signal_semaphore(ec-&gt;mutex, 1);&n;    */
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_space_setup
id|ec_space_setup
(paren
id|ACPI_HANDLE
id|region_handle
comma
id|UINT32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|return_context
)paren
(brace
singleline_comment|// TODO: What is this function for?
multiline_comment|/* &n;&t; * The ec object is in the handler context and is needed&n;&t; * when calling the ec_space_handler.&n;&t; */
op_star
id|return_context
op_assign
id|handler_context
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_static
r_void
DECL|function|ec_query_handler
id|ec_query_handler
(paren
r_void
op_star
id|context
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|EC_QUERY_DATA
op_star
id|ec_q
op_assign
(paren
id|EC_QUERY_DATA
op_star
)paren
id|context
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_query_handler&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec_q
op_logical_or
op_logical_neg
id|ec_q-&gt;ec
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_ERROR
comma
(paren
l_string|&quot;Invalid (NULL) context.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/*&n;     * Evaluate _Qxx:&n;     * --------------&n;     * Evaluate corresponding _Qxx method.  Note that a zero query&n;     * value indicates a spurious EC_SCI (no such thing as _Q00).&n;     */
id|object_name
(braket
l_int|2
)braket
op_assign
id|hex
(braket
(paren
(paren
id|ec_q-&gt;data
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
)paren
)braket
suffix:semicolon
id|object_name
(braket
l_int|3
)braket
op_assign
id|hex
(braket
(paren
id|ec_q-&gt;data
op_amp
l_int|0x0F
)paren
)braket
suffix:semicolon
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;Read query data[0x%02x] from ec - evaluating [%s].&bslash;n&quot;
comma
id|ec_q-&gt;data
comma
id|object_name
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|ec_q-&gt;ec-&gt;acpi_handle
comma
id|object_name
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ec_q
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/*&n; * handle GPE&n; */
r_static
r_void
DECL|function|ec_gpe_handler
id|ec_gpe_handler
c_func
(paren
r_void
op_star
id|context
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ec_context_t
op_star
id|ec
op_assign
(paren
id|ec_context_t
op_star
)paren
id|context
suffix:semicolon
id|EC_QUERY_DATA
op_star
id|ec_q
op_assign
l_int|NULL
suffix:semicolon
id|EC_STATUS
id|ec_status
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_gpe_handler&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;Invalid (NULL) context.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
singleline_comment|// GET SPINLOCK!
multiline_comment|/*&n;     * EC_SCI?&n;     * -------&n;     * Check the EC_SCI bit to see if this is an EC_SCI event.  If not (e.g.&n;     * OBF/IBE) just return, as we already poll to detect these events.&n;     */
id|ec_status
op_assign
id|acpi_os_in8
c_func
(paren
id|ec-&gt;status_port
)paren
suffix:semicolon
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;EC Status Register: [0x%02x]&bslash;n&quot;
comma
id|ec_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ec_status
op_amp
id|EC_FLAG_SCI
)paren
)paren
id|return_VOID
suffix:semicolon
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;EC_SCI detected - running QUERY.&bslash;n&quot;
)paren
)paren
suffix:semicolon
singleline_comment|// TODO: Need GFP_ATOMIC &squot;switch&squot; for OSL interface...
id|ec_q
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|EC_QUERY_DATA
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec_q
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;Memory allocation failure.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
id|ec_q-&gt;ec
op_assign
id|ec
suffix:semicolon
id|ec_q-&gt;data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * Run Query:&n;     * ----------&n;     * Query the EC to find out which _Qxx method we need to evaluate.&n;     * Note that successful completion of the query causes the EC_SCI&n;     * bit to be cleared (and thus clearing the interrupt source).&n;     */
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;status_port
comma
id|EC_COMMAND_QUERY
comma
id|EC_EVENT_OUTPUT_BUFFER_FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Unable to send &squot;query command&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|End
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_read
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
op_amp
(paren
id|ec_q-&gt;data
)paren
comma
id|EC_EVENT_NONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Error reading query data.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|End
suffix:semicolon
)brace
singleline_comment|// RELEASE SPINLOCK!
r_if
c_cond
(paren
op_logical_neg
id|ec_q-&gt;data
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Spurious EC SCI detected.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_ERROR
suffix:semicolon
r_goto
id|End
suffix:semicolon
)brace
multiline_comment|/*&n;     * Defer _Qxx Execution:&n;     * ---------------------&n;     * Can&squot;t evaluate this method now &squot;cause we&squot;re at interrupt-level.&n;     */
id|status
op_assign
id|acpi_os_queue_for_execution
c_func
(paren
id|OSD_PRIORITY_GPE
comma
id|ec_query_handler
comma
id|ec_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_ERROR
comma
(paren
l_string|&quot;Unable to defer _Qxx method evaluation.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|End
suffix:semicolon
)brace
id|End
suffix:colon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|kfree
c_func
(paren
id|ec_q
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
r_static
id|ACPI_STATUS
DECL|function|ec_region_setup
id|ec_region_setup
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_ec_region_setup&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;acpi_ec_region_setup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
r_if
c_cond
(paren
op_star
id|region_context
)paren
(brace
id|acpi_cm_free
(paren
op_star
id|region_context
)paren
suffix:semicolon
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * &n; * FUNCTION:    ec_region_handler&n; *&n; * PARAMETERS:  function            - Read or Write operation&n; *              address             - Where in the space to read or write&n; *              bit_width            - Field width in bits (8, 16, or 32)&n; *              value               - Pointer to in or out value&n; *              context             - context pointer&n; *&n; * RETURN:      &lt;TBD&gt;&n; *&n; * DESCRIPTION: Handler for the Embedded Controller (EC) address space &n; *              (Op Region)&n; *&n; ****************************************************************************/
r_static
id|ACPI_STATUS
DECL|function|ec_region_handler
id|ec_region_handler
(paren
id|UINT32
id|function
comma
id|ACPI_PHYSICAL_ADDRESS
id|address
comma
id|UINT32
id|bit_width
comma
id|UINT32
op_star
id|value
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
id|region_context
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ec_context_t
op_star
id|ec
op_assign
l_int|NULL
suffix:semicolon
id|EC_REQUEST
id|ec_request
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_space_handler&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address
OG
l_int|0xFF
op_logical_or
id|bit_width
op_ne
l_int|8
op_logical_or
op_logical_neg
id|value
op_logical_or
op_logical_neg
id|handler_context
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
id|ec
op_assign
(paren
id|ec_context_t
op_star
)paren
id|handler_context
suffix:semicolon
r_switch
c_cond
(paren
id|function
)paren
(brace
r_case
id|ADDRESS_SPACE_READ
suffix:colon
id|ec_request.command
op_assign
id|EC_COMMAND_READ
suffix:semicolon
id|ec_request.address
op_assign
id|address
suffix:semicolon
id|ec_request.data
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ADDRESS_SPACE_WRITE
suffix:colon
id|ec_request.command
op_assign
id|EC_COMMAND_WRITE
suffix:semicolon
id|ec_request.address
op_assign
id|address
suffix:semicolon
id|ec_request.data
op_assign
(paren
id|UINT8
)paren
(paren
op_star
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG_PRINT
c_func
(paren
id|ACPI_WARN
comma
(paren
l_string|&quot;Received request with invalid function [0x%08X].&bslash;n&quot;
comma
id|function
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_INFO
comma
(paren
l_string|&quot;device[ec] command[0x%02X] address[0x%02X] data[0x%02X]&bslash;n&quot;
comma
id|ec_request.command
comma
id|ec_request.address
comma
id|ec_request.data
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;     * Perform the Transaction.&n;     */
id|status
op_assign
id|ec_transaction
c_func
(paren
id|ec
comma
op_amp
id|ec_request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(paren
op_star
id|value
)paren
op_assign
(paren
id|UINT32
)paren
id|ec_request.data
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get Embedded Controller information&n; */
r_static
id|ACPI_STATUS
DECL|function|found_ec
id|found_ec
c_func
(paren
id|ACPI_HANDLE
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctx
comma
r_void
op_star
op_star
id|value
)paren
(brace
id|ACPI_STATUS
id|status
suffix:semicolon
id|ACPI_OBJECT
id|obj
suffix:semicolon
id|ACPI_BUFFER
id|buf
suffix:semicolon
id|RESOURCE
op_star
id|res
suffix:semicolon
id|ec_context_t
op_star
id|ec_cxt
suffix:semicolon
id|buf.length
op_assign
l_int|0
suffix:semicolon
id|buf.pointer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|acpi_get_current_resources
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
op_ne
id|AE_BUFFER_OVERFLOW
)paren
r_return
id|AE_OK
suffix:semicolon
id|buf.pointer
op_assign
id|kmalloc
c_func
(paren
id|buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf.pointer
)paren
r_return
id|AE_NO_MEMORY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_current_resources
c_func
(paren
id|handle
comma
op_amp
id|buf
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|ec_cxt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ec_context_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec_cxt
)paren
(brace
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
r_return
id|AE_NO_MEMORY
suffix:semicolon
)brace
id|ec_cxt-&gt;acpi_handle
op_assign
id|handle
suffix:semicolon
id|res
op_assign
(paren
id|RESOURCE
op_star
)paren
id|buf.pointer
suffix:semicolon
id|ec_cxt-&gt;data_port
op_assign
id|res-&gt;data.io.min_base_address
suffix:semicolon
id|res
op_assign
id|NEXT_RESOURCE
c_func
(paren
id|res
)paren
suffix:semicolon
id|ec_cxt-&gt;status_port
op_assign
(paren
r_int
)paren
id|res-&gt;data.io.min_base_address
suffix:semicolon
id|kfree
c_func
(paren
id|buf.pointer
)paren
suffix:semicolon
multiline_comment|/* determine GPE bit */
multiline_comment|/* BUG: in acpi 2.0 this could return a package */
id|buf.length
op_assign
r_sizeof
(paren
id|obj
)paren
suffix:semicolon
id|buf.pointer
op_assign
op_amp
id|obj
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_GPE&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
)paren
op_logical_or
id|obj.type
op_ne
id|ACPI_TYPE_NUMBER
)paren
r_return
id|AE_OK
suffix:semicolon
id|ec_cxt-&gt;gpe_bit
op_assign
id|obj.number.value
suffix:semicolon
multiline_comment|/* determine if we need the Global Lock when accessing */
id|buf.length
op_assign
r_sizeof
(paren
id|obj
)paren
suffix:semicolon
id|buf.pointer
op_assign
op_amp
id|obj
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
l_string|&quot;_GLK&quot;
comma
l_int|NULL
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|AE_NOT_FOUND
)paren
id|ec_cxt-&gt;need_global_lock
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
op_logical_or
id|obj.type
op_ne
id|ACPI_TYPE_NUMBER
)paren
(brace
id|DEBUG_PRINT
c_func
(paren
id|ACPI_ERROR
comma
(paren
l_string|&quot;_GLK failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|ec_cxt-&gt;need_global_lock
op_assign
id|obj.number.value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: found EC @ (0x%02x,0x%02x,gpe %d GL %d)&bslash;n&quot;
comma
id|ec_cxt-&gt;data_port
comma
id|ec_cxt-&gt;status_port
comma
id|ec_cxt-&gt;gpe_bit
comma
id|ec_cxt-&gt;need_global_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|acpi_install_gpe_handler
c_func
(paren
id|ec_cxt-&gt;gpe_bit
comma
id|ACPI_EVENT_EDGE_TRIGGERED
comma
id|ec_gpe_handler
comma
id|ec_cxt
)paren
)paren
)paren
(brace
id|REPORT_ERROR
c_func
(paren
(paren
l_string|&quot;Could not install GPE handler for EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|status
op_assign
id|acpi_install_address_space_handler
(paren
id|handle
comma
id|ADDRESS_SPACE_EC
comma
id|ec_region_handler
comma
id|ec_region_setup
comma
id|ec_cxt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|REPORT_ERROR
c_func
(paren
(paren
l_string|&quot;Could not install EC address &quot;
l_string|&quot;space handler, error %s&bslash;n&quot;
comma
id|acpi_cm_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
r_int
DECL|function|acpi_ec_init
id|acpi_ec_init
c_func
(paren
r_void
)paren
(brace
id|acpi_get_devices
c_func
(paren
id|ACPI_EC_HID
comma
id|found_ec
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|acpi_ec_terminate
id|acpi_ec_terminate
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* TODO */
multiline_comment|/* walk list of EC&squot;s */
multiline_comment|/* free their context and release resources */
r_return
l_int|0
suffix:semicolon
)brace
eof
