multiline_comment|/******************************************************************************&n; *&n; * Module Name: tbtable - ACPI tables: FACP, FACS, and RSDP utilities&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;hardware.h&quot;
macro_line|#include &quot;tables.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          TABLE_MANAGER
id|MODULE_NAME
(paren
l_string|&quot;tbtable&quot;
)paren
suffix:semicolon
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_tb_get_table_rsdt&n; *&n; * PARAMETERS:  Number_of_tables    - Where the table count is placed&n; *              Table_ptr           - Input buffer pointer, optional&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Load and validate the RSDP (ptr) and RSDT (table)&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_tb_get_table_rsdt
id|acpi_tb_get_table_rsdt
(paren
id|u32
op_star
id|number_of_tables
)paren
(brace
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ACPI_TABLE_DESC
id|table_info
suffix:semicolon
multiline_comment|/* Get the RSDP */
id|status
op_assign
id|acpi_tb_find_rsdp
(paren
op_amp
id|table_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|REPORT_WARNING
(paren
l_string|&quot;RSDP structure not found&quot;
)paren
suffix:semicolon
r_return
(paren
id|AE_NO_ACPI_TABLES
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the table pointers and allocation info */
id|status
op_assign
id|acpi_tb_init_table_descriptor
(paren
id|ACPI_TABLE_RSDP
comma
op_amp
id|table_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|acpi_gbl_RSDP
op_assign
(paren
id|ROOT_SYSTEM_DESCRIPTOR_POINTER
op_star
)paren
id|table_info.pointer
suffix:semicolon
multiline_comment|/*&n;&t; * RSDP structure was found;  Now get the RSDT&n;&t; */
id|status
op_assign
id|acpi_tb_get_table
(paren
(paren
r_void
op_star
)paren
id|acpi_gbl_RSDP-&gt;rsdt_physical_address
comma
l_int|NULL
comma
op_amp
id|table_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
id|AE_BAD_SIGNATURE
)paren
(brace
multiline_comment|/* Invalid RSDT signature */
id|REPORT_ERROR
(paren
l_string|&quot;Invalid signature where RSDP indicates RSDT should be located&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Always delete the RSDP mapping */
id|acpi_tb_delete_acpi_table
(paren
id|ACPI_TABLE_RSDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the table pointers and allocation info */
id|status
op_assign
id|acpi_tb_init_table_descriptor
(paren
id|ACPI_TABLE_RSDT
comma
op_amp
id|table_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|acpi_gbl_RSDT
op_assign
(paren
id|ROOT_SYSTEM_DESCRIPTION_TABLE
op_star
)paren
id|table_info.pointer
suffix:semicolon
multiline_comment|/* Valid RSDT signature, verify the checksum */
id|status
op_assign
id|acpi_tb_verify_table_checksum
(paren
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|acpi_gbl_RSDT
)paren
suffix:semicolon
multiline_comment|/* Determine the number of tables pointed to by the RSDT */
op_star
id|number_of_tables
op_assign
(paren
id|s32
)paren
id|DIV_4
(paren
id|acpi_gbl_RSDT-&gt;header.length
op_minus
r_sizeof
(paren
id|ACPI_TABLE_HEADER
)paren
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_tb_scan_memory_for_rsdp&n; *&n; * PARAMETERS:  Start_address       - Starting pointer for search&n; *              Length              - Maximum length to search&n; *&n; * RETURN:      Pointer to the RSDP if found, otherwise NULL.&n; *&n; * DESCRIPTION: Search a block of memory for the RSDP signature&n; *&n; ******************************************************************************/
r_char
op_star
DECL|function|acpi_tb_scan_memory_for_rsdp
id|acpi_tb_scan_memory_for_rsdp
(paren
r_char
op_star
id|start_address
comma
id|u32
id|length
)paren
(brace
id|u32
id|offset
suffix:semicolon
r_char
op_star
id|mem_rover
suffix:semicolon
multiline_comment|/* Search from given start addr for the requested length  */
r_for
c_loop
(paren
id|offset
op_assign
l_int|0
comma
id|mem_rover
op_assign
id|start_address
suffix:semicolon
id|offset
OL
id|length
suffix:semicolon
id|offset
op_add_assign
id|RSDP_SCAN_STEP
comma
id|mem_rover
op_add_assign
id|RSDP_SCAN_STEP
)paren
(brace
multiline_comment|/* The signature and checksum must both be correct */
r_if
c_cond
(paren
id|STRNCMP
(paren
id|mem_rover
comma
id|RSDP_SIG
comma
r_sizeof
(paren
id|RSDP_SIG
)paren
op_minus
l_int|1
)paren
op_eq
l_int|0
op_logical_and
id|acpi_tb_checksum
(paren
id|mem_rover
comma
r_sizeof
(paren
id|ROOT_SYSTEM_DESCRIPTOR_POINTER
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If so, we have found the RSDP */
r_return
id|mem_rover
suffix:semicolon
)brace
)brace
multiline_comment|/* Searched entire block, no RSDP was found */
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_tb_find_rsdp&n; *&n; * PARAMETERS:  *Buffer_ptr             - If == NULL, read data from buffer&n; *                                        rather than searching memory&n; *              *Table_info             - Where the table info is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Search lower 1_mbyte of memory for the root system descriptor&n; *              pointer structure.  If it is found, set *RSDP to point to it.&n; *&n; *              NOTE: The RSDP must be either in the first 1_k of the Extended&n; *              BIOS Data Area or between E0000 and FFFFF (ACPI 1.0 section&n; *              5.2.2; assertion #421).&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_tb_find_rsdp
id|acpi_tb_find_rsdp
(paren
id|ACPI_TABLE_DESC
op_star
id|table_info
)paren
(brace
r_char
op_star
id|table_ptr
suffix:semicolon
r_char
op_star
id|mem_rover
suffix:semicolon
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_acpi_init_data.RSDP_physical_address
)paren
(brace
multiline_comment|/*&n;&t;&t; *  RSDP address was supplied as part of the initialization data&n;&t;&t; */
id|status
op_assign
id|acpi_os_map_memory
c_func
(paren
id|acpi_gbl_acpi_init_data.RSDP_physical_address
comma
r_sizeof
(paren
id|ROOT_SYSTEM_DESCRIPTOR_POINTER
)paren
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|table_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|table_ptr
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *  The signature and checksum must both be correct&n;&t;&t; */
r_if
c_cond
(paren
id|STRNCMP
(paren
id|table_ptr
comma
id|RSDP_SIG
comma
r_sizeof
(paren
id|RSDP_SIG
)paren
op_minus
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Nope, BAD Signature */
r_return
(paren
id|AE_BAD_SIGNATURE
)paren
suffix:semicolon
)brace
multiline_comment|/* The signature and checksum must both be correct */
r_if
c_cond
(paren
id|acpi_tb_checksum
(paren
id|table_ptr
comma
r_sizeof
(paren
id|ROOT_SYSTEM_DESCRIPTOR_POINTER
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Nope, BAD Checksum */
r_return
(paren
id|AE_BAD_CHECKSUM
)paren
suffix:semicolon
)brace
multiline_comment|/* RSDP supplied is OK */
multiline_comment|/* If so, we have found the RSDP */
id|table_info-&gt;pointer
op_assign
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|table_ptr
suffix:semicolon
id|table_info-&gt;length
op_assign
r_sizeof
(paren
id|ROOT_SYSTEM_DESCRIPTOR_POINTER
)paren
suffix:semicolon
id|table_info-&gt;allocation
op_assign
id|ACPI_MEM_MAPPED
suffix:semicolon
id|table_info-&gt;base_pointer
op_assign
id|table_ptr
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Search memory for RSDP.  First map low physical memory.&n;&t; */
id|status
op_assign
id|acpi_os_map_memory
(paren
id|LO_RSDP_WINDOW_BASE
comma
id|LO_RSDP_WINDOW_SIZE
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|table_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 1) Search EBDA (low memory) paragraphs&n;&t; */
r_if
c_cond
(paren
l_int|NULL
op_ne
(paren
id|mem_rover
op_assign
id|acpi_tb_scan_memory_for_rsdp
(paren
id|table_ptr
comma
id|LO_RSDP_WINDOW_SIZE
)paren
)paren
)paren
(brace
multiline_comment|/* Found it, return pointer and don&squot;t delete the mapping */
id|table_info-&gt;pointer
op_assign
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|mem_rover
suffix:semicolon
id|table_info-&gt;length
op_assign
id|LO_RSDP_WINDOW_SIZE
suffix:semicolon
id|table_info-&gt;allocation
op_assign
id|ACPI_MEM_MAPPED
suffix:semicolon
id|table_info-&gt;base_pointer
op_assign
id|table_ptr
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* This mapping is no longer needed */
id|acpi_os_unmap_memory
(paren
id|table_ptr
comma
id|LO_RSDP_WINDOW_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * 2) Search upper memory: 16-byte boundaries in E0000h-F0000h&n;&t; */
id|status
op_assign
id|acpi_os_map_memory
(paren
id|HI_RSDP_WINDOW_BASE
comma
id|HI_RSDP_WINDOW_SIZE
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|table_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_ne
(paren
id|mem_rover
op_assign
id|acpi_tb_scan_memory_for_rsdp
(paren
id|table_ptr
comma
id|HI_RSDP_WINDOW_SIZE
)paren
)paren
)paren
(brace
multiline_comment|/* Found it, return pointer and don&squot;t delete the mapping */
id|table_info-&gt;pointer
op_assign
(paren
id|ACPI_TABLE_HEADER
op_star
)paren
id|mem_rover
suffix:semicolon
id|table_info-&gt;length
op_assign
id|HI_RSDP_WINDOW_SIZE
suffix:semicolon
id|table_info-&gt;allocation
op_assign
id|ACPI_MEM_MAPPED
suffix:semicolon
id|table_info-&gt;base_pointer
op_assign
id|table_ptr
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* This mapping is no longer needed */
id|acpi_os_unmap_memory
(paren
id|table_ptr
comma
id|HI_RSDP_WINDOW_SIZE
)paren
suffix:semicolon
multiline_comment|/* RSDP signature was not found */
r_return
(paren
id|AE_NOT_FOUND
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_tb_get_table_facs&n; *&n; * PARAMETERS:  *Buffer_ptr             - If == NULL, read data from buffer&n; *                                        rather than searching memory&n; *              *Table_info             - Where the table info is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Returns a pointer to the FACS as defined in FACP.  This&n; *              function assumes the global variable FACP has been&n; *              correctly initialized.  The value of FACP-&gt;Firmware_ctrl&n; *              into a far pointer which is returned.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_tb_get_table_facs
id|acpi_tb_get_table_facs
(paren
r_char
op_star
id|buffer_ptr
comma
id|ACPI_TABLE_DESC
op_star
id|table_info
)paren
(brace
r_void
op_star
id|table_ptr
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|size
suffix:semicolon
id|u8
id|allocation
suffix:semicolon
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
multiline_comment|/* Must have a valid FACP pointer */
r_if
c_cond
(paren
op_logical_neg
id|acpi_gbl_FACP
)paren
(brace
r_return
(paren
id|AE_NO_ACPI_TABLES
)paren
suffix:semicolon
)brace
id|size
op_assign
r_sizeof
(paren
id|FIRMWARE_ACPI_CONTROL_STRUCTURE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer_ptr
)paren
(brace
multiline_comment|/*&n;&t;&t; * Getting table from a file -- allocate a buffer and&n;&t;&t; * read the table.&n;&t;&t; */
id|table_ptr
op_assign
id|acpi_cm_allocate
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|table_ptr
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|MEMCPY
(paren
id|table_ptr
comma
id|buffer_ptr
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Save allocation type */
id|allocation
op_assign
id|ACPI_MEM_ALLOCATED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Just map the physical memory to our address space */
id|status
op_assign
id|acpi_tb_map_acpi_table
(paren
(paren
r_void
op_star
)paren
id|acpi_gbl_FACP-&gt;firmware_ctrl
comma
op_amp
id|size
comma
op_amp
id|table_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Save allocation type */
id|allocation
op_assign
id|ACPI_MEM_MAPPED
suffix:semicolon
)brace
multiline_comment|/* Return values */
id|table_info-&gt;pointer
op_assign
id|table_ptr
suffix:semicolon
id|table_info-&gt;length
op_assign
id|size
suffix:semicolon
id|table_info-&gt;allocation
op_assign
id|allocation
suffix:semicolon
id|table_info-&gt;base_pointer
op_assign
id|table_ptr
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
eof
