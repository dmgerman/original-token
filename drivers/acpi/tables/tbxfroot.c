multiline_comment|/******************************************************************************&n; *&n; * Module Name: tbxfroot - Find the root ACPI table (RSDT)&n; *              $Revision: 33 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;achware.h&quot;
macro_line|#include &quot;actables.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          TABLE_MANAGER
id|MODULE_NAME
(paren
l_string|&quot;tbxfroot&quot;
)paren
DECL|macro|RSDP_CHECKSUM_LENGTH
mdefine_line|#define RSDP_CHECKSUM_LENGTH 20
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_find_root_pointer&n; *&n; * PARAMETERS:  **Rsdp_physical_address     - Where to place the RSDP address&n; *&n; * RETURN:      Status, Physical address of the RSDP&n; *&n; * DESCRIPTION: Find the RSDP&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_find_root_pointer
id|acpi_find_root_pointer
(paren
id|ACPI_PHYSICAL_ADDRESS
op_star
id|rsdp_physical_address
)paren
(brace
id|ACPI_TABLE_DESC
id|table_info
suffix:semicolon
id|ACPI_STATUS
id|status
suffix:semicolon
multiline_comment|/* Get the RSDP */
id|status
op_assign
id|acpi_tb_find_rsdp
(paren
op_amp
id|table_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|AE_NO_ACPI_TABLES
)paren
suffix:semicolon
)brace
op_star
id|rsdp_physical_address
op_assign
id|table_info.physical_address
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_tb_scan_memory_for_rsdp&n; *&n; * PARAMETERS:  Start_address       - Starting pointer for search&n; *              Length              - Maximum length to search&n; *&n; * RETURN:      Pointer to the RSDP if found, otherwise NULL.&n; *&n; * DESCRIPTION: Search a block of memory for the RSDP signature&n; *&n; ******************************************************************************/
id|u8
op_star
DECL|function|acpi_tb_scan_memory_for_rsdp
id|acpi_tb_scan_memory_for_rsdp
(paren
id|u8
op_star
id|start_address
comma
id|u32
id|length
)paren
(brace
id|u32
id|offset
suffix:semicolon
id|u8
op_star
id|mem_rover
suffix:semicolon
multiline_comment|/* Search from given start addr for the requested length  */
r_for
c_loop
(paren
id|offset
op_assign
l_int|0
comma
id|mem_rover
op_assign
id|start_address
suffix:semicolon
id|offset
OL
id|length
suffix:semicolon
id|offset
op_add_assign
id|RSDP_SCAN_STEP
comma
id|mem_rover
op_add_assign
id|RSDP_SCAN_STEP
)paren
(brace
multiline_comment|/* The signature and checksum must both be correct */
r_if
c_cond
(paren
id|STRNCMP
(paren
(paren
id|NATIVE_CHAR
op_star
)paren
id|mem_rover
comma
id|RSDP_SIG
comma
r_sizeof
(paren
id|RSDP_SIG
)paren
op_minus
l_int|1
)paren
op_eq
l_int|0
op_logical_and
id|acpi_tb_checksum
(paren
id|mem_rover
comma
id|RSDP_CHECKSUM_LENGTH
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If so, we have found the RSDP */
r_return
(paren
id|mem_rover
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Searched entire block, no RSDP was found */
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_tb_find_rsdp&n; *&n; * PARAMETERS:  *Buffer_ptr             - If == NULL, read data from buffer&n; *                                        rather than searching memory&n; *              *Table_info             - Where the table info is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Search lower 1_mbyte of memory for the root system descriptor&n; *              pointer structure.  If it is found, set *RSDP to point to it.&n; *&n; *              NOTE: The RSDP must be either in the first 1_k of the Extended&n; *              BIOS Data Area or between E0000 and FFFFF (ACPI 1.0 section&n; *              5.2.2; assertion #421).&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_tb_find_rsdp
id|acpi_tb_find_rsdp
(paren
id|ACPI_TABLE_DESC
op_star
id|table_info
)paren
(brace
id|u8
op_star
id|table_ptr
suffix:semicolon
id|u8
op_star
id|mem_rover
suffix:semicolon
id|UINT64
id|phys_addr
suffix:semicolon
id|ACPI_STATUS
id|status
op_assign
id|AE_OK
suffix:semicolon
multiline_comment|/*&n;&t; * Search memory for RSDP.  First map low physical memory.&n;&t; */
id|status
op_assign
id|acpi_os_map_memory
(paren
id|LO_RSDP_WINDOW_BASE
comma
id|LO_RSDP_WINDOW_SIZE
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|table_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 1) Search EBDA (low memory) paragraphs&n;&t; */
id|mem_rover
op_assign
id|acpi_tb_scan_memory_for_rsdp
(paren
id|table_ptr
comma
id|LO_RSDP_WINDOW_SIZE
)paren
suffix:semicolon
multiline_comment|/* This mapping is no longer needed */
id|acpi_os_unmap_memory
(paren
id|table_ptr
comma
id|LO_RSDP_WINDOW_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem_rover
)paren
(brace
multiline_comment|/* Found it, return the physical address */
id|phys_addr
op_assign
id|LO_RSDP_WINDOW_BASE
suffix:semicolon
id|phys_addr
op_add_assign
(paren
id|mem_rover
op_minus
id|table_ptr
)paren
suffix:semicolon
id|table_info-&gt;physical_address
op_assign
id|phys_addr
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 2) Search upper memory: 16-byte boundaries in E0000h-F0000h&n;&t; */
id|status
op_assign
id|acpi_os_map_memory
(paren
id|HI_RSDP_WINDOW_BASE
comma
id|HI_RSDP_WINDOW_SIZE
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|table_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|mem_rover
op_assign
id|acpi_tb_scan_memory_for_rsdp
(paren
id|table_ptr
comma
id|HI_RSDP_WINDOW_SIZE
)paren
suffix:semicolon
multiline_comment|/* This mapping is no longer needed */
id|acpi_os_unmap_memory
(paren
id|table_ptr
comma
id|HI_RSDP_WINDOW_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem_rover
)paren
(brace
multiline_comment|/* Found it, return the physical address */
id|phys_addr
op_assign
id|HI_RSDP_WINDOW_BASE
suffix:semicolon
id|phys_addr
op_add_assign
(paren
id|mem_rover
op_minus
id|table_ptr
)paren
suffix:semicolon
id|table_info-&gt;physical_address
op_assign
id|phys_addr
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* RSDP signature was not found */
r_return
(paren
id|AE_NOT_FOUND
)paren
suffix:semicolon
)brace
eof
