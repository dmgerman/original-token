multiline_comment|/*&n; *  sys.c - System management (suspend, ...)&n; *&n; *  Copyright (C) 2000 Andrew Henroid&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;driver.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;OS_DEPENDENT
id|MODULE_NAME
(paren
l_string|&quot;sys&quot;
)paren
DECL|macro|ACPI_SLP_TYP
mdefine_line|#define ACPI_SLP_TYP(typa, typb)&t;(((int)(typa) &lt;&lt; 8) | (int)(typb))
DECL|macro|ACPI_SLP_TYPA
mdefine_line|#define ACPI_SLP_TYPA(value)&t;&t;((value) &gt;&gt; 8)
DECL|macro|ACPI_SLP_TYPB
mdefine_line|#define ACPI_SLP_TYPB(value)&t;&t;((value) &amp; 0xff)
DECL|struct|acpi_enter_sx_ctx
r_struct
id|acpi_enter_sx_ctx
(brace
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|acpi_sleep_state
r_volatile
id|acpi_sstate_t
id|acpi_sleep_state
op_assign
id|ACPI_S0
suffix:semicolon
DECL|variable|acpi_slptyp
r_static
r_int
r_int
id|acpi_slptyp
(braket
id|ACPI_S5
op_plus
l_int|1
)braket
op_assign
(brace
id|ACPI_INVALID
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Enter system sleep state&n; */
r_static
r_void
DECL|function|acpi_enter_sx_async
id|acpi_enter_sx_async
c_func
(paren
r_void
op_star
id|context
)paren
(brace
r_struct
id|acpi_enter_sx_ctx
op_star
id|ctx
op_assign
(paren
r_struct
id|acpi_enter_sx_ctx
op_star
)paren
id|context
suffix:semicolon
id|ACPI_OBJECT_LIST
id|arg_list
suffix:semicolon
id|ACPI_OBJECT
id|arg
suffix:semicolon
multiline_comment|/*&n;         * _PSW methods could be run here to enable wake-on keyboard, LAN, etc.&n;&t; */
singleline_comment|// run the _PTS method
id|memset
c_func
(paren
op_amp
id|arg_list
comma
l_int|0
comma
r_sizeof
(paren
id|arg_list
)paren
)paren
suffix:semicolon
id|arg_list.count
op_assign
l_int|1
suffix:semicolon
id|arg_list.pointer
op_assign
op_amp
id|arg
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|arg
comma
l_int|0
comma
r_sizeof
(paren
id|arg
)paren
)paren
suffix:semicolon
id|arg.type
op_assign
id|ACPI_TYPE_NUMBER
suffix:semicolon
id|arg.number.value
op_assign
id|ctx-&gt;state
suffix:semicolon
id|acpi_evaluate_object
c_func
(paren
l_int|NULL
comma
l_string|&quot;&bslash;&bslash;_PTS&quot;
comma
op_amp
id|arg_list
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// clear wake status by writing a 1
id|acpi_hw_register_bit_access
c_func
(paren
id|ACPI_WRITE
comma
id|ACPI_MTX_LOCK
comma
id|WAK_STS
comma
l_int|1
)paren
suffix:semicolon
id|acpi_sleep_state
op_assign
id|ctx-&gt;state
suffix:semicolon
singleline_comment|// set ACPI_SLP_TYPA/b and ACPI_SLP_EN
id|acpi_hw_register_bit_access
c_func
(paren
id|ACPI_WRITE
comma
id|ACPI_MTX_LOCK
comma
id|SLP_TYPE_A
comma
id|ACPI_SLP_TYPA
c_func
(paren
id|acpi_slptyp
(braket
id|ctx-&gt;state
)braket
)paren
)paren
suffix:semicolon
id|acpi_hw_register_bit_access
c_func
(paren
id|ACPI_WRITE
comma
id|ACPI_MTX_LOCK
comma
id|SLP_TYPE_B
comma
id|ACPI_SLP_TYPB
c_func
(paren
id|acpi_slptyp
(braket
id|ctx-&gt;state
)braket
)paren
)paren
suffix:semicolon
id|acpi_hw_register_bit_access
c_func
(paren
id|ACPI_WRITE
comma
id|ACPI_MTX_LOCK
comma
id|SLP_EN
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctx-&gt;state
op_ne
id|ACPI_S1
)paren
(brace
multiline_comment|/* we should have just shut off - what are we doing here? */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: S%d failed&bslash;n&quot;
comma
id|ctx-&gt;state
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
singleline_comment|// wait until S1 is entered
r_while
c_loop
(paren
op_logical_neg
(paren
id|acpi_hw_register_bit_access
c_func
(paren
id|ACPI_READ
comma
id|ACPI_MTX_LOCK
comma
id|WAK_STS
)paren
)paren
)paren
id|safe_halt
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// run the _WAK method
id|memset
c_func
(paren
op_amp
id|arg_list
comma
l_int|0
comma
r_sizeof
(paren
id|arg_list
)paren
)paren
suffix:semicolon
id|arg_list.count
op_assign
l_int|1
suffix:semicolon
id|arg_list.pointer
op_assign
op_amp
id|arg
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|arg
comma
l_int|0
comma
r_sizeof
(paren
id|arg
)paren
)paren
suffix:semicolon
id|arg.type
op_assign
id|ACPI_TYPE_NUMBER
suffix:semicolon
id|arg.number.value
op_assign
id|ctx-&gt;state
suffix:semicolon
id|acpi_evaluate_object
c_func
(paren
l_int|NULL
comma
l_string|&quot;&bslash;&bslash;_WAK&quot;
comma
op_amp
id|arg_list
comma
l_int|NULL
)paren
suffix:semicolon
id|out
suffix:colon
id|acpi_sleep_state
op_assign
id|ACPI_S0
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ctx-&gt;wait
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ctx-&gt;wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Enter soft-off (S5)&n; */
r_static
r_void
DECL|function|acpi_power_off
id|acpi_power_off
c_func
(paren
r_void
)paren
(brace
r_struct
id|acpi_enter_sx_ctx
id|ctx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STRNCMP
c_func
(paren
id|acpi_fadt.header.signature
comma
id|ACPI_FADT_SIGNATURE
comma
id|ACPI_SIG_LEN
)paren
op_ne
l_int|0
)paren
op_logical_or
id|acpi_slptyp
(braket
id|ACPI_S5
)braket
op_eq
id|ACPI_INVALID
)paren
r_return
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ctx.wait
)paren
suffix:semicolon
id|ctx.state
op_assign
id|ACPI_S5
suffix:semicolon
id|acpi_enter_sx_async
c_func
(paren
op_amp
id|ctx
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Enter system sleep state and wait for completion&n; */
r_int
DECL|function|acpi_enter_sx
id|acpi_enter_sx
c_func
(paren
id|acpi_sstate_t
id|state
)paren
(brace
r_struct
id|acpi_enter_sx_ctx
id|ctx
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STRNCMP
c_func
(paren
id|acpi_fadt.header.signature
comma
id|ACPI_FADT_SIGNATURE
comma
id|ACPI_SIG_LEN
)paren
op_ne
l_int|0
)paren
op_logical_or
id|acpi_slptyp
(braket
id|state
)braket
op_eq
id|ACPI_INVALID
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ctx.wait
)paren
suffix:semicolon
id|ctx.state
op_assign
id|state
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|ctx.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_os_queue_for_execution
c_func
(paren
l_int|0
comma
id|acpi_enter_sx_async
comma
op_amp
id|ctx
)paren
)paren
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|ctx.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_int
DECL|function|acpi_sys_init
id|acpi_sys_init
c_func
(paren
r_void
)paren
(brace
id|u8
id|sx
suffix:semicolon
id|u8
id|type_a
suffix:semicolon
id|u8
id|type_b
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: System firmware supports:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sx
op_assign
id|ACPI_S0
suffix:semicolon
id|sx
op_le
id|ACPI_S5
suffix:semicolon
id|sx
op_increment
)paren
(brace
r_int
id|ca_sx
op_assign
(paren
id|sx
op_le
id|ACPI_S4
)paren
ques
c_cond
id|sx
suffix:colon
(paren
id|sx
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_hw_obtain_sleep_type_register_data
c_func
(paren
id|ca_sx
comma
op_amp
id|type_a
comma
op_amp
id|type_b
)paren
)paren
)paren
(brace
id|acpi_slptyp
(braket
id|sx
)braket
op_assign
id|ACPI_SLP_TYP
c_func
(paren
id|type_a
comma
id|type_b
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; S%d&quot;
comma
id|sx
)paren
suffix:semicolon
)brace
r_else
(brace
id|acpi_slptyp
(braket
id|sx
)braket
op_assign
id|ACPI_INVALID
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pm_power_off
op_assign
id|acpi_power_off
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
