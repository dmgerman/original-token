multiline_comment|/* Code to support devices on the DIO (and eventually DIO-II) bus&n; * Copyright (C) 05/1998 Peter Maydell &lt;pmaydell@chiark.greenend.org.uk&gt;&n; * &n; * This code has basically these routines at the moment:&n; * int dio_find(u_int deviceid)&n; *    Search the list of DIO devices and return the select code&n; *    of the next unconfigured device found that matches the given device ID.&n; *    Note that the deviceid parameter should be the encoded ID.&n; *    This means that framebuffers should pass it as &n; *    DIO_ENCODE_ID(DIO_ID_FBUFFER,DIO_ID2_TOPCAT)&n; *    (or whatever); everybody else just uses DIO_ID_FOOBAR.&n; * void *dio_scodetoviraddr(int scode)&n; *    Return the virtual address corresponding to the given select code.&n; *    NB: DIO-II devices will have to be mapped in in this routine!&n; * int dio_scodetoipl(int scode)&n; *    Every DIO card has a fixed interrupt priority level. This function &n; *    returns it, whatever it is.&n; * const char *dio_scodetoname(int scode)&n; *    Return a character string describing this board [might be &quot;&quot; if &n; *    not CONFIG_DIO_CONSTANTS]&n; * void dio_config_board(int scode)     mark board as configured in the list&n; * void dio_unconfig_board(int scode)   mark board as no longer configured&n; *&n; * This file is based on the way the Amiga port handles Zorro II cards, &n; * although we aren&squot;t so complicated...&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/dio.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;                         /* kmalloc() */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/hwtest.h&gt;                           /* hwreg_present() */
macro_line|#include &lt;asm/io.h&gt;                               /* readb() */
multiline_comment|/* not a real config option yet! */
DECL|macro|CONFIG_DIO_CONSTANTS
mdefine_line|#define CONFIG_DIO_CONSTANTS
macro_line|#ifdef CONFIG_DIO_CONSTANTS
multiline_comment|/* We associate each numeric ID with an appropriate descriptive string&n; * using a constant array of these structs.&n; * FIXME: we should be able to arrange to throw away most of the strings&n; * using the initdata stuff. Then we wouldn&squot;t need to worry about &n; * carrying them around...&n; * I think we do this by copying them into newly kmalloc()ed memory and &n; * marking the names[] array as .initdata ?&n; */
DECL|struct|dioname
r_struct
id|dioname
(brace
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* useful macro */
DECL|macro|DIONAME
mdefine_line|#define DIONAME(x) { DIO_ID_##x, DIO_DESC_##x }
DECL|macro|DIOFBNAME
mdefine_line|#define DIOFBNAME(x) { DIO_ENCODE_ID( DIO_ID_FBUFFER, DIO_ID2_##x), DIO_DESC2_##x }
DECL|variable|names
r_static
r_struct
id|dioname
id|names
(braket
)braket
op_assign
(brace
id|DIONAME
c_func
(paren
id|DCA0
)paren
comma
id|DIONAME
c_func
(paren
id|DCA0REM
)paren
comma
id|DIONAME
c_func
(paren
id|DCA1
)paren
comma
id|DIONAME
c_func
(paren
id|DCA1REM
)paren
comma
id|DIONAME
c_func
(paren
id|DCM
)paren
comma
id|DIONAME
c_func
(paren
id|DCMREM
)paren
comma
id|DIONAME
c_func
(paren
id|LAN
)paren
comma
id|DIONAME
c_func
(paren
id|FHPIB
)paren
comma
id|DIONAME
c_func
(paren
id|NHPIB
)paren
comma
id|DIONAME
c_func
(paren
id|IHPIB
)paren
comma
id|DIONAME
c_func
(paren
id|SCSI0
)paren
comma
id|DIONAME
c_func
(paren
id|SCSI1
)paren
comma
id|DIONAME
c_func
(paren
id|SCSI2
)paren
comma
id|DIONAME
c_func
(paren
id|SCSI3
)paren
comma
id|DIONAME
c_func
(paren
id|FBUFFER
)paren
comma
id|DIONAME
c_func
(paren
id|PARALLEL
)paren
comma
id|DIONAME
c_func
(paren
id|VME
)paren
comma
id|DIONAME
c_func
(paren
id|DCL
)paren
comma
id|DIONAME
c_func
(paren
id|DCLREM
)paren
comma
id|DIONAME
c_func
(paren
id|MISC0
)paren
comma
id|DIONAME
c_func
(paren
id|MISC1
)paren
comma
id|DIONAME
c_func
(paren
id|MISC2
)paren
comma
id|DIONAME
c_func
(paren
id|MISC3
)paren
comma
id|DIONAME
c_func
(paren
id|MISC4
)paren
comma
id|DIONAME
c_func
(paren
id|MISC5
)paren
comma
id|DIONAME
c_func
(paren
id|MISC6
)paren
comma
id|DIONAME
c_func
(paren
id|MISC7
)paren
comma
id|DIONAME
c_func
(paren
id|MISC8
)paren
comma
id|DIONAME
c_func
(paren
id|MISC9
)paren
comma
id|DIONAME
c_func
(paren
id|MISC10
)paren
comma
id|DIONAME
c_func
(paren
id|MISC11
)paren
comma
id|DIONAME
c_func
(paren
id|MISC12
)paren
comma
id|DIONAME
c_func
(paren
id|MISC13
)paren
comma
id|DIOFBNAME
c_func
(paren
id|GATORBOX
)paren
comma
id|DIOFBNAME
c_func
(paren
id|TOPCAT
)paren
comma
id|DIOFBNAME
c_func
(paren
id|RENAISSANCE
)paren
comma
id|DIOFBNAME
c_func
(paren
id|LRCATSEYE
)paren
comma
id|DIOFBNAME
c_func
(paren
id|HRCCATSEYE
)paren
comma
id|DIOFBNAME
c_func
(paren
id|HRMCATSEYE
)paren
comma
id|DIOFBNAME
c_func
(paren
id|DAVINCI
)paren
comma
id|DIOFBNAME
c_func
(paren
id|XXXCATSEYE
)paren
comma
id|DIOFBNAME
c_func
(paren
id|HYPERION
)paren
comma
id|DIOFBNAME
c_func
(paren
id|XGENESIS
)paren
comma
id|DIOFBNAME
c_func
(paren
id|TIGER
)paren
comma
id|DIOFBNAME
c_func
(paren
id|YGENESIS
)paren
)brace
suffix:semicolon
DECL|macro|DIONAME
macro_line|#undef DIONAME
DECL|macro|DIOFBNAME
macro_line|#undef DIOFBNAME
DECL|macro|NUMNAMES
mdefine_line|#define NUMNAMES (sizeof(names) / sizeof(struct dioname))
DECL|variable|unknowndioname
r_static
r_const
r_char
op_star
id|unknowndioname
op_assign
l_string|&quot;unknown DIO board -- please email &lt;pmaydell@chiark.greenend.org.uk&gt;!&quot;
suffix:semicolon
DECL|function|dio_getname
r_static
r_const
r_char
op_star
id|dio_getname
c_func
(paren
r_int
id|id
)paren
(brace
multiline_comment|/* return pointer to a constant string describing the board with given ID */
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUMNAMES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|names
(braket
id|i
)braket
dot
id|id
op_eq
id|id
)paren
r_return
id|names
(braket
id|i
)braket
dot
id|name
suffix:semicolon
r_return
id|unknowndioname
suffix:semicolon
)brace
macro_line|#else
DECL|variable|dio_no_name
r_static
r_char
id|dio_no_name
(braket
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|macro|dio_getname
mdefine_line|#define dio_getname(_id)&t;(dio_no_name)
macro_line|#endif /* CONFIG_DIO_CONSTANTS */
multiline_comment|/* We represent all the DIO boards in the system with a linked list of these structs. */
DECL|struct|dioboard
r_struct
id|dioboard
(brace
DECL|member|next
r_struct
id|dioboard
op_star
id|next
suffix:semicolon
multiline_comment|/* link to next struct in list */
DECL|member|ipl
r_int
id|ipl
suffix:semicolon
multiline_comment|/* IPL of this board */
DECL|member|configured
r_int
id|configured
suffix:semicolon
multiline_comment|/* has this board been configured? */
DECL|member|scode
r_int
id|scode
suffix:semicolon
multiline_comment|/* select code of this board */
DECL|member|id
r_int
id|id
suffix:semicolon
multiline_comment|/* encoded ID */
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|blist
r_static
r_struct
id|dioboard
op_star
id|blist
op_assign
l_int|NULL
suffix:semicolon
DECL|function|dio_find_slow
r_static
r_int
id|__init
id|dio_find_slow
c_func
(paren
r_int
id|deviceid
)paren
(brace
multiline_comment|/* Called to find a DIO device before the full bus scan has run.  Basically&n;&t;   only used by the console driver.  */
r_int
id|scode
suffix:semicolon
r_for
c_loop
(paren
id|scode
op_assign
l_int|0
suffix:semicolon
id|scode
OL
id|DIO_SCMAX
suffix:semicolon
id|scode
op_increment
)paren
(brace
r_void
op_star
id|va
suffix:semicolon
r_if
c_cond
(paren
id|DIO_SCINHOLE
c_func
(paren
id|scode
)paren
)paren
r_continue
suffix:semicolon
id|va
op_assign
id|dio_scodetoviraddr
c_func
(paren
id|scode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|va
op_logical_or
op_logical_neg
id|hwreg_present
c_func
(paren
id|va
op_plus
id|DIO_IDOFF
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* no board present at that select code */
r_if
c_cond
(paren
id|DIO_ID
c_func
(paren
id|va
)paren
op_eq
id|deviceid
)paren
r_return
id|scode
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dio_find
r_int
id|dio_find
c_func
(paren
r_int
id|deviceid
)paren
(brace
r_if
c_cond
(paren
id|blist
)paren
(brace
multiline_comment|/* fast way */
r_struct
id|dioboard
op_star
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|blist
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
id|b-&gt;id
op_eq
id|deviceid
op_logical_and
id|b-&gt;configured
op_eq
l_int|0
)paren
r_return
id|b-&gt;scode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|dio_find_slow
c_func
(paren
id|deviceid
)paren
suffix:semicolon
)brace
multiline_comment|/* This is the function that scans the DIO space and works out what&n; * hardware is actually present.&n; */
DECL|function|dio_init
r_void
id|__init
id|dio_init
c_func
(paren
r_void
)paren
(brace
r_int
id|scode
suffix:semicolon
r_struct
id|dioboard
op_star
id|b
comma
op_star
id|bprev
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Scanning for DIO devices...&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|scode
op_assign
l_int|0
suffix:semicolon
id|scode
OL
id|DIO_SCMAX
suffix:semicolon
op_increment
id|scode
)paren
(brace
id|u_char
id|prid
comma
id|secid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* primary, secondary ID bytes */
id|u_char
op_star
id|va
suffix:semicolon
r_if
c_cond
(paren
id|DIO_SCINHOLE
c_func
(paren
id|scode
)paren
)paren
r_continue
suffix:semicolon
id|va
op_assign
id|dio_scodetoviraddr
c_func
(paren
id|scode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|va
op_logical_or
op_logical_neg
id|hwreg_present
c_func
(paren
id|va
op_plus
id|DIO_IDOFF
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* no board present at that select code */
multiline_comment|/* Found a board, allocate it an entry in the list */
id|b
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dioboard
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* read the ID byte(s) and encode if necessary. Note workaround &n;                 * for broken internal HPIB devices...&n;                 */
r_if
c_cond
(paren
op_logical_neg
id|DIO_ISIHPIB
c_func
(paren
id|scode
)paren
)paren
id|prid
op_assign
id|DIO_ID
c_func
(paren
id|va
)paren
suffix:semicolon
r_else
id|prid
op_assign
id|DIO_ID_IHPIB
suffix:semicolon
r_if
c_cond
(paren
id|DIO_NEEDSSECID
c_func
(paren
id|prid
)paren
)paren
(brace
id|secid
op_assign
id|DIO_SECID
c_func
(paren
id|va
)paren
suffix:semicolon
id|b-&gt;id
op_assign
id|DIO_ENCODE_ID
c_func
(paren
id|prid
comma
id|secid
)paren
suffix:semicolon
)brace
r_else
id|b-&gt;id
op_assign
id|prid
suffix:semicolon
id|b-&gt;configured
op_assign
l_int|0
suffix:semicolon
id|b-&gt;scode
op_assign
id|scode
suffix:semicolon
id|b-&gt;ipl
op_assign
id|DIO_IPL
c_func
(paren
id|va
)paren
suffix:semicolon
id|b-&gt;name
op_assign
id|dio_getname
c_func
(paren
id|b-&gt;id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;select code %3d: ID %02X&quot;
comma
id|scode
comma
id|prid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DIO_NEEDSSECID
c_func
(paren
id|b-&gt;id
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;:%02X&quot;
comma
id|secid
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %s&bslash;n&quot;
comma
id|b-&gt;name
)paren
suffix:semicolon
id|b-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|bprev
)paren
id|bprev-&gt;next
op_assign
id|b
suffix:semicolon
r_else
id|blist
op_assign
id|b
suffix:semicolon
id|bprev
op_assign
id|b
suffix:semicolon
)brace
)brace
multiline_comment|/* Bear in mind that this is called in the very early stages of initialisation&n; * in order to get the virtual address of the serial port for the console...&n; */
DECL|function|dio_scodetoviraddr
r_void
op_star
id|dio_scodetoviraddr
c_func
(paren
r_int
id|scode
)paren
(brace
r_if
c_cond
(paren
id|scode
OG
id|DIOII_SCBASE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dio_scodetoviraddr: don&squot;t support DIO-II yet!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scode
OG
id|DIO_SCMAX
op_logical_or
id|scode
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|DIO_SCINHOLE
c_func
(paren
id|scode
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scode
op_eq
id|DIO_IHPIBSCODE
)paren
multiline_comment|/* this should really be #ifdef CONFIG_IHPIB */
r_return
(paren
r_void
op_star
)paren
id|DIO_IHPIBADDR
suffix:semicolon
multiline_comment|/* or something similar... */
r_return
(paren
r_void
op_star
)paren
(paren
id|DIO_VIRADDRBASE
op_plus
id|DIO_BASE
op_plus
id|scode
op_star
l_int|0x10000
)paren
suffix:semicolon
)brace
DECL|function|dio_scodetoipl
r_int
id|dio_scodetoipl
c_func
(paren
r_int
id|scode
)paren
(brace
r_struct
id|dioboard
op_star
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|blist
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
id|b-&gt;scode
op_eq
id|scode
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dio_scodetoipl: bad select code %d&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
id|b-&gt;ipl
suffix:semicolon
)brace
DECL|function|dio_scodetoname
r_const
r_char
op_star
id|dio_scodetoname
c_func
(paren
r_int
id|scode
)paren
(brace
r_struct
id|dioboard
op_star
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|blist
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
id|b-&gt;scode
op_eq
id|scode
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dio_scodetoname: bad select code %d&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
r_return
id|b-&gt;name
suffix:semicolon
)brace
DECL|function|dio_config_board
r_void
id|dio_config_board
c_func
(paren
r_int
id|scode
)paren
(brace
r_struct
id|dioboard
op_star
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|blist
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
id|b-&gt;scode
op_eq
id|scode
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
id|printk
c_func
(paren
l_string|&quot;dio_config_board: bad select code %d&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|b-&gt;configured
)paren
id|printk
c_func
(paren
l_string|&quot;dio_config_board: board at select code %d already configured&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
r_else
id|b-&gt;configured
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|dio_unconfig_board
r_void
id|dio_unconfig_board
c_func
(paren
r_int
id|scode
)paren
(brace
r_struct
id|dioboard
op_star
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|blist
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
id|b-&gt;scode
op_eq
id|scode
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
id|printk
c_func
(paren
l_string|&quot;dio_unconfig_board: bad select code %d&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|b-&gt;configured
)paren
id|printk
c_func
(paren
l_string|&quot;dio_unconfig_board: board at select code %d not configured&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
r_else
id|b-&gt;configured
op_assign
l_int|0
suffix:semicolon
)brace
eof
