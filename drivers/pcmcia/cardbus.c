multiline_comment|/*======================================================================&n;  &n;    Cardbus device configuration&n;    &n;    cardbus.c 1.57 1999/09/07 15:19:32&n;&n;    The contents of this file are subject to the Mozilla Public&n;    License Version 1.1 (the &quot;License&quot;); you may not use this file&n;    except in compliance with the License. You may obtain a copy of&n;    the License at http://www.mozilla.org/MPL/&n;&n;    Software distributed under the License is distributed on an &quot;AS&n;    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or&n;    implied. See the License for the specific language governing&n;    rights and limitations under the License.&n;&n;    The initial developer of the original code is David A. Hinds&n;    &lt;dhinds@hyper.stanford.edu&gt;.  Portions created by David A. Hinds&n;    are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.&n;&n;    Alternatively, the contents of this file may be used under the&n;    terms of the GNU Public License version 2 (the &quot;GPL&quot;), in which&n;    case the provisions of the GPL are applicable instead of the&n;    above.  If you wish to allow the use of your version of this file&n;    only under the terms of the GPL and not to allow others to use&n;    your version of this file under the MPL, indicate your decision&n;    by deleting the provisions above and replace them with the notice&n;    and other provisions required by the GPL.  If you do not delete&n;    the provisions above, a recipient may use your version of this&n;    file under either the MPL or the GPL.&n;    &n;    These routines handle allocating resources for Cardbus cards, as&n;    well as setting up and shutting down Cardbus sockets.  They are&n;    called from cs.c in response to Request/ReleaseConfiguration and&n;    Request/ReleaseIO calls.&n;    &n;======================================================================*/
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifndef PCMCIA_DEBUG
DECL|macro|PCMCIA_DEBUG
mdefine_line|#define PCMCIA_DEBUG 1
macro_line|#endif
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
DECL|macro|IN_CARD_SERVICES
mdefine_line|#define IN_CARD_SERVICES
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/bulkmem.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &quot;cs_internal.h&quot;
macro_line|#include &quot;rsrc_mgr.h&quot;
multiline_comment|/*====================================================================*/
DECL|macro|FIND_FIRST_BIT
mdefine_line|#define FIND_FIRST_BIT(n)&t;((n) - ((n) &amp; ((n)-1)))
DECL|macro|pci_readb
mdefine_line|#define pci_readb&t;&t;pcibios_read_config_byte
DECL|macro|pci_writeb
mdefine_line|#define pci_writeb&t;&t;pcibios_write_config_byte
DECL|macro|pci_readw
mdefine_line|#define pci_readw&t;&t;pcibios_read_config_word
DECL|macro|pci_writew
mdefine_line|#define pci_writew&t;&t;pcibios_write_config_word
DECL|macro|pci_readl
mdefine_line|#define pci_readl&t;&t;pcibios_read_config_dword
DECL|macro|pci_writel
mdefine_line|#define pci_writel&t;&t;pcibios_write_config_dword
DECL|macro|CB_BAR
mdefine_line|#define CB_BAR(n)&t;&t;(PCI_BASE_ADDRESS_0+(4*(n)))
DECL|macro|CB_ROM_BASE
mdefine_line|#define CB_ROM_BASE&t;&t;0x0030
multiline_comment|/* Offsets in the Expansion ROM Image Header */
DECL|macro|ROM_SIGNATURE
mdefine_line|#define ROM_SIGNATURE&t;&t;0x0000&t;/* 2 bytes */
DECL|macro|ROM_DATA_PTR
mdefine_line|#define ROM_DATA_PTR&t;&t;0x0018&t;/* 2 bytes */
multiline_comment|/* Offsets in the CardBus PC Card Data Structure */
DECL|macro|PCDATA_SIGNATURE
mdefine_line|#define PCDATA_SIGNATURE&t;0x0000&t;/* 4 bytes */
DECL|macro|PCDATA_VPD_PTR
mdefine_line|#define PCDATA_VPD_PTR&t;&t;0x0008&t;/* 2 bytes */
DECL|macro|PCDATA_LENGTH
mdefine_line|#define PCDATA_LENGTH&t;&t;0x000a&t;/* 2 bytes */
DECL|macro|PCDATA_REVISION
mdefine_line|#define PCDATA_REVISION&t;&t;0x000c
DECL|macro|PCDATA_IMAGE_SZ
mdefine_line|#define PCDATA_IMAGE_SZ&t;&t;0x0010&t;/* 2 bytes */
DECL|macro|PCDATA_ROM_LEVEL
mdefine_line|#define PCDATA_ROM_LEVEL&t;0x0012&t;/* 2 bytes */
DECL|macro|PCDATA_CODE_TYPE
mdefine_line|#define PCDATA_CODE_TYPE&t;0x0014
DECL|macro|PCDATA_INDICATOR
mdefine_line|#define PCDATA_INDICATOR&t;0x0015
DECL|struct|cb_config_t
r_typedef
r_struct
id|cb_config_t
(brace
DECL|member|size
id|u_int
id|size
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|dev
r_struct
id|pci_dev
id|dev
suffix:semicolon
DECL|typedef|cb_config_t
)brace
id|cb_config_t
suffix:semicolon
DECL|macro|BASE
mdefine_line|#define BASE(dev,n)&t;((dev).resource[n].start)
DECL|macro|ROM
mdefine_line|#define ROM(dev)&t;((dev).resource[6].start)
multiline_comment|/* There are three classes of bridge maps: IO ports,&n;   non-prefetchable memory, and prefetchable memory */
DECL|enumerator|B_IO
DECL|enumerator|B_M1
DECL|enumerator|B_M2
DECL|typedef|bridge_type
r_typedef
r_enum
(brace
id|B_IO
comma
id|B_M1
comma
id|B_M2
)brace
id|bridge_type
suffix:semicolon
multiline_comment|/*=====================================================================&n;&n;    Expansion ROM&squot;s have a special layout, and pointers specify an&n;    image number and an offset within that image.  check_rom()&n;    verifies that the expansion ROM exists and has the standard&n;    layout.  xlate_rom_addr() converts an image/offset address to an&n;    absolute offset from the ROM&squot;s base address.&n;    &n;=====================================================================*/
DECL|function|check_rom
r_static
r_int
id|check_rom
c_func
(paren
id|u_char
op_star
id|b
comma
id|u_long
id|len
)paren
(brace
id|u_int
id|img
op_assign
l_int|0
comma
id|ofs
op_assign
l_int|0
comma
id|sz
suffix:semicolon
id|u_short
id|data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;ROM image dump:&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|b
)paren
op_eq
l_int|0x55
)paren
op_logical_and
(paren
id|readb
c_func
(paren
id|b
op_plus
l_int|1
)paren
op_eq
l_int|0xaa
)paren
)paren
(brace
id|data
op_assign
id|readb
c_func
(paren
id|b
op_plus
id|ROM_DATA_PTR
)paren
op_plus
(paren
id|readb
c_func
(paren
id|b
op_plus
id|ROM_DATA_PTR
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|sz
op_assign
l_int|512
op_star
(paren
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_IMAGE_SZ
)paren
op_plus
(paren
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_IMAGE_SZ
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  image %d: 0x%06x-0x%06x, signature %c%c%c%c&bslash;n&quot;
comma
id|img
comma
id|ofs
comma
id|ofs
op_plus
id|sz
op_minus
l_int|1
comma
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_SIGNATURE
)paren
comma
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_SIGNATURE
op_plus
l_int|1
)paren
comma
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_SIGNATURE
op_plus
l_int|2
)paren
comma
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_SIGNATURE
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|ofs
op_add_assign
id|sz
suffix:semicolon
id|img
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_INDICATOR
)paren
op_amp
l_int|0x80
)paren
op_logical_or
(paren
id|sz
op_eq
l_int|0
)paren
op_logical_or
(paren
id|ofs
op_ge
id|len
)paren
)paren
r_break
suffix:semicolon
id|b
op_add_assign
id|sz
suffix:semicolon
)brace
r_return
id|img
suffix:semicolon
)brace
DECL|function|xlate_rom_addr
r_static
id|u_int
id|xlate_rom_addr
c_func
(paren
id|u_char
op_star
id|b
comma
id|u_int
id|addr
)paren
(brace
id|u_int
id|img
op_assign
l_int|0
comma
id|ofs
op_assign
l_int|0
comma
id|sz
suffix:semicolon
id|u_short
id|data
suffix:semicolon
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|b
)paren
op_eq
l_int|0x55
)paren
op_logical_and
(paren
id|readb
c_func
(paren
id|b
op_plus
l_int|1
)paren
op_eq
l_int|0xaa
)paren
)paren
(brace
r_if
c_cond
(paren
id|img
op_eq
(paren
id|addr
op_rshift
l_int|28
)paren
)paren
r_return
(paren
id|addr
op_amp
l_int|0x0fffffff
)paren
op_plus
id|ofs
suffix:semicolon
id|data
op_assign
id|readb
c_func
(paren
id|b
op_plus
id|ROM_DATA_PTR
)paren
op_plus
(paren
id|readb
c_func
(paren
id|b
op_plus
id|ROM_DATA_PTR
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|sz
op_assign
l_int|512
op_star
(paren
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_IMAGE_SZ
)paren
op_plus
(paren
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_IMAGE_SZ
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sz
op_eq
l_int|0
)paren
op_logical_or
(paren
id|readb
c_func
(paren
id|b
op_plus
id|data
op_plus
id|PCDATA_INDICATOR
)paren
op_amp
l_int|0x80
)paren
)paren
r_break
suffix:semicolon
id|b
op_add_assign
id|sz
suffix:semicolon
id|ofs
op_add_assign
id|sz
suffix:semicolon
id|img
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=====================================================================&n;&n;    These are similar to setup_cis_mem and release_cis_mem for 16-bit&n;    cards.  The &quot;result&quot; that is used externally is the cb_cis_virt&n;    pointer in the socket_info_t structure.&n;    &n;=====================================================================*/
DECL|function|cb_setup_cis_mem
r_int
id|cb_setup_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
comma
r_int
id|space
)paren
(brace
id|cb_bridge_map
op_star
id|m
op_assign
op_amp
id|s-&gt;cb_cis_map
suffix:semicolon
id|u_long
id|base
op_assign
l_int|0
suffix:semicolon
id|u_int
id|sz
comma
id|br
suffix:semicolon
r_if
c_cond
(paren
id|space
op_eq
id|s-&gt;cb_cis_space
)paren
r_return
id|CS_SUCCESS
suffix:semicolon
r_else
r_if
c_cond
(paren
id|s-&gt;cb_cis_space
op_ne
l_int|0
)paren
id|cb_release_cis_mem
c_func
(paren
id|s
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;cs: cb_setup_cis_mem(space %d)&bslash;n&quot;
comma
id|space
)paren
suffix:semicolon
multiline_comment|/* If socket is configured, then use existing memory mapping */
r_if
c_cond
(paren
id|s-&gt;lock_count
)paren
(brace
id|s-&gt;cb_cis_virt
op_assign
id|ioremap
c_func
(paren
id|BASE
c_func
(paren
id|s-&gt;cb_config
(braket
l_int|0
)braket
dot
id|dev
comma
id|space
op_minus
l_int|1
)paren
comma
id|s-&gt;cb_config
(braket
l_int|0
)braket
dot
id|size
(braket
id|space
op_minus
l_int|1
)braket
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|s-&gt;cb_cis_space
op_assign
id|space
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* Not configured?  Then set up temporary map */
id|br
op_assign
(paren
id|space
op_eq
l_int|7
)paren
ques
c_cond
id|CB_ROM_BASE
suffix:colon
id|CB_BAR
c_func
(paren
id|space
op_minus
l_int|1
)paren
suffix:semicolon
id|pci_writel
c_func
(paren
id|s-&gt;cap.cardbus
comma
l_int|0
comma
id|br
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|pci_readl
c_func
(paren
id|s-&gt;cap.cardbus
comma
l_int|0
comma
id|br
comma
op_amp
id|sz
)paren
suffix:semicolon
id|sz
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|sz
op_assign
id|FIND_FIRST_BIT
c_func
(paren
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
OL
id|PAGE_SIZE
)paren
id|sz
op_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|find_mem_region
c_func
(paren
op_amp
id|base
comma
id|sz
comma
l_string|&quot;cb_enabler&quot;
comma
id|sz
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: could not allocate %dK memory for&quot;
l_string|&quot; CardBus socket %d&bslash;n&quot;
comma
id|sz
op_div
l_int|1024
comma
id|s-&gt;sock
)paren
suffix:semicolon
r_return
id|CS_OUT_OF_RESOURCE
suffix:semicolon
)brace
id|s-&gt;cb_cis_space
op_assign
id|space
suffix:semicolon
id|s-&gt;cb_cis_virt
op_assign
id|ioremap
c_func
(paren
id|base
comma
id|sz
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;  phys 0x%08lx-0x%08lx, virt 0x%08lx&bslash;n&quot;
comma
id|base
comma
id|base
op_plus
id|sz
op_minus
l_int|1
comma
(paren
id|u_long
)paren
id|s-&gt;cb_cis_virt
)paren
suffix:semicolon
id|pci_writel
c_func
(paren
id|s-&gt;cap.cardbus
comma
l_int|0
comma
id|br
comma
id|base
op_or
l_int|1
)paren
suffix:semicolon
id|pci_writeb
c_func
(paren
id|s-&gt;cap.cardbus
comma
l_int|0
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_MEMORY
)paren
suffix:semicolon
id|m-&gt;map
op_assign
l_int|0
suffix:semicolon
id|m-&gt;flags
op_assign
id|MAP_ACTIVE
suffix:semicolon
id|m-&gt;start
op_assign
id|base
suffix:semicolon
id|m-&gt;stop
op_assign
id|base
op_plus
id|sz
op_minus
l_int|1
suffix:semicolon
id|s
op_member_access_from_pointer
id|ss_entry
c_func
(paren
id|s-&gt;sock
comma
id|SS_SetBridge
comma
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|space
op_eq
l_int|7
)paren
op_logical_and
(paren
id|check_rom
c_func
(paren
id|s-&gt;cb_cis_virt
comma
id|sz
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: no valid ROM images found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|CS_READ_FAILURE
suffix:semicolon
)brace
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
DECL|function|cb_release_cis_mem
r_void
id|cb_release_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
id|cb_bridge_map
op_star
id|m
op_assign
op_amp
id|s-&gt;cb_cis_map
suffix:semicolon
id|u_int
id|br
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;cb_cis_virt
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;cs: cb_release_cis_mem()&bslash;n&quot;
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|s-&gt;cb_cis_virt
)paren
suffix:semicolon
id|s-&gt;cb_cis_virt
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;cb_cis_space
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;start
)paren
(brace
multiline_comment|/* This is overkill: we probably only need to release the&n;&t;   memory region, but the rest should be safe */
id|br
op_assign
(paren
id|s-&gt;cb_cis_space
op_eq
l_int|7
)paren
ques
c_cond
id|CB_ROM_BASE
suffix:colon
id|CB_BAR
c_func
(paren
id|s-&gt;cb_cis_space
op_minus
l_int|1
)paren
suffix:semicolon
id|m-&gt;map
op_assign
l_int|0
suffix:semicolon
id|m-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|s
op_member_access_from_pointer
id|ss_entry
c_func
(paren
id|s-&gt;sock
comma
id|SS_SetBridge
comma
id|m
)paren
suffix:semicolon
id|pci_writeb
c_func
(paren
id|s-&gt;cap.cardbus
comma
l_int|0
comma
id|PCI_COMMAND
comma
l_int|0
)paren
suffix:semicolon
id|pci_writel
c_func
(paren
id|s-&gt;cap.cardbus
comma
l_int|0
comma
id|br
comma
l_int|0
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|m-&gt;start
comma
id|m-&gt;stop
op_minus
id|m-&gt;start
op_plus
l_int|1
)paren
suffix:semicolon
id|m-&gt;start
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*=====================================================================&n;&n;    This is used by the CIS processing code to read CIS information&n;    from a CardBus device.&n;    &n;=====================================================================*/
DECL|function|read_cb_mem
r_void
id|read_cb_mem
c_func
(paren
id|socket_info_t
op_star
id|s
comma
id|u_char
id|fn
comma
r_int
id|space
comma
id|u_int
id|addr
comma
id|u_int
id|len
comma
r_void
op_star
id|ptr
)paren
(brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;cs: read_cb_mem(%d, %#x, %u)&bslash;n&quot;
comma
id|space
comma
id|addr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|space
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|addr
op_plus
id|len
OG
l_int|0x100
)paren
r_goto
id|fail
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
suffix:semicolon
id|addr
op_increment
comma
id|ptr
op_increment
comma
id|len
op_decrement
)paren
id|pci_readb
c_func
(paren
id|s-&gt;cap.cardbus
comma
id|fn
comma
id|addr
comma
(paren
id|u_char
op_star
)paren
id|ptr
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|cb_setup_cis_mem
c_func
(paren
id|s
comma
id|space
)paren
op_ne
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|space
op_eq
l_int|7
)paren
(brace
id|addr
op_assign
id|xlate_rom_addr
c_func
(paren
id|s-&gt;cb_cis_virt
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr
op_plus
id|len
OG
id|s-&gt;cb_cis_map.stop
op_minus
id|s-&gt;cb_cis_map.start
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;cb_cis_virt
op_ne
l_int|NULL
)paren
r_for
c_loop
(paren
suffix:semicolon
id|len
suffix:semicolon
id|addr
op_increment
comma
id|ptr
op_increment
comma
id|len
op_decrement
)paren
op_star
(paren
id|u_char
op_star
)paren
id|ptr
op_assign
id|readb
c_func
(paren
id|s-&gt;cb_cis_virt
op_plus
id|addr
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|fail
suffix:colon
id|memset
c_func
(paren
id|ptr
comma
l_int|0xff
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=====================================================================&n;&n;    cb_alloc() and cb_free() allocate and free the kernel data&n;    structures for a Cardbus device, and handle the lowest level PCI&n;    device setup issues.&n;    &n;=====================================================================*/
DECL|function|cb_alloc
r_int
id|cb_alloc
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
r_struct
id|pci_dev
id|tmp
suffix:semicolon
id|u_short
id|vend
comma
id|v
comma
id|dev
suffix:semicolon
id|u_char
id|i
comma
id|hdr
comma
id|fn
comma
id|bus
op_assign
id|s-&gt;cap.cardbus
suffix:semicolon
id|cb_config_t
op_star
id|c
suffix:semicolon
id|tmp.bus
op_assign
id|s-&gt;cap.cb_bus
suffix:semicolon
id|tmp.devfn
op_assign
l_int|0
suffix:semicolon
id|tmp.next
op_assign
id|pci_devices
suffix:semicolon
id|pci_devices
op_assign
op_amp
id|tmp
suffix:semicolon
id|pci_readw
c_func
(paren
id|bus
comma
l_int|0
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vend
)paren
suffix:semicolon
id|pci_readw
c_func
(paren
id|bus
comma
l_int|0
comma
id|PCI_DEVICE_ID
comma
op_amp
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cs: cb_alloc(bus %d): vendor 0x%04x, &quot;
l_string|&quot;device 0x%04x&bslash;n&quot;
comma
id|bus
comma
id|vend
comma
id|dev
)paren
suffix:semicolon
id|pci_readb
c_func
(paren
id|bus
comma
l_int|0
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* Count functions */
r_for
c_loop
(paren
id|fn
op_assign
l_int|0
suffix:semicolon
id|fn
OL
l_int|8
suffix:semicolon
id|fn
op_increment
)paren
(brace
id|tmp.devfn
op_assign
id|fn
suffix:semicolon
id|pci_readw
c_func
(paren
id|bus
comma
id|fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v
op_ne
id|vend
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
id|fn
op_assign
l_int|1
suffix:semicolon
id|s-&gt;functions
op_assign
id|fn
suffix:semicolon
id|c
op_assign
id|kmalloc
c_func
(paren
id|fn
op_star
r_sizeof
(paren
r_struct
id|cb_config_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
id|CS_OUT_OF_RESOURCE
suffix:semicolon
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
id|fn
op_star
r_sizeof
(paren
r_struct
id|cb_config_t
)paren
)paren
suffix:semicolon
id|s-&gt;cb_config
op_assign
id|c
suffix:semicolon
id|pci_devices
op_assign
id|tmp.next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
(braket
id|i
)braket
dot
id|dev.bus
op_assign
id|s-&gt;cap.cb_bus
suffix:semicolon
id|c
(braket
id|i
)braket
dot
id|dev.devfn
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|fn
op_minus
l_int|1
)paren
(brace
id|c
(braket
id|i
)braket
dot
id|dev.sibling
op_assign
id|c
(braket
id|i
)braket
dot
id|dev.next
op_assign
op_amp
id|c
(braket
id|i
op_plus
l_int|1
)braket
dot
id|dev
suffix:semicolon
)brace
)brace
id|s-&gt;cap.cb_bus-&gt;devices
op_assign
op_amp
id|c
(braket
l_int|0
)braket
dot
id|dev
suffix:semicolon
multiline_comment|/* Link into PCI device chain */
id|c
(braket
id|s-&gt;functions
op_minus
l_int|1
)braket
dot
id|dev.next
op_assign
id|pci_devices
suffix:semicolon
id|pci_devices
op_assign
op_amp
id|c
(braket
l_int|0
)braket
dot
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
(braket
id|i
)braket
dot
id|dev.vendor
op_assign
id|vend
suffix:semicolon
id|pci_readw
c_func
(paren
id|bus
comma
id|i
comma
id|PCI_DEVICE_ID
comma
op_amp
id|c
(braket
id|i
)braket
dot
id|dev.device
)paren
suffix:semicolon
id|pci_readl
c_func
(paren
id|bus
comma
id|i
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|c
(braket
id|i
)braket
dot
id|dev
dot
r_class
)paren
suffix:semicolon
id|c
(braket
id|i
)braket
dot
id|dev
dot
r_class
op_rshift_assign
l_int|8
suffix:semicolon
id|c
(braket
id|i
)braket
dot
id|dev.hdr_type
op_assign
id|hdr
suffix:semicolon
id|pci_proc_attach_device
c_func
(paren
op_amp
id|c
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
)brace
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
DECL|function|cb_free
r_void
id|cb_free
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
r_struct
id|pci_dev
op_star
op_star
id|p
comma
op_star
id|q
suffix:semicolon
id|cb_config_t
op_star
id|c
op_assign
id|s-&gt;cb_config
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
(brace
multiline_comment|/* Unlink from PCI device chain */
r_for
c_loop
(paren
id|p
op_assign
op_amp
id|pci_devices
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_assign
op_amp
(paren
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|next
)paren
)paren
r_if
c_cond
(paren
op_star
id|p
op_eq
op_amp
id|c
(braket
l_int|0
)braket
dot
id|dev
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|q
op_assign
op_star
id|p
suffix:semicolon
id|q
suffix:semicolon
id|q
op_assign
id|q-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;bus
op_ne
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|bus
)paren
r_break
suffix:semicolon
id|pci_proc_detach_device
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|p
)paren
op_star
id|p
op_assign
id|q
suffix:semicolon
id|s-&gt;cap.cb_bus-&gt;devices
op_assign
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cs: cb_free(bus %d)&bslash;n&quot;
comma
id|s-&gt;cap.cardbus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;cb_config
)paren
(brace
id|kfree
c_func
(paren
id|s-&gt;cb_config
)paren
suffix:semicolon
id|s-&gt;cb_config
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*=====================================================================&n;&n;    cb_config() has the job of allocating all system resources that&n;    a Cardbus card requires.  Rather than using the CIS (which seems&n;    to not always be present), it treats the card as an ordinary PCI&n;    device, and probes the base address registers to determine each&n;    function&squot;s IO and memory space needs.&n;&n;    It is called from the RequestIO card service.&n;    &n;======================================================================*/
DECL|function|cb_config
r_int
id|cb_config
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
id|cb_config_t
op_star
id|c
op_assign
id|s-&gt;cb_config
suffix:semicolon
id|u_char
id|fn
op_assign
id|s-&gt;functions
suffix:semicolon
id|u_char
id|i
comma
id|j
comma
id|bus
op_assign
id|s-&gt;cap.cardbus
comma
op_star
id|name
suffix:semicolon
id|u_int
id|sz
comma
id|align
comma
id|m
comma
id|mask
(braket
l_int|3
)braket
comma
id|num
(braket
l_int|3
)braket
comma
id|base
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|irq
comma
r_try
comma
id|ret
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cs: cb_config(bus %d)&bslash;n&quot;
comma
id|s-&gt;cap.cardbus
)paren
suffix:semicolon
multiline_comment|/* Determine IO and memory space needs */
id|num
(braket
id|B_IO
)braket
op_assign
id|num
(braket
id|B_M1
)braket
op_assign
id|num
(braket
id|B_M2
)braket
op_assign
l_int|0
suffix:semicolon
id|mask
(braket
id|B_IO
)braket
op_assign
id|mask
(braket
id|B_M1
)braket
op_assign
id|mask
(braket
id|B_M2
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fn
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
(brace
id|pci_writel
c_func
(paren
id|bus
comma
id|i
comma
id|CB_BAR
c_func
(paren
id|j
)paren
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|pci_readl
c_func
(paren
id|bus
comma
id|i
comma
id|CB_BAR
c_func
(paren
id|j
)paren
comma
op_amp
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
(brace
id|m
op_assign
id|B_IO
suffix:semicolon
id|sz
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
)brace
r_else
(brace
id|m
op_assign
(paren
id|sz
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
ques
c_cond
id|B_M2
suffix:colon
id|B_M1
suffix:semicolon
id|sz
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
)brace
id|sz
op_assign
id|FIND_FIRST_BIT
c_func
(paren
id|sz
)paren
suffix:semicolon
id|c
(braket
id|i
)braket
dot
id|size
(braket
id|j
)braket
op_assign
id|sz
op_or
id|m
suffix:semicolon
r_if
c_cond
(paren
id|m
op_logical_and
(paren
id|sz
OL
id|PAGE_SIZE
)paren
)paren
id|sz
op_assign
id|PAGE_SIZE
suffix:semicolon
id|num
(braket
id|m
)braket
op_add_assign
id|sz
suffix:semicolon
id|mask
(braket
id|m
)braket
op_or_assign
id|sz
suffix:semicolon
)brace
id|pci_writel
c_func
(paren
id|bus
comma
id|i
comma
id|CB_ROM_BASE
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|pci_readl
c_func
(paren
id|bus
comma
id|i
comma
id|CB_ROM_BASE
comma
op_amp
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_ne
l_int|0
)paren
(brace
id|sz
op_assign
id|FIND_FIRST_BIT
c_func
(paren
id|sz
op_amp
op_complement
l_int|0x00000001
)paren
suffix:semicolon
id|c
(braket
id|i
)braket
dot
id|size
(braket
l_int|6
)braket
op_assign
id|sz
op_or
id|B_M1
suffix:semicolon
r_if
c_cond
(paren
id|sz
OL
id|PAGE_SIZE
)paren
id|sz
op_assign
id|PAGE_SIZE
suffix:semicolon
id|num
(braket
id|B_M1
)braket
op_add_assign
id|sz
suffix:semicolon
id|mask
(braket
id|B_M1
)braket
op_or_assign
id|sz
suffix:semicolon
)brace
)brace
multiline_comment|/* Allocate system resources */
id|name
op_assign
l_string|&quot;cb_enabler&quot;
suffix:semicolon
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|NumPorts
op_assign
id|num
(braket
id|B_IO
)braket
suffix:semicolon
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|BasePort
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|num
(braket
id|B_IO
)braket
)paren
(brace
r_if
c_cond
(paren
id|find_io_region
c_func
(paren
op_amp
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|BasePort
comma
id|num
(braket
id|B_IO
)braket
comma
id|name
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: could not allocate %d IO ports for&quot;
l_string|&quot; CardBus socket %d&bslash;n&quot;
comma
id|num
(braket
id|B_IO
)braket
comma
id|s-&gt;sock
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|base
(braket
id|B_IO
)braket
op_assign
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|BasePort
op_plus
id|num
(braket
id|B_IO
)braket
suffix:semicolon
)brace
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|size
op_assign
id|num
(braket
id|B_M1
)braket
suffix:semicolon
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|base
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|num
(braket
id|B_M1
)braket
)paren
(brace
r_if
c_cond
(paren
id|find_mem_region
c_func
(paren
op_amp
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|base
comma
id|num
(braket
id|B_M1
)braket
comma
id|name
comma
id|num
(braket
id|B_M1
)braket
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: could not allocate %dK memory for&quot;
l_string|&quot; CardBus socket %d&bslash;n&quot;
comma
id|num
(braket
id|B_M1
)braket
op_div
l_int|1024
comma
id|s-&gt;sock
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|base
(braket
id|B_M1
)braket
op_assign
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|base
op_plus
id|num
(braket
id|B_M1
)braket
suffix:semicolon
)brace
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|size
op_assign
id|num
(braket
id|B_M2
)braket
suffix:semicolon
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|base
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|num
(braket
id|B_M2
)braket
)paren
(brace
r_if
c_cond
(paren
id|find_mem_region
c_func
(paren
op_amp
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|base
comma
id|num
(braket
id|B_M2
)braket
comma
id|name
comma
id|num
(braket
id|B_M2
)braket
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: could not allocate %dK memory for&quot;
l_string|&quot; CardBus socket %d&bslash;n&quot;
comma
id|num
(braket
id|B_M2
)braket
op_div
l_int|1024
comma
id|s-&gt;sock
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|base
(braket
id|B_M2
)braket
op_assign
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|base
op_plus
id|num
(braket
id|B_M2
)braket
suffix:semicolon
)brace
multiline_comment|/* Set up base address registers */
r_while
c_loop
(paren
id|mask
(braket
id|B_IO
)braket
op_or
id|mask
(braket
id|B_M1
)braket
op_or
id|mask
(braket
id|B_M2
)braket
)paren
(brace
id|num
(braket
id|B_IO
)braket
op_assign
id|FIND_FIRST_BIT
c_func
(paren
id|mask
(braket
id|B_IO
)braket
)paren
suffix:semicolon
id|mask
(braket
id|B_IO
)braket
op_sub_assign
id|num
(braket
id|B_IO
)braket
suffix:semicolon
id|num
(braket
id|B_M1
)braket
op_assign
id|FIND_FIRST_BIT
c_func
(paren
id|mask
(braket
id|B_M1
)braket
)paren
suffix:semicolon
id|mask
(braket
id|B_M1
)braket
op_sub_assign
id|num
(braket
id|B_M1
)braket
suffix:semicolon
id|num
(braket
id|B_M2
)braket
op_assign
id|FIND_FIRST_BIT
c_func
(paren
id|mask
(braket
id|B_M2
)braket
)paren
suffix:semicolon
id|mask
(braket
id|B_M2
)braket
op_sub_assign
id|num
(braket
id|B_M2
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fn
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|7
suffix:semicolon
id|j
op_increment
)paren
(brace
id|sz
op_assign
id|c
(braket
id|i
)braket
dot
id|size
(braket
id|j
)braket
suffix:semicolon
id|m
op_assign
id|sz
op_amp
l_int|3
suffix:semicolon
id|sz
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|align
op_assign
(paren
id|m
op_logical_and
(paren
id|sz
OL
id|PAGE_SIZE
)paren
)paren
ques
c_cond
id|PAGE_SIZE
suffix:colon
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_logical_and
(paren
id|align
op_eq
id|num
(braket
id|m
)braket
)paren
)paren
(brace
id|base
(braket
id|m
)braket
op_sub_assign
id|align
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
l_int|6
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  fn %d bar %d: &quot;
comma
id|i
comma
id|j
op_plus
l_int|1
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  fn %d rom: &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s 0x%x-0x%x&bslash;n&quot;
comma
(paren
id|m
)paren
ques
c_cond
l_string|&quot;mem&quot;
suffix:colon
l_string|&quot;io&quot;
comma
id|base
(braket
id|m
)braket
comma
id|base
(braket
id|m
)braket
op_plus
id|sz
op_minus
l_int|1
)paren
suffix:semicolon
id|BASE
c_func
(paren
id|c
(braket
id|i
)braket
dot
id|dev
comma
id|j
)paren
op_assign
id|base
(braket
id|m
)braket
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Allocate interrupt if needed */
id|s-&gt;irq.AssignedIRQ
op_assign
id|irq
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_readb
c_func
(paren
id|bus
comma
id|i
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;cap.irq_mask
op_amp
(paren
l_int|1
op_lshift
id|s-&gt;cap.pci_irq
)paren
)paren
(brace
id|irq
op_assign
id|s-&gt;cap.pci_irq
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISA
r_else
r_for
c_loop
(paren
r_try
op_assign
l_int|0
suffix:semicolon
r_try
OL
l_int|2
suffix:semicolon
r_try
op_increment
)paren
(brace
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
OL
l_int|32
suffix:semicolon
id|irq
op_increment
)paren
r_if
c_cond
(paren
(paren
id|s-&gt;cap.irq_mask
op_rshift
id|irq
)paren
op_amp
l_int|1
)paren
(brace
id|ret
op_assign
id|try_irq
c_func
(paren
id|IRQ_TYPE_EXCLUSIVE
comma
id|irq
comma
r_try
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: could not allocate interrupt&quot;
l_string|&quot; for CardBus socket %d&bslash;n&quot;
comma
id|s-&gt;sock
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
macro_line|#endif
id|s-&gt;irq.AssignedIRQ
op_assign
id|irq
suffix:semicolon
)brace
)brace
id|c
(braket
l_int|0
)braket
dot
id|dev.irq
op_assign
id|irq
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
id|failed
suffix:colon
id|cb_release
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
id|CS_OUT_OF_RESOURCE
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    cb_release() releases all the system resources (IO and memory&n;    space, and interrupt) committed for a Cardbus card by a prior call&n;    to cb_config().&n;&n;    It is called from the ReleaseIO() service.&n;    &n;======================================================================*/
DECL|function|cb_release
r_void
id|cb_release
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
id|cb_config_t
op_star
id|c
op_assign
id|s-&gt;cb_config
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;cs: cb_release(bus %d)&bslash;n&quot;
comma
id|s-&gt;cap.cardbus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|size
OG
l_int|0
)paren
id|release_mem_region
c_func
(paren
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|base
comma
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|size
OG
l_int|0
)paren
id|release_mem_region
c_func
(paren
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|base
comma
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|NumPorts
OG
l_int|0
)paren
id|release_region
c_func
(paren
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|BasePort
comma
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|NumPorts
)paren
suffix:semicolon
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|NumPorts
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISA
r_if
c_cond
(paren
(paren
id|c
(braket
l_int|0
)braket
dot
id|dev.irq
op_ne
l_int|0
)paren
op_logical_and
(paren
id|c
(braket
l_int|0
)braket
dot
id|dev.irq
op_ne
id|s-&gt;cap.pci_irq
)paren
)paren
id|undo_irq
c_func
(paren
id|IRQ_TYPE_EXCLUSIVE
comma
id|c
(braket
l_int|0
)braket
dot
id|dev.irq
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*=====================================================================&n;&n;    cb_enable() has the job of configuring a socket for a Cardbus&n;    card, and initializing the card&squot;s PCI configuration registers.&n;&n;    It first sets up the Cardbus bridge windows, for IO and memory&n;    accesses.  Then, it initializes each card function&squot;s base address&n;    registers, interrupt line register, and command register.&n;&n;    It is called as part of the RequestConfiguration card service.&n;    It should be called after a previous call to cb_config() (via the&n;    RequestIO service).&n;    &n;======================================================================*/
DECL|function|cb_enable
r_void
id|cb_enable
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
id|u_char
id|i
comma
id|j
comma
id|bus
op_assign
id|s-&gt;cap.cardbus
suffix:semicolon
id|cb_config_t
op_star
id|c
op_assign
id|s-&gt;cb_config
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;cs: cb_enable(bus %d)&bslash;n&quot;
comma
id|bus
)paren
suffix:semicolon
multiline_comment|/* Configure bridge */
r_if
c_cond
(paren
id|s-&gt;cb_cis_map.start
)paren
id|cb_release_cis_mem
c_func
(paren
id|s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cb_bridge_map
id|m
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
id|B_IO
suffix:colon
id|m.map
op_assign
l_int|0
suffix:semicolon
id|m.flags
op_assign
id|MAP_IOSPACE
op_or
id|MAP_ACTIVE
suffix:semicolon
id|m.start
op_assign
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|BasePort
suffix:semicolon
id|m.stop
op_assign
id|m.start
op_plus
id|s-&gt;io
(braket
l_int|0
)braket
dot
id|NumPorts
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B_M1
suffix:colon
id|m.map
op_assign
l_int|0
suffix:semicolon
id|m.flags
op_assign
id|MAP_ACTIVE
suffix:semicolon
id|m.start
op_assign
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|base
suffix:semicolon
id|m.stop
op_assign
id|m.start
op_plus
id|s-&gt;win
(braket
l_int|0
)braket
dot
id|size
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B_M2
suffix:colon
id|m.map
op_assign
l_int|1
suffix:semicolon
id|m.flags
op_assign
id|MAP_PREFETCH
op_or
id|MAP_ACTIVE
suffix:semicolon
id|m.start
op_assign
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|base
suffix:semicolon
id|m.stop
op_assign
id|m.start
op_plus
id|s-&gt;win
(braket
l_int|1
)braket
dot
id|size
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m.start
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  bridge %s map %d (flags 0x%x): 0x%x-0x%x&bslash;n&quot;
comma
(paren
id|m.flags
op_amp
id|MAP_IOSPACE
)paren
ques
c_cond
l_string|&quot;io&quot;
suffix:colon
l_string|&quot;mem&quot;
comma
id|m.map
comma
id|m.flags
comma
id|m.start
comma
id|m.stop
)paren
suffix:semicolon
id|s
op_member_access_from_pointer
id|ss_entry
c_func
(paren
id|s-&gt;sock
comma
id|SS_SetBridge
comma
op_amp
id|m
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up base address registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|s-&gt;functions
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|BASE
c_func
(paren
id|c
(braket
id|i
)braket
dot
id|dev
comma
id|j
)paren
op_ne
l_int|0
)paren
id|pci_writel
c_func
(paren
id|bus
comma
id|i
comma
id|CB_BAR
c_func
(paren
id|j
)paren
comma
id|BASE
c_func
(paren
id|c
(braket
id|i
)braket
dot
id|dev
comma
id|j
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ROM
c_func
(paren
id|c
(braket
id|i
)braket
dot
id|dev
)paren
op_ne
l_int|0
)paren
id|pci_writel
c_func
(paren
id|bus
comma
id|i
comma
id|CB_ROM_BASE
comma
id|ROM
c_func
(paren
id|c
(braket
id|i
)braket
dot
id|dev
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up PCI interrupt and command registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|s-&gt;functions
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_writeb
c_func
(paren
id|bus
comma
id|i
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
)paren
suffix:semicolon
id|pci_writeb
c_func
(paren
id|bus
comma
id|i
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;irq.AssignedIRQ
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|s-&gt;functions
suffix:semicolon
id|i
op_increment
)paren
id|pci_writeb
c_func
(paren
id|bus
comma
id|i
comma
id|PCI_INTERRUPT_LINE
comma
id|s-&gt;irq.AssignedIRQ
)paren
suffix:semicolon
id|s-&gt;socket.io_irq
op_assign
id|s-&gt;irq.AssignedIRQ
suffix:semicolon
id|s
op_member_access_from_pointer
id|ss_entry
c_func
(paren
id|s-&gt;sock
comma
id|SS_SetSocket
comma
op_amp
id|s-&gt;socket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*======================================================================&n;&n;    cb_disable() unconfigures a Cardbus card previously set up by&n;    cb_enable().&n;&n;    It is called from the ReleaseConfiguration service.&n;    &n;======================================================================*/
DECL|function|cb_disable
r_void
id|cb_disable
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
id|u_char
id|i
suffix:semicolon
id|cb_bridge_map
id|m
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0xffff
)brace
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;cs: cb_disable(bus %d)&bslash;n&quot;
comma
id|s-&gt;cap.cardbus
)paren
suffix:semicolon
multiline_comment|/* Turn off bridge windows */
r_if
c_cond
(paren
id|s-&gt;cb_cis_map.start
)paren
id|cb_release_cis_mem
c_func
(paren
id|s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
id|B_IO
suffix:colon
id|m.map
op_assign
l_int|0
suffix:semicolon
id|m.flags
op_assign
id|MAP_IOSPACE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B_M1
suffix:colon
id|m.map
op_assign
id|m.flags
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B_M2
suffix:colon
id|m.map
op_assign
l_int|1
suffix:semicolon
id|m.flags
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|s
op_member_access_from_pointer
id|ss_entry
c_func
(paren
id|s-&gt;sock
comma
id|SS_SetBridge
comma
op_amp
id|m
)paren
suffix:semicolon
)brace
)brace
eof
