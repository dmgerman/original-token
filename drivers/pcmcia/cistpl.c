multiline_comment|/*======================================================================&n;&n;    PCMCIA Card Information Structure parser&n;&n;    cistpl.c 1.91 2000/09/16 03:48:28&n;&n;    The contents of this file are subject to the Mozilla Public&n;    License Version 1.1 (the &quot;License&quot;); you may not use this file&n;    except in compliance with the License. You may obtain a copy of&n;    the License at http://www.mozilla.org/MPL/&n;&n;    Software distributed under the License is distributed on an &quot;AS&n;    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or&n;    implied. See the License for the specific language governing&n;    rights and limitations under the License.&n;&n;    The initial developer of the original code is David A. Hinds&n;    &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds&n;    are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.&n;&n;    Alternatively, the contents of this file may be used under the&n;    terms of the GNU Public License version 2 (the &quot;GPL&quot;), in which&n;    case the provisions of the GPL are applicable instead of the&n;    above.  If you wish to allow the use of your version of this file&n;    only under the terms of the GPL and not to allow others to use&n;    your version of this file under the MPL, indicate your decision&n;    by deleting the provisions above and replace them with the notice&n;    and other provisions required by the GPL.  If you do not delete&n;    the provisions above, a recipient may use your version of this&n;    file under either the MPL or the GPL.&n;    &n;======================================================================*/
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/bus_ops.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/bulkmem.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &quot;cs_internal.h&quot;
macro_line|#include &quot;rsrc_mgr.h&quot;
DECL|variable|mantissa
r_static
r_const
id|u_char
id|mantissa
(braket
)braket
op_assign
(brace
l_int|10
comma
l_int|12
comma
l_int|13
comma
l_int|15
comma
l_int|20
comma
l_int|25
comma
l_int|30
comma
l_int|35
comma
l_int|40
comma
l_int|45
comma
l_int|50
comma
l_int|55
comma
l_int|60
comma
l_int|70
comma
l_int|80
comma
l_int|90
)brace
suffix:semicolon
DECL|variable|exponent
r_static
r_const
id|u_int
id|exponent
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|10
comma
l_int|100
comma
l_int|1000
comma
l_int|10000
comma
l_int|100000
comma
l_int|1000000
comma
l_int|10000000
)brace
suffix:semicolon
multiline_comment|/* Convert an extended speed byte to a time in nanoseconds */
DECL|macro|SPEED_CVT
mdefine_line|#define SPEED_CVT(v) &bslash;&n;    (mantissa[(((v)&gt;&gt;3)&amp;15)-1] * exponent[(v)&amp;7] / 10)
multiline_comment|/* Convert a power byte to a current in 0.1 microamps */
DECL|macro|POWER_CVT
mdefine_line|#define POWER_CVT(v) &bslash;&n;    (mantissa[((v)&gt;&gt;3)&amp;15] * exponent[(v)&amp;7] / 10)
DECL|macro|POWER_SCALE
mdefine_line|#define POWER_SCALE(v)&t;&t;(exponent[(v)&amp;7])
multiline_comment|/* Upper limit on reasonable # of tuples */
DECL|macro|MAX_TUPLES
mdefine_line|#define MAX_TUPLES&t;&t;200
multiline_comment|/*====================================================================*/
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
DECL|macro|INT_MODULE_PARM
mdefine_line|#define INT_MODULE_PARM(n, v) static int n = v; MODULE_PARM(n, &quot;i&quot;)
id|INT_MODULE_PARM
c_func
(paren
id|cis_width
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 16-bit CIS? */
multiline_comment|/*======================================================================&n;&n;    Low-level functions to read and write CIS memory.  I think the&n;    write routine is only useful for writing one-byte registers.&n;    &n;======================================================================*/
multiline_comment|/* Bits in attr field */
DECL|macro|IS_ATTR
mdefine_line|#define IS_ATTR&t;&t;1
DECL|macro|IS_INDIRECT
mdefine_line|#define IS_INDIRECT&t;8
r_static
r_int
id|setup_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
suffix:semicolon
DECL|function|set_cis_map
r_static
r_void
id|set_cis_map
c_func
(paren
id|socket_info_t
op_star
id|s
comma
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|s-&gt;ss_entry
op_member_access_from_pointer
id|set_mem_map
c_func
(paren
id|s-&gt;sock
comma
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;cap.features
op_amp
id|SS_CAP_STATIC_MAP
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;cis_virt
)paren
id|bus_iounmap
c_func
(paren
id|s-&gt;cap.bus
comma
id|s-&gt;cis_virt
)paren
suffix:semicolon
id|s-&gt;cis_virt
op_assign
id|bus_ioremap
c_func
(paren
id|s-&gt;cap.bus
comma
id|mem-&gt;sys_start
comma
id|s-&gt;cap.map_size
)paren
suffix:semicolon
)brace
)brace
DECL|function|read_cis_mem
r_void
id|read_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
comma
r_int
id|attr
comma
id|u_int
id|addr
comma
id|u_int
id|len
comma
r_void
op_star
id|ptr
)paren
(brace
id|pccard_mem_map
op_star
id|mem
op_assign
op_amp
id|s-&gt;cis_mem
suffix:semicolon
id|u_char
op_star
id|sys
comma
op_star
id|buf
op_assign
id|ptr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;cs: read_cis_mem(%d, %#x, %u)&bslash;n&quot;
comma
id|attr
comma
id|addr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup_cis_mem
c_func
(paren
id|s
)paren
op_ne
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|ptr
comma
l_int|0xff
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mem-&gt;flags
op_assign
id|MAP_ACTIVE
op_or
(paren
(paren
id|cis_width
)paren
ques
c_cond
id|MAP_16BIT
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_amp
id|IS_INDIRECT
)paren
(brace
multiline_comment|/* Indirect accesses use a bunch of special registers at fixed&n;&t;   locations in common memory */
id|u_char
id|flags
op_assign
id|ICTRL0_COMMON
op_or
id|ICTRL0_AUTOINC
op_or
id|ICTRL0_BYTEGRAN
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_amp
id|IS_ATTR
)paren
(brace
id|addr
op_mul_assign
l_int|2
suffix:semicolon
id|flags
op_assign
id|ICTRL0_AUTOINC
suffix:semicolon
)brace
id|mem-&gt;card_start
op_assign
l_int|0
suffix:semicolon
id|mem-&gt;flags
op_assign
id|MAP_ACTIVE
suffix:semicolon
id|set_cis_map
c_func
(paren
id|s
comma
id|mem
)paren
suffix:semicolon
id|sys
op_assign
id|s-&gt;cis_virt
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
id|flags
comma
id|sys
op_plus
id|CISREG_ICTRL0
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
id|addr
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR0
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR1
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
(paren
id|addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR2
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
(paren
id|addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR3
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|buf
op_increment
)paren
op_star
id|buf
op_assign
id|bus_readb
c_func
(paren
id|s-&gt;cap.bus
comma
id|sys
op_plus
id|CISREG_IDATA0
)paren
suffix:semicolon
)brace
r_else
(brace
id|u_int
id|inc
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|attr
)paren
(brace
id|mem-&gt;flags
op_or_assign
id|MAP_ATTRIB
suffix:semicolon
id|inc
op_increment
suffix:semicolon
id|addr
op_mul_assign
l_int|2
suffix:semicolon
)brace
id|sys
op_add_assign
(paren
id|addr
op_amp
(paren
id|s-&gt;cap.map_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|mem-&gt;card_start
op_assign
id|addr
op_amp
op_complement
(paren
id|s-&gt;cap.map_size
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|set_cis_map
c_func
(paren
id|s
comma
id|mem
)paren
suffix:semicolon
id|sys
op_assign
id|s-&gt;cis_virt
op_plus
(paren
id|addr
op_amp
(paren
id|s-&gt;cap.map_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|buf
op_increment
comma
id|sys
op_add_assign
id|inc
)paren
(brace
r_if
c_cond
(paren
id|sys
op_eq
id|s-&gt;cis_virt
op_plus
id|s-&gt;cap.map_size
)paren
r_break
suffix:semicolon
op_star
id|buf
op_assign
id|bus_readb
c_func
(paren
id|s-&gt;cap.bus
comma
id|sys
)paren
suffix:semicolon
)brace
id|mem-&gt;card_start
op_add_assign
id|s-&gt;cap.map_size
suffix:semicolon
id|addr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;cs:  %#2.2x %#2.2x %#2.2x %#2.2x ...&bslash;n&quot;
comma
op_star
(paren
id|u_char
op_star
)paren
(paren
id|ptr
op_plus
l_int|0
)paren
comma
op_star
(paren
id|u_char
op_star
)paren
(paren
id|ptr
op_plus
l_int|1
)paren
comma
op_star
(paren
id|u_char
op_star
)paren
(paren
id|ptr
op_plus
l_int|2
)paren
comma
op_star
(paren
id|u_char
op_star
)paren
(paren
id|ptr
op_plus
l_int|3
)paren
)paren
suffix:semicolon
)brace
DECL|function|write_cis_mem
r_void
id|write_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
comma
r_int
id|attr
comma
id|u_int
id|addr
comma
id|u_int
id|len
comma
r_void
op_star
id|ptr
)paren
(brace
id|pccard_mem_map
op_star
id|mem
op_assign
op_amp
id|s-&gt;cis_mem
suffix:semicolon
id|u_char
op_star
id|sys
comma
op_star
id|buf
op_assign
id|ptr
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;cs: write_cis_mem(%d, %#x, %u)&bslash;n&quot;
comma
id|attr
comma
id|addr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup_cis_mem
c_func
(paren
id|s
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|mem-&gt;flags
op_assign
id|MAP_ACTIVE
op_or
(paren
(paren
id|cis_width
)paren
ques
c_cond
id|MAP_16BIT
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_amp
id|IS_INDIRECT
)paren
(brace
multiline_comment|/* Indirect accesses use a bunch of special registers at fixed&n;&t;   locations in common memory */
id|u_char
id|flags
op_assign
id|ICTRL0_COMMON
op_or
id|ICTRL0_AUTOINC
op_or
id|ICTRL0_BYTEGRAN
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_amp
id|IS_ATTR
)paren
(brace
id|addr
op_mul_assign
l_int|2
suffix:semicolon
id|flags
op_assign
id|ICTRL0_AUTOINC
suffix:semicolon
)brace
id|mem-&gt;card_start
op_assign
l_int|0
suffix:semicolon
id|mem-&gt;flags
op_assign
id|MAP_ACTIVE
suffix:semicolon
id|set_cis_map
c_func
(paren
id|s
comma
id|mem
)paren
suffix:semicolon
id|sys
op_assign
id|s-&gt;cis_virt
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
id|flags
comma
id|sys
op_plus
id|CISREG_ICTRL0
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
id|addr
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR0
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR1
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
(paren
id|addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR2
)paren
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
(paren
id|addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
id|sys
op_plus
id|CISREG_IADDR3
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|buf
op_increment
)paren
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
op_star
id|buf
comma
id|sys
op_plus
id|CISREG_IDATA0
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|inc
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_amp
id|IS_ATTR
)paren
(brace
id|mem-&gt;flags
op_or_assign
id|MAP_ATTRIB
suffix:semicolon
id|inc
op_increment
suffix:semicolon
id|addr
op_mul_assign
l_int|2
suffix:semicolon
)brace
id|mem-&gt;card_start
op_assign
id|addr
op_amp
op_complement
(paren
id|s-&gt;cap.map_size
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|set_cis_map
c_func
(paren
id|s
comma
id|mem
)paren
suffix:semicolon
id|sys
op_assign
id|s-&gt;cis_virt
op_plus
(paren
id|addr
op_amp
(paren
id|s-&gt;cap.map_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|buf
op_increment
comma
id|sys
op_add_assign
id|inc
)paren
(brace
r_if
c_cond
(paren
id|sys
op_eq
id|s-&gt;cis_virt
op_plus
id|s-&gt;cap.map_size
)paren
r_break
suffix:semicolon
id|bus_writeb
c_func
(paren
id|s-&gt;cap.bus
comma
op_star
id|buf
comma
id|sys
)paren
suffix:semicolon
)brace
id|mem-&gt;card_start
op_add_assign
id|s-&gt;cap.map_size
suffix:semicolon
id|addr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*======================================================================&n;&n;    This is tricky... when we set up CIS memory, we try to validate&n;    the memory window space allocations.&n;    &n;======================================================================*/
multiline_comment|/* Scratch pointer to the socket we use for validation */
DECL|variable|vs
r_static
id|socket_info_t
op_star
id|vs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Validation function for cards with a valid CIS */
DECL|function|cis_readable
r_static
r_int
id|cis_readable
c_func
(paren
id|u_long
id|base
)paren
(brace
id|cisinfo_t
id|info1
comma
id|info2
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|vs-&gt;cis_mem.sys_start
op_assign
id|base
suffix:semicolon
id|vs-&gt;cis_mem.sys_stop
op_assign
id|base
op_plus
id|vs-&gt;cap.map_size
op_minus
l_int|1
suffix:semicolon
id|vs-&gt;cis_virt
op_assign
id|bus_ioremap
c_func
(paren
id|vs-&gt;cap.bus
comma
id|base
comma
id|vs-&gt;cap.map_size
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_validate_cis
c_func
(paren
id|vs-&gt;clients
comma
op_amp
id|info1
)paren
suffix:semicolon
multiline_comment|/* invalidate mapping and CIS cache */
id|bus_iounmap
c_func
(paren
id|vs-&gt;cap.bus
comma
id|vs-&gt;cis_virt
)paren
suffix:semicolon
id|vs-&gt;cis_used
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_ne
l_int|0
)paren
op_logical_or
(paren
id|info1.Chains
op_eq
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|vs-&gt;cis_mem.sys_start
op_assign
id|base
op_plus
id|vs-&gt;cap.map_size
suffix:semicolon
id|vs-&gt;cis_mem.sys_stop
op_assign
id|base
op_plus
l_int|2
op_star
id|vs-&gt;cap.map_size
op_minus
l_int|1
suffix:semicolon
id|vs-&gt;cis_virt
op_assign
id|bus_ioremap
c_func
(paren
id|vs-&gt;cap.bus
comma
id|base
op_plus
id|vs-&gt;cap.map_size
comma
id|vs-&gt;cap.map_size
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_validate_cis
c_func
(paren
id|vs-&gt;clients
comma
op_amp
id|info2
)paren
suffix:semicolon
id|bus_iounmap
c_func
(paren
id|vs-&gt;cap.bus
comma
id|vs-&gt;cis_virt
)paren
suffix:semicolon
id|vs-&gt;cis_used
op_assign
l_int|0
suffix:semicolon
r_return
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
(paren
id|info1.Chains
op_eq
id|info2.Chains
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Validation function for simple memory cards */
DECL|function|checksum
r_static
r_int
id|checksum
c_func
(paren
id|u_long
id|base
)paren
(brace
r_int
id|i
comma
id|a
comma
id|b
comma
id|d
suffix:semicolon
id|vs-&gt;cis_mem.sys_start
op_assign
id|base
suffix:semicolon
id|vs-&gt;cis_mem.sys_stop
op_assign
id|base
op_plus
id|vs-&gt;cap.map_size
op_minus
l_int|1
suffix:semicolon
id|vs-&gt;cis_virt
op_assign
id|bus_ioremap
c_func
(paren
id|vs-&gt;cap.bus
comma
id|base
comma
id|vs-&gt;cap.map_size
)paren
suffix:semicolon
id|vs-&gt;cis_mem.card_start
op_assign
l_int|0
suffix:semicolon
id|vs-&gt;cis_mem.flags
op_assign
id|MAP_ACTIVE
suffix:semicolon
id|vs-&gt;ss_entry
op_member_access_from_pointer
id|set_mem_map
c_func
(paren
id|vs-&gt;sock
comma
op_amp
id|vs-&gt;cis_mem
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t bother checking every word... */
id|a
op_assign
l_int|0
suffix:semicolon
id|b
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vs-&gt;cap.map_size
suffix:semicolon
id|i
op_add_assign
l_int|44
)paren
(brace
id|d
op_assign
id|bus_readl
c_func
(paren
id|vs-&gt;cap.bus
comma
id|vs-&gt;cis_virt
op_plus
id|i
)paren
suffix:semicolon
id|a
op_add_assign
id|d
suffix:semicolon
id|b
op_and_assign
id|d
suffix:semicolon
)brace
id|bus_iounmap
c_func
(paren
id|vs-&gt;cap.bus
comma
id|vs-&gt;cis_virt
)paren
suffix:semicolon
r_return
(paren
id|b
op_eq
op_minus
l_int|1
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
(paren
id|a
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|checksum_match
r_static
r_int
id|checksum_match
c_func
(paren
id|u_long
id|base
)paren
(brace
r_int
id|a
op_assign
id|checksum
c_func
(paren
id|base
)paren
comma
id|b
op_assign
id|checksum
c_func
(paren
id|base
op_plus
id|vs-&gt;cap.map_size
)paren
suffix:semicolon
r_return
(paren
(paren
id|a
op_eq
id|b
)paren
op_logical_and
(paren
id|a
op_ge
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|setup_cis_mem
r_static
r_int
id|setup_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;cap.features
op_amp
id|SS_CAP_STATIC_MAP
)paren
op_logical_and
(paren
id|s-&gt;cis_mem.sys_start
op_eq
l_int|0
)paren
)paren
(brace
r_int
id|low
op_assign
op_logical_neg
(paren
id|s-&gt;cap.features
op_amp
id|SS_CAP_PAGE_REGS
)paren
suffix:semicolon
id|vs
op_assign
id|s
suffix:semicolon
id|validate_mem
c_func
(paren
id|cis_readable
comma
id|checksum_match
comma
id|low
)paren
suffix:semicolon
id|s-&gt;cis_mem.sys_start
op_assign
l_int|0
suffix:semicolon
id|vs
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|find_mem_region
c_func
(paren
op_amp
id|s-&gt;cis_mem.sys_start
comma
id|s-&gt;cap.map_size
comma
id|s-&gt;cap.map_size
comma
id|low
comma
l_string|&quot;card services&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;cs: unable to map card memory!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|CS_OUT_OF_RESOURCE
suffix:semicolon
)brace
id|s-&gt;cis_mem.sys_stop
op_assign
id|s-&gt;cis_mem.sys_start
op_plus
id|s-&gt;cap.map_size
op_minus
l_int|1
suffix:semicolon
id|s-&gt;cis_virt
op_assign
id|bus_ioremap
c_func
(paren
id|s-&gt;cap.bus
comma
id|s-&gt;cis_mem.sys_start
comma
id|s-&gt;cap.map_size
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|release_cis_mem
r_void
id|release_cis_mem
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;cis_mem.sys_start
op_ne
l_int|0
)paren
(brace
id|s-&gt;cis_mem.flags
op_and_assign
op_complement
id|MAP_ACTIVE
suffix:semicolon
id|s-&gt;ss_entry
op_member_access_from_pointer
id|set_mem_map
c_func
(paren
id|s-&gt;sock
comma
op_amp
id|s-&gt;cis_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;cap.features
op_amp
id|SS_CAP_STATIC_MAP
)paren
)paren
id|release_mem_region
c_func
(paren
id|s-&gt;cis_mem.sys_start
comma
id|s-&gt;cap.map_size
)paren
suffix:semicolon
id|bus_iounmap
c_func
(paren
id|s-&gt;cap.bus
comma
id|s-&gt;cis_virt
)paren
suffix:semicolon
id|s-&gt;cis_mem.sys_start
op_assign
l_int|0
suffix:semicolon
id|s-&gt;cis_virt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*======================================================================&n;&n;    This is a wrapper around read_cis_mem, with the same interface,&n;    but which caches information, for cards whose CIS may not be&n;    readable all the time.&n;    &n;======================================================================*/
DECL|function|read_cis_cache
r_static
r_void
id|read_cis_cache
c_func
(paren
id|socket_info_t
op_star
id|s
comma
r_int
id|attr
comma
id|u_int
id|addr
comma
id|u_int
id|len
comma
r_void
op_star
id|ptr
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|caddr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;fake_cis
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;fake_cis_len
OG
id|addr
op_plus
id|len
)paren
id|memcpy
c_func
(paren
id|ptr
comma
id|s-&gt;fake_cis
op_plus
id|addr
comma
id|len
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|ptr
comma
l_int|0xff
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|caddr
op_assign
id|s-&gt;cis_cache
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|s-&gt;cis_used
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|addr
op_eq
id|addr
)paren
op_logical_and
(paren
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
op_eq
id|len
)paren
op_logical_and
(paren
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|attr
op_eq
id|attr
)paren
)paren
r_break
suffix:semicolon
id|caddr
op_add_assign
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|s-&gt;cis_used
)paren
(brace
id|memcpy
c_func
(paren
id|ptr
comma
id|caddr
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CARDBUS
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|SOCKET_CARDBUS
)paren
id|read_cb_mem
c_func
(paren
id|s
comma
l_int|0
comma
id|attr
comma
id|addr
comma
id|len
comma
id|ptr
)paren
suffix:semicolon
r_else
macro_line|#endif
id|read_cis_mem
c_func
(paren
id|s
comma
id|attr
comma
id|addr
comma
id|len
comma
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Copy data into the cache, if there is room */
r_if
c_cond
(paren
(paren
id|i
OL
id|MAX_CIS_TABLE
)paren
op_logical_and
(paren
id|caddr
op_plus
id|len
OL
id|s-&gt;cis_cache
op_plus
id|MAX_CIS_DATA
)paren
)paren
(brace
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|addr
op_assign
id|addr
suffix:semicolon
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|attr
op_assign
id|attr
suffix:semicolon
id|s-&gt;cis_used
op_increment
suffix:semicolon
id|memcpy
c_func
(paren
id|caddr
comma
id|ptr
comma
id|len
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*======================================================================&n;&n;    This verifies if the CIS of a card matches what is in the CIS&n;    cache.&n;    &n;======================================================================*/
DECL|function|verify_cis_cache
r_int
id|verify_cis_cache
c_func
(paren
id|socket_info_t
op_star
id|s
)paren
(brace
r_char
id|buf
(braket
l_int|256
)braket
comma
op_star
id|caddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|caddr
op_assign
id|s-&gt;cis_cache
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|s-&gt;cis_used
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifdef CONFIG_CARDBUS
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|SOCKET_CARDBUS
)paren
id|read_cb_mem
c_func
(paren
id|s
comma
l_int|0
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|attr
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|addr
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
comma
id|buf
)paren
suffix:semicolon
r_else
macro_line|#endif
id|read_cis_mem
c_func
(paren
id|s
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|attr
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|addr
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|buf
comma
id|caddr
comma
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|caddr
op_add_assign
id|s-&gt;cis_table
(braket
id|i
)braket
dot
id|len
suffix:semicolon
)brace
r_return
(paren
id|i
OL
id|s-&gt;cis_used
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    For really bad cards, we provide a facility for uploading a&n;    replacement CIS.&n;    &n;======================================================================*/
DECL|function|pcmcia_replace_cis
r_int
id|pcmcia_replace_cis
c_func
(paren
id|client_handle_t
id|handle
comma
id|cisdump_t
op_star
id|cis
)paren
(brace
id|socket_info_t
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_HANDLE
c_func
(paren
id|handle
)paren
)paren
r_return
id|CS_BAD_HANDLE
suffix:semicolon
id|s
op_assign
id|SOCKET
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;fake_cis
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|s-&gt;fake_cis
)paren
suffix:semicolon
id|s-&gt;fake_cis
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cis-&gt;Length
OG
id|CISTPL_MAX_CIS_SIZE
)paren
r_return
id|CS_BAD_SIZE
suffix:semicolon
id|s-&gt;fake_cis
op_assign
id|kmalloc
c_func
(paren
id|cis-&gt;Length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;fake_cis
op_eq
l_int|NULL
)paren
r_return
id|CS_OUT_OF_RESOURCE
suffix:semicolon
id|s-&gt;fake_cis_len
op_assign
id|cis-&gt;Length
suffix:semicolon
id|memcpy
c_func
(paren
id|s-&gt;fake_cis
comma
id|cis-&gt;Data
comma
id|cis-&gt;Length
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    The high-level CIS tuple services&n;    &n;======================================================================*/
DECL|struct|tuple_flags
r_typedef
r_struct
id|tuple_flags
(brace
DECL|member|link_space
id|u_int
id|link_space
suffix:colon
l_int|4
suffix:semicolon
DECL|member|has_link
id|u_int
id|has_link
suffix:colon
l_int|1
suffix:semicolon
DECL|member|mfc_fn
id|u_int
id|mfc_fn
suffix:colon
l_int|3
suffix:semicolon
DECL|member|space
id|u_int
id|space
suffix:colon
l_int|4
suffix:semicolon
DECL|typedef|tuple_flags
)brace
id|tuple_flags
suffix:semicolon
DECL|macro|LINK_SPACE
mdefine_line|#define LINK_SPACE(f)&t;(((tuple_flags *)(&amp;(f)))-&gt;link_space)
DECL|macro|HAS_LINK
mdefine_line|#define HAS_LINK(f)&t;(((tuple_flags *)(&amp;(f)))-&gt;has_link)
DECL|macro|MFC_FN
mdefine_line|#define MFC_FN(f)&t;(((tuple_flags *)(&amp;(f)))-&gt;mfc_fn)
DECL|macro|SPACE
mdefine_line|#define SPACE(f)&t;(((tuple_flags *)(&amp;(f)))-&gt;space)
r_int
id|pcmcia_get_next_tuple
c_func
(paren
id|client_handle_t
id|handle
comma
id|tuple_t
op_star
id|tuple
)paren
suffix:semicolon
DECL|function|pcmcia_get_first_tuple
r_int
id|pcmcia_get_first_tuple
c_func
(paren
id|client_handle_t
id|handle
comma
id|tuple_t
op_star
id|tuple
)paren
(brace
id|socket_info_t
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_HANDLE
c_func
(paren
id|handle
)paren
)paren
r_return
id|CS_BAD_HANDLE
suffix:semicolon
id|s
op_assign
id|SOCKET
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;state
op_amp
id|SOCKET_PRESENT
)paren
)paren
r_return
id|CS_NO_CARD
suffix:semicolon
id|tuple-&gt;TupleLink
op_assign
id|tuple-&gt;Flags
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_CARDBUS
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|SOCKET_CARDBUS
)paren
(brace
id|u_int
id|ptr
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|s-&gt;cap.cb_dev-&gt;subordinate-&gt;number
comma
l_int|0
comma
l_int|0x28
comma
op_amp
id|ptr
)paren
suffix:semicolon
id|tuple-&gt;CISOffset
op_assign
id|ptr
op_amp
op_complement
l_int|7
suffix:semicolon
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
(paren
id|ptr
op_amp
l_int|7
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
multiline_comment|/* Assume presence of a LONGLINK_C to address 0 */
id|tuple-&gt;CISOffset
op_assign
id|tuple-&gt;LinkOffset
op_assign
l_int|0
suffix:semicolon
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;state
op_amp
id|SOCKET_CARDBUS
)paren
op_logical_and
(paren
id|s-&gt;functions
OG
l_int|1
)paren
op_logical_and
op_logical_neg
(paren
id|tuple-&gt;Attributes
op_amp
id|TUPLE_RETURN_COMMON
)paren
)paren
(brace
id|cisdata_t
id|req
op_assign
id|tuple-&gt;DesiredTuple
suffix:semicolon
id|tuple-&gt;DesiredTuple
op_assign
id|CISTPL_LONGLINK_MFC
suffix:semicolon
r_if
c_cond
(paren
id|pcmcia_get_next_tuple
c_func
(paren
id|handle
comma
id|tuple
)paren
op_eq
id|CS_SUCCESS
)paren
(brace
id|tuple-&gt;DesiredTuple
op_assign
id|CISTPL_LINKTARGET
suffix:semicolon
r_if
c_cond
(paren
id|pcmcia_get_next_tuple
c_func
(paren
id|handle
comma
id|tuple
)paren
op_ne
id|CS_SUCCESS
)paren
r_return
id|CS_NO_MORE_ITEMS
suffix:semicolon
)brace
r_else
id|tuple-&gt;CISOffset
op_assign
id|tuple-&gt;TupleLink
op_assign
l_int|0
suffix:semicolon
id|tuple-&gt;DesiredTuple
op_assign
id|req
suffix:semicolon
)brace
r_return
id|pcmcia_get_next_tuple
c_func
(paren
id|handle
comma
id|tuple
)paren
suffix:semicolon
)brace
DECL|function|follow_link
r_static
r_int
id|follow_link
c_func
(paren
id|socket_info_t
op_star
id|s
comma
id|tuple_t
op_star
id|tuple
)paren
(brace
id|u_char
id|link
(braket
l_int|5
)braket
suffix:semicolon
id|u_int
id|ofs
suffix:semicolon
r_if
c_cond
(paren
id|MFC_FN
c_func
(paren
id|tuple-&gt;Flags
)paren
)paren
(brace
multiline_comment|/* Get indirect link from the MFC tuple */
id|read_cis_cache
c_func
(paren
id|s
comma
id|LINK_SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
comma
id|tuple-&gt;LinkOffset
comma
l_int|5
comma
id|link
)paren
suffix:semicolon
id|ofs
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
(paren
id|link
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_MFC_ATTR
)paren
suffix:semicolon
multiline_comment|/* Move to the next indirect link */
id|tuple-&gt;LinkOffset
op_add_assign
l_int|5
suffix:semicolon
id|MFC_FN
c_func
(paren
id|tuple-&gt;Flags
)paren
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
)paren
(brace
id|ofs
op_assign
id|tuple-&gt;LinkOffset
suffix:semicolon
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|LINK_SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
suffix:semicolon
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;state
op_amp
id|SOCKET_CARDBUS
)paren
op_logical_and
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
)paren
(brace
multiline_comment|/* This is ugly, but a common CIS error is to code the long&n;&t;   link offset incorrectly, so we check the right spot... */
id|read_cis_cache
c_func
(paren
id|s
comma
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
comma
id|ofs
comma
l_int|5
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_LINKTARGET
)paren
op_logical_and
(paren
id|link
(braket
l_int|1
)braket
op_ge
l_int|3
)paren
op_logical_and
(paren
id|strncmp
c_func
(paren
id|link
op_plus
l_int|2
comma
l_string|&quot;CIS&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
)paren
r_return
id|ofs
suffix:semicolon
multiline_comment|/* Then, we try the wrong spot... */
id|ofs
op_assign
id|ofs
op_rshift
l_int|1
suffix:semicolon
)brace
id|read_cis_cache
c_func
(paren
id|s
comma
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
comma
id|ofs
comma
l_int|5
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|link
(braket
l_int|0
)braket
op_ne
id|CISTPL_LINKTARGET
)paren
op_logical_or
(paren
id|link
(braket
l_int|1
)braket
OL
l_int|3
)paren
op_logical_or
(paren
id|strncmp
c_func
(paren
id|link
op_plus
l_int|2
comma
l_string|&quot;CIS&quot;
comma
l_int|3
)paren
op_ne
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|ofs
suffix:semicolon
)brace
DECL|function|pcmcia_get_next_tuple
r_int
id|pcmcia_get_next_tuple
c_func
(paren
id|client_handle_t
id|handle
comma
id|tuple_t
op_star
id|tuple
)paren
(brace
id|socket_info_t
op_star
id|s
suffix:semicolon
id|u_char
id|link
(braket
l_int|2
)braket
comma
id|tmp
suffix:semicolon
r_int
id|ofs
comma
id|i
comma
id|attr
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_HANDLE
c_func
(paren
id|handle
)paren
)paren
r_return
id|CS_BAD_HANDLE
suffix:semicolon
id|s
op_assign
id|SOCKET
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;state
op_amp
id|SOCKET_PRESENT
)paren
)paren
r_return
id|CS_NO_CARD
suffix:semicolon
id|link
(braket
l_int|1
)braket
op_assign
id|tuple-&gt;TupleLink
suffix:semicolon
id|ofs
op_assign
id|tuple-&gt;CISOffset
op_plus
id|tuple-&gt;TupleLink
suffix:semicolon
id|attr
op_assign
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TUPLES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|link
(braket
l_int|1
)braket
op_eq
l_int|0xff
)paren
(brace
id|link
(braket
l_int|0
)braket
op_assign
id|CISTPL_END
suffix:semicolon
)brace
r_else
(brace
id|read_cis_cache
c_func
(paren
id|s
comma
id|attr
comma
id|ofs
comma
l_int|2
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_NULL
)paren
(brace
id|ofs
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* End of chain?  Follow long link if possible */
r_if
c_cond
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_END
)paren
(brace
r_if
c_cond
(paren
(paren
id|ofs
op_assign
id|follow_link
c_func
(paren
id|s
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|CS_NO_MORE_ITEMS
suffix:semicolon
id|attr
op_assign
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
suffix:semicolon
id|read_cis_cache
c_func
(paren
id|s
comma
id|attr
comma
id|ofs
comma
l_int|2
comma
id|link
)paren
suffix:semicolon
)brace
multiline_comment|/* Is this a link tuple?  Make a note of it */
r_if
c_cond
(paren
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_LONGLINK_A
)paren
op_logical_or
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_LONGLINK_C
)paren
op_logical_or
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_LONGLINK_MFC
)paren
op_logical_or
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_LINKTARGET
)paren
op_logical_or
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_INDIRECT
)paren
op_logical_or
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|CISTPL_NO_LINK
)paren
)paren
(brace
r_switch
c_cond
(paren
id|link
(braket
l_int|0
)braket
)paren
(brace
r_case
id|CISTPL_LONGLINK_A
suffix:colon
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|1
suffix:semicolon
id|LINK_SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|attr
op_or
id|IS_ATTR
suffix:semicolon
id|read_cis_cache
c_func
(paren
id|s
comma
id|attr
comma
id|ofs
op_plus
l_int|2
comma
l_int|4
comma
op_amp
id|tuple-&gt;LinkOffset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_LONGLINK_C
suffix:colon
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|1
suffix:semicolon
id|LINK_SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|attr
op_amp
op_complement
id|IS_ATTR
suffix:semicolon
id|read_cis_cache
c_func
(paren
id|s
comma
id|attr
comma
id|ofs
op_plus
l_int|2
comma
l_int|4
comma
op_amp
id|tuple-&gt;LinkOffset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_INDIRECT
suffix:colon
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|1
suffix:semicolon
id|LINK_SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|IS_ATTR
op_or
id|IS_INDIRECT
suffix:semicolon
id|tuple-&gt;LinkOffset
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_LONGLINK_MFC
suffix:colon
id|tuple-&gt;LinkOffset
op_assign
id|ofs
op_plus
l_int|3
suffix:semicolon
id|LINK_SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|attr
suffix:semicolon
r_if
c_cond
(paren
id|handle-&gt;Function
op_eq
id|BIND_FN_ALL
)paren
(brace
multiline_comment|/* Follow all the MFC links */
id|read_cis_cache
c_func
(paren
id|s
comma
id|attr
comma
id|ofs
op_plus
l_int|2
comma
l_int|1
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|MFC_FN
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
id|tmp
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Follow exactly one of the links */
id|MFC_FN
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|1
suffix:semicolon
id|tuple-&gt;LinkOffset
op_add_assign
id|handle-&gt;Function
op_star
l_int|5
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CISTPL_NO_LINK
suffix:colon
id|HAS_LINK
c_func
(paren
id|tuple-&gt;Flags
)paren
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tuple-&gt;Attributes
op_amp
id|TUPLE_RETURN_LINK
)paren
op_logical_and
(paren
id|tuple-&gt;DesiredTuple
op_eq
id|RETURN_FIRST_TUPLE
)paren
)paren
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuple-&gt;DesiredTuple
op_eq
id|RETURN_FIRST_TUPLE
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|link
(braket
l_int|0
)braket
op_eq
id|tuple-&gt;DesiredTuple
)paren
r_break
suffix:semicolon
id|ofs
op_add_assign
id|link
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|MAX_TUPLES
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;cs: overrun in pcmcia_get_next_tuple for socket %d&bslash;n&quot;
comma
id|handle-&gt;Socket
)paren
suffix:semicolon
r_return
id|CS_NO_MORE_ITEMS
suffix:semicolon
)brace
id|tuple-&gt;TupleCode
op_assign
id|link
(braket
l_int|0
)braket
suffix:semicolon
id|tuple-&gt;TupleLink
op_assign
id|link
(braket
l_int|1
)braket
suffix:semicolon
id|tuple-&gt;CISOffset
op_assign
id|ofs
op_plus
l_int|2
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|macro|_MIN
mdefine_line|#define _MIN(a, b)&t;&t;(((a) &lt; (b)) ? (a) : (b))
DECL|function|pcmcia_get_tuple_data
r_int
id|pcmcia_get_tuple_data
c_func
(paren
id|client_handle_t
id|handle
comma
id|tuple_t
op_star
id|tuple
)paren
(brace
id|socket_info_t
op_star
id|s
suffix:semicolon
id|u_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_HANDLE
c_func
(paren
id|handle
)paren
)paren
r_return
id|CS_BAD_HANDLE
suffix:semicolon
id|s
op_assign
id|SOCKET
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleLink
OL
id|tuple-&gt;TupleOffset
)paren
r_return
id|CS_NO_MORE_ITEMS
suffix:semicolon
id|len
op_assign
id|tuple-&gt;TupleLink
op_minus
id|tuple-&gt;TupleOffset
suffix:semicolon
id|tuple-&gt;TupleDataLen
op_assign
id|tuple-&gt;TupleLink
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
id|CS_SUCCESS
suffix:semicolon
id|read_cis_cache
c_func
(paren
id|s
comma
id|SPACE
c_func
(paren
id|tuple-&gt;Flags
)paren
comma
id|tuple-&gt;CISOffset
op_plus
id|tuple-&gt;TupleOffset
comma
id|_MIN
c_func
(paren
id|len
comma
id|tuple-&gt;TupleDataMax
)paren
comma
id|tuple-&gt;TupleData
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    Parsing routines for individual tuples&n;    &n;======================================================================*/
DECL|function|parse_device
r_static
r_int
id|parse_device
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_device_t
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_char
id|scale
suffix:semicolon
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
id|device-&gt;ndev
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CISTPL_MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0xff
)paren
r_break
suffix:semicolon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|type
op_assign
(paren
op_star
id|p
op_rshift
l_int|4
)paren
suffix:semicolon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|wp
op_assign
(paren
op_star
id|p
op_amp
l_int|0x08
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
op_amp
l_int|0x07
)paren
(brace
r_case
l_int|0
suffix:colon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|speed
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|speed
op_assign
l_int|250
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|speed
op_assign
l_int|200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|speed
op_assign
l_int|150
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|speed
op_assign
l_int|100
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|speed
op_assign
id|SPEED_CVT
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0xff
)paren
r_break
suffix:semicolon
id|scale
op_assign
op_star
id|p
op_amp
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|scale
op_eq
l_int|7
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|device-&gt;dev
(braket
id|i
)braket
dot
id|size
op_assign
(paren
(paren
op_star
id|p
op_rshift
l_int|3
)paren
op_plus
l_int|1
)paren
op_star
(paren
l_int|512
op_lshift
(paren
id|scale
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|device-&gt;ndev
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_break
suffix:semicolon
)brace
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_checksum
r_static
r_int
id|parse_checksum
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_checksum_t
op_star
id|csum
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|5
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|csum-&gt;addr
op_assign
id|tuple-&gt;CISOffset
op_plus
(paren
r_int
)paren
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u_short
op_star
)paren
id|p
)paren
op_minus
l_int|2
suffix:semicolon
id|csum-&gt;len
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u_short
op_star
)paren
(paren
id|p
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|csum-&gt;sum
op_assign
op_star
(paren
id|p
op_plus
l_int|4
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_longlink
r_static
r_int
id|parse_longlink
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_longlink_t
op_star
id|link
)paren
(brace
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|4
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|link-&gt;addr
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
id|tuple-&gt;TupleData
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_longlink_mfc
r_static
r_int
id|parse_longlink_mfc
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_longlink_mfc_t
op_star
id|link
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|link-&gt;nfn
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
op_le
id|link-&gt;nfn
op_star
l_int|5
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|link-&gt;nfn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|link-&gt;fn
(braket
id|i
)braket
dot
id|space
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|link-&gt;fn
(braket
id|i
)braket
dot
id|addr
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_strings
r_static
r_int
id|parse_strings
c_func
(paren
id|u_char
op_star
id|p
comma
id|u_char
op_star
id|q
comma
r_int
id|max
comma
r_char
op_star
id|s
comma
id|u_char
op_star
id|ofs
comma
id|u_char
op_star
id|found
)paren
(brace
r_int
id|i
comma
id|j
comma
id|ns
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|ns
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0xff
)paren
r_break
suffix:semicolon
id|ofs
(braket
id|i
)braket
op_assign
id|j
suffix:semicolon
id|ns
op_increment
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|s
(braket
id|j
op_increment
)braket
op_assign
(paren
op_star
id|p
op_eq
l_int|0xff
)paren
ques
c_cond
l_char|&squot;&bslash;0&squot;
suffix:colon
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
op_star
id|p
op_eq
l_int|0xff
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|p
op_eq
l_int|0xff
)paren
op_logical_or
(paren
op_increment
id|p
op_eq
id|q
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
(brace
op_star
id|found
op_assign
id|ns
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
id|ns
op_eq
id|max
)paren
ques
c_cond
id|CS_SUCCESS
suffix:colon
id|CS_BAD_TUPLE
suffix:semicolon
)brace
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_vers_1
r_static
r_int
id|parse_vers_1
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_vers_1_t
op_star
id|vers_1
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
id|vers_1-&gt;major
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|vers_1-&gt;minor
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ge
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_return
id|parse_strings
c_func
(paren
id|p
comma
id|q
comma
id|CISTPL_VERS_1_MAX_PROD_STRINGS
comma
id|vers_1-&gt;str
comma
id|vers_1-&gt;ofs
comma
op_amp
id|vers_1-&gt;ns
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_altstr
r_static
r_int
id|parse_altstr
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_altstr_t
op_star
id|altstr
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
r_return
id|parse_strings
c_func
(paren
id|p
comma
id|q
comma
id|CISTPL_MAX_ALTSTR_STRINGS
comma
id|altstr-&gt;str
comma
id|altstr-&gt;ofs
comma
op_amp
id|altstr-&gt;ns
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_jedec
r_static
r_int
id|parse_jedec
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_jedec_t
op_star
id|jedec
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
r_int
id|nid
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
r_for
c_loop
(paren
id|nid
op_assign
l_int|0
suffix:semicolon
id|nid
OL
id|CISTPL_MAX_DEVICES
suffix:semicolon
id|nid
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
OG
id|q
op_minus
l_int|2
)paren
r_break
suffix:semicolon
id|jedec-&gt;id
(braket
id|nid
)braket
dot
id|mfr
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|jedec-&gt;id
(braket
id|nid
)braket
dot
id|info
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
)brace
id|jedec-&gt;nid
op_assign
id|nid
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_manfid
r_static
r_int
id|parse_manfid
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_manfid_t
op_star
id|m
)paren
(brace
id|u_short
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|4
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
(paren
id|u_short
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|m-&gt;manf
op_assign
id|le16_to_cpu
c_func
(paren
id|p
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|m-&gt;card
op_assign
id|le16_to_cpu
c_func
(paren
id|p
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_funcid
r_static
r_int
id|parse_funcid
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_funcid_t
op_star
id|f
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|2
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|f-&gt;func
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|f-&gt;sysinit
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_funce
r_static
r_int
id|parse_funce
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_funce_t
op_star
id|f
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|1
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|f-&gt;type
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|tuple-&gt;TupleDataLen
suffix:semicolon
id|i
op_increment
)paren
id|f-&gt;data
(braket
id|i
op_minus
l_int|1
)braket
op_assign
id|p
(braket
id|i
)braket
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_config
r_static
r_int
id|parse_config
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_config_t
op_star
id|config
)paren
(brace
r_int
id|rasz
comma
id|rmsz
comma
id|i
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|rasz
op_assign
op_star
id|p
op_amp
l_int|0x03
suffix:semicolon
id|rmsz
op_assign
(paren
op_star
id|p
op_amp
l_int|0x3c
)paren
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
id|rasz
op_plus
id|rmsz
op_plus
l_int|4
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|config-&gt;last_idx
op_assign
op_star
(paren
op_increment
id|p
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|config-&gt;base
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|rasz
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;base
op_add_assign
id|p
(braket
id|i
)braket
op_lshift
(paren
l_int|8
op_star
id|i
)paren
suffix:semicolon
id|p
op_add_assign
id|rasz
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;rmask
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|rmsz
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;rmask
(braket
id|i
op_rshift
l_int|2
)braket
op_add_assign
id|p
(braket
id|i
)braket
op_lshift
(paren
l_int|8
op_star
(paren
id|i
op_mod
l_int|4
)paren
)paren
suffix:semicolon
id|config-&gt;subtuples
op_assign
id|tuple-&gt;TupleDataLen
op_minus
(paren
id|rasz
op_plus
id|rmsz
op_plus
l_int|4
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    The following routines are all used to parse the nightmarish&n;    config table entries.&n;    &n;======================================================================*/
DECL|function|parse_power
r_static
id|u_char
op_star
id|parse_power
c_func
(paren
id|u_char
op_star
id|p
comma
id|u_char
op_star
id|q
comma
id|cistpl_power_t
op_star
id|pwr
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_int
id|scale
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|pwr-&gt;present
op_assign
op_star
id|p
suffix:semicolon
id|pwr-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pwr-&gt;present
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|pwr-&gt;param
(braket
id|i
)braket
op_assign
id|POWER_CVT
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
id|scale
op_assign
id|POWER_SCALE
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
op_amp
l_int|0x7f
)paren
OL
l_int|100
)paren
id|pwr-&gt;param
(braket
id|i
)braket
op_add_assign
(paren
op_star
id|p
op_amp
l_int|0x7f
)paren
op_star
id|scale
op_div
l_int|100
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0x7d
)paren
id|pwr-&gt;flags
op_or_assign
id|CISTPL_POWER_HIGHZ_OK
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0x7e
)paren
id|pwr-&gt;param
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0x7f
)paren
id|pwr-&gt;flags
op_or_assign
id|CISTPL_POWER_HIGHZ_REQ
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_timing
r_static
id|u_char
op_star
id|parse_timing
c_func
(paren
id|u_char
op_star
id|p
comma
id|u_char
op_star
id|q
comma
id|cistpl_timing_t
op_star
id|timing
)paren
(brace
id|u_char
id|scale
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|scale
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scale
op_amp
l_int|3
)paren
op_ne
l_int|3
)paren
(brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|timing-&gt;wait
op_assign
id|SPEED_CVT
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
id|timing-&gt;waitscale
op_assign
id|exponent
(braket
id|scale
op_amp
l_int|3
)braket
suffix:semicolon
)brace
r_else
id|timing-&gt;wait
op_assign
l_int|0
suffix:semicolon
id|scale
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scale
op_amp
l_int|7
)paren
op_ne
l_int|7
)paren
(brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|timing-&gt;ready
op_assign
id|SPEED_CVT
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
id|timing-&gt;rdyscale
op_assign
id|exponent
(braket
id|scale
op_amp
l_int|7
)braket
suffix:semicolon
)brace
r_else
id|timing-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|scale
op_rshift_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|scale
op_ne
l_int|7
)paren
(brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|timing-&gt;reserved
op_assign
id|SPEED_CVT
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
id|timing-&gt;rsvscale
op_assign
id|exponent
(braket
id|scale
)braket
suffix:semicolon
)brace
r_else
id|timing-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_io
r_static
id|u_char
op_star
id|parse_io
c_func
(paren
id|u_char
op_star
id|p
comma
id|u_char
op_star
id|q
comma
id|cistpl_io_t
op_star
id|io
)paren
(brace
r_int
id|i
comma
id|j
comma
id|bsz
comma
id|lsz
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|io-&gt;flags
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
)paren
(brace
id|io-&gt;nwin
op_assign
l_int|1
suffix:semicolon
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|base
op_assign
l_int|0
suffix:semicolon
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|len
op_assign
(paren
l_int|1
op_lshift
(paren
id|io-&gt;flags
op_amp
id|CISTPL_IO_LINES_MASK
)paren
)paren
suffix:semicolon
r_return
id|p
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|io-&gt;nwin
op_assign
(paren
op_star
id|p
op_amp
l_int|0x0f
)paren
op_plus
l_int|1
suffix:semicolon
id|bsz
op_assign
(paren
op_star
id|p
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|bsz
op_eq
l_int|3
)paren
id|bsz
op_increment
suffix:semicolon
id|lsz
op_assign
(paren
op_star
id|p
op_amp
l_int|0xc0
)paren
op_rshift
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|lsz
op_eq
l_int|3
)paren
id|lsz
op_increment
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|io-&gt;nwin
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io-&gt;win
(braket
id|i
)braket
dot
id|base
op_assign
l_int|0
suffix:semicolon
id|io-&gt;win
(braket
id|i
)braket
dot
id|len
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|bsz
suffix:semicolon
id|j
op_increment
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|io-&gt;win
(braket
id|i
)braket
dot
id|base
op_add_assign
op_star
id|p
op_lshift
(paren
id|j
op_star
l_int|8
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|lsz
suffix:semicolon
id|j
op_increment
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|io-&gt;win
(braket
id|i
)braket
dot
id|len
op_add_assign
op_star
id|p
op_lshift
(paren
id|j
op_star
l_int|8
)paren
suffix:semicolon
)brace
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_mem
r_static
id|u_char
op_star
id|parse_mem
c_func
(paren
id|u_char
op_star
id|p
comma
id|u_char
op_star
id|q
comma
id|cistpl_mem_t
op_star
id|mem
)paren
(brace
r_int
id|i
comma
id|j
comma
id|asz
comma
id|lsz
comma
id|has_ha
suffix:semicolon
id|u_int
id|len
comma
id|ca
comma
id|ha
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|mem-&gt;nwin
op_assign
(paren
op_star
id|p
op_amp
l_int|0x07
)paren
op_plus
l_int|1
suffix:semicolon
id|lsz
op_assign
(paren
op_star
id|p
op_amp
l_int|0x18
)paren
op_rshift
l_int|3
suffix:semicolon
id|asz
op_assign
(paren
op_star
id|p
op_amp
l_int|0x60
)paren
op_rshift
l_int|5
suffix:semicolon
id|has_ha
op_assign
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mem-&gt;nwin
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_assign
id|ca
op_assign
id|ha
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|lsz
suffix:semicolon
id|j
op_increment
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|len
op_add_assign
op_star
id|p
op_lshift
(paren
id|j
op_star
l_int|8
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|asz
suffix:semicolon
id|j
op_increment
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|ca
op_add_assign
op_star
id|p
op_lshift
(paren
id|j
op_star
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|has_ha
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|asz
suffix:semicolon
id|j
op_increment
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|ha
op_add_assign
op_star
id|p
op_lshift
(paren
id|j
op_star
l_int|8
)paren
suffix:semicolon
)brace
id|mem-&gt;win
(braket
id|i
)braket
dot
id|len
op_assign
id|len
op_lshift
l_int|8
suffix:semicolon
id|mem-&gt;win
(braket
id|i
)braket
dot
id|card_addr
op_assign
id|ca
op_lshift
l_int|8
suffix:semicolon
id|mem-&gt;win
(braket
id|i
)braket
dot
id|host_addr
op_assign
id|ha
op_lshift
l_int|8
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_irq
r_static
id|u_char
op_star
id|parse_irq
c_func
(paren
id|u_char
op_star
id|p
comma
id|u_char
op_star
id|q
comma
id|cistpl_irq_t
op_star
id|irq
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|irq-&gt;IRQInfo1
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|irq-&gt;IRQInfo1
op_amp
id|IRQ_INFO2_VALID
)paren
(brace
r_if
c_cond
(paren
id|p
op_plus
l_int|2
OG
id|q
)paren
r_return
l_int|NULL
suffix:semicolon
id|irq-&gt;IRQInfo2
op_assign
(paren
id|p
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_cftable_entry
r_static
r_int
id|parse_cftable_entry
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_cftable_entry_t
op_star
id|entry
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
comma
id|features
suffix:semicolon
id|p
op_assign
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
id|entry-&gt;index
op_assign
op_star
id|p
op_amp
l_int|0x3f
suffix:semicolon
id|entry-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x40
)paren
id|entry-&gt;flags
op_or_assign
id|CISTPL_CFTABLE_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x10
)paren
id|entry-&gt;flags
op_or_assign
id|CISTPL_CFTABLE_BVDS
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x20
)paren
id|entry-&gt;flags
op_or_assign
id|CISTPL_CFTABLE_WP
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x40
)paren
id|entry-&gt;flags
op_or_assign
id|CISTPL_CFTABLE_RDYBSY
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
id|entry-&gt;flags
op_or_assign
id|CISTPL_CFTABLE_MWAIT
suffix:semicolon
id|entry-&gt;interface
op_assign
op_star
id|p
op_amp
l_int|0x0f
suffix:semicolon
)brace
r_else
id|entry-&gt;interface
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Process optional features */
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|features
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
multiline_comment|/* Power options */
r_if
c_cond
(paren
(paren
id|features
op_amp
l_int|3
)paren
OG
l_int|0
)paren
(brace
id|p
op_assign
id|parse_power
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;vcc.present
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|features
op_amp
l_int|3
)paren
OG
l_int|1
)paren
(brace
id|p
op_assign
id|parse_power
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;vpp1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;vpp1.present
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|features
op_amp
l_int|3
)paren
OG
l_int|2
)paren
(brace
id|p
op_assign
id|parse_power
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;vpp2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;vpp2.present
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Timing options */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x04
)paren
(brace
id|p
op_assign
id|parse_timing
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;timing
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
(brace
id|entry-&gt;timing.wait
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;timing.ready
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;timing.reserved
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* I/O window options */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x08
)paren
(brace
id|p
op_assign
id|parse_io
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;io.nwin
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Interrupt options */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x10
)paren
(brace
id|p
op_assign
id|parse_irq
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;irq.IRQInfo1
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|features
op_amp
l_int|0x60
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|entry-&gt;mem.nwin
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
id|entry-&gt;mem.nwin
op_assign
l_int|1
suffix:semicolon
id|entry-&gt;mem.win
(braket
l_int|0
)braket
dot
id|len
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u_short
op_star
)paren
id|p
)paren
op_lshift
l_int|8
suffix:semicolon
id|entry-&gt;mem.win
(braket
l_int|0
)braket
dot
id|card_addr
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;mem.win
(braket
l_int|0
)braket
dot
id|host_addr
op_assign
l_int|0
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|p
OG
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
id|entry-&gt;mem.nwin
op_assign
l_int|1
suffix:semicolon
id|entry-&gt;mem.win
(braket
l_int|0
)braket
dot
id|len
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u_short
op_star
)paren
id|p
)paren
op_lshift
l_int|8
suffix:semicolon
id|entry-&gt;mem.win
(braket
l_int|0
)braket
dot
id|card_addr
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u_short
op_star
)paren
(paren
id|p
op_plus
l_int|2
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|entry-&gt;mem.win
(braket
l_int|0
)braket
dot
id|host_addr
op_assign
l_int|0
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|p
OG
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x60
suffix:colon
id|p
op_assign
id|parse_mem
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Misc features */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|entry-&gt;flags
op_or_assign
(paren
op_star
id|p
op_lshift
l_int|8
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
id|entry-&gt;subtuples
op_assign
id|q
op_minus
id|p
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
macro_line|#ifdef CONFIG_CARDBUS
DECL|function|parse_bar
r_static
r_int
id|parse_bar
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_bar_t
op_star
id|bar
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|6
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|bar-&gt;attr
op_assign
op_star
id|p
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
id|bar-&gt;size
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
id|p
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
DECL|function|parse_config_cb
r_static
r_int
id|parse_config_cb
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_config_t
op_star
id|config
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
op_ne
l_int|3
)paren
op_logical_or
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|6
)paren
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|config-&gt;last_idx
op_assign
op_star
(paren
op_increment
id|p
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|config-&gt;base
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
id|p
)paren
suffix:semicolon
id|config-&gt;subtuples
op_assign
id|tuple-&gt;TupleDataLen
op_minus
l_int|6
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
DECL|function|parse_cftable_entry_cb
r_static
r_int
id|parse_cftable_entry_cb
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_cftable_entry_cb_t
op_star
id|entry
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
comma
id|features
suffix:semicolon
id|p
op_assign
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
id|entry-&gt;index
op_assign
op_star
id|p
op_amp
l_int|0x3f
suffix:semicolon
id|entry-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x40
)paren
id|entry-&gt;flags
op_or_assign
id|CISTPL_CFTABLE_DEFAULT
suffix:semicolon
multiline_comment|/* Process optional features */
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|features
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
multiline_comment|/* Power options */
r_if
c_cond
(paren
(paren
id|features
op_amp
l_int|3
)paren
OG
l_int|0
)paren
(brace
id|p
op_assign
id|parse_power
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;vcc.present
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|features
op_amp
l_int|3
)paren
OG
l_int|1
)paren
(brace
id|p
op_assign
id|parse_power
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;vpp1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;vpp1.present
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|features
op_amp
l_int|3
)paren
OG
l_int|2
)paren
(brace
id|p
op_assign
id|parse_power
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;vpp2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;vpp2.present
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* I/O window options */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x08
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|entry-&gt;io
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_else
id|entry-&gt;io
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Interrupt options */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x10
)paren
(brace
id|p
op_assign
id|parse_irq
c_func
(paren
id|p
comma
id|q
comma
op_amp
id|entry-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_else
id|entry-&gt;irq.IRQInfo1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|features
op_amp
l_int|0x20
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|entry-&gt;mem
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_else
id|entry-&gt;mem
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Misc features */
r_if
c_cond
(paren
id|features
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|entry-&gt;flags
op_or_assign
(paren
op_star
id|p
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|entry-&gt;flags
op_or_assign
(paren
op_star
id|p
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
id|entry-&gt;subtuples
op_assign
id|q
op_minus
id|p
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*====================================================================*/
DECL|function|parse_device_geo
r_static
r_int
id|parse_device_geo
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_device_geo_t
op_star
id|geo
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
r_int
id|n
suffix:semicolon
id|p
op_assign
(paren
id|u_char
op_star
)paren
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|CISTPL_MAX_DEVICES
suffix:semicolon
id|n
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
OG
id|q
op_minus
l_int|6
)paren
r_break
suffix:semicolon
id|geo-&gt;geo
(braket
id|n
)braket
dot
id|buswidth
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|geo-&gt;geo
(braket
id|n
)braket
dot
id|erase_block
op_assign
l_int|1
op_lshift
(paren
id|p
(braket
l_int|1
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|geo-&gt;geo
(braket
id|n
)braket
dot
id|read_block
op_assign
l_int|1
op_lshift
(paren
id|p
(braket
l_int|2
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|geo-&gt;geo
(braket
id|n
)braket
dot
id|write_block
op_assign
l_int|1
op_lshift
(paren
id|p
(braket
l_int|3
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|geo-&gt;geo
(braket
id|n
)braket
dot
id|partition
op_assign
l_int|1
op_lshift
(paren
id|p
(braket
l_int|4
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|geo-&gt;geo
(braket
id|n
)braket
dot
id|interleave
op_assign
l_int|1
op_lshift
(paren
id|p
(braket
l_int|5
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|p
op_add_assign
l_int|6
suffix:semicolon
)brace
id|geo-&gt;ngeo
op_assign
id|n
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_vers_2
r_static
r_int
id|parse_vers_2
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_vers_2_t
op_star
id|v2
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|10
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
id|v2-&gt;vers
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|v2-&gt;comply
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|v2-&gt;dindex
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u_short
op_star
)paren
(paren
id|p
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|v2-&gt;vspec8
op_assign
id|p
(braket
l_int|6
)braket
suffix:semicolon
id|v2-&gt;vspec9
op_assign
id|p
(braket
l_int|7
)braket
suffix:semicolon
id|v2-&gt;nhdr
op_assign
id|p
(braket
l_int|8
)braket
suffix:semicolon
id|p
op_add_assign
l_int|9
suffix:semicolon
r_return
id|parse_strings
c_func
(paren
id|p
comma
id|q
comma
l_int|2
comma
id|v2-&gt;str
comma
op_amp
id|v2-&gt;vendor
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_org
r_static
r_int
id|parse_org
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_org_t
op_star
id|org
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
r_int
id|i
suffix:semicolon
id|p
op_assign
id|tuple-&gt;TupleData
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|tuple-&gt;TupleDataLen
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|org-&gt;data_org
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|30
suffix:semicolon
id|i
op_increment
)paren
(brace
id|org-&gt;desc
(braket
id|i
)braket
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|p
op_eq
id|q
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
)brace
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|parse_format
r_static
r_int
id|parse_format
c_func
(paren
id|tuple_t
op_star
id|tuple
comma
id|cistpl_format_t
op_star
id|fmt
)paren
(brace
id|u_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OL
l_int|10
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
id|p
op_assign
id|tuple-&gt;TupleData
suffix:semicolon
id|fmt-&gt;type
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|fmt-&gt;edc
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|fmt-&gt;offset
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
(paren
id|p
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|fmt-&gt;length
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u_int
op_star
)paren
(paren
id|p
op_plus
l_int|6
)paren
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|pcmcia_parse_tuple
r_int
id|pcmcia_parse_tuple
c_func
(paren
id|client_handle_t
id|handle
comma
id|tuple_t
op_star
id|tuple
comma
id|cisparse_t
op_star
id|parse
)paren
(brace
r_int
id|ret
op_assign
id|CS_SUCCESS
suffix:semicolon
r_if
c_cond
(paren
id|tuple-&gt;TupleDataLen
OG
id|tuple-&gt;TupleDataMax
)paren
r_return
id|CS_BAD_TUPLE
suffix:semicolon
r_switch
c_cond
(paren
id|tuple-&gt;TupleCode
)paren
(brace
r_case
id|CISTPL_DEVICE
suffix:colon
r_case
id|CISTPL_DEVICE_A
suffix:colon
id|ret
op_assign
id|parse_device
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;device
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_CARDBUS
r_case
id|CISTPL_BAR
suffix:colon
id|ret
op_assign
id|parse_bar
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;bar
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_CONFIG_CB
suffix:colon
id|ret
op_assign
id|parse_config_cb
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;config
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_CFTABLE_ENTRY_CB
suffix:colon
id|ret
op_assign
id|parse_cftable_entry_cb
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;cftable_entry_cb
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|CISTPL_CHECKSUM
suffix:colon
id|ret
op_assign
id|parse_checksum
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;checksum
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_LONGLINK_A
suffix:colon
r_case
id|CISTPL_LONGLINK_C
suffix:colon
id|ret
op_assign
id|parse_longlink
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;longlink
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_LONGLINK_MFC
suffix:colon
id|ret
op_assign
id|parse_longlink_mfc
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;longlink_mfc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_VERS_1
suffix:colon
id|ret
op_assign
id|parse_vers_1
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;version_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_ALTSTR
suffix:colon
id|ret
op_assign
id|parse_altstr
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;altstr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_JEDEC_A
suffix:colon
r_case
id|CISTPL_JEDEC_C
suffix:colon
id|ret
op_assign
id|parse_jedec
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;jedec
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_MANFID
suffix:colon
id|ret
op_assign
id|parse_manfid
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;manfid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID
suffix:colon
id|ret
op_assign
id|parse_funcid
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;funcid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCE
suffix:colon
id|ret
op_assign
id|parse_funce
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;funce
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_CONFIG
suffix:colon
id|ret
op_assign
id|parse_config
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;config
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_CFTABLE_ENTRY
suffix:colon
id|ret
op_assign
id|parse_cftable_entry
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;cftable_entry
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_DEVICE_GEO
suffix:colon
r_case
id|CISTPL_DEVICE_GEO_A
suffix:colon
id|ret
op_assign
id|parse_device_geo
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;device_geo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_VERS_2
suffix:colon
id|ret
op_assign
id|parse_vers_2
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;vers_2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_ORG
suffix:colon
id|ret
op_assign
id|parse_org
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;org
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FORMAT
suffix:colon
r_case
id|CISTPL_FORMAT_A
suffix:colon
id|ret
op_assign
id|parse_format
c_func
(paren
id|tuple
comma
op_amp
id|parse-&gt;format
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_NO_LINK
suffix:colon
r_case
id|CISTPL_LINKTARGET
suffix:colon
id|ret
op_assign
id|CS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
id|CS_UNSUPPORTED_FUNCTION
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    This is used internally by Card Services to look up CIS stuff.&n;    &n;======================================================================*/
DECL|function|read_tuple
r_int
id|read_tuple
c_func
(paren
id|client_handle_t
id|handle
comma
id|cisdata_t
id|code
comma
r_void
op_star
id|parse
)paren
(brace
id|tuple_t
id|tuple
suffix:semicolon
id|cisdata_t
id|buf
(braket
l_int|255
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|code
suffix:semicolon
id|tuple.Attributes
op_assign
id|TUPLE_RETURN_COMMON
suffix:semicolon
id|ret
op_assign
id|pcmcia_get_first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
r_return
id|ret
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_get_tuple_data
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|pcmcia_parse_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
id|parse
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    This tries to determine if a card has a sensible CIS.  It returns&n;    the number of tuples in the CIS, or 0 if the CIS looks bad.  The&n;    checks include making sure several critical tuples are present and&n;    valid; seeing if the total number of tuples is reasonable; and&n;    looking for tuples that use reserved codes.&n;    &n;======================================================================*/
DECL|function|pcmcia_validate_cis
r_int
id|pcmcia_validate_cis
c_func
(paren
id|client_handle_t
id|handle
comma
id|cisinfo_t
op_star
id|info
)paren
(brace
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|p
suffix:semicolon
r_int
id|ret
comma
id|reserved
comma
id|dev_ok
op_assign
l_int|0
comma
id|ident_ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_HANDLE
c_func
(paren
id|handle
)paren
)paren
r_return
id|CS_BAD_HANDLE
suffix:semicolon
id|info-&gt;Chains
op_assign
id|reserved
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|RETURN_FIRST_TUPLE
suffix:semicolon
id|tuple.Attributes
op_assign
id|TUPLE_RETURN_COMMON
suffix:semicolon
id|ret
op_assign
id|pcmcia_get_first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
r_return
id|CS_SUCCESS
suffix:semicolon
multiline_comment|/* First tuple should be DEVICE; we should really have either that&n;       or a CFTABLE_ENTRY of some sort */
r_if
c_cond
(paren
(paren
id|tuple.TupleCode
op_eq
id|CISTPL_DEVICE
)paren
op_logical_or
(paren
id|read_tuple
c_func
(paren
id|handle
comma
id|CISTPL_CFTABLE_ENTRY
comma
op_amp
id|p
)paren
op_eq
id|CS_SUCCESS
)paren
op_logical_or
(paren
id|read_tuple
c_func
(paren
id|handle
comma
id|CISTPL_CFTABLE_ENTRY_CB
comma
op_amp
id|p
)paren
op_eq
id|CS_SUCCESS
)paren
)paren
id|dev_ok
op_increment
suffix:semicolon
multiline_comment|/* All cards should have a MANFID tuple, and/or a VERS_1 or VERS_2&n;       tuple, for card identification.  Certain old D-Link and Linksys&n;       cards have only a broken VERS_2 tuple; hence the bogus test. */
r_if
c_cond
(paren
(paren
id|read_tuple
c_func
(paren
id|handle
comma
id|CISTPL_MANFID
comma
op_amp
id|p
)paren
op_eq
id|CS_SUCCESS
)paren
op_logical_or
(paren
id|read_tuple
c_func
(paren
id|handle
comma
id|CISTPL_VERS_1
comma
op_amp
id|p
)paren
op_eq
id|CS_SUCCESS
)paren
op_logical_or
(paren
id|read_tuple
c_func
(paren
id|handle
comma
id|CISTPL_VERS_2
comma
op_amp
id|p
)paren
op_ne
id|CS_NO_MORE_ITEMS
)paren
)paren
id|ident_ok
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_ok
op_logical_and
op_logical_neg
id|ident_ok
)paren
r_return
id|CS_SUCCESS
suffix:semicolon
r_for
c_loop
(paren
id|info-&gt;Chains
op_assign
l_int|1
suffix:semicolon
id|info-&gt;Chains
OL
id|MAX_TUPLES
suffix:semicolon
id|info-&gt;Chains
op_increment
)paren
(brace
id|ret
op_assign
id|pcmcia_get_next_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tuple.TupleCode
OG
l_int|0x23
)paren
op_logical_and
(paren
id|tuple.TupleCode
OL
l_int|0x40
)paren
)paren
op_logical_or
(paren
(paren
id|tuple.TupleCode
OG
l_int|0x47
)paren
op_logical_and
(paren
id|tuple.TupleCode
OL
l_int|0x80
)paren
)paren
op_logical_or
(paren
(paren
id|tuple.TupleCode
OG
l_int|0x90
)paren
op_logical_and
(paren
id|tuple.TupleCode
OL
l_int|0xff
)paren
)paren
)paren
id|reserved
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;Chains
op_eq
id|MAX_TUPLES
)paren
op_logical_or
(paren
id|reserved
OG
l_int|5
)paren
op_logical_or
(paren
(paren
op_logical_neg
id|dev_ok
op_logical_or
op_logical_neg
id|ident_ok
)paren
op_logical_and
(paren
id|info-&gt;Chains
OG
l_int|10
)paren
)paren
)paren
id|info-&gt;Chains
op_assign
l_int|0
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
eof
