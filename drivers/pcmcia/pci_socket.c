multiline_comment|/*&n; * Generic PCI pccard driver interface.&n; *&n; * (C) Copyright 1999 Linus Torvalds&n; *&n; * This implements the common parts of PCI pccard drivers,&n; * notably detection and infrastructure conversion (ie change&n; * from socket index to &quot;struct pci_dev&quot; etc)&n; *&n; * This does NOT implement the actual low-level driver details,&n; * and this has on purpose been left generic enough that it can&n; * be used to set up a PCI PCMCIA controller (ie non-cardbus),&n; * or to set up a controller.&n; *&n; * See for example the &quot;yenta&quot; driver for PCI cardbus controllers&n; * conforming to the yenta cardbus specifications.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;pci_socket.h&quot;
DECL|variable|controller_list
r_static
r_struct
id|pci_simple_probe_entry
id|controller_list
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1225
comma
l_int|0
comma
l_int|0
comma
op_amp
id|yenta_operations
)brace
comma
(brace
l_int|0x1180
comma
l_int|0x0475
comma
l_int|0
comma
l_int|0
comma
op_amp
id|yenta_operations
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Arbitrary define. This is the array of active cardbus&n; * entries.&n; */
DECL|macro|MAX_SOCKETS
mdefine_line|#define MAX_SOCKETS (8)
DECL|variable|pci_socket_array
r_static
id|pci_socket_t
id|pci_socket_array
(braket
id|MAX_SOCKETS
)braket
suffix:semicolon
multiline_comment|/*&n; * Work in progress. I need to distill the _real_ differences in&n; * carbus drivers, and change the cardbus &quot;op&quot; list to match. This&n; * is just a direct 1:1 mapping of the pccard operations.&n; */
DECL|function|pci_register_callback
r_static
r_int
id|pci_register_callback
c_func
(paren
r_int
r_int
id|sock
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
comma
r_int
r_int
)paren
comma
r_void
op_star
id|info
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
id|socket-&gt;handler
op_assign
id|handler
suffix:semicolon
id|socket-&gt;info
op_assign
id|info
suffix:semicolon
r_if
c_cond
(paren
id|handler
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_inquire_socket
r_static
r_int
id|pci_inquire_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_cap_t
op_star
id|cap
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;inquire
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|inquire
c_func
(paren
id|socket
comma
id|cap
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_get_status
r_static
r_int
id|pci_get_status
c_func
(paren
r_int
r_int
id|sock
comma
r_int
r_int
op_star
id|value
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;get_status
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|get_status
c_func
(paren
id|socket
comma
id|value
)paren
suffix:semicolon
op_star
id|value
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_get_socket
r_static
r_int
id|pci_get_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;get_socket
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|get_socket
c_func
(paren
id|socket
comma
id|state
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_set_socket
r_static
r_int
id|pci_set_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;set_socket
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|set_socket
c_func
(paren
id|socket
comma
id|state
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_get_io_map
r_static
r_int
id|pci_get_io_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;get_io_map
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|get_io_map
c_func
(paren
id|socket
comma
id|io
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_set_io_map
r_static
r_int
id|pci_set_io_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;set_io_map
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|set_io_map
c_func
(paren
id|socket
comma
id|io
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_get_mem_map
r_static
r_int
id|pci_get_mem_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;get_mem_map
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|get_mem_map
c_func
(paren
id|socket
comma
id|mem
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_set_mem_map
r_static
r_int
id|pci_set_mem_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;set_mem_map
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|set_mem_map
c_func
(paren
id|socket
comma
id|mem
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_get_bridge
r_static
r_int
id|pci_get_bridge
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|cb_bridge_map
op_star
id|m
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;get_bridge
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|get_bridge
c_func
(paren
id|socket
comma
id|m
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_set_bridge
r_static
r_int
id|pci_set_bridge
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|cb_bridge_map
op_star
id|m
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;set_bridge
)paren
r_return
id|socket-&gt;op
op_member_access_from_pointer
id|set_bridge
c_func
(paren
id|socket
comma
id|m
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pci_proc_setup
r_static
r_void
id|pci_proc_setup
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|proc_dir_entry
op_star
id|base
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;proc_setup
)paren
id|socket-&gt;op
op_member_access_from_pointer
id|proc_setup
c_func
(paren
id|socket
comma
id|base
)paren
suffix:semicolon
)brace
DECL|variable|pci_socket_operations
r_static
r_struct
id|pccard_operations
id|pci_socket_operations
op_assign
(brace
id|pci_register_callback
comma
id|pci_inquire_socket
comma
id|pci_get_status
comma
id|pci_get_socket
comma
id|pci_set_socket
comma
id|pci_get_io_map
comma
id|pci_set_io_map
comma
id|pci_get_mem_map
comma
id|pci_set_mem_map
comma
id|pci_get_bridge
comma
id|pci_set_bridge
comma
id|pci_proc_setup
)brace
suffix:semicolon
DECL|function|pci_socket_probe
r_static
r_int
id|__init
id|pci_socket_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|nr
comma
r_const
r_struct
id|pci_simple_probe_entry
op_star
id|entry
comma
r_void
op_star
id|data
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|nr
op_plus
id|pci_socket_array
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found controller %d: %s&bslash;n&quot;
comma
id|nr
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|socket-&gt;dev
op_assign
id|dev
suffix:semicolon
id|socket-&gt;op
op_assign
id|entry-&gt;dev_data
suffix:semicolon
id|socket-&gt;op
op_member_access_from_pointer
id|open
c_func
(paren
id|socket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_socket_init
r_static
r_int
id|__init
id|pci_socket_init
c_func
(paren
r_void
)paren
(brace
r_int
id|sockets
op_assign
id|pci_simple_probe
c_func
(paren
id|controller_list
comma
id|MAX_SOCKETS
comma
id|pci_socket_probe
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockets
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|register_ss_entry
c_func
(paren
id|sockets
comma
op_amp
id|pci_socket_operations
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_socket_exit
r_static
r_void
id|__exit
id|pci_socket_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|unregister_ss_entry
c_func
(paren
op_amp
id|pci_socket_operations
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_socket_t
op_star
id|socket
op_assign
id|pci_socket_array
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;op
op_logical_and
id|socket-&gt;op-&gt;close
)paren
id|socket-&gt;op
op_member_access_from_pointer
id|close
c_func
(paren
id|socket
)paren
suffix:semicolon
)brace
)brace
DECL|variable|pci_socket_init
id|module_init
c_func
(paren
id|pci_socket_init
)paren
suffix:semicolon
DECL|variable|pci_socket_exit
id|module_exit
c_func
(paren
id|pci_socket_exit
)paren
suffix:semicolon
eof
