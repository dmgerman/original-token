multiline_comment|/*======================================================================&n;&n;    Device driver for Databook TCIC-2 PCMCIA controller&n;&n;    tcic.c 1.111 2000/02/15 04:13:12&n;&n;    The contents of this file are subject to the Mozilla Public&n;    License Version 1.1 (the &quot;License&quot;); you may not use this file&n;    except in compliance with the License. You may obtain a copy of&n;    the License at http://www.mozilla.org/MPL/&n;&n;    Software distributed under the License is distributed on an &quot;AS&n;    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or&n;    implied. See the License for the specific language governing&n;    rights and limitations under the License.&n;&n;    The initial developer of the original code is David A. Hinds&n;    &lt;dhinds@pcmcia.sourceforge.org&gt;.  Portions created by David A. Hinds&n;    are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.&n;&n;    Alternatively, the contents of this file may be used under the&n;    terms of the GNU Public License version 2 (the &quot;GPL&quot;), in which&n;    case the provisions of the GPL are applicable instead of the&n;    above.  If you wish to allow the use of your version of this file&n;    only under the terms of the GPL and not to allow others to use&n;    your version of this file under the MPL, indicate your decision&n;    by deleting the provisions above and replace them with the notice&n;    and other provisions required by the GPL.  If you do not delete&n;    the provisions above, a recipient may use your version of this&n;    file under either the MPL or the GPL.&n;    &n;======================================================================*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &quot;tcic.h&quot;
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;tcic.c 1.111 2000/02/15 04:13:12 (David Hinds)&quot;
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David Hinds &lt;dhinds@pcmcia.sourceforge.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Databook TCIC-2 PCMCIA socket driver&quot;
)paren
suffix:semicolon
multiline_comment|/*====================================================================*/
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
multiline_comment|/* The base port address of the TCIC-2 chip */
DECL|variable|tcic_base
r_static
r_int
id|tcic_base
op_assign
id|TCIC_BASE
suffix:semicolon
multiline_comment|/* Specify a socket number to ignore */
DECL|variable|ignore
r_static
r_int
id|ignore
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Probe for safe interrupts? */
DECL|variable|do_scan
r_static
r_int
id|do_scan
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Bit map of interrupts to choose from */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xffff
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|16
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* The card status change interrupt -- 0 means autoselect */
DECL|variable|cs_irq
r_static
r_int
id|cs_irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Poll status interval -- 0 means default to interrupt */
DECL|variable|poll_interval
r_static
r_int
id|poll_interval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Delay for card status double-checking */
DECL|variable|poll_quick
r_static
r_int
id|poll_quick
op_assign
id|HZ
op_div
l_int|20
suffix:semicolon
multiline_comment|/* CCLK external clock time, in nanoseconds.  70 ns = 14.31818 MHz */
DECL|variable|cycle_time
r_static
r_int
id|cycle_time
op_assign
l_int|70
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tcic_base
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ignore
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|do_scan
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq_list
comma
l_string|&quot;1-16i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cs_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|poll_interval
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|poll_quick
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cycle_time
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*====================================================================*/
r_static
r_void
id|tcic_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|tcic_timer
c_func
(paren
id|u_long
id|data
)paren
suffix:semicolon
DECL|variable|tcic_operations
r_static
r_struct
id|pccard_operations
id|tcic_operations
suffix:semicolon
DECL|struct|socket_info_t
r_typedef
r_struct
id|socket_info_t
(brace
DECL|member|psock
id|u_short
id|psock
suffix:semicolon
DECL|member|handler
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
id|info
comma
id|u_int
id|events
)paren
suffix:semicolon
DECL|member|info
r_void
op_star
id|info
suffix:semicolon
DECL|member|last_sstat
id|u_char
id|last_sstat
suffix:semicolon
DECL|member|id
id|u_char
id|id
suffix:semicolon
DECL|typedef|socket_info_t
)brace
id|socket_info_t
suffix:semicolon
DECL|variable|poll_timer
r_static
r_struct
id|timer_list
id|poll_timer
suffix:semicolon
DECL|variable|tcic_timer_pending
r_static
r_int
id|tcic_timer_pending
op_assign
l_int|0
suffix:semicolon
DECL|variable|sockets
r_static
r_int
id|sockets
suffix:semicolon
DECL|variable|socket_table
r_static
id|socket_info_t
id|socket_table
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|tcic_cap
r_static
id|socket_cap_t
id|tcic_cap
op_assign
(brace
multiline_comment|/* only 16-bit cards, memory windows must be size-aligned */
id|SS_CAP_PCCARD
op_or
id|SS_CAP_MEM_ALIGN
comma
l_int|0x4cf8
comma
multiline_comment|/* irq 14, 11, 10, 7, 6, 5, 4, 3 */
l_int|0x1000
comma
multiline_comment|/* 4K minimum window size */
l_int|0
comma
l_int|0
multiline_comment|/* No PCI or CardBus support */
)brace
suffix:semicolon
multiline_comment|/*====================================================================*/
multiline_comment|/* Trick when selecting interrupts: the TCIC sktirq pin is supposed&n;   to map to irq 11, but is coded as 0 or 1 in the irq registers. */
DECL|macro|TCIC_IRQ
mdefine_line|#define TCIC_IRQ(x) ((x) ? (((x) == 11) ? 1 : (x)) : 15)
macro_line|#ifdef PCMCIA_DEBUG_X
DECL|function|tcic_getb
r_static
id|u_char
id|tcic_getb
c_func
(paren
id|u_char
id|reg
)paren
(brace
id|u_char
id|val
op_assign
id|inb
c_func
(paren
id|tcic_base
op_plus
id|reg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tcic_getb(%#x) = %#x&bslash;n&quot;
comma
id|tcic_base
op_plus
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|tcic_getw
r_static
id|u_short
id|tcic_getw
c_func
(paren
id|u_char
id|reg
)paren
(brace
id|u_short
id|val
op_assign
id|inw
c_func
(paren
id|tcic_base
op_plus
id|reg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tcic_getw(%#x) = %#x&bslash;n&quot;
comma
id|tcic_base
op_plus
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|tcic_setb
r_static
r_void
id|tcic_setb
c_func
(paren
id|u_char
id|reg
comma
id|u_char
id|data
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tcic_setb(%#x, %#x)&bslash;n&quot;
comma
id|tcic_base
op_plus
id|reg
comma
id|data
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
comma
id|tcic_base
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|tcic_setw
r_static
r_void
id|tcic_setw
c_func
(paren
id|u_char
id|reg
comma
id|u_short
id|data
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tcic_setw(%#x, %#x)&bslash;n&quot;
comma
id|tcic_base
op_plus
id|reg
comma
id|data
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
comma
id|tcic_base
op_plus
id|reg
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|tcic_getb
mdefine_line|#define tcic_getb(reg) inb(tcic_base+reg)
DECL|macro|tcic_getw
mdefine_line|#define tcic_getw(reg) inw(tcic_base+reg)
DECL|macro|tcic_setb
mdefine_line|#define tcic_setb(reg, data) outb(data, tcic_base+reg)
DECL|macro|tcic_setw
mdefine_line|#define tcic_setw(reg, data) outw(data, tcic_base+reg)
macro_line|#endif
DECL|function|tcic_setl
r_static
r_void
id|tcic_setl
c_func
(paren
id|u_char
id|reg
comma
id|u_int
id|data
)paren
(brace
macro_line|#ifdef PCMCIA_DEBUG_X
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tcic_setl(%#x, %#lx)&bslash;n&quot;
comma
id|tcic_base
op_plus
id|reg
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
id|outw
c_func
(paren
id|data
op_amp
l_int|0xffff
comma
id|tcic_base
op_plus
id|reg
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
op_rshift
l_int|16
comma
id|tcic_base
op_plus
id|reg
op_plus
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|tcic_aux_getb
r_static
id|u_char
id|tcic_aux_getb
c_func
(paren
id|u_short
id|reg
)paren
(brace
id|u_char
id|mode
op_assign
(paren
id|tcic_getb
c_func
(paren
id|TCIC_MODE
)paren
op_amp
id|TCIC_MODE_PGMMASK
)paren
op_or
id|reg
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_MODE
comma
id|mode
)paren
suffix:semicolon
r_return
id|tcic_getb
c_func
(paren
id|TCIC_AUX
)paren
suffix:semicolon
)brace
DECL|function|tcic_aux_setb
r_static
r_void
id|tcic_aux_setb
c_func
(paren
id|u_short
id|reg
comma
id|u_char
id|data
)paren
(brace
id|u_char
id|mode
op_assign
(paren
id|tcic_getb
c_func
(paren
id|TCIC_MODE
)paren
op_amp
id|TCIC_MODE_PGMMASK
)paren
op_or
id|reg
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_MODE
comma
id|mode
)paren
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_AUX
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|tcic_aux_getw
r_static
id|u_short
id|tcic_aux_getw
c_func
(paren
id|u_short
id|reg
)paren
(brace
id|u_char
id|mode
op_assign
(paren
id|tcic_getb
c_func
(paren
id|TCIC_MODE
)paren
op_amp
id|TCIC_MODE_PGMMASK
)paren
op_or
id|reg
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_MODE
comma
id|mode
)paren
suffix:semicolon
r_return
id|tcic_getw
c_func
(paren
id|TCIC_AUX
)paren
suffix:semicolon
)brace
DECL|function|tcic_aux_setw
r_static
r_void
id|tcic_aux_setw
c_func
(paren
id|u_short
id|reg
comma
id|u_short
id|data
)paren
(brace
id|u_char
id|mode
op_assign
(paren
id|tcic_getb
c_func
(paren
id|TCIC_MODE
)paren
op_amp
id|TCIC_MODE_PGMMASK
)paren
op_or
id|reg
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_MODE
comma
id|mode
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_AUX
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
multiline_comment|/* Time conversion functions */
DECL|function|to_cycles
r_static
r_int
id|to_cycles
c_func
(paren
r_int
id|ns
)paren
(brace
r_if
c_cond
(paren
id|ns
OL
l_int|14
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|2
op_star
(paren
id|ns
op_minus
l_int|14
)paren
op_div
id|cycle_time
suffix:semicolon
)brace
DECL|function|to_ns
r_static
r_int
id|to_ns
c_func
(paren
r_int
id|cycles
)paren
(brace
r_return
(paren
id|cycles
op_star
id|cycle_time
)paren
op_div
l_int|2
op_plus
l_int|14
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|variable|irq_hits
r_static
r_volatile
id|u_int
id|irq_hits
suffix:semicolon
DECL|function|irq_count
r_static
r_void
id|__init
id|irq_count
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|irq_hits
op_increment
suffix:semicolon
)brace
DECL|function|try_irq
r_static
id|u_int
id|__init
id|try_irq
c_func
(paren
r_int
id|irq
)paren
(brace
id|u_short
id|cfg
suffix:semicolon
id|irq_hits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|irq_count
comma
l_int|0
comma
l_string|&quot;irq scan&quot;
comma
id|irq_count
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_hits
)paren
(brace
id|free_irq
c_func
(paren
id|irq
comma
id|irq_count
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Generate one interrupt */
id|cfg
op_assign
id|TCIC_SYSCFG_AUTOBUSY
op_or
l_int|0x0a00
suffix:semicolon
id|tcic_aux_setw
c_func
(paren
id|TCIC_AUX_SYSCFG
comma
id|cfg
op_or
id|TCIC_IRQ
c_func
(paren
id|irq
)paren
)paren
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_IENA
comma
id|TCIC_IENA_ERR
op_or
id|TCIC_IENA_CFG_HIGH
)paren
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_ICSR
comma
id|TCIC_ICSR_ERR
op_or
id|TCIC_ICSR_JAM
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|irq_count
)paren
suffix:semicolon
multiline_comment|/* Turn off interrupts */
id|tcic_setb
c_func
(paren
id|TCIC_IENA
comma
id|TCIC_IENA_CFG_OFF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tcic_getb
c_func
(paren
id|TCIC_ICSR
)paren
)paren
id|tcic_setb
c_func
(paren
id|TCIC_ICSR
comma
id|TCIC_ICSR_JAM
)paren
suffix:semicolon
id|tcic_aux_setw
c_func
(paren
id|TCIC_AUX_SYSCFG
comma
id|cfg
)paren
suffix:semicolon
r_return
(paren
id|irq_hits
op_ne
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|irq_scan
r_static
id|u_int
id|__init
id|irq_scan
c_func
(paren
id|u_int
id|mask0
)paren
(brace
id|u_int
id|mask1
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef __alpha__
DECL|macro|PIC
mdefine_line|#define PIC 0x4d0
multiline_comment|/* Don&squot;t probe level-triggered interrupts -- reserved for PCI */
r_int
id|level_mask
op_assign
id|inb_p
c_func
(paren
id|PIC
)paren
op_or
(paren
id|inb_p
c_func
(paren
id|PIC
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level_mask
)paren
id|mask0
op_and_assign
op_complement
id|level_mask
suffix:semicolon
macro_line|#endif
id|mask1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|do_scan
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|mask0
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_logical_and
(paren
id|try_irq
c_func
(paren
id|i
)paren
op_eq
l_int|0
)paren
)paren
id|mask1
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|mask1
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_logical_and
(paren
id|try_irq
c_func
(paren
id|i
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|mask1
op_xor_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mask1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scanned&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Fallback: just find interrupts that aren&squot;t in use */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|mask0
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_logical_and
(paren
id|request_irq
c_func
(paren
id|i
comma
id|irq_count
comma
l_int|0
comma
l_string|&quot;x&quot;
comma
id|irq_count
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|mask1
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|i
comma
id|irq_count
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;default&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;) = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mask1
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s%d&quot;
comma
(paren
(paren
id|mask1
op_amp
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_minus
l_int|1
)paren
)paren
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
r_return
id|mask1
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    See if a card is present, powered up, in IO mode, and already&n;    bound to a (non-PCMCIA) Linux driver.&n;&n;    We make an exception for cards that look like serial devices.&n;    &n;======================================================================*/
DECL|function|is_active
r_static
r_int
id|__init
id|is_active
c_func
(paren
r_int
id|s
)paren
(brace
id|u_short
id|scf1
comma
id|ioctl
comma
id|base
comma
id|num
suffix:semicolon
id|u_char
id|pwr
comma
id|sstat
suffix:semicolon
id|u_int
id|addr
suffix:semicolon
id|tcic_setl
c_func
(paren
id|TCIC_ADDR
comma
(paren
id|s
op_lshift
id|TCIC_ADDR_SS_SHFT
)paren
op_or
id|TCIC_ADDR_INDREG
op_or
id|TCIC_SCF1
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
id|scf1
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|pwr
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_PWR
)paren
suffix:semicolon
id|sstat
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_SSTAT
)paren
suffix:semicolon
id|addr
op_assign
id|TCIC_IWIN
c_func
(paren
id|s
comma
l_int|0
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_IBASE_X
)paren
suffix:semicolon
id|base
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_ICTL_X
)paren
suffix:semicolon
id|ioctl
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
op_amp
id|TCIC_ICTL_TINY
)paren
id|num
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|num
op_assign
(paren
id|base
op_xor
(paren
id|base
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|base
op_assign
id|base
op_amp
(paren
id|base
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sstat
op_amp
id|TCIC_SSTAT_CD
)paren
op_logical_and
(paren
id|pwr
op_amp
id|TCIC_PWR_VCC
c_func
(paren
id|s
)paren
)paren
op_logical_and
(paren
id|scf1
op_amp
id|TCIC_SCF1_IOSTS
)paren
op_logical_and
(paren
id|ioctl
op_amp
id|TCIC_ICTL_ENA
)paren
op_logical_and
(paren
id|check_region
c_func
(paren
id|base
comma
id|num
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|base
op_amp
l_int|0xfeef
)paren
op_ne
l_int|0x02e8
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    This returns the revision code for the specified socket.&n;    &n;======================================================================*/
DECL|function|get_tcic_id
r_static
r_int
id|__init
id|get_tcic_id
c_func
(paren
r_void
)paren
(brace
id|u_short
id|id
suffix:semicolon
id|tcic_aux_setw
c_func
(paren
id|TCIC_AUX_TEST
comma
id|TCIC_TEST_DIAG
)paren
suffix:semicolon
id|id
op_assign
id|tcic_aux_getw
c_func
(paren
id|TCIC_AUX_ILOCK
)paren
suffix:semicolon
id|id
op_assign
(paren
id|id
op_amp
id|TCIC_ILOCKTEST_ID_MASK
)paren
op_rshift
id|TCIC_ILOCKTEST_ID_SH
suffix:semicolon
id|tcic_aux_setw
c_func
(paren
id|TCIC_AUX_TEST
comma
l_int|0
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|function|init_tcic
r_static
r_int
id|__init
id|init_tcic
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|sock
suffix:semicolon
id|u_int
id|mask
comma
id|scan
suffix:semicolon
id|servinfo_t
id|serv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|pcmcia_get_card_services_info
c_func
(paren
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;tcic: Card Services release &quot;
l_string|&quot;does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Databook TCIC-2 PCMCIA probe: &quot;
)paren
suffix:semicolon
id|sock
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|tcic_base
comma
l_int|16
)paren
op_eq
l_int|0
)paren
(brace
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getw
c_func
(paren
id|TCIC_ADDR
)paren
op_eq
l_int|0
)paren
(brace
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
l_int|0xc3a5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getw
c_func
(paren
id|TCIC_ADDR
)paren
op_eq
l_int|0xc3a5
)paren
id|sock
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock
op_eq
l_int|0
)paren
(brace
multiline_comment|/* See if resetting the controller does any good */
id|tcic_setb
c_func
(paren
id|TCIC_SCTRL
comma
id|TCIC_SCTRL_RESET
)paren
suffix:semicolon
id|tcic_setb
c_func
(paren
id|TCIC_SCTRL
comma
l_int|0
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getw
c_func
(paren
id|TCIC_ADDR
)paren
op_eq
l_int|0
)paren
(brace
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
l_int|0xc3a5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getw
c_func
(paren
id|TCIC_ADDR
)paren
op_eq
l_int|0xc3a5
)paren
id|sock
op_assign
l_int|2
suffix:semicolon
)brace
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;could not allocate ports, &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;not found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|tcic_base
comma
l_int|16
comma
l_string|&quot;tcic-2&quot;
)paren
suffix:semicolon
id|sockets
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sock
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_eq
id|ignore
)paren
op_logical_or
id|is_active
c_func
(paren
id|i
)paren
)paren
r_continue
suffix:semicolon
id|socket_table
(braket
id|sockets
)braket
dot
id|psock
op_assign
id|i
suffix:semicolon
id|socket_table
(braket
id|sockets
)braket
dot
id|handler
op_assign
l_int|NULL
suffix:semicolon
id|socket_table
(braket
id|sockets
)braket
dot
id|info
op_assign
l_int|NULL
suffix:semicolon
id|socket_table
(braket
id|sockets
)braket
dot
id|id
op_assign
id|get_tcic_id
c_func
(paren
)paren
suffix:semicolon
id|sockets
op_increment
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|socket_table
(braket
l_int|0
)braket
dot
id|id
)paren
(brace
r_case
id|TCIC_ID_DB86082
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86082&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ID_DB86082A
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86082A&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ID_DB86084
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86084&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ID_DB86084A
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86084A&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ID_DB86072
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86072&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ID_DB86184
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86184&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ID_DB86082B
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DB86082B&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown ID 0x%02x&quot;
comma
id|socket_table
(braket
l_int|0
)braket
dot
id|id
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up polling */
id|poll_timer.function
op_assign
op_amp
id|tcic_timer
suffix:semicolon
id|poll_timer.data
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|poll_timer
)paren
suffix:semicolon
multiline_comment|/* Build interrupt mask */
id|printk
c_func
(paren
l_string|&quot;, %d sockets&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  irq list (&quot;
comma
id|sockets
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|mask
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
id|mask
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
)paren
suffix:semicolon
id|mask
op_and_assign
id|tcic_cap.irq_mask
suffix:semicolon
multiline_comment|/* Scan interrupts */
id|mask
op_assign
id|irq_scan
c_func
(paren
id|mask
)paren
suffix:semicolon
id|tcic_cap.irq_mask
op_assign
id|mask
suffix:semicolon
multiline_comment|/* Check for only two interrupts available */
id|scan
op_assign
(paren
id|mask
op_amp
(paren
id|mask
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|scan
op_amp
(paren
id|scan
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|poll_interval
op_eq
l_int|0
)paren
)paren
id|poll_interval
op_assign
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|poll_interval
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Avoid irq 12 unless it is explicitly requested */
id|u_int
id|cs_mask
op_assign
id|mask
op_amp
(paren
(paren
id|cs_irq
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|cs_irq
)paren
suffix:colon
op_complement
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|cs_mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_logical_and
(paren
id|request_irq
c_func
(paren
id|i
comma
id|tcic_interrupt
comma
l_int|0
comma
l_string|&quot;tcic&quot;
comma
id|tcic_interrupt
)paren
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
id|cs_irq
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cs_irq
op_eq
l_int|0
)paren
id|poll_interval
op_assign
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tcic_cap.irq_mask
op_amp
(paren
l_int|1
op_lshift
l_int|11
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;sktirq is irq 11, &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs_irq
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;status change on irq %d&bslash;n&quot;
comma
id|cs_irq
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;polled status, interval = %d ms&bslash;n&quot;
comma
id|poll_interval
op_star
l_int|1000
op_div
id|HZ
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sockets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
op_plus
l_int|2
comma
id|socket_table
(braket
id|i
)braket
dot
id|psock
op_lshift
id|TCIC_SS_SHFT
)paren
suffix:semicolon
id|socket_table
(braket
id|i
)braket
dot
id|last_sstat
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_SSTAT
)paren
suffix:semicolon
)brace
multiline_comment|/* jump start interrupt handler, if needed */
id|tcic_interrupt
c_func
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_ss_entry
c_func
(paren
id|sockets
comma
op_amp
id|tcic_operations
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;tcic: register_ss_entry() failed&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|tcic_base
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs_irq
op_ne
l_int|0
)paren
id|free_irq
c_func
(paren
id|cs_irq
comma
id|tcic_interrupt
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* init_tcic */
multiline_comment|/*====================================================================*/
DECL|function|exit_tcic
r_static
r_void
id|__exit
id|exit_tcic
c_func
(paren
r_void
)paren
(brace
id|u_long
id|flags
suffix:semicolon
id|unregister_ss_entry
c_func
(paren
op_amp
id|tcic_operations
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs_irq
op_ne
l_int|0
)paren
(brace
id|tcic_aux_setw
c_func
(paren
id|TCIC_AUX_SYSCFG
comma
id|TCIC_SYSCFG_AUTOBUSY
op_or
l_int|0x0a00
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|cs_irq
comma
id|tcic_interrupt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tcic_timer_pending
)paren
id|del_timer
c_func
(paren
op_amp
id|poll_timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|tcic_base
comma
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* exit_tcic */
multiline_comment|/*====================================================================*/
DECL|variable|pending_events
r_static
id|u_int
id|pending_events
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|pending_event_lock
r_static
id|spinlock_t
id|pending_event_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|tcic_bh
r_static
r_void
id|tcic_bh
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
id|u_int
id|events
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sockets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|pending_event_lock
)paren
suffix:semicolon
id|events
op_assign
id|pending_events
(braket
id|i
)braket
suffix:semicolon
id|pending_events
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|pending_event_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socket_table
(braket
id|i
)braket
dot
id|handler
)paren
id|socket_table
(braket
id|i
)braket
dot
id|handler
c_func
(paren
id|socket_table
(braket
id|i
)braket
dot
id|info
comma
id|events
)paren
suffix:semicolon
)brace
)brace
DECL|variable|tcic_task
r_static
r_struct
id|tq_struct
id|tcic_task
op_assign
(brace
id|routine
suffix:colon
id|tcic_bh
)brace
suffix:semicolon
DECL|function|tcic_interrupt
r_static
r_void
id|tcic_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
comma
id|quick
op_assign
l_int|0
suffix:semicolon
id|u_char
id|latch
comma
id|sstat
suffix:semicolon
id|u_short
id|psock
suffix:semicolon
id|u_int
id|events
suffix:semicolon
r_static
r_volatile
r_int
id|active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|active
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;tcic: reentered interrupt handler!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|active
op_assign
l_int|1
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;tcic: tcic_interrupt()&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sockets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psock
op_assign
id|socket_table
(braket
id|i
)braket
dot
id|psock
suffix:semicolon
id|tcic_setl
c_func
(paren
id|TCIC_ADDR
comma
(paren
id|psock
op_lshift
id|TCIC_ADDR_SS_SHFT
)paren
op_or
id|TCIC_ADDR_INDREG
op_or
id|TCIC_SCF1
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
id|sstat
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_SSTAT
)paren
suffix:semicolon
id|latch
op_assign
id|sstat
op_xor
id|socket_table
(braket
id|psock
)braket
dot
id|last_sstat
suffix:semicolon
id|socket_table
(braket
id|i
)braket
dot
id|last_sstat
op_assign
id|sstat
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getb
c_func
(paren
id|TCIC_ICSR
)paren
op_amp
id|TCIC_ICSR_CDCHG
)paren
(brace
id|tcic_setb
c_func
(paren
id|TCIC_ICSR
comma
id|TCIC_ICSR_CLEAR
)paren
suffix:semicolon
id|quick
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|latch
op_eq
l_int|0
)paren
op_logical_or
(paren
id|socket_table
(braket
id|psock
)braket
dot
id|handler
op_eq
l_int|NULL
)paren
)paren
r_continue
suffix:semicolon
id|events
op_assign
(paren
id|latch
op_amp
id|TCIC_SSTAT_CD
)paren
ques
c_cond
id|SS_DETECT
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|latch
op_amp
id|TCIC_SSTAT_WP
)paren
ques
c_cond
id|SS_WRPROT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
op_amp
id|TCIC_SCF1_IOSTS
)paren
(brace
id|events
op_or_assign
(paren
id|latch
op_amp
id|TCIC_SSTAT_LBAT1
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|events
op_or_assign
(paren
id|latch
op_amp
id|TCIC_SSTAT_RDY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|latch
op_amp
id|TCIC_SSTAT_LBAT1
)paren
ques
c_cond
id|SS_BATDEAD
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|latch
op_amp
id|TCIC_SSTAT_LBAT2
)paren
ques
c_cond
id|SS_BATWARN
suffix:colon
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|events
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|pending_event_lock
)paren
suffix:semicolon
id|pending_events
(braket
id|i
)braket
op_or_assign
id|events
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pending_event_lock
)paren
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|tcic_task
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Schedule next poll, if needed */
r_if
c_cond
(paren
(paren
(paren
id|cs_irq
op_eq
l_int|0
)paren
op_logical_or
id|quick
)paren
op_logical_and
(paren
op_logical_neg
id|tcic_timer_pending
)paren
)paren
(brace
id|poll_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|quick
ques
c_cond
id|poll_quick
suffix:colon
id|poll_interval
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|poll_timer
)paren
suffix:semicolon
id|tcic_timer_pending
op_assign
l_int|1
suffix:semicolon
)brace
id|active
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;tcic: interrupt done&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* tcic_interrupt */
DECL|function|tcic_timer
r_static
r_void
id|tcic_timer
c_func
(paren
id|u_long
id|data
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;tcic: tcic_timer()&bslash;n&quot;
)paren
suffix:semicolon
id|tcic_timer_pending
op_assign
l_int|0
suffix:semicolon
id|tcic_interrupt
c_func
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* tcic_timer */
multiline_comment|/*====================================================================*/
DECL|function|tcic_register_callback
r_static
r_int
id|tcic_register_callback
c_func
(paren
r_int
r_int
id|lsock
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
comma
r_int
r_int
)paren
comma
r_void
op_star
id|info
)paren
(brace
id|socket_table
(braket
id|lsock
)braket
dot
id|handler
op_assign
id|handler
suffix:semicolon
id|socket_table
(braket
id|lsock
)braket
dot
id|info
op_assign
id|info
suffix:semicolon
r_if
c_cond
(paren
id|handler
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_register_callback */
multiline_comment|/*====================================================================*/
DECL|function|tcic_get_status
r_static
r_int
id|tcic_get_status
c_func
(paren
r_int
r_int
id|lsock
comma
id|u_int
op_star
id|value
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_char
id|reg
suffix:semicolon
id|tcic_setl
c_func
(paren
id|TCIC_ADDR
comma
(paren
id|psock
op_lshift
id|TCIC_ADDR_SS_SHFT
)paren
op_or
id|TCIC_ADDR_INDREG
op_or
id|TCIC_SCF1
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
id|reg
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_SSTAT
)paren
suffix:semicolon
op_star
id|value
op_assign
(paren
id|reg
op_amp
id|TCIC_SSTAT_CD
)paren
ques
c_cond
id|SS_DETECT
suffix:colon
l_int|0
suffix:semicolon
op_star
id|value
op_or_assign
(paren
id|reg
op_amp
id|TCIC_SSTAT_WP
)paren
ques
c_cond
id|SS_WRPROT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
op_amp
id|TCIC_SCF1_IOSTS
)paren
(brace
op_star
id|value
op_or_assign
(paren
id|reg
op_amp
id|TCIC_SSTAT_LBAT1
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|value
op_or_assign
(paren
id|reg
op_amp
id|TCIC_SSTAT_RDY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
op_star
id|value
op_or_assign
(paren
id|reg
op_amp
id|TCIC_SSTAT_LBAT1
)paren
ques
c_cond
id|SS_BATDEAD
suffix:colon
l_int|0
suffix:semicolon
op_star
id|value
op_or_assign
(paren
id|reg
op_amp
id|TCIC_SSTAT_LBAT2
)paren
ques
c_cond
id|SS_BATWARN
suffix:colon
l_int|0
suffix:semicolon
)brace
id|reg
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_PWR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
(paren
id|TCIC_PWR_VCC
c_func
(paren
id|psock
)paren
op_or
id|TCIC_PWR_VPP
c_func
(paren
id|psock
)paren
)paren
)paren
op_star
id|value
op_or_assign
id|SS_POWERON
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: GetStatus(%d) = %#2.2x&bslash;n&quot;
comma
id|lsock
comma
op_star
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_get_status */
multiline_comment|/*====================================================================*/
DECL|function|tcic_inquire_socket
r_static
r_int
id|tcic_inquire_socket
c_func
(paren
r_int
r_int
id|lsock
comma
id|socket_cap_t
op_star
id|cap
)paren
(brace
op_star
id|cap
op_assign
id|tcic_cap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_inquire_socket */
multiline_comment|/*====================================================================*/
DECL|function|tcic_get_socket
r_static
r_int
id|tcic_get_socket
c_func
(paren
r_int
r_int
id|lsock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_char
id|reg
suffix:semicolon
id|u_short
id|scf1
comma
id|scf2
suffix:semicolon
id|tcic_setl
c_func
(paren
id|TCIC_ADDR
comma
(paren
id|psock
op_lshift
id|TCIC_ADDR_SS_SHFT
)paren
op_or
id|TCIC_ADDR_INDREG
op_or
id|TCIC_SCF1
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
id|scf1
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|state-&gt;flags
op_assign
(paren
id|scf1
op_amp
id|TCIC_SCF1_IOSTS
)paren
ques
c_cond
id|SS_IOCARD
suffix:colon
l_int|0
suffix:semicolon
id|state-&gt;flags
op_or_assign
(paren
id|scf1
op_amp
id|TCIC_SCF1_DMA_MASK
)paren
ques
c_cond
id|SS_DMA_MODE
suffix:colon
l_int|0
suffix:semicolon
id|state-&gt;flags
op_or_assign
(paren
id|scf1
op_amp
id|TCIC_SCF1_SPKR
)paren
ques
c_cond
id|SS_SPKR_ENA
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tcic_getb
c_func
(paren
id|TCIC_SCTRL
)paren
op_amp
id|TCIC_SCTRL_ENA
)paren
id|state-&gt;flags
op_or_assign
id|SS_OUTPUT_ENA
suffix:semicolon
id|state-&gt;io_irq
op_assign
id|scf1
op_amp
id|TCIC_SCF1_IRQ_MASK
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;io_irq
op_eq
l_int|1
)paren
id|state-&gt;io_irq
op_assign
l_int|11
suffix:semicolon
id|reg
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_PWR
)paren
suffix:semicolon
id|state-&gt;Vcc
op_assign
id|state-&gt;Vpp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|TCIC_PWR_VCC
c_func
(paren
id|psock
)paren
)paren
(brace
r_if
c_cond
(paren
id|reg
op_amp
id|TCIC_PWR_VPP
c_func
(paren
id|psock
)paren
)paren
id|state-&gt;Vcc
op_assign
l_int|50
suffix:semicolon
r_else
id|state-&gt;Vcc
op_assign
id|state-&gt;Vpp
op_assign
l_int|50
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|reg
op_amp
id|TCIC_PWR_VPP
c_func
(paren
id|psock
)paren
)paren
(brace
id|state-&gt;Vcc
op_assign
l_int|50
suffix:semicolon
id|state-&gt;Vpp
op_assign
l_int|120
suffix:semicolon
)brace
)brace
id|reg
op_assign
id|tcic_aux_getb
c_func
(paren
id|TCIC_AUX_ILOCK
)paren
suffix:semicolon
id|state-&gt;flags
op_or_assign
(paren
id|reg
op_amp
id|TCIC_ILOCK_CRESET
)paren
ques
c_cond
id|SS_RESET
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Card status change interrupt mask */
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|TCIC_SCF2
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
id|scf2
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|state-&gt;csc_mask
op_assign
(paren
id|scf2
op_amp
id|TCIC_SCF2_MCD
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_DETECT
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
id|state-&gt;csc_mask
op_or_assign
(paren
id|scf2
op_amp
id|TCIC_SCF2_MLBAT1
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_STSCHG
suffix:semicolon
)brace
r_else
(brace
id|state-&gt;csc_mask
op_or_assign
(paren
id|scf2
op_amp
id|TCIC_SCF2_MLBAT1
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_BATDEAD
suffix:semicolon
id|state-&gt;csc_mask
op_or_assign
(paren
id|scf2
op_amp
id|TCIC_SCF2_MLBAT2
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_BATWARN
suffix:semicolon
id|state-&gt;csc_mask
op_or_assign
(paren
id|scf2
op_amp
id|TCIC_SCF2_MRDY
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_READY
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: GetSocket(%d) = flags %#3.3x, Vcc %d, Vpp %d, &quot;
l_string|&quot;io_irq %d, csc_mask %#2.2x&bslash;n&quot;
comma
id|lsock
comma
id|state-&gt;flags
comma
id|state-&gt;Vcc
comma
id|state-&gt;Vpp
comma
id|state-&gt;io_irq
comma
id|state-&gt;csc_mask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_get_socket */
multiline_comment|/*====================================================================*/
DECL|function|tcic_set_socket
r_static
r_int
id|tcic_set_socket
c_func
(paren
r_int
r_int
id|lsock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_char
id|reg
suffix:semicolon
id|u_short
id|scf1
comma
id|scf2
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: SetSocket(%d, flags %#3.3x, Vcc %d, Vpp %d, &quot;
l_string|&quot;io_irq %d, csc_mask %#2.2x)&bslash;n&quot;
comma
id|lsock
comma
id|state-&gt;flags
comma
id|state-&gt;Vcc
comma
id|state-&gt;Vpp
comma
id|state-&gt;io_irq
comma
id|state-&gt;csc_mask
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
op_plus
l_int|2
comma
(paren
id|psock
op_lshift
id|TCIC_SS_SHFT
)paren
op_or
id|TCIC_ADR2_INDREG
)paren
suffix:semicolon
id|reg
op_assign
id|tcic_getb
c_func
(paren
id|TCIC_PWR
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
(paren
id|TCIC_PWR_VCC
c_func
(paren
id|psock
)paren
op_or
id|TCIC_PWR_VPP
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;Vcc
op_eq
l_int|50
)paren
(brace
r_switch
c_cond
(paren
id|state-&gt;Vpp
)paren
(brace
r_case
l_int|0
suffix:colon
id|reg
op_or_assign
id|TCIC_PWR_VCC
c_func
(paren
id|psock
)paren
op_or
id|TCIC_PWR_VPP
c_func
(paren
id|psock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|reg
op_or_assign
id|TCIC_PWR_VCC
c_func
(paren
id|psock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|120
suffix:colon
id|reg
op_or_assign
id|TCIC_PWR_VPP
c_func
(paren
id|psock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|state-&gt;Vcc
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ne
id|tcic_getb
c_func
(paren
id|TCIC_PWR
)paren
)paren
id|tcic_setb
c_func
(paren
id|TCIC_PWR
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|TCIC_ILOCK_HOLD_CCLK
op_or
id|TCIC_ILOCK_CWAIT
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
)paren
(brace
id|tcic_setb
c_func
(paren
id|TCIC_SCTRL
comma
id|TCIC_SCTRL_ENA
)paren
suffix:semicolon
id|reg
op_or_assign
id|TCIC_ILOCK_CRESENA
suffix:semicolon
)brace
r_else
id|tcic_setb
c_func
(paren
id|TCIC_SCTRL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_RESET
)paren
id|reg
op_or_assign
id|TCIC_ILOCK_CRESET
suffix:semicolon
id|tcic_aux_setb
c_func
(paren
id|TCIC_AUX_ILOCK
comma
id|reg
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|TCIC_SCF1
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
id|scf1
op_assign
id|TCIC_SCF1_FINPACK
suffix:semicolon
id|scf1
op_or_assign
id|TCIC_IRQ
c_func
(paren
id|state-&gt;io_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
id|scf1
op_or_assign
id|TCIC_SCF1_IOSTS
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_SPKR_ENA
)paren
id|scf1
op_or_assign
id|TCIC_SCF1_SPKR
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_DMA_MODE
)paren
id|scf1
op_or_assign
id|TCIC_SCF1_DREQ2
op_lshift
id|TCIC_SCF1_DMA_SHIFT
suffix:semicolon
)brace
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|scf1
)paren
suffix:semicolon
multiline_comment|/* Some general setup stuff, and configure status interrupt */
id|reg
op_assign
id|TCIC_WAIT_ASYNC
op_or
id|TCIC_WAIT_SENSE
op_or
id|to_cycles
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|tcic_aux_setb
c_func
(paren
id|TCIC_AUX_WCTL
comma
id|reg
)paren
suffix:semicolon
id|tcic_aux_setw
c_func
(paren
id|TCIC_AUX_SYSCFG
comma
id|TCIC_SYSCFG_AUTOBUSY
op_or
l_int|0x0a00
op_or
id|TCIC_IRQ
c_func
(paren
id|cs_irq
)paren
)paren
suffix:semicolon
multiline_comment|/* Card status change interrupt mask */
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|TCIC_SCF2
c_func
(paren
id|psock
)paren
)paren
suffix:semicolon
id|scf2
op_assign
id|TCIC_SCF2_MALL
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_DETECT
)paren
id|scf2
op_and_assign
op_complement
id|TCIC_SCF2_MCD
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_STSCHG
)paren
id|reg
op_and_assign
op_complement
id|TCIC_SCF2_MLBAT1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATDEAD
)paren
id|reg
op_and_assign
op_complement
id|TCIC_SCF2_MLBAT1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATWARN
)paren
id|reg
op_and_assign
op_complement
id|TCIC_SCF2_MLBAT2
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_READY
)paren
id|reg
op_and_assign
op_complement
id|TCIC_SCF2_MRDY
suffix:semicolon
)brace
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|scf2
)paren
suffix:semicolon
multiline_comment|/* For the ISA bus, the irq should be active-high totem-pole */
id|tcic_setb
c_func
(paren
id|TCIC_IENA
comma
id|TCIC_IENA_CDCHG
op_or
id|TCIC_IENA_CFG_HIGH
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_set_socket */
multiline_comment|/*====================================================================*/
DECL|function|tcic_get_io_map
r_static
r_int
id|tcic_get_io_map
c_func
(paren
r_int
r_int
id|lsock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_short
id|base
comma
id|ioctl
suffix:semicolon
id|u_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;map
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
op_plus
l_int|2
comma
id|TCIC_ADR2_INDREG
op_or
(paren
id|psock
op_lshift
id|TCIC_SS_SHFT
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|TCIC_IWIN
c_func
(paren
id|psock
comma
id|io-&gt;map
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_IBASE_X
)paren
suffix:semicolon
id|base
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_ICTL_X
)paren
suffix:semicolon
id|ioctl
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
op_amp
id|TCIC_ICTL_TINY
)paren
id|io-&gt;start
op_assign
id|io-&gt;stop
op_assign
id|base
suffix:semicolon
r_else
(brace
id|io-&gt;start
op_assign
id|base
op_amp
(paren
id|base
op_minus
l_int|1
)paren
suffix:semicolon
id|io-&gt;stop
op_assign
id|io-&gt;start
op_plus
(paren
id|base
op_xor
(paren
id|base
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|io-&gt;speed
op_assign
id|to_ns
c_func
(paren
id|ioctl
op_amp
id|TCIC_ICTL_WSCNT_MASK
)paren
suffix:semicolon
id|io-&gt;flags
op_assign
(paren
id|ioctl
op_amp
id|TCIC_ICTL_ENA
)paren
ques
c_cond
id|MAP_ACTIVE
suffix:colon
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|ioctl
op_amp
id|TCIC_ICTL_BW_MASK
)paren
(brace
r_case
id|TCIC_ICTL_BW_DYN
suffix:colon
id|io-&gt;flags
op_or_assign
id|MAP_AUTOSZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCIC_ICTL_BW_16
suffix:colon
id|io-&gt;flags
op_or_assign
id|MAP_16BIT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: GetIOMap(%d, %d) = %#2.2x, %d ns, &quot;
l_string|&quot;%#4.4x-%#4.4x&bslash;n&quot;
comma
id|lsock
comma
id|io-&gt;map
comma
id|io-&gt;flags
comma
id|io-&gt;speed
comma
id|io-&gt;start
comma
id|io-&gt;stop
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_get_io_map */
multiline_comment|/*====================================================================*/
DECL|function|tcic_set_io_map
r_static
r_int
id|tcic_set_io_map
c_func
(paren
r_int
r_int
id|lsock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_int
id|addr
suffix:semicolon
id|u_short
id|base
comma
id|len
comma
id|ioctl
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: SetIOMap(%d, %d, %#2.2x, %d ns, &quot;
l_string|&quot;%#4.4x-%#4.4x)&bslash;n&quot;
comma
id|lsock
comma
id|io-&gt;map
comma
id|io-&gt;flags
comma
id|io-&gt;speed
comma
id|io-&gt;start
comma
id|io-&gt;stop
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|io-&gt;map
OG
l_int|1
)paren
op_logical_or
(paren
id|io-&gt;start
OG
l_int|0xffff
)paren
op_logical_or
(paren
id|io-&gt;stop
OG
l_int|0xffff
)paren
op_logical_or
(paren
id|io-&gt;stop
OL
id|io-&gt;start
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
op_plus
l_int|2
comma
id|TCIC_ADR2_INDREG
op_or
(paren
id|psock
op_lshift
id|TCIC_SS_SHFT
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|TCIC_IWIN
c_func
(paren
id|psock
comma
id|io-&gt;map
)paren
suffix:semicolon
id|base
op_assign
id|io-&gt;start
suffix:semicolon
id|len
op_assign
id|io-&gt;stop
op_minus
id|io-&gt;start
suffix:semicolon
multiline_comment|/* Check to see that len+1 is power of two, etc */
r_if
c_cond
(paren
(paren
id|len
op_amp
(paren
id|len
op_plus
l_int|1
)paren
)paren
op_logical_or
(paren
id|base
op_amp
id|len
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|base
op_or_assign
(paren
id|len
op_plus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_IBASE_X
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|base
)paren
suffix:semicolon
id|ioctl
op_assign
(paren
id|psock
op_lshift
id|TCIC_ICTL_SS_SHFT
)paren
suffix:semicolon
id|ioctl
op_or_assign
(paren
id|len
op_eq
l_int|0
)paren
ques
c_cond
id|TCIC_ICTL_TINY
suffix:colon
l_int|0
suffix:semicolon
id|ioctl
op_or_assign
(paren
id|io-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
ques
c_cond
id|TCIC_ICTL_ENA
suffix:colon
l_int|0
suffix:semicolon
id|ioctl
op_or_assign
id|to_cycles
c_func
(paren
id|io-&gt;speed
)paren
op_amp
id|TCIC_ICTL_WSCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|io-&gt;flags
op_amp
id|MAP_AUTOSZ
)paren
)paren
(brace
id|ioctl
op_or_assign
id|TCIC_ICTL_QUIET
suffix:semicolon
id|ioctl
op_or_assign
(paren
id|io-&gt;flags
op_amp
id|MAP_16BIT
)paren
ques
c_cond
id|TCIC_ICTL_BW_16
suffix:colon
id|TCIC_ICTL_BW_8
suffix:semicolon
)brace
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_ICTL_X
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|ioctl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_set_io_map */
multiline_comment|/*====================================================================*/
DECL|function|tcic_get_mem_map
r_static
r_int
id|tcic_get_mem_map
c_func
(paren
r_int
r_int
id|lsock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_short
id|addr
comma
id|ctl
suffix:semicolon
id|u_long
id|base
comma
id|mmap
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;map
OG
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
op_plus
l_int|2
comma
id|TCIC_ADR2_INDREG
op_or
(paren
id|psock
op_lshift
id|TCIC_SS_SHFT
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|TCIC_MWIN
c_func
(paren
id|psock
comma
id|mem-&gt;map
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_MBASE_X
)paren
suffix:semicolon
id|base
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
id|TCIC_MBASE_4K_BIT
)paren
(brace
id|mem-&gt;sys_start
op_assign
id|base
op_amp
id|TCIC_MBASE_HA_MASK
suffix:semicolon
id|mem-&gt;sys_stop
op_assign
id|mem-&gt;sys_start
suffix:semicolon
)brace
r_else
(brace
id|base
op_and_assign
id|TCIC_MBASE_HA_MASK
suffix:semicolon
id|mem-&gt;sys_start
op_assign
(paren
id|base
op_amp
(paren
id|base
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|mem-&gt;sys_stop
op_assign
id|mem-&gt;sys_start
op_plus
(paren
id|base
op_xor
(paren
id|base
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|mem-&gt;sys_start
op_assign
id|mem-&gt;sys_start
op_lshift
id|TCIC_MBASE_HA_SHFT
suffix:semicolon
id|mem-&gt;sys_stop
op_assign
(paren
id|mem-&gt;sys_stop
op_lshift
id|TCIC_MBASE_HA_SHFT
)paren
op_plus
l_int|0x0fff
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_MMAP_X
)paren
suffix:semicolon
id|mmap
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|mem-&gt;flags
op_assign
(paren
id|mmap
op_amp
id|TCIC_MMAP_REG
)paren
ques
c_cond
id|MAP_ATTRIB
suffix:colon
l_int|0
suffix:semicolon
id|mmap
op_and_assign
id|TCIC_MMAP_CA_MASK
suffix:semicolon
id|mem-&gt;card_start
op_assign
id|mem-&gt;sys_start
op_plus
(paren
id|mmap
op_lshift
id|TCIC_MMAP_CA_SHFT
)paren
suffix:semicolon
id|mem-&gt;card_start
op_and_assign
l_int|0x3ffffff
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_MCTL_X
)paren
suffix:semicolon
id|ctl
op_assign
id|tcic_getw
c_func
(paren
id|TCIC_DATA
)paren
suffix:semicolon
id|mem-&gt;flags
op_or_assign
(paren
id|ctl
op_amp
id|TCIC_MCTL_ENA
)paren
ques
c_cond
id|MAP_ACTIVE
suffix:colon
l_int|0
suffix:semicolon
id|mem-&gt;flags
op_or_assign
(paren
id|ctl
op_amp
id|TCIC_MCTL_B8
)paren
ques
c_cond
l_int|0
suffix:colon
id|MAP_16BIT
suffix:semicolon
id|mem-&gt;flags
op_or_assign
(paren
id|ctl
op_amp
id|TCIC_MCTL_WP
)paren
ques
c_cond
id|MAP_WRPROT
suffix:colon
l_int|0
suffix:semicolon
id|mem-&gt;speed
op_assign
id|to_ns
c_func
(paren
id|ctl
op_amp
id|TCIC_MCTL_WSCNT_MASK
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: GetMemMap(%d, %d) = %#2.2x, %d ns, &quot;
l_string|&quot;%#5.5lx-%#5.5lx, %#5.5x&bslash;n&quot;
comma
id|lsock
comma
id|mem-&gt;map
comma
id|mem-&gt;flags
comma
id|mem-&gt;speed
comma
id|mem-&gt;sys_start
comma
id|mem-&gt;sys_stop
comma
id|mem-&gt;card_start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_get_mem_map */
multiline_comment|/*====================================================================*/
DECL|function|tcic_set_mem_map
r_static
r_int
id|tcic_set_mem_map
c_func
(paren
r_int
r_int
id|lsock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|u_short
id|psock
op_assign
id|socket_table
(braket
id|lsock
)braket
dot
id|psock
suffix:semicolon
id|u_short
id|addr
comma
id|ctl
suffix:semicolon
id|u_long
id|base
comma
id|len
comma
id|mmap
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;tcic: SetMemMap(%d, %d, %#2.2x, %d ns, &quot;
l_string|&quot;%#5.5lx-%#5.5lx, %#5.5x)&bslash;n&quot;
comma
id|lsock
comma
id|mem-&gt;map
comma
id|mem-&gt;flags
comma
id|mem-&gt;speed
comma
id|mem-&gt;sys_start
comma
id|mem-&gt;sys_stop
comma
id|mem-&gt;card_start
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mem-&gt;map
OG
l_int|3
)paren
op_logical_or
(paren
id|mem-&gt;card_start
OG
l_int|0x3ffffff
)paren
op_logical_or
(paren
id|mem-&gt;sys_start
OG
l_int|0xffffff
)paren
op_logical_or
(paren
id|mem-&gt;sys_stop
OG
l_int|0xffffff
)paren
op_logical_or
(paren
id|mem-&gt;sys_start
OG
id|mem-&gt;sys_stop
)paren
op_logical_or
(paren
id|mem-&gt;speed
OG
l_int|1000
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
op_plus
l_int|2
comma
id|TCIC_ADR2_INDREG
op_or
(paren
id|psock
op_lshift
id|TCIC_SS_SHFT
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|TCIC_MWIN
c_func
(paren
id|psock
comma
id|mem-&gt;map
)paren
suffix:semicolon
id|base
op_assign
id|mem-&gt;sys_start
suffix:semicolon
id|len
op_assign
id|mem-&gt;sys_stop
op_minus
id|mem-&gt;sys_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_amp
(paren
id|len
op_plus
l_int|1
)paren
)paren
op_logical_or
(paren
id|base
op_amp
id|len
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0x0fff
)paren
id|base
op_assign
(paren
id|base
op_rshift
id|TCIC_MBASE_HA_SHFT
)paren
op_or
id|TCIC_MBASE_4K_BIT
suffix:semicolon
r_else
id|base
op_assign
(paren
id|base
op_or
(paren
id|len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
op_rshift
id|TCIC_MBASE_HA_SHFT
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_MBASE_X
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|base
)paren
suffix:semicolon
id|mmap
op_assign
id|mem-&gt;card_start
op_minus
id|mem-&gt;sys_start
suffix:semicolon
id|mmap
op_assign
(paren
id|mmap
op_rshift
id|TCIC_MMAP_CA_SHFT
)paren
op_amp
id|TCIC_MMAP_CA_MASK
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ATTRIB
)paren
id|mmap
op_or_assign
id|TCIC_MMAP_REG
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_MMAP_X
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|mmap
)paren
suffix:semicolon
id|ctl
op_assign
id|TCIC_MCTL_QUIET
op_or
(paren
id|psock
op_lshift
id|TCIC_MCTL_SS_SHFT
)paren
suffix:semicolon
id|ctl
op_or_assign
id|to_cycles
c_func
(paren
id|mem-&gt;speed
)paren
op_amp
id|TCIC_MCTL_WSCNT_MASK
suffix:semicolon
id|ctl
op_or_assign
(paren
id|mem-&gt;flags
op_amp
id|MAP_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
id|TCIC_MCTL_B8
suffix:semicolon
id|ctl
op_or_assign
(paren
id|mem-&gt;flags
op_amp
id|MAP_WRPROT
)paren
ques
c_cond
id|TCIC_MCTL_WP
suffix:colon
l_int|0
suffix:semicolon
id|ctl
op_or_assign
(paren
id|mem-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
ques
c_cond
id|TCIC_MCTL_ENA
suffix:colon
l_int|0
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_ADDR
comma
id|addr
op_plus
id|TCIC_MCTL_X
)paren
suffix:semicolon
id|tcic_setw
c_func
(paren
id|TCIC_DATA
comma
id|ctl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* tcic_set_mem_map */
multiline_comment|/*====================================================================*/
DECL|function|tcic_proc_setup
r_static
r_void
id|tcic_proc_setup
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|proc_dir_entry
op_star
id|base
)paren
(brace
)brace
DECL|function|tcic_init
r_static
r_int
id|tcic_init
c_func
(paren
r_int
r_int
id|s
)paren
(brace
r_int
id|i
suffix:semicolon
id|pccard_io_map
id|io
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
suffix:semicolon
id|pccard_mem_map
id|mem
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|mem.sys_stop
op_assign
l_int|0x1000
suffix:semicolon
id|tcic_set_socket
c_func
(paren
id|s
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io.map
op_assign
id|i
suffix:semicolon
id|tcic_set_io_map
c_func
(paren
id|s
comma
op_amp
id|io
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem.map
op_assign
id|i
suffix:semicolon
id|tcic_set_mem_map
c_func
(paren
id|s
comma
op_amp
id|mem
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tcic_suspend
r_static
r_int
id|tcic_suspend
c_func
(paren
r_int
r_int
id|sock
)paren
(brace
r_return
id|tcic_set_socket
c_func
(paren
id|sock
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
)brace
DECL|variable|tcic_operations
r_static
r_struct
id|pccard_operations
id|tcic_operations
op_assign
(brace
id|tcic_init
comma
id|tcic_suspend
comma
id|tcic_register_callback
comma
id|tcic_inquire_socket
comma
id|tcic_get_status
comma
id|tcic_get_socket
comma
id|tcic_set_socket
comma
id|tcic_get_io_map
comma
id|tcic_set_io_map
comma
id|tcic_get_mem_map
comma
id|tcic_set_mem_map
comma
id|tcic_proc_setup
)brace
suffix:semicolon
multiline_comment|/*====================================================================*/
DECL|variable|init_tcic
id|module_init
c_func
(paren
id|init_tcic
)paren
suffix:semicolon
DECL|variable|exit_tcic
id|module_exit
c_func
(paren
id|exit_tcic
)paren
suffix:semicolon
eof
