multiline_comment|/*&n; *&t;drivers/i2o/i2o_lan.c&n; *&n; * &t;I2O LAN CLASS OSM &t;&t;May 26th 2000&n; *&n; *&t;(C) Copyright 1999, 2000 &t;University of Helsinki,&n; *&t;&t;      &t;&t;&t;Department of Computer Science&n; *&n; * &t;This code is still under development / test.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Authors: &t;Auvo H&#xfffd;kkinen &lt;Auvo.Hakkinen@cs.Helsinki.FI&gt;&n; *&t;Fixes:&t;&t;Juha Siev&#xfffd;nen &lt;Juha.Sievanen@cs.Helsinki.FI&gt;&n; *&t; &t;&t;Taneli V&#xfffd;h&#xfffd;kangas &lt;Taneli.Vahakangas@cs.Helsinki.FI&gt;&n; *&t;&t;&t;Deepak Saxena &lt;deepak@plexity.net&gt;&n; *&n; *&t;Tested:&t;&t;in FDDI environment (using SysKonnect&squot;s DDM)&n; *&t;&t;&t;in Gigabit Eth environment (using SysKonnect&squot;s DDM)&n; *&t;&t;&t;in Fast Ethernet environment (using Intel 82558 DDM)&n; *&n; *&t;TODO:&t;&t;tests for other LAN classes (Token Ring, Fibre Channel)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/fddidevice.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &lt;linux/fcdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#include &quot;i2o_lan.h&quot;
singleline_comment|//#define DRIVERDEBUG
macro_line|#ifdef DRIVERDEBUG
DECL|macro|dprintk
mdefine_line|#define dprintk(s, args...) printk(s, ## args)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(s, args...)
macro_line|#endif
multiline_comment|/* The following module parameters are used as default values&n; * for per interface values located in the net_device private area.&n; * Private values are changed via /proc filesystem.&n; */
DECL|variable|max_buckets_out
r_static
id|u32
id|max_buckets_out
op_assign
id|I2O_LAN_MAX_BUCKETS_OUT
suffix:semicolon
DECL|variable|bucket_thresh
r_static
id|u32
id|bucket_thresh
op_assign
id|I2O_LAN_BUCKET_THRESH
suffix:semicolon
DECL|variable|rx_copybreak
r_static
id|u32
id|rx_copybreak
op_assign
id|I2O_LAN_RX_COPYBREAK
suffix:semicolon
DECL|variable|tx_batch_mode
r_static
id|u8
id|tx_batch_mode
op_assign
id|I2O_LAN_TX_BATCH_MODE
suffix:semicolon
DECL|variable|i2o_event_mask
r_static
id|u32
id|i2o_event_mask
op_assign
id|I2O_LAN_EVENT_MASK
suffix:semicolon
DECL|macro|MAX_LAN_CARDS
mdefine_line|#define MAX_LAN_CARDS 16
DECL|variable|i2o_landevs
r_static
r_struct
id|net_device
op_star
id|i2o_landevs
(braket
id|MAX_LAN_CARDS
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|unit
r_static
r_int
id|unit
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* device unit number */
r_static
r_void
id|i2o_lan_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|iop
comma
r_struct
id|i2o_message
op_star
id|m
)paren
suffix:semicolon
r_static
r_void
id|i2o_lan_send_post_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|iop
comma
r_struct
id|i2o_message
op_star
id|m
)paren
suffix:semicolon
r_static
r_int
id|i2o_lan_receive_post
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|i2o_lan_receive_post_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|iop
comma
r_struct
id|i2o_message
op_star
id|m
)paren
suffix:semicolon
r_static
r_void
id|i2o_lan_release_buckets
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
suffix:semicolon
r_static
r_int
id|i2o_lan_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|i2o_lan_handle_event
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
suffix:semicolon
multiline_comment|/* Structures to register handlers for the incoming replies. */
DECL|variable|i2o_lan_send_handler
r_static
r_struct
id|i2o_handler
id|i2o_lan_send_handler
op_assign
(brace
id|i2o_lan_send_post_reply
comma
singleline_comment|// For send replies
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;I2O LAN OSM send&quot;
comma
op_minus
l_int|1
comma
id|I2O_CLASS_LAN
)brace
suffix:semicolon
DECL|variable|lan_send_context
r_static
r_int
id|lan_send_context
suffix:semicolon
DECL|variable|i2o_lan_receive_handler
r_static
r_struct
id|i2o_handler
id|i2o_lan_receive_handler
op_assign
(brace
id|i2o_lan_receive_post_reply
comma
singleline_comment|// For receive replies
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;I2O LAN OSM receive&quot;
comma
op_minus
l_int|1
comma
id|I2O_CLASS_LAN
)brace
suffix:semicolon
DECL|variable|lan_receive_context
r_static
r_int
id|lan_receive_context
suffix:semicolon
DECL|variable|i2o_lan_handler
r_static
r_struct
id|i2o_handler
id|i2o_lan_handler
op_assign
(brace
id|i2o_lan_reply
comma
singleline_comment|// For other replies
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;I2O LAN OSM&quot;
comma
op_minus
l_int|1
comma
id|I2O_CLASS_LAN
)brace
suffix:semicolon
DECL|variable|lan_context
r_static
r_int
id|lan_context
suffix:semicolon
DECL|variable|i2o_post_buckets_task
id|DECLARE_TASK_QUEUE
c_func
(paren
id|i2o_post_buckets_task
)paren
suffix:semicolon
DECL|variable|run_i2o_post_buckets_task
r_struct
id|tq_struct
id|run_i2o_post_buckets_task
op_assign
(brace
id|routine
suffix:colon
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|run_task_queue
comma
id|data
suffix:colon
(paren
r_void
op_star
)paren
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Functions to handle message failures and transaction errors:&n;==============================================================*/
multiline_comment|/*&n; * i2o_lan_handle_failure(): Fail bit has been set since IOP&squot;s message&n; * layer cannot deliver the request to the target, or the target cannot&n; * process the request.&n; */
DECL|function|i2o_lan_handle_failure
r_static
r_void
id|i2o_lan_handle_failure
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
op_star
id|preserved_msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|iop-&gt;mem_offset
op_plus
id|msg
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|u32
op_star
id|sgl_elem
op_assign
op_amp
id|preserved_msg
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|u8
id|le_flag
suffix:semicolon
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
multiline_comment|/* If PacketSend failed, free sk_buffs reserved by upper layers */
r_if
c_cond
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
op_eq
id|LAN_PACKET_SEND
)paren
(brace
r_do
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|sgl_elem
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
suffix:semicolon
id|le_flag
op_assign
op_star
id|sgl_elem
op_rshift
l_int|31
suffix:semicolon
id|sgl_elem
op_add_assign
l_int|3
suffix:semicolon
)brace
r_while
c_loop
(paren
id|le_flag
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Last element flag not set */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* If ReceivePost failed, free sk_buffs we have reserved */
r_if
c_cond
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
op_eq
id|LAN_RECEIVE_POST
)paren
(brace
r_do
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|sgl_elem
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
id|le_flag
op_assign
op_star
id|sgl_elem
op_rshift
l_int|31
suffix:semicolon
id|sgl_elem
op_add_assign
l_int|3
suffix:semicolon
)brace
r_while
c_loop
(paren
id|le_flag
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Last element flag not set */
)brace
multiline_comment|/* Release the preserved msg frame by resubmitting it as a NOP */
id|preserved_msg
(braket
l_int|0
)braket
op_assign
id|THREE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|preserved_msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_NOP
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
l_int|0
suffix:semicolon
id|preserved_msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|iop
comma
id|msg
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_handle_transaction_error(): IOP or DDM has rejected the request&n; * for general cause (format error, bad function code, insufficient resources,&n; * etc.). We get one transaction_error for each failed transaction.&n; */
DECL|function|i2o_lan_handle_transaction_error
r_static
r_void
id|i2o_lan_handle_transaction_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
multiline_comment|/* If PacketSend was rejected, free sk_buff reserved by upper layers */
r_if
c_cond
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
op_eq
id|LAN_PACKET_SEND
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|msg
(braket
l_int|3
)braket
)paren
suffix:semicolon
singleline_comment|// TransactionContext
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* If ReceivePost was rejected, free sk_buff we have reserved */
r_if
c_cond
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
op_eq
id|LAN_RECEIVE_POST
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|msg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * i2o_lan_handle_status(): Common parts of handling a not succeeded request&n; * (status != SUCCESS).&n; */
DECL|function|i2o_lan_handle_status
r_static
r_int
id|i2o_lan_handle_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
(brace
multiline_comment|/* Fail bit set? */
r_if
c_cond
(paren
id|msg
(braket
l_int|0
)braket
op_amp
id|MSG_FAIL
)paren
(brace
id|i2o_lan_handle_failure
c_func
(paren
id|dev
comma
id|msg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Message rejected for general cause? */
r_if
c_cond
(paren
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_eq
id|I2O_REPLY_STATUS_TRANSACTION_ERROR
)paren
(brace
id|i2o_lan_handle_transaction_error
c_func
(paren
id|dev
comma
id|msg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Else have to handle it in the callback function */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Callback functions called from the interrupt routine:&n;=======================================================*/
multiline_comment|/*&n; * i2o_lan_send_post_reply(): Callback function to handle PostSend replies.&n; */
DECL|function|i2o_lan_send_post_reply
r_static
r_void
id|i2o_lan_send_post_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|iop
comma
r_struct
id|i2o_message
op_star
id|m
)paren
(brace
id|u32
op_star
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|m
suffix:semicolon
id|u8
id|unit
op_assign
(paren
id|u8
)paren
(paren
id|msg
(braket
l_int|2
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
singleline_comment|// InitiatorContext
r_struct
id|net_device
op_star
id|dev
op_assign
id|i2o_landevs
(braket
id|unit
)braket
suffix:semicolon
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
id|trl_count
op_assign
id|msg
(braket
l_int|3
)braket
op_amp
l_int|0x000000FF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|i2o_lan_handle_status
c_func
(paren
id|dev
comma
id|msg
)paren
)paren
r_return
suffix:semicolon
)brace
macro_line|#ifdef DRIVERDEBUG
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* DDM has handled transmit request(s), free sk_buffs.&n;&t; * We get similar single transaction reply also in error cases &n;&t; * (except if msg failure or transaction error).&n;&t; */
r_while
c_loop
(paren
id|trl_count
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|msg
(braket
l_int|4
op_plus
id|trl_count
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx skb freed (trl_count=%d).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|trl_count
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
suffix:semicolon
id|trl_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* If priv-&gt;tx_out had reached tx_max_out, the queue was stopped */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_receive_post_reply(): Callback function to process incoming packets.&n; */
DECL|function|i2o_lan_receive_post_reply
r_static
r_void
id|i2o_lan_receive_post_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|iop
comma
r_struct
id|i2o_message
op_star
id|m
)paren
(brace
id|u32
op_star
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|m
suffix:semicolon
id|u8
id|unit
op_assign
(paren
id|u8
)paren
(paren
id|msg
(braket
l_int|2
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
singleline_comment|// InitiatorContext
r_struct
id|net_device
op_star
id|dev
op_assign
id|i2o_landevs
(braket
id|unit
)braket
suffix:semicolon
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_bucket_descriptor
op_star
id|bucket
op_assign
(paren
r_struct
id|i2o_bucket_descriptor
op_star
)paren
op_amp
id|msg
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|i2o_packet_info
op_star
id|packet
suffix:semicolon
id|u8
id|trl_count
op_assign
id|msg
(braket
l_int|3
)braket
op_amp
l_int|0x000000FF
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|old_skb
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|i2o_lan_handle_status
c_func
(paren
id|dev
comma
id|msg
)paren
)paren
r_return
suffix:semicolon
id|i2o_lan_release_buckets
c_func
(paren
id|dev
comma
id|msg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DRIVERDEBUG
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Else we are receiving incoming post. */
r_while
c_loop
(paren
id|trl_count
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|bucket-&gt;context
suffix:semicolon
id|packet
op_assign
(paren
r_struct
id|i2o_packet_info
op_star
)paren
id|bucket-&gt;packet_info
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
multiline_comment|/* Sanity checks: Any weird characteristics in bucket? */
r_if
c_cond
(paren
id|packet-&gt;flags
op_amp
l_int|0x0f
op_logical_or
op_logical_neg
id|packet-&gt;flags
op_amp
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
id|packet-&gt;flags
op_amp
l_int|0x01
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: packet with errors, error code=0x%02x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|packet-&gt;status
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* The following shouldn&squot;t happen, unless parameters in&n;&t;&t;&t; * LAN_OPERATION group are changed during the run time.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|packet-&gt;flags
op_amp
l_int|0x0c
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: multi-bucket packets not supported!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet-&gt;flags
op_amp
l_int|0x40
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: multiple packets in a bucket not supported!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|bucket
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Copy short packet to a new skb */
r_if
c_cond
(paren
id|packet-&gt;len
OL
id|priv-&gt;rx_copybreak
)paren
(brace
id|old_skb
op_assign
id|skb
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|dev_alloc_skb
c_func
(paren
id|packet-&gt;len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t allocate skb.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|packet-&gt;len
)paren
comma
id|old_skb-&gt;data
comma
id|packet-&gt;len
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;fbl_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;i2o_fbl_tail
OL
id|I2O_LAN_MAX_BUCKETS_OUT
)paren
id|priv-&gt;i2o_fbl
(braket
op_increment
id|priv-&gt;i2o_fbl_tail
)braket
op_assign
id|old_skb
suffix:semicolon
r_else
id|dev_kfree_skb_irq
c_func
(paren
id|old_skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;fbl_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
id|skb_put
c_func
(paren
id|skb
comma
id|packet-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Deliver to upper layers */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|priv
op_member_access_from_pointer
id|type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Incoming packet (%d bytes) delivered &quot;
l_string|&quot;to upper level.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|packet-&gt;len
)paren
suffix:semicolon
id|bucket
op_increment
suffix:semicolon
singleline_comment|// to next Packet Descriptor Block
)brace
macro_line|#ifdef DRIVERDEBUG
r_if
c_cond
(paren
id|msg
(braket
l_int|5
)braket
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DDM out of buckets (priv-&gt;count = %d)!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If DDM has already consumed bucket_thresh buckets, post new ones */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
op_le
id|priv-&gt;max_buckets_out
op_minus
id|priv-&gt;bucket_thresh
)paren
(brace
id|run_i2o_post_buckets_task.data
op_assign
(paren
r_void
op_star
)paren
id|dev
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|run_i2o_post_buckets_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_reply(): Callback function to handle other incoming messages&n; * except SendPost and ReceivePost.&n; */
DECL|function|i2o_lan_reply
r_static
r_void
id|i2o_lan_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|iop
comma
r_struct
id|i2o_message
op_star
id|m
)paren
(brace
id|u32
op_star
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|m
suffix:semicolon
id|u8
id|unit
op_assign
(paren
id|u8
)paren
(paren
id|msg
(braket
l_int|2
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
singleline_comment|// InitiatorContext
r_struct
id|net_device
op_star
id|dev
op_assign
id|i2o_landevs
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|i2o_lan_handle_status
c_func
(paren
id|dev
comma
id|msg
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* In other error cases just report and continue */
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
)brace
macro_line|#ifdef DRIVERDEBUG
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
(brace
r_case
id|LAN_RESET
suffix:colon
r_case
id|LAN_SUSPEND
suffix:colon
multiline_comment|/* default reply without payload */
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_EVT_REGISTER
suffix:colon
r_case
id|I2O_CMD_UTIL_EVT_ACK
suffix:colon
id|i2o_lan_handle_event
c_func
(paren
id|dev
comma
id|msg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_PARAMS_SET
suffix:colon
multiline_comment|/* default reply, results in ReplyPayload (not examined) */
r_switch
c_cond
(paren
id|msg
(braket
l_int|3
)braket
op_rshift
l_int|16
)paren
(brace
r_case
l_int|1
suffix:colon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Reply to set MAC filter mask.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Reply to set MAC table.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Bad group 0x%04X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
(braket
l_int|3
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: No handler for the reply.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Functions used by the above callback functions:&n;=================================================*/
multiline_comment|/*&n; * i2o_lan_release_buckets(): Free unused buckets (sk_buffs).&n; */
DECL|function|i2o_lan_release_buckets
r_static
r_void
id|i2o_lan_release_buckets
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
id|trl_elem_size
op_assign
(paren
id|u8
)paren
(paren
id|msg
(braket
l_int|3
)braket
op_rshift
l_int|8
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
id|u8
id|trl_count
op_assign
(paren
id|u8
)paren
(paren
id|msg
(braket
l_int|3
)braket
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
id|u32
op_star
id|pskb
op_assign
op_amp
id|msg
(braket
l_int|6
)braket
suffix:semicolon
r_while
c_loop
(paren
id|trl_count
op_decrement
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Releasing unused rx skb %p (trl_count=%d).&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
op_star
id|pskb
)paren
comma
id|trl_count
op_plus
l_int|1
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
op_star
id|pskb
)paren
)paren
suffix:semicolon
id|pskb
op_add_assign
l_int|1
op_plus
id|trl_elem_size
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * i2o_lan_event_reply(): Handle events.&n; */
DECL|function|i2o_lan_handle_event
r_static
r_void
id|i2o_lan_handle_event
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|msg
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
id|max_evt_data_size
op_assign
id|iop-&gt;status_block-&gt;inbound_frame_size
op_minus
l_int|5
suffix:semicolon
r_struct
id|i2o_reply
(brace
id|u32
id|header
(braket
l_int|4
)braket
suffix:semicolon
id|u32
id|evt_indicator
suffix:semicolon
id|u32
id|data
(braket
id|max_evt_data_size
)braket
suffix:semicolon
)brace
op_star
id|evt
op_assign
(paren
r_struct
id|i2o_reply
op_star
)paren
id|msg
suffix:semicolon
r_int
id|evt_data_len
op_assign
(paren
(paren
id|msg
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_minus
l_int|5
)paren
op_star
l_int|4
suffix:semicolon
multiline_comment|/* real size*/
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: I2O event - &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
op_eq
id|I2O_CMD_UTIL_EVT_ACK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Event acknowledgement reply.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Else evt-&gt;function == I2O_CMD_UTIL_EVT_REGISTER) */
r_switch
c_cond
(paren
id|evt-&gt;evt_indicator
)paren
(brace
r_case
id|I2O_EVT_IND_STATE_CHANGE
suffix:colon
(brace
r_struct
id|state_data
(brace
id|u16
id|status
suffix:semicolon
id|u8
id|state
suffix:semicolon
id|u8
id|data
suffix:semicolon
)brace
op_star
id|evt_data
op_assign
(paren
r_struct
id|state_data
op_star
)paren
(paren
id|evt-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;State chance 0x%08x.&bslash;n&quot;
comma
id|evt-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* If the DDM is in error state, recovery may be&n;&t;&t; * possible if status = Transmit or Receive Control&n;&t;&t; * Unit Inoperable.&n;&t;&t; */
r_if
c_cond
(paren
id|evt_data-&gt;state
op_eq
l_int|0x05
op_logical_and
id|evt_data-&gt;status
op_eq
l_int|0x0003
)paren
id|i2o_lan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|I2O_EVT_IND_FIELD_MODIFIED
suffix:colon
(brace
id|u16
op_star
id|work16
op_assign
(paren
id|u16
op_star
)paren
id|evt-&gt;data
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Group 0x%04x, field %d changed.&bslash;n&quot;
comma
id|work16
(braket
l_int|0
)braket
comma
id|work16
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|I2O_EVT_IND_VENDOR_EVT
suffix:colon
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Vendor event:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|evt_data_len
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;   0x%08x&bslash;n&quot;
comma
id|evt-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|I2O_EVT_IND_DEVICE_RESET
suffix:colon
multiline_comment|/* Spec 2.0 p. 6-121:&n;&t;&t; * The event of _DEVICE_RESET should also be responded&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;Device reset.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_event_ack
c_func
(paren
id|iop
comma
id|msg
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Event Acknowledge timeout.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if 0
r_case
id|I2O_EVT_IND_EVT_MASK_MODIFIED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Event mask modified, 0x%08x.&bslash;n&quot;
comma
id|evt-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_EVT_IND_GENERAL_WARNING
suffix:colon
id|printk
c_func
(paren
l_string|&quot;General warning 0x%04x.&bslash;n&quot;
comma
id|evt-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_EVT_IND_CONFIGURATION_FLAG
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Configuration requested.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_EVT_IND_CAPABILITY_CHANGE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Capability change 0x%04x.&bslash;n&quot;
comma
id|evt-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_EVT_IND_DEVICE_STATE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Device state changed 0x%08x.&bslash;n&quot;
comma
id|evt-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|I2O_LAN_EVT_LINK_DOWN
suffix:colon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Link to the physical device is lost.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_LAN_EVT_LINK_UP
suffix:colon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Link to the physical device is (re)established.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_LAN_EVT_MEDIA_CHANGE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Media change.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;0x%08x. No handler.&bslash;n&quot;
comma
id|evt-&gt;evt_indicator
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * i2o_lan_receive_post(): Post buckets to receive packets.&n; */
DECL|function|i2o_lan_receive_post
r_static
r_int
id|i2o_lan_receive_post
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|m
comma
op_star
id|msg
suffix:semicolon
id|u32
id|bucket_len
op_assign
(paren
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|u32
id|total
op_assign
id|priv-&gt;max_buckets_out
op_minus
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
id|u32
id|bucket_count
suffix:semicolon
id|u32
op_star
id|sgl_elem
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Send (total/bucket_count) separate I2O requests */
r_while
c_loop
(paren
id|total
)paren
(brace
id|m
op_assign
id|I2O_POST_READ32
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|iop-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|bucket_count
op_assign
(paren
id|total
op_ge
id|priv-&gt;sgl_max
)paren
ques
c_cond
id|priv-&gt;sgl_max
suffix:colon
id|total
suffix:semicolon
id|total
op_sub_assign
id|bucket_count
suffix:semicolon
id|atomic_add
c_func
(paren
id|bucket_count
comma
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending %d buckets (size %d) to LAN DDM.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|bucket_count
comma
id|bucket_len
)paren
suffix:semicolon
multiline_comment|/* Fill in the header */
id|__raw_writel
c_func
(paren
id|I2O_MESSAGE_SIZE
c_func
(paren
l_int|4
op_plus
l_int|3
op_star
id|bucket_count
)paren
op_or
id|SGL_OFFSET_4
comma
id|msg
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|LAN_RECEIVE_POST
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
comma
id|msg
op_plus
l_int|1
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_receive_context
comma
id|msg
op_plus
l_int|2
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|bucket_count
comma
id|msg
op_plus
l_int|3
)paren
suffix:semicolon
id|sgl_elem
op_assign
op_amp
id|msg
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Fill in the payload - contains bucket_count SGL elements */
r_while
c_loop
(paren
id|bucket_count
op_decrement
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;fbl_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;i2o_fbl_tail
op_ge
l_int|0
)paren
id|skb
op_assign
id|priv-&gt;i2o_fbl
(braket
id|priv-&gt;i2o_fbl_tail
op_decrement
)braket
suffix:semicolon
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|bucket_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;fbl_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;fbl_lock
comma
id|flags
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x51000000
op_or
id|bucket_len
comma
id|sgl_elem
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb
comma
id|sgl_elem
op_plus
l_int|1
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
id|sgl_elem
op_plus
l_int|2
)paren
suffix:semicolon
id|sgl_elem
op_add_assign
l_int|3
suffix:semicolon
)brace
multiline_comment|/* set LE flag and post  */
id|__raw_writel
c_func
(paren
id|__raw_readl
c_func
(paren
id|sgl_elem
op_minus
l_int|3
)paren
op_or
l_int|0x80000000
comma
(paren
id|sgl_elem
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|iop
comma
id|m
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Functions called from the network stack, and functions called by them:&n;========================================================================*/
multiline_comment|/*&n; * i2o_lan_reset(): Reset the LAN adapter into the operational state and&n; * &t;restore it to full operation.&n; */
DECL|function|i2o_lan_reset
r_static
r_int
id|i2o_lan_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
id|msg
(braket
l_int|5
)braket
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LAN RESET MESSAGE.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|LAN_RESET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_context
suffix:semicolon
singleline_comment|// InitiatorContext
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// TransactionContext
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Keep posted buckets
r_if
c_cond
(paren
id|i2o_post_this
c_func
(paren
id|iop
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_suspend(): Put LAN adapter into a safe, non-active state.&n; * &t;IOP replies to any LAN class message with status error_no_data_transfer&n; *&t;/ suspended.&n; */
DECL|function|i2o_lan_suspend
r_static
r_int
id|i2o_lan_suspend
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
id|msg
(braket
l_int|5
)braket
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LAN SUSPEND MESSAGE.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|LAN_SUSPEND
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_context
suffix:semicolon
singleline_comment|// InitiatorContext
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// TransactionContext
id|msg
(braket
l_int|4
)braket
op_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
singleline_comment|// return posted buckets
r_if
c_cond
(paren
id|i2o_post_this
c_func
(paren
id|iop
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_set_ddm_parameters:&n; * These settings are done to ensure proper initial values for DDM.&n; * They can be changed via proc file system or vai configuration utility.&n; */
DECL|function|i2o_set_ddm_parameters
r_static
r_void
id|i2o_set_ddm_parameters
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
id|val
suffix:semicolon
multiline_comment|/*&n;&t; * When PacketOrphanlimit is set to the maximum packet length,&n;&t; * the packets will never be split into two separate buckets&n;&t; */
id|val
op_assign
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
suffix:semicolon
r_if
c_cond
(paren
id|i2o_set_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0004
comma
l_int|2
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to set PacketOrphanLimit.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PacketOrphanLimit set to %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* When RxMaxPacketsBucket = 1, DDM puts only one packet into bucket */
id|val
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i2o_set_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0008
comma
l_int|4
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to set RxMaxPacketsBucket.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: RxMaxPacketsBucket set to %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|val
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Functions called from the network stack:&n;==========================================*/
multiline_comment|/*&n; * i2o_lan_open(): Open the device to send/receive packets via&n; * the network device.&n; */
DECL|function|i2o_lan_open
r_static
r_int
id|i2o_lan_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
id|mc_addr_group
(braket
l_int|64
)braket
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|i2o_claim_device
c_func
(paren
id|i2o_dev
comma
op_amp
id|i2o_lan_handler
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to claim the I2O LAN device.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: I2O LAN device (tid=%d) claimed by LAN OSM.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i2o_dev-&gt;lct_data.tid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_event_register
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_context
comma
l_int|0
comma
id|priv-&gt;i2o_event_mask
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to set the event mask.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|i2o_lan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Get the max number of multicast addresses */
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0001
comma
op_minus
l_int|1
comma
op_amp
id|mc_addr_group
comma
r_sizeof
(paren
id|mc_addr_group
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to query LAN_MAC_ADDRESS group.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|priv-&gt;max_size_mc_table
op_assign
id|mc_addr_group
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Malloc space for free bucket list to resuse reveive post buckets */
id|priv-&gt;i2o_fbl
op_assign
id|kmalloc
c_func
(paren
id|priv-&gt;max_buckets_out
op_star
r_sizeof
(paren
r_struct
id|sk_buff
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;i2o_fbl
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|priv-&gt;i2o_fbl_tail
op_assign
op_minus
l_int|1
suffix:semicolon
id|priv-&gt;send_active
op_assign
l_int|0
suffix:semicolon
id|i2o_set_ddm_parameters
c_func
(paren
id|dev
)paren
suffix:semicolon
id|i2o_lan_receive_post
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_close(): End the transfering.&n; */
DECL|function|i2o_lan_close
r_static
r_int
id|i2o_lan_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|i2o_lan_suspend
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_event_register
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_context
comma
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to clear the event mask.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|priv-&gt;i2o_fbl_tail
op_ge
l_int|0
)paren
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;i2o_fbl
(braket
id|priv-&gt;i2o_fbl_tail
op_decrement
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|priv-&gt;i2o_fbl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_release_device
c_func
(paren
id|i2o_dev
comma
op_amp
id|i2o_lan_handler
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to unclaim I2O LAN device &quot;
l_string|&quot;(tid=%d).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i2o_dev-&gt;lct_data.tid
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_tx_timeout(): Tx timeout handler.&n; */
DECL|function|i2o_lan_tx_timeout
r_static
r_void
id|i2o_lan_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_batch_send(): Send packets in batch. &n; * Both i2o_lan_sdu_send and i2o_lan_packet_send use this.&n; */
DECL|function|i2o_lan_batch_send
r_static
r_void
id|i2o_lan_batch_send
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|priv-&gt;i2o_dev-&gt;controller
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_count
op_ne
l_int|0
)paren
(brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|iop
comma
id|priv-&gt;m
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d packets sent.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;tx_count
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
)brace
id|priv-&gt;send_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_FC
multiline_comment|/*&n; * i2o_lan_sdu_send(): Send a packet, MAC header added by the DDM.&n; * Must be supported by Fibre Channel, optional for Ethernet/802.3,&n; * Token Ring, FDDI&n; */
DECL|function|i2o_lan_sdu_send
r_static
r_int
id|i2o_lan_sdu_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
id|u32
id|m
comma
op_star
id|msg
suffix:semicolon
id|u32
op_star
id|sgl_elem
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_increment
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * If tx_batch_mode = 0x00 forced to immediate mode&n;&t; * If tx_batch_mode = 0x01 forced to batch mode&n;&t; * If tx_batch_mode = 0x10 switch automatically, current mode immediate&n;&t; * If tx_batch_mode = 0x11 switch automatically, current mode batch&n;&t; *&t;If gap between two packets is &gt; 0 ticks, switch to immediate&n;&t; */
r_if
c_cond
(paren
id|priv-&gt;tx_batch_mode
op_rshift
l_int|1
)paren
singleline_comment|// switch automatically
id|priv-&gt;tx_batch_mode
op_assign
id|tickssofar
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_count
op_eq
l_int|1
)paren
(brace
id|m
op_assign
id|I2O_POST_READ32
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|iop-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|priv-&gt;m
op_assign
id|m
suffix:semicolon
id|__raw_writel
c_func
(paren
id|NINE_WORD_MSG_SIZE
op_or
l_int|1
op_lshift
l_int|12
op_or
id|SGL_OFFSET_4
comma
id|msg
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|LAN_PACKET_SEND
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
comma
id|msg
op_plus
l_int|1
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_send_context
comma
id|msg
op_plus
l_int|2
)paren
suffix:semicolon
singleline_comment|// InitiatorContext
id|__raw_writel
c_func
(paren
l_int|1
op_lshift
l_int|30
op_or
l_int|1
op_lshift
l_int|3
comma
id|msg
op_plus
l_int|3
)paren
suffix:semicolon
singleline_comment|// TransmitControlWord
id|__raw_writel
c_func
(paren
l_int|0xD7000000
op_or
id|skb-&gt;len
comma
id|msg
op_plus
l_int|4
)paren
suffix:semicolon
singleline_comment|// MAC hdr included
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb
comma
id|msg
op_plus
l_int|5
)paren
suffix:semicolon
singleline_comment|// TransactionContext
id|__raw_writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
id|msg
op_plus
l_int|6
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb-&gt;mac.raw
comma
id|msg
op_plus
l_int|7
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb-&gt;mac.raw
op_plus
l_int|4
comma
id|msg
op_plus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;tx_batch_mode
op_amp
l_int|0x01
)paren
op_logical_and
op_logical_neg
id|priv-&gt;send_active
)paren
(brace
id|priv-&gt;send_active
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|priv-&gt;i2o_batch_send_task
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Add new SGL element to the previous message frame */
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|iop-&gt;mem_offset
op_plus
id|priv-&gt;m
)paren
suffix:semicolon
id|sgl_elem
op_assign
op_amp
id|msg
(braket
id|priv-&gt;tx_count
op_star
l_int|5
op_plus
l_int|1
)braket
suffix:semicolon
id|__raw_writel
c_func
(paren
id|I2O_MESSAGE_SIZE
c_func
(paren
(paren
id|__raw_readl
c_func
(paren
id|msg
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|5
)paren
op_or
l_int|1
op_lshift
l_int|12
op_or
id|SGL_OFFSET_4
comma
id|msg
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|__raw_readl
c_func
(paren
id|sgl_elem
op_minus
l_int|5
)paren
op_amp
l_int|0x7FFFFFFF
comma
id|sgl_elem
op_minus
l_int|5
)paren
suffix:semicolon
multiline_comment|/* clear LE flag */
id|__raw_writel
c_func
(paren
l_int|0xD5000000
op_or
id|skb-&gt;len
comma
id|sgl_elem
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb
comma
id|sgl_elem
op_plus
l_int|1
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
id|sgl_elem
op_plus
l_int|2
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|skb-&gt;mac.raw
)paren
comma
id|sgl_elem
op_plus
l_int|3
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|skb-&gt;mac.raw
)paren
op_plus
l_int|1
comma
id|sgl_elem
op_plus
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* If tx not in batch mode or frame is full, send immediatelly */
r_if
c_cond
(paren
op_logical_neg
(paren
id|priv-&gt;tx_batch_mode
op_amp
l_int|0x01
)paren
op_logical_or
id|priv-&gt;tx_count
op_eq
id|priv-&gt;sgl_max
)paren
(brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|iop
comma
id|priv-&gt;m
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d packets sent.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;tx_count
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If DDMs TxMaxPktOut reached, stop queueing layer to send more */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
op_ge
id|priv-&gt;tx_max_out
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif CONFIG_NET_FC
multiline_comment|/*&n; * i2o_lan_packet_send(): Send a packet as is, including the MAC header.&n; *&n; * Must be supported by Ethernet/802.3, Token Ring, FDDI, optional for&n; * Fibre Channel&n; */
DECL|function|i2o_lan_packet_send
r_static
r_int
id|i2o_lan_packet_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
r_int
id|tickssofar
op_assign
id|jiffies
op_minus
id|dev-&gt;trans_start
suffix:semicolon
id|u32
id|m
comma
op_star
id|msg
suffix:semicolon
id|u32
op_star
id|sgl_elem
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_increment
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * If tx_batch_mode = 0x00 forced to immediate mode&n;&t; * If tx_batch_mode = 0x01 forced to batch mode&n;&t; * If tx_batch_mode = 0x10 switch automatically, current mode immediate&n;&t; * If tx_batch_mode = 0x11 switch automatically, current mode batch&n;&t; *&t;If gap between two packets is &gt; 0 ticks, switch to immediate&n;&t; */
r_if
c_cond
(paren
id|priv-&gt;tx_batch_mode
op_rshift
l_int|1
)paren
singleline_comment|// switch automatically
id|priv-&gt;tx_batch_mode
op_assign
id|tickssofar
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;tx_count
op_eq
l_int|1
)paren
(brace
id|m
op_assign
id|I2O_POST_READ32
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|iop-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|priv-&gt;m
op_assign
id|m
suffix:semicolon
id|__raw_writel
c_func
(paren
id|SEVEN_WORD_MSG_SIZE
op_or
l_int|1
op_lshift
l_int|12
op_or
id|SGL_OFFSET_4
comma
id|msg
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|LAN_PACKET_SEND
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
comma
id|msg
op_plus
l_int|1
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_send_context
comma
id|msg
op_plus
l_int|2
)paren
suffix:semicolon
singleline_comment|// InitiatorContext
id|__raw_writel
c_func
(paren
l_int|1
op_lshift
l_int|30
op_or
l_int|1
op_lshift
l_int|3
comma
id|msg
op_plus
l_int|3
)paren
suffix:semicolon
singleline_comment|// TransmitControlWord
singleline_comment|// bit 30: reply as soon as transmission attempt is complete
singleline_comment|// bit 3: Supress CRC generation
id|__raw_writel
c_func
(paren
l_int|0xD5000000
op_or
id|skb-&gt;len
comma
id|msg
op_plus
l_int|4
)paren
suffix:semicolon
singleline_comment|// MAC hdr included
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb
comma
id|msg
op_plus
l_int|5
)paren
suffix:semicolon
singleline_comment|// TransactionContext
id|__raw_writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
id|msg
op_plus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;tx_batch_mode
op_amp
l_int|0x01
)paren
op_logical_and
op_logical_neg
id|priv-&gt;send_active
)paren
(brace
id|priv-&gt;send_active
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|priv-&gt;i2o_batch_send_task
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Add new SGL element to the previous message frame */
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|iop-&gt;mem_offset
op_plus
id|priv-&gt;m
)paren
suffix:semicolon
id|sgl_elem
op_assign
op_amp
id|msg
(braket
id|priv-&gt;tx_count
op_star
l_int|3
op_plus
l_int|1
)braket
suffix:semicolon
id|__raw_writel
c_func
(paren
id|I2O_MESSAGE_SIZE
c_func
(paren
(paren
id|__raw_readl
c_func
(paren
id|msg
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|3
)paren
op_or
l_int|1
op_lshift
l_int|12
op_or
id|SGL_OFFSET_4
comma
id|msg
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|__raw_readl
c_func
(paren
id|sgl_elem
op_minus
l_int|3
)paren
op_amp
l_int|0x7FFFFFFF
comma
id|sgl_elem
op_minus
l_int|3
)paren
suffix:semicolon
multiline_comment|/* clear LE flag */
id|__raw_writel
c_func
(paren
l_int|0xD5000000
op_or
id|skb-&gt;len
comma
id|sgl_elem
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
(paren
id|u32
)paren
id|skb
comma
id|sgl_elem
op_plus
l_int|1
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
comma
id|sgl_elem
op_plus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* If tx is in immediate mode or frame is full, send now */
r_if
c_cond
(paren
op_logical_neg
(paren
id|priv-&gt;tx_batch_mode
op_amp
l_int|0x01
)paren
op_logical_or
id|priv-&gt;tx_count
op_eq
id|priv-&gt;sgl_max
)paren
(brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|iop
comma
id|priv-&gt;m
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d packets sent.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;tx_count
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If DDMs TxMaxPktOut reached, stop queueing layer to send more */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;tx_out
)paren
op_ge
id|priv-&gt;tx_max_out
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;tx_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_get_stats(): Fill in the statistics.&n; */
DECL|function|i2o_lan_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|i2o_lan_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u64
id|val64
(braket
l_int|16
)braket
suffix:semicolon
id|u64
id|supported_group
(braket
l_int|4
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0100
comma
op_minus
l_int|1
comma
id|val64
comma
r_sizeof
(paren
id|val64
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LAN_HISTORICAL_STATS queried.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_assign
id|val64
(braket
l_int|0
)braket
suffix:semicolon
id|priv-&gt;stats.tx_bytes
op_assign
id|val64
(braket
l_int|1
)braket
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_assign
id|val64
(braket
l_int|2
)braket
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_assign
id|val64
(braket
l_int|3
)braket
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_assign
id|val64
(braket
l_int|4
)braket
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_assign
id|val64
(braket
l_int|5
)braket
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_assign
id|val64
(braket
l_int|6
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0180
comma
op_minus
l_int|1
comma
op_amp
id|supported_group
comma
r_sizeof
(paren
id|supported_group
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_SUPPORTED_OPTIONAL_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|supported_group
(braket
l_int|2
)braket
)paren
(brace
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0183
comma
op_minus
l_int|1
comma
id|val64
comma
r_sizeof
(paren
id|val64
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_OPTIONAL_RX_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LAN_OPTIONAL_RX_HISTORICAL_STATS queried.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.multicast
op_assign
id|val64
(braket
l_int|4
)braket
suffix:semicolon
id|priv-&gt;stats.rx_length_errors
op_assign
id|val64
(braket
l_int|10
)braket
suffix:semicolon
id|priv-&gt;stats.rx_crc_errors
op_assign
id|val64
(braket
l_int|0
)braket
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
op_eq
id|I2O_LAN_ETHERNET
)paren
(brace
id|u64
id|supported_stats
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0200
comma
op_minus
l_int|1
comma
id|val64
comma
r_sizeof
(paren
id|val64
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_802_3_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LAN_802_3_HISTORICAL_STATS queried.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.transmit_collision
op_assign
id|val64
(braket
l_int|1
)braket
op_plus
id|val64
(braket
l_int|2
)braket
suffix:semicolon
id|priv-&gt;stats.rx_frame_errors
op_assign
id|val64
(braket
l_int|0
)braket
suffix:semicolon
id|priv-&gt;stats.tx_carrier_errors
op_assign
id|val64
(braket
l_int|6
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0280
comma
op_minus
l_int|1
comma
op_amp
id|supported_stats
comma
r_sizeof
(paren
id|supported_stats
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_SUPPORTED_802_3_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|supported_stats
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0281
comma
op_minus
l_int|1
comma
id|val64
comma
r_sizeof
(paren
id|val64
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_OPTIONAL_802_3_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LAN_OPTIONAL_802_3_HISTORICAL_STATS queried.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|supported_stats
op_amp
l_int|0x1
)paren
id|priv-&gt;stats.rx_over_errors
op_assign
id|val64
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|supported_stats
op_amp
l_int|0x4
)paren
id|priv-&gt;stats.tx_heartbeat_errors
op_assign
id|val64
(braket
l_int|2
)braket
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef CONFIG_TR
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
op_eq
id|I2O_LAN_TR
)paren
(brace
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0300
comma
op_minus
l_int|1
comma
id|val64
comma
r_sizeof
(paren
id|val64
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_802_5_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
r_struct
id|tr_statistics
op_star
id|stats
op_assign
(paren
r_struct
id|tr_statistics
op_star
)paren
op_amp
id|priv-&gt;stats
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LAN_802_5_HISTORICAL_STATS queried.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;line_errors
op_assign
id|val64
(braket
l_int|0
)braket
suffix:semicolon
id|stats-&gt;internal_errors
op_assign
id|val64
(braket
l_int|7
)braket
suffix:semicolon
id|stats-&gt;burst_errors
op_assign
id|val64
(braket
l_int|4
)braket
suffix:semicolon
id|stats-&gt;A_C_errors
op_assign
id|val64
(braket
l_int|2
)braket
suffix:semicolon
id|stats-&gt;abort_delimiters
op_assign
id|val64
(braket
l_int|3
)braket
suffix:semicolon
id|stats-&gt;lost_frames
op_assign
id|val64
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* stats-&gt;recv_congest_count&t;= ?;  FIXME ??*/
id|stats-&gt;frame_copied_errors
op_assign
id|val64
(braket
l_int|5
)braket
suffix:semicolon
id|stats-&gt;frequency_errors
op_assign
id|val64
(braket
l_int|6
)braket
suffix:semicolon
id|stats-&gt;token_errors
op_assign
id|val64
(braket
l_int|9
)braket
suffix:semicolon
)brace
multiline_comment|/* Token Ring optional stats not yet defined */
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
op_eq
id|I2O_LAN_FDDI
)paren
(brace
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|iop
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0400
comma
op_minus
l_int|1
comma
id|val64
comma
r_sizeof
(paren
id|val64
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to query LAN_FDDI_HISTORICAL_STATS.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: LAN_FDDI_HISTORICAL_STATS queried.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|priv-&gt;stats.smt_cf_state
op_assign
id|val64
(braket
l_int|0
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;stats.mac_upstream_nbr
comma
op_amp
id|val64
(braket
l_int|1
)braket
comma
id|FDDI_K_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;stats.mac_downstream_nbr
comma
op_amp
id|val64
(braket
l_int|2
)braket
comma
id|FDDI_K_ALEN
)paren
suffix:semicolon
id|priv-&gt;stats.mac_error_cts
op_assign
id|val64
(braket
l_int|3
)braket
suffix:semicolon
id|priv-&gt;stats.mac_lost_cts
op_assign
id|val64
(braket
l_int|4
)braket
suffix:semicolon
id|priv-&gt;stats.mac_rmt_state
op_assign
id|val64
(braket
l_int|5
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;stats.port_lct_fail_cts
comma
op_amp
id|val64
(braket
l_int|6
)braket
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;stats.port_lem_reject_cts
comma
op_amp
id|val64
(braket
l_int|7
)braket
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;stats.port_lem_cts
comma
op_amp
id|val64
(braket
l_int|8
)braket
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;stats.port_pcm_state
comma
op_amp
id|val64
(braket
l_int|9
)braket
comma
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* FDDI optional stats not yet defined */
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FC
multiline_comment|/* Fibre Channel Statistics not yet defined in 1.53 nor 2.0 */
macro_line|#endif
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* &n; * i2o_lan_set_mc_filter(): Post a request to set multicast filter.&n; */
DECL|function|i2o_lan_set_mc_filter
r_int
id|i2o_lan_set_mc_filter
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|filter_mask
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
id|u32
id|msg
(braket
l_int|10
)braket
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|TEN_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_SET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0x0001
op_lshift
l_int|16
op_or
l_int|3
suffix:semicolon
singleline_comment|// TransactionContext: group&amp;field
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0xCC000000
op_or
l_int|16
suffix:semicolon
singleline_comment|// Immediate data SGL
id|msg
(braket
l_int|6
)braket
op_assign
l_int|1
suffix:semicolon
singleline_comment|// OperationCount
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0x0001
op_lshift
l_int|16
op_or
id|I2O_PARAMS_FIELD_SET
suffix:semicolon
singleline_comment|// Group, Operation
id|msg
(braket
l_int|8
)braket
op_assign
l_int|3
op_lshift
l_int|16
op_or
l_int|1
suffix:semicolon
singleline_comment|// FieldIndex, FieldCount 
id|msg
(braket
l_int|9
)braket
op_assign
id|filter_mask
suffix:semicolon
singleline_comment|// Value
r_return
id|i2o_post_this
c_func
(paren
id|iop
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * i2o_lan_set_mc_table(): Post a request to set LAN_MULTICAST_MAC_ADDRESS table.&n; */
DECL|function|i2o_lan_set_mc_table
r_int
id|i2o_lan_set_mc_table
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_dev-&gt;controller
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mc
suffix:semicolon
id|u32
id|msg
(braket
l_int|10
op_plus
l_int|2
op_star
id|dev-&gt;mc_count
)braket
suffix:semicolon
id|u8
op_star
id|work8
op_assign
(paren
id|u8
op_star
)paren
(paren
id|msg
op_plus
l_int|10
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|I2O_MESSAGE_SIZE
c_func
(paren
l_int|10
op_plus
l_int|2
op_star
id|dev-&gt;mc_count
)paren
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_SET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data.tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|priv-&gt;unit
op_lshift
l_int|16
op_or
id|lan_context
suffix:semicolon
singleline_comment|// InitiatorContext
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0x0002
op_lshift
l_int|16
op_or
(paren
id|u16
)paren
op_minus
l_int|1
suffix:semicolon
singleline_comment|// TransactionContext
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// OperationFlags
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0xCC000000
op_or
(paren
l_int|16
op_plus
l_int|8
op_star
id|dev-&gt;mc_count
)paren
suffix:semicolon
singleline_comment|// Immediate data SGL
id|msg
(braket
l_int|6
)braket
op_assign
l_int|2
suffix:semicolon
singleline_comment|// OperationCount
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0x0002
op_lshift
l_int|16
op_or
id|I2O_PARAMS_TABLE_CLEAR
suffix:semicolon
singleline_comment|// Group, Operation
id|msg
(braket
l_int|8
)braket
op_assign
l_int|0x0002
op_lshift
l_int|16
op_or
id|I2O_PARAMS_ROW_ADD
suffix:semicolon
singleline_comment|// Group, Operation
id|msg
(braket
l_int|9
)braket
op_assign
id|dev-&gt;mc_count
op_lshift
l_int|16
op_or
(paren
id|u16
)paren
op_minus
l_int|1
suffix:semicolon
singleline_comment|// RowCount, FieldCount
r_for
c_loop
(paren
id|mc
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mc
suffix:semicolon
id|mc
op_assign
id|mc-&gt;next
comma
id|work8
op_add_assign
l_int|8
)paren
(brace
id|memset
c_func
(paren
id|work8
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|work8
comma
id|mc-&gt;dmi_addr
comma
id|mc-&gt;dmi_addrlen
)paren
suffix:semicolon
singleline_comment|// Values
)brace
r_return
id|i2o_post_this
c_func
(paren
id|iop
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_set_multicast_list(): Enable a network device to receive packets&n; *      not send to the protocol address.&n; */
DECL|function|i2o_lan_set_multicast_list
r_static
r_void
id|i2o_lan_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|filter_mask
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|filter_mask
op_assign
l_int|0x00000002
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling promiscuous mode...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
id|dev-&gt;mc_count
OG
id|priv-&gt;max_size_mc_table
)paren
(brace
id|filter_mask
op_assign
l_int|0x00000004
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling all multicast mode...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
id|filter_mask
op_assign
l_int|0x00000000
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling multicast mode...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_lan_set_mc_table
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to send MAC table.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|filter_mask
op_assign
l_int|0x00000300
suffix:semicolon
singleline_comment|// Broadcast, Multicast disabled
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling unicast mode...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Finally copy new FilterMask to DDM */
r_if
c_cond
(paren
id|i2o_lan_set_mc_filter
c_func
(paren
id|dev
comma
id|filter_mask
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unable to send MAC FilterMask.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * i2o_lan_change_mtu(): Change maximum transfer unit size.&n; */
DECL|function|i2o_lan_change_mtu
r_static
r_int
id|i2o_lan_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
id|u32
id|max_pkt_size
suffix:semicolon
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|i2o_dev-&gt;controller
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0000
comma
l_int|6
comma
op_amp
id|max_pkt_size
comma
l_int|4
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
template_param
l_int|9000
op_logical_or
id|new_mtu
OG
id|max_pkt_size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
id|i2o_lan_suspend
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// to SUSPENDED state, return buckets
r_while
c_loop
(paren
id|priv-&gt;i2o_fbl_tail
op_ge
l_int|0
)paren
singleline_comment|// free buffered buckets
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;i2o_fbl
(braket
id|priv-&gt;i2o_fbl_tail
op_decrement
)braket
)paren
suffix:semicolon
id|i2o_lan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// to OPERATIONAL state
id|i2o_set_ddm_parameters
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// reset some parameters
id|i2o_lan_receive_post
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// post new buckets (new size)
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Functions to initialize I2O LAN OSM:&n;======================================*/
multiline_comment|/*&n; * i2o_lan_register_device(): Register LAN class device to kernel.&n; */
DECL|function|i2o_lan_register_device
r_struct
id|net_device
op_star
id|i2o_lan_register_device
c_func
(paren
r_struct
id|i2o_device
op_star
id|i2o_dev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
l_int|NULL
suffix:semicolon
id|u8
id|hw_addr
(braket
l_int|8
)braket
suffix:semicolon
id|u32
id|tx_max_out
op_assign
l_int|0
suffix:semicolon
r_int
r_int
(paren
op_star
id|type_trans
)paren
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_void
(paren
op_star
id|unregister_dev
)paren
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
)paren
(brace
r_case
id|I2O_LAN_ETHERNET
suffix:colon
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|i2o_lan_local
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|type_trans
op_assign
id|eth_type_trans
suffix:semicolon
id|unregister_dev
op_assign
id|unregister_netdev
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ANYLAN
r_case
id|I2O_LAN_100VG
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_lan: 100base VG not yet supported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
r_case
id|I2O_LAN_TR
suffix:colon
id|dev
op_assign
id|init_trdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|i2o_lan_local
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|type_trans
op_assign
id|tr_type_trans
suffix:semicolon
id|unregister_dev
op_assign
id|unregister_trdev
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
r_case
id|I2O_LAN_FDDI
suffix:colon
(brace
r_int
id|size
op_assign
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
r_sizeof
(paren
r_struct
id|i2o_lan_local
)paren
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_alloc_name
c_func
(paren
id|dev
comma
l_string|&quot;fddi%d&quot;
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o_lan: Too many FDDI devices.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|type_trans
op_assign
id|fddi_type_trans
suffix:semicolon
id|unregister_dev
op_assign
(paren
r_void
op_star
)paren
id|unregister_netdevice
suffix:semicolon
id|fddi_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FC
r_case
id|I2O_LAN_FIBRE_CHANNEL
suffix:colon
id|dev
op_assign
id|init_fcdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|i2o_lan_local
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|type_trans
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* FIXME: Move fc_type_trans() from drivers/net/fc/iph5526.c to net/802/fc.c&n; * and export it in include/linux/fcdevice.h&n; *&t;&t;type_trans = fc_type_trans;&n; */
id|unregister_dev
op_assign
(paren
r_void
op_star
)paren
id|unregister_fcdev
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|I2O_LAN_UNKNOWN
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_lan: LAN type 0x%04x not supported.&bslash;n&quot;
comma
id|i2o_dev-&gt;lct_data.sub_class
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|priv-&gt;i2o_dev
op_assign
id|i2o_dev
suffix:semicolon
id|priv-&gt;type_trans
op_assign
id|type_trans
suffix:semicolon
id|priv-&gt;sgl_max
op_assign
(paren
id|i2o_dev-&gt;controller-&gt;status_block-&gt;inbound_frame_size
op_minus
l_int|4
)paren
op_div
l_int|3
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|priv-&gt;buckets_out
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set default values for user configurable parameters */
multiline_comment|/* Private values are changed via /proc file system */
id|priv-&gt;max_buckets_out
op_assign
id|max_buckets_out
suffix:semicolon
id|priv-&gt;bucket_thresh
op_assign
id|bucket_thresh
suffix:semicolon
id|priv-&gt;rx_copybreak
op_assign
id|rx_copybreak
suffix:semicolon
id|priv-&gt;tx_batch_mode
op_assign
id|tx_batch_mode
op_amp
l_int|0x03
suffix:semicolon
id|priv-&gt;i2o_event_mask
op_assign
id|i2o_event_mask
suffix:semicolon
id|priv-&gt;tx_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|priv-&gt;fbl_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|unit
op_increment
suffix:semicolon
id|i2o_landevs
(braket
id|unit
)braket
op_assign
id|dev
suffix:semicolon
id|priv-&gt;unit
op_assign
id|unit
suffix:semicolon
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|i2o_dev-&gt;controller
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0001
comma
l_int|0
comma
op_amp
id|hw_addr
comma
r_sizeof
(paren
id|hw_addr
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to query hardware address.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|unit
op_decrement
suffix:semicolon
id|unregister_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: hwaddr = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|hw_addr
(braket
l_int|0
)braket
comma
id|hw_addr
(braket
l_int|1
)braket
comma
id|hw_addr
(braket
l_int|2
)braket
comma
id|hw_addr
(braket
l_int|3
)braket
comma
id|hw_addr
(braket
l_int|4
)braket
comma
id|hw_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|6
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|hw_addr
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_query_scalar
c_func
(paren
id|i2o_dev-&gt;controller
comma
id|i2o_dev-&gt;lct_data.tid
comma
l_int|0x0007
comma
l_int|2
comma
op_amp
id|tx_max_out
comma
r_sizeof
(paren
id|tx_max_out
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to query max TX queue.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|unit
op_decrement
suffix:semicolon
id|unregister_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Max TX Outstanding = %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_max_out
)paren
suffix:semicolon
id|priv-&gt;tx_max_out
op_assign
id|tx_max_out
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|priv-&gt;tx_out
comma
l_int|0
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|priv-&gt;i2o_batch_send_task.list
)paren
suffix:semicolon
id|priv-&gt;i2o_batch_send_task.sync
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;i2o_batch_send_task.routine
op_assign
(paren
r_void
op_star
)paren
id|i2o_lan_batch_send
suffix:semicolon
id|priv-&gt;i2o_batch_send_task.data
op_assign
(paren
r_void
op_star
)paren
id|dev
suffix:semicolon
id|dev-&gt;open
op_assign
id|i2o_lan_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|i2o_lan_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|i2o_lan_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|i2o_lan_set_multicast_list
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|i2o_lan_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|I2O_LAN_TX_TIMEOUT
suffix:semicolon
macro_line|#ifdef CONFIG_NET_FC
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
op_eq
id|I2O_LAN_FIBRE_CHANNEL
)paren
id|dev-&gt;hard_start_xmit
op_assign
id|i2o_lan_sdu_send
suffix:semicolon
r_else
macro_line|#endif
id|dev-&gt;hard_start_xmit
op_assign
id|i2o_lan_packet_send
suffix:semicolon
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
op_eq
id|I2O_LAN_ETHERNET
)paren
id|dev-&gt;change_mtu
op_assign
id|i2o_lan_change_mtu
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|macro|i2o_lan_init
mdefine_line|#define i2o_lan_init&t;init_module
macro_line|#endif
DECL|function|i2o_lan_init
r_int
id|__init
id|i2o_lan_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;I2O LAN OSM (C) 1999 University of Helsinki.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Module params are used as global defaults for private values */
r_if
c_cond
(paren
id|max_buckets_out
OG
id|I2O_LAN_MAX_BUCKETS_OUT
)paren
id|max_buckets_out
op_assign
id|I2O_LAN_MAX_BUCKETS_OUT
suffix:semicolon
r_if
c_cond
(paren
id|bucket_thresh
OG
id|max_buckets_out
)paren
id|bucket_thresh
op_assign
id|max_buckets_out
suffix:semicolon
multiline_comment|/* Install handlers for incoming replies */
r_if
c_cond
(paren
id|i2o_install_handler
c_func
(paren
op_amp
id|i2o_lan_send_handler
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_lan: Unable to register I2O LAN OSM.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|lan_send_context
op_assign
id|i2o_lan_send_handler.context
suffix:semicolon
r_if
c_cond
(paren
id|i2o_install_handler
c_func
(paren
op_amp
id|i2o_lan_receive_handler
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_lan: Unable to register I2O LAN OSM.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|lan_receive_context
op_assign
id|i2o_lan_receive_handler.context
suffix:semicolon
r_if
c_cond
(paren
id|i2o_install_handler
c_func
(paren
op_amp
id|i2o_lan_handler
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_lan: Unable to register I2O LAN OSM.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|lan_context
op_assign
id|i2o_lan_handler.context
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_LAN_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|i2o_landevs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_I2O_CONTROLLERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|i2o_controller
op_star
id|iop
op_assign
id|i2o_find_controller
c_func
(paren
id|i
)paren
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
suffix:semicolon
r_if
c_cond
(paren
id|iop
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|i2o_dev
op_assign
id|iop-&gt;devices
suffix:semicolon
id|i2o_dev
op_ne
l_int|NULL
suffix:semicolon
id|i2o_dev
op_assign
id|i2o_dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.class_id
op_ne
id|I2O_CLASS_LAN
)paren
r_continue
suffix:semicolon
multiline_comment|/* Make sure device not already claimed by an ISM */
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.user_tid
op_ne
l_int|0xFFF
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|unit
op_eq
id|MAX_LAN_CARDS
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|iop
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o_lan: Too many I2O LAN devices.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev
op_assign
id|i2o_lan_register_device
c_func
(paren
id|i2o_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_lan: Unable to register I2O LAN device 0x%04x.&bslash;n&quot;
comma
id|i2o_dev-&gt;lct_data.sub_class
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: I2O LAN device registered, &quot;
l_string|&quot;subclass = 0x%04x, unit = %d, tid = %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i2o_dev-&gt;lct_data.sub_class
comma
(paren
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|unit
comma
id|i2o_dev-&gt;lct_data.tid
)paren
suffix:semicolon
)brace
id|i2o_unlock_controller
c_func
(paren
id|iop
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%d I2O LAN devices found and registered.&bslash;n&quot;
comma
id|unit
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|unit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|i2o_landevs
(braket
id|i
)braket
suffix:semicolon
r_struct
id|i2o_lan_local
op_star
id|priv
op_assign
(paren
r_struct
id|i2o_lan_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|priv-&gt;i2o_dev
suffix:semicolon
r_switch
c_cond
(paren
id|i2o_dev-&gt;lct_data.sub_class
)paren
(brace
r_case
id|I2O_LAN_ETHERNET
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_FDDI
r_case
id|I2O_LAN_FDDI
suffix:colon
id|unregister_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
r_case
id|I2O_LAN_TR
suffix:colon
id|unregister_trdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_FC
r_case
id|I2O_LAN_FIBRE_CHANNEL
suffix:colon
id|unregister_fcdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Spurious I2O LAN subclass 0x%08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i2o_dev-&gt;lct_data.sub_class
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: I2O LAN device unregistered.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|i2o_remove_handler
c_func
(paren
op_amp
id|i2o_lan_handler
)paren
suffix:semicolon
id|i2o_remove_handler
c_func
(paren
op_amp
id|i2o_lan_send_handler
)paren
suffix:semicolon
id|i2o_remove_handler
c_func
(paren
op_amp
id|i2o_lan_receive_handler
)paren
suffix:semicolon
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;University of Helsinki, Department of Computer Science&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2O Lan OSM&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_buckets_out
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|I2O_LAN_MAX_BUCKETS_OUT
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_buckets_out
comma
l_string|&quot;Total number of buckets to post (1-)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|bucket_thresh
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|I2O_LAN_MAX_BUCKETS_OUT
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|bucket_thresh
comma
l_string|&quot;Bucket post threshold (1-)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;1-&quot;
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;Copy breakpoint for copy only small frames (1-)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tx_batch_mode
comma
l_string|&quot;0-2&quot;
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tx_batch_mode
comma
l_string|&quot;0=Send immediatelly, 1=Send in batches, 2=Switch automatically&quot;
)paren
suffix:semicolon
macro_line|#endif
eof
