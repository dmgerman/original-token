multiline_comment|/*&n; * I2O Configuration Interface Driver&n; *&n; * (C) Copyright 1999   Red Hat Software&n; *&t;&n; * Written by Alan Cox, Building Number Three Ltd&n; *&n; * Modified 04/20/1999 by Deepak Saxena&n; *   - Added basic ioctl() support&n; * Modified 06/07/1999 by Deepak Saxena&n; *   - Added software download ioctl (still testing)&n; * Modified 09/10/1999 by Auvo H&#xfffd;kkinen&n; *   - Changes to i2o_cfg_reply(), ioctl_parms()&n; *   - Added ioct_validate()&n; * Modified 09/30/1999 by Taneli V&#xfffd;h&#xfffd;kangas&n; *   - Fixed ioctl_swdl()&n; * Modified 10/04/1999 by Taneli V&#xfffd;h&#xfffd;kangas&n; *   - Changed ioctl_swdl(), implemented ioctl_swul() and ioctl_swdel()&n; * Modified 11/18/199 by Deepak Saxena&n; *   - Added event managmenet support&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|variable|i2o_cfg_context
r_static
r_int
id|i2o_cfg_context
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|page_buf
r_static
r_void
op_star
id|page_buf
suffix:semicolon
DECL|variable|i2o_buffer
r_static
r_void
op_star
id|i2o_buffer
suffix:semicolon
DECL|variable|i2o_config_lock
r_static
id|spinlock_t
id|i2o_config_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|i2o_wait_queue
r_struct
id|wait_queue
op_star
id|i2o_wait_queue
suffix:semicolon
DECL|macro|MODINC
mdefine_line|#define MODINC(x,y) (x = x++ % y)
DECL|struct|i2o_cfg_info
r_struct
id|i2o_cfg_info
(brace
DECL|member|fp
r_struct
id|file
op_star
id|fp
suffix:semicolon
DECL|member|fasync
r_struct
id|fasync_struct
op_star
id|fasync
suffix:semicolon
DECL|member|event_q
r_struct
id|i2o_evt_info
id|event_q
(braket
id|I2O_EVT_Q_LEN
)braket
suffix:semicolon
DECL|member|q_in
id|u16
id|q_in
suffix:semicolon
singleline_comment|// Queue head index
DECL|member|q_out
id|u16
id|q_out
suffix:semicolon
singleline_comment|// Queue tail index
DECL|member|q_len
id|u16
id|q_len
suffix:semicolon
singleline_comment|// Queue length
DECL|member|q_lost
id|u16
id|q_lost
suffix:semicolon
singleline_comment|// Number of lost events
DECL|member|q_id
id|u32
id|q_id
suffix:semicolon
singleline_comment|// Event queue ID...used as tx_context
DECL|member|next
r_struct
id|i2o_cfg_info
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|open_files
r_static
r_struct
id|i2o_cfg_info
op_star
id|open_files
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|i2o_cfg_info_id
r_static
r_int
id|i2o_cfg_info_id
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|ioctl_getiops
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_gethrt
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_getlct
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_parms
c_func
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_html
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_swdl
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_swul
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_swdel
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_validate
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|ioctl_evt_reg
c_func
(paren
r_int
r_int
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|ioctl_evt_get
c_func
(paren
r_int
r_int
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|cfg_fasync
c_func
(paren
r_int
comma
r_struct
id|file
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;This is the callback for any message we have posted. The message itself&n; *&t;will be returned to the message pool when we return from the IRQ&n; *&n; *&t;This runs in irq context so be short and sweet.&n; */
DECL|function|i2o_cfg_reply
r_static
r_void
id|i2o_cfg_reply
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
comma
r_struct
id|i2o_controller
op_star
id|c
comma
r_struct
id|i2o_message
op_star
id|m
)paren
(brace
id|u32
op_star
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|m
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|0
)braket
op_amp
id|MSG_FAIL
)paren
(brace
id|u32
op_star
id|preserved_msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|msg
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_config: IOP failed to process the msg.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Release the preserved msg frame by resubmitting it as a NOP */
id|preserved_msg
(braket
l_int|0
)braket
op_assign
id|THREE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|preserved_msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_NOP
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
l_int|0
suffix:semicolon
id|preserved_msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|msg
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
singleline_comment|// ReqStatus != SUCCESS
id|i2o_report_status
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;i2o_config&quot;
comma
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;function
op_eq
id|I2O_CMD_UTIL_EVT_REGISTER
)paren
(brace
r_struct
id|i2o_cfg_info
op_star
id|inf
suffix:semicolon
r_for
c_loop
(paren
id|inf
op_assign
id|open_files
suffix:semicolon
id|inf
suffix:semicolon
id|inf
op_assign
id|inf-&gt;next
)paren
r_if
c_cond
(paren
id|inf-&gt;q_id
op_eq
id|msg
(braket
l_int|3
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
singleline_comment|//
singleline_comment|// If this is the case, it means that we&squot;re getting
singleline_comment|// events for a file descriptor that&squot;s been close()&squot;d
singleline_comment|// w/o the user unregistering for events first.
singleline_comment|// The code currently assumes that the user will 
singleline_comment|// take care of unregistering for events before closing
singleline_comment|// a file.
singleline_comment|// 
singleline_comment|// TODO: 
singleline_comment|// Should we track event registartion and deregister
singleline_comment|// for events when a file is close()&squot;d so this doesn&squot;t
singleline_comment|// happen? That would get rid of the search through
singleline_comment|// the linked list since file-&gt;private_data could point
singleline_comment|// directly to the i2o_config_info data structure...but
singleline_comment|// it would mean having all sorts of tables to track
singleline_comment|// what each file is registered for...I think the
singleline_comment|// current method is simpler. - DS
singleline_comment|//&t;&t;&t;
r_if
c_cond
(paren
op_logical_neg
id|inf
)paren
(brace
r_return
suffix:semicolon
)brace
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|id.iop
op_assign
id|c-&gt;unit
suffix:semicolon
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|id.tid
op_assign
id|m-&gt;target_tid
suffix:semicolon
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|id.evt_mask
op_assign
id|msg
(braket
l_int|4
)braket
suffix:semicolon
singleline_comment|//
singleline_comment|// Data size = msg size - reply header
singleline_comment|//
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|data_size
op_assign
(paren
id|m-&gt;size
op_minus
l_int|5
)paren
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|data_size
)paren
(brace
id|memcpy
c_func
(paren
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|evt_data
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|msg
op_plus
l_int|5
)paren
comma
id|inf-&gt;event_q
(braket
id|inf-&gt;q_in
)braket
dot
id|data_size
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|i2o_config_lock
)paren
suffix:semicolon
id|MODINC
c_func
(paren
id|inf-&gt;q_in
comma
id|I2O_EVT_Q_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inf-&gt;q_len
op_eq
id|I2O_EVT_Q_LEN
)paren
(brace
id|MODINC
c_func
(paren
id|inf-&gt;q_out
comma
id|I2O_EVT_Q_LEN
)paren
suffix:semicolon
id|inf-&gt;q_lost
op_increment
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Keep I2OEVTGET on another CPU from touching this
id|inf-&gt;q_len
op_increment
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_config_lock
)paren
suffix:semicolon
singleline_comment|//&t;&t;printk(KERN_INFO &quot;File %p w/id %d has %d events&bslash;n&quot;,
singleline_comment|//&t;&t;&t;inf-&gt;fp, inf-&gt;q_id, inf-&gt;q_len);&t;
id|kill_fasync
c_func
(paren
op_amp
id|inf-&gt;fasync
comma
id|SIGIO
comma
id|POLL_IN
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Each of these describes an i2o message handler. They are&n; *&t;multiplexed by the i2o_core code&n; */
DECL|variable|cfg_handler
r_struct
id|i2o_handler
id|cfg_handler
op_assign
(brace
id|i2o_cfg_reply
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;Configuration&quot;
comma
l_int|0
comma
l_int|0xffffffff
singleline_comment|// All classes
)brace
suffix:semicolon
DECL|function|cfg_llseek
r_static
r_int
r_int
id|cfg_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
DECL|function|cfg_write
r_static
id|ssize_t
id|cfg_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config write not yet supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cfg_read
r_static
id|ssize_t
id|cfg_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ptr
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * IOCTL Handler&n; */
DECL|function|cfg_ioctl
r_static
r_int
id|cfg_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|I2OGETIOPS
suffix:colon
id|ret
op_assign
id|ioctl_getiops
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OHRTGET
suffix:colon
id|ret
op_assign
id|ioctl_gethrt
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OLCTGET
suffix:colon
id|ret
op_assign
id|ioctl_getlct
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OPARMSET
suffix:colon
id|ret
op_assign
id|ioctl_parms
c_func
(paren
id|arg
comma
id|I2OPARMSET
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OPARMGET
suffix:colon
id|ret
op_assign
id|ioctl_parms
c_func
(paren
id|arg
comma
id|I2OPARMGET
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OSWDL
suffix:colon
id|ret
op_assign
id|ioctl_swdl
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OSWUL
suffix:colon
id|ret
op_assign
id|ioctl_swul
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OSWDEL
suffix:colon
id|ret
op_assign
id|ioctl_swdel
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OVALIDATE
suffix:colon
id|ret
op_assign
id|ioctl_validate
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OHTML
suffix:colon
id|ret
op_assign
id|ioctl_html
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OEVTREG
suffix:colon
id|ret
op_assign
id|ioctl_evt_reg
c_func
(paren
id|arg
comma
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OEVTGET
suffix:colon
id|ret
op_assign
id|ioctl_evt_get
c_func
(paren
id|arg
comma
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ioctl_getiops
r_int
id|ioctl_getiops
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|u8
op_star
id|user_iop_table
op_assign
(paren
id|u8
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
id|foo
(braket
id|MAX_I2O_CONTROLLERS
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|user_iop_table
comma
id|MAX_I2O_CONTROLLERS
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_I2O_CONTROLLERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
(brace
id|foo
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
r_else
(brace
id|foo
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|__copy_to_user
c_func
(paren
id|user_iop_table
comma
id|foo
comma
id|MAX_I2O_CONTROLLERS
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioctl_gethrt
r_int
id|ioctl_gethrt
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_hrtlct
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
id|kcmd
suffix:semicolon
id|i2o_hrt
op_star
id|hrt
suffix:semicolon
r_int
id|len
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_cmd_hrtlct
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kcmd.resbuf
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|hrt
op_assign
(paren
id|i2o_hrt
op_star
)paren
id|c-&gt;hrt
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|len
op_assign
l_int|8
op_plus
(paren
(paren
id|hrt-&gt;entry_len
op_star
id|hrt-&gt;num_entries
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* We did a get user...so assuming mem is ok...is this bad? */
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
(brace
id|ret
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kcmd.resbuf
comma
(paren
r_void
op_star
)paren
id|hrt
comma
id|len
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ioctl_getlct
r_int
id|ioctl_getlct
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_hrtlct
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
id|kcmd
suffix:semicolon
id|i2o_lct
op_star
id|lct
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_cmd_hrtlct
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kcmd.resbuf
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|lct
op_assign
(paren
id|i2o_lct
op_star
)paren
id|c-&gt;lct
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|len
op_assign
(paren
r_int
r_int
)paren
id|lct-&gt;table_size
op_lshift
l_int|2
suffix:semicolon
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
(brace
id|ret
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kcmd.resbuf
comma
(paren
r_void
op_star
)paren
id|lct
comma
id|len
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ioctl_parms
r_static
r_int
id|ioctl_parms
c_func
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|type
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_cmd_psetget
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_psetget
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_cmd_psetget
id|kcmd
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
id|u8
op_star
id|ops
suffix:semicolon
id|u8
op_star
id|res
suffix:semicolon
r_int
id|len
suffix:semicolon
id|u32
id|i2o_cmd
op_assign
(paren
id|type
op_eq
id|I2OPARMGET
ques
c_cond
id|I2O_CMD_UTIL_PARAMS_GET
suffix:colon
id|I2O_CMD_UTIL_PARAMS_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_cmd_psetget
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|ops
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|kcmd.oplen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ops
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ops
comma
id|kcmd.opbuf
comma
id|kcmd.oplen
)paren
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ops
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * It&squot;s possible to have a _very_ large table&n;&t; * and that the user asks for all of it at once...&n;&t; */
id|res
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
l_int|65536
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ops
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|len
op_assign
id|i2o_issue_params
c_func
(paren
id|i2o_cmd
comma
id|c
comma
id|kcmd.tid
comma
id|ops
comma
id|kcmd.oplen
comma
id|res
comma
l_int|65536
)paren
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
(brace
id|ret
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|cmd-&gt;resbuf
comma
id|res
comma
id|len
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ioctl_html
r_int
id|ioctl_html
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_html
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_html
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_html
id|kcmd
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|u8
op_star
id|res
op_assign
l_int|NULL
suffix:semicolon
r_void
op_star
id|query
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|token
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
id|u32
id|msg
(braket
id|MSG_FRAME_SIZE
op_div
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_html
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: can&squot;t copy html cmd&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: can&squot;t copy html reslen&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|kcmd.resbuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: NULL html buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kcmd.qlen
)paren
multiline_comment|/* Check for post data */
(brace
id|query
op_assign
id|kmalloc
c_func
(paren
id|kcmd.qlen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|query
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|query
comma
id|kcmd.qbuf
comma
id|kcmd.qlen
)paren
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: could not get query&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|query
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|res
op_assign
id|kmalloc
c_func
(paren
l_int|65536
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|msg
(braket
l_int|1
)braket
op_assign
(paren
id|I2O_CMD_UTIL_CONFIG_DIALOG
op_lshift
l_int|24
)paren
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|kcmd.tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|i2o_cfg_context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
id|kcmd.page
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0xD0000000
op_or
l_int|65536
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kcmd.qlen
)paren
(brace
multiline_comment|/* Check for post data */
id|msg
(braket
l_int|0
)braket
op_assign
id|SEVEN_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
)brace
r_else
(brace
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x50000000
op_or
l_int|65536
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD4000000
op_or
(paren
id|kcmd.qlen
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|query
)paren
suffix:semicolon
)brace
id|token
op_assign
id|i2o_post_wait
c_func
(paren
id|c
comma
id|msg
comma
l_int|9
op_star
l_int|4
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;token = %#10x&bslash;n&quot;
comma
id|token
)paren
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kcmd.qlen
)paren
(brace
id|kfree
c_func
(paren
id|query
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|res
comma
l_int|65536
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kcmd.resbuf
comma
id|res
comma
id|len
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kcmd.qlen
)paren
(brace
id|kfree
c_func
(paren
id|query
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ioctl_swdl
r_int
id|ioctl_swdl
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_sw_xfer
id|kxfer
suffix:semicolon
r_struct
id|i2o_sw_xfer
op_star
id|pxfer
op_assign
(paren
r_struct
id|i2o_sw_xfer
op_star
)paren
id|arg
suffix:semicolon
r_int
r_char
id|maxfrag
op_assign
l_int|0
comma
id|curfrag
op_assign
l_int|1
suffix:semicolon
r_int
r_char
op_star
id|buffer
suffix:semicolon
id|u32
id|msg
(braket
l_int|9
)braket
suffix:semicolon
r_int
r_int
id|status
op_assign
l_int|0
comma
id|swlen
op_assign
l_int|0
comma
id|fragsize
op_assign
l_int|8192
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kxfer
comma
id|pxfer
comma
r_sizeof
(paren
r_struct
id|i2o_sw_xfer
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|swlen
comma
id|kxfer.swlen
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|maxfrag
comma
id|kxfer.maxfrag
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|curfrag
comma
id|kxfer.curfrag
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curfrag
op_eq
id|maxfrag
)paren
(brace
id|fragsize
op_assign
id|swlen
op_minus
(paren
id|maxfrag
op_minus
l_int|1
)paren
op_star
l_int|8192
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|kxfer.buf
op_logical_or
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|kxfer.buf
comma
id|fragsize
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kxfer.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|fragsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|__copy_from_user
c_func
(paren
id|buffer
comma
id|kxfer.buf
comma
id|fragsize
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_7
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SW_DOWNLOAD
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
id|cfg_handler.context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
(paren
(paren
id|u32
)paren
id|kxfer.flags
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|kxfer.sw_type
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|maxfrag
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|curfrag
)paren
)paren
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
id|swlen
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|kxfer.sw_id
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
(paren
l_int|0xD0000000
op_or
id|fragsize
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
singleline_comment|//&t;printk(&quot;i2o_config: swdl frag %d/%d (size %d)&bslash;n&quot;, curfrag, maxfrag, fragsize);
id|status
op_assign
id|i2o_post_wait
c_func
(paren
id|c
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|60
)paren
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
singleline_comment|// it fails if you try and send frags out of order
singleline_comment|// and for some yet unknown reasons too
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: swdl failed, DetailedStatus = %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioctl_swul
r_int
id|ioctl_swul
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_sw_xfer
id|kxfer
suffix:semicolon
r_struct
id|i2o_sw_xfer
op_star
id|pxfer
op_assign
(paren
r_struct
id|i2o_sw_xfer
op_star
)paren
id|arg
suffix:semicolon
r_int
r_char
id|maxfrag
op_assign
l_int|0
comma
id|curfrag
op_assign
l_int|1
suffix:semicolon
r_int
r_char
op_star
id|buffer
suffix:semicolon
id|u32
id|msg
(braket
l_int|9
)braket
suffix:semicolon
r_int
r_int
id|status
op_assign
l_int|0
comma
id|swlen
op_assign
l_int|0
comma
id|fragsize
op_assign
l_int|8192
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kxfer
comma
id|pxfer
comma
r_sizeof
(paren
r_struct
id|i2o_sw_xfer
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|swlen
comma
id|kxfer.swlen
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|maxfrag
comma
id|kxfer.maxfrag
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|curfrag
comma
id|kxfer.curfrag
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curfrag
op_eq
id|maxfrag
)paren
(brace
id|fragsize
op_assign
id|swlen
op_minus
(paren
id|maxfrag
op_minus
l_int|1
)paren
op_star
l_int|8192
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|kxfer.buf
op_logical_or
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|kxfer.buf
comma
id|fragsize
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kxfer.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|fragsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_7
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SW_UPLOAD
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
id|cfg_handler.context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
id|u32
)paren
id|kxfer.flags
op_lshift
l_int|24
op_or
(paren
id|u32
)paren
id|kxfer.sw_type
op_lshift
l_int|16
op_or
(paren
id|u32
)paren
id|maxfrag
op_lshift
l_int|8
op_or
(paren
id|u32
)paren
id|curfrag
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
id|swlen
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|kxfer.sw_id
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
(paren
l_int|0xD0000000
op_or
id|fragsize
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
singleline_comment|//&t;printk(&quot;i2o_config: swul frag %d/%d (size %d)&bslash;n&quot;, curfrag, maxfrag, fragsize);
id|status
op_assign
id|i2o_post_wait
c_func
(paren
id|c
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|60
)paren
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: swul failed, DetailedStatus = %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|__copy_to_user
c_func
(paren
id|kxfer.buf
comma
id|buffer
comma
id|fragsize
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioctl_swdel
r_int
id|ioctl_swdel
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_sw_xfer
id|kxfer
comma
op_star
id|pxfer
op_assign
(paren
r_struct
id|i2o_sw_xfer
op_star
)paren
id|arg
suffix:semicolon
id|u32
id|msg
(braket
l_int|7
)braket
suffix:semicolon
r_int
r_int
id|swlen
suffix:semicolon
r_int
id|token
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kxfer
comma
id|pxfer
comma
r_sizeof
(paren
r_struct
id|i2o_sw_xfer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|swlen
comma
id|kxfer.swlen
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|kxfer.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|SEVEN_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SW_REMOVE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
id|i2o_cfg_context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
id|u32
)paren
id|kxfer.flags
op_lshift
l_int|24
op_or
(paren
id|u32
)paren
id|kxfer.sw_type
op_lshift
l_int|16
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
id|swlen
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|kxfer.sw_id
suffix:semicolon
id|token
op_assign
id|i2o_post_wait
c_func
(paren
id|c
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|10
)paren
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o_config: swdel failed, DetailedStatus = %d&bslash;n&quot;
comma
id|token
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioctl_validate
r_int
id|ioctl_validate
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
id|token
suffix:semicolon
r_int
id|iop
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
id|u32
id|msg
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|c
op_assign
id|i2o_find_controller
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_CONFIG_VALIDATE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|iop
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
id|i2o_cfg_context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|token
op_assign
id|i2o_post_wait
c_func
(paren
id|c
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|10
)paren
suffix:semicolon
id|i2o_unlock_controller
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Can&squot;t validate configuration, ErrorStatus = %d&bslash;n&quot;
comma
id|token
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioctl_evt_reg
r_static
r_int
id|ioctl_evt_reg
c_func
(paren
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
id|u32
id|msg
(braket
l_int|5
)braket
suffix:semicolon
r_struct
id|i2o_evt_id
op_star
id|pdesc
op_assign
(paren
r_struct
id|i2o_evt_id
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_evt_id
id|kdesc
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|iop
suffix:semicolon
r_struct
id|i2o_device
op_star
id|d
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kdesc
comma
id|pdesc
comma
r_sizeof
(paren
r_struct
id|i2o_evt_id
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* IOP exists? */
id|iop
op_assign
id|i2o_find_controller
c_func
(paren
id|kdesc.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iop
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|i2o_unlock_controller
c_func
(paren
id|iop
)paren
suffix:semicolon
multiline_comment|/* Device exists? */
r_for
c_loop
(paren
id|d
op_assign
id|iop-&gt;devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
r_if
c_cond
(paren
id|d-&gt;lct_data.tid
op_eq
id|kdesc.tid
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|d
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_EVT_REGISTER
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|kdesc.tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
(paren
id|u32
)paren
id|i2o_cfg_context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|fp-&gt;private_data
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
id|kdesc.evt_mask
suffix:semicolon
id|i2o_post_this
c_func
(paren
id|iop
comma
id|msg
comma
l_int|20
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioctl_evt_get
r_static
r_int
id|ioctl_evt_get
c_func
(paren
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
id|u32
id|id
op_assign
(paren
id|u32
)paren
id|fp-&gt;private_data
suffix:semicolon
r_struct
id|i2o_cfg_info
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|i2o_evt_get
op_star
id|uget
op_assign
(paren
r_struct
id|i2o_evt_get
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_evt_get
id|kget
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
singleline_comment|// access_ok doesn&squot;t check for NULL?!?!
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|uget
comma
r_sizeof
(paren
r_struct
id|i2o_evt_get
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|open_files
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;q_id
op_eq
id|id
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;q_len
)paren
(brace
r_return
op_minus
id|ENOENT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|kget.info
comma
op_amp
id|p-&gt;event_q
(braket
id|p-&gt;q_out
)braket
comma
r_sizeof
(paren
r_struct
id|i2o_evt_info
)paren
)paren
suffix:semicolon
id|MODINC
c_func
(paren
id|p-&gt;q_out
comma
id|I2O_EVT_Q_LEN
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;q_len
op_decrement
suffix:semicolon
id|kget.pending
op_assign
id|p-&gt;q_len
suffix:semicolon
id|kget.lost
op_assign
id|p-&gt;q_lost
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|__copy_to_user
c_func
(paren
id|uget
comma
op_amp
id|kget
comma
r_sizeof
(paren
r_struct
id|i2o_evt_get
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cfg_open
r_static
r_int
id|cfg_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|i2o_cfg_info
op_star
id|tmp
op_assign
(paren
r_struct
id|i2o_cfg_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2o_cfg_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
(paren
id|i2o_cfg_info_id
op_increment
)paren
suffix:semicolon
id|tmp-&gt;fp
op_assign
id|file
suffix:semicolon
id|tmp-&gt;fasync
op_assign
l_int|NULL
suffix:semicolon
id|tmp-&gt;q_id
op_assign
(paren
id|u32
)paren
id|file-&gt;private_data
suffix:semicolon
id|tmp-&gt;q_len
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;q_in
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;q_out
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;q_lost
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;next
op_assign
id|open_files
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|open_files
op_assign
id|tmp
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cfg_release
r_static
r_int
id|cfg_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|u32
id|id
op_assign
(paren
id|u32
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|i2o_cfg_info
op_star
id|p1
comma
op_star
id|p2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|p1
op_assign
id|p2
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p1
op_assign
id|open_files
suffix:semicolon
id|p1
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|p1-&gt;q_id
op_eq
id|id
)paren
(brace
r_if
c_cond
(paren
id|p1-&gt;fasync
)paren
(brace
id|cfg_fasync
c_func
(paren
op_minus
l_int|1
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p2
)paren
(brace
id|p2-&gt;next
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
r_else
id|open_files
op_assign
id|p1-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|p1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p2
op_assign
id|p1
suffix:semicolon
id|p1
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cfg_fasync
r_static
r_int
id|cfg_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|fp
comma
r_int
id|on
)paren
(brace
id|u32
id|id
op_assign
(paren
id|u32
)paren
id|fp-&gt;private_data
suffix:semicolon
r_struct
id|i2o_cfg_info
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|open_files
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;q_id
op_eq
id|id
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
r_return
id|fasync_helper
c_func
(paren
id|fd
comma
id|fp
comma
id|on
comma
op_amp
id|p-&gt;fasync
)paren
suffix:semicolon
)brace
DECL|variable|config_fops
r_static
r_struct
id|file_operations
id|config_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|cfg_llseek
comma
id|read
suffix:colon
id|cfg_read
comma
id|write
suffix:colon
id|cfg_write
comma
id|ioctl
suffix:colon
id|cfg_ioctl
comma
id|open
suffix:colon
id|cfg_open
comma
id|release
suffix:colon
id|cfg_release
comma
id|fasync
suffix:colon
id|cfg_fasync
comma
)brace
suffix:semicolon
DECL|variable|i2o_miscdev
r_static
r_struct
id|miscdevice
id|i2o_miscdev
op_assign
(brace
id|I2O_MINOR
comma
l_string|&quot;i2octl&quot;
comma
op_amp
id|config_fops
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|i2o_config_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;I2O configuration manager v 0.04.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  (C) Copyright 1999 Red Hat Software&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|page_buf
op_assign
id|kmalloc
c_func
(paren
l_int|4096
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_config: no memory for page buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|i2o_miscdev
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_config: can&squot;t register device.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|page_buf
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Install our handler&n;&t; */
r_if
c_cond
(paren
id|i2o_install_handler
c_func
(paren
op_amp
id|cfg_handler
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|page_buf
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_config: handler register failed.&bslash;n&quot;
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|i2o_miscdev
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;The low 16bits of the transaction context must match this&n;&t; *&t;for everything we post. Otherwise someone else gets our mail&n;&t; */
id|i2o_cfg_context
op_assign
id|cfg_handler.context
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|misc_deregister
c_func
(paren
op_amp
id|i2o_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page_buf
)paren
(brace
id|kfree
c_func
(paren
id|page_buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_cfg_context
op_ne
op_minus
l_int|1
)paren
(brace
id|i2o_remove_handler
c_func
(paren
op_amp
id|cfg_handler
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_buffer
)paren
(brace
id|kfree
c_func
(paren
id|i2o_buffer
)paren
suffix:semicolon
)brace
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Red Hat Software&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2O Configuration&quot;
)paren
suffix:semicolon
macro_line|#endif
eof
