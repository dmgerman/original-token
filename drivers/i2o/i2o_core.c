multiline_comment|/*&n; *&t;Core I2O structure managment&n; *&n; *&t;(C) Copyright 1999   Red Hat Software&n; *&t;&n; *&t;Written by Alan Cox, Building Number Three Ltd&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; * &t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;A lot of the I2O message side code from this is taken from the&n; *&t;Red Creek RCPCI45 adapter driver by Red Creek Communications&n; *&n; *&t;Some fixes and cleanup by Philipp Rumpf&n; *&n; *&t;Additional fixes by Juha Siev&#xfffd;nen &lt;Juha.Sievanen@cs.Helsinki.FI&gt;&n; *&t;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &quot;i2o_lan.h&quot;
multiline_comment|/*&n; *&t;Size of the I2O module table&n; */
DECL|variable|i2o_handlers
r_static
r_struct
id|i2o_handler
op_star
id|i2o_handlers
(braket
id|MAX_I2O_MODULES
)braket
suffix:semicolon
DECL|variable|i2o_controllers
r_static
r_struct
id|i2o_controller
op_star
id|i2o_controllers
(braket
id|MAX_I2O_CONTROLLERS
)braket
suffix:semicolon
DECL|variable|i2o_num_controllers
r_int
id|i2o_num_controllers
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|i2o_online_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;I2O configuration spinlock. This isnt a big deal for contention&n; *&t;so we have one only&n; */
macro_line|#ifdef __SMP__
DECL|variable|i2o_configuration_lock
r_static
id|spinlock_t
id|i2o_configuration_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Install an I2O handler - these handle the asynchronous messaging&n; *&t;from the card once it has initialised.&n; */
DECL|function|i2o_install_handler
r_int
id|i2o_install_handler
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
)paren
(brace
r_int
id|i
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_I2O_MODULES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2o_handlers
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|h-&gt;context
op_assign
id|i
suffix:semicolon
id|i2o_handlers
(braket
id|i
)braket
op_assign
id|h
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
DECL|function|i2o_remove_handler
r_int
id|i2o_remove_handler
c_func
(paren
r_struct
id|i2o_handler
op_star
id|h
)paren
(brace
id|i2o_handlers
(braket
id|h-&gt;context
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Each I2O controller has a chain of devices on it - these match&n; *&t;the useful parts of the LCT of the board.&n; */
DECL|function|i2o_install_device
r_int
id|i2o_install_device
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_struct
id|i2o_device
op_star
id|d
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
id|d-&gt;controller
op_assign
id|c
suffix:semicolon
id|d-&gt;owner
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;next
op_assign
id|c-&gt;devices
suffix:semicolon
id|c-&gt;devices
op_assign
id|d
suffix:semicolon
op_star
id|d-&gt;dev_name
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* we need this version to call out of i2o_delete_controller */
DECL|function|__i2o_delete_device
r_int
id|__i2o_delete_device
c_func
(paren
r_struct
id|i2o_device
op_star
id|d
)paren
(brace
r_struct
id|i2o_device
op_star
op_star
id|p
suffix:semicolon
id|p
op_assign
op_amp
(paren
id|d-&gt;controller-&gt;devices
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Hey we have a driver!&n;&t; */
r_if
c_cond
(paren
id|d-&gt;owner
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Seek, locate&n;&t; */
r_while
c_loop
(paren
op_star
id|p
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
id|d
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Destroy&n;&t;&t;&t; */
op_star
id|p
op_assign
id|d-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_assign
op_amp
(paren
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_delete_device: passed invalid device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|i2o_delete_device
r_int
id|i2o_delete_device
c_func
(paren
r_struct
id|i2o_device
op_star
id|d
)paren
(brace
r_int
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
id|ret
op_assign
id|__i2o_delete_device
c_func
(paren
id|d
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add and remove controllers from the I2O controller list&n; */
DECL|function|i2o_install_controller
r_int
id|i2o_install_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_I2O_CONTROLLERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2o_controllers
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|i2o_controllers
(braket
id|i
)braket
op_assign
id|c
suffix:semicolon
id|c-&gt;next
op_assign
id|i2o_controller_chain
suffix:semicolon
id|i2o_controller_chain
op_assign
id|c
suffix:semicolon
id|c-&gt;unit
op_assign
id|i
suffix:semicolon
id|sprintf
c_func
(paren
id|c-&gt;name
comma
l_string|&quot;i2o/iop%d&quot;
comma
id|i
)paren
suffix:semicolon
id|i2o_num_controllers
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No free i2o controller slots.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|i2o_delete_controller
r_int
id|i2o_delete_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_controller
op_star
op_star
id|p
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|c-&gt;users
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_while
c_loop
(paren
id|c-&gt;devices
)paren
(brace
r_if
c_cond
(paren
id|__i2o_delete_device
c_func
(paren
id|c-&gt;devices
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Shouldnt happen */
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|c
op_member_access_from_pointer
id|destructor
c_func
(paren
id|c
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|i2o_controller_chain
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
id|c
)paren
(brace
multiline_comment|/* Prepare for restart */
singleline_comment|//&t;&t;&t;i2o_clear_controller(c);
op_star
id|p
op_assign
id|c-&gt;next
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;page_frame
)paren
(brace
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|c-&gt;page_frame
)paren
suffix:semicolon
id|i2o_controllers
(braket
id|c-&gt;unit
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|c
)paren
suffix:semicolon
id|i2o_num_controllers
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_assign
op_amp
(paren
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_delete_controller: bad pointer!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
DECL|function|i2o_unlock_controller
r_void
id|i2o_unlock_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|c-&gt;users
)paren
suffix:semicolon
)brace
DECL|function|i2o_find_controller
r_struct
id|i2o_controller
op_star
id|i2o_find_controller
c_func
(paren
r_int
id|n
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
op_logical_or
id|n
op_ge
id|MAX_I2O_CONTROLLERS
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
id|c
op_assign
id|i2o_controllers
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ne
l_int|NULL
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|c-&gt;users
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Track if a device is being used by a driver&n; */
DECL|function|i2o_claim_device
r_int
id|i2o_claim_device
c_func
(paren
r_struct
id|i2o_device
op_star
id|d
comma
r_struct
id|i2o_driver
op_star
id|r
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;owner
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|d-&gt;controller-&gt;users
)paren
suffix:semicolon
id|d-&gt;owner
op_assign
id|r
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2o_release_device
r_int
id|i2o_release_device
c_func
(paren
r_struct
id|i2o_device
op_star
id|d
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;owner
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|d-&gt;controller-&gt;users
)paren
suffix:semicolon
id|d-&gt;owner
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i2o_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This is called by the bus specific driver layer when an interrupt&n; *&t;or poll of this card interface is desired.&n; */
DECL|function|i2o_run_queue
r_void
id|i2o_run_queue
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|m
suffix:semicolon
id|u32
id|mv
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mv
op_assign
id|I2O_REPLY_READ32
c_func
(paren
id|c
)paren
)paren
op_ne
l_int|0xFFFFFFFF
)paren
(brace
r_struct
id|i2o_handler
op_star
id|i
suffix:semicolon
id|m
op_assign
(paren
r_struct
id|i2o_message
op_star
)paren
id|bus_to_virt
c_func
(paren
id|mv
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Temporary Debugging&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|m-&gt;function_addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
)paren
op_eq
l_int|0x15
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;UTFR!&bslash;n&quot;
)paren
suffix:semicolon
)brace
singleline_comment|//&t;&t;printk(&quot;dispatching.&bslash;n&quot;);
id|i
op_assign
id|i2o_handlers
(braket
id|m-&gt;initiator_context
op_amp
(paren
id|MAX_I2O_MODULES
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|i
op_member_access_from_pointer
id|reply
c_func
(paren
id|i
comma
id|c
comma
id|m
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Spurious reply&bslash;n&quot;
)paren
suffix:semicolon
id|i2o_flush_reply
c_func
(paren
id|c
comma
id|mv
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Do i2o class name lookup&n; */
DECL|function|i2o_get_class_name
r_const
r_char
op_star
id|i2o_get_class_name
c_func
(paren
r_int
r_class
)paren
(brace
r_int
id|idx
op_assign
l_int|16
suffix:semicolon
r_static
r_char
op_star
id|i2o_class_name
(braket
)braket
op_assign
(brace
l_string|&quot;Executive&quot;
comma
l_string|&quot;Device Driver Module&quot;
comma
l_string|&quot;Block Device&quot;
comma
l_string|&quot;Tape Device&quot;
comma
l_string|&quot;LAN Inteface&quot;
comma
l_string|&quot;WAN Interface&quot;
comma
l_string|&quot;Fibre Channel Port&quot;
comma
l_string|&quot;Fibre Channel Device&quot;
comma
l_string|&quot;SCSI Device&quot;
comma
l_string|&quot;ATE Port&quot;
comma
l_string|&quot;ATE Device&quot;
comma
l_string|&quot;Floppy Controller&quot;
comma
l_string|&quot;Floppy Device&quot;
comma
l_string|&quot;Secondary Bus Port&quot;
comma
l_string|&quot;Peer Transport Agent&quot;
comma
l_string|&quot;Peer Transport&quot;
comma
l_string|&quot;Unknown&quot;
)brace
suffix:semicolon
r_switch
c_cond
(paren
r_class
op_amp
l_int|0xFFF
)paren
(brace
r_case
id|I2O_CLASS_EXECUTIVE
suffix:colon
id|idx
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_DDM
suffix:colon
id|idx
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_RANDOM_BLOCK_STORAGE
suffix:colon
id|idx
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_SEQUENTIAL_STORAGE
suffix:colon
id|idx
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_LAN
suffix:colon
id|idx
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_WAN
suffix:colon
id|idx
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FIBRE_CHANNEL_PORT
suffix:colon
id|idx
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL
suffix:colon
id|idx
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_SCSI_PERIPHERAL
suffix:colon
id|idx
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_ATE_PORT
suffix:colon
id|idx
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_ATE_PERIPHERAL
suffix:colon
id|idx
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FLOPPY_CONTROLLER
suffix:colon
id|idx
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FLOPPY_DEVICE
suffix:colon
id|idx
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_BUS_ADAPTER_PORT
suffix:colon
id|idx
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_PEER_TRANSPORT_AGENT
suffix:colon
id|idx
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_PEER_TRANSPORT
suffix:colon
id|idx
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|i2o_class_name
(braket
id|idx
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Wait up to 5 seconds for a message slot to be available.&n; */
DECL|function|i2o_wait_message
id|u32
id|i2o_wait_message
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_char
op_star
id|why
)paren
(brace
r_int
id|time
op_assign
id|jiffies
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_while
c_loop
(paren
(paren
id|m
op_assign
id|I2O_POST_READ32
c_func
(paren
id|c
)paren
)paren
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|time
)paren
op_ge
l_int|5
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Timeout waiting for message to send %s.&bslash;n&quot;
comma
id|c-&gt;name
comma
id|why
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|m
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Wait up to 5 seconds for a reply to be available.&n; */
DECL|function|i2o_wait_reply
id|u32
id|i2o_wait_reply
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_char
op_star
id|why
comma
r_int
id|timeout
)paren
(brace
id|u32
id|m
suffix:semicolon
r_int
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
(paren
id|m
op_assign
id|I2O_REPLY_READ32
c_func
(paren
id|c
)paren
)paren
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|time
op_ge
id|timeout
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: timeout waiting for %s reply.&bslash;n&quot;
comma
id|c-&gt;name
comma
id|why
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|m
suffix:semicolon
)brace
multiline_comment|/* Quiesce and clear IOP  */
DECL|function|i2o_quiesce_controller
r_int
id|i2o_quiesce_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
multiline_comment|/* now we stop receiving messages to this IOP */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;Quiesce IOP&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_QUIESCE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Sending SysQuiesce to %s&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;System Quiesce&quot;
comma
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
multiline_comment|/* Someday we should check return status... */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2o_clear_controller
r_int
id|i2o_clear_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;IOP Clear&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_ADAPTER_CLEAR
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Sending IOPClear to %s&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;IOP Clear timeout&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;i2o table walking. We just provide a single element retrieve. You can&n; *&t;all sorts of fancy lookups in I2O but we have no performance critical&n; *&t;lookups so why write all the code for it.&n; */
macro_line|#if 0
r_static
r_int
id|i2o_query_table_polled
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
r_void
op_star
id|buf
comma
r_int
id|buflen
comma
r_int
id|group
comma
r_int
id|field
comma
id|u32
op_star
id|key
comma
r_int
id|keylen
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|u16
id|op
(braket
l_int|64
)braket
suffix:semicolon
id|u32
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
op_star
id|rbuf
suffix:semicolon
id|op
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* One Operation */
id|op
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PAD */
id|op
(braket
l_int|2
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* LIST_GET */
id|op
(braket
l_int|3
)braket
op_assign
id|group
suffix:semicolon
multiline_comment|/* group number */
id|op
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 field */
id|op
(braket
l_int|5
)braket
op_assign
id|field
suffix:semicolon
multiline_comment|/* Field number */
id|op
(braket
l_int|6
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Key count */
id|memcpy
c_func
(paren
id|op
op_plus
l_int|7
comma
id|key
comma
id|keylen
)paren
suffix:semicolon
multiline_comment|/* Key */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;I2O query table.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|rbuf
op_assign
id|kmalloc
c_func
(paren
id|buflen
op_plus
l_int|32
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rbuf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No free memory for table read.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Context */
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x54000000
op_or
(paren
l_int|14
)paren
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|op
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD0000000
op_or
(paren
l_int|32
op_plus
id|buflen
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|rbuf
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now wait for a reply&n;&t; */
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;Table read timeout&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kfree
c_func
(paren
id|rbuf
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
(brace
id|i2o_report_status
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;i2o_core&quot;
comma
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
id|msg
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|p
op_assign
id|rbuf
suffix:semicolon
multiline_comment|/* Ok &squot;p&squot; is the reply block - lets see what happened */
multiline_comment|/* p0-&gt;p2 are the header */
multiline_comment|/* FIXME: endians - turn p3 to little endian */
id|i
op_assign
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* Message size */
r_if
c_cond
(paren
id|i
OL
id|buflen
)paren
(brace
id|buflen
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* Do we have an error block ? */
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xFF000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error in field read.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rbuf
)paren
suffix:semicolon
r_return
op_minus
id|EBADR
suffix:semicolon
)brace
multiline_comment|/* p[1] holds the more flag and row count - we dont care */
multiline_comment|/* Ok it worked p[2]-&gt; hold the data */
id|memcpy
c_func
(paren
id|buf
comma
id|p
op_plus
l_int|2
comma
id|buflen
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rbuf
)paren
suffix:semicolon
multiline_comment|/* Finally return the message */
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
id|buflen
suffix:semicolon
)brace
macro_line|#endif
DECL|function|i2o_query_scalar_polled
r_static
r_int
id|i2o_query_scalar_polled
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
r_void
op_star
id|buf
comma
r_int
id|buflen
comma
r_int
id|group
comma
r_int
id|field
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|u16
id|op
(braket
l_int|8
)braket
suffix:semicolon
id|u32
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
op_star
id|rbuf
suffix:semicolon
id|op
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* One Operation */
id|op
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PAD */
id|op
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIELD_GET */
id|op
(braket
l_int|3
)braket
op_assign
id|group
suffix:semicolon
multiline_comment|/* group number */
id|op
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 field */
id|op
(braket
l_int|5
)braket
op_assign
id|field
suffix:semicolon
multiline_comment|/* Field number */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;I2O query scalar.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|rbuf
op_assign
id|kmalloc
c_func
(paren
id|buflen
op_plus
l_int|32
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rbuf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No free memory for scalar read.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Context */
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x54000000
op_or
l_int|12
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|op
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD0000000
op_or
(paren
l_int|32
op_plus
id|buflen
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|rbuf
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now wait for a reply&n;&t; */
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;Scalar read timeout&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kfree
c_func
(paren
id|rbuf
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
(brace
id|i2o_report_status
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;i2o_core&quot;
comma
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
id|msg
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|p
op_assign
id|rbuf
suffix:semicolon
multiline_comment|/* Ok &squot;p&squot; is the reply block - lets see what happened */
multiline_comment|/* p0-&gt;p2 are the header */
multiline_comment|/* FIXME: endians - turn p3 to little endian */
r_if
c_cond
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Suspicious field read return 0x%08X&bslash;n&quot;
comma
id|p
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|i
op_assign
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* Message size */
r_if
c_cond
(paren
id|i
OL
id|buflen
)paren
(brace
id|buflen
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* Do we have an error block ? */
r_if
c_cond
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0xFF000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error in field read.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rbuf
)paren
suffix:semicolon
r_return
op_minus
id|EBADR
suffix:semicolon
)brace
multiline_comment|/* p[1] holds the more flag and row count - we dont care */
multiline_comment|/* Ok it worked p[2]-&gt; hold the data */
id|memcpy
c_func
(paren
id|buf
comma
id|p
op_plus
l_int|2
comma
id|buflen
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rbuf
)paren
suffix:semicolon
multiline_comment|/* Finally return the message */
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
id|buflen
suffix:semicolon
)brace
multiline_comment|/*&n; *&t; Dump the information block associated with a given unit (TID)&n; */
DECL|function|i2o_report_controller_unit
r_void
id|i2o_report_controller_unit
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|unit
)paren
(brace
r_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i2o_query_scalar_polled
c_func
(paren
id|c
comma
id|unit
comma
id|buf
comma
l_int|16
comma
l_int|0xF100
comma
l_int|3
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;     Vendor: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_query_scalar_polled
c_func
(paren
id|c
comma
id|unit
comma
id|buf
comma
l_int|16
comma
l_int|0xF100
comma
l_int|4
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;     Device: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|i2o_query_scalar_polled
c_func
(paren
id|c
comma
id|unit
comma
id|buf
comma
l_int|16
comma
l_int|0xF100
comma
l_int|5
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Description: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
macro_line|#endif&t;
r_if
c_cond
(paren
id|i2o_query_scalar_polled
c_func
(paren
id|c
comma
id|unit
comma
id|buf
comma
l_int|8
comma
l_int|0xF100
comma
l_int|6
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;        Rev: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Parse the hardware resource table. Right now we print it out&n; *&t;and don&squot;t do a lot with it. We should collate these and then&n; *&t;interact with the Linux resource allocation block.&n; *&n; *&t;Lets prove we can read it first eh ?&n; *&n; *&t;This is full of endianisms!&n; */
DECL|function|i2o_parse_hrt
r_static
r_int
id|i2o_parse_hrt
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
id|u8
op_star
id|p
)paren
(brace
id|u32
op_star
id|rows
op_assign
(paren
id|u32
op_star
)paren
id|p
suffix:semicolon
id|u8
op_star
id|d
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|length
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|state
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|3
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: HRT table for controller is too new a version.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|count
op_assign
id|p
(braket
l_int|0
)braket
op_or
(paren
id|p
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|length
op_assign
id|p
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HRT has %d entries of %d bytes each.&bslash;n&quot;
comma
id|count
comma
id|length
op_lshift
l_int|2
)paren
suffix:semicolon
id|rows
op_add_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Adapter %08X: &quot;
comma
id|rows
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p
op_assign
(paren
id|u8
op_star
)paren
(paren
id|rows
op_plus
l_int|1
)paren
suffix:semicolon
id|d
op_assign
(paren
id|u8
op_star
)paren
(paren
id|rows
op_plus
l_int|2
)paren
suffix:semicolon
id|state
op_assign
id|p
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TID %04X:[&quot;
comma
id|state
op_amp
l_int|0xFFF
)paren
suffix:semicolon
id|state
op_rshift_assign
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Hidden */
r_if
c_cond
(paren
id|state
op_amp
(paren
l_int|1
op_lshift
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;P&quot;
)paren
suffix:semicolon
multiline_comment|/* Present */
r_if
c_cond
(paren
id|state
op_amp
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;C&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Controlled */
)brace
r_if
c_cond
(paren
id|state
OG
l_int|9
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Hard */
id|printk
c_func
(paren
l_string|&quot;]:&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|p
(braket
l_int|3
)braket
op_amp
l_int|0xFFFF
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Adapter private bus - easy */
id|printk
c_func
(paren
l_string|&quot;Local bus %d: I/O at 0x%04X Mem 0x%08X&quot;
comma
id|p
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|d
(braket
l_int|0
)braket
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|d
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* ISA bus */
id|printk
c_func
(paren
l_string|&quot;ISA %d: CSN %d I/O at 0x%04X Mem 0x%08X&quot;
comma
id|p
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|d
(braket
l_int|0
)braket
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|d
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* EISA bus */
id|printk
c_func
(paren
l_string|&quot;EISA %d: Slot %d I/O at 0x%04X Mem 0x%08X&quot;
comma
id|p
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|3
)braket
comma
id|d
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|d
(braket
l_int|0
)braket
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|d
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* MCA bus */
id|printk
c_func
(paren
l_string|&quot;MCA %d: Slot %d I/O at 0x%04X Mem 0x%08X&quot;
comma
id|p
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|3
)braket
comma
id|d
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|d
(braket
l_int|0
)braket
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|d
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* PCI bus */
id|printk
c_func
(paren
l_string|&quot;PCI %d: Bus %d Device %d Function %d&quot;
comma
id|p
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|2
)braket
comma
id|d
(braket
l_int|1
)braket
comma
id|d
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x80
suffix:colon
multiline_comment|/* Other */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unsupported bus type.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|rows
op_add_assign
id|length
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The logical configuration table tells us what we can talk to&n; *&t;on the board. Most of the stuff isn&squot;t interesting to us. &n; */
DECL|function|i2o_parse_lct
r_static
r_int
id|i2o_parse_lct
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
id|u32
op_star
id|lct
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|max
suffix:semicolon
r_int
id|tid
suffix:semicolon
id|u32
op_star
id|p
suffix:semicolon
r_struct
id|i2o_device
op_star
id|d
suffix:semicolon
r_char
id|str
(braket
l_int|22
)braket
suffix:semicolon
id|max
op_assign
id|lct
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
suffix:semicolon
id|max
op_sub_assign
l_int|3
suffix:semicolon
id|max
op_div_assign
l_int|9
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LCT has %d entries.&bslash;n&quot;
comma
id|max
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max
OG
l_int|128
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LCT was truncated.&bslash;n&quot;
)paren
suffix:semicolon
id|max
op_assign
l_int|128
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lct
(braket
l_int|1
)braket
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Configuration dialog desired.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|p
op_assign
id|lct
op_plus
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d
op_assign
(paren
r_struct
id|i2o_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2o_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i2o_core: Out of memory for LCT data.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|d-&gt;controller
op_assign
id|c
suffix:semicolon
id|d-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;id
op_assign
id|tid
op_assign
(paren
id|p
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xFFF
suffix:semicolon
id|d
op_member_access_from_pointer
r_class
op_assign
id|p
(braket
l_int|3
)braket
op_amp
l_int|0xFFF
suffix:semicolon
id|d-&gt;subclass
op_assign
id|p
(braket
l_int|4
)braket
op_amp
l_int|0xFFF
suffix:semicolon
id|d-&gt;parent
op_assign
(paren
id|p
(braket
l_int|5
)braket
op_rshift
l_int|12
)paren
op_amp
l_int|0xFFF
suffix:semicolon
id|d-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;TID %d.&bslash;n&quot;
comma
id|tid
)paren
suffix:semicolon
id|i2o_report_controller_unit
c_func
(paren
id|c
comma
id|tid
)paren
suffix:semicolon
id|i2o_install_device
c_func
(paren
id|c
comma
id|d
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Class: &quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;%-21s&quot;
comma
id|i2o_get_class_name
c_func
(paren
id|d
op_member_access_from_pointer
r_class
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|str
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  Subclass: 0x%03X   Flags: &quot;
comma
id|d-&gt;subclass
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|2
)braket
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;C&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// ConfigDialog requested
r_if
c_cond
(paren
id|p
(braket
l_int|2
)braket
op_amp
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;M&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Multi-user capable
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
(braket
l_int|2
)braket
op_amp
(paren
l_int|1
op_lshift
l_int|4
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;P&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Peer service enabled!
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
(braket
l_int|2
)braket
op_amp
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Mgmt service enabled!
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
l_int|9
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Reset the IOP to sane state */
multiline_comment|/* I think we need handler for core (or executive class in I2O terms) */
r_static
r_int
id|i2o_reset_adapter
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u8
op_star
id|work8
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
r_int
id|time
suffix:semicolon
multiline_comment|/* First stop extral operations */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;quiesce IOP&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_QUIESCE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;System Quiesce timeout&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* Then reset the IOP */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;reset IOP&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|work8
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|work8
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP reset failed - no free memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|work8
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|EIGHT_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_ADAPTER_RESET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|work8
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 64bit host FIXME */
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
multiline_comment|/* Wait for a reply */
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|work8
(braket
l_int|0
)braket
op_eq
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|time
)paren
op_ge
l_int|5
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP reset timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|work8
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|work8
(braket
l_int|0
)braket
op_eq
l_int|0x02
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IOP Reset rejected&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;Bring an I2O controller into HOLD state. See the 1.5&n; *&t;spec. Basically we go&n; *&n; *&t;Wait for the message queue to initialise. &n; *&t;If it didnt -&gt; controller is dead&n; *&t;&n; *&t;Send a get status using the message queue&n; *&t;Poll for a reply block 88 bytes long&n; *&n; *&t;Send an initialise outbound queue&n; *&t;Poll for a reply&n; *&n; *&t;Post our blank messages to the queue FIFO&n; *&n; *&t;Send GetHRT, Parse it&n; */
DECL|function|i2o_activate_controller
r_int
id|i2o_activate_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_int
id|time
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|u8
op_star
id|workspace
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Configuring I2O controller at 0x%08X.&bslash;n&quot;
comma
(paren
id|u32
)paren
id|c-&gt;mem_phys
)paren
suffix:semicolon
multiline_comment|/* First reset the IOP to sane state */
singleline_comment|//&t;i2o_reset_adapter(c)
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;initialise&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|workspace
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
l_int|88
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|workspace
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP initialisation failed - no free memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|workspace
comma
l_int|0
comma
l_int|88
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_STATUS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|workspace
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 64bit host FIXME */
id|msg
(braket
l_int|8
)braket
op_assign
l_int|88
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Wait for a reply&n;&t; */
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|workspace
(braket
l_int|87
)braket
op_ne
l_int|0xFF
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|time
)paren
op_ge
l_int|5
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP get status timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Ok the reply has arrived. Fill in the important stuff&n;&t; */
id|c-&gt;status
op_assign
id|workspace
(braket
l_int|10
)braket
suffix:semicolon
id|c-&gt;i2oversion
op_assign
(paren
id|workspace
(braket
l_int|9
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|c-&gt;inbound_size
op_assign
(paren
id|workspace
(braket
l_int|12
)braket
op_or
(paren
id|workspace
(braket
l_int|13
)braket
op_lshift
l_int|8
)paren
)paren
op_star
l_int|4
suffix:semicolon
multiline_comment|/* 32bit words */
multiline_comment|/*&n;&t; *&t;If the board is running, reset it - we have no idea&n;&t; *&t;what kind of a mess the previous owner left it in.&n;&t; */
singleline_comment|//&t;if(c-&gt;status == ADAPTER_STATE_OPERATIONAL)
singleline_comment|//&t;&t;i2o_reset_device(c);
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;initqueue&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|EIGHT_WORD_MSG_SIZE
op_or
id|TRL_OFFSET_6
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_OUTBOUND_INIT
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0x0106
suffix:semicolon
multiline_comment|/* Transaction context */
id|msg
(braket
l_int|4
)braket
op_assign
l_int|4096
suffix:semicolon
multiline_comment|/* Host page frame size */
id|msg
(braket
l_int|5
)braket
op_assign
id|MSG_FRAME_SIZE
op_lshift
l_int|16
op_or
l_int|0x80
suffix:semicolon
multiline_comment|/* Outbound msg frame size and Initcode */
id|msg
(braket
l_int|6
)braket
op_assign
l_int|0xD0000004
suffix:semicolon
multiline_comment|/* Simple SG LE, EOB */
id|msg
(braket
l_int|7
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|workspace
)paren
suffix:semicolon
op_star
(paren
(paren
id|u32
op_star
)paren
id|workspace
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Post it&n;&t; */
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|workspace
(braket
l_int|0
)braket
op_ne
id|I2O_CMD_OUTBOUND_INIT_COMPLETE
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|time
)paren
op_ge
l_int|5
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP outbound initialise failed.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
id|c-&gt;page_frame
op_assign
id|kmalloc
c_func
(paren
id|MSG_POOL_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;page_frame
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP init failed: no memory for message page.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|m
op_assign
id|virt_to_phys
c_func
(paren
id|c-&gt;page_frame
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NMBR_MSG_FRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|m
op_add_assign
id|MSG_FRAME_SIZE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;The outbound queue is initialised and loaded,&n;&t; *&n;&t; *&t;Now we need the Hardware Resource Table. We must ask for&n;&t; *&t;this next we can&squot;t issue random messages yet.&n;&t; */
id|workspace
op_assign
id|kmalloc
c_func
(paren
l_int|2048
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|workspace
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP init failed; no memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;I2O HRT timeout.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_4
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_HRT_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0x0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* Transaction context */
id|msg
(braket
l_int|4
)braket
op_assign
(paren
l_int|0xD0000000
op_or
l_int|2048
)paren
suffix:semicolon
multiline_comment|/* Simple transaction , 2K */
id|msg
(braket
l_int|5
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|workspace
)paren
suffix:semicolon
multiline_comment|/* Dump it here */
op_star
(paren
(paren
id|u32
op_star
)paren
id|workspace
)paren
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now wait for a reply&n;&t; */
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;HRT table&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
(brace
id|i2o_report_status
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;i2o_core&quot;
comma
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
id|msg
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|i2o_parse_hrt
c_func
(paren
id|c
comma
id|workspace
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
id|i2o_online_controller
c_func
(paren
id|c
)paren
suffix:semicolon
singleline_comment|//&t;i2o_report_controller_unit(c, ADAPTER_TID);
)brace
multiline_comment|/*&n; *&t;Bring a controller online. Needs completing for multiple controllers&n; */
DECL|function|i2o_online_controller
r_int
id|i2o_online_controller
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|u32
id|systab
(braket
l_int|32
)braket
suffix:semicolon
id|u32
id|privmem
(braket
l_int|2
)braket
suffix:semicolon
id|u32
id|privio
(braket
l_int|2
)braket
suffix:semicolon
id|u32
op_star
id|workspace
suffix:semicolon
id|systab
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
id|systab
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|systab
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|systab
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|systab
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Organisation ID */
id|systab
(braket
l_int|5
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Ident 2 for now */
id|systab
(braket
l_int|6
)braket
op_assign
l_int|0
op_lshift
l_int|24
op_or
l_int|0
op_lshift
l_int|16
op_or
id|I2OVERSION
op_lshift
l_int|12
op_or
l_int|1
suffix:semicolon
multiline_comment|/* Memory mapped, IOPState, v1.5, segment 1 */
id|systab
(braket
l_int|7
)braket
op_assign
id|MSG_FRAME_SIZE
op_rshift
l_int|2
suffix:semicolon
multiline_comment|/* Message size */
id|systab
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* LastChanged */
id|systab
(braket
l_int|9
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Should be IOP capabilities */
id|systab
(braket
l_int|10
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|c-&gt;post_port
)paren
suffix:semicolon
id|systab
(braket
l_int|11
)braket
op_assign
l_int|0
suffix:semicolon
id|privmem
(braket
l_int|0
)braket
op_assign
id|c-&gt;priv_mem
suffix:semicolon
multiline_comment|/* Private memory space base address */
id|privmem
(braket
l_int|1
)braket
op_assign
id|c-&gt;priv_mem_size
suffix:semicolon
id|privio
(braket
l_int|0
)braket
op_assign
id|c-&gt;priv_io
suffix:semicolon
multiline_comment|/* Private I/O address */
id|privio
(braket
l_int|1
)braket
op_assign
id|c-&gt;priv_io_size
suffix:semicolon
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;SetSysTab&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* Now we build the systab */
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_6
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_TAB_SET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Context not needed */
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
(paren
l_int|2
op_lshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Host 1 I2O 2 */
id|msg
(braket
l_int|5
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Segment 1 */
multiline_comment|/*&n;&t; *&t;Scatter Gather List&n;&t; */
id|msg
(braket
l_int|6
)braket
op_assign
l_int|0x54000000
op_or
l_int|48
suffix:semicolon
multiline_comment|/* One table for now */
id|msg
(braket
l_int|7
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|systab
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
l_int|0xD4000000
op_or
l_int|48
suffix:semicolon
multiline_comment|/* One table for now */
id|msg
(braket
l_int|9
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|privmem
)paren
suffix:semicolon
multiline_comment|/* &t;msg[10] = virt_to_phys(privio); */
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now wait for a reply&n;&t; */
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;Systab read&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
(brace
id|i2o_report_status
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;i2o_core&quot;
comma
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
id|msg
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Finally we go online&n;&t; */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;No message for SysEnable&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_ENABLE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Context not needed */
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now wait for a reply&n;&t; */
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;Enable&quot;
comma
l_int|240
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
(brace
id|i2o_report_status
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;i2o_core&quot;
comma
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
id|msg
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Grab the LCT, see what is attached&n;&t; */
id|m
op_assign
id|i2o_wait_message
c_func
(paren
id|c
comma
l_string|&quot;No message for LCT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|workspace
op_assign
id|kmalloc
c_func
(paren
l_int|8192
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|workspace
op_eq
l_int|NULL
)paren
(brace
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
multiline_comment|/* NOP */
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No free memory for i2o controller buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|workspace
comma
l_int|0
comma
l_int|8192
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_6
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_LCT_NOTIFY
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Context not needed */
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* All devices */
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* Report now */
id|msg
(braket
l_int|6
)braket
op_assign
l_int|0xD0000000
op_or
l_int|8192
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|workspace
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now wait for a reply&n;&t; */
id|m
op_assign
id|i2o_wait_reply
c_func
(paren
id|c
comma
l_string|&quot;LCT&quot;
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
(brace
id|i2o_report_status
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;i2o_core&quot;
comma
(paren
id|msg
(braket
l_int|1
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
(paren
id|msg
(braket
l_int|4
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
comma
id|msg
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|i2o_parse_lct
c_func
(paren
id|c
comma
id|workspace
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|workspace
)paren
suffix:semicolon
id|I2O_REPLY_WRITE32
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Run time support routines&n; */
multiline_comment|/*&n; *&t;Generic &quot;post and forget&quot; helpers. This is less efficient - we do&n; *&t;a memcpy for example that isnt strictly needed, but for most uses&n; *&t;this is simply not worth optimising&n; */
DECL|function|i2o_post_this
r_int
id|i2o_post_this
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
id|u32
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
r_int
r_int
id|t
op_assign
id|jiffies
suffix:semicolon
r_do
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|I2O_POST_READ32
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|m
op_eq
l_int|0xFFFFFFFF
op_logical_and
(paren
id|jiffies
op_minus
id|t
)paren
OL
id|HZ
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: controller not responding.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|msg
op_assign
id|bus_to_virt
c_func
(paren
id|c-&gt;mem_offset
op_plus
id|m
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|msg
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|i2o_post_message
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Post a message and wait for a response flag to be set. This API will&n; *&t;change to use wait_queue&squot;s one day&n; */
DECL|function|i2o_post_wait
r_int
id|i2o_post_wait
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
id|u32
op_star
id|data
comma
r_int
id|len
comma
r_int
op_star
id|flag
comma
r_int
id|timeout
)paren
(brace
r_int
r_int
id|t
op_assign
id|jiffies
suffix:semicolon
op_star
id|flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i2o_post_this
c_func
(paren
id|c
comma
id|tid
comma
id|data
comma
id|len
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
op_star
id|flag
op_logical_and
(paren
id|jiffies
op_minus
id|t
)paren
OL
id|timeout
op_star
id|HZ
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|flag
op_le
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Issue UTIL_CLAIM messages&n; */
DECL|function|i2o_issue_claim
r_int
id|i2o_issue_claim
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
r_int
id|context
comma
r_int
id|onoff
comma
r_int
op_star
id|flag
)paren
(brace
id|u32
id|msg
(braket
l_int|6
)braket
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
r_if
c_cond
(paren
id|onoff
)paren
(brace
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_CLAIM
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
)brace
r_else
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_RELEASE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
multiline_comment|/* The 0x80000000 convention for flagging is assumed by this helper */
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0x80000000
op_or
id|context
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|flag
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0x01
op_lshift
l_int|24
suffix:semicolon
multiline_comment|/* Primary user */
r_return
id|i2o_post_wait
c_func
(paren
id|c
comma
id|tid
comma
id|msg
comma
l_int|20
comma
id|flag
comma
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Query a scalar value&n; */
DECL|function|i2o_query_scalar
r_int
id|i2o_query_scalar
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
r_int
id|context
comma
r_int
id|group
comma
r_int
id|field
comma
r_void
op_star
id|buf
comma
r_int
id|buflen
comma
r_int
op_star
id|flag
)paren
(brace
id|u16
op_star
id|op
suffix:semicolon
id|u32
op_star
id|bl
suffix:semicolon
id|u32
id|msg
(braket
l_int|9
)braket
suffix:semicolon
id|bl
op_assign
id|kmalloc
c_func
(paren
id|buflen
op_plus
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Enough space for error replys */
r_if
c_cond
(paren
id|bl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: no memory for query buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|op
op_assign
(paren
id|u16
op_star
)paren
id|bl
suffix:semicolon
id|op
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* One Operation */
id|op
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PAD */
id|op
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIELD_GET */
id|op
(braket
l_int|3
)braket
op_assign
id|group
suffix:semicolon
multiline_comment|/* group number */
id|op
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* field count, default = 1 */
id|op
(braket
l_int|5
)braket
op_assign
id|field
suffix:semicolon
multiline_comment|/* field index */
r_if
c_cond
(paren
id|field
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* Single value or the whole group? */
(brace
id|op
(braket
l_int|4
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|op
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|context
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* So we can pick it out */
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|flag
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x54000000
op_or
l_int|12
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|bl
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;There are 8 bytes of &quot;overhead&quot; required to pull in&n;&t;&t; *&t;a Params ResultsList; 2 bytes for ResultCount&n;&t;&t; *&t;(which should have value=1), plus 2 bytes for pad,&n;&t;&t; *&t;plus 2 bytes for BlockSize, plus 1 byte BlockStatus,&n;&t;&t; *&t;plus 1 byte ErrorInfoSize (8 bytes total overhead).&n;&t;&t; *&t;This is followed finally by actual result value(s).&n;&t;&t; *&n;&t;&t; *&t;Tell the IOP to return 8 + buflen bytes.&n;&t;&t; */
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD0000000
op_or
(paren
l_int|8
op_plus
id|buflen
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|bl
op_plus
l_int|3
)paren
suffix:semicolon
id|bl
(braket
l_int|3
)braket
op_assign
l_int|0xFCFCFCFC
suffix:semicolon
singleline_comment|// Pad,ResultCount
id|bl
(braket
l_int|4
)braket
op_assign
l_int|0xFAFAFCFC
suffix:semicolon
singleline_comment|// ErrorInfoSize,BlockStatus,BlockSize
multiline_comment|/*&n;&t; *&t;Post the message and await a reply&n;&t; */
r_if
c_cond
(paren
id|i2o_post_wait
c_func
(paren
id|c
comma
id|tid
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
id|flag
comma
l_int|2
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bl
(braket
l_int|4
)braket
op_amp
l_int|0x00FF00000
)paren
multiline_comment|/* BlockStatus != SUCCESS */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o_query_scalar - Error&bslash;n&quot;
l_string|&quot;ErrorInfoSize = 0x%02x, BlockStatus = 0x%02x, &quot;
l_string|&quot;BlockSize = 0x%04x&bslash;n&quot;
comma
id|bl
(braket
l_int|4
)braket
op_rshift
l_int|24
comma
(paren
id|bl
(braket
l_int|4
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
comma
id|bl
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|bl
(braket
l_int|3
)braket
op_amp
l_int|0xFFFF
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: query ResultCount = 0x%04x&bslash;n&quot;
comma
id|bl
(braket
l_int|3
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buf
comma
id|bl
op_plus
l_int|5
comma
id|buflen
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* &n; * Query a table field &n; * FIXME: NOT TESTED! &n; */
r_int
id|i2o_query_table
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
r_int
id|context
comma
r_void
op_star
id|buf
comma
r_int
id|buflen
comma
r_int
id|table
comma
r_int
op_star
id|field
comma
r_int
id|fieldlen
comma
id|u32
op_star
id|key
comma
r_int
id|keylen
comma
r_int
op_star
id|flag
)paren
(brace
r_static
id|u16
id|op
(braket
l_int|32
)braket
suffix:semicolon
id|u32
op_star
id|bl
suffix:semicolon
id|u32
id|msg
(braket
l_int|9
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|bl
op_assign
id|kmalloc
c_func
(paren
id|buflen
op_plus
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: no memory for query buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|op
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Operation count */
id|op
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved */
id|op
(braket
l_int|2
)braket
op_assign
id|I2O_PARAMS_LIST_GET
suffix:semicolon
multiline_comment|/* Operation */
id|op
(braket
l_int|3
)braket
op_assign
id|table
suffix:semicolon
multiline_comment|/* Group */
multiline_comment|/* Specific fields or the whole group? */
r_if
c_cond
(paren
op_star
id|field
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* FIXME: Fields can be variable size */
id|op
(braket
l_int|4
)braket
op_assign
id|fieldlen
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fieldlen
suffix:semicolon
id|i
op_increment
)paren
id|op
(braket
l_int|4
op_plus
id|i
)braket
op_assign
id|field
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
id|op
(braket
l_int|4
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|op
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|bl
comma
id|op
comma
l_int|12
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|context
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* So we can pick it out */
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|flag
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x54000000
op_or
l_int|12
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|bl
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD0000000
op_or
(paren
id|buflen
op_plus
l_int|48
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|bl
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Post the message and await a reply&n;&t; */
r_if
c_cond
(paren
id|i2o_post_wait
c_func
(paren
id|c
comma
id|tid
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
id|flag
comma
l_int|2
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bl
(braket
l_int|5
)braket
op_amp
l_int|0x00FF00000
)paren
multiline_comment|/* BlockStatus != SUCCESS */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o_query_table - Error&bslash;n&quot;
l_string|&quot;ErrorInfoSize = 0x%02x, BlockStatus = 0x%02x, &quot;
l_string|&quot;BlockSize = 0x%04x&bslash;n&quot;
comma
id|bl
(braket
l_int|5
)braket
op_rshift
l_int|24
comma
(paren
id|bl
(braket
l_int|5
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
comma
id|bl
(braket
l_int|5
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|bl
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: query ResultCount = %0#4x&bslash;n&quot;
comma
id|bl
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buf
comma
id|bl
op_plus
l_int|6
comma
id|buflen
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Set (for now) scalar value&n; *&n; * TODO: Add support for table groups&n; */
DECL|function|i2o_params_set
r_int
id|i2o_params_set
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_int
id|tid
comma
r_int
id|context
comma
r_int
id|table
comma
r_int
id|field
comma
r_void
op_star
id|buf
comma
r_int
id|buflen
comma
r_int
op_star
id|flag
)paren
(brace
r_static
id|u16
id|opdata
(braket
)braket
op_assign
initialization_block
suffix:semicolon
id|u32
op_star
id|bl
suffix:semicolon
id|u32
id|msg
(braket
l_int|9
)braket
suffix:semicolon
id|bl
op_assign
id|kmalloc
c_func
(paren
id|buflen
op_plus
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: no memory for set buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|opdata
(braket
l_int|3
)braket
op_assign
id|table
suffix:semicolon
multiline_comment|/* Single value or the whole group? */
r_if
c_cond
(paren
id|field
op_ne
op_minus
l_int|1
)paren
(brace
id|opdata
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
id|opdata
(braket
l_int|5
)braket
op_assign
id|field
suffix:semicolon
id|opdata
(braket
l_int|6
)braket
op_assign
op_star
(paren
id|u16
op_star
)paren
id|buf
suffix:semicolon
)brace
r_else
(brace
id|opdata
(braket
l_int|4
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|opdata
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|bl
comma
id|opdata
comma
l_int|14
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_UTIL_PARAMS_SET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
id|context
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* So we can pick it out */
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|flag
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x54000000
op_or
l_int|14
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|bl
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD0000000
op_or
(paren
id|buflen
op_plus
l_int|48
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|bl
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Post the message and wait for a reply */
r_if
c_cond
(paren
id|i2o_post_wait
c_func
(paren
id|c
comma
id|tid
comma
id|msg
comma
l_int|36
comma
id|flag
comma
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Perhaps we should check errors, eh? */
r_if
c_cond
(paren
id|bl
(braket
l_int|5
)braket
op_amp
l_int|0x00FF00000
)paren
multiline_comment|/* BlockStatus != SUCCESS */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o_params_set - Error&bslash;n&quot;
l_string|&quot;ErrorInfoSize = %0#2x, BlockStatus = %0#2x, &quot;
l_string|&quot;BlockSize = %0#4x&bslash;n&quot;
comma
id|bl
(braket
l_int|5
)braket
op_rshift
l_int|24
comma
(paren
id|bl
(braket
l_int|5
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
comma
id|bl
(braket
l_int|5
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|bl
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: params set ResultCount = %0#4x&bslash;n&quot;
comma
id|bl
(braket
l_int|4
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|bl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|report_common_status
r_void
id|report_common_status
c_func
(paren
id|u8
id|req_status
)paren
(brace
multiline_comment|/* the following reply status strings are common to all classes */
r_static
r_char
op_star
id|REPLY_STATUS
(braket
)braket
op_assign
(brace
l_string|&quot;SUCCESS&quot;
comma
l_string|&quot;ABORT_DIRTY&quot;
comma
l_string|&quot;ABORT_NO_DATA_TRANSFER&quot;
comma
l_string|&quot;ABORT_PARTIAL_TRANSFER&quot;
comma
l_string|&quot;ERROR_DIRTY&quot;
comma
l_string|&quot;ERROR_NO_DATA_TRANSFER&quot;
comma
l_string|&quot;ERROR_PARTIAL_TRANSFER&quot;
comma
l_string|&quot;PROCESS_ABORT_DIRTY&quot;
comma
l_string|&quot;PROCESS_ABORT_NO_DATA_TRANSFER&quot;
comma
l_string|&quot;PROCESS_ABORT_PARTIAL_TRANSFER&quot;
comma
l_string|&quot;TRANSACTION_ERROR&quot;
comma
l_string|&quot;PROGRESS_REPORT&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
id|req_status
OG
id|I2O_REPLY_STATUS_PROGRESS_REPORT
)paren
id|printk
c_func
(paren
l_string|&quot;%0#4x / &quot;
comma
id|req_status
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s / &quot;
comma
id|REPLY_STATUS
(braket
id|req_status
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|report_common_dsc
r_static
r_void
id|report_common_dsc
c_func
(paren
id|u16
id|detailed_status
)paren
(brace
multiline_comment|/* The following detailed statuscodes are valid &n;&t;   - for executive class, utility class, DDM class and&n;&t;   - for transaction error replies&n;&t;*/
r_static
r_char
op_star
id|COMMON_DSC
(braket
)braket
op_assign
(brace
l_string|&quot;SUCCESS&quot;
comma
l_string|&quot;0x01&quot;
comma
singleline_comment|// not used
l_string|&quot;BAD_KEY&quot;
comma
l_string|&quot;TCL_ERROR&quot;
comma
l_string|&quot;REPLY_BUFFER_FULL&quot;
comma
l_string|&quot;NO_SUCH_PAGE&quot;
comma
l_string|&quot;INSUFFICIENT_RESOURCE_SOFT&quot;
comma
l_string|&quot;INSUFFICIENT_RESOURCE_HARD&quot;
comma
l_string|&quot;0x08&quot;
comma
singleline_comment|// not used
l_string|&quot;CHAIN_BUFFER_TOO_LARGE&quot;
comma
l_string|&quot;UNSUPPORTED_FUNCTION&quot;
comma
l_string|&quot;DEVICE_LOCKED&quot;
comma
l_string|&quot;DEVICE_RESET&quot;
comma
l_string|&quot;INAPPROPRIATE_FUNCTION&quot;
comma
l_string|&quot;INVALID_INITIATOR_ADDRESS&quot;
comma
l_string|&quot;INVALID_MESSAGE_FLAGS&quot;
comma
l_string|&quot;INVALID_OFFSET&quot;
comma
l_string|&quot;INVALID_PARAMETER&quot;
comma
l_string|&quot;INVALID_REQUEST&quot;
comma
l_string|&quot;INVALID_TARGET_ADDRESS&quot;
comma
l_string|&quot;MESSAGE_TOO_LARGE&quot;
comma
l_string|&quot;MESSAGE_TOO_SMALL&quot;
comma
l_string|&quot;MISSING_PARAMETER&quot;
comma
l_string|&quot;TIMEOUT&quot;
comma
l_string|&quot;UNKNOWN_ERROR&quot;
comma
l_string|&quot;UNKNOWN_FUNCTION&quot;
comma
l_string|&quot;UNSUPPORTED_VERSION&quot;
comma
l_string|&quot;DEVICE_BUSY&quot;
comma
l_string|&quot;DEVICE_NOT_AVAILABLE&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
id|detailed_status
OG
id|I2O_DSC_DEVICE_NOT_AVAILABLE
)paren
id|printk
c_func
(paren
l_string|&quot;%0#4x.&bslash;n&quot;
comma
id|detailed_status
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s.&bslash;n&quot;
comma
id|COMMON_DSC
(braket
id|detailed_status
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|report_lan_dsc
r_void
id|report_lan_dsc
c_func
(paren
id|u16
id|detailed_status
)paren
(brace
r_static
r_char
op_star
id|LAN_DSC
(braket
)braket
op_assign
(brace
singleline_comment|// Lan detailed status code strings
l_string|&quot;SUCCESS&quot;
comma
l_string|&quot;DEVICE_FAILURE&quot;
comma
l_string|&quot;DESTINATION_NOT_FOUND&quot;
comma
l_string|&quot;TRANSMIT_ERROR&quot;
comma
l_string|&quot;TRANSMIT_ABORTED&quot;
comma
l_string|&quot;RECEIVE_ERROR&quot;
comma
l_string|&quot;RECEIVE_ABORTED&quot;
comma
l_string|&quot;DMA_ERROR&quot;
comma
l_string|&quot;BAD_PACKET_DETECTED&quot;
comma
l_string|&quot;OUT_OF_MEMORY&quot;
comma
l_string|&quot;BUCKET_OVERRUN&quot;
comma
l_string|&quot;IOP_INTERNAL_ERROR&quot;
comma
l_string|&quot;CANCELED&quot;
comma
l_string|&quot;INVALID_TRANSACTION_CONTEXT&quot;
comma
l_string|&quot;DEST_ADDRESS_DETECTED&quot;
comma
l_string|&quot;DEST_ADDRESS_OMITTED&quot;
comma
l_string|&quot;PARTIAL_PACKET_RETURNED&quot;
comma
l_string|&quot;TEMP_SUSPENDED_STATE&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
id|detailed_status
OG
id|I2O_LAN_DSC_TEMP_SUSPENDED_STATE
)paren
id|printk
c_func
(paren
l_string|&quot;%0#4x.&bslash;n&quot;
comma
id|detailed_status
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s.&bslash;n&quot;
comma
id|LAN_DSC
(braket
id|detailed_status
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|report_util_cmd
r_static
r_void
id|report_util_cmd
c_func
(paren
id|u8
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|I2O_CMD_UTIL_NOP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_NOP, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_ABORT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_ABORT, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_CLAIM
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_CLAIM, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_RELEASE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_CLAIM_RELEASE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_CONFIG_DIALOG
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_CONFIG_DIALOG, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_DEVICE_RESERVE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_DEVICE_RESERVE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_DEVICE_RELEASE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_DEVICE_RELEASE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_ACK
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_EVENT_ACKNOWLEDGE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_EVT_REGISTER
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_EVENT_REGISTER, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_LOCK
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_LOCK, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_LOCK_RELEASE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_LOCK_RELEASE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_PARAMS_GET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_PARAMS_GET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_PARAMS_SET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_PARAMS_SET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_UTIL_REPLY_FAULT_NOTIFY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;UTIL_REPLY_FAULT_NOTIFY, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%0#2x, &quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|report_exec_cmd
r_static
r_void
id|report_exec_cmd
c_func
(paren
id|u8
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|I2O_CMD_ADAPTER_ASSIGN
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_ADAPTER_ASSIGN, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_ADAPTER_READ
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_ADAPTER_READ, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_ADAPTER_RELEASE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_ADAPTER_RELEASE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_BIOS_INFO_SET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_BIOS_INFO_SET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_BOOT_DEVICE_SET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_BOOT_DEVICE_SET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_CONFIG_VALIDATE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_CONFIG_VALIDATE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_CONN_SETUP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_CONN_SETUP, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DDM_DESTROY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DDM_DESTROY, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DDM_ENABLE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DDM_ENABLE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DDM_QUIESCE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DDM_QUIESCE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DDM_RESET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DDM_RESET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DDM_SUSPEND
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DDM_SUSPEND, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DEVICE_ASSIGN
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DEVICE_ASSIGN, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_DEVICE_RELEASE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_DEVICE_RELEASE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_HRT_GET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_HRT_GET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_ADAPTER_CLEAR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_IOP_CLEAR, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_ADAPTER_CONNECT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_IOP_CONNECT, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_ADAPTER_RESET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_IOP_RESET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_LCT_NOTIFY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_LCT_NOTIFY, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_OUTBOUND_INIT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_OUTBOUND_INIT, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_PATH_ENABLE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_PATH_ENABLE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_PATH_QUIESCE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_PATH_QUIESCE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_PATH_RESET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_PATH_RESET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_STATIC_MF_CREATE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_STATIC_MF_CREATE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_STATIC_MF_RELEASE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_STATIC_MF_RELEASE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_STATUS_GET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_STATUS_GET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SW_DOWNLOAD
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SW_DOWNLOAD, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SW_UPLOAD
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SW_UPLOAD, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SW_REMOVE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SW_REMOVE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SYS_ENABLE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SYS_ENABLE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SYS_MODIFY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SYS_MODIFY, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SYS_QUIESCE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SYS_QUIESCE, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CMD_SYS_TAB_SET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXEC_SYS_TAB_SET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%02x, &quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|report_lan_cmd
r_static
r_void
id|report_lan_cmd
c_func
(paren
id|u8
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|LAN_PACKET_SEND
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LAN_PACKET_SEND, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAN_SDU_SEND
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LAN_SDU_SEND, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAN_RECEIVE_POST
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LAN_RECEIVE_POST, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAN_RESET
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LAN_RESET, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAN_SUSPEND
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LAN_SUSPEND, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%02x, &quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* TODO: Add support for other classes */
DECL|function|i2o_report_status
r_void
id|i2o_report_status
c_func
(paren
r_const
r_char
op_star
id|severity
comma
r_const
r_char
op_star
id|module
comma
id|u8
id|cmd
comma
id|u8
id|req_status
comma
id|u16
id|detailed_status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|severity
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
comma
id|module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
OL
l_int|0x1F
)paren
(brace
singleline_comment|// Utility Class
id|report_util_cmd
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|report_common_status
c_func
(paren
id|req_status
)paren
suffix:semicolon
id|report_common_dsc
c_func
(paren
id|detailed_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_ge
l_int|0x30
op_logical_and
id|cmd
op_le
l_int|0x3F
)paren
(brace
singleline_comment|// LAN class
id|report_lan_cmd
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|report_common_status
c_func
(paren
id|req_status
)paren
suffix:semicolon
id|report_lan_dsc
c_func
(paren
id|detailed_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_ge
l_int|0xA0
op_logical_and
id|cmd
op_le
l_int|0xEF
)paren
(brace
singleline_comment|// Executive class
id|report_exec_cmd
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|report_common_status
c_func
(paren
id|req_status
)paren
suffix:semicolon
id|report_common_dsc
c_func
(paren
id|detailed_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%02x, %02x / %04x.&bslash;n&quot;
comma
id|cmd
comma
id|req_status
comma
id|detailed_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|i2o_install_handler
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_install_handler
)paren
suffix:semicolon
DECL|variable|i2o_remove_handler
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_remove_handler
)paren
suffix:semicolon
DECL|variable|i2o_install_device
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_install_device
)paren
suffix:semicolon
DECL|variable|i2o_delete_device
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_delete_device
)paren
suffix:semicolon
DECL|variable|i2o_quiesce_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_quiesce_controller
)paren
suffix:semicolon
DECL|variable|i2o_clear_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_clear_controller
)paren
suffix:semicolon
DECL|variable|i2o_install_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_install_controller
)paren
suffix:semicolon
DECL|variable|i2o_delete_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_delete_controller
)paren
suffix:semicolon
DECL|variable|i2o_unlock_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_unlock_controller
)paren
suffix:semicolon
DECL|variable|i2o_find_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_find_controller
)paren
suffix:semicolon
DECL|variable|i2o_num_controllers
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_num_controllers
)paren
suffix:semicolon
DECL|variable|i2o_claim_device
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_claim_device
)paren
suffix:semicolon
DECL|variable|i2o_release_device
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_release_device
)paren
suffix:semicolon
DECL|variable|i2o_run_queue
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_run_queue
)paren
suffix:semicolon
DECL|variable|i2o_report_controller_unit
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_report_controller_unit
)paren
suffix:semicolon
DECL|variable|i2o_activate_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_activate_controller
)paren
suffix:semicolon
DECL|variable|i2o_online_controller
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_online_controller
)paren
suffix:semicolon
DECL|variable|i2o_get_class_name
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_get_class_name
)paren
suffix:semicolon
DECL|variable|i2o_query_scalar
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_query_scalar
)paren
suffix:semicolon
DECL|variable|i2o_params_set
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_params_set
)paren
suffix:semicolon
DECL|variable|i2o_post_this
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_post_this
)paren
suffix:semicolon
DECL|variable|i2o_post_wait
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_post_wait
)paren
suffix:semicolon
DECL|variable|i2o_issue_claim
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_issue_claim
)paren
suffix:semicolon
DECL|variable|i2o_report_status
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_report_status
)paren
suffix:semicolon
DECL|variable|report_common_status
id|EXPORT_SYMBOL
c_func
(paren
id|report_common_status
)paren
suffix:semicolon
DECL|variable|report_lan_dsc
id|EXPORT_SYMBOL
c_func
(paren
id|report_lan_dsc
)paren
suffix:semicolon
DECL|variable|i2o_wait_message
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_wait_message
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Red Hat Software&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2O Core&quot;
)paren
suffix:semicolon
eof
