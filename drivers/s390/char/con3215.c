multiline_comment|/*&n; *  drivers/s390/char/con3215.c&n; *    3215 line mode terminal driver.&n; *&n; *  S390 version&n; *    Copyright (C) 1999,2000 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Martin Schwidefsky (schwidefsky@de.ibm.com),&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;../../../arch/s390/kernel/cpcmd.h&quot;
macro_line|#include &lt;asm/irq.h&gt;
DECL|macro|NR_3215
mdefine_line|#define NR_3215&t;&t;    1
DECL|macro|NR_3215_REQ
mdefine_line|#define NR_3215_REQ&t;    (4*NR_3215)
DECL|macro|RAW3215_BUFFER_SIZE
mdefine_line|#define RAW3215_BUFFER_SIZE 65536     /* output buffer size */
DECL|macro|RAW3215_INBUF_SIZE
mdefine_line|#define RAW3215_INBUF_SIZE  256&t;      /* input buffer size */
DECL|macro|RAW3215_MIN_SPACE
mdefine_line|#define RAW3215_MIN_SPACE   128&t;      /* minimum free space for wakeup */
DECL|macro|RAW3215_MIN_WRITE
mdefine_line|#define RAW3215_MIN_WRITE   1024      /* min. length for immediate output */
DECL|macro|RAW3215_MAX_CCWLEN
mdefine_line|#define RAW3215_MAX_CCWLEN  3968      /* max. bytes to write with one ccw */
DECL|macro|RAW3215_NR_CCWS
mdefine_line|#define RAW3215_NR_CCWS&t;    ((RAW3215_BUFFER_SIZE/RAW3215_MAX_CCWLEN)+2)
DECL|macro|RAW3215_TIMEOUT
mdefine_line|#define RAW3215_TIMEOUT&t;    HZ/10     /* time for delayed output */
DECL|macro|RAW3215_FIXED
mdefine_line|#define RAW3215_FIXED&t;    1&t;      /* 3215 console device is not be freed */
DECL|macro|RAW3215_ACTIVE
mdefine_line|#define RAW3215_ACTIVE&t;    2&t;      /* set if the device is in use */
DECL|macro|RAW3215_WORKING
mdefine_line|#define RAW3215_WORKING&t;    4&t;      /* set if a request is being worked on */
DECL|macro|RAW3215_THROTTLED
mdefine_line|#define RAW3215_THROTTLED   8&t;      /* set if reading is disabled */
DECL|macro|RAW3215_STOPPED
mdefine_line|#define RAW3215_STOPPED&t;    16&t;      /* set if writing is disabled */
DECL|macro|RAW3215_CLOSING
mdefine_line|#define RAW3215_CLOSING&t;    32&t;      /* set while in close process */
DECL|macro|RAW3215_TIMER_RUNS
mdefine_line|#define RAW3215_TIMER_RUNS  64&t;      /* set if the output delay timer is on */
DECL|macro|RAW3215_FLUSHING
mdefine_line|#define RAW3215_FLUSHING    128&t;      /* set to flush buffer (no delay) */
DECL|macro|RAW3215_BH_PENDING
mdefine_line|#define RAW3215_BH_PENDING  256       /* indication for bh scheduling */
r_struct
id|_raw3215_info
suffix:semicolon
multiline_comment|/* forward declaration ... */
DECL|variable|raw3215_condevice
r_int
id|raw3215_condevice
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* preset console device */
multiline_comment|/*&n; * Request types for a 3215 device&n; */
r_typedef
r_enum
(brace
DECL|enumerator|RAW3215_FREE
DECL|enumerator|RAW3215_READ
DECL|enumerator|RAW3215_WRITE
id|RAW3215_FREE
comma
id|RAW3215_READ
comma
id|RAW3215_WRITE
DECL|typedef|raw3215_type
)brace
id|raw3215_type
suffix:semicolon
multiline_comment|/*&n; * Request structure for a 3215 device&n; */
DECL|struct|_raw3215_req
r_typedef
r_struct
id|_raw3215_req
(brace
DECL|member|type
id|raw3215_type
id|type
suffix:semicolon
multiline_comment|/* type of the request */
DECL|member|start
DECL|member|end
r_int
id|start
comma
id|end
suffix:semicolon
multiline_comment|/* start/end index into output buffer */
DECL|member|residual
r_int
id|residual
suffix:semicolon
multiline_comment|/* residual count for read request */
DECL|member|ccws
id|ccw1_t
id|ccws
(braket
id|RAW3215_NR_CCWS
)braket
suffix:semicolon
multiline_comment|/* space for the channel program */
DECL|member|info
r_struct
id|_raw3215_info
op_star
id|info
suffix:semicolon
multiline_comment|/* pointer to main structure */
DECL|member|next
r_struct
id|_raw3215_req
op_star
id|next
suffix:semicolon
multiline_comment|/* pointer to next request */
DECL|typedef|raw3215_req
)brace
id|raw3215_req
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
DECL|struct|_raw3215_info
r_typedef
r_struct
id|_raw3215_info
(brace
DECL|member|flags
r_int
id|flags
suffix:semicolon
multiline_comment|/* state flags */
DECL|member|irq
r_int
id|irq
suffix:semicolon
multiline_comment|/* interrupt number to do_IO */
DECL|member|buffer
r_char
op_star
id|buffer
suffix:semicolon
multiline_comment|/* pointer to output buffer */
DECL|member|inbuf
r_char
op_star
id|inbuf
suffix:semicolon
multiline_comment|/* pointer to input buffer */
DECL|member|head
r_int
id|head
suffix:semicolon
multiline_comment|/* first free byte in output buffer */
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* number of bytes in output buffer */
DECL|member|devstat
id|devstat_t
id|devstat
suffix:semicolon
multiline_comment|/* device status structure for do_IO */
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
multiline_comment|/* pointer to tty structure if present */
DECL|member|tqueue
r_struct
id|tq_struct
id|tqueue
suffix:semicolon
multiline_comment|/* task queue to bottom half */
DECL|member|queued_read
id|raw3215_req
op_star
id|queued_read
suffix:semicolon
multiline_comment|/* pointer to queued read requests */
DECL|member|queued_write
id|raw3215_req
op_star
id|queued_write
suffix:semicolon
multiline_comment|/* pointer to queued write requests */
DECL|member|empty_wait
id|wait_queue_head_t
id|empty_wait
suffix:semicolon
multiline_comment|/* wait queue for flushing */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* timer for delayed output */
DECL|member|message
r_char
op_star
id|message
suffix:semicolon
multiline_comment|/* pending message from raw3215_irq */
DECL|member|msg_dstat
r_int
id|msg_dstat
suffix:semicolon
multiline_comment|/* dstat for pending message */
DECL|member|msg_cstat
r_int
id|msg_cstat
suffix:semicolon
multiline_comment|/* cstat for pending message */
DECL|typedef|raw3215_info
)brace
id|raw3215_info
suffix:semicolon
DECL|variable|raw3215
r_static
id|raw3215_info
op_star
id|raw3215
(braket
id|NR_3215
)braket
suffix:semicolon
multiline_comment|/* array of 3215 devices structures */
DECL|variable|raw3215_freelist
r_static
id|raw3215_req
op_star
id|raw3215_freelist
suffix:semicolon
multiline_comment|/* list of free request structures */
DECL|variable|raw3215_freelist_lock
r_static
id|spinlock_t
id|raw3215_freelist_lock
suffix:semicolon
multiline_comment|/* spinlock to protect free list */
DECL|variable|tty3215_driver
r_static
r_struct
id|tty_driver
id|tty3215_driver
suffix:semicolon
DECL|variable|tty3215_table
r_static
r_struct
id|tty_struct
op_star
id|tty3215_table
(braket
id|NR_3215
)braket
suffix:semicolon
DECL|variable|tty3215_termios
r_static
r_struct
id|termios
op_star
id|tty3215_termios
(braket
id|NR_3215
)braket
suffix:semicolon
DECL|variable|tty3215_termios_locked
r_static
r_struct
id|termios
op_star
id|tty3215_termios_locked
(braket
id|NR_3215
)braket
suffix:semicolon
DECL|variable|tty3215_refcount
r_static
r_int
id|tty3215_refcount
suffix:semicolon
macro_line|#ifndef MIN
DECL|macro|MIN
mdefine_line|#define MIN(a,b)&t;((a) &lt; (b) ? (a) : (b))
macro_line|#endif
DECL|function|con3215_setup
r_static
r_int
id|__init
id|con3215_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|vdev
suffix:semicolon
id|vdev
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|str
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vdev
op_ge
l_int|0
op_logical_and
id|vdev
OL
l_int|65536
)paren
id|raw3215_condevice
op_assign
id|vdev
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;condev=&quot;
comma
id|con3215_setup
)paren
suffix:semicolon
multiline_comment|/*&n; * Get a request structure from the free list&n; */
DECL|function|raw3215_alloc_req
r_extern
r_inline
id|raw3215_req
op_star
id|raw3215_alloc_req
c_func
(paren
r_void
)paren
(brace
id|raw3215_req
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|raw3215_freelist_lock
comma
id|flags
)paren
suffix:semicolon
id|req
op_assign
id|raw3215_freelist
suffix:semicolon
id|raw3215_freelist
op_assign
id|req-&gt;next
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|raw3215_freelist_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|req
suffix:semicolon
)brace
multiline_comment|/*&n; * Put a request structure back to the free list&n; */
DECL|function|raw3215_free_req
r_extern
r_inline
r_void
id|raw3215_free_req
c_func
(paren
id|raw3215_req
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;type
op_eq
id|RAW3215_FREE
)paren
r_return
suffix:semicolon
multiline_comment|/* don&squot;t free a free request */
id|req-&gt;type
op_assign
id|RAW3215_FREE
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|raw3215_freelist_lock
comma
id|flags
)paren
suffix:semicolon
id|req-&gt;next
op_assign
id|raw3215_freelist
suffix:semicolon
id|raw3215_freelist
op_assign
id|req
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|raw3215_freelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get a write request structure. That is either a new or the last&n; * queued write request. The request structure is set up in &n; * raw3215_mk_write_ccw.&n; */
DECL|function|raw3215_mk_write_req
r_static
id|raw3215_req
op_star
id|raw3215_mk_write_req
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
id|raw3215_req
op_star
id|req
suffix:semicolon
multiline_comment|/* check if there is a queued write request */
id|req
op_assign
id|raw-&gt;queued_write
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no queued write request, use new req structure */
id|req
op_assign
id|raw3215_alloc_req
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;type
op_assign
id|RAW3215_WRITE
suffix:semicolon
id|req-&gt;info
op_assign
id|raw
suffix:semicolon
id|req-&gt;start
op_assign
id|raw-&gt;head
suffix:semicolon
)brace
r_else
id|raw-&gt;queued_write
op_assign
l_int|NULL
suffix:semicolon
r_return
id|req
suffix:semicolon
)brace
multiline_comment|/*&n; * Get a read request structure. If there is a queued read request&n; * it is used, but that shouldn&squot;t happen because a 3215 terminal&n; * won&squot;t accept a new read before the old one is completed.&n; */
DECL|function|raw3215_mk_read_req
r_static
id|raw3215_req
op_star
id|raw3215_mk_read_req
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
id|raw3215_req
op_star
id|req
suffix:semicolon
multiline_comment|/* there can only be ONE read request at a time */
id|req
op_assign
id|raw-&gt;queued_read
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no queued read request, use new req structure */
id|req
op_assign
id|raw3215_alloc_req
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;type
op_assign
id|RAW3215_READ
suffix:semicolon
id|req-&gt;info
op_assign
id|raw
suffix:semicolon
)brace
r_else
id|raw-&gt;queued_read
op_assign
l_int|NULL
suffix:semicolon
r_return
id|req
suffix:semicolon
)brace
multiline_comment|/*&n; * Set up a write request with the information from the main structure.&n; * A ccw chain is created that writes everything in the output buffer&n; * to the 3215 device.&n; */
DECL|function|raw3215_mk_write_ccw
r_static
r_int
id|raw3215_mk_write_ccw
c_func
(paren
id|raw3215_info
op_star
id|raw
comma
id|raw3215_req
op_star
id|req
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_int
id|len
comma
id|count
comma
id|ix
suffix:semicolon
id|ccw
op_assign
id|req-&gt;ccws
suffix:semicolon
id|req-&gt;end
op_assign
(paren
id|raw-&gt;head
op_minus
l_int|1
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|len
op_assign
(paren
(paren
id|req-&gt;end
op_minus
id|req-&gt;start
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
)paren
op_plus
l_int|1
suffix:semicolon
id|ix
op_assign
id|req-&gt;start
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ccw
OG
id|req-&gt;ccws
)paren
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* use command chaining */
id|ccw-&gt;cmd_code
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* write, auto carrier return */
id|ccw-&gt;flags
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* ignore incorrect length ind.  */
id|ccw-&gt;cda
op_assign
(paren
r_void
op_star
)paren
id|virt_to_phys
c_func
(paren
id|raw-&gt;buffer
op_plus
id|ix
)paren
suffix:semicolon
id|count
op_assign
(paren
id|len
OG
id|RAW3215_MAX_CCWLEN
)paren
ques
c_cond
id|RAW3215_MAX_CCWLEN
suffix:colon
id|len
suffix:semicolon
r_if
c_cond
(paren
id|ix
op_plus
id|count
OG
id|RAW3215_BUFFER_SIZE
)paren
id|count
op_assign
id|RAW3215_BUFFER_SIZE
op_minus
id|ix
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
id|len
op_sub_assign
id|count
suffix:semicolon
id|ix
op_assign
(paren
id|ix
op_plus
id|count
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Set up a read request that reads up to 160 byte from the 3215 device.&n; */
DECL|function|raw3215_mk_read_ccw
r_static
r_void
id|raw3215_mk_read_ccw
c_func
(paren
id|raw3215_info
op_star
id|raw
comma
id|raw3215_req
op_star
id|req
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|ccw
op_assign
id|req-&gt;ccws
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
l_int|0x0A
suffix:semicolon
multiline_comment|/* read inquiry */
id|ccw-&gt;flags
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* ignore incorrect length */
id|ccw-&gt;count
op_assign
l_int|160
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_void
op_star
)paren
id|virt_to_phys
c_func
(paren
id|raw-&gt;inbuf
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Start a read or a write request&n; */
DECL|function|raw3215_start_io
r_static
r_void
id|raw3215_start_io
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
id|raw3215_req
op_star
id|req
suffix:semicolon
r_int
id|res
suffix:semicolon
id|req
op_assign
id|raw-&gt;queued_read
suffix:semicolon
r_if
c_cond
(paren
id|req
op_ne
l_int|NULL
op_logical_and
op_logical_neg
(paren
id|raw-&gt;flags
op_amp
(paren
id|RAW3215_WORKING
op_or
id|RAW3215_THROTTLED
)paren
)paren
)paren
(brace
multiline_comment|/* dequeue request */
id|raw-&gt;queued_read
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|do_IO
c_func
(paren
id|raw-&gt;irq
comma
id|req-&gt;ccws
comma
(paren
id|__u32
)paren
id|req
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
l_int|0
)paren
(brace
multiline_comment|/* do_IO failed, put request back to queue */
id|raw-&gt;queued_read
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|raw-&gt;flags
op_or_assign
id|RAW3215_WORKING
suffix:semicolon
)brace
)brace
id|req
op_assign
id|raw-&gt;queued_write
suffix:semicolon
r_if
c_cond
(paren
id|req
op_ne
l_int|NULL
op_logical_and
op_logical_neg
(paren
id|raw-&gt;flags
op_amp
(paren
id|RAW3215_WORKING
op_or
id|RAW3215_STOPPED
)paren
)paren
)paren
(brace
multiline_comment|/* dequeue request */
id|raw-&gt;queued_write
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|do_IO
c_func
(paren
id|raw-&gt;irq
comma
id|req-&gt;ccws
comma
(paren
id|__u32
)paren
id|req
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
l_int|0
)paren
(brace
multiline_comment|/* do_IO failed, put request back to queue */
id|raw-&gt;queued_write
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|raw-&gt;flags
op_or_assign
id|RAW3215_WORKING
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Function to start a delayed output after RAW3215_TIMEOUT seconds&n; */
DECL|function|raw3215_timeout
r_static
r_void
id|raw3215_timeout
c_func
(paren
r_int
r_int
id|__data
)paren
(brace
id|raw3215_info
op_star
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|__data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_TIMER_RUNS
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|raw-&gt;timer
)paren
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_TIMER_RUNS
suffix:semicolon
id|raw3215_start_io
c_func
(paren
id|raw
)paren
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function to conditionally start an IO. A read is started immediatly,&n; * a write is only started immediatly if the flush flag is on or the&n; * amount of data is bigger than RAW3215_MIN_WRITE. If a write is not&n; * done immediatly a timer is started with a delay of RAW3215_TIMEOUT.&n; */
DECL|function|raw3215_try_io
r_extern
r_inline
r_void
id|raw3215_try_io
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_ACTIVE
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;queued_read
op_ne
l_int|NULL
)paren
id|raw3215_start_io
c_func
(paren
id|raw
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|raw-&gt;queued_write
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|raw-&gt;count
op_ge
id|RAW3215_MIN_WRITE
op_logical_or
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_FLUSHING
)paren
)paren
(brace
multiline_comment|/* execute write requests bigger than minimum size */
id|raw3215_start_io
c_func
(paren
id|raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_TIMER_RUNS
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|raw-&gt;timer
)paren
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_TIMER_RUNS
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_TIMER_RUNS
)paren
)paren
(brace
multiline_comment|/* delay small writes */
id|init_timer
c_func
(paren
op_amp
id|raw-&gt;timer
)paren
suffix:semicolon
id|raw-&gt;timer.expires
op_assign
id|RAW3215_TIMEOUT
op_plus
id|jiffies
suffix:semicolon
id|raw-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|raw
suffix:semicolon
id|raw-&gt;timer.function
op_assign
id|raw3215_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|raw-&gt;timer
)paren
suffix:semicolon
id|raw-&gt;flags
op_or_assign
id|RAW3215_TIMER_RUNS
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * The bottom half handler routine for 3215 devices. It tries to start&n; * the next IO and wakes up processes waiting on the tty.&n; */
DECL|function|raw3215_softint
r_static
r_void
id|raw3215_softint
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|data
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|raw3215_try_io
c_func
(paren
(paren
id|raw3215_info
op_star
)paren
id|data
)paren
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_BH_PENDING
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check for pending message from raw3215_irq */
r_if
c_cond
(paren
id|raw-&gt;message
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|raw-&gt;message
comma
id|raw-&gt;irq
comma
id|raw-&gt;msg_dstat
comma
id|raw-&gt;msg_cstat
)paren
suffix:semicolon
id|raw-&gt;message
op_assign
l_int|NULL
suffix:semicolon
)brace
id|tty
op_assign
id|raw-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_ne
l_int|NULL
op_logical_and
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;count
op_ge
id|RAW3215_MIN_SPACE
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function to safely add raw3215_softint to tq_immediate.&n; * The s390irq spinlock must be held.&n; */
DECL|function|raw3215_sched_bh
r_static
r_inline
r_void
id|raw3215_sched_bh
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
r_if
c_cond
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_BH_PENDING
)paren
r_return
suffix:semicolon
multiline_comment|/* already pending */
id|raw-&gt;flags
op_or_assign
id|RAW3215_BH_PENDING
suffix:semicolon
id|raw-&gt;tqueue.routine
op_assign
id|raw3215_softint
suffix:semicolon
id|raw-&gt;tqueue.data
op_assign
id|raw
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|raw-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the raw3215_info structure associated with irq&n; */
DECL|function|raw3215_find_info
r_static
r_inline
id|raw3215_info
op_star
id|raw3215_find_info
c_func
(paren
r_int
id|irq
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_3215
suffix:semicolon
id|i
op_increment
)paren
(brace
id|raw
op_assign
id|raw3215
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|raw
op_ne
l_int|NULL
op_logical_and
id|raw-&gt;irq
op_eq
id|irq
op_logical_and
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_ACTIVE
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
(paren
id|i
op_ge
id|NR_3215
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|raw
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt routine, called from Ingo&squot;s I/O layer&n; */
DECL|function|raw3215_irq
r_static
r_void
id|raw3215_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|int_parm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw3215_req
op_star
id|req
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|devstat_t
op_star
id|stat
suffix:semicolon
r_int
id|cstat
comma
id|dstat
suffix:semicolon
r_int
id|count
comma
id|slen
suffix:semicolon
id|stat
op_assign
(paren
id|devstat_t
op_star
)paren
id|int_parm
suffix:semicolon
id|req
op_assign
(paren
id|raw3215_req
op_star
)paren
id|stat-&gt;intparm
suffix:semicolon
id|cstat
op_assign
id|stat-&gt;cstat
suffix:semicolon
id|dstat
op_assign
id|stat-&gt;dstat
suffix:semicolon
r_if
c_cond
(paren
id|cstat
op_ne
l_int|0
)paren
(brace
id|raw
op_assign
id|raw3215_find_info
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
op_ne
l_int|NULL
)paren
(brace
id|raw-&gt;message
op_assign
id|KERN_WARNING
l_string|&quot;Got nonzero channel status in raw3215_irq &quot;
l_string|&quot;(dev %i, dev sts 0x%2x, sch sts 0x%2x)&quot;
suffix:semicolon
id|raw-&gt;msg_dstat
op_assign
id|dstat
suffix:semicolon
id|raw-&gt;msg_cstat
op_assign
id|cstat
suffix:semicolon
id|raw3215_sched_bh
c_func
(paren
id|raw
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dstat
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* we got a unit exception */
id|dstat
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
multiline_comment|/* we can ignore it */
)brace
r_switch
c_cond
(paren
id|dstat
)paren
(brace
r_case
l_int|0x80
suffix:colon
r_if
c_cond
(paren
id|cstat
op_ne
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Attention interrupt, someone hit the enter key */
r_if
c_cond
(paren
(paren
id|raw
op_assign
id|raw3215_find_info
c_func
(paren
id|irq
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* That shouldn&squot;t happen ... */
multiline_comment|/* Setup a read request */
id|req
op_assign
id|raw3215_mk_read_req
c_func
(paren
id|raw
)paren
suffix:semicolon
id|raw3215_mk_read_ccw
c_func
(paren
id|raw
comma
id|req
)paren
suffix:semicolon
id|raw-&gt;queued_read
op_assign
id|req
suffix:semicolon
r_if
c_cond
(paren
id|MACHINE_IS_P390
)paren
id|memset
c_func
(paren
id|raw-&gt;inbuf
comma
l_int|0
comma
id|RAW3215_INBUF_SIZE
)paren
suffix:semicolon
id|raw3215_sched_bh
c_func
(paren
id|raw
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
r_case
l_int|0x0C
suffix:colon
multiline_comment|/* Channel end interrupt. */
id|raw
op_assign
id|req-&gt;info
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;type
op_eq
id|RAW3215_READ
)paren
(brace
multiline_comment|/* store residual count, then wait for device end */
id|req-&gt;residual
op_assign
id|stat-&gt;rescnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dstat
op_eq
l_int|0x08
)paren
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Device end interrupt. */
id|raw
op_assign
id|req-&gt;info
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;type
op_eq
id|RAW3215_READ
op_logical_and
id|raw-&gt;tty
op_ne
l_int|NULL
)paren
(brace
id|tty
op_assign
id|raw-&gt;tty
suffix:semicolon
id|count
op_assign
l_int|160
op_minus
id|req-&gt;residual
suffix:semicolon
r_if
c_cond
(paren
id|MACHINE_IS_P390
)paren
(brace
id|slen
op_assign
id|strnlen
c_func
(paren
id|raw-&gt;inbuf
comma
id|RAW3215_INBUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|slen
)paren
id|count
op_assign
id|slen
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
op_ge
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
id|count
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
op_minus
l_int|1
suffix:semicolon
id|EBCASC
c_func
(paren
id|raw-&gt;inbuf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
multiline_comment|/* hat is 0xb0 in codepage 037 (US etc.) and thus */
multiline_comment|/* converted to 0x5e in ascii (&squot;^&squot;) */
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
comma
l_string|&quot;^c&quot;
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
multiline_comment|/* hat is 0xb0 in several other codepages (German,*/
multiline_comment|/* UK, ...) and thus converted to ascii octal 252 */
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
comma
l_string|&quot;&bslash;252c&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* emulate a control C = break */
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|INTR_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|raw-&gt;tty
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
comma
l_string|&quot;^d&quot;
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
comma
l_string|&quot;&bslash;252d&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* emulate a control D = end of file */
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|EOF_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|raw-&gt;tty
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
comma
l_string|&quot;^z&quot;
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
comma
l_string|&quot;&bslash;252z&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* emulate a control Z = suspend */
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|SUSP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|raw-&gt;tty
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|raw-&gt;inbuf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|2
op_logical_or
(paren
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
op_plus
id|count
op_minus
l_int|2
comma
l_string|&quot;^n&quot;
comma
l_int|2
)paren
op_logical_or
id|strncmp
c_func
(paren
id|raw-&gt;inbuf
op_plus
id|count
op_minus
l_int|2
comma
l_string|&quot;&bslash;252n&quot;
comma
l_int|2
)paren
)paren
)paren
(brace
multiline_comment|/* don&squot;t add the auto &bslash;n */
id|tty-&gt;flip.char_buf_ptr
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
id|TTY_NORMAL
comma
id|count
op_plus
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_else
id|count
op_sub_assign
l_int|2
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|count
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|raw-&gt;tty
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;type
op_eq
id|RAW3215_WRITE
)paren
(brace
id|raw-&gt;count
op_sub_assign
(paren
(paren
id|req-&gt;end
op_minus
id|req-&gt;start
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_WORKING
suffix:semicolon
id|raw3215_free_req
c_func
(paren
id|req
)paren
suffix:semicolon
multiline_comment|/* check for empty wait */
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|raw-&gt;empty_wait
)paren
op_logical_and
id|raw-&gt;queued_write
op_eq
l_int|NULL
op_logical_and
id|raw-&gt;queued_read
op_eq
l_int|NULL
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|raw-&gt;empty_wait
)paren
suffix:semicolon
)brace
id|raw3215_sched_bh
c_func
(paren
id|raw
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Strange interrupt, I&squot;ll do my best to clean up */
r_if
c_cond
(paren
(paren
id|raw
op_assign
id|raw3215_find_info
c_func
(paren
id|irq
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* That shouldn&squot;t happen ... */
r_if
c_cond
(paren
id|raw
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|req
op_ne
l_int|NULL
op_logical_and
id|req-&gt;type
op_ne
id|RAW3215_FREE
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;type
op_eq
id|RAW3215_WRITE
)paren
id|raw-&gt;count
op_sub_assign
(paren
(paren
id|req-&gt;end
op_minus
id|req-&gt;start
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
)paren
op_plus
l_int|1
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_WORKING
suffix:semicolon
id|raw3215_free_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
id|raw-&gt;message
op_assign
id|KERN_WARNING
l_string|&quot;Spurious interrupt in in raw3215_irq &quot;
l_string|&quot;(dev %i, dev sts 0x%2x, sch sts 0x%2x)&quot;
suffix:semicolon
id|raw-&gt;msg_dstat
op_assign
id|dstat
suffix:semicolon
id|raw-&gt;msg_cstat
op_assign
id|cstat
suffix:semicolon
id|raw3215_sched_bh
c_func
(paren
id|raw
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * String write routine for 3215 devices&n; */
r_static
r_int
DECL|function|raw3215_write
id|raw3215_write
c_func
(paren
id|raw3215_info
op_star
id|raw
comma
r_const
r_char
op_star
id|str
comma
r_int
id|from_user
comma
r_int
r_int
id|length
)paren
(brace
id|raw3215_req
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
comma
id|c
suffix:semicolon
r_int
id|count
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
(paren
id|length
OG
id|RAW3215_BUFFER_SIZE
)paren
ques
c_cond
id|RAW3215_BUFFER_SIZE
suffix:colon
id|length
suffix:semicolon
id|length
op_sub_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;count
OL
id|count
)paren
(brace
multiline_comment|/* there might be a request pending */
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_cons_dev
c_func
(paren
id|raw-&gt;irq
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* that shouldn&squot;t happen */
id|raw-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|req
op_assign
id|raw3215_mk_write_req
c_func
(paren
id|raw
)paren
suffix:semicolon
multiline_comment|/* copy string to output buffer and convert it to EBCDIC */
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
id|MIN
c_func
(paren
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;count
comma
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|c
op_sub_assign
id|copy_from_user
c_func
(paren
id|raw-&gt;buffer
op_plus
id|raw-&gt;head
comma
id|str
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ASCEBC
c_func
(paren
id|raw-&gt;buffer
op_plus
id|raw-&gt;head
comma
id|c
)paren
suffix:semicolon
id|raw-&gt;head
op_assign
(paren
id|raw-&gt;head
op_plus
id|c
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|raw-&gt;count
op_add_assign
id|c
suffix:semicolon
id|str
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
id|MIN
c_func
(paren
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;count
comma
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|memcpy
c_func
(paren
id|raw-&gt;buffer
op_plus
id|raw-&gt;head
comma
id|str
comma
id|c
)paren
suffix:semicolon
id|ASCEBC
c_func
(paren
id|raw-&gt;buffer
op_plus
id|raw-&gt;head
comma
id|c
)paren
suffix:semicolon
id|raw-&gt;head
op_assign
(paren
id|raw-&gt;head
op_plus
id|c
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|raw-&gt;count
op_add_assign
id|c
suffix:semicolon
id|str
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
)brace
id|raw3215_mk_write_ccw
c_func
(paren
id|raw
comma
id|req
)paren
suffix:semicolon
id|raw-&gt;queued_write
op_assign
id|req
suffix:semicolon
multiline_comment|/* start or queue request */
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Put character routine for 3215 devices&n; */
DECL|function|raw3215_putchar
r_static
r_void
id|raw3215_putchar
c_func
(paren
id|raw3215_info
op_star
id|raw
comma
r_int
r_char
id|ch
)paren
(brace
id|raw3215_req
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;count
OL
l_int|1
)paren
(brace
multiline_comment|/* there might be a request pending */
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_cons_dev
c_func
(paren
id|raw-&gt;irq
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* that shouldn&squot;t happen */
id|raw-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|req
op_assign
id|raw3215_mk_write_req
c_func
(paren
id|raw
)paren
suffix:semicolon
id|raw-&gt;buffer
(braket
id|raw-&gt;head
)braket
op_assign
(paren
r_char
)paren
id|_ascebc
(braket
(paren
r_int
)paren
id|ch
)braket
suffix:semicolon
id|raw-&gt;head
op_assign
(paren
id|raw-&gt;head
op_plus
l_int|1
)paren
op_amp
(paren
id|RAW3215_BUFFER_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|raw-&gt;count
op_increment
suffix:semicolon
id|raw3215_mk_write_ccw
c_func
(paren
id|raw
comma
id|req
)paren
suffix:semicolon
id|raw-&gt;queued_write
op_assign
id|req
suffix:semicolon
multiline_comment|/* start or queue request */
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Flush routine, it simply sets the flush flag and tries to start &n; * pending IO.&n; */
DECL|function|raw3215_flush_buffer
r_static
r_void
id|raw3215_flush_buffer
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;count
OG
l_int|0
)paren
(brace
id|raw-&gt;flags
op_or_assign
id|RAW3215_FLUSHING
suffix:semicolon
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_FLUSHING
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Fire up a 3215 device.&n; */
DECL|function|raw3215_startup
r_static
r_int
id|raw3215_startup
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_ACTIVE
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|raw-&gt;irq
comma
id|raw3215_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;3215 terminal driver&quot;
comma
op_amp
id|raw-&gt;devstat
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|raw-&gt;flags
op_or_assign
id|RAW3215_ACTIVE
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown a 3215 device.&n; */
DECL|function|raw3215_shutdown
r_static
r_void
id|raw3215_shutdown
c_func
(paren
id|raw3215_info
op_star
id|raw
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_ACTIVE
)paren
op_logical_or
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_FIXED
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Wait for outstanding requests, then free irq */
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_WORKING
)paren
op_logical_or
id|raw-&gt;queued_write
op_ne
l_int|NULL
op_logical_or
id|raw-&gt;queued_read
op_ne
l_int|NULL
)paren
(brace
id|raw-&gt;flags
op_or_assign
id|RAW3215_CLOSING
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|raw-&gt;empty_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|raw-&gt;empty_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
(paren
id|RAW3215_ACTIVE
op_or
id|RAW3215_CLOSING
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|raw-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|raw3215_find_dev
id|raw3215_find_dev
c_func
(paren
r_int
id|number
)paren
(brace
id|dev_info_t
id|dinfo
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|count
suffix:semicolon
id|irq
op_assign
id|get_irq_first
c_func
(paren
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
op_le
id|number
op_logical_and
id|irq
op_ne
op_minus
id|ENODEV
)paren
(brace
r_if
c_cond
(paren
id|get_dev_info
c_func
(paren
id|irq
comma
op_amp
id|dinfo
)paren
op_eq
op_minus
id|ENODEV
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|dinfo.devno
op_eq
id|raw3215_condevice
op_logical_or
id|dinfo.sid_data.cu_type
op_eq
l_int|0x3215
)paren
(brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|number
)paren
r_return
id|irq
suffix:semicolon
)brace
id|irq
op_assign
id|get_irq_next
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* console not found */
)brace
macro_line|#ifdef CONFIG_3215_CONSOLE
multiline_comment|/*&n; * Try to request the console IRQ. Called from init/main.c&n; */
DECL|function|con3215_activate
r_int
id|con3215_activate
c_func
(paren
r_void
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACHINE_IS_VM
op_logical_and
op_logical_neg
id|MACHINE_IS_P390
)paren
r_return
l_int|0
suffix:semicolon
id|raw
op_assign
id|raw3215
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* 3215 console is the first one */
r_if
c_cond
(paren
id|raw-&gt;irq
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* now console device found in con3215_init */
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|raw3215_startup
c_func
(paren
id|raw
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write a string to the 3215 console&n; */
r_static
r_void
DECL|function|con3215_write
id|con3215_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|str
comma
r_int
r_int
id|count
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|raw
op_assign
id|raw3215
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* console 3215 is the first one */
id|raw3215_write
c_func
(paren
id|raw
comma
id|str
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|con3215_device
id|kdev_t
id|con3215_device
c_func
(paren
r_struct
id|console
op_star
id|c
)paren
(brace
r_return
id|MKDEV
c_func
(paren
id|TTY_MAJOR
comma
id|c-&gt;index
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * panic() calls console_unblank before the system enters a&n; * disabled, endless loop.&n; */
DECL|function|con3215_unblank
r_void
id|con3215_unblank
c_func
(paren
r_void
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|raw
op_assign
id|raw3215
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* console 3215 is the first one */
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|raw-&gt;count
OG
l_int|0
)paren
(brace
multiline_comment|/* there might be a request pending */
id|raw-&gt;flags
op_or_assign
id|RAW3215_FLUSHING
suffix:semicolon
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_cons_dev
c_func
(paren
id|raw-&gt;irq
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* that shouldn&squot;t happen */
id|raw-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_FLUSHING
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|con3215_consetup
r_static
r_int
id|__init
id|con3215_consetup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  The console structure for the 3215 console&n; */
DECL|variable|con3215
r_static
r_struct
id|console
id|con3215
op_assign
(brace
id|name
suffix:colon
l_string|&quot;tty3215&quot;
comma
id|write
suffix:colon
id|con3215_write
comma
id|device
suffix:colon
id|con3215_device
comma
id|unblank
suffix:colon
id|con3215_unblank
comma
id|setup
suffix:colon
id|con3215_consetup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * tty3215_open&n; *&n; * This routine is called whenever a 3215 tty is opened.&n; */
DECL|function|tty3215_open
r_static
r_int
id|tty3215_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
OL
l_int|0
)paren
op_logical_or
(paren
id|line
op_ge
id|NR_3215
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|raw
op_assign
id|raw3215
(braket
id|line
)braket
suffix:semicolon
r_if
c_cond
(paren
id|raw
op_eq
l_int|NULL
)paren
(brace
id|raw
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|raw3215_info
)paren
op_plus
id|RAW3215_INBUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|raw-&gt;irq
op_assign
id|raw3215_find_dev
c_func
(paren
id|line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;irq
op_eq
op_minus
l_int|1
)paren
(brace
id|kfree
c_func
(paren
id|raw
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|raw-&gt;inbuf
op_assign
(paren
r_char
op_star
)paren
id|raw
op_plus
r_sizeof
(paren
id|raw3215_info
)paren
suffix:semicolon
id|memset
c_func
(paren
id|raw
comma
l_int|0
comma
r_sizeof
(paren
id|raw3215_info
)paren
)paren
suffix:semicolon
id|raw-&gt;buffer
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|RAW3215_BUFFER_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;buffer
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|raw
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|raw-&gt;tqueue.routine
op_assign
id|raw3215_softint
suffix:semicolon
id|raw-&gt;tqueue.data
op_assign
id|raw
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|raw-&gt;empty_wait
)paren
suffix:semicolon
id|raw3215
(braket
id|line
)braket
op_assign
id|raw
suffix:semicolon
)brace
id|tty-&gt;driver_data
op_assign
id|raw
suffix:semicolon
id|raw-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tty-&gt;low_latency
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t use bottom half for pushing chars */
multiline_comment|/*&n;&t; * Start up 3215 device&n;&t; */
id|retval
op_assign
id|raw3215_startup
c_func
(paren
id|raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3215_close()&n; *&n; * This routine is called when the 3215 tty is closed. We wait&n; * for the remaining request to be completed. Then we clean up.&n; */
DECL|function|tty3215_close
r_static
r_void
id|tty3215_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|raw
op_eq
l_int|NULL
op_logical_or
id|tty-&gt;count
OG
l_int|1
)paren
r_return
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Shutdown the terminal */
id|raw3215_shutdown
c_func
(paren
id|raw
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|raw-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns the amount of free space in the output buffer.&n; */
DECL|function|tty3215_write_room
r_static
r_int
id|tty3215_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_return
id|RAW3215_BUFFER_SIZE
op_minus
id|raw-&gt;count
suffix:semicolon
)brace
multiline_comment|/*&n; * String write routine for 3215 ttys&n; */
DECL|function|tty3215_write
r_static
r_int
id|tty3215_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
l_int|0
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ret
op_assign
id|raw3215_write
c_func
(paren
id|raw
comma
id|buf
comma
id|from_user
comma
id|count
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Put character routine for 3215 ttys&n; */
DECL|function|tty3215_put_char
r_static
r_void
id|tty3215_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|raw3215_putchar
c_func
(paren
id|raw
comma
id|ch
)paren
suffix:semicolon
)brace
DECL|function|tty3215_flush_chars
r_static
r_void
id|tty3215_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
)brace
multiline_comment|/*&n; * Returns the number of characters in the output buffer&n; */
DECL|function|tty3215_chars_in_buffer
r_static
r_int
id|tty3215_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_return
id|raw-&gt;count
suffix:semicolon
)brace
DECL|function|tty3215_flush_buffer
r_static
r_void
id|tty3215_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|raw3215_flush_buffer
c_func
(paren
id|raw
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Currently we don&squot;t have any io controls for 3215 ttys&n; */
DECL|function|tty3215_ioctl
r_static
r_int
id|tty3215_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Disable reading from a 3215 tty&n; */
DECL|function|tty3215_throttle
r_static
r_void
id|tty3215_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|raw-&gt;flags
op_or_assign
id|RAW3215_THROTTLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Enable reading from a 3215 tty&n; */
DECL|function|tty3215_unthrottle
r_static
r_void
id|tty3215_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_THROTTLED
)paren
(brace
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_THROTTLED
suffix:semicolon
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Disable writing to a 3215 tty&n; */
DECL|function|tty3215_stop
r_static
r_void
id|tty3215_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|raw-&gt;flags
op_or_assign
id|RAW3215_STOPPED
suffix:semicolon
)brace
multiline_comment|/*&n; * Enable writing to a 3215 tty&n; */
DECL|function|tty3215_start
r_static
r_void
id|tty3215_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;flags
op_amp
id|RAW3215_STOPPED
)paren
(brace
id|s390irq_spin_lock_irqsave
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|raw-&gt;flags
op_and_assign
op_complement
id|RAW3215_STOPPED
suffix:semicolon
id|raw3215_try_io
c_func
(paren
id|raw
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|raw-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * 3215 console driver boottime initialization code.&n; * Register console. We can&squot;t request the IRQ here, because&n; * it&squot;s too early (kmalloc isn&squot;t working yet). We&squot;ll have to&n; * buffer all the console requests until we can request the&n; * irq. For this purpose we use some pages of fixed memory.&n; */
DECL|function|con3215_init
r_void
id|__init
id|con3215_init
c_func
(paren
r_void
)paren
(brace
id|raw3215_info
op_star
id|raw
suffix:semicolon
id|raw3215_req
op_star
id|req
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACHINE_IS_VM
op_logical_and
op_logical_neg
id|MACHINE_IS_P390
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
id|cpcmd
c_func
(paren
l_string|&quot;TERM CONMODE 3215&quot;
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|cpcmd
c_func
(paren
l_string|&quot;TERM AUTOCR OFF&quot;
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate 3215 request structures */
id|raw3215_freelist
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|raw3215_freelist_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_3215_REQ
suffix:semicolon
id|i
op_increment
)paren
(brace
id|req
op_assign
(paren
id|raw3215_req
op_star
)paren
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
id|raw3215_req
)paren
)paren
suffix:semicolon
id|req-&gt;next
op_assign
id|raw3215_freelist
suffix:semicolon
id|raw3215_freelist
op_assign
id|req
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_3215_CONSOLE
id|raw3215
(braket
l_int|0
)braket
op_assign
id|raw
op_assign
(paren
id|raw3215_info
op_star
)paren
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
id|raw3215_info
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|raw
comma
l_int|0
comma
r_sizeof
(paren
id|raw3215_info
)paren
)paren
suffix:semicolon
id|raw-&gt;buffer
op_assign
(paren
r_char
op_star
)paren
id|alloc_bootmem
c_func
(paren
id|RAW3215_BUFFER_SIZE
)paren
suffix:semicolon
id|raw-&gt;inbuf
op_assign
(paren
r_char
op_star
)paren
id|alloc_bootmem
c_func
(paren
id|RAW3215_INBUF_SIZE
)paren
suffix:semicolon
multiline_comment|/* Find the first console */
id|raw-&gt;irq
op_assign
id|raw3215_find_dev
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|raw-&gt;flags
op_or_assign
id|RAW3215_FIXED
suffix:semicolon
id|raw-&gt;tqueue.routine
op_assign
id|raw3215_softint
suffix:semicolon
id|raw-&gt;tqueue.data
op_assign
id|raw
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|raw-&gt;empty_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw-&gt;irq
op_ne
op_minus
l_int|1
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|con3215
)paren
suffix:semicolon
id|s390irq_spin_lock
c_func
(paren
id|raw-&gt;irq
)paren
suffix:semicolon
id|set_cons_dev
c_func
(paren
id|raw-&gt;irq
)paren
suffix:semicolon
id|s390irq_spin_unlock
c_func
(paren
id|raw-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|free_bootmem
c_func
(paren
(paren
r_int
r_int
)paren
id|raw-&gt;inbuf
comma
id|RAW3215_INBUF_SIZE
)paren
suffix:semicolon
id|free_bootmem
c_func
(paren
(paren
r_int
r_int
)paren
id|raw-&gt;buffer
comma
id|RAW3215_BUFFER_SIZE
)paren
suffix:semicolon
id|free_bootmem
c_func
(paren
(paren
r_int
r_int
)paren
id|raw
comma
r_sizeof
(paren
id|raw3215_info
)paren
)paren
suffix:semicolon
id|raw3215
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t find a 3215 console device&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Initialize the tty_driver structure&n;&t; * Entries in tty3215_driver that are NOT initialized:&n;&t; * proc_entry, set_termios, flush_buffer, set_ldisc, write_proc&n;&t; */
id|memset
c_func
(paren
op_amp
id|tty3215_driver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|tty3215_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|tty3215_driver.driver_name
op_assign
l_string|&quot;tty3215&quot;
suffix:semicolon
id|tty3215_driver.name
op_assign
l_string|&quot;ttyS&quot;
suffix:semicolon
id|tty3215_driver.name_base
op_assign
l_int|0
suffix:semicolon
id|tty3215_driver.major
op_assign
id|TTY_MAJOR
suffix:semicolon
id|tty3215_driver.minor_start
op_assign
l_int|64
suffix:semicolon
id|tty3215_driver.num
op_assign
id|NR_3215
suffix:semicolon
id|tty3215_driver.type
op_assign
id|TTY_DRIVER_TYPE_SYSTEM
suffix:semicolon
id|tty3215_driver.subtype
op_assign
id|SYSTEM_TYPE_TTY
suffix:semicolon
id|tty3215_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|tty3215_driver.init_termios.c_iflag
op_assign
id|IGNBRK
op_or
id|IGNPAR
suffix:semicolon
id|tty3215_driver.init_termios.c_oflag
op_assign
id|ONLCR
suffix:semicolon
id|tty3215_driver.init_termios.c_lflag
op_assign
id|ISIG
suffix:semicolon
id|tty3215_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|tty3215_driver.refcount
op_assign
op_amp
id|tty3215_refcount
suffix:semicolon
id|tty3215_driver.table
op_assign
id|tty3215_table
suffix:semicolon
id|tty3215_driver.termios
op_assign
id|tty3215_termios
suffix:semicolon
id|tty3215_driver.termios_locked
op_assign
id|tty3215_termios_locked
suffix:semicolon
id|tty3215_driver.open
op_assign
id|tty3215_open
suffix:semicolon
id|tty3215_driver.close
op_assign
id|tty3215_close
suffix:semicolon
id|tty3215_driver.write
op_assign
id|tty3215_write
suffix:semicolon
id|tty3215_driver.put_char
op_assign
id|tty3215_put_char
suffix:semicolon
id|tty3215_driver.flush_chars
op_assign
id|tty3215_flush_chars
suffix:semicolon
id|tty3215_driver.write_room
op_assign
id|tty3215_write_room
suffix:semicolon
id|tty3215_driver.chars_in_buffer
op_assign
id|tty3215_chars_in_buffer
suffix:semicolon
id|tty3215_driver.flush_buffer
op_assign
id|tty3215_flush_buffer
suffix:semicolon
id|tty3215_driver.ioctl
op_assign
id|tty3215_ioctl
suffix:semicolon
id|tty3215_driver.throttle
op_assign
id|tty3215_throttle
suffix:semicolon
id|tty3215_driver.unthrottle
op_assign
id|tty3215_unthrottle
suffix:semicolon
id|tty3215_driver.send_xchar
op_assign
l_int|NULL
suffix:semicolon
id|tty3215_driver.set_termios
op_assign
l_int|NULL
suffix:semicolon
id|tty3215_driver.stop
op_assign
id|tty3215_stop
suffix:semicolon
id|tty3215_driver.start
op_assign
id|tty3215_start
suffix:semicolon
id|tty3215_driver.hangup
op_assign
l_int|NULL
suffix:semicolon
id|tty3215_driver.break_ctl
op_assign
l_int|NULL
suffix:semicolon
id|tty3215_driver.wait_until_sent
op_assign
l_int|NULL
suffix:semicolon
id|tty3215_driver.read_proc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|tty3215_driver
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t register tty3215 driver&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
