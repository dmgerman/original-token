multiline_comment|/*&n; *  drivers/s390/char/hwc_tty.c&n; *    HWC line mode terminal driver.&n; *&n; *  S390 version&n; *    Copyright (C) 1999 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Martin Peschke &lt;peschke@fh-brandenburg.de&gt;&n; *&n; *  Thanks to Martin Schwidefsky.&n; */
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;hwc_rw.h&quot;
DECL|macro|HWC_TTY_PRINT_HEADER
mdefine_line|#define HWC_TTY_PRINT_HEADER &quot;hwc tty driver: &quot;
DECL|macro|HWC_TTY_BUF_SIZE
mdefine_line|#define HWC_TTY_BUF_SIZE 512
r_typedef
r_struct
(brace
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|buf
r_int
r_char
id|buf
(braket
id|HWC_TTY_BUF_SIZE
)braket
suffix:semicolon
DECL|member|buf_count
r_int
r_int
r_int
id|buf_count
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|typedef|hwc_tty_data_struct
)brace
id|hwc_tty_data_struct
suffix:semicolon
DECL|variable|hwc_tty_data
r_static
id|hwc_tty_data_struct
id|hwc_tty_data
suffix:semicolon
DECL|variable|hwc_tty_driver
r_static
r_struct
id|tty_driver
id|hwc_tty_driver
suffix:semicolon
DECL|variable|hwc_tty_table
r_static
r_struct
id|tty_struct
op_star
id|hwc_tty_table
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|hwc_tty_termios
r_static
r_struct
id|termios
op_star
id|hwc_tty_termios
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|hwc_tty_termios_locked
r_static
r_struct
id|termios
op_star
id|hwc_tty_termios_locked
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|hwc_tty_refcount
r_static
r_int
id|hwc_tty_refcount
op_assign
l_int|0
suffix:semicolon
r_extern
r_struct
id|termios
id|tty_std_termios
suffix:semicolon
r_static
r_int
DECL|function|hwc_tty_open
id|hwc_tty_open
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_if
c_cond
(paren
id|MINOR
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|tty-&gt;driver_data
op_assign
op_amp
id|hwc_tty_data
suffix:semicolon
id|hwc_tty_data.buf_count
op_assign
l_int|0
suffix:semicolon
id|hwc_tty_data.tty
op_assign
id|tty
suffix:semicolon
id|tty-&gt;low_latency
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|wake_up_hwc_tty
id|wake_up_hwc_tty
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hwc_tty_data.tty
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hwc_tty_data.tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|hwc_tty_data.tty-&gt;ldisc.write_wakeup
)paren
(paren
id|hwc_tty_data.tty-&gt;ldisc.write_wakeup
)paren
(paren
id|hwc_tty_data.tty
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|hwc_tty_data.tty-&gt;write_wait
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|hwc_tty_close
id|hwc_tty_close
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_if
c_cond
(paren
id|MINOR
(paren
id|tty-&gt;device
)paren
op_ne
id|tty-&gt;driver.minor_start
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|HWC_TTY_PRINT_HEADER
l_string|&quot;do not close hwc tty because of wrong device number&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|hwc_tty_data.tty
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|hwc_tty_write_room
id|hwc_tty_write_room
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|hwc_write_room
(paren
id|IN_BUFS_TOTAL
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|hwc_tty_write
id|hwc_tty_write
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|hwc_tty_data.buf_count
OG
l_int|0
)paren
(brace
id|hwc_write
(paren
l_int|0
comma
id|hwc_tty_data.buf
comma
id|hwc_tty_data.buf_count
)paren
suffix:semicolon
id|hwc_tty_data.buf_count
op_assign
l_int|0
suffix:semicolon
)brace
id|retval
op_assign
id|hwc_write
(paren
id|from_user
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_void
DECL|function|hwc_tty_put_char
id|hwc_tty_put_char
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|hwc_tty_data.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwc_tty_data.buf_count
op_ge
id|HWC_TTY_BUF_SIZE
)paren
(brace
id|hwc_write
(paren
l_int|0
comma
id|hwc_tty_data.buf
comma
id|hwc_tty_data.buf_count
)paren
suffix:semicolon
id|hwc_tty_data.buf_count
op_assign
l_int|0
suffix:semicolon
)brace
id|hwc_tty_data.buf
(braket
id|hwc_tty_data.buf_count
)braket
op_assign
id|ch
suffix:semicolon
id|hwc_tty_data.buf_count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|hwc_tty_data.lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|hwc_tty_flush_chars
id|hwc_tty_flush_chars
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|hwc_tty_data.lock
comma
id|flags
)paren
suffix:semicolon
id|hwc_write
(paren
l_int|0
comma
id|hwc_tty_data.buf
comma
id|hwc_tty_data.buf_count
)paren
suffix:semicolon
id|hwc_tty_data.buf_count
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|hwc_tty_data.lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|hwc_tty_chars_in_buffer
id|hwc_tty_chars_in_buffer
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|hwc_chars_in_buffer
(paren
id|IN_BUFS_TOTAL
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_void
DECL|function|hwc_tty_flush_buffer
id|hwc_tty_flush_buffer
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|wake_up_hwc_tty
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|hwc_tty_ioctl
id|hwc_tty_ioctl
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|hwc_ioctl
(paren
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_void
DECL|function|store_hwc_input
id|store_hwc_input
(paren
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|hwc_tty_data.tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
multiline_comment|/* hat is 0xb0 in codepage 037 (US etc.) and thus */
multiline_comment|/* converted to 0x5e in ascii (&squot;^&squot;) */
id|strncmp
(paren
id|buf
comma
l_string|&quot;^c&quot;
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
multiline_comment|/* hat is 0xb0 in several other codepages (German, */
multiline_comment|/* UK, ...) and thus converted to ascii octal 252 */
id|strncmp
(paren
id|buf
comma
l_string|&quot;&bslash;0252c&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|INTR_CHAR
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
id|strncmp
(paren
id|buf
comma
l_string|&quot;^d&quot;
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
id|strncmp
(paren
id|buf
comma
l_string|&quot;&bslash;0252d&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|EOF_CHAR
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
id|strncmp
(paren
id|buf
comma
l_string|&quot;^z&quot;
comma
l_int|2
)paren
op_eq
l_int|0
op_logical_or
id|strncmp
(paren
id|buf
comma
l_string|&quot;&bslash;0252z&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|SUSP_CHAR
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|2
op_logical_or
(paren
id|strncmp
(paren
id|buf
op_plus
id|count
op_minus
l_int|2
comma
l_string|&quot;^n&quot;
comma
l_int|2
)paren
op_logical_or
id|strncmp
(paren
id|buf
op_plus
id|count
op_minus
l_int|2
comma
l_string|&quot;&bslash;0252n&quot;
comma
l_int|2
)paren
)paren
)paren
(brace
id|tty-&gt;flip.char_buf_ptr
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_else
id|count
op_sub_assign
l_int|2
suffix:semicolon
id|memset
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
id|TTY_NORMAL
comma
id|count
)paren
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|count
suffix:semicolon
)brace
id|tty_flip_buffer_push
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_hwc_tty
(paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|hwc_tty_init
id|hwc_tty_init
(paren
r_void
)paren
(brace
id|memset
(paren
op_amp
id|hwc_tty_driver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|hwc_tty_data
comma
l_int|0
comma
r_sizeof
(paren
id|hwc_tty_data_struct
)paren
)paren
suffix:semicolon
id|hwc_tty_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|hwc_tty_driver.driver_name
op_assign
l_string|&quot;tty_hwc&quot;
suffix:semicolon
id|hwc_tty_driver.name
op_assign
l_string|&quot;ttyS&quot;
suffix:semicolon
id|hwc_tty_driver.name_base
op_assign
l_int|0
suffix:semicolon
id|hwc_tty_driver.major
op_assign
id|TTY_MAJOR
suffix:semicolon
id|hwc_tty_driver.minor_start
op_assign
l_int|64
suffix:semicolon
id|hwc_tty_driver.num
op_assign
l_int|1
suffix:semicolon
id|hwc_tty_driver.type
op_assign
id|TTY_DRIVER_TYPE_SYSTEM
suffix:semicolon
id|hwc_tty_driver.subtype
op_assign
id|SYSTEM_TYPE_TTY
suffix:semicolon
id|hwc_tty_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|hwc_tty_driver.init_termios.c_iflag
op_assign
id|IGNBRK
op_or
id|IGNPAR
suffix:semicolon
id|hwc_tty_driver.init_termios.c_oflag
op_assign
id|ONLCR
suffix:semicolon
id|hwc_tty_driver.init_termios.c_lflag
op_assign
id|ISIG
op_or
id|ECHO
suffix:semicolon
id|hwc_tty_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|hwc_tty_driver.refcount
op_assign
op_amp
id|hwc_tty_refcount
suffix:semicolon
id|hwc_tty_driver.table
op_assign
id|hwc_tty_table
suffix:semicolon
id|hwc_tty_driver.termios
op_assign
id|hwc_tty_termios
suffix:semicolon
id|hwc_tty_driver.termios_locked
op_assign
id|hwc_tty_termios_locked
suffix:semicolon
id|hwc_tty_driver.open
op_assign
id|hwc_tty_open
suffix:semicolon
id|hwc_tty_driver.close
op_assign
l_int|NULL
multiline_comment|/* hwc_tty_close */
suffix:semicolon
id|hwc_tty_driver.write
op_assign
id|hwc_tty_write
suffix:semicolon
id|hwc_tty_driver.put_char
op_assign
id|hwc_tty_put_char
suffix:semicolon
id|hwc_tty_driver.flush_chars
op_assign
id|hwc_tty_flush_chars
suffix:semicolon
id|hwc_tty_driver.write_room
op_assign
id|hwc_tty_write_room
suffix:semicolon
id|hwc_tty_driver.chars_in_buffer
op_assign
id|hwc_tty_chars_in_buffer
suffix:semicolon
id|hwc_tty_driver.flush_buffer
op_assign
id|hwc_tty_flush_buffer
suffix:semicolon
id|hwc_tty_driver.ioctl
op_assign
id|hwc_tty_ioctl
suffix:semicolon
id|hwc_tty_driver.throttle
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.unthrottle
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.send_xchar
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.set_termios
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.set_ldisc
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.stop
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.start
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.hangup
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.break_ctl
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.wait_until_sent
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.read_proc
op_assign
l_int|NULL
suffix:semicolon
id|hwc_tty_driver.write_proc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
(paren
op_amp
id|hwc_tty_driver
)paren
)paren
id|panic
(paren
l_string|&quot;Couldn&squot;t register hwc_tty driver&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
