multiline_comment|/* &n; * File...........: linux/drivers/s390/block/dasd_ccwstuff.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999,2000&n; */
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/dasd.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;dasd_types.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;dasd_ccw:&quot;
DECL|macro|MAX_CP_POWER
mdefine_line|#define MAX_CP_POWER 9&t;&t;/* Maximum allowed index */
DECL|macro|CP_PER_PAGE_POWER
mdefine_line|#define CP_PER_PAGE_POWER 9&t;/* Maximum index, fitting on page */
DECL|macro|get_free_pages
mdefine_line|#define get_free_pages __get_free_pages
multiline_comment|/* Stuff for the handling task_list */
DECL|variable|cq_head
id|dasd_chanq_t
op_star
id|cq_head
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* head of task_list */
DECL|variable|chanq_tasks
id|atomic_t
id|chanq_tasks
suffix:semicolon
multiline_comment|/* Array of freelists for the channel programs&squot; -space */
DECL|variable|ccwarea
r_static
id|ccw1_t
op_star
id|ccwarea
(braket
id|CP_PER_PAGE_POWER
op_plus
l_int|1
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* array of pages retrieved for internal use */
DECL|macro|MAX_DASD_PAGES
mdefine_line|#define MAX_DASD_PAGES 64
DECL|variable|dasd_page_count
r_static
r_int
id|dasd_page_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|dasd_page
r_static
r_int
id|dasd_page
(braket
id|MAX_DASD_PAGES
)braket
suffix:semicolon
DECL|variable|ccw_lock
r_static
id|spinlock_t
id|ccw_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* spinlock for ccwareas */
DECL|variable|cq_lock
r_static
id|spinlock_t
id|cq_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* spinlock for cq_head */
r_void
DECL|function|ccwarea_enq
id|ccwarea_enq
(paren
r_int
id|index
comma
id|ccw1_t
op_star
id|area
)paren
(brace
id|FUNCTION_ENTRY
(paren
l_string|&quot;ccwarea_enq&quot;
)paren
suffix:semicolon
macro_line|#if DASD_PARANOIA &gt; 2
r_if
c_cond
(paren
op_logical_neg
id|area
)paren
(brace
id|INTERNAL_CHECK
(paren
l_string|&quot;zero area %s&bslash;n&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|index
OG
id|CP_PER_PAGE_POWER
)paren
(brace
id|INTERNAL_CHECK
(paren
l_string|&quot;index too large %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
)brace
macro_line|#endif
op_star
(paren
id|ccw1_t
op_star
op_star
)paren
id|area
op_assign
id|ccwarea
(braket
id|index
)braket
suffix:semicolon
id|ccwarea
(braket
id|index
)braket
op_assign
id|area
suffix:semicolon
id|FUNCTION_EXIT
(paren
l_string|&quot;ccwarea_enq&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ccw1_t
op_star
DECL|function|ccwarea_deq
id|ccwarea_deq
(paren
r_int
id|index
)paren
(brace
id|ccw1_t
op_star
id|cp
suffix:semicolon
id|FUNCTION_ENTRY
(paren
l_string|&quot;ccwarea_deq&quot;
)paren
suffix:semicolon
macro_line|#if DASD_PARANOIA &gt; 2
r_if
c_cond
(paren
id|index
OG
id|CP_PER_PAGE_POWER
)paren
(brace
id|INTERNAL_CHECK
(paren
l_string|&quot;index too large %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
)brace
macro_line|#endif
id|cp
op_assign
id|ccwarea
(braket
id|index
)braket
suffix:semicolon
id|ccwarea
(braket
id|index
)braket
op_assign
op_star
(paren
id|ccw1_t
op_star
op_star
)paren
id|ccwarea
(braket
id|index
)braket
suffix:semicolon
macro_line|#if DASD_PARANOIA &gt; 2
r_if
c_cond
(paren
op_logical_neg
id|cp
)paren
(brace
id|INTERNAL_CHECK
(paren
l_string|&quot;returning NULL %s&bslash;n&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|FUNCTION_EXIT
(paren
l_string|&quot;ccwarea_deq&quot;
)paren
suffix:semicolon
r_return
id|cp
suffix:semicolon
)brace
id|ccw1_t
op_star
DECL|function|request_cpa
id|request_cpa
(paren
r_int
id|index
)paren
(brace
id|ccw1_t
op_star
id|freeblk
suffix:semicolon
id|FUNCTION_ENTRY
(paren
l_string|&quot;request_cpa&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
OG
id|MAX_CP_POWER
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;index too large %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|freeblk
op_assign
l_int|NULL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|index
OG
id|CP_PER_PAGE_POWER
)paren
(brace
r_int
id|pc
op_assign
l_int|1
op_lshift
(paren
id|index
op_minus
id|CP_PER_PAGE_POWER
)paren
suffix:semicolon
r_do
(brace
id|freeblk
op_assign
(paren
id|ccw1_t
op_star
)paren
id|get_free_pages
(paren
id|GFP_ATOMIC
comma
id|index
op_minus
id|CP_PER_PAGE_POWER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_page_count
op_plus
id|pc
op_ge
id|MAX_DASD_PAGES
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Requesting too many pages...&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pc
suffix:semicolon
id|i
op_increment
)paren
id|dasd_page
(braket
id|dasd_page_count
op_increment
)braket
op_assign
(paren
r_int
)paren
id|freeblk
op_plus
id|i
op_star
id|PAGE_SIZE
suffix:semicolon
)brace
id|FUNCTION_CONTROL
(paren
l_string|&quot;requesting index %d&quot;
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|freeblk
)paren
(brace
id|panic
(paren
l_string|&quot;No memory received&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|freeblk
)paren
suffix:semicolon
id|memset
c_func
(paren
id|freeblk
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
(paren
id|index
op_minus
id|CP_PER_PAGE_POWER
)paren
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ccwarea
(braket
id|index
)braket
op_eq
l_int|NULL
)paren
(brace
id|ccw1_t
op_star
id|blk
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|CP_PER_PAGE_POWER
)paren
(brace
r_do
(brace
id|blk
op_assign
(paren
id|ccw1_t
op_star
)paren
id|get_free_page
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_page_count
op_plus
l_int|1
op_ge
id|MAX_DASD_PAGES
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Requesting too many pages...&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dasd_page
(braket
id|dasd_page_count
op_increment
)braket
op_assign
(paren
r_int
)paren
id|blk
suffix:semicolon
)brace
r_if
c_cond
(paren
id|blk
op_eq
l_int|NULL
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Can&squot;t allocate page!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|blk
)paren
suffix:semicolon
id|memset
c_func
(paren
id|blk
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|ccwarea_enq
(paren
id|CP_PER_PAGE_POWER
comma
id|blk
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|blk
op_assign
id|request_cpa
(paren
id|index
op_plus
l_int|1
)paren
suffix:semicolon
macro_line|#if DASD_PARANOIA &gt; 1
r_if
c_cond
(paren
op_logical_neg
id|blk
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;retrieved NULL&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* DASD_PARANOIA */
id|ccwarea_enq
(paren
id|index
comma
id|blk
)paren
suffix:semicolon
id|ccwarea_enq
(paren
id|index
comma
id|blk
op_plus
(paren
l_int|1
op_lshift
id|index
)paren
)paren
suffix:semicolon
)brace
macro_line|#if DASD_PARANOIA &gt; 2
r_if
c_cond
(paren
op_logical_neg
id|ccwarea
(braket
id|index
)braket
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;ccwarea is NULL&bslash;n%s&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* DASD_PARANOIA */
id|freeblk
op_assign
id|ccwarea_deq
(paren
id|index
)paren
suffix:semicolon
macro_line|#if DASD_PARANOIA &gt; 1
r_if
c_cond
(paren
op_logical_neg
id|freeblk
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;freeblk is NULL&bslash;n%s&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* DASD_PARANOIA */
m_exit
suffix:colon
id|FUNCTION_EXIT
(paren
l_string|&quot;request_cpa&quot;
)paren
suffix:semicolon
r_return
id|freeblk
suffix:semicolon
)brace
id|ccw1_t
op_star
DECL|function|request_cp
id|request_cp
(paren
r_int
id|size
)paren
(brace
id|ccw1_t
op_star
id|freeblk
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|blksize
suffix:semicolon
multiline_comment|/* Determine the index of ccwarea to look at */
r_for
c_loop
(paren
id|index
op_assign
l_int|0
comma
id|blksize
op_assign
l_int|1
suffix:semicolon
id|size
OG
id|blksize
suffix:semicolon
id|index
op_increment
comma
id|blksize
op_assign
id|blksize
op_lshift
l_int|1
)paren
(brace
)brace
r_if
c_cond
(paren
id|index
OG
id|MAX_CP_POWER
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;index too large %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
)brace
id|spin_lock
(paren
op_amp
id|ccw_lock
)paren
suffix:semicolon
id|freeblk
op_assign
id|request_cpa
(paren
id|index
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|ccw_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freeblk
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No way to deliver free ccw space&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|freeblk
suffix:semicolon
)brace
r_void
DECL|function|release_cp
id|release_cp
(paren
r_int
id|size
comma
id|ccw1_t
op_star
id|area
)paren
(brace
r_int
id|index
suffix:semicolon
r_int
id|blksize
suffix:semicolon
multiline_comment|/* Determine the index of ccwarea to look at */
r_for
c_loop
(paren
id|index
op_assign
l_int|0
comma
id|blksize
op_assign
l_int|1
suffix:semicolon
id|size
OG
id|blksize
suffix:semicolon
id|index
op_increment
comma
id|blksize
op_assign
id|blksize
op_lshift
l_int|1
)paren
(brace
)brace
r_if
c_cond
(paren
id|index
OG
id|MAX_CP_POWER
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;index too large %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|index
OG
id|CP_PER_PAGE_POWER
)paren
(brace
id|free_pages
(paren
(paren
r_int
r_int
)paren
id|area
comma
id|index
op_minus
id|CP_PER_PAGE_POWER
)paren
suffix:semicolon
id|INTERNAL_CHECK
(paren
l_string|&quot;large index used: %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock
(paren
op_amp
id|ccw_lock
)paren
suffix:semicolon
id|ccwarea_enq
(paren
id|index
comma
id|area
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|ccw_lock
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------- */
DECL|variable|cqrp
r_static
id|cqr_t
op_star
id|cqrp
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|cqr_lock
r_static
id|spinlock_t
id|cqr_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_void
DECL|function|cqf_enq
id|cqf_enq
(paren
id|cqr_t
op_star
id|cqf
)paren
(brace
op_star
(paren
id|cqr_t
op_star
op_star
)paren
id|cqf
op_assign
id|cqrp
suffix:semicolon
id|cqrp
op_assign
id|cqf
suffix:semicolon
)brace
id|cqr_t
op_star
DECL|function|cqf_deq
id|cqf_deq
(paren
r_void
)paren
(brace
id|cqr_t
op_star
id|cqr
op_assign
id|cqrp
suffix:semicolon
id|cqrp
op_assign
op_star
(paren
id|cqr_t
op_star
op_star
)paren
id|cqrp
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
id|cqr_t
op_star
DECL|function|request_cq
id|request_cq
(paren
r_void
)paren
(brace
id|cqr_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|cqr_t
op_star
id|area
suffix:semicolon
id|spin_lock
(paren
op_amp
id|cqr_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cqrp
op_eq
l_int|NULL
)paren
(brace
r_do
(brace
id|area
op_assign
(paren
id|cqr_t
op_star
)paren
id|get_free_page
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|area
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory for chanq area&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|area
)paren
suffix:semicolon
id|memset
c_func
(paren
id|area
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_page_count
op_plus
l_int|1
op_ge
id|MAX_DASD_PAGES
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Requesting too many pages...&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dasd_page
(braket
id|dasd_page_count
op_increment
)braket
op_assign
(paren
r_int
)paren
id|area
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4096
op_div
r_sizeof
(paren
id|cqr_t
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cqf_enq
(paren
id|area
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
id|cqr
op_assign
id|cqf_deq
(paren
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|cqr_lock
)paren
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
r_void
DECL|function|release_cq
id|release_cq
(paren
id|cqr_t
op_star
id|cqr
)paren
(brace
id|spin_lock
(paren
op_amp
id|cqr_lock
)paren
suffix:semicolon
id|cqf_enq
(paren
id|cqr
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|cqr_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------- */
id|cqr_t
op_star
DECL|function|request_cqr
id|request_cqr
(paren
r_int
id|cpsize
comma
r_int
id|datasize
)paren
(brace
id|cqr_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
id|cqr
op_assign
id|request_cq
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
id|__FILE__
l_string|&quot;No memory for chanq request&bslash;n&quot;
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|memset
(paren
id|cqr
comma
l_int|0
comma
r_sizeof
(paren
id|cqr_t
)paren
)paren
suffix:semicolon
id|cqr
op_member_access_from_pointer
id|magic
op_assign
id|DASD_MAGIC
suffix:semicolon
r_if
c_cond
(paren
id|cpsize
)paren
(brace
id|cqr-&gt;cpaddr
op_assign
id|request_cp
(paren
id|cpsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;cpaddr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
id|__FILE__
l_string|&quot;No memory for channel program&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|nocp
suffix:semicolon
)brace
id|cqr-&gt;cplength
op_assign
id|cpsize
suffix:semicolon
)brace
r_if
c_cond
(paren
id|datasize
)paren
(brace
r_do
(brace
id|cqr-&gt;data
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
(paren
id|datasize
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;data
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
id|__FILE__
l_string|&quot;No memory for cqr data area&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|cqr-&gt;data
)paren
suffix:semicolon
id|memset
(paren
id|cqr-&gt;data
comma
l_int|0
comma
id|datasize
)paren
suffix:semicolon
)brace
r_goto
m_exit
suffix:semicolon
id|nocp
suffix:colon
id|release_cq
(paren
id|cqr
)paren
suffix:semicolon
id|cqr
op_assign
l_int|NULL
suffix:semicolon
m_exit
suffix:colon
r_return
id|cqr
suffix:semicolon
)brace
r_int
DECL|function|release_cqr
id|release_cqr
(paren
id|cqr_t
op_star
id|cqr
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cqr-&gt;data
)paren
(brace
id|kfree
(paren
id|cqr-&gt;data
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cqr-&gt;dstat
)paren
(brace
id|kfree
(paren
id|cqr-&gt;dstat
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cqr-&gt;cpaddr
)paren
(brace
id|release_cp
(paren
id|cqr-&gt;cplength
comma
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
)brace
id|cqr
op_member_access_from_pointer
id|magic
op_assign
id|dasd_MAGIC
suffix:semicolon
id|release_cq
(paren
id|cqr
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------- */
r_void
DECL|function|dasd_chanq_enq
id|dasd_chanq_enq
(paren
id|dasd_chanq_t
op_star
id|q
comma
id|cqr_t
op_star
id|cqr
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;head
op_ne
l_int|NULL
)paren
(brace
id|q-&gt;tail-&gt;next
op_assign
id|cqr
suffix:semicolon
)brace
r_else
id|q-&gt;head
op_assign
id|cqr
suffix:semicolon
id|cqr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;tail
op_assign
id|cqr
suffix:semicolon
id|q-&gt;queued_requests
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|atomic_compare_and_swap
c_func
(paren
id|CQR_STATUS_FILLED
comma
id|CQR_STATUS_QUEUED
comma
op_amp
id|cqr-&gt;status
)paren
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;q_cqr: %p status changed %d&bslash;n&quot;
comma
id|cqr
comma
id|atomic_read
c_func
(paren
op_amp
id|cqr-&gt;status
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|dasd_chanq_deq
id|dasd_chanq_deq
(paren
id|dasd_chanq_t
op_star
id|q
comma
id|cqr_t
op_star
id|cqr
)paren
(brace
id|cqr_t
op_star
id|prev
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
(paren
id|cqr_t
op_star
)paren
id|q-&gt;head
)paren
(brace
id|q-&gt;head
op_assign
id|cqr-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;head
op_eq
l_int|NULL
)paren
id|q-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|prev
op_assign
(paren
id|cqr_t
op_star
)paren
id|q-&gt;head
suffix:semicolon
r_while
c_loop
(paren
id|prev
op_logical_and
id|prev-&gt;next
op_ne
id|cqr
)paren
id|prev
op_assign
id|prev-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|prev-&gt;next
op_assign
id|cqr-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|prev-&gt;next
op_eq
l_int|NULL
)paren
id|q-&gt;tail
op_assign
id|prev
suffix:semicolon
)brace
id|cqr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;queued_requests
op_decrement
suffix:semicolon
r_return
id|release_cqr
c_func
(paren
id|cqr
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
r_void
DECL|function|cql_enq_head
id|cql_enq_head
(paren
id|dasd_chanq_t
op_star
id|q
)paren
(brace
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;NULL queue passed%s&bslash;n&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|q-&gt;flags
)paren
op_amp
id|DASD_CHANQ_ACTIVE
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Queue already active&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|cq_lock
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|DASD_CHANQ_ACTIVE
comma
op_amp
id|q-&gt;flags
)paren
suffix:semicolon
id|q-&gt;next_q
op_assign
id|cq_head
suffix:semicolon
id|cq_head
op_assign
id|q
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cq_lock
)paren
suffix:semicolon
)brace
r_void
DECL|function|cql_deq
id|cql_deq
(paren
id|dasd_chanq_t
op_star
id|q
)paren
(brace
id|dasd_chanq_t
op_star
id|c
suffix:semicolon
r_if
c_cond
(paren
id|cq_head
op_eq
l_int|NULL
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;Channel queue is empty%s&bslash;n&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
(brace
id|INTERNAL_ERROR
(paren
l_string|&quot;NULL queue passed%s&bslash;n&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|cq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|atomic_read
c_func
(paren
op_amp
id|q-&gt;flags
)paren
op_amp
id|DASD_CHANQ_ACTIVE
)paren
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Queue not active&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cq_head
op_eq
id|q
)paren
(brace
id|cq_head
op_assign
id|q-&gt;next_q
suffix:semicolon
)brace
r_else
(brace
id|c
op_assign
id|cq_head
suffix:semicolon
r_while
c_loop
(paren
id|c-&gt;next_q
op_logical_and
id|c-&gt;next_q
op_ne
id|q
)paren
id|c
op_assign
id|c-&gt;next_q
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;next_q
op_ne
id|q
)paren
id|INTERNAL_ERROR
(paren
l_string|&quot;Entry not in queue%s&bslash;n&quot;
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
r_else
id|c-&gt;next_q
op_assign
id|q-&gt;next_q
suffix:semicolon
)brace
id|q-&gt;next_q
op_assign
l_int|NULL
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|DASD_CHANQ_ACTIVE
comma
op_amp
id|q-&gt;flags
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cq_lock
)paren
suffix:semicolon
)brace
eof
