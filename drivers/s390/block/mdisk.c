multiline_comment|/*&n; *  drivers/s390/block/mdisk.c&n; *    VM minidisk device driver.&n; *&n; *  S390 version&n; *    Copyright (C) 1999 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Hartmut Penner (hp@de.ibm.com)&n; */
macro_line|#ifndef __KERNEL__
DECL|macro|__KERNEL__
macro_line|#  define __KERNEL__
macro_line|#endif
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;              /* printk()                         */
macro_line|#include &lt;linux/malloc.h&gt;              /* kmalloc()                        */
macro_line|#include &lt;linux/vmalloc.h&gt;             /* vmalloc()                        */
macro_line|#include &lt;linux/fs.h&gt;                  /* everything...                    */
macro_line|#include &lt;linux/errno.h&gt;               /* error codes                      */
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/types.h&gt;               /* size_t                           */
macro_line|#include &lt;linux/fcntl.h&gt;               /* O_ACCMODE                        */
macro_line|#include &lt;linux/hdreg.h&gt;               /* HDIO_GETGEO                      */
macro_line|#include &lt;linux/init.h&gt;                /* initfunc                         */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;asm/system.h&gt;                /* cli(), *_flags                   */
macro_line|#include &lt;asm/uaccess.h&gt;               /* access_ok                        */
macro_line|#include &lt;asm/io.h&gt;                    /* virt_to_phys                     */
multiline_comment|/* Added statement HSM 12/03/99 */
macro_line|#include &lt;asm/irq.h&gt;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MDISK_MAJOR /* force definitions on in blk.h */
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;mdisk.h&quot;        /* local definitions */
multiline_comment|/*&n; * structure for all device specific information&n; */
DECL|struct|mdisk_Dev
r_typedef
r_struct
id|mdisk_Dev
(brace
DECL|member|vdev
id|u32
id|vdev
suffix:semicolon
multiline_comment|/* vdev of mindisk */
DECL|member|size
id|u32
id|size
suffix:semicolon
multiline_comment|/* size in blocks */
DECL|member|status
id|u32
id|status
suffix:semicolon
multiline_comment|/* status of last io operation */
DECL|member|nr_bhs
id|u32
id|nr_bhs
suffix:semicolon
multiline_comment|/* number of buffer of last io operation */
DECL|member|blksize
id|u32
id|blksize
suffix:semicolon
multiline_comment|/* blksize from minidisk */
DECL|member|blkmult
id|u32
id|blkmult
suffix:semicolon
multiline_comment|/* multiplier between blksize and 512 HARDSECT */
DECL|member|blkshift
id|u32
id|blkshift
suffix:semicolon
multiline_comment|/* loe2 of multiplier above */
multiline_comment|/*&n;&t; * each device has own iob and bio,&n;&t; * it&squot;s possible to run io in parallel&n;&t; * not used yet due to only one CURRENT per MAJOR&n;&t; */
DECL|member|iob
id|mdisk_rw_io_t
op_star
id|iob
suffix:semicolon
multiline_comment|/* each device has it own iob and bio */
DECL|member|bio
id|mdisk_bio_t
op_star
id|bio
suffix:semicolon
multiline_comment|/* Added statement HSM 12/03/99 */
DECL|member|dev_status
id|devstat_t
id|dev_status
suffix:semicolon
multiline_comment|/* Here we hold the I/O status */
DECL|member|usage
r_int
id|usage
suffix:semicolon
multiline_comment|/* usage counter */
DECL|member|tqueue
r_struct
id|tq_struct
id|tqueue
suffix:semicolon
multiline_comment|/* per device task queue */
DECL|typedef|mdisk_Dev
)brace
id|mdisk_Dev
suffix:semicolon
multiline_comment|/*&n; * appended to global structures in mdisk_init;&n; */
DECL|variable|mdisk_blksizes
r_static
r_int
id|mdisk_blksizes
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|variable|mdisk_sizes
r_static
r_int
id|mdisk_sizes
(braket
id|MDISK_DEVS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|mdisk_hardsects
r_static
r_int
id|mdisk_hardsects
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|variable|mdisk_maxsectors
r_static
r_int
id|mdisk_maxsectors
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
multiline_comment|/*&n; *  structure hold device specific information&n; */
DECL|variable|mdisk_devices
r_static
id|mdisk_Dev
id|mdisk_devices
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|variable|mdisk_iob
r_static
id|mdisk_rw_io_t
id|mdisk_iob
(braket
id|MDISK_DEVS
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
DECL|variable|mdisk_bio
r_static
id|mdisk_bio_t
id|mdisk_bio
(braket
id|MDISK_DEVS
)braket
(braket
l_int|256
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Parameter parsing&n; */
r_struct
(brace
DECL|member|vdev
r_int
id|vdev
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|member|size
r_int
id|size
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|member|offset
r_int
id|offset
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|member|blksize
r_int
id|blksize
(braket
id|MDISK_DEVS
)braket
suffix:semicolon
DECL|variable|mdisk_setup_data
)brace
id|mdisk_setup_data
suffix:semicolon
multiline_comment|/*&n; * Parameter parsing function, called from init/main.c&n; * vdev    : virtual device number&n; * size    : size in kbyte&n; * offset  : offset after which minidisk is available&n; * blksize : blocksize minidisk is formated&n; * Format is: mdisk=&lt;vdev&gt;:&lt;size&gt;:&lt;offset&gt;:&lt;blksize&gt;,&lt;vdev&gt;:&lt;size&gt;:&lt;offset&gt;...&n; * &lt;vdev&gt;:&lt;size&gt;:&lt;offset&gt;:&lt;blksize&gt; can be shortened to &lt;vdev&gt;:&lt;size&gt; with offset=0,blksize=512&n; */
DECL|function|mdisk_setup
r_int
id|__init
id|mdisk_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|cur
op_assign
id|str
suffix:semicolon
r_int
id|vdev
comma
id|size
comma
id|offset
op_assign
l_int|0
comma
id|blksize
suffix:semicolon
r_static
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
id|memset
c_func
(paren
op_amp
id|mdisk_setup_data
comma
l_int|0
comma
r_sizeof
(paren
id|mdisk_setup_data
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|cur
op_ne
l_int|0
)paren
(brace
id|blksize
op_assign
id|MDISK_HARDSECT
suffix:semicolon
id|vdev
op_assign
id|size
op_assign
id|offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isxdigit
c_func
(paren
op_star
id|cur
)paren
)paren
r_goto
id|syntax_error
suffix:semicolon
id|vdev
op_assign
id|simple_strtoul
c_func
(paren
id|cur
comma
op_amp
id|cur
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cur
op_ne
l_int|0
op_logical_and
op_star
id|cur
op_ne
l_char|&squot;,&squot;
)paren
(brace
r_if
c_cond
(paren
op_star
id|cur
op_increment
op_ne
l_char|&squot;:&squot;
)paren
r_goto
id|syntax_error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isxdigit
c_func
(paren
op_star
id|cur
)paren
)paren
r_goto
id|syntax_error
suffix:semicolon
id|size
op_assign
id|simple_strtoul
c_func
(paren
id|cur
comma
op_amp
id|cur
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cur
op_eq
l_char|&squot;:&squot;
)paren
(brace
multiline_comment|/* another colon -&gt; offset specified */
id|cur
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isxdigit
c_func
(paren
op_star
id|cur
)paren
)paren
r_goto
id|syntax_error
suffix:semicolon
id|offset
op_assign
id|simple_strtoul
c_func
(paren
id|cur
comma
op_amp
id|cur
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cur
op_eq
l_char|&squot;:&squot;
)paren
(brace
multiline_comment|/* another colon -&gt; blksize */
id|cur
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isxdigit
c_func
(paren
op_star
id|cur
)paren
)paren
r_goto
id|syntax_error
suffix:semicolon
id|blksize
op_assign
id|simple_strtoul
c_func
(paren
id|cur
comma
op_amp
id|cur
comma
l_int|16
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|cur
op_ne
l_char|&squot;,&squot;
op_logical_and
op_star
id|cur
op_ne
l_int|0
)paren
r_goto
id|syntax_error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|cur
op_eq
l_char|&squot;,&squot;
)paren
id|cur
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|MDISK_DEVS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mnd: too many devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mdisk_setup_data.vdev
(braket
id|i
)braket
op_assign
id|vdev
suffix:semicolon
id|mdisk_setup_data.size
(braket
id|i
)braket
op_assign
id|size
suffix:semicolon
id|mdisk_setup_data.offset
(braket
id|i
)braket
op_assign
id|offset
suffix:semicolon
id|mdisk_setup_data.blksize
(braket
id|i
)braket
op_assign
id|blksize
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
id|syntax_error
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mnd: syntax error in parameter string: %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;mdisk=&quot;
comma
id|mdisk_setup
)paren
suffix:semicolon
multiline_comment|/*&n; * Open and close&n; */
DECL|function|mdisk_open
r_static
r_int
id|mdisk_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|mdisk_Dev
op_star
id|dev
suffix:semicolon
multiline_comment|/* device information */
r_int
id|num
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * size 0 means device not installed&n;&t; */
r_if
c_cond
(paren
(paren
id|num
op_ge
id|MDISK_DEVS
)paren
op_logical_or
(paren
id|mdisk_sizes
(braket
id|num
)braket
op_eq
l_int|0
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev
op_assign
op_amp
id|mdisk_devices
(braket
id|num
)braket
suffix:semicolon
id|dev-&gt;usage
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* success */
)brace
DECL|function|mdisk_release
r_static
r_int
id|mdisk_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|mdisk_Dev
op_star
id|dev
op_assign
op_amp
id|mdisk_devices
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * flush device&n;&t; */
id|fsync_dev
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|dev-&gt;usage
op_decrement
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The mdisk() implementation&n; */
DECL|function|mdisk_ioctl
r_static
r_int
id|mdisk_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
comma
id|rc
comma
id|size
op_assign
l_int|0
suffix:semicolon
r_struct
id|hd_geometry
op_star
id|geo
op_assign
(paren
r_struct
id|hd_geometry
op_star
)paren
id|arg
suffix:semicolon
id|mdisk_Dev
op_star
id|dev
op_assign
id|mdisk_devices
op_plus
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|BLKGETSIZE
suffix:colon
id|rc
op_assign
id|copy_to_user
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|dev-&gt;size
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mnd: ioctl BLKGETSIZE %d&bslash;n&quot;
comma
id|dev-&gt;size
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_case
id|BLKFLSBUF
suffix:colon
multiline_comment|/* flush */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/* only root */
id|fsync_dev
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|BLKRAGET
suffix:colon
multiline_comment|/* return the readahead value */
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|put_user
c_func
(paren
id|read_ahead
(braket
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|BLKRASET
suffix:colon
multiline_comment|/* set the readahead value */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|0xff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* limit it */
id|read_ahead
(braket
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
op_assign
id|arg
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|BLKRRPART
suffix:colon
multiline_comment|/* re-read partition table: can&squot;t do it */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|HDIO_GETGEO
suffix:colon
multiline_comment|/*&n;&t;&t; * get geometry of device -&gt; linear&n;&t;&t; */
id|size
op_assign
id|dev-&gt;size
suffix:semicolon
r_if
c_cond
(paren
id|geo
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|geo
comma
r_sizeof
(paren
op_star
id|geo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|put_user
c_func
(paren
l_int|1
comma
op_amp
id|geo-&gt;cylinders
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|1
comma
op_amp
id|geo-&gt;heads
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|size
comma
op_amp
id|geo-&gt;sectors
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|0
comma
op_amp
id|geo-&gt;start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* unknown command */
)brace
multiline_comment|/*&n; * The file operations&n; */
DECL|variable|mdisk_fops
r_static
r_struct
id|block_device_operations
id|mdisk_fops
op_assign
(brace
id|ioctl
suffix:colon
id|mdisk_ioctl
comma
id|open
suffix:colon
id|mdisk_open
comma
id|release
suffix:colon
id|mdisk_release
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * The &squot;low level&squot; IO function&n; */
r_static
id|__inline__
r_int
DECL|function|dia250
id|dia250
c_func
(paren
r_void
op_star
id|iob
comma
r_int
id|cmd
)paren
(brace
r_int
id|rc
suffix:semicolon
id|iob
op_assign
(paren
r_void
op_star
)paren
id|virt_to_phys
c_func
(paren
id|iob
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;    lr    2,%1&bslash;n&quot;
l_string|&quot;    lr    3,%2&bslash;n&quot;
l_string|&quot;    .long 0x83230250&bslash;n&quot;
l_string|&quot;    lr    %0,3&quot;
suffix:colon
l_string|&quot;=d&quot;
(paren
id|rc
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
id|iob
)paren
comma
l_string|&quot;d&quot;
(paren
id|cmd
)paren
suffix:colon
l_string|&quot;2&quot;
comma
l_string|&quot;3&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Init of minidisk device&n; */
r_static
id|__inline__
r_int
DECL|function|mdisk_init_io
id|mdisk_init_io
c_func
(paren
id|mdisk_Dev
op_star
id|dev
comma
r_int
id|blocksize
comma
r_int
id|offset
comma
r_int
id|size
)paren
(brace
id|mdisk_init_io_t
op_star
id|iob
op_assign
(paren
id|mdisk_init_io_t
op_star
)paren
id|dev-&gt;iob
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|memset
c_func
(paren
id|iob
comma
l_int|0
comma
r_sizeof
(paren
id|mdisk_init_io_t
)paren
)paren
suffix:semicolon
id|iob-&gt;dev_nr
op_assign
id|dev-&gt;vdev
suffix:semicolon
id|iob-&gt;block_size
op_assign
id|blocksize
suffix:semicolon
id|iob-&gt;offset
op_assign
id|offset
suffix:semicolon
id|iob-&gt;start_block
op_assign
l_int|0
suffix:semicolon
id|iob-&gt;end_block
op_assign
id|size
suffix:semicolon
id|rc
op_assign
id|dia250
c_func
(paren
id|iob
comma
id|INIT_BIO
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * clear for following io once&n;&t; */
id|memset
c_func
(paren
id|iob
comma
l_int|0
comma
r_sizeof
(paren
id|mdisk_rw_io_t
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * release of minidisk device&n; */
r_static
id|__inline__
r_int
DECL|function|mdisk_term_io
id|mdisk_term_io
c_func
(paren
id|mdisk_Dev
op_star
id|dev
)paren
(brace
id|mdisk_init_io_t
op_star
id|iob
op_assign
(paren
id|mdisk_init_io_t
op_star
)paren
id|dev-&gt;iob
suffix:semicolon
id|memset
c_func
(paren
id|iob
comma
l_int|0
comma
r_sizeof
(paren
id|mdisk_init_io_t
)paren
)paren
suffix:semicolon
id|iob-&gt;dev_nr
op_assign
id|dev-&gt;vdev
suffix:semicolon
r_return
id|dia250
c_func
(paren
id|iob
comma
id|TERM_BIO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * setup and start of minidisk io request&n; */
r_static
id|__inline__
r_int
DECL|function|mdisk_rw_io_clustered
id|mdisk_rw_io_clustered
(paren
id|mdisk_Dev
op_star
id|dev
comma
id|mdisk_bio_t
op_star
id|bio_array
comma
r_int
id|length
comma
r_int
id|req
comma
r_int
id|sync
)paren
(brace
r_int
id|rc
suffix:semicolon
id|mdisk_rw_io_t
op_star
id|iob
op_assign
id|dev-&gt;iob
suffix:semicolon
id|iob-&gt;dev_nr
op_assign
id|dev-&gt;vdev
suffix:semicolon
id|iob-&gt;key
op_assign
l_int|0
suffix:semicolon
id|iob-&gt;flags
op_assign
id|sync
suffix:semicolon
id|iob-&gt;block_count
op_assign
id|length
suffix:semicolon
id|iob-&gt;interrupt_params
op_assign
id|req
suffix:semicolon
id|iob-&gt;bio_list
op_assign
id|virt_to_phys
c_func
(paren
id|bio_array
)paren
suffix:semicolon
id|rc
op_assign
id|dia250
c_func
(paren
id|iob
comma
id|RW_BIO
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * The device characteristics function&n; */
r_static
id|__inline__
r_int
DECL|function|dia210
id|dia210
c_func
(paren
r_void
op_star
id|devchar
)paren
(brace
r_int
id|rc
suffix:semicolon
id|devchar
op_assign
(paren
r_void
op_star
)paren
id|virt_to_phys
c_func
(paren
id|devchar
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;    lr    2,%1&bslash;n&quot;
l_string|&quot;    .long 0x83200210&bslash;n&quot;
l_string|&quot;    ipm   %0&bslash;n&quot;
l_string|&quot;    srl   %0,28&quot;
suffix:colon
l_string|&quot;=d&quot;
(paren
id|rc
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
id|devchar
)paren
suffix:colon
l_string|&quot;2&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * read the label of a minidisk and extract its characteristics&n; */
r_static
id|__inline__
r_int
DECL|function|mdisk_read_label
id|mdisk_read_label
(paren
id|mdisk_Dev
op_star
id|dev
comma
r_int
id|i
)paren
(brace
r_static
id|mdisk_dev_char_t
id|devchar
suffix:semicolon
r_static
r_int
id|label
(braket
l_int|1024
)braket
suffix:semicolon
r_int
id|block
comma
id|b
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|mdisk_bio_t
op_star
id|bio
suffix:semicolon
id|devchar.dev_nr
op_assign
id|dev
op_member_access_from_pointer
id|vdev
suffix:semicolon
id|devchar.rdc_len
op_assign
r_sizeof
(paren
id|mdisk_dev_char_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dia210
c_func
(paren
op_amp
id|devchar
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|devchar.vdev_class
op_eq
id|DEV_CLASS_FBA
)paren
(brace
id|block
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|block
op_assign
l_int|3
suffix:semicolon
)brace
id|bio
op_assign
id|dev-&gt;bio
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|512
suffix:semicolon
id|b
OL
l_int|4097
suffix:semicolon
id|b
op_assign
id|b
op_star
l_int|2
)paren
(brace
id|rc
op_assign
id|mdisk_init_io
c_func
(paren
id|dev
comma
id|b
comma
l_int|0
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|4
)paren
(brace
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|bio
(braket
l_int|0
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|mdisk_bio_t
)paren
)paren
suffix:semicolon
id|bio
(braket
l_int|0
)braket
dot
id|type
op_assign
id|MDISK_READ_REQ
suffix:semicolon
id|bio
(braket
l_int|0
)braket
dot
id|block_number
op_assign
id|block
suffix:semicolon
id|bio
(braket
l_int|0
)braket
dot
id|buffer
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|label
)paren
suffix:semicolon
id|dev-&gt;nr_bhs
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mdisk_rw_io_clustered
c_func
(paren
id|dev
comma
op_amp
id|bio
(braket
l_int|0
)braket
comma
l_int|1
comma
(paren
r_int
r_int
)paren
id|dev
comma
id|MDISK_SYNC
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|label
(braket
l_int|0
)braket
op_ne
l_int|0xc3d4e2f1
)paren
(brace
multiline_comment|/* CMS1 */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;mnd: %4lX &quot;
l_string|&quot;is not CMS format&bslash;n&quot;
comma
id|mdisk_setup_data.vdev
(braket
id|i
)braket
)paren
suffix:semicolon
id|rc
op_assign
id|mdisk_term_io
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|label
(braket
l_int|13
)braket
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;mnd: %4lX &quot;
l_string|&quot;is not reserved&bslash;n&quot;
comma
id|mdisk_setup_data.vdev
(braket
id|i
)braket
)paren
suffix:semicolon
id|rc
op_assign
id|mdisk_term_io
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
id|mdisk_setup_data.size
(braket
id|i
)braket
op_assign
(paren
id|label
(braket
l_int|7
)braket
op_minus
l_int|1
op_minus
id|label
(braket
l_int|13
)braket
)paren
op_star
(paren
id|label
(braket
l_int|3
)braket
op_rshift
l_int|9
)paren
op_rshift
l_int|1
suffix:semicolon
id|mdisk_setup_data.blksize
(braket
id|i
)braket
op_assign
id|label
(braket
l_int|3
)braket
suffix:semicolon
id|mdisk_setup_data.offset
(braket
id|i
)braket
op_assign
id|label
(braket
l_int|13
)braket
op_plus
l_int|1
suffix:semicolon
id|rc
op_assign
id|mdisk_term_io
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|mdisk_term_io
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;mnd: Cannot read label of %4lX &quot;
l_string|&quot;- is it formatted?&bslash;n&quot;
comma
id|mdisk_setup_data.vdev
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
r_return
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * this handles a clustered request in success case&n; * all buffers are detach and marked uptodate to the kernel&n; * then CURRENT-&gt;bh is set to the last processed but not&n; * update buffer&n; */
r_static
id|__inline__
r_void
DECL|function|mdisk_end_request
id|mdisk_end_request
c_func
(paren
r_int
id|nr_bhs
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|nr_bhs
OG
l_int|1
)paren
(brace
id|req
op_assign
id|CURRENT
suffix:semicolon
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_bhs
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|req-&gt;bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
id|bh-&gt;b_reqnext
op_assign
l_int|NULL
suffix:semicolon
id|bh
op_member_access_from_pointer
id|b_end_io
c_func
(paren
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * set CURRENT to last processed, not marked buffer&n;&t;&t; */
id|req-&gt;buffer
op_assign
id|bh-&gt;b_data
suffix:semicolon
id|req-&gt;current_nr_sectors
op_assign
id|bh-&gt;b_size
op_rshift
l_int|9
suffix:semicolon
id|CURRENT
op_assign
id|req
suffix:semicolon
)brace
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Block-driver specific functions&n; */
DECL|function|mdisk_request
r_void
id|mdisk_request
c_func
(paren
id|request_queue_t
op_star
id|queue
)paren
(brace
id|mdisk_Dev
op_star
id|dev
suffix:semicolon
id|mdisk_bio_t
op_star
id|bio
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
r_int
id|sector
comma
id|nr
comma
id|offset
suffix:semicolon
r_int
id|rc
comma
id|rw
comma
id|i
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|CURRENT
)paren
(brace
id|INIT_REQUEST
suffix:semicolon
multiline_comment|/* Check if the minor number is in range */
r_if
c_cond
(paren
id|DEVICE_NR
c_func
(paren
id|CURRENT_DEV
)paren
OG
id|MDISK_DEVS
)paren
(brace
r_static
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
op_increment
OL
l_int|5
)paren
multiline_comment|/* print the message at most five times */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mnd: request for minor %d out of range&bslash;n&quot;
comma
id|DEVICE_NR
c_func
(paren
id|CURRENT_DEV
)paren
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Pointer to device structure, from the static array&n;&t;&t; */
id|dev
op_assign
id|mdisk_devices
op_plus
id|DEVICE_NR
c_func
(paren
id|CURRENT_DEV
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * check, if operation is past end of devices&n;&t;&t; */
r_if
c_cond
(paren
id|CURRENT-&gt;nr_sectors
op_plus
id|CURRENT-&gt;sector
OG
id|dev-&gt;size
)paren
(brace
r_static
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
op_increment
OL
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mnd%c: request past end of device&bslash;n&quot;
comma
id|DEVICE_NR
c_func
(paren
id|CURRENT_DEV
)paren
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * do command (read or write)&n;&t;&t; */
r_switch
c_cond
(paren
id|CURRENT-&gt;cmd
)paren
(brace
r_case
id|READ
suffix:colon
id|rw
op_assign
id|MDISK_READ_REQ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE
suffix:colon
id|rw
op_assign
id|MDISK_WRITE_REQ
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* can&squot;t happen */
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * put the clustered requests in mdisk_bio array&n;&t;&t; * nr_sectors is checked against max_sectors in make_request&n;&t;&t; * nr_sectors and sector are always blocks of 512 &n;&t;&t; * but bh_size depends on the filesystems size&n;&t;&t; */
id|sector
op_assign
id|CURRENT-&gt;sector
op_rshift
id|dev-&gt;blkshift
suffix:semicolon
id|bh
op_assign
id|CURRENT-&gt;bh
suffix:semicolon
id|bio
op_assign
id|dev-&gt;bio
suffix:semicolon
id|dev-&gt;nr_bhs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * sector is translated to block in minidisk context&n;&t;&t; * &n;&t;&t; */
id|offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|nr
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|nr
OL
id|CURRENT-&gt;nr_sectors
op_logical_and
id|bh
suffix:semicolon
id|nr
op_add_assign
id|dev-&gt;blkmult
comma
id|sector
op_increment
comma
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|bio
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|mdisk_bio_t
)paren
)paren
suffix:semicolon
id|bio
(braket
id|i
)braket
dot
id|type
op_assign
id|rw
suffix:semicolon
id|bio
(braket
id|i
)braket
dot
id|block_number
op_assign
id|sector
suffix:semicolon
id|bio
(braket
id|i
)braket
dot
id|buffer
op_assign
id|virt_to_phys
c_func
(paren
id|bh-&gt;b_data
op_plus
id|offset
)paren
suffix:semicolon
id|offset
op_add_assign
id|dev-&gt;blksize
suffix:semicolon
r_if
c_cond
(paren
id|bh-&gt;b_size
op_le
id|offset
)paren
(brace
id|offset
op_assign
l_int|0
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
id|dev-&gt;nr_bhs
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mdisk_rw_io_clustered
c_func
(paren
id|dev
comma
op_amp
id|bio
(braket
l_int|0
)braket
comma
id|i
comma
(paren
r_int
r_int
)paren
id|dev
comma
macro_line|#ifdef CONFIG_MDISK_SYNC
id|MDISK_SYNC
macro_line|#else
id|MDISK_ASYNC
macro_line|#endif
)paren
)paren
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mnd%c: %s request failed rc %d&quot;
l_string|&quot; sector %ld nr_sectors %ld &bslash;n&quot;
comma
id|DEVICE_NR
c_func
(paren
id|CURRENT_DEV
)paren
comma
id|rw
op_eq
id|MDISK_READ_REQ
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|rc
comma
id|CURRENT-&gt;sector
comma
id|CURRENT-&gt;nr_sectors
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Synchron: looping to end of request (INIT_REQUEST has return)&n;&t;&t; * Asynchron: end_request done in bottom half&n;&t;&t; */
macro_line|#ifdef CONFIG_MDISK_SYNC
id|mdisk_end_request
c_func
(paren
id|dev-&gt;nr_bhs
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|mdisk_end_request
c_func
(paren
id|dev-&gt;nr_bhs
)paren
suffix:semicolon
r_else
r_return
suffix:semicolon
macro_line|#endif&t;
)brace
)brace
multiline_comment|/*&n; * mdisk interrupt handler called when read/write request finished&n; * queues and marks a bottom half.&n; *&n; */
DECL|function|do_mdisk_interrupt
r_void
id|do_mdisk_interrupt
c_func
(paren
r_void
)paren
(brace
id|u16
id|code
suffix:semicolon
id|mdisk_Dev
op_star
id|dev
suffix:semicolon
id|code
op_assign
id|S390_lowcore.cpu_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|code
op_rshift
l_int|8
)paren
op_ne
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mnd: wrong sub-interruption code %d&quot;
comma
id|code
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * pointer to devives structure given as external interruption&n;&t; * parameter&n;&t; */
id|dev
op_assign
(paren
id|mdisk_Dev
op_star
)paren
id|S390_lowcore.ext_params
suffix:semicolon
id|dev-&gt;status
op_assign
id|code
op_amp
l_int|0x00ff
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|dev-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * the bottom half checks the status of request&n; * on success it calls end_request and calls mdisk_request&n; * if more transfer to do&n; */
r_static
r_void
DECL|function|do_mdisk_bh
id|do_mdisk_bh
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|mdisk_Dev
op_star
id|dev
op_assign
(paren
id|mdisk_Dev
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check for status of asynchronous rw&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;status
op_ne
l_int|0x00
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mnd: status of async rw %d&quot;
comma
id|dev-&gt;status
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * end request for clustered requests&n;&t;&t; */
r_if
c_cond
(paren
id|CURRENT
)paren
id|mdisk_end_request
c_func
(paren
id|dev-&gt;nr_bhs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if more to do, call mdisk_request&n;&t; */
r_if
c_cond
(paren
id|CURRENT
)paren
id|mdisk_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_void
multiline_comment|/* Added fuction HSM 12/03/99 */
DECL|function|mdisk_handler
id|mdisk_handler
(paren
r_int
id|cpu
comma
r_void
op_star
id|ds
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;mnd: received I/O interrupt... shouldn&squot;t happen&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|mdisk_init
r_int
id|__init
id|mdisk_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
comma
id|i
suffix:semicolon
id|mdisk_Dev
op_star
id|dev
suffix:semicolon
id|request_queue_t
op_star
id|q
suffix:semicolon
multiline_comment|/*&n;&t; * register block device&n;&t; */
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;mnd&quot;
comma
op_amp
id|mdisk_fops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mnd: unable to get major %d for mini disk&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
id|MAJOR_NR
suffix:semicolon
)brace
id|q
op_assign
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|q
comma
id|mdisk_request
)paren
suffix:semicolon
id|blk_queue_headactive
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|major
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * setup sizes for available devices&n;&t; */
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
id|MDISK_RAHEAD
suffix:semicolon
multiline_comment|/* 8 sector (4kB) read-ahead */
id|blk_size
(braket
id|MAJOR_NR
)braket
op_assign
id|mdisk_sizes
suffix:semicolon
multiline_comment|/* size of reserved mdisk    */
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|mdisk_blksizes
suffix:semicolon
multiline_comment|/* blksize of device      */
id|hardsect_size
(braket
id|MAJOR_NR
)braket
op_assign
id|mdisk_hardsects
suffix:semicolon
id|max_sectors
(braket
id|MAJOR_NR
)braket
op_assign
id|mdisk_maxsectors
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MDISK_DEVS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mdisk_setup_data.vdev
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Added block HSM 12/03/99 */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|get_irq_by_devno
c_func
(paren
id|mdisk_setup_data.vdev
(braket
id|i
)braket
)paren
comma
id|mdisk_handler
comma
l_int|0
comma
l_string|&quot;mnd&quot;
comma
op_amp
(paren
id|mdisk_devices
(braket
id|i
)braket
dot
id|dev_status
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;mnd: Cannot acquire I/O irq of&quot;
l_string|&quot; %4lX for paranoia reasons, skipping&bslash;n&quot;
comma
id|mdisk_setup_data.vdev
(braket
id|i
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * open VM minidisk low level device&n;&t;&t; */
id|dev
op_assign
op_amp
id|mdisk_devices
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;bio
op_assign
id|mdisk_bio
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;iob
op_assign
op_amp
id|mdisk_iob
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;vdev
op_assign
id|mdisk_setup_data.vdev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|mdisk_setup_data.size
(braket
id|i
)braket
op_eq
l_int|0
)paren
id|rc
op_assign
id|mdisk_read_label
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|dev-&gt;size
op_assign
id|mdisk_setup_data.size
(braket
id|i
)braket
op_star
l_int|2
suffix:semicolon
multiline_comment|/* buffer 512 b */
id|dev-&gt;blksize
op_assign
id|mdisk_setup_data.blksize
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;tqueue.routine
op_assign
id|do_mdisk_bh
suffix:semicolon
id|dev-&gt;tqueue.data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;blkmult
op_assign
id|dev-&gt;blksize
op_div
l_int|512
suffix:semicolon
id|dev-&gt;blkshift
op_assign
id|dev-&gt;blkmult
op_eq
l_int|1
ques
c_cond
l_int|0
suffix:colon
id|dev-&gt;blkmult
op_eq
l_int|2
ques
c_cond
l_int|1
suffix:colon
id|dev-&gt;blkmult
op_eq
l_int|4
ques
c_cond
l_int|2
suffix:colon
id|dev-&gt;blkmult
op_eq
l_int|8
ques
c_cond
l_int|3
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|mdisk_sizes
(braket
id|i
)braket
op_assign
id|mdisk_setup_data.size
(braket
id|i
)braket
suffix:semicolon
id|mdisk_blksizes
(braket
id|i
)braket
op_assign
id|mdisk_setup_data.blksize
(braket
id|i
)braket
suffix:semicolon
id|mdisk_hardsects
(braket
id|i
)braket
op_assign
id|mdisk_setup_data.blksize
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * max sectors for one clustered req  &n;&t;&t; */
id|mdisk_maxsectors
(braket
id|i
)braket
op_assign
id|MDISK_MAXSECTORS
op_star
id|dev-&gt;blkmult
suffix:semicolon
id|rc
op_assign
id|mdisk_init_io
c_func
(paren
id|dev
comma
id|mdisk_setup_data.blksize
(braket
id|i
)braket
comma
id|mdisk_setup_data.offset
(braket
id|i
)braket
comma
multiline_comment|/* offset in vdev*/
id|dev-&gt;size
op_rshift
id|dev-&gt;blkshift
multiline_comment|/* size in blocks */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mnd%c: init failed (rc: %d)&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|i
comma
id|rc
)paren
suffix:semicolon
id|mdisk_sizes
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * set vdev in device structure for further rw access&n;&t;&t; * vdev and size given by linload&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;mnd%c: register device at major %X with %d blocks %d blksize &bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|i
comma
id|MAJOR_NR
comma
id|dev-&gt;size
op_rshift
id|dev-&gt;blkshift
comma
id|dev-&gt;blkmult
op_star
l_int|512
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * enable service-signal external interruptions,&n;&t; * Control Register 0 bit 22 := 1&n;&t; * (besides PSW bit 7 must be set to 1 somewhere for external&n;&t; * interruptions)&n;&t; */
id|ctl_set_bit
c_func
(paren
l_int|0
comma
l_int|9
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
