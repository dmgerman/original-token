multiline_comment|/*&n; *  drivers/s390/net/iucv.c&n; *    Network driver for VM using iucv&n; *&n; *  S390 version&n; *    Copyright (C) 1999 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Stefan Hegewald &lt;hegewald@de.ibm.com&gt;&n; *               Hartmut Penner &lt;hpenner@de.ibm.com&gt;&n; * &n; *    2.3 Updates Denis Joseph Barrow (djbarrow@de.ibm.com,barrow_dj@yahoo.com)&n; *                Martin Schwidefsky (schwidefsky@de.ibm.com)&n; *                &n;&n; */
macro_line|#ifndef __KERNEL__
DECL|macro|__KERNEL__
mdefine_line|#define __KERNEL__
macro_line|#endif
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;              /* printk()                         */
macro_line|#include &lt;linux/malloc.h&gt;              /* kmalloc()                        */
macro_line|#include &lt;linux/errno.h&gt;               /* error codes                      */
macro_line|#include &lt;linux/types.h&gt;               /* size_t                           */
macro_line|#include &lt;linux/interrupt.h&gt;           /* mark_bh                          */
macro_line|#include &lt;linux/netdevice.h&gt;           /* struct net_device, and other headers */
macro_line|#include &lt;linux/inetdevice.h&gt;          /* struct net_device, and other headers */
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/ip.h&gt;                  /* struct iphdr                     */
macro_line|#include &lt;linux/tcp.h&gt;                 /* struct tcphdr                    */
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &quot;iucv.h&quot;
DECL|macro|DEBUG123
mdefine_line|#define DEBUG123
DECL|macro|MAX_DEVICES
mdefine_line|#define MAX_DEVICES  10
r_extern
r_char
id|_ascebc
(braket
)braket
suffix:semicolon
multiline_comment|/* &n; *  global structures &n; */
DECL|variable|iucv_userid
r_static
r_char
id|iucv_userid
(braket
id|MAX_DEVICES
)braket
(braket
l_int|8
)braket
suffix:semicolon
DECL|variable|iucv_ascii_userid
r_static
r_char
id|iucv_ascii_userid
(braket
id|MAX_DEVICES
)braket
(braket
l_int|8
)braket
suffix:semicolon
DECL|variable|iucv_pathid
r_static
r_int
id|iucv_pathid
(braket
id|MAX_DEVICES
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|iucv_ext_int_buffer
r_static
r_int
r_char
id|iucv_ext_int_buffer
(braket
l_int|40
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
(paren
l_int|8
)paren
)paren
)paren
op_assign
initialization_block
suffix:semicolon
DECL|variable|glob_command_buffer
r_static
r_int
r_char
id|glob_command_buffer
(braket
l_int|40
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&gt;=0x20300
DECL|typedef|net_device
r_typedef
r_struct
id|net_device
id|net_device
suffix:semicolon
macro_line|#else
DECL|typedef|net_device
r_typedef
r_struct
id|device
id|net_device
suffix:semicolon
macro_line|#endif
DECL|variable|iucv_devs
id|net_device
id|iucv_devs
(braket
)braket
suffix:semicolon
multiline_comment|/* This structure is private to each device. It is used to pass */
multiline_comment|/* packets in and out, so there is place for a packet           */
DECL|struct|iucv_priv
r_struct
id|iucv_priv
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|packetlen
r_int
id|packetlen
suffix:semicolon
DECL|member|status
r_int
id|status
suffix:semicolon
DECL|member|packetdata
id|u8
op_star
id|packetdata
suffix:semicolon
DECL|member|pathid
r_int
id|pathid
suffix:semicolon
multiline_comment|/* used device */
DECL|member|command_buffer
r_int
r_char
id|command_buffer
(braket
l_int|40
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
DECL|member|ext_int_buffer
r_int
r_char
id|ext_int_buffer
(braket
l_int|40
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
DECL|member|receive_buffer
id|u8
op_star
id|receive_buffer
suffix:semicolon
DECL|member|receive_buffer_len
r_int
id|receive_buffer_len
suffix:semicolon
DECL|member|send_buffer
id|u8
op_star
id|send_buffer
suffix:semicolon
DECL|member|send_buffer_len
r_int
id|send_buffer_len
suffix:semicolon
DECL|member|new_send_buf
r_char
op_star
id|new_send_buf
suffix:semicolon
multiline_comment|/* send buffer ptr */
DECL|member|recv_buf
r_int
r_char
id|recv_buf
(braket
l_int|2048
)braket
suffix:semicolon
multiline_comment|/* size is just a guess */
DECL|member|userid
r_int
r_char
id|userid
(braket
l_int|8
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|iucv_header
r_struct
id|iucv_header
(brace
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
DECL|function|netif_is_busy
r_static
id|__inline__
r_int
id|netif_is_busy
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
macro_line|#if LINUX_VERSION_CODE&lt;0x02032D
r_return
id|dev-&gt;tbusy
suffix:semicolon
macro_line|#else
r_return
id|test_bit
c_func
(paren
id|__LINK_STATE_XOFF
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE&lt;0x02032D
DECL|macro|netif_enter_interrupt
mdefine_line|#define netif_enter_interrupt(dev) dev-&gt;interrupt=1
DECL|macro|netif_exit_interrupt
mdefine_line|#define netif_exit_interrupt(dev) dev-&gt;interrupt=0
DECL|macro|netif_start
mdefine_line|#define netif_start(dev) dev-&gt;start=1
DECL|macro|netif_stop
mdefine_line|#define netif_stop(dev) dev-&gt;start=0
DECL|function|netif_stop_queue
r_static
id|__inline__
r_void
id|netif_stop_queue
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|netif_start_queue
r_static
id|__inline__
r_void
id|netif_start_queue
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|netif_wake_queue
r_static
id|__inline__
r_void
id|netif_wake_queue
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|netif_enter_interrupt
mdefine_line|#define netif_enter_interrupt(dev)
DECL|macro|netif_exit_interrupt
mdefine_line|#define netif_exit_interrupt(dev)
DECL|macro|netif_start
mdefine_line|#define netif_start(dev)
DECL|macro|netif_stop
mdefine_line|#define netif_stop(dev)
macro_line|#endif
multiline_comment|/*&n; * Following the iucv primitives &n; */
DECL|function|b2f0
r_extern
r_inline
r_void
id|b2f0
c_func
(paren
r_int
id|code
comma
r_void
op_star
id|parm
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;LR    1,%1&bslash;n&bslash;tLR    0,%0&bslash;n&bslash;t.long 0xb2f01000&quot;
op_scope_resolution
l_string|&quot;d&quot;
(paren
id|code
)paren
comma
l_string|&quot;a&quot;
(paren
id|parm
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
)brace
DECL|function|iucv_enable
r_int
id|iucv_enable
c_func
(paren
r_void
op_star
id|parms
)paren
(brace
id|MASK_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;ipmask
op_assign
l_int|0xF8
suffix:semicolon
id|b2f0
c_func
(paren
id|SETMASK
comma
id|parm
)paren
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;ipmask
op_assign
l_int|0xF8
suffix:semicolon
id|b2f0
c_func
(paren
id|SETCMASK
comma
id|parm
)paren
suffix:semicolon
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_declare_buffer
r_int
id|iucv_declare_buffer
c_func
(paren
r_void
op_star
id|parms
comma
id|DCLBFR_T
op_star
id|buffer
)paren
(brace
id|DCLBFR_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;ipflags1
op_assign
l_int|0x00
suffix:semicolon
id|parm-&gt;ipbfadr1
op_assign
id|virt_to_phys
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|b2f0
c_func
(paren
id|DECLARE_BUFFER
comma
id|parm
)paren
suffix:semicolon
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_retrieve_buffer
r_int
id|iucv_retrieve_buffer
c_func
(paren
r_void
op_star
id|parms
)paren
(brace
id|DCLBFR_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0x0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;iprcode
op_assign
l_int|0x0
suffix:semicolon
id|b2f0
c_func
(paren
id|RETRIEVE_BUFFER
comma
id|parm
)paren
suffix:semicolon
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_connect
r_int
id|iucv_connect
c_func
(paren
r_void
op_star
id|parms
comma
r_const
r_char
op_star
id|userid
comma
r_const
r_char
op_star
id|host
comma
r_const
r_char
op_star
id|ipusr
comma
r_int
r_int
op_star
id|used_pathid
)paren
(brace
id|CONNECT_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
multiline_comment|/* ipflags was 0x60*/
id|memset
c_func
(paren
id|parms
comma
l_int|0x0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;ipflags1
op_assign
l_int|0x80
suffix:semicolon
id|parm-&gt;ipmsglim
op_assign
l_int|0x0a
suffix:semicolon
id|memcpy
c_func
(paren
id|parm-&gt;ipvmid
comma
id|userid
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipusr
)paren
id|memcpy
c_func
(paren
id|parm-&gt;ipuser
comma
id|ipusr
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|parm-&gt;iptarget
comma
id|host
comma
l_int|8
)paren
suffix:semicolon
id|b2f0
c_func
(paren
id|CONNECT
comma
id|parm
)paren
suffix:semicolon
op_star
id|used_pathid
op_assign
id|parm-&gt;ippathid
suffix:semicolon
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_accept
r_int
id|iucv_accept
c_func
(paren
r_void
op_star
id|parms
comma
r_int
id|pathid
)paren
(brace
macro_line|#ifdef DEBUG
r_int
id|i
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|ACCEPT_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;ippathid
op_assign
id|pathid
suffix:semicolon
id|parm-&gt;ipflags1
op_assign
l_int|0x80
suffix:semicolon
id|parm-&gt;ipmsglim
op_assign
l_int|0x0a
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_accept input.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|parms
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|b2f0
c_func
(paren
id|ACCEPT
comma
id|parm
)paren
suffix:semicolon
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_receive
r_int
id|iucv_receive
c_func
(paren
r_void
op_star
id|parms
comma
r_void
op_star
id|bufferarray
comma
r_int
id|len
)paren
(brace
macro_line|#ifdef DEBUG
r_int
id|i
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|RECEIVE_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0x0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
multiline_comment|/*parm-&gt;ipflags1 = 0x42;*/
id|parm-&gt;ipflags1
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;ipmsgid
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;iptrgcls
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;ipbfadr1
op_assign
(paren
id|ULONG
)paren
id|virt_to_phys
c_func
(paren
id|bufferarray
)paren
suffix:semicolon
id|parm-&gt;ipbfln1f
op_assign
id|len
suffix:semicolon
id|parm-&gt;ipbfln2f
op_assign
l_int|0x0
suffix:semicolon
id|b2f0
c_func
(paren
id|RECEIVE
comma
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parm-&gt;iprcode
op_eq
l_int|0
)paren
id|len
op_assign
id|parm-&gt;ipbfln1f
suffix:semicolon
singleline_comment|//  len = len-parm-&gt;ipbfln1f;
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_receive command input:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* show iucv buffer before send */
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|parms
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_receive data buffer:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* show data received */
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|bufferarray
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;received length: %02x &quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_send
r_int
id|iucv_send
c_func
(paren
r_void
op_star
id|parms
comma
r_int
id|pathid
comma
r_void
op_star
id|bufferarray
comma
r_int
id|len
comma
r_void
op_star
id|recv_buf
comma
r_int
id|recv_len
)paren
(brace
macro_line|#ifdef DEBUG
r_int
id|i
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|SEND_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0x0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
multiline_comment|/*  parm-&gt;ipflags1 = 0x48; ??*/
id|parm-&gt;ippathid
op_assign
id|pathid
suffix:semicolon
id|parm-&gt;ipflags1
op_assign
l_int|0x14
suffix:semicolon
multiline_comment|/* any options ?? */
id|parm-&gt;ipmsgid
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;iptrgcls
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;ipbfadr1
op_assign
id|virt_to_phys
c_func
(paren
id|bufferarray
)paren
suffix:semicolon
id|parm-&gt;ipbfln1f
op_assign
id|len
suffix:semicolon
id|parm-&gt;ipsrccls
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;ipmsgtag
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;ipbfadr2
op_assign
id|virt_to_phys
c_func
(paren
id|recv_buf
)paren
suffix:semicolon
id|parm-&gt;ipbfln2f
op_assign
id|recv_len
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_send command input:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* show iucv buffer before send */
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|parms
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_send data buffer:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* show send data before send */
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
r_char
op_star
)paren
id|bufferarray
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|b2f0
c_func
(paren
id|SEND
comma
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUGXX
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_send buffer after send:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* show send buffer after send */
(brace
id|printk
c_func
(paren
l_string|&quot;%1x&quot;
comma
(paren
(paren
r_char
op_star
)paren
id|bufferarray
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
DECL|function|iucv_sever
r_int
id|iucv_sever
c_func
(paren
r_void
op_star
id|parms
)paren
(brace
id|SEVER_T
op_star
id|parm
op_assign
id|parms
suffix:semicolon
id|memset
c_func
(paren
id|parms
comma
l_int|0x0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm-&gt;ippathid
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;ipflags1
op_assign
l_int|0x0
suffix:semicolon
id|parm-&gt;iprcode
op_assign
l_int|0xF
suffix:semicolon
id|memset
c_func
(paren
id|parm-&gt;ipuser
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|b2f0
c_func
(paren
id|SEVER
comma
id|parm
)paren
suffix:semicolon
r_return
id|parm-&gt;iprcode
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
multiline_comment|/*--------------------------*/
multiline_comment|/* Dump buffer formatted    */
multiline_comment|/*--------------------------*/
DECL|function|dumpit
r_static
r_void
id|dumpit
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
l_int|16
)paren
op_logical_and
id|i
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
l_int|4
)paren
op_logical_and
id|i
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X&quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_mod
l_int|16
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*--------------------------*/
multiline_comment|/* Get device from pathid   */
multiline_comment|/*--------------------------*/
DECL|function|get_device_from_pathid
id|net_device
op_star
id|get_device_from_pathid
c_func
(paren
r_int
id|pathid
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|iucv_pathid
(braket
id|i
)braket
op_eq
id|pathid
)paren
r_return
op_amp
id|iucv_devs
(braket
id|i
)braket
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;iucv: get_device_from_pathid: no device for pathid %X&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------*/
multiline_comment|/* Get device from userid   */
multiline_comment|/*--------------------------*/
DECL|function|get_device_from_userid
id|net_device
op_star
id|get_device_from_userid
c_func
(paren
r_char
op_star
id|userid
)paren
(brace
r_int
id|i
suffix:semicolon
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev
op_assign
op_amp
id|iucv_devs
(braket
id|i
)braket
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|privptr-&gt;userid
comma
id|userid
comma
l_int|8
)paren
op_eq
l_int|0
)paren
r_return
op_amp
id|iucv_devs
(braket
id|i
)braket
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;iucv: get_device_from_uid: no device for userid %s&bslash;n&quot;
comma
id|userid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------*/
multiline_comment|/* Open iucv Device Driver */
multiline_comment|/*--------------------------*/
DECL|function|iucv_open
r_int
id|iucv_open
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_int
id|iucv_used_pathid
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
r_char
id|iucv_host
(braket
l_int|8
)braket
op_assign
initialization_block
suffix:semicolon
r_char
id|vmident
(braket
l_int|16
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_open, device: %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;pathid
op_ne
op_minus
l_int|1
)paren
(brace
id|netif_start
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|iucv_connect
c_func
(paren
id|privptr-&gt;command_buffer
comma
id|privptr-&gt;userid
comma
id|iucv_host
comma
id|vmident
comma
op_amp
id|iucv_used_pathid
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: iucv connect failed with rc %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|iucv_retrieve_buffer
c_func
(paren
id|privptr-&gt;command_buffer
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|privptr-&gt;pathid
op_assign
id|iucv_used_pathid
suffix:semicolon
id|iucv_pathid
(braket
id|dev
op_minus
id|iucv_devs
)braket
op_assign
id|privptr-&gt;pathid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_connect ended with rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv[%d] pathid %X &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|dev
op_minus
id|iucv_devs
)paren
comma
id|privptr-&gt;pathid
)paren
suffix:semicolon
macro_line|#endif
id|netif_start
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------------*/
multiline_comment|/* Receive a packet: retrieve, encapsulate and pass over to upper levels */
multiline_comment|/*-----------------------------------------------------------------------*/
DECL|function|iucv_rx
r_void
id|iucv_rx
c_func
(paren
id|net_device
op_star
id|dev
comma
r_int
id|len
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_rx len: %X, device %s&bslash;n&quot;
comma
id|len
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv rx: received orig:&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* strip iucv header now */
id|len
op_assign
id|len
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* short header */
id|buf
op_assign
id|buf
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* short header */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* why +2 ? alignment ? */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv rx: low on mem, returning...&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* align IP on 16B boundary*/
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv rx: data before netif_rx()&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Write metadata, and then pass to the receive level */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
multiline_comment|/* don&squot;t check it*/
id|privptr-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end  iucv_rx() */
multiline_comment|/*----------------------------*/
multiline_comment|/* handle interrupts          */
multiline_comment|/*----------------------------*/
DECL|function|do_iucv_interrupt
r_void
id|do_iucv_interrupt
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|in_device
op_star
id|indev
suffix:semicolon
r_struct
id|in_ifaddr
op_star
id|inaddr
suffix:semicolon
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|net_device
op_star
id|dev
op_assign
l_int|0
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
id|INTERRUPT_T
op_star
id|extern_int_buffer
suffix:semicolon
r_int
r_int
id|iucv_data_len
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|iucv_next
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|rcvptr
suffix:semicolon
multiline_comment|/* get own buffer: */
id|extern_int_buffer
op_assign
(paren
id|INTERRUPT_T
op_star
)paren
id|iucv_ext_int_buffer
suffix:semicolon
id|netif_enter_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* lock ! */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: do_iucv_interrupt %x received; pathid: %02X&bslash;n&quot;
comma
id|extern_int_buffer-&gt;iptype
comma
id|extern_int_buffer-&gt;ippathid
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: extern_int_buffer:&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|extern_int_buffer
(braket
l_int|0
)braket
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|extern_int_buffer-&gt;iptype
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* connection pending ext interrrupt */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: connection pending IRQ.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|iucv_accept
c_func
(paren
id|glob_command_buffer
comma
id|extern_int_buffer-&gt;ippathid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_accept failed with rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|iucv_retrieve_buffer
c_func
(paren
id|glob_command_buffer
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|dumpit
c_func
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
id|extern_int_buffer
)paren
(braket
l_int|8
)braket
comma
l_int|8
)paren
suffix:semicolon
macro_line|#endif
id|dev
op_assign
id|get_device_from_userid
c_func
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
id|extern_int_buffer
)paren
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|privptr-&gt;pathid
op_assign
id|extern_int_buffer-&gt;ippathid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_accept ended with rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: device %s found.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* connection completed ext interrrupt */
multiline_comment|/* set own global IP address */
multiline_comment|/* &amp; set global routing addr */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;connection completed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|extern_int_buffer-&gt;ipmsgtag
op_ne
l_int|0
)paren
(brace
multiline_comment|/* get ptr&squot;s to kernel struct with local &amp; broadcast address */
id|dev
op_assign
id|get_device_from_pathid
c_func
(paren
id|extern_int_buffer-&gt;ippathid
)paren
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|indev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
id|inaddr
op_assign
(paren
r_struct
id|in_ifaddr
op_star
)paren
id|indev-&gt;ifa_list
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* connection severed ext interrrupt */
multiline_comment|/* we do not handle this one at this time */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;connection severed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* connection quiesced ext interrrupt */
multiline_comment|/* we do not handle this one at this time */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;connection quiesced.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
multiline_comment|/* connection resumed ext interrrupt */
multiline_comment|/* we do not handle this one at this time */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;connection resumed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* priority message complete ext interrupt */
r_case
l_int|0x07
suffix:colon
multiline_comment|/* non priority message complete ext interrupt */
multiline_comment|/* send it to iucv_rx for handling */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;message completed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|extern_int_buffer-&gt;ipaudit
op_eq
l_int|0
)paren
multiline_comment|/* ok case */
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: msg complete interrupt successful, rc: %X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|extern_int_buffer-&gt;ipaudit
)paren
suffix:semicolon
macro_line|#endif
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: msg complete interrupt error, rc: %X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|extern_int_buffer-&gt;ipaudit
)paren
suffix:semicolon
)brace
multiline_comment|/* a transmission is over: tell we are no more busy */
id|dev
op_assign
id|get_device_from_pathid
c_func
(paren
id|extern_int_buffer-&gt;ippathid
)paren
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* transmission is no longer busy*/
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* priority message pending */
r_case
l_int|0x09
suffix:colon
multiline_comment|/* non priority message pending */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;message pending.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|dev
op_assign
id|get_device_from_pathid
c_func
(paren
id|extern_int_buffer-&gt;ippathid
)paren
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|rcvptr
op_assign
op_amp
id|privptr-&gt;receive_buffer
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* re-set receive buffer */
id|memset
c_func
(paren
id|privptr-&gt;receive_buffer
comma
l_int|0
comma
id|privptr-&gt;receive_buffer_len
)paren
suffix:semicolon
id|len
op_assign
id|privptr-&gt;receive_buffer_len
suffix:semicolon
multiline_comment|/* get data now */
r_if
c_cond
(paren
id|extern_int_buffer-&gt;ipflags1
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* data is in the message */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_receive data is in header!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|privptr-&gt;receive_buffer
comma
(paren
r_char
op_star
)paren
id|extern_int_buffer-&gt;iprmmsg1
comma
(paren
r_int
r_int
)paren
(paren
id|extern_int_buffer-&gt;iprmmsg2
)paren
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* data is in buffer, do a receive */
(brace
id|rc
op_assign
id|iucv_receive
c_func
(paren
id|privptr-&gt;command_buffer
comma
id|rcvptr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
op_logical_or
id|len
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_receive failed with rc: %X, length: %lX&bslash;n&quot;
comma
id|rc
comma
id|len
)paren
suffix:semicolon
id|iucv_retrieve_buffer
c_func
(paren
id|privptr-&gt;command_buffer
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* end else */
id|iucv_next
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* get next packet offset */
id|iucv_data_len
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|rcvptr
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* until receive buffer is empty, i.e. iucv_next == 0 ! */
multiline_comment|/* get data length:    */
id|iucv_data_len
op_assign
id|iucv_data_len
op_minus
id|iucv_next
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_receive: len is %02X, last: %02X&bslash;n&quot;
comma
id|iucv_data_len
comma
id|iucv_next
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* transmit upstairs */
id|iucv_rx
c_func
(paren
id|dev
comma
(paren
id|iucv_data_len
)paren
comma
id|rcvptr
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: transaction complete now.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|iucv_next
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|rcvptr
)paren
suffix:semicolon
id|rcvptr
op_assign
id|rcvptr
op_plus
id|iucv_data_len
suffix:semicolon
multiline_comment|/* get next packet offset */
id|iucv_data_len
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|rcvptr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|iucv_data_len
op_ne
l_int|0
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* transmission is no longer busy*/
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unknown iucv interrupt &bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|netif_exit_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* release lock*/
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: leaving do_iucv_interrupt.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* end    do_iucv_interrupt()  */
multiline_comment|/*-------------------------------------------*/
multiline_comment|/*   Transmit a packet (low level interface) */
multiline_comment|/*-------------------------------------------*/
DECL|function|iucv_hw_tx
r_int
id|iucv_hw_tx
c_func
(paren
r_char
op_star
id|send_buf
comma
r_int
id|len
comma
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* This function deals with hw details.                         */
multiline_comment|/* This interface strips off the ethernet header details.       */
multiline_comment|/* In other words, this function implements the iucv behaviour,*/
multiline_comment|/* while all other procedures are rather device-independent     */
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
r_int
id|rc
comma
id|recv_len
op_assign
l_int|2000
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_hw_tx, device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: hw_TX_data len: %X&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|dumpit
c_func
(paren
id|send_buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* I am paranoid. Ain&squot;t I? */
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: Hmm... packet too short (%i octets)&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;   * build IUCV header (preceeding halfword offset)   &n;   * works as follows: Each packet is preceded by the &n;   * halfword offset to the next one. &n;   * The last packet is followed by an offset of zero.&n;   * E.g., AL2(12),10-byte packet, AL2(34), 32-byte packet, AL2(0)&n;   */
id|memcpy
c_func
(paren
op_amp
id|privptr-&gt;send_buffer
(braket
l_int|2
)braket
comma
id|send_buf
comma
id|len
op_plus
l_int|2
)paren
suffix:semicolon
id|privptr-&gt;send_buffer
(braket
id|len
op_plus
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;send_buffer
(braket
id|len
op_plus
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
op_amp
id|privptr-&gt;send_buffer
(braket
l_int|0
)braket
)paren
op_assign
id|len
op_plus
l_int|2
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_hw_tx, device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: send len: %X&bslash;n&quot;
comma
id|len
op_plus
l_int|4
)paren
suffix:semicolon
id|dumpit
c_func
(paren
id|privptr-&gt;send_buffer
comma
id|len
op_plus
l_int|4
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
(paren
r_int
r_int
op_star
)paren
op_amp
id|privptr-&gt;send_buffer
(braket
l_int|0
)braket
)paren
op_assign
id|len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* Ok, now the packet is ready for transmission: send it. */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|iucv_send
c_func
(paren
id|privptr-&gt;command_buffer
comma
id|privptr-&gt;pathid
comma
op_amp
id|privptr-&gt;send_buffer
(braket
l_int|0
)braket
comma
id|len
op_plus
l_int|4
comma
id|privptr-&gt;recv_buf
comma
id|recv_len
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: send_iucv failed, rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|iucv_retrieve_buffer
c_func
(paren
id|privptr-&gt;command_buffer
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: send_iucv ended, rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* end   iucv_hw_tx()  */
multiline_comment|/*------------------------------------------*/
multiline_comment|/* Transmit a packet (called by the kernel) */
multiline_comment|/*------------------------------------------*/
DECL|function|iucv_tx
r_int
id|iucv_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: NULL dev passed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: %s: NULL buffer passed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: enter iucv_tx, using %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|netif_is_busy
c_func
(paren
id|dev
)paren
)paren
multiline_comment|/* shouldn&squot;t happen */
(brace
id|privptr-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: %s: transmit access conflict ! leaving iucv_tx.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* transmission is busy*/
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* save the timestamp*/
multiline_comment|/* actual deliver of data is device-specific, and not shown here */
id|retval
op_assign
id|iucv_hw_tx
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|dev
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* release it*/
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv:leaving iucv_tx, device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
multiline_comment|/* zero == done; nonzero == fail*/
)brace
multiline_comment|/* end  iucv_tx( struct sk_buff *skb, struct device *dev)  */
multiline_comment|/*---------------*/
multiline_comment|/* iucv_release */
multiline_comment|/*---------------*/
DECL|function|iucv_release
r_int
id|iucv_release
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|netif_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* can&squot;t transmit any more*/
id|rc
op_assign
id|iucv_sever
c_func
(paren
id|privptr-&gt;command_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: %s: iucv_release pending...rc:%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rc
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_sever ended with rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* end  iucv_release() */
multiline_comment|/*-----------------------------------------------*/
multiline_comment|/* Configuration changes (passed on by ifconfig) */
multiline_comment|/*-----------------------------------------------*/
DECL|function|iucv_config
r_int
id|iucv_config
c_func
(paren
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
multiline_comment|/* can&squot;t act on a running interface*/
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* ignore other fields */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  end  iucv_config()  */
multiline_comment|/*----------------*/
multiline_comment|/* Ioctl commands */
multiline_comment|/*----------------*/
DECL|function|iucv_ioctl
r_int
id|iucv_ioctl
c_func
(paren
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: device %s; iucv_ioctl&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*---------------------------------*/
multiline_comment|/* Return statistics to the caller */
multiline_comment|/*---------------------------------*/
DECL|function|iucv_stats
r_struct
id|net_device_stats
op_star
id|iucv_stats
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|iucv_priv
op_star
id|priv
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: device %s; iucv_stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * iucv_change_mtu     &n; * IUCV can handle MTU sizes from 576 to approx. 32000    &n; */
DECL|function|iucv_change_mtu
r_static
r_int
id|iucv_change_mtu
c_func
(paren
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: device %s; iucv_change_mtu&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|64
)paren
op_logical_or
(paren
id|new_mtu
OG
l_int|32000
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------*/
multiline_comment|/* The init function (sometimes called probe).*/
multiline_comment|/* It is invoked by register_netdev()         */
multiline_comment|/*--------------------------------------------*/
DECL|function|iucv_init
r_int
id|iucv_init
c_func
(paren
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|iucv_priv
op_star
id|privptr
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_init, device: %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;open
op_assign
id|iucv_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|iucv_release
suffix:semicolon
id|dev-&gt;set_config
op_assign
id|iucv_config
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|iucv_tx
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|iucv_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|iucv_stats
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|iucv_change_mtu
suffix:semicolon
multiline_comment|/* keep the default flags, just add NOARP */
id|dev-&gt;hard_header_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_SLIP
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|100
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
id|dev-&gt;mtu
op_assign
l_int|4092
suffix:semicolon
id|dev_init_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Then, allocate the priv field. This encloses the statistics */
multiline_comment|/* and a few private fields.*/
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iucv_priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: no memory for dev-&gt;priv.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iucv_priv
)paren
)paren
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|iucv_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|privptr-&gt;send_buffer
op_assign
(paren
id|u8
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_plus
id|GFP_DMA
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;send_buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: could not get pages for send buffer&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|privptr-&gt;send_buffer
comma
l_int|0
comma
l_int|8
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
id|privptr-&gt;send_buffer_len
op_assign
l_int|8
op_star
id|PAGE_SIZE
suffix:semicolon
id|privptr-&gt;receive_buffer
op_assign
(paren
id|u8
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_plus
id|GFP_DMA
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;receive_buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: could not get pages for receive buffer&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|privptr-&gt;receive_buffer
comma
l_int|0
comma
l_int|8
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
id|privptr-&gt;receive_buffer_len
op_assign
l_int|8
op_star
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/* now use the private fields ... */
multiline_comment|/* init pathid                    */
id|privptr-&gt;pathid
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* init private userid from global userid */
id|memcpy
c_func
(paren
id|privptr-&gt;userid
comma
id|iucv_userid
(braket
id|dev
op_minus
id|iucv_devs
)braket
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* we can use only ONE buffer for external interrupt ! */
id|rc
op_assign
id|iucv_declare_buffer
c_func
(paren
id|privptr-&gt;command_buffer
comma
(paren
id|DCLBFR_T
op_star
)paren
id|iucv_ext_int_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
op_logical_and
id|rc
op_ne
l_int|19
)paren
multiline_comment|/* ignore existing buffer */
(brace
id|printk
c_func
(paren
l_string|&quot;iucv:iucv_declare failed, rc: %X&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|iucv_enable
c_func
(paren
id|privptr-&gt;command_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv:iucv_enable failed, rc: %x&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|iucv_retrieve_buffer
c_func
(paren
id|privptr-&gt;command_buffer
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: iucv_init endend OK for device %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * setup iucv devices&n; * &n; * string passed: iucv=userid1,...,useridn &n; */
macro_line|#if LINUX_VERSION_CODE&gt;=0x020300
DECL|function|iucv_setup
r_static
r_int
id|__init
id|iucv_setup
c_func
(paren
r_char
op_star
id|str
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_void
id|iucv_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
macro_line|#endif
(brace
r_int
id|result
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
comma
id|device_present
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|s
op_assign
id|str
suffix:semicolon
id|net_device
op_star
id|dev
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: start registering device(s)... &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     * scan device userids&n;     */
r_while
c_loop
(paren
op_star
id|s
op_ne
l_int|0x20
op_logical_and
op_star
id|s
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
r_if
c_cond
(paren
op_star
id|s
op_eq
l_char|&squot;,&squot;
)paren
(brace
multiline_comment|/* fill userid up to 8 chars */
r_for
c_loop
(paren
id|k
op_assign
id|i
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|iucv_userid
(braket
id|j
)braket
(braket
id|k
)braket
op_assign
l_int|0x40
suffix:semicolon
)brace
multiline_comment|/* end for */
multiline_comment|/* new device  */
id|j
op_increment
suffix:semicolon
id|s
op_increment
suffix:semicolon
multiline_comment|/* ignore current char */
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
id|MAX_DEVICES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iucv: setup devices: max devices %d reached.&bslash;n&quot;
comma
id|MAX_DEVICES
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end if */
r_continue
suffix:semicolon
)brace
multiline_comment|/* end if */
id|iucv_ascii_userid
(braket
id|j
)braket
(braket
id|i
)braket
op_assign
(paren
r_int
)paren
op_star
id|s
suffix:semicolon
id|iucv_userid
(braket
id|j
)braket
(braket
id|i
)braket
op_assign
id|_ascebc
(braket
(paren
r_int
)paren
op_star
id|s
op_increment
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
multiline_comment|/* end while */
multiline_comment|/* &n;     * fill last userid up to 8 chars&n;     */
r_for
c_loop
(paren
id|k
op_assign
id|i
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|iucv_userid
(braket
id|j
)braket
(braket
id|k
)braket
op_assign
l_int|0x40
suffix:semicolon
)brace
multiline_comment|/*&n;     * set device name and register&n;     */
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
op_le
id|j
suffix:semicolon
id|k
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|iucv_devs
(braket
id|k
)braket
dot
id|name
comma
l_string|&quot;iucv0&quot;
comma
l_int|4
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|iucv_devs
(braket
id|k
)braket
suffix:semicolon
id|dev-&gt;name
(braket
l_int|4
)braket
op_assign
id|k
op_plus
l_char|&squot;0&squot;
suffix:semicolon
macro_line|#ifdef DEBUGX
id|printk
c_func
(paren
l_string|&quot;iucv: (ASCII- )Userid:%s&bslash;n&quot;
comma
op_amp
id|iucv_ascii_userid
(braket
id|k
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: (ASCII-)Userid: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
)paren
id|iucv_ascii_userid
(braket
id|k
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: (EBCDIC-)Userid: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
)paren
id|iucv_userid
(braket
id|k
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iucv: device name :%s&bslash;n&quot;
comma
id|iucv_devs
(braket
id|k
)braket
dot
id|name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|result
op_assign
id|register_netdev
c_func
(paren
id|iucv_devs
op_plus
id|k
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;iucv: error %i registering device &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|result
comma
id|iucv_devs
(braket
id|k
)braket
dot
id|name
)paren
suffix:semicolon
r_else
(brace
id|device_present
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* end for */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;iucv: end register devices, %d devices present&bslash;n&quot;
comma
id|device_present
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* return device_present ? 0 : -ENODEV; */
macro_line|#if LINUX_VERSION_CODE&gt;=0x020300
r_return
l_int|1
suffix:semicolon
macro_line|#else
r_return
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=0x020300
id|__setup
c_func
(paren
l_string|&quot;iucv=&quot;
comma
id|iucv_setup
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*-------------*/
multiline_comment|/* The devices */
multiline_comment|/*-------------*/
DECL|variable|iucv_names
r_char
id|iucv_names
(braket
id|MAX_DEVICES
op_star
l_int|8
)braket
suffix:semicolon
multiline_comment|/* MAX_DEVICES eight-byte buffers */
DECL|variable|iucv_devs
id|net_device
id|iucv_devs
(braket
id|MAX_DEVICES
)braket
op_assign
(brace
(brace
id|iucv_names
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|8
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|16
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|24
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|32
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|40
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|48
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|56
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|64
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
comma
(brace
id|iucv_names
op_plus
l_int|72
comma
multiline_comment|/* name -- set at load time */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* shmem addresses */
l_int|0x000
comma
multiline_comment|/* ioport */
l_int|0
comma
multiline_comment|/* irq line */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* various flags: init to 0 */
l_int|NULL
comma
multiline_comment|/* next ptr */
id|iucv_init
comma
multiline_comment|/* init function, fill other fields with NULL&squot;s */
)brace
)brace
suffix:semicolon
eof
