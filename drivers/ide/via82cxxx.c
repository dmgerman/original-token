multiline_comment|/*&n; * linux/drivers/block/via82cxxx.c&t;Version 0.07&t;Feb. 10, 2000&n; *&n; *  Copyright (C) 1998-99&t;Michel Aubry, Maintainer&n; *  Copyright (C) 1999&t;&t;Jeff Garzik, MVP4 Support&n; *&t;&t;&t;&t;&t;(jgarzik@mandrakesoft.com)&n; *  Copyright (C) 1998-2000&t;Andre Hedrick (andre@suse.com)&n; *  May be copied or modified under the terms of the GNU General Public License&n; *&n; *  The VIA MVP-4 is reported OK with UDMA.&n; *  The VIA MVP-3 is reported OK with UDMA.&n; *  The TX Pro III is also reported OK with UDMA.&n; *&n; *  VIA chips also have a single FIFO, with the same 64 bytes deep&n; *  buffer (16 levels of 4 bytes each).&n; *&n; *  However, VIA chips can have the buffer split either 8:8 levels,&n; *  16:0 levels or 0:16 levels between both channels. One could think&n; *  of using this feature, as even if no level of FIFO is given to a&n; *  given channel, one can for instance always reach ATAPI drives through&n; *  it, or, if one channel is unused, configuration defaults to&n; *  an even split FIFO levels.&n; *  &n; *  This feature is available only through a kernel command line :&n; *&t;&t;&quot;splitfifo=Chan,Thr0,Thr1&quot; or &quot;splitfifo=Chan&quot;.&n; *&t;&t;where:  Chan =1,2,3 or 4 and Thrx = 1,2,3,or 4.&n; *&n; *  If Chan == 1:&n; *&t;gives all the fifo to channel 0,&n; *&t;sets its threshold to Thr0/4,&n; *&t;and disables any dma access to channel 1.&n; *&n; *  If chan == 2:&n; *&t;gives all the fifo to channel 1,&n; *&t;sets its threshold to Thr1/4,&n; *&t;and disables any dma access to channel 0.&n; *&n; *  If chan == 3 or 4:&n; *&t;shares evenly fifo between channels,&n; *&t;gives channel 0 a threshold of Thr0/4,&n; *&t;and channel 1 a threshold of Thr1/4.&n; *&n; *  Note that by default (if no command line is provided) and if a channel&n; *  has been disabled in Bios, all the fifo is given to the active channel,&n; *  and its threshold is set to 3/4.&n; *&n; *  VT82c586B&n; *&n; *    Offset 4B-48 - Drive Timing Control&n; *             | pio0 | pio1 | pio2 | pio3 | pio4&n; *    25.0 MHz | 0xA8 | 0x65 | 0x65 | 0x31 | 0x20 &n; *    33.0 MHz | 0xA8 | 0x65 | 0x65 | 0x31 | 0x20&n; *    37.5 MHz | 0xA9 | 0x76 | 0x76 | 0x32 | 0x21&n; *&n; *    Offset 53-50 - UltraDMA Extended Timing Control&n; *      UDMA   |  NO  |   0  |   1  |   2&n; *             | 0x03 | 0x62 | 0x61 | 0x60&n; *&n; *  VT82c596B &amp; VT82c686A&n; *&n; *    Offset 4B-48 - Drive Timing Control&n; *             | pio0 | pio1 | pio2 | pio3 | pio4&n; *    25.0 MHz | 0xA8 | 0x65 | 0x65 | 0x31 | 0x20&n; *    33.0 MHz | 0xA8 | 0x65 | 0x65 | 0x31 | 0x20&n; *    37.5 MHz | 0xDB | 0x87 | 0x87 | 0x42 | 0x31&n; *    41.5 MHz | 0xFE | 0xA8 | 0xA8 | 0x53 | 0x32&n; *&n; *    Offset 53-50 - UltraDMA Extended Timing Control&n; *      UDMA   |  NO  |   0  |   1  |   2&n; *    33.0 MHz | 0x03 | 0xE2 | 0xE1 | 0xE0&n; *    37.5 MHz | 0x03 | 0xE2 | 0xE2 | 0xE1   (1)&n; *&n; *    Offset 53-50 - UltraDMA Extended Timing Control&n; *      UDMA   |  NO  |   0  |   1  |   2  |   3  |   4&n; *    33.0 MHz |  (2) | 0xE6 | 0xE4 | 0xE2 | 0xE1 | 0xE0&n; *    37.5 MHz |  (2) | 0xE6 | 0xE6 | 0xE4 | 0xE2 | 0xE1   (1)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|variable|host_dev
r_static
r_struct
id|pci_dev
op_star
id|host_dev
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|isa_dev
r_static
r_struct
id|pci_dev
op_star
id|isa_dev
op_assign
l_int|NULL
suffix:semicolon
r_static
r_const
r_struct
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|host_id
r_int
r_int
id|host_id
suffix:semicolon
DECL|variable|ApolloHostChipInfo
)brace
id|ApolloHostChipInfo
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;VT 82C585 Apollo VP1/VPX&quot;
comma
id|PCI_DEVICE_ID_VIA_82C585
comma
)brace
comma
(brace
l_string|&quot;VT 82C595 Apollo VP2&quot;
comma
id|PCI_DEVICE_ID_VIA_82C595
comma
)brace
comma
(brace
l_string|&quot;VT 82C597 Apollo VP3&quot;
comma
id|PCI_DEVICE_ID_VIA_82C597_0
comma
)brace
comma
(brace
l_string|&quot;VT 82C598 Apollo MVP3&quot;
comma
id|PCI_DEVICE_ID_VIA_82C598_0
comma
)brace
comma
(brace
l_string|&quot;VT 82C598 Apollo MVP3&quot;
comma
id|PCI_DEVICE_ID_VIA_82C598_0
comma
)brace
comma
(brace
l_string|&quot;VT 82C680 Apollo P6&quot;
comma
id|PCI_DEVICE_ID_VIA_82C680
comma
)brace
comma
(brace
l_string|&quot;VT 82C691 Apollo Pro&quot;
comma
id|PCI_DEVICE_ID_VIA_82C691
comma
)brace
comma
(brace
l_string|&quot;VT 82C693 Apollo Pro Plus&quot;
comma
id|PCI_DEVICE_ID_VIA_82C693
comma
)brace
comma
(brace
l_string|&quot;Apollo MVP4&quot;
comma
id|PCI_DEVICE_ID_VIA_8501_0
comma
)brace
comma
(brace
l_string|&quot;VT 8371&quot;
comma
id|PCI_DEVICE_ID_VIA_8371_0
comma
)brace
comma
(brace
l_string|&quot;VT 8601&quot;
comma
id|PCI_DEVICE_ID_VIA_8601_0
comma
)brace
comma
)brace
suffix:semicolon
DECL|macro|NUM_APOLLO_ISA_CHIP_DEVICES
mdefine_line|#define NUM_APOLLO_ISA_CHIP_DEVICES&t;2
DECL|macro|VIA_FLAG_CHECK_REV
mdefine_line|#define VIA_FLAG_CHECK_REV&t;&t;0x00000001
DECL|macro|VIA_FLAG_ATA_66
mdefine_line|#define VIA_FLAG_ATA_66&t;&t;&t;0x00000002
r_static
r_const
r_struct
(brace
DECL|member|host_id
r_int
r_int
id|host_id
suffix:semicolon
DECL|member|isa_id
r_int
r_int
id|isa_id
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|variable|ApolloISAChipInfo
)brace
id|ApolloISAChipInfo
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE_ID_VIA_82C585
comma
id|PCI_DEVICE_ID_VIA_82C586_1
comma
id|VIA_FLAG_CHECK_REV
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C595
comma
id|PCI_DEVICE_ID_VIA_82C586_1
comma
id|VIA_FLAG_CHECK_REV
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C597_0
comma
id|PCI_DEVICE_ID_VIA_82C586_1
comma
id|VIA_FLAG_CHECK_REV
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C598_0
comma
id|PCI_DEVICE_ID_VIA_82C586_1
comma
id|VIA_FLAG_CHECK_REV
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C598_0
comma
id|PCI_DEVICE_ID_VIA_82C596
comma
l_int|0
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C680
comma
id|PCI_DEVICE_ID_VIA_82C586_1
comma
id|VIA_FLAG_CHECK_REV
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C691
comma
id|PCI_DEVICE_ID_VIA_82C596
comma
id|VIA_FLAG_ATA_66
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_82C693
comma
id|PCI_DEVICE_ID_VIA_82C596
comma
l_int|0
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_8501_0
comma
id|PCI_DEVICE_ID_VIA_82C686
comma
id|VIA_FLAG_ATA_66
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_8371_0
comma
id|PCI_DEVICE_ID_VIA_82C686
comma
id|VIA_FLAG_ATA_66
)brace
comma
(brace
id|PCI_DEVICE_ID_VIA_8601_0
comma
id|PCI_DEVICE_ID_VIA_8231
comma
id|VIA_FLAG_ATA_66
)brace
comma
)brace
suffix:semicolon
DECL|macro|arraysize
mdefine_line|#define arraysize(x)&t;(sizeof(x)/sizeof(*(x)))
DECL|macro|DISPLAY_VIA_TIMINGS
mdefine_line|#define DISPLAY_VIA_TIMINGS
macro_line|#if defined(DISPLAY_VIA_TIMINGS) &amp;&amp; defined(CONFIG_PROC_FS)
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
DECL|variable|FIFO_str
r_static
r_char
op_star
id|FIFO_str
(braket
)braket
op_assign
(brace
l_string|&quot; 1 &quot;
comma
l_string|&quot;3/4&quot;
comma
l_string|&quot;1/2&quot;
comma
l_string|&quot;1/4&quot;
)brace
suffix:semicolon
DECL|variable|control3_str
r_static
r_char
op_star
id|control3_str
(braket
)braket
op_assign
(brace
l_string|&quot;No limitation&quot;
comma
l_string|&quot;64&quot;
comma
l_string|&quot;128&quot;
comma
l_string|&quot;192&quot;
)brace
suffix:semicolon
r_static
r_int
id|via_get_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
(paren
op_star
id|via_display_info
)paren
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* ide-proc.c */
DECL|variable|bmide_dev
r_static
r_struct
id|pci_dev
op_star
id|bmide_dev
suffix:semicolon
DECL|function|print_apollo_drive_config
r_static
r_char
op_star
id|print_apollo_drive_config
(paren
r_char
op_star
id|buf
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_int
id|time
suffix:semicolon
id|byte
id|tm
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
multiline_comment|/* Drive Timing Control */
id|rc
op_assign
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x48
comma
op_amp
id|time
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Act Pls Width:  %02d          %02d           %02d          %02d&bslash;n&quot;
comma
(paren
(paren
id|time
op_amp
l_int|0xf0000000
)paren
op_rshift
l_int|28
)paren
op_plus
l_int|1
comma
(paren
(paren
id|time
op_amp
l_int|0xf00000
)paren
op_rshift
l_int|20
)paren
op_plus
l_int|1
comma
(paren
(paren
id|time
op_amp
l_int|0xf000
)paren
op_rshift
l_int|12
)paren
op_plus
l_int|1
comma
(paren
(paren
id|time
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Recovery Time:  %02d          %02d           %02d          %02d&bslash;n&quot;
comma
(paren
(paren
id|time
op_amp
l_int|0x0f000000
)paren
op_rshift
l_int|24
)paren
op_plus
l_int|1
comma
(paren
(paren
id|time
op_amp
l_int|0x0f0000
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|1
comma
(paren
(paren
id|time
op_amp
l_int|0x0f00
)paren
op_rshift
l_int|8
)paren
op_plus
l_int|1
comma
(paren
id|time
op_amp
l_int|0x0f
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Address Setup Time */
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x4C
comma
op_amp
id|tm
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Add. Setup T.:  %01dT          %01dT           %01dT          %01dT&bslash;n&quot;
comma
(paren
(paren
id|tm
op_amp
l_int|0xc0
)paren
op_rshift
l_int|6
)paren
op_plus
l_int|1
comma
(paren
(paren
id|tm
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|1
comma
(paren
(paren
id|tm
op_amp
l_int|0x0c
)paren
op_rshift
l_int|2
)paren
op_plus
l_int|1
comma
(paren
id|tm
op_amp
l_int|0x03
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* UltraDMA33 Extended Timing Control */
id|rc
op_assign
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x50
comma
op_amp
id|time
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;------------------UDMA-Timing-Control------------------------&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Enable Meth.:    %01d           %01d            %01d           %01d&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|0x80000000
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|time
op_amp
l_int|0x800000
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|time
op_amp
l_int|0x8000
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|time
op_amp
l_int|0x80
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Enable:         %s         %s          %s         %s&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|0x40000000
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
comma
(paren
id|time
op_amp
l_int|0x400000
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
comma
(paren
id|time
op_amp
l_int|0x4000
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
comma
(paren
id|time
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Transfer Mode: %s         %s          %s         %s&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|0x20000000
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
l_string|&quot;DMA&quot;
comma
(paren
id|time
op_amp
l_int|0x200000
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
l_string|&quot;DMA&quot;
comma
(paren
id|time
op_amp
l_int|0x2000
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
l_string|&quot;DMA&quot;
comma
(paren
id|time
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
l_string|&quot;DMA&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Cycle Time:     %01dT          %01dT           %01dT          %01dT&bslash;n&quot;
comma
(paren
(paren
id|time
op_amp
l_int|0x03000000
)paren
op_rshift
l_int|24
)paren
op_plus
l_int|2
comma
(paren
(paren
id|time
op_amp
l_int|0x030000
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|2
comma
(paren
(paren
id|time
op_amp
l_int|0x0300
)paren
op_rshift
l_int|8
)paren
op_plus
l_int|2
comma
(paren
id|time
op_amp
l_int|0x03
)paren
op_plus
l_int|2
)paren
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
id|p
suffix:semicolon
)brace
DECL|function|print_apollo_ide_config
r_static
r_char
op_star
id|print_apollo_ide_config
(paren
r_char
op_star
id|buf
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|byte
id|time
comma
id|tmp
suffix:semicolon
r_int
r_int
id|size0
comma
id|size1
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
op_amp
id|time
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Prefetch Buffer :      %s                     %s&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|128
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|time
op_amp
l_int|32
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Post Write Buffer:     %s                     %s&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|64
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|time
op_amp
l_int|16
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
multiline_comment|/* FIFO configuration */
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x43
comma
op_amp
id|time
)paren
suffix:semicolon
id|tmp
op_assign
(paren
(paren
id|time
op_amp
l_int|0x20
)paren
op_rshift
l_int|2
)paren
op_plus
(paren
(paren
id|time
op_amp
l_int|0x40
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;FIFO Conf/Chan. :      %02d                      %02d&bslash;n&quot;
comma
l_int|16
op_minus
id|tmp
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|time
op_amp
l_int|0x0F
)paren
op_rshift
l_int|2
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Threshold Prim. :      %s                     %s&bslash;n&quot;
comma
id|FIFO_str
(braket
id|tmp
)braket
comma
id|FIFO_str
(braket
id|time
op_amp
l_int|0x03
)braket
)paren
suffix:semicolon
multiline_comment|/* chipset Control3 */
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x46
comma
op_amp
id|time
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Read DMA FIFO flush:   %s                     %s&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|time
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;End Sect. FIFO flush:  %s                     %s&bslash;n&quot;
comma
(paren
id|time
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|time
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Max DRDY Pulse Width:  %s %s&bslash;n&quot;
comma
id|control3_str
(braket
(paren
id|time
op_amp
l_int|0x03
)paren
)braket
comma
(paren
id|time
op_amp
l_int|0x03
)paren
ques
c_cond
l_string|&quot;PCI clocks&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* Primary and Secondary sector sizes */
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0x60
comma
op_amp
id|size0
)paren
suffix:semicolon
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0x68
comma
op_amp
id|size1
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Bytes Per Sector:      %03d                     %03d&bslash;n&quot;
comma
id|size0
op_amp
l_int|0xfff
comma
id|size1
op_amp
l_int|0xfff
)paren
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
id|p
suffix:semicolon
)brace
DECL|function|print_apollo_chipset_control1
r_static
r_char
op_star
id|print_apollo_chipset_control1
(paren
r_char
op_star
id|buf
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|byte
id|t
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_int
r_int
id|c
suffix:semicolon
id|byte
id|l
comma
id|l_max
suffix:semicolon
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0x04
comma
op_amp
id|c
)paren
suffix:semicolon
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x44
comma
op_amp
id|t
)paren
suffix:semicolon
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x0d
comma
op_amp
id|l
)paren
suffix:semicolon
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x3f
comma
op_amp
id|l_max
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Command register = 0x%x&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Master Read  Cycle IRDY %d Wait State&bslash;n&quot;
comma
(paren
id|t
op_amp
l_int|64
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Master Write Cycle IRDY %d Wait State&bslash;n&quot;
comma
(paren
id|t
op_amp
l_int|32
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;FIFO Output Data 1/2 Clock Advance: %s&bslash;n&quot;
comma
(paren
id|t
op_amp
l_int|16
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Bus Master IDE Status Register Read Retry: %s&bslash;n&quot;
comma
(paren
id|t
op_amp
l_int|8
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Latency timer = %d (max. = %d)&bslash;n&quot;
comma
id|l
comma
id|l_max
)paren
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
id|p
suffix:semicolon
)brace
DECL|function|print_apollo_chipset_control2
r_static
r_char
op_star
id|print_apollo_chipset_control2
(paren
r_char
op_star
id|buf
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|byte
id|t
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x45
comma
op_amp
id|t
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Interrupt Steering Swap: %s&bslash;n&quot;
comma
(paren
id|t
op_amp
l_int|64
)paren
ques
c_cond
l_string|&quot;on &quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
id|p
suffix:semicolon
)brace
DECL|function|print_apollo_chipset_control3
r_static
r_char
op_star
id|print_apollo_chipset_control3
(paren
r_char
op_star
id|buf
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
r_int
id|n
)paren
(brace
multiline_comment|/*&n;&t; * at that point we can be sure that register 0x20 of the&n;&t; * chipset contains the right address...&n;&t; */
r_int
r_int
id|bibma
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|byte
id|c0
comma
id|c1
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|rc
op_assign
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x20
comma
op_amp
id|bibma
)paren
suffix:semicolon
id|bibma
op_assign
(paren
id|bibma
op_amp
l_int|0xfff0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * at that point bibma+0x2 et bibma+0xa are byte registers&n;&t; * to investigate:&n;&t; */
id|c0
op_assign
id|inb
c_func
(paren
(paren
r_int
r_int
)paren
id|bibma
op_plus
l_int|0x02
)paren
suffix:semicolon
id|c1
op_assign
id|inb
c_func
(paren
(paren
r_int
r_int
)paren
id|bibma
op_plus
l_int|0x0a
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
(brace
multiline_comment|/*p = sprintf(p,&quot;--------------------Primary IDE------------Secondary IDE-----&quot;);*/
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;both channels togth:   %s                     %s&bslash;n&quot;
comma
(paren
id|c0
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;no&quot;
suffix:colon
l_string|&quot;yes&quot;
comma
(paren
id|c1
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;no&quot;
suffix:colon
l_string|&quot;yes&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*p = sprintf(p,&quot;--------------drive0------drive1-------drive0------drive1----&quot;);*/
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;DMA enabled:    %s         %s          %s         %s&bslash;n&quot;
comma
(paren
id|c0
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
comma
(paren
id|c0
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
comma
(paren
id|c1
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
comma
(paren
id|c1
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
)brace
r_return
(paren
r_char
op_star
)paren
id|p
suffix:semicolon
)brace
DECL|function|via_get_info
r_static
r_int
id|via_get_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|addr
comma
id|off_t
id|offset
comma
r_int
id|count
)paren
(brace
multiline_comment|/*&n;&t; * print what /proc/via displays,&n;&t; * if required from DISPLAY_APOLLO_TIMINGS&n;&t; */
r_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
multiline_comment|/* Parameter of chipset : */
multiline_comment|/* Miscellaneous control 1 */
id|p
op_assign
id|print_apollo_chipset_control1
c_func
(paren
id|buffer
comma
id|bmide_dev
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous control 2 */
id|p
op_assign
id|print_apollo_chipset_control2
c_func
(paren
id|p
comma
id|bmide_dev
)paren
suffix:semicolon
multiline_comment|/* Parameters of drives: */
multiline_comment|/* Header */
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;------------------Primary IDE------------Secondary IDE-----&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
id|print_apollo_chipset_control3
c_func
(paren
id|p
comma
id|bmide_dev
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|print_apollo_ide_config
c_func
(paren
id|p
comma
id|bmide_dev
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;--------------drive0------drive1-------drive0------drive1----&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
id|print_apollo_chipset_control3
c_func
(paren
id|p
comma
id|bmide_dev
comma
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|print_apollo_drive_config
c_func
(paren
id|p
comma
id|bmide_dev
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buffer
suffix:semicolon
multiline_comment|/* hoping it is less than 4K... */
)brace
macro_line|#endif  /* defined(DISPLAY_VIA_TIMINGS) &amp;&amp; defined(CONFIG_PROC_FS) */
multiline_comment|/*&n; *  Used to set Fifo configuration via kernel command line:&n; */
DECL|variable|via_proc
id|byte
id|via_proc
op_assign
l_int|0
suffix:semicolon
DECL|variable|fifoconfig
id|byte
id|fifoconfig
op_assign
l_int|0
suffix:semicolon
DECL|variable|newfifo
r_static
id|byte
id|newfifo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Used to just intialize once Fifo configuration */
DECL|variable|done
r_static
r_int
r_int
id|done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *  Set VIA Chipset Timings for (U)DMA modes enabled.&n; *&n; *  VIA Apollo chipset has complete support for&n; *  setting up the timing parameters.&n; */
DECL|function|set_via_timings
r_static
r_void
id|set_via_timings
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|hwif-&gt;pci_dev
suffix:semicolon
id|byte
id|post
op_assign
id|hwif-&gt;channel
ques
c_cond
l_int|0x30
suffix:colon
l_int|0xc0
suffix:semicolon
id|byte
id|flush
op_assign
id|hwif-&gt;channel
ques
c_cond
l_int|0x50
suffix:colon
l_int|0xa0
suffix:semicolon
r_int
id|mask
op_assign
id|hwif-&gt;channel
ques
c_cond
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:colon
(paren
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|byte
id|via_config
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
comma
id|errors
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: VIA Bus-Master &quot;
comma
id|hwif-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * setting IDE read prefetch buffer and IDE post write buffer.&n;&t; * (This feature allows prefetched reads and post writes).&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
op_amp
id|via_config
)paren
)paren
)paren
id|errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mask
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
id|via_config
op_amp
op_complement
id|post
)paren
)paren
)paren
id|errors
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
id|via_config
op_or
id|post
)paren
)paren
)paren
id|errors
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * setting Channel read and End-of-sector FIFO flush.&n;&t; * (This feature ensures that FIFO flush is enabled:&n;&t; *  - for read DMA when interrupt asserts the given channel.&n;&t; *  - at the end of each sector for the given channel.)&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x46
comma
op_amp
id|via_config
)paren
)paren
)paren
id|errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mask
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x46
comma
id|via_config
op_amp
op_complement
id|flush
)paren
)paren
)paren
id|errors
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x46
comma
id|via_config
op_or
id|flush
)paren
)paren
)paren
id|errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;dma_base
)paren
id|printk
c_func
(paren
l_string|&quot;Config %s. No DMA Enabled&bslash;n&quot;
comma
id|errors
ques
c_cond
l_string|&quot;ERROR&quot;
suffix:colon
l_string|&quot;Success&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;(U)DMA Timing Config %s&bslash;n&quot;
comma
id|errors
ques
c_cond
l_string|&quot;ERROR&quot;
suffix:colon
l_string|&quot;Success&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Sets VIA 82cxxx FIFO configuration:&n; *  This chipsets gets a splitable fifo. This can be driven either by command&n; *  line option (eg &quot;splitfifo=2,2,3&quot; which asks this driver to switch all the &n; *  16 fifo levels to the second drive, and give it a threshold of 3 for (u)dma &n; *  triggering.&n; */
DECL|function|via_set_fifoconfig
r_static
r_int
id|via_set_fifoconfig
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
id|byte
id|fifo
suffix:semicolon
r_int
r_int
id|timings
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|hwif-&gt;pci_dev
suffix:semicolon
multiline_comment|/* read port configuration */
r_if
c_cond
(paren
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x40
comma
op_amp
id|timings
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* first read actual fifo config: */
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x43
comma
op_amp
id|fifo
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* keep 4 and 7 bit as they seem to differ between chipsets flavors... */
id|newfifo
op_assign
id|fifo
op_amp
l_int|0x90
suffix:semicolon
r_if
c_cond
(paren
id|fifoconfig
)paren
(brace
multiline_comment|/* we received a config request from kernel command line: */
id|newfifo
op_or_assign
id|fifoconfig
op_amp
l_int|0x6f
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If ever just one channel is unused, allocate all fifo levels to it&n;&t;&t; * and give it a 3/4 threshold for (u)dma transfers.&n;&t;&t; * Otherwise, share it evenly between channels:&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|timings
op_amp
l_int|3
)paren
op_eq
l_int|2
)paren
(brace
multiline_comment|/* only primary channel is  enabled&n;&t;&t;&t; * 16 buf. to prim. chan. thresh=3/4&n;&t;&t;&t; */
id|newfifo
op_or_assign
l_int|0x06
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|timings
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* only secondary channel is enabled!&n;&t;&t;&t; * 16 buffers to sec. ch. thresh=3/4&n;&t;&t;&t; */
id|newfifo
op_or_assign
l_int|0x69
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fifo evenly distributed: */
id|newfifo
op_or_assign
l_int|0x2a
suffix:semicolon
)brace
)brace
multiline_comment|/* write resulting configuration to chipset: */
r_if
c_cond
(paren
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x43
comma
id|newfifo
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* and then reread it to get the actual one */
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x43
comma
op_amp
id|newfifo
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* print a kernel report: */
id|printk
c_func
(paren
l_string|&quot;Split FIFO Configuration: %s Primary buffers, threshold = %s&bslash;n&quot;
comma
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
ques
c_cond
l_string|&quot; 0&quot;
suffix:colon
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
ques
c_cond
l_string|&quot; 8&quot;
suffix:colon
l_string|&quot;16&quot;
)paren
comma
op_logical_neg
(paren
id|newfifo
op_amp
l_int|0x0c
)paren
ques
c_cond
l_string|&quot;1&quot;
suffix:colon
(paren
op_logical_neg
(paren
id|newfifo
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;3/4&quot;
suffix:colon
(paren
id|newfifo
op_amp
l_int|0x04
)paren
ques
c_cond
l_string|&quot;1/4&quot;
suffix:colon
l_string|&quot;1/2&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                          %s Second. buffers, threshold = %s&bslash;n&quot;
comma
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
ques
c_cond
l_string|&quot;16&quot;
suffix:colon
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
ques
c_cond
l_string|&quot; 8&quot;
suffix:colon
l_string|&quot; 0&quot;
)paren
comma
op_logical_neg
(paren
id|newfifo
op_amp
l_int|0x03
)paren
ques
c_cond
l_string|&quot;1&quot;
suffix:colon
(paren
op_logical_neg
(paren
id|newfifo
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot;3/4&quot;
suffix:colon
(paren
id|newfifo
op_amp
l_int|0x01
)paren
ques
c_cond
l_string|&quot;1/4&quot;
suffix:colon
l_string|&quot;1/2&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_VIA82CXXX_TUNING
DECL|function|via82cxxx_tune_chipset
r_static
r_int
id|via82cxxx_tune_chipset
(paren
id|ide_drive_t
op_star
id|drive
comma
id|byte
id|speed
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|hwif-&gt;pci_dev
suffix:semicolon
r_int
r_int
id|dma_base
op_assign
id|hwif-&gt;dma_base
suffix:semicolon
id|byte
id|unit
op_assign
(paren
id|drive-&gt;select.b.unit
op_amp
l_int|0x01
)paren
suffix:semicolon
r_int
id|drive_number
op_assign
(paren
(paren
id|hwif-&gt;channel
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
op_plus
id|unit
)paren
suffix:semicolon
id|byte
id|ata2_pci
op_assign
l_int|0x00
suffix:semicolon
id|byte
id|ata3_pci
op_assign
l_int|0x00
suffix:semicolon
id|byte
id|timing
op_assign
l_int|0x00
suffix:semicolon
id|byte
id|ultra
op_assign
l_int|0x00
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|bus_speed
op_assign
id|ide_system_bus_speed
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|drive_number
)paren
(brace
r_case
l_int|0
suffix:colon
id|ata2_pci
op_assign
l_int|0x48
suffix:semicolon
id|ata3_pci
op_assign
l_int|0x50
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|ata2_pci
op_assign
l_int|0x49
suffix:semicolon
id|ata3_pci
op_assign
l_int|0x51
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|ata2_pci
op_assign
l_int|0x4a
suffix:semicolon
id|ata3_pci
op_assign
l_int|0x52
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|ata2_pci
op_assign
l_int|0x4b
suffix:semicolon
id|ata3_pci
op_assign
l_int|0x53
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|err
suffix:semicolon
)brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|ata2_pci
comma
op_amp
id|timing
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|ata3_pci
comma
op_amp
id|ultra
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|XFER_UDMA_4
suffix:colon
r_case
id|XFER_UDMA_3
suffix:colon
r_case
id|XFER_UDMA_2
suffix:colon
r_case
id|XFER_UDMA_1
suffix:colon
r_case
id|XFER_UDMA_0
suffix:colon
r_case
id|XFER_MW_DMA_2
suffix:colon
r_case
id|XFER_MW_DMA_1
suffix:colon
r_case
id|XFER_MW_DMA_0
suffix:colon
r_case
id|XFER_SW_DMA_2
suffix:colon
r_case
id|XFER_SW_DMA_1
suffix:colon
r_case
id|XFER_SW_DMA_0
suffix:colon
r_case
id|XFER_PIO_4
suffix:colon
r_case
id|XFER_PIO_3
suffix:colon
r_case
id|XFER_PIO_2
suffix:colon
r_case
id|XFER_PIO_1
suffix:colon
r_case
id|XFER_PIO_0
suffix:colon
r_case
id|XFER_PIO_SLOW
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|ata2_pci
comma
id|timing
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|ata3_pci
comma
id|ultra
)paren
suffix:semicolon
id|err
op_assign
id|ide_config_drive_speed
c_func
(paren
id|drive
comma
id|speed
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|config_chipset_for_dma
r_static
r_int
id|config_chipset_for_dma
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|byte
id|speed
op_assign
l_int|0x00
suffix:semicolon
r_int
id|rval
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0010
)paren
op_logical_and
(paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|udma_four
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0008
)paren
op_logical_and
(paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|udma_four
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0004
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0002
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0001
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0004
)paren
(brace
id|speed
op_assign
id|XFER_MW_DMA_2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0002
)paren
(brace
id|speed
op_assign
id|XFER_MW_DMA_1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0001
)paren
(brace
id|speed
op_assign
id|XFER_MW_DMA_0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0004
)paren
(brace
id|speed
op_assign
id|XFER_SW_DMA_2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0002
)paren
(brace
id|speed
op_assign
id|XFER_SW_DMA_1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0001
)paren
(brace
id|speed
op_assign
id|XFER_SW_DMA_0
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
(paren
r_int
)paren
id|ide_dma_off_quietly
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|via82cxxx_tune_chipset
c_func
(paren
id|drive
comma
id|speed
)paren
suffix:semicolon
id|rval
op_assign
(paren
r_int
)paren
(paren
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|11
)paren
op_amp
l_int|3
)paren
ques
c_cond
id|ide_dma_on
suffix:colon
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|8
)paren
op_amp
l_int|7
)paren
ques
c_cond
id|ide_dma_on
suffix:colon
(paren
(paren
id|id-&gt;dma_mword
op_rshift
l_int|8
)paren
op_amp
l_int|7
)paren
ques
c_cond
id|ide_dma_on
suffix:colon
(paren
(paren
id|id-&gt;dma_1word
op_rshift
l_int|8
)paren
op_amp
l_int|7
)paren
ques
c_cond
id|ide_dma_on
suffix:colon
id|ide_dma_off_quietly
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|function|config_chipset_for_pio
r_static
r_void
id|config_chipset_for_pio
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_int
r_int
id|eide_pio_timing
(braket
l_int|6
)braket
op_assign
(brace
l_int|960
comma
l_int|480
comma
l_int|240
comma
l_int|180
comma
l_int|120
comma
l_int|90
)brace
suffix:semicolon
r_int
r_int
id|xfer_pio
op_assign
id|drive-&gt;id-&gt;eide_pio_modes
suffix:semicolon
id|byte
id|timing
comma
id|speed
comma
id|pio
suffix:semicolon
id|pio
op_assign
id|ide_get_best_pio_mode
c_func
(paren
id|drive
comma
l_int|255
comma
l_int|5
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xfer_pio
OG
l_int|4
)paren
id|xfer_pio
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;id-&gt;eide_pio_iordy
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|xfer_pio
op_assign
l_int|5
suffix:semicolon
id|xfer_pio
OG
l_int|0
op_logical_and
id|drive-&gt;id-&gt;eide_pio_iordy
OG
id|eide_pio_timing
(braket
id|xfer_pio
)braket
suffix:semicolon
id|xfer_pio
op_decrement
)paren
suffix:semicolon
)brace
r_else
(brace
id|xfer_pio
op_assign
(paren
id|drive-&gt;id-&gt;eide_pio_modes
op_amp
l_int|4
)paren
ques
c_cond
l_int|0x05
suffix:colon
(paren
id|drive-&gt;id-&gt;eide_pio_modes
op_amp
l_int|2
)paren
ques
c_cond
l_int|0x04
suffix:colon
(paren
id|drive-&gt;id-&gt;eide_pio_modes
op_amp
l_int|1
)paren
ques
c_cond
l_int|0x03
suffix:colon
(paren
id|drive-&gt;id-&gt;tPIO
op_amp
l_int|2
)paren
ques
c_cond
l_int|0x02
suffix:colon
(paren
id|drive-&gt;id-&gt;tPIO
op_amp
l_int|1
)paren
ques
c_cond
l_int|0x01
suffix:colon
id|xfer_pio
suffix:semicolon
)brace
id|timing
op_assign
(paren
id|xfer_pio
op_ge
id|pio
)paren
ques
c_cond
id|xfer_pio
suffix:colon
id|pio
suffix:semicolon
r_switch
c_cond
(paren
id|timing
)paren
(brace
r_case
l_int|4
suffix:colon
id|speed
op_assign
id|XFER_PIO_4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|speed
op_assign
id|XFER_PIO_3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|speed
op_assign
id|XFER_PIO_2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|speed
op_assign
id|XFER_PIO_1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|speed
op_assign
(paren
op_logical_neg
id|drive-&gt;id-&gt;tPIO
)paren
ques
c_cond
id|XFER_PIO_0
suffix:colon
id|XFER_PIO_SLOW
suffix:semicolon
r_break
suffix:semicolon
)brace
(paren
r_void
)paren
id|via82cxxx_tune_chipset
c_func
(paren
id|drive
comma
id|speed
)paren
suffix:semicolon
)brace
DECL|function|via82cxxx_tune_drive
r_static
r_void
id|via82cxxx_tune_drive
(paren
id|ide_drive_t
op_star
id|drive
comma
id|byte
id|pio
)paren
(brace
id|byte
id|speed
suffix:semicolon
r_switch
c_cond
(paren
id|pio
)paren
(brace
r_case
l_int|4
suffix:colon
id|speed
op_assign
id|XFER_PIO_4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|speed
op_assign
id|XFER_PIO_3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|speed
op_assign
id|XFER_PIO_2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|speed
op_assign
id|XFER_PIO_1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|speed
op_assign
id|XFER_PIO_0
suffix:semicolon
r_break
suffix:semicolon
)brace
(paren
r_void
)paren
id|via82cxxx_tune_chipset
c_func
(paren
id|drive
comma
id|speed
)paren
suffix:semicolon
)brace
DECL|function|config_drive_xfer_rate
r_static
r_int
id|config_drive_xfer_rate
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|ide_dma_action_t
id|dma_func
op_assign
id|ide_dma_on
suffix:semicolon
r_if
c_cond
(paren
id|id
op_logical_and
(paren
id|id-&gt;capability
op_amp
l_int|1
)paren
op_logical_and
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|autodma
)paren
(brace
multiline_comment|/* Consult the list of known &quot;bad&quot; drives */
r_if
c_cond
(paren
id|ide_dmaproc
c_func
(paren
id|ide_dma_bad_drive
comma
id|drive
)paren
)paren
(brace
id|dma_func
op_assign
id|ide_dma_off
suffix:semicolon
r_goto
id|fast_ata_pio
suffix:semicolon
)brace
id|dma_func
op_assign
id|ide_dma_off_quietly
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x001F
)paren
(brace
multiline_comment|/* Force if Capable UltraDMA */
id|dma_func
op_assign
id|config_chipset_for_dma
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
op_logical_and
(paren
id|dma_func
op_ne
id|ide_dma_on
)paren
)paren
r_goto
id|try_dma_modes
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
(brace
id|try_dma_modes
suffix:colon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0007
)paren
op_logical_or
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0007
)paren
)paren
(brace
multiline_comment|/* Force if Capable regular DMA modes */
id|dma_func
op_assign
id|config_chipset_for_dma
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_func
op_ne
id|ide_dma_on
)paren
r_goto
id|no_dma_set
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ide_dmaproc
c_func
(paren
id|ide_dma_good_drive
comma
id|drive
)paren
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;eide_dma_time
OG
l_int|150
)paren
(brace
r_goto
id|no_dma_set
suffix:semicolon
)brace
multiline_comment|/* Consult the list of known &quot;good&quot; drives */
id|dma_func
op_assign
id|config_chipset_for_dma
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_func
op_ne
id|ide_dma_on
)paren
r_goto
id|no_dma_set
suffix:semicolon
)brace
r_else
(brace
r_goto
id|fast_ata_pio
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;capability
op_amp
l_int|8
)paren
op_logical_or
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
)paren
(brace
id|fast_ata_pio
suffix:colon
id|dma_func
op_assign
id|ide_dma_off_quietly
suffix:semicolon
id|no_dma_set
suffix:colon
id|config_chipset_for_pio
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_return
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|dmaproc
c_func
(paren
id|dma_func
comma
id|drive
)paren
suffix:semicolon
)brace
DECL|function|via82cxxx_dmaproc
r_int
id|via82cxxx_dmaproc
(paren
id|ide_dma_action_t
id|func
comma
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_switch
c_cond
(paren
id|func
)paren
(brace
r_case
id|ide_dma_check
suffix:colon
r_return
id|config_drive_xfer_rate
c_func
(paren
id|drive
)paren
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|ide_dmaproc
c_func
(paren
id|func
comma
id|drive
)paren
suffix:semicolon
multiline_comment|/* use standard DMA stuff */
)brace
macro_line|#endif /* CONFIG_VIA82CXXX_TUNING */
DECL|function|pci_init_via82cxxx
r_int
r_int
id|__init
id|pci_init_via82cxxx
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|pci_dev
op_star
id|host
suffix:semicolon
r_struct
id|pci_dev
op_star
id|isa
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|ata33
comma
id|ata66
suffix:semicolon
id|byte
id|revision
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arraysize
(paren
id|ApolloHostChipInfo
)paren
op_logical_and
op_logical_neg
id|host_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
id|host
op_assign
id|pci_find_device
(paren
id|PCI_VENDOR_ID_VIA
comma
id|ApolloHostChipInfo
(braket
id|i
)braket
dot
id|host_id
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_continue
suffix:semicolon
id|host_dev
op_assign
id|host
suffix:semicolon
id|printk
c_func
(paren
id|ApolloHostChipInfo
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|arraysize
(paren
id|ApolloISAChipInfo
)paren
op_logical_and
op_logical_neg
id|isa_dev
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ApolloISAChipInfo
(braket
id|j
)braket
dot
id|host_id
op_ne
id|ApolloHostChipInfo
(braket
id|i
)braket
dot
id|host_id
)paren
r_continue
suffix:semicolon
id|isa
op_assign
id|pci_find_device
(paren
id|PCI_VENDOR_ID_VIA
comma
id|ApolloISAChipInfo
(braket
id|j
)braket
dot
id|isa_id
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isa
)paren
r_continue
suffix:semicolon
id|isa_dev
op_assign
id|isa
suffix:semicolon
id|ata33
op_assign
l_int|1
suffix:semicolon
id|ata66
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ApolloISAChipInfo
(braket
id|j
)braket
dot
id|flags
op_amp
id|VIA_FLAG_CHECK_REV
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|isa_dev
comma
l_int|0x0d
comma
op_amp
id|revision
)paren
suffix:semicolon
id|ata33
op_assign
(paren
id|revision
op_ge
l_int|0x20
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ApolloISAChipInfo
(braket
id|j
)braket
dot
id|flags
op_amp
id|VIA_FLAG_ATA_66
)paren
(brace
id|ata33
op_assign
l_int|0
suffix:semicolon
id|ata66
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ata33
op_or
id|ata66
)paren
id|printk
c_func
(paren
l_string|&quot; Chipset Core ATA-%s&quot;
comma
id|ata66
ques
c_cond
l_string|&quot;66&quot;
suffix:colon
l_string|&quot;33&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(DISPLAY_VIA_TIMINGS) &amp;&amp; defined(CONFIG_PROC_FS)
id|via_proc
op_assign
l_int|1
suffix:semicolon
id|bmide_dev
op_assign
id|dev
suffix:semicolon
id|via_display_info
op_assign
op_amp
id|via_get_info
suffix:semicolon
macro_line|#endif /* DISPLAY_VIA_TIMINGS &amp;&amp;  CONFIG_PROC_FS*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ata66_via82cxxx
r_int
r_int
id|__init
id|ata66_via82cxxx
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
multiline_comment|/* (Jeff Garzik) FIXME!!! for MVP4 */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ide_init_via82cxxx
r_void
id|__init
id|ide_init_via82cxxx
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
id|set_via_timings
c_func
(paren
id|hwif
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_VIA82CXXX_TUNING
id|hwif-&gt;tuneproc
op_assign
op_amp
id|via82cxxx_tune_drive
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;dma_base
)paren
(brace
id|hwif-&gt;dmaproc
op_assign
op_amp
id|via82cxxx_dmaproc
suffix:semicolon
)brace
r_else
(brace
id|hwif-&gt;autodma
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;drives
(braket
l_int|0
)braket
dot
id|autotune
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;drives
(braket
l_int|1
)braket
dot
id|autotune
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_VIA82CXXX_TUNING */
)brace
multiline_comment|/*&n; *  ide_dmacapable_via82cxxx(ide_hwif_t *, unsigned long)&n; *  checks if channel &quot;channel&quot; of if hwif is dma&n; *  capable or not, according to kernel command line,&n; *  and the new fifo settings.&n; *  It calls &quot;ide_setup_dma&quot; on capable mainboards, and&n; *  bypasses the setup if not capable.&n; */
DECL|function|ide_dmacapable_via82cxxx
r_void
id|ide_dmacapable_via82cxxx
(paren
id|ide_hwif_t
op_star
id|hwif
comma
r_int
r_int
id|dmabase
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|via_set_fifoconfig
c_func
(paren
id|hwif
)paren
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * check if any fifo is available for requested port:&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|hwif-&gt;channel
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
)paren
op_logical_or
(paren
(paren
id|hwif-&gt;channel
op_eq
l_int|1
)paren
op_logical_and
(paren
(paren
id|newfifo
op_amp
l_int|0x60
)paren
op_eq
l_int|0x00
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    %s: VP_IDE Bus-Master DMA disabled (FIFO setting)&bslash;n&quot;
comma
id|hwif-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|ide_setup_dma
c_func
(paren
id|hwif
comma
id|dmabase
comma
l_int|8
)paren
suffix:semicolon
)brace
)brace
eof
