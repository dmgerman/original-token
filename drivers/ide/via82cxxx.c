multiline_comment|/*&n; * $Id: via82cxxx.c,v 2.1e 2000/10/03 10:01:00 vojtech Exp $&n; *&n; *  Copyright (c) 2000 Vojtech Pavlik&n; *&n; *  Based on the work of:&n; *&t;Michel Aubry&n; *&t;Jeff Garzik&n; *&t;Andre Hedrick&n; *&n; *  Sponsored by SuSE&n; */
multiline_comment|/*&n; * VIA vt82c586 IDE driver for Linux. Supports&n; *&n; *   vt82c586, vt82c586a, vt82c586b, vt82c596a, vt82c596b, vt82c686a, vt8231&n; *&n; * southbridges, which can be found in&n; *&n; *  VIA Apollo VP, VPX, VPX/97, VP2, VP2/97, VP3, MVP3, MVP4&n; *  VIA Apollo Pro, Pro Plus, Pro 133, Pro 133A, ProMedia 601, ProSavage 605&n; *  VIA Apollo KX133, KT133&n; *  AMD-640, AMD-750 IronGate&n; *&n; * chipsets. Supports PIO 0-5, MWDMA 0-2, SWDMA 0-2 and&n; * UDMA 0-5 (includes UDMA33, 66 and 100) modes. UDMA100 isn&squot;t possible&n; * on any of the supported chipsets yet.&n; *&n; * UDMA66 and higher modes are autodetected only in case the BIOS has enabled them.&n; * To force UDMA66, use &squot;ide0=ata66&squot; or &squot;ide1=ata66&squot; on the kernel command line.&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Should you need to contact me, the author, you can do so either by&n; * e-mail - mail your message to &lt;vojtech@suse.cz&gt;, or by paper mail:&n; * Vojtech Pavlik, Ucitelska 1576, Prague 8, 182 00 Czech Republic&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;ide_modes.h&quot;
DECL|macro|VIA_BM_BASE
mdefine_line|#define VIA_BM_BASE&t;&t;0x20
DECL|macro|VIA_IDE_ENABLE
mdefine_line|#define VIA_IDE_ENABLE&t;&t;0x40
DECL|macro|VIA_IDE_CONFIG
mdefine_line|#define VIA_IDE_CONFIG&t;&t;0x41
DECL|macro|VIA_FIFO_CONFIG
mdefine_line|#define VIA_FIFO_CONFIG&t;&t;0x43
DECL|macro|VIA_MISC_1
mdefine_line|#define VIA_MISC_1&t;&t;0x44
DECL|macro|VIA_MISC_2
mdefine_line|#define VIA_MISC_2&t;&t;0x45
DECL|macro|VIA_MISC_3
mdefine_line|#define VIA_MISC_3&t;&t;0x46
DECL|macro|VIA_DRIVE_TIMING
mdefine_line|#define VIA_DRIVE_TIMING&t;0x48
DECL|macro|VIA_ADDRESS_SETUP
mdefine_line|#define VIA_ADDRESS_SETUP&t;0x4c
DECL|macro|VIA_UDMA_TIMING
mdefine_line|#define VIA_UDMA_TIMING&t;&t;0x50
DECL|macro|VIA_PRI_SECTOR_SIZE
mdefine_line|#define VIA_PRI_SECTOR_SIZE&t;0x60
DECL|macro|VIA_SEC_SECTOR_SIZE
mdefine_line|#define VIA_SEC_SECTOR_SIZE&t;0x68
multiline_comment|/*&n; * VIA SouthBridge chips.&n; */
r_static
r_const
r_struct
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|speed
r_int
r_char
id|speed
suffix:semicolon
DECL|variable|via_isa_bridges
)brace
id|via_isa_bridges
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;vt8231&quot;
comma
id|PCI_DEVICE_ID_VIA_8231
comma
id|XFER_UDMA_4
)brace
comma
(brace
l_string|&quot;vt82c686a&quot;
comma
id|PCI_DEVICE_ID_VIA_82C686
comma
id|XFER_UDMA_4
)brace
comma
(brace
l_string|&quot;vt82c596b&quot;
comma
id|PCI_DEVICE_ID_VIA_82C596
comma
id|XFER_UDMA_4
)brace
comma
(brace
l_string|&quot;vt82c596a&quot;
comma
id|PCI_DEVICE_ID_VIA_82C596
comma
id|XFER_UDMA_2
)brace
comma
(brace
l_string|&quot;vt82c586b&quot;
comma
id|PCI_DEVICE_ID_VIA_82C586_0
comma
id|XFER_UDMA_2
)brace
comma
(brace
l_string|&quot;vt82c586a&quot;
comma
id|PCI_DEVICE_ID_VIA_82C586_0
comma
id|XFER_UDMA_2
)brace
comma
(brace
l_string|&quot;vt82c586&quot;
comma
id|PCI_DEVICE_ID_VIA_82C586_0
comma
id|XFER_MW_DMA_2
)brace
comma
(brace
l_string|&quot;Unknown SouthBridge&quot;
comma
l_int|0
comma
id|XFER_UDMA_2
)brace
comma
)brace
suffix:semicolon
DECL|variable|via_config
r_static
r_int
r_char
id|via_config
suffix:semicolon
DECL|variable|via_enabled
r_static
r_int
r_char
id|via_enabled
suffix:semicolon
DECL|variable|via_ata66
r_static
r_int
r_int
id|via_ata66
suffix:semicolon
multiline_comment|/*&n; * PIO 0-5, MWDMA 0-2 and UDMA 0-5 timings (in nanoseconds).&n; * These were taken from ATA/ATAPI-6 standard, rev 0a, except&n; * for PIO 5, which is a nonstandard extension.&n; *&n; * Dilemma: 8-bit (register) PIO accesses need more relaxed timing.&n; * Hopefully the chipset is taking care of that. If it doesn&squot;t&n; * do so, define VIA_USE_8_BIT_TIMING to see if it helps.&n; */
macro_line|#ifndef XFER_PIO_5
DECL|macro|XFER_PIO_5
mdefine_line|#define XFER_PIO_5&t;&t;0x0d
macro_line|#endif
r_static
r_const
r_struct
(brace
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|setup
r_int
id|setup
suffix:semicolon
multiline_comment|/* t1 */
DECL|member|active
r_int
id|active
suffix:semicolon
multiline_comment|/* t2  or tD */
DECL|member|recover
r_int
id|recover
suffix:semicolon
multiline_comment|/* t2i or tK */
DECL|member|cycle
r_int
id|cycle
suffix:semicolon
multiline_comment|/* t0 */
DECL|member|udma
r_int
id|udma
suffix:semicolon
multiline_comment|/* t2CYCTYP/2 */
DECL|variable|via_timing
)brace
id|via_timing
(braket
)braket
op_assign
(brace
(brace
id|XFER_UDMA_5
comma
l_string|&quot;UDMA5&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|20
)brace
comma
(brace
id|XFER_UDMA_4
comma
l_string|&quot;UDMA4&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|30
)brace
comma
(brace
id|XFER_UDMA_3
comma
l_string|&quot;UDMA3&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|45
)brace
comma
(brace
id|XFER_UDMA_2
comma
l_string|&quot;UDMA2&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|60
)brace
comma
(brace
id|XFER_UDMA_1
comma
l_string|&quot;UDMA1&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|80
)brace
comma
(brace
id|XFER_UDMA_0
comma
l_string|&quot;UDMA0&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|120
)brace
comma
(brace
id|XFER_MW_DMA_2
comma
l_string|&quot;MDMA2&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|0
)brace
comma
(brace
id|XFER_MW_DMA_1
comma
l_string|&quot;MDMA1&quot;
comma
l_int|45
comma
l_int|80
comma
l_int|50
comma
l_int|150
comma
l_int|0
)brace
comma
(brace
id|XFER_MW_DMA_0
comma
l_string|&quot;MDMA0&quot;
comma
l_int|60
comma
l_int|215
comma
l_int|215
comma
l_int|480
comma
l_int|0
)brace
comma
(brace
id|XFER_SW_DMA_2
comma
l_string|&quot;SDMA2&quot;
comma
l_int|60
comma
l_int|120
comma
l_int|120
comma
l_int|240
comma
l_int|0
)brace
comma
(brace
id|XFER_SW_DMA_1
comma
l_string|&quot;SDMA1&quot;
comma
l_int|90
comma
l_int|240
comma
l_int|240
comma
l_int|480
comma
l_int|0
)brace
comma
(brace
id|XFER_SW_DMA_0
comma
l_string|&quot;SDMA0&quot;
comma
l_int|120
comma
l_int|480
comma
l_int|480
comma
l_int|960
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_5
comma
l_string|&quot;PIO5&quot;
comma
l_int|20
comma
l_int|50
comma
l_int|30
comma
l_int|100
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_4
comma
l_string|&quot;PIO4&quot;
comma
l_int|25
comma
l_int|70
comma
l_int|25
comma
l_int|120
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_3
comma
l_string|&quot;PIO3&quot;
comma
l_int|30
comma
l_int|80
comma
l_int|70
comma
l_int|180
comma
l_int|0
)brace
comma
macro_line|#ifdef VIA_USE_8_BIT_TIMING
(brace
id|XFER_PIO_2
comma
l_string|&quot;PIO2&quot;
comma
l_int|30
comma
l_int|290
comma
l_int|60
comma
l_int|330
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_1
comma
l_string|&quot;PIO1&quot;
comma
l_int|50
comma
l_int|290
comma
l_int|100
comma
l_int|383
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_0
comma
l_string|&quot;PIO0&quot;
comma
l_int|70
comma
l_int|290
comma
l_int|300
comma
l_int|600
comma
l_int|0
)brace
comma
macro_line|#else
(brace
id|XFER_PIO_2
comma
l_string|&quot;PIO2&quot;
comma
l_int|30
comma
l_int|100
comma
l_int|90
comma
l_int|240
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_1
comma
l_string|&quot;PIO1&quot;
comma
l_int|50
comma
l_int|125
comma
l_int|100
comma
l_int|383
comma
l_int|0
)brace
comma
(brace
id|XFER_PIO_0
comma
l_string|&quot;PIO0&quot;
comma
l_int|70
comma
l_int|165
comma
l_int|150
comma
l_int|600
comma
l_int|0
)brace
comma
macro_line|#endif
(brace
id|XFER_PIO_SLOW
comma
l_string|&quot;SLOW&quot;
comma
l_int|120
comma
l_int|290
comma
l_int|240
comma
l_int|960
comma
l_int|0
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * VIA /proc entry.&n; */
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
DECL|variable|via_proc
r_int
id|via_proc
op_assign
l_int|0
suffix:semicolon
DECL|variable|bmide_dev
DECL|variable|isa_dev
r_static
r_struct
id|pci_dev
op_star
id|bmide_dev
comma
op_star
id|isa_dev
suffix:semicolon
r_extern
r_int
(paren
op_star
id|via_display_info
)paren
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* ide-proc.c */
DECL|variable|via_fifo
r_static
r_char
op_star
id|via_fifo
(braket
)braket
op_assign
(brace
l_string|&quot; 1 &quot;
comma
l_string|&quot;3/4&quot;
comma
l_string|&quot;1/2&quot;
comma
l_string|&quot;1/4&quot;
)brace
suffix:semicolon
DECL|variable|via_control3
r_static
r_char
op_star
id|via_control3
(braket
)braket
op_assign
(brace
l_string|&quot;No limit&quot;
comma
l_string|&quot;64&quot;
comma
l_string|&quot;128&quot;
comma
l_string|&quot;192&quot;
)brace
suffix:semicolon
DECL|macro|via_print
mdefine_line|#define via_print(format, arg...) p += sprintf(p, format &quot;&bslash;n&quot; , ## arg)
DECL|macro|via_print_drive
mdefine_line|#define via_print_drive(name, format, arg...)&bslash;&n;&t;p += sprintf(p, name); for (i = 0; i &lt; 4; i++) p += sprintf(p, format, ## arg); p += sprintf(p, &quot;&bslash;n&quot;);
DECL|function|via_get_info
r_static
r_int
id|via_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|addr
comma
id|off_t
id|offset
comma
r_int
id|count
)paren
(brace
r_int
id|pci_clock
comma
id|speed
(braket
l_int|4
)braket
comma
id|cycle
(braket
l_int|4
)braket
comma
id|setup
(braket
l_int|4
)braket
comma
id|active
(braket
l_int|4
)braket
comma
id|recover
(braket
l_int|4
)braket
comma
id|umul
(braket
l_int|4
)braket
comma
id|uen
(braket
l_int|4
)braket
comma
id|udma
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|bmide_dev
suffix:semicolon
r_int
r_int
id|v
comma
id|u
comma
id|i
comma
id|base
suffix:semicolon
r_int
r_int
id|c
comma
id|size0
comma
id|size1
suffix:semicolon
r_int
r_char
id|t
comma
id|c0
comma
id|c1
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;----------VIA BusMastering IDE Configuration----------------&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Driver Version:                     2.1e&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|isa_dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|t
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;South Bridge:                       VIA %s rev %#x&quot;
comma
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|name
comma
id|t
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|c
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Command register:                   %#x&quot;
comma
id|c
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|t
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Latency timer:                      %d&quot;
comma
id|t
)paren
suffix:semicolon
id|pci_clock
op_assign
id|system_bus_clock
c_func
(paren
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;PCI clock:                          %dMHz&quot;
comma
id|pci_clock
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_MISC_1
comma
op_amp
id|t
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Master Read  Cycle IRDY:            %dws&quot;
comma
(paren
id|t
op_amp
l_int|64
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Master Write Cycle IRDY:            %dws&quot;
comma
(paren
id|t
op_amp
l_int|32
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;FIFO Output Data 1/2 Clock Advance: %s&quot;
comma
(paren
id|t
op_amp
l_int|16
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;BM IDE Status Register Read Retry:  %s&quot;
comma
(paren
id|t
op_amp
l_int|8
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_MISC_3
comma
op_amp
id|t
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Max DRDY Pulse Width:               %s%s&quot;
comma
id|via_control3
(braket
(paren
id|t
op_amp
l_int|0x03
)paren
)braket
comma
(paren
id|t
op_amp
l_int|0x03
)paren
ques
c_cond
l_string|&quot;PCI clocks&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;-----------------------Primary IDE-------Secondary IDE------&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Read DMA FIFO flush:   %10s%20s&quot;
comma
(paren
id|t
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|t
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;End Sect. FIFO flush:  %10s%20s&quot;
comma
(paren
id|t
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|t
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_IDE_CONFIG
comma
op_amp
id|t
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Prefetch Buffer:       %10s%20s&quot;
comma
(paren
id|t
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|t
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Post Write Buffer:     %10s%20s&quot;
comma
(paren
id|t
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
(paren
id|t
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_FIFO_CONFIG
comma
op_amp
id|t
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;FIFO size:             %10d%20d&quot;
comma
l_int|16
op_minus
(paren
(paren
(paren
id|t
op_rshift
l_int|5
)paren
op_amp
l_int|1
)paren
op_plus
(paren
(paren
id|t
op_rshift
l_int|6
)paren
op_amp
l_int|1
)paren
)paren
op_star
l_int|8
comma
(paren
(paren
(paren
id|t
op_rshift
l_int|5
)paren
op_amp
l_int|1
)paren
op_plus
(paren
(paren
id|t
op_rshift
l_int|6
)paren
op_amp
l_int|1
)paren
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Threshold Prim.:       %10s%20s&quot;
comma
id|via_fifo
(braket
(paren
id|t
op_rshift
l_int|2
)paren
op_amp
l_int|3
)braket
comma
id|via_fifo
(braket
id|t
op_amp
l_int|3
)braket
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|VIA_PRI_SECTOR_SIZE
comma
op_amp
id|size0
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|VIA_SEC_SECTOR_SIZE
comma
op_amp
id|size1
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Bytes Per Sector:      %10d%20d&quot;
comma
id|size0
op_amp
l_int|0xfff
comma
id|size1
op_amp
l_int|0xfff
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|VIA_BM_BASE
comma
op_amp
id|base
)paren
suffix:semicolon
id|base
op_assign
(paren
id|base
op_amp
l_int|0xfff0
)paren
suffix:semicolon
id|c0
op_assign
id|inb
c_func
(paren
(paren
r_int
r_int
)paren
id|base
op_plus
l_int|0x02
)paren
suffix:semicolon
id|c1
op_assign
id|inb
c_func
(paren
(paren
r_int
r_int
)paren
id|base
op_plus
l_int|0x0a
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;Both channels togth:   %10s%20s&quot;
comma
(paren
id|c0
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;no&quot;
suffix:colon
l_string|&quot;yes&quot;
comma
(paren
id|c1
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;no&quot;
suffix:colon
l_string|&quot;yes&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;-------------------drive0----drive1----drive2----drive3-----&quot;
)paren
suffix:semicolon
id|via_print
c_func
(paren
l_string|&quot;BMDMA enabled: %10s%10s%10s%10s&quot;
comma
(paren
id|c0
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
(paren
id|c0
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
(paren
id|c1
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
(paren
id|c1
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_ADDRESS_SETUP
comma
op_amp
id|t
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|VIA_DRIVE_TIMING
comma
op_amp
id|v
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|VIA_UDMA_TIMING
comma
op_amp
id|u
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|setup
(braket
id|i
)braket
op_assign
(paren
(paren
id|t
op_rshift
(paren
(paren
l_int|3
op_minus
id|i
)paren
op_lshift
l_int|1
)paren
)paren
op_amp
l_int|0x3
)paren
op_plus
l_int|1
suffix:semicolon
id|active
(braket
id|i
)braket
op_assign
(paren
(paren
id|v
op_rshift
(paren
(paren
(paren
l_int|3
op_minus
id|i
)paren
op_lshift
l_int|3
)paren
op_plus
l_int|4
)paren
)paren
op_amp
l_int|0xf
)paren
op_plus
l_int|1
suffix:semicolon
id|recover
(braket
id|i
)braket
op_assign
(paren
(paren
id|v
op_rshift
(paren
(paren
l_int|3
op_minus
id|i
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xf
)paren
op_plus
l_int|1
suffix:semicolon
id|udma
(braket
id|i
)braket
op_assign
(paren
(paren
id|u
op_rshift
(paren
(paren
l_int|3
op_minus
id|i
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0x7
)paren
op_plus
l_int|2
suffix:semicolon
id|umul
(braket
id|i
)braket
op_assign
(paren
(paren
id|u
op_rshift
(paren
(paren
(paren
l_int|3
op_minus
id|i
)paren
op_amp
l_int|2
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0x8
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|uen
(braket
id|i
)braket
op_assign
(paren
(paren
id|u
op_rshift
(paren
(paren
l_int|3
op_minus
id|i
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0x20
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|speed
(braket
id|i
)braket
op_assign
id|uen
(braket
id|i
)braket
ques
c_cond
l_int|20
op_star
id|pci_clock
op_star
id|umul
(braket
id|i
)braket
op_div
id|udma
(braket
id|i
)braket
suffix:colon
l_int|20
op_star
id|pci_clock
op_div
(paren
id|active
(braket
id|i
)braket
op_plus
id|recover
(braket
id|i
)braket
)paren
suffix:semicolon
id|cycle
(braket
id|i
)braket
op_assign
id|uen
(braket
id|i
)braket
ques
c_cond
l_int|1000
op_div
(paren
id|pci_clock
op_star
id|umul
(braket
id|i
)braket
)paren
op_star
id|udma
(braket
id|i
)braket
suffix:colon
l_int|1000
op_div
id|pci_clock
op_star
(paren
id|active
(braket
id|i
)braket
op_plus
id|recover
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|via_print_drive
c_func
(paren
l_string|&quot;Transfer Mode: &quot;
comma
l_string|&quot;%10s&quot;
comma
id|uen
(braket
id|i
)braket
ques
c_cond
l_string|&quot;UDMA&quot;
suffix:colon
l_string|&quot;DMA/PIO&quot;
)paren
suffix:semicolon
id|via_print_drive
c_func
(paren
l_string|&quot;Address Setup: &quot;
comma
l_string|&quot;%8dns&quot;
comma
(paren
l_int|1000
op_div
id|pci_clock
)paren
op_star
id|setup
(braket
id|i
)braket
)paren
suffix:semicolon
id|via_print_drive
c_func
(paren
l_string|&quot;Active Pulse:  &quot;
comma
l_string|&quot;%8dns&quot;
comma
(paren
l_int|1000
op_div
id|pci_clock
)paren
op_star
id|active
(braket
id|i
)braket
)paren
suffix:semicolon
id|via_print_drive
c_func
(paren
l_string|&quot;Recovery Time: &quot;
comma
l_string|&quot;%8dns&quot;
comma
(paren
l_int|1000
op_div
id|pci_clock
)paren
op_star
id|recover
(braket
id|i
)braket
)paren
suffix:semicolon
id|via_print_drive
c_func
(paren
l_string|&quot;Cycle Time:    &quot;
comma
l_string|&quot;%8dns&quot;
comma
id|cycle
(braket
id|i
)braket
)paren
suffix:semicolon
id|via_print_drive
c_func
(paren
l_string|&quot;Transfer Rate: &quot;
comma
l_string|&quot;%4d.%dMB/s&quot;
comma
id|speed
(braket
id|i
)braket
op_div
l_int|10
comma
id|speed
(braket
id|i
)braket
op_mod
l_int|10
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buffer
suffix:semicolon
multiline_comment|/* hoping it is less than 4K... */
)brace
macro_line|#endif
DECL|macro|FIT
mdefine_line|#define FIT(v,min,max) ((v)&gt;(max)?(max):((v)&lt;(min)?(min):(v)))
DECL|macro|ENOUGH
mdefine_line|#define ENOUGH(v,un) (((v)-1)/(un)+1)
macro_line|#ifdef DEBUG
DECL|macro|via_write_config_byte
mdefine_line|#define via_write_config_byte(dev,number,value) do {&bslash;&n;&t;&t;printk(KERN_DEBUG &quot;VP_IDE: Setting register %#x to %#x&bslash;n&quot;, number, value);&bslash;&n;&t;&t;pci_write_config_byte(dev,number,value); } while (0)
macro_line|#else
DECL|macro|via_write_config_byte
mdefine_line|#define via_write_config_byte&t;pci_write_config_byte
macro_line|#endif
DECL|function|via_set_speed
r_static
r_int
id|via_set_speed
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|byte
id|speed
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|pci_dev
suffix:semicolon
r_int
id|i
comma
id|T
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|t
comma
id|setup
comma
id|active
comma
id|recover
comma
id|cycle
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;dn
OG
l_int|3
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|T
op_assign
l_int|1000
op_div
id|system_bus_clock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
)paren
id|speed
op_assign
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|via_timing
(braket
id|i
)braket
dot
id|mode
op_logical_and
id|via_timing
(braket
id|i
)braket
dot
id|mode
op_ne
id|speed
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;VP_IDE: Setting drive %d to %s&bslash;n&quot;
comma
id|drive-&gt;dn
comma
id|via_timing
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
macro_line|#endif
id|setup
op_assign
id|ENOUGH
c_func
(paren
id|via_timing
(braket
id|i
)braket
dot
id|setup
comma
id|T
)paren
suffix:semicolon
id|active
op_assign
id|ENOUGH
c_func
(paren
id|via_timing
(braket
id|i
)braket
dot
id|active
comma
id|T
)paren
suffix:semicolon
id|recover
op_assign
id|ENOUGH
c_func
(paren
id|via_timing
(braket
id|i
)braket
dot
id|recover
comma
id|T
)paren
suffix:semicolon
id|cycle
op_assign
id|ENOUGH
c_func
(paren
id|via_timing
(braket
id|i
)braket
dot
id|cycle
comma
id|T
)paren
suffix:semicolon
r_if
c_cond
(paren
id|active
op_plus
id|recover
OL
id|cycle
)paren
(brace
id|active
op_add_assign
(paren
id|cycle
op_minus
(paren
id|active
op_plus
id|recover
)paren
)paren
op_div
l_int|2
suffix:semicolon
id|recover
op_assign
id|cycle
op_minus
id|active
suffix:semicolon
)brace
multiline_comment|/*&n; * PIO address setup&n; */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_ADDRESS_SETUP
comma
op_amp
id|t
)paren
suffix:semicolon
id|t
op_assign
(paren
id|t
op_amp
op_complement
(paren
l_int|3
op_lshift
(paren
(paren
l_int|3
op_minus
id|drive-&gt;dn
)paren
op_lshift
l_int|1
)paren
)paren
)paren
op_or
(paren
id|FIT
c_func
(paren
id|setup
op_minus
l_int|1
comma
l_int|0
comma
l_int|3
)paren
op_lshift
(paren
(paren
l_int|3
op_minus
id|drive-&gt;dn
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|via_write_config_byte
c_func
(paren
id|dev
comma
id|VIA_ADDRESS_SETUP
comma
id|t
)paren
suffix:semicolon
multiline_comment|/*&n; * PIO active &amp; recover&n; */
id|via_write_config_byte
c_func
(paren
id|dev
comma
id|VIA_DRIVE_TIMING
op_plus
(paren
l_int|3
op_minus
id|drive-&gt;dn
)paren
comma
(paren
id|FIT
c_func
(paren
id|active
op_minus
l_int|1
comma
l_int|0
comma
l_int|0xf
)paren
op_lshift
l_int|4
)paren
op_or
id|FIT
c_func
(paren
id|recover
op_minus
l_int|1
comma
l_int|0
comma
l_int|0xf
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * UDMA cycle&n; */
r_switch
c_cond
(paren
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
)paren
(brace
r_case
id|XFER_UDMA_2
suffix:colon
id|t
op_assign
id|via_timing
(braket
id|i
)braket
dot
id|udma
ques
c_cond
(paren
l_int|0xe0
op_or
(paren
id|FIT
c_func
(paren
id|ENOUGH
c_func
(paren
id|via_timing
(braket
id|i
)braket
dot
id|udma
comma
id|T
)paren
comma
l_int|2
comma
l_int|5
)paren
op_minus
l_int|2
)paren
)paren
suffix:colon
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XFER_UDMA_4
suffix:colon
id|t
op_assign
id|via_timing
(braket
id|i
)braket
dot
id|udma
ques
c_cond
(paren
l_int|0xe8
op_or
(paren
id|FIT
c_func
(paren
id|ENOUGH
c_func
(paren
id|via_timing
(braket
id|i
)braket
dot
id|udma
comma
id|T
op_div
l_int|2
)paren
comma
l_int|2
comma
l_int|9
)paren
op_minus
l_int|2
)paren
)paren
suffix:colon
l_int|0x0f
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
op_ne
id|XFER_MW_DMA_2
)paren
id|via_write_config_byte
c_func
(paren
id|dev
comma
id|VIA_UDMA_TIMING
op_plus
(paren
l_int|3
op_minus
id|drive-&gt;dn
)paren
comma
id|t
)paren
suffix:semicolon
multiline_comment|/*&n; * Drive init&n; */
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;init_speed
)paren
id|drive-&gt;init_speed
op_assign
id|speed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ide_config_drive_speed
c_func
(paren
id|drive
comma
id|speed
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|drive-&gt;current_speed
op_assign
id|speed
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|config_chipset_for_pio
r_static
r_void
id|config_chipset_for_pio
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_int
id|eide_pio_timing
(braket
)braket
op_assign
(brace
l_int|600
comma
l_int|383
comma
l_int|240
comma
l_int|180
comma
l_int|120
comma
l_int|100
)brace
suffix:semicolon
r_int
r_char
id|pio
comma
id|ide_pio
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;id-&gt;eide_pio_iordy
OG
l_int|0
)paren
(brace
multiline_comment|/* Has timing table */
r_for
c_loop
(paren
id|pio
op_assign
l_int|5
suffix:semicolon
id|pio
op_ge
l_int|0
suffix:semicolon
id|pio
op_decrement
)paren
r_if
c_cond
(paren
id|drive-&gt;id-&gt;eide_pio_iordy
op_le
id|eide_pio_timing
(braket
id|pio
)braket
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No timing table -&gt; use mode capabilities */
id|pio
op_assign
(paren
id|drive-&gt;id-&gt;eide_pio_modes
op_amp
l_int|4
)paren
ques
c_cond
l_int|5
suffix:colon
(paren
id|drive-&gt;id-&gt;eide_pio_modes
op_amp
l_int|2
)paren
ques
c_cond
l_int|4
suffix:colon
(paren
id|drive-&gt;id-&gt;eide_pio_modes
op_amp
l_int|1
)paren
ques
c_cond
l_int|3
suffix:colon
(paren
id|drive-&gt;id-&gt;tPIO
op_eq
l_int|2
)paren
ques
c_cond
l_int|2
suffix:colon
(paren
id|drive-&gt;id-&gt;tPIO
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
id|ide_pio
op_assign
id|ide_get_best_pio_mode
c_func
(paren
id|drive
comma
l_int|255
comma
l_int|5
comma
l_int|NULL
)paren
suffix:semicolon
id|pio
op_assign
(paren
id|pio
op_ge
id|ide_pio
)paren
ques
c_cond
id|pio
suffix:colon
id|ide_pio
suffix:semicolon
multiline_comment|/* Phew. What about the blacklist? */
r_if
c_cond
(paren
op_logical_neg
id|pio
)paren
id|pio
op_assign
(paren
op_logical_neg
id|drive-&gt;id-&gt;tPIO
)paren
ques
c_cond
id|XFER_PIO_0
suffix:colon
id|XFER_PIO_SLOW
suffix:semicolon
r_else
id|pio
op_add_assign
id|XFER_PIO_0
suffix:semicolon
multiline_comment|/* Fixup because of broken ide-probe.c */
id|drive-&gt;dn
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|channel
op_star
l_int|2
op_plus
(paren
id|drive-&gt;select.b.unit
op_amp
l_int|1
)paren
suffix:semicolon
id|via_set_speed
c_func
(paren
id|drive
comma
id|pio
)paren
suffix:semicolon
)brace
DECL|function|via82cxxx_tune_drive
r_static
r_void
id|via82cxxx_tune_drive
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|byte
id|pio
)paren
(brace
r_if
c_cond
(paren
id|pio
op_eq
l_int|255
)paren
(brace
id|config_chipset_for_pio
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pio
OG
l_int|5
)paren
id|pio
op_assign
l_int|5
suffix:semicolon
id|via_set_speed
c_func
(paren
id|drive
comma
id|XFER_PIO_0
op_plus
id|pio
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA
DECL|function|config_chipset_for_dma
r_static
r_int
id|config_chipset_for_dma
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
r_int
r_char
id|ultra66
op_assign
id|eighty_ninty_three
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
r_char
id|speed
op_assign
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0010
)paren
op_logical_and
id|ultra66
)paren
ques
c_cond
id|XFER_UDMA_4
suffix:colon
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0008
)paren
op_logical_and
id|ultra66
)paren
ques
c_cond
id|XFER_UDMA_3
suffix:colon
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0004
)paren
ques
c_cond
id|XFER_UDMA_2
suffix:colon
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0002
)paren
ques
c_cond
id|XFER_UDMA_1
suffix:colon
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0001
)paren
ques
c_cond
id|XFER_UDMA_0
suffix:colon
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0004
)paren
ques
c_cond
id|XFER_MW_DMA_2
suffix:colon
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0002
)paren
ques
c_cond
id|XFER_MW_DMA_1
suffix:colon
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0001
)paren
ques
c_cond
id|XFER_MW_DMA_0
suffix:colon
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0004
)paren
ques
c_cond
id|XFER_SW_DMA_2
suffix:colon
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0002
)paren
ques
c_cond
id|XFER_SW_DMA_1
suffix:colon
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0001
)paren
ques
c_cond
id|XFER_SW_DMA_0
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|speed
)paren
r_return
(paren
r_int
)paren
id|ide_dma_off_quietly
suffix:semicolon
id|via_set_speed
c_func
(paren
id|drive
comma
id|speed
)paren
suffix:semicolon
r_return
(paren
r_int
)paren
id|ide_dma_on
suffix:semicolon
)brace
multiline_comment|/*&n; * Almost a library function.&n; */
DECL|function|config_drive_xfer_rate
r_static
r_int
id|config_drive_xfer_rate
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|ide_dma_action_t
id|dma_func
op_assign
id|ide_dma_on
suffix:semicolon
r_if
c_cond
(paren
id|id
op_logical_and
(paren
id|id-&gt;capability
op_amp
l_int|1
)paren
op_logical_and
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|autodma
)paren
(brace
multiline_comment|/* Consult the list of known &quot;bad&quot; drives */
r_if
c_cond
(paren
id|ide_dmaproc
c_func
(paren
id|ide_dma_bad_drive
comma
id|drive
)paren
)paren
(brace
id|dma_func
op_assign
id|ide_dma_off
suffix:semicolon
r_goto
id|fast_ata_pio
suffix:semicolon
)brace
id|dma_func
op_assign
id|ide_dma_off_quietly
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x002F
)paren
(brace
multiline_comment|/* Force if Capable UltraDMA */
id|dma_func
op_assign
id|config_chipset_for_dma
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
op_logical_and
(paren
id|dma_func
op_ne
id|ide_dma_on
)paren
)paren
r_goto
id|try_dma_modes
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
(brace
id|try_dma_modes
suffix:colon
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0007
)paren
(brace
multiline_comment|/* Force if Capable regular DMA modes */
id|dma_func
op_assign
id|config_chipset_for_dma
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_func
op_ne
id|ide_dma_on
)paren
r_goto
id|no_dma_set
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ide_dmaproc
c_func
(paren
id|ide_dma_good_drive
comma
id|drive
)paren
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;eide_dma_time
OG
l_int|150
)paren
(brace
r_goto
id|no_dma_set
suffix:semicolon
)brace
multiline_comment|/* Consult the list of known &quot;good&quot; drives */
id|dma_func
op_assign
id|config_chipset_for_dma
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_func
op_ne
id|ide_dma_on
)paren
r_goto
id|no_dma_set
suffix:semicolon
)brace
r_else
(brace
r_goto
id|fast_ata_pio
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;capability
op_amp
l_int|8
)paren
op_logical_or
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
)paren
(brace
id|fast_ata_pio
suffix:colon
id|dma_func
op_assign
id|ide_dma_off_quietly
suffix:semicolon
id|no_dma_set
suffix:colon
id|config_chipset_for_pio
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_return
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|dmaproc
c_func
(paren
id|dma_func
comma
id|drive
)paren
suffix:semicolon
)brace
DECL|function|via82cxxx_dmaproc
r_int
id|via82cxxx_dmaproc
c_func
(paren
id|ide_dma_action_t
id|func
comma
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_if
c_cond
(paren
id|func
op_eq
id|ide_dma_check
)paren
r_return
id|config_drive_xfer_rate
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|ide_dmaproc
c_func
(paren
id|func
comma
id|drive
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_BLK_DEV_IDEDMA */
DECL|function|pci_init_via82cxxx
r_int
r_int
id|__init
id|pci_init_via82cxxx
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|pci_dev
op_star
id|isa
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
id|f
comma
id|t
comma
id|m
suffix:semicolon
r_int
r_int
id|u
comma
id|i
suffix:semicolon
multiline_comment|/*&n; * Find ISA bridge to see how good the IDE is.&n; */
r_for
c_loop
(paren
id|via_config
op_assign
l_int|0
suffix:semicolon
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|id
suffix:semicolon
id|via_config
op_increment
)paren
r_if
c_cond
(paren
(paren
id|isa
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_VIA
comma
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|id
comma
l_int|NULL
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/*&n; * Read revision.&n; */
r_if
c_cond
(paren
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|id
op_eq
id|PCI_DEVICE_ID_VIA_82C586_0
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|isa
comma
id|PCI_REVISION_ID
comma
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
OL
l_int|0x30
)paren
id|via_config
op_increment
suffix:semicolon
multiline_comment|/* vt82c586a */
r_if
c_cond
(paren
id|t
OL
l_int|0x20
)paren
id|via_config
op_increment
suffix:semicolon
multiline_comment|/* vt82c586 */
)brace
r_if
c_cond
(paren
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|id
op_eq
id|PCI_DEVICE_ID_VIA_82C596
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|isa
comma
id|PCI_REVISION_ID
comma
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
OL
l_int|0x10
)paren
id|via_config
op_increment
suffix:semicolon
multiline_comment|/* vt82c596a */
)brace
multiline_comment|/*&n; * Check UDMA66 mode set by BIOS.&n; */
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|VIA_UDMA_TIMING
comma
op_amp
id|u
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_UDMA_TIMING
op_plus
(paren
l_int|3
op_minus
id|i
)paren
comma
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u
op_amp
(paren
l_int|0x80000
op_rshift
(paren
(paren
id|i
op_rshift
l_int|1
)paren
op_lshift
l_int|4
)paren
)paren
)paren
op_logical_and
(paren
(paren
id|t
op_amp
l_int|7
)paren
OL
l_int|2
)paren
)paren
id|via_ata66
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|i
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;VP_IDE: BIOS enabled ATA66: primary: %s, secondary: %s&bslash;n&quot;
comma
id|via_ata66
op_amp
l_int|1
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|via_ata66
op_amp
l_int|2
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Set UDMA66 double clock bits.&n; */
r_if
c_cond
(paren
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
op_eq
id|XFER_UDMA_4
)paren
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|VIA_UDMA_TIMING
comma
id|u
op_or
l_int|0x80008
)paren
suffix:semicolon
multiline_comment|/*&n; * Set up FIFO, flush, prefetch and post-writes.&n; */
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|VIA_IDE_ENABLE
comma
op_amp
id|u
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_FIFO_CONFIG
comma
op_amp
id|f
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_IDE_CONFIG
comma
op_amp
id|t
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|VIA_MISC_3
comma
op_amp
id|m
)paren
suffix:semicolon
id|f
op_and_assign
l_int|0x90
suffix:semicolon
id|t
op_and_assign
l_int|0x0f
suffix:semicolon
id|m
op_and_assign
l_int|0x0f
suffix:semicolon
r_switch
c_cond
(paren
id|u
op_amp
l_int|3
)paren
(brace
r_case
l_int|2
suffix:colon
id|via_enabled
op_assign
l_int|1
suffix:semicolon
id|f
op_or_assign
l_int|0x06
suffix:semicolon
id|t
op_or_assign
l_int|0xc0
suffix:semicolon
id|m
op_or_assign
l_int|0xa0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* primary only, 3/4 */
r_case
l_int|1
suffix:colon
id|via_enabled
op_assign
l_int|2
suffix:semicolon
id|f
op_or_assign
l_int|0x69
suffix:semicolon
id|t
op_or_assign
l_int|0x30
suffix:semicolon
id|m
op_or_assign
l_int|0x50
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* secondary only, 3/4 */
r_case
l_int|3
suffix:colon
id|via_enabled
op_assign
l_int|3
suffix:semicolon
r_default
suffix:colon
id|f
op_or_assign
l_int|0x2a
suffix:semicolon
id|t
op_or_assign
l_int|0xf0
suffix:semicolon
id|m
op_or_assign
l_int|0xf0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* fifo evenly distributed */
)brace
id|via_write_config_byte
c_func
(paren
id|dev
comma
id|VIA_FIFO_CONFIG
comma
id|f
)paren
suffix:semicolon
id|via_write_config_byte
c_func
(paren
id|dev
comma
id|VIA_IDE_CONFIG
comma
id|t
)paren
suffix:semicolon
id|via_write_config_byte
c_func
(paren
id|dev
comma
id|VIA_MISC_3
comma
id|m
)paren
suffix:semicolon
multiline_comment|/*&n; * Print the boot message.&n; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VP_IDE: VIA %s IDE %s controller on pci%d:%d.%d&bslash;n&quot;
comma
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|name
comma
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
op_ge
id|XFER_UDMA_4
ques
c_cond
l_string|&quot;UDMA66&quot;
suffix:colon
id|via_isa_bridges
(braket
id|via_config
)braket
dot
id|speed
op_ge
id|XFER_UDMA_2
ques
c_cond
l_string|&quot;UDMA33&quot;
suffix:colon
l_string|&quot;MWDMA16&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Register /proc/ide/via entry&n; */
macro_line|#if defined(CONFIG_PROC_FS)
r_if
c_cond
(paren
op_logical_neg
id|via_proc
)paren
(brace
id|via_proc
op_assign
l_int|1
suffix:semicolon
id|bmide_dev
op_assign
id|dev
suffix:semicolon
id|isa_dev
op_assign
id|isa
suffix:semicolon
id|via_display_info
op_assign
op_amp
id|via_get_info
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Since we don&squot;t have a way to detect the 80-wire ribbon cable&n; * we rely on the BIOS detection. We also check the IDENTIFY byte&n; * 93 to check the drive&squot;s point of view. I think we could return&n; * &squot;1&squot; here &n; */
DECL|function|ata66_via82cxxx
r_int
r_int
id|__init
id|ata66_via82cxxx
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
r_return
(paren
(paren
id|via_enabled
op_amp
id|via_ata66
)paren
op_rshift
id|hwif-&gt;channel
)paren
op_amp
l_int|1
suffix:semicolon
)brace
DECL|function|ide_init_via82cxxx
r_void
id|__init
id|ide_init_via82cxxx
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
id|hwif-&gt;tuneproc
op_assign
op_amp
id|via82cxxx_tune_drive
suffix:semicolon
id|hwif-&gt;speedproc
op_assign
op_amp
id|via_set_speed
suffix:semicolon
id|hwif-&gt;drives
(braket
l_int|0
)braket
dot
id|autotune
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;drives
(braket
l_int|1
)braket
dot
id|autotune
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;autodma
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA
r_if
c_cond
(paren
id|hwif-&gt;dma_base
)paren
(brace
id|hwif-&gt;dmaproc
op_assign
op_amp
id|via82cxxx_dmaproc
suffix:semicolon
id|hwif-&gt;autodma
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_BLK_DEV_IDEDMA */
)brace
multiline_comment|/*&n; * We allow the BM-DMA driver only work on enabled interfaces.&n; */
DECL|function|ide_dmacapable_via82cxxx
r_void
id|__init
id|ide_dmacapable_via82cxxx
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
comma
r_int
r_int
id|dmabase
)paren
(brace
r_if
c_cond
(paren
(paren
id|via_enabled
op_rshift
id|hwif-&gt;channel
)paren
op_amp
l_int|1
)paren
id|ide_setup_dma
c_func
(paren
id|hwif
comma
id|dmabase
comma
l_int|8
)paren
suffix:semicolon
)brace
eof
