multiline_comment|/*&n; * linux/drivers/ide/icside.c&n; *&n; * Copyright (c) 1996,1997 Russell King.&n; *&n; * Changelog:&n; *  08-Jun-1996&t;RMK&t;Created&n; *  12-Sep-1997&t;RMK&t;Added interrupt enable/disable&n; *  17-Apr-1999&t;RMK&t;Added support for V6 EASI&n; *  22-May-1999&t;RMK&t;Added support for V6 DMA&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
macro_line|#include &lt;asm/io.h&gt;
r_extern
r_char
op_star
id|ide_xfer_verbose
(paren
id|byte
id|xfer_rate
)paren
suffix:semicolon
multiline_comment|/*&n; * Maximum number of interfaces per card&n; */
DECL|macro|MAX_IFS
mdefine_line|#define MAX_IFS&t;2
DECL|macro|ICS_IDENT_OFFSET
mdefine_line|#define ICS_IDENT_OFFSET&t;&t;0x8a0
DECL|macro|ICS_ARCIN_V5_INTRSTAT
mdefine_line|#define ICS_ARCIN_V5_INTRSTAT&t;&t;0x000
DECL|macro|ICS_ARCIN_V5_INTROFFSET
mdefine_line|#define ICS_ARCIN_V5_INTROFFSET&t;&t;0x001
DECL|macro|ICS_ARCIN_V5_IDEOFFSET
mdefine_line|#define ICS_ARCIN_V5_IDEOFFSET&t;&t;0xa00
DECL|macro|ICS_ARCIN_V5_IDEALTOFFSET
mdefine_line|#define ICS_ARCIN_V5_IDEALTOFFSET&t;0xae0
DECL|macro|ICS_ARCIN_V5_IDESTEPPING
mdefine_line|#define ICS_ARCIN_V5_IDESTEPPING&t;4
DECL|macro|ICS_ARCIN_V6_IDEOFFSET_1
mdefine_line|#define ICS_ARCIN_V6_IDEOFFSET_1&t;0x800
DECL|macro|ICS_ARCIN_V6_INTROFFSET_1
mdefine_line|#define ICS_ARCIN_V6_INTROFFSET_1&t;0x880
DECL|macro|ICS_ARCIN_V6_INTRSTAT_1
mdefine_line|#define ICS_ARCIN_V6_INTRSTAT_1&t;&t;0x8a4
DECL|macro|ICS_ARCIN_V6_IDEALTOFFSET_1
mdefine_line|#define ICS_ARCIN_V6_IDEALTOFFSET_1&t;0x8e0
DECL|macro|ICS_ARCIN_V6_IDEOFFSET_2
mdefine_line|#define ICS_ARCIN_V6_IDEOFFSET_2&t;0xc00
DECL|macro|ICS_ARCIN_V6_INTROFFSET_2
mdefine_line|#define ICS_ARCIN_V6_INTROFFSET_2&t;0xc80
DECL|macro|ICS_ARCIN_V6_INTRSTAT_2
mdefine_line|#define ICS_ARCIN_V6_INTRSTAT_2&t;&t;0xca4
DECL|macro|ICS_ARCIN_V6_IDEALTOFFSET_2
mdefine_line|#define ICS_ARCIN_V6_IDEALTOFFSET_2&t;0xce0
DECL|macro|ICS_ARCIN_V6_IDESTEPPING
mdefine_line|#define ICS_ARCIN_V6_IDESTEPPING&t;4
DECL|struct|cardinfo
r_struct
id|cardinfo
(brace
DECL|member|dataoffset
r_int
r_int
id|dataoffset
suffix:semicolon
DECL|member|ctrloffset
r_int
r_int
id|ctrloffset
suffix:semicolon
DECL|member|stepping
r_int
r_int
id|stepping
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|icside_cardinfo_v5
r_static
r_struct
id|cardinfo
id|icside_cardinfo_v5
op_assign
(brace
id|ICS_ARCIN_V5_IDEOFFSET
comma
id|ICS_ARCIN_V5_IDEALTOFFSET
comma
id|ICS_ARCIN_V5_IDESTEPPING
)brace
suffix:semicolon
DECL|variable|icside_cardinfo_v6_1
r_static
r_struct
id|cardinfo
id|icside_cardinfo_v6_1
op_assign
(brace
id|ICS_ARCIN_V6_IDEOFFSET_1
comma
id|ICS_ARCIN_V6_IDEALTOFFSET_1
comma
id|ICS_ARCIN_V6_IDESTEPPING
)brace
suffix:semicolon
DECL|variable|icside_cardinfo_v6_2
r_static
r_struct
id|cardinfo
id|icside_cardinfo_v6_2
op_assign
(brace
id|ICS_ARCIN_V6_IDEOFFSET_2
comma
id|ICS_ARCIN_V6_IDEALTOFFSET_2
comma
id|ICS_ARCIN_V6_IDESTEPPING
)brace
suffix:semicolon
DECL|variable|icside_cids
r_static
r_const
id|card_ids
id|icside_cids
(braket
)braket
op_assign
(brace
(brace
id|MANU_ICS
comma
id|PROD_ICS_IDE
)brace
comma
(brace
id|MANU_ICS2
comma
id|PROD_ICS2_IDE
)brace
comma
(brace
l_int|0xffff
comma
l_int|0xffff
)brace
)brace
suffix:semicolon
r_typedef
r_enum
(brace
DECL|enumerator|ics_if_unknown
id|ics_if_unknown
comma
DECL|enumerator|ics_if_arcin_v5
id|ics_if_arcin_v5
comma
DECL|enumerator|ics_if_arcin_v6
id|ics_if_arcin_v6
DECL|typedef|iftype_t
)brace
id|iftype_t
suffix:semicolon
multiline_comment|/* ---------------- Version 5 PCB Support Functions --------------------- */
multiline_comment|/* Prototype: icside_irqenable_arcin_v5 (struct expansion_card *ec, int irqnr)&n; * Purpose  : enable interrupts from card&n; */
DECL|function|icside_irqenable_arcin_v5
r_static
r_void
id|icside_irqenable_arcin_v5
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|memc_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|memc_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqdisable_arcin_v5 (struct expansion_card *ec, int irqnr)&n; * Purpose  : disable interrupts from card&n; */
DECL|function|icside_irqdisable_arcin_v5
r_static
r_void
id|icside_irqdisable_arcin_v5
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|memc_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|inb
(paren
id|memc_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
)brace
DECL|variable|icside_ops_arcin_v5
r_static
r_const
id|expansioncard_ops_t
id|icside_ops_arcin_v5
op_assign
(brace
id|icside_irqenable_arcin_v5
comma
id|icside_irqdisable_arcin_v5
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* ---------------- Version 6 PCB Support Functions --------------------- */
multiline_comment|/* Prototype: icside_irqenable_arcin_v6 (struct expansion_card *ec, int irqnr)&n; * Purpose  : enable interrupts from card&n; */
DECL|function|icside_irqenable_arcin_v6
r_static
r_void
id|icside_irqenable_arcin_v6
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|ide_base_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqdisable_arcin_v6 (struct expansion_card *ec, int irqnr)&n; * Purpose  : disable interrupts from card&n; */
DECL|function|icside_irqdisable_arcin_v6
r_static
r_void
id|icside_irqdisable_arcin_v6
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_int
r_int
id|ide_base_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
id|inb
(paren
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
(paren
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqprobe(struct expansion_card *ec)&n; * Purpose  : detect an active interrupt from card&n; */
DECL|function|icside_irqpending_arcin_v6
r_static
r_int
id|icside_irqpending_arcin_v6
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_int
r_int
id|ide_base_port
op_assign
(paren
r_int
r_int
)paren
id|ec-&gt;irq_data
suffix:semicolon
r_return
id|inb
c_func
(paren
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTRSTAT_1
)paren
op_amp
l_int|1
op_logical_or
id|inb
c_func
(paren
id|ide_base_port
op_plus
id|ICS_ARCIN_V6_INTRSTAT_2
)paren
op_amp
l_int|1
suffix:semicolon
)brace
DECL|variable|icside_ops_arcin_v6
r_static
r_const
id|expansioncard_ops_t
id|icside_ops_arcin_v6
op_assign
(brace
id|icside_irqenable_arcin_v6
comma
id|icside_irqdisable_arcin_v6
comma
id|icside_irqpending_arcin_v6
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Prototype: icside_identifyif (struct expansion_card *ec)&n; * Purpose  : identify IDE interface type&n; * Notes    : checks the description string&n; */
DECL|function|icside_identifyif
r_static
id|iftype_t
id|__init
id|icside_identifyif
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|iftype_t
id|iftype
suffix:semicolon
r_int
id|id
op_assign
l_int|0
suffix:semicolon
id|iftype
op_assign
id|ics_if_unknown
suffix:semicolon
id|addr
op_assign
id|ecard_address
(paren
id|ec
comma
id|ECARD_IOC
comma
id|ECARD_FAST
)paren
op_plus
id|ICS_IDENT_OFFSET
suffix:semicolon
id|id
op_assign
id|inb
(paren
id|addr
)paren
op_amp
l_int|1
suffix:semicolon
id|id
op_or_assign
(paren
id|inb
(paren
id|addr
op_plus
l_int|1
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
id|id
op_or_assign
(paren
id|inb
(paren
id|addr
op_plus
l_int|2
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|2
suffix:semicolon
id|id
op_or_assign
(paren
id|inb
(paren
id|addr
op_plus
l_int|3
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|3
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* A3IN */
id|printk
c_func
(paren
l_string|&quot;icside: A3IN unsupported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* A3USER */
id|printk
c_func
(paren
l_string|&quot;icside: A3USER unsupported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* ARCIN V6 */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icside: detected ARCIN V6 in slot %d&bslash;n&quot;
comma
id|ec-&gt;slot_no
)paren
suffix:semicolon
id|iftype
op_assign
id|ics_if_arcin_v6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
multiline_comment|/* ARCIN V5 (no id) */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icside: detected ARCIN V5 in slot %d&bslash;n&quot;
comma
id|ec-&gt;slot_no
)paren
suffix:semicolon
id|iftype
op_assign
id|ics_if_arcin_v5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* we don&squot;t know - complain very loudly */
id|printk
c_func
(paren
l_string|&quot;icside: ***********************************&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;icside: *** UNKNOWN ICS INTERFACE id=%d ***&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;icside: ***********************************&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;icside: please report this to linux@arm.linux.org.uk&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;icside: defaulting to ARCIN V5&bslash;n&quot;
)paren
suffix:semicolon
id|iftype
op_assign
id|ics_if_arcin_v5
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|iftype
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA_ICS
multiline_comment|/*&n; * SG-DMA support.&n; *&n; * Similar to the BM-DMA, but we use the RiscPCs IOMD DMA controllers.&n; * There is only one DMA controller per card, which means that only&n; * one drive can be accessed at one time.  NOTE! We do not enforce that&n; * here, but we rely on the main IDE driver spotting that both&n; * interfaces use the same IRQ, which should guarantee this.&n; */
DECL|macro|NR_ENTRIES
mdefine_line|#define NR_ENTRIES 256
DECL|macro|TABLE_SIZE
mdefine_line|#define TABLE_SIZE (NR_ENTRIES * 8)
DECL|function|ide_build_sglist
r_static
r_int
id|ide_build_sglist
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|hwif-&gt;sg_table
suffix:semicolon
r_int
id|nents
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;cmd
op_eq
id|READ
)paren
id|hwif-&gt;sg_dma_direction
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
r_else
id|hwif-&gt;sg_dma_direction
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
id|bh
op_assign
id|rq-&gt;bh
suffix:semicolon
r_do
(brace
r_int
r_char
op_star
id|virt_addr
op_assign
id|bh-&gt;b_data
suffix:semicolon
r_int
r_int
id|size
op_assign
id|bh-&gt;b_size
suffix:semicolon
r_while
c_loop
(paren
(paren
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|virt_addr
op_plus
id|size
)paren
op_ne
(paren
r_int
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
r_break
suffix:semicolon
id|size
op_add_assign
id|bh-&gt;b_size
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|sg
(braket
id|nents
)braket
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sg
)paren
)paren
suffix:semicolon
id|sg
(braket
id|nents
)braket
dot
id|address
op_assign
id|virt_addr
suffix:semicolon
id|sg
(braket
id|nents
)braket
dot
id|length
op_assign
id|size
suffix:semicolon
id|nents
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|bh
op_ne
l_int|NULL
)paren
suffix:semicolon
r_return
id|pci_map_sg
c_func
(paren
l_int|NULL
comma
id|sg
comma
id|nents
comma
id|hwif-&gt;sg_dma_direction
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icside_build_dmatable
id|icside_build_dmatable
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|reading
)paren
(brace
r_return
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|sg_nents
op_assign
id|ide_build_sglist
c_func
(paren
id|HWIF
c_func
(paren
id|drive
)paren
comma
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
)paren
suffix:semicolon
)brace
multiline_comment|/* Teardown mappings after DMA has completed.  */
DECL|function|icside_destroy_dmatable
r_static
r_void
id|icside_destroy_dmatable
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|sg_table
suffix:semicolon
r_int
id|nents
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|sg_nents
suffix:semicolon
id|pci_unmap_sg
c_func
(paren
l_int|NULL
comma
id|sg
comma
id|nents
comma
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|sg_dma_direction
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icside_config_if
id|icside_config_if
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|xfer_mode
)paren
(brace
r_int
id|func
op_assign
id|ide_dma_off
suffix:semicolon
r_switch
c_cond
(paren
id|xfer_mode
)paren
(brace
r_case
id|XFER_MW_DMA_2
suffix:colon
multiline_comment|/*&n;&t;&t; * The cycle time is limited to 250ns by the r/w&n;&t;&t; * pulse width (90ns), however we should still&n;&t;&t; * have a maximum burst transfer rate of 8MB/s.&n;&t;&t; */
id|drive-&gt;drive_data
op_assign
l_int|250
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XFER_MW_DMA_1
suffix:colon
id|drive-&gt;drive_data
op_assign
l_int|250
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XFER_MW_DMA_0
suffix:colon
id|drive-&gt;drive_data
op_assign
l_int|480
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|drive-&gt;drive_data
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;init_speed
)paren
id|drive-&gt;init_speed
op_assign
(paren
id|byte
)paren
id|xfer_mode
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;drive_data
op_logical_and
id|ide_config_drive_speed
c_func
(paren
id|drive
comma
(paren
id|byte
)paren
id|xfer_mode
)paren
op_eq
l_int|0
)paren
id|func
op_assign
id|ide_dma_on
suffix:semicolon
r_else
id|drive-&gt;drive_data
op_assign
l_int|480
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s selected (peak %dMB/s)&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|ide_xfer_verbose
c_func
(paren
id|xfer_mode
)paren
comma
l_int|2000
op_div
id|drive-&gt;drive_data
)paren
suffix:semicolon
id|drive-&gt;current_speed
op_assign
(paren
id|byte
)paren
id|xfer_mode
suffix:semicolon
r_return
id|func
suffix:semicolon
)brace
r_static
r_int
DECL|function|icside_set_speed
id|icside_set_speed
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|byte
id|speed
)paren
(brace
r_return
id|icside_config_if
c_func
(paren
id|drive
comma
id|speed
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icside_dma_check
id|icside_dma_check
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
id|autodma
op_assign
id|hwif-&gt;autodma
suffix:semicolon
r_int
id|xfer_mode
op_assign
id|XFER_PIO_2
suffix:semicolon
r_int
id|func
op_assign
id|ide_dma_off_quietly
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|id
op_logical_or
op_logical_neg
(paren
id|id-&gt;capability
op_amp
l_int|1
)paren
op_logical_or
op_logical_neg
id|autodma
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Consult the list of known &quot;bad&quot; drives&n;&t; */
r_if
c_cond
(paren
id|ide_dmaproc
c_func
(paren
id|ide_dma_bad_drive
comma
id|drive
)paren
)paren
(brace
id|func
op_assign
id|ide_dma_off
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Enable DMA on any drive that has multiword DMA&n;&t; */
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|4
)paren
(brace
id|xfer_mode
op_assign
id|XFER_MW_DMA_2
suffix:semicolon
id|func
op_assign
id|ide_dma_on
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|2
)paren
(brace
id|xfer_mode
op_assign
id|XFER_MW_DMA_1
suffix:semicolon
id|func
op_assign
id|ide_dma_on
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
l_int|1
)paren
(brace
id|xfer_mode
op_assign
id|XFER_MW_DMA_0
suffix:semicolon
id|func
op_assign
id|ide_dma_on
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Consult the list of known &quot;good&quot; drives&n;&t; */
r_if
c_cond
(paren
id|ide_dmaproc
c_func
(paren
id|ide_dma_good_drive
comma
id|drive
)paren
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;eide_dma_time
OG
l_int|150
)paren
r_goto
id|out
suffix:semicolon
id|xfer_mode
op_assign
id|XFER_MW_DMA_1
suffix:semicolon
id|func
op_assign
id|ide_dma_on
suffix:semicolon
)brace
id|out
suffix:colon
id|func
op_assign
id|icside_config_if
c_func
(paren
id|drive
comma
id|xfer_mode
)paren
suffix:semicolon
r_return
id|hwif
op_member_access_from_pointer
id|dmaproc
c_func
(paren
id|func
comma
id|drive
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icside_dmaproc
id|icside_dmaproc
c_func
(paren
id|ide_dma_action_t
id|func
comma
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
id|count
comma
id|reading
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|func
)paren
(brace
r_case
id|ide_dma_check
suffix:colon
r_return
id|icside_dma_check
c_func
(paren
id|drive
)paren
suffix:semicolon
r_case
id|ide_dma_read
suffix:colon
id|reading
op_assign
l_int|1
suffix:semicolon
r_case
id|ide_dma_write
suffix:colon
id|count
op_assign
id|icside_build_dmatable
c_func
(paren
id|drive
comma
id|reading
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|1
suffix:semicolon
id|disable_dma
c_func
(paren
id|hwif-&gt;hw.dma
)paren
suffix:semicolon
multiline_comment|/* Route the DMA signals to&n;&t;&t; * to the correct interface.&n;&t;&t; */
id|outb
c_func
(paren
id|hwif-&gt;select_data
comma
id|hwif-&gt;config_data
)paren
suffix:semicolon
multiline_comment|/* Select the correct timing&n;&t;&t; * for this drive&n;&t;&t; */
id|set_dma_speed
c_func
(paren
id|hwif-&gt;hw.dma
comma
id|drive-&gt;drive_data
)paren
suffix:semicolon
id|set_dma_sg
c_func
(paren
id|hwif-&gt;hw.dma
comma
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|sg_table
comma
id|count
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|hwif-&gt;hw.dma
comma
id|reading
ques
c_cond
id|DMA_MODE_READ
suffix:colon
id|DMA_MODE_WRITE
)paren
suffix:semicolon
id|drive-&gt;waiting_for_dma
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;media
op_ne
id|ide_disk
)paren
r_return
l_int|0
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|ide_dma_intr
comma
id|WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
id|OUT_BYTE
c_func
(paren
id|reading
ques
c_cond
id|WIN_READDMA
suffix:colon
id|WIN_WRITEDMA
comma
id|IDE_COMMAND_REG
)paren
suffix:semicolon
r_case
id|ide_dma_begin
suffix:colon
id|enable_dma
c_func
(paren
id|hwif-&gt;hw.dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ide_dma_end
suffix:colon
id|drive-&gt;waiting_for_dma
op_assign
l_int|0
suffix:semicolon
id|disable_dma
c_func
(paren
id|hwif-&gt;hw.dma
)paren
suffix:semicolon
id|icside_destroy_dmatable
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|get_dma_residue
c_func
(paren
id|hwif-&gt;hw.dma
)paren
op_ne
l_int|0
suffix:semicolon
r_case
id|ide_dma_test_irq
suffix:colon
r_return
id|inb
c_func
(paren
(paren
r_int
r_int
)paren
id|hwif-&gt;hw.priv
)paren
op_amp
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
id|ide_dmaproc
c_func
(paren
id|func
comma
id|drive
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|icside_setup_dma
id|icside_setup_dma
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
comma
r_int
id|autodma
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    %s: SG-DMA&quot;
comma
id|hwif-&gt;name
)paren
suffix:semicolon
id|hwif-&gt;sg_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|NR_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;sg_table
)paren
r_goto
id|failed
suffix:semicolon
id|hwif-&gt;dmatable_cpu
op_assign
l_int|NULL
suffix:semicolon
id|hwif-&gt;dmatable_dma
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;speedproc
op_assign
id|icside_set_speed
suffix:semicolon
id|hwif-&gt;dmaproc
op_assign
id|icside_dmaproc
suffix:semicolon
id|hwif-&gt;autodma
op_assign
id|autodma
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; capable%s&bslash;n&quot;
comma
id|autodma
ques
c_cond
l_string|&quot;, auto-enable&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|failed
suffix:colon
id|printk
c_func
(paren
l_string|&quot; -- ERROR, unable to allocate DMA table&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_static
id|ide_hwif_t
op_star
DECL|function|icside_find_hwif
id|icside_find_hwif
c_func
(paren
r_int
r_int
id|dataport
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
r_int
id|index
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|index
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;hw.io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
(paren
id|ide_ioreg_t
)paren
id|dataport
)paren
r_goto
id|found
suffix:semicolon
)brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|index
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;hw.io_ports
(braket
id|IDE_DATA_OFFSET
)braket
)paren
r_goto
id|found
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
id|found
suffix:colon
r_return
id|hwif
suffix:semicolon
)brace
r_static
id|ide_hwif_t
op_star
DECL|function|icside_setup
id|icside_setup
c_func
(paren
r_int
r_int
id|base
comma
r_struct
id|cardinfo
op_star
id|info
comma
r_int
id|irq
)paren
(brace
r_int
r_int
id|port
op_assign
id|base
op_plus
id|info-&gt;dataoffset
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
id|hwif
op_assign
id|icside_find_hwif
c_func
(paren
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwif
)paren
(brace
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hwif-&gt;hw
comma
l_int|0
comma
r_sizeof
(paren
id|hw_regs_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IDE_DATA_OFFSET
suffix:semicolon
id|i
op_le
id|IDE_STATUS_OFFSET
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hwif-&gt;hw.io_ports
(braket
id|i
)braket
op_assign
(paren
id|ide_ioreg_t
)paren
id|port
suffix:semicolon
id|port
op_add_assign
l_int|1
op_lshift
id|info-&gt;stepping
suffix:semicolon
)brace
id|hwif-&gt;hw.io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|base
op_plus
id|info-&gt;ctrloffset
suffix:semicolon
id|hwif-&gt;hw.irq
op_assign
id|irq
suffix:semicolon
id|hwif-&gt;hw.dma
op_assign
id|NO_DMA
suffix:semicolon
id|hwif-&gt;noprobe
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;chipset
op_assign
id|ide_acorn
suffix:semicolon
)brace
r_return
id|hwif
suffix:semicolon
)brace
DECL|function|icside_register_v5
r_static
r_int
id|__init
id|icside_register_v5
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|autodma
)paren
(brace
r_int
r_int
id|slot_port
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
id|slot_port
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_MEMC
comma
l_int|0
)paren
suffix:semicolon
id|ec-&gt;irqaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|ioaddr
c_func
(paren
id|slot_port
op_plus
id|ICS_ARCIN_V5_INTRSTAT
)paren
suffix:semicolon
id|ec-&gt;irqmask
op_assign
l_int|1
suffix:semicolon
id|ec-&gt;irq_data
op_assign
(paren
r_void
op_star
)paren
id|slot_port
suffix:semicolon
id|ec-&gt;ops
op_assign
(paren
id|expansioncard_ops_t
op_star
)paren
op_amp
id|icside_ops_arcin_v5
suffix:semicolon
multiline_comment|/*&n;&t; * Be on the safe side - disable interrupts&n;&t; */
id|inb
c_func
(paren
id|slot_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
id|hwif
op_assign
id|icside_setup
c_func
(paren
id|slot_port
comma
op_amp
id|icside_cardinfo_v5
comma
id|ec-&gt;irq
)paren
suffix:semicolon
r_return
id|hwif
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|icside_register_v6
r_static
r_int
id|__init
id|icside_register_v6
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|autodma
)paren
(brace
r_int
r_int
id|slot_port
comma
id|port
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
comma
op_star
id|mate
suffix:semicolon
r_int
id|sel
op_assign
l_int|0
suffix:semicolon
id|slot_port
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_IOC
comma
id|ECARD_FAST
)paren
suffix:semicolon
id|port
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_EASI
comma
id|ECARD_FAST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
l_int|0
)paren
id|port
op_assign
id|slot_port
suffix:semicolon
r_else
id|sel
op_assign
l_int|1
op_lshift
l_int|5
suffix:semicolon
id|outb
c_func
(paren
id|sel
comma
id|slot_port
)paren
suffix:semicolon
id|ec-&gt;irq_data
op_assign
(paren
r_void
op_star
)paren
id|port
suffix:semicolon
id|ec-&gt;ops
op_assign
(paren
id|expansioncard_ops_t
op_star
)paren
op_amp
id|icside_ops_arcin_v6
suffix:semicolon
multiline_comment|/*&n;&t; * Be on the safe side - disable interrupts&n;&t; */
id|inb
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
id|hwif
op_assign
id|icside_setup
c_func
(paren
id|port
comma
op_amp
id|icside_cardinfo_v6_1
comma
id|ec-&gt;irq
)paren
suffix:semicolon
id|mate
op_assign
id|icside_setup
c_func
(paren
id|port
comma
op_amp
id|icside_cardinfo_v6_2
comma
id|ec-&gt;irq
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA_ICS
r_if
c_cond
(paren
id|ec-&gt;dma
op_ne
id|NO_DMA
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|ec-&gt;dma
comma
id|hwif-&gt;name
)paren
)paren
r_goto
id|no_dma
suffix:semicolon
r_if
c_cond
(paren
id|hwif
)paren
(brace
id|hwif-&gt;config_data
op_assign
id|slot_port
suffix:semicolon
id|hwif-&gt;select_data
op_assign
id|sel
suffix:semicolon
id|hwif-&gt;hw.dma
op_assign
id|ec-&gt;dma
suffix:semicolon
id|hwif-&gt;hw.priv
op_assign
(paren
r_void
op_star
)paren
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTRSTAT_1
)paren
suffix:semicolon
id|hwif-&gt;channel
op_assign
l_int|0
suffix:semicolon
id|icside_setup_dma
c_func
(paren
id|hwif
comma
id|autodma
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mate
)paren
(brace
id|mate-&gt;config_data
op_assign
id|slot_port
suffix:semicolon
id|mate-&gt;select_data
op_assign
id|sel
op_or
l_int|1
suffix:semicolon
id|mate-&gt;hw.dma
op_assign
id|ec-&gt;dma
suffix:semicolon
id|mate-&gt;hw.priv
op_assign
(paren
r_void
op_star
)paren
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTRSTAT_2
)paren
suffix:semicolon
id|mate-&gt;channel
op_assign
l_int|1
suffix:semicolon
id|icside_setup_dma
c_func
(paren
id|mate
comma
id|autodma
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|no_dma
suffix:colon
r_return
id|hwif
op_logical_or
id|mate
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|icside_init
r_int
id|__init
id|icside_init
c_func
(paren
r_void
)paren
(brace
r_int
id|autodma
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IDEDMA_ICS_AUTO
id|autodma
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|ecard_startfind
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|expansion_card
op_star
id|ec
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ec
op_assign
id|ecard_find
c_func
(paren
l_int|0
comma
id|icside_cids
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|ecard_claim
c_func
(paren
id|ec
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|icside_identifyif
c_func
(paren
id|ec
)paren
)paren
(brace
r_case
id|ics_if_arcin_v5
suffix:colon
id|result
op_assign
id|icside_register_v5
c_func
(paren
id|ec
comma
id|autodma
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ics_if_arcin_v6
suffix:colon
id|result
op_assign
id|icside_register_v6
c_func
(paren
id|ec
comma
id|autodma
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
id|ecard_release
c_func
(paren
id|ec
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
