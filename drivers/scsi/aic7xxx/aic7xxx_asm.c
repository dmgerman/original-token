multiline_comment|/*&n; * Aic7xxx SCSI host adapter firmware asssembler&n; *&n; * Copyright (c) 1997 Justin T. Gibbs.&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice immediately at the beginning of the file, without modification,&n; *    this list of conditions, and the following disclaimer.&n; * 2. Redistributions in binary form must reproduce the above copyright&n; *    notice, this list of conditions and the following disclaimer in the&n; *    documentation and/or other materials provided with the distribution.&n; * 3. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; *      $Id: aic7xxx_asm.c,v 1.16 1997/03/18 19:18:39 gibbs Exp $&n; */
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;sys/mman.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;sysexits.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &quot;aic7xxx_asm.h&quot;
macro_line|#include &quot;symbol.h&quot;
macro_line|#include &quot;sequencer.h&quot;
r_static
r_void
id|usage
id|__P
c_func
(paren
(paren
r_void
)paren
)paren
suffix:semicolon
r_static
r_void
id|back_patch
id|__P
c_func
(paren
(paren
r_void
)paren
)paren
suffix:semicolon
r_static
r_void
id|output_code
id|__P
c_func
(paren
(paren
id|FILE
op_star
id|ofile
)paren
)paren
suffix:semicolon
r_static
r_void
id|output_listing
id|__P
c_func
(paren
(paren
id|FILE
op_star
id|listfile
comma
r_char
op_star
id|ifilename
comma
r_char
op_star
id|options
)paren
)paren
suffix:semicolon
r_static
r_struct
id|patch
op_star
id|next_patch
id|__P
c_func
(paren
(paren
r_struct
id|patch
op_star
id|cur_patch
comma
r_int
id|options
comma
r_int
id|instrptr
)paren
)paren
suffix:semicolon
DECL|variable|search_path
r_struct
id|path_list
id|search_path
suffix:semicolon
DECL|variable|includes_search_curdir
r_int
id|includes_search_curdir
suffix:semicolon
DECL|variable|appname
r_char
op_star
id|appname
suffix:semicolon
DECL|variable|ofile
id|FILE
op_star
id|ofile
suffix:semicolon
DECL|variable|ofilename
r_char
op_star
id|ofilename
suffix:semicolon
r_static
id|STAILQ_HEAD
c_func
(paren
comma
id|instruction
)paren
id|seq_program
suffix:semicolon
r_static
id|STAILQ_HEAD
c_func
(paren
comma
id|patch
)paren
id|patch_list
suffix:semicolon
DECL|variable|patch_options
id|symlist_t
id|patch_options
suffix:semicolon
macro_line|#if DEBUG
r_extern
r_int
id|yy_flex_debug
suffix:semicolon
r_extern
r_int
id|yydebug
suffix:semicolon
macro_line|#endif
r_extern
id|FILE
op_star
id|yyin
suffix:semicolon
r_extern
r_int
id|yyparse
id|__P
c_func
(paren
(paren
r_void
)paren
)paren
suffix:semicolon
r_int
DECL|function|main
id|main
c_func
(paren
id|argc
comma
id|argv
)paren
r_int
id|argc
suffix:semicolon
r_char
op_star
id|argv
(braket
)braket
suffix:semicolon
(brace
r_extern
r_char
op_star
id|optarg
suffix:semicolon
r_extern
r_int
id|optind
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_char
op_star
id|inputfilename
suffix:semicolon
r_char
op_star
id|regfilename
suffix:semicolon
id|FILE
op_star
id|regfile
suffix:semicolon
r_char
op_star
id|listfilename
suffix:semicolon
id|FILE
op_star
id|listfile
suffix:semicolon
r_char
op_star
id|options
suffix:semicolon
id|SLIST_INIT
c_func
(paren
op_amp
id|search_path
)paren
suffix:semicolon
id|STAILQ_INIT
c_func
(paren
op_amp
id|seq_program
)paren
suffix:semicolon
id|STAILQ_INIT
c_func
(paren
op_amp
id|patch_list
)paren
suffix:semicolon
id|SLIST_INIT
c_func
(paren
op_amp
id|patch_options
)paren
suffix:semicolon
id|includes_search_curdir
op_assign
l_int|1
suffix:semicolon
id|appname
op_assign
op_star
id|argv
suffix:semicolon
id|regfile
op_assign
l_int|NULL
suffix:semicolon
id|listfile
op_assign
l_int|NULL
suffix:semicolon
id|options
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if DEBUG
id|yy_flex_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|ch
op_assign
id|getopt
c_func
(paren
id|argc
comma
id|argv
comma
l_string|&quot;d:l:n:o:r:I:O:&quot;
)paren
)paren
op_ne
id|EOF
)paren
(brace
r_switch
c_cond
(paren
id|ch
)paren
(brace
r_case
l_char|&squot;d&squot;
suffix:colon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|optarg
comma
l_string|&quot;s&quot;
)paren
op_eq
l_int|0
)paren
id|yy_flex_debug
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|optarg
comma
l_string|&quot;p&quot;
)paren
op_eq
l_int|0
)paren
id|yydebug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|stop
c_func
(paren
l_string|&quot;-d: Assembler not built with debugging &quot;
l_string|&quot;information&quot;
comma
id|EX_SOFTWARE
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_char|&squot;l&squot;
suffix:colon
multiline_comment|/* Create a program listing */
r_if
c_cond
(paren
(paren
id|listfile
op_assign
id|fopen
c_func
(paren
id|optarg
comma
l_string|&quot;w&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
id|optarg
)paren
suffix:semicolon
id|stop
c_func
(paren
l_int|NULL
comma
id|EX_CANTCREAT
)paren
suffix:semicolon
)brace
id|listfilename
op_assign
id|optarg
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;n&squot;
suffix:colon
multiline_comment|/* Don&squot;t complain about the -nostdinc directrive */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|optarg
comma
l_string|&quot;ostdinc&quot;
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: Unknown option -%c%s&bslash;n&quot;
comma
id|appname
comma
id|ch
comma
id|optarg
)paren
suffix:semicolon
id|usage
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;o&squot;
suffix:colon
r_if
c_cond
(paren
(paren
id|ofile
op_assign
id|fopen
c_func
(paren
id|optarg
comma
l_string|&quot;w&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
id|optarg
)paren
suffix:semicolon
id|stop
c_func
(paren
l_int|NULL
comma
id|EX_CANTCREAT
)paren
suffix:semicolon
)brace
id|ofilename
op_assign
id|optarg
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;O&squot;
suffix:colon
multiline_comment|/* Patches to include in the listing */
id|options
op_assign
id|optarg
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;r&squot;
suffix:colon
r_if
c_cond
(paren
(paren
id|regfile
op_assign
id|fopen
c_func
(paren
id|optarg
comma
l_string|&quot;w&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
id|optarg
)paren
suffix:semicolon
id|stop
c_func
(paren
l_int|NULL
comma
id|EX_CANTCREAT
)paren
suffix:semicolon
)brace
id|regfilename
op_assign
id|optarg
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;I&squot;
suffix:colon
(brace
id|path_entry_t
id|include_dir
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|optarg
comma
l_string|&quot;-&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|includes_search_curdir
op_eq
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: Warning - &squot;-I-&squot; &quot;
l_string|&quot;specified multiple &quot;
l_string|&quot;times&bslash;n&quot;
comma
id|appname
)paren
suffix:semicolon
)brace
id|includes_search_curdir
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|include_dir
op_assign
id|search_path.slh_first
suffix:semicolon
id|include_dir
op_ne
l_int|NULL
suffix:semicolon
id|include_dir
op_assign
id|include_dir-&gt;links.sle_next
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t; * All entries before a &squot;-I-&squot; only&n;&t;&t;&t;&t;&t; * apply to includes specified with&n;&t;&t;&t;&t;&t; * quotes instead of &quot;&lt;&gt;&quot;.&n;&t;&t;&t;&t;&t; */
id|include_dir-&gt;quoted_includes_only
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|include_dir
op_assign
(paren
id|path_entry_t
)paren
id|malloc
c_func
(paren
r_sizeof
(paren
op_star
id|include_dir
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|include_dir
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
id|optarg
)paren
suffix:semicolon
id|stop
c_func
(paren
l_int|NULL
comma
id|EX_OSERR
)paren
suffix:semicolon
)brace
id|include_dir-&gt;directory
op_assign
id|strdup
c_func
(paren
id|optarg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|include_dir-&gt;directory
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
id|optarg
)paren
suffix:semicolon
id|stop
c_func
(paren
l_int|NULL
comma
id|EX_OSERR
)paren
suffix:semicolon
)brace
id|include_dir-&gt;quoted_includes_only
op_assign
l_int|0
suffix:semicolon
id|SLIST_INSERT_HEAD
c_func
(paren
op_amp
id|search_path
comma
id|include_dir
comma
id|links
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
l_char|&squot;?&squot;
suffix:colon
r_default
suffix:colon
id|usage
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
)brace
id|argc
op_sub_assign
id|optind
suffix:semicolon
id|argv
op_add_assign
id|optind
suffix:semicolon
r_if
c_cond
(paren
id|argc
op_ne
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: No input file specifiled&bslash;n&quot;
comma
id|appname
)paren
suffix:semicolon
id|usage
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
id|symtable_open
c_func
(paren
)paren
suffix:semicolon
id|inputfilename
op_assign
op_star
id|argv
suffix:semicolon
id|include_file
c_func
(paren
op_star
id|argv
comma
id|SOURCE_FILE
)paren
suffix:semicolon
id|retval
op_assign
id|yyparse
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
l_int|0
)paren
(brace
id|back_patch
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ofile
op_ne
l_int|NULL
)paren
id|output_code
c_func
(paren
id|ofile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regfile
op_ne
l_int|NULL
)paren
id|symtable_dump
c_func
(paren
id|regfile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|listfile
op_ne
l_int|NULL
)paren
id|output_listing
c_func
(paren
id|listfile
comma
id|inputfilename
comma
id|options
)paren
suffix:semicolon
)brace
id|stop
c_func
(paren
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|usage
id|usage
c_func
(paren
)paren
(brace
(paren
r_void
)paren
id|fprintf
c_func
(paren
id|stderr
comma
"&quot;"
id|usage
suffix:colon
op_mod
op_minus
l_int|16
id|s
(braket
op_minus
id|nostdinc
)braket
(braket
op_minus
id|I
op_minus
)braket
(braket
op_minus
id|I
id|directory
)braket
(braket
op_minus
id|o
id|output_file
)braket
(braket
op_minus
id|r
id|register_output_file
)braket
(braket
op_minus
id|l
id|program_list_file
)braket
(braket
op_minus
id|O
id|option_name
(braket
op_or
id|options_name2
)braket
)braket
id|input_file
"&bslash;"
id|n
"&quot;"
comma
id|appname
)paren
suffix:semicolon
m_exit
(paren
id|EX_USAGE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|back_patch
id|back_patch
c_func
(paren
)paren
(brace
r_struct
id|instruction
op_star
id|cur_instr
suffix:semicolon
r_for
c_loop
(paren
id|cur_instr
op_assign
id|seq_program.stqh_first
suffix:semicolon
id|cur_instr
op_ne
l_int|NULL
suffix:semicolon
id|cur_instr
op_assign
id|cur_instr-&gt;links.stqe_next
)paren
(brace
r_if
c_cond
(paren
id|cur_instr-&gt;patch_label
op_ne
l_int|NULL
)paren
(brace
r_struct
id|ins_format3
op_star
id|f3_instr
suffix:semicolon
id|u_int
id|address
suffix:semicolon
r_if
c_cond
(paren
id|cur_instr-&gt;patch_label-&gt;type
op_ne
id|LABEL
)paren
(brace
r_char
id|buf
(braket
l_int|255
)braket
suffix:semicolon
id|snprintf
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
l_string|&quot;Undefined label %s&quot;
comma
id|cur_instr-&gt;patch_label-&gt;name
)paren
suffix:semicolon
id|stop
c_func
(paren
id|buf
comma
id|EX_DATAERR
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
id|f3_instr
op_assign
op_amp
id|cur_instr-&gt;format.format3
suffix:semicolon
id|address
op_assign
(paren
(paren
id|f3_instr-&gt;opcode_addr
op_amp
id|ADDR_HIGH_BIT
)paren
op_lshift
l_int|8
)paren
op_or
id|f3_instr-&gt;address
suffix:semicolon
id|address
op_add_assign
id|cur_instr-&gt;patch_label-&gt;info.linfo-&gt;address
suffix:semicolon
id|f3_instr-&gt;opcode_addr
op_and_assign
op_complement
id|ADDR_HIGH_BIT
suffix:semicolon
id|f3_instr-&gt;opcode_addr
op_or_assign
(paren
id|address
op_rshift
l_int|8
)paren
op_amp
id|ADDR_HIGH_BIT
suffix:semicolon
id|f3_instr-&gt;address
op_assign
id|address
op_amp
l_int|0xFF
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|output_code
id|output_code
c_func
(paren
id|ofile
)paren
id|FILE
op_star
id|ofile
suffix:semicolon
(brace
r_struct
id|instruction
op_star
id|cur_instr
suffix:semicolon
id|patch_t
op_star
id|cur_patch
suffix:semicolon
id|symbol_node_t
op_star
id|cur_node
suffix:semicolon
r_int
id|instrcount
suffix:semicolon
id|instrcount
op_assign
l_int|0
suffix:semicolon
id|fprintf
c_func
(paren
id|ofile
comma
"&quot;"
multiline_comment|/*&n;  * DO NOT EDIT - This file is automatically generated.&n;  */
"&bslash;"
id|n
"&quot;"
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|ofile
comma
l_string|&quot;static u_int8_t seqprog[] = {&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cur_instr
op_assign
id|seq_program.stqh_first
suffix:semicolon
id|cur_instr
op_ne
l_int|NULL
suffix:semicolon
id|cur_instr
op_assign
id|cur_instr-&gt;links.stqe_next
)paren
(brace
id|fprintf
c_func
(paren
id|ofile
comma
l_string|&quot;&bslash;t0x%02x, 0x%02x, 0x%02x, 0x%02x,&bslash;n&quot;
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|0
)braket
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|1
)braket
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|2
)braket
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|instrcount
op_increment
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|ofile
comma
l_string|&quot;};&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Output the patch list, option definitions first.&n;&t; */
r_for
c_loop
(paren
id|cur_node
op_assign
id|patch_options.slh_first
suffix:semicolon
id|cur_node
op_ne
l_int|NULL
suffix:semicolon
id|cur_node
op_assign
id|cur_node-&gt;links.sle_next
)paren
(brace
id|fprintf
c_func
(paren
id|ofile
comma
l_string|&quot;#define&bslash;t%-16s&bslash;t0x%x&bslash;n&quot;
comma
id|cur_node-&gt;symbol-&gt;name
comma
id|cur_node-&gt;symbol-&gt;info.condinfo-&gt;value
)paren
suffix:semicolon
)brace
id|fprintf
(paren
id|ofile
comma
"&quot;"
r_struct
id|patch
(brace
r_int
id|options
suffix:semicolon
r_int
id|negative
suffix:semicolon
r_int
id|begin
suffix:semicolon
r_int
id|end
suffix:semicolon
)brace
id|patches
(braket
)braket
op_assign
(brace
"&bslash;"
id|n
"&quot;"
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cur_patch
op_assign
id|patch_list.stqh_first
suffix:semicolon
id|cur_patch
op_ne
l_int|NULL
suffix:semicolon
id|cur_patch
op_assign
id|cur_patch-&gt;links.stqe_next
)paren
(brace
id|fprintf
c_func
(paren
id|ofile
comma
l_string|&quot;&bslash;t{ 0x%08x, %d, 0x%03x, 0x%03x },&bslash;n&quot;
comma
id|cur_patch-&gt;options
comma
id|cur_patch-&gt;negative
comma
id|cur_patch-&gt;begin
comma
id|cur_patch-&gt;end
)paren
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|ofile
comma
l_string|&quot;&bslash;t{ 0x%08x, %d, 0x%03x, 0x%03x }&bslash;n};&bslash;n&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %d instructions used&bslash;n&quot;
comma
id|appname
comma
id|instrcount
)paren
suffix:semicolon
)brace
r_void
DECL|function|output_listing
id|output_listing
c_func
(paren
id|listfile
comma
id|ifilename
comma
id|patches
)paren
id|FILE
op_star
id|listfile
suffix:semicolon
r_char
op_star
id|ifilename
suffix:semicolon
r_char
op_star
id|patches
suffix:semicolon
(brace
id|FILE
op_star
id|ifile
suffix:semicolon
r_int
id|line
suffix:semicolon
r_struct
id|instruction
op_star
id|cur_instr
suffix:semicolon
r_int
id|instrcount
suffix:semicolon
r_int
id|instrptr
suffix:semicolon
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
id|patch_t
op_star
id|cur_patch
suffix:semicolon
r_char
op_star
id|option_spec
suffix:semicolon
r_int
id|options
suffix:semicolon
id|instrcount
op_assign
l_int|0
suffix:semicolon
id|instrptr
op_assign
l_int|0
suffix:semicolon
id|line
op_assign
l_int|1
suffix:semicolon
id|options
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* All code outside of patch blocks */
r_if
c_cond
(paren
(paren
id|ifile
op_assign
id|fopen
c_func
(paren
id|ifilename
comma
l_string|&quot;r&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
id|ifilename
)paren
suffix:semicolon
id|stop
c_func
(paren
l_int|NULL
comma
id|EX_DATAERR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Determine which options to apply to this listing.&n;&t; */
r_while
c_loop
(paren
(paren
id|option_spec
op_assign
id|strsep
c_func
(paren
op_amp
id|patches
comma
l_string|&quot;|&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|symbol_t
op_star
id|symbol
suffix:semicolon
id|symbol
op_assign
id|symtable_get
c_func
(paren
id|option_spec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|symbol-&gt;type
op_ne
id|CONDITIONAL
)paren
(brace
id|stop
c_func
(paren
l_string|&quot;Invalid option specified in patch list for &quot;
l_string|&quot;program listing&quot;
comma
id|EX_USAGE
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
id|options
op_or_assign
id|symbol-&gt;info.condinfo-&gt;value
suffix:semicolon
)brace
id|cur_patch
op_assign
id|patch_list.stqh_first
suffix:semicolon
r_for
c_loop
(paren
id|cur_instr
op_assign
id|seq_program.stqh_first
suffix:semicolon
id|cur_instr
op_ne
l_int|NULL
suffix:semicolon
id|cur_instr
op_assign
id|cur_instr-&gt;links.stqe_next
comma
id|instrcount
op_increment
)paren
(brace
id|cur_patch
op_assign
id|next_patch
c_func
(paren
id|cur_patch
comma
id|options
comma
id|instrcount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_patch
op_logical_and
id|cur_patch-&gt;begin
op_le
id|instrcount
op_logical_and
id|cur_patch-&gt;end
OG
id|instrcount
)paren
multiline_comment|/* Don&squot;t count this instruction as it is in a patch&n;&t;&t;&t; * that was removed.&n;&t;&t;&t; */
r_continue
suffix:semicolon
r_while
c_loop
(paren
id|line
OL
id|cur_instr-&gt;srcline
)paren
(brace
id|fgets
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|ifile
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|listfile
comma
l_string|&quot;&bslash;t&bslash;t%s&quot;
comma
id|buf
)paren
suffix:semicolon
id|line
op_increment
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|listfile
comma
l_string|&quot;%03x %02x%02x%02x%02x&quot;
comma
id|instrptr
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|0
)braket
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|1
)braket
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|2
)braket
comma
id|cur_instr-&gt;format.bytes
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|fgets
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|ifile
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|listfile
comma
l_string|&quot;&bslash;t%s&quot;
comma
id|buf
)paren
suffix:semicolon
id|line
op_increment
suffix:semicolon
id|instrptr
op_increment
suffix:semicolon
)brace
multiline_comment|/* Dump the remainder of the file */
r_while
c_loop
(paren
id|fgets
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|ifile
)paren
op_ne
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|listfile
comma
l_string|&quot;&bslash;t&bslash;t%s&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
id|fclose
c_func
(paren
id|ifile
)paren
suffix:semicolon
)brace
r_static
r_struct
id|patch
op_star
DECL|function|next_patch
id|next_patch
c_func
(paren
id|cur_patch
comma
id|options
comma
id|instrptr
)paren
r_struct
id|patch
op_star
id|cur_patch
suffix:semicolon
r_int
id|options
suffix:semicolon
r_int
id|instrptr
suffix:semicolon
(brace
r_while
c_loop
(paren
id|cur_patch
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|cur_patch-&gt;options
op_amp
id|options
)paren
op_ne
l_int|0
op_logical_and
id|cur_patch-&gt;negative
op_eq
id|FALSE
)paren
op_logical_or
(paren
(paren
id|cur_patch-&gt;options
op_amp
id|options
)paren
op_eq
l_int|0
op_logical_and
id|cur_patch-&gt;negative
op_eq
id|TRUE
)paren
op_logical_or
(paren
id|instrptr
op_ge
id|cur_patch-&gt;end
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Either we want to keep this section of code,&n;&t;&t;&t; * or we have consumed this patch. Skip to the&n;&t;&t;&t; * next patch.&n;&t;&t;&t; */
id|cur_patch
op_assign
id|cur_patch-&gt;links.stqe_next
suffix:semicolon
)brace
r_else
multiline_comment|/* Found an okay patch */
r_break
suffix:semicolon
)brace
r_return
(paren
id|cur_patch
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Print out error information if appropriate, and clean up before&n; * terminating the program.&n; */
r_void
DECL|function|stop
id|stop
c_func
(paren
id|string
comma
id|err_code
)paren
r_const
r_char
op_star
id|string
suffix:semicolon
r_int
id|err_code
suffix:semicolon
(brace
r_if
c_cond
(paren
id|string
op_ne
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: &quot;
comma
id|appname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yyfilename
op_ne
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Stopped at file %s, line %d - &quot;
comma
id|yyfilename
comma
id|yylineno
)paren
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|string
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ofile
op_ne
l_int|NULL
)paren
(brace
id|fclose
c_func
(paren
id|ofile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err_code
op_ne
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: Removing %s due to error&bslash;n&quot;
comma
id|appname
comma
id|ofilename
)paren
suffix:semicolon
id|unlink
c_func
(paren
id|ofilename
)paren
suffix:semicolon
)brace
)brace
id|symlist_free
c_func
(paren
op_amp
id|patch_options
)paren
suffix:semicolon
id|symtable_close
c_func
(paren
)paren
suffix:semicolon
m_exit
(paren
id|err_code
)paren
suffix:semicolon
)brace
r_struct
id|instruction
op_star
DECL|function|seq_alloc
id|seq_alloc
c_func
(paren
)paren
(brace
r_struct
id|instruction
op_star
id|new_instr
suffix:semicolon
id|new_instr
op_assign
(paren
r_struct
id|instruction
op_star
)paren
id|malloc
c_func
(paren
r_sizeof
(paren
r_struct
id|instruction
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_instr
op_eq
l_int|NULL
)paren
id|stop
c_func
(paren
l_string|&quot;Unable to malloc instruction object&quot;
comma
id|EX_SOFTWARE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|new_instr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|new_instr
)paren
)paren
suffix:semicolon
id|STAILQ_INSERT_TAIL
c_func
(paren
op_amp
id|seq_program
comma
id|new_instr
comma
id|links
)paren
suffix:semicolon
id|new_instr-&gt;srcline
op_assign
id|yylineno
suffix:semicolon
r_return
id|new_instr
suffix:semicolon
)brace
id|patch_t
op_star
DECL|function|patch_alloc
id|patch_alloc
c_func
(paren
)paren
(brace
id|patch_t
op_star
id|new_patch
suffix:semicolon
id|new_patch
op_assign
(paren
id|patch_t
op_star
)paren
id|malloc
c_func
(paren
r_sizeof
(paren
id|patch_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_patch
op_eq
l_int|NULL
)paren
id|stop
c_func
(paren
l_string|&quot;Unable to malloc patch object&quot;
comma
id|EX_SOFTWARE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|new_patch
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|new_patch
)paren
)paren
suffix:semicolon
id|STAILQ_INSERT_TAIL
c_func
(paren
op_amp
id|patch_list
comma
id|new_patch
comma
id|links
)paren
suffix:semicolon
r_return
id|new_patch
suffix:semicolon
)brace
eof
