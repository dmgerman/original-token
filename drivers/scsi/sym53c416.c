multiline_comment|/* &n; *  sym53c416.c&n; *  Low-level SCSI driver for sym53c416 chip.&n; *  Copyright (C) 1998 Lieven Willems (lw_linux@hotmail.com)&n; * &n; *  Changes : &n; * &n; *  Marcelo Tosatti &lt;marcelo@conectiva.com.br&gt; : Added io_request_lock locking&n; * &n; *  LILO command line usage: sym53c416=&lt;PORTBASE&gt;[,&lt;IRQ&gt;]&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the&n; *  Free Software Foundation; either version 2, or (at your option) any&n; *  later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;sym53c416.h&quot;
DECL|macro|VERSION_STRING
mdefine_line|#define VERSION_STRING        &quot;Version 1.0.0&quot;
DECL|macro|TC_LOW
mdefine_line|#define TC_LOW       0x00     /* Transfer counter low        */
DECL|macro|TC_MID
mdefine_line|#define TC_MID       0x01     /* Transfer counter mid        */
DECL|macro|SCSI_FIFO
mdefine_line|#define SCSI_FIFO    0x02     /* SCSI FIFO register          */
DECL|macro|COMMAND_REG
mdefine_line|#define COMMAND_REG  0x03     /* Command Register            */
DECL|macro|STATUS_REG
mdefine_line|#define STATUS_REG   0x04     /* Status Register (READ)      */
DECL|macro|DEST_BUS_ID
mdefine_line|#define DEST_BUS_ID  0x04     /* Destination Bus ID (WRITE)  */
DECL|macro|INT_REG
mdefine_line|#define INT_REG      0x05     /* Interrupt Register (READ)   */
DECL|macro|TOM
mdefine_line|#define TOM          0x05     /* Time out multiplier (WRITE) */
DECL|macro|STP
mdefine_line|#define STP          0x06     /* Synchronous Transfer period */
DECL|macro|SYNC_OFFSET
mdefine_line|#define SYNC_OFFSET  0x07     /* Synchronous Offset          */
DECL|macro|CONF_REG_1
mdefine_line|#define CONF_REG_1   0x08     /* Configuration register 1    */
DECL|macro|CONF_REG_2
mdefine_line|#define CONF_REG_2   0x0B     /* Configuration register 2    */
DECL|macro|CONF_REG_3
mdefine_line|#define CONF_REG_3   0x0C     /* Configuration register 3    */
DECL|macro|CONF_REG_4
mdefine_line|#define CONF_REG_4   0x0D     /* Configuration register 4    */
DECL|macro|TC_HIGH
mdefine_line|#define TC_HIGH      0x0E     /* Transfer counter high       */
DECL|macro|PIO_FIFO_1
mdefine_line|#define PIO_FIFO_1   0x10     /* PIO FIFO register 1         */
DECL|macro|PIO_FIFO_2
mdefine_line|#define PIO_FIFO_2   0x11     /* PIO FIFO register 2         */
DECL|macro|PIO_FIFO_3
mdefine_line|#define PIO_FIFO_3   0x12     /* PIO FIFO register 3         */
DECL|macro|PIO_FIFO_4
mdefine_line|#define PIO_FIFO_4   0x13     /* PIO FIFO register 4         */
DECL|macro|PIO_FIFO_CNT
mdefine_line|#define PIO_FIFO_CNT 0x14     /* PIO FIFO count              */
DECL|macro|PIO_INT_REG
mdefine_line|#define PIO_INT_REG  0x15     /* PIO interrupt register      */
DECL|macro|CONF_REG_5
mdefine_line|#define CONF_REG_5   0x16     /* Configuration register 5    */
DECL|macro|FEATURE_EN
mdefine_line|#define FEATURE_EN   0x1D     /* Feature Enable register     */
multiline_comment|/* Configuration register 1 entries: */
multiline_comment|/* Bits 2-0: SCSI ID of host adapter */
DECL|macro|SCM
mdefine_line|#define SCM    0x80                     /* Slow Cable Mode              */
DECL|macro|SRID
mdefine_line|#define SRID   0x40                     /* SCSI Reset Interrupt Disable */
DECL|macro|PTM
mdefine_line|#define PTM    0x20                     /* Parity Test Mode             */
DECL|macro|EPC
mdefine_line|#define EPC    0x10                     /* Enable Parity Checking       */
DECL|macro|CTME
mdefine_line|#define CTME   0x08                     /* Special Test Mode            */
multiline_comment|/* Configuration register 2 entries: */
DECL|macro|FE
mdefine_line|#define FE     0x40                     /* Features Enable              */
DECL|macro|SCSI2
mdefine_line|#define SCSI2  0x08                     /* SCSI 2 Enable                */
DECL|macro|TBPA
mdefine_line|#define TBPA   0x04                     /* Target Bad Parity Abort      */
multiline_comment|/* Configuration register 3 entries: */
DECL|macro|IDMRC
mdefine_line|#define IDMRC  0x80                     /* ID Message Reserved Check    */
DECL|macro|QTE
mdefine_line|#define QTE    0x40                     /* Queue Tag Enable             */
DECL|macro|CDB10
mdefine_line|#define CDB10  0x20                     /* Command Descriptor Block 10  */
DECL|macro|FSCSI
mdefine_line|#define FSCSI  0x10                     /* FastSCSI                     */
DECL|macro|FCLK
mdefine_line|#define FCLK   0x08                     /* FastClock                    */
multiline_comment|/* Configuration register 4 entries: */
DECL|macro|RBS
mdefine_line|#define RBS    0x08                     /* Register bank select         */
DECL|macro|EAN
mdefine_line|#define EAN    0x04                     /* Enable Active Negotiation    */
multiline_comment|/* Configuration register 5 entries: */
DECL|macro|LPSR
mdefine_line|#define LPSR   0x80                     /* Lower Power SCSI Reset       */
DECL|macro|IE
mdefine_line|#define IE     0x20                     /* Interrupt Enable             */
DECL|macro|LPM
mdefine_line|#define LPM    0x02                     /* Low Power Mode               */
DECL|macro|WSE0
mdefine_line|#define WSE0   0x01                     /* 0WS Enable                   */
multiline_comment|/* Interrupt register entries: */
DECL|macro|SRST
mdefine_line|#define SRST   0x80                     /* SCSI Reset                   */
DECL|macro|ILCMD
mdefine_line|#define ILCMD  0x40                     /* Illegal Command              */
DECL|macro|DIS
mdefine_line|#define DIS    0x20                     /* Disconnect                   */
DECL|macro|BS
mdefine_line|#define BS     0x10                     /* Bus Service                  */
DECL|macro|FC
mdefine_line|#define FC     0x08                     /* Function Complete            */
DECL|macro|RESEL
mdefine_line|#define RESEL  0x04                     /* Reselected                   */
DECL|macro|SI
mdefine_line|#define SI     0x03                     /* Selection Interrupt          */
multiline_comment|/* Status Register Entries: */
DECL|macro|SCI
mdefine_line|#define SCI    0x80                     /* SCSI Core Int                */
DECL|macro|GE
mdefine_line|#define GE     0x40                     /* Gross Error                  */
DECL|macro|PE
mdefine_line|#define PE     0x20                     /* Parity Error                 */
DECL|macro|TC
mdefine_line|#define TC     0x10                     /* Terminal Count               */
DECL|macro|VGC
mdefine_line|#define VGC    0x08                     /* Valid Group Code             */
DECL|macro|PHBITS
mdefine_line|#define PHBITS 0x07                     /* Phase bits                   */
multiline_comment|/* PIO Interrupt Register Entries: */
DECL|macro|SCI
mdefine_line|#define SCI    0x80                     /* SCSI Core Int                */
DECL|macro|PFI
mdefine_line|#define PFI    0x40                     /* PIO FIFO Interrupt           */
DECL|macro|FULL
mdefine_line|#define FULL   0x20                     /* PIO FIFO Full                */
DECL|macro|EMPTY
mdefine_line|#define EMPTY  0x10                     /* PIO FIFO Empty               */
DECL|macro|CE
mdefine_line|#define CE     0x08                     /* Collision Error              */
DECL|macro|OUE
mdefine_line|#define OUE    0x04                     /* Overflow / Underflow error   */
DECL|macro|FIE
mdefine_line|#define FIE    0x02                     /* Full Interrupt Enable        */
DECL|macro|EIE
mdefine_line|#define EIE    0x01                     /* Empty Interrupt Enable       */
multiline_comment|/* SYM53C416 SCSI phases (lower 3 bits of SYM53C416_STATUS_REG) */
DECL|macro|PHASE_DATA_OUT
mdefine_line|#define PHASE_DATA_OUT    0x00
DECL|macro|PHASE_DATA_IN
mdefine_line|#define PHASE_DATA_IN     0x01
DECL|macro|PHASE_COMMAND
mdefine_line|#define PHASE_COMMAND     0x02
DECL|macro|PHASE_STATUS
mdefine_line|#define PHASE_STATUS      0x03
DECL|macro|PHASE_RESERVED_1
mdefine_line|#define PHASE_RESERVED_1  0x04
DECL|macro|PHASE_RESERVED_2
mdefine_line|#define PHASE_RESERVED_2  0x05
DECL|macro|PHASE_MESSAGE_OUT
mdefine_line|#define PHASE_MESSAGE_OUT 0x06
DECL|macro|PHASE_MESSAGE_IN
mdefine_line|#define PHASE_MESSAGE_IN  0x07
multiline_comment|/* SYM53C416 core commands */
DECL|macro|NOOP
mdefine_line|#define NOOP                      0x00
DECL|macro|FLUSH_FIFO
mdefine_line|#define FLUSH_FIFO                0x01
DECL|macro|RESET_CHIP
mdefine_line|#define RESET_CHIP                0x02
DECL|macro|RESET_SCSI_BUS
mdefine_line|#define RESET_SCSI_BUS            0x03
DECL|macro|DISABLE_SEL_RESEL
mdefine_line|#define DISABLE_SEL_RESEL         0x45
DECL|macro|RESEL_SEQ
mdefine_line|#define RESEL_SEQ                 0x40
DECL|macro|SEL_WITHOUT_ATN_SEQ
mdefine_line|#define SEL_WITHOUT_ATN_SEQ       0x41
DECL|macro|SEL_WITH_ATN_SEQ
mdefine_line|#define SEL_WITH_ATN_SEQ          0x42
DECL|macro|SEL_WITH_ATN_AND_STOP_SEQ
mdefine_line|#define SEL_WITH_ATN_AND_STOP_SEQ 0x43
DECL|macro|ENABLE_SEL_RESEL
mdefine_line|#define ENABLE_SEL_RESEL          0x44
DECL|macro|SEL_WITH_ATN3_SEQ
mdefine_line|#define SEL_WITH_ATN3_SEQ         0x46
DECL|macro|RESEL3_SEQ
mdefine_line|#define RESEL3_SEQ                0x47
DECL|macro|SND_MSG
mdefine_line|#define SND_MSG                   0x20
DECL|macro|SND_STAT
mdefine_line|#define SND_STAT                  0x21
DECL|macro|SND_DATA
mdefine_line|#define SND_DATA                  0x22
DECL|macro|DISCONNECT_SEQ
mdefine_line|#define DISCONNECT_SEQ            0x23
DECL|macro|TERMINATE_SEQ
mdefine_line|#define TERMINATE_SEQ             0x24
DECL|macro|TARGET_COMM_COMPLETE_SEQ
mdefine_line|#define TARGET_COMM_COMPLETE_SEQ  0x25
DECL|macro|DISCONN
mdefine_line|#define DISCONN                   0x27
DECL|macro|RECV_MSG_SEQ
mdefine_line|#define RECV_MSG_SEQ              0x28
DECL|macro|RECV_CMD
mdefine_line|#define RECV_CMD                  0x29
DECL|macro|RECV_DATA
mdefine_line|#define RECV_DATA                 0x2A
DECL|macro|RECV_CMD_SEQ
mdefine_line|#define RECV_CMD_SEQ              0x2B
DECL|macro|TARGET_ABORT_PIO
mdefine_line|#define TARGET_ABORT_PIO          0x04
DECL|macro|TRANSFER_INFORMATION
mdefine_line|#define TRANSFER_INFORMATION      0x10
DECL|macro|INIT_COMM_COMPLETE_SEQ
mdefine_line|#define INIT_COMM_COMPLETE_SEQ    0x11
DECL|macro|MSG_ACCEPTED
mdefine_line|#define MSG_ACCEPTED              0x12
DECL|macro|TRANSFER_PAD
mdefine_line|#define TRANSFER_PAD              0x18
DECL|macro|SET_ATN
mdefine_line|#define SET_ATN                   0x1A
DECL|macro|RESET_ATN
mdefine_line|#define RESET_ATN                 0x1B
DECL|macro|ILLEGAL
mdefine_line|#define ILLEGAL                   0xFF
DECL|macro|PIO_MODE
mdefine_line|#define PIO_MODE                  0x80
DECL|macro|IO_RANGE
mdefine_line|#define IO_RANGE 0x20         /* 0x00 - 0x1F                   */
DECL|macro|ID
mdefine_line|#define ID       &quot;sym53c416&quot;&t;/* Attention: copied to the sym53c416.h */
DECL|macro|PIO_SIZE
mdefine_line|#define PIO_SIZE 128          /* Size of PIO fifo is 128 bytes */
DECL|macro|READ_TIMEOUT
mdefine_line|#define READ_TIMEOUT              150
DECL|macro|WRITE_TIMEOUT
mdefine_line|#define WRITE_TIMEOUT             150
macro_line|#ifdef MODULE
DECL|macro|sym53c416_base
mdefine_line|#define sym53c416_base sym53c416
DECL|macro|sym53c416_base_1
mdefine_line|#define sym53c416_base_1 sym53c416_1
DECL|macro|sym53c416_base_2
mdefine_line|#define sym53c416_base_2 sym53c416_2
DECL|macro|sym53c416_base_3
mdefine_line|#define sym53c416_base_3 sym53c416_3
DECL|variable|sym53c416_base
r_static
r_int
r_int
id|sym53c416_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_irq
r_static
r_int
r_int
id|sym53c416_irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_base_1
r_static
r_int
r_int
id|sym53c416_base_1
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_irq_1
r_static
r_int
r_int
id|sym53c416_irq_1
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_base_2
r_static
r_int
r_int
id|sym53c416_base_2
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_irq_2
r_static
r_int
r_int
id|sym53c416_irq_2
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_base_3
r_static
r_int
r_int
id|sym53c416_base_3
op_assign
l_int|0
suffix:semicolon
DECL|variable|sym53c416_irq_3
r_static
r_int
r_int
id|sym53c416_irq_3
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* #define DEBUG */
multiline_comment|/* Macro for debugging purposes */
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
DECL|macro|MAXHOSTS
mdefine_line|#define MAXHOSTS 4
DECL|enum|phases
r_enum
id|phases
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|data_out
id|data_out
comma
DECL|enumerator|data_in
id|data_in
comma
DECL|enumerator|command_ph
id|command_ph
comma
DECL|enumerator|status_ph
id|status_ph
comma
DECL|enumerator|message_out
id|message_out
comma
DECL|enumerator|message_in
id|message_in
)brace
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|scsi_id
r_int
id|scsi_id
suffix:semicolon
DECL|typedef|host
)brace
id|host
suffix:semicolon
DECL|variable|hosts
id|host
id|hosts
(braket
id|MAXHOSTS
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
id|SYM53C416_SCSI_ID
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
id|SYM53C416_SCSI_ID
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
id|SYM53C416_SCSI_ID
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
id|SYM53C416_SCSI_ID
)brace
)brace
suffix:semicolon
DECL|variable|host_index
r_static
r_int
id|host_index
op_assign
l_int|0
suffix:semicolon
DECL|variable|info
r_static
r_char
id|info
(braket
l_int|120
)braket
suffix:semicolon
DECL|variable|current_command
r_static
id|Scsi_Cmnd
op_star
id|current_command
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|fastpio
r_int
id|fastpio
op_assign
l_int|1
suffix:semicolon
DECL|variable|probeaddrs
r_int
id|probeaddrs
(braket
)braket
op_assign
(brace
l_int|0x200
comma
l_int|0x220
comma
l_int|0x240
comma
l_int|0
)brace
suffix:semicolon
DECL|function|sym53c416_set_transfer_counter
r_static
r_void
id|sym53c416_set_transfer_counter
c_func
(paren
r_int
id|base
comma
r_int
r_int
id|len
)paren
(brace
multiline_comment|/* Program Transfer Counter */
id|outb
c_func
(paren
id|len
op_amp
l_int|0x0000FF
comma
id|base
op_plus
id|TC_LOW
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|len
op_amp
l_int|0x00FF00
)paren
op_rshift
l_int|8
comma
id|base
op_plus
id|TC_MID
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|len
op_amp
l_int|0xFF0000
)paren
op_rshift
l_int|16
comma
id|base
op_plus
id|TC_HIGH
)paren
suffix:semicolon
)brace
multiline_comment|/* Returns the number of bytes read */
DECL|function|sym53c416_read
r_static
id|__inline__
r_int
r_int
id|sym53c416_read
c_func
(paren
r_int
id|base
comma
r_int
r_char
op_star
id|buffer
comma
r_int
r_int
id|len
)paren
(brace
r_int
r_int
id|orig_len
op_assign
id|len
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|bytes_left
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|timeout
op_assign
id|READ_TIMEOUT
suffix:semicolon
multiline_comment|/* Do transfer */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|timeout
)paren
(brace
id|bytes_left
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|PIO_FIFO_CNT
)paren
suffix:semicolon
multiline_comment|/* Number of bytes in the PIO FIFO */
r_if
c_cond
(paren
id|fastpio
op_logical_and
id|bytes_left
OG
l_int|3
)paren
(brace
id|insl
c_func
(paren
id|base
op_plus
id|PIO_FIFO_1
comma
id|buffer
comma
id|bytes_left
op_rshift
l_int|2
)paren
suffix:semicolon
id|buffer
op_add_assign
id|bytes_left
op_amp
l_int|0xFC
suffix:semicolon
id|len
op_sub_assign
id|bytes_left
op_amp
l_int|0xFC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bytes_left
OG
l_int|0
)paren
(brace
id|len
op_sub_assign
id|bytes_left
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|bytes_left
OG
l_int|0
suffix:semicolon
id|bytes_left
op_decrement
)paren
(brace
op_star
(paren
id|buffer
op_increment
)paren
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|PIO_FIFO_1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|i
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|i
op_logical_and
(paren
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
op_amp
id|EMPTY
)paren
op_logical_and
id|timeout
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
op_amp
id|SCI
)paren
(brace
id|timeout
op_assign
l_int|0
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
op_amp
id|EMPTY
)paren
(brace
id|timeout
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|orig_len
op_minus
id|len
suffix:semicolon
)brace
multiline_comment|/* Returns the number of bytes written */
DECL|function|sym53c416_write
r_static
id|__inline__
r_int
r_int
id|sym53c416_write
c_func
(paren
r_int
id|base
comma
r_int
r_char
op_star
id|buffer
comma
r_int
r_int
id|len
)paren
(brace
r_int
r_int
id|orig_len
op_assign
id|len
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|bufferfree
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
r_int
id|timeout
op_assign
id|WRITE_TIMEOUT
suffix:semicolon
multiline_comment|/* Do transfer */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|timeout
)paren
(brace
id|bufferfree
op_assign
id|PIO_SIZE
op_minus
id|inb
c_func
(paren
id|base
op_plus
id|PIO_FIFO_CNT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufferfree
OG
id|len
)paren
(brace
id|bufferfree
op_assign
id|len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fastpio
op_logical_and
id|bufferfree
OG
l_int|3
)paren
(brace
id|outsl
c_func
(paren
id|base
op_plus
id|PIO_FIFO_1
comma
id|buffer
comma
id|bufferfree
op_rshift
l_int|2
)paren
suffix:semicolon
id|buffer
op_add_assign
id|bufferfree
op_amp
l_int|0xFC
suffix:semicolon
id|len
op_sub_assign
id|bufferfree
op_amp
l_int|0xFC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bufferfree
OG
l_int|0
)paren
(brace
id|len
op_sub_assign
id|bufferfree
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|bufferfree
OG
l_int|0
suffix:semicolon
id|bufferfree
op_decrement
)paren
(brace
id|outb
c_func
(paren
op_star
(paren
id|buffer
op_increment
)paren
comma
id|base
op_plus
id|PIO_FIFO_1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|i
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|i
op_logical_and
(paren
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
op_amp
id|FULL
)paren
op_logical_and
id|timeout
)paren
(brace
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
op_amp
id|FULL
)paren
(brace
id|timeout
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|orig_len
op_minus
id|len
suffix:semicolon
)brace
DECL|function|sym53c416_intr_handle
r_static
r_void
id|sym53c416_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|base
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|status_reg
comma
id|pio_int_reg
comma
id|int_reg
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
r_int
r_int
id|sgcount
suffix:semicolon
r_int
r_int
id|tot_trans
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We search the base address of the host adapter which caused the interrupt */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_index
op_logical_and
op_logical_neg
id|base
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|irq
op_eq
id|hosts
(braket
id|i
)braket
dot
id|irq
)paren
(brace
id|base
op_assign
id|hosts
(braket
id|i
)braket
dot
id|base
suffix:semicolon
)brace
multiline_comment|/* If no adapter found, we cannot handle the interrupt. Leave a message */
multiline_comment|/* and continue. This should never happen...                            */
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: No host adapter defined for interrupt %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Now we have the base address and we can start handling the interrupt */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|status_reg
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|STATUS_REG
)paren
suffix:semicolon
id|pio_int_reg
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
suffix:semicolon
id|int_reg
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|INT_REG
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* First, we handle error conditions */
r_if
c_cond
(paren
id|int_reg
op_amp
id|SCI
)paren
multiline_comment|/* SCSI Reset */
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: Reset received&bslash;n&quot;
)paren
suffix:semicolon
id|current_command-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_command-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|current_command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|int_reg
op_amp
id|ILCMD
)paren
multiline_comment|/* Illegal Command */
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: Illegal Command: 0x%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|base
op_plus
id|COMMAND_REG
)paren
)paren
suffix:semicolon
id|current_command-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_command-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|current_command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg
op_amp
id|GE
)paren
multiline_comment|/* Gross Error */
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: Gross Error&bslash;n&quot;
)paren
suffix:semicolon
id|current_command-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_command-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|current_command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg
op_amp
id|PE
)paren
multiline_comment|/* Parity Error */
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: Parity Error&bslash;n&quot;
)paren
suffix:semicolon
id|current_command-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_command-&gt;result
op_assign
id|DID_PARITY
op_lshift
l_int|16
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|current_command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pio_int_reg
op_amp
(paren
id|CE
op_or
id|OUE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: PIO Interrupt Error&bslash;n&quot;
)paren
suffix:semicolon
id|current_command-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_command-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|current_command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|int_reg
op_amp
id|DIS
)paren
multiline_comment|/* Disconnect */
(brace
r_if
c_cond
(paren
id|current_command-&gt;SCp.phase
op_ne
id|message_in
)paren
(brace
id|current_command-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
id|current_command-&gt;result
op_assign
(paren
id|current_command-&gt;SCp.Status
op_amp
l_int|0xFF
)paren
op_or
(paren
(paren
id|current_command-&gt;SCp.Message
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|current_command-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|current_command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Now we handle SCSI phases         */
r_switch
c_cond
(paren
id|status_reg
op_amp
id|PHBITS
)paren
multiline_comment|/* Filter SCSI phase out of status reg */
(brace
r_case
id|PHASE_DATA_OUT
suffix:colon
(brace
r_if
c_cond
(paren
id|int_reg
op_amp
id|BS
)paren
(brace
id|current_command-&gt;SCp.phase
op_assign
id|data_out
suffix:semicolon
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|sym53c416_set_transfer_counter
c_func
(paren
id|base
comma
id|current_command-&gt;request_bufflen
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TRANSFER_INFORMATION
op_or
id|PIO_MODE
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|current_command-&gt;use_sg
)paren
(brace
id|tot_trans
op_assign
id|sym53c416_write
c_func
(paren
id|base
comma
id|current_command-&gt;request_buffer
comma
id|current_command-&gt;request_bufflen
)paren
suffix:semicolon
)brace
r_else
(brace
id|sgcount
op_assign
id|current_command-&gt;use_sg
suffix:semicolon
id|sglist
op_assign
id|current_command-&gt;request_buffer
suffix:semicolon
r_while
c_loop
(paren
id|sgcount
op_decrement
)paren
(brace
id|tot_trans
op_add_assign
id|sym53c416_write
c_func
(paren
id|base
comma
id|sglist-&gt;address
comma
id|sglist-&gt;length
)paren
suffix:semicolon
id|sglist
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tot_trans
OL
id|current_command-&gt;underflow
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: underflow, wrote %d bytes, request for %d bytes&bslash;n&quot;
comma
id|tot_trans
comma
id|current_command-&gt;underflow
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_case
id|PHASE_DATA_IN
suffix:colon
(brace
r_if
c_cond
(paren
id|int_reg
op_amp
id|BS
)paren
(brace
id|current_command-&gt;SCp.phase
op_assign
id|data_in
suffix:semicolon
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|sym53c416_set_transfer_counter
c_func
(paren
id|base
comma
id|current_command-&gt;request_bufflen
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TRANSFER_INFORMATION
op_or
id|PIO_MODE
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|current_command-&gt;use_sg
)paren
(brace
id|tot_trans
op_assign
id|sym53c416_read
c_func
(paren
id|base
comma
id|current_command-&gt;request_buffer
comma
id|current_command-&gt;request_bufflen
)paren
suffix:semicolon
)brace
r_else
(brace
id|sgcount
op_assign
id|current_command-&gt;use_sg
suffix:semicolon
id|sglist
op_assign
id|current_command-&gt;request_buffer
suffix:semicolon
r_while
c_loop
(paren
id|sgcount
op_decrement
)paren
(brace
id|tot_trans
op_add_assign
id|sym53c416_read
c_func
(paren
id|base
comma
id|sglist-&gt;address
comma
id|sglist-&gt;length
)paren
suffix:semicolon
id|sglist
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tot_trans
OL
id|current_command-&gt;underflow
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: underflow, read %d bytes, request for %d bytes&bslash;n&quot;
comma
id|tot_trans
comma
id|current_command-&gt;underflow
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_case
id|PHASE_COMMAND
suffix:colon
(brace
id|current_command-&gt;SCp.phase
op_assign
id|command_ph
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: Unknown interrupt in command phase&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|PHASE_STATUS
suffix:colon
(brace
id|current_command-&gt;SCp.phase
op_assign
id|status_ph
suffix:semicolon
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|INIT_COMM_COMPLETE_SEQ
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|PHASE_RESERVED_1
suffix:colon
r_case
id|PHASE_RESERVED_2
suffix:colon
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416: Warning: Reserved phase&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|PHASE_MESSAGE_OUT
suffix:colon
(brace
id|current_command-&gt;SCp.phase
op_assign
id|message_out
suffix:semicolon
id|outb
c_func
(paren
id|SET_ATN
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MSG_ACCEPTED
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|PHASE_MESSAGE_IN
suffix:colon
(brace
id|current_command-&gt;SCp.phase
op_assign
id|message_in
suffix:semicolon
id|current_command-&gt;SCp.Status
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|SCSI_FIFO
)paren
suffix:semicolon
id|current_command-&gt;SCp.Message
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|SCSI_FIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_command-&gt;SCp.Message
op_eq
id|SAVE_POINTERS
op_logical_or
id|current_command-&gt;SCp.Message
op_eq
id|DISCONNECT
)paren
(brace
id|outb
c_func
(paren
id|SET_ATN
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|MSG_ACCEPTED
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|sym53c416_init
r_static
r_void
id|sym53c416_init
c_func
(paren
r_int
id|base
comma
r_int
id|scsi_id
)paren
(brace
id|outb
c_func
(paren
id|RESET_CHIP
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NOOP
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x99
comma
id|base
op_plus
id|TOM
)paren
suffix:semicolon
multiline_comment|/* Time out of 250 ms */
id|outb
c_func
(paren
l_int|0x05
comma
id|base
op_plus
id|STP
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|base
op_plus
id|SYNC_OFFSET
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EPC
op_or
id|scsi_id
comma
id|base
op_plus
id|CONF_REG_1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FE
op_or
id|SCSI2
op_or
id|TBPA
comma
id|base
op_plus
id|CONF_REG_2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IDMRC
op_or
id|QTE
op_or
id|CDB10
op_or
id|FSCSI
op_or
id|FCLK
comma
id|base
op_plus
id|CONF_REG_3
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x83
op_or
id|EAN
comma
id|base
op_plus
id|CONF_REG_4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IE
op_or
id|WSE0
comma
id|base
op_plus
id|CONF_REG_5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|base
op_plus
id|FEATURE_EN
)paren
suffix:semicolon
)brace
DECL|function|sym53c416_probeirq
r_static
r_int
id|sym53c416_probeirq
c_func
(paren
r_int
id|base
comma
r_int
id|scsi_id
)paren
(brace
r_int
id|irq
comma
id|irqs
comma
id|i
suffix:semicolon
multiline_comment|/* Clear interrupt register */
id|inb
c_func
(paren
id|base
op_plus
id|INT_REG
)paren
suffix:semicolon
multiline_comment|/* Start probing for irq&squot;s */
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Reinit chip */
id|sym53c416_init
c_func
(paren
id|base
comma
id|scsi_id
)paren
suffix:semicolon
multiline_comment|/* Cause interrupt */
id|outb
c_func
(paren
id|NOOP
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ILLEGAL
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x07
comma
id|base
op_plus
id|DEST_BUS_ID
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|base
op_plus
id|DEST_BUS_ID
)paren
suffix:semicolon
multiline_comment|/* Wait for interrupt to occur */
id|i
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
r_while
c_loop
(paren
id|i
OG
id|jiffies
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|STATUS_REG
)paren
op_amp
id|SCI
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_le
id|jiffies
)paren
(brace
multiline_comment|/* timed out */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get occurred irq */
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
id|sym53c416_init
c_func
(paren
id|base
comma
id|scsi_id
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
multiline_comment|/* Setup: sym53c416=base,irq */
DECL|function|sym53c416_setup
r_void
id|sym53c416_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|host_index
op_ge
id|MAXHOSTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416.c: Too many hosts defined&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
template_param
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416.c: Wrong number of parameters:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sym53c416.c: usage: sym53c416=&lt;base&gt;[,&lt;irq&gt;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_index
op_logical_and
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
op_eq
id|ints
(braket
l_int|1
)braket
)paren
(brace
id|i
op_assign
op_minus
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
(brace
id|hosts
(braket
id|host_index
)braket
dot
id|base
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|hosts
(braket
id|host_index
)braket
dot
id|irq
op_assign
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|2
)paren
ques
c_cond
id|ints
(braket
l_int|2
)braket
suffix:colon
l_int|0
suffix:semicolon
id|host_index
op_increment
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|sym53c416_test
r_static
r_int
id|sym53c416_test
c_func
(paren
r_int
id|base
)paren
(brace
id|outb
c_func
(paren
id|RESET_CHIP
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NOOP
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|COMMAND_REG
)paren
op_ne
id|NOOP
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|inb
c_func
(paren
id|base
op_plus
id|TC_HIGH
)paren
op_logical_or
id|inb
c_func
(paren
id|base
op_plus
id|TC_HIGH
)paren
op_eq
l_int|0xFF
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|base
op_plus
id|PIO_INT_REG
)paren
op_amp
(paren
id|FULL
op_or
id|EMPTY
op_or
id|CE
op_or
id|OUE
op_or
id|FIE
op_or
id|EIE
)paren
)paren
op_ne
id|EMPTY
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sym53c416_probe
r_void
id|sym53c416_probe
c_func
(paren
r_void
)paren
(brace
r_int
op_star
id|base
op_assign
id|probeaddrs
suffix:semicolon
r_int
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|ints
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|base
suffix:semicolon
id|base
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|check_region
c_func
(paren
op_star
id|base
comma
id|IO_RANGE
)paren
op_logical_and
id|sym53c416_test
c_func
(paren
op_star
id|base
)paren
)paren
(brace
id|ints
(braket
l_int|1
)braket
op_assign
op_star
id|base
suffix:semicolon
id|sym53c416_setup
c_func
(paren
l_int|NULL
comma
id|ints
)paren
suffix:semicolon
)brace
)brace
DECL|function|sym53c416_detect
r_int
id|sym53c416_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|count
suffix:semicolon
macro_line|#ifdef MODULE
r_int
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|ints
(braket
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|sym53c416_base
)paren
(brace
id|ints
(braket
l_int|1
)braket
op_assign
id|sym53c416_base
suffix:semicolon
id|ints
(braket
l_int|2
)braket
op_assign
id|sym53c416_irq
suffix:semicolon
id|sym53c416_setup
c_func
(paren
l_int|NULL
comma
id|ints
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sym53c416_base_1
)paren
(brace
id|ints
(braket
l_int|1
)braket
op_assign
id|sym53c416_base_1
suffix:semicolon
id|ints
(braket
l_int|2
)braket
op_assign
id|sym53c416_irq_1
suffix:semicolon
id|sym53c416_setup
c_func
(paren
l_int|NULL
comma
id|ints
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sym53c416_base_2
)paren
(brace
id|ints
(braket
l_int|1
)braket
op_assign
id|sym53c416_base_2
suffix:semicolon
id|ints
(braket
l_int|2
)braket
op_assign
id|sym53c416_irq_2
suffix:semicolon
id|sym53c416_setup
c_func
(paren
l_int|NULL
comma
id|ints
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sym53c416_base_3
)paren
(brace
id|ints
(braket
l_int|1
)braket
op_assign
id|sym53c416_base_3
suffix:semicolon
id|ints
(braket
l_int|2
)braket
op_assign
id|sym53c416_irq_3
suffix:semicolon
id|sym53c416_setup
c_func
(paren
l_int|NULL
comma
id|ints
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;sym53c416.c: %s&bslash;n&quot;
comma
id|VERSION_STRING
)paren
suffix:semicolon
id|sym53c416_probe
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now we register and set up each host adapter found... */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_index
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|sym53c416_test
c_func
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No sym53c416 found at address 0x%03x&bslash;n&quot;
comma
id|hosts
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hosts
(braket
id|i
)braket
dot
id|irq
op_eq
l_int|0
)paren
multiline_comment|/* We don&squot;t have an irq yet, so we should probe for one */
r_if
c_cond
(paren
(paren
id|hosts
(braket
id|i
)braket
dot
id|irq
op_assign
id|sym53c416_probeirq
c_func
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
comma
id|hosts
(braket
id|i
)braket
dot
id|scsi_id
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;irq autoprobing failed for sym53c416 at address 0x%03x&bslash;n&quot;
comma
id|hosts
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hosts
(braket
id|i
)braket
dot
id|irq
op_logical_and
op_logical_neg
id|check_region
c_func
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
comma
id|IO_RANGE
)paren
)paren
(brace
id|shpnt
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shpnt
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Request for specified IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hosts
(braket
id|i
)braket
dot
id|irq
comma
id|sym53c416_intr_handle
comma
l_int|0
comma
id|ID
comma
l_int|NULL
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Unable to assign IRQ %d&bslash;n&quot;
comma
id|hosts
(braket
id|i
)braket
dot
id|irq
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Inform the kernel of our IO range */
id|request_region
c_func
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
comma
id|IO_RANGE
comma
id|ID
)paren
suffix:semicolon
id|shpnt-&gt;unique_id
op_assign
id|hosts
(braket
id|i
)braket
dot
id|base
suffix:semicolon
id|shpnt-&gt;io_port
op_assign
id|hosts
(braket
id|i
)braket
dot
id|base
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
id|IO_RANGE
suffix:semicolon
id|shpnt-&gt;irq
op_assign
id|hosts
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
id|shpnt-&gt;this_id
op_assign
id|hosts
(braket
id|i
)braket
dot
id|scsi_id
suffix:semicolon
id|sym53c416_init
c_func
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
comma
id|hosts
(braket
id|i
)braket
dot
id|scsi_id
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|sym53c416_info
r_const
r_char
op_star
id|sym53c416_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SChost
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|base
op_assign
id|SChost-&gt;io_port
suffix:semicolon
r_int
id|irq
op_assign
id|SChost-&gt;irq
suffix:semicolon
r_int
id|scsi_id
op_assign
l_int|0
suffix:semicolon
r_int
id|rev
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|TC_HIGH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_index
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
op_eq
id|base
)paren
(brace
id|scsi_id
op_assign
id|hosts
(braket
id|i
)braket
dot
id|scsi_id
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|info
comma
l_string|&quot;Symbios Logic 53c416 (rev. %d) at 0x%03x, irq %d, SCSI-ID %d, %s pio&quot;
comma
id|rev
comma
id|base
comma
id|irq
comma
id|scsi_id
comma
(paren
id|fastpio
)paren
ques
c_cond
l_string|&quot;fast&quot;
suffix:colon
l_string|&quot;slow&quot;
)paren
suffix:semicolon
r_return
id|info
suffix:semicolon
)brace
DECL|function|sym53c416_queuecommand
r_int
id|sym53c416_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
id|base
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Store base register as we can have more than one controller in the system */
id|base
op_assign
id|SCpnt-&gt;host-&gt;io_port
suffix:semicolon
id|current_command
op_assign
id|SCpnt
suffix:semicolon
multiline_comment|/* set current command                */
id|current_command-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* set ptr to done function           */
id|current_command-&gt;SCp.phase
op_assign
id|command_ph
suffix:semicolon
multiline_comment|/* currect phase is the command phase */
id|current_command-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
id|current_command-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SCpnt-&gt;target
comma
id|base
op_plus
id|DEST_BUS_ID
)paren
suffix:semicolon
multiline_comment|/* Set scsi id target        */
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
multiline_comment|/* Flush SCSI and PIO FIFO&squot;s */
multiline_comment|/* Write SCSI command into the SCSI fifo */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
id|i
)braket
comma
id|base
op_plus
id|SCSI_FIFO
)paren
suffix:semicolon
)brace
multiline_comment|/* Start selection sequence */
id|outb
c_func
(paren
id|SEL_WITHOUT_ATN_SEQ
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
multiline_comment|/* Now an interrupt will be generated which we will catch in out interrupt routine */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|SCpnt-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
DECL|function|sym53c416_command
r_int
id|sym53c416_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|sym53c416_queuecommand
c_func
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCpnt-&gt;SCp.Status
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
DECL|function|sym53c416_abort
r_int
id|sym53c416_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sym53c416_abort&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t know how to abort for the moment */
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
DECL|function|sym53c416_reset
r_int
id|sym53c416_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
r_int
id|base
suffix:semicolon
r_int
id|scsi_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sym53c416_reset&bslash;n&quot;
)paren
suffix:semicolon
id|base
op_assign
id|SCpnt-&gt;host-&gt;io_port
suffix:semicolon
multiline_comment|/* search scsi_id */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_index
op_logical_and
id|scsi_id
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hosts
(braket
id|i
)braket
dot
id|base
op_eq
id|base
)paren
(brace
id|scsi_id
op_assign
id|hosts
(braket
id|i
)braket
dot
id|scsi_id
suffix:semicolon
)brace
id|outb
c_func
(paren
id|RESET_CHIP
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NOOP
op_or
id|PIO_MODE
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RESET_SCSI_BUS
comma
id|base
op_plus
id|COMMAND_REG
)paren
suffix:semicolon
id|sym53c416_init
c_func
(paren
id|base
comma
id|scsi_id
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
DECL|function|sym53c416_bios_param
r_int
id|sym53c416_bios_param
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|ip
)paren
(brace
r_int
id|size
suffix:semicolon
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|ip
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* heads                        */
id|ip
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* sectors                      */
r_if
c_cond
(paren
(paren
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
)paren
OG
l_int|1024
)paren
multiline_comment|/* cylinders, test for big disk */
(brace
id|ip
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* heads                        */
id|ip
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
multiline_comment|/* sectors                      */
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
multiline_comment|/* cylinders                    */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Loadable module support */
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Lieven Willems&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sym53c416
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sym53c416_1
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sym53c416_2
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sym53c416_3
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|SYM53C416
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
