macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/zorro.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;wd33c93.h&quot;
macro_line|#include &quot;gvp11.h&quot;
macro_line|#include&lt;linux/stat.h&gt;
DECL|variable|proc_scsi_gvp11
r_struct
id|proc_dir_entry
id|proc_scsi_gvp11
op_assign
(brace
id|PROC_SCSI_GVP11
comma
l_int|5
comma
l_string|&quot;GVP11&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
DECL|macro|DMA
mdefine_line|#define DMA(ptr) ((gvp11_scsiregs *)((ptr)-&gt;base))
DECL|macro|HDATA
mdefine_line|#define HDATA(ptr) ((struct WD33C93_hostdata *)((ptr)-&gt;hostdata))
DECL|variable|first_instance
r_static
r_struct
id|Scsi_Host
op_star
id|first_instance
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|gvp11_template
r_static
id|Scsi_Host_Template
op_star
id|gvp11_template
suffix:semicolon
DECL|function|gvp11_intr
r_static
r_void
id|gvp11_intr
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_void
op_star
id|dummy
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
r_for
c_loop
(paren
id|instance
op_assign
id|first_instance
suffix:semicolon
id|instance
op_logical_and
id|instance-&gt;hostt
op_eq
id|gvp11_template
suffix:semicolon
id|instance
op_assign
id|instance-&gt;next
)paren
(brace
id|status
op_assign
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|CNTR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|GVP11_DMAC_INT_PENDING
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* disable PORTS interrupt */
id|custom.intena
op_assign
id|IF_PORTS
suffix:semicolon
id|wd33c93_intr
(paren
id|instance
)paren
suffix:semicolon
multiline_comment|/* enable PORTS interrupt */
id|custom.intena
op_assign
id|IF_SETCLR
op_or
id|IF_PORTS
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * DMA transfer mask for GVP Series II SCSI controller.&n; * Some versions can only DMA into the 24 bit address space&n; * (0-&gt;16M).  Others can DMA into the full 32 bit address&n; * space.  The default is to only allow DMA into the 24 bit&n; * address space.  The &quot;gvp11=0xFFFFFFFE&quot; setup parameter can&n; * be supplied to force an alternate (32 bit) mask.&n; */
DECL|variable|gvp11_xfer_mask
r_static
r_int
id|gvp11_xfer_mask
op_assign
id|GVP11_XFER_MASK
suffix:semicolon
DECL|function|gvp11_setup
r_void
id|gvp11_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|gvp11_xfer_mask
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
)brace
DECL|function|dma_setup
r_static
r_int
id|dma_setup
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
id|dir_in
)paren
(brace
r_int
r_int
id|cntr
op_assign
id|GVP11_DMAC_INT_ENABLE
suffix:semicolon
r_int
r_int
id|addr
op_assign
id|VTOP
c_func
(paren
id|cmd-&gt;SCp.ptr
)paren
suffix:semicolon
multiline_comment|/* don&squot;t allow DMA if the physical address is bad */
r_if
c_cond
(paren
id|addr
op_amp
id|gvp11_xfer_mask
op_logical_or
(paren
op_logical_neg
id|dir_in
op_logical_and
id|mm_end_of_chunk
(paren
id|addr
comma
id|cmd-&gt;SCp.this_residual
)paren
)paren
)paren
(brace
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_len
op_assign
(paren
id|cmd-&gt;SCp.this_residual
op_plus
l_int|511
)paren
op_amp
op_complement
l_int|0x1ff
suffix:semicolon
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
op_assign
id|scsi_malloc
(paren
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_len
)paren
suffix:semicolon
multiline_comment|/* can&squot;t allocate memory; use PIO */
r_if
c_cond
(paren
op_logical_neg
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
)paren
(brace
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_len
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* check if the address of the bounce buffer is OK */
id|addr
op_assign
id|VTOP
c_func
(paren
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
id|gvp11_xfer_mask
)paren
(brace
id|scsi_free
(paren
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_len
)paren
suffix:semicolon
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
op_assign
l_int|NULL
suffix:semicolon
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_len
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dir_in
)paren
(brace
multiline_comment|/* copy to bounce buffer for a write */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
macro_line|#if 0
id|panic
(paren
l_string|&quot;scsi%ddma: incomplete s/g support&quot;
comma
id|cmd-&gt;host-&gt;host_no
)paren
suffix:semicolon
macro_line|#else
id|memcpy
(paren
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|cmd-&gt;SCp.ptr
comma
id|cmd-&gt;SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
r_else
id|memcpy
(paren
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* setup dma direction */
r_if
c_cond
(paren
op_logical_neg
id|dir_in
)paren
id|cntr
op_or_assign
id|GVP11_DMAC_DIR_WRITE
suffix:semicolon
id|HDATA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|dma_dir
op_assign
id|dir_in
suffix:semicolon
id|DMA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|CNTR
op_assign
id|cntr
suffix:semicolon
multiline_comment|/* setup DMA *physical* address */
id|DMA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|ACR
op_assign
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|dir_in
)paren
multiline_comment|/* invalidate any cache */
id|cache_clear
(paren
id|addr
comma
id|cmd-&gt;SCp.this_residual
)paren
suffix:semicolon
r_else
multiline_comment|/* push any dirty cache */
id|cache_push
(paren
id|addr
comma
id|cmd-&gt;SCp.this_residual
)paren
suffix:semicolon
multiline_comment|/* start DMA */
id|DMA
c_func
(paren
id|cmd-&gt;host
)paren
op_member_access_from_pointer
id|ST_DMA
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* return success */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dma_stop
r_static
r_void
id|dma_stop
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|status
)paren
(brace
multiline_comment|/* stop DMA */
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|SP_DMA
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* remove write bit from CONTROL bits */
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|CNTR
op_assign
id|GVP11_DMAC_INT_ENABLE
suffix:semicolon
multiline_comment|/* copy from a bounce buffer, if necessary */
r_if
c_cond
(paren
id|status
op_logical_and
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
)paren
(brace
r_if
c_cond
(paren
id|SCpnt
op_logical_and
id|SCpnt-&gt;use_sg
)paren
(brace
macro_line|#if 0
id|panic
(paren
l_string|&quot;scsi%d: incomplete s/g support&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_dir
)paren
(brace
id|memcpy
(paren
id|SCpnt-&gt;SCp.ptr
comma
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|SCpnt-&gt;SCp.this_residual
)paren
suffix:semicolon
)brace
id|scsi_free
(paren
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_len
)paren
suffix:semicolon
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
op_assign
l_int|NULL
suffix:semicolon
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_dir
op_logical_and
id|SCpnt
)paren
id|memcpy
(paren
id|SCpnt-&gt;request_buffer
comma
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|scsi_free
(paren
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
comma
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_len
)paren
suffix:semicolon
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_buffer
op_assign
l_int|NULL
suffix:semicolon
id|HDATA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|dma_bounce_len
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|gvp11_detect
r_int
id|gvp11_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_static
r_int
r_char
id|called
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
r_int
id|i
comma
id|manuf
comma
id|product
comma
id|num_gvp11
op_assign
l_int|0
suffix:semicolon
id|caddr_t
id|address
suffix:semicolon
r_enum
id|GVP_ident
id|epc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_AMIGA
op_logical_or
id|called
)paren
r_return
l_int|0
suffix:semicolon
id|called
op_assign
l_int|1
suffix:semicolon
id|tpnt-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_gvp11
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|boot_info.bi_amiga.num_autocon
suffix:semicolon
id|i
op_increment
)paren
(brace
id|manuf
op_assign
id|boot_info.bi_amiga.autocon
(braket
id|i
)braket
dot
id|cd_Rom.er_Manufacturer
suffix:semicolon
id|product
op_assign
id|boot_info.bi_amiga.autocon
(braket
id|i
)braket
dot
id|cd_Rom.er_Product
suffix:semicolon
macro_line|#if 0
multiline_comment|/* this seems to catch some non HD boards.  GVP is sooooo stupid */
r_if
c_cond
(paren
id|manuf
op_eq
id|MANUF_GVP
op_logical_and
(paren
(paren
id|product
op_eq
id|PROD_GVPIISCSI
)paren
op_logical_or
(paren
id|product
op_eq
id|PROD_GVPIISCSI_2
)paren
)paren
)paren
(brace
macro_line|#else
r_if
c_cond
(paren
id|manuf
op_eq
id|MANUF_GVP
op_logical_and
id|product
op_eq
id|PROD_GVPIISCSI
)paren
(brace
macro_line|#endif
multiline_comment|/* check extended product code */
id|address
op_assign
id|boot_info.bi_amiga.autocon
(braket
id|i
)braket
dot
id|cd_BoardAddr
suffix:semicolon
id|epc
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|ZTWO_VADDR
c_func
(paren
id|address
)paren
op_plus
l_int|0x8000
)paren
suffix:semicolon
id|epc
op_assign
id|epc
op_amp
id|GVP_EPCMASK
suffix:semicolon
multiline_comment|/* &n;&t;     * This should (hopefully) be the correct way to identify&n;&t;     * all the different GVP SCSI controllers (except for the&n;&t;     * SERIES I though).&n;&t;     */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|epc
op_eq
id|GVP_A1291_SCSI
)paren
op_logical_or
(paren
id|epc
op_eq
id|GVP_GFORCE_040_SCSI
)paren
op_logical_or
(paren
id|epc
op_eq
id|GVP_GFORCE_030_SCSI
)paren
op_logical_or
(paren
id|epc
op_eq
id|GVP_A530_SCSI
)paren
op_logical_or
(paren
id|epc
op_eq
id|GVP_COMBO_R4_SCSI
)paren
op_logical_or
(paren
id|epc
op_eq
id|GVP_COMBO_R3_SCSI
)paren
op_logical_or
(paren
id|epc
op_eq
id|GVP_SERIESII
)paren
)paren
)paren
r_continue
suffix:semicolon
id|instance
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|WD33C93_hostdata
)paren
)paren
suffix:semicolon
id|instance-&gt;base
op_assign
(paren
r_int
r_char
op_star
)paren
id|ZTWO_VADDR
c_func
(paren
id|address
)paren
suffix:semicolon
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|secret2
op_assign
l_int|1
suffix:semicolon
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|secret1
op_assign
l_int|0
suffix:semicolon
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|secret3
op_assign
l_int|15
suffix:semicolon
r_while
c_loop
(paren
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|CNTR
op_amp
id|GVP11_DMAC_BUSY
)paren
suffix:semicolon
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|CNTR
op_assign
l_int|0
suffix:semicolon
id|wd33c93_init
c_func
(paren
id|instance
comma
(paren
id|wd33c93_regs
op_star
)paren
op_amp
(paren
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|SASR
)paren
comma
id|dma_setup
comma
id|dma_stop
comma
id|WD33C93_FS_8_10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_gvp11
op_increment
op_eq
l_int|0
)paren
(brace
id|first_instance
op_assign
id|instance
suffix:semicolon
id|gvp11_template
op_assign
id|instance-&gt;hostt
suffix:semicolon
id|add_isr
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|gvp11_intr
comma
l_int|0
comma
l_int|NULL
comma
l_string|&quot;GVP11 SCSI&quot;
)paren
suffix:semicolon
)brace
id|DMA
c_func
(paren
id|instance
)paren
op_member_access_from_pointer
id|CNTR
op_assign
id|GVP11_DMAC_INT_ENABLE
suffix:semicolon
macro_line|#if 0 /* The Zorro stuff is not totally integrated yet ! */
id|boot_info.bi_amiga.autocon_configured
op_or_assign
l_int|1
op_lshift
id|i
suffix:semicolon
macro_line|#endif
)brace
)brace
r_return
id|num_gvp11
suffix:semicolon
)brace
eof
