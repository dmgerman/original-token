multiline_comment|/*&n;  SCSI Tape Driver for Linux version 1.1 and newer. See the accompanying&n;  file README.st for more information.&n;&n;  History:&n;&n;  OnStream SCSI Tape support (osst) cloned from st.c by&n;  Willem Riede (osst@riede.org) Feb 2000&n;  Fixes ... Kurt Garloff &lt;garloff@suse.de&gt; Mar 2000&n;&n;  Rewritten from Dwayne Forsyth&squot;s SCSI tape driver by Kai Makisara.&n;  Contribution and ideas from several people including (in alphabetical&n;  order) Klaus Ehrenfried, Wolfgang Denk, Steve Hirsch, Andreas Koppenh&quot;ofer,&n;  Michael Leodolter, Eyal Lebedinsky, J&quot;org Weule, and Eric Youngdale.&n;&n;  Copyright 1992 - 2000 Kai Makisara&n;&t;&t; email Kai.Makisara@metla.fi&n;&n;  $Header: /home/cvsroot/Driver/osst.c,v 1.51 2000/12/22 20:48:27 garloff Exp $&n;&n;  Microscopic alterations - Rik Ling, 2000/12/21&n;  Last modified: Wed Feb  2 22:04:05 2000 by makisara@kai.makisara.local&n;  Some small formal changes - aeb, 950809&n;*/
DECL|variable|cvsid
r_static
r_const
r_char
op_star
id|cvsid
op_assign
l_string|&quot;$Id: osst.c,v 1.51 2000/12/22 20:48:27 garloff Exp $&quot;
suffix:semicolon
DECL|variable|osst_version
r_const
r_char
op_star
id|osst_version
op_assign
l_string|&quot;0.9.4.3&quot;
suffix:semicolon
multiline_comment|/* The &quot;failure to reconnect&quot; firmware bug */
DECL|macro|OSST_FW_NEED_POLL_MIN
mdefine_line|#define OSST_FW_NEED_POLL_MIN 10602 /*(107A)*/
DECL|macro|OSST_FW_NEED_POLL_MAX
mdefine_line|#define OSST_FW_NEED_POLL_MAX 10708 /*(108D)*/
DECL|macro|OSST_FW_NEED_POLL
mdefine_line|#define OSST_FW_NEED_POLL(x,d) ((x) &gt;= OSST_FW_NEED_POLL_MIN &amp;&amp; (x) &lt;= OSST_FW_NEED_POLL_MAX &amp;&amp; d-&gt;host-&gt;this_id != 7)
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
multiline_comment|/* The driver prints some debugging information on the console if DEBUG&n;   is defined and non-zero. */
DECL|macro|DEBUG
mdefine_line|#define DEBUG 0
multiline_comment|/* The message level for the debug messages is currently set to KERN_NOTICE&n;   so that people can easily see the messages. Later when the debugging messages&n;   in the drivers are more widely classified, this may be changed to KERN_DEBUG. */
DECL|macro|OSST_DEB_MSG
mdefine_line|#define OSST_DEB_MSG  KERN_NOTICE
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR OSST_MAJOR
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
DECL|macro|ST_KILOBYTE
mdefine_line|#define ST_KILOBYTE 1024
macro_line|#include &quot;st.h&quot;
macro_line|#include &quot;osst.h&quot;
macro_line|#include &quot;osst_options.h&quot;
macro_line|#include &quot;osst_detect.h&quot;
macro_line|#include &quot;constants.h&quot;
DECL|variable|buffer_kbs
r_static
r_int
id|buffer_kbs
op_assign
l_int|0
suffix:semicolon
DECL|variable|write_threshold_kbs
r_static
r_int
id|write_threshold_kbs
op_assign
l_int|0
suffix:semicolon
DECL|variable|max_buffers
r_static
r_int
id|max_buffers
op_assign
l_int|0
suffix:semicolon
DECL|variable|max_sg_segs
r_static
r_int
id|max_sg_segs
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Willem Riede&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OnStream SCSI Tape Driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|buffer_kbs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|write_threshold_kbs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_buffers
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_sg_segs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|struct|osst_dev_parm
r_static
r_struct
id|osst_dev_parm
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|val
r_int
op_star
id|val
suffix:semicolon
DECL|variable|__initdata
)brace
id|parms
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;buffer_kbs&quot;
comma
op_amp
id|buffer_kbs
)brace
comma
(brace
l_string|&quot;write_threshold_kbs&quot;
comma
op_amp
id|write_threshold_kbs
)brace
comma
(brace
l_string|&quot;max_buffers&quot;
comma
op_amp
id|max_buffers
)brace
comma
(brace
l_string|&quot;max_sg_segs&quot;
comma
op_amp
id|max_sg_segs
)brace
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Some default definitions have been moved to osst_options.h */
DECL|macro|OSST_BUFFER_SIZE
mdefine_line|#define OSST_BUFFER_SIZE (OSST_BUFFER_BLOCKS * ST_KILOBYTE)
DECL|macro|OSST_WRITE_THRESHOLD
mdefine_line|#define OSST_WRITE_THRESHOLD (OSST_WRITE_THRESHOLD_BLOCKS * ST_KILOBYTE)
multiline_comment|/* The buffer size should fit into the 24 bits for length in the&n;   6-byte SCSI read and write commands. */
macro_line|#if OSST_BUFFER_SIZE &gt;= (2 &lt;&lt; 24 - 1)
macro_line|#error &quot;Buffer size should not exceed (2 &lt;&lt; 24 - 1) bytes!&quot;
macro_line|#endif
macro_line|#if DEBUG
DECL|variable|debugging
r_static
r_int
id|debugging
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES 0
DECL|macro|MAX_WRITE_RETRIES
mdefine_line|#define MAX_WRITE_RETRIES 0
DECL|macro|MAX_READY_RETRIES
mdefine_line|#define MAX_READY_RETRIES 5
DECL|macro|NO_TAPE
mdefine_line|#define NO_TAPE  NOT_READY
DECL|macro|OSST_TIMEOUT
mdefine_line|#define OSST_TIMEOUT (200 * HZ)
DECL|macro|OSST_LONG_TIMEOUT
mdefine_line|#define OSST_LONG_TIMEOUT (1800 * HZ)
DECL|macro|TAPE_NR
mdefine_line|#define TAPE_NR(x) (MINOR(x) &amp; ~(128 | ST_MODE_MASK))
DECL|macro|TAPE_MODE
mdefine_line|#define TAPE_MODE(x) ((MINOR(x) &amp; ST_MODE_MASK) &gt;&gt; ST_MODE_SHIFT)
multiline_comment|/* Internal ioctl to set both density (uppermost 8 bits) and blocksize (lower&n;   24 bits) */
DECL|macro|SET_DENS_AND_BLK
mdefine_line|#define SET_DENS_AND_BLK 0x10001
DECL|variable|osst_nbr_buffers
r_static
r_int
id|osst_nbr_buffers
suffix:semicolon
DECL|variable|osst_buffer_size
r_static
r_int
id|osst_buffer_size
op_assign
id|OSST_BUFFER_SIZE
suffix:semicolon
DECL|variable|osst_write_threshold
r_static
r_int
id|osst_write_threshold
op_assign
id|OSST_WRITE_THRESHOLD
suffix:semicolon
DECL|variable|osst_max_buffers
r_static
r_int
id|osst_max_buffers
op_assign
id|OSST_MAX_BUFFERS
suffix:semicolon
DECL|variable|osst_max_sg_segs
r_static
r_int
id|osst_max_sg_segs
op_assign
id|OSST_MAX_SG
suffix:semicolon
DECL|variable|os_scsi_tapes
r_static
id|OS_Scsi_Tape
op_star
op_star
id|os_scsi_tapes
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|osst_buffers
r_static
id|OSST_buffer
op_star
op_star
id|osst_buffers
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|modes_defined
r_static
r_int
id|modes_defined
op_assign
id|FALSE
suffix:semicolon
r_static
id|OSST_buffer
op_star
id|new_tape_buffer
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|enlarge_buffer
c_func
(paren
id|OSST_buffer
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|normalize_buffer
c_func
(paren
id|OSST_buffer
op_star
)paren
suffix:semicolon
r_static
r_int
id|append_to_buffer
c_func
(paren
r_const
r_char
op_star
comma
id|OSST_buffer
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|from_buffer
c_func
(paren
id|OSST_buffer
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|osst_zero_buffer_tail
c_func
(paren
id|OSST_buffer
op_star
)paren
suffix:semicolon
r_static
r_int
id|osst_copy_to_buffer
c_func
(paren
id|OSST_buffer
op_star
comma
r_int
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|osst_copy_from_buffer
c_func
(paren
id|OSST_buffer
op_star
comma
r_int
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|osst_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|osst_attach
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_int
id|osst_detect
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_void
id|osst_detach
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
DECL|variable|osst_template
r_struct
id|Scsi_Device_Template
id|osst_template
op_assign
(brace
id|name
suffix:colon
l_string|&quot;OnStream tape&quot;
comma
id|tag
suffix:colon
l_string|&quot;osst&quot;
comma
id|scsi_type
suffix:colon
id|TYPE_TAPE
comma
id|major
suffix:colon
id|OSST_MAJOR
comma
id|detect
suffix:colon
id|osst_detect
comma
id|init
suffix:colon
id|osst_init
comma
id|attach
suffix:colon
id|osst_attach
comma
id|detach
suffix:colon
id|osst_detach
)brace
suffix:semicolon
r_static
r_int
id|osst_int_ioctl
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|osst_set_frame_position
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|frame
comma
r_int
id|skip
)paren
suffix:semicolon
r_static
r_int
id|osst_get_frame_position
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
suffix:semicolon
r_static
r_int
id|osst_flush_write_buffer
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|file_blk
)paren
suffix:semicolon
r_static
r_int
id|osst_write_error_recovery
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|pending
)paren
suffix:semicolon
"&f;"
multiline_comment|/* Routines that handle the interaction with mid-layer SCSI routines */
multiline_comment|/* Convert the result to success code */
DECL|function|osst_chk_result
r_static
r_int
id|osst_chk_result
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
id|SRpnt
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|result
op_assign
id|SRpnt-&gt;sr_result
suffix:semicolon
r_int
r_char
op_star
id|sense
op_assign
id|SRpnt-&gt;sr_sense_buffer
comma
id|scode
suffix:semicolon
macro_line|#if DEBUG
r_const
r_char
op_star
id|stp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|sense
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We don&squot;t have sense data if this byte is zero */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
id|scode
op_assign
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0x0f
suffix:semicolon
r_else
(brace
id|sense
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We don&squot;t have sense data if this byte is zero */
id|scode
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Error: %x, cmd: %x %x %x %x %x %x Len: %d&bslash;n&quot;
comma
id|dev
comma
id|result
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|1
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|3
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|4
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|5
)braket
comma
id|SRpnt-&gt;sr_bufflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
id|print_req_sense
c_func
(paren
l_string|&quot;osst&quot;
comma
id|SRpnt
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
op_logical_or
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
id|scode
op_ne
id|NO_SENSE
op_logical_and
id|scode
op_ne
id|RECOVERED_ERROR
op_logical_and
multiline_comment|/*      &t; scode != UNIT_ATTENTION &amp;&amp; */
id|scode
op_ne
id|BLANK_CHECK
op_logical_and
id|scode
op_ne
id|VOLUME_OVERFLOW
op_logical_and
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_ne
id|MODE_SENSE
op_logical_and
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_ne
id|TEST_UNIT_READY
)paren
)paren
(brace
multiline_comment|/* Abnormal conditions for tape */
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Error with sense data: &quot;
comma
id|dev
)paren
suffix:semicolon
id|print_req_sense
c_func
(paren
l_string|&quot;osst&quot;
comma
id|SRpnt
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Error %x (sugg. bt 0x%x, driver bt 0x%x, host bt 0x%x).&bslash;n&quot;
comma
id|dev
comma
id|result
comma
id|suggestion
c_func
(paren
id|result
)paren
comma
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_MASK
comma
id|host_byte
c_func
(paren
id|result
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
id|scode
op_eq
id|RECOVERED_ERROR
)paren
(brace
id|STp-&gt;recover_count
op_increment
suffix:semicolon
id|STp-&gt;recover_erreg
op_increment
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
id|stp
op_assign
l_string|&quot;read&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
id|stp
op_assign
l_string|&quot;write&quot;
suffix:semicolon
r_else
id|stp
op_assign
l_string|&quot;ioctl&quot;
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Recovered %s error (%d).&bslash;n&quot;
comma
id|dev
comma
id|stp
comma
id|os_scsi_tapes
(braket
id|dev
)braket
op_member_access_from_pointer
id|recover_count
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0xe0
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* Wakeup from interrupt */
DECL|function|osst_sleep_done
r_static
r_void
id|osst_sleep_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|dev
suffix:semicolon
r_int
id|remainder
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|SCpnt-&gt;request.rq_dev
)paren
)paren
OL
id|osst_template.nr_dev
)paren
(brace
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
)paren
(brace
multiline_comment|/* EOM at write-behind, has all been written? */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|remainder
op_assign
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
r_else
id|remainder
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|VOLUME_OVERFLOW
op_logical_or
id|remainder
OG
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
multiline_comment|/* Error */
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
op_assign
id|INT_MAX
suffix:semicolon
multiline_comment|/* OK */
)brace
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_SCSI_DONE
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
op_assign
id|SCpnt-&gt;sc_request
suffix:semicolon
macro_line|#if DEBUG
id|STp-&gt;write_pending
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|up
c_func
(paren
id|SCpnt-&gt;request.sem
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_else
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst?: Illegal interrupt device %x&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Do the scsi command. Waits until command performed if do_wait is true.&n;   Otherwise osst_write_behind_check() is used to check that the command&n;   has finished. */
DECL|function|osst_do_scsi
r_static
id|Scsi_Request
op_star
id|osst_do_scsi
c_func
(paren
id|Scsi_Request
op_star
id|SRpnt
comma
id|OS_Scsi_Tape
op_star
id|STp
comma
r_int
r_char
op_star
id|cmd
comma
r_int
id|bytes
comma
r_int
id|direction
comma
r_int
id|timeout
comma
r_int
id|retries
comma
r_int
id|do_wait
)paren
(brace
r_int
r_char
op_star
id|bp
suffix:semicolon
singleline_comment|//static int inject = 0; /* FIXME - take out inject occasional read errors */
singleline_comment|//static int repeat = 0;
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|SRpnt
op_assign
id|scsi_allocate_request
c_func
(paren
id|STp-&gt;device
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Can&squot;t get SCSI request.&bslash;n&quot;
comma
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
(paren
op_minus
id|EINTR
)paren
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|cmd
(braket
l_int|1
)braket
op_or_assign
(paren
id|SRpnt-&gt;sr_device-&gt;lun
op_lshift
l_int|5
)paren
op_amp
l_int|0xe0
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|STp-&gt;sem
)paren
suffix:semicolon
id|SRpnt-&gt;sr_use_sg
op_assign
(paren
id|bytes
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|sg
(braket
l_int|0
)braket
dot
id|length
)paren
ques
c_cond
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|use_sg
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt-&gt;sr_use_sg
)paren
(brace
id|bp
op_assign
(paren
r_char
op_star
)paren
op_amp
(paren
id|STp-&gt;buffer-&gt;sg
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;sg_segs
OL
id|SRpnt-&gt;sr_use_sg
)paren
id|SRpnt-&gt;sr_use_sg
op_assign
id|STp-&gt;buffer-&gt;sg_segs
suffix:semicolon
)brace
r_else
id|bp
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|SRpnt-&gt;sr_data_direction
op_assign
id|direction
suffix:semicolon
id|SRpnt-&gt;sr_cmd_len
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_request.sem
op_assign
op_amp
(paren
id|STp-&gt;sem
)paren
suffix:semicolon
id|SRpnt-&gt;sr_request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|SRpnt-&gt;sr_request.rq_dev
op_assign
id|STp-&gt;devt
suffix:semicolon
id|scsi_do_req
c_func
(paren
id|SRpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
id|bp
comma
id|bytes
comma
id|osst_sleep_done
comma
id|timeout
comma
id|retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_wait
)paren
(brace
id|down
c_func
(paren
id|SRpnt-&gt;sr_request.sem
)paren
suffix:semicolon
id|SRpnt-&gt;sr_request.sem
op_assign
l_int|NULL
suffix:semicolon
id|STp-&gt;buffer-&gt;syscall_result
op_assign
id|osst_chk_result
c_func
(paren
id|STp
comma
id|SRpnt
)paren
suffix:semicolon
singleline_comment|//if ((STp-&gt;buffer)-&gt;syscall_result == 0 &amp;&amp;
singleline_comment|//    cmd[0] == READ_6 &amp;&amp; cmd[4] &amp;&amp; ( /* (++ inject % 83) == 29  || */
singleline_comment|//     (STp-&gt;first_frame_position == 240 /* or STp-&gt;read_error_frame to fail again on the block calculated above */ &amp;&amp; ++repeat &lt; 3))) {
singleline_comment|//&t;printk(OSST_DEB_MSG &quot;osst%d: injecting read error&bslash;n&quot;, TAPE_NR(STp-&gt;devt));
singleline_comment|//&t;STp-&gt;buffer-&gt;last_result_fatal = 1; /* FIXME - take out inject occasional read errors */
singleline_comment|//}
)brace
r_return
id|SRpnt
suffix:semicolon
)brace
multiline_comment|/* Handle the write-behind checking (downs the semaphore) */
DECL|function|osst_write_behind_check
r_static
r_void
id|osst_write_behind_check
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
)paren
(brace
id|OSST_buffer
op_star
id|STbuffer
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
id|STbuffer
op_assign
id|STp-&gt;buffer
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|STp-&gt;write_pending
)paren
id|STp-&gt;nbr_waits
op_increment
suffix:semicolon
r_else
id|STp-&gt;nbr_finished
op_increment
suffix:semicolon
macro_line|#endif
id|down
c_func
(paren
op_amp
(paren
id|STp-&gt;sem
)paren
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt-&gt;sr_request.sem
op_assign
l_int|NULL
suffix:semicolon
id|STp-&gt;buffer-&gt;syscall_result
op_assign
id|osst_chk_result
c_func
(paren
id|STp
comma
id|STp-&gt;buffer-&gt;last_SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
id|osst_write_error_recovery
c_func
(paren
id|STp
comma
op_amp
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
)paren
comma
l_int|1
)paren
suffix:semicolon
r_else
id|STp-&gt;first_frame_position
op_increment
suffix:semicolon
id|scsi_release_request
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STbuffer-&gt;writing
OL
id|STbuffer-&gt;buffer_bytes
)paren
macro_line|#if 0
id|memcpy
c_func
(paren
id|STbuffer-&gt;b_data
comma
id|STbuffer-&gt;b_data
op_plus
id|STbuffer-&gt;writing
comma
id|STbuffer-&gt;buffer_bytes
op_minus
id|STbuffer-&gt;writing
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: write_behind_check: something left in buffer!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|STbuffer-&gt;buffer_bytes
op_sub_assign
id|STbuffer-&gt;writing
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STps-&gt;drv_block
op_increment
suffix:semicolon
r_else
id|STps-&gt;drv_block
op_add_assign
id|STbuffer-&gt;writing
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|STbuffer-&gt;writing
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Onstream specific Routines */
multiline_comment|/*&n; * Initialize the OnStream AUX&n; */
DECL|function|osst_init_aux
r_static
r_void
id|osst_init_aux
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
r_int
id|frame_type
comma
r_int
id|logical_blk_num
)paren
(brace
id|os_aux_t
op_star
id|aux
op_assign
id|STp-&gt;buffer-&gt;aux
suffix:semicolon
id|os_partition_t
op_star
id|par
op_assign
op_amp
id|aux-&gt;partition
suffix:semicolon
id|os_dat_t
op_star
id|dat
op_assign
op_amp
id|aux-&gt;dat
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|aux
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|aux
)paren
)paren
suffix:semicolon
id|aux-&gt;format_id
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|aux-&gt;application_sig
comma
l_string|&quot;LIN4&quot;
comma
l_int|4
)paren
suffix:semicolon
id|aux-&gt;hdwr
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|aux-&gt;frame_type
op_assign
id|frame_type
suffix:semicolon
r_switch
c_cond
(paren
id|frame_type
)paren
(brace
r_case
id|OS_FRAME_TYPE_HEADER
suffix:colon
id|aux-&gt;update_frame_cntr
op_assign
id|htonl
c_func
(paren
id|STp-&gt;update_frame_cntr
)paren
suffix:semicolon
id|par-&gt;partition_num
op_assign
id|OS_CONFIG_PARTITION
suffix:semicolon
id|par-&gt;par_desc_ver
op_assign
id|OS_PARTITION_VERSION
suffix:semicolon
id|par-&gt;wrt_pass_cntr
op_assign
id|htons
c_func
(paren
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* 0-4 = reserved, 5-9 = header, 2990-2994 = header, 2995-2999 = reserved */
id|par-&gt;first_frame_ppos
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|par-&gt;last_frame_ppos
op_assign
id|htonl
c_func
(paren
l_int|0xbb7
)paren
suffix:semicolon
id|aux-&gt;frame_seq_num
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|aux-&gt;logical_blk_num_high
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|aux-&gt;logical_blk_num
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|aux-&gt;next_mark_ppos
op_assign
id|htonl
c_func
(paren
id|STp-&gt;first_mark_ppos
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OS_FRAME_TYPE_DATA
suffix:colon
r_case
id|OS_FRAME_TYPE_MARKER
suffix:colon
id|dat-&gt;dat_sz
op_assign
l_int|8
suffix:semicolon
id|dat-&gt;reserved1
op_assign
l_int|0
suffix:semicolon
id|dat-&gt;entry_cnt
op_assign
l_int|1
suffix:semicolon
id|dat-&gt;reserved3
op_assign
l_int|0
suffix:semicolon
id|dat-&gt;dat_list
(braket
l_int|0
)braket
dot
id|blk_sz
op_assign
id|htonl
c_func
(paren
id|frame_type
op_eq
id|OS_FRAME_TYPE_DATA
ques
c_cond
id|STp-&gt;block_size
suffix:colon
l_int|0
)paren
suffix:semicolon
id|dat-&gt;dat_list
(braket
l_int|0
)braket
dot
id|blk_cnt
op_assign
id|htons
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|dat-&gt;dat_list
(braket
l_int|0
)braket
dot
id|flags
op_assign
id|frame_type
op_eq
id|OS_FRAME_TYPE_MARKER
ques
c_cond
id|OS_DAT_FLAGS_MARK
suffix:colon
id|OS_DAT_FLAGS_DATA
suffix:semicolon
id|dat-&gt;dat_list
(braket
l_int|0
)braket
dot
id|reserved
op_assign
l_int|0
suffix:semicolon
r_case
id|OS_FRAME_TYPE_EOD
suffix:colon
id|aux-&gt;update_frame_cntr
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|par-&gt;partition_num
op_assign
id|OS_DATA_PARTITION
suffix:semicolon
id|par-&gt;par_desc_ver
op_assign
id|OS_PARTITION_VERSION
suffix:semicolon
id|par-&gt;wrt_pass_cntr
op_assign
id|htons
c_func
(paren
id|STp-&gt;wrt_pass_cntr
)paren
suffix:semicolon
id|par-&gt;first_frame_ppos
op_assign
id|htonl
c_func
(paren
id|STp-&gt;first_data_ppos
)paren
suffix:semicolon
id|par-&gt;last_frame_ppos
op_assign
id|htonl
c_func
(paren
id|STp-&gt;capacity
)paren
suffix:semicolon
id|aux-&gt;frame_seq_num
op_assign
id|htonl
c_func
(paren
id|logical_blk_num
)paren
suffix:semicolon
id|aux-&gt;logical_blk_num_high
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|aux-&gt;logical_blk_num
op_assign
id|htonl
c_func
(paren
id|logical_blk_num
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
multiline_comment|/* probably FILL */
)brace
id|aux-&gt;filemark_cnt
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;filemark_cnt
)paren
suffix:semicolon
multiline_comment|/* FIXME -- violates ADR spec */
id|aux-&gt;phys_fm
op_assign
id|ntohl
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|aux-&gt;last_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;last_mark_ppos
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Verify that we have the correct tape frame&n; */
DECL|function|osst_verify_frame
r_static
r_int
id|osst_verify_frame
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
r_int
id|logical_blk_num
comma
r_int
id|quiet
)paren
(brace
id|os_aux_t
op_star
id|aux
op_assign
id|STp-&gt;buffer-&gt;aux
suffix:semicolon
id|os_partition_t
op_star
id|par
op_assign
op_amp
(paren
id|aux-&gt;partition
)paren
suffix:semicolon
id|ST_partstat
op_star
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STp-&gt;buffer-&gt;sg_segs
suffix:semicolon
id|i
op_increment
)paren
id|memset
c_func
(paren
id|STp-&gt;buffer-&gt;sg
(braket
id|i
)braket
dot
id|address
comma
l_int|0
comma
id|STp-&gt;buffer-&gt;sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|STp-&gt;buffer-&gt;b_data
comma
l_string|&quot;READ ERROR ON FRAME&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, read error&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|aux-&gt;format_id
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, format_id %u&bslash;n&quot;
comma
id|dev
comma
id|ntohl
c_func
(paren
id|aux-&gt;format_id
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|aux-&gt;application_sig
comma
id|STp-&gt;application_sig
comma
l_int|4
)paren
op_ne
l_int|0
op_logical_and
(paren
id|memcmp
c_func
(paren
id|aux-&gt;application_sig
comma
l_string|&quot;LIN3&quot;
comma
l_int|4
)paren
op_ne
l_int|0
op_logical_or
id|STp-&gt;linux_media_version
op_ne
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, incorrect application signature&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|par-&gt;partition_num
op_ne
id|OS_DATA_PARTITION
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;linux_media
op_logical_or
id|STp-&gt;linux_media_version
op_ne
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, partition num %d&bslash;n&quot;
comma
id|dev
comma
id|par-&gt;partition_num
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|par-&gt;par_desc_ver
op_ne
id|OS_PARTITION_VERSION
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, partition version %d&bslash;n&quot;
comma
id|dev
comma
id|par-&gt;par_desc_ver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|par-&gt;wrt_pass_cntr
)paren
op_ne
id|STp-&gt;wrt_pass_cntr
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, wrt_pass_cntr %d (expected %d)&bslash;n&quot;
comma
id|dev
comma
id|ntohs
c_func
(paren
id|par-&gt;wrt_pass_cntr
)paren
comma
id|STp-&gt;wrt_pass_cntr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aux-&gt;frame_seq_num
op_ne
id|aux-&gt;logical_blk_num
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, seq != logical&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_DATA
op_logical_and
id|aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_EOD
op_logical_and
id|aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|quiet
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, frame type %x&bslash;n&quot;
comma
id|dev
comma
id|aux-&gt;frame_type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_EOD
op_logical_and
id|STp-&gt;first_frame_position
OL
id|STp-&gt;eod_frame_ppos
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping premature EOD frame %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|logical_blk_num
op_ne
op_minus
l_int|1
op_logical_and
id|ntohl
c_func
(paren
id|aux-&gt;logical_blk_num
)paren
op_ne
id|logical_blk_num
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|quiet
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Skipping frame, logical_blk_num %u (expected %d)&bslash;n&quot;
comma
id|dev
comma
id|ntohl
c_func
(paren
id|aux-&gt;logical_blk_num
)paren
comma
id|logical_blk_num
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_FM_HIT
suffix:semicolon
id|i
op_assign
id|ntohl
c_func
(paren
id|aux-&gt;filemark_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_ne
l_int|NULL
op_logical_and
id|i
OL
id|OS_FM_TAB_MAX
op_logical_and
(paren
id|i
OG
id|STp-&gt;filemark_cnt
op_logical_or
id|STp-&gt;first_frame_position
op_minus
l_int|1
op_ne
id|ntohl
c_func
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|i
)braket
)paren
)paren
)paren
(brace
macro_line|#if 1 
singleline_comment|//DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: %s filemark %d at frame %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|i
)braket
op_eq
l_int|0
ques
c_cond
l_string|&quot;Learned&quot;
suffix:colon
l_string|&quot;Corrected&quot;
comma
id|i
comma
id|STp-&gt;first_frame_position
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|i
)braket
op_assign
id|htonl
c_func
(paren
id|STp-&gt;first_frame_position
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|STp-&gt;filemark_cnt
)paren
id|STp-&gt;filemark_cnt
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_EOD
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_EOD_1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_DATA
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for the unit to become Ready&n; */
DECL|function|osst_wait_ready
r_static
r_int
id|osst_wait_ready
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|timeout
)paren
(brace
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
r_int
id|startwait
op_assign
id|jiffies
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dbg
op_assign
id|debugging
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Reached onstream wait ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_while
c_loop
(paren
id|STp-&gt;buffer-&gt;syscall_result
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|startwait
op_plus
id|timeout
op_star
id|HZ
)paren
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_eq
l_int|2
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|4
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|1
op_logical_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|8
)paren
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Sleeping in onstream wait ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Turning off debugging for a while&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|debugging
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
)brace
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
macro_line|#if DEBUG
id|debugging
op_assign
id|dbg
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
op_logical_and
id|osst_write_error_recovery
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Abnormal exit from onstream wait ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Result = %d, Sense: 0=%02x, 2=%02x, 12=%02x, 13=%02x&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;buffer-&gt;syscall_result
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Normal exit from onstream wait ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|osst_position_tape_and_confirm
r_static
r_int
id|osst_position_tape_and_confirm
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|frame
)paren
(brace
r_int
id|retval
suffix:semicolon
id|osst_wait_ready
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|15
op_star
l_int|60
)paren
suffix:semicolon
multiline_comment|/* TODO - can this catch a write error? */
id|retval
op_assign
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
id|osst_wait_ready
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|15
op_star
l_int|60
)paren
suffix:semicolon
r_return
(paren
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for write(s) to complete&n; */
DECL|function|osst_flush_drive_buffer
r_static
r_int
id|osst_flush_drive_buffer
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Reached onstream flush drive buffer (write filemark)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
id|result
op_assign
id|osst_write_error_recovery
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
suffix:semicolon
id|result
op_or_assign
id|osst_wait_ready
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|5
op_star
l_int|60
)paren
suffix:semicolon
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
r_return
(paren
id|result
)paren
suffix:semicolon
)brace
DECL|macro|OSST_POLL_PER_SEC
mdefine_line|#define OSST_POLL_PER_SEC 10
DECL|function|osst_wait_frame
r_static
r_int
id|osst_wait_frame
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|curr
comma
r_int
id|minlast
comma
r_int
id|to
)paren
(brace
r_int
id|startwait
op_assign
id|jiffies
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#if DEBUG
r_char
id|notyetprinted
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|minlast
op_ge
l_int|0
op_logical_and
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_ne
id|ST_READING
)paren
op_logical_or
(paren
id|minlast
OL
l_int|0
op_logical_and
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_ne
id|ST_WRITING
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%i: waiting for frame without having initialized %s!&bslash;n&quot;
comma
id|dev
comma
id|minlast
OL
l_int|0
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|time_before
(paren
id|jiffies
comma
id|startwait
op_plus
id|to
op_star
id|HZ
)paren
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|osst_get_frame_position
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EIO
)paren
r_if
c_cond
(paren
(paren
id|result
op_assign
id|osst_write_error_recovery
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* successfull recovery leaves drive ready for frame */
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;first_frame_position
op_eq
id|curr
op_logical_and
(paren
(paren
id|minlast
template_param
(paren
r_int
)paren
id|curr
op_plus
id|minlast
)paren
op_logical_or
(paren
id|minlast
op_ge
l_int|0
op_logical_and
id|STp-&gt;cur_frames
OG
id|minlast
)paren
)paren
op_logical_and
id|result
op_ge
l_int|0
)paren
(brace
macro_line|#if DEBUG&t;&t;&t;
r_if
c_cond
(paren
id|debugging
op_logical_or
id|jiffies
op_minus
id|startwait
op_ge
l_int|2
op_star
id|HZ
op_div
id|OSST_POLL_PER_SEC
)paren
id|printk
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Succ wait f fr %i (&gt;%i): %i-%i %i (%i): %3li.%li s&bslash;n&quot;
comma
id|dev
comma
id|curr
comma
id|curr
op_plus
id|minlast
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
comma
id|STp-&gt;cur_frames
comma
id|result
comma
(paren
id|jiffies
op_minus
id|startwait
)paren
op_div
id|HZ
comma
(paren
(paren
(paren
id|jiffies
op_minus
id|startwait
)paren
op_mod
id|HZ
)paren
op_star
l_int|10
)paren
op_div
id|HZ
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|jiffies
op_minus
id|startwait
op_ge
l_int|2
op_star
id|HZ
op_div
id|OSST_POLL_PER_SEC
op_logical_and
id|notyetprinted
)paren
(brace
id|printk
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Wait for frame %i (&gt;%i): %i-%i %i (%i)&bslash;n&quot;
comma
id|dev
comma
id|curr
comma
id|curr
op_plus
id|minlast
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
comma
id|STp-&gt;cur_frames
comma
id|result
)paren
suffix:semicolon
id|notyetprinted
op_decrement
suffix:semicolon
)brace
macro_line|#endif
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
(paren
id|HZ
op_div
id|OSST_POLL_PER_SEC
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Fail wait f fr %i (&gt;%i): %i-%i %i: %3li.%li s&bslash;n&quot;
comma
id|dev
comma
id|curr
comma
id|curr
op_plus
id|minlast
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
comma
id|STp-&gt;cur_frames
comma
(paren
id|jiffies
op_minus
id|startwait
)paren
op_div
id|HZ
comma
(paren
(paren
(paren
id|jiffies
op_minus
id|startwait
)paren
op_mod
id|HZ
)paren
op_star
l_int|10
)paren
op_div
id|HZ
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the next OnStream tape block at the current location&n; */
DECL|function|osst_read_block
r_static
r_int
id|osst_read_block
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|timeout
)paren
(brace
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|os_aux_t
op_star
id|aux
op_assign
id|STp-&gt;buffer-&gt;aux
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* TODO: Error handling */
r_if
c_cond
(paren
id|STp-&gt;poll
)paren
id|retval
op_assign
id|osst_wait_frame
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;first_frame_position
comma
l_int|0
comma
id|timeout
)paren
suffix:semicolon
macro_line|#if 0
singleline_comment|// DEBUG
id|printk
(paren
l_string|&quot;osst_read: wait for frame returned %i&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Reading block from OnStream tape&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|cmd
comma
id|OS_FRAME_SIZE
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
id|MAX_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
(brace
id|retval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;read_error_frame
op_eq
l_int|0
)paren
(brace
id|STp-&gt;read_error_frame
op_assign
id|STp-&gt;first_frame_position
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: recording read error at %d&bslash;n&quot;
comma
id|STp-&gt;read_error_frame
)paren
suffix:semicolon
multiline_comment|/*FIXME*/
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Sense: %2x %2x %2x %2x %2x %2x %2x %2x&bslash;n&quot;
comma
id|dev
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|1
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|3
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|4
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|5
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|6
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|7
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
id|STp-&gt;first_frame_position
op_increment
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: AUX: %c%c%c%c UpdFrCt#%d %s FrSeq#%d LogBlk#%d&bslash;n&quot;
comma
id|dev
comma
id|aux-&gt;application_sig
(braket
l_int|0
)braket
comma
id|aux-&gt;application_sig
(braket
l_int|1
)braket
comma
id|aux-&gt;application_sig
(braket
l_int|2
)braket
comma
id|aux-&gt;application_sig
(braket
l_int|3
)braket
comma
id|ntohl
c_func
(paren
id|aux-&gt;update_frame_cntr
)paren
comma
id|aux-&gt;frame_type
op_eq
l_int|1
ques
c_cond
l_string|&quot;EOD&quot;
suffix:colon
id|aux-&gt;frame_type
op_eq
l_int|2
ques
c_cond
l_string|&quot;MARK&quot;
suffix:colon
id|aux-&gt;frame_type
op_eq
l_int|8
ques
c_cond
l_string|&quot;HEADR&quot;
suffix:colon
id|aux-&gt;frame_type
op_eq
l_int|0x80
ques
c_cond
l_string|&quot;DATA&quot;
suffix:colon
l_string|&quot;FILL&quot;
comma
id|ntohl
c_func
(paren
id|aux-&gt;frame_seq_num
)paren
comma
id|ntohl
c_func
(paren
id|aux-&gt;logical_blk_num
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_eq
l_int|2
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: mark_cnt=%d, last_mark=%d, next_mark=%d&bslash;n&quot;
comma
id|dev
comma
id|ntohl
c_func
(paren
id|aux-&gt;filemark_cnt
)paren
comma
id|ntohl
c_func
(paren
id|aux-&gt;last_mark_ppos
)paren
comma
id|ntohl
c_func
(paren
id|aux-&gt;next_mark_ppos
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Exit read block from OnStream tape with code %d&bslash;n&quot;
comma
id|dev
comma
id|retval
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
id|retval
)paren
suffix:semicolon
)brace
DECL|function|osst_initiate_read
r_static
r_int
id|osst_initiate_read
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
id|ST_partstat
op_star
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STps-&gt;rw
op_ne
id|ST_READING
)paren
(brace
multiline_comment|/* Initialize read operation */
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
(brace
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|1
)paren
suffix:semicolon
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
)brace
id|STps-&gt;rw
op_assign
id|ST_READING
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Issue a read 0 command to get the OnStream drive&n;&t;&t; *      read blocks into its buffer.&n;&t;&t; */
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Start Read Ahead on OnStream tape&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
id|retval
op_assign
id|STp-&gt;buffer-&gt;syscall_result
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|osst_get_logical_blk
r_static
r_int
id|osst_get_logical_blk
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|logical_blk_num
comma
r_int
id|quiet
)paren
(brace
id|ST_partstat
op_star
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
comma
id|bad
op_assign
l_int|0
comma
id|past
op_assign
l_int|0
comma
id|x
comma
id|position
suffix:semicolon
multiline_comment|/*&n;&t; * Search and wait for the next logical tape block&n;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|cnt
op_increment
OG
l_int|400
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Couldn&squot;t find logical block %d, aborting&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;read_error_frame
)paren
(brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;read_error_frame
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if 1 
singleline_comment|//DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Repositioning tape to bad block %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;read_error_frame
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;read_error_frame
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Looking for block %d, attempt %d&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
comma
id|cnt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|osst_initiate_read
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
op_logical_or
(paren
(paren
op_logical_neg
id|STp-&gt;logical_blk_in_buffer
)paren
op_logical_and
id|osst_read_block
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|30
)paren
)paren
)paren
(brace
id|position
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|position
op_ge
l_int|0xbae
op_logical_and
id|position
OL
l_int|0xbb8
)paren
id|position
op_assign
l_int|0xbb8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|position
OG
id|STp-&gt;eod_frame_ppos
op_logical_or
op_increment
id|bad
op_eq
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: start again from pos %d, eod %d, bad %d&bslash;n&quot;
comma
id|dev
comma
id|position
comma
id|STp-&gt;eod_frame_ppos
comma
id|bad
)paren
suffix:semicolon
multiline_comment|/*FIXME*/
id|position
op_assign
id|STp-&gt;read_error_frame
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|position
op_add_assign
l_int|39
suffix:semicolon
id|cnt
op_add_assign
l_int|20
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Bad block detected, positioning tape to block %d&bslash;n&quot;
comma
id|dev
comma
id|position
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|position
comma
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|osst_verify_frame
c_func
(paren
id|STp
comma
id|logical_blk_num
comma
id|quiet
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|osst_verify_frame
c_func
(paren
id|STp
comma
op_minus
l_int|1
comma
id|quiet
)paren
)paren
(brace
id|x
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;logical_blk_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;fast_open
)paren
(brace
macro_line|#if 1 
singleline_comment|//DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Found logical block %d instead of %d after fast open&bslash;n&quot;
comma
id|dev
comma
id|x
comma
id|logical_blk_num
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;read_error_frame
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
OG
id|logical_blk_num
)paren
(brace
r_if
c_cond
(paren
op_increment
id|past
OG
l_int|3
)paren
(brace
multiline_comment|/* positioning backwards did not bring us to the desired block */
id|position
op_assign
id|STp-&gt;read_error_frame
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|position
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
op_plus
id|logical_blk_num
op_minus
id|x
op_minus
l_int|1
suffix:semicolon
macro_line|#if 1 
singleline_comment|//DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Found logical block %d while looking for %d: back up %d&bslash;n&quot;
comma
id|dev
comma
id|x
comma
id|logical_blk_num
comma
id|STp-&gt;first_frame_position
op_minus
id|position
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|position
comma
l_int|0
)paren
suffix:semicolon
id|cnt
op_add_assign
l_int|10
suffix:semicolon
)brace
r_else
id|past
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
op_eq
l_int|0xbaf
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Skipping config partition&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0xbb8
comma
l_int|0
)paren
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
)brace
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
OG
l_int|1
)paren
(brace
id|STp-&gt;recover_count
op_increment
suffix:semicolon
id|STp-&gt;recover_erreg
op_increment
suffix:semicolon
)brace
id|STp-&gt;logical_blk_num
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;logical_blk_num
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_or
id|STps-&gt;eof
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Exit get logical block (%d=&gt;%d) from OnStream tape with code %d&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
comma
id|STp-&gt;logical_blk_num
comma
id|STps-&gt;eof
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;fast_open
op_assign
id|FALSE
suffix:semicolon
id|STp-&gt;read_error_frame
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|STps-&gt;eof
)paren
suffix:semicolon
)brace
DECL|function|osst_seek_logical_blk
r_static
r_int
id|osst_seek_logical_blk
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|logical_blk_num
)paren
(brace
r_int
id|estimate
suffix:semicolon
r_int
id|retries
op_assign
l_int|0
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|logical_blk_num
OL
l_int|0
)paren
id|logical_blk_num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME -- this may not be valid for foreign formats */
r_if
c_cond
(paren
id|logical_blk_num
OL
l_int|2980
)paren
id|estimate
op_assign
id|logical_blk_num
op_plus
l_int|10
suffix:semicolon
r_else
id|estimate
op_assign
id|logical_blk_num
op_plus
l_int|20
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Seeking logical block %d (now at %d)&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
comma
id|STp-&gt;logical_blk_num
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
op_increment
id|retries
OL
l_int|10
)paren
(brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|estimate
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|logical_blk_num
comma
l_int|1
)paren
op_ge
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|1
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;logical_blk_num
op_ne
id|logical_blk_num
)paren
id|estimate
op_add_assign
id|logical_blk_num
op_minus
id|STp-&gt;logical_blk_num
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
id|error
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Couldn&squot;t seek to logical block %d (at %d), %d retries&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
comma
id|STp-&gt;logical_blk_num
comma
id|retries
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
DECL|function|osst_seek_frame
r_static
r_int
id|osst_seek_frame
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|frame
)paren
(brace
id|ST_partstat
op_star
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|frame
OL
l_int|0
op_logical_or
id|frame
op_ge
id|STp-&gt;capacity
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame
op_le
id|STp-&gt;first_data_ppos
)paren
(brace
id|STp-&gt;logical_blk_num
op_assign
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
id|r
op_assign
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
r_return
id|r
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
op_ne
id|frame
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|STp-&gt;logical_blk_num
op_increment
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|htonl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;filemark_cnt
)paren
suffix:semicolon
id|STps-&gt;drv_block
op_assign
op_minus
l_int|1
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read back the drive&squot;s internal buffer contents, as a part&n; * of the write error recovery mechanism for old OnStream&n; * firmware revisions.&n; */
DECL|function|osst_read_back_buffer_and_rewrite
r_static
r_int
id|osst_read_back_buffer_and_rewrite
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
r_int
id|block
comma
r_int
r_int
id|skip
comma
r_int
id|pending
)paren
(brace
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
r_int
r_char
op_star
id|buffer
comma
op_star
id|p
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_int
id|frames
comma
id|flag
comma
id|new_block
comma
id|i
comma
id|logical_blk_num
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|startwait
op_assign
id|jiffies
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dbg
op_assign
id|debugging
suffix:semicolon
macro_line|#endif
id|frames
op_assign
id|STp-&gt;cur_frames
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
op_assign
(paren
r_int
r_char
op_star
)paren
id|vmalloc
c_func
(paren
(paren
id|frames
op_plus
id|pending
)paren
op_star
id|OS_DATA_SIZE
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
op_minus
id|frames
op_minus
id|pending
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Reading back %d frames from drive buffer%s&bslash;n&quot;
comma
id|dev
comma
id|frames
comma
id|pending
ques
c_cond
l_string|&quot; and one that was pending&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pending
)paren
(brace
id|osst_copy_from_buffer
c_func
(paren
id|STp-&gt;buffer
comma
(paren
id|p
op_assign
op_amp
id|buffer
(braket
id|frames
op_star
id|OS_DATA_SIZE
)braket
)paren
)paren
suffix:semicolon
singleline_comment|//&t;&t;memcpy((p = &amp;buffer[frames * OS_DATA_SIZE]), STp-&gt;buffer-&gt;b_data, OS_DATA_SIZE);
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Pending logical block %d, data %x %x %x %x&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
op_plus
id|frames
comma
id|p
(braket
l_int|0
)braket
comma
id|p
(braket
l_int|1
)braket
comma
id|p
(braket
l_int|2
)braket
comma
id|p
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|buffer
suffix:semicolon
id|i
OL
id|frames
suffix:semicolon
id|i
op_increment
comma
id|p
op_add_assign
id|OS_DATA_SIZE
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
l_int|0x3C
suffix:semicolon
multiline_comment|/* Buffer Read           */
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* Retrieve Faulty Block */
id|cmd
(braket
l_int|7
)braket
op_assign
l_int|32768
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|8
)braket
op_assign
l_int|32768
op_amp
l_int|0xff
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|OS_FRAME_SIZE
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
id|MAX_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Failed to read block back from OnStream buffer&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
id|buffer
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|osst_copy_from_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|p
)paren
suffix:semicolon
singleline_comment|//&t;&t;memcpy(p, STp-&gt;buffer-&gt;b_data, OS_DATA_SIZE);
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Read back logical block %d, data %x %x %x %x&bslash;n&quot;
comma
id|dev
comma
id|logical_blk_num
op_plus
id|i
comma
id|p
(braket
l_int|0
)braket
comma
id|p
(braket
l_int|1
)braket
comma
id|p
(braket
l_int|2
)braket
comma
id|p
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Frames left in buffer: %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;cur_frames
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Write synchronously so we can be sure we&squot;re OK again and don&squot;t have to recover recursively */
multiline_comment|/* In the header we don&squot;t actually re-write the blocks that fail, just the ones after them */
r_for
c_loop
(paren
id|flag
op_assign
l_int|1
comma
id|new_block
op_assign
id|block
comma
id|p
op_assign
id|buffer
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|frames
op_plus
id|pending
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|flag
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;write_type
op_eq
id|OS_WRITE_HEADER
)paren
(brace
id|i
op_add_assign
id|skip
suffix:semicolon
id|p
op_add_assign
id|skip
op_star
id|OS_DATA_SIZE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|new_block
OL
l_int|2990
op_logical_and
id|new_block
op_plus
id|skip
op_plus
id|frames
op_plus
id|pending
op_ge
l_int|2990
)paren
id|new_block
op_assign
l_int|3000
op_minus
id|i
suffix:semicolon
r_else
id|new_block
op_add_assign
id|skip
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Position to frame %d, write lblk %d&bslash;n&quot;
comma
id|dev
comma
id|new_block
op_plus
id|i
comma
id|logical_blk_num
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* FIXME var blk sz */
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|new_block
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
id|osst_wait_ready
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|60
)paren
suffix:semicolon
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
r_if
c_cond
(paren
id|new_block
OG
id|block
op_plus
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Failed to find valid tape media&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
id|buffer
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|frames
op_plus
id|pending
)paren
r_break
suffix:semicolon
)brace
id|osst_copy_to_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|p
)paren
suffix:semicolon
singleline_comment|//&t;&t;memcpy(STp-&gt;buffer-&gt;b_data, p, OS_DATA_SIZE);
multiline_comment|/*&n;&t;&t; * IMPORTANT: for error recovery to work, _never_ queue frames with mixed frame type!&n;&t;&t; */
id|osst_init_aux
c_func
(paren
id|STp
comma
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
comma
id|logical_blk_num
op_plus
id|i
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: About to attempt to write to frame %d&bslash;n&quot;
comma
id|dev
comma
id|new_block
op_plus
id|i
)paren
suffix:semicolon
macro_line|#endif
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|OS_FRAME_SIZE
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
)paren
id|flag
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|p
op_add_assign
id|OS_DATA_SIZE
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/* if we just sent the last frame, wait till all successfully written */
r_if
c_cond
(paren
id|i
op_eq
id|frames
op_plus
id|pending
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Check re-write successful&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Sleeping in re-write wait ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Turning off debugging for a while&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|debugging
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|flag
op_assign
id|STp-&gt;buffer-&gt;syscall_result
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|flag
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|startwait
op_plus
l_int|60
op_star
id|HZ
)paren
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_eq
l_int|2
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|4
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|1
op_logical_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|8
)paren
)paren
(brace
multiline_comment|/* in the process of becoming ready */
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
)paren
id|flag
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if DEBUG
id|debugging
op_assign
id|dbg
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Wait re-write finished&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|flag
)paren
(brace
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|13
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|0
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Volume overflow in write error recovery&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
id|buffer
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* hit end of tape = fail */
)brace
id|i
op_assign
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|6
)braket
)paren
op_minus
id|new_block
suffix:semicolon
id|p
op_assign
op_amp
id|buffer
(braket
id|i
op_star
id|OS_DATA_SIZE
)braket
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Additional write error at %d&bslash;n&quot;
comma
id|dev
comma
id|new_block
op_plus
id|i
)paren
suffix:semicolon
macro_line|#endif
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: reported frame positions: host = %d, tape = %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
)paren
suffix:semicolon
macro_line|#endif
)brace
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
)brace
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
id|buffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|osst_reposition_and_retry
r_static
r_int
id|osst_reposition_and_retry
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
r_int
id|block
comma
r_int
r_int
id|skip
comma
r_int
id|pending
)paren
(brace
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|attempts
op_assign
l_int|1000
op_div
id|skip
suffix:semicolon
r_int
id|flag
op_assign
l_int|1
suffix:semicolon
r_int
id|startwait
op_assign
id|jiffies
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dbg
op_assign
id|debugging
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|attempts
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|startwait
op_plus
l_int|60
op_star
id|HZ
)paren
)paren
(brace
r_if
c_cond
(paren
id|flag
)paren
(brace
macro_line|#if DEBUG
id|debugging
op_assign
id|dbg
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|block
OL
l_int|2990
op_logical_and
id|block
op_plus
id|skip
op_plus
id|STp-&gt;cur_frames
op_plus
id|pending
op_ge
l_int|2990
)paren
id|block
op_assign
l_int|3000
op_minus
id|skip
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Position to frame %d, re-write from lblk %d&bslash;n&quot;
comma
id|dev
comma
id|block
op_plus
id|skip
comma
id|STp-&gt;logical_blk_num
op_minus
id|STp-&gt;cur_frames
op_minus
id|pending
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
op_plus
id|skip
comma
l_int|1
)paren
suffix:semicolon
id|flag
op_assign
l_int|0
suffix:semicolon
id|attempts
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* additional write error */
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Addl error, host %d, tape %d, buffer %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
comma
id|STp-&gt;cur_frames
)paren
suffix:semicolon
macro_line|#endif
id|block
op_assign
id|STp-&gt;last_frame_position
suffix:semicolon
id|flag
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pending
op_logical_and
id|STp-&gt;cur_frames
OL
l_int|50
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: About to write pending lblk %d at frame %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;logical_blk_num
op_minus
l_int|1
comma
id|STp-&gt;first_frame_position
)paren
suffix:semicolon
macro_line|#endif
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|OS_FRAME_SIZE
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
)paren
(brace
multiline_comment|/* additional write error */
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|13
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|0
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Volume overflow in write error recovery&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* hit end of tape = fail */
)brace
id|flag
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pending
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;cur_frames
op_eq
l_int|0
)paren
(brace
macro_line|#if DEBUG
id|debugging
op_assign
id|dbg
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Wait re-write finished&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Sleeping in re-write wait ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Turning off debugging for a while&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|debugging
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Failed to find valid tape media&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#if DEBUG
id|debugging
op_assign
id|dbg
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Error recovery algorithm for the OnStream tape.&n; */
DECL|function|osst_write_error_recovery
r_static
r_int
id|osst_write_error_recovery
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|pending
)paren
(brace
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
id|ST_partstat
op_star
id|STps
op_assign
op_amp
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|rw_state
suffix:semicolon
r_int
r_int
id|block
comma
id|skip
suffix:semicolon
id|rw_state
op_assign
id|STps-&gt;rw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_ne
l_int|3
op_logical_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_ne
l_int|12
op_logical_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Write error recovery cannot handle %02x:%02x:%02x&bslash;n&quot;
comma
id|dev
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|block
op_assign
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
id|skip
op_assign
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|9
)braket
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Detected physical bad block at %u, advised to skip %d&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|skip
)paren
suffix:semicolon
macro_line|#endif
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: reported frame positions: host = %d, tape = %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|STp-&gt;write_type
)paren
(brace
r_case
id|OS_WRITE_DATA
suffix:colon
r_case
id|OS_WRITE_EOD
suffix:colon
r_case
id|OS_WRITE_NEW_MARK
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Relocating %d buffered logical blocks to physical block %u&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;cur_frames
comma
id|block
op_plus
id|skip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;os_fw_rev
op_ge
l_int|10600
)paren
id|retval
op_assign
id|osst_reposition_and_retry
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
comma
id|skip
comma
id|pending
)paren
suffix:semicolon
r_else
id|retval
op_assign
id|osst_read_back_buffer_and_rewrite
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
comma
id|skip
comma
id|pending
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OS_WRITE_LAST_MARK
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Bad block in update last marker, fatal&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
op_plus
id|STp-&gt;cur_frames
op_plus
id|pending
comma
l_int|0
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OS_WRITE_HEADER
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Bad block in header partition, skipped&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
id|osst_read_back_buffer_and_rewrite
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
comma
l_int|1
comma
id|pending
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Bad block in filler, ignored&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
op_plus
id|STp-&gt;cur_frames
op_plus
id|pending
comma
l_int|0
)paren
suffix:semicolon
)brace
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Positioning complete, cur_frames %d, pos %d, tape pos %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;cur_frames
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: next logical block to write: %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;logical_blk_num
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|retval
op_eq
l_int|0
)paren
(brace
id|STp-&gt;recover_count
op_increment
suffix:semicolon
id|STp-&gt;recover_erreg
op_increment
suffix:semicolon
)brace
id|STps-&gt;rw
op_assign
id|rw_state
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|osst_space_over_filemarks_backward
r_static
r_int
id|osst_space_over_filemarks_backward
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|mt_op
comma
r_int
id|mt_count
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|last_mark_ppos
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Reached space_over_filemarks_backwards %d %d&bslash;n&quot;
comma
id|dev
comma
id|mt_op
comma
id|mt_count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks_bwd&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;linux_media_version
op_ge
l_int|4
)paren
(brace
multiline_comment|/*&n;&t;&t; * direct lookup in header filemark list&n;&t;&t; */
id|cnt
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;filemark_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_ok
op_logical_and
id|STp-&gt;header_cache
op_ne
l_int|NULL
op_logical_and
(paren
id|cnt
op_minus
id|mt_count
)paren
op_ge
l_int|0
op_logical_and
(paren
id|cnt
op_minus
id|mt_count
)paren
OL
id|OS_FM_TAB_MAX
op_logical_and
(paren
id|cnt
op_minus
id|mt_count
)paren
OL
id|STp-&gt;filemark_cnt
op_logical_and
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|cnt
op_minus
l_int|1
)braket
op_eq
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
id|last_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|cnt
op_minus
id|mt_count
)braket
)paren
suffix:semicolon
macro_line|#if 1 
singleline_comment|//DEBUG
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_eq
l_int|NULL
op_logical_or
(paren
id|cnt
op_minus
id|mt_count
)paren
OL
l_int|0
op_logical_or
(paren
id|cnt
op_minus
id|mt_count
)paren
op_ge
id|OS_FM_TAB_MAX
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Filemark lookup fail due to %s&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;header_cache
op_eq
l_int|NULL
ques
c_cond
l_string|&quot;lack of header cache&quot;
suffix:colon
l_string|&quot;count out of range&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Filemark lookup: prev mark %d (%s), skip %d to %d&bslash;n&quot;
comma
id|dev
comma
id|cnt
comma
(paren
(paren
id|cnt
op_eq
op_minus
l_int|1
op_logical_and
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|cnt
op_minus
l_int|1
)braket
op_eq
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
)paren
ques
c_cond
l_string|&quot;match&quot;
suffix:colon
l_string|&quot;error&quot;
comma
id|mt_count
comma
id|last_mark_ppos
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|last_mark_ppos
OG
l_int|10
op_logical_and
id|last_mark_ppos
OL
id|STp-&gt;eod_frame_ppos
)paren
(brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|last_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Expected to find marker at block %d, not found&bslash;n&quot;
comma
id|dev
comma
id|last_mark_ppos
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mt_op
op_eq
id|MTBSFM
)paren
(brace
id|STp-&gt;logical_blk_num
op_increment
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Reverting to scan filemark backwards&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
id|cnt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_ne
id|mt_count
)paren
(brace
id|last_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_mark_ppos
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Positioning to last mark at %d&bslash;n&quot;
comma
id|dev
comma
id|last_mark_ppos
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|last_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Expected to find marker at block %d, not found&bslash;n&quot;
comma
id|dev
comma
id|last_mark_ppos
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mt_op
op_eq
id|MTBSFM
)paren
(brace
id|STp-&gt;logical_blk_num
op_increment
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ADRL 1.1 compatible &quot;slow&quot; space filemarks fwd version&n; *&n; * Just scans for the filemark sequentially.&n; */
DECL|function|osst_space_over_filemarks_forward_slow
r_static
r_int
id|osst_space_over_filemarks_forward_slow
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|mt_op
comma
r_int
id|mt_count
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Reached space_over_filemarks_forward_slow %d %d&bslash;n&quot;
comma
id|dev
comma
id|mt_op
comma
id|mt_count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks_fwd&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_MARKER
)paren
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_EOD
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: space_fwd: EOD reached&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;first_frame_position
OG
id|STp-&gt;eod_frame_ppos
op_plus
l_int|1
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: EOD position corrected (%d=&gt;%d)&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;eod_frame_ppos
comma
id|STp-&gt;first_frame_position
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;eod_frame_ppos
op_assign
id|STp-&gt;first_frame_position
op_minus
l_int|1
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_eq
id|mt_count
)paren
r_break
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mt_op
op_eq
id|MTFSF
)paren
(brace
id|STp-&gt;logical_blk_num
op_increment
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Fast linux specific version of OnStream FSF&n; */
DECL|function|osst_space_over_filemarks_forward_fast
r_static
r_int
id|osst_space_over_filemarks_forward_fast
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|mt_op
comma
r_int
id|mt_count
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
comma
id|next_mark_ppos
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Reached space_over_filemarks_forward_fast %d %d&bslash;n&quot;
comma
id|dev
comma
id|mt_op
comma
id|mt_count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks_fwd&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;linux_media_version
op_ge
l_int|4
)paren
(brace
multiline_comment|/*&n;&t;&t; * direct lookup in header filemark list&n;&t;&t; */
id|cnt
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;filemark_cnt
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_ok
op_logical_and
id|STp-&gt;header_cache
op_ne
l_int|NULL
op_logical_and
(paren
id|cnt
op_plus
id|mt_count
)paren
OL
id|OS_FM_TAB_MAX
op_logical_and
(paren
id|cnt
op_plus
id|mt_count
)paren
OL
id|STp-&gt;filemark_cnt
op_logical_and
(paren
(paren
id|cnt
op_eq
op_minus
l_int|1
op_logical_and
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|cnt
)braket
op_eq
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
)paren
)paren
id|next_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|cnt
op_plus
id|mt_count
)braket
)paren
suffix:semicolon
macro_line|#if 1 
singleline_comment|//DEBUG
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_eq
l_int|NULL
op_logical_or
(paren
id|cnt
op_plus
id|mt_count
)paren
op_ge
id|OS_FM_TAB_MAX
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Filemark lookup fail due to %s&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;header_cache
op_eq
l_int|NULL
ques
c_cond
l_string|&quot;lack of header cache&quot;
suffix:colon
l_string|&quot;count out of range&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Filemark lookup: prev mark %d (%s), skip %d to %d&bslash;n&quot;
comma
id|dev
comma
id|cnt
comma
(paren
(paren
id|cnt
op_eq
op_minus
l_int|1
op_logical_and
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|cnt
)braket
op_eq
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
)paren
ques
c_cond
l_string|&quot;match&quot;
suffix:colon
l_string|&quot;error&quot;
comma
id|mt_count
comma
id|next_mark_ppos
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|next_mark_ppos
op_le
l_int|10
op_logical_or
id|next_mark_ppos
OG
id|STp-&gt;eod_frame_ppos
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Reverting to slow filemark space&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
id|osst_space_over_filemarks_forward_slow
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|mt_op
comma
id|mt_count
)paren
suffix:semicolon
)brace
r_else
(brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|next_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Expected to find marker at block %d, not found&bslash;n&quot;
comma
id|dev
comma
id|next_mark_ppos
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;filemark_cnt
)paren
op_ne
id|cnt
op_plus
id|mt_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Expected to find marker %d at block %d, not %d&bslash;n&quot;
comma
id|dev
comma
id|cnt
op_plus
id|mt_count
comma
id|next_mark_ppos
comma
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;filemark_cnt
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Find nearest (usually previous) marker, then jump from marker to marker&n;&t;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_MARKER
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_EOD
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: space_fwd: EOD reached&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;filemark_cnt
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;first_mark_ppos
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Reverting to slow filemark space&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
id|osst_space_over_filemarks_forward_slow
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|mt_op
comma
id|mt_count
)paren
suffix:semicolon
)brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;first_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks_fwd_fast&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Expected to find filemark at %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_mark_ppos
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|osst_space_over_filemarks_backward
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|MTBSF
comma
l_int|1
)paren
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|mt_count
op_increment
suffix:semicolon
)brace
)brace
id|cnt
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_ne
id|mt_count
)paren
(brace
id|next_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;next_mark_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|next_mark_ppos
op_logical_or
id|next_mark_ppos
OG
id|STp-&gt;eod_frame_ppos
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Reverting to slow filemark space&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
id|osst_space_over_filemarks_forward_slow
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|mt_op
comma
id|mt_count
op_minus
id|cnt
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_else
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Positioning to next mark at %d&bslash;n&quot;
comma
id|dev
comma
id|next_mark_ppos
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|next_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in space_filemarks&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Expected to find marker at block %d, not found&bslash;n&quot;
comma
id|dev
comma
id|next_mark_ppos
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|mt_op
op_eq
id|MTFSF
)paren
id|STp-&gt;logical_blk_num
op_increment
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * In debug mode, we want to see as many errors as possible&n; * to test the error recovery mechanism.&n; */
macro_line|#if DEBUG
DECL|function|osst_set_retries
r_static
r_void
id|osst_set_retries
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|retries
)paren
(brace
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|NUMBER_RETRIES_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
op_minus
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Medium Type - ignoring */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Block Descriptor Length */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|0
)braket
op_assign
id|NUMBER_RETRIES_PAGE
op_or
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_assign
l_int|4
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_assign
id|retries
suffix:semicolon
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Setting number of retries on OnStream tape to %d&bslash;n&quot;
comma
id|dev
comma
id|retries
)paren
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;osst%d: Couldn&squot;t set retries to %d&bslash;n&quot;
comma
id|dev
comma
id|retries
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0
r_static
r_void
id|osst_update_markers
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|last_mark_ppos
comma
r_int
id|this_mark_ppos
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|frame
comma
id|reslt
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
suffix:semicolon
id|STp-&gt;last_mark_ppos
op_assign
id|this_mark_ppos
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_ne
l_int|NULL
op_logical_and
id|STp-&gt;filemark_cnt
OL
id|OS_FM_TAB_MAX
)paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|STp-&gt;filemark_cnt
)braket
op_assign
id|htonl
c_func
(paren
id|this_mark_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;filemark_cnt
op_increment
op_eq
l_int|0
)paren
id|STp-&gt;first_mark_ppos
op_assign
id|this_mark_ppos
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;linux_media_version
op_ge
l_int|4
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|last_mark_ppos
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|STp-&gt;write_type
op_assign
id|OS_WRITE_LAST_MARK
suffix:semicolon
id|frame
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Update last_marker at frame %d&bslash;n&quot;
comma
id|dev
comma
id|last_mark_addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: current position %d, lblk %d, tape blk %d&bslash;n&quot;
comma
id|dev
comma
id|frame
comma
id|STp-&gt;logical_blk_num
comma
id|STp-&gt;last_frame_position
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|last_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
id|osst_initiate_read
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
id|reslt
op_assign
id|osst_read_block
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|180
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reslt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: couldn&squot;t read last marker&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_MARKER
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: expected marker at addr %d&bslash;n&quot;
comma
id|dev
comma
id|last_mark_ppos
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: writing back marker&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;buffer-&gt;aux-&gt;next_mark_ppos
op_assign
id|htonl
c_func
(paren
id|this_mark_ppos
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|last_mark_ppos
comma
l_int|0
)paren
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
op_logical_or
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: couldn&squot;t write marker back at addr %d&bslash;n&quot;
comma
id|dev
comma
id|last_mark_ppos
)paren
suffix:semicolon
)brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* FIXME -- errors should go back to user space */
)brace
macro_line|#endif
DECL|function|osst_write_filemark
r_static
r_int
id|osst_write_filemark
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|this_mark_ppos
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
l_int|0
suffix:semicolon
id|STp-&gt;write_type
op_assign
id|OS_WRITE_NEW_MARK
suffix:semicolon
id|this_mark_ppos
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Writing Filemark %i at frame %d (lblk %d)&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;filemark_cnt
comma
id|this_mark_ppos
comma
id|STp-&gt;logical_blk_num
)paren
suffix:semicolon
macro_line|#endif
id|osst_init_aux
c_func
(paren
id|STp
comma
id|OS_FRAME_TYPE_MARKER
comma
id|STp-&gt;logical_blk_num
op_increment
)paren
suffix:semicolon
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_assign
id|ST_WRITING
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
suffix:semicolon
id|result
op_or_assign
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
id|STp-&gt;last_mark_ppos
op_assign
id|this_mark_ppos
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_ne
l_int|NULL
op_logical_and
id|STp-&gt;filemark_cnt
OL
id|OS_FM_TAB_MAX
)paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|STp-&gt;filemark_cnt
)braket
op_assign
id|htonl
c_func
(paren
id|this_mark_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;filemark_cnt
op_increment
op_eq
l_int|0
)paren
id|STp-&gt;first_mark_ppos
op_assign
id|this_mark_ppos
suffix:semicolon
singleline_comment|//&t;osst_update_markers(STp, aSRpnt, STp-&gt;last_mark_addr, this_mark_addr);
r_return
id|result
suffix:semicolon
)brace
DECL|function|osst_write_eod
r_static
r_int
id|osst_write_eod
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
id|result
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
l_int|0
suffix:semicolon
id|STp-&gt;write_type
op_assign
id|OS_WRITE_EOD
suffix:semicolon
id|STp-&gt;eod_frame_ppos
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Writing EOD at %d=&gt;%d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;logical_blk_num
comma
id|STp-&gt;eod_frame_ppos
)paren
suffix:semicolon
macro_line|#endif
id|osst_init_aux
c_func
(paren
id|STp
comma
id|OS_FRAME_TYPE_EOD
comma
id|STp-&gt;logical_blk_num
op_increment
)paren
suffix:semicolon
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_assign
id|ST_WRITING
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
suffix:semicolon
id|result
op_or_assign
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
id|STp-&gt;eod_frame_lfa
op_assign
op_decrement
(paren
id|STp-&gt;logical_blk_num
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|osst_write_filler
r_static
r_int
id|osst_write_filler
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|block
comma
r_int
id|count
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Reached onstream write filler group %d&bslash;n&quot;
comma
id|dev
comma
id|block
)paren
suffix:semicolon
macro_line|#endif
id|osst_wait_ready
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|60
op_star
l_int|5
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
comma
l_int|0
)paren
suffix:semicolon
id|STp-&gt;write_type
op_assign
id|OS_WRITE_FILLER
suffix:semicolon
id|osst_init_aux
c_func
(paren
id|STp
comma
id|OS_FRAME_TYPE_FILL
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|memcpy
c_func
(paren
id|STp-&gt;buffer-&gt;b_data
comma
l_string|&quot;Filler&quot;
comma
l_int|6
)paren
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_bytes
op_assign
l_int|6
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t write filler frame&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Exiting onstream write filler group&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
)brace
DECL|function|__osst_write_header
r_static
r_int
id|__osst_write_header
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|block
comma
r_int
id|count
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Reached onstream write header group %d&bslash;n&quot;
comma
id|dev
comma
id|block
)paren
suffix:semicolon
macro_line|#endif
id|osst_wait_ready
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|60
op_star
l_int|5
)paren
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
comma
l_int|0
)paren
suffix:semicolon
id|STp-&gt;write_type
op_assign
id|OS_WRITE_HEADER
suffix:semicolon
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_assign
id|ST_WRITING
suffix:semicolon
id|osst_init_aux
c_func
(paren
id|STp
comma
id|OS_FRAME_TYPE_HEADER
comma
id|STp-&gt;logical_blk_num
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|osst_copy_to_buffer
c_func
(paren
id|STp-&gt;buffer
comma
(paren
r_int
r_char
op_star
)paren
id|STp-&gt;header_cache
)paren
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_bytes
op_assign
r_sizeof
(paren
id|os_header_t
)paren
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Couldn&squot;t write header frame&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
id|result
op_assign
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Write onstream header group %s&bslash;n&quot;
comma
id|dev
comma
id|result
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;done&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|result
suffix:semicolon
)brace
DECL|function|osst_write_header
r_static
r_int
id|osst_write_header
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|locate_eod
)paren
(brace
id|os_header_t
op_star
id|header
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Writing tape header&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;header_cache
op_assign
(paren
id|os_header_t
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
id|os_header_t
)paren
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%i: Failed to allocate header cache&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|STp-&gt;header_cache
comma
l_int|0
comma
r_sizeof
(paren
id|os_header_t
)paren
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Allocated and cleared memory for header cache&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|STp-&gt;header_ok
)paren
id|STp-&gt;update_frame_cntr
op_increment
suffix:semicolon
r_else
id|STp-&gt;update_frame_cntr
op_assign
l_int|0
suffix:semicolon
id|header
op_assign
id|STp-&gt;header_cache
suffix:semicolon
id|strcpy
c_func
(paren
id|header-&gt;ident_str
comma
l_string|&quot;ADR_SEQ&quot;
)paren
suffix:semicolon
id|header-&gt;major_rev
op_assign
l_int|1
suffix:semicolon
id|header-&gt;minor_rev
op_assign
l_int|4
suffix:semicolon
id|header-&gt;ext_trk_tb_off
op_assign
id|htons
c_func
(paren
l_int|17192
)paren
suffix:semicolon
id|header-&gt;pt_par_num
op_assign
l_int|1
suffix:semicolon
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|partition_num
op_assign
id|OS_DATA_PARTITION
suffix:semicolon
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|par_desc_ver
op_assign
id|OS_PARTITION_VERSION
suffix:semicolon
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|wrt_pass_cntr
op_assign
id|htons
c_func
(paren
id|STp-&gt;wrt_pass_cntr
)paren
suffix:semicolon
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|first_frame_ppos
op_assign
id|htonl
c_func
(paren
id|STp-&gt;first_data_ppos
)paren
suffix:semicolon
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|last_frame_ppos
op_assign
id|htonl
c_func
(paren
id|STp-&gt;capacity
)paren
suffix:semicolon
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|eod_frame_ppos
op_assign
id|htonl
c_func
(paren
id|STp-&gt;eod_frame_ppos
)paren
suffix:semicolon
id|header-&gt;cfg_col_width
op_assign
id|htonl
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|header-&gt;dat_col_width
op_assign
id|htonl
c_func
(paren
l_int|1500
)paren
suffix:semicolon
id|header-&gt;qfa_col_width
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|header-&gt;ext_track_tb.nr_stream_part
op_assign
l_int|1
suffix:semicolon
id|header-&gt;ext_track_tb.et_ent_sz
op_assign
l_int|32
suffix:semicolon
id|header-&gt;ext_track_tb.dat_ext_trk_ey.et_part_num
op_assign
l_int|0
suffix:semicolon
id|header-&gt;ext_track_tb.dat_ext_trk_ey.fmt
op_assign
l_int|1
suffix:semicolon
id|header-&gt;ext_track_tb.dat_ext_trk_ey.fm_tab_off
op_assign
id|htons
c_func
(paren
l_int|17736
)paren
suffix:semicolon
id|header-&gt;ext_track_tb.dat_ext_trk_ey.last_hlb_hi
op_assign
l_int|0
suffix:semicolon
id|header-&gt;ext_track_tb.dat_ext_trk_ey.last_hlb
op_assign
id|htonl
c_func
(paren
id|STp-&gt;eod_frame_lfa
)paren
suffix:semicolon
id|header-&gt;ext_track_tb.dat_ext_trk_ey.last_pp
op_assign
id|htonl
c_func
(paren
id|STp-&gt;eod_frame_ppos
)paren
suffix:semicolon
id|header-&gt;dat_fm_tab.fm_part_num
op_assign
l_int|0
suffix:semicolon
id|header-&gt;dat_fm_tab.fm_tab_ent_sz
op_assign
l_int|4
suffix:semicolon
id|header-&gt;dat_fm_tab.fm_tab_ent_cnt
op_assign
id|htons
c_func
(paren
id|STp-&gt;filemark_cnt
OL
id|OS_FM_TAB_MAX
ques
c_cond
id|STp-&gt;filemark_cnt
suffix:colon
id|OS_FM_TAB_MAX
)paren
suffix:semicolon
id|result
op_assign
id|__osst_write_header
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0xbae
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;update_frame_cntr
op_eq
l_int|0
)paren
id|osst_write_filler
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0xbb3
comma
l_int|5
)paren
suffix:semicolon
id|result
op_and_assign
id|__osst_write_header
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|5
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|locate_eod
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: locating back to eod frame addr %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;eod_frame_ppos
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;eod_frame_ppos
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: write header failed&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|STp-&gt;application_sig
comma
l_string|&quot;LIN4&quot;
comma
l_int|4
)paren
suffix:semicolon
id|STp-&gt;linux_media
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;linux_media_version
op_assign
l_int|4
suffix:semicolon
id|STp-&gt;header_ok
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|osst_reset_header
r_static
r_int
id|osst_reset_header
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_ne
l_int|NULL
)paren
id|memset
c_func
(paren
id|STp-&gt;header_cache
comma
l_int|0
comma
r_sizeof
(paren
id|os_header_t
)paren
)paren
suffix:semicolon
id|STp-&gt;logical_blk_num
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;eod_frame_ppos
op_assign
id|STp-&gt;first_data_ppos
op_assign
l_int|0x0000000A
suffix:semicolon
id|STp-&gt;filemark_cnt
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;first_mark_ppos
op_assign
id|STp-&gt;last_mark_ppos
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|osst_write_header
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|__osst_analyze_headers
r_static
r_int
id|__osst_analyze_headers
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|block
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|os_header_t
op_star
id|header
suffix:semicolon
id|os_aux_t
op_star
id|aux
suffix:semicolon
r_char
id|id_string
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|linux_media_version
comma
id|update_frame_cntr
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|block
op_eq
l_int|5
op_logical_or
id|block
op_eq
l_int|0xbae
op_logical_or
id|STp-&gt;buffer-&gt;syscall_result
)paren
(brace
r_if
c_cond
(paren
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: Couldn&squot;t position tape&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_initiate_read
(paren
id|STp
comma
id|aSRpnt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: Couldn&squot;t initiate read&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|osst_read_block
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|180
)paren
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Couldn&squot;t read header frame&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|header
op_assign
(paren
id|os_header_t
op_star
)paren
id|STp-&gt;buffer-&gt;b_data
suffix:semicolon
multiline_comment|/* warning: only first segment addressable */
id|aux
op_assign
id|STp-&gt;buffer-&gt;aux
suffix:semicolon
r_if
c_cond
(paren
id|aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_HEADER
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Skipping non-header frame (%d)&bslash;n&quot;
comma
id|dev
comma
id|block
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|header-&gt;ident_str
comma
l_string|&quot;ADR_SEQ&quot;
comma
l_int|7
)paren
op_ne
l_int|0
op_logical_and
id|strncmp
c_func
(paren
id|header-&gt;ident_str
comma
l_string|&quot;ADR-SEQ&quot;
comma
l_int|7
)paren
op_ne
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|id_string
comma
id|header-&gt;ident_str
comma
l_int|7
)paren
suffix:semicolon
id|id_string
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Invalid header identification string %s&bslash;n&quot;
comma
id|dev
comma
id|id_string
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|update_frame_cntr
op_assign
id|ntohl
c_func
(paren
id|aux-&gt;update_frame_cntr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update_frame_cntr
OL
id|STp-&gt;update_frame_cntr
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Skipping frame %d with update_frame_counter %d&lt;%d&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|update_frame_cntr
comma
id|STp-&gt;update_frame_cntr
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;major_rev
op_ne
l_int|1
op_logical_or
id|header-&gt;minor_rev
op_ne
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: %s revision %d.%d detected (1.4 supported)&bslash;n&quot;
comma
id|dev
comma
(paren
id|header-&gt;major_rev
op_ne
l_int|1
op_logical_or
id|header-&gt;minor_rev
template_param
l_int|4
)paren
ques
c_cond
l_string|&quot;Invalid&quot;
suffix:colon
l_string|&quot;Warning:&quot;
comma
id|header-&gt;major_rev
comma
id|header-&gt;minor_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;major_rev
op_ne
l_int|1
op_logical_or
id|header-&gt;minor_rev
template_param
l_int|4
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;pt_par_num
op_ne
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Warning: %d partitions defined, only one supported&bslash;n&quot;
comma
id|dev
comma
id|header-&gt;pt_par_num
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|id_string
comma
id|aux-&gt;application_sig
comma
l_int|4
)paren
suffix:semicolon
id|id_string
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|id_string
comma
l_string|&quot;LIN&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|STp-&gt;linux_media
op_assign
l_int|1
suffix:semicolon
id|linux_media_version
op_assign
id|id_string
(braket
l_int|3
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|linux_media_version
op_ne
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Linux media version %d detected (current 4)&bslash;n&quot;
comma
id|dev
comma
id|linux_media_version
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: non Linux media detected (%s)&bslash;n&quot;
comma
id|dev
comma
id|id_string
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linux_media_version
OL
id|STp-&gt;linux_media_version
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Skipping frame %d with linux_media_version %d&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|linux_media_version
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linux_media_version
OG
id|STp-&gt;linux_media_version
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Frame %d sets linux_media_version to %d&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|linux_media_version
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|STp-&gt;application_sig
comma
id|id_string
comma
l_int|5
)paren
suffix:semicolon
id|STp-&gt;linux_media_version
op_assign
id|linux_media_version
suffix:semicolon
id|STp-&gt;update_frame_cntr
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update_frame_cntr
OG
id|STp-&gt;update_frame_cntr
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Frame %d sets update_frame_counter to %d&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|update_frame_cntr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;header_cache
op_assign
(paren
id|os_header_t
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
id|os_header_t
)paren
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%i: Failed to allocate header cache&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Allocated memory for header cache&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
id|osst_copy_from_buffer
c_func
(paren
id|STp-&gt;buffer
comma
(paren
r_int
r_char
op_star
)paren
id|STp-&gt;header_cache
)paren
suffix:semicolon
id|header
op_assign
id|STp-&gt;header_cache
suffix:semicolon
multiline_comment|/* further accesses from cached (full) copy */
id|STp-&gt;wrt_pass_cntr
op_assign
id|ntohs
c_func
(paren
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|wrt_pass_cntr
)paren
suffix:semicolon
id|STp-&gt;first_data_ppos
op_assign
id|ntohl
c_func
(paren
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|first_frame_ppos
)paren
suffix:semicolon
id|STp-&gt;eod_frame_ppos
op_assign
id|ntohl
c_func
(paren
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|eod_frame_ppos
)paren
suffix:semicolon
id|STp-&gt;eod_frame_lfa
op_assign
id|ntohl
c_func
(paren
id|header-&gt;ext_track_tb.dat_ext_trk_ey.last_hlb
)paren
suffix:semicolon
id|STp-&gt;filemark_cnt
op_assign
id|ntohl
c_func
(paren
id|aux-&gt;filemark_cnt
)paren
suffix:semicolon
id|STp-&gt;first_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|aux-&gt;next_mark_ppos
)paren
suffix:semicolon
id|STp-&gt;last_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|aux-&gt;last_mark_ppos
)paren
suffix:semicolon
id|STp-&gt;update_frame_cntr
op_assign
id|update_frame_cntr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: detected write pass %d, update frame counter %d, filemark counter %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;wrt_pass_cntr
comma
id|STp-&gt;update_frame_cntr
comma
id|STp-&gt;filemark_cnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: first data frame on tape = %d, last = %d, eod frame = %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_data_ppos
comma
id|ntohl
c_func
(paren
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|last_frame_ppos
)paren
comma
id|ntohl
c_func
(paren
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|eod_frame_ppos
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: first mark on tape = %d, last = %d, eod frame = %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_mark_ppos
comma
id|STp-&gt;last_mark_ppos
comma
id|STp-&gt;eod_frame_ppos
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|header-&gt;minor_rev
OL
l_int|4
op_logical_and
id|STp-&gt;linux_media_version
op_eq
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Moving filemark list to ADR 1.4 location&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|header-&gt;dat_fm_tab.fm_tab_ent
comma
(paren
r_void
op_star
)paren
id|header-&gt;old_filemark_list
comma
r_sizeof
(paren
id|header-&gt;dat_fm_tab.fm_tab_ent
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|header-&gt;old_filemark_list
comma
l_int|0
comma
r_sizeof
(paren
id|header-&gt;old_filemark_list
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;minor_rev
op_eq
l_int|4
op_logical_and
(paren
id|header-&gt;ext_trk_tb_off
op_ne
id|htons
c_func
(paren
l_int|17192
)paren
op_logical_or
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|partition_num
op_ne
id|OS_DATA_PARTITION
op_logical_or
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|par_desc_ver
op_ne
id|OS_PARTITION_VERSION
op_logical_or
id|header-&gt;partition
(braket
l_int|0
)braket
dot
id|last_frame_ppos
op_ne
id|htonl
c_func
(paren
id|STp-&gt;capacity
)paren
op_logical_or
id|header-&gt;cfg_col_width
op_ne
id|htonl
c_func
(paren
l_int|20
)paren
op_logical_or
id|header-&gt;dat_col_width
op_ne
id|htonl
c_func
(paren
l_int|1500
)paren
op_logical_or
id|header-&gt;qfa_col_width
op_ne
id|htonl
c_func
(paren
l_int|0
)paren
op_logical_or
id|header-&gt;ext_track_tb.nr_stream_part
op_ne
l_int|1
op_logical_or
id|header-&gt;ext_track_tb.et_ent_sz
op_ne
l_int|32
op_logical_or
id|header-&gt;ext_track_tb.dat_ext_trk_ey.et_part_num
op_ne
id|OS_DATA_PARTITION
op_logical_or
id|header-&gt;ext_track_tb.dat_ext_trk_ey.fmt
op_ne
l_int|1
op_logical_or
id|header-&gt;ext_track_tb.dat_ext_trk_ey.fm_tab_off
op_ne
id|htons
c_func
(paren
l_int|17736
)paren
op_logical_or
id|header-&gt;ext_track_tb.dat_ext_trk_ey.last_hlb_hi
op_ne
l_int|0
op_logical_or
id|header-&gt;ext_track_tb.dat_ext_trk_ey.last_pp
op_ne
id|htonl
c_func
(paren
id|STp-&gt;eod_frame_ppos
)paren
op_logical_or
id|header-&gt;dat_fm_tab.fm_part_num
op_ne
id|OS_DATA_PARTITION
op_logical_or
id|header-&gt;dat_fm_tab.fm_tab_ent_sz
op_ne
l_int|4
op_logical_or
id|header-&gt;dat_fm_tab.fm_tab_ent_cnt
op_ne
id|htons
c_func
(paren
id|STp-&gt;filemark_cnt
OL
id|OS_FM_TAB_MAX
ques
c_cond
id|STp-&gt;filemark_cnt
suffix:colon
id|OS_FM_TAB_MAX
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: Failed consistency check ADR 1.4 format&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
singleline_comment|//&t;&t;memcpy(STp-&gt;header_cache, header, sizeof(os_header_t));
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|osst_analyze_headers
r_static
r_int
id|osst_analyze_headers
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
id|position
comma
id|block
suffix:semicolon
r_int
id|first
comma
id|last
suffix:semicolon
r_int
id|valid
op_assign
l_int|0
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|position
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
(brace
id|STp-&gt;header_ok
op_assign
id|STp-&gt;linux_media
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;linux_media_version
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|STp-&gt;header_ok
op_assign
id|STp-&gt;linux_media
op_assign
id|STp-&gt;linux_media_version
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;wrt_pass_cntr
op_assign
id|STp-&gt;update_frame_cntr
op_assign
op_minus
l_int|1
suffix:semicolon
id|STp-&gt;eod_frame_ppos
op_assign
id|STp-&gt;first_data_ppos
op_assign
op_minus
l_int|1
suffix:semicolon
id|STp-&gt;first_mark_ppos
op_assign
id|STp-&gt;last_mark_ppos
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Reading header&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* optimization for speed - if we are positioned at block 10, read second group first */
multiline_comment|/* TODO try the ADR 1.1 locations for the second group if we have no valid one yet... */
id|first
op_assign
id|position
op_eq
l_int|10
ques
c_cond
l_int|0xbae
suffix:colon
l_int|5
suffix:semicolon
id|last
op_assign
id|position
op_eq
l_int|10
ques
c_cond
l_int|0xbb3
suffix:colon
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|block
op_assign
id|first
suffix:semicolon
id|block
OL
id|last
suffix:semicolon
id|block
op_increment
)paren
r_if
c_cond
(paren
id|__osst_analyze_headers
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
)paren
)paren
id|valid
op_assign
l_int|1
suffix:semicolon
id|first
op_assign
id|position
op_eq
l_int|10
ques
c_cond
l_int|5
suffix:colon
l_int|0xbae
suffix:semicolon
id|last
op_assign
id|position
op_eq
l_int|10
ques
c_cond
l_int|10
suffix:colon
l_int|0xbb3
suffix:semicolon
r_for
c_loop
(paren
id|block
op_assign
id|first
suffix:semicolon
id|block
OL
id|last
suffix:semicolon
id|block
op_increment
)paren
r_if
c_cond
(paren
id|__osst_analyze_headers
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|block
)paren
)paren
id|valid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|valid
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%i: Failed to find valid ADRL header, new media?&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|STp-&gt;eod_frame_ppos
op_assign
id|STp-&gt;first_data_ppos
op_assign
l_int|0
suffix:semicolon
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|10
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|position
op_le
id|STp-&gt;first_data_ppos
)paren
(brace
id|position
op_assign
id|STp-&gt;first_data_ppos
suffix:semicolon
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_file
op_assign
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_block
op_assign
id|STp-&gt;logical_blk_num
op_assign
l_int|0
suffix:semicolon
)brace
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|position
comma
l_int|0
)paren
suffix:semicolon
id|STp-&gt;header_ok
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|osst_verify_position
r_static
r_int
id|osst_verify_position
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
id|frame_position
op_assign
id|STp-&gt;first_frame_position
suffix:semicolon
r_int
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
suffix:semicolon
r_int
id|prev_mark_ppos
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|actual_mark_ppos
comma
id|i
comma
id|n
suffix:semicolon
macro_line|#if 1 
singleline_comment|//DEBUG
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Verify that the tape is really the one we think before writing&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|frame_position
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Couldn&squot;t get logical blk num in verify_position&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;linux_media_version
op_ge
l_int|4
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STp-&gt;filemark_cnt
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|n
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|i
)braket
)paren
)paren
OL
id|frame_position
)paren
id|prev_mark_ppos
op_assign
id|n
suffix:semicolon
)brace
r_else
id|prev_mark_ppos
op_assign
id|frame_position
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* usually - we don&squot;t really know */
id|actual_mark_ppos
op_assign
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_eq
id|OS_FRAME_TYPE_MARKER
ques
c_cond
id|frame_position
op_minus
l_int|1
suffix:colon
id|ntohl
c_func
(paren
id|STp-&gt;buffer-&gt;aux-&gt;last_mark_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame_position
op_ne
id|STp-&gt;first_frame_position
op_logical_or
id|logical_blk_num
op_ne
id|STp-&gt;logical_blk_num
op_plus
l_int|1
op_logical_or
id|prev_mark_ppos
op_ne
id|actual_mark_ppos
)paren
(brace
macro_line|#if 1 
singleline_comment|//DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Block mismatch: frame %d-%d, lblk %d-%d, mark %d-%d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
comma
id|frame_position
comma
id|STp-&gt;logical_blk_num
op_plus
l_int|1
comma
id|logical_blk_num
comma
id|actual_mark_ppos
comma
id|prev_mark_ppos
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;logical_blk_num
op_assign
id|logical_blk_num
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Acc. to OnStream, the vers. numbering is the following:&n; * X.XX for released versions (X=digit), &n; * XXXY for unreleased versions (Y=letter)&n; * Ordering 1.05 &lt; 106A &lt; 106a &lt; 106B &lt; ... &lt; 1.06&n; * This fn makes monoton numbers out of this scheme ...&n; */
DECL|function|osst_parse_firmware_rev
r_static
r_int
r_int
id|osst_parse_firmware_rev
(paren
r_const
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|rev
suffix:semicolon
r_if
c_cond
(paren
id|str
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
id|rev
op_assign
(paren
id|str
(braket
l_int|0
)braket
op_minus
l_int|0x30
)paren
op_star
l_int|10000
op_plus
(paren
id|str
(braket
l_int|2
)braket
op_minus
l_int|0x30
)paren
op_star
l_int|1000
op_plus
(paren
id|str
(braket
l_int|3
)braket
op_minus
l_int|0x30
)paren
op_star
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|rev
op_assign
(paren
id|str
(braket
l_int|0
)braket
op_minus
l_int|0x30
)paren
op_star
l_int|10000
op_plus
(paren
id|str
(braket
l_int|1
)braket
op_minus
l_int|0x30
)paren
op_star
l_int|1000
op_plus
(paren
id|str
(braket
l_int|2
)braket
op_minus
l_int|0x30
)paren
op_star
l_int|100
op_minus
l_int|100
suffix:semicolon
id|rev
op_add_assign
l_int|2
op_star
(paren
id|str
(braket
l_int|3
)braket
op_amp
l_int|0x1f
)paren
op_plus
(paren
id|str
(braket
l_int|3
)braket
op_ge
l_int|0x60
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|rev
suffix:semicolon
)brace
multiline_comment|/*&n; * Configure the OnStream SCII tape drive for default operation&n; */
DECL|function|osst_configure_onstream
r_static
r_int
id|osst_configure_onstream
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
id|osst_mode_parameter_header_t
op_star
id|header
suffix:semicolon
id|osst_block_size_page_t
op_star
id|bs
suffix:semicolon
id|osst_capabilities_page_t
op_star
id|cp
suffix:semicolon
id|osst_tape_paramtr_page_t
op_star
id|prm
suffix:semicolon
r_int
id|drive_buffer_size
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Not Ready&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;os_fw_rev
OL
l_int|10600
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;osst%i: Old OnStream firmware revision detected (%s)&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;device-&gt;rev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;osst%i: An upgrade to version 1.06 or above is recommended&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Configure 32.5KB (data+aux) frame size.&n;&t; * Get the current block size from the block size mode page&n;&t; */
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|BLOCK_SIZE_PAGE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|BLOCK_SIZE_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: Busy&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;osst%i: Can&squot;t get tape block size mode page&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|header
op_assign
(paren
id|osst_mode_parameter_header_t
op_star
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|bs
op_assign
(paren
id|osst_block_size_page_t
op_star
)paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
r_sizeof
(paren
id|osst_mode_parameter_header_t
)paren
op_plus
id|header-&gt;bdl
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: 32KB play back: %s&bslash;n&quot;
comma
id|dev
comma
id|bs-&gt;play32
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: 32.5KB play back: %s&bslash;n&quot;
comma
id|dev
comma
id|bs-&gt;play32_5
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: 32KB record: %s&bslash;n&quot;
comma
id|dev
comma
id|bs-&gt;record32
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: 32.5KB record: %s&bslash;n&quot;
comma
id|dev
comma
id|bs-&gt;record32_5
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Configure default auto columns mode, 32.5KB transfer mode&n;&t; */
id|bs-&gt;one
op_assign
l_int|1
suffix:semicolon
id|bs-&gt;play32
op_assign
l_int|0
suffix:semicolon
id|bs-&gt;play32_5
op_assign
l_int|1
suffix:semicolon
id|bs-&gt;record32
op_assign
l_int|0
suffix:semicolon
id|bs-&gt;record32_5
op_assign
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|BLOCK_SIZE_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;osst%i: Couldn&squot;t set tape block size mode page&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;block_size
op_assign
(paren
id|STp-&gt;raw
)paren
ques
c_cond
id|OS_FRAME_SIZE
suffix:colon
id|OS_DATA_SIZE
suffix:semicolon
id|STp-&gt;min_block
op_assign
id|OS_FRAME_SIZE
suffix:semicolon
multiline_comment|/* FIXME */
id|STp-&gt;max_block
op_assign
id|STp-&gt;block_size
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%i: Block Size changed to 32.5K&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * In debug mode, we want to see as many errors as possible&n;&t; * to test the error recovery mechanism.&n;&t; */
id|osst_set_retries
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|0
)paren
suffix:semicolon
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Set vendor name to &squot;LIN4&squot; for &quot;Linux support version 4&quot;.&n;&t; */
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|VENDOR_IDENT_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|header-&gt;mode_data_length
op_assign
id|VENDOR_IDENT_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
op_minus
l_int|1
suffix:semicolon
id|header-&gt;medium_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Medium Type - ignoring */
id|header-&gt;dsp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved */
id|header-&gt;bdl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Block Descriptor Length */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|0
)braket
op_assign
id|VENDOR_IDENT_PAGE
op_or
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|1
)braket
op_assign
l_int|6
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_assign
l_char|&squot;L&squot;
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|4
)braket
op_assign
l_char|&squot;N&squot;
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|5
)braket
op_assign
l_char|&squot;4&squot;
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;osst%i: Couldn&squot;t set vendor name to %s&bslash;n&quot;
comma
id|dev
comma
(paren
r_char
op_star
)paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|CAPABILITIES_PAGE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|CAPABILITIES_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;osst%i: can&squot;t get capabilities page&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|header
op_assign
(paren
id|osst_mode_parameter_header_t
op_star
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|cp
op_assign
(paren
id|osst_capabilities_page_t
op_star
)paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
r_sizeof
(paren
id|osst_mode_parameter_header_t
)paren
op_plus
id|header-&gt;bdl
)paren
suffix:semicolon
id|drive_buffer_size
op_assign
id|ntohs
c_func
(paren
id|cp-&gt;buffer_size
)paren
op_div
l_int|2
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|TAPE_PARAMTR_PAGE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|TAPE_PARAMTR_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;osst%i: can&squot;t get tape parameter page&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|header
op_assign
(paren
id|osst_mode_parameter_header_t
op_star
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|prm
op_assign
(paren
id|osst_tape_paramtr_page_t
op_star
)paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
r_sizeof
(paren
id|osst_mode_parameter_header_t
)paren
op_plus
id|header-&gt;bdl
)paren
suffix:semicolon
id|STp-&gt;density
op_assign
id|prm-&gt;density
suffix:semicolon
id|STp-&gt;capacity
op_assign
id|ntohs
c_func
(paren
id|prm-&gt;segtrk
)paren
op_star
id|ntohs
c_func
(paren
id|prm-&gt;trks
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Density %d, tape length: %dMB, drive buffer size: %dKB&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;density
comma
id|STp-&gt;capacity
op_div
l_int|32
comma
id|drive_buffer_size
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Step over EOF if it has been inadvertently crossed (ioctl not used because&n;   it messes up the block number). */
DECL|function|cross_eof
r_static
r_int
id|cross_eof
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|forward
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Stepping over filemark %s.&bslash;n&quot;
comma
id|dev
comma
id|forward
ques
c_cond
l_string|&quot;forward&quot;
suffix:colon
l_string|&quot;backward&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|forward
)paren
(brace
multiline_comment|/* assumes that the filemark is already read by the drive, so this is low cost */
id|result
op_assign
id|osst_space_over_filemarks_forward_slow
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|MTFSF
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* assumes this is only called if we just read the filemark! */
id|result
op_assign
id|osst_seek_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;logical_blk_num
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Stepping over filemark %s failed.&bslash;n&quot;
comma
id|dev
comma
id|forward
ques
c_cond
l_string|&quot;forward&quot;
suffix:colon
l_string|&quot;backward&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Get the tape position. */
DECL|function|osst_get_frame_position
r_static
r_int
id|osst_get_frame_position
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
r_char
id|scmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* KG: We want to be able to use it for checking Write Buffer availability&n;&t; *  and thus don&squot;t want to risk to overwrite anything. Exchange buffers ... */
r_char
id|mybuf
(braket
l_int|24
)braket
suffix:semicolon
r_char
op_star
id|olddata
op_assign
id|STp-&gt;buffer-&gt;b_data
suffix:semicolon
r_int
id|oldsize
op_assign
id|STp-&gt;buffer-&gt;buffer_size
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|memset
(paren
id|scmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|scmd
(braket
l_int|0
)braket
op_assign
id|READ_POSITION
suffix:semicolon
id|STp-&gt;buffer-&gt;b_data
op_assign
id|mybuf
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_size
op_assign
l_int|24
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|scmd
comma
l_int|20
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|STp-&gt;buffer-&gt;b_data
op_assign
id|olddata
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_size
op_assign
id|oldsize
suffix:semicolon
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
)paren
id|result
op_assign
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|3
)paren
ques
c_cond
op_minus
id|EIO
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EINVAL
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Can&squot;t read tape position.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EIO
)paren
(brace
multiline_comment|/* re-read position */
r_int
r_char
id|mysense
(braket
l_int|16
)braket
suffix:semicolon
id|memcpy
(paren
id|mysense
comma
id|SRpnt-&gt;sr_sense_buffer
comma
l_int|16
)paren
suffix:semicolon
id|memset
(paren
id|scmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|scmd
(braket
l_int|0
)braket
op_assign
id|READ_POSITION
suffix:semicolon
id|STp-&gt;buffer-&gt;b_data
op_assign
id|mybuf
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_size
op_assign
l_int|24
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|scmd
comma
l_int|20
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;buffer-&gt;syscall_result
)paren
id|memcpy
(paren
id|SRpnt-&gt;sr_sense_buffer
comma
id|mysense
comma
l_int|16
)paren
suffix:semicolon
)brace
id|STp-&gt;first_frame_position
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|7
)braket
suffix:semicolon
id|STp-&gt;last_frame_position
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|8
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
suffix:semicolon
id|STp-&gt;cur_frames
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|15
)braket
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Drive Positions: host %d, tape %d%s, buffer %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
comma
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot; (BOP)&quot;
suffix:colon
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot; (EOP)&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|STp-&gt;cur_frames
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;cur_frames
op_eq
l_int|0
op_logical_and
id|STp-&gt;first_frame_position
op_ne
id|STp-&gt;last_frame_position
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Correcting read position %d, %d, %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
comma
id|STp-&gt;last_frame_position
comma
id|STp-&gt;cur_frames
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;first_frame_position
op_assign
id|STp-&gt;last_frame_position
suffix:semicolon
)brace
)brace
id|STp-&gt;buffer-&gt;b_data
op_assign
id|olddata
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_size
op_assign
id|oldsize
suffix:semicolon
r_return
(paren
id|result
op_eq
l_int|0
ques
c_cond
id|STp-&gt;first_frame_position
suffix:colon
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the tape block */
DECL|function|osst_set_frame_position
r_static
r_int
id|osst_set_frame_position
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|block
comma
r_int
id|skip
)paren
(brace
r_int
r_char
id|scmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|timeout
op_assign
id|STp-&gt;long_timeout
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|block
template_param
id|STp-&gt;capacity
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Reposition request %d out of range&bslash;n&quot;
comma
id|dev
comma
id|block
)paren
suffix:semicolon
id|block
op_assign
id|block
OL
l_int|0
ques
c_cond
l_int|0
suffix:colon
(paren
id|STp-&gt;capacity
op_minus
l_int|1
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Setting block to %d.&bslash;n&quot;
comma
id|dev
comma
id|block
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
id|scmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|scmd
(braket
l_int|0
)braket
op_assign
id|SEEK_10
suffix:semicolon
id|scmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|scmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|24
)paren
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
suffix:semicolon
id|scmd
(braket
l_int|5
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
suffix:semicolon
id|scmd
(braket
l_int|6
)braket
op_assign
id|block
suffix:semicolon
r_if
c_cond
(paren
id|skip
)paren
id|scmd
(braket
l_int|9
)braket
op_assign
l_int|0x80
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|scmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
id|STp-&gt;first_frame_position
op_assign
id|STp-&gt;last_frame_position
op_assign
id|block
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: SEEK command failed.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* osst versions of st functions - augmented and stripped to suit OnStream only */
multiline_comment|/* Flush the write buffer (never need to write if variable blocksize). */
DECL|function|osst_flush_write_buffer
r_static
r_int
id|osst_flush_write_buffer
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|file_blk
)paren
(brace
r_int
id|offset
comma
id|transfer
comma
id|blks
op_assign
l_int|0
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
)paren
(brace
r_if
c_cond
(paren
id|SRpnt
op_eq
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
)paren
macro_line|#if DEBUG
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: aSRpnt points to Scsi_Request that write_behind_check will release -- cleared&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
op_star
id|aSRpnt
op_assign
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if DEBUG
)brace
r_else
r_if
c_cond
(paren
id|SRpnt
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: aSRpnt does not point to Scsi_Request that write_behind_check will release -- strange&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif&t;
id|osst_write_behind_check
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Async write error (flush) %x.&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
op_eq
id|INT_MAX
)paren
r_return
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;dirty
op_eq
l_int|1
)paren
(brace
id|offset
op_assign
id|STp-&gt;buffer-&gt;buffer_bytes
suffix:semicolon
id|transfer
op_assign
id|OS_FRAME_SIZE
suffix:semicolon
id|blks
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Flushing %d bytes, Tranfering %d bytes in %d blocks.&bslash;n&quot;
comma
id|dev
comma
id|offset
comma
id|transfer
comma
id|blks
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|offset
OL
id|OS_DATA_SIZE
)paren
id|osst_zero_buffer_tail
c_func
(paren
id|STp-&gt;buffer
)paren
suffix:semicolon
multiline_comment|/* TODO: Error handling! */
r_if
c_cond
(paren
id|STp-&gt;poll
)paren
id|result
op_assign
id|osst_wait_frame
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;first_frame_position
comma
op_minus
l_int|50
comma
l_int|120
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
op_star
id|aSRpnt
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: write sense [0]=0x%02x [2]=%02x [12]=%02x [13]=%02x&bslash;n&quot;
comma
id|dev
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
op_logical_and
multiline_comment|/* FIXME - SC-30 drive doesn&squot;t assert EOM bit */
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NO_SENSE
)paren
(brace
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|osst_write_error_recovery
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Error on flush.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|file_blk
op_logical_and
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
id|STp-&gt;first_frame_position
op_add_assign
id|blks
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Exit flush write buffer with code %d&bslash;n&quot;
comma
id|dev
comma
id|result
)paren
suffix:semicolon
macro_line|#endif
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Flush the tape buffer. The tape will be positioned correctly unless&n;   seek_next is true. */
DECL|function|osst_flush_buffer
r_static
r_int
id|osst_flush_buffer
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
id|seek_next
)paren
(brace
r_int
id|backspace
comma
id|result
suffix:semicolon
id|OSST_buffer
op_star
id|STbuffer
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
macro_line|#if DEBUG
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
macro_line|#endif
id|STbuffer
op_assign
id|STp-&gt;buffer
suffix:semicolon
multiline_comment|/*&n;&t; * If there was a bus reset, block further access&n;&t; * to this device.&n;&t; */
r_if
c_cond
(paren
id|STp-&gt;device-&gt;was_reset
)paren
(brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
l_int|0
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
multiline_comment|/* Writing */
r_return
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
id|aSRpnt
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Reached flush (read) buffer&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|backspace
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
)paren
op_div
id|STp-&gt;block_size
op_minus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|seek_next
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
id|result
op_assign
id|cross_eof
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* Back over the EOF hit */
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
op_logical_and
id|backspace
OG
l_int|0
)paren
multiline_comment|/* TODO -- design and run a test case for this */
id|result
op_assign
id|osst_seek_logical_blk
c_func
(paren
id|STp
comma
id|aSRpnt
comma
id|STp-&gt;logical_blk_num
op_minus
id|backspace
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Entry points to osst */
multiline_comment|/* Write command */
DECL|function|osst_write
r_static
id|ssize_t
id|osst_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|ssize_t
id|total
comma
id|retval
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|i
comma
id|do_count
comma
id|blks
comma
id|transfer
suffix:semicolon
r_int
id|write_threshold
suffix:semicolon
r_int
id|doing_write
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_const
r_char
op_star
id|b_point
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
)paren
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are in the middle of error recovery, don&squot;t let anyone&n;&t; * else try and use this device.  Also, if error recovery fails, it&n;&t; * may try and take the device offline, in which case all further&n;&t; * access to the device is prohibited.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
(brace
multiline_comment|/* &quot;A request was outside the capabilities of the device.&quot; */
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
id|retval
op_assign
(paren
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_else
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * If there was a bus reset, block further access&n;&t; * to this device.&n;&t; */
r_if
c_cond
(paren
id|STp-&gt;device-&gt;was_reset
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Write must be integral number of blocks */
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Write (%ld bytes) not multiple of tape block size (32k).&bslash;n&quot;
comma
id|dev
comma
(paren
r_int
r_int
)paren
id|count
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;first_frame_position
op_ge
id|STp-&gt;capacity
op_minus
l_int|164
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Write truncated at EOM early warning (frame %d).&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;first_frame_position
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;do_auto_lock
op_logical_and
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
op_logical_and
op_logical_neg
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_READING
)paren
(brace
id|retval
op_assign
id|osst_flush_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;rw
op_ne
id|ST_WRITING
)paren
(brace
multiline_comment|/* Are we totally rewriting this tape? */
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;header_ok
op_logical_or
id|STp-&gt;first_frame_position
op_eq
id|STp-&gt;first_data_ppos
op_logical_or
(paren
id|STps-&gt;drv_file
op_eq
l_int|0
op_logical_and
id|STps-&gt;drv_block
op_eq
l_int|0
)paren
)paren
(brace
id|STp-&gt;wrt_pass_cntr
op_increment
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Allocating next write pass counter: %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;wrt_pass_cntr
)paren
suffix:semicolon
macro_line|#endif
id|osst_reset_header
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
id|STp-&gt;logical_blk_num
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do we know where we&squot;ll be writing on the tape? */
r_else
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;fast_open
op_logical_and
id|osst_verify_position
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
)paren
op_logical_or
id|STps-&gt;drv_file
OL
l_int|0
op_logical_or
id|STps-&gt;drv_block
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;first_frame_position
op_eq
id|STp-&gt;eod_frame_ppos
)paren
(brace
id|STps-&gt;drv_file
op_assign
id|STp-&gt;filemark_cnt
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We have no idea where the tape is positioned - give up */
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Cannot write at indeterminate position.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
OG
l_int|0
op_logical_and
id|STps-&gt;drv_file
OL
id|STp-&gt;filemark_cnt
)paren
(brace
id|STp-&gt;filemark_cnt
op_assign
id|STps-&gt;drv_file
suffix:semicolon
id|STp-&gt;last_mark_ppos
op_assign
id|ntohl
c_func
(paren
id|STp-&gt;header_cache-&gt;dat_fm_tab.fm_tab_ent
(braket
id|STp-&gt;filemark_cnt
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Overwriting file %d with old write pass counter %d&bslash;n&quot;
comma
id|dev
comma
id|STps-&gt;drv_file
comma
id|STp-&gt;wrt_pass_cntr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: may lead to stale data being accepted on reading back!&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: resetting filemark count to %d and last mark ppos to %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;filemark_cnt
comma
id|STp-&gt;last_mark_ppos
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|STp-&gt;fast_open
op_assign
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;header_ok
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Write cannot proceed without valid headers&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
)paren
(brace
r_if
c_cond
(paren
id|SRpnt
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst%d: Not supposed to have SRpnt at line %d&bslash;n&quot;
comma
id|dev
comma
id|__LINE__
)paren
suffix:semicolon
id|osst_write_behind_check
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Async write error (write) %x.&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|midlevel_result
op_eq
id|INT_MAX
)paren
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
r_else
id|STps-&gt;eof
op_assign
id|ST_EOM_ERROR
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOM_OK
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOM_ERROR
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check the buffer readability in cases where copy_user might catch&n;&t;&t; the problems after some tape movement. */
r_if
c_cond
(paren
(paren
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
op_plus
id|count
op_minus
l_int|1
comma
l_int|1
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;do_buffer_writes
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Write must be integral number of blocks */
macro_line|#endif
id|write_threshold
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|write_threshold
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_star
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;do_async_writes
)paren
id|write_threshold
op_decrement
suffix:semicolon
id|total
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|STp
op_member_access_from_pointer
id|raw
)paren
op_logical_and
(paren
id|STp-&gt;first_frame_position
op_eq
l_int|0xbae
)paren
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Skipping over config partition.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* error recovery may have bumped us past the header partition */
r_if
c_cond
(paren
id|osst_get_frame_position
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
OL
l_int|0xbb8
)paren
id|osst_position_tape_and_confirm
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|0xbb8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;poll
)paren
id|retval
op_assign
id|osst_wait_frame
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;first_frame_position
comma
op_minus
l_int|50
comma
l_int|60
)paren
suffix:semicolon
multiline_comment|/* TODO: Check for an error ! */
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_WRITING
suffix:semicolon
id|STp-&gt;write_type
op_assign
id|OS_WRITE_DATA
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Writing %d bytes to file %d block %d lblk %d frame %d&bslash;n&quot;
comma
id|dev
comma
id|count
comma
id|STps-&gt;drv_file
comma
id|STps-&gt;drv_block
comma
id|STp-&gt;logical_blk_num
comma
id|STp-&gt;first_frame_position
)paren
suffix:semicolon
macro_line|#endif
id|b_point
op_assign
id|buf
suffix:semicolon
r_while
c_loop
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
id|count
OG
id|write_threshold
)paren
(brace
id|doing_write
op_assign
l_int|1
suffix:semicolon
id|do_count
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_star
id|STp-&gt;block_size
op_minus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:semicolon
r_if
c_cond
(paren
id|do_count
OG
id|count
)paren
id|do_count
op_assign
id|count
suffix:semicolon
id|i
op_assign
id|append_to_buffer
c_func
(paren
id|b_point
comma
id|STp-&gt;buffer
comma
id|do_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|transfer
op_assign
id|OS_FRAME_SIZE
suffix:semicolon
id|blks
op_assign
l_int|1
suffix:semicolon
id|osst_init_aux
c_func
(paren
id|STp
comma
id|OS_FRAME_TYPE_DATA
comma
id|STp-&gt;logical_blk_num
op_increment
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Error on write:&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|transfer
op_assign
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
r_else
id|transfer
op_assign
l_int|0
suffix:semicolon
id|transfer
op_mul_assign
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
id|transfer
op_le
id|do_count
)paren
(brace
id|filp-&gt;f_pos
op_add_assign
id|do_count
op_minus
id|transfer
suffix:semicolon
id|count
op_sub_assign
id|do_count
op_minus
id|transfer
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
id|STps-&gt;drv_block
op_add_assign
(paren
id|do_count
op_minus
id|transfer
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
multiline_comment|/* EOM within current request */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: EOM with %d bytes unwritten.&bslash;n&quot;
comma
id|dev
comma
id|transfer
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|STps-&gt;eof
op_assign
id|ST_EOM_ERROR
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Too cautious? */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* EOM for old data */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: EOM with lost data.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|osst_write_error_recovery
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|1
)paren
op_eq
l_int|0
)paren
r_goto
id|ok
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Too cautious? */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|total
)paren
id|retval
op_assign
id|total
op_minus
id|count
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STp-&gt;first_frame_position
op_increment
suffix:semicolon
id|ok
suffix:colon
id|filp-&gt;f_pos
op_add_assign
id|do_count
suffix:semicolon
id|b_point
op_add_assign
id|do_count
suffix:semicolon
id|count
op_sub_assign
id|do_count
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
id|STps-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
)brace
id|STp-&gt;first_frame_position
op_add_assign
id|blks
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ne
l_int|0
)paren
(brace
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
id|i
op_assign
id|append_to_buffer
c_func
(paren
id|b_point
comma
id|STp-&gt;buffer
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|doing_write
op_logical_and
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STm-&gt;do_async_writes
op_logical_and
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_ge
id|STp-&gt;write_threshold
op_logical_and
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_ge
id|OS_DATA_SIZE
)paren
)paren
(brace
multiline_comment|/* Schedule an asynchronous write */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_div
id|STp-&gt;block_size
)paren
op_star
id|STp-&gt;block_size
suffix:semicolon
id|STp-&gt;dirty
op_assign
op_logical_neg
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_eq
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
suffix:semicolon
id|transfer
op_assign
id|OS_FRAME_SIZE
suffix:semicolon
id|blks
op_assign
l_int|1
suffix:semicolon
id|osst_init_aux
c_func
(paren
id|STp
comma
id|OS_FRAME_TYPE_DATA
comma
id|STp-&gt;logical_blk_num
op_increment
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
macro_line|#if DEBUG
id|STp-&gt;write_pending
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
singleline_comment|//    else if (SRpnt != NULL) {
singleline_comment|//&t;scsi_release_request(SRpnt);&t;/* FIXME -- this relesae no longer in st - why? */
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prevent releasing this request! */
singleline_comment|//    }
id|STps-&gt;at_sm
op_and_assign
(paren
id|total
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|total
OG
l_int|0
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|retval
op_assign
id|total
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|SRpnt
op_ne
l_int|NULL
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Read command */
DECL|function|osst_read
r_static
id|ssize_t
id|osst_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|ssize_t
id|total
comma
id|retval
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|i
comma
id|transfer
suffix:semicolon
r_int
id|special
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
)paren
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are in the middle of error recovery, don&squot;t let anyone&n;&t; * else try and use this device.  Also, if error recovery fails, it&n;&t; * may try and take the device offline, in which case all further&n;&t; * access to the device is prohibited.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
(brace
multiline_comment|/* &quot;A request was outside the capabilities of the device.&quot; */
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
id|retval
op_assign
(paren
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_else
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Must have initialized medium */
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;header_ok
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Use multiple of %d bytes as block size (%ld requested)&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;block_size
comma
(paren
r_int
r_int
)paren
id|count
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* Read must be integral number of blocks */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;do_auto_lock
op_logical_and
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
op_logical_and
op_logical_neg
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
(brace
id|retval
op_assign
id|osst_flush_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
id|STps-&gt;eof
op_ne
id|ST_NOEOF
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: EOF/EOM flag up (%d). Bytes %d&bslash;n&quot;
comma
id|dev
comma
id|STps-&gt;eof
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_eq
l_int|0
op_logical_and
id|STps-&gt;eof
op_ge
id|ST_EOD_1
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
OL
id|ST_EOD
)paren
(brace
id|STps-&gt;eof
op_add_assign
l_int|1
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* EOM or Blank Check */
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check the buffer writability before any tape movement. Don&squot;t alter&n;&t;&t; buffer data. */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_to_user
(paren
id|buf
comma
op_amp
id|i
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
op_plus
id|count
op_minus
l_int|1
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_to_user
(paren
id|buf
op_plus
id|count
op_minus
l_int|1
comma
op_amp
id|i
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Loop until enough data in buffer or a special condition found */
r_for
c_loop
(paren
id|total
op_assign
l_int|0
comma
id|special
op_assign
l_int|0
suffix:semicolon
id|total
OL
id|count
op_logical_and
op_logical_neg
id|special
suffix:semicolon
)paren
(brace
multiline_comment|/* Get new data if the buffer is empty */
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_eq
l_int|0
)paren
(brace
id|special
op_assign
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;logical_blk_num
comma
l_int|0
)paren
suffix:semicolon
id|STp-&gt;buffer-&gt;buffer_bytes
op_assign
id|special
ques
c_cond
l_int|0
suffix:colon
id|OS_DATA_SIZE
suffix:semicolon
id|STp-&gt;buffer-&gt;read_pointer
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;logical_blk_num
op_increment
suffix:semicolon
multiline_comment|/* block to look for next time */
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|special
OL
l_int|0
)paren
(brace
multiline_comment|/* No need to continue read */
id|retval
op_assign
id|special
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STps-&gt;drv_block
op_increment
suffix:semicolon
)brace
multiline_comment|/* Move the data from driver buffer to user buffer */
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
OG
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
id|STps-&gt;eof
op_ne
id|ST_NOEOF
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: EOF up (%d). Left %d, needed %d.&bslash;n&quot;
comma
id|dev
comma
id|STps-&gt;eof
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
comma
id|count
op_minus
id|total
)paren
suffix:semicolon
macro_line|#endif
id|transfer
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
OL
id|count
op_minus
id|total
ques
c_cond
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:colon
id|count
op_minus
id|total
suffix:semicolon
id|i
op_assign
id|from_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|buf
comma
id|transfer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_add_assign
id|transfer
suffix:semicolon
id|buf
op_add_assign
id|transfer
suffix:semicolon
id|total
op_add_assign
id|transfer
suffix:semicolon
)brace
)brace
multiline_comment|/* for (total = 0, special = 0; total &lt; count &amp;&amp; !special; ) */
multiline_comment|/* Change the eof state if no data from tape or buffer */
r_if
c_cond
(paren
id|total
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
id|STps-&gt;eof
op_assign
(paren
id|STp-&gt;first_frame_position
op_ge
id|STp-&gt;eod_frame_ppos
)paren
ques
c_cond
id|ST_EOD
suffix:colon
id|ST_FM
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOD_1
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_EOD_2
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
OG
l_int|0
op_logical_and
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOD_2
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|retval
op_assign
id|total
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|SRpnt
op_ne
l_int|NULL
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Set the driver options */
DECL|function|osst_log_options
r_static
r_void
id|osst_log_options
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|ST_mode
op_star
id|STm
comma
r_int
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Mode %d options: buffer writes: %d, async writes: %d, read ahead: %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;current_mode
comma
id|STm-&gt;do_buffer_writes
comma
id|STm-&gt;do_async_writes
comma
id|STm-&gt;do_read_ahead
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d:    can bsr: %d, two FMs: %d, fast mteom: %d, auto lock: %d,&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;can_bsr
comma
id|STp-&gt;two_fm
comma
id|STp-&gt;fast_mteom
comma
id|STp-&gt;do_auto_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d:    defs for wr: %d, no block limits: %d, partitions: %d, s2 log: %d&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;defaults_for_writes
comma
id|STp-&gt;omit_blklims
comma
id|STp-&gt;can_partitions
comma
id|STp-&gt;scsi2_logical
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d:    sysv: %d&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;sysv
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d:    debugging: %d&bslash;n&quot;
comma
id|dev
comma
id|debugging
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|osst_set_options
r_static
r_int
id|osst_set_options
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
r_int
id|options
)paren
(brace
r_int
id|value
suffix:semicolon
r_int
id|code
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|memcpy
c_func
(paren
id|STm
comma
op_amp
(paren
id|STp-&gt;modes
(braket
l_int|0
)braket
)paren
comma
r_sizeof
(paren
id|ST_mode
)paren
)paren
suffix:semicolon
id|modes_defined
op_assign
id|TRUE
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Initialized mode %d definition from mode 0&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;current_mode
)paren
suffix:semicolon
macro_line|#endif
)brace
id|code
op_assign
id|options
op_amp
id|MT_ST_OPTIONS
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_BOOLEANS
)paren
(brace
id|STm-&gt;do_buffer_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_BUFFER_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;do_async_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_ASYNC_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;defaults_for_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_DEF_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;do_read_ahead
op_assign
(paren
id|options
op_amp
id|MT_ST_READ_AHEAD
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;two_fm
op_assign
(paren
id|options
op_amp
id|MT_ST_TWO_FM
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;fast_mteom
op_assign
(paren
id|options
op_amp
id|MT_ST_FAST_MTEOM
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;do_auto_lock
op_assign
(paren
id|options
op_amp
id|MT_ST_AUTO_LOCK
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;can_bsr
op_assign
(paren
id|options
op_amp
id|MT_ST_CAN_BSR
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;omit_blklims
op_assign
(paren
id|options
op_amp
id|MT_ST_NO_BLKLIMS
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
)paren
id|STp-&gt;can_partitions
op_assign
(paren
id|options
op_amp
id|MT_ST_CAN_PARTITIONS
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;scsi2_logical
op_assign
(paren
id|options
op_amp
id|MT_ST_SCSI2LOGICAL
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;sysv
op_assign
(paren
id|options
op_amp
id|MT_ST_SYSV
)paren
op_ne
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|debugging
op_assign
(paren
id|options
op_amp
id|MT_ST_DEBUGGING
)paren
op_ne
l_int|0
suffix:semicolon
macro_line|#endif
id|osst_log_options
c_func
(paren
id|STp
comma
id|STm
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_SETBOOLEANS
op_logical_or
id|code
op_eq
id|MT_ST_CLEARBOOLEANS
)paren
(brace
id|value
op_assign
(paren
id|code
op_eq
id|MT_ST_SETBOOLEANS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_BUFFER_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_buffer_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_ASYNC_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_async_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_DEF_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;defaults_for_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_READ_AHEAD
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_read_ahead
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_TWO_FM
)paren
op_ne
l_int|0
)paren
id|STp-&gt;two_fm
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_FAST_MTEOM
)paren
op_ne
l_int|0
)paren
id|STp-&gt;fast_mteom
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_AUTO_LOCK
)paren
op_ne
l_int|0
)paren
id|STp-&gt;do_auto_lock
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_CAN_BSR
)paren
op_ne
l_int|0
)paren
id|STp-&gt;can_bsr
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_NO_BLKLIMS
)paren
op_ne
l_int|0
)paren
id|STp-&gt;omit_blklims
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
id|options
op_amp
id|MT_ST_CAN_PARTITIONS
)paren
op_ne
l_int|0
)paren
id|STp-&gt;can_partitions
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_SCSI2LOGICAL
)paren
op_ne
l_int|0
)paren
id|STp-&gt;scsi2_logical
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_SYSV
)paren
op_ne
l_int|0
)paren
id|STm-&gt;sysv
op_assign
id|value
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_DEBUGGING
)paren
op_ne
l_int|0
)paren
id|debugging
op_assign
id|value
suffix:semicolon
macro_line|#endif
id|osst_log_options
c_func
(paren
id|STp
comma
id|STm
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_WRITE_THRESHOLD
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
op_star
id|ST_KILOBYTE
suffix:semicolon
r_if
c_cond
(paren
id|value
template_param
id|osst_buffer_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Write threshold %d too small or too large.&bslash;n&quot;
comma
id|dev
comma
id|value
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;write_threshold
op_assign
id|value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Write threshold set to %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_BLKSIZE
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
op_complement
id|MT_ST_OPTIONS
)paren
(brace
id|STm-&gt;default_blksize
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Default block size disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_blksize
op_assign
id|value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Default block size set to %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;default_blksize
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_TIMEOUTS
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_amp
id|MT_ST_SET_LONG_TIMEOUT
)paren
op_ne
l_int|0
)paren
(brace
id|STp-&gt;long_timeout
op_assign
(paren
id|value
op_amp
op_complement
id|MT_ST_SET_LONG_TIMEOUT
)paren
op_star
id|HZ
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Long timeout set to %d seconds.&bslash;n&quot;
comma
id|dev
comma
(paren
id|value
op_amp
op_complement
id|MT_ST_SET_LONG_TIMEOUT
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;timeout
op_assign
id|value
op_star
id|HZ
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Normal timeout set to %d seconds.&bslash;n&quot;
comma
id|dev
comma
id|value
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_OPTIONS
)paren
(brace
id|code
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_CLEAR_DEFAULT
)paren
suffix:semicolon
id|value
op_assign
(paren
id|options
op_amp
id|MT_ST_CLEAR_DEFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_DENSITY
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STm-&gt;default_density
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Density default disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_density
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Density default set to %x&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;default_density
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_DRVBUFFER
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STp-&gt;default_drvbuffer
op_assign
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Drive buffer default disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;default_drvbuffer
op_assign
id|value
op_amp
l_int|7
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Drive buffer default set to %x&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;default_drvbuffer
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_COMPRESSION
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STm-&gt;default_compression
op_assign
id|ST_DONT_TOUCH
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Compression default disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_compression
op_assign
(paren
id|value
op_amp
l_int|1
ques
c_cond
id|ST_YES
suffix:colon
id|ST_NO
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst%d: Compression default set to %x&bslash;n&quot;
comma
id|dev
comma
(paren
id|value
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Internal ioctl function */
DECL|function|osst_int_ioctl
r_static
r_int
id|osst_int_ioctl
c_func
(paren
id|OS_Scsi_Tape
op_star
id|STp
comma
id|Scsi_Request
op_star
op_star
id|aSRpnt
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
id|ltmp
suffix:semicolon
r_int
id|i
comma
id|ioctl_result
suffix:semicolon
r_int
id|chg_eof
op_assign
id|TRUE
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|fileno
comma
id|blkno
comma
id|at_sm
comma
id|logical_blk_num
suffix:semicolon
r_int
id|datalen
op_assign
l_int|0
comma
id|direction
op_assign
id|SCSI_DATA_NONE
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
op_logical_and
id|cmd_in
op_ne
id|MTLOAD
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
r_return
(paren
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_else
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|timeout
op_assign
id|STp-&gt;long_timeout
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|fileno
op_assign
id|STps-&gt;drv_file
suffix:semicolon
id|blkno
op_assign
id|STps-&gt;drv_block
suffix:semicolon
id|at_sm
op_assign
id|STps-&gt;at_sm
suffix:semicolon
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|MTFSFM
suffix:colon
id|chg_eof
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* Changed from the FSF after this */
r_case
id|MTFSF
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;linux_media
)paren
id|ioctl_result
op_assign
id|osst_space_over_filemarks_forward_fast
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|cmd_in
comma
id|arg
)paren
suffix:semicolon
r_else
id|ioctl_result
op_assign
id|osst_space_over_filemarks_forward_slow
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|cmd_in
comma
id|arg
)paren
suffix:semicolon
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
suffix:semicolon
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
r_case
id|MTBSF
suffix:colon
id|chg_eof
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* Changed from the FSF after this */
r_case
id|MTBSFM
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;raw
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|ioctl_result
op_assign
id|osst_space_over_filemarks_backward
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|cmd_in
comma
id|arg
)paren
suffix:semicolon
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
suffix:semicolon
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_sub_assign
id|arg
suffix:semicolon
id|blkno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We can&squot;t know the block number */
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
r_case
id|MTFSR
suffix:colon
r_case
id|MTBSR
suffix:colon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Skipping %lu blocks %s from logical block %d&bslash;n&quot;
comma
id|dev
comma
id|arg
comma
id|cmd_in
op_eq
id|MTFSR
ques
c_cond
l_string|&quot;forward&quot;
suffix:colon
l_string|&quot;backward&quot;
comma
id|logical_blk_num
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSR
)paren
(brace
id|logical_blk_num
op_add_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_add_assign
id|arg
suffix:semicolon
)brace
r_else
(brace
id|logical_blk_num
op_sub_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_sub_assign
id|arg
suffix:semicolon
)brace
id|ioctl_result
op_assign
id|osst_seek_logical_blk
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|logical_blk_num
op_minus
l_int|1
)paren
suffix:semicolon
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
r_case
id|MTFSS
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Space Setmarks */
multiline_comment|/* FIXME -- OS can&squot;t do this? */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Spacing tape forward %d setmarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
)paren
(brace
id|blkno
op_assign
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|at_sm
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTBSS
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Space Setmarks */
multiline_comment|/* FIXME -- OS can&squot;t do this? */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|ltmp
op_assign
l_int|0xff000000
suffix:semicolon
id|ltmp
op_assign
id|ltmp
op_or
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Spacing tape backward %ld setmarks.&bslash;n&quot;
comma
id|dev
comma
(paren
op_minus
id|ltmp
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
)paren
(brace
id|blkno
op_assign
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|at_sm
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
op_logical_and
op_logical_neg
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
)paren
id|ioctl_result
op_assign
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|1
)paren
suffix:semicolon
r_else
id|ioctl_result
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arg
suffix:semicolon
id|i
op_increment
)paren
id|ioctl_result
op_or_assign
id|osst_write_filemark
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
suffix:semicolon
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_assign
l_int|0
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
r_case
id|MTWSM
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;raw
)paren
r_return
l_int|0
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
multiline_comment|/* FIXME -- need OS version */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWSM
)paren
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|timeout
op_assign
id|STp-&gt;timeout
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWEOF
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Writing %d filemarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Writing %d setmarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_assign
(paren
id|cmd_in
op_eq
id|MTWSM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
r_case
id|MTLOAD
suffix:colon
r_case
id|MTUNLOAD
suffix:colon
r_case
id|MTRETEN
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOAD
)paren
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* load */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTRETEN
)paren
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* retension then mount */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTOFFL
)paren
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* rewind then eject */
id|timeout
op_assign
id|STp-&gt;timeout
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|MTUNLOAD
suffix:colon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Unloading tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOAD
suffix:colon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Loading tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTRETEN
suffix:colon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Retensioning tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Ejecting tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
id|logical_blk_num
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: No op on tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Should do something ? */
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Spacing to end of recorded medium.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|osst_set_frame_position
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;eod_frame_ppos
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_get_logical_blk
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|ioctl_result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;aux-&gt;frame_type
op_ne
id|OS_FRAME_TYPE_EOD
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: No EOD frame found where expected.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|ioctl_result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
)brace
id|ioctl_result
op_assign
id|osst_set_frame_position
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;eod_frame_ppos
comma
l_int|0
)paren
suffix:semicolon
id|logical_blk_num
op_assign
id|STp-&gt;logical_blk_num
suffix:semicolon
id|fileno
op_assign
id|STp-&gt;filemark_cnt
suffix:semicolon
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
r_case
id|MTERASE
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|ioctl_result
op_assign
id|osst_reset_header
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
id|i
op_assign
id|osst_write_eod
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|ioctl_result
)paren
id|ioctl_result
op_assign
id|i
suffix:semicolon
id|i
op_assign
id|osst_position_tape_and_confirm
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;eod_frame_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|ioctl_result
)paren
id|ioctl_result
op_assign
id|i
suffix:semicolon
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
id|logical_blk_num
op_assign
l_int|0
suffix:semicolon
r_goto
id|os_bypass
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|REZERO_UNIT
suffix:semicolon
multiline_comment|/* rewind */
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Rewinding tape, Immed=%d.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
id|logical_blk_num
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOCK
suffix:colon
id|chg_eof
op_assign
id|FALSE
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ALLOW_MEDIUM_REMOVAL
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|SCSI_REMOVAL_PREVENT
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Locking drive door.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif;
r_break
suffix:semicolon
r_case
id|MTUNLOCK
suffix:colon
id|chg_eof
op_assign
id|FALSE
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ALLOW_MEDIUM_REMOVAL
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|SCSI_REMOVAL_ALLOW
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Unlocking drive door.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif;
r_break
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
multiline_comment|/* Set block length */
r_case
id|MTSETDENSITY
suffix:colon
multiline_comment|/* Set tape density */
r_case
id|MTSETDRVBUFFER
suffix:colon
multiline_comment|/* Set drive buffering */
r_case
id|SET_DENS_AND_BLK
suffix:colon
multiline_comment|/* Set density and block size */
id|chg_eof
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;dirty
op_logical_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Not allowed if data in buffer */
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
op_logical_and
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
op_ne
l_int|0
op_logical_and
(paren
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
template_param
id|STp-&gt;max_block
op_logical_or
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
OG
id|osst_buffer_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Illegal block size.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* silently ignore if block size didn&squot;t change */
r_default
suffix:colon
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
)brace
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|datalen
comma
id|direction
comma
id|timeout
comma
id|MAX_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
id|ioctl_result
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Couldn&squot;t exec scsi cmd for IOCTL&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ioctl_result
suffix:semicolon
)brace
id|os_bypass
suffix:colon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: IOCTL (%d) Result=%d&bslash;n&quot;
comma
id|dev
comma
id|cmd_in
comma
id|ioctl_result
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ioctl_result
)paren
(brace
multiline_comment|/* SCSI command successful */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSFM
)paren
(brace
id|fileno
op_decrement
suffix:semicolon
id|blkno
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSFM
)paren
(brace
id|fileno
op_increment
suffix:semicolon
id|blkno
op_increment
suffix:semicolon
)brace
id|STps-&gt;drv_block
op_assign
id|blkno
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|fileno
suffix:semicolon
id|STps-&gt;at_sm
op_assign
id|at_sm
suffix:semicolon
id|STp-&gt;logical_blk_num
op_assign
id|logical_blk_num
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOCK
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_EXPLICIT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTUNLOCK
)paren
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTEOM
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSF
)paren
id|STps-&gt;eof
op_assign
(paren
id|STp-&gt;first_frame_position
op_ge
id|STp-&gt;eod_frame_ppos
)paren
ques
c_cond
id|ST_EOD
suffix:colon
id|ST_FM
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chg_eof
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTOFFL
op_logical_or
id|cmd_in
op_eq
id|MTUNLOAD
)paren
id|STp-&gt;rew_at_close
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOAD
)paren
(brace
multiline_comment|/*      &t;&t;STp-&gt;rew_at_close = (MINOR(inode-&gt;i_rdev) &amp; 0x80) == 0;  FIXME */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|last_block_valid
op_assign
id|FALSE
suffix:semicolon
)brace
id|STp-&gt;partition
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTREW
)paren
(brace
id|ioctl_result
op_assign
id|osst_position_tape_and_confirm
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;first_data_ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl_result
OG
l_int|0
)paren
id|ioctl_result
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSF
op_logical_or
id|cmd_in
op_eq
id|MTBSFM
)paren
(brace
r_if
c_cond
(paren
id|osst_position_tape_and_confirm
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;first_data_ppos
)paren
OL
l_int|0
)paren
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSF
op_logical_or
id|cmd_in
op_eq
id|MTFSFM
)paren
(brace
r_if
c_cond
(paren
id|osst_position_tape_and_confirm
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;eod_frame_ppos
)paren
OL
l_int|0
)paren
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
(brace
id|STps-&gt;drv_file
op_assign
id|STp-&gt;filemark_cnt
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSR
op_logical_or
id|cmd_in
op_eq
id|MTFSR
op_logical_or
id|cmd_in
op_eq
id|MTWEOF
op_logical_or
id|cmd_in
op_eq
id|MTEOM
)paren
(brace
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTERASE
)paren
(brace
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SRpnt
)paren
(brace
multiline_comment|/* SCSI command was not completely successful. */
r_if
c_cond
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chg_eof
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|BLANK_CHECK
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOCK
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCK_FAILS
suffix:semicolon
)brace
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_return
id|ioctl_result
suffix:semicolon
)brace
multiline_comment|/* Open the device */
DECL|function|os_scsi_tape_open
r_static
r_int
id|os_scsi_tape_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|b_size
comma
id|need_dma_buffer
comma
id|new_session
op_assign
id|FALSE
comma
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|mode
op_assign
id|TAPE_MODE
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|osst_template.dev_max
op_logical_or
(paren
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
)paren
op_eq
l_int|NULL
op_logical_or
op_logical_neg
id|STp-&gt;device
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;in_use
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Device already in use.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
id|STp-&gt;in_use
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;rew_at_close
op_assign
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
id|__MOD_INC_USE_COUNT
c_func
(paren
id|STp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_template.module
)paren
id|__MOD_INC_USE_COUNT
c_func
(paren
id|osst_template.module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|STp-&gt;current_mode
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Mode change from %d to %d.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;current_mode
comma
id|mode
)paren
suffix:semicolon
macro_line|#endif
id|new_session
op_assign
id|TRUE
suffix:semicolon
id|STp-&gt;current_mode
op_assign
id|mode
suffix:semicolon
)brace
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|flags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|STp-&gt;write_prot
op_assign
(paren
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDONLY
)paren
suffix:semicolon
id|STp-&gt;raw
op_assign
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0x40
)paren
op_ne
l_int|0
suffix:semicolon
multiline_comment|/* Allocate a buffer for this user */
id|need_dma_buffer
op_assign
id|STp-&gt;restr_dma
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|osst_nbr_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|osst_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|in_use
op_logical_and
(paren
op_logical_neg
id|need_dma_buffer
op_logical_or
id|osst_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|dma
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|osst_nbr_buffers
)paren
(brace
id|STp-&gt;buffer
op_assign
id|new_tape_buffer
c_func
(paren
id|FALSE
comma
id|need_dma_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Can&squot;t allocate tape buffer.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
)brace
r_else
id|STp-&gt;buffer
op_assign
id|osst_buffers
(braket
id|i
)braket
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|use_sg
op_assign
id|STp-&gt;device-&gt;host-&gt;sg_tablesize
suffix:semicolon
multiline_comment|/* Compute the usable buffer size for this SCSI adapter */
r_if
c_cond
(paren
op_logical_neg
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|use_sg
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|sg
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|use_sg
op_logical_and
id|i
OL
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|sg_segs
suffix:semicolon
id|i
op_increment
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_add_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
id|STp-&gt;ready
op_assign
id|ST_READY
suffix:semicolon
id|STp-&gt;recover_count
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|STp-&gt;nbr_waits
op_assign
id|STp-&gt;nbr_finished
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|memset
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NOT_READY
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|4
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Unit not ready, cause %x&bslash;n&quot;
comma
id|dev
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|2
)paren
(brace
multiline_comment|/* initialize command required (LOAD) */
id|memset
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
)brace
id|osst_wait_ready
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|1
ques
c_cond
l_int|15
suffix:colon
l_int|3
)paren
op_star
l_int|60
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|UNIT_ATTENTION
)paren
(brace
multiline_comment|/* New media? */
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Unit wants attention&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_ne
l_int|0x70
op_logical_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_ne
id|UNIT_ATTENTION
)paren
r_break
suffix:semicolon
)brace
id|STp-&gt;device-&gt;was_reset
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This guess will be updated later if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
id|FALSE
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_file
op_assign
l_int|0
suffix:semicolon
)brace
id|new_session
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if we have valid headers from before, and the drive/tape seem untouched,&n;&t; * open without reconfiguring and re-reading the headers&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;buffer-&gt;syscall_result
op_logical_and
id|STp-&gt;header_ok
op_logical_and
op_logical_neg
id|SRpnt-&gt;sr_result
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|VENDOR_IDENT_PAGE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|VENDOR_IDENT_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_READ
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
op_logical_or
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_ne
l_char|&squot;L&squot;
op_logical_or
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_ne
l_char|&squot;I&squot;
op_logical_or
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|4
)braket
op_ne
l_char|&squot;N&squot;
op_logical_or
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|5
)braket
op_ne
l_char|&squot;4&squot;
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: signature was changed to %c%c%c%c&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
comma
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
comma
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|4
)braket
comma
id|STp-&gt;buffer-&gt;b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
)brace
id|i
op_assign
id|STp-&gt;first_frame_position
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;header_ok
op_logical_and
id|i
op_eq
id|osst_get_frame_position
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
)paren
(brace
r_if
c_cond
(paren
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Can&squot;t lock drive door&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
)brace
id|STp-&gt;fast_open
op_assign
id|TRUE
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|i
op_ne
id|STp-&gt;first_frame_position
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: tape position changed from %d to %d&bslash;n&quot;
comma
id|dev
comma
id|i
comma
id|STp-&gt;first_frame_position
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
)brace
id|STp-&gt;fast_open
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
op_logical_and
multiline_comment|/* in all error conditions except no medium */
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_ne
l_int|2
op_logical_or
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_ne
l_int|0x3A
)paren
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|4
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
op_minus
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Medium Type - ignoring */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Block Descriptor Length */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|0
)braket
op_assign
l_int|0x3f
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_assign
l_int|2
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_assign
l_int|3
suffix:semicolon
macro_line|#if 1 
singleline_comment|//DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%i: Applying soft reset&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|SCSI_DATA_WRITE
comma
id|STp-&gt;timeout
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
id|STp-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|osst_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|SCSI_DATA_NONE
comma
id|STp-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_ne
l_int|0x70
op_logical_or
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NOT_READY
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|UNIT_ATTENTION
)paren
(brace
id|STp-&gt;device-&gt;was_reset
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This guess will be updated later if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
id|FALSE
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_file
op_assign
l_int|0
suffix:semicolon
)brace
id|new_session
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|osst_wait_ready
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|15
op_star
l_int|60
)paren
)paren
multiline_comment|/* FIXME - not allowed with NOBLOCK */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%i: Device did not become Ready in open&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NOT_READY
op_logical_and
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|0x3a
)paren
(brace
multiline_comment|/* Check ASC */
id|STp-&gt;ready
op_assign
id|ST_NO_TAPE
suffix:semicolon
)brace
r_else
id|STp-&gt;ready
op_assign
id|ST_NOT_READY
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|STp-&gt;density
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the erroneous &quot;residue&quot; */
id|STp-&gt;write_prot
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;block_size
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_file
op_assign
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|STp-&gt;min_block
op_assign
id|STp-&gt;max_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|osst_configure_onstream
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
multiline_comment|/*&t;STp-&gt;drv_write_prot = ((STp-&gt;buffer)-&gt;b_data[2] &amp; 0x80) != 0; FIXME */
r_if
c_cond
(paren
id|OS_FRAME_SIZE
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_logical_and
op_logical_neg
id|enlarge_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|OS_FRAME_SIZE
comma
id|STp-&gt;restr_dma
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;osst%d: Framesize %d too large for buffer.&bslash;n&quot;
comma
id|dev
comma
id|OS_FRAME_SIZE
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_ge
id|OS_FRAME_SIZE
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|b_size
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STp-&gt;buffer-&gt;sg_segs
op_logical_and
(paren
id|b_size
op_plus
id|STp-&gt;buffer-&gt;sg
(braket
id|i
)braket
dot
id|length
)paren
op_le
id|OS_DATA_SIZE
suffix:semicolon
id|b_size
op_add_assign
id|STp-&gt;buffer-&gt;sg
(braket
id|i
op_increment
)braket
dot
id|length
)paren
suffix:semicolon
id|STp-&gt;buffer-&gt;aux
op_assign
(paren
id|os_aux_t
op_star
)paren
(paren
id|STp-&gt;buffer-&gt;sg
(braket
id|i
)braket
dot
id|address
op_plus
id|OS_DATA_SIZE
op_minus
id|b_size
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: b_data points to %p in segment 0 at %p&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;buffer-&gt;b_data
comma
id|STp-&gt;buffer-&gt;sg
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: AUX points to %p in segment %d at %p&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;buffer-&gt;aux
comma
id|i
comma
id|STp-&gt;buffer-&gt;sg
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
id|STp-&gt;buffer-&gt;aux
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* this had better never happen! */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
id|STp-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Block size: %d, frame size: %d, buffer size: %d (%d blocks).&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;block_size
comma
id|OS_FRAME_SIZE
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;drv_write_prot
)paren
(brace
id|STp-&gt;write_prot
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Write protected&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_WRONLY
op_logical_or
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDWR
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EROFS
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|new_session
)paren
(brace
multiline_comment|/* Change the drive parameters for the new mode */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: New Session&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;density_changed
op_assign
id|STp-&gt;blksize_changed
op_assign
id|FALSE
suffix:semicolon
id|STp-&gt;compression_changed
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * properly position the tape and check the ADR headers&n;&t; */
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
)paren
(brace
r_if
c_cond
(paren
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: Can&squot;t lock drive door&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
)brace
id|osst_analyze_headers
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
r_if
c_cond
(paren
id|SRpnt
op_ne
l_int|NULL
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer
op_ne
l_int|NULL
)paren
(brace
id|STp-&gt;buffer-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
id|STp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|STp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_template.module
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|osst_template.module
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Flush the tape buffer before close */
DECL|function|os_scsi_tape_flush
r_static
r_int
id|os_scsi_tape_flush
c_func
(paren
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|result
op_assign
l_int|0
comma
id|result2
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|kdev_t
id|devt
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|file_count
c_func
(paren
id|filp
)paren
OG
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|devt
)paren
suffix:semicolon
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
op_logical_and
op_logical_neg
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
)paren
(brace
id|result
op_assign
id|osst_flush_write_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
op_logical_and
id|result
op_ne
(paren
op_minus
id|ENOSPC
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
op_logical_and
op_logical_neg
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: File length %ld bytes.&bslash;n&quot;
comma
id|dev
comma
(paren
r_int
)paren
(paren
id|filp-&gt;f_pos
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Async write waits %d, finished %d.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;nbr_waits
comma
id|STp-&gt;nbr_finished
)paren
suffix:semicolon
)brace
macro_line|#endif
id|result
op_assign
id|osst_flush_drive_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|result
op_assign
id|osst_write_filemark
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|osst_write_eod
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
id|osst_write_header
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
op_logical_neg
(paren
id|STp-&gt;rew_at_close
)paren
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Buffer flushed, %d EOF(s) written&bslash;n&quot;
comma
id|dev
comma
l_int|1
op_plus
id|STp-&gt;two_fm
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;rew_at_close
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;sysv
op_logical_or
id|STps-&gt;rw
op_ne
id|ST_READING
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;can_bsr
)paren
id|result
op_assign
id|osst_flush_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
id|result
op_assign
id|cross_eof
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
)brace
r_else
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|STps-&gt;eof
op_eq
id|ST_NOEOF
op_logical_and
op_logical_neg
(paren
id|result
op_assign
id|cross_eof
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|TRUE
)paren
)paren
)paren
op_logical_or
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;rew_at_close
)paren
(brace
id|result2
op_assign
id|osst_position_tape_and_confirm
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|STp-&gt;first_data_ppos
)paren
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
id|STp-&gt;logical_blk_num
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|result
op_assign
id|result2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SRpnt
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Close the device and release it */
DECL|function|os_scsi_tape_close
r_static
r_int
id|os_scsi_tape_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|kdev_t
id|devt
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
r_int
id|dev
suffix:semicolon
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|devt
)paren
suffix:semicolon
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_eq
id|ST_LOCKED_AUTO
)paren
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTUNLOCK
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer
op_ne
l_int|NULL
)paren
id|STp-&gt;buffer-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|STp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_template.module
)paren
(brace
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|osst_template.module
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* The ioctl command */
DECL|function|osst_ioctl
r_static
r_int
id|osst_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
comma
id|cmd_nr
comma
id|cmd_type
comma
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|blk
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
id|os_scsi_tapes
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#endif
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are in the middle of error recovery, don&squot;t let anyone&n;&t; * else try and use this device.  Also, if error recovery fails, it&n;&t; * may try and take the device offline, in which case all further&n;&t; * access to the device is prohibited.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|cmd_type
op_assign
id|_IOC_TYPE
c_func
(paren
id|cmd_in
)paren
suffix:semicolon
id|cmd_nr
op_assign
id|_IOC_NR
c_func
(paren
id|cmd_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCTOP
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCTOP
)paren
)paren
(brace
r_struct
id|mtop
id|mtc
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
id|mtc
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|i
op_assign
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|mtc
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETDRVBUFFER
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst%d: MTSETDRVBUFFER only allowed for root.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
op_logical_and
(paren
id|mtc.mt_op
op_ne
id|MTSETDRVBUFFER
op_logical_and
(paren
id|mtc.mt_count
op_amp
id|MT_ST_OPTIONS
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTFSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTFSFM
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
)paren
(brace
id|mtc.mt_count
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_add_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTBSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSFM
)paren
(brace
id|mtc.mt_count
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSEEK
)paren
(brace
multiline_comment|/* Old position must be restored if partition will be changed */
id|i
op_assign
op_logical_neg
id|STp-&gt;can_partitions
op_logical_or
(paren
id|STp-&gt;new_partition
op_ne
id|STp-&gt;partition
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|mtc.mt_op
op_eq
id|MTREW
op_logical_or
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_or
id|mtc.mt_op
op_eq
id|MTRETEN
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
op_logical_or
id|mtc.mt_op
op_eq
id|MTLOCK
op_logical_or
id|mtc.mt_op
op_eq
id|MTLOAD
op_logical_or
id|mtc.mt_op
op_eq
id|MTCOMPRESSION
suffix:semicolon
)brace
id|i
op_assign
id|osst_flush_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * If there was a bus reset, block further access&n;&t;&t;&t; * to this device.  If the user wants to rewind the tape,&n;&t;&t;&t; * then reset the flag and allow access again.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mtc.mt_op
op_ne
id|MTREW
op_logical_and
id|mtc.mt_op
op_ne
id|MTOFFL
op_logical_and
id|mtc.mt_op
op_ne
id|MTRETEN
op_logical_and
id|mtc.mt_op
op_ne
id|MTERASE
op_logical_and
id|mtc.mt_op
op_ne
id|MTSEEK
op_logical_and
id|mtc.mt_op
op_ne
id|MTEOM
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STp-&gt;device-&gt;was_reset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_ne
id|ST_UNLOCKED
op_logical_and
id|STp-&gt;door_locked
op_ne
id|ST_LOCK_FAILS
)paren
(brace
r_if
c_cond
(paren
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;osst%d: Could not relock door after bus reset.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_ne
id|MTNOP
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETBLK
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETDENSITY
op_logical_and
id|mtc.mt_op
op_ne
id|MTWSM
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETDRVBUFFER
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETPART
)paren
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
multiline_comment|/* Prevent automatic WEOF and fsf */
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_and
id|STp-&gt;door_locked
op_ne
id|ST_UNLOCKED
)paren
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTUNLOCK
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Ignore result! */
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETDRVBUFFER
op_logical_and
(paren
id|mtc.mt_count
op_amp
id|MT_ST_OPTIONS
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
id|osst_set_options
c_func
(paren
id|STp
comma
id|mtc.mt_count
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETPART
)paren
(brace
multiline_comment|/*     if (!STp-&gt;can_partitions ||&n;&t;   mtc.mt_count &lt; 0 || mtc.mt_count &gt;= ST_NBR_PARTITIONS)&n;&t; return (-EINVAL);&n;&t;&t; if (mtc.mt_count &gt;= STp-&gt;nbr_partitions &amp;&amp;&n;&t;   (STp-&gt;nbr_partitions = nbr_partitions(inode)) &lt; 0)&n;&t; return (-EIO);*/
r_if
c_cond
(paren
id|mtc.mt_count
op_ge
id|STp-&gt;nbr_partitions
)paren
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
id|STp-&gt;new_partition
op_assign
id|mtc.mt_count
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTMKPART
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|MTREW
comma
l_int|0
)paren
)paren
OL
l_int|0
multiline_comment|/*||&n;&t;&t;&t;    (i = partition_tape(inode, mtc.mt_count)) &lt; 0*/
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|at_sm
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|last_block_valid
op_assign
id|FALSE
suffix:semicolon
)brace
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Bad guess ?-) */
id|STps-&gt;drv_block
op_assign
id|STps-&gt;drv_file
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSEEK
)paren
(brace
id|i
op_assign
id|osst_seek_frame
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|mtc.mt_count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
)paren
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*   if (STp-&gt;can_partitions &amp;&amp; STp-&gt;ready == ST_READY &amp;&amp;&n;&t; (i = update_partition(inode)) &lt; 0)&n;&t;&t; {retval=i;goto out;}*/
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTCOMPRESSION
)paren
id|retval
op_assign
op_minus
id|EINVAL
multiline_comment|/*osst_compression(STp, (mtc.mt_count &amp; 1))*/
suffix:semicolon
r_else
id|retval
op_assign
id|osst_int_ioctl
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|mtc.mt_op
comma
id|mtc.mt_count
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|osst_flush_buffer
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
comma
id|FALSE
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* if (STp-&gt;can_partitions &amp;&amp;&n;&t;&t; (i = update_partition(inode)) &lt; 0)&n;&t; {retval=i;goto out;}*/
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCGET
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCGET
)paren
)paren
(brace
r_struct
id|mtget
id|mt_status
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mt_status.mt_type
op_assign
id|MT_ISONSTREAM_SC
suffix:semicolon
id|mt_status.mt_erreg
op_assign
id|STp-&gt;recover_erreg
op_lshift
id|MT_ST_SOFTERR_SHIFT
suffix:semicolon
id|mt_status.mt_dsreg
op_assign
(paren
(paren
id|STp-&gt;block_size
op_lshift
id|MT_ST_BLKSIZE_SHIFT
)paren
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
op_or
(paren
(paren
id|STp-&gt;density
op_lshift
id|MT_ST_DENSITY_SHIFT
)paren
op_amp
id|MT_ST_DENSITY_MASK
)paren
suffix:semicolon
id|mt_status.mt_blkno
op_assign
id|STps-&gt;drv_block
suffix:semicolon
id|mt_status.mt_fileno
op_assign
id|STps-&gt;drv_file
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
id|mt_status.mt_blkno
op_add_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_READING
)paren
id|mt_status.mt_blkno
op_sub_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|mt_status.mt_gstat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_write_prot
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_WR_PROT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mt_status.mt_blkno
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mt_status.mt_fileno
op_eq
l_int|0
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_BOT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
id|mt_status.mt_gstat
op_or_assign
id|GMT_EOF
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
)brace
id|mt_status.mt_resid
op_assign
id|STp-&gt;partition
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOM_OK
op_logical_or
id|STps-&gt;eof
op_eq
id|ST_EOM_ERROR
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_EOT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_ge
id|ST_EOM_OK
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_EOD
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|1
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_D_800
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|2
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_D_1600
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|3
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_D_6250
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_ONLINE
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_DR_OPEN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;at_sm
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_SM
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STm-&gt;do_async_writes
op_logical_or
(paren
id|STm-&gt;do_buffer_writes
op_logical_and
id|STp-&gt;block_size
op_ne
l_int|0
)paren
op_logical_or
id|STp-&gt;drv_buffer
op_ne
l_int|0
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_IM_REP_EN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|i
op_assign
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
op_amp
id|mt_status
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STp-&gt;recover_erreg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear after read */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* End of MTIOCGET */
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCPOS
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCPOS
)paren
)paren
(brace
r_struct
id|mtpos
id|mt_pos
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|blk
op_assign
id|osst_get_frame_position
c_func
(paren
id|STp
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|blk
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mt_pos.mt_blkno
op_assign
id|blk
suffix:semicolon
id|i
op_assign
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
(paren
op_amp
id|mt_pos
)paren
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SRpnt
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|scsi_ioctl
c_func
(paren
id|STp-&gt;device
comma
id|cmd_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|SRpnt
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Memory handling routines */
multiline_comment|/* Try to allocate a new tape buffer */
DECL|function|new_tape_buffer
r_static
id|OSST_buffer
op_star
id|new_tape_buffer
c_func
(paren
r_int
id|from_initialization
comma
r_int
id|need_dma
)paren
(brace
r_int
id|i
comma
id|priority
comma
id|b_size
comma
id|order
comma
id|got
op_assign
l_int|0
comma
id|segs
op_assign
l_int|0
suffix:semicolon
id|OSST_buffer
op_star
id|tb
suffix:semicolon
r_if
c_cond
(paren
id|osst_nbr_buffers
op_ge
id|osst_template.dev_max
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Should never happen */
r_if
c_cond
(paren
id|from_initialization
)paren
id|priority
op_assign
id|GFP_ATOMIC
suffix:semicolon
r_else
id|priority
op_assign
id|GFP_KERNEL
suffix:semicolon
id|i
op_assign
r_sizeof
(paren
id|OSST_buffer
)paren
op_plus
(paren
id|osst_max_sg_segs
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|scatterlist
)paren
suffix:semicolon
id|tb
op_assign
(paren
id|OSST_buffer
op_star
)paren
id|kmalloc
c_func
(paren
id|i
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tb
)paren
(brace
singleline_comment|//    tb-&gt;this_size = i;
r_if
c_cond
(paren
id|need_dma
)paren
id|priority
op_or_assign
id|GFP_DMA
suffix:semicolon
multiline_comment|/* Try to allocate the first segment up to OSST_FIRST_ORDER and the&n;&t;&t; others big enough to reach the goal */
r_for
c_loop
(paren
id|b_size
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|b_size
OL
id|osst_buffer_size
op_logical_and
id|order
OL
id|OSST_FIRST_ORDER
suffix:semicolon
id|b_size
op_mul_assign
l_int|2
comma
id|order
op_increment
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|b_size
op_ge
id|PAGE_SIZE
suffix:semicolon
id|order
op_decrement
comma
id|b_size
op_div_assign
l_int|2
)paren
(brace
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|address
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|priority
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|address
op_ne
l_int|NULL
)paren
(brace
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|alt_address
op_assign
l_int|NULL
suffix:semicolon
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|length
op_assign
id|b_size
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tb-&gt;sg
(braket
id|segs
)braket
dot
id|address
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|tb
)paren
suffix:semicolon
id|tb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Got something, continue */
r_for
c_loop
(paren
id|b_size
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|osst_buffer_size
OG
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|length
op_plus
(paren
id|OSST_FIRST_SG
op_minus
l_int|1
)paren
op_star
id|b_size
suffix:semicolon
id|b_size
op_mul_assign
l_int|2
comma
id|order
op_increment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|segs
op_assign
l_int|1
comma
id|got
op_assign
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|got
OL
id|osst_buffer_size
op_logical_and
id|segs
OL
id|OSST_FIRST_SG
suffix:semicolon
)paren
(brace
id|tb-&gt;sg
(braket
id|segs
)braket
dot
id|address
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|priority
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tb-&gt;sg
(braket
id|segs
)braket
dot
id|address
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|osst_buffer_size
op_minus
id|got
op_le
(paren
id|OSST_FIRST_SG
op_minus
id|segs
)paren
op_star
id|b_size
op_div
l_int|2
)paren
(brace
id|b_size
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* Large enough for the rest of the buffers */
id|order
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|tb-&gt;sg_segs
op_assign
id|segs
suffix:semicolon
id|tb-&gt;orig_sg_segs
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|tb-&gt;buffer_size
op_assign
id|got
suffix:semicolon
macro_line|#endif
id|normalize_buffer
c_func
(paren
id|tb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tb
)paren
suffix:semicolon
id|tb
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tb-&gt;sg
(braket
id|segs
)braket
dot
id|alt_address
op_assign
l_int|NULL
suffix:semicolon
id|tb-&gt;sg
(braket
id|segs
)braket
dot
id|length
op_assign
id|b_size
suffix:semicolon
id|got
op_add_assign
id|b_size
suffix:semicolon
id|segs
op_increment
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|tb
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;osst: Can&squot;t allocate new tape buffer (nbr %d).&bslash;n&quot;
comma
id|osst_nbr_buffers
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|tb-&gt;sg_segs
op_assign
id|tb-&gt;orig_sg_segs
op_assign
id|segs
suffix:semicolon
id|tb-&gt;b_data
op_assign
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: Allocated tape buffer %d (%d bytes, %d segments, dma: %d, a: %p).&bslash;n&quot;
comma
id|osst_nbr_buffers
comma
id|got
comma
id|tb-&gt;sg_segs
comma
id|need_dma
comma
id|tb-&gt;b_data
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: segment sizes: first %d, last %d bytes.&bslash;n&quot;
comma
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|length
comma
id|tb-&gt;sg
(braket
id|segs
op_minus
l_int|1
)braket
dot
id|length
)paren
suffix:semicolon
)brace
macro_line|#endif
id|tb-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|tb-&gt;dma
op_assign
id|need_dma
suffix:semicolon
id|tb-&gt;buffer_size
op_assign
id|got
suffix:semicolon
id|tb-&gt;writing
op_assign
l_int|0
suffix:semicolon
id|osst_buffers
(braket
id|osst_nbr_buffers
op_increment
)braket
op_assign
id|tb
suffix:semicolon
r_return
id|tb
suffix:semicolon
)brace
multiline_comment|/* Try to allocate a temporary enlarged tape buffer */
DECL|function|enlarge_buffer
r_static
r_int
id|enlarge_buffer
c_func
(paren
id|OSST_buffer
op_star
id|STbuffer
comma
r_int
id|new_size
comma
r_int
id|need_dma
)paren
(brace
r_int
id|segs
comma
id|nbr
comma
id|max_segs
comma
id|b_size
comma
id|priority
comma
id|order
comma
id|got
suffix:semicolon
id|normalize_buffer
c_func
(paren
id|STbuffer
)paren
suffix:semicolon
id|max_segs
op_assign
id|STbuffer-&gt;use_sg
suffix:semicolon
r_if
c_cond
(paren
id|max_segs
OG
id|osst_max_sg_segs
)paren
id|max_segs
op_assign
id|osst_max_sg_segs
suffix:semicolon
id|nbr
op_assign
id|max_segs
op_minus
id|STbuffer-&gt;sg_segs
suffix:semicolon
r_if
c_cond
(paren
id|nbr
op_le
l_int|0
)paren
r_return
id|FALSE
suffix:semicolon
id|priority
op_assign
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|need_dma
)paren
id|priority
op_or_assign
id|GFP_DMA
suffix:semicolon
r_for
c_loop
(paren
id|b_size
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|b_size
op_star
id|nbr
OL
id|new_size
op_minus
id|STbuffer-&gt;buffer_size
suffix:semicolon
id|b_size
op_mul_assign
l_int|2
comma
id|order
op_increment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|segs
op_assign
id|STbuffer-&gt;sg_segs
comma
id|got
op_assign
id|STbuffer-&gt;buffer_size
suffix:semicolon
id|segs
OL
id|max_segs
op_logical_and
id|got
OL
id|new_size
suffix:semicolon
)paren
(brace
id|STbuffer-&gt;sg
(braket
id|segs
)braket
dot
id|address
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|priority
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STbuffer-&gt;sg
(braket
id|segs
)braket
dot
id|address
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|new_size
op_minus
id|got
op_le
(paren
id|max_segs
op_minus
id|segs
)paren
op_star
id|b_size
op_div
l_int|2
)paren
(brace
id|b_size
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* Large enough for the rest of the buffers */
id|order
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;osst: Failed to enlarge buffer to %d bytes.&bslash;n&quot;
comma
id|new_size
)paren
suffix:semicolon
macro_line|#if DEBUG
id|STbuffer-&gt;buffer_size
op_assign
id|got
suffix:semicolon
macro_line|#endif
id|normalize_buffer
c_func
(paren
id|STbuffer
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|STbuffer-&gt;sg
(braket
id|segs
)braket
dot
id|alt_address
op_assign
l_int|NULL
suffix:semicolon
id|STbuffer-&gt;sg
(braket
id|segs
)braket
dot
id|length
op_assign
id|b_size
suffix:semicolon
id|STbuffer-&gt;sg_segs
op_add_assign
l_int|1
suffix:semicolon
id|got
op_add_assign
id|b_size
suffix:semicolon
id|STbuffer-&gt;buffer_size
op_assign
id|got
suffix:semicolon
id|segs
op_increment
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_for
c_loop
(paren
id|nbr
op_assign
l_int|0
suffix:semicolon
id|osst_buffers
(braket
id|nbr
)braket
op_ne
id|STbuffer
op_logical_and
id|nbr
OL
id|osst_nbr_buffers
suffix:semicolon
id|nbr
op_increment
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: Expanded tape buffer %d (%d bytes, %d-&gt;%d segments, dma: %d, a: %p).&bslash;n&quot;
comma
id|nbr
comma
id|got
comma
id|STbuffer-&gt;orig_sg_segs
comma
id|STbuffer-&gt;sg_segs
comma
id|need_dma
comma
id|STbuffer-&gt;b_data
)paren
suffix:semicolon
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: segment sizes: first %d, last %d bytes.&bslash;n&quot;
comma
id|STbuffer-&gt;sg
(braket
l_int|0
)braket
dot
id|length
comma
id|STbuffer-&gt;sg
(braket
id|segs
op_minus
l_int|1
)braket
dot
id|length
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* Release the extra buffer */
DECL|function|normalize_buffer
r_static
r_void
id|normalize_buffer
c_func
(paren
id|OSST_buffer
op_star
id|STbuffer
)paren
(brace
r_int
id|i
comma
id|order
comma
id|b_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|STbuffer-&gt;orig_sg_segs
suffix:semicolon
id|i
OL
id|STbuffer-&gt;sg_segs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|b_size
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|b_size
OL
id|STbuffer-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|b_size
op_mul_assign
l_int|2
comma
id|order
op_increment
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|STbuffer-&gt;sg
(braket
id|i
)braket
dot
id|address
comma
id|order
)paren
suffix:semicolon
id|STbuffer-&gt;buffer_size
op_sub_assign
id|STbuffer-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
id|STbuffer-&gt;orig_sg_segs
OL
id|STbuffer-&gt;sg_segs
)paren
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: Buffer at %p normalized to %d bytes (segs %d).&bslash;n&quot;
comma
id|STbuffer-&gt;b_data
comma
id|STbuffer-&gt;buffer_size
comma
id|STbuffer-&gt;sg_segs
)paren
suffix:semicolon
macro_line|#endif
id|STbuffer-&gt;sg_segs
op_assign
id|STbuffer-&gt;orig_sg_segs
suffix:semicolon
)brace
multiline_comment|/* Move data from the user buffer to the tape buffer. Returns zero (success) or&n;   negative error code. */
DECL|function|append_to_buffer
r_static
r_int
id|append_to_buffer
c_func
(paren
r_const
r_char
op_star
id|ubp
comma
id|OSST_buffer
op_star
id|st_bp
comma
r_int
id|do_count
)paren
(brace
r_int
id|i
comma
id|cnt
comma
id|res
comma
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|offset
op_assign
id|st_bp-&gt;buffer_bytes
suffix:semicolon
id|i
OL
id|st_bp-&gt;sg_segs
op_logical_and
id|offset
op_ge
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|i
op_increment
)paren
id|offset
op_sub_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|st_bp-&gt;sg_segs
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: Append_to_buffer offset overflow.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
OL
id|do_count
ques
c_cond
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
suffix:colon
id|do_count
suffix:semicolon
id|res
op_assign
id|copy_from_user
c_func
(paren
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|address
op_plus
id|offset
comma
id|ubp
comma
id|cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|st_bp-&gt;buffer_bytes
op_add_assign
id|cnt
suffix:semicolon
id|ubp
op_add_assign
id|cnt
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: Append_to_buffer overflow (left %d).&bslash;n&quot;
comma
id|do_count
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Move data from the tape buffer to the user buffer. Returns zero (success) or&n;   negative error code. */
DECL|function|from_buffer
r_static
r_int
id|from_buffer
c_func
(paren
id|OSST_buffer
op_star
id|st_bp
comma
r_char
op_star
id|ubp
comma
r_int
id|do_count
)paren
(brace
r_int
id|i
comma
id|cnt
comma
id|res
comma
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|offset
op_assign
id|st_bp-&gt;read_pointer
suffix:semicolon
id|i
OL
id|st_bp-&gt;sg_segs
op_logical_and
id|offset
op_ge
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|i
op_increment
)paren
id|offset
op_sub_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|st_bp-&gt;sg_segs
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: From_buffer offset overflow.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
OL
id|do_count
ques
c_cond
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
suffix:colon
id|do_count
suffix:semicolon
id|res
op_assign
id|copy_to_user
c_func
(paren
id|ubp
comma
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|address
op_plus
id|offset
comma
id|cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|st_bp-&gt;buffer_bytes
op_sub_assign
id|cnt
suffix:semicolon
id|st_bp-&gt;read_pointer
op_add_assign
id|cnt
suffix:semicolon
id|ubp
op_add_assign
id|cnt
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: From_buffer overflow (left %d).&bslash;n&quot;
comma
id|do_count
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Sets the tail of the buffer after fill point to zero.&n;   Returns zero (success) or negative error code.        */
DECL|function|osst_zero_buffer_tail
r_static
r_int
id|osst_zero_buffer_tail
c_func
(paren
id|OSST_buffer
op_star
id|st_bp
)paren
(brace
r_int
id|i
comma
id|offset
comma
id|do_count
comma
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|offset
op_assign
id|st_bp-&gt;buffer_bytes
suffix:semicolon
id|i
OL
id|st_bp-&gt;sg_segs
op_logical_and
id|offset
op_ge
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|i
op_increment
)paren
id|offset
op_sub_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|st_bp-&gt;sg_segs
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: Zero_buffer offset overflow.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|do_count
op_assign
id|OS_DATA_SIZE
op_minus
id|st_bp-&gt;read_pointer
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
OL
id|do_count
ques
c_cond
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
suffix:colon
id|do_count
suffix:semicolon
id|memset
c_func
(paren
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|address
op_plus
id|offset
comma
l_int|0
comma
id|cnt
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: Zero_buffer overflow (left %d).&bslash;n&quot;
comma
id|do_count
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy a osst 32K block of memory into the buffer.&n;   Returns zero (success) or negative error code.  */
DECL|function|osst_copy_to_buffer
r_static
r_int
id|osst_copy_to_buffer
c_func
(paren
id|OSST_buffer
op_star
id|st_bp
comma
r_int
r_char
op_star
id|ptr
)paren
(brace
r_int
id|i
comma
id|cnt
comma
id|do_count
op_assign
id|OS_DATA_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
OL
id|do_count
ques
c_cond
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:colon
id|do_count
suffix:semicolon
id|memcpy
c_func
(paren
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|address
comma
id|ptr
comma
id|cnt
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|ptr
op_add_assign
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
op_logical_or
id|i
op_ne
id|st_bp-&gt;sg_segs
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: Copy_to_buffer overflow (left %d at sg %d).&bslash;n&quot;
comma
id|do_count
comma
id|i
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy a osst 32K block of memory from the buffer.&n;   Returns zero (success) or negative error code.  */
DECL|function|osst_copy_from_buffer
r_static
r_int
id|osst_copy_from_buffer
c_func
(paren
id|OSST_buffer
op_star
id|st_bp
comma
r_int
r_char
op_star
id|ptr
)paren
(brace
r_int
id|i
comma
id|cnt
comma
id|do_count
op_assign
id|OS_DATA_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
OL
id|do_count
ques
c_cond
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|length
suffix:colon
id|do_count
suffix:semicolon
id|memcpy
c_func
(paren
id|ptr
comma
id|st_bp-&gt;sg
(braket
id|i
)braket
dot
id|address
comma
id|cnt
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|ptr
op_add_assign
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
op_logical_or
id|i
op_ne
id|st_bp-&gt;sg_segs
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: Copy_from_buffer overflow (left %d at sg %d).&bslash;n&quot;
comma
id|do_count
comma
id|i
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Module housekeeping */
DECL|function|validate_options
r_static
r_void
id|validate_options
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|buffer_kbs
OG
l_int|0
)paren
id|osst_buffer_size
op_assign
id|buffer_kbs
op_star
id|ST_KILOBYTE
suffix:semicolon
r_if
c_cond
(paren
id|write_threshold_kbs
OG
l_int|0
)paren
id|osst_write_threshold
op_assign
id|write_threshold_kbs
op_star
id|ST_KILOBYTE
suffix:semicolon
r_if
c_cond
(paren
id|osst_write_threshold
OG
id|osst_buffer_size
)paren
id|osst_write_threshold
op_assign
id|osst_buffer_size
suffix:semicolon
r_if
c_cond
(paren
id|max_buffers
OG
l_int|0
)paren
id|osst_max_buffers
op_assign
id|max_buffers
suffix:semicolon
r_if
c_cond
(paren
id|max_sg_segs
op_ge
id|OSST_FIRST_SG
)paren
id|osst_max_sg_segs
op_assign
id|max_sg_segs
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst: bufsize %d, wrt %d, max buffers %d, s/g segs %d.&bslash;n&quot;
comma
id|osst_buffer_size
comma
id|osst_write_threshold
comma
id|osst_max_buffers
comma
id|osst_max_sg_segs
)paren
suffix:semicolon
singleline_comment|//printk(OSST_DEB_MSG &quot;osst: sizeof(header) = %d (%s)&bslash;n&quot;,sizeof(os_header_t),sizeof(os_header_t)==OS_DATA_SIZE?&quot;ok&quot;:&quot;error&quot;);
)brace
macro_line|#ifndef MODULE
multiline_comment|/* Set the boot options. Syntax: osst=xxx,yyy,...&n;   where xxx is buffer size in 1024 byte blocks and yyy is write threshold&n;   in 1024 byte blocks. */
DECL|function|osst_setup
r_static
r_int
id|__init
id|osst_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|i
comma
id|ints
(braket
l_int|5
)braket
suffix:semicolon
r_char
op_star
id|stp
suffix:semicolon
id|stp
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ints
(braket
l_int|0
)braket
op_logical_and
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|parms
)paren
suffix:semicolon
id|i
op_increment
)paren
op_star
id|parms
(braket
id|i
)braket
dot
id|val
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|stp
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|parms
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|parms
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|stp
comma
id|parms
(braket
id|i
)braket
dot
id|name
comma
id|len
)paren
op_logical_and
(paren
op_star
(paren
id|stp
op_plus
id|len
)paren
op_eq
l_char|&squot;:&squot;
op_logical_or
op_star
(paren
id|stp
op_plus
id|len
)paren
op_eq
l_char|&squot;=&squot;
)paren
)paren
(brace
op_star
id|parms
(braket
id|i
)braket
dot
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|stp
op_plus
id|len
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
r_sizeof
(paren
id|parms
)paren
op_div
r_sizeof
(paren
r_struct
id|osst_dev_parm
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;osst: illegal parameter in &squot;%s&squot;&bslash;n&quot;
comma
id|stp
)paren
suffix:semicolon
id|stp
op_assign
id|strchr
c_func
(paren
id|stp
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stp
)paren
id|stp
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;osst=&quot;
comma
id|osst_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|osst_fops
r_static
r_struct
id|file_operations
id|osst_fops
op_assign
(brace
id|read
suffix:colon
id|osst_read
comma
id|write
suffix:colon
id|osst_write
comma
id|ioctl
suffix:colon
id|osst_ioctl
comma
id|open
suffix:colon
id|os_scsi_tape_open
comma
id|flush
suffix:colon
id|os_scsi_tape_flush
comma
id|release
suffix:colon
id|os_scsi_tape_close
comma
)brace
suffix:semicolon
DECL|function|osst_supports
r_static
r_int
id|osst_supports
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
r_struct
id|osst_support_data
(brace
r_char
op_star
id|vendor
suffix:semicolon
r_char
op_star
id|model
suffix:semicolon
r_char
op_star
id|rev
suffix:semicolon
r_char
op_star
id|driver_hint
suffix:semicolon
multiline_comment|/* Name of the correct driver, NULL if unknown */
)brace
suffix:semicolon
r_static
r_struct
id|osst_support_data
id|support_list
(braket
)braket
op_assign
(brace
multiline_comment|/* {&quot;XXX&quot;, &quot;Yy-&quot;, &quot;&quot;, NULL},  example */
id|SIGS_FROM_OSST
comma
(brace
l_int|NULL
comma
)brace
)brace
suffix:semicolon
r_struct
id|osst_support_data
op_star
id|rp
suffix:semicolon
multiline_comment|/* We are willing to drive OnStream SC-x0 as well as the&n;&t; * &t; * IDE, ParPort, FireWire, USB variants, if accessible by&n;&t; * &t; &t; * emulation layer (ide-scsi, usb-storage, ...) */
r_for
c_loop
(paren
id|rp
op_assign
op_amp
(paren
id|support_list
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|rp-&gt;vendor
op_ne
l_int|NULL
suffix:semicolon
id|rp
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|rp-&gt;vendor
comma
id|SDp-&gt;vendor
comma
id|strlen
c_func
(paren
id|rp-&gt;vendor
)paren
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|rp-&gt;model
comma
id|SDp-&gt;model
comma
id|strlen
c_func
(paren
id|rp-&gt;model
)paren
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|rp-&gt;rev
comma
id|SDp-&gt;rev
comma
id|strlen
c_func
(paren
id|rp-&gt;rev
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|osst_attach
r_static
r_int
id|osst_attach
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
id|OS_Scsi_Tape
op_star
id|tpnt
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
r_int
id|mode
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|SDp-&gt;type
op_ne
id|TYPE_TAPE
op_logical_or
op_logical_neg
id|osst_supports
c_func
(paren
id|SDp
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|osst_template.nr_dev
op_ge
id|osst_template.dev_max
)paren
(brace
id|SDp-&gt;attached
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* find a free minor number */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|os_scsi_tapes
(braket
id|i
)braket
op_logical_and
id|i
OL
id|osst_template.dev_max
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|osst_template.dev_max
)paren
(brace
id|panic
(paren
l_string|&quot;Scsi_devices corrupt (osst)&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate a OS_Scsi_Tape for this device */
id|tpnt
op_assign
(paren
id|OS_Scsi_Tape
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|OS_Scsi_Tape
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tpnt
op_eq
l_int|NULL
)paren
(brace
id|SDp-&gt;attached
op_decrement
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst: Can&squot;t allocate device descriptor.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tpnt
comma
l_int|0
comma
r_sizeof
(paren
id|OS_Scsi_Tape
)paren
)paren
suffix:semicolon
id|os_scsi_tapes
(braket
id|i
)braket
op_assign
id|tpnt
suffix:semicolon
id|tpnt-&gt;capacity
op_assign
l_int|0xfffff
suffix:semicolon
multiline_comment|/* allocate a buffer for this device */
r_if
c_cond
(paren
op_logical_neg
id|new_tape_buffer
c_func
(paren
id|TRUE
comma
id|TRUE
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst: Unable to allocate a tape buffer.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
r_for
c_loop
(paren
id|mode
op_assign
l_int|0
suffix:semicolon
id|mode
OL
id|ST_NBR_MODES
suffix:semicolon
op_increment
id|mode
)paren
(brace
r_char
id|name
(braket
l_int|8
)braket
suffix:semicolon
r_static
r_char
op_star
id|formats
(braket
id|ST_NBR_MODES
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*  Rewind entry  */
id|sprintf
(paren
id|name
comma
l_string|&quot;mt%s&quot;
comma
id|formats
(braket
id|mode
)braket
)paren
suffix:semicolon
macro_line|# if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|tpnt-&gt;de_r
(braket
id|mode
)braket
op_assign
id|devfs_register
(paren
id|SDp-&gt;de
comma
id|name
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
id|i
op_plus
(paren
id|mode
op_lshift
l_int|5
)paren
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
op_amp
id|osst_fops
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|# else
id|tpnt-&gt;de_r
(braket
id|mode
)braket
op_assign
id|devfs_register
(paren
id|SDp-&gt;de
comma
id|name
comma
l_int|0
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
id|i
op_plus
(paren
id|mode
op_lshift
l_int|5
)paren
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
l_int|0
comma
l_int|0
comma
op_amp
id|osst_fops
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|# endif&t;&t;
multiline_comment|/*  No-rewind entry  */
id|sprintf
(paren
id|name
comma
l_string|&quot;mt%sn&quot;
comma
id|formats
(braket
id|mode
)braket
)paren
suffix:semicolon
macro_line|# if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|tpnt-&gt;de_n
(braket
id|mode
)braket
op_assign
id|devfs_register
(paren
id|SDp-&gt;de
comma
id|name
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
id|i
op_plus
(paren
id|mode
op_lshift
l_int|5
)paren
op_plus
l_int|128
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
op_amp
id|osst_fops
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|# else&t;&t;
id|tpnt-&gt;de_n
(braket
id|mode
)braket
op_assign
id|devfs_register
(paren
id|SDp-&gt;de
comma
id|name
comma
l_int|0
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
id|i
op_plus
(paren
id|mode
op_lshift
l_int|5
)paren
op_plus
l_int|128
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
l_int|0
comma
l_int|0
comma
op_amp
id|osst_fops
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|# endif
)brace
id|devfs_register_tape
(paren
id|tpnt-&gt;de_r
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
id|tpnt-&gt;device
op_assign
id|SDp
suffix:semicolon
id|tpnt-&gt;devt
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|i
)paren
suffix:semicolon
id|tpnt-&gt;dirty
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;drv_buffer
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Try buffering if no mode sense */
id|tpnt-&gt;restr_dma
op_assign
(paren
id|SDp-&gt;host
)paren
op_member_access_from_pointer
id|unchecked_isa_dma
suffix:semicolon
id|tpnt-&gt;density
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;do_auto_lock
op_assign
id|OSST_AUTO_LOCK
suffix:semicolon
id|tpnt-&gt;can_bsr
op_assign
id|OSST_IN_FILE_POS
suffix:semicolon
id|tpnt-&gt;can_partitions
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;two_fm
op_assign
id|OSST_TWO_FM
suffix:semicolon
id|tpnt-&gt;fast_mteom
op_assign
id|OSST_FAST_MTEOM
suffix:semicolon
id|tpnt-&gt;scsi2_logical
op_assign
id|OSST_SCSI2LOGICAL
suffix:semicolon
multiline_comment|/* FIXME */
id|tpnt-&gt;write_threshold
op_assign
id|osst_write_threshold
suffix:semicolon
id|tpnt-&gt;default_drvbuffer
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* No forced buffering */
id|tpnt-&gt;partition
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;nbr_partitions
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;timeout
op_assign
id|OSST_TIMEOUT
suffix:semicolon
id|tpnt-&gt;long_timeout
op_assign
id|OSST_LONG_TIMEOUT
suffix:semicolon
multiline_comment|/* Recognize OnStream tapes */
id|printk
(paren
l_string|&quot;osst%i: Tape driver with OnStream support osst %s&bslash;nosst%i: %s&bslash;n&quot;
comma
id|i
comma
id|osst_version
comma
id|i
comma
id|cvsid
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t need to test for OnStream, as this has been done in detect () */
id|tpnt-&gt;os_fw_rev
op_assign
id|osst_parse_firmware_rev
(paren
id|SDp-&gt;rev
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
(paren
l_string|&quot;osst%i: OnStream tape drive recognized, Model %s&bslash;n&quot;
comma
id|i
comma
id|SDp-&gt;model
)paren
suffix:semicolon
macro_line|#endif
id|tpnt-&gt;omit_blklims
op_assign
l_int|1
suffix:semicolon
id|tpnt-&gt;poll
op_assign
(paren
id|strncmp
c_func
(paren
id|SDp-&gt;model
comma
l_string|&quot;DI-&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_or
id|OSST_FW_NEED_POLL
c_func
(paren
id|tpnt-&gt;os_fw_rev
comma
id|SDp
)paren
suffix:semicolon
id|tpnt-&gt;logical_blk_in_buffer
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;header_ok
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;linux_media
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;header_cache
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_MODES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STm
op_assign
op_amp
(paren
id|tpnt-&gt;modes
(braket
id|i
)braket
)paren
suffix:semicolon
id|STm-&gt;defined
op_assign
id|FALSE
suffix:semicolon
id|STm-&gt;sysv
op_assign
id|OSST_SYSV
suffix:semicolon
id|STm-&gt;defaults_for_writes
op_assign
l_int|0
suffix:semicolon
id|STm-&gt;do_async_writes
op_assign
id|OSST_ASYNC_WRITES
suffix:semicolon
id|STm-&gt;do_buffer_writes
op_assign
id|OSST_BUFFER_WRITES
suffix:semicolon
id|STm-&gt;do_read_ahead
op_assign
id|OSST_READ_AHEAD
suffix:semicolon
id|STm-&gt;default_compression
op_assign
id|ST_DONT_TOUCH
suffix:semicolon
id|STm-&gt;default_blksize
op_assign
l_int|32
op_star
id|ST_KILOBYTE
suffix:semicolon
multiline_comment|/* No forced size */
id|STm-&gt;default_density
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No forced density */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|tpnt-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
id|FALSE
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;drv_file
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|tpnt-&gt;current_mode
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;modes
(braket
l_int|0
)braket
dot
id|defined
op_assign
id|TRUE
suffix:semicolon
id|tpnt-&gt;density_changed
op_assign
id|tpnt-&gt;compression_changed
op_assign
id|tpnt-&gt;blksize_changed
op_assign
id|FALSE
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|tpnt-&gt;lock
)paren
suffix:semicolon
id|osst_template.nr_dev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|osst_detect
r_static
r_int
id|osst_detect
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
r_if
c_cond
(paren
id|SDp-&gt;type
op_ne
id|TYPE_TAPE
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|osst_supports
c_func
(paren
id|SDp
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Detected OnStream scsi tape osst%d at scsi%d, channel %d, id %d, lun %d&bslash;n&quot;
comma
id|osst_template.dev_noticed
op_increment
comma
id|SDp-&gt;host-&gt;host_no
comma
id|SDp-&gt;channel
comma
id|SDp-&gt;id
comma
id|SDp-&gt;lun
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|osst_registered
r_static
r_int
id|osst_registered
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Driver initialization (not __initfunc because may be called later) */
DECL|function|osst_init
r_static
r_int
id|osst_init
c_func
(paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|osst_template.dev_noticed
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|osst_registered
)paren
(brace
macro_line|#ifdef CONFIG_DEVFS_FS
r_if
c_cond
(paren
id|devfs_register_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
comma
op_amp
id|osst_fops
)paren
)paren
(brace
macro_line|#else
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
comma
op_amp
id|osst_fops
)paren
)paren
(brace
macro_line|#endif
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst: Unable to get major %d for OnStream tapes&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|osst_registered
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|os_scsi_tapes
)paren
r_return
l_int|0
suffix:semicolon
id|osst_template.dev_max
op_assign
id|OSST_MAX_TAPES
suffix:semicolon
r_if
c_cond
(paren
id|osst_template.dev_max
OG
l_int|128
op_div
id|ST_NBR_MODES
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst: Only %d tapes accessible.&bslash;n&quot;
comma
l_int|128
op_div
id|ST_NBR_MODES
)paren
suffix:semicolon
id|os_scsi_tapes
op_assign
(paren
id|OS_Scsi_Tape
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|osst_template.dev_max
op_star
r_sizeof
(paren
id|OS_Scsi_Tape
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|os_scsi_tapes
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst: Unable to allocate array for OnStream SCSI tapes.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|devfs_unregister_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
)paren
suffix:semicolon
macro_line|#else
id|unregister_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|osst_template.dev_max
suffix:semicolon
op_increment
id|i
)paren
id|os_scsi_tapes
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Allocate the buffer pointers */
id|osst_buffers
op_assign
(paren
id|OSST_buffer
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|osst_template.dev_max
op_star
r_sizeof
(paren
id|OSST_buffer
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_buffers
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;osst: Unable to allocate tape buffer pointers.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|devfs_unregister_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
)paren
suffix:semicolon
macro_line|#else
id|unregister_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|os_scsi_tapes
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|osst_nbr_buffers
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|OSST_DEB_MSG
l_string|&quot;osst: Buffer size %d bytes, write threshold %d bytes.&bslash;n&quot;
comma
id|osst_buffer_size
comma
id|osst_write_threshold
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|osst_detach
r_static
r_void
id|osst_detach
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
id|OS_Scsi_Tape
op_star
id|tpnt
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
r_int
id|mode
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|osst_template.dev_max
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tpnt
op_assign
id|os_scsi_tapes
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tpnt
op_ne
l_int|NULL
op_logical_and
id|tpnt-&gt;device
op_eq
id|SDp
)paren
(brace
id|tpnt-&gt;device
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
r_for
c_loop
(paren
id|mode
op_assign
l_int|0
suffix:semicolon
id|mode
OL
id|ST_NBR_MODES
suffix:semicolon
op_increment
id|mode
)paren
(brace
id|devfs_unregister
(paren
id|tpnt-&gt;de_r
(braket
id|mode
)braket
)paren
suffix:semicolon
id|tpnt-&gt;de_r
(braket
id|mode
)braket
op_assign
l_int|NULL
suffix:semicolon
id|devfs_unregister
(paren
id|tpnt-&gt;de_n
(braket
id|mode
)braket
)paren
suffix:semicolon
id|tpnt-&gt;de_n
(braket
id|mode
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
id|kfree
c_func
(paren
id|tpnt
)paren
suffix:semicolon
id|os_scsi_tapes
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|SDp-&gt;attached
op_decrement
suffix:semicolon
id|osst_template.nr_dev
op_decrement
suffix:semicolon
id|osst_template.dev_noticed
op_decrement
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|init_osst
r_static
r_int
id|__init
id|init_osst
c_func
(paren
r_void
)paren
(brace
id|validate_options
c_func
(paren
)paren
suffix:semicolon
id|osst_template.module
op_assign
id|THIS_MODULE
suffix:semicolon
r_return
id|scsi_register_module
c_func
(paren
id|MODULE_SCSI_DEV
comma
op_amp
id|osst_template
)paren
suffix:semicolon
)brace
DECL|function|exit_osst
r_static
r_void
id|__exit
id|exit_osst
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|OS_Scsi_Tape
op_star
id|STp
suffix:semicolon
id|scsi_unregister_module
c_func
(paren
id|MODULE_SCSI_DEV
comma
op_amp
id|osst_template
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|devfs_unregister_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
)paren
suffix:semicolon
macro_line|#else
id|unregister_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;osst&quot;
)paren
suffix:semicolon
macro_line|#endif
id|osst_registered
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|os_scsi_tapes
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|osst_template.dev_max
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp
op_assign
id|os_scsi_tapes
(braket
id|i
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;header_cache
op_ne
l_int|NULL
)paren
id|vfree
c_func
(paren
id|STp-&gt;header_cache
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|STp
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|os_scsi_tapes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osst_buffers
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|osst_nbr_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|osst_buffers
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|osst_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|orig_sg_segs
op_assign
l_int|0
suffix:semicolon
id|normalize_buffer
c_func
(paren
id|osst_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|osst_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|osst_buffers
)paren
suffix:semicolon
)brace
)brace
id|osst_template.dev_max
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;osst: Unloaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|init_osst
id|module_init
c_func
(paren
id|init_osst
)paren
suffix:semicolon
DECL|variable|exit_osst
id|module_exit
c_func
(paren
id|exit_osst
)paren
suffix:semicolon
eof
