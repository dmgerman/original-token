multiline_comment|/***********************************************************************&n; *&t;FILE NAME : SCSIIOM.C&t;&t;&t;&t;&t;       *&n; *&t;     BY   : C.L. Huang,    ching@tekram.com.tw&t;&t;       *&n; *&t;Description: Device Driver for Tekram DC-390 (T) PCI SCSI      *&n; *&t;&t;     Bus Master Host Adapter&t;&t;&t;       *&n; ***********************************************************************/
multiline_comment|/* $Id: scsiiom.c,v 2.55.2.17 2000/12/20 00:39:37 garloff Exp $ */
r_static
r_void
id|__inline__
DECL|function|dc390_freetag
id|dc390_freetag
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;TagNumber
OL
l_int|255
)paren
(brace
id|pDCB-&gt;TagMask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pSRB-&gt;TagNumber
)paren
suffix:semicolon
multiline_comment|/* free tag mask */
id|pSRB-&gt;TagNumber
op_assign
l_int|255
suffix:semicolon
)brace
)brace
suffix:semicolon
id|UCHAR
DECL|function|dc390_StartSCSI
id|dc390_StartSCSI
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|UCHAR
id|cmd
suffix:semicolon
id|UCHAR
id|disc_allowed
comma
id|try_sync_nego
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP0
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;Connected
)paren
(brace
singleline_comment|// Should not happen normally
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Can&squot;t select when connected! (%08x,%02x)&bslash;n&quot;
comma
id|pSRB-&gt;SRBState
comma
id|pSRB-&gt;SRBFlag
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|pACB-&gt;SelConn
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
)paren
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: We were just reset and don&squot;t accept commands yet!&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
l_int|1
suffix:semicolon
)brace
id|DC390_write8
(paren
id|Scsi_Dest_ID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Period
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Offset
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|pDCB-&gt;CtrlR1
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg3
comma
id|pDCB-&gt;CtrlR3
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pDCB-&gt;CtrlR4
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
multiline_comment|/* Flush FIFO */
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Start SCSI command: %02x (Sync:%02x)&bslash;n&quot;
comma
"&bslash;"
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;SyncMode
)paren
suffix:semicolon
)paren
id|disc_allowed
op_assign
id|pDCB-&gt;DevMode
op_amp
id|EN_DISCONNECT_
suffix:semicolon
id|try_sync_nego
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t disconnect on AUTO_REQSENSE, cause it might be an&n;     * Contingent Allegiance Condition (6.6), where no tags should be used.&n;     * All other have to be allowed to disconnect to prevent Incorrect &n;     * Initiator Connection (6.8.2/6.5.2) */
multiline_comment|/* Changed KG, 99/06/06 */
r_if
c_cond
(paren
multiline_comment|/*(((pSRB-&gt;pcmd-&gt;cmnd[0] == INQUIRY) || (pSRB-&gt;pcmd-&gt;cmnd[0] == REQUEST_SENSE) ||&n;&t; * (pSRB-&gt;pcmd-&gt;cmnd[0] == TEST_UNIT_READY)) &amp;&amp; pACB-&gt;scan_devices)&n;&t;&t;||*/
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
id|disc_allowed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_ENABLE
)paren
op_logical_and
(paren
id|pDCB-&gt;TargetLUN
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pDCB-&gt;Inquiry7
op_amp
l_int|0x10
)paren
op_logical_and
(paren
(paren
(paren
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_or
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
op_logical_or
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
)paren
)paren
id|try_sync_nego
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|SEL_W_ATN
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|IDENTIFY
c_func
(paren
id|disc_allowed
comma
id|pDCB-&gt;TargetLUN
)paren
)paren
suffix:semicolon
multiline_comment|/* Change 99/05/31: Don&squot;t use tags when not disconnecting (BUSY) */
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
op_logical_and
id|disc_allowed
)paren
(brace
id|UCHAR
id|tag_no
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
l_int|1
op_lshift
id|tag_no
)paren
op_amp
id|pDCB-&gt;TagMask
)paren
id|tag_no
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tag_no
op_ge
r_sizeof
(paren
id|pDCB-&gt;TagMask
)paren
op_star
l_int|8
op_logical_or
id|tag_no
op_ge
id|pDCB-&gt;MaxCommand
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Out of tags for Dev. %02x %02x&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
singleline_comment|//goto no_tag;
)brace
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|SIMPLE_QUEUE_TAG
)paren
suffix:semicolon
id|pDCB-&gt;TagMask
op_or_assign
(paren
l_int|1
op_lshift
id|tag_no
)paren
suffix:semicolon
id|pSRB-&gt;TagNumber
op_assign
id|tag_no
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|tag_no
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: Select w/DisCn for Cmd %li (SRB %p), Using Tag %02x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB
comma
id|tag_no
)paren
suffix:semicolon
)paren
id|cmd
op_assign
id|SEL_W_ATN3
suffix:semicolon
)brace
r_else
multiline_comment|/* No TagQ */
(brace
singleline_comment|//      no_tag:
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: Select w%s/DisCn for Cmd %li (SRB %p), No TagQ&bslash;n&quot;
comma
(paren
id|disc_allowed
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;o&quot;
)paren
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB
)paren
suffix:semicolon
)paren
)brace
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_START_
suffix:semicolon
r_if
c_cond
(paren
id|try_sync_nego
)paren
(brace
id|UCHAR
id|Sync_Off
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: NEW Sync Nego code triggered (%i %i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
)paren
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|EXTENDED_MESSAGE
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|2
)braket
op_assign
id|EXTENDED_SDTR
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|3
)braket
op_assign
id|pDCB-&gt;NegoPeriod
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|Sync_Off
op_amp
l_int|0x0f
)paren
)paren
id|Sync_Off
op_assign
id|SYNC_NEGO_OFFSET
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|4
)braket
op_assign
id|Sync_Off
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|5
suffix:semicolon
singleline_comment|//pSRB-&gt;SRBState = SRB_MSGOUT_;
id|pSRB-&gt;SRBState
op_or_assign
id|DO_SYNC_NEGO
suffix:semicolon
id|cmd
op_assign
id|SEL_W_ATN_STOP
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Command is written in CommandPhase, if SEL_W_ATN_STOP ... */
r_if
c_cond
(paren
id|cmd
op_ne
id|SEL_W_ATN_STOP
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|DC390_write8
(paren
id|ScsiFifo
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
r_sizeof
(paren
id|pSRB-&gt;pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|0
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: AutoReqSense !&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
r_else
multiline_comment|/* write cmnd to bus */
(brace
id|PUCHAR
id|ptr
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|pSRB-&gt;pcmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pSRB-&gt;pcmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|DC390_write8
(paren
id|ScsiFifo
comma
op_star
(paren
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
id|DEBUG0
c_func
(paren
r_if
(paren
id|pACB-&gt;pActiveDCB
)paren
"&bslash;"
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: ActiveDCB != 0&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DEBUG0
c_func
(paren
r_if
(paren
id|pDCB-&gt;pActiveSRB
)paren
"&bslash;"
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: ActiveSRB != 0&bslash;n&quot;
)paren
suffix:semicolon
)paren
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
r_if
c_cond
(paren
id|DC390_read8
(paren
id|Scsi_Status
)paren
op_amp
id|INTERRUPT
)paren
(brace
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Interrupt during Start SCSI (pid %li, target %02i-%02i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;target
comma
id|pSRB-&gt;pcmd-&gt;lun
)paren
suffix:semicolon
)paren
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
singleline_comment|//DC390_write8 (ScsiCmd, CLEAR_FIFO_CMD);
id|pACB-&gt;SelLost
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|cmd
)paren
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//#define DMA_INT EN_DMA_INT /*| EN_PAGE_INT*/
DECL|macro|DMA_INT
mdefine_line|#define DMA_INT 0
macro_line|#if DMA_INT
multiline_comment|/* This is similar to AM53C974.c ... */
r_static
id|UCHAR
DECL|function|dc390_dma_intr
id|dc390_dma_intr
(paren
id|PACB
id|pACB
)paren
(brace
id|PSRB
id|pSRB
suffix:semicolon
id|UCHAR
id|dstate
suffix:semicolon
id|DEBUG0
c_func
(paren
id|USHORT
id|pstate
suffix:semicolon
id|PDEVDECL1
suffix:semicolon
)paren
id|DEBUG0
c_func
(paren
id|PDEVSET1
suffix:semicolon
)paren
id|DEBUG0
c_func
(paren
id|PCI_READ_CONFIG_WORD
(paren
id|PDEV
comma
id|PCI_STATUS
comma
op_amp
id|pstate
)paren
suffix:semicolon
)paren
id|DEBUG0
c_func
(paren
r_if
(paren
id|pstate
op_amp
(paren
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
)paren
"&bslash;"
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;DC390: PCI state = %04x!&bslash;n&quot;
comma
id|pstate
)paren
suffix:semicolon
"&bslash;"
id|PCI_WRITE_CONFIG_WORD
(paren
id|PDEV
comma
id|PCI_STATUS
comma
(paren
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)paren
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;pActiveDCB
op_logical_or
op_logical_neg
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
r_return
id|dstate
suffix:semicolon
r_else
id|pSRB
op_assign
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|dstate
op_amp
(paren
id|DMA_XFER_ABORT
op_or
id|DMA_XFER_ERROR
op_or
id|POWER_DOWN
op_or
id|PCI_MS_ABORT
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: DMA error (%02x)!&bslash;n&quot;
comma
id|dstate
)paren
suffix:semicolon
r_return
id|dstate
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|dstate
op_amp
id|DMA_XFER_DONE
)paren
(brace
id|UINT
id|residual
comma
id|xferCnt
suffix:semicolon
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC390_read8
(paren
id|DMA_Cmd
)paren
op_amp
id|READ_DIRECTION
)paren
)paren
(brace
r_do
(brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: read residual bytes ... &bslash;n&quot;
)paren
suffix:semicolon
)paren
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
id|residual
op_assign
id|DC390_read8
(paren
id|CtcReg_Low
)paren
op_or
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
op_or
id|DC390_read8
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
suffix:semicolon
id|residual
op_add_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
suffix:semicolon
)brace
r_while
c_loop
(paren
id|residual
op_logical_and
op_logical_neg
(paren
id|dstate
op_amp
id|SCSI_INTERRUPT
)paren
op_logical_and
op_decrement
id|ctr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: dma_intr: DMA aborted unfinished: %06x bytes remain!!&bslash;n&quot;
comma
id|DC390_read32
(paren
id|DMA_Wk_ByteCntr
)paren
)paren
suffix:semicolon
multiline_comment|/* residual =  ... */
)brace
r_else
id|residual
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ??? */
id|xferCnt
op_assign
id|pSRB-&gt;SGToBeXferLen
op_minus
id|residual
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|residual
suffix:semicolon
macro_line|# ifdef DC390_DEBUG0
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: DMA: residual = %i, xfer = %i&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|residual
comma
(paren
r_int
r_int
)paren
id|xferCnt
)paren
suffix:semicolon
macro_line|# endif
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
)brace
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|dstate
op_lshift
l_int|24
suffix:semicolon
r_return
id|dstate
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
r_void
id|__inline__
DECL|function|DC390_Interrupt
id|DC390_Interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|PACB
id|pACB
comma
id|pACB2
suffix:semicolon
id|PDCB
id|pDCB
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|UCHAR
id|sstatus
op_assign
l_int|0
suffix:semicolon
id|UCHAR
id|phase
suffix:semicolon
r_void
(paren
op_star
id|stateV
)paren
(paren
id|PACB
comma
id|PSRB
comma
id|PUCHAR
)paren
suffix:semicolon
id|UCHAR
id|istate
comma
id|istatus
suffix:semicolon
macro_line|#if DMA_INT
id|UCHAR
id|dstatus
suffix:semicolon
macro_line|#endif
id|DC390_AFLAGS
id|DC390_IFLAGS
singleline_comment|//DC390_DFLAGS
id|pACB
op_assign
(paren
id|PACB
)paren
id|dev_id
suffix:semicolon
r_for
c_loop
(paren
id|pACB2
op_assign
id|dc390_pACB_start
suffix:semicolon
(paren
id|pACB2
op_logical_and
id|pACB2
op_ne
id|pACB
)paren
suffix:semicolon
id|pACB2
op_assign
id|pACB2-&gt;pNextACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB2
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: IRQ called with foreign dev_id %p!&bslash;n&quot;
comma
id|pACB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|//DC390_LOCK_DRV;
id|sstatus
op_assign
id|DC390_read8
(paren
id|Scsi_Status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sstatus
op_amp
id|INTERRUPT
)paren
)paren
(brace
multiline_comment|/*DC390_UNLOCK_DRV;*/
r_return
suffix:semicolon
)brace
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;sstatus=%02x,&quot;
comma
id|sstatus
)paren
suffix:semicolon
)paren
macro_line|#if DMA_INT
id|DC390_LOCK_IO
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
id|dstatus
op_assign
id|dc390_dma_intr
(paren
id|pACB
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;dstatus=%02x,&quot;
comma
id|dstatus
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|dstatus
op_amp
id|SCSI_INTERRUPT
)paren
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390 Int w/o SCSI actions (only DMA?)&bslash;n&quot;
)paren
suffix:semicolon
)paren
singleline_comment|//DC390_UNLOCK_DRV;
r_return
suffix:semicolon
)brace
suffix:semicolon
macro_line|#else
singleline_comment|//DC390_write32 (DMA_ScsiBusCtrl, WRT_ERASE_DMA_STAT | EN_INT_ON_PCI_ABORT);
singleline_comment|//dstatus = DC390_read8 (DMA_Status);
singleline_comment|//DC390_write32 (DMA_ScsiBusCtrl, EN_INT_ON_PCI_ABORT);
macro_line|#endif
id|DC390_LOCK_IO
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
singleline_comment|//DC390_UNLOCK_DRV_NI; /* Allow _other_ CPUs to process IRQ (useful for shared IRQs) */
id|istate
op_assign
id|DC390_read8
(paren
id|Intern_State
)paren
suffix:semicolon
id|istatus
op_assign
id|DC390_read8
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* This clears Scsi_Status, Intern_State and INT_Status ! */
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;Istatus(Res,Inv,Dis,Serv,Succ,ReS,SelA,Sel)=%02x,&quot;
comma
id|istatus
)paren
suffix:semicolon
)paren
id|dc390_laststatus
op_and_assign
op_complement
l_int|0x00ffffff
suffix:semicolon
id|dc390_laststatus
op_or_assign
multiline_comment|/* dstatus&lt;&lt;24 | */
id|sstatus
op_lshift
l_int|16
op_or
id|istate
op_lshift
l_int|8
op_or
id|istatus
suffix:semicolon
r_if
c_cond
(paren
id|sstatus
op_amp
id|ILLEGAL_OP_ERR
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Illegal Operation detected (%08x)!&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|dc390_dumpinfo
(paren
id|pACB
comma
id|pACB-&gt;pActiveDCB
comma
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|istatus
op_amp
id|INVALID_CMD
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Invalid Command detected (%08x)!&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|dc390_InvalidCmd
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
id|SCSI_RESET
)paren
(brace
id|dc390_ScsiRstDetect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
id|DISCONNECTED
)paren
(brace
id|dc390_Disconnect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
id|RESELECTED
)paren
(brace
id|dc390_Reselect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|istatus
op_amp
(paren
id|SELECTED
op_or
id|SEL_ATTENTION
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Target mode not supported!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
(paren
id|SUCCESSFUL_OP
op_or
id|SERVICE_REQUEST
)paren
)paren
(brace
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Suc. op/ Serv. req: pActiveDCB = 0!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
id|dc390_EnableMsgOut_Abort
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
id|phase
op_assign
id|pSRB-&gt;ScsiPhase
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: [%i]%s(0) (%02x)&bslash;n&quot;
comma
id|phase
comma
id|dc390_p0_str
(braket
id|phase
)braket
comma
id|sstatus
)paren
suffix:semicolon
)paren
id|stateV
op_assign
(paren
r_void
op_star
)paren
id|dc390_phase0
(braket
id|phase
)braket
suffix:semicolon
(paren
op_star
id|stateV
)paren
(paren
id|pACB
comma
id|pSRB
comma
op_amp
id|sstatus
)paren
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|sstatus
op_amp
l_int|7
suffix:semicolon
id|phase
op_assign
(paren
id|UCHAR
)paren
id|sstatus
op_amp
l_int|7
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: [%i]%s(1) (%02x)&bslash;n&quot;
comma
id|phase
comma
id|dc390_p1_str
(braket
id|phase
)braket
comma
id|sstatus
)paren
suffix:semicolon
)paren
id|stateV
op_assign
(paren
r_void
op_star
)paren
id|dc390_phase1
(braket
id|phase
)braket
suffix:semicolon
(paren
op_star
id|stateV
)paren
(paren
id|pACB
comma
id|pSRB
comma
op_amp
id|sstatus
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
id|unlock
suffix:colon
singleline_comment|//DC390_LOCK_DRV_NI;
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
singleline_comment|//DC390_UNLOCK_DRV; /* Restore initial flags */
)brace
r_void
DECL|function|do_DC390_Interrupt
id|do_DC390_Interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Irq (%i) caught: &quot;
comma
id|irq
)paren
suffix:semicolon
)paren
multiline_comment|/* Locking is done in DC390_Interrupt */
id|DC390_Interrupt
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
l_string|&quot;.. IRQ returned&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
r_void
DECL|function|dc390_DataOut_0
id|dc390_DataOut_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|UCHAR
id|sstatus
suffix:semicolon
id|PSGL
id|psgl
suffix:semicolon
id|UINT
id|ResidCnt
comma
id|xferCnt
suffix:semicolon
id|UCHAR
id|dstate
op_assign
l_int|0
suffix:semicolon
id|sstatus
op_assign
op_star
id|psstatus
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|sstatus
op_amp
(paren
id|PARITY_ERR
op_or
id|ILLEGAL_OP_ERR
)paren
)paren
(brace
id|pSRB-&gt;SRBStatus
op_or_assign
id|PARITY_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstatus
op_amp
id|COUNT_2_ZERO
)paren
(brace
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
multiline_comment|/* only try for about a second */
r_while
c_loop
(paren
op_decrement
id|ctr
op_logical_and
op_logical_neg
(paren
(paren
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
)paren
op_amp
id|DMA_XFER_DONE
)paren
op_logical_and
id|pSRB-&gt;SGToBeXferLen
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: Deadlock in DataOut_0: DMA aborted unfinished: %06x bytes remain!!&bslash;n&quot;
comma
id|DC390_read32
(paren
id|DMA_Wk_ByteCntr
)paren
)paren
suffix:semicolon
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|dstate
op_lshift
l_int|24
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|pSRB-&gt;SGToBeXferLen
suffix:semicolon
id|pSRB-&gt;SGIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;pSegmentList
op_increment
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|virt_to_bus
c_func
(paren
id|psgl-&gt;address
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
(paren
id|ULONG
)paren
id|psgl-&gt;length
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ResidCnt
op_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
suffix:semicolon
id|ResidCnt
op_add_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|CtcReg_Low
)paren
suffix:semicolon
id|xferCnt
op_assign
id|pSRB-&gt;SGToBeXferLen
op_minus
id|ResidCnt
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|ResidCnt
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
op_star
id|psstatus
op_amp
l_int|7
)paren
op_ne
id|SCSI_DATA_OUT
)paren
(brace
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|WRITE_DIRECTION
op_plus
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* | DMA_INT */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|dc390_DataIn_0
id|dc390_DataIn_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|UCHAR
id|sstatus
comma
id|residual
comma
id|bval
suffix:semicolon
id|PSGL
id|psgl
suffix:semicolon
id|UINT
id|ResidCnt
comma
id|i
suffix:semicolon
id|ULONG
id|xferCnt
suffix:semicolon
id|PUCHAR
id|ptr
suffix:semicolon
id|sstatus
op_assign
op_star
id|psstatus
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|sstatus
op_amp
(paren
id|PARITY_ERR
op_or
id|ILLEGAL_OP_ERR
)paren
)paren
(brace
id|pSRB-&gt;SRBStatus
op_or_assign
id|PARITY_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstatus
op_amp
id|COUNT_2_ZERO
)paren
(brace
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
multiline_comment|/* only try for about a second */
r_int
id|dstate
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|ctr
op_logical_and
op_logical_neg
(paren
(paren
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
)paren
op_amp
id|DMA_XFER_DONE
)paren
op_logical_and
id|pSRB-&gt;SGToBeXferLen
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: Deadlock in DataIn_0: DMA aborted unfinished: %06x bytes remain!!&bslash;n&quot;
comma
id|DC390_read32
(paren
id|DMA_Wk_ByteCntr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: DataIn_0: DMA State: %i&bslash;n&quot;
comma
id|dstate
)paren
suffix:semicolon
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|dstate
op_lshift
l_int|24
suffix:semicolon
id|DEBUG1
c_func
(paren
id|ResidCnt
op_assign
(paren
(paren
id|ULONG
)paren
id|DC390_read8
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
)paren
"&bslash;"
op_plus
(paren
(paren
id|ULONG
)paren
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
)paren
"&bslash;"
op_plus
(paren
(paren
id|ULONG
)paren
id|DC390_read8
(paren
id|CtcReg_Low
)paren
)paren
suffix:semicolon
)paren
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Count_2_Zero (ResidCnt=%i,ToBeXfer=%li),&quot;
comma
id|ResidCnt
comma
id|pSRB-&gt;SGToBeXferLen
)paren
suffix:semicolon
)paren
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|READ_DIRECTION
op_plus
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* | DMA_INT */
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|pSRB-&gt;SGToBeXferLen
suffix:semicolon
id|pSRB-&gt;SGIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;pSegmentList
op_increment
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|virt_to_bus
c_func
(paren
id|psgl-&gt;address
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
(paren
id|ULONG
)paren
id|psgl-&gt;length
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* phase changed */
(brace
id|residual
op_assign
l_int|0
suffix:semicolon
id|bval
op_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
suffix:semicolon
r_while
c_loop
(paren
id|bval
op_amp
l_int|0x1f
)paren
(brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Check for residuals,&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
(paren
id|bval
op_amp
l_int|0x1f
)paren
op_eq
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bval
op_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
l_int|0x1f
)paren
)paren
(brace
r_goto
id|din_1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
l_int|0x0ff
)paren
(brace
id|residual
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ;1 residual byte */
r_goto
id|din_1
suffix:semicolon
)brace
)brace
)brace
r_else
id|bval
op_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
suffix:semicolon
)brace
id|din_1
suffix:colon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|READ_DIRECTION
op_plus
id|DMA_BLAST_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0xa000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|bval
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|BLAST_COMPLETE
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* It seems a DMA Blast abort isn&squot;t that bad ... */
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: DMA Blast aborted unfinished!&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, READ_DIRECTION+DMA_IDLE_CMD); /* | DMA_INT */
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|bval
op_lshift
l_int|24
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Blast: Read %i times DMA_Status %02x&quot;
comma
l_int|0xa000
op_minus
id|i
comma
id|bval
)paren
suffix:semicolon
)paren
id|ResidCnt
op_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|CtcReg_High
)paren
suffix:semicolon
id|ResidCnt
op_lshift_assign
l_int|8
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
suffix:semicolon
id|ResidCnt
op_lshift_assign
l_int|8
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|UINT
)paren
id|DC390_read8
(paren
id|CtcReg_Low
)paren
suffix:semicolon
id|xferCnt
op_assign
id|pSRB-&gt;SGToBeXferLen
op_minus
id|ResidCnt
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|ResidCnt
suffix:semicolon
r_if
c_cond
(paren
id|residual
)paren
(brace
id|bval
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
multiline_comment|/* get one residual byte */
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|bus_to_virt
c_func
(paren
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|bval
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_increment
suffix:semicolon
id|xferCnt
op_increment
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_increment
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_decrement
suffix:semicolon
)brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Xfered: %li, Total: %li, Remaining: %li&bslash;n&quot;
comma
id|xferCnt
comma
"&bslash;"
id|pSRB-&gt;TotalXferredLen
comma
id|pSRB-&gt;SGToBeXferLen
)paren
suffix:semicolon
)paren
)brace
)brace
r_if
c_cond
(paren
(paren
op_star
id|psstatus
op_amp
l_int|7
)paren
op_ne
id|SCSI_DATA_IN
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|READ_DIRECTION
op_plus
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* | DMA_INT */
)brace
)brace
r_static
r_void
DECL|function|dc390_Command_0
id|dc390_Command_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
)brace
r_static
r_void
DECL|function|dc390_Status_0
id|dc390_Status_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|pSRB-&gt;TargetStatus
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
singleline_comment|//udelay (1);
id|pSRB-&gt;EndMessage
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
multiline_comment|/* get message */
op_star
id|psstatus
op_assign
id|SCSI_NOP0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_COMPLETED
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|MSG_ACCEPTED_CMD
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_MsgOut_0
id|dc390_MsgOut_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_UNEXPECT_RESEL
op_plus
id|SRB_ABORT_SENT
)paren
)paren
(brace
op_star
id|psstatus
op_assign
id|SCSI_NOP0
suffix:semicolon
)brace
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_static
r_void
id|__inline__
DECL|function|dc390_reprog
id|dc390_reprog
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
id|DC390_write8
(paren
id|Sync_Period
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Offset
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg3
comma
id|pDCB-&gt;CtrlR3
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pDCB-&gt;CtrlR4
)paren
suffix:semicolon
id|dc390_SetXferRate
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef DC390_DEBUG0
r_static
r_void
DECL|function|dc390_printMsg
id|dc390_printMsg
(paren
id|UCHAR
op_star
id|MsgBuf
comma
id|UCHAR
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|MsgBuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|MsgBuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
DECL|macro|DC390_ENABLE_MSGOUT
mdefine_line|#define DC390_ENABLE_MSGOUT DC390_write8 (ScsiCmd, SET_ATN_CMD)
multiline_comment|/* reject_msg */
r_static
r_void
id|__inline__
DECL|function|dc390_MsgIn_reject
id|dc390_MsgIn_reject
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|MESSAGE_REJECT
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
id|DEBUG0
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Reject message&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
multiline_comment|/* abort command */
r_static
r_void
id|__inline__
DECL|function|dc390_EnableMsgOut_Abort
id|dc390_EnableMsgOut_Abort
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
id|pSRB-&gt;pSRBDCB-&gt;DCBFlag
op_and_assign
op_complement
id|ABORT_DEV_
suffix:semicolon
)brace
r_static
id|PSRB
DECL|function|dc390_MsgIn_QTag
id|dc390_MsgIn_QTag
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|UCHAR
id|tag
)paren
(brace
id|PSRB
id|lastSRB
op_assign
id|pDCB-&gt;pGoingLast
suffix:semicolon
id|PSRB
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|pSRB
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;TagNumber
op_eq
id|tag
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|lastSRB
)paren
r_goto
id|mingx0
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
id|dc390_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
)paren
(brace
r_goto
id|mingx0
suffix:semicolon
)brace
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
)brace
r_else
(brace
id|mingx0
suffix:colon
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|ABORT_TAG
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
)brace
r_return
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* set async transfer mode */
r_static
r_void
DECL|function|dc390_MsgIn_set_async
id|dc390_MsgIn_set_async
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|PDCB
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|DO_SYNC_NEGO
)paren
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Target %i initiates Non-Sync?&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|DO_SYNC_NEGO
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_ENABLE
op_plus
id|SYNC_NEGO_DONE
)paren
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
singleline_comment|//pDCB-&gt;NegoPeriod = 50; /* 200ns &lt;=&gt; 5 MHz */
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
multiline_comment|/* fast clock / normal scsi */
id|pDCB-&gt;CtrlR4
op_and_assign
l_int|0x3f
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
multiline_comment|/* glitch eater */
id|dc390_reprog
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
multiline_comment|/* set sync transfer mode */
r_static
r_void
DECL|function|dc390_MsgIn_set_sync
id|dc390_MsgIn_set_sync
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|USHORT
id|wval
comma
id|wval1
suffix:semicolon
id|PDCB
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
id|UCHAR
id|oldsyncperiod
op_assign
id|pDCB-&gt;SyncPeriod
suffix:semicolon
id|UCHAR
id|oldsyncoffset
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|DO_SYNC_NEGO
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Target %i initiates Sync: %ins %i ... answer ...&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_lshift
l_int|2
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* reject */
singleline_comment|//dc390_MsgIn_reject (pACB, pSRB);
singleline_comment|//return dc390_MsgIn_set_async (pACB, pSRB);
multiline_comment|/* Reply with corrected SDTR Message */
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
OG
l_int|15
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Lower Sync Offset to 15&bslash;n&quot;
)paren
suffix:semicolon
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
op_assign
l_int|15
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
OL
id|pDCB-&gt;NegoPeriod
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Set sync nego period to %ins&bslash;n&quot;
comma
id|pDCB-&gt;NegoPeriod
op_lshift
l_int|2
)paren
suffix:semicolon
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_assign
id|pDCB-&gt;NegoPeriod
suffix:semicolon
)brace
suffix:semicolon
id|memcpy
(paren
id|pSRB-&gt;MsgOutBuf
comma
id|pSRB-&gt;MsgInBuf
comma
l_int|5
)paren
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|5
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
)brace
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|DO_SYNC_NEGO
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_ENABLE
op_plus
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_and_assign
l_int|0x0f0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_or_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
suffix:semicolon
id|wval
op_assign
(paren
id|USHORT
)paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
suffix:semicolon
id|wval
op_assign
id|wval
op_lshift
l_int|2
suffix:semicolon
id|wval
op_sub_assign
l_int|3
suffix:semicolon
id|wval1
op_assign
id|wval
op_div
l_int|25
suffix:semicolon
multiline_comment|/* compute speed */
r_if
c_cond
(paren
(paren
id|wval1
op_star
l_int|25
)paren
op_ne
id|wval
)paren
(brace
id|wval1
op_increment
suffix:semicolon
)brace
id|bval
op_assign
id|FAST_CLK
op_plus
id|FAST_SCSI
suffix:semicolon
multiline_comment|/* fast clock / fast scsi */
id|pDCB-&gt;CtrlR4
op_and_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* Glitch eater: 12ns less than normal */
r_if
c_cond
(paren
id|pACB-&gt;glitch_cfg
op_ne
id|NS_TO_GLITCH
c_func
(paren
l_int|0
)paren
)paren
id|pDCB-&gt;CtrlR4
op_or_assign
id|NS_TO_GLITCH
c_func
(paren
(paren
(paren
id|GLITCH_TO_NS
c_func
(paren
id|pACB-&gt;glitch_cfg
)paren
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|pDCB-&gt;CtrlR4
op_or_assign
id|NS_TO_GLITCH
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wval1
OL
l_int|4
)paren
id|pDCB-&gt;CtrlR4
op_or_assign
id|NS_TO_GLITCH
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Ultra */
r_if
c_cond
(paren
id|wval1
op_ge
l_int|8
)paren
(brace
id|wval1
op_decrement
suffix:semicolon
multiline_comment|/* Timing computation differs by 1 from FAST_SCSI */
id|bval
op_assign
id|FAST_CLK
suffix:semicolon
multiline_comment|/* fast clock / normal scsi */
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
multiline_comment|/* glitch eater */
)brace
id|pDCB-&gt;CtrlR3
op_assign
id|bval
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
(paren
id|UCHAR
)paren
id|wval1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|oldsyncperiod
op_ne
id|wval1
op_logical_or
id|oldsyncoffset
op_ne
id|pDCB-&gt;SyncOffset
)paren
op_logical_and
id|pDCB-&gt;TargetLUN
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|FAST_SCSI
)paren
)paren
id|wval1
op_increment
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Target %i: Sync transfer %i.%1i MHz, Offset %i&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
l_int|40
op_div
id|wval1
comma
(paren
(paren
l_int|40
op_mod
id|wval1
)paren
op_star
l_int|10
op_plus
id|wval1
op_div
l_int|2
)paren
op_div
id|wval1
comma
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
id|dc390_reprog
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* handle RESTORE_PTR */
r_static
r_void
DECL|function|dc390_restore_ptr
id|dc390_restore_ptr
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|PSGL
id|psgl
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
(paren
id|UCHAR
)paren
id|pSRB-&gt;pcmd-&gt;use_sg
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
id|pSRB-&gt;pcmd-&gt;request_buffer
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
r_while
c_loop
(paren
id|pSRB-&gt;TotalXferredLen
op_plus
(paren
id|ULONG
)paren
id|psgl-&gt;length
OL
id|pSRB-&gt;Saved_Ptr
)paren
(brace
id|pSRB-&gt;TotalXferredLen
op_add_assign
(paren
id|ULONG
)paren
id|psgl-&gt;length
suffix:semicolon
id|pSRB-&gt;SGIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;pSegmentList
op_increment
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|virt_to_bus
c_func
(paren
id|psgl-&gt;address
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
(paren
id|ULONG
)paren
id|psgl-&gt;length
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
)brace
id|pSRB-&gt;SGToBeXferLen
op_sub_assign
(paren
id|pSRB-&gt;Saved_Ptr
op_minus
id|pSRB-&gt;TotalXferredLen
)paren
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
(paren
id|pSRB-&gt;Saved_Ptr
op_minus
id|pSRB-&gt;TotalXferredLen
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Pointer restored. Segment %i, Total %li, Bus %08lx&bslash;n&quot;
comma
id|pSRB-&gt;SGIndex
comma
id|pSRB-&gt;Saved_Ptr
comma
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;pcmd-&gt;request_buffer
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
id|pSRB-&gt;pcmd-&gt;request_buffer
op_plus
id|pSRB-&gt;Saved_Ptr
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
id|pSRB-&gt;pcmd-&gt;request_bufflen
op_minus
id|pSRB-&gt;Saved_Ptr
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Pointer restored. Total %li, Bus %p&bslash;n&quot;
comma
id|pSRB-&gt;Saved_Ptr
comma
id|pSRB-&gt;Segmentx.address
)paren
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: RESTORE_PTR message for Transfer without Scatter-Gather ??&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
id|pSRB-&gt;Saved_Ptr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* According to the docs, the AM53C974 reads the message and &n; * generates a Succesful Operation IRQ before asserting ACK for&n; * the last byte (how does it know whether it&squot;s the last ?) */
multiline_comment|/* The old code handled it in another way, indicating, that on&n; * every message byte an IRQ is generated and every byte has to&n; * be manually ACKed. Hmmm ?  (KG, 98/11/28) */
multiline_comment|/* The old implementation was correct. Sigh! */
multiline_comment|/* Check if the message is complete */
r_static
id|UCHAR
id|__inline__
DECL|function|dc390_MsgIn_complete
id|dc390_MsgIn_complete
(paren
id|UCHAR
op_star
id|msgbuf
comma
id|UINT
id|len
)paren
(brace
r_if
c_cond
(paren
op_star
id|msgbuf
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|msgbuf
(braket
l_int|1
)braket
op_plus
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|msgbuf
op_ge
l_int|0x20
op_logical_and
op_star
id|msgbuf
op_le
l_int|0x2f
)paren
singleline_comment|// two byte messages
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* read and eval received messages */
r_void
DECL|function|dc390_MsgIn_0
id|dc390_MsgIn_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|PDCB
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
multiline_comment|/* Read the msg */
id|pSRB-&gt;MsgInBuf
(braket
id|pACB-&gt;MsgLen
op_increment
)braket
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
singleline_comment|//pSRB-&gt;SRBState = 0;
multiline_comment|/* Msg complete ? */
r_if
c_cond
(paren
id|dc390_MsgIn_complete
(paren
id|pSRB-&gt;MsgInBuf
comma
id|pACB-&gt;MsgLen
)paren
)paren
(brace
id|DEBUG0
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: MsgIn:&quot;
)paren
suffix:semicolon
id|dc390_printMsg
(paren
id|pSRB-&gt;MsgInBuf
comma
id|pACB-&gt;MsgLen
)paren
suffix:semicolon
)paren
multiline_comment|/* Now eval the msg */
r_switch
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DISCONNECT
suffix:colon
id|pSRB-&gt;SRBState
op_assign
id|SRB_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
id|pSRB
op_assign
id|dc390_MsgIn_QTag
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RESET_ATN_CMD
)paren
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* 200ns &lt;=&gt; 5 MHz */
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|DO_SYNC_NEGO
)paren
(brace
id|dc390_MsgIn_set_async
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
multiline_comment|/* reject every extended msg but SDTR */
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
op_ne
l_int|3
op_logical_or
id|pSRB-&gt;MsgInBuf
(braket
l_int|2
)braket
op_ne
id|EXTENDED_SDTR
)paren
id|dc390_MsgIn_reject
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_eq
l_int|0
op_logical_or
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
op_eq
l_int|0
)paren
id|dc390_MsgIn_set_async
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_else
id|dc390_MsgIn_set_sync
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
suffix:semicolon
singleline_comment|// nothing has to be done
r_case
id|COMMAND_COMPLETE
suffix:colon
r_break
suffix:semicolon
singleline_comment|// SAVE POINTER may be ignored as we have the PSRB associated with the
singleline_comment|// scsi command. Thanks, Gerard, for pointing it out.
r_case
id|SAVE_POINTERS
suffix:colon
id|pSRB-&gt;Saved_Ptr
op_assign
id|pSRB-&gt;TotalXferredLen
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// The device might want to restart transfer with a RESTORE
r_case
id|RESTORE_POINTERS
suffix:colon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: RESTORE POINTER message received ... try to handle&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|dc390_restore_ptr
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// reject unknown messages
r_default
suffix:colon
id|dc390_MsgIn_reject
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear counter and MsgIn state */
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
)brace
suffix:semicolon
op_star
id|psstatus
op_assign
id|SCSI_NOP0
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|MSG_ACCEPTED_CMD
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_void
DECL|function|dc390_DataIO_Comm
id|dc390_DataIO_Comm
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|UCHAR
id|ioDir
)paren
(brace
id|PSGL
id|psgl
suffix:semicolon
id|ULONG
id|lval
suffix:semicolon
id|PDCB
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pACB-&gt;pTmpSRB
)paren
(brace
r_if
c_cond
(paren
id|pDCB
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: pSRB == pTmpSRB! (TagQ Error?) (%02i-%i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_else
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: pSRB == pTmpSRB! (TagQ Error?) (DCB 0!)&bslash;n&quot;
)paren
suffix:semicolon
id|dc390_EnableMsgOut_Abort
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
id|pDCB-&gt;DCBFlag
op_or_assign
id|ABORT_DEV
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
op_or
id|ioDir
multiline_comment|/* | DMA_INT */
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB-&gt;SGToBeXferLen
)paren
(brace
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|virt_to_bus
c_func
(paren
id|psgl-&gt;address
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
(paren
id|ULONG
)paren
id|psgl-&gt;length
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; DC390: Next SG segment.&quot;
)paren
suffix:semicolon
)paren
)brace
id|lval
op_assign
id|pSRB-&gt;SGToBeXferLen
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; DC390: Start transfer: %li bytes (address %08lx)&bslash;n&quot;
comma
id|lval
comma
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
)paren
id|DC390_write8
(paren
id|CtcReg_Low
comma
(paren
id|UCHAR
)paren
id|lval
)paren
suffix:semicolon
id|lval
op_rshift_assign
l_int|8
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_Mid
comma
(paren
id|UCHAR
)paren
id|lval
)paren
suffix:semicolon
id|lval
op_rshift_assign
l_int|8
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_High
comma
(paren
id|UCHAR
)paren
id|lval
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_XferCnt
comma
id|pSRB-&gt;SGToBeXferLen
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_XferAddr
comma
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD | ioDir); /* | DMA_INT; */
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|DMA_COMMAND
op_plus
id|INFO_XFER_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_START_CMD
op_or
id|ioDir
op_or
id|DMA_INT
)paren
suffix:semicolon
singleline_comment|//DEBUG1(DC390_write32 (DMA_ScsiBusCtrl, WRT_ERASE_DMA_STAT | EN_INT_ON_PCI_ABORT);)
singleline_comment|//DEBUG1(printk (KERN_DEBUG &quot;DC390: DMA_Status: %02x&bslash;n&quot;, DC390_read8 (DMA_Status));)
singleline_comment|//DEBUG1(DC390_write32 (DMA_ScsiBusCtrl, EN_INT_ON_PCI_ABORT);)
)brace
r_else
multiline_comment|/* xfer pad */
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
id|H_OVER_UNDER_RUN
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_or_assign
id|OVER_RUN
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot; DC390: Overrun -&quot;
)paren
suffix:semicolon
)paren
)brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot; Clear transfer pad &bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DC390_write8
(paren
id|CtcReg_Low
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_Mid
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_High
comma
l_int|0
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_XFERPAD
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|DMA_COMMAND
op_plus
id|XFER_PAD_BYTE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;DC390_write8 (DMA_Cmd, DMA_IDLE_CMD | ioDir); // | DMA_INT;&n;&t;DC390_write8 (DMA_Cmd, DMA_START_CMD | ioDir | DMA_INT);&n;*/
)brace
)brace
r_static
r_void
DECL|function|dc390_DataOutPhase
id|dc390_DataOutPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|dc390_DataIO_Comm
(paren
id|pACB
comma
id|pSRB
comma
id|WRITE_DIRECTION
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_DataInPhase
id|dc390_DataInPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|dc390_DataIO_Comm
(paren
id|pACB
comma
id|pSRB
comma
id|READ_DIRECTION
)paren
suffix:semicolon
)brace
r_void
DECL|function|dc390_CommandPhase
id|dc390_CommandPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|PDCB
id|pDCB
suffix:semicolon
id|UCHAR
id|i
comma
id|cnt
suffix:semicolon
id|PUCHAR
id|ptr
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RESET_ATN_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
id|cnt
op_assign
(paren
id|UCHAR
)paren
id|pSRB-&gt;pcmd-&gt;cmd_len
suffix:semicolon
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|pSRB-&gt;pcmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC390_write8
(paren
id|ScsiFifo
comma
op_star
(paren
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|UCHAR
id|bval
op_assign
l_int|0
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
r_sizeof
(paren
id|pSRB-&gt;pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;DC390: AutoReqSense (CmndPhase)!&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_COMMAND
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_StatusPhase
id|dc390_StatusPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_STATUS
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INITIATOR_CMD_CMPLTE
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_void
DECL|function|dc390_MsgOutPhase
id|dc390_MsgOutPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|UCHAR
id|bval
comma
id|i
comma
id|cnt
suffix:semicolon
id|PUCHAR
id|ptr
suffix:semicolon
id|PDCB
id|pDCB
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_MSGOUT
)paren
)paren
(brace
id|cnt
op_assign
id|pSRB-&gt;MsgCnt
suffix:semicolon
r_if
c_cond
(paren
id|cnt
)paren
(brace
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|pSRB-&gt;MsgOutBuf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC390_write8
(paren
id|ScsiFifo
comma
op_star
(paren
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
op_logical_and
(paren
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_eq
id|ABORT
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
)brace
)brace
r_else
(brace
id|bval
op_assign
id|ABORT
suffix:semicolon
multiline_comment|/* ??? MSG_NOP */
r_if
c_cond
(paren
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_or
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_or
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_ENABLE
)paren
(brace
r_goto
id|mop1
suffix:semicolon
)brace
)brace
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|mop1
suffix:colon
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: OLD Sync Nego code triggered! (%i %i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|EXTENDED_MESSAGE
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/*    ;length of extended msg */
id|DC390_write8
(paren
id|ScsiFifo
comma
id|EXTENDED_SDTR
)paren
suffix:semicolon
multiline_comment|/*    ; sync nego */
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;NegoPeriod
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
r_else
id|DC390_write8
(paren
id|ScsiFifo
comma
id|SYNC_NEGO_OFFSET
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|DO_SYNC_NEGO
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dc390_MsgInPhase
id|dc390_MsgInPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_MSGIN
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DISCONNECT
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGIN
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_static
r_void
DECL|function|dc390_Nop_0
id|dc390_Nop_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
)brace
r_static
r_void
DECL|function|dc390_Nop_1
id|dc390_Nop_1
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
(brace
)brace
r_static
r_void
DECL|function|dc390_SetXferRate
id|dc390_SetXferRate
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
id|UCHAR
id|bval
comma
id|i
comma
id|cnt
suffix:semicolon
id|PDCB
id|ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;TargetLUN
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;scan_devices
)paren
(brace
id|ptr
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|cnt
op_assign
id|pACB-&gt;DCBCnt
suffix:semicolon
id|bval
op_assign
id|pDCB-&gt;TargetID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ptr-&gt;TargetID
op_eq
id|bval
)paren
(brace
id|ptr-&gt;SyncPeriod
op_assign
id|pDCB-&gt;SyncPeriod
suffix:semicolon
id|ptr-&gt;SyncOffset
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
id|ptr-&gt;CtrlR3
op_assign
id|pDCB-&gt;CtrlR3
suffix:semicolon
id|ptr-&gt;CtrlR4
op_assign
id|pDCB-&gt;CtrlR4
suffix:semicolon
id|ptr-&gt;SyncMode
op_assign
id|pDCB-&gt;SyncMode
suffix:semicolon
)brace
id|ptr
op_assign
id|ptr-&gt;pNextDCB
suffix:semicolon
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
r_void
DECL|function|dc390_Disconnect
id|dc390_Disconnect
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|pDCB
suffix:semicolon
id|PSRB
id|pSRB
comma
id|psrb
suffix:semicolon
id|UCHAR
id|i
comma
id|cnt
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DISC,&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;Connected
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: Disconnect not-connected bus?&bslash;n&quot;
)paren
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|0
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
r_int
id|j
op_assign
l_int|400
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACB:%p-&gt;ActiveDCB:%p IOPort:%04x IRQ:%02x !&bslash;n&quot;
comma
"&bslash;"
id|pACB
comma
id|pDCB
comma
id|pACB-&gt;IOPortBase
comma
id|pACB-&gt;IRQLevel
)paren
suffix:semicolon
)paren
r_while
c_loop
(paren
op_decrement
id|j
)paren
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
id|DC390_read8
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|EN_SEL_RESEL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|EN_SEL_RESEL
)paren
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP0
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_UNEXPECT_RESEL
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_ABORT_SENT
)paren
(brace
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_assign
l_int|0
suffix:semicolon
id|cnt
op_assign
id|pDCB-&gt;GoingSRBCnt
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psrb
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pSRB
op_assign
id|psrb
suffix:semicolon
)brace
id|pDCB-&gt;pGoingSRB
op_assign
l_int|0
suffix:semicolon
id|dc390_Query_to_Waiting
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_START_
op_plus
id|SRB_MSGOUT
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_DISCONNECT
op_plus
id|SRB_COMPLETED
)paren
)paren
)paren
(brace
multiline_comment|/* Selection time out */
r_if
c_cond
(paren
op_logical_neg
(paren
l_int|1
multiline_comment|/*pACB-&gt;scan_devices*/
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Going_to_Waiting
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;TargetStatus
op_assign
id|SCSI_STAT_SEL_TIMEOUT
suffix:semicolon
r_goto
id|disc1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
(brace
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_COMPLETED
)paren
(brace
id|disc1
suffix:colon
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_FREE
suffix:semicolon
id|dc390_SRBdone
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
)brace
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|dc390_Reselect
id|dc390_Reselect
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|pDCB
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|UCHAR
id|id
comma
id|lun
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;RSEL,&quot;
)paren
suffix:semicolon
)paren
id|pACB-&gt;Connected
op_assign
l_int|1
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
multiline_comment|/* Arbitration lost but Reselection won */
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: (ActiveDCB != 0: Arb. lost but resel. won)!&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;scan_devices
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Going_to_Waiting
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Get ID */
id|lun
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;Dev %02x,&quot;
comma
id|lun
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|lun
op_amp
(paren
l_int|1
op_lshift
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
)paren
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Reselection must select host adapter: %02x!&bslash;n&quot;
comma
id|lun
)paren
suffix:semicolon
r_else
id|lun
op_xor_assign
l_int|1
op_lshift
id|pACB-&gt;pScsiHost-&gt;this_id
suffix:semicolon
multiline_comment|/* Mask AdapterID */
id|id
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|lun
op_rshift_assign
l_int|1
)paren
id|id
op_increment
suffix:semicolon
multiline_comment|/* Get LUN */
id|lun
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lun
op_amp
id|IDENTIFY_BASE
)paren
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Resel: Expect identify message!&bslash;n&quot;
)paren
suffix:semicolon
id|lun
op_and_assign
l_int|7
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;(%02i-%i),&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
)paren
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Reselect from non existing device (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pACB-&gt;pActiveDCB
op_assign
id|pDCB
suffix:semicolon
multiline_comment|/* TagQ: We expect a message soon, so never mind the exact SRB */
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
(brace
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
(brace
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_or
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
)paren
(brace
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Reselect without outstanding cmnd (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|dc390_EnableMsgOut_Abort
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Reselect: Abort (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|dc390_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
)brace
)brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Resel SRB(%p): TagNum (%02x)&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;TagNumber
)paren
suffix:semicolon
)paren
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP0
suffix:semicolon
id|DC390_write8
(paren
id|Scsi_Dest_ID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Period
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Offset
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|pDCB-&gt;CtrlR1
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg3
comma
id|pDCB-&gt;CtrlR3
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pDCB-&gt;CtrlR4
)paren
suffix:semicolon
multiline_comment|/* ; Glitch eater */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|MSG_ACCEPTED_CMD
)paren
suffix:semicolon
multiline_comment|/* ;to release the /ACK signal */
)brace
r_static
r_void
DECL|function|dc390_remove_dev
id|dc390_remove_dev
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
id|PDCB
id|pPrevDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;GoingSRBCnt
OG
l_int|1
)paren
(brace
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Driver won&squot;t free DCB (ID %i, LUN %i): 0x%08x because of SRBCnt %i&bslash;n&quot;
comma
"&bslash;"
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
(paren
r_int
)paren
id|pDCB
comma
id|pDCB-&gt;GoingSRBCnt
)paren
suffix:semicolon
)paren
r_return
suffix:semicolon
)brace
suffix:semicolon
id|pACB-&gt;DCBmap
(braket
id|pDCB-&gt;TargetID
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
singleline_comment|// The first one
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
(brace
singleline_comment|// The last one
r_if
c_cond
(paren
id|pACB-&gt;pLastDCB
op_eq
id|pDCB
)paren
(brace
id|pDCB-&gt;pNextDCB
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
l_int|0
suffix:semicolon
)brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pPrevDCB-&gt;pNextDCB
op_ne
id|pDCB
)paren
id|pPrevDCB
op_assign
id|pPrevDCB-&gt;pNextDCB
suffix:semicolon
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLastDCB
)paren
id|pACB-&gt;pLastDCB
op_assign
id|pPrevDCB
suffix:semicolon
)brace
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Driver about to free DCB (ID %i, LUN %i): %p&bslash;n&quot;
comma
"&bslash;"
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pActiveDCB
)paren
id|pACB-&gt;pActiveDCB
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pDCBRunRobin
)paren
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|kfree
(paren
id|pDCB
)paren
suffix:semicolon
id|pACB-&gt;DCBCnt
op_decrement
suffix:semicolon
multiline_comment|/* pACB-&gt;DeviceCnt--; */
)brace
suffix:semicolon
r_static
id|UCHAR
id|__inline__
DECL|function|dc390_tagq_blacklist
id|dc390_tagq_blacklist
(paren
r_char
op_star
id|name
)paren
(brace
id|UCHAR
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BADDEVCNT
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|memcmp
(paren
id|name
comma
id|dc390_baddevname1
(braket
id|i
)braket
comma
l_int|28
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
DECL|function|dc390_disc_tagq_set
id|dc390_disc_tagq_set
(paren
id|PDCB
id|pDCB
comma
id|PSCSI_INQDATA
id|ptr
)paren
(brace
multiline_comment|/* Check for SCSI format (ANSI and Response data format) */
r_if
c_cond
(paren
(paren
id|ptr-&gt;Vers
op_amp
l_int|0x07
)paren
op_ge
l_int|2
op_logical_or
(paren
id|ptr-&gt;RDF
op_amp
l_int|0x0F
)paren
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;Flags
op_amp
id|SCSI_INQ_CMDQUEUE
)paren
op_logical_and
(paren
id|pDCB-&gt;DevMode
op_amp
id|TAG_QUEUEING_
)paren
op_logical_and
multiline_comment|/* ((pDCB-&gt;DevType == TYPE_DISK) &n;&t;&t;|| (pDCB-&gt;DevType == TYPE_MOD)) &amp;&amp;*/
op_logical_neg
id|dc390_tagq_blacklist
(paren
(paren
(paren
r_char
op_star
)paren
id|ptr
)paren
op_plus
l_int|8
)paren
)paren
(brace
r_if
c_cond
(paren
id|pDCB-&gt;MaxCommand
op_eq
l_int|1
)paren
id|pDCB-&gt;MaxCommand
op_assign
id|pDCB-&gt;pDCBACB-&gt;TagMaxNum
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|EN_TAG_QUEUEING
multiline_comment|/* | EN_ATN_STOP */
suffix:semicolon
singleline_comment|//pDCB-&gt;TagMask = 0;
)brace
r_else
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
)brace
)brace
suffix:semicolon
r_static
r_void
DECL|function|dc390_add_dev
id|dc390_add_dev
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSCSI_INQDATA
id|ptr
)paren
(brace
id|UCHAR
id|bval1
op_assign
id|ptr-&gt;DevType
op_amp
id|SCSI_DEVTYPE
suffix:semicolon
id|pDCB-&gt;DevType
op_assign
id|bval1
suffix:semicolon
multiline_comment|/* if (bval1 == TYPE_DISK || bval1 == TYPE_MOD) */
id|dc390_disc_tagq_set
(paren
id|pDCB
comma
id|ptr
)paren
suffix:semicolon
)brace
suffix:semicolon
r_void
DECL|function|dc390_SRBdone
id|dc390_SRBdone
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|UCHAR
id|bval
comma
id|status
comma
id|i
comma
id|DCB_removed
suffix:semicolon
id|PSCSICMD
id|pcmd
suffix:semicolon
id|PSCSI_INQDATA
id|ptr
suffix:semicolon
id|PSGL
id|ptr2
suffix:semicolon
id|ULONG
id|swlval
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|DCB_removed
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|pSRB-&gt;TargetStatus
suffix:semicolon
id|ptr
op_assign
(paren
id|PSCSI_INQDATA
)paren
(paren
id|pcmd-&gt;request_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|ptr
op_assign
(paren
id|PSCSI_INQDATA
)paren
(paren
(paren
(paren
id|PSGL
)paren
id|ptr
)paren
op_member_access_from_pointer
id|address
)paren
suffix:semicolon
)brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot; SRBdone (%02x,%08x), SRB %p, pid %li&bslash;n&quot;
comma
id|status
comma
id|pcmd-&gt;result
comma
"&bslash;"
id|pSRB
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
multiline_comment|/* Last command was a Request Sense */
id|pSRB-&gt;SRBFlag
op_and_assign
op_complement
id|AUTO_REQSENSE
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|CHECK_CONDITION
op_lshift
l_int|1
suffix:semicolon
macro_line|#ifdef DC390_REMOVABLEDEBUG
r_switch
c_cond
(paren
id|pcmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
(brace
r_case
id|NOT_READY
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: ReqSense: NOT_READY (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i)&bslash;n&quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UNIT_ATTENTION
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: ReqSense: UNIT_ATTENTION (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i)&bslash;n&quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ILLEGAL_REQUEST
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: ReqSense: ILLEGAL_REQUEST (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i)&bslash;n&quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEDIUM_ERROR
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: ReqSense: MEDIUM_ERROR (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i)&bslash;n&quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARDWARE_ERROR
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: ReqSense: HARDWARE_ERROR (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i)&bslash;n&quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
singleline_comment|//pcmd-&gt;result = MK_RES(DRIVER_SENSE,DID_OK,0,status);
r_if
c_cond
(paren
id|status
op_eq
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
)paren
(brace
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
l_int|0
comma
id|DID_BAD_TARGET
comma
l_int|0
comma
multiline_comment|/*CHECK_CONDITION*/
l_int|0
)paren
suffix:semicolon
r_goto
id|ckc_e
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSRB-&gt;RetryCnt
op_eq
l_int|0
)paren
(brace
singleline_comment|//(UINT)(pSRB-&gt;pcmd-&gt;cmnd[0]) = pSRB-&gt;Segment0[0];
id|pSRB-&gt;TotalXferredLen
op_assign
id|pSRB-&gt;SavedTotXLen
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSRB-&gt;TotalXferredLen
)paren
op_logical_and
(paren
id|pSRB-&gt;TotalXferredLen
op_ge
id|pcmd-&gt;underflow
)paren
)paren
(brace
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
r_else
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
l_int|0
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
)brace
id|REMOVABLEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cmd=%02x,Result=%08x,XferL=%08x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
"&bslash;"
(paren
id|UINT
)paren
id|pcmd-&gt;result
comma
(paren
id|UINT
)paren
id|pSRB-&gt;TotalXferredLen
)paren
suffix:semicolon
)paren
r_goto
id|ckc_e
suffix:semicolon
)brace
r_else
multiline_comment|/* Retry */
(brace
id|pSRB-&gt;RetryCnt
op_decrement
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
singleline_comment|//*((PUINT) &amp;(pSRB-&gt;CmdBlock[0])) = pSRB-&gt;Segment0[0];
singleline_comment|//*((PUINT) &amp;(pSRB-&gt;CmdBlock[4])) = pSRB-&gt;Segment0[1];
multiline_comment|/* Don&squot;t retry on TEST_UNIT_READY */
r_if
c_cond
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
multiline_comment|/* || pSRB-&gt;pcmd-&gt;cmnd[0] == START_STOP */
)paren
(brace
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
l_int|0
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
id|REMOVABLEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cmd=%02x, Result=%08x, XferL=%08x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
"&bslash;"
(paren
id|UINT
)paren
id|pcmd-&gt;result
comma
(paren
id|UINT
)paren
id|pSRB-&gt;TotalXferredLen
)paren
suffix:semicolon
)paren
r_goto
id|ckc_e
suffix:semicolon
)brace
id|SET_RES_DRV
c_func
(paren
id|pcmd-&gt;result
comma
id|DRIVER_SENSE
)paren
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
(paren
id|UCHAR
)paren
id|pSRB-&gt;SavedSGCount
suffix:semicolon
singleline_comment|//pSRB-&gt;ScsiCmdLen&t; = (UCHAR) (pSRB-&gt;Segment1[0] &gt;&gt; 8);
id|DEBUG0
(paren
id|printk
(paren
l_string|&quot;DC390: RETRY pid %li (%02x), target %02i-%02i&bslash;n&quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pcmd-&gt;target
comma
id|pcmd-&gt;lun
)paren
suffix:semicolon
)paren
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
(brace
id|dc390_Going_to_Waiting
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|CHECK_CONDITION
)paren
(brace
id|REMOVABLEDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Check_Condition (Cmd %02x, Id %02x, LUN %02x)&bslash;n&quot;
comma
"&bslash;"
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
op_logical_and
(paren
id|pSRB-&gt;SGcount
)paren
op_logical_and
(paren
id|pSRB-&gt;SGToBeXferLen
)paren
)paren
(brace
id|bval
op_assign
id|pSRB-&gt;SGcount
suffix:semicolon
id|swlval
op_assign
l_int|0
suffix:semicolon
id|ptr2
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|pSRB-&gt;SGIndex
suffix:semicolon
id|i
OL
id|bval
suffix:semicolon
id|i
op_increment
)paren
(brace
id|swlval
op_add_assign
id|ptr2-&gt;length
suffix:semicolon
id|ptr2
op_increment
suffix:semicolon
)brace
id|REMOVABLEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;XferredLen=%08x,NotXferLen=%08x&bslash;n&quot;
comma
"&bslash;"
(paren
id|UINT
)paren
id|pSRB-&gt;TotalXferredLen
comma
(paren
id|UINT
)paren
id|swlval
)paren
suffix:semicolon
)paren
)brace
id|dc390_RequestSense
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|QUEUE_FULL
)paren
(brace
id|bval
op_assign
(paren
id|UCHAR
)paren
id|pDCB-&gt;GoingSRBCnt
suffix:semicolon
id|bval
op_decrement
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
id|bval
suffix:semicolon
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Going_to_Waiting
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
id|SCSI_STAT_SEL_TIMEOUT
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
id|H_SEL_TIMEOUT
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|DID_NO_CONNECT
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Devices are removed below ... */
)brace
r_else
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|BUSY
op_logical_and
(paren
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
op_logical_or
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
id|pACB-&gt;scan_devices
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|status
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
l_int|0
comma
id|pSRB-&gt;EndMessage
comma
multiline_comment|/*status*/
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Another error */
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;RetryCnt
)paren
(brace
multiline_comment|/* Retry */
singleline_comment|//printk (&quot;DC390: retry&bslash;n&quot;);
id|pSRB-&gt;RetryCnt
op_decrement
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
(brace
id|dc390_Going_to_Waiting
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Report error */
singleline_comment|//pcmd-&gt;result = MK_RES(0, DID_ERROR, pSRB-&gt;EndMessage, status);
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
id|SET_RES_TARGET
c_func
(paren
id|pcmd-&gt;result
comma
id|status
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/*  Target status == 0 */
id|status
op_assign
id|pSRB-&gt;AdaptStatus
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|H_OVER_UNDER_RUN
)paren
(brace
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBStatus
op_amp
id|PARITY_ERROR
)paren
(brace
singleline_comment|//pcmd-&gt;result = MK_RES(0,DID_PARITY,pSRB-&gt;EndMessage,0);
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_PARITY
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* No error */
(brace
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|pcmd-&gt;result
op_amp
id|RES_DID
)paren
op_eq
l_int|0
op_logical_and
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
id|pcmd-&gt;cmnd
(braket
l_int|2
)braket
op_eq
l_int|0
op_logical_and
id|pcmd-&gt;request_bufflen
op_ge
l_int|8
op_logical_and
id|ptr
op_logical_and
(paren
id|ptr-&gt;Vers
op_amp
l_int|0x07
)paren
op_ge
l_int|2
)paren
id|pDCB-&gt;Inquiry7
op_assign
id|ptr-&gt;Flags
suffix:semicolon
id|ckc_e
suffix:colon
r_if
c_cond
(paren
id|pACB-&gt;scan_devices
)paren
(brace
r_if
c_cond
(paren
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
op_logical_or
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
(brace
macro_line|#ifdef DC390_DEBUG0
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: %s: result: %08x&quot;
comma
(paren
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
ques
c_cond
l_string|&quot;INQUIRY&quot;
suffix:colon
l_string|&quot;TEST_UNIT_READY&quot;
)paren
comma
id|pcmd-&gt;result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;result
op_amp
(paren
id|DRIVER_SENSE
op_lshift
l_int|24
)paren
)paren
id|printk
(paren
l_string|&quot; (sense: %02x %02x %02x %02x)&bslash;n&quot;
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|0
)braket
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|1
)braket
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|2
)braket
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|host_byte
c_func
(paren
id|pcmd-&gt;result
)paren
op_ne
id|DID_OK
op_logical_and
op_logical_neg
(paren
id|status_byte
c_func
(paren
id|pcmd-&gt;result
)paren
op_amp
id|CHECK_CONDITION
)paren
op_logical_and
op_logical_neg
(paren
id|status_byte
c_func
(paren
id|pcmd-&gt;result
)paren
op_amp
id|BUSY
)paren
)paren
op_logical_or
(paren
(paren
id|driver_byte
c_func
(paren
id|pcmd-&gt;result
)paren
op_amp
id|DRIVER_SENSE
)paren
op_logical_and
(paren
id|pcmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|pcmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
op_eq
id|ILLEGAL_REQUEST
)paren
op_logical_or
id|host_byte
c_func
(paren
id|pcmd-&gt;result
)paren
op_amp
id|DID_ERROR
)paren
(brace
multiline_comment|/* device not present: remove */
singleline_comment|//dc390_Going_remove (pDCB, pSRB);
id|dc390_remove_dev
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|DCB_removed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pcmd-&gt;target
op_eq
id|pACB-&gt;pScsiHost-&gt;max_id
op_minus
l_int|1
)paren
op_logical_and
(paren
(paren
id|pcmd-&gt;lun
op_eq
l_int|0
)paren
op_logical_or
(paren
id|pcmd-&gt;lun
op_eq
id|pACB-&gt;pScsiHost-&gt;max_lun
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* device present: add */
r_if
c_cond
(paren
(paren
id|pcmd-&gt;target
op_eq
id|pACB-&gt;pScsiHost-&gt;max_id
op_minus
l_int|1
)paren
op_logical_and
(paren
id|pcmd-&gt;lun
op_eq
id|pACB-&gt;pScsiHost-&gt;max_lun
op_minus
l_int|1
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
id|END_SCAN
suffix:semicolon
)brace
multiline_comment|/* pACB-&gt;DeviceCnt++; */
multiline_comment|/* Dev is added on INQUIRY */
)brace
)brace
)brace
singleline_comment|//if( pSRB-&gt;pcmd-&gt;cmnd[0] == INQUIRY &amp;&amp; 
singleline_comment|//  (host_byte(pcmd-&gt;result) == DID_OK || status_byte(pcmd-&gt;result) &amp; CHECK_CONDITION) )
r_if
c_cond
(paren
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
(paren
id|pcmd-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_logical_or
id|status_byte
c_func
(paren
id|pcmd-&gt;result
)paren
op_amp
id|CHECK_CONDITION
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;DevType
op_amp
id|SCSI_DEVTYPE
)paren
op_eq
id|TYPE_NODEV
op_logical_and
op_logical_neg
id|DCB_removed
)paren
(brace
singleline_comment|//printk (&quot;DC390: Type = nodev! (%02i-%i)&bslash;n&quot;, pcmd-&gt;target, pcmd-&gt;lun);
multiline_comment|/* device not present: remove */
singleline_comment|//dc390_Going_remove (pDCB, pSRB);
id|dc390_remove_dev
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|DCB_removed
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* device found: add */
id|dc390_add_dev
(paren
id|pACB
comma
id|pDCB
comma
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;scan_devices
)paren
id|pACB-&gt;DeviceCnt
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pcmd-&gt;target
op_eq
id|pACB-&gt;pScsiHost-&gt;max_id
op_minus
l_int|1
)paren
op_logical_and
(paren
id|pcmd-&gt;lun
op_eq
id|pACB-&gt;pScsiHost-&gt;max_lun
op_minus
l_int|1
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
)brace
)brace
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,30)
id|pcmd-&gt;resid
op_assign
id|pcmd-&gt;request_bufflen
op_minus
id|pSRB-&gt;TotalXferredLen
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|DCB_removed
)paren
id|dc390_Going_remove
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Add to free list */
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: SRBdone: done pid %li&bslash;n&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|DC390_UNLOCK_ACB_NI
suffix:semicolon
id|pcmd-&gt;scsi_done
(paren
id|pcmd
)paren
suffix:semicolon
id|DC390_LOCK_ACB_NI
suffix:semicolon
id|dc390_Query_to_Waiting
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Remove all SRBs from Going list and inform midlevel */
r_void
DECL|function|dc390_DoingSRB_Done
id|dc390_DoingSRB_Done
c_func
(paren
id|PACB
id|pACB
comma
id|PSCSICMD
id|cmd
)paren
(brace
id|PDCB
id|pDCB
comma
id|pdcb
suffix:semicolon
id|PSRB
id|psrb
comma
id|psrb2
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|PSCSICMD
id|pcmd
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdcb
)paren
r_return
suffix:semicolon
r_do
(brace
id|psrb
op_assign
id|pdcb-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pdcb-&gt;GoingSRBCnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psrb2
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
id|pcmd
op_assign
id|psrb-&gt;pcmd
suffix:semicolon
id|dc390_Free_insert
(paren
id|pACB
comma
id|psrb
)paren
suffix:semicolon
macro_line|#ifndef USE_NEW_EH
multiline_comment|/* New EH will crash on being given timed out cmnds */
r_if
c_cond
(paren
id|pcmd
op_eq
id|cmd
)paren
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|DID_ABORT
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|DID_RESET
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&t;    ReleaseSRB( pDCB, pSRB ); */
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: DoingSRB_Done: done pid %li&bslash;n&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|DC390_UNLOCK_ACB_NI
suffix:semicolon
id|pcmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|pcmd
)paren
suffix:semicolon
id|DC390_LOCK_ACB_NI
suffix:semicolon
macro_line|#endif&t;
id|psrb
op_assign
id|psrb2
suffix:semicolon
)brace
id|pdcb-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|pdcb-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pdcb-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pdcb
op_assign
id|pdcb-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
id|dc390_Query_to_Waiting
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_ResetSCSIBus
id|dc390_ResetSCSIBus
c_func
(paren
id|PACB
id|pACB
)paren
(brace
singleline_comment|//DC390_write8 (ScsiCmd, RST_DEVICE_CMD);
singleline_comment|//udelay (250);
singleline_comment|//DC390_write8 (ScsiCmd, NOP_CMD);
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RST_SCSI_BUS_CMD
)paren
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_ScsiRstDetect
id|dc390_ScsiRstDetect
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Rst_Detect: laststat = %08x&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
singleline_comment|//DEBUG0(printk(KERN_INFO &quot;RST_DETECT,&quot;);)
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* Unlock before ? */
multiline_comment|/* delay half a second */
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;ACBFlag
op_amp
id|RESET_DEV
)paren
(brace
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DONE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset was issued by sb else */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DETECT
suffix:semicolon
id|dc390_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_DoingSRB_Done
c_func
(paren
id|pACB
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//dc390_RecoverSRB( pACB );
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|dc390_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_void
id|__inline__
DECL|function|dc390_RequestSense
id|dc390_RequestSense
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|PSCSICMD
id|pcmd
suffix:semicolon
id|REMOVABLEDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: RequestSense (Cmd %02x, Id %02x, LUN %02x)&bslash;n&quot;
comma
"&bslash;"
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
)paren
id|pSRB-&gt;SRBFlag
op_or_assign
id|AUTO_REQSENSE
suffix:semicolon
singleline_comment|//pSRB-&gt;Segment0[0] = (UINT) pSRB-&gt;CmdBlock[0];
singleline_comment|//pSRB-&gt;Segment0[1] = (UINT) pSRB-&gt;CmdBlock[4];
singleline_comment|//pSRB-&gt;Segment1[0] = ((UINT)(pSRB-&gt;pcmd-&gt;cmd_len) &lt;&lt; 8) + pSRB-&gt;SGcount;
singleline_comment|//pSRB-&gt;Segment1[1] = pSRB-&gt;TotalXferredLen;
id|pSRB-&gt;SavedSGCount
op_assign
id|pSRB-&gt;SGcount
suffix:semicolon
id|pSRB-&gt;SavedTotXLen
op_assign
id|pSRB-&gt;TotalXferredLen
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CHECK_CONDITION&lt;&lt;1; */
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
op_amp
(paren
id|pcmd-&gt;sense_buffer
)paren
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
singleline_comment|//pSRB-&gt;CmdBlock[0] = REQUEST_SENSE;
singleline_comment|//pSRB-&gt;CmdBlock[1] = pDCB-&gt;TargetLUN &lt;&lt; 5;
singleline_comment|//(USHORT) pSRB-&gt;CmdBlock[2] = 0;
singleline_comment|//(USHORT) pSRB-&gt;CmdBlock[4] = sizeof(pcmd-&gt;sense_buffer);
singleline_comment|//pSRB-&gt;ScsiCmdLen = 6;
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
(brace
id|dc390_Going_to_Waiting
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__inline__
DECL|function|dc390_InvalidCmd
id|dc390_InvalidCmd
c_func
(paren
id|PACB
id|pACB
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB-&gt;SRBState
op_amp
(paren
id|SRB_START_
op_plus
id|SRB_MSGOUT
)paren
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
)brace
)brace
eof
