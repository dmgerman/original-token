multiline_comment|/* fastlane.c: Driver for Phase5&squot;s Fastlane SCSI Controller.&n; *&n; * Copyright (C) 1996 Jesper Skov (jskov@cygnus.co.uk)&n; *&n; * This driver is based on the CyberStorm driver, hence the occasional&n; * reference to CyberStorm.&n; *&n; * Betatesting &amp; crucial adjustments by Patrik Rak &n; * (prak3264@ss1000.ms.mff.cuni.cz)&n; *&n; */
multiline_comment|/* TODO:&n; *&n; * o According to the doc from laire, it is required to reset the DMA when&n; *   the transfer is done. ATM we reset DMA just before every new &n; *   dma_init_(read|write).&n; *&n; * 1) Figure out how to make a cleaner merge with the sparc driver with regard&n; *    to the caches and the Sparc MMU mapping.&n; * 2) Make as few routines required outside the generic driver. A lot of the&n; *    routines in this file used to be inline!&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;NCR53C9x.h&quot;
macro_line|#include &quot;fastlane.h&quot;
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
multiline_comment|/* Let this defined unless you really need to enable DMA IRQ one day */
DECL|macro|NODMAIRQ
mdefine_line|#define NODMAIRQ
r_static
r_int
id|dma_bytes_sent
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
r_int
id|fifo_count
)paren
suffix:semicolon
r_static
r_int
id|dma_can_transfer
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|Scsi_Cmnd
op_star
id|sp
)paren
suffix:semicolon
r_static
r_inline
r_void
id|dma_clear
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_void
id|dma_dump_state
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_void
id|dma_init_read
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|__u32
id|addr
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_void
id|dma_init_write
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|__u32
id|vaddr
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_void
id|dma_ints_off
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_void
id|dma_ints_on
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_int
id|dma_irq_p
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_void
id|dma_led_off
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_void
id|dma_led_on
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_int
id|dma_ports_p
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
suffix:semicolon
r_static
r_void
id|dma_setup
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|__u32
id|addr
comma
r_int
id|count
comma
r_int
id|write
)paren
suffix:semicolon
DECL|variable|ctrl_data
r_static
r_int
r_char
id|ctrl_data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Keep backup of the stuff written&n;&t;&t;&t;&t; * to ctrl_reg. Always write a copy&n;&t;&t;&t;&t; * to this register when writing to&n;&t;&t;&t;&t; * the hardware register!&n;&t;&t;&t;&t; */
DECL|variable|cmd_buffer
r_volatile
r_int
r_char
id|cmd_buffer
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* This is where all commands are put&n;&t;&t;&t;&t; * before they are trasfered to the ESP chip&n;&t;&t;&t;&t; * via PIO.&n;&t;&t;&t;&t; */
multiline_comment|/***************************************************************** Detection */
DECL|function|fastlane_esp_detect
r_int
id|fastlane_esp_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|NCR_ESP
op_star
id|esp
suffix:semicolon
r_const
r_struct
id|ConfigDev
op_star
id|esp_dev
suffix:semicolon
r_int
r_int
id|key
suffix:semicolon
r_int
r_int
id|address
suffix:semicolon
r_if
c_cond
(paren
(paren
id|key
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_PHASE5_BLIZZARD_1230_II_FASTLANE_Z3_CYBERSCSI_CYBERSTORM060
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|esp_dev
op_assign
id|zorro_get_board
c_func
(paren
id|key
)paren
suffix:semicolon
multiline_comment|/* Check if this is really a fastlane controller. The problem&n;&t;&t; * is that also the cyberstorm and blizzard controllers use&n;&t;&t; * this ID value. Fortunately only Fastlane maps in Z3 space&n;&t;&t; */
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|esp_dev-&gt;cd_BoardAddr
OL
l_int|0x1000000
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|esp
op_assign
id|esp_allocate
c_func
(paren
id|tpnt
comma
(paren
r_void
op_star
)paren
id|esp_dev
)paren
suffix:semicolon
multiline_comment|/* Do command transfer with programmed I/O */
id|esp-&gt;do_pio_cmds
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Required functions */
id|esp-&gt;dma_bytes_sent
op_assign
op_amp
id|dma_bytes_sent
suffix:semicolon
id|esp-&gt;dma_can_transfer
op_assign
op_amp
id|dma_can_transfer
suffix:semicolon
id|esp-&gt;dma_dump_state
op_assign
op_amp
id|dma_dump_state
suffix:semicolon
id|esp-&gt;dma_init_read
op_assign
op_amp
id|dma_init_read
suffix:semicolon
id|esp-&gt;dma_init_write
op_assign
op_amp
id|dma_init_write
suffix:semicolon
id|esp-&gt;dma_ints_off
op_assign
op_amp
id|dma_ints_off
suffix:semicolon
id|esp-&gt;dma_ints_on
op_assign
op_amp
id|dma_ints_on
suffix:semicolon
id|esp-&gt;dma_irq_p
op_assign
op_amp
id|dma_irq_p
suffix:semicolon
id|esp-&gt;dma_ports_p
op_assign
op_amp
id|dma_ports_p
suffix:semicolon
id|esp-&gt;dma_setup
op_assign
op_amp
id|dma_setup
suffix:semicolon
multiline_comment|/* Optional functions */
id|esp-&gt;dma_barrier
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;dma_drain
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;dma_invalidate
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;dma_irq_entry
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;dma_irq_exit
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;dma_led_on
op_assign
op_amp
id|dma_led_on
suffix:semicolon
id|esp-&gt;dma_led_off
op_assign
op_amp
id|dma_led_off
suffix:semicolon
id|esp-&gt;dma_poll
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;dma_reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the portBits (enable IRQs) */
id|ctrl_data
op_assign
(paren
id|FASTLANE_DMA_FCODE
op_or
macro_line|#ifndef NODMAIRQ
id|FASTLANE_DMA_EDI
op_or
macro_line|#endif
id|FASTLANE_DMA_ESI
)paren
suffix:semicolon
multiline_comment|/* SCSI chip clock */
id|esp-&gt;cfreq
op_assign
l_int|40000000
suffix:semicolon
multiline_comment|/* Map the physical address space into virtual kernel space */
id|address
op_assign
(paren
r_int
r_int
)paren
id|kernel_map
c_func
(paren
(paren
r_int
r_int
)paren
id|esp_dev-&gt;cd_BoardAddr
comma
id|esp_dev-&gt;cd_BoardSize
comma
id|KERNELMAP_NOCACHE_SER
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|address
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Could not remap Fastlane controller memory!&quot;
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|esp-&gt;ehost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The DMA registers on the Fastlane are mapped&n;&t;&t; * relative to the device (i.e. in the same Zorro&n;&t;&t; * I/O block).&n;&t;&t; */
id|esp-&gt;dregs
op_assign
(paren
r_void
op_star
)paren
(paren
id|address
op_plus
id|FASTLANE_DMA_ADDR
)paren
suffix:semicolon
multiline_comment|/* ESP register base */
id|esp-&gt;eregs
op_assign
(paren
r_struct
id|ESP_regs
op_star
)paren
(paren
id|address
op_plus
id|FASTLANE_ESP_ADDR
)paren
suffix:semicolon
multiline_comment|/* Board base */
id|esp-&gt;edev
op_assign
(paren
r_void
op_star
)paren
id|address
suffix:semicolon
multiline_comment|/* Set the command buffer */
id|esp-&gt;esp_command_dvma
op_assign
id|VTOP
c_func
(paren
(paren
r_int
r_int
)paren
id|cmd_buffer
)paren
suffix:semicolon
id|esp-&gt;irq
op_assign
id|IRQ_AMIGA_PORTS
suffix:semicolon
id|request_irq
c_func
(paren
id|IRQ_AMIGA_PORTS
comma
id|esp_intr
comma
l_int|0
comma
l_string|&quot;Fastlane SCSI&quot;
comma
id|esp_intr
)paren
suffix:semicolon
multiline_comment|/* Controller ID */
id|esp-&gt;scsi_id
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* Check for differential SCSI-bus */
multiline_comment|/* What is this stuff? */
id|esp-&gt;diff
op_assign
l_int|0
suffix:semicolon
id|dma_clear
c_func
(paren
id|esp
)paren
suffix:semicolon
id|esp_initialize
c_func
(paren
id|esp
)paren
suffix:semicolon
id|zorro_config_board
c_func
(paren
id|key
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nESP: Total of %d ESP hosts found, %d actually in use.&bslash;n&quot;
comma
id|nesps
comma
id|esps_in_use
)paren
suffix:semicolon
id|esps_running
op_assign
id|esps_in_use
suffix:semicolon
r_return
id|esps_in_use
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************* DMA Functions */
DECL|function|dma_bytes_sent
r_static
r_int
id|dma_bytes_sent
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
r_int
id|fifo_count
)paren
(brace
multiline_comment|/* Since the Fastlane DMA is fully dedicated to the ESP chip,&n;&t; * the number of bytes sent (to the ESP chip) equals the number&n;&t; * of bytes in the FIFO - there is no buffering in the DMA controller.&n;&t; * XXXX Do I read this right? It is from host to ESP, right?&n;&t; */
r_return
id|fifo_count
suffix:semicolon
)brace
DECL|function|dma_can_transfer
r_static
r_int
id|dma_can_transfer
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|Scsi_Cmnd
op_star
id|sp
)paren
(brace
r_int
r_int
id|sz
op_assign
id|sp-&gt;SCp.this_residual
suffix:semicolon
r_if
c_cond
(paren
id|sz
OG
l_int|0xfffc
)paren
(brace
id|sz
op_assign
l_int|0xfffc
suffix:semicolon
)brace
r_return
id|sz
suffix:semicolon
)brace
DECL|function|dma_dump_state
r_static
r_void
id|dma_dump_state
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;esp%d: dma -- cond_reg&lt;%02x&gt;&bslash;n&quot;
comma
id|esp-&gt;esp_id
comma
(paren
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
)paren
op_member_access_from_pointer
id|cond_reg
)paren
)paren
suffix:semicolon
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;intreq:&lt;%04x&gt;, intena:&lt;%04x&gt;&bslash;n&quot;
comma
id|custom.intreqr
comma
id|custom.intenar
)paren
)paren
suffix:semicolon
)brace
DECL|function|dma_init_read
r_static
r_void
id|dma_init_read
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|__u32
id|addr
comma
r_int
id|length
)paren
(brace
r_struct
id|fastlane_dma_registers
op_star
id|dregs
op_assign
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
suffix:semicolon
r_int
r_int
op_star
id|t
suffix:semicolon
id|cache_clear
c_func
(paren
id|addr
comma
id|length
)paren
suffix:semicolon
id|dma_clear
c_func
(paren
id|esp
)paren
suffix:semicolon
id|t
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
id|addr
op_amp
l_int|0x00ffffff
)paren
op_plus
id|esp-&gt;edev
)paren
suffix:semicolon
id|dregs-&gt;clear_strobe
op_assign
l_int|0
suffix:semicolon
op_star
id|t
op_assign
id|addr
suffix:semicolon
id|ctrl_data
op_assign
(paren
id|ctrl_data
op_amp
id|FASTLANE_DMA_MASK
)paren
op_or
id|FASTLANE_DMA_ENABLE
suffix:semicolon
id|dregs-&gt;ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
)brace
DECL|function|dma_init_write
r_static
r_void
id|dma_init_write
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|__u32
id|addr
comma
r_int
id|length
)paren
(brace
r_struct
id|fastlane_dma_registers
op_star
id|dregs
op_assign
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
suffix:semicolon
r_int
r_int
op_star
id|t
suffix:semicolon
id|cache_push
c_func
(paren
id|addr
comma
id|length
)paren
suffix:semicolon
id|dma_clear
c_func
(paren
id|esp
)paren
suffix:semicolon
id|t
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
id|addr
op_amp
l_int|0x00ffffff
)paren
op_plus
(paren
id|esp-&gt;edev
)paren
)paren
suffix:semicolon
id|dregs-&gt;clear_strobe
op_assign
l_int|0
suffix:semicolon
op_star
id|t
op_assign
id|addr
suffix:semicolon
id|ctrl_data
op_assign
(paren
(paren
id|ctrl_data
op_amp
id|FASTLANE_DMA_MASK
)paren
op_or
id|FASTLANE_DMA_ENABLE
op_or
id|FASTLANE_DMA_WRITE
)paren
suffix:semicolon
id|dregs-&gt;ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
)brace
DECL|function|dma_clear
r_static
r_inline
r_void
id|dma_clear
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
r_struct
id|fastlane_dma_registers
op_star
id|dregs
op_assign
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
suffix:semicolon
r_int
r_int
op_star
id|t
suffix:semicolon
id|ctrl_data
op_assign
(paren
id|ctrl_data
op_amp
id|FASTLANE_DMA_MASK
)paren
suffix:semicolon
id|dregs-&gt;ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
id|t
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|esp-&gt;edev
)paren
suffix:semicolon
id|dregs-&gt;clear_strobe
op_assign
l_int|0
suffix:semicolon
op_star
id|t
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|dma_ints_off
r_static
r_void
id|dma_ints_off
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
id|disable_irq
c_func
(paren
id|esp-&gt;irq
)paren
suffix:semicolon
)brace
DECL|function|dma_ints_on
r_static
r_void
id|dma_ints_on
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
id|enable_irq
c_func
(paren
id|esp-&gt;irq
)paren
suffix:semicolon
)brace
DECL|function|dma_irq_p
r_static
r_int
id|dma_irq_p
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
r_struct
id|fastlane_dma_registers
op_star
id|dregs
op_assign
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
suffix:semicolon
macro_line|#if 0
r_int
r_char
id|dma_status
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
id|dma_status
op_assign
id|dregs-&gt;cond_reg
suffix:semicolon
r_if
c_cond
(paren
id|dma_status
op_amp
id|FASTLANE_DMA_IACT
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* not our IRQ */
multiline_comment|/* Return 1 if ESP requested IRQ */
r_if
c_cond
(paren
macro_line|#ifndef NODMAIRQ
(paren
id|dma_status
op_amp
id|FASTLANE_DMA_CREQ
)paren
op_logical_and
macro_line|#endif
(paren
op_logical_neg
(paren
id|dma_status
op_amp
id|FASTLANE_DMA_MINT
)paren
)paren
op_logical_and
(paren
(paren
(paren
(paren
r_struct
id|ESP_regs
op_star
)paren
(paren
id|esp-&gt;eregs
)paren
)paren
op_member_access_from_pointer
id|esp_status
)paren
op_amp
id|ESP_STAT_INTR
)paren
)paren
(brace
id|r
op_assign
l_int|1
suffix:semicolon
)brace
id|dregs-&gt;ctrl_reg
op_assign
(paren
id|ctrl_data
op_amp
op_complement
(paren
id|FASTLANE_DMA_EDI
op_or
id|FASTLANE_DMA_ESI
)paren
)paren
suffix:semicolon
id|dregs-&gt;ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
r_return
id|r
suffix:semicolon
macro_line|#else
r_int
id|r
suffix:semicolon
id|r
op_assign
(paren
(paren
(paren
r_struct
id|ESP_regs
op_star
)paren
(paren
id|esp-&gt;eregs
)paren
)paren
op_member_access_from_pointer
id|esp_status
)paren
op_amp
id|ESP_STAT_INTR
suffix:semicolon
id|dregs-&gt;ctrl_reg
op_assign
id|ctrl_data
op_amp
op_complement
(paren
id|FASTLANE_DMA_EDI
op_or
id|FASTLANE_DMA_ESI
)paren
suffix:semicolon
id|dregs-&gt;ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
r_return
id|r
suffix:semicolon
macro_line|#endif
)brace
DECL|function|dma_led_off
r_static
r_void
id|dma_led_off
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
id|ctrl_data
op_and_assign
op_complement
id|FASTLANE_DMA_LED
suffix:semicolon
(paren
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
)paren
op_member_access_from_pointer
id|ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
)brace
DECL|function|dma_led_on
r_static
r_void
id|dma_led_on
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
id|ctrl_data
op_or_assign
id|FASTLANE_DMA_LED
suffix:semicolon
(paren
(paren
r_struct
id|fastlane_dma_registers
op_star
)paren
(paren
id|esp-&gt;dregs
)paren
)paren
op_member_access_from_pointer
id|ctrl_reg
op_assign
id|ctrl_data
suffix:semicolon
)brace
DECL|function|dma_ports_p
r_static
r_int
id|dma_ports_p
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
)paren
(brace
r_return
(paren
(paren
id|custom.intenar
)paren
op_amp
id|IF_PORTS
)paren
suffix:semicolon
)brace
DECL|function|dma_setup
r_static
r_void
id|dma_setup
c_func
(paren
r_struct
id|NCR_ESP
op_star
id|esp
comma
id|__u32
id|addr
comma
r_int
id|count
comma
r_int
id|write
)paren
(brace
multiline_comment|/* On the Sparc, DMA_ST_WRITE means &quot;move data from device to memory&quot;&n;&t; * so when (write) is true, it actually means READ!&n;&t; */
r_if
c_cond
(paren
id|write
)paren
(brace
id|dma_init_read
c_func
(paren
id|esp
comma
id|addr
comma
id|count
)paren
suffix:semicolon
)brace
r_else
(brace
id|dma_init_write
c_func
(paren
id|esp
comma
id|addr
comma
id|count
)paren
suffix:semicolon
)brace
)brace
eof
