multiline_comment|/* aha152x.c -- Adaptec AHA-152x driver&n; * Author: J&#xfffd;rgen E. Fischer, fischer@norbit.de&n; * Copyright 1993-1999 J&#xfffd;rgen E. Fischer&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; *&n; * $Id: aha152x.c,v 2.3 2000/11/04 16:40:26 fischer Exp $&n; *&n; * $Log: aha152x.c,v $&n; * Revision 2.3  2000/11/04 16:40:26  fischer&n; * - handle data overruns&n; * - extend timeout for data phases&n; *&n; * Revision 2.2  2000/08/08 19:54:53  fischer&n; * - minor changes&n; *&n; * Revision 2.1  2000/05/17 16:23:17  fischer&n; * - signature update&n; * - fix for data out w/o scatter gather&n; *&n; * Revision 2.0  1999/12/25 15:07:32  fischer&n; * - interrupt routine completly reworked&n; * - basic support for new eh code&n; *&n; * Revision 1.21  1999/11/10 23:46:36  fischer&n; * - default to synchronous operation&n; * - synchronous negotiation fixed&n; * - added timeout to loops&n; * - debugging output can be controlled through procfs&n; *&n; * Revision 1.20  1999/11/07 18:37:31  fischer&n; * - synchronous operation works&n; * - resid support for sg driver&n; *&n; * Revision 1.19  1999/11/02 22:39:59  fischer&n; * - moved leading comments to README.aha152x&n; * - new additional module parameters&n; * - updates for 2.3&n; * - support for the Tripace TC1550 controller&n; * - interrupt handling changed&n; *&n; * Revision 1.18  1996/09/07 20:10:40  fischer&n; * - fixed can_queue handling (multiple outstanding commands working again)&n; *&n; * Revision 1.17  1996/08/17 16:05:14  fischer&n; * - biosparam improved&n; * - interrupt verification&n; * - updated documentation&n; * - cleanups&n; *&n; * Revision 1.16  1996/06/09 00:04:56  root&n; * - added configuration symbols for insmod (aha152x/aha152x1)&n; *&n; * Revision 1.15  1996/04/30 14:52:06  fischer&n; * - proc info fixed&n; * - support for extended translation for &gt;1GB disks&n; *&n; * Revision 1.14  1996/01/17  15:11:20  fischer&n; * - fixed lockup in MESSAGE IN phase after reconnection&n; *&n; * Revision 1.13  1996/01/09  02:15:53  fischer&n; * - some cleanups&n; * - moved request_irq behind controller initialization&n; *   (to avoid spurious interrupts)&n; *&n; * Revision 1.12  1995/12/16  12:26:07  fischer&n; * - barrier()s added&n; * - configurable RESET delay added&n; *&n; * Revision 1.11  1995/12/06  21:18:35  fischer&n; * - some minor updates&n; *&n; * Revision 1.10  1995/07/22  19:18:45  fischer&n; * - support for 2 controllers&n; * - started synchronous data transfers (not working yet)&n; *&n; * Revision 1.9  1995/03/18  09:20:24  root&n; * - patches for PCMCIA and modules&n; *&n; * Revision 1.8  1995/01/21  22:07:19  root&n; * - snarf_region =&gt; request_region&n; * - aha152x_intr interface change&n; *&n; * Revision 1.7  1995/01/02  23:19:36  root&n; * - updated COMMAND_SIZE to cmd_len&n; * - changed sti() to restore_flags()&n; * - fixed some #ifdef which generated warnings&n; *&n; * Revision 1.6  1994/11/24  20:35:27  root&n; * - problem with odd number of bytes in fifo fixed&n; *&n; * Revision 1.5  1994/10/30  14:39:56  root&n; * - abort code fixed&n; * - debugging improved&n; *&n; * Revision 1.4  1994/09/12  11:33:01  root&n; * - irqaction to request_irq&n; * - abortion updated&n; *&n; * Revision 1.3  1994/08/04  13:53:05  root&n; * - updates for mid-level-driver changes&n; * - accept unexpected BUSFREE phase as error condition&n; * - parity check now configurable&n; *&n; * Revision 1.2  1994/07/03  12:56:36  root&n; * - cleaned up debugging code&n; * - more tweaking on reset delays&n; * - updated abort/reset code (pretty untested...)&n; *&n; * Revision 1.1  1994/05/28  21:18:49  root&n; * - update for mid-level interface change (abort-reset)&n; * - delays after resets adjusted for some slow devices&n; *&n; * Revision 1.0  1994/03/25  12:52:00  root&n; * - Fixed &quot;more data than expected&quot; problem&n; * - added new BIOS signatures&n; *&n; * Revision 0.102  1994/01/31  20:44:12  root&n; * - minor changes in insw/outsw handling&n; *&n; * Revision 0.101  1993/12/13  01:16:27  root&n; * - fixed STATUS phase (non-GOOD stati were dropped sometimes;&n; *   fixes problems with CD-ROM sector size detection &amp; media change)&n; *&n; * Revision 0.100  1993/12/10  16:58:47  root&n; * - fix for unsuccessful selections in case of non-continuous id assignments&n; *   on the scsi bus.&n; *&n; * Revision 0.99  1993/10/24  16:19:59  root&n; * - fixed DATA IN (rare read errors gone)&n; *&n; * Revision 0.98  1993/10/17  12:54:44  root&n; * - fixed some recent fixes (shame on me)&n; * - moved initialization of scratch area to aha152x_queue&n; *&n; * Revision 0.97  1993/10/09  18:53:53  root&n; * - DATA IN fixed. Rarely left data in the fifo.&n; *&n; * Revision 0.96  1993/10/03  00:53:59  root&n; * - minor changes on DATA IN&n; *&n; * Revision 0.95  1993/09/24  10:36:01  root&n; * - change handling of MSGI after reselection&n; * - fixed sti/cli&n; * - minor changes&n; *&n; * Revision 0.94  1993/09/18  14:08:22  root&n; * - fixed bug in multiple outstanding command code&n; * - changed detection&n; * - support for kernel command line configuration&n; * - reset corrected&n; * - changed message handling&n; *&n; * Revision 0.93  1993/09/15  20:41:19  root&n; * - fixed bugs with multiple outstanding commands&n; *&n; * Revision 0.92  1993/09/13  02:46:33  root&n; * - multiple outstanding commands work (no problems with IBM drive)&n; *&n; * Revision 0.91  1993/09/12  20:51:46  root&n; * added multiple outstanding commands&n; * (some problem with this $%&amp;? IBM device remain)&n; *&n; * Revision 0.9  1993/09/12  11:11:22  root&n; * - corrected auto-configuration&n; * - changed the auto-configuration (added some &squot;#define&squot;s)&n; * - added support for dis-/reconnection&n; *&n; * Revision 0.8  1993/09/06  23:09:39  root&n; * - added support for the drive activity light&n; * - minor changes&n; *&n; * Revision 0.7  1993/09/05  14:30:15  root&n; * - improved phase detection&n; * - now using the new snarf_region code of 0.99pl13&n; *&n; * Revision 0.6  1993/09/02  11:01:38  root&n; * first public release; added some signatures and biosparam()&n; *&n; * Revision 0.5  1993/08/30  10:23:30  root&n; * fixed timing problems with my IBM drive&n; *&n; * Revision 0.4  1993/08/29  14:06:52  root&n; * fixed some problems with timeouts due incomplete commands&n; *&n; * Revision 0.3  1993/08/28  15:55:03  root&n; * writing data works too.  mounted and worked on a dos partition&n; *&n; * Revision 0.2  1993/08/27  22:42:07  root&n; * reading data works.  Mounted a msdos partition.&n; *&n; * Revision 0.1  1993/08/25  13:38:30  root&n; * first &quot;damn thing doesn&squot;t work&quot; version&n; *&n; * Revision 0.0  1993/08/14  19:54:25  root&n; * empty function bodies; detect() works.&n; *&n; *&n; **************************************************************************&n; &n; see README.aha152x for configuration details&n;&n; **************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#if defined(PCMCIA)
DECL|macro|MODULE
macro_line|#undef MODULE
macro_line|#endif
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &quot;aha152x.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;scsi/scsicam.h&gt;
multiline_comment|/* DEFINES */
multiline_comment|/* For PCMCIA cards, always use AUTOCONF */
macro_line|#if defined(PCMCIA) || defined(MODULE)
macro_line|#if !defined(AUTOCONF)
DECL|macro|AUTOCONF
mdefine_line|#define AUTOCONF
macro_line|#endif
macro_line|#endif
macro_line|#if !defined(AUTOCONF) &amp;&amp; !defined(SETUP0)
macro_line|#error define AUTOCONF or SETUP0
macro_line|#endif
macro_line|#if defined(AHA152X_DEBUG)
DECL|macro|DEBUG_DEFAULT
mdefine_line|#define DEBUG_DEFAULT debug_eh
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(when,msgs...) &bslash;&n;&t;do { if(HOSTDATA(shpnt)-&gt;debug &amp; (when)) printk(msgs); } while(0)
DECL|macro|DO_LOCK
mdefine_line|#define DO_LOCK(flags)&t;&bslash;&n;&t;do { &bslash;&n;&t;&t;if(spin_is_locked(&amp;QLOCK)) { &bslash;&n;&t;&t;&t;DPRINTK(debug_intr, DEBUG_LEAD &quot;(%s:%d) already locked at %s:%d&bslash;n&quot;, CMDINFO(CURRENT_SC), __FUNCTION__, __LINE__, QLOCKER, QLOCKERL); &bslash;&n;&t;&t;} &bslash;&n;&t;&t;DPRINTK(debug_locks, DEBUG_LEAD &quot;(%s:%d) locking&bslash;n&quot;, CMDINFO(CURRENT_SC), __FUNCTION__, __LINE__); &bslash;&n;&t;&t;spin_lock_irqsave(&amp;QLOCK,flags); &bslash;&n;&t;&t;DPRINTK(debug_locks, DEBUG_LEAD &quot;(%s:%d) locked&bslash;n&quot;, CMDINFO(CURRENT_SC), __FUNCTION__, __LINE__); &bslash;&n;&t;&t;QLOCKER=__FUNCTION__; &bslash;&n;&t;&t;QLOCKERL=__LINE__; &bslash;&n;&t;} while(0)
DECL|macro|DO_UNLOCK
mdefine_line|#define DO_UNLOCK(flags)&t;&bslash;&n;&t;do { &bslash;&n;&t;&t;DPRINTK(debug_locks, DEBUG_LEAD &quot;(%s:%d) unlocking (locked at %s:%d)&bslash;n&quot;, CMDINFO(CURRENT_SC), __FUNCTION__, __LINE__, QLOCKER, QLOCKERL); &bslash;&n;&t;&t;spin_unlock_irqrestore(&amp;QLOCK,flags); &bslash;&n;&t;&t;DPRINTK(debug_locks, DEBUG_LEAD &quot;(%s:%d) unlocked&bslash;n&quot;, CMDINFO(CURRENT_SC), __FUNCTION__, __LINE__); &bslash;&n;&t;&t;QLOCKER=&quot;(not locked)&quot;; &bslash;&n;&t;&t;QLOCKERL=0; &bslash;&n;&t;} while(0)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(when,msgs...)
DECL|macro|DO_LOCK
mdefine_line|#define&t;DO_LOCK(flags)&t;&t;spin_lock_irqsave(&amp;QLOCK,flags)
DECL|macro|DO_UNLOCK
mdefine_line|#define&t;DO_UNLOCK(flags)&t;spin_unlock_irqrestore(&amp;QLOCK,flags)
macro_line|#endif
DECL|macro|LEAD
mdefine_line|#define LEAD&t;&t;&quot;(scsi%d:%d:%d) &quot;
DECL|macro|WARN_LEAD
mdefine_line|#define WARN_LEAD&t;KERN_WARNING&t;LEAD
DECL|macro|INFO_LEAD
mdefine_line|#define INFO_LEAD&t;KERN_INFO&t;LEAD
DECL|macro|NOTE_LEAD
mdefine_line|#define NOTE_LEAD&t;KERN_NOTICE&t;LEAD
DECL|macro|ERR_LEAD
mdefine_line|#define ERR_LEAD&t;KERN_ERR&t;LEAD
DECL|macro|DEBUG_LEAD
mdefine_line|#define DEBUG_LEAD&t;KERN_DEBUG&t;LEAD
DECL|macro|CMDINFO
mdefine_line|#define CMDINFO(cmd) &bslash;&n;&t;&t;&t;(cmd) ? ((cmd)-&gt;host-&gt;host_no) : -1, &bslash;&n;                        (cmd) ? ((cmd)-&gt;target &amp; 0x0f) : -1, &bslash;&n;&t;&t;&t;(cmd) ? ((cmd)-&gt;lun &amp; 0x07) : -1
DECL|macro|DELAY_DEFAULT
mdefine_line|#define DELAY_DEFAULT 100
multiline_comment|/* possible irq range */
macro_line|#if defined(PCMCIA)
DECL|macro|IRQ_MIN
mdefine_line|#define IRQ_MIN 0
DECL|macro|IRQ_MAX
mdefine_line|#define IRQ_MAX 16
macro_line|#else
DECL|macro|IRQ_MIN
mdefine_line|#define IRQ_MIN 9
DECL|macro|IRQ_MAX
mdefine_line|#define IRQ_MAX 12
macro_line|#endif
DECL|macro|IRQS
mdefine_line|#define IRQS    IRQ_MAX-IRQ_MIN+1
r_enum
(brace
DECL|enumerator|not_issued
id|not_issued
op_assign
l_int|0x0001
comma
multiline_comment|/* command not yet issued */
DECL|enumerator|selecting
id|selecting
op_assign
l_int|0x0002
comma
multiline_comment|/* target is beeing selected */
DECL|enumerator|identified
id|identified
op_assign
l_int|0x0004
comma
multiline_comment|/* IDENTIFY was sent */
DECL|enumerator|disconnected
id|disconnected
op_assign
l_int|0x0008
comma
multiline_comment|/* target disconnected */
DECL|enumerator|completed
id|completed
op_assign
l_int|0x0010
comma
multiline_comment|/* target sent COMMAND COMPLETE */
DECL|enumerator|aborted
id|aborted
op_assign
l_int|0x0020
comma
multiline_comment|/* ABORT was sent */
DECL|enumerator|resetted
id|resetted
op_assign
l_int|0x0040
comma
multiline_comment|/* BUS DEVICE RESET was sent */
DECL|enumerator|spiordy
id|spiordy
op_assign
l_int|0x0080
comma
multiline_comment|/* waiting for SPIORDY to raise */
DECL|enumerator|syncneg
id|syncneg
op_assign
l_int|0x0100
comma
multiline_comment|/* synchronous negotiation in progress */
DECL|enumerator|aborting
id|aborting
op_assign
l_int|0x0200
comma
multiline_comment|/* ABORT is pending */
DECL|enumerator|resetting
id|resetting
op_assign
l_int|0x0400
comma
multiline_comment|/* BUS DEVICE RESET is pending */
)brace
suffix:semicolon
macro_line|#if defined(MODULE)
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;J&#xfffd;rgen Fischer&quot;
)paren
suffix:semicolon
DECL|variable|AHA152X_REVID
id|MODULE_DESCRIPTION
c_func
(paren
id|AHA152X_REVID
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;base io address of controller&quot;
)paren
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;interrupt for controller&quot;
)paren
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scsiid
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scsiid
comma
l_string|&quot;scsi id of controller&quot;
)paren
suffix:semicolon
DECL|variable|scsiid
r_static
r_int
id|scsiid
(braket
)braket
op_assign
(brace
l_int|7
comma
l_int|7
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|reconnect
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|reconnect
comma
l_string|&quot;allow targets to disconnect&quot;
)paren
suffix:semicolon
DECL|variable|reconnect
r_static
r_int
id|reconnect
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|parity
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|parity
comma
l_string|&quot;use scsi parity&quot;
)paren
suffix:semicolon
DECL|variable|parity
r_static
r_int
id|parity
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sync
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|sync
comma
l_string|&quot;use synchronous transfers&quot;
)paren
suffix:semicolon
DECL|variable|sync
r_static
r_int
id|sync
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|delay
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|delay
comma
l_string|&quot;scsi reset delay&quot;
)paren
suffix:semicolon
DECL|variable|delay
r_static
r_int
id|delay
(braket
)braket
op_assign
(brace
id|DELAY_DEFAULT
comma
id|DELAY_DEFAULT
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|exttrans
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|exttrans
comma
l_string|&quot;use extended translation&quot;
)paren
suffix:semicolon
DECL|variable|exttrans
r_static
r_int
id|exttrans
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#if !defined(AHA152X_DEBUG)
id|MODULE_PARM
c_func
(paren
id|aha152x
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|aha152x
comma
l_string|&quot;parameters for first controller&quot;
)paren
suffix:semicolon
DECL|variable|aha152x
r_static
r_int
id|aha152x
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
id|DELAY_DEFAULT
comma
l_int|0
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x1
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|aha152x1
comma
l_string|&quot;parameters for second controller&quot;
)paren
suffix:semicolon
DECL|variable|aha152x1
r_static
r_int
id|aha152x1
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
id|DELAY_DEFAULT
comma
l_int|0
)brace
suffix:semicolon
macro_line|#else
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;flags for driver debugging&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
(braket
)braket
op_assign
(brace
id|DEBUG_DEFAULT
comma
id|DEBUG_DEFAULT
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x
comma
l_string|&quot;1-9i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|aha152x
comma
l_string|&quot;parameters for first controller&quot;
)paren
suffix:semicolon
DECL|variable|aha152x
r_static
r_int
id|aha152x
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
id|DELAY_DEFAULT
comma
l_int|0
comma
id|DEBUG_DEFAULT
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x1
comma
l_string|&quot;1-9i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|aha152x1
comma
l_string|&quot;parameters for second controller&quot;
)paren
suffix:semicolon
DECL|variable|aha152x1
r_static
r_int
id|aha152x1
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
id|DELAY_DEFAULT
comma
l_int|0
comma
id|DEBUG_DEFAULT
)brace
suffix:semicolon
macro_line|#endif /* !defined(AHA152X_DEBUG) */
macro_line|#endif /* MODULE */
multiline_comment|/* set by aha152x_setup according to the command line */
DECL|variable|setup_count
r_static
r_int
id|setup_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|registered_count
r_static
r_int
id|registered_count
op_assign
l_int|0
suffix:semicolon
DECL|struct|aha152x_setup
r_static
r_struct
id|aha152x_setup
(brace
DECL|member|io_port
r_int
id|io_port
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|scsiid
r_int
id|scsiid
suffix:semicolon
DECL|member|reconnect
r_int
id|reconnect
suffix:semicolon
DECL|member|parity
r_int
id|parity
suffix:semicolon
DECL|member|synchronous
r_int
id|synchronous
suffix:semicolon
DECL|member|delay
r_int
id|delay
suffix:semicolon
DECL|member|ext_trans
r_int
id|ext_trans
suffix:semicolon
DECL|member|tc1550
r_int
id|tc1550
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
DECL|member|debug
r_int
id|debug
suffix:semicolon
macro_line|#endif
DECL|member|conf
r_char
op_star
id|conf
suffix:semicolon
DECL|variable|setup
)brace
id|setup
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|aha152x_host
r_static
r_struct
id|Scsi_Host
op_star
id|aha152x_host
(braket
id|IRQS
)braket
suffix:semicolon
multiline_comment|/*&n; * internal states of the host&n; *&n; */
DECL|enum|aha152x_state
r_enum
id|aha152x_state
(brace
DECL|enumerator|idle
id|idle
op_assign
l_int|0
comma
DECL|enumerator|unknown
id|unknown
comma
DECL|enumerator|seldo
id|seldo
comma
DECL|enumerator|seldi
id|seldi
comma
DECL|enumerator|selto
id|selto
comma
DECL|enumerator|busfree
id|busfree
comma
DECL|enumerator|msgo
id|msgo
comma
DECL|enumerator|cmd
id|cmd
comma
DECL|enumerator|msgi
id|msgi
comma
DECL|enumerator|status
id|status
comma
DECL|enumerator|datai
id|datai
comma
DECL|enumerator|datao
id|datao
comma
DECL|enumerator|parerr
id|parerr
comma
DECL|enumerator|rsti
id|rsti
comma
DECL|enumerator|maxstate
id|maxstate
)brace
suffix:semicolon
multiline_comment|/*&n; * current state information of the host&n; *&n; */
DECL|struct|aha152x_hostdata
r_struct
id|aha152x_hostdata
(brace
DECL|member|issue_SC
id|Scsi_Cmnd
op_star
id|issue_SC
suffix:semicolon
multiline_comment|/* pending commands to issue */
DECL|member|current_SC
id|Scsi_Cmnd
op_star
id|current_SC
suffix:semicolon
multiline_comment|/* current command on the bus */
DECL|member|disconnected_SC
id|Scsi_Cmnd
op_star
id|disconnected_SC
suffix:semicolon
multiline_comment|/* commands that disconnected */
DECL|member|done_SC
id|Scsi_Cmnd
op_star
id|done_SC
suffix:semicolon
multiline_comment|/* command that was completed */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* host lock */
macro_line|#if defined(AHA152X_DEBUG)
DECL|member|locker
r_char
op_star
id|locker
suffix:semicolon
multiline_comment|/* which function has the lock */
DECL|member|lockerl
r_int
id|lockerl
suffix:semicolon
multiline_comment|/* where did it get it */
DECL|member|debug
r_int
id|debug
suffix:semicolon
multiline_comment|/* current debugging setting */
macro_line|#endif
macro_line|#if defined(AHA152X_STAT)
DECL|member|total_commands
r_int
id|total_commands
suffix:semicolon
DECL|member|disconnections
r_int
id|disconnections
suffix:semicolon
DECL|member|busfree_without_any_action
r_int
id|busfree_without_any_action
suffix:semicolon
DECL|member|busfree_without_old_command
r_int
id|busfree_without_old_command
suffix:semicolon
DECL|member|busfree_without_new_command
r_int
id|busfree_without_new_command
suffix:semicolon
DECL|member|busfree_without_done_command
r_int
id|busfree_without_done_command
suffix:semicolon
DECL|member|busfree_with_check_condition
r_int
id|busfree_with_check_condition
suffix:semicolon
DECL|member|count
r_int
id|count
(braket
id|maxstate
)braket
suffix:semicolon
DECL|member|count_trans
r_int
id|count_trans
(braket
id|maxstate
)braket
suffix:semicolon
DECL|member|time
r_int
r_int
id|time
(braket
id|maxstate
)braket
suffix:semicolon
macro_line|#endif
DECL|member|commands
r_int
id|commands
suffix:semicolon
multiline_comment|/* current number of commands */
DECL|member|reconnect
r_int
id|reconnect
suffix:semicolon
multiline_comment|/* disconnection allowed */
DECL|member|parity
r_int
id|parity
suffix:semicolon
multiline_comment|/* parity checking enabled */
DECL|member|synchronous
r_int
id|synchronous
suffix:semicolon
multiline_comment|/* synchronous transferes enabled */
DECL|member|delay
r_int
id|delay
suffix:semicolon
multiline_comment|/* reset out delay */
DECL|member|ext_trans
r_int
id|ext_trans
suffix:semicolon
multiline_comment|/* extended translation enabled */
DECL|member|swint
r_int
id|swint
suffix:semicolon
multiline_comment|/* software-interrupt was fired during detect() */
DECL|member|service
r_int
id|service
suffix:semicolon
multiline_comment|/* bh needs to be run */
DECL|member|in_intr
r_int
id|in_intr
suffix:semicolon
multiline_comment|/* bh is running */
multiline_comment|/* current state,&n;&t;   previous state,&n;&t;   last state different from current state */
DECL|member|state
DECL|member|prevstate
DECL|member|laststate
r_enum
id|aha152x_state
id|state
comma
id|prevstate
comma
id|laststate
suffix:semicolon
DECL|member|target
r_int
id|target
suffix:semicolon
multiline_comment|/* reconnecting target */
DECL|member|syncrate
r_int
r_char
id|syncrate
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* current synchronous transfer agreements */
DECL|member|syncneg
r_int
r_char
id|syncneg
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* 0: no negotiation;&n;&t;&t; * 1: negotiation in progress;&n;&t;&t; * 2: negotiation completed&n;&t;&t; */
DECL|member|cmd_i
r_int
id|cmd_i
suffix:semicolon
multiline_comment|/* number of sent bytes of current command */
DECL|member|msgi_len
r_int
id|msgi_len
suffix:semicolon
multiline_comment|/* number of received message bytes */
DECL|member|msgi
r_int
r_char
id|msgi
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* received message bytes */
DECL|member|msgo_i
DECL|member|msgo_len
r_int
id|msgo_i
comma
id|msgo_len
suffix:semicolon
multiline_comment|/* number of sent bytes and length of current messages */
DECL|member|msgo
r_int
r_char
id|msgo
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* pending messages */
DECL|member|data_len
r_int
id|data_len
suffix:semicolon
multiline_comment|/* number of sent/received bytes in dataphase */
DECL|member|io_port0
r_int
r_int
id|io_port0
suffix:semicolon
DECL|member|io_port1
r_int
r_int
id|io_port1
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * host specific command extension&n; *&n; */
DECL|struct|aha152x_scdata
r_struct
id|aha152x_scdata
(brace
DECL|member|next
id|Scsi_Cmnd
op_star
id|next
suffix:semicolon
multiline_comment|/* next sc in queue */
DECL|member|done
id|Scsi_Cmnd
op_star
id|done
suffix:semicolon
multiline_comment|/* done command */
DECL|member|sem
r_struct
id|semaphore
op_star
id|sem
suffix:semicolon
multiline_comment|/* semaphore to block on */
)brace
suffix:semicolon
multiline_comment|/* access macros for hostdata */
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(shpnt)&t;&t;((struct aha152x_hostdata *) &amp;shpnt-&gt;hostdata)
DECL|macro|HOSTNO
mdefine_line|#define HOSTNO&t;&t;&t;((shpnt)-&gt;host_no)
DECL|macro|CURRENT_SC
mdefine_line|#define CURRENT_SC&t;&t;(HOSTDATA(shpnt)-&gt;current_SC)
DECL|macro|DONE_SC
mdefine_line|#define DONE_SC&t;&t;&t;(HOSTDATA(shpnt)-&gt;done_SC)
DECL|macro|ISSUE_SC
mdefine_line|#define ISSUE_SC&t;&t;(HOSTDATA(shpnt)-&gt;issue_SC)
DECL|macro|DISCONNECTED_SC
mdefine_line|#define DISCONNECTED_SC&t;&t;(HOSTDATA(shpnt)-&gt;disconnected_SC)
DECL|macro|QLOCK
mdefine_line|#define QLOCK&t;&t;&t;(HOSTDATA(shpnt)-&gt;lock)
DECL|macro|QLOCKER
mdefine_line|#define QLOCKER&t;&t;&t;(HOSTDATA(shpnt)-&gt;locker)
DECL|macro|QLOCKERL
mdefine_line|#define QLOCKERL&t;&t;(HOSTDATA(shpnt)-&gt;lockerl)
DECL|macro|STATE
mdefine_line|#define STATE&t;&t;&t;(HOSTDATA(shpnt)-&gt;state)
DECL|macro|PREVSTATE
mdefine_line|#define PREVSTATE&t;&t;(HOSTDATA(shpnt)-&gt;prevstate)
DECL|macro|LASTSTATE
mdefine_line|#define LASTSTATE&t;&t;(HOSTDATA(shpnt)-&gt;laststate)
DECL|macro|RECONN_TARGET
mdefine_line|#define RECONN_TARGET&t;&t;(HOSTDATA(shpnt)-&gt;target)
DECL|macro|CMD_I
mdefine_line|#define CMD_I&t;&t;&t;(HOSTDATA(shpnt)-&gt;cmd_i)
DECL|macro|MSGO
mdefine_line|#define MSGO(i)&t;&t;&t;(HOSTDATA(shpnt)-&gt;msgo[i])
DECL|macro|MSGO_I
mdefine_line|#define MSGO_I&t;&t;&t;(HOSTDATA(shpnt)-&gt;msgo_i)
DECL|macro|MSGOLEN
mdefine_line|#define MSGOLEN&t;&t;&t;(HOSTDATA(shpnt)-&gt;msgo_len)
DECL|macro|ADDMSGO
mdefine_line|#define ADDMSGO(x)&t;&t;(MSGOLEN&lt;256 ? MSGO(MSGOLEN++)=x : aha152x_error(shpnt,&quot;MSGO overflow&quot;))
DECL|macro|MSGI
mdefine_line|#define MSGI(i)&t;&t;&t;(HOSTDATA(shpnt)-&gt;msgi[i])
DECL|macro|MSGILEN
mdefine_line|#define MSGILEN&t;&t;&t;(HOSTDATA(shpnt)-&gt;msgi_len)
DECL|macro|ADDMSGI
mdefine_line|#define ADDMSGI(x)&t;&t;(MSGILEN&lt;256 ? MSGI(MSGILEN++)=x : aha152x_error(shpnt,&quot;MSGI overflow&quot;))
DECL|macro|DATA_LEN
mdefine_line|#define DATA_LEN&t;&t;(HOSTDATA(shpnt)-&gt;data_len)
DECL|macro|SYNCRATE
mdefine_line|#define SYNCRATE&t;&t;(HOSTDATA(shpnt)-&gt;syncrate[CURRENT_SC-&gt;target])
DECL|macro|SYNCNEG
mdefine_line|#define SYNCNEG&t;&t;&t;(HOSTDATA(shpnt)-&gt;syncneg[CURRENT_SC-&gt;target])
DECL|macro|DELAY
mdefine_line|#define DELAY&t;&t;&t;(HOSTDATA(shpnt)-&gt;delay)
DECL|macro|EXT_TRANS
mdefine_line|#define EXT_TRANS&t;&t;(HOSTDATA(shpnt)-&gt;ext_trans)
DECL|macro|TC1550
mdefine_line|#define TC1550&t;&t;&t;(HOSTDATA(shpnt)-&gt;tc1550)
DECL|macro|RECONNECT
mdefine_line|#define RECONNECT&t;&t;(HOSTDATA(shpnt)-&gt;reconnect)
DECL|macro|PARITY
mdefine_line|#define PARITY&t;&t;&t;(HOSTDATA(shpnt)-&gt;parity)
DECL|macro|SYNCHRONOUS
mdefine_line|#define SYNCHRONOUS&t;&t;(HOSTDATA(shpnt)-&gt;synchronous)
DECL|macro|HOSTIOPORT0
mdefine_line|#define HOSTIOPORT0&t;&t;(HOSTDATA(shpnt)-&gt;io_port0)
DECL|macro|HOSTIOPORT1
mdefine_line|#define HOSTIOPORT1&t;&t;(HOSTDATA(shpnt)-&gt;io_port1)
DECL|macro|SCDATA
mdefine_line|#define SCDATA(SCpnt)&t;&t;((struct aha152x_scdata *) (SCpnt)-&gt;host_scribble)
DECL|macro|SCNEXT
mdefine_line|#define SCNEXT(SCpnt)&t;&t;SCDATA(SCpnt)-&gt;next
DECL|macro|SCDONE
mdefine_line|#define SCDONE(SCpnt)&t;&t;SCDATA(SCpnt)-&gt;done
DECL|macro|SCSEM
mdefine_line|#define SCSEM(SCpnt)&t;&t;SCDATA(SCpnt)-&gt;sem
multiline_comment|/* state handling */
r_static
r_void
id|seldi_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|seldo_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|selto_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|busfree_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|msgo_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|msgo_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|msgo_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|cmd_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|cmd_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|cmd_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|datai_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|datai_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|datai_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|datao_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|datao_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|datao_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|status_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|msgi_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|msgi_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|parerr_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|rsti_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|complete
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
multiline_comment|/*&n; * driver states&n; *&n; */
r_static
r_struct
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|init
r_void
(paren
op_star
id|init
)paren
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
DECL|member|run
r_void
(paren
op_star
id|run
)paren
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
DECL|member|end
r_void
(paren
op_star
id|end
)paren
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
DECL|member|spio
r_int
id|spio
suffix:semicolon
DECL|variable|states
)brace
id|states
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;idle&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;unknown&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;seldo&quot;
comma
l_int|0
comma
id|seldo_run
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;seldi&quot;
comma
l_int|0
comma
id|seldi_run
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;selto&quot;
comma
l_int|0
comma
id|selto_run
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;busfree&quot;
comma
l_int|0
comma
id|busfree_run
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;msgo&quot;
comma
id|msgo_init
comma
id|msgo_run
comma
id|msgo_end
comma
l_int|1
)brace
comma
(brace
l_string|&quot;cmd&quot;
comma
id|cmd_init
comma
id|cmd_run
comma
id|cmd_end
comma
l_int|1
)brace
comma
(brace
l_string|&quot;msgi&quot;
comma
l_int|0
comma
id|msgi_run
comma
id|msgi_end
comma
l_int|1
)brace
comma
(brace
l_string|&quot;status&quot;
comma
l_int|0
comma
id|status_run
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
l_string|&quot;datai&quot;
comma
id|datai_init
comma
id|datai_run
comma
id|datai_end
comma
l_int|0
)brace
comma
(brace
l_string|&quot;datao&quot;
comma
id|datao_init
comma
id|datao_run
comma
id|datao_end
comma
l_int|0
)brace
comma
(brace
l_string|&quot;parerr&quot;
comma
l_int|0
comma
id|parerr_run
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;rsti&quot;
comma
l_int|0
comma
id|rsti_run
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* setup &amp; interrupt */
r_static
r_void
id|intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|reset_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|aha152x_error
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_char
op_star
id|msg
)paren
suffix:semicolon
r_static
r_void
id|done
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
id|error
)paren
suffix:semicolon
r_static
r_int
id|checksetup
c_func
(paren
r_struct
id|aha152x_setup
op_star
id|setup
)paren
suffix:semicolon
multiline_comment|/* diagnostics */
r_static
r_void
id|disp_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|show_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|show_queues
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|disp_enintr
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
multiline_comment|/* possible i/o addresses for the AIC-6260; default first */
DECL|variable|ports
r_static
r_int
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x340
comma
l_int|0x140
)brace
suffix:semicolon
DECL|macro|PORT_COUNT
mdefine_line|#define PORT_COUNT (sizeof(ports) / sizeof(unsigned short))
macro_line|#if !defined(SKIP_BIOSTEST)
multiline_comment|/* possible locations for the Adaptec BIOS; defaults first */
DECL|variable|addresses
r_static
r_int
r_int
id|addresses
(braket
)braket
op_assign
(brace
l_int|0xdc000
comma
multiline_comment|/* default first */
l_int|0xc8000
comma
l_int|0xcc000
comma
l_int|0xd0000
comma
l_int|0xd4000
comma
l_int|0xd8000
comma
l_int|0xe0000
comma
l_int|0xeb800
comma
multiline_comment|/* VTech Platinum SMP */
l_int|0xf0000
comma
)brace
suffix:semicolon
DECL|macro|ADDRESS_COUNT
mdefine_line|#define ADDRESS_COUNT (sizeof(addresses) / sizeof(unsigned int))
multiline_comment|/* signatures for various AIC-6[23]60 based controllers.&n;   The point in detecting signatures is to avoid useless and maybe&n;   harmful probes on ports. I&squot;m not sure that all listed boards pass&n;   auto-configuration. For those which fail the BIOS signature is&n;   obsolete, because user intervention to supply the configuration is&n;   needed anyway.  May be an information whether or not the BIOS supports&n;   extended translation could be also useful here. */
DECL|struct|signature
r_static
r_struct
id|signature
(brace
DECL|member|signature
r_int
r_char
op_star
id|signature
suffix:semicolon
DECL|member|sig_offset
r_int
id|sig_offset
suffix:semicolon
DECL|member|sig_length
r_int
id|sig_length
suffix:semicolon
DECL|variable|signatures
)brace
id|signatures
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Adaptec AHA-1520 BIOS&quot;
comma
l_int|0x102e
comma
l_int|21
)brace
comma
multiline_comment|/* Adaptec 152x */
(brace
l_string|&quot;Adaptec AHA-1520B&quot;
comma
l_int|0x000b
comma
l_int|17
)brace
comma
multiline_comment|/* Adaptec 152x rev B */
(brace
l_string|&quot;Adaptec AHA-1520B&quot;
comma
l_int|0x0026
comma
l_int|17
)brace
comma
multiline_comment|/* Iomega Jaz Jet ISA (AIC6370Q) */
(brace
l_string|&quot;Adaptec ASW-B626 BIOS&quot;
comma
l_int|0x1029
comma
l_int|21
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;Adaptec BIOS: ASW-B626&quot;
comma
l_int|0x000f
comma
l_int|22
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;Adaptec ASW-B626 S2&quot;
comma
l_int|0x2e6c
comma
l_int|19
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;Adaptec BIOS:AIC-6360&quot;
comma
l_int|0x000c
comma
l_int|21
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;ScsiPro SP-360 BIOS&quot;
comma
l_int|0x2873
comma
l_int|19
)brace
comma
multiline_comment|/* ScsiPro-Controller  */
(brace
l_string|&quot;GA-400 LOCAL BUS SCSI BIOS&quot;
comma
l_int|0x102e
comma
l_int|26
)brace
comma
multiline_comment|/* Gigabyte Local-Bus-SCSI */
(brace
l_string|&quot;Adaptec BIOS:AVA-282X&quot;
comma
l_int|0x000c
comma
l_int|21
)brace
comma
multiline_comment|/* Adaptec 282x */
(brace
l_string|&quot;Adaptec IBM Dock II SCSI&quot;
comma
l_int|0x2edd
comma
l_int|24
)brace
comma
multiline_comment|/* IBM Thinkpad Dock II */
(brace
l_string|&quot;Adaptec BIOS:AHA-1532P&quot;
comma
l_int|0x001c
comma
l_int|22
)brace
comma
multiline_comment|/* IBM Thinkpad Dock II SCSI */
(brace
l_string|&quot;DTC3520A Host Adapter BIOS&quot;
comma
l_int|0x318a
comma
l_int|26
)brace
comma
multiline_comment|/* DTC 3520A ISA SCSI */
)brace
suffix:semicolon
DECL|macro|SIGNATURE_COUNT
mdefine_line|#define SIGNATURE_COUNT (sizeof(signatures) / sizeof(struct signature))
macro_line|#endif
multiline_comment|/*&n; *  queue services:&n; *&n; */
DECL|function|append_SC
r_static
r_inline
r_void
id|append_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
id|Scsi_Cmnd
op_star
id|new_SC
)paren
(brace
id|Scsi_Cmnd
op_star
id|end
suffix:semicolon
id|SCNEXT
c_func
(paren
id|new_SC
)paren
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|SC
)paren
op_star
id|SC
op_assign
id|new_SC
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|end
op_assign
op_star
id|SC
suffix:semicolon
id|SCNEXT
c_func
(paren
id|end
)paren
suffix:semicolon
id|end
op_assign
id|SCNEXT
c_func
(paren
id|end
)paren
)paren
suffix:semicolon
id|SCNEXT
c_func
(paren
id|end
)paren
op_assign
id|new_SC
suffix:semicolon
)brace
)brace
DECL|function|remove_first_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_first_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
id|ptr
op_assign
op_star
id|SC
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
(brace
op_star
id|SC
op_assign
id|SCNEXT
c_func
(paren
op_star
id|SC
)paren
suffix:semicolon
id|SCNEXT
c_func
(paren
id|ptr
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|remove_lun_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_lun_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
r_int
id|target
comma
r_int
id|lun
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
comma
op_star
id|prev
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
op_star
id|SC
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_logical_and
(paren
(paren
id|ptr-&gt;target
op_ne
id|target
)paren
op_logical_or
(paren
id|ptr-&gt;lun
op_ne
id|lun
)paren
)paren
suffix:semicolon
id|prev
op_assign
id|ptr
comma
id|ptr
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
id|SCNEXT
c_func
(paren
id|prev
)paren
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_else
op_star
id|SC
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|SCNEXT
c_func
(paren
id|ptr
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|remove_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
id|Scsi_Cmnd
op_star
id|SCp
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
comma
op_star
id|prev
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
op_star
id|SC
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_logical_and
id|SCp
op_ne
id|ptr
suffix:semicolon
id|prev
op_assign
id|ptr
comma
id|ptr
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
id|SCNEXT
c_func
(paren
id|prev
)paren
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_else
op_star
id|SC
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|SCNEXT
c_func
(paren
id|ptr
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|ptr
suffix:semicolon
)brace
macro_line|#if defined(PCMCIA) || !defined(MODULE)
DECL|function|aha152x_setup
r_void
id|aha152x_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|setup_count
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: you can only configure up to two controllers&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|setup
(braket
id|setup_count
)braket
dot
id|conf
op_assign
id|str
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|1
ques
c_cond
id|ints
(braket
l_int|1
)braket
suffix:colon
l_int|0x340
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|2
ques
c_cond
id|ints
(braket
l_int|2
)braket
suffix:colon
l_int|11
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|3
ques
c_cond
id|ints
(braket
l_int|3
)braket
suffix:colon
l_int|7
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|4
ques
c_cond
id|ints
(braket
l_int|4
)braket
suffix:colon
l_int|1
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|5
ques
c_cond
id|ints
(braket
l_int|5
)braket
suffix:colon
l_int|1
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|6
ques
c_cond
id|ints
(braket
l_int|6
)braket
suffix:colon
l_int|1
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|7
ques
c_cond
id|ints
(braket
l_int|7
)braket
suffix:colon
id|DELAY_DEFAULT
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|8
ques
c_cond
id|ints
(braket
l_int|8
)braket
suffix:colon
l_int|0
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|9
ques
c_cond
id|ints
(braket
l_int|9
)braket
suffix:colon
id|DEBUG_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|9
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;aha152x: usage: aha152x=&lt;IOBASE&gt;[,&lt;IRQ&gt;[,&lt;SCSI ID&gt;&quot;
l_string|&quot;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt;[,&lt;EXT_TRANS&gt;[,&lt;DEBUG&gt;]]]]]]]]&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|8
)paren
(brace
multiline_comment|/*}*/
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;aha152x: usage: aha152x=&lt;IOBASE&gt;[,&lt;IRQ&gt;[,&lt;SCSI ID&gt;&quot;
l_string|&quot;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt;[,&lt;EXT_TRANS&gt;]]]]]]]&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_else
(brace
id|setup_count
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#if !defined(MODULE)
DECL|function|do_setup
r_static
r_int
id|__init
id|do_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
macro_line|#if defined(AHA152X_DEBUG)
r_int
id|ints
(braket
l_int|11
)braket
suffix:semicolon
macro_line|#else
r_int
id|ints
(braket
l_int|10
)braket
suffix:semicolon
macro_line|#endif
r_int
id|count
op_assign
id|setup_count
suffix:semicolon
id|get_options
c_func
(paren
id|str
comma
r_sizeof
(paren
id|ints
)paren
op_div
r_sizeof
(paren
r_int
)paren
comma
id|ints
)paren
suffix:semicolon
id|aha152x_setup
c_func
(paren
id|str
comma
id|ints
)paren
suffix:semicolon
r_return
id|count
OL
id|setup_count
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;aha152x=&quot;
comma
id|do_setup
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Test, if port_base is valid.&n; *&n; */
DECL|function|aha152x_porttest
r_static
r_int
id|aha152x_porttest
c_func
(paren
r_int
id|io_port
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_port
comma
id|IO_RANGE
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset stack pointer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_STACK
comma
id|i
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset stack pointer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
op_logical_and
id|GETPORT
c_func
(paren
id|io_port
op_plus
id|O_STACK
)paren
op_eq
id|i
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_return
(paren
id|i
op_eq
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|tc1550_porttest
r_static
r_int
id|tc1550_porttest
c_func
(paren
r_int
id|io_port
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_port
comma
id|IO_RANGE
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_TC_DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset stack pointer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_STACK
comma
id|i
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_TC_DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset stack pointer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
op_logical_and
id|GETPORT
c_func
(paren
id|io_port
op_plus
id|O_TC_STACK
)paren
op_eq
id|i
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_return
(paren
id|i
op_eq
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|checksetup
r_static
r_int
id|checksetup
c_func
(paren
r_struct
id|aha152x_setup
op_star
id|setup
)paren
(brace
macro_line|#if !defined(PCMCIA)
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PORT_COUNT
op_logical_and
(paren
id|setup-&gt;io_port
op_ne
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|PORT_COUNT
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|aha152x_porttest
c_func
(paren
id|setup-&gt;io_port
)paren
)paren
(brace
id|setup-&gt;tc1550
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tc1550_porttest
c_func
(paren
id|setup-&gt;io_port
)paren
)paren
(brace
id|setup-&gt;tc1550
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|setup-&gt;irq
OL
id|IRQ_MIN
)paren
op_logical_or
(paren
id|setup-&gt;irq
OG
id|IRQ_MAX
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|setup-&gt;scsiid
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;scsiid
OG
l_int|7
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|setup-&gt;reconnect
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;reconnect
OG
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|setup-&gt;parity
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;parity
OG
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|setup-&gt;synchronous
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;synchronous
OG
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|setup-&gt;ext_trans
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;ext_trans
OG
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|swintr
r_static
r_void
id|swintr
c_func
(paren
r_int
id|irqno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|aha152x_host
(braket
id|irqno
op_minus
id|IRQ_MIN
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: catched software interrupt for unknown controller.&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
op_increment
suffix:semicolon
)brace
DECL|function|aha152x_detect
r_int
id|aha152x_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|i
comma
id|j
comma
id|ok
suffix:semicolon
macro_line|#if defined(AUTOCONF)
id|aha152x_config
id|conf
suffix:semicolon
macro_line|#endif
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;aha152x&quot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRQS
suffix:semicolon
id|i
op_increment
)paren
id|aha152x_host
(braket
id|i
)braket
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|setup_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x: processing commandline: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|setup_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|checksetup
c_func
(paren
op_amp
id|setup
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;&bslash;naha152x: %s&bslash;n&quot;
comma
id|setup
(braket
id|i
)braket
dot
id|conf
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: invalid line&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ok&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(SETUP0)
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
)paren
(brace
r_struct
id|aha152x_setup
id|override
op_assign
id|SETUP0
suffix:semicolon
r_if
c_cond
(paren
id|setup_count
op_eq
l_int|0
op_logical_or
(paren
id|override.io_port
op_ne
id|setup
(braket
l_int|0
)braket
dot
id|io_port
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|checksetup
c_func
(paren
op_amp
id|override
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;&bslash;naha152x: invalid override SETUP0={0x%x,%d,%d,%d,%d,%d,%d,%d}&bslash;n&quot;
comma
id|override.io_port
comma
id|override.irq
comma
id|override.scsiid
comma
id|override.reconnect
comma
id|override.parity
comma
id|override.synchronous
comma
id|override.delay
comma
id|override.ext_trans
)paren
suffix:semicolon
)brace
r_else
id|setup
(braket
id|setup_count
op_increment
)braket
op_assign
id|override
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#if defined(SETUP1)
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
)paren
(brace
r_struct
id|aha152x_setup
id|override
op_assign
id|SETUP1
suffix:semicolon
r_if
c_cond
(paren
id|setup_count
op_eq
l_int|0
op_logical_or
(paren
id|override.io_port
op_ne
id|setup
(braket
l_int|0
)braket
dot
id|io_port
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|checksetup
c_func
(paren
op_amp
id|override
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;&bslash;naha152x: invalid override SETUP1={0x%x,%d,%d,%d,%d,%d,%d,%d}&bslash;n&quot;
comma
id|override.io_port
comma
id|override.irq
comma
id|override.scsiid
comma
id|override.reconnect
comma
id|override.parity
comma
id|override.synchronous
comma
id|override.delay
comma
id|override.ext_trans
)paren
suffix:semicolon
)brace
r_else
id|setup
(braket
id|setup_count
op_increment
)braket
op_assign
id|override
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#if defined(MODULE)
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
op_logical_and
(paren
id|aha152x
(braket
l_int|0
)braket
op_ne
l_int|0
op_logical_or
id|io
(braket
l_int|0
)braket
op_ne
l_int|0
op_logical_or
id|irq
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|aha152x
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|conf
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|aha152x
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|aha152x
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|aha152x
(braket
l_int|2
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|aha152x
(braket
l_int|3
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|aha152x
(braket
l_int|4
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|aha152x
(braket
l_int|5
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|aha152x
(braket
l_int|6
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|aha152x
(braket
l_int|7
)braket
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|aha152x
(braket
l_int|8
)braket
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|io
(braket
l_int|0
)braket
op_ne
l_int|0
op_logical_or
id|irq
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|io
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|io
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|irq
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|scsiid
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|reconnect
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|parity
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|sync
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|delay
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|exttrans
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|debug
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|checksetup
c_func
(paren
op_amp
id|setup
(braket
id|setup_count
)braket
)paren
)paren
id|setup_count
op_increment
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: invalid module params io=0x%x, irq=%d,scsiid=%d,reconnect=%d,parity=%d,sync=%d,delay=%d,exttrans=%d&bslash;n&quot;
comma
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
comma
id|setup
(braket
id|setup_count
)braket
dot
id|irq
comma
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
comma
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
comma
id|setup
(braket
id|setup_count
)braket
dot
id|parity
comma
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
comma
id|setup
(braket
id|setup_count
)braket
dot
id|delay
comma
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
op_logical_and
(paren
id|aha152x1
(braket
l_int|0
)braket
op_ne
l_int|0
op_logical_or
id|io
(braket
l_int|1
)braket
op_ne
l_int|0
op_logical_or
id|irq
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|aha152x1
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|conf
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|aha152x1
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|aha152x1
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|aha152x1
(braket
l_int|2
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|aha152x1
(braket
l_int|3
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|aha152x1
(braket
l_int|4
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|aha152x1
(braket
l_int|5
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|aha152x1
(braket
l_int|6
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|aha152x1
(braket
l_int|7
)braket
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|aha152x1
(braket
l_int|8
)braket
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|io
(braket
l_int|1
)braket
op_ne
l_int|0
op_logical_or
id|irq
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|io
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|io
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|irq
(braket
l_int|1
)braket
suffix:semicolon
)brace
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|scsiid
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|reconnect
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|parity
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|sync
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|delay
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|exttrans
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|debug
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|checksetup
c_func
(paren
op_amp
id|setup
(braket
id|setup_count
)braket
)paren
)paren
id|setup_count
op_increment
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: invalid module params io=0x%x, irq=%d,scsiid=%d,reconnect=%d,parity=%d,sync=%d,delay=%d,exttrans=%d&bslash;n&quot;
comma
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
comma
id|setup
(braket
id|setup_count
)braket
dot
id|irq
comma
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
comma
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
comma
id|setup
(braket
id|setup_count
)braket
dot
id|parity
comma
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
comma
id|setup
(braket
id|setup_count
)braket
dot
id|delay
comma
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(AUTOCONF)
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
)paren
(brace
macro_line|#if !defined(SKIP_BIOSTEST)
id|ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ADDRESS_COUNT
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|SIGNATURE_COUNT
)paren
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|j
op_increment
)paren
id|ok
op_assign
id|isa_check_signature
c_func
(paren
id|addresses
(braket
id|i
)braket
op_plus
id|signatures
(braket
id|j
)braket
dot
id|sig_offset
comma
id|signatures
(braket
id|j
)braket
dot
id|signature
comma
id|signatures
(braket
id|j
)braket
dot
id|sig_length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
op_logical_and
id|setup_count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x: BIOS test: passed, &quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x: &quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* !SKIP_BIOSTEST */
id|ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PORT_COUNT
op_logical_and
id|setup_count
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|setup_count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|setup
(braket
l_int|0
)braket
dot
id|io_port
op_eq
id|ports
(braket
id|i
)braket
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|aha152x_porttest
c_func
(paren
id|ports
(braket
id|i
)braket
)paren
)paren
(brace
id|ok
op_increment
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|ports
(braket
id|i
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|tc1550
op_assign
l_int|0
suffix:semicolon
id|conf.cf_port
op_assign
(paren
id|GETPORT
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
id|O_PORTA
)paren
op_lshift
l_int|8
)paren
op_plus
id|GETPORT
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
id|O_PORTB
)paren
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|IRQ_MIN
op_plus
id|conf.cf_irq
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|conf.cf_id
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|conf.cf_tardisc
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
op_logical_neg
id|conf.cf_parity
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|conf.cf_syncneg
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|DELAY_DEFAULT
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|DEBUG_DEFAULT
suffix:semicolon
macro_line|#endif
id|setup_count
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tc1550_porttest
c_func
(paren
id|ports
(braket
id|i
)braket
)paren
)paren
(brace
id|ok
op_increment
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|ports
(braket
id|i
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|tc1550
op_assign
l_int|1
suffix:semicolon
id|conf.cf_port
op_assign
(paren
id|GETPORT
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
id|O_PORTA
)paren
op_lshift
l_int|8
)paren
op_plus
id|GETPORT
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
id|O_PORTB
)paren
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|IRQ_MIN
op_plus
id|conf.cf_irq
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|conf.cf_id
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|conf.cf_tardisc
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
op_logical_neg
id|conf.cf_parity
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|conf.cf_syncneg
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|DELAY_DEFAULT
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|DEBUG_DEFAULT
suffix:semicolon
macro_line|#endif
id|setup_count
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ok
)paren
id|printk
c_func
(paren
l_string|&quot;auto configuration: ok, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;detected %d controller(s)&bslash;n&quot;
comma
id|setup_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|setup_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
id|aha152x_host
(braket
id|setup
(braket
id|i
)braket
dot
id|irq
op_minus
id|IRQ_MIN
)braket
op_assign
id|shpnt
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|aha152x_hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: scsi_register failed&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|registered_count
op_increment
suffix:semicolon
id|shpnt-&gt;io_port
op_assign
id|setup
(braket
id|i
)braket
dot
id|io_port
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
id|IO_RANGE
suffix:semicolon
id|shpnt-&gt;irq
op_assign
id|setup
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup
(braket
id|i
)braket
dot
id|tc1550
)paren
(brace
id|HOSTIOPORT0
op_assign
id|setup
(braket
id|i
)braket
dot
id|io_port
suffix:semicolon
id|HOSTIOPORT1
op_assign
id|setup
(braket
id|i
)braket
dot
id|io_port
suffix:semicolon
)brace
r_else
(brace
id|HOSTIOPORT0
op_assign
id|setup
(braket
id|i
)braket
dot
id|io_port
op_plus
l_int|0x10
suffix:semicolon
id|HOSTIOPORT1
op_assign
id|setup
(braket
id|i
)braket
dot
id|io_port
op_minus
l_int|0x10
suffix:semicolon
)brace
id|ISSUE_SC
op_assign
l_int|0
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|0
suffix:semicolon
id|DONE_SC
op_assign
l_int|0
suffix:semicolon
id|DISCONNECTED_SC
op_assign
l_int|0
suffix:semicolon
id|QLOCK
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|STATE
op_assign
l_int|0
suffix:semicolon
id|PREVSTATE
op_assign
l_int|0
suffix:semicolon
id|LASTSTATE
op_assign
l_int|0
suffix:semicolon
id|MSGILEN
op_assign
l_int|0
suffix:semicolon
id|MSGOLEN
op_assign
l_int|0
suffix:semicolon
id|RECONNECT
op_assign
id|setup
(braket
id|i
)braket
dot
id|reconnect
suffix:semicolon
id|SYNCHRONOUS
op_assign
id|setup
(braket
id|i
)braket
dot
id|synchronous
suffix:semicolon
id|PARITY
op_assign
id|setup
(braket
id|i
)braket
dot
id|parity
suffix:semicolon
id|DELAY
op_assign
id|setup
(braket
id|i
)braket
dot
id|delay
suffix:semicolon
id|EXT_TRANS
op_assign
id|setup
(braket
id|i
)braket
dot
id|ext_trans
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_assign
id|setup
(braket
id|i
)braket
dot
id|debug
suffix:semicolon
macro_line|#endif
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|in_intr
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|total_commands
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|disconnections
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_any_action
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_old_command
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_new_command
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_done_command
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_with_check_condition
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|idle
suffix:semicolon
id|j
OL
id|maxstate
suffix:semicolon
id|j
op_increment
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count_trans
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|time
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncneg
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIID
comma
id|setup
(braket
id|i
)braket
dot
id|scsiid
op_lshift
l_int|4
)paren
suffix:semicolon
id|shpnt-&gt;this_id
op_assign
id|setup
(braket
id|i
)braket
dot
id|scsiid
suffix:semicolon
r_if
c_cond
(paren
id|setup
(braket
id|i
)braket
dot
id|reconnect
)paren
id|shpnt-&gt;can_queue
op_assign
id|AHA152X_MAXQUEUE
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|shpnt-&gt;hostt-&gt;use_new_eh_code
)paren
(brace
macro_line|#endif
multiline_comment|/* RESET OUT */
id|printk
c_func
(paren
l_string|&quot;aha152x: resetting bus...&bslash;n&quot;
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|SCSIRSTO
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|256
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|DELAY
)paren
suffix:semicolon
macro_line|#if 0
)brace
macro_line|#endif
id|reset_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x%d%s: &quot;
l_string|&quot;vital data: rev=%x, &quot;
l_string|&quot;io=0x%03lx (0x%03lx/0x%03lx), &quot;
l_string|&quot;irq=%d, &quot;
l_string|&quot;scsiid=%d, &quot;
l_string|&quot;reconnect=%s, &quot;
l_string|&quot;parity=%s, &quot;
l_string|&quot;synchronous=%s, &quot;
l_string|&quot;delay=%d, &quot;
l_string|&quot;extended translation=%s&bslash;n&quot;
comma
id|HOSTNO
comma
id|setup
(braket
id|i
)braket
dot
id|tc1550
ques
c_cond
l_string|&quot; (tc1550 mode)&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|GETPORT
c_func
(paren
id|REV
)paren
op_amp
l_int|0x7
comma
id|shpnt-&gt;io_port
comma
id|HOSTIOPORT0
comma
id|HOSTIOPORT1
comma
id|shpnt-&gt;irq
comma
id|shpnt-&gt;this_id
comma
id|RECONNECT
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
id|PARITY
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
id|SYNCHRONOUS
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
id|DELAY
comma
id|EXT_TRANS
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|IO_RANGE
comma
l_string|&quot;aha152x&quot;
)paren
suffix:semicolon
multiline_comment|/* not expecting any interrupts */
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
l_int|0
)paren
suffix:semicolon
id|ok
op_assign
id|request_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|swintr
comma
id|SA_INTERRUPT
comma
l_string|&quot;aha152x&quot;
comma
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ok
op_eq
op_minus
id|EINVAL
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: bad IRQ %d.&bslash;n&quot;
comma
id|HOSTNO
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ok
op_eq
op_minus
id|EBUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: IRQ %d already in use.&bslash;n&quot;
comma
id|HOSTNO
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: Unexpected error code %d on requesting IRQ %d.&bslash;n&quot;
comma
id|HOSTNO
comma
id|ok
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: driver needs an IRQ.&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|registered_count
op_decrement
suffix:semicolon
id|release_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|IO_RANGE
)paren
suffix:semicolon
id|aha152x_host
(braket
id|shpnt-&gt;irq
op_minus
id|IRQ_MIN
)braket
op_assign
l_int|0
suffix:semicolon
id|shpnt
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x%d: trying software interrupt, &quot;
comma
id|HOSTNO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|SWINT
op_or
id|INTEN
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
)paren
(brace
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;lost.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: IRQ %d possibly wrong.  Please verify.&bslash;n&quot;
comma
id|HOSTNO
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
id|registered_count
op_decrement
suffix:semicolon
id|release_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|IO_RANGE
)paren
suffix:semicolon
id|aha152x_host
(braket
id|shpnt-&gt;irq
op_minus
id|IRQ_MIN
)braket
op_assign
l_int|0
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|shpnt
op_assign
l_int|NULL
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ok.&bslash;n&quot;
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
multiline_comment|/* clear interrupts */
id|SETPORT
c_func
(paren
id|SSTAT0
comma
l_int|0x7f
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
l_int|0xef
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;aha152x&quot;
comma
id|shpnt
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: failed to reassign interrupt.&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|registered_count
op_decrement
suffix:semicolon
id|release_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|IO_RANGE
)paren
suffix:semicolon
id|shpnt
op_assign
id|aha152x_host
(braket
id|shpnt-&gt;irq
op_minus
id|IRQ_MIN
)braket
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_return
id|registered_count
OG
l_int|0
suffix:semicolon
)brace
DECL|function|aha152x_release
r_int
id|aha152x_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|shpnt-&gt;irq
)paren
id|free_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shpnt-&gt;io_port
)paren
id|release_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|IO_RANGE
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * setup controller to generate interrupts depending&n; * on current state (lock has to be acquired)&n; *&n; */
DECL|function|setup_expected_interrupts
r_static
r_int
id|setup_expected_interrupts
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|ASSERT_LOCK
c_func
(paren
op_amp
id|QLOCK
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|selecting
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_intr
comma
id|DEBUG_LEAD
l_string|&quot;expecting: (seldo) (seltimo) (seldi)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|SELTO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|ENSELDO
op_or
(paren
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENSELTIMO
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
id|debug_intr
comma
id|DEBUG_LEAD
l_string|&quot;expecting: (phase change) (busfree) %s&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|spiordy
ques
c_cond
l_string|&quot;(spiordy)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|spiordy
)paren
ques
c_cond
id|ENSPIORDY
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENSCSIRST
op_or
id|ENSCSIPERR
op_or
id|ENBUSFREE
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|STATE
op_eq
id|seldi
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_intr
comma
id|DEBUG_LEAD
l_string|&quot;expecting: (phase change) (identify)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENSCSIRST
op_or
id|ENSCSIPERR
op_or
id|ENBUSFREE
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
id|debug_intr
comma
id|DEBUG_LEAD
l_string|&quot;expecting: %s %s&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|DISCONNECTED_SC
ques
c_cond
l_string|&quot;(reselection)&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|ISSUE_SC
ques
c_cond
l_string|&quot;(busfree)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENSCSIRST
op_or
(paren
(paren
id|ISSUE_SC
op_logical_or
id|DONE_SC
)paren
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|in_intr
)paren
(brace
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
)brace
r_return
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *  Queue a command and setup interrupts for a free bus.&n; */
DECL|function|aha152x_internal_queue
r_int
id|aha152x_internal_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_struct
id|semaphore
op_star
id|sem
comma
r_int
id|phase
comma
id|Scsi_Cmnd
op_star
id|done_SC
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queue
)paren
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;queue: cmd_len=%d pieces=%d size=%u cmnd=&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
comma
id|SCpnt-&gt;cmd_len
comma
id|SCpnt-&gt;use_sg
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|SCpnt-&gt;resid
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|SCpnt-&gt;SCp.phase
op_assign
id|not_issued
op_or
id|phase
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
id|CHECK_CONDITION
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.have_data_in
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|aha152x_scdata
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;host_scribble
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;allocation failed&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|SCNEXT
c_func
(paren
id|SCpnt
)paren
op_assign
l_int|0
suffix:semicolon
id|SCDONE
c_func
(paren
id|SCpnt
)paren
op_assign
id|done_SC
suffix:semicolon
id|SCSEM
c_func
(paren
id|SCpnt
)paren
op_assign
id|sem
suffix:semicolon
multiline_comment|/* setup scratch area&n;&t;   SCp.ptr              : buffer pointer&n;&t;   SCp.this_residual    : buffer length&n;&t;   SCp.buffer           : next buffer&n;&t;   SCp.buffers_residual : left buffers in list&n;&t;   SCp.phase            : current state of the command */
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
)brace
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|total_commands
op_increment
suffix:semicolon
macro_line|#endif
multiline_comment|/* Turn led on, when this is the first command. */
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_eq
l_int|1
)paren
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|1
)paren
suffix:semicolon
id|append_SC
c_func
(paren
op_amp
id|ISSUE_SC
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|in_intr
)paren
(brace
id|setup_expected_interrupts
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aha152x_queue
r_int
id|aha152x_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|REQUEST_SENSE
)paren
(brace
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
r_return
id|aha152x_internal_queue
c_func
(paren
id|SCpnt
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|done
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  run a command&n; *&n; */
DECL|function|internal_done
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
macro_line|#if 0
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|INFO_LEAD
l_string|&quot;internal_done called&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|SCSEM
c_func
(paren
id|SCpnt
)paren
)paren
(brace
id|up
c_func
(paren
id|SCSEM
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|aha152x_command
r_int
id|aha152x_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
id|aha152x_internal_queue
c_func
(paren
id|SCpnt
comma
op_amp
id|sem
comma
l_int|0
comma
l_int|0
comma
id|internal_done
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; *  Abort a command&n; *&n; */
DECL|function|aha152x_abort
r_int
id|aha152x_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;abort(%p): no host structure&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
comma
id|SCpnt
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_eh
)paren
(brace
id|printk
c_func
(paren
id|DEBUG_LEAD
l_string|&quot;abort(%p)&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
comma
id|SCpnt
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ptr
op_assign
id|remove_SC
c_func
(paren
op_amp
id|ISSUE_SC
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;not yet issued - SUCCESS&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|0
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|SCpnt-&gt;host_scribble
)paren
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|0
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME:&n;&t; * for current command: queue ABORT for message out and raise ATN&n;&t; * for disconnected command: pseudo SC with ABORT message or ABORT on reselection?&n;&t; *&n;&t; */
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;cannot abort running or disconnected command&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
DECL|function|timer_expired
r_static
r_void
id|timer_expired
c_func
(paren
r_int
r_int
id|p
)paren
(brace
r_struct
id|semaphore
op_star
id|sem
op_assign
(paren
r_void
op_star
)paren
id|p
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x: timer expired&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
id|sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset a device&n; *&n; * FIXME: never seen this live. might lockup...&n; *&n; */
DECL|function|aha152x_device_reset
r_int
id|aha152x_device_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
r_struct
id|timer_list
id|timer
suffix:semicolon
id|Scsi_Cmnd
id|cmnd
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_eh
)paren
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;aha152x_device_reset(%p)&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
comma
id|SCpnt
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|CURRENT_SC
op_eq
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;cannot reset current device&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|cmnd.cmd_len
op_assign
l_int|0
suffix:semicolon
id|cmnd.host
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|cmnd.target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|cmnd.lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|cmnd.use_sg
op_assign
l_int|0
suffix:semicolon
id|cmnd.request_buffer
op_assign
l_int|0
suffix:semicolon
id|cmnd.request_bufflen
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|sem
suffix:semicolon
id|timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
multiline_comment|/* 10s */
id|timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|timer_expired
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|aha152x_internal_queue
c_func
(paren
op_amp
id|cmnd
comma
op_amp
id|sem
comma
id|resetting
comma
l_int|0
comma
id|internal_done
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmnd.SCp.phase
op_amp
id|resetted
)paren
(brace
r_return
id|SUCCESS
suffix:semicolon
)brace
r_else
(brace
r_return
id|FAILED
suffix:semicolon
)brace
)brace
DECL|function|free_hard_reset_SCs
r_void
id|free_hard_reset_SCs
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
id|Scsi_Cmnd
op_star
op_star
id|SCs
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ptr
op_assign
op_star
id|SCs
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
(brace
id|Scsi_Cmnd
op_star
id|next
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr-&gt;device-&gt;soft_reset
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;disconnected command %p removed&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|ptr
)paren
comma
id|ptr
)paren
suffix:semicolon
id|remove_SC
c_func
(paren
id|SCs
comma
id|ptr
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
id|kfree
c_func
(paren
id|ptr-&gt;host_scribble
)paren
suffix:semicolon
id|ptr-&gt;host_scribble
op_assign
l_int|0
suffix:semicolon
)brace
id|ptr
op_assign
id|next
suffix:semicolon
)brace
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset the bus&n; *&n; */
DECL|function|aha152x_bus_reset
r_int
id|aha152x_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_eh
)paren
(brace
id|printk
c_func
(paren
id|DEBUG_LEAD
l_string|&quot;aha152x_bus_reset(%p)&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
comma
id|SCpnt
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
macro_line|#endif
id|free_hard_reset_SCs
c_func
(paren
id|shpnt
comma
op_amp
id|ISSUE_SC
)paren
suffix:semicolon
id|free_hard_reset_SCs
c_func
(paren
id|shpnt
comma
op_amp
id|DISCONNECTED_SC
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;resetting bus&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|SCSIRSTO
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|256
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|DELAY
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;bus reset returns&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|setup_expected_interrupts
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_eq
l_int|0
)paren
(brace
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|0
)paren
suffix:semicolon
)brace
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; *  Restore default values to the AIC-6260 registers and reset the fifos&n; *&n; */
DECL|function|reset_ports
r_static
r_void
id|reset_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* disable interrupts */
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|RSTFIFO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL1
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
l_int|0
)paren
suffix:semicolon
id|SETRATE
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* clear all interrupt conditions */
id|SETPORT
c_func
(paren
id|SSTAT0
comma
l_int|0x7f
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
l_int|0xef
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT4
comma
id|SYNCERR
op_or
id|FWERR
op_or
id|FRERR
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|BRSTCNTRL
comma
l_int|0xf1
)paren
suffix:semicolon
multiline_comment|/* clear SCSI fifos and transfer count */
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRCH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|setup_expected_interrupts
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset the host (bus and controller)&n; *&n; */
DECL|function|aha152x_host_reset
r_int
id|aha152x_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
macro_line|#if defined(AHA152X_DEBUG)
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
macro_line|#endif
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;aha152x_host_reset(%p)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
comma
id|SCpnt
)paren
suffix:semicolon
id|aha152x_bus_reset
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;resetting ports&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|SCpnt
)paren
)paren
suffix:semicolon
id|reset_ports
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the &quot;logical geometry&quot;&n; *&n; */
DECL|function|aha152x_biosparam
r_int
id|aha152x_biosparam
c_func
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|info_array
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|disk-&gt;device-&gt;host
suffix:semicolon
multiline_comment|/* try default translation */
id|info_array
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
l_int|64
op_star
l_int|32
)paren
suffix:semicolon
multiline_comment|/* for disks &gt;1GB do some guessing */
r_if
c_cond
(paren
id|info_array
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
(brace
r_int
id|info
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* try to figure out the geometry from the partition table */
r_if
c_cond
(paren
id|scsicam_bios_param
c_func
(paren
id|disk
comma
id|dev
comma
id|info
)paren
OL
l_int|0
op_logical_or
op_logical_neg
(paren
(paren
id|info
(braket
l_int|0
)braket
op_eq
l_int|64
op_logical_and
id|info
(braket
l_int|1
)braket
op_eq
l_int|32
)paren
op_logical_or
(paren
id|info
(braket
l_int|0
)braket
op_eq
l_int|255
op_logical_and
id|info
(braket
l_int|1
)braket
op_eq
l_int|63
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|EXT_TRANS
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;aha152x: unable to verify geometry for disk with &gt;1GB.&bslash;n&quot;
l_string|&quot;         using extended translation.&bslash;n&quot;
)paren
suffix:semicolon
id|info_array
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;aha152x: unable to verify geometry for disk with &gt;1GB.&bslash;n&quot;
l_string|&quot;         Using default translation. Please verify yourself.&bslash;n&quot;
l_string|&quot;         Perhaps you need to enable extended translation in the driver.&bslash;n&quot;
l_string|&quot;         See /usr/src/linux/drivers/scsi/README.aha152x for details.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|info_array
(braket
l_int|0
)braket
op_assign
id|info
(braket
l_int|0
)braket
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
id|info
(braket
l_int|1
)braket
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|info
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|0
)braket
op_eq
l_int|255
op_logical_and
op_logical_neg
id|EXT_TRANS
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;aha152x: current partition table is using extended translation.&bslash;n&quot;
l_string|&quot;         using it also, although it&squot;s not explictly enabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Internal done function&n; *&n; */
DECL|function|done
r_static
r_void
id|done
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
id|error
)paren
(brace
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
r_if
c_cond
(paren
id|DONE_SC
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;there&squot;s already a completed command %p - will cause abort&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|DONE_SC
)paren
suffix:semicolon
)brace
id|DONE_SC
op_assign
id|CURRENT_SC
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|0
suffix:semicolon
id|DONE_SC-&gt;result
op_assign
id|error
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: done() called outside of command&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|aha152x_tq
r_static
r_struct
id|tq_struct
id|aha152x_tq
suffix:semicolon
multiline_comment|/*&n; * Run service completions on the card with interrupts enabled.&n; *&n; */
DECL|function|run
r_static
r_void
id|run
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|aha152x_host
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shpnt
op_logical_and
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|service
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|service
op_assign
l_int|0
suffix:semicolon
id|complete
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *    Interrupts handler&n; *&n; */
DECL|function|intr
r_static
r_void
id|intr
c_func
(paren
r_int
id|irqno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|aha152x_host
(braket
id|irqno
op_minus
id|IRQ_MIN
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x: catched interrupt for unknown controller.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* no more interrupts from the controller, while we&squot;re busy.&n;&t;   INTEN is restored by the BH handler */
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* check if there is already something to be&n;           serviced; should not happen */
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|service
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: lost interrupt (%d)&bslash;n&quot;
comma
id|HOSTNO
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|service
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Poke the BH handler */
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|service
op_increment
suffix:semicolon
id|aha152x_tq.routine
op_assign
(paren
r_void
op_star
)paren
id|run
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|aha152x_tq
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * busfree phase&n; * - handle completition/disconnection/error of current command&n; * - start selection for next command (if any)&n; */
DECL|function|busfree_run
r_static
r_void
id|busfree_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
r_int
id|action
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRCH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRBUSFREE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
macro_line|#if defined(AHA152X_STAT)
id|action
op_increment
suffix:semicolon
macro_line|#endif
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|syncneg
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|completed
)paren
(brace
multiline_comment|/* target sent COMMAND COMPLETE */
id|done
c_func
(paren
id|shpnt
comma
(paren
id|CURRENT_SC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|CURRENT_SC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|aborted
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;ABORT sent&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
(paren
id|CURRENT_SC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|CURRENT_SC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|resetted
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|DEBUG_LEAD
l_string|&quot;BUS DEVICE RESET sent&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
(paren
id|CURRENT_SC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|CURRENT_SC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|disconnected
)paren
(brace
multiline_comment|/* target sent DISCONNECT */
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;target disconnected at %d/%d&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;resid
comma
id|CURRENT_SC-&gt;request_bufflen
)paren
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|disconnections
op_increment
suffix:semicolon
macro_line|#endif
id|append_SC
c_func
(paren
op_amp
id|DISCONNECTED_SC
comma
id|CURRENT_SC
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|done
c_func
(paren
id|shpnt
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
macro_line|#if defined(AHA152X_STAT)
)brace
r_else
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_old_command
op_increment
suffix:semicolon
macro_line|#endif
)brace
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DONE_SC
)paren
(brace
macro_line|#if defined(AHA152X_STAT)
id|action
op_increment
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|SCDONE
c_func
(paren
id|DONE_SC
)paren
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
op_assign
id|DONE_SC
suffix:semicolon
id|DONE_SC
op_assign
id|SCDONE
c_func
(paren
id|DONE_SC
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_eh
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;received sense: &quot;
comma
id|CMDINFO
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
id|print_sense
c_func
(paren
l_string|&quot;bh&quot;
comma
id|DONE_SC
)paren
suffix:semicolon
)brace
macro_line|#endif
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* turn led off */
id|kfree
c_func
(paren
id|ptr-&gt;host_scribble
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|DONE_SC-&gt;SCp.Status
op_eq
l_int|0x02
)paren
(brace
macro_line|#if defined(AHA152X_STAT)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_with_check_condition
op_increment
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|ERR_LEAD
l_string|&quot;CHECK CONDITION found&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|DONE_SC
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|DONE_SC-&gt;SCp.Status
op_amp
id|not_issued
)paren
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmnd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmnd
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
op_assign
id|DONE_SC
suffix:semicolon
id|DONE_SC
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|ERR_LEAD
l_string|&quot;requesting sense&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
id|cmnd-&gt;cmnd
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|cmnd-&gt;cmnd
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|cmnd-&gt;cmnd
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|cmnd-&gt;cmnd
(braket
l_int|4
)braket
op_assign
r_sizeof
(paren
id|ptr-&gt;sense_buffer
)paren
suffix:semicolon
id|cmnd-&gt;cmnd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|cmnd-&gt;cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmnd-&gt;host
op_assign
id|ptr-&gt;host
suffix:semicolon
id|cmnd-&gt;target
op_assign
id|ptr-&gt;target
suffix:semicolon
id|cmnd-&gt;lun
op_assign
id|ptr-&gt;lun
suffix:semicolon
id|cmnd-&gt;use_sg
op_assign
l_int|0
suffix:semicolon
id|cmnd-&gt;request_buffer
op_assign
id|ptr-&gt;sense_buffer
suffix:semicolon
id|cmnd-&gt;request_bufflen
op_assign
r_sizeof
(paren
id|ptr-&gt;sense_buffer
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|aha152x_internal_queue
c_func
(paren
id|cmnd
comma
l_int|0
comma
l_int|0
comma
id|ptr
comma
id|internal_done
)paren
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;allocation failed&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmnd
)paren
(brace
id|kfree
c_func
(paren
id|cmnd
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
macro_line|#if 0
id|DPRINTK
c_func
(paren
id|debug_eh
comma
id|ERR_LEAD
l_string|&quot;command not issued - CHECK CONDITION ignored&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|DONE_SC
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;
)brace
)brace
r_if
c_cond
(paren
id|DONE_SC
op_logical_and
id|DONE_SC-&gt;scsi_done
)paren
(brace
multiline_comment|/* turn led off, when no commands are in the driver */
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* turn led off */
id|kfree
c_func
(paren
id|DONE_SC-&gt;host_scribble
)paren
suffix:semicolon
id|DONE_SC-&gt;host_scribble
op_assign
l_int|0
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_done
comma
id|DEBUG_LEAD
l_string|&quot;calling scsi_done(%p)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|DONE_SC
)paren
comma
id|DONE_SC
)paren
suffix:semicolon
id|DONE_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|DONE_SC
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_done
comma
id|DEBUG_LEAD
l_string|&quot;scsi_done(%p) returned&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|DONE_SC
)paren
comma
id|DONE_SC
)paren
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|DONE_SC
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
)brace
r_else
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_done_command
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|ISSUE_SC
)paren
(brace
id|CURRENT_SC
op_assign
id|remove_first_SC
c_func
(paren
op_amp
id|ISSUE_SC
)paren
suffix:semicolon
)brace
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
macro_line|#if defined(AHA152X_STAT)
id|action
op_increment
suffix:semicolon
macro_line|#endif
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|selecting
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;selecting target&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
multiline_comment|/* clear selection timeout */
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|SELTO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSIID
comma
(paren
id|shpnt-&gt;this_id
op_lshift
id|OID_
)paren
op_or
id|CURRENT_SC-&gt;target
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL1
comma
(paren
id|PARITY
ques
c_cond
id|ENSPCHK
suffix:colon
l_int|0
)paren
op_or
id|ENSTIMER
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|ENSELO
op_or
id|ENAUTOATNO
op_or
(paren
id|DISCONNECTED_SC
ques
c_cond
id|ENRESELI
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if defined(AHA152X_STAT)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_new_command
op_increment
suffix:semicolon
macro_line|#endif
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENRESELI
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#if defined(AHA152X_STAT)
r_if
c_cond
(paren
op_logical_neg
id|action
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_any_action
op_increment
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * Selection done (OUT)&n; * - queue IDENTIFY message and SDTR to selected target for message out&n; *   (ATN asserted automagically via ENAUTOATNO in busfree())&n; */
DECL|function|seldo_run
r_static
r_void
id|seldo_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|SETPORT
c_func
(paren
id|SCSISIG
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRBUSFREE
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRPHASECHG
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
(paren
id|selecting
op_or
id|not_issued
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SELDO
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;aha152x: passing bus free condition&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SSTAT0
comma
id|CLRSELDO
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|IDENTIFY
c_func
(paren
id|RECONNECT
comma
id|CURRENT_SC-&gt;lun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|aborting
)paren
(brace
id|ADDMSGO
c_func
(paren
id|ABORT
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|resetting
)paren
(brace
id|ADDMSGO
c_func
(paren
id|BUS_DEVICE_RESET
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SYNCNEG
op_eq
l_int|0
op_logical_and
id|SYNCHRONOUS
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|syncneg
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|EXTENDED_MESSAGE
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|EXTENDED_SDTR
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* 200ns */
id|ADDMSGO
c_func
(paren
l_int|8
)paren
suffix:semicolon
multiline_comment|/* 8 byte req/ack offset */
id|SYNCNEG
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* negotiation in progress */
)brace
id|SETRATE
c_func
(paren
id|SYNCRATE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Selection timeout&n; * - return command to mid-level with failure cause&n; *&n; */
DECL|function|selto_run
r_static
r_void
id|selto_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRSELTIMO
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;selection timeout&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;!CURRENT_SC&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|selecting
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|aborted
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;aborted&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SELINGO
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;arbitration not won&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ARBITRATION won, but SELECTION failed */
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;selection failed&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Selection in done&n; * - put current command back to issue queue&n; *   (reconnection of a disconnected nexus instead&n; *    of successful selection out)&n; *&n; */
DECL|function|seldi_run
r_static
r_void
id|seldi_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|selid
suffix:semicolon
r_int
id|target
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT0
comma
id|CLRSELDI
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRBUSFREE
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRPHASECHG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|not_issued
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;command should not have been issued yet&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|ERR_LEAD
l_string|&quot;command requeued - reselection&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|append_SC
c_func
(paren
op_amp
id|ISSUE_SC
comma
id|CURRENT_SC
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|DISCONNECTED_SC
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;unexpected SELDI &quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|RECONN_TARGET
op_assign
op_minus
l_int|1
suffix:semicolon
id|selid
op_assign
id|GETPORT
c_func
(paren
id|SELID
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
id|shpnt-&gt;this_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|selid
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x%d: target id unknown (%02x)&bslash;n&quot;
comma
id|HOSTNO
comma
id|selid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|target
op_assign
l_int|7
suffix:semicolon
op_logical_neg
(paren
id|selid
op_amp
(paren
l_int|1
op_lshift
id|target
)paren
)paren
suffix:semicolon
id|target
op_decrement
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|selid
op_amp
op_complement
(paren
l_int|1
op_lshift
id|target
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x%d: multiple targets reconnected (%02x)&bslash;n&quot;
comma
id|HOSTNO
comma
id|selid
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIID
comma
(paren
id|shpnt-&gt;this_id
op_lshift
id|OID_
)paren
op_or
id|target
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETRATE
c_func
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|target
)braket
)paren
suffix:semicolon
id|RECONN_TARGET
op_assign
id|target
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_selection
comma
id|DEBUG_LEAD
l_string|&quot;target %d reselected (%02x).&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|target
comma
id|selid
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * message in phase&n; * - handle initial message after reconnection to identify&n; *   reconnecting nexus&n; * - queue command on DISCONNECTED_SC on DISCONNECT message&n; * - set completed flag on COMMAND COMPLETE&n; *   (other completition code moved to busfree_run)&n; * - handle response to SDTR&n; * - clear synchronous transfer agreements on BUS RESET&n; *&n; * FIXME: what about SAVE POINTERS, RESTORE POINTERS?&n; *&n; */
DECL|function|msgi_run
r_static
r_void
id|msgi_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|sstat1
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sstat1
op_amp
(paren
id|PHASECHG
op_or
id|PHASEMIS
op_or
id|BUSFREE
)paren
op_logical_or
op_logical_neg
(paren
id|sstat1
op_amp
id|REQINIT
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SPIORDY
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_msgi
comma
id|DEBUG_LEAD
l_string|&quot;!SPIORDY&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ADDMSGI
c_func
(paren
id|GETPORT
c_func
(paren
id|SCSIDAT
)paren
)paren
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgi
)paren
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;inbound message %02x &quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|MSGI
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|print_msg
c_func
(paren
op_amp
id|MSGI
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
r_if
c_cond
(paren
id|LASTSTATE
op_ne
id|seldi
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: message in w/o current command not after reselection&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; &t; &t; * Handle reselection&n;&t; &t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|MSGI
c_func
(paren
l_int|0
)paren
op_amp
id|IDENTIFY_BASE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: target didn&squot;t identify after reselection&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|CURRENT_SC
op_assign
id|remove_lun_SC
c_func
(paren
op_amp
id|DISCONNECTED_SC
comma
id|RECONN_TARGET
comma
id|MSGI
c_func
(paren
l_int|0
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha152x%d: no disconnected command for target %d/%d&bslash;n&quot;
comma
id|HOSTNO
comma
id|RECONN_TARGET
comma
id|MSGI
c_func
(paren
l_int|0
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|debug_msgi
comma
id|DEBUG_LEAD
l_string|&quot;target reconnected&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.Message
op_assign
id|MSGI
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|disconnected
suffix:semicolon
id|MSGILEN
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* next message if any */
r_continue
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.Message
op_assign
id|MSGI
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|MSGI
c_func
(paren
l_int|0
)paren
)paren
(brace
r_case
id|DISCONNECT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|RECONNECT
)paren
id|printk
c_func
(paren
id|WARN_LEAD
l_string|&quot;target was not allowed to disconnect&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|disconnected
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COMMAND_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|completed
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_msgi
comma
id|DEBUG_LEAD
l_string|&quot;again COMMAND COMPLETE&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|completed
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
r_if
c_cond
(paren
id|SYNCNEG
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;Synchronous Data Transfer Request was rejected&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|SYNCNEG
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* negotiation completed */
)brace
r_else
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;inbound message (MESSAGE REJECT)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
r_break
suffix:semicolon
r_case
id|RESTORE_POINTERS
suffix:colon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_if
c_cond
(paren
id|MSGILEN
OL
l_int|2
op_logical_or
id|MSGILEN
OL
id|MSGI
c_func
(paren
l_int|1
)paren
op_plus
l_int|2
)paren
(brace
multiline_comment|/* not yet completed */
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|MSGI
c_func
(paren
l_int|2
)paren
)paren
(brace
r_case
id|EXTENDED_SDTR
suffix:colon
(brace
r_int
id|ticks
suffix:semicolon
r_if
c_cond
(paren
id|MSGI
c_func
(paren
l_int|1
)paren
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;SDTR message length!=3&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
id|INFO_LEAD
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|print_msg
c_func
(paren
op_amp
id|MSGI
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ticks
op_assign
(paren
id|MSGI
c_func
(paren
l_int|3
)paren
op_star
l_int|4
op_plus
l_int|49
)paren
op_div
l_int|50
suffix:semicolon
r_if
c_cond
(paren
id|syncneg
)paren
(brace
multiline_comment|/* negotiation in progress */
r_if
c_cond
(paren
id|ticks
OG
l_int|9
op_logical_or
id|MSGI
c_func
(paren
l_int|4
)paren
template_param
l_int|8
)paren
(brace
id|ADDMSGO
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;received Synchronous Data Transfer Request invalid - rejected&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SYNCRATE
op_or_assign
(paren
(paren
id|ticks
op_minus
l_int|2
)paren
op_lshift
l_int|4
)paren
op_plus
id|MSGI
c_func
(paren
l_int|4
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ticks
op_le
l_int|9
op_logical_and
id|MSGI
c_func
(paren
l_int|4
)paren
op_ge
l_int|1
)paren
(brace
id|ADDMSGO
c_func
(paren
id|EXTENDED_MESSAGE
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|EXTENDED_SDTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ticks
OL
l_int|4
)paren
(brace
id|ticks
op_assign
l_int|4
suffix:semicolon
id|ADDMSGO
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
r_else
id|ADDMSGO
c_func
(paren
id|MSGI
c_func
(paren
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MSGI
c_func
(paren
l_int|4
)paren
OG
l_int|8
)paren
id|MSGI
c_func
(paren
l_int|4
)paren
op_assign
l_int|8
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|MSGI
c_func
(paren
l_int|4
)paren
)paren
suffix:semicolon
id|SYNCRATE
op_or_assign
(paren
(paren
id|ticks
op_minus
l_int|2
)paren
op_lshift
l_int|4
)paren
op_plus
id|MSGI
c_func
(paren
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* requested SDTR is too slow, do it asynchronously */
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;Synchronous Data Transfer Request too slow - Rejecting&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
)brace
id|SYNCNEG
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* negotiation completed */
id|SETRATE
c_func
(paren
id|SYNCRATE
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUS_DEVICE_RESET
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncneg
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|EXTENDED_MODIFY_DATA_POINTER
suffix:colon
r_case
id|EXTENDED_EXTENDED_IDENTIFY
suffix:colon
r_case
id|EXTENDED_WDTR
suffix:colon
r_default
suffix:colon
id|ADDMSGO
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|MSGILEN
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|msgi_end
r_static
r_void
id|msgi_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|MSGILEN
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|WARN_LEAD
l_string|&quot;target left before message completed (%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|MSGILEN
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSGOLEN
OG
l_int|0
op_logical_and
op_logical_neg
(paren
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
op_amp
id|BUSFREE
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_msgi
comma
id|DEBUG_LEAD
l_string|&quot;msgo pending&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
id|P_MSGI
op_or
id|SIG_ATNO
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * message out phase&n; *&n; */
DECL|function|msgo_init
r_static
r_void
id|msgo_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|MSGOLEN
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|syncneg
)paren
op_logical_and
id|SYNCNEG
op_eq
l_int|2
op_logical_and
id|SYNCRATE
op_eq
l_int|0
)paren
(brace
id|ADDMSGO
c_func
(paren
id|IDENTIFY
c_func
(paren
id|RECONNECT
comma
id|CURRENT_SC-&gt;lun
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;unexpected MESSAGE OUT phase; rejecting&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|ADDMSGO
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
)brace
)brace
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgo
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|DEBUG_LEAD
l_string|&quot;messages( &quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MSGOLEN
suffix:semicolon
id|i
op_add_assign
id|print_msg
c_func
(paren
op_amp
id|MSGO
c_func
(paren
id|i
)paren
)paren
comma
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * message out phase&n; *&n; */
DECL|function|msgo_run
r_static
r_void
id|msgo_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|MSGO_I
op_eq
id|MSGOLEN
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_msgo
comma
id|DEBUG_LEAD
l_string|&quot;messages all sent (%d/%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|MSGO_I
comma
id|MSGOLEN
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|MSGO_I
OL
id|MSGOLEN
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_msgo
comma
id|DEBUG_LEAD
l_string|&quot;message byte %02x (%d/%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|MSGO
c_func
(paren
id|MSGO_I
)paren
comma
id|MSGO_I
comma
id|MSGOLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SPIORDY
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_msgo
comma
id|DEBUG_LEAD
l_string|&quot;!SPIORDY&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSGO_I
op_eq
id|MSGOLEN
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Leave MESSAGE OUT after transfer */
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRATNO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSGO
c_func
(paren
id|MSGO_I
)paren
op_amp
id|IDENTIFY_BASE
)paren
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|identified
suffix:semicolon
r_if
c_cond
(paren
id|MSGO
c_func
(paren
id|MSGO_I
)paren
op_eq
id|ABORT
)paren
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|aborted
suffix:semicolon
r_if
c_cond
(paren
id|MSGO
c_func
(paren
id|MSGO_I
)paren
op_eq
id|BUS_DEVICE_RESET
)paren
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|resetted
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSIDAT
comma
id|MSGO
c_func
(paren
id|MSGO_I
op_increment
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|msgo_end
r_static
r_void
id|msgo_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|MSGO_I
OL
id|MSGOLEN
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;message sent incompletely (%d/%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|MSGO_I
comma
id|MSGOLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SYNCNEG
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;Synchronous Data Transfer Request was rejected&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|SYNCNEG
op_assign
l_int|2
suffix:semicolon
)brace
)brace
id|MSGO_I
op_assign
l_int|0
suffix:semicolon
id|MSGOLEN
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * command phase&n; *&n; */
DECL|function|cmd_init
r_static
r_void
id|cmd_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.sent_command
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;command already sent&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_cmd
)paren
(brace
id|printk
c_func
(paren
id|DEBUG_LEAD
l_string|&quot;cmd_init: &quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|CURRENT_SC-&gt;cmnd
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CMD_I
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * command phase&n; *&n; */
DECL|function|cmd_run
r_static
r_void
id|cmd_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|CMD_I
op_eq
id|CURRENT_SC-&gt;cmd_len
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_cmd
comma
id|DEBUG_LEAD
l_string|&quot;command already completely sent (%d/%d)&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CMD_I
comma
id|CURRENT_SC-&gt;cmd_len
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CMD_I
OL
id|CURRENT_SC-&gt;cmd_len
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_cmd
comma
id|DEBUG_LEAD
l_string|&quot;command byte %02x (%d/%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;cmnd
(braket
id|CMD_I
)braket
comma
id|CMD_I
comma
id|CURRENT_SC-&gt;cmd_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SPIORDY
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_cmd
comma
id|DEBUG_LEAD
l_string|&quot;!SPIORDY&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIDAT
comma
id|CURRENT_SC-&gt;cmnd
(braket
id|CMD_I
op_increment
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|cmd_end
r_static
r_void
id|cmd_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|CMD_I
OL
id|CURRENT_SC-&gt;cmd_len
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;command sent incompletely (%d/%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CMD_I
comma
id|CURRENT_SC-&gt;cmd_len
)paren
suffix:semicolon
)brace
r_else
id|CURRENT_SC-&gt;SCp.sent_command
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * status phase&n; *&n; */
DECL|function|status_run
r_static
r_void
id|status_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SPIORDY
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_status
comma
id|DEBUG_LEAD
l_string|&quot;!SPIORDY&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.Status
op_assign
id|GETPORT
c_func
(paren
id|SCSIDAT
)paren
suffix:semicolon
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_status
)paren
(brace
id|printk
c_func
(paren
id|DEBUG_LEAD
l_string|&quot;inbound status %02x &quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;SCp.Status
)paren
suffix:semicolon
id|print_status
c_func
(paren
id|CURRENT_SC-&gt;SCp.Status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * data in phase&n; *&n; */
DECL|function|datai_init
r_static
r_void
id|datai_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|RSTFIFO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|RSTFIFO
op_or
id|ENDMA
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|SCSIEN
op_or
id|DMAEN
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENSCSIPERR
op_or
id|ENSCSIRST
op_or
id|ENPHASEMIS
op_or
id|ENBUSFREE
)paren
suffix:semicolon
id|DATA_LEN
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_datai
comma
id|DEBUG_LEAD
l_string|&quot;datai_init: request_bufflen=%d resid=%d&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;request_bufflen
comma
id|CURRENT_SC-&gt;resid
)paren
suffix:semicolon
)brace
DECL|function|datai_run
r_static
r_void
id|datai_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
r_int
id|the_time
suffix:semicolon
r_int
id|fifodata
comma
id|data_count
suffix:semicolon
multiline_comment|/*&n;&t; * loop while the phase persists or the fifos are not empty&n;&t; *&n;&t; */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
op_logical_or
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
)paren
op_logical_or
id|TESTLO
c_func
(paren
id|SSTAT2
comma
id|SEMPTY
)paren
)paren
(brace
multiline_comment|/* FIXME: maybe this should be done by setting up&n;&t;&t; * STCNT to trigger ENSWRAP interrupt, instead of&n;&t;&t; * polling for DFIFOFULL&n;&t;&t; */
id|the_time
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOFULL
op_or
id|INTSTAT
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|the_time
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOFULL
op_or
id|INTSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;datai timeout&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|DFIFOFULL
)paren
)paren
(brace
id|fifodata
op_assign
l_int|128
suffix:semicolon
)brace
r_else
(brace
id|the_time
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|SSTAT2
comma
id|SEMPTY
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|the_time
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT2
comma
id|SEMPTY
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;datai sempty timeout&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fifodata
op_assign
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.this_residual
OG
l_int|0
)paren
(brace
r_while
c_loop
(paren
id|fifodata
OG
l_int|0
op_logical_and
id|CURRENT_SC-&gt;SCp.this_residual
OG
l_int|0
)paren
(brace
id|data_count
op_assign
id|fifodata
OG
id|CURRENT_SC-&gt;SCp.this_residual
ques
c_cond
id|CURRENT_SC-&gt;SCp.this_residual
suffix:colon
id|fifodata
suffix:semicolon
id|fifodata
op_sub_assign
id|data_count
suffix:semicolon
r_if
c_cond
(paren
id|data_count
op_amp
l_int|1
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_datai
comma
id|DEBUG_LEAD
l_string|&quot;8bit&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
op_or
id|_8BIT
)paren
suffix:semicolon
op_star
id|CURRENT_SC-&gt;SCp.ptr
op_increment
op_assign
id|GETPORT
c_func
(paren
id|DATAPORT
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_decrement
suffix:semicolon
id|DATA_LEN
op_increment
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_count
OG
l_int|1
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_datai
comma
id|DEBUG_LEAD
l_string|&quot;16bit(%d)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|data_count
)paren
suffix:semicolon
id|data_count
op_rshift_assign
l_int|1
suffix:semicolon
id|insw
c_func
(paren
id|DATAPORT
comma
id|CURRENT_SC-&gt;SCp.ptr
comma
id|data_count
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_add_assign
l_int|2
op_star
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_sub_assign
l_int|2
op_star
id|data_count
suffix:semicolon
id|DATA_LEN
op_add_assign
l_int|2
op_star
id|data_count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.this_residual
op_eq
l_int|0
op_logical_and
id|CURRENT_SC-&gt;SCp.buffers_residual
OG
l_int|0
)paren
(brace
multiline_comment|/* advance to next buffer */
id|CURRENT_SC-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|CURRENT_SC-&gt;SCp.buffer
op_increment
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|fifodata
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;no buffers left for %d(%d) bytes (data overrun!?)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|fifodata
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
op_or
id|_8BIT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fifodata
OG
l_int|0
)paren
(brace
r_int
id|data
suffix:semicolon
id|data
op_assign
id|GETPORT
c_func
(paren
id|DATAPORT
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_datai
comma
id|DEBUG_LEAD
l_string|&quot;data=%02x&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|data
)paren
suffix:semicolon
id|fifodata
op_decrement
suffix:semicolon
id|DATA_LEN
op_increment
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
op_or
id|_8BIT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
op_logical_or
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
)paren
op_logical_or
id|TESTLO
c_func
(paren
id|SSTAT2
comma
id|SEMPTY
)paren
op_logical_or
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * something went wrong, if there&squot;s something left in the fifos&n;&t;&t; * or the phase didn&squot;t change&n;&t;&t; */
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;fifos should be empty and phase should have changed&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DATA_LEN
op_ne
id|GETSTCNT
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;manual transfer count differs from automatic (count=%d;stcnt=%d;diff=%d;fifostat=%d)&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|DATA_LEN
comma
id|GETSTCNT
c_func
(paren
)paren
comma
id|GETSTCNT
c_func
(paren
)paren
op_minus
id|DATA_LEN
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
)brace
)brace
DECL|function|datai_end
r_static
r_void
id|datai_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|CURRENT_SC-&gt;resid
op_sub_assign
id|GETSTCNT
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_datai
comma
id|DEBUG_LEAD
l_string|&quot;datai_end: request_bufflen=%d resid=%d stcnt=%d&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;request_bufflen
comma
id|CURRENT_SC-&gt;resid
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * data out phase&n; *&n; */
DECL|function|datao_init
r_static
r_void
id|datao_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|WRITE_READ
op_or
id|RSTFIFO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|WRITE_READ
op_or
id|ENDMA
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|SCSIEN
op_or
id|DMAEN
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENSCSIPERR
op_or
id|ENSCSIRST
op_or
id|ENPHASEMIS
op_or
id|ENBUSFREE
)paren
suffix:semicolon
id|DATA_LEN
op_assign
id|CURRENT_SC-&gt;resid
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_datao
comma
id|DEBUG_LEAD
l_string|&quot;datao_init: request_bufflen=%d; resid=%d&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;request_bufflen
comma
id|CURRENT_SC-&gt;resid
)paren
suffix:semicolon
)brace
DECL|function|datao_run
r_static
r_void
id|datao_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
r_int
id|the_time
suffix:semicolon
r_int
id|data_count
suffix:semicolon
multiline_comment|/* until phase changes or all data sent */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
op_logical_and
id|CURRENT_SC-&gt;SCp.this_residual
OG
l_int|0
)paren
(brace
id|data_count
op_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|data_count
OG
id|CURRENT_SC-&gt;SCp.this_residual
)paren
(brace
id|data_count
op_assign
id|CURRENT_SC-&gt;SCp.this_residual
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;datao fifo not empty (%d)&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_count
op_amp
l_int|1
)paren
(brace
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|WRITE_READ
op_or
id|ENDMA
op_or
id|_8BIT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DATAPORT
comma
op_star
id|CURRENT_SC-&gt;SCp.ptr
op_increment
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_decrement
suffix:semicolon
id|CURRENT_SC-&gt;resid
op_decrement
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|WRITE_READ
op_or
id|ENDMA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_count
OG
l_int|1
)paren
(brace
id|data_count
op_rshift_assign
l_int|1
suffix:semicolon
id|outsw
c_func
(paren
id|DATAPORT
comma
id|CURRENT_SC-&gt;SCp.ptr
comma
id|data_count
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_add_assign
l_int|2
op_star
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_sub_assign
l_int|2
op_star
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;resid
op_sub_assign
l_int|2
op_star
id|data_count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.this_residual
op_eq
l_int|0
op_logical_and
id|CURRENT_SC-&gt;SCp.buffers_residual
OG
l_int|0
)paren
(brace
multiline_comment|/* advance to next buffer */
id|CURRENT_SC-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|CURRENT_SC-&gt;SCp.buffer
op_increment
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
id|the_time
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
op_or
id|INTSTAT
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|the_time
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
op_or
id|INTSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;dataout timeout&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|datao_end
r_static
r_void
id|datao_end
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
)paren
)paren
(brace
r_int
id|data_count
op_assign
(paren
id|DATA_LEN
op_minus
id|CURRENT_SC-&gt;resid
)paren
op_minus
id|GETSTCNT
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_datao
comma
id|DEBUG_LEAD
l_string|&quot;datao: %d bytes to resend (%d written, %d transfered)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|data_count
comma
id|DATA_LEN
op_minus
id|CURRENT_SC-&gt;resid
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
id|CURRENT_SC-&gt;resid
op_add_assign
id|data_count
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;use_sg
)paren
(brace
id|data_count
op_sub_assign
id|CURRENT_SC-&gt;SCp.ptr
op_minus
id|CURRENT_SC-&gt;SCp.buffer-&gt;address
suffix:semicolon
r_while
c_loop
(paren
id|data_count
OG
l_int|0
)paren
(brace
id|CURRENT_SC-&gt;SCp.buffer
op_decrement
suffix:semicolon
id|CURRENT_SC-&gt;SCp.buffers_residual
op_increment
suffix:semicolon
id|data_count
op_sub_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.ptr
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;address
op_minus
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;length
op_plus
id|data_count
suffix:semicolon
)brace
r_else
(brace
id|CURRENT_SC-&gt;SCp.ptr
op_sub_assign
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_add_assign
id|data_count
suffix:semicolon
)brace
)brace
id|DPRINTK
c_func
(paren
id|debug_datao
comma
id|DEBUG_LEAD
l_string|&quot;datao_end: request_bufflen=%d; resid=%d; stcnt=%d&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|CURRENT_SC-&gt;request_bufflen
comma
id|CURRENT_SC-&gt;resid
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRCH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * figure out what state we&squot;re in&n; *&n; */
DECL|function|update_state
r_static
r_int
id|update_state
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|dataphase
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|stat0
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
suffix:semicolon
r_int
r_int
id|stat1
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
suffix:semicolon
id|PREVSTATE
op_assign
id|STATE
suffix:semicolon
id|STATE
op_assign
id|unknown
suffix:semicolon
r_if
c_cond
(paren
id|stat1
op_amp
id|SCSIRSTI
)paren
(brace
id|STATE
op_assign
id|rsti
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|SCSIRSTI
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat0
op_amp
id|SELDI
op_logical_and
id|PREVSTATE
op_eq
id|busfree
)paren
(brace
id|STATE
op_assign
id|seldi
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat0
op_amp
id|SELDO
op_logical_and
id|CURRENT_SC
op_logical_and
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|selecting
)paren
)paren
(brace
id|STATE
op_assign
id|seldo
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat1
op_amp
id|SELTO
)paren
(brace
id|STATE
op_assign
id|selto
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat1
op_amp
id|BUSFREE
)paren
(brace
id|STATE
op_assign
id|busfree
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|BUSFREE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat1
op_amp
id|SCSIPERR
)paren
(brace
id|STATE
op_assign
id|parerr
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|SCSIPERR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat1
op_amp
id|REQINIT
)paren
(brace
r_switch
c_cond
(paren
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_MSGI
suffix:colon
id|STATE
op_assign
id|msgi
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|STATE
op_assign
id|msgo
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAO
suffix:colon
id|STATE
op_assign
id|datao
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|STATE
op_assign
id|datai
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|STATE
op_assign
id|status
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|STATE
op_assign
id|cmd
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dataphase
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|stat0
op_amp
id|SELDI
)paren
op_logical_and
id|STATE
op_ne
id|seldi
op_logical_and
op_logical_neg
id|dataphase
)paren
(brace
id|printk
c_func
(paren
id|INFO_LEAD
l_string|&quot;reselection missed?&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STATE
op_ne
id|PREVSTATE
)paren
(brace
id|LASTSTATE
op_assign
id|PREVSTATE
suffix:semicolon
)brace
r_return
id|dataphase
suffix:semicolon
)brace
multiline_comment|/*&n; * handle parity error&n; *&n; * FIXME: in which phase?&n; *&n; */
DECL|function|parerr_run
r_static
r_void
id|parerr_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;parity error&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
)paren
suffix:semicolon
id|done
c_func
(paren
id|shpnt
comma
id|DID_PARITY
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * handle reset in&n; *&n; */
DECL|function|rsti_run
r_static
r_void
id|rsti_run
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;aha152x%d: scsi reset in&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
id|ptr
op_assign
id|DISCONNECTED_SC
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
(brace
id|Scsi_Cmnd
op_star
id|next
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr-&gt;device-&gt;soft_reset
)paren
(brace
id|remove_SC
c_func
(paren
op_amp
id|DISCONNECTED_SC
comma
id|ptr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ptr-&gt;host_scribble
)paren
suffix:semicolon
id|ptr-&gt;host_scribble
op_assign
l_int|0
suffix:semicolon
id|ptr-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|ptr
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
id|ptr
op_assign
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT_SC
op_logical_and
op_logical_neg
id|CURRENT_SC-&gt;device-&gt;soft_reset
)paren
(brace
id|done
c_func
(paren
id|shpnt
comma
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * bottom-half handler&n; *&n; */
DECL|function|complete
r_static
r_void
id|complete
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|dataphase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|pending
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|in_intr
op_ne
l_int|0
)paren
(brace
id|aha152x_error
c_func
(paren
id|shpnt
comma
l_string|&quot;bottom-half already running!?&quot;
)paren
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|in_intr
op_increment
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * loop while there are interrupt conditions pending&n;&t; *&n;&t; */
r_do
(brace
r_int
r_int
id|start
op_assign
id|jiffies
suffix:semicolon
id|dataphase
op_assign
id|update_state
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_phases
comma
id|LEAD
l_string|&quot;start %s %s(%s)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|states
(braket
id|STATE
)braket
dot
id|name
comma
id|states
(braket
id|PREVSTATE
)braket
dot
id|name
comma
id|states
(braket
id|LASTSTATE
)braket
dot
id|name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * end previous state&n;&t;&t; *&n;&t;&t; */
r_if
c_cond
(paren
id|PREVSTATE
op_ne
id|STATE
op_logical_and
id|states
(braket
id|PREVSTATE
)braket
dot
id|end
)paren
(brace
id|states
(braket
id|PREVSTATE
)braket
dot
id|end
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * disable SPIO mode if previous phase used it&n;&t;&t; * and this one doesn&squot;t&n;&t;&t; *&n;&t;&t; */
r_if
c_cond
(paren
id|states
(braket
id|PREVSTATE
)braket
dot
id|spio
op_logical_and
op_logical_neg
id|states
(braket
id|STATE
)braket
dot
id|spio
)paren
(brace
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|spiordy
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * accept current dataphase phase&n;&t;&t; *&n;&t;&t; */
r_if
c_cond
(paren
id|dataphase
)paren
(brace
id|SETPORT
c_func
(paren
id|SSTAT0
comma
id|REQINIT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
op_amp
id|P_MASK
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|PHASECHG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * enable SPIO mode if previous didn&squot;t use it&n;&t;&t; * and this one does&n;&t;&t; *&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|states
(braket
id|PREVSTATE
)braket
dot
id|spio
op_logical_and
id|states
(braket
id|STATE
)braket
dot
id|spio
)paren
(brace
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|SPIOEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|spiordy
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * initialize for new state&n;&t;&t; *&n;&t;&t; */
r_if
c_cond
(paren
id|PREVSTATE
op_ne
id|STATE
op_logical_and
id|states
(braket
id|STATE
)braket
dot
id|init
)paren
(brace
id|states
(braket
id|STATE
)braket
dot
id|init
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * handle current state&n;&t;&t; *&n;&t;&t; */
r_if
c_cond
(paren
id|states
(braket
id|STATE
)braket
dot
id|run
)paren
(brace
id|states
(braket
id|STATE
)braket
dot
id|run
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|ERR_LEAD
l_string|&quot;unexpected state (%x)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|STATE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * setup controller to interrupt on&n;&t;&t; * the next expected condition and&n;&t;&t; * loop if it&squot;s already there&n;&t;&t; *&n;&t;&t; */
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|pending
op_assign
id|setup_expected_interrupts
c_func
(paren
id|shpnt
)paren
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count
(braket
id|STATE
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|PREVSTATE
op_ne
id|STATE
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count_trans
(braket
id|STATE
)braket
op_increment
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|time
(braket
id|STATE
)braket
op_add_assign
id|jiffies
op_minus
id|start
suffix:semicolon
macro_line|#endif
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_phases
comma
id|LEAD
l_string|&quot;end %s %s(%s)&bslash;n&quot;
comma
id|CMDINFO
c_func
(paren
id|CURRENT_SC
)paren
comma
id|states
(braket
id|STATE
)braket
dot
id|name
comma
id|states
(braket
id|PREVSTATE
)braket
dot
id|name
comma
id|states
(braket
id|LASTSTATE
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pending
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * enable interrupts and leave bottom-half&n;&t; *&n;&t; */
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|in_intr
op_decrement
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Dump the current driver status and panic&n; */
DECL|function|aha152x_error
r_static
r_void
id|aha152x_error
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_char
op_star
id|msg
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;&bslash;naha152x%d: %s&bslash;n&quot;
comma
id|HOSTNO
comma
id|msg
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;aha152x panic&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display registers of AIC-6260&n; */
DECL|function|disp_ports
r_static
r_void
id|disp_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
macro_line|#if defined(AHA152X_DEBUG)
r_int
id|s
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n%s: %s(%s) &quot;
comma
id|CURRENT_SC
ques
c_cond
l_string|&quot;busy&quot;
suffix:colon
l_string|&quot;waiting&quot;
comma
id|states
(braket
id|STATE
)braket
dot
id|name
comma
id|states
(braket
id|PREVSTATE
)braket
dot
id|name
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISEQ
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSISEQ( &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TEMODEO
)paren
id|printk
c_func
(paren
l_string|&quot;TARGET MODE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELO
)paren
id|printk
c_func
(paren
l_string|&quot;SELO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELI
)paren
id|printk
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENRESELI
)paren
id|printk
c_func
(paren
l_string|&quot;RESELI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNO
)paren
id|printk
c_func
(paren
l_string|&quot;AUTOATNO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNI
)paren
id|printk
c_func
(paren
l_string|&quot;AUTOATNI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNP
)paren
id|printk
c_func
(paren
l_string|&quot;AUTOATNP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTO
)paren
id|printk
c_func
(paren
l_string|&quot;SCSIRSTO &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;);&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; SCSISIG(&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|s
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_DATAO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DATA OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DATA IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|printk
c_func
(paren
l_string|&quot;COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STATUS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MESSAGE OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MESSAGE IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;*illegal*&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTSTAT (%s); &quot;
comma
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
ques
c_cond
l_string|&quot;hi&quot;
suffix:colon
l_string|&quot;lo&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
id|printk
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
id|printk
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
id|printk
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
id|printk
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
id|printk
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
id|printk
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
id|printk
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
id|printk
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
id|printk
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
id|printk
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
id|printk
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
id|printk
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
id|printk
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
id|printk
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
id|printk
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
id|printk
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
id|printk
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
id|printk
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
id|printk
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
id|printk
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
id|printk
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
id|printk
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
id|printk
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
id|printk
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
id|printk
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
id|printk
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
id|printk
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
id|printk
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
id|printk
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
id|printk
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
id|printk
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
id|printk
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SXFRCTL0( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SXFRCTL0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIEN
)paren
id|printk
c_func
(paren
l_string|&quot;SCSIEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DMAEN
)paren
id|printk
c_func
(paren
l_string|&quot;DMAEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|CH1
)paren
id|printk
c_func
(paren
l_string|&quot;CH1 &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|CLRSTCNT
)paren
id|printk
c_func
(paren
l_string|&quot;CLRSTCNT &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SPIOEN
)paren
id|printk
c_func
(paren
l_string|&quot;SPIOEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|CLRCH1
)paren
id|printk
c_func
(paren
l_string|&quot;CLRCH1 &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SIGNAL( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_ATNI
)paren
id|printk
c_func
(paren
l_string|&quot;ATNI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_SELI
)paren
id|printk
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_BSYI
)paren
id|printk
c_func
(paren
l_string|&quot;BSYI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_REQI
)paren
id|printk
c_func
(paren
l_string|&quot;REQI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_ACKI
)paren
id|printk
c_func
(paren
l_string|&quot;ACKI &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SELID (%02x), &quot;
comma
id|GETPORT
c_func
(paren
id|SELID
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STCNT (%d), &quot;
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT2( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SOFFSET
)paren
id|printk
c_func
(paren
l_string|&quot;SOFFSET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SEMPTY
)paren
id|printk
c_func
(paren
l_string|&quot;SEMPTY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SFULL
)paren
id|printk
c_func
(paren
l_string|&quot;SFULL &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); SFCNT (%d); &quot;
comma
id|s
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSICNT (%d), OFFCNT(%d), &quot;
comma
(paren
id|s
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|s
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT4( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SYNCERR
)paren
id|printk
c_func
(paren
l_string|&quot;SYNCERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|FWERR
)paren
id|printk
c_func
(paren
l_string|&quot;FWERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|FRERR
)paren
id|printk
c_func
(paren
l_string|&quot;FRERR &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMACNTRL0( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMACNTRL0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|_8BIT
ques
c_cond
l_string|&quot;8BIT&quot;
suffix:colon
l_string|&quot;16BIT&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|DMA
ques
c_cond
l_string|&quot;DMA&quot;
suffix:colon
l_string|&quot;PIO&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|WRITE_READ
ques
c_cond
l_string|&quot;WRITE&quot;
suffix:colon
l_string|&quot;READ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENDMA
)paren
id|printk
c_func
(paren
l_string|&quot;ENDMA &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|INTEN
)paren
id|printk
c_func
(paren
l_string|&quot;INTEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|RSTFIFO
)paren
id|printk
c_func
(paren
l_string|&quot;RSTFIFO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SWINT
)paren
id|printk
c_func
(paren
l_string|&quot;SWINT &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMASTAT( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMASTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATDONE
)paren
id|printk
c_func
(paren
l_string|&quot;ATDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|WORDRDY
)paren
id|printk
c_func
(paren
l_string|&quot;WORDRDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOFULL
)paren
id|printk
c_func
(paren
l_string|&quot;DFIFOFULL &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOEMP
)paren
id|printk
c_func
(paren
l_string|&quot;DFIFOEMP &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * display enabled interrupts&n; */
DECL|function|disp_enintr
r_static
r_void
id|disp_enintr
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|s
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;enabled interrupts ( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDO
)paren
id|printk
c_func
(paren
l_string|&quot;ENSELDO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDI
)paren
id|printk
c_func
(paren
l_string|&quot;ENSELDI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELINGO
)paren
id|printk
c_func
(paren
l_string|&quot;ENSELINGO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSWRAP
)paren
id|printk
c_func
(paren
l_string|&quot;ENSWRAP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSDONE
)paren
id|printk
c_func
(paren
l_string|&quot;ENSDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSPIORDY
)paren
id|printk
c_func
(paren
l_string|&quot;ENSPIORDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENDMADONE
)paren
id|printk
c_func
(paren
l_string|&quot;ENDMADONE &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELTIMO
)paren
id|printk
c_func
(paren
l_string|&quot;ENSELTIMO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENATNTARG
)paren
id|printk
c_func
(paren
l_string|&quot;ENATNTARG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASEMIS
)paren
id|printk
c_func
(paren
l_string|&quot;ENPHASEMIS &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENBUSFREE
)paren
id|printk
c_func
(paren
l_string|&quot;ENBUSFREE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSCSIPERR
)paren
id|printk
c_func
(paren
l_string|&quot;ENSCSIPERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASECHG
)paren
id|printk
c_func
(paren
l_string|&quot;ENPHASECHG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENREQINIT
)paren
id|printk
c_func
(paren
l_string|&quot;ENREQINIT &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Show the command data of a command&n; */
DECL|function|show_command
r_static
r_void
id|show_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|ptr
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;0x%08x: target=%d; lun=%d; cmnd=(&quot;
comma
(paren
r_int
r_int
)paren
id|ptr
comma
id|ptr-&gt;target
comma
id|ptr-&gt;lun
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|ptr-&gt;cmnd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;); request_bufflen=%d; resid=%d; phase |&quot;
comma
id|ptr-&gt;request_bufflen
comma
id|ptr-&gt;resid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|not_issued
)paren
id|printk
c_func
(paren
l_string|&quot;not issued|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|selecting
)paren
id|printk
c_func
(paren
l_string|&quot;selecting|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|identified
)paren
id|printk
c_func
(paren
l_string|&quot;identified|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|disconnected
)paren
id|printk
c_func
(paren
l_string|&quot;disconnected|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|completed
)paren
id|printk
c_func
(paren
l_string|&quot;completed|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|spiordy
)paren
id|printk
c_func
(paren
l_string|&quot;spiordy|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|syncneg
)paren
id|printk
c_func
(paren
l_string|&quot;syncneg|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|aborted
)paren
id|printk
c_func
(paren
l_string|&quot;aborted|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|resetted
)paren
id|printk
c_func
(paren
l_string|&quot;resetted|&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;; next=0x%p&bslash;n&quot;
comma
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dump the queued data&n; */
DECL|function|show_queues
r_static
r_void
id|show_queues
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;nqueue status:&bslash;nissue_SC:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|ISSUE_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
id|show_command
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;current_SC:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
id|show_command
c_func
(paren
id|CURRENT_SC
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;none&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;disconnected_SC:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|DISCONNECTED_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
id|show_command
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|disp_enintr
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) pos += sprintf(pos, ## args)
DECL|function|get_command
r_static
r_int
id|get_command
c_func
(paren
r_char
op_star
id|pos
comma
id|Scsi_Cmnd
op_star
id|ptr
)paren
(brace
r_char
op_star
id|start
op_assign
id|pos
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;0x%08x: target=%d; lun=%d; cmnd=( &quot;
comma
(paren
r_int
r_int
)paren
id|ptr
comma
id|ptr-&gt;target
comma
id|ptr-&gt;lun
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|COMMAND_SIZE
c_func
(paren
id|ptr-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|ptr-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); resid=%d; residual=%d; buffers=%d; phase |&quot;
comma
id|ptr-&gt;resid
comma
id|ptr-&gt;SCp.this_residual
comma
id|ptr-&gt;SCp.buffers_residual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|not_issued
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;not issued|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|selecting
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;selecting|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|disconnected
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;disconnected|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|aborted
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;aborted|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|identified
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;identified|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|completed
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;completed|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|spiordy
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;spiordy|&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|syncneg
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;syncneg|&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;; next=0x%p&bslash;n&quot;
comma
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
r_return
(paren
id|pos
op_minus
id|start
)paren
suffix:semicolon
)brace
DECL|function|get_ports
r_static
r_int
id|get_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_char
op_star
id|pos
)paren
(brace
r_char
op_star
id|start
op_assign
id|pos
suffix:semicolon
r_int
id|s
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n%s: %s(%s) &quot;
comma
id|CURRENT_SC
ques
c_cond
l_string|&quot;on bus&quot;
suffix:colon
l_string|&quot;waiting&quot;
comma
id|states
(braket
id|STATE
)braket
dot
id|name
comma
id|states
(braket
id|PREVSTATE
)braket
dot
id|name
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISEQ
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSISEQ( &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TEMODEO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;TARGET MODE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENRESELI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;RESELI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;AUTOATNO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;AUTOATNI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNP
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;AUTOATNP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIRSTO &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;);&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; SCSISIG(&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|s
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_DATAO
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;DATA OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;DATA IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;STATUS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;MESSAGE OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;MESSAGE IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;*illegal*&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;INTSTAT (%s); &quot;
comma
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
ques
c_cond
l_string|&quot;hi&quot;
suffix:colon
l_string|&quot;lo&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SXFRCTL0( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SXFRCTL0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIEN
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DMAEN
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DMAEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|CH1
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;CH1 &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|CLRSTCNT
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;CLRSTCNT &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SPIOEN
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SPIOEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|CLRCH1
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;CLRCH1 &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SIGNAL( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_ATNI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ATNI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_SELI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_BSYI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;BSYI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_REQI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;REQI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SIG_ACKI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ACKI &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SELID(%02x), &quot;
comma
id|GETPORT
c_func
(paren
id|SELID
)paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;STCNT(%d), &quot;
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT2( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SOFFSET
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SOFFSET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SEMPTY
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SEMPTY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SFULL
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SFULL &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); SFCNT (%d); &quot;
comma
id|s
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT3
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSICNT (%d), OFFCNT(%d), &quot;
comma
(paren
id|s
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|s
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT4( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SYNCERR
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SYNCERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|FWERR
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;FWERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|FRERR
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;FRERR &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DMACNTRL0( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMACNTRL0
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|_8BIT
ques
c_cond
l_string|&quot;8BIT&quot;
suffix:colon
l_string|&quot;16BIT&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|DMA
ques
c_cond
l_string|&quot;DMA&quot;
suffix:colon
l_string|&quot;PIO&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|WRITE_READ
ques
c_cond
l_string|&quot;WRITE&quot;
suffix:colon
l_string|&quot;READ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENDMA
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENDMA &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|INTEN
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;INTEN &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|RSTFIFO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;RSTFIFO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SWINT
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;SWINT &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DMASTAT( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMASTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATDONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ATDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|WORDRDY
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;WORDRDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOFULL
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DFIFOFULL &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOEMP
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DFIFOEMP &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;enabled interrupts( &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELDO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDI
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELDI &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELINGO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELINGO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSWRAP
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSWRAP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSDONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSDONE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSPIORDY
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSPIORDY &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENDMADONE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENDMADONE &quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELTIMO
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELTIMO &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENATNTARG
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENATNTARG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASEMIS
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENPHASEMIS &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENBUSFREE
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENBUSFREE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSCSIPERR
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENSCSIPERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASECHG
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENPHASECHG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENREQINIT
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;ENREQINIT &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|pos
op_minus
id|start
)paren
suffix:semicolon
)brace
DECL|function|aha152x_set_info
r_int
id|aha152x_set_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|length
comma
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|shpnt
op_logical_or
op_logical_neg
id|buffer
op_logical_or
id|length
OL
l_int|8
op_logical_or
id|strncmp
c_func
(paren
l_string|&quot;aha152x &quot;
comma
id|buffer
comma
l_int|8
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if defined(AHA152X_DEBUG)
r_if
c_cond
(paren
id|length
OG
l_int|14
op_logical_and
id|strncmp
c_func
(paren
l_string|&quot;debug &quot;
comma
id|buffer
op_plus
l_int|8
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|debug
op_assign
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_assign
id|simple_strtoul
c_func
(paren
id|buffer
op_plus
l_int|14
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x%d: debugging options set to 0x%04x (were 0x%04x)&bslash;n&quot;
comma
id|HOSTNO
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
comma
id|debug
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#if defined(AHA152X_STAT)
r_if
c_cond
(paren
id|length
OG
l_int|13
op_logical_and
id|strncmp
c_func
(paren
l_string|&quot;reset&quot;
comma
id|buffer
op_plus
l_int|8
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|total_commands
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|disconnections
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_any_action
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_old_command
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_new_command
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_done_command
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_with_check_condition
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|idle
suffix:semicolon
id|i
OL
id|maxstate
suffix:semicolon
id|i
op_increment
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count_trans
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|time
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha152x%d: stats reseted.&bslash;n&quot;
comma
id|HOSTNO
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|length
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) &bslash;&n;&t;do { if(pos &lt; buffer + length) pos += sprintf(pos, ## args); } while(0)
DECL|function|aha152x_proc_info
r_int
id|aha152x_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|thislength
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|shpnt
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
l_int|NULL
suffix:semicolon
id|i
OL
id|IRQS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|aha152x_host
(braket
id|i
)braket
op_logical_and
id|aha152x_host
(braket
id|i
)braket
op_member_access_from_pointer
id|host_no
op_eq
id|hostno
)paren
id|shpnt
op_assign
id|aha152x_host
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_procinfo
comma
id|KERN_DEBUG
l_string|&quot;aha152x_proc_info: buffer=%p offset=%ld length=%d hostno=%d inout=%d&bslash;n&quot;
comma
id|buffer
comma
id|offset
comma
id|length
comma
id|hostno
comma
id|inout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inout
)paren
r_return
id|aha152x_set_info
c_func
(paren
id|buffer
comma
id|length
comma
id|shpnt
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
id|AHA152X_REVID
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;ioports 0x%04lx to 0x%04lx&bslash;n&quot;
comma
id|shpnt-&gt;io_port
comma
id|shpnt-&gt;io_port
op_plus
id|shpnt-&gt;n_io_port
op_minus
l_int|1
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;interrupt 0x%02x&bslash;n&quot;
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;disconnection/reconnection %s&bslash;n&quot;
comma
id|RECONNECT
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;parity checking %s&bslash;n&quot;
comma
id|PARITY
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;synchronous transfers %s&bslash;n&quot;
comma
id|SYNCHRONOUS
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%d commands currently queued&bslash;n&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SYNCHRONOUS
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;synchronously operating targets (tick=50 ns):&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x7f
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;target %d: period %dT/%dns; req/ack offset %d&bslash;n&quot;
comma
id|i
comma
(paren
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|2
)paren
comma
(paren
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|2
)paren
op_star
l_int|50
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
macro_line|#if defined(AHA152X_DEBUG)
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(flags,txt) &bslash;&n;&t;if(HOSTDATA(shpnt)-&gt;debug &amp; flags) SPRINTF(&quot;(%s) &quot;, txt);
id|SPRINTF
c_func
(paren
l_string|&quot;enabled debugging options: &quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_procinfo
comma
l_string|&quot;procinfo&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_queue
comma
l_string|&quot;queue&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_intr
comma
l_string|&quot;interrupt&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_selection
comma
l_string|&quot;selection&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_msgo
comma
l_string|&quot;message out&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_msgi
comma
l_string|&quot;message in&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_status
comma
l_string|&quot;status&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_cmd
comma
l_string|&quot;command&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_datai
comma
l_string|&quot;data in&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_datao
comma
l_string|&quot;data out&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_eh
comma
l_string|&quot;eh&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_locks
comma
l_string|&quot;locks&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_phases
comma
l_string|&quot;phases&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;nqueue status:&bslash;n&quot;
)paren
suffix:semicolon
id|DO_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISSUE_SC
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;not yet issued commands:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|ISSUE_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
id|pos
op_add_assign
id|get_command
c_func
(paren
id|pos
comma
id|ptr
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;no not yet issued commands&bslash;n&quot;
)paren
suffix:semicolon
id|DO_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;current command:&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_add_assign
id|get_command
c_func
(paren
id|pos
comma
id|CURRENT_SC
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;no current command&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DISCONNECTED_SC
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;disconnected commands:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|DISCONNECTED_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
id|SCNEXT
c_func
(paren
id|ptr
)paren
)paren
id|pos
op_add_assign
id|get_command
c_func
(paren
id|pos
comma
id|ptr
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;no disconnected commands&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_add_assign
id|get_ports
c_func
(paren
id|shpnt
comma
id|pos
)paren
suffix:semicolon
macro_line|#if defined(AHA152X_STAT)
id|SPRINTF
c_func
(paren
l_string|&quot;statistics:&bslash;n&quot;
l_string|&quot;total commands:               %d&bslash;n&quot;
l_string|&quot;disconnections:               %d&bslash;n&quot;
l_string|&quot;busfree with check condition: %d&bslash;n&quot;
l_string|&quot;busfree without old command:  %d&bslash;n&quot;
l_string|&quot;busfree without new command:  %d&bslash;n&quot;
l_string|&quot;busfree without done command: %d&bslash;n&quot;
l_string|&quot;busfree without any action:   %d&bslash;n&quot;
l_string|&quot;state      &quot;
l_string|&quot;transitions  &quot;
l_string|&quot;count        &quot;
l_string|&quot;time&bslash;n&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|total_commands
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|disconnections
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_with_check_condition
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_old_command
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_new_command
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_done_command
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|busfree_without_any_action
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|maxstate
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;%-10s %-12d %-12d %-12ld&bslash;n&quot;
comma
id|states
(braket
id|i
)braket
dot
id|name
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count_trans
(braket
id|i
)braket
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|count
(braket
id|i
)braket
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|time
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DPRINTK
c_func
(paren
id|debug_procinfo
comma
id|KERN_DEBUG
l_string|&quot;aha152x_proc_info: pos=%p&bslash;n&quot;
comma
id|pos
)paren
suffix:semicolon
id|thislength
op_assign
id|pos
op_minus
(paren
id|buffer
op_plus
id|offset
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_procinfo
comma
id|KERN_DEBUG
l_string|&quot;aha152x_proc_info: length=%d thislength=%d&bslash;n&quot;
comma
id|length
comma
id|thislength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|thislength
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
id|debug_procinfo
comma
id|KERN_DEBUG
l_string|&quot;aha152x_proc_info: output too short&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|start
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|thislength
op_assign
id|thislength
OL
id|length
ques
c_cond
id|thislength
suffix:colon
id|length
suffix:semicolon
id|DPRINTK
c_func
(paren
id|debug_procinfo
comma
id|KERN_DEBUG
l_string|&quot;aha152x_proc_info: return %d&bslash;n&quot;
comma
id|thislength
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_return
id|thislength
OL
id|length
ques
c_cond
id|thislength
suffix:colon
id|length
suffix:semicolon
)brace
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|AHA152X
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
