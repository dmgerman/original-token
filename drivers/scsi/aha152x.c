multiline_comment|/* aha152x.c -- Adaptec AHA-152x driver&n; * Author: J&#xfffd;rgen E. Fischer, fischer@et-inf.fho-emden.de&n; * Copyright 1993, 1994, 1995, 1996 J&#xfffd;rgen E. Fischer&n; *&n; *&n; * This driver is based on&n; *   fdomain.c -- Future Domain TMC-16x0 driver&n; * which is&n; *   Copyright 1992, 1993 Rickard E. Faith (faith@cs.unc.edu)&n; *&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; *&n; * $Id: aha152x.c,v 1.18 1996/09/07 20:10:40 fischer Exp $&n; *&n; * $Log: aha152x.c,v $&n; * Revision 1.18  1996/09/07 20:10:40  fischer&n; * - fixed can_queue handling (multiple outstanding commands working again)&n; *&n; * Revision 1.17  1996/08/17 16:05:14  fischer&n; * - biosparam improved&n; * - interrupt verification&n; * - updated documentation&n; * - cleanups&n; *&n; * Revision 1.16  1996/06/09 00:04:56  root&n; * - added configuration symbols for insmod (aha152x/aha152x1)&n; *&n; * Revision 1.15  1996/04/30 14:52:06  fischer&n; * - proc info fixed&n; * - support for extended translation for &gt;1GB disks&n; *&n; * Revision 1.14  1996/01/17  15:11:20  fischer&n; * - fixed lockup in MESSAGE IN phase after reconnection&n; *&n; * Revision 1.13  1996/01/09  02:15:53  fischer&n; * - some cleanups&n; * - moved request_irq behind controller initialization&n; *   (to avoid spurious interrupts)&n; *&n; * Revision 1.12  1995/12/16  12:26:07  fischer&n; * - barrier()s added&n; * - configurable RESET delay added&n; *&n; * Revision 1.11  1995/12/06  21:18:35  fischer&n; * - some minor updates&n; *&n; * Revision 1.10  1995/07/22  19:18:45  fischer&n; * - support for 2 controllers&n; * - started synchronous data transfers (not working yet)&n; *&n; * Revision 1.9  1995/03/18  09:20:24  root&n; * - patches for PCMCIA and modules&n; *&n; * Revision 1.8  1995/01/21  22:07:19  root&n; * - snarf_region =&gt; request_region&n; * - aha152x_intr interface change&n; *&n; * Revision 1.7  1995/01/02  23:19:36  root&n; * - updated COMMAND_SIZE to cmd_len&n; * - changed sti() to restore_flags()&n; * - fixed some #ifdef which generated warnings&n; *&n; * Revision 1.6  1994/11/24  20:35:27  root&n; * - problem with odd number of bytes in fifo fixed&n; *&n; * Revision 1.5  1994/10/30  14:39:56  root&n; * - abort code fixed&n; * - debugging improved&n; *&n; * Revision 1.4  1994/09/12  11:33:01  root&n; * - irqaction to request_irq&n; * - abortion updated&n; *&n; * Revision 1.3  1994/08/04  13:53:05  root&n; * - updates for mid-level-driver changes&n; * - accept unexpected BUSFREE phase as error condition&n; * - parity check now configurable&n; *&n; * Revision 1.2  1994/07/03  12:56:36  root&n; * - cleaned up debugging code&n; * - more tweaking on reset delays&n; * - updated abort/reset code (pretty untested...)&n; *&n; * Revision 1.1  1994/05/28  21:18:49  root&n; * - update for mid-level interface change (abort-reset)&n; * - delays after resets adjusted for some slow devices&n; *&n; * Revision 1.0  1994/03/25  12:52:00  root&n; * - Fixed &quot;more data than expected&quot; problem&n; * - added new BIOS signatures&n; *&n; * Revision 0.102  1994/01/31  20:44:12  root&n; * - minor changes in insw/outsw handling&n; *&n; * Revision 0.101  1993/12/13  01:16:27  root&n; * - fixed STATUS phase (non-GOOD stati were dropped sometimes;&n; *   fixes problems with CD-ROM sector size detection &amp; media change)&n; *&n; * Revision 0.100  1993/12/10  16:58:47  root&n; * - fix for unsuccessful selections in case of non-continuous id assignments&n; *   on the scsi bus.&n; *&n; * Revision 0.99  1993/10/24  16:19:59  root&n; * - fixed DATA IN (rare read errors gone)&n; *&n; * Revision 0.98  1993/10/17  12:54:44  root&n; * - fixed some recent fixes (shame on me)&n; * - moved initialization of scratch area to aha152x_queue&n; *&n; * Revision 0.97  1993/10/09  18:53:53  root&n; * - DATA IN fixed. Rarely left data in the fifo.&n; *&n; * Revision 0.96  1993/10/03  00:53:59  root&n; * - minor changes on DATA IN&n; *&n; * Revision 0.95  1993/09/24  10:36:01  root&n; * - change handling of MSGI after reselection&n; * - fixed sti/cli&n; * - minor changes&n; *&n; * Revision 0.94  1993/09/18  14:08:22  root&n; * - fixed bug in multiple outstanding command code&n; * - changed detection&n; * - support for kernel command line configuration&n; * - reset corrected&n; * - changed message handling&n; *&n; * Revision 0.93  1993/09/15  20:41:19  root&n; * - fixed bugs with multiple outstanding commands&n; *&n; * Revision 0.92  1993/09/13  02:46:33  root&n; * - multiple outstanding commands work (no problems with IBM drive)&n; *&n; * Revision 0.91  1993/09/12  20:51:46  root&n; * added multiple outstanding commands&n; * (some problem with this $%&amp;? IBM device remain)&n; *&n; * Revision 0.9  1993/09/12  11:11:22  root&n; * - corrected auto-configuration&n; * - changed the auto-configuration (added some &squot;#define&squot;s)&n; * - added support for dis-/reconnection&n; *&n; * Revision 0.8  1993/09/06  23:09:39  root&n; * - added support for the drive activity light&n; * - minor changes&n; *&n; * Revision 0.7  1993/09/05  14:30:15  root&n; * - improved phase detection&n; * - now using the new snarf_region code of 0.99pl13&n; *&n; * Revision 0.6  1993/09/02  11:01:38  root&n; * first public release; added some signatures and biosparam()&n; *&n; * Revision 0.5  1993/08/30  10:23:30  root&n; * fixed timing problems with my IBM drive&n; *&n; * Revision 0.4  1993/08/29  14:06:52  root&n; * fixed some problems with timeouts due incomplete commands&n; *&n; * Revision 0.3  1993/08/28  15:55:03  root&n; * writing data works too.  mounted and worked on a dos partition&n; *&n; * Revision 0.2  1993/08/27  22:42:07  root&n; * reading data works.  Mounted a msdos partition.&n; *&n; * Revision 0.1  1993/08/25  13:38:30  root&n; * first &quot;damn thing doesn&squot;t work&quot; version&n; *&n; * Revision 0.0  1993/08/14  19:54:25  root&n; * empty function bodies; detect() works.&n; *&n; *&n; **************************************************************************&n;&n;&n; &n; DESCRIPTION:&n;&n; This is the Linux low-level SCSI driver for Adaptec AHA-1520/1522 SCSI&n; host adapters.&n;&n;&n; CONFIGURATION ARGUMENTS:&n;&n;  IOPORT        base io address                           (0x340/0x140)&n;  IRQ           interrupt level                           (9-12; default 11)&n;  SCSI_ID       scsi id of controller                     (0-7; default 7)&n;  RECONNECT     allow targets to disconnect from the bus  (0/1; default 1 [on])&n;  PARITY        enable parity checking                    (0/1; default 1 [on])&n;  SYNCHRONOUS   enable synchronous transfers              (0/1; default 0 [off])&n;                (NOT WORKING YET)&n;  DELAY:        bus reset delay                           (default 100)&n;  EXT_TRANS:    enable extended translation               (0/1: default 0 [off])&n;                (see NOTES below)&n;&n; COMPILE TIME CONFIGURATION (put into AHA152X in drivers/scsi/Makefile):&n;&n; -DAUTOCONF&n;   use configuration the controller reports (AHA-152x only)&n;&n; -DSKIP_BIOSTEST&n;   Don&squot;t test for BIOS signature (AHA-1510 or disabled BIOS)&n;&n; -DSETUP0=&quot;{ IOPORT, IRQ, SCSI_ID, RECONNECT, PARITY, SYNCHRONOUS, DELAY, EXT_TRANS }&quot;&n;   override for the first controller &n;   &n; -DSETUP1=&quot;{ IOPORT, IRQ, SCSI_ID, RECONNECT, PARITY, SYNCHRONOUS, DELAY, EXT_TRANS }&quot;&n;   override for the second controller&n;&n;&n; LILO COMMAND LINE OPTIONS:&n;&n; aha152x=&lt;IOPORT&gt;[,&lt;IRQ&gt;[,&lt;SCSI-ID&gt;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt; [,&lt;EXT_TRANS]]]]]]]&n;&n; The normal configuration can be overridden by specifying a command line.&n; When you do this, the BIOS test is skipped. Entered values have to be&n; valid (known).  Don&squot;t use values that aren&squot;t supported under normal&n; operation.  If you think that you need other values: contact me.&n; For two controllers use the aha152x statement twice.&n;&n;&n; SYMBOLS FOR MODULE CONFIGURATION:&n; &n;  aha152x=IOPORT,IRQ,SCSI_ID,RECONNECT,PARITY,SYNCHRONOUS,DELAY,EXT_TRANS&n;    configuration override of first controller&n;&n; &n;  aha152x1=IOPORT,IRQ,SCSI_ID,RECONNECT,PARITY,SYNCHRONOUS,DELAY,EXT_TRANS&n;    configuration override of second controller&n;&n;&n; NOTES ON EXT_TRANS: &n;&n; SCSI uses block numbers to address blocks/sectors on a device.&n; The BIOS uses a cylinder/head/sector addressing scheme (C/H/S)&n; scheme instead.  DOS expects a BIOS or driver that understands this&n; C/H/S addressing.&n;&n; The number of cylinders/heads/sectors is called geometry and is required&n; as base for requests in C/H/S adressing.  SCSI only knows about the&n; total capacity of disks in blocks (sectors).&n;&n; Therefore the SCSI BIOS/DOS driver has to calculate a logical/virtual&n; geometry just to be able to support that addressing scheme.  The geometry&n; returned by the SCSI BIOS is a pure calculation and has nothing to&n; do with the real/physical geometry of the disk (which is usually&n; irrelevant anyway).&n;&n; Basically this has no impact at all on Linux, because it also uses block&n; instead of C/H/S addressing.  Unfortunately C/H/S addressing is also used&n; in the partition table and therefore every operating system has to know&n; the right geometry to be able to interpret it.&n;&n; Moreover there are certain limitations to the C/H/S addressing scheme,&n; namely the address space is limited to upto 255 heads, upto 63 sectors&n; and a maximum of 1023 cylinders.&n;&n; The AHA-1522 BIOS calculates the geometry by fixing the number of heads&n; to 64, the number of sectors to 32 and by calculating the number of&n; cylinders by dividing the capacity reported by the disk by 64*32 (1 MB).&n; This is considered to be the default translation.&n;&n; With respect to the limit of 1023 cylinders using C/H/S you can only&n; address the first GB of your disk in the partition table.  Therefore&n; BIOSes of some newer controllers based on the AIC-6260/6360 support&n; extended translation.  This means that the BIOS uses 255 for heads,&n; 63 for sectors and then divides the capacity of the disk by 255*63&n; (about 8 MB), as soon it sees a disk greater than 1 GB.  That results&n; in a maximum of about 8 GB adressable diskspace in the partition table&n; (but there are already bigger disks out there today).&n;&n; To make it even more complicated the translation mode might/might&n; not be configurable in certain BIOS setups.&n;&n; This driver does some more or less failsafe guessing to get the&n; geometry right in most cases:&n;&n; - for disks&lt;1GB: use default translation (C/32/64)&n; - for disks&gt;1GB:&n;   - take current geometry from the partition table&n;     (using scsicam_bios_param and accept only `valid&squot; geometries,&n;      ie. either (C/32/64) or (C/63/255)).  This can be extended&n;      translation even if it&squot;s not enabled in the driver.&n;   - if that fails, take extended translation if enabled by override,&n;     kernel or module parameter, otherwise take default translation and&n;     ask the user for verification.  This might on not yet partitioned&n;     disks or&n;&n;&n; REFERENCES USED:&n;&n; &quot;AIC-6260 SCSI Chip Specification&quot;, Adaptec Corporation.&n;&n; &quot;SCSI COMPUTER SYSTEM INTERFACE - 2 (SCSI-2)&quot;, X3T9.2/86-109 rev. 10h&n;&n; &quot;Writing a SCSI device driver for Linux&quot;, Rik Faith (faith@cs.unc.edu)&n;&n; &quot;Kernel Hacker&squot;s Guide&quot;, Michael K. Johnson (johnsonm@sunsite.unc.edu)&n;&n; &quot;Adaptec 1520/1522 User&squot;s Guide&quot;, Adaptec Corporation.&n; &n; Michael K. Johnson (johnsonm@sunsite.unc.edu)&n;&n; Drew Eckhardt (drew@cs.colorado.edu)&n;&n; Eric Youngdale (ericy@cais.com) &n;&n; special thanks to Eric Youngdale for the free(!) supplying the&n; documentation on the chip.&n;&n; **************************************************************************/
macro_line|#ifdef PCMCIA
DECL|macro|MODULE
mdefine_line|#define MODULE
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#ifdef PCMCIA
DECL|macro|MODULE
macro_line|#undef MODULE
macro_line|#endif
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &quot;aha152x.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;scsi/scsicam.h&gt;
DECL|variable|proc_scsi_aha152x
r_struct
id|proc_dir_entry
id|proc_scsi_aha152x
op_assign
(brace
id|PROC_SCSI_AHA152X
comma
l_int|7
comma
l_string|&quot;aha152x&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
multiline_comment|/* DEFINES */
multiline_comment|/* For PCMCIA cards, always use AUTOCONF */
macro_line|#if defined(PCMCIA) || defined(MODULE)
macro_line|#if !defined(AUTOCONF)
DECL|macro|AUTOCONF
mdefine_line|#define AUTOCONF
macro_line|#endif
macro_line|#endif
macro_line|#if !defined(AUTOCONF) &amp;&amp; !defined(SETUP0)
macro_line|#error define AUTOCONF or SETUP0
macro_line|#endif
macro_line|#if defined(DEBUG_AHA152X)
DECL|macro|SKIP_PORTS
macro_line|#undef  SKIP_PORTS              /* don&squot;t display ports */
DECL|macro|DEBUG_QUEUE
macro_line|#undef  DEBUG_QUEUE             /* debug queue() */
DECL|macro|DEBUG_RESET
macro_line|#undef  DEBUG_RESET             /* debug reset() */
DECL|macro|DEBUG_INTR
macro_line|#undef  DEBUG_INTR              /* debug intr() */
DECL|macro|DEBUG_SELECTION
macro_line|#undef  DEBUG_SELECTION         /* debug selection part in intr() */
DECL|macro|DEBUG_MSGO
macro_line|#undef  DEBUG_MSGO              /* debug message out phase in intr() */
DECL|macro|DEBUG_MSGI
macro_line|#undef  DEBUG_MSGI              /* debug message in phase in intr() */
DECL|macro|DEBUG_STATUS
macro_line|#undef  DEBUG_STATUS            /* debug status phase in intr() */
DECL|macro|DEBUG_CMD
macro_line|#undef  DEBUG_CMD               /* debug command phase in intr() */
DECL|macro|DEBUG_DATAI
macro_line|#undef  DEBUG_DATAI             /* debug data in phase in intr() */
DECL|macro|DEBUG_DATAO
macro_line|#undef  DEBUG_DATAO             /* debug data out phase in intr() */
DECL|macro|DEBUG_ABORT
macro_line|#undef  DEBUG_ABORT             /* debug abort() */
DECL|macro|DEBUG_DONE
macro_line|#undef  DEBUG_DONE              /* debug done() */
DECL|macro|DEBUG_BIOSPARAM
macro_line|#undef  DEBUG_BIOSPARAM         /* debug biosparam() */
DECL|macro|DEBUG_RACE
macro_line|#undef  DEBUG_RACE              /* debug race conditions */
DECL|macro|DEBUG_PHASES
macro_line|#undef  DEBUG_PHASES            /* debug phases (useful to trace) */
DECL|macro|DEBUG_QUEUES
macro_line|#undef  DEBUG_QUEUES            /* debug reselection */
multiline_comment|/* recently used for debugging */
macro_line|#if 0
macro_line|#endif
DECL|macro|DEBUG_SELECTION
mdefine_line|#define DEBUG_SELECTION
DECL|macro|DEBUG_PHASES
mdefine_line|#define DEBUG_PHASES
DECL|macro|DEBUG_RESET
mdefine_line|#define DEBUG_RESET
DECL|macro|DEBUG_ABORT
mdefine_line|#define DEBUG_ABORT
DECL|macro|DEBUG_DEFAULT
mdefine_line|#define DEBUG_DEFAULT (debug_reset|debug_abort)
macro_line|#endif
multiline_comment|/* END OF DEFINES */
r_extern
r_int
id|loops_per_sec
suffix:semicolon
DECL|macro|DELAY_DEFAULT
mdefine_line|#define DELAY_DEFAULT 100
multiline_comment|/* some additional &quot;phases&quot; for getphase() */
DECL|macro|P_BUSFREE
mdefine_line|#define P_BUSFREE  1
DECL|macro|P_PARITY
mdefine_line|#define P_PARITY   2
multiline_comment|/* possible irq range */
DECL|macro|IRQ_MIN
mdefine_line|#define IRQ_MIN 9
DECL|macro|IRQ_MAX
mdefine_line|#define IRQ_MAX 12
DECL|macro|IRQS
mdefine_line|#define IRQS    IRQ_MAX-IRQ_MIN+1
r_enum
(brace
DECL|enumerator|not_issued
id|not_issued
op_assign
l_int|0x0001
comma
DECL|enumerator|in_selection
id|in_selection
op_assign
l_int|0x0002
comma
DECL|enumerator|disconnected
id|disconnected
op_assign
l_int|0x0004
comma
DECL|enumerator|aborted
id|aborted
op_assign
l_int|0x0008
comma
DECL|enumerator|sent_ident
id|sent_ident
op_assign
l_int|0x0010
comma
DECL|enumerator|in_other
id|in_other
op_assign
l_int|0x0020
comma
DECL|enumerator|in_sync
id|in_sync
op_assign
l_int|0x0040
comma
DECL|enumerator|sync_ok
id|sync_ok
op_assign
l_int|0x0080
comma
)brace
suffix:semicolon
macro_line|#if defined(MODULE)
macro_line|#if defined(DEBUG_AHA152X)
DECL|variable|aha152x
r_int
id|aha152x
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
id|DELAY_DEFAULT
comma
l_int|0
comma
id|DEBUG_DEFAULT
)brace
suffix:semicolon
DECL|variable|aha152x1
r_int
id|aha152x1
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
id|DELAY_DEFAULT
comma
l_int|0
comma
id|DEBUG_DEFAULT
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x
comma
l_string|&quot;1-9i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x1
comma
l_string|&quot;1-9i&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|variable|aha152x
r_int
id|aha152x
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
id|DELAY_DEFAULT
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|aha152x1
r_int
id|aha152x1
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|11
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
id|DELAY_DEFAULT
comma
l_int|0
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha152x1
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
multiline_comment|/* set by aha152x_setup according to the command line */
DECL|variable|setup_count
r_static
r_int
id|setup_count
op_assign
l_int|0
suffix:semicolon
DECL|struct|aha152x_setup
r_static
r_struct
id|aha152x_setup
(brace
DECL|member|io_port
r_int
id|io_port
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|scsiid
r_int
id|scsiid
suffix:semicolon
DECL|member|reconnect
r_int
id|reconnect
suffix:semicolon
DECL|member|parity
r_int
id|parity
suffix:semicolon
DECL|member|synchronous
r_int
id|synchronous
suffix:semicolon
DECL|member|delay
r_int
id|delay
suffix:semicolon
DECL|member|ext_trans
r_int
id|ext_trans
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
DECL|member|debug
r_int
id|debug
suffix:semicolon
macro_line|#endif
DECL|member|conf
r_char
op_star
id|conf
suffix:semicolon
DECL|variable|setup
)brace
id|setup
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|aha152x_host
r_static
r_struct
id|Scsi_Host
op_star
id|aha152x_host
(braket
id|IRQS
)braket
suffix:semicolon
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(shpnt)   ((struct aha152x_hostdata *) &amp;shpnt-&gt;hostdata)
DECL|macro|CURRENT_SC
mdefine_line|#define CURRENT_SC        (HOSTDATA(shpnt)-&gt;current_SC)
DECL|macro|ISSUE_SC
mdefine_line|#define ISSUE_SC          (HOSTDATA(shpnt)-&gt;issue_SC)
DECL|macro|DISCONNECTED_SC
mdefine_line|#define DISCONNECTED_SC   (HOSTDATA(shpnt)-&gt;disconnected_SC)
DECL|macro|DELAY
mdefine_line|#define DELAY             (HOSTDATA(shpnt)-&gt;delay)
DECL|macro|EXT_TRANS
mdefine_line|#define EXT_TRANS         (HOSTDATA(shpnt)-&gt;ext_trans)
DECL|macro|SYNCRATE
mdefine_line|#define SYNCRATE          (HOSTDATA(shpnt)-&gt;syncrate[CURRENT_SC-&gt;target])
DECL|macro|MSG
mdefine_line|#define MSG(i)            (HOSTDATA(shpnt)-&gt;message[i])
DECL|macro|MSGLEN
mdefine_line|#define MSGLEN            (HOSTDATA(shpnt)-&gt;message_len)
DECL|macro|ADDMSG
mdefine_line|#define ADDMSG(x)         (MSG(MSGLEN++)=x)
DECL|struct|aha152x_hostdata
r_struct
id|aha152x_hostdata
(brace
DECL|member|issue_SC
id|Scsi_Cmnd
op_star
id|issue_SC
suffix:semicolon
DECL|member|current_SC
id|Scsi_Cmnd
op_star
id|current_SC
suffix:semicolon
DECL|member|disconnected_SC
id|Scsi_Cmnd
op_star
id|disconnected_SC
suffix:semicolon
DECL|member|aborting
r_int
id|aborting
suffix:semicolon
DECL|member|abortion_complete
r_int
id|abortion_complete
suffix:semicolon
DECL|member|abort_result
r_int
id|abort_result
suffix:semicolon
DECL|member|commands
r_int
id|commands
suffix:semicolon
DECL|member|reconnect
r_int
id|reconnect
suffix:semicolon
DECL|member|parity
r_int
id|parity
suffix:semicolon
DECL|member|synchronous
r_int
id|synchronous
suffix:semicolon
DECL|member|delay
r_int
id|delay
suffix:semicolon
DECL|member|ext_trans
r_int
id|ext_trans
suffix:semicolon
DECL|member|swint
r_int
id|swint
suffix:semicolon
DECL|member|syncrate
r_int
r_char
id|syncrate
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|message
r_int
r_char
id|message
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|message_len
r_int
id|message_len
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
DECL|member|debug
r_int
id|debug
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
r_void
id|aha152x_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_void
id|aha152x_done
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
id|error
)paren
suffix:semicolon
r_void
id|aha152x_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
r_int
id|aha152x_checksetup
c_func
(paren
r_struct
id|aha152x_setup
op_star
id|setup
)paren
suffix:semicolon
r_static
r_void
id|aha152x_reset_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|aha152x_panic
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_char
op_star
id|msg
)paren
suffix:semicolon
r_static
r_void
id|disp_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|show_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|show_queues
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_void
id|disp_enintr
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
r_static
r_void
id|enter_driver
c_func
(paren
r_const
r_char
op_star
)paren
suffix:semicolon
r_static
r_void
id|leave_driver
c_func
(paren
r_const
r_char
op_star
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* possible i/o addresses for the AIC-6260 */
DECL|variable|ports
r_static
r_int
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x340
comma
multiline_comment|/* default first */
l_int|0x140
)brace
suffix:semicolon
DECL|macro|PORT_COUNT
mdefine_line|#define PORT_COUNT (sizeof(ports) / sizeof(unsigned short))
macro_line|#if !defined(SKIP_BIOSTEST)
multiline_comment|/* possible locations for the Adaptec BIOS */
DECL|variable|addresses
r_static
r_int
r_int
id|addresses
(braket
)braket
op_assign
(brace
l_int|0xdc000
comma
multiline_comment|/* default first */
l_int|0xc8000
comma
l_int|0xcc000
comma
l_int|0xd0000
comma
l_int|0xd4000
comma
l_int|0xd8000
comma
l_int|0xe0000
comma
l_int|0xeb800
comma
multiline_comment|/* VTech Platinum SMP */
l_int|0xf0000
comma
)brace
suffix:semicolon
DECL|macro|ADDRESS_COUNT
mdefine_line|#define ADDRESS_COUNT (sizeof(addresses) / sizeof(unsigned int))
multiline_comment|/* signatures for various AIC-6[23]60 based controllers.&n;   The point in detecting signatures is to avoid useless and maybe&n;   harmful probes on ports. I&squot;m not sure that all listed boards pass&n;   auto-configuration. For those which fail the BIOS signature is&n;   obsolete, because user intervention to supply the configuration is&n;   needed anyway.  May be an information whether or not the BIOS supports&n;   extended translation could be also useful here. */
DECL|struct|signature
r_static
r_struct
id|signature
(brace
DECL|member|signature
r_int
r_char
op_star
id|signature
suffix:semicolon
DECL|member|sig_offset
r_int
id|sig_offset
suffix:semicolon
DECL|member|sig_length
r_int
id|sig_length
suffix:semicolon
DECL|variable|signatures
)brace
id|signatures
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Adaptec AHA-1520 BIOS&quot;
comma
l_int|0x102e
comma
l_int|21
)brace
comma
multiline_comment|/* Adaptec 152x */
(brace
l_string|&quot;Adaptec ASW-B626 BIOS&quot;
comma
l_int|0x1029
comma
l_int|21
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;Adaptec BIOS: ASW-B626&quot;
comma
l_int|0x0f
comma
l_int|22
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;Adaptec ASW-B626 S2&quot;
comma
l_int|0x2e6c
comma
l_int|19
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;Adaptec BIOS:AIC-6360&quot;
comma
l_int|0xc
comma
l_int|21
)brace
comma
multiline_comment|/* on-board controller */
(brace
l_string|&quot;ScsiPro SP-360 BIOS&quot;
comma
l_int|0x2873
comma
l_int|19
)brace
comma
multiline_comment|/* ScsiPro-Controller  */
(brace
l_string|&quot;GA-400 LOCAL BUS SCSI BIOS&quot;
comma
l_int|0x102e
comma
l_int|26
)brace
comma
multiline_comment|/* Gigabyte Local-Bus-SCSI */
(brace
l_string|&quot;Adaptec BIOS:AVA-282X&quot;
comma
l_int|0xc
comma
l_int|21
)brace
comma
multiline_comment|/* Adaptec 282x */
(brace
l_string|&quot;Adaptec IBM Dock II SCSI&quot;
comma
l_int|0x2edd
comma
l_int|24
)brace
comma
multiline_comment|/* IBM Thinkpad Dock II */
(brace
l_string|&quot;Adaptec BIOS:AHA-1532P&quot;
comma
l_int|0x1c
comma
l_int|22
)brace
comma
multiline_comment|/* IBM Thinkpad Dock II SCSI */
)brace
suffix:semicolon
DECL|macro|SIGNATURE_COUNT
mdefine_line|#define SIGNATURE_COUNT (sizeof(signatures) / sizeof(struct signature))
macro_line|#endif
DECL|function|do_pause
r_static
r_void
id|do_pause
c_func
(paren
r_int
id|amount
)paren
multiline_comment|/* Pause for amount*10 milliseconds */
(brace
r_int
r_int
id|the_time
op_assign
id|jiffies
op_plus
id|amount
suffix:semicolon
multiline_comment|/* 0.01 seconds per jiffy */
r_while
c_loop
(paren
id|jiffies
OL
id|the_time
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  queue services:&n; */
DECL|function|append_SC
r_static
r_inline
r_void
id|append_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
id|Scsi_Cmnd
op_star
id|new_SC
)paren
(brace
id|Scsi_Cmnd
op_star
id|end
suffix:semicolon
id|new_SC-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|SC
)paren
(brace
op_star
id|SC
op_assign
id|new_SC
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|end
op_assign
op_star
id|SC
suffix:semicolon
id|end-&gt;host_scribble
suffix:semicolon
id|end
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|end-&gt;host_scribble
)paren
(brace
suffix:semicolon
)brace
id|end-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|new_SC
suffix:semicolon
)brace
)brace
DECL|function|remove_first_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_first_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
id|ptr
op_assign
op_star
id|SC
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
(brace
op_star
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
op_star
id|SC
)paren
op_member_access_from_pointer
id|host_scribble
suffix:semicolon
)brace
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|remove_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
r_int
id|target
comma
r_int
id|lun
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
comma
op_star
id|prev
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
op_star
id|SC
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_logical_and
(paren
(paren
id|ptr-&gt;target
op_ne
id|target
)paren
op_logical_or
(paren
id|ptr-&gt;lun
op_ne
id|lun
)paren
)paren
suffix:semicolon
id|prev
op_assign
id|ptr
comma
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr
)paren
r_if
c_cond
(paren
id|prev
)paren
(brace
id|prev-&gt;host_scribble
op_assign
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
r_else
op_star
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
multiline_comment|/*&n; * read inbound byte and wait for ACK to get low&n; */
DECL|function|make_acklow
r_static
r_void
id|make_acklow
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|SPIOEN
)paren
suffix:semicolon
id|GETPORT
c_func
(paren
id|SCSIDAT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|TESTHI
c_func
(paren
id|SCSISIG
comma
id|ACKI
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * detect current phase more reliable:&n; * phase is valid, when the target asserts REQ after we&squot;ve deasserted ACK.&n; *&n; * return value is a valid phase or an error code.&n; *&n; * errorcodes:&n; *   P_BUSFREE   BUS FREE phase detected&n; *   P_PARITY    parity error in DATA phase&n; */
DECL|function|getphase
r_static
r_int
id|getphase
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|phase
comma
id|sstat1
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_do
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|sstat1
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
)paren
op_amp
(paren
id|BUSFREE
op_or
id|SCSIRSTI
op_or
id|REQINIT
)paren
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstat1
op_amp
id|BUSFREE
)paren
(brace
r_return
id|P_BUSFREE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstat1
op_amp
id|SCSIRSTI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: RESET IN&bslash;n&quot;
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|SCSIRSTI
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|TESTHI
c_func
(paren
id|SCSISIG
comma
id|ACKI
)paren
op_logical_or
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|REQINIT
)paren
)paren
(brace
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRSCSIPERR
)paren
suffix:semicolon
id|phase
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
op_amp
id|P_MASK
suffix:semicolon
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|SSTAT1
comma
id|SCSIPERR
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|phase
op_amp
(paren
id|CDO
op_or
id|MSGO
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* DATA phase */
r_return
id|P_PARITY
suffix:semicolon
)brace
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_else
r_return
id|phase
suffix:semicolon
)brace
)brace
multiline_comment|/* called from init/main.c */
DECL|function|aha152x_setup
r_void
id|aha152x_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|setup_count
OG
l_int|2
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;aha152x: you can only configure up to two controllers&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|setup
(braket
id|setup_count
)braket
dot
id|conf
op_assign
id|str
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|1
ques
c_cond
id|ints
(braket
l_int|1
)braket
suffix:colon
l_int|0x340
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|2
ques
c_cond
id|ints
(braket
l_int|2
)braket
suffix:colon
l_int|11
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|3
ques
c_cond
id|ints
(braket
l_int|3
)braket
suffix:colon
l_int|7
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|4
ques
c_cond
id|ints
(braket
l_int|4
)braket
suffix:colon
l_int|1
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|5
ques
c_cond
id|ints
(braket
l_int|5
)braket
suffix:colon
l_int|1
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|6
ques
c_cond
id|ints
(braket
l_int|6
)braket
suffix:colon
l_int|0
multiline_comment|/* FIXME: 1 */
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|7
ques
c_cond
id|ints
(braket
l_int|7
)braket
suffix:colon
id|DELAY_DEFAULT
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|8
ques
c_cond
id|ints
(braket
l_int|8
)braket
suffix:colon
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|9
ques
c_cond
id|ints
(braket
l_int|9
)braket
suffix:colon
id|DEBUG_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|9
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: usage: aha152x=&lt;IOBASE&gt;[,&lt;IRQ&gt;[,&lt;SCSI ID&gt;&quot;
l_string|&quot;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt;[,&lt;EXT_TRANS&gt;[,&lt;DEBUG&gt;]]]]]]]]&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: usage: aha152x=&lt;IOBASE&gt;[,&lt;IRQ&gt;[,&lt;SCSI ID&gt;&quot;
l_string|&quot;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt;[,&lt;EXT_TRANS&gt;]]]]]]]&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
id|setup_count
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Test, if port_base is valid.&n; */
DECL|function|aha152x_porttest
r_static
r_int
id|aha152x_porttest
c_func
(paren
r_int
id|io_port
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_port
comma
id|IO_RANGE
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset stack pointer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_STACK
comma
id|i
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|io_port
op_plus
id|O_DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset stack pointer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
op_logical_and
id|GETPORT
c_func
(paren
id|io_port
op_plus
id|O_STACK
)paren
op_eq
id|i
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_return
id|i
op_eq
l_int|16
suffix:semicolon
)brace
DECL|function|aha152x_checksetup
r_int
id|aha152x_checksetup
c_func
(paren
r_struct
id|aha152x_setup
op_star
id|setup
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifndef PCMCIA
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PORT_COUNT
op_logical_and
(paren
id|setup-&gt;io_port
op_ne
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|PORT_COUNT
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|aha152x_porttest
c_func
(paren
id|setup-&gt;io_port
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;irq
id|IRQ_MAX
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|setup-&gt;scsiid
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;scsiid
OG
l_int|7
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|setup-&gt;reconnect
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;reconnect
OG
l_int|1
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|setup-&gt;parity
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;parity
OG
l_int|1
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|setup-&gt;synchronous
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;synchronous
OG
l_int|1
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|setup-&gt;ext_trans
OL
l_int|0
)paren
op_logical_or
(paren
id|setup-&gt;ext_trans
OG
l_int|1
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|aha152x_swintr
r_void
id|aha152x_swintr
c_func
(paren
r_int
id|irqno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|aha152x_host
(braket
id|irqno
op_minus
id|IRQ_MIN
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;aha152x: catched software interrupt for unknown controller.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
op_increment
suffix:semicolon
)brace
DECL|function|aha152x_detect
r_int
id|aha152x_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|i
comma
id|j
comma
id|ok
suffix:semicolon
macro_line|#if defined(AUTOCONF)
id|aha152x_config
id|conf
suffix:semicolon
macro_line|#endif
id|tpnt-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_aha152x
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aha152x_host
(braket
id|i
)braket
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup_count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: processing commandline: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|setup_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|aha152x_checksetup
c_func
(paren
op_amp
id|setup
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: %s&bslash;n&quot;
comma
id|setup
(braket
id|i
)braket
dot
id|conf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha152x: invalid line (controller=%d)&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ok&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef SETUP0
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
)paren
(brace
r_struct
id|aha152x_setup
id|override
op_assign
id|SETUP0
suffix:semicolon
r_if
c_cond
(paren
id|setup_count
op_eq
l_int|0
op_logical_or
(paren
id|override.io_port
op_ne
id|setup
(braket
l_int|0
)braket
dot
id|io_port
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|aha152x_checksetup
c_func
(paren
op_amp
id|override
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: invalid override SETUP0={0x%x,%d,%d,%d,%d,%d,%d,%d}&bslash;n&quot;
comma
id|override.io_port
comma
id|override.irq
comma
id|override.scsiid
comma
id|override.reconnect
comma
id|override.parity
comma
id|override.synchronous
comma
id|override.delay
comma
id|override.ext_trans
)paren
suffix:semicolon
)brace
r_else
id|setup
(braket
id|setup_count
op_increment
)braket
op_assign
id|override
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef SETUP1
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
)paren
(brace
r_struct
id|aha152x_setup
id|override
op_assign
id|SETUP1
suffix:semicolon
r_if
c_cond
(paren
id|setup_count
op_eq
l_int|0
op_logical_or
(paren
id|override.io_port
op_ne
id|setup
(braket
l_int|0
)braket
dot
id|io_port
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|aha152x_checksetup
c_func
(paren
op_amp
id|override
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: invalid override SETUP1={0x%x,%d,%d,%d,%d,%d,%d,%d}&bslash;n&quot;
comma
id|override.io_port
comma
id|override.irq
comma
id|override.scsiid
comma
id|override.reconnect
comma
id|override.parity
comma
id|override.synchronous
comma
id|override.delay
comma
id|override.ext_trans
)paren
suffix:semicolon
)brace
r_else
id|setup
(braket
id|setup_count
op_increment
)braket
op_assign
id|override
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(MODULE)
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
op_logical_and
id|aha152x
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|conf
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|aha152x
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|aha152x
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|aha152x
(braket
l_int|2
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|aha152x
(braket
l_int|3
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|aha152x
(braket
l_int|4
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|aha152x
(braket
l_int|5
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|aha152x
(braket
l_int|6
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|aha152x
(braket
l_int|7
)braket
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|aha152x
(braket
l_int|8
)braket
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|aha152x_checksetup
c_func
(paren
op_amp
id|setup
(braket
id|setup_count
)braket
)paren
)paren
(brace
id|setup_count
op_increment
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: invalid module argument aha152x=0x%x,%d,%d,%d,%d,%d,%d,%d&bslash;n&quot;
comma
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
comma
id|setup
(braket
id|setup_count
)braket
dot
id|irq
comma
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
comma
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
comma
id|setup
(braket
id|setup_count
)braket
dot
id|parity
comma
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
comma
id|setup
(braket
id|setup_count
)braket
dot
id|delay
comma
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
op_logical_and
id|aha152x1
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|setup
(braket
id|setup_count
)braket
dot
id|conf
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|aha152x1
(braket
l_int|0
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|aha152x1
(braket
l_int|1
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|aha152x1
(braket
l_int|2
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|aha152x1
(braket
l_int|3
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
id|aha152x1
(braket
l_int|4
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
id|aha152x1
(braket
l_int|5
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|aha152x1
(braket
l_int|6
)braket
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
id|aha152x1
(braket
l_int|7
)braket
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|aha152x1
(braket
l_int|8
)braket
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|aha152x_checksetup
c_func
(paren
op_amp
id|setup
(braket
id|setup_count
)braket
)paren
)paren
(brace
id|setup_count
op_increment
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: invalid module argument aha152x1=0x%x,%d,%d,%d,%d,%d,%d,%d&bslash;n&quot;
comma
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
comma
id|setup
(braket
id|setup_count
)braket
dot
id|irq
comma
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
comma
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
comma
id|setup
(braket
id|setup_count
)braket
dot
id|parity
comma
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
comma
id|setup
(braket
id|setup_count
)braket
dot
id|delay
comma
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(AUTOCONF)
r_if
c_cond
(paren
id|setup_count
OL
l_int|2
)paren
(brace
macro_line|#if !defined(SKIP_BIOSTEST)
id|ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ADDRESS_COUNT
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|SIGNATURE_COUNT
)paren
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|j
op_increment
)paren
(brace
id|ok
op_assign
id|check_signature
c_func
(paren
id|addresses
(braket
id|i
)braket
op_plus
id|signatures
(braket
id|j
)braket
dot
id|sig_offset
comma
id|signatures
(braket
id|j
)braket
dot
id|signature
comma
id|signatures
(braket
id|j
)braket
dot
id|sig_length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
op_logical_and
id|setup_count
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;aha152x: BIOS test: passed, &quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;aha152x: &quot;
)paren
suffix:semicolon
macro_line|#endif /* !SKIP_BIOSTEST */
id|ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PORT_COUNT
op_logical_and
id|setup_count
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|setup_count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|setup
(braket
l_int|0
)braket
dot
id|io_port
op_eq
id|ports
(braket
id|i
)braket
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aha152x_porttest
c_func
(paren
id|ports
(braket
id|i
)braket
)paren
)paren
(brace
id|ok
op_increment
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|io_port
op_assign
id|ports
(braket
id|i
)braket
suffix:semicolon
id|conf.cf_port
op_assign
(paren
id|GETPORT
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
id|O_PORTA
)paren
op_lshift
l_int|8
)paren
op_plus
id|GETPORT
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
id|O_PORTB
)paren
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|irq
op_assign
id|IRQ_MIN
op_plus
id|conf.cf_irq
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|scsiid
op_assign
id|conf.cf_id
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|reconnect
op_assign
id|conf.cf_tardisc
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|parity
op_assign
op_logical_neg
id|conf.cf_parity
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|synchronous
op_assign
l_int|0
multiline_comment|/* FIXME: conf.cf_syncneg */
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|delay
op_assign
id|DELAY_DEFAULT
suffix:semicolon
id|setup
(braket
id|setup_count
)braket
dot
id|ext_trans
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
id|setup
(braket
id|setup_count
)braket
dot
id|debug
op_assign
id|DEBUG_DEFAULT
suffix:semicolon
macro_line|#endif
id|setup_count
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ok
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;auto configuration: ok, &quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;detected %d controller(s)&bslash;n&quot;
comma
id|setup_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|setup_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
r_int
r_int
id|the_time
suffix:semicolon
id|shpnt
op_assign
id|aha152x_host
(braket
id|setup
(braket
id|i
)braket
dot
id|irq
op_minus
id|IRQ_MIN
)braket
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|aha152x_hostdata
)paren
)paren
suffix:semicolon
id|shpnt-&gt;io_port
op_assign
id|setup
(braket
id|i
)braket
dot
id|io_port
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
id|IO_RANGE
suffix:semicolon
id|shpnt-&gt;irq
op_assign
id|setup
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
id|ISSUE_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
l_int|NULL
suffix:semicolon
id|CURRENT_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
l_int|NULL
suffix:semicolon
id|DISCONNECTED_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
l_int|NULL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|reconnect
op_assign
id|setup
(braket
id|i
)braket
dot
id|reconnect
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|parity
op_assign
id|setup
(braket
id|i
)braket
dot
id|parity
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
op_assign
id|setup
(braket
id|i
)braket
dot
id|synchronous
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|delay
op_assign
id|setup
(braket
id|i
)braket
dot
id|delay
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|ext_trans
op_assign
id|setup
(braket
id|i
)braket
dot
id|ext_trans
suffix:semicolon
macro_line|#ifdef DEBUG_AHA152X
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_assign
id|setup
(braket
id|i
)braket
dot
id|debug
suffix:semicolon
macro_line|#endif
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|aborting
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abortion_complete
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abort_result
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|message_len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIID
comma
id|setup
(braket
id|i
)braket
dot
id|scsiid
op_lshift
l_int|4
)paren
suffix:semicolon
id|shpnt-&gt;this_id
op_assign
id|setup
(braket
id|i
)braket
dot
id|scsiid
suffix:semicolon
r_if
c_cond
(paren
id|setup
(braket
id|i
)braket
dot
id|reconnect
)paren
(brace
id|shpnt-&gt;can_queue
op_assign
id|AHA152X_MAXQUEUE
suffix:semicolon
)brace
multiline_comment|/* RESET OUT */
id|SETBITS
c_func
(paren
id|SCSISEQ
comma
id|SCSIRSTO
)paren
suffix:semicolon
id|do_pause
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|CLRBITS
c_func
(paren
id|SCSISEQ
comma
id|SCSIRSTO
)paren
suffix:semicolon
id|do_pause
c_func
(paren
id|setup
(braket
id|i
)braket
dot
id|delay
)paren
suffix:semicolon
id|aha152x_reset_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha152x%d: vital data: PORTBASE=0x%03x, IRQ=%d, SCSI ID=%d,&quot;
l_string|&quot; reconnect=%s, parity=%s, synchronous=%s, delay=%d, extended translation=%s&bslash;n&quot;
comma
id|i
comma
id|shpnt-&gt;io_port
comma
id|shpnt-&gt;irq
comma
id|shpnt-&gt;this_id
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|reconnect
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|parity
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|delay
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|ext_trans
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|IO_RANGE
comma
l_string|&quot;aha152x&quot;
)paren
suffix:semicolon
multiline_comment|/* Register */
multiline_comment|/* not expecting any interrupts */
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
l_int|0
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
id|ok
op_assign
id|request_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|aha152x_swintr
comma
id|SA_INTERRUPT
comma
l_string|&quot;aha152x&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ok
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ok
op_eq
op_minus
id|EINVAL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x%d: bad IRQ %d.&bslash;n&quot;
comma
id|i
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ok
op_eq
op_minus
id|EBUSY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x%d: IRQ %d already in use.&bslash;n&quot;
comma
id|i
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x%d: Unexpected error code %d on requesting IRQ %d.&bslash;n&quot;
comma
id|i
comma
id|ok
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha152x: driver needs an IRQ.&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|shpnt
op_assign
id|aha152x_host
(braket
id|shpnt-&gt;irq
op_minus
id|IRQ_MIN
)braket
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha152x: trying software interrupt, &quot;
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|SWINT
)paren
suffix:semicolon
id|the_time
op_assign
id|jiffies
op_plus
l_int|100
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
op_logical_and
id|jiffies
OL
id|the_time
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|shpnt-&gt;irq
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|swint
)paren
(brace
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;lost.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;aha152x: IRQ %d possibly wrong.  Please verify.&bslash;n&quot;
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|shpnt
op_assign
id|aha152x_host
(braket
id|shpnt-&gt;irq
op_minus
id|IRQ_MIN
)braket
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ok.&bslash;n&quot;
)paren
suffix:semicolon
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|SWINT
)paren
suffix:semicolon
multiline_comment|/* clear interrupts */
id|SETPORT
c_func
(paren
id|SSTAT0
comma
l_int|0x7f
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
l_int|0xef
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|aha152x_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;aha152x&quot;
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: failed to reassign interrupt.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|setup_count
OG
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *  Queue a command and setup interrupts for a free bus.&n; */
DECL|function|aha152x_queue
r_int
id|aha152x_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|enter_driver
c_func
(paren
l_string|&quot;queue&quot;
)paren
suffix:semicolon
macro_line|#else
macro_line|#if defined(DEBUG_QUEUE)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queue
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: queue(), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
macro_line|#if defined(DEBUG_QUEUE)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queue
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCpnt (target = %d lun = %d cmnd = &quot;
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, cmd_len=%d, pieces = %d size = %u), &quot;
comma
id|SCpnt-&gt;cmd_len
comma
id|SCpnt-&gt;use_sg
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* setup scratch area&n;     SCp.ptr              : buffer pointer&n;     SCp.this_residual    : buffer length&n;     SCp.buffer           : next buffer&n;     SCp.buffers_residual : left buffers in list&n;     SCp.phase            : current state of the command */
id|SCpnt-&gt;SCp.phase
op_assign
id|not_issued
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;SCp.Status
op_assign
id|CHECK_CONDITION
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.have_data_in
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn led on, when this is the first command. */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_eq
l_int|1
)paren
(brace
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i+ (%d), &quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
suffix:semicolon
)brace
macro_line|#endif
id|append_SC
c_func
(paren
op_amp
id|ISSUE_SC
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Enable bus free interrupt, when we aren&squot;t currently on the bus */
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;queue&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  We only support commands in interrupt-driven fashion&n; */
DECL|function|aha152x_command
r_int
id|aha152x_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: interrupt driven driver; use aha152x_queue()&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  Abort a queued command&n; *  (commands that are on the bus can&squot;t be aborted easily)&n; */
DECL|function|aha152x_abort
r_int
id|aha152x_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
comma
op_star
id|prev
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_ABORT)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_abort
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: abort(), SCpnt=0x%08x, &quot;
comma
(paren
r_int
r_int
)paren
id|SCpnt
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* look for command in issue queue */
r_for
c_loop
(paren
id|ptr
op_assign
id|ISSUE_SC
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_logical_and
id|ptr
op_ne
id|SCpnt
suffix:semicolon
id|prev
op_assign
id|ptr
comma
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr
)paren
(brace
multiline_comment|/* dequeue */
r_if
c_cond
(paren
id|prev
)paren
(brace
id|prev-&gt;host_scribble
op_assign
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
r_else
id|ISSUE_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ptr-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|ptr-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|ptr
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* if the bus is busy or a command is currently processed,&n;     we can&squot;t do anything more */
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|BUSFREE
)paren
op_logical_or
(paren
id|CURRENT_SC
op_logical_and
id|CURRENT_SC
op_ne
id|SCpnt
)paren
)paren
(brace
multiline_comment|/* fail abortion, if bus is busy */
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bus busy w/o current command, &quot;
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
multiline_comment|/* bus is free */
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
multiline_comment|/* target entered bus free before COMMAND COMPLETE, nothing to abort */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|CURRENT_SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|CURRENT_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|CURRENT_SC
)paren
suffix:semicolon
id|CURRENT_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
l_int|NULL
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* look for command in disconnected queue */
r_for
c_loop
(paren
id|ptr
op_assign
id|DISCONNECTED_SC
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_logical_and
id|ptr
op_ne
id|SCpnt
suffix:semicolon
id|prev
op_assign
id|ptr
comma
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
multiline_comment|/* command wasn&squot;t found */
id|printk
c_func
(paren
l_string|&quot;command not found&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|aborting
)paren
(brace
multiline_comment|/* dequeue */
r_if
c_cond
(paren
id|prev
)paren
(brace
id|prev-&gt;host_scribble
op_assign
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
r_else
id|DISCONNECTED_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
multiline_comment|/* set command current and initiate selection,&n;       let the interrupt routine take care of the abortion */
id|CURRENT_SC
op_assign
id|ptr
suffix:semicolon
id|ptr-&gt;SCp.phase
op_assign
id|in_selection
op_or
id|aborted
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSIID
comma
(paren
id|shpnt-&gt;this_id
op_lshift
id|OID_
)paren
op_or
id|CURRENT_SC-&gt;target
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
id|ABORT
)paren
suffix:semicolon
multiline_comment|/* enable interrupts for SELECTION OUT DONE and SELECTION TIME OUT */
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|ENSELDO
op_or
(paren
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENSELTIMO
)paren
suffix:semicolon
multiline_comment|/* Enable SELECTION OUT sequence */
id|SETBITS
c_func
(paren
id|SCSISEQ
comma
id|ENSELO
op_or
id|ENAUTOATNO
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abort_result
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|aborting
op_increment
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abortion_complete
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Hi Eric, guess what ;-) */
multiline_comment|/* sleep until the abortion is complete */
r_while
c_loop
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abortion_complete
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|aborting
op_assign
l_int|0
suffix:semicolon
r_return
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abort_result
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* we&squot;re already aborting a command */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  Restore default values to the AIC-6260 registers and reset the fifos&n; */
DECL|function|aha152x_reset_ports
r_static
r_void
id|aha152x_reset_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
multiline_comment|/* disable interrupts */
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|RSTFIFO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL1
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSIRATE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* clear all interrupt conditions */
id|SETPORT
c_func
(paren
id|SSTAT0
comma
l_int|0x7f
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
l_int|0xef
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT4
comma
id|SYNCERR
op_or
id|FWERR
op_or
id|FRERR
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL1
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|BRSTCNTRL
comma
l_int|0xf1
)paren
suffix:semicolon
multiline_comment|/* clear SCSI fifo and transfer count */
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRCH1
op_or
id|CLRSTCNT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
multiline_comment|/* enable interrupts */
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Reset registers, reset a hanging bus and&n; *  kill active and disconnected commands for target w/o soft reset&n; */
DECL|function|aha152x_reset
r_int
id|aha152x_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|unused
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
comma
op_star
id|prev
comma
op_star
id|next
suffix:semicolon
id|aha152x_reset_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
multiline_comment|/* Reset, if bus hangs */
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|BUSFREE
)paren
)paren
(brace
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RESET)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_reset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: reset(), bus not free: SCSI RESET OUT&bslash;n&quot;
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ptr
op_assign
id|CURRENT_SC
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_logical_and
op_logical_neg
id|ptr-&gt;device-&gt;soft_reset
)paren
(brace
id|ptr-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|ptr-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|ptr
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|CURRENT_SC
)paren
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|NULL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_assign
id|DISCONNECTED_SC
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ptr-&gt;device-&gt;soft_reset
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
(brace
id|prev-&gt;host_scribble
op_assign
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
r_else
id|DISCONNECTED_SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
id|next
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
id|ptr-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|ptr-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|ptr
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_assign
id|next
suffix:semicolon
)brace
r_else
(brace
id|prev
op_assign
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RESET)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_reset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;commands on targets w/ soft-resets:&bslash;n&quot;
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* RESET OUT */
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|SCSIRSTO
)paren
suffix:semicolon
id|do_pause
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|do_pause
c_func
(paren
id|DELAY
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
)brace
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the &quot;logical geometry&quot;&n; */
DECL|function|aha152x_biosparam
r_int
id|aha152x_biosparam
c_func
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|info_array
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|disk-&gt;device-&gt;host
suffix:semicolon
macro_line|#if defined(DEBUG_BIOSPARAM)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_biosparam
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x_biosparam: dev=%s, size=%d, &quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
comma
id|disk-&gt;capacity
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* try default translation */
id|info_array
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
l_int|64
op_star
l_int|32
)paren
suffix:semicolon
multiline_comment|/* for disks &gt;1GB do some guessing */
r_if
c_cond
(paren
id|info_array
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
(brace
r_int
id|info
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* try to figure out the geometry from the partition table */
r_if
c_cond
(paren
id|scsicam_bios_param
c_func
(paren
id|disk
comma
id|dev
comma
id|info
)paren
OL
l_int|0
op_logical_or
op_logical_neg
(paren
(paren
id|info
(braket
l_int|0
)braket
op_eq
l_int|64
op_logical_and
id|info
(braket
l_int|1
)braket
op_eq
l_int|32
)paren
op_logical_or
(paren
id|info
(braket
l_int|0
)braket
op_eq
l_int|255
op_logical_and
id|info
(braket
l_int|1
)braket
op_eq
l_int|63
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|EXT_TRANS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: unable to verify geometry for disk with &gt;1GB.&bslash;n&quot;
l_string|&quot;         using extended translation.&bslash;n&quot;
)paren
suffix:semicolon
id|info_array
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: unable to verify geometry for disk with &gt;1GB.&bslash;n&quot;
l_string|&quot;         Using default translation. Please verify yourself.&bslash;n&quot;
l_string|&quot;         Perhaps you need to enable extended translation in the driver.&bslash;n&quot;
l_string|&quot;         See /usr/src/linux/drivers/scsi/aha152x.c for details.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|info_array
(braket
l_int|0
)braket
op_assign
id|info
(braket
l_int|0
)braket
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
id|info
(braket
l_int|1
)braket
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|info
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|0
)braket
op_eq
l_int|255
op_logical_and
op_logical_neg
id|EXT_TRANS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: current partition table is using extended translation.&bslash;n&quot;
l_string|&quot;         using it also, although it&squot;s not explicty enabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#if defined(DEBUG_BIOSPARAM)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_biosparam
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bios geometry: head=%d, sec=%d, cyl=%d&bslash;n&quot;
comma
id|info_array
(braket
l_int|0
)braket
comma
id|info_array
(braket
l_int|1
)braket
comma
id|info_array
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;WARNING: check, if the bios geometry is correct.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Internal done function&n; */
DECL|function|aha152x_done
r_void
id|aha152x_done
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
id|error
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|done_SC
suffix:semicolon
macro_line|#if defined(DEBUG_DONE)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: done(), &quot;
)paren
suffix:semicolon
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
macro_line|#if defined(DEBUG_DONE)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;done(%x), &quot;
comma
id|error
)paren
suffix:semicolon
)brace
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|done_SC
op_assign
id|CURRENT_SC
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* turn led off, when no commands are in the driver */
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
(brace
id|SETPORT
c_func
(paren
id|PORTA
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* turn led off */
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ok (%d), &quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Why poll for the BUS FREE phase, when we have setup the interrupt!? */
macro_line|#if defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_phases
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BUS FREE loop, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|BUSFREE
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_phases
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BUS FREE&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
id|done_SC-&gt;result
op_assign
id|error
suffix:semicolon
r_if
c_cond
(paren
id|done_SC-&gt;scsi_done
)paren
(brace
macro_line|#if defined(DEBUG_DONE)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;calling scsi_done, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|done_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|done_SC
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_DONE)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;done returned, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
id|panic
c_func
(paren
l_string|&quot;aha152x: current_SC-&gt;scsi_done() == NULL&quot;
)paren
suffix:semicolon
)brace
r_else
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;done() called outside of command&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupts handler (main routine of the driver)&n; */
DECL|function|aha152x_intr
r_void
id|aha152x_intr
c_func
(paren
r_int
id|irqno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|aha152x_host
(braket
id|irqno
op_minus
id|IRQ_MIN
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|done
op_assign
l_int|0
comma
id|phase
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|enter_driver
c_func
(paren
l_string|&quot;intr&quot;
)paren
suffix:semicolon
macro_line|#else
macro_line|#if defined(DEBUG_INTR)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_intr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: intr(), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;aha152x: catched interrupt for unknown controller.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* no more interrupts from the controller, while we&squot;re busy.&n;     INTEN has to be restored, when we&squot;re ready to leave&n;     intr(). To avoid race conditions, we have to return&n;     immediately afterwards. */
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Yes, sti() really needs to be here */
multiline_comment|/* disconnected target is trying to reconnect.&n;     Only possible, if we have disconnected nexuses and&n;     nothing is occupying the bus.&n;  */
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|SSTAT0
comma
id|SELDI
)paren
op_logical_and
id|DISCONNECTED_SC
op_logical_and
(paren
op_logical_neg
id|CURRENT_SC
op_logical_or
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|in_selection
)paren
)paren
)paren
(brace
r_int
id|identify_msg
comma
id|target
comma
id|i
suffix:semicolon
multiline_comment|/* Avoid conflicts when a target reconnects&n;       while we are trying to connect to another. */
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i+, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|append_SC
c_func
(paren
op_amp
id|ISSUE_SC
comma
id|CURRENT_SC
)paren
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* disable sequences */
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT0
comma
id|CLRSELDI
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRBUSFREE
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_QUEUES) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_queues
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;reselected, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|i
op_assign
id|GETPORT
c_func
(paren
id|SELID
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
id|shpnt-&gt;this_id
)paren
suffix:semicolon
id|target
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;reconnecting target unknown&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
(paren
id|i
op_amp
l_int|1
)paren
op_eq
l_int|0
suffix:semicolon
id|target
op_increment
comma
id|i
op_rshift_assign
l_int|1
)paren
(brace
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELID=%02x, target=%d, &quot;
comma
id|GETPORT
c_func
(paren
id|SELID
)paren
comma
id|target
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SETPORT
c_func
(paren
id|SCSIID
comma
(paren
id|shpnt-&gt;this_id
op_lshift
id|OID_
)paren
op_or
id|target
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|ENRESELI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SELDI
)paren
)paren
(brace
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;RESELI failed&quot;
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIRATE
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|target
)braket
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
id|P_MSGI
)paren
suffix:semicolon
multiline_comment|/* Get identify message */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|getphase
c_func
(paren
id|shpnt
)paren
)paren
op_ne
id|P_MSGI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;target doesn&squot;t enter MSGI to identify (phase=%02x)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;unknown lun&quot;
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|identify_msg
op_assign
id|GETPORT
c_func
(paren
id|SCSIBUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|identify_msg
op_amp
id|IDENTIFY_BASE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;target=%d, inbound message (%02x) != IDENTIFY&bslash;n&quot;
comma
id|target
comma
id|identify_msg
)paren
suffix:semicolon
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;unknown lun&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;identify=%02x, lun=%d, &quot;
comma
id|identify_msg
comma
id|identify_msg
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;d-, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC
op_assign
id|remove_SC
c_func
(paren
op_amp
id|DISCONNECTED_SC
comma
id|target
comma
id|identify_msg
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;lun=%d, &quot;
comma
id|identify_msg
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;no disconnected command for that lun&quot;
)paren
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|disconnected
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|getphase
c_func
(paren
id|shpnt
)paren
op_ne
id|P_MSGI
)paren
(brace
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENBUSFREE
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(reselected) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Check, if we aren&squot;t busy with a command */
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC
)paren
(brace
multiline_comment|/* bus is free to issue a queued command */
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|SSTAT1
comma
id|BUSFREE
)paren
op_logical_and
id|ISSUE_SC
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i-, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC
op_assign
id|remove_first_SC
c_func
(paren
op_amp
id|ISSUE_SC
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_INTR) || defined(DEBUG_SELECTION) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_intr
op_or
id|debug_selection
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;issuing command, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC-&gt;SCp.phase
op_assign
id|in_selection
suffix:semicolon
macro_line|#if defined(DEBUG_INTR) || defined(DEBUG_SELECTION) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_intr
op_or
id|debug_selection
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;selecting %d, &quot;
comma
id|CURRENT_SC-&gt;target
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SETPORT
c_func
(paren
id|SCSIID
comma
(paren
id|shpnt-&gt;this_id
op_lshift
id|OID_
)paren
op_or
id|CURRENT_SC-&gt;target
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts for SELECTION OUT DONE and SELECTION OUT INITIATED */
id|SETPORT
c_func
(paren
id|SXFRCTL1
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|parity
ques
c_cond
(paren
id|ENSPCHK
op_or
id|ENSTIMER
)paren
suffix:colon
id|ENSTIMER
)paren
suffix:semicolon
multiline_comment|/* enable interrupts for SELECTION OUT DONE and SELECTION TIME OUT */
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|ENSELDO
op_or
(paren
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENSELTIMO
)paren
suffix:semicolon
multiline_comment|/* Enable SELECTION OUT sequence */
id|SETBITS
c_func
(paren
id|SCSISEQ
comma
id|ENSELO
op_or
id|ENAUTOATNO
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No command we are busy with and no new to issue */
id|printk
c_func
(paren
l_string|&quot;aha152x: ignoring spurious interrupt, nothing to do&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|DMACNTRL0
comma
id|SWINT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: SWINT is set!  Why?&bslash;n&quot;
)paren
suffix:semicolon
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|SWINT
)paren
suffix:semicolon
)brace
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(selecting) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* the bus is busy with something */
macro_line|#if defined(DEBUG_INTR)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_intr
)paren
(brace
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* we are waiting for the result of a selection attempt */
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|in_selection
)paren
(brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|SELTO
)paren
)paren
multiline_comment|/* no timeout */
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|SSTAT0
comma
id|SELDO
)paren
)paren
(brace
multiline_comment|/* clear BUS FREE interrupt */
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRBUSFREE
)paren
suffix:semicolon
multiline_comment|/* Disable SELECTION OUT sequence */
id|CLRBITS
c_func
(paren
id|SCSISEQ
comma
id|ENSELO
op_or
id|ENAUTOATNO
)paren
suffix:semicolon
multiline_comment|/* Disable SELECTION OUT DONE interrupt */
id|CLRBITS
c_func
(paren
id|SIMODE0
comma
id|ENSELDO
)paren
suffix:semicolon
id|CLRBITS
c_func
(paren
id|SIMODE1
comma
id|ENSELTIMO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SELDO
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: passing bus free condition&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(passing bus free) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|aborted
)paren
(brace
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abort_result
op_assign
id|SCSI_ABORT_ERROR
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abortion_complete
op_increment
suffix:semicolon
)brace
id|aha152x_done
c_func
(paren
id|shpnt
comma
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_SELECTION) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_selection
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELDO (SELID=%x), &quot;
comma
id|GETPORT
c_func
(paren
id|SELID
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* selection was done */
id|SETPORT
c_func
(paren
id|SSTAT0
comma
id|CLRSELDO
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_ABORT)
r_if
c_cond
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_abort
)paren
op_logical_and
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|aborted
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(ABORT) target selected, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|in_selection
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|in_other
suffix:semicolon
id|ADDMSG
c_func
(paren
id|IDENTIFY
c_func
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|reconnect
comma
id|CURRENT_SC-&gt;lun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|SYNCRATE
op_amp
l_int|0x80
)paren
op_logical_and
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
)paren
(brace
id|ADDMSG
c_func
(paren
id|EXTENDED_MESSAGE
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
id|EXTENDED_SDTR
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;outbound SDTR: &quot;
)paren
suffix:semicolon
id|print_msg
c_func
(paren
op_amp
id|MSG
c_func
(paren
id|MSGLEN
op_minus
l_int|5
)paren
)paren
suffix:semicolon
id|SYNCRATE
op_assign
l_int|0x80
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|in_sync
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(SELDO) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SETPORT
c_func
(paren
id|SCSIRATE
comma
id|SYNCRATE
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISIG
comma
id|P_MSGO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENREQINIT
op_or
id|ENBUSFREE
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;neither timeout nor selection&bslash;007&quot;
)paren
suffix:semicolon
r_else
(brace
macro_line|#if defined(DEBUG_SELECTION) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_selection
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELTO, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* end selection attempt */
id|CLRBITS
c_func
(paren
id|SCSISEQ
comma
id|ENSELO
op_or
id|ENAUTOATNO
)paren
suffix:semicolon
multiline_comment|/* timeout */
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRSELTIMO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(SELTO) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|aborted
)paren
(brace
macro_line|#if defined(DEBUG_ABORT)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_abort
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(ABORT) selection timeout, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abort_result
op_assign
id|SCSI_ABORT_ERROR
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abortion_complete
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT0
comma
id|SELINGO
)paren
)paren
(brace
multiline_comment|/* ARBITRATION not won */
id|aha152x_done
c_func
(paren
id|shpnt
comma
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* ARBITRATION won, but SELECTION failed */
id|aha152x_done
c_func
(paren
id|shpnt
comma
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* enable interrupt, when target leaves current phase */
id|phase
op_assign
id|getphase
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|phase
op_amp
op_complement
id|P_MASK
)paren
)paren
(brace
multiline_comment|/* &quot;real&quot; phase */
id|SETPORT
c_func
(paren
id|SCSISIG
comma
id|phase
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRPHASECHG
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_assign
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
op_complement
(paren
(paren
id|P_MASK
op_or
l_int|1
)paren
op_lshift
l_int|16
)paren
)paren
op_or
(paren
id|phase
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* information transfer phase */
r_switch
c_cond
(paren
id|phase
)paren
(brace
r_case
id|P_MSGO
suffix:colon
multiline_comment|/* MESSAGE OUT */
(brace
r_int
id|i
comma
id|identify
op_assign
l_int|0
comma
m_abort
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(DEBUG_INTR) || defined(DEBUG_MSGO) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_intr
op_or
id|debug_msgo
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MESSAGE OUT, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|MSGLEN
op_eq
l_int|0
)paren
(brace
id|ADDMSG
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_MSGO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgo
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unexpected MESSAGE OUT phase; rejecting, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
id|CLRBITS
c_func
(paren
id|SXFRCTL0
comma
id|ENDMA
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENREQINIT
op_or
id|ENBUSFREE
)paren
suffix:semicolon
multiline_comment|/* wait for data latch to become ready or a phase change */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_MSGO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgo
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;messages (&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MSGLEN
suffix:semicolon
id|i
op_add_assign
id|print_msg
c_func
(paren
op_amp
id|MSG
c_func
(paren
id|i
)paren
)paren
comma
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
)paren
(brace
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MSGLEN
op_logical_and
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|PHASEMIS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#if defined(DEBUG_MSGO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgo
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
id|MSG
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|i
op_eq
id|MSGLEN
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Leave MESSAGE OUT after transfer */
id|SETPORT
c_func
(paren
id|SSTAT1
comma
id|CLRATNO
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIDAT
comma
id|MSG
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|getphase
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MSG
c_func
(paren
id|i
)paren
op_eq
id|IDENTIFY
c_func
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|reconnect
comma
id|CURRENT_SC-&gt;lun
)paren
)paren
(brace
id|identify
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSG
c_func
(paren
id|i
)paren
op_eq
id|ABORT
)paren
(brace
m_abort
op_increment
suffix:semicolon
)brace
)brace
id|MSGLEN
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|identify
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|sent_ident
suffix:semicolon
)brace
r_if
c_cond
(paren
m_abort
)paren
(brace
multiline_comment|/* revive abort(); abort() enables interrupts */
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abort_result
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|abortion_complete
op_increment
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
(paren
id|P_MASK
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* exit */
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(ABORT) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|aha152x_done
c_func
(paren
id|shpnt
comma
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
multiline_comment|/* COMMAND phase */
macro_line|#if defined(DEBUG_INTR) || defined(DEBUG_CMD) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_intr
op_or
id|debug_cmd
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;COMMAND, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|CURRENT_SC-&gt;SCp.sent_command
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|CLRBITS
c_func
(paren
id|SXFRCTL0
comma
id|ENDMA
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENREQINIT
op_or
id|ENBUSFREE
)paren
suffix:semicolon
multiline_comment|/* wait for data latch to become ready or a phase change */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CURRENT_SC-&gt;cmd_len
op_logical_and
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|PHASEMIS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SETPORT
c_func
(paren
id|SCSIDAT
comma
id|CURRENT_SC-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|getphase
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|CURRENT_SC-&gt;cmd_len
op_logical_and
id|TESTHI
c_func
(paren
id|SSTAT1
comma
id|PHASEMIS
)paren
)paren
(brace
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;target left COMMAND&quot;
)paren
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.sent_command
op_increment
suffix:semicolon
)brace
r_else
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;Nothing to send while in COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
multiline_comment|/* MESSAGE IN phase */
(brace
r_int
id|start_sync
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(DEBUG_INTR) || defined(DEBUG_MSGI) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_intr
op_or
id|debug_msgi
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MESSAGE IN, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENBUSFREE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|phase
op_eq
id|P_MSGI
)paren
(brace
id|CURRENT_SC-&gt;SCp.Message
op_assign
id|GETPORT
c_func
(paren
id|SCSIDAT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|CURRENT_SC-&gt;SCp.Message
)paren
(brace
r_case
id|DISCONNECT
suffix:colon
macro_line|#if defined(DEBUG_MSGI) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_msgi
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;target disconnected, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|disconnected
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|reconnect
)paren
(brace
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;target was not allowed to disconnect&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|COMMAND_COMPLETE
suffix:colon
macro_line|#if defined(DEBUG_MSGI) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_msgi
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;inbound message (COMMAND COMPLETE), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|done
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|in_sync
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|in_sync
suffix:semicolon
id|SYNCRATE
op_assign
l_int|0x80
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;synchronous rejected, &quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;inbound message (MESSAGE REJECT), &quot;
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_MSGI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgi
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;inbound message (MESSAGE REJECT), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
macro_line|#if defined(DEBUG_MSGI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgi
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;inbound message (SAVE DATA POINTERS), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|RESTORE_POINTERS
suffix:colon
macro_line|#if defined(DEBUG_MSGI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgi
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;inbound message (RESTORE DATA POINTERS), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
(brace
r_char
id|buffer
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if defined(DEBUG_MSGI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgi
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;inbound message (EXTENDED MESSAGE), &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|getphase
c_func
(paren
id|shpnt
)paren
op_ne
id|P_MSGI
)paren
(brace
r_break
suffix:semicolon
)brace
id|buffer
(braket
l_int|0
)braket
op_assign
id|EXTENDED_MESSAGE
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|GETPORT
c_func
(paren
id|SCSIDAT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|buffer
(braket
l_int|1
)braket
op_logical_and
(paren
id|make_acklow
c_func
(paren
id|shpnt
)paren
comma
id|getphase
c_func
(paren
id|shpnt
)paren
op_eq
id|P_MSGI
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buffer
(braket
l_int|2
op_plus
id|i
)braket
op_assign
id|GETPORT
c_func
(paren
id|SCSIDAT
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_MSGI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_msgi
)paren
(brace
id|print_msg
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|buffer
(braket
l_int|2
)braket
)paren
(brace
r_case
id|EXTENDED_SDTR
suffix:colon
(brace
r_int
id|ticks
suffix:semicolon
r_if
c_cond
(paren
id|buffer
(braket
l_int|1
)braket
op_ne
l_int|3
)paren
(brace
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;SDTR message length != 3&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
)paren
(brace
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;inbound SDTR: &quot;
)paren
suffix:semicolon
id|print_msg
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|ticks
op_assign
(paren
id|buffer
(braket
l_int|3
)braket
op_star
l_int|4
op_plus
l_int|49
)paren
op_div
l_int|50
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|in_sync
)paren
(brace
multiline_comment|/* we initiated SDTR */
r_if
c_cond
(paren
id|ticks
OG
l_int|9
op_logical_or
id|buffer
(braket
l_int|4
)braket
template_param
l_int|8
)paren
(brace
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;received SDTR invalid&quot;
)paren
suffix:semicolon
)brace
id|SYNCRATE
op_or_assign
(paren
(paren
id|ticks
op_minus
l_int|2
)paren
op_lshift
l_int|4
)paren
op_plus
id|buffer
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ticks
op_le
l_int|9
op_logical_and
id|buffer
(braket
l_int|4
)braket
op_ge
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
l_int|4
)braket
OG
l_int|8
)paren
(brace
id|buffer
(braket
l_int|4
)braket
op_assign
l_int|8
suffix:semicolon
)brace
id|ADDMSG
c_func
(paren
id|EXTENDED_MESSAGE
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
id|EXTENDED_SDTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ticks
OL
l_int|4
)paren
(brace
id|ticks
op_assign
l_int|4
suffix:semicolon
id|ADDMSG
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
r_else
id|ADDMSG
c_func
(paren
id|buffer
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|ADDMSG
c_func
(paren
id|buffer
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;outbound SDTR: &quot;
)paren
suffix:semicolon
id|print_msg
c_func
(paren
op_amp
id|MSG
c_func
(paren
id|MSGLEN
op_minus
l_int|5
)paren
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|in_sync
suffix:semicolon
id|SYNCRATE
op_or_assign
(paren
(paren
id|ticks
op_minus
l_int|2
)paren
op_lshift
l_int|4
)paren
op_plus
id|buffer
(braket
l_int|4
)braket
suffix:semicolon
id|start_sync
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* requested SDTR is too slow, do it asynchronously */
id|ADDMSG
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
id|SYNCRATE
op_assign
l_int|0
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SCSIRATE
comma
id|SYNCRATE
op_amp
l_int|0x7f
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXTENDED_MODIFY_DATA_POINTER
suffix:colon
r_case
id|EXTENDED_EXTENDED_IDENTIFY
suffix:colon
r_case
id|EXTENDED_WDTR
suffix:colon
r_default
suffix:colon
id|ADDMSG
c_func
(paren
id|MESSAGE_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unsupported inbound message %x, &quot;
comma
id|CURRENT_SC-&gt;SCp.Message
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|phase
op_assign
id|getphase
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start_sync
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
id|in_sync
suffix:semicolon
)brace
r_else
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
id|in_sync
suffix:semicolon
r_if
c_cond
(paren
id|MSGLEN
OG
l_int|0
)paren
(brace
id|SETPORT
c_func
(paren
id|SCSISIG
comma
id|P_MSGI
op_or
id|ATNO
)paren
suffix:semicolon
)brace
multiline_comment|/* clear SCSI fifo on BUSFREE */
r_if
c_cond
(paren
id|phase
op_eq
id|P_BUSFREE
)paren
(brace
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRCH1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.phase
op_amp
id|disconnected
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_QUEUES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_queues
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;d+, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|append_SC
c_func
(paren
op_amp
id|DISCONNECTED_SC
comma
id|CURRENT_SC
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
id|CURRENT_SC
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|SCSISEQ
comma
id|ENRESELI
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
multiline_comment|/* STATUS IN phase */
macro_line|#if defined(DEBUG_STATUS) || defined(DEBUG_INTR) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_status
op_or
id|debug_intr
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STATUS, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENREQINIT
op_or
id|ENBUSFREE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|SSTAT1
comma
id|PHASEMIS
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: passing STATUS phase&quot;
)paren
suffix:semicolon
)brace
id|CURRENT_SC-&gt;SCp.Status
op_assign
id|GETPORT
c_func
(paren
id|SCSIBUS
)paren
suffix:semicolon
id|make_acklow
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|getphase
c_func
(paren
id|shpnt
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_STATUS)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;inbound status &quot;
)paren
suffix:semicolon
id|print_status
c_func
(paren
id|CURRENT_SC-&gt;SCp.Status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
multiline_comment|/* DATA IN phase */
(brace
r_int
id|fifodata
comma
id|data_count
comma
id|done
suffix:semicolon
macro_line|#if defined(DEBUG_DATAI) || defined(DEBUG_INTR) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_datai
op_or
id|debug_intr
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DATA IN, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0
r_if
c_cond
(paren
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
op_logical_or
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: P_DATAI: %d(%d) bytes left in FIFO, resetting&bslash;n&quot;
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
comma
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* reset host fifo */
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|RSTFIFO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|RSTFIFO
op_or
id|ENDMA
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|SCSIEN
op_or
id|DMAEN
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENBUSFREE
)paren
suffix:semicolon
multiline_comment|/* done is set when the FIFO is empty after the target left DATA IN */
id|done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* while the target stays in DATA to transfer data */
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;expecting data, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* wait for PHASEMIS or full FIFO */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOFULL
op_or
id|INTSTAT
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ok, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|DFIFOFULL
)paren
)paren
(brace
id|fifodata
op_assign
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* wait for SCSI fifo to get empty */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|SSTAT2
comma
id|SEMPTY
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* rest of data in FIFO */
id|fifodata
op_assign
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;last transfer, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|done
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fifodata=%d, &quot;
comma
id|fifodata
)paren
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|fifodata
op_logical_and
id|CURRENT_SC-&gt;SCp.this_residual
)paren
(brace
id|data_count
op_assign
id|fifodata
suffix:semicolon
multiline_comment|/* limit data transfer to size of first sg buffer */
r_if
c_cond
(paren
id|data_count
OG
id|CURRENT_SC-&gt;SCp.this_residual
)paren
(brace
id|data_count
op_assign
id|CURRENT_SC-&gt;SCp.this_residual
suffix:semicolon
)brace
id|fifodata
op_sub_assign
id|data_count
suffix:semicolon
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;data_count=%d, &quot;
comma
id|data_count
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|data_count
op_amp
l_int|1
)paren
(brace
multiline_comment|/* get a single byte in byte mode */
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|_8BIT
)paren
suffix:semicolon
op_star
id|CURRENT_SC-&gt;SCp.ptr
op_increment
op_assign
id|GETPORT
c_func
(paren
id|DATAPORT
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_count
OG
l_int|1
)paren
(brace
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|_8BIT
)paren
suffix:semicolon
id|data_count
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* Number of words */
id|insw
c_func
(paren
id|DATAPORT
comma
id|CURRENT_SC-&gt;SCp.ptr
comma
id|data_count
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
multiline_comment|/* show what comes with the last transfer */
r_if
c_cond
(paren
id|done
)paren
(brace
macro_line|#if 0
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;data on last transfer (%d bytes) &quot;
comma
l_int|2
op_star
id|data_count
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;data on last transfer (%d bytes: &quot;
comma
l_int|2
op_star
id|data_count
)paren
suffix:semicolon
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|CURRENT_SC-&gt;SCp.ptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
op_star
id|data_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2x &quot;
comma
op_star
id|data
op_increment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;), &quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
id|CURRENT_SC-&gt;SCp.ptr
op_add_assign
l_int|2
op_star
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_sub_assign
l_int|2
op_star
id|data_count
suffix:semicolon
)brace
multiline_comment|/* if this buffer is full and there are more buffers left */
r_if
c_cond
(paren
op_logical_neg
id|CURRENT_SC-&gt;SCp.this_residual
op_logical_and
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
(brace
multiline_comment|/* advance to next buffer */
id|CURRENT_SC-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|CURRENT_SC-&gt;SCp.buffer
op_increment
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;         * FIFO should be empty&n;         */
r_if
c_cond
(paren
id|fifodata
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: more data than expected (%d bytes)&bslash;n&quot;
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|_8BIT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha152x: data (&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fifodata
op_decrement
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2x &quot;
comma
id|GETPORT
c_func
(paren
id|DATAPORT
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
r_if
c_cond
(paren
op_logical_neg
id|fifodata
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fifo empty, &quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;something left in fifo, &quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if defined(DEBUG_DATAI)
r_if
c_cond
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datai
)paren
op_logical_and
(paren
id|CURRENT_SC-&gt;SCp.buffers_residual
op_logical_or
id|CURRENT_SC-&gt;SCp.this_residual
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;left buffers (buffers=%d, bytes=%d), &quot;
comma
id|CURRENT_SC-&gt;SCp.buffers_residual
comma
id|CURRENT_SC-&gt;SCp.this_residual
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* transfer can be considered ended, when SCSIEN reads back zero */
id|CLRBITS
c_func
(paren
id|SXFRCTL0
comma
id|SCSIEN
op_or
id|DMAEN
)paren
suffix:semicolon
r_while
c_loop
(paren
id|TESTHI
c_func
(paren
id|SXFRCTL0
comma
id|SCSIEN
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_DATAI) || defined(DEBUG_INTR)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_datai
op_or
id|debug_intr
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;got %d bytes, &quot;
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC-&gt;SCp.have_data_in
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|P_DATAO
suffix:colon
multiline_comment|/* DATA OUT phase */
(brace
r_int
id|data_count
suffix:semicolon
macro_line|#if defined(DEBUG_DATAO) || defined(DEBUG_INTR) || defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_datao
op_or
id|debug_intr
op_or
id|debug_phases
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DATA OUT, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;got data to send (bytes=%d, buffers=%d), &quot;
comma
id|CURRENT_SC-&gt;SCp.this_residual
comma
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
op_logical_or
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d(%d) left in FIFO, &quot;
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
comma
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
suffix:semicolon
id|aha152x_panic
c_func
(paren
id|shpnt
comma
l_string|&quot;FIFO should be empty&quot;
)paren
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|CH1
op_or
id|CLRSTCNT
op_or
id|CLRCH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SXFRCTL0
comma
id|SCSIEN
op_or
id|DMAEN
op_or
id|CH1
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|WRITE_READ
op_or
id|RSTFIFO
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
op_or
id|WRITE_READ
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENBUSFREE
)paren
suffix:semicolon
multiline_comment|/* while current buffer is not empty or&n;         there are more buffers to transfer */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|PHASEMIS
)paren
op_logical_and
(paren
id|CURRENT_SC-&gt;SCp.this_residual
op_logical_or
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
)paren
(brace
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sending data (left: bytes=%d, buffers=%d), waiting, &quot;
comma
id|CURRENT_SC-&gt;SCp.this_residual
comma
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* transfer rest of buffer, but max. 128 byte */
id|data_count
op_assign
id|CURRENT_SC-&gt;SCp.this_residual
OG
l_int|128
ques
c_cond
l_int|128
suffix:colon
id|CURRENT_SC-&gt;SCp.this_residual
suffix:semicolon
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;data_count=%d, &quot;
comma
id|data_count
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|data_count
op_amp
l_int|1
)paren
(brace
multiline_comment|/* put a single byte in byte mode */
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|_8BIT
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|DATAPORT
comma
op_star
id|CURRENT_SC-&gt;SCp.ptr
op_increment
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_count
OG
l_int|1
)paren
(brace
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|_8BIT
)paren
suffix:semicolon
id|data_count
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* number of words */
id|outsw
c_func
(paren
id|DATAPORT
comma
id|CURRENT_SC-&gt;SCp.ptr
comma
id|data_count
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_add_assign
l_int|2
op_star
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_sub_assign
l_int|2
op_star
id|data_count
suffix:semicolon
)brace
multiline_comment|/* wait for FIFO to get empty */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|DMASTAT
comma
id|DFIFOEMP
op_or
id|INTSTAT
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fifo (%d bytes), transfered (%d bytes), &quot;
comma
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* if this buffer is empty and there are more buffers left */
r_if
c_cond
(paren
id|TESTLO
c_func
(paren
id|SSTAT1
comma
id|PHASEMIS
)paren
op_logical_and
op_logical_neg
id|CURRENT_SC-&gt;SCp.this_residual
op_logical_and
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
(brace
multiline_comment|/* advance to next buffer */
id|CURRENT_SC-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|CURRENT_SC-&gt;SCp.buffer
op_increment
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_assign
id|CURRENT_SC-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|CURRENT_SC-&gt;SCp.this_residual
op_logical_or
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
(brace
multiline_comment|/* target leaves DATA OUT for an other phase (perhaps disconnect) */
multiline_comment|/* data in fifos has to be resend */
id|data_count
op_assign
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
suffix:semicolon
id|data_count
op_add_assign
id|GETPORT
c_func
(paren
id|FIFOSTAT
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.ptr
op_sub_assign
id|data_count
suffix:semicolon
id|CURRENT_SC-&gt;SCp.this_residual
op_add_assign
id|data_count
suffix:semicolon
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;left data (bytes=%d, buffers=%d), fifos (bytes=%d), &quot;
l_string|&quot;transfer incomplete, resetting fifo, &quot;
comma
id|CURRENT_SC-&gt;SCp.this_residual
comma
id|CURRENT_SC-&gt;SCp.buffers_residual
comma
id|data_count
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SETPORT
c_func
(paren
id|DMACNTRL0
comma
id|WRITE_READ
op_or
id|RSTFIFO
)paren
suffix:semicolon
id|CLRBITS
c_func
(paren
id|SXFRCTL0
comma
id|SCSIEN
op_or
id|DMAEN
)paren
suffix:semicolon
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;waiting for SCSI fifo to get empty, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* wait for SCSI fifo to get empty */
r_while
c_loop
(paren
id|TESTLO
c_func
(paren
id|SSTAT2
comma
id|SEMPTY
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_DATAO)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_datao
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ok, left data (bytes=%d, buffers=%d) &quot;
comma
id|CURRENT_SC-&gt;SCp.this_residual
comma
id|CURRENT_SC-&gt;SCp.buffers_residual
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CLRBITS
c_func
(paren
id|SXFRCTL0
comma
id|SCSIEN
op_or
id|DMAEN
)paren
suffix:semicolon
multiline_comment|/* transfer can be considered ended, when SCSIEN reads back zero */
r_while
c_loop
(paren
id|TESTHI
c_func
(paren
id|SXFRCTL0
comma
id|SCSIEN
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|CLRBITS
c_func
(paren
id|DMACNTRL0
comma
id|ENDMA
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_DATAO) || defined(DEBUG_INTR)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
(paren
id|debug_datao
op_or
id|debug_intr
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sent %d data bytes, &quot;
comma
id|GETSTCNT
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_break
suffix:semicolon
r_case
id|P_BUSFREE
suffix:colon
multiline_comment|/* BUSFREE */
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(BUSFREE) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(DEBUG_PHASES)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_phases
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unexpected BUS FREE, &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
(paren
id|P_MASK
op_lshift
l_int|16
)paren
suffix:semicolon
id|aha152x_done
c_func
(paren
id|shpnt
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t know any better */
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_PARITY
suffix:colon
multiline_comment|/* parity error in DATA phase */
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(DID_PARITY) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;PARITY error in DATA phase, &quot;
)paren
suffix:semicolon
id|CURRENT_SC-&gt;SCp.phase
op_and_assign
op_complement
(paren
id|P_MASK
op_lshift
l_int|16
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
id|aha152x_done
c_func
(paren
id|shpnt
comma
id|DID_PARITY
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;aha152x: unexpected phase&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|done
)paren
(brace
macro_line|#if defined(DEBUG_INTR)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_intr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;command done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(done) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SETPORT
c_func
(paren
id|SIMODE0
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENSELDI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ISSUE_SC
ques
c_cond
id|ENBUSFREE
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SCSISEQ
comma
id|DISCONNECTED_SC
ques
c_cond
id|ENRESELI
suffix:colon
l_int|0
)paren
suffix:semicolon
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
id|aha152x_done
c_func
(paren
id|shpnt
comma
(paren
id|CURRENT_SC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|CURRENT_SC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_RACE)
id|printk
c_func
(paren
l_string|&quot;done returned (DID_OK: Status=%x; Message=%x).&bslash;n&quot;
comma
id|CURRENT_SC-&gt;SCp.Status
comma
id|CURRENT_SC-&gt;SCp.Message
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|CURRENT_SC-&gt;SCp.phase
op_or_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
)brace
id|SETPORT
c_func
(paren
id|SIMODE0
comma
l_int|0
)paren
suffix:semicolon
id|SETPORT
c_func
(paren
id|SIMODE1
comma
id|ENPHASEMIS
op_or
id|ENBUSFREE
)paren
suffix:semicolon
macro_line|#if defined(DEBUG_INTR)
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_intr
)paren
(brace
id|disp_enintr
c_func
(paren
id|shpnt
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(DEBUG_RACE)
id|leave_driver
c_func
(paren
l_string|&quot;(PHASEEND) intr&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SETBITS
c_func
(paren
id|DMACNTRL0
comma
id|INTEN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &n; * Dump the current driver status and panic...&n; */
DECL|function|aha152x_panic
r_static
r_void
id|aha152x_panic
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_char
op_star
id|msg
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: %s&bslash;n&quot;
comma
id|msg
)paren
suffix:semicolon
id|show_queues
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;aha152x panic&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display registers of AIC-6260&n; */
DECL|function|disp_ports
r_static
r_void
id|disp_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
macro_line|#ifdef DEBUG_AHA152X
r_int
id|s
suffix:semicolon
macro_line|#ifdef SKIP_PORTS
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_skipports
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;&bslash;n%s: &quot;
comma
id|CURRENT_SC
ques
c_cond
l_string|&quot;on bus&quot;
suffix:colon
l_string|&quot;waiting&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISEQ
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSISEQ (&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TEMODEO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TARGET MODE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENRESELI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RESELI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AUTOATNO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AUTOATNI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AUTOATNP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSIRSTO &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;);&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; SCSISIG (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|s
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_DATAO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DATA OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DATA IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|printk
c_func
(paren
l_string|&quot;COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STATUS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MESSAGE OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MESSAGE IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;*illegal*&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTSTAT (%s); &quot;
comma
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
ques
c_cond
l_string|&quot;hi&quot;
suffix:colon
l_string|&quot;lo&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
)brace
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
)brace
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SXFRCTL0 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SXFRCTL0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSIEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DMAEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMAEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|CH1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CH1 &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|CLRSTCNT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CLRSTCNT &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SPIOEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SPIOEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|CLRCH1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CLRCH1 &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SIGNAL (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATNI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ATNI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|BSYI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BSYI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|REQI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;REQI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ACKI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ACKI &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SELID (%02x), &quot;
comma
id|GETPORT
c_func
(paren
id|SELID
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT2 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SOFFSET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SOFFSET &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SEMPTY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SEMPTY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SFULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SFULL &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); SFCNT (%d); &quot;
comma
id|s
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSICNT (%d), OFFCNT(%d), &quot;
comma
(paren
id|s
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|s
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SSTAT4 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SYNCERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SYNCERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|FWERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FWERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|FRERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FRERR &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMACNTRL0 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMACNTRL0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|_8BIT
ques
c_cond
l_string|&quot;8BIT&quot;
suffix:colon
l_string|&quot;16BIT&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|DMA
ques
c_cond
l_string|&quot;DMA&quot;
suffix:colon
l_string|&quot;PIO&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|WRITE_READ
ques
c_cond
l_string|&quot;WRITE&quot;
suffix:colon
l_string|&quot;READ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENDMA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENDMA &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|INTEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;INTEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|RSTFIFO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RSTFIFO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SWINT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SWINT &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMASTAT (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMASTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATDONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ATDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|WORDRDY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;WORDRDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOFULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DFIFOFULL &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOEMP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DFIFOEMP &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * display enabled interrupts&n; */
DECL|function|disp_enintr
r_static
r_void
id|disp_enintr
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|s
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;enabled interrupts (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSELDO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSELDI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELINGO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSELINGO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSWRAP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSWRAP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSDONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSPIORDY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSPIORDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENDMADONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENDMADONE &quot;
)paren
suffix:semicolon
)brace
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELTIMO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSELTIMO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENATNTARG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENATNTARG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASEMIS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENPHASEMIS &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENBUSFREE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENBUSFREE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSCSIPERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENSCSIPERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASECHG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENPHASECHG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENREQINIT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENREQINIT &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(DEBUG_RACE)
DECL|variable|should_leave
r_static
r_const
r_char
op_star
id|should_leave
suffix:semicolon
DECL|variable|in_driver
r_static
r_int
id|in_driver
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Only one routine can be in the driver at once.&n; */
DECL|function|enter_driver
r_static
r_void
id|enter_driver
c_func
(paren
r_const
r_char
op_star
id|func
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha152x: entering %s() (%x)&bslash;n&quot;
comma
id|func
comma
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_driver
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s should leave first.&bslash;n&quot;
comma
id|should_leave
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;aha152x: already in driver&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|in_driver
op_increment
suffix:semicolon
id|should_leave
op_assign
id|func
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|leave_driver
r_static
r_void
id|leave_driver
c_func
(paren
r_const
r_char
op_star
id|func
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;naha152x: leaving %s() (%x)&bslash;n&quot;
comma
id|func
comma
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|in_driver
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha152x: %s already left.&bslash;n&quot;
comma
id|should_leave
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;aha152x: %s already left driver.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|in_driver
op_decrement
suffix:semicolon
id|should_leave
op_assign
id|func
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Show the command data of a command&n; */
DECL|function|show_command
r_static
r_void
id|show_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|ptr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%08x: target=%d; lun=%d; cmnd=(&quot;
comma
(paren
r_int
r_int
)paren
id|ptr
comma
id|ptr-&gt;target
comma
id|ptr-&gt;lun
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|ptr-&gt;cmnd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;); residual=%d; buffers=%d; phase |&quot;
comma
id|ptr-&gt;SCp.this_residual
comma
id|ptr-&gt;SCp.buffers_residual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|not_issued
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;not issued|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|in_selection
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;in selection|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|disconnected
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;disconnected|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|aborted
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aborted|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|sent_ident
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;send_ident|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|in_other
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;; in other(&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|ptr-&gt;SCp.phase
op_rshift
l_int|16
)paren
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_DATAO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DATA OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DATA IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|printk
c_func
(paren
l_string|&quot;COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STATUS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MESSAGE OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MESSAGE IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;*illegal*&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
(paren
l_int|1
op_lshift
l_int|16
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;; phaseend&quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;; next=0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ptr-&gt;host_scribble
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dump the queued data&n; */
DECL|function|show_queues
r_static
r_void
id|show_queues
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;QUEUE STATUS:&bslash;nissue_SC:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|ISSUE_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
id|show_command
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;current_SC:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|show_command
c_func
(paren
id|CURRENT_SC
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;none&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;disconnected_SC:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|DISCONNECTED_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
id|show_command
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
id|disp_ports
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|disp_enintr
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|aha152x_set_info
r_int
id|aha152x_set_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|length
comma
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
multiline_comment|/* Currently this is a no-op */
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) pos += sprintf(pos, ## args)
DECL|function|get_command
r_static
r_int
id|get_command
c_func
(paren
r_char
op_star
id|pos
comma
id|Scsi_Cmnd
op_star
id|ptr
)paren
(brace
r_char
op_star
id|start
op_assign
id|pos
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;0x%08x: target=%d; lun=%d; cmnd=( &quot;
comma
(paren
r_int
r_int
)paren
id|ptr
comma
id|ptr-&gt;target
comma
id|ptr-&gt;lun
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|COMMAND_SIZE
c_func
(paren
id|ptr-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|ptr-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); residual=%d; buffers=%d; phase |&quot;
comma
id|ptr-&gt;SCp.this_residual
comma
id|ptr-&gt;SCp.buffers_residual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|not_issued
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;not issued|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|in_selection
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;in selection|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|disconnected
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;disconnected|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|aborted
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;aborted|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|sent_ident
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;send_ident|&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
id|in_other
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;; in other(&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|ptr-&gt;SCp.phase
op_rshift
l_int|16
)paren
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_DATAO
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;DATA OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;DATA IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;STATUS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;MESSAGE OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;MESSAGE IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;*illegal*&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;SCp.phase
op_amp
(paren
l_int|1
op_lshift
l_int|16
)paren
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;; phaseend&quot;
)paren
suffix:semicolon
)brace
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;; next=0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ptr-&gt;host_scribble
)paren
suffix:semicolon
r_return
id|pos
op_minus
id|start
suffix:semicolon
)brace
DECL|function|get_ports
r_static
r_int
id|get_ports
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_char
op_star
id|pos
)paren
(brace
r_char
op_star
id|start
op_assign
id|pos
suffix:semicolon
r_int
id|s
suffix:semicolon
macro_line|#ifdef SKIP_PORTS
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|debug
op_amp
id|debug_skipports
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#endif
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n%s: &quot;
comma
id|CURRENT_SC
ques
c_cond
l_string|&quot;on bus&quot;
suffix:colon
l_string|&quot;waiting&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISEQ
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSISEQ (&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TEMODEO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;TARGET MODE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENRESELI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;RESELI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;AUTOATNO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;AUTOATNI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENAUTOATNP
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;AUTOATNP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIRSTO &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;);&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; SCSISIG (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|s
op_amp
id|P_MASK
)paren
(brace
r_case
id|P_DATAO
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;DATA OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_DATAI
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;DATA IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_CMD
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;COMMAND&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_STATUS
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;STATUS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGO
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;MESSAGE OUT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P_MSGI
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;MESSAGE IN&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;*illegal*&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;INTSTAT (%s); &quot;
comma
id|TESTHI
c_func
(paren
id|DMASTAT
comma
id|INTSTAT
)paren
ques
c_cond
l_string|&quot;hi&quot;
suffix:colon
l_string|&quot;lo&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
)brace
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT0
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|TARGET
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;TARGET &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELDO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELDI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELDI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELINGO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELINGO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SWRAP
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SWRAP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SDONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SPIORDY
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SPIORDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DMADONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;DMADONE &quot;
)paren
suffix:semicolon
)brace
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT1
)paren
op_amp
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SELTO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELTO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ATNTARG
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ATNTARG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIRSTI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIRSTI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASEMIS
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;PHASEMIS &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|BUSFREE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;BUSFREE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SCSIPERR
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIPERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|PHASECHG
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;PHASECHG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|REQINIT
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;REQINIT &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SXFRCTL0 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SXFRCTL0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SCSIEN
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SCSIEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DMAEN
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;DMAEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|CH1
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;CH1 &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|CLRSTCNT
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;CLRSTCNT &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SPIOEN
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SPIOEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|CLRCH1
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;CLRCH1 &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SIGNAL (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SCSISIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATNI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ATNI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SELI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SELI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|BSYI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;BSYI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|REQI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;REQI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ACKI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ACKI &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SELID (%02x), &quot;
comma
id|GETPORT
c_func
(paren
id|SELID
)paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT2 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SOFFSET
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SOFFSET &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SEMPTY
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SEMPTY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SFULL
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SFULL &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); SFCNT (%d); &quot;
comma
id|s
op_amp
(paren
id|SFULL
op_or
id|SFCNT
)paren
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT3
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSICNT (%d), OFFCNT(%d), &quot;
comma
(paren
id|s
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|s
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SSTAT4 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SSTAT4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SYNCERR
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SYNCERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|FWERR
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;FWERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|FRERR
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;FRERR &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DMACNTRL0 (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMACNTRL0
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|_8BIT
ques
c_cond
l_string|&quot;8BIT&quot;
suffix:colon
l_string|&quot;16BIT&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|DMA
ques
c_cond
l_string|&quot;DMA&quot;
suffix:colon
l_string|&quot;PIO&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
op_amp
id|WRITE_READ
ques
c_cond
l_string|&quot;WRITE&quot;
suffix:colon
l_string|&quot;READ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENDMA
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENDMA &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|INTEN
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;INTEN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|RSTFIFO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;RSTFIFO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SWINT
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;SWINT &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;); &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DMASTAT (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|DMASTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ATDONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ATDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|WORDRDY
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;WORDRDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOFULL
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;DFIFOFULL &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|DFIFOEMP
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;DFIFOEMP &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;)&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;enabled interrupts (&quot;
)paren
suffix:semicolon
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELDO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELDI
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELDI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSELINGO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELINGO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSWRAP
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSWRAP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSDONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSPIORDY
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSPIORDY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENDMADONE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENDMADONE &quot;
)paren
suffix:semicolon
)brace
id|s
op_assign
id|GETPORT
c_func
(paren
id|SIMODE1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|ENSELTIMO
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSELTIMO &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENATNTARG
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENATNTARG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASEMIS
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENPHASEMIS &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENBUSFREE
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENBUSFREE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENSCSIPERR
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENSCSIPERR &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENPHASECHG
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENPHASECHG &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|ENREQINIT
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;ENREQINIT &quot;
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|pos
op_minus
id|start
)paren
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) do { if(pos &lt; buffer + length) pos += sprintf(pos, ## args); } while(0)
DECL|function|aha152x_proc_info
r_int
id|aha152x_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|shpnt
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
l_int|NULL
suffix:semicolon
id|i
OL
id|IRQS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|aha152x_host
(braket
id|i
)braket
op_logical_and
id|aha152x_host
(braket
id|i
)braket
op_member_access_from_pointer
id|host_no
op_eq
id|hostno
)paren
(brace
id|shpnt
op_assign
id|aha152x_host
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inout
)paren
(brace
multiline_comment|/* Has data been written to the file ? */
r_return
id|aha152x_set_info
c_func
(paren
id|buffer
comma
id|length
comma
id|shpnt
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
id|AHA152X_REVID
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;ioports 0x%04x to 0x%04x&bslash;n&quot;
comma
id|shpnt-&gt;io_port
comma
id|shpnt-&gt;io_port
op_plus
id|shpnt-&gt;n_io_port
op_minus
l_int|1
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;interrupt 0x%02x&bslash;n&quot;
comma
id|shpnt-&gt;irq
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;disconnection/reconnection %s&bslash;n&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|reconnect
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;parity checking %s&bslash;n&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|parity
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;synchronous transfers %s&bslash;n&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%d commands currently queued&bslash;n&quot;
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|commands
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|synchronous
)paren
(brace
macro_line|#if 0
id|SPRINTF
c_func
(paren
l_string|&quot;synchronously operating targets (tick=%ld ns):&bslash;n&quot;
comma
l_int|250000000
op_div
id|loops_per_sec
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x7f
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;target %d: period %dT/%ldns; req/ack offset %d&bslash;n&quot;
comma
id|i
comma
(paren
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|2
)paren
comma
(paren
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|2
)paren
op_star
l_int|250000000
op_div
id|loops_per_sec
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
macro_line|#else
id|SPRINTF
c_func
(paren
l_string|&quot;synchronously operating targets (tick=50 ns):&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x7f
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;target %d: period %dT/%dns; req/ack offset %d&bslash;n&quot;
comma
id|i
comma
(paren
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|2
)paren
comma
(paren
(paren
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_plus
l_int|2
)paren
op_star
l_int|50
comma
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|syncrate
(braket
id|i
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#ifdef DEBUG_AHA152X
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(flags,txt) if(HOSTDATA(shpnt)-&gt;debug &amp; flags) SPRINTF(&quot;(%s) &quot;, txt);
id|SPRINTF
c_func
(paren
l_string|&quot;enabled debugging options: &quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_skipports
comma
l_string|&quot;skip ports&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_queue
comma
l_string|&quot;queue&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_intr
comma
l_string|&quot;interrupt&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_selection
comma
l_string|&quot;selection&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_msgo
comma
l_string|&quot;message out&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_msgi
comma
l_string|&quot;message in&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_status
comma
l_string|&quot;status&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_cmd
comma
l_string|&quot;command&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_datai
comma
l_string|&quot;data in&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_datao
comma
l_string|&quot;data out&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_abort
comma
l_string|&quot;abort&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_done
comma
l_string|&quot;done&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_biosparam
comma
l_string|&quot;bios parameters&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_phases
comma
l_string|&quot;phases&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_queues
comma
l_string|&quot;queues&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
id|debug_reset
comma
l_string|&quot;reset&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;nqueue status:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISSUE_SC
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;not yet issued commands:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|ISSUE_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
id|pos
op_add_assign
id|get_command
c_func
(paren
id|pos
comma
id|ptr
)paren
suffix:semicolon
)brace
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;no not yet issued commands&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT_SC
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;current command:&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_add_assign
id|get_command
c_func
(paren
id|pos
comma
id|CURRENT_SC
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;no current command&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DISCONNECTED_SC
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;disconnected commands:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|DISCONNECTED_SC
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
id|pos
op_add_assign
id|get_command
c_func
(paren
id|pos
comma
id|ptr
)paren
suffix:semicolon
)brace
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;no disconnected commands&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|pos
op_add_assign
id|get_ports
c_func
(paren
id|shpnt
comma
id|pos
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
OL
id|offset
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
OL
id|length
)paren
r_return
id|pos
op_minus
id|buffer
op_minus
id|offset
suffix:semicolon
r_else
r_return
id|length
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|AHA152X
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
