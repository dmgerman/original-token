multiline_comment|/*+M*************************************************************************&n; * Perceptive Solutions, Inc. PSI-240I device driver proc support for Linux.&n; *&n; * Copyright (c) 1997 Perceptive Solutions, Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; see the file COPYING.  If not, write to&n; * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *&n; *&t;File Name:&t;&t;psi240i.c&n; *&n; *&t;Description:&t;SCSI driver for the PSI240I EIDE interface card.&n; *&n; *-M*************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;psi240i.h&quot;
macro_line|#include &quot;psi_chip.h&quot;
macro_line|#include&lt;linux/stat.h&gt;
singleline_comment|//#define DEBUG 1
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
DECL|macro|MAXBOARDS
mdefine_line|#define MAXBOARDS 2&t;/* Increase this and the sizes of the arrays below, if you need more. */
DECL|macro|PORT_DATA
mdefine_line|#define&t;PORT_DATA&t;&t;&t;&t;0
DECL|macro|PORT_ERROR
mdefine_line|#define&t;PORT_ERROR&t;&t;&t;&t;1
DECL|macro|PORT_SECTOR_COUNT
mdefine_line|#define&t;PORT_SECTOR_COUNT&t;&t;2
DECL|macro|PORT_LBA_0
mdefine_line|#define&t;PORT_LBA_0&t;&t;&t;&t;3
DECL|macro|PORT_LBA_8
mdefine_line|#define&t;PORT_LBA_8&t;&t;&t;&t;4
DECL|macro|PORT_LBA_16
mdefine_line|#define&t;PORT_LBA_16&t;&t;&t;&t;5
DECL|macro|PORT_LBA_24
mdefine_line|#define&t;PORT_LBA_24&t;&t;&t;&t;6
DECL|macro|PORT_STAT_CMD
mdefine_line|#define&t;PORT_STAT_CMD&t;&t;&t;7
DECL|macro|PORT_SEL_FAIL
mdefine_line|#define&t;PORT_SEL_FAIL&t;&t;&t;8
DECL|macro|PORT_IRQ_STATUS
mdefine_line|#define&t;PORT_IRQ_STATUS&t;&t;&t;9
DECL|macro|PORT_ADDRESS
mdefine_line|#define&t;PORT_ADDRESS&t;&t;&t;10
DECL|macro|PORT_FAIL
mdefine_line|#define&t;PORT_FAIL&t;&t;&t;&t;11
DECL|macro|PORT_ALT_STAT
mdefine_line|#define&t;PORT_ALT_STAT&t;&t;   &t;12
r_typedef
r_struct
(brace
DECL|member|device
id|UCHAR
id|device
suffix:semicolon
singleline_comment|// device code
DECL|member|byte6
id|UCHAR
id|byte6
suffix:semicolon
singleline_comment|// device select register image
DECL|member|spigot
id|UCHAR
id|spigot
suffix:semicolon
singleline_comment|// spigot number
DECL|member|expectingIRQ
id|UCHAR
id|expectingIRQ
suffix:semicolon
singleline_comment|// flag for expecting and interrupt
DECL|member|sectors
id|USHORT
id|sectors
suffix:semicolon
singleline_comment|// number of sectors per track
DECL|member|heads
id|USHORT
id|heads
suffix:semicolon
singleline_comment|// number of heads
DECL|member|cylinders
id|USHORT
id|cylinders
suffix:semicolon
singleline_comment|// number of cylinders for this device
DECL|member|spareword
id|USHORT
id|spareword
suffix:semicolon
singleline_comment|// placeholder
DECL|member|blocks
id|ULONG
id|blocks
suffix:semicolon
singleline_comment|// number of blocks on device
DECL|typedef|OUR_DEVICE
DECL|typedef|POUR_DEVICE
)brace
id|OUR_DEVICE
comma
op_star
id|POUR_DEVICE
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ports
id|USHORT
id|ports
(braket
l_int|13
)braket
suffix:semicolon
DECL|member|device
id|OUR_DEVICE
id|device
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|pSCmnd
id|Scsi_Cmnd
op_star
id|pSCmnd
suffix:semicolon
DECL|member|ide
id|IDE_STRUCT
id|ide
suffix:semicolon
DECL|member|startSector
id|ULONG
id|startSector
suffix:semicolon
DECL|member|sectorCount
id|USHORT
id|sectorCount
suffix:semicolon
DECL|member|SCpnt
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
DECL|member|buffer
id|VOID
op_star
id|buffer
suffix:semicolon
DECL|member|expectingIRQ
id|USHORT
id|expectingIRQ
suffix:semicolon
DECL|typedef|ADAPTER240I
DECL|typedef|PADAPTER240I
)brace
id|ADAPTER240I
comma
op_star
id|PADAPTER240I
suffix:semicolon
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(host) ((PADAPTER240I)&amp;host-&gt;hostdata)
DECL|variable|PsiHost
r_static
r_struct
id|Scsi_Host
op_star
id|PsiHost
(braket
l_int|6
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* One for each IRQ level (10-15) */
DECL|variable|identifyData
r_static
id|IDENTIFY_DATA
id|identifyData
suffix:semicolon
DECL|variable|ChipSetup
r_static
id|SETUP
id|ChipSetup
suffix:semicolon
DECL|variable|portAddr
r_static
id|USHORT
id|portAddr
(braket
l_int|6
)braket
op_assign
(brace
id|CHIP_ADRS_0
comma
id|CHIP_ADRS_1
comma
id|CHIP_ADRS_2
comma
id|CHIP_ADRS_3
comma
id|CHIP_ADRS_4
comma
id|CHIP_ADRS_5
)brace
suffix:semicolon
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteData&t;:LOCAL&n; *&n; *&t;Description:&t;Write data to device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WriteData
r_static
r_int
id|WriteData
(paren
id|PADAPTER240I
id|padapter
)paren
(brace
id|ULONG
id|timer
suffix:semicolon
id|USHORT
op_star
id|pports
op_assign
id|padapter-&gt;ports
suffix:semicolon
id|timer
op_assign
id|jiffies
op_plus
id|TIMEOUT_DRQ
suffix:semicolon
singleline_comment|// calculate the timeout value
r_do
(brace
r_if
c_cond
(paren
id|inb_p
(paren
id|pports
(braket
id|PORT_STAT_CMD
)braket
)paren
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|outsw
(paren
id|pports
(braket
id|PORT_DATA
)braket
comma
id|padapter-&gt;buffer
comma
(paren
id|USHORT
)paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|2
)braket
op_star
l_int|256
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|timer
comma
id|jiffies
)paren
)paren
suffix:semicolon
singleline_comment|// test for timeout
id|padapter-&gt;ide.ide.ides.cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;IdeCmd&t;:LOCAL&n; *&n; *&t;Description:&t;Process a queued command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Zero if no error or status register contents on error.&n; *&n; ****************************************************************/
DECL|function|IdeCmd
r_static
id|UCHAR
id|IdeCmd
(paren
id|PADAPTER240I
id|padapter
)paren
(brace
id|ULONG
id|timer
suffix:semicolon
id|USHORT
op_star
id|pports
op_assign
id|padapter-&gt;ports
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ides.spigot
comma
id|pports
(braket
id|PORT_SEL_FAIL
)braket
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
comma
id|pports
(braket
id|PORT_LBA_24
)braket
)paren
suffix:semicolon
singleline_comment|// select the drive
id|timer
op_assign
id|jiffies
op_plus
id|TIMEOUT_READY
suffix:semicolon
singleline_comment|// calculate the timeout value
r_do
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;ports
(braket
id|PORT_STAT_CMD
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRDY
)paren
(brace
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|2
)braket
comma
id|pports
(braket
id|PORT_SECTOR_COUNT
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|3
)braket
comma
id|pports
(braket
id|PORT_LBA_0
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|4
)braket
comma
id|pports
(braket
id|PORT_LBA_8
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|5
)braket
comma
id|pports
(braket
id|PORT_LBA_16
)braket
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|1
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|7
)braket
comma
id|pports
(braket
id|PORT_STAT_CMD
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;ide.ide.ides.cmd
op_eq
id|IDE_CMD_WRITE_MULTIPLE
)paren
r_return
(paren
id|WriteData
(paren
id|padapter
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|timer
comma
id|jiffies
)paren
)paren
suffix:semicolon
singleline_comment|// test for timeout
id|padapter-&gt;ide.ide.ides.cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;SetupTransfer&t;:LOCAL&n; *&n; *&t;Description:&t;Setup a data transfer command.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;drive&t; - Drive/head register upper nibble only.&n; *&n; *&t;Returns:&t;&t;TRUE if no data to transfer.&n; *&n; ****************************************************************/
DECL|function|SetupTransfer
r_static
r_int
id|SetupTransfer
(paren
id|PADAPTER240I
id|padapter
comma
id|UCHAR
id|drive
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
op_star
(paren
id|ULONG
op_star
)paren
id|padapter-&gt;ide.ide.ides.lba
op_assign
id|padapter-&gt;startSector
suffix:semicolon
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_or_assign
id|drive
suffix:semicolon
id|padapter-&gt;ide.ide.ides.sectors
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|SECTORSXFER
)paren
ques
c_cond
id|SECTORSXFER
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|padapter-&gt;ide.ide.ides.sectors
suffix:semicolon
singleline_comment|// bump the start and count for next xfer
id|padapter-&gt;startSector
op_add_assign
id|padapter-&gt;ide.ide.ides.sectors
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|padapter-&gt;ide.ide.ides.cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;DecodeError&t;:LOCAL&n; *&n; *&t;Description:&t;Decode and process device errors.&n; *&n; *&t;Parameters:&t;&t;pshost - Pointer to host data block.&n; *&t;&t;&t;&t;&t;status - Status register code.&n; *&n; *&t;Returns:&t;&t;The driver status code.&n; *&n; ****************************************************************/
DECL|function|DecodeError
r_static
id|ULONG
id|DecodeError
(paren
r_struct
id|Scsi_Host
op_star
id|pshost
comma
id|UCHAR
id|status
)paren
(brace
id|PADAPTER240I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
id|UCHAR
id|error
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_WRITE_FAULT
)paren
(brace
r_return
id|DID_PARITY
op_lshift
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_BUSY
)paren
r_return
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|error
op_assign
id|inb_p
(paren
id|padapter-&gt;ports
(braket
id|PORT_ERROR
)braket
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npsi240i error register: %x&quot;
comma
id|error
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|IDE_ERROR_AMNF
suffix:colon
r_case
id|IDE_ERROR_TKONF
suffix:colon
r_case
id|IDE_ERROR_ABRT
suffix:colon
r_case
id|IDE_ERROR_IDFN
suffix:colon
r_case
id|IDE_ERROR_UNC
suffix:colon
r_case
id|IDE_ERROR_BBK
suffix:colon
r_default
suffix:colon
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Irq_Handler&t;:LOCAL&n; *&n; *&t;Description:&t;Interrupt handler.&n; *&n; *&t;Parameters:&t;&t;irq&t;&t;- Hardware IRQ number.&n; *&t;&t;&t;&t;&t;dev_id&t;-&n; *&t;&t;&t;&t;&t;regs&t;-&n; *&n; *&t;Returns:&t;&t;TRUE if drive is not ready in time.&n; *&n; ****************************************************************/
DECL|function|Irq_Handler
r_static
r_void
id|Irq_Handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
suffix:semicolon
singleline_comment|// Pointer to host data block
id|PADAPTER240I
id|padapter
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|USHORT
op_star
id|pports
suffix:semicolon
singleline_comment|// I/O port array
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_int
id|z
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npsi240i received interrupt&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|shost
op_assign
id|PsiHost
(braket
id|irq
op_minus
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
id|panic
(paren
l_string|&quot;Splunge!&quot;
)paren
suffix:semicolon
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
suffix:semicolon
id|pports
op_assign
id|padapter-&gt;ports
suffix:semicolon
id|SCpnt
op_assign
id|padapter-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;expectingIRQ
)paren
(brace
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npsi240i Unsolicited interrupt&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;ports
(braket
id|PORT_STAT_CMD
)braket
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
r_goto
id|irqerror
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npsi240i processing interrupt&quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|padapter-&gt;ide.ide.ides.cmd
)paren
singleline_comment|// decide how to handle the interrupt
(brace
r_case
id|IDE_CMD_READ_MULTIPLE
suffix:colon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|insw
(paren
id|pports
(braket
id|PORT_DATA
)braket
comma
id|padapter-&gt;buffer
comma
(paren
id|USHORT
)paren
id|padapter-&gt;ide.ide.ides.sectors
op_star
l_int|256
)paren
suffix:semicolon
id|padapter-&gt;buffer
op_add_assign
id|padapter-&gt;ide.ide.ides.sectors
op_star
l_int|512
suffix:semicolon
r_if
c_cond
(paren
id|SetupTransfer
(paren
id|padapter
comma
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_amp
l_int|0xF0
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|IdeCmd
(paren
id|padapter
)paren
)paren
)paren
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IDE_CMD_WRITE_MULTIPLE
suffix:colon
id|padapter-&gt;buffer
op_add_assign
id|padapter-&gt;ide.ide.ides.sectors
op_star
l_int|512
suffix:semicolon
r_if
c_cond
(paren
id|SetupTransfer
(paren
id|padapter
comma
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_amp
l_int|0xF0
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|IdeCmd
(paren
id|padapter
)paren
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IDE_COMMAND_IDENTIFY
suffix:colon
(brace
id|PINQUIRYDATA
id|pinquiryData
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|insw
(paren
id|pports
(braket
id|PORT_DATA
)braket
comma
op_amp
id|identifyData
comma
r_sizeof
(paren
id|identifyData
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|memset
(paren
id|pinquiryData
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
singleline_comment|// Zero INQUIRY data structure.
id|pinquiryData-&gt;DeviceType
op_assign
l_int|0
suffix:semicolon
id|pinquiryData-&gt;Versions
op_assign
l_int|2
suffix:semicolon
id|pinquiryData-&gt;AdditionalLength
op_assign
l_int|35
op_minus
l_int|4
suffix:semicolon
singleline_comment|// Fill in vendor identification fields.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|20
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;VendorId
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.ModelNumber
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;VendorId
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.ModelNumber
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
singleline_comment|// Initialize unused portion of product id.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_increment
)paren
id|pinquiryData-&gt;ProductId
(braket
l_int|12
op_plus
id|z
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
singleline_comment|// Move firmware revision from IDENTIFY data to
singleline_comment|// product revision in INQUIRY data.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.FirmwareRevision
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.FirmwareRevision
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|irqerror
suffix:colon
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npsi240i error  Device Status: %X&bslash;n&quot;
comma
id|status
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DecodeError
(paren
id|shost
comma
id|status
)paren
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
DECL|function|do_Irq_Handler
r_static
r_void
id|do_Irq_Handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|Irq_Handler
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Psi240i_QueueCommand&n; *&n; *&t;Description:&t;Process a queued command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;done  - Pointer to done function to call.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Psi240i_QueueCommand
r_int
id|Psi240i_QueueCommand
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|UCHAR
op_star
id|cdb
op_assign
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
singleline_comment|// Pointer to SCSI CDB
id|PADAPTER240I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|SCpnt-&gt;target
)braket
suffix:semicolon
singleline_comment|// Pointer to device information
id|UCHAR
id|rc
suffix:semicolon
singleline_comment|// command return code
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|padapter-&gt;ide.ide.ides.spigot
op_assign
id|pdev-&gt;spigot
suffix:semicolon
id|padapter-&gt;buffer
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;device
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;psi240i_queuecommand: %02X: done can&squot;t be NULL&bslash;n&quot;
comma
op_star
id|cdb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
op_star
id|cdb
)paren
(brace
r_case
id|SCSIOP_INQUIRY
suffix:colon
singleline_comment|// inquiry CDB
(brace
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_assign
id|pdev-&gt;byte6
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_COMMAND_IDENTIFY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SCSIOP_TEST_UNIT_READY
suffix:colon
singleline_comment|// test unit ready CDB
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSIOP_READ_CAPACITY
suffix:colon
singleline_comment|// read capctiy CDB
(brace
id|PREAD_CAPACITY_DATA
id|pdata
op_assign
(paren
id|PREAD_CAPACITY_DATA
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|pdata-&gt;blksiz
op_assign
l_int|0x20000
suffix:semicolon
id|XANY2SCSI
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|pdata-&gt;blks
comma
id|pdev-&gt;blocks
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SCSIOP_VERIFY
suffix:colon
singleline_comment|// verify CDB
op_star
(paren
id|ULONG
op_star
)paren
id|padapter-&gt;ide.ide.ides.lba
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_or_assign
id|pdev-&gt;byte6
suffix:semicolon
id|padapter-&gt;ide.ide.ide
(braket
l_int|2
)braket
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_COMMAND_VERIFY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ
suffix:colon
singleline_comment|// read10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_READ_MULTIPLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ6
suffix:colon
singleline_comment|// read6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_READ_MULTIPLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE
suffix:colon
singleline_comment|// write10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_WRITE_MULTIPLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE6
suffix:colon
singleline_comment|// write6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_WRITE_MULTIPLE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEB
(paren
id|printk
(paren
l_string|&quot;psi240i_queuecommand: Unsupported command %02X&bslash;n&quot;
comma
op_star
id|cdb
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
singleline_comment|// Save this command data
id|rc
op_assign
id|IdeCmd
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;psi240i_queuecommand: %02X, %02X: Device failed to respond for command&bslash;n&quot;
comma
op_star
id|cdb
comma
id|padapter-&gt;ide.ide.ides.cmd
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEB
(paren
id|printk
c_func
(paren
l_string|&quot;psi240i_queuecommand: %02X, %02X now waiting for interrupt &quot;
comma
op_star
id|cdb
comma
id|padapter-&gt;ide.ide.ides.cmd
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|SCpnt-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Psi240i_Command&n; *&n; *&t;Description:&t;Process a command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Psi240i_Command
r_int
id|Psi240i_Command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;psi240i_command: ..calling psi240i_queuecommand&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|Psi240i_QueueCommand
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCpnt-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n; *&t;Name:&t;&t;&t;ReadChipMemory&n; *&n; *&t;Description:&t;Read information from controller memory.&n; *&n; *&t;Parameters:&t;&t;psetup&t;- Pointer to memory image of setup information.&n; *&t;&t;&t;&t;&t;base&t;- base address of memory.&n; *&t;&t;&t;&t;&t;length&t;- lenght of data space in bytes.&n; *&t;&t;&t;&t;&t;port&t;- I/O address of data port.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; **************************************************************************/
DECL|function|ReadChipMemory
r_void
id|ReadChipMemory
(paren
r_void
op_star
id|pdata
comma
id|USHORT
id|base
comma
id|USHORT
id|length
comma
id|USHORT
id|port
)paren
(brace
id|USHORT
id|z
comma
id|zz
suffix:semicolon
id|UCHAR
op_star
id|pd
op_assign
(paren
id|UCHAR
op_star
)paren
id|pdata
suffix:semicolon
id|outb_p
(paren
id|SEL_NONE
comma
id|port
op_plus
id|REG_SEL_FAIL
)paren
suffix:semicolon
singleline_comment|// setup data port
id|zz
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|zz
OL
id|length
)paren
(brace
id|outw_p
(paren
id|base
comma
id|port
op_plus
id|REG_ADDRESS
)paren
suffix:semicolon
singleline_comment|// setup address
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|8
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|zz
op_plus
id|z
)paren
OL
id|length
)paren
op_star
id|pd
op_increment
op_assign
id|inb_p
(paren
id|port
op_plus
id|z
)paren
suffix:semicolon
singleline_comment|// read data byte
)brace
id|zz
op_add_assign
l_int|8
suffix:semicolon
id|base
op_add_assign
l_int|8
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Psi240i_Detect&n; *&n; *&t;Description:&t;Detect and initialize our boards.&n; *&n; *&t;Parameters:&t;&t;tpnt - Pointer to SCSI host template structure.&n; *&n; *&t;Returns:&t;&t;Number of adapters found.&n; *&n; ****************************************************************/
DECL|function|Psi240i_Detect
r_int
id|Psi240i_Detect
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|board
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|unit
suffix:semicolon
r_int
id|z
suffix:semicolon
id|USHORT
id|port
suffix:semicolon
id|CHIP_CONFIG_N
id|chipConfig
suffix:semicolon
id|CHIP_DEVICE_N
id|chipDevice
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|pshost
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
r_for
c_loop
(paren
id|board
op_assign
l_int|0
suffix:semicolon
id|board
OL
l_int|6
suffix:semicolon
id|board
op_increment
)paren
singleline_comment|// scan for I/O ports
(brace
id|port
op_assign
id|portAddr
(braket
id|board
)braket
suffix:semicolon
singleline_comment|// get base address to test
r_if
c_cond
(paren
id|check_region
(paren
id|port
comma
l_int|16
)paren
)paren
singleline_comment|// test for I/O addresses available
r_continue
suffix:semicolon
singleline_comment|//   nope
r_if
c_cond
(paren
id|inb_p
(paren
id|port
op_plus
id|REG_FAIL
)paren
op_ne
id|CHIP_ID
)paren
singleline_comment|// do the first test for likley hood that it is us
r_continue
suffix:semicolon
id|outb_p
(paren
id|SEL_NONE
comma
id|port
op_plus
id|REG_SEL_FAIL
)paren
suffix:semicolon
singleline_comment|// setup EEPROM/RAM access
id|outw
(paren
l_int|0
comma
id|port
op_plus
id|REG_ADDRESS
)paren
suffix:semicolon
singleline_comment|// setup EEPROM address zero
r_if
c_cond
(paren
id|inb_p
(paren
id|port
)paren
op_ne
l_int|0x55
)paren
singleline_comment|// test 1st byte
r_continue
suffix:semicolon
singleline_comment|//   nope
r_if
c_cond
(paren
id|inb_p
(paren
id|port
op_plus
l_int|1
)paren
op_ne
l_int|0xAA
)paren
singleline_comment|// test 2nd byte
r_continue
suffix:semicolon
singleline_comment|//   nope
singleline_comment|// at this point our board is found and can be accessed.  Now we need to initialize
singleline_comment|// our informatation and register with the kernel.
id|ReadChipMemory
(paren
op_amp
id|chipConfig
comma
id|CHIP_CONFIG
comma
r_sizeof
(paren
id|chipConfig
)paren
comma
id|port
)paren
suffix:semicolon
id|ReadChipMemory
(paren
op_amp
id|chipDevice
comma
id|CHIP_DEVICE
comma
r_sizeof
(paren
id|chipDevice
)paren
comma
id|port
)paren
suffix:semicolon
id|ReadChipMemory
(paren
op_amp
id|ChipSetup
comma
id|CHIP_EEPROM_DATA
comma
r_sizeof
(paren
id|ChipSetup
)paren
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chipConfig.numDrives
)paren
singleline_comment|// if no devices on this board
r_continue
suffix:semicolon
id|pshost
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
id|ADAPTER240I
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pshost
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|chipConfig.irq
comma
id|do_Irq_Handler
comma
l_int|0
comma
l_string|&quot;psi240i&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to allocate IRQ for PSI-240I controller.&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|unregister
suffix:semicolon
)brace
id|PsiHost
(braket
id|chipConfig.irq
op_minus
l_int|10
)braket
op_assign
id|pshost
suffix:semicolon
id|pshost-&gt;unique_id
op_assign
id|port
suffix:semicolon
id|pshost-&gt;io_port
op_assign
id|port
suffix:semicolon
id|pshost-&gt;n_io_port
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Number of bytes of I/O space used */
id|pshost-&gt;irq
op_assign
id|chipConfig.irq
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|11
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// build regester address array
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|ports
(braket
id|z
)braket
op_assign
id|port
op_plus
id|z
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|ports
(braket
l_int|11
)braket
op_assign
id|port
op_plus
id|REG_FAIL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|ports
(braket
l_int|12
)braket
op_assign
id|port
op_plus
id|REG_ALT_STAT
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPorts =&quot;
)paren
)paren
suffix:semicolon
id|DEB
(paren
r_for
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|13
suffix:semicolon
id|z
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %#04X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|ports
(braket
id|z
)braket
)paren
suffix:semicolon
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|chipConfig.numDrives
suffix:semicolon
op_increment
id|z
)paren
(brace
id|unit
op_assign
id|chipDevice
(braket
id|z
)braket
dot
id|channel
op_amp
l_int|0x0F
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|device
op_assign
id|ChipSetup.setupDevice
(braket
id|unit
)braket
dot
id|device
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|byte6
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
(paren
id|unit
op_amp
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
l_int|0xE0
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|spigot
op_assign
(paren
id|UCHAR
)paren
(paren
l_int|1
op_lshift
(paren
id|unit
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|sectors
op_assign
id|ChipSetup.setupDevice
(braket
id|unit
)braket
dot
id|sectors
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|heads
op_assign
id|ChipSetup.setupDevice
(braket
id|unit
)braket
dot
id|heads
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|cylinders
op_assign
id|ChipSetup.setupDevice
(braket
id|unit
)braket
dot
id|cylinders
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|blocks
op_assign
id|ChipSetup.setupDevice
(braket
id|unit
)braket
dot
id|blocks
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nHOSTDATA-&gt;device    = %X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|device
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          byte6     = %X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|byte6
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          spigot    = %X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|spigot
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          sectors   = %X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|sectors
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          heads     = %X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|heads
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          cylinders = %X&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|cylinders
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          blocks    = %lX&quot;
comma
id|HOSTDATA
c_func
(paren
id|pshost
)paren
op_member_access_from_pointer
id|device
(braket
id|unit
)braket
dot
id|blocks
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nPSI-240I EIDE CONTROLLER: at I/O = %x  IRQ = %d&bslash;n&quot;
comma
id|port
comma
id|chipConfig.irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(C) 1997 Perceptive Solutions, Inc. All rights reserved&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
r_continue
suffix:semicolon
id|unregister
suffix:colon
suffix:semicolon
id|scsi_unregister
(paren
id|pshost
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Psi240i_Abort&n; *&n; *&t;Description:&t;Process the Abort command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Allways snooze.&n; *&n; ****************************************************************/
DECL|function|Psi240i_Abort
r_int
id|Psi240i_Abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;psi240i_abort&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Psi240i_Reset&n; *&n; *&t;Description:&t;Process the Reset command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;flags - Flags about the reset command&n; *&n; *&t;Returns:&t;&t;No active command at this time, so this means&n; *&t;&t;&t;&t;&t;that each time we got some kind of response the&n; *&t;&t;&t;&t;&t;last time through.  Tell the mid-level code to&n; *&t;&t;&t;&t;&t;request sense information in order to decide what&n; *&t;&t;&t;&t;&t;to do next.&n; *&n; ****************************************************************/
DECL|function|Psi240i_Reset
r_int
id|Psi240i_Reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
macro_line|#include &quot;sd.h&quot;
multiline_comment|/****************************************************************&n; *&t;Name:&t;Psi240i_BiosParam&n; *&n; *&t;Description:&t;Process the biosparam request from the SCSI manager to&n; *&t;&t;&t;&t;&t;return C/H/S data.&n; *&n; *&t;Parameters:&t;&t;disk - Pointer to SCSI disk structure.&n; *&t;&t;&t;&t;&t;dev&t; - Major/minor number from kernel.&n; *&t;&t;&t;&t;&t;geom - Pointer to integer array to place geometry data.&n; *&n; *&t;Returns:&t;&t;zero.&n; *&n; ****************************************************************/
DECL|function|Psi240i_BiosParam
r_int
id|Psi240i_BiosParam
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|pdev
op_assign
op_amp
(paren
id|HOSTDATA
c_func
(paren
id|disk-&gt;device-&gt;host
)paren
op_member_access_from_pointer
id|device
(braket
id|disk-&gt;device-&gt;id
)braket
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|pdev-&gt;heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|pdev-&gt;sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|pdev-&gt;cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|PSI240I
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
