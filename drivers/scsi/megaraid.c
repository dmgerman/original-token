multiline_comment|/*===================================================================&n; *&n; *                    Linux MegaRAID device driver&n; *&n; * Copyright 1998 American Megatrends Inc.&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; * Version : 1.00&n; * &n; * Description: Linux device driver for AMI MegaRAID controller&n; *&n; * Supported controllers: MegaRAID 418, 428, 438, 466, 762&n; * &n; * Maintainer: Jeff L Jones &lt;jeffreyj@ami.com&gt;&n; *&n; * History:&n; *&n; * Version 0.90:&n; *     Original source contributed by Dell; integrated it into the kernel and&n; *     cleaned up some things.  Added support for 438/466 controllers.&n; *&n; * Version 0.91:&n; *     Aligned mailbox area on 16-byte boundry.&n; *     Added schedule() at the end to properly clean up.&n; *     Made improvements for conformity to linux driver standards.&n; *&n; * Version 0.92:&n; *     Added support for 2.1 kernels.&n; *         Reads from pci_dev struct, so it&squot;s not dependent on pcibios.&n; *         Added some missing virt_to_bus() translations.&n; *     Added support for SMP.&n; *         Changed global cli()&squot;s to spinlocks for 2.1, and simulated&n; *          spinlocks for 2.0.&n; *     Removed setting of SA_INTERRUPT flag when requesting Irq.&n; *&n; * Version 0.92ac:&n; *      Small changes to the comments/formatting. Plus a couple of&n; *      added notes. Returned to the authors. No actual code changes&n; *      save printk levels.&n; *      8 Oct 98        Alan Cox &lt;alan.cox@linux.org&gt;&n; *&n; *     Merged with 2.1.131 source tree.&n; *     12 Dec 98       K. Baranowski &lt;kgb@knm.org.pl&gt;                          &n; *&n; * Version 0.93:&n; *     Added support for vendor specific ioctl commands (0x80+xxh)&n; *     Changed some fields in MEGARAID struct to better values.&n; *     Added signature check for Rp controllers under 2.0 kernels&n; *     Changed busy-wait loop to be time-based&n; *     Fixed SMP race condition in isr&n; *     Added kfree (sgList) on release&n; *     Added #include linux/version.h to megaraid.h for hosts.h&n; *     Changed max_id to represent max logical drives instead of targets.&n; *&n; * Version 0.94:&n; *     Got rid of some excess locking/unlocking&n; *     Fixed slight memory corruption problem while memcpy&squot;ing into mailbox&n; *     Changed logical drives to be reported as luns rather than targets&n; *     Changed max_id to 16 since it is now max targets/chan again.&n; *     Improved ioctl interface for upcoming megamgr&n; *&n; * Version 0.95:&n; *     Fixed problem of queueing multiple commands to adapter;&n; *       still has some strange problems on some setups, so still&n; *       defaults to single.  To enable parallel commands change&n; *       #define MULTI_IO in megaraid.h&n; *     Changed kmalloc allocation to be done in beginning.&n; *     Got rid of C++ style comments&n; *&n; * Version 0.96:&n; *     762 fully supported.&n; * Version 0.97:&n; *     Changed megaraid_command to use wait_queue.&n; *     Fixed bug of undesirably detecting HP onboard controllers which&n; *      are disabled.&n; *     &n; * Version 1.00:&n; *     Checks to see if an irq ocurred while in isr, and runs through&n; *        routine again.&n; *     Copies mailbox to temp area before processing in isr&n; *     Added barrier() in busy wait to fix volatility bug&n; *     Uses separate list for freed Scbs, keeps track of cmd state&n; *     Put spinlocks around entire queue function for now...&n; *     Full multi-io commands working stablely without previous problems&n; *     Added skipXX LILO option for Madrona motherboard support&n; *&n; *&n; * BUGS:&n; *     Some older 2.1 kernels (eg. 2.1.90) have a bug in pci.c that&n; *     fails to detect the controller as a pci device on the system.&n; *&n; *     Timeout period for mid scsi layer is too short for&n; *     this controller.  Must be increased or Aborts will occur.&n; *&n; *===================================================================*/
DECL|macro|CRLFSTR
mdefine_line|#define CRLFSTR &quot;&bslash;n&quot;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;American Megatrends Inc.&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;AMI MegaRAID driver&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;&t;/* for kmalloc() */
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#else
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;megaraid.h&quot;
multiline_comment|/*================================================================&n; *&n; *                          #Defines&n; *&n; *================================================================&n; */
macro_line|#if LINUX_VERSION_CODE &lt; 0x020100
DECL|macro|ioremap
mdefine_line|#define ioremap vremap
DECL|macro|iounmap
mdefine_line|#define iounmap vfree
multiline_comment|/* simulate spin locks */
r_typedef
r_struct
(brace
DECL|member|lock
r_volatile
r_char
id|lock
suffix:semicolon
DECL|typedef|spinlock_t
)brace
id|spinlock_t
suffix:semicolon
DECL|macro|spin_lock_init
mdefine_line|#define spin_lock_init(x) { (x)-&gt;lock = 0;}
DECL|macro|spin_lock_irqsave
mdefine_line|#define spin_lock_irqsave(x,flags) { while ((x)-&gt;lock) barrier();&bslash;&n;                                        (x)-&gt;lock=1; save_flags(flags);&bslash;&n;                                        cli();}
DECL|macro|spin_unlock_irqrestore
mdefine_line|#define spin_unlock_irqrestore(x,flags) { (x)-&gt;lock=0; restore_flags(flags);}
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020100
DECL|macro|queue_task_irq
mdefine_line|#define queue_task_irq(a,b)     queue_task(a,b)
DECL|macro|queue_task_irq_off
mdefine_line|#define queue_task_irq_off(a,b) queue_task(a,b)
macro_line|#endif
DECL|macro|MAX_SERBUF
mdefine_line|#define MAX_SERBUF 160
DECL|macro|COM_BASE
mdefine_line|#define COM_BASE 0x2f8
DECL|macro|ENQUEUE
mdefine_line|#define ENQUEUE(obj,type,list,next) &bslash;&n;{ type **node; long cpuflag; &bslash;&n;  spin_lock_irqsave(&amp;mega_lock,cpuflag);&bslash;&n;  for(node=&amp;(list); *node; node=(type **)&amp;(*node)-&gt;##next); &bslash;&n;  (*node) = obj; &bslash;&n;  (*node)-&gt;##next = NULL; &bslash;&n;  spin_unlock_irqrestore(&amp;mega_lock,cpuflag);&bslash;&n;}
multiline_comment|/* a non-locking version (if we already have the lock) */
DECL|macro|ENQUEUE_NL
mdefine_line|#define ENQUEUE_NL(obj,type,list,next) &bslash;&n;{ type **node; &bslash;&n;  for(node=&amp;(list); *node; node=(type **)&amp;(*node)-&gt;##next); &bslash;&n;  (*node) = obj; &bslash;&n;  (*node)-&gt;##next = NULL; &bslash;&n;}
DECL|macro|DEQUEUE
mdefine_line|#define DEQUEUE(obj,type,list,next) &bslash;&n;{ long cpuflag; &bslash;&n;  spin_lock_irqsave(&amp;mega_lock,cpuflag);&bslash;&n;  if ((obj=list) != NULL) {&bslash;&n;    list = (type *)(list)-&gt;##next; &bslash;&n;  } &bslash;&n;  spin_unlock_irqrestore(&amp;mega_lock,cpuflag);&bslash;&n;};
DECL|function|RDINDOOR
id|u_long
id|RDINDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_return
id|readl
(paren
id|megaCfg-&gt;base
op_plus
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|WRINDOOR
r_void
id|WRINDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_long
id|value
)paren
(brace
id|writel
(paren
id|value
comma
id|megaCfg-&gt;base
op_plus
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|RDOUTDOOR
id|u_long
id|RDOUTDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_return
id|readl
(paren
id|megaCfg-&gt;base
op_plus
l_int|0x2C
)paren
suffix:semicolon
)brace
DECL|function|WROUTDOOR
r_void
id|WROUTDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_long
id|value
)paren
(brace
id|writel
(paren
id|value
comma
id|megaCfg-&gt;base
op_plus
l_int|0x2C
)paren
suffix:semicolon
)brace
multiline_comment|/*================================================================&n; *&n; *                    Function prototypes&n; *&n; *================================================================&n; */
r_static
r_int
id|megaIssueCmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_char
op_star
id|mboxData
comma
id|mega_scb
op_star
id|scb
comma
r_int
id|intr
)paren
suffix:semicolon
r_static
r_int
id|build_sglist
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|scb
comma
id|u_long
op_star
id|buffer
comma
id|u_long
op_star
id|length
)paren
suffix:semicolon
r_static
r_int
id|mega_busyWaitMbox
c_func
(paren
id|mega_host_config
op_star
)paren
suffix:semicolon
r_static
r_void
id|mega_runpendq
(paren
id|mega_host_config
op_star
)paren
suffix:semicolon
r_static
r_void
id|mega_rundoneq
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|mega_cmd_done
(paren
id|mega_host_config
op_star
comma
id|mega_scb
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|mega_scb
op_star
id|mega_ioctl
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
r_static
r_inline
r_void
id|freeSgList
c_func
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
suffix:semicolon
multiline_comment|/* set SERDEBUG to 1 to enable serial debugging */
DECL|macro|SERDEBUG
mdefine_line|#define SERDEBUG 0
macro_line|#if SERDEBUG
r_static
r_void
id|ser_init
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ser_puts
(paren
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_void
id|ser_putc
(paren
r_char
id|c
)paren
suffix:semicolon
r_static
r_int
id|ser_printk
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*================================================================&n; *&n; *                    Global variables&n; *&n; *================================================================&n; */
multiline_comment|/*  Use &quot;megaraid=skipXX&quot; to prohibit driver from scanning XX scsi id&n;     on each channel.  Used for Madrona motherboard, where SAF_TE&n;     processor id cannot be scanned */
DECL|variable|megaraid
r_static
r_char
op_star
id|megaraid
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; 0x20100
macro_line|#ifdef MODULE
id|MODULE_PARM
c_func
(paren
id|megaraid
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
DECL|variable|skip_id
r_static
r_int
id|skip_id
suffix:semicolon
DECL|variable|numCtlrs
r_static
r_int
id|numCtlrs
op_assign
l_int|0
suffix:semicolon
DECL|variable|megaCtlrs
r_static
id|mega_host_config
op_star
id|megaCtlrs
(braket
l_int|12
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
macro_line|#if DEBUG
DECL|variable|maxCmdTime
r_static
id|u_long
id|maxCmdTime
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|pLastScb
r_static
id|mega_scb
op_star
id|pLastScb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Queue of pending/completed SCBs */
DECL|variable|qCompleted
r_static
id|Scsi_Cmnd
op_star
id|qCompleted
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if SERDEBUG
DECL|variable|serial_lock
r_volatile
r_static
id|spinlock_t
id|serial_lock
suffix:semicolon
macro_line|#endif
DECL|variable|mega_lock
r_volatile
r_static
id|spinlock_t
id|mega_lock
suffix:semicolon
DECL|variable|proc_scsi_megaraid
r_struct
id|proc_dir_entry
id|proc_scsi_megaraid
op_assign
(brace
id|PROC_SCSI_MEGARAID
comma
l_int|8
comma
l_string|&quot;megaraid&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
macro_line|#if SERDEBUG
DECL|variable|strbuf
r_static
r_char
id|strbuf
(braket
id|MAX_SERBUF
op_plus
l_int|1
)braket
suffix:semicolon
DECL|function|ser_init
r_static
r_void
id|ser_init
(paren
)paren
(brace
r_int
id|port
op_assign
id|COM_BASE
suffix:semicolon
id|outb
(paren
l_int|0x80
comma
id|port
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 9600 Baud, if 19200: outb(6,port) */
id|outb
(paren
l_int|12
comma
id|port
)paren
suffix:semicolon
id|outb
(paren
l_int|3
comma
id|port
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ser_puts
r_static
r_void
id|ser_puts
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|ptr
suffix:semicolon
id|ser_init
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|str
suffix:semicolon
op_star
id|ptr
suffix:semicolon
op_increment
id|ptr
)paren
id|ser_putc
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
DECL|function|ser_putc
r_static
r_void
id|ser_putc
(paren
r_char
id|c
)paren
(brace
r_int
id|port
op_assign
id|COM_BASE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
(paren
id|port
op_plus
l_int|5
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outb
(paren
id|c
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0x0a
)paren
(brace
r_while
c_loop
(paren
(paren
id|inb
(paren
id|port
op_plus
l_int|5
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outb
(paren
l_int|0x0d
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|ser_printk
r_static
r_int
id|ser_printk
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|serial_lock
comma
id|flags
)paren
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|i
op_assign
id|vsprintf
(paren
id|strbuf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|ser_puts
(paren
id|strbuf
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|serial_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|macro|TRACE
mdefine_line|#define TRACE(a)    { ser_printk a;}
macro_line|#else
DECL|macro|TRACE
mdefine_line|#define TRACE(A)
macro_line|#endif
DECL|function|callDone
r_void
id|callDone
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;result
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;*** %.08lx %.02x &lt;%d.%d.%d&gt; = %x&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|SCpnt-&gt;result
)paren
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------&n; *&n; *                      Local functions&n; *&n; *-------------------------------------------------------------------------*/
multiline_comment|/*=======================&n; * Free a SCB structure&n; *=======================&n; */
DECL|function|freeSCB
r_static
r_void
id|freeSCB
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
)paren
(brace
id|mega_scb
op_star
op_star
id|ppScb
suffix:semicolon
multiline_comment|/* Unlink from pending queue */
r_for
c_loop
(paren
id|ppScb
op_assign
op_amp
id|megaCfg-&gt;qPending
suffix:semicolon
op_star
id|ppScb
suffix:semicolon
id|ppScb
op_assign
op_amp
(paren
op_star
id|ppScb
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|ppScb
op_eq
id|pScb
)paren
(brace
op_star
id|ppScb
op_assign
id|pScb-&gt;next
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Link back into list */
id|pScb-&gt;state
op_assign
id|SCB_FREE
suffix:semicolon
id|pScb-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|pScb-&gt;next
op_assign
id|megaCfg-&gt;qFree
suffix:semicolon
id|megaCfg-&gt;qFree
op_assign
id|pScb
suffix:semicolon
)brace
multiline_comment|/*===========================&n; * Allocate a SCB structure&n; *===========================&n; */
DECL|function|allocateSCB
r_static
id|mega_scb
op_star
id|allocateSCB
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
multiline_comment|/* Unlink command from Free List */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|megaCfg-&gt;qFree
)paren
op_ne
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qFree
op_assign
id|pScb-&gt;next
suffix:semicolon
id|pScb-&gt;isrcount
op_assign
id|jiffies
suffix:semicolon
id|pScb-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pScb-&gt;state
op_assign
id|SCB_ACTIVE
suffix:semicolon
id|pScb-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
r_return
id|pScb
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Megaraid: Could not allocate free SCB!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*================================================&n; * Initialize SCB structures&n; *================================================&n; */
DECL|function|initSCB
r_static
r_int
id|initSCB
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_int
id|idx
suffix:semicolon
id|megaCfg-&gt;qFree
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
id|megaCfg-&gt;max_cmds
op_minus
l_int|1
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|idx
op_assign
id|idx
suffix:semicolon
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|mega_sglist
)paren
op_star
id|MAX_SGLIST
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t allocate sglist for id %d&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|freeSgList
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idx
OL
id|MAX_COMMANDS
)paren
(brace
multiline_comment|/* Link to free list */
id|freeSCB
c_func
(paren
id|megaCfg
comma
op_amp
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Run through the list of completed requests */
DECL|function|mega_rundoneq
r_static
r_void
id|mega_rundoneq
(paren
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|DEQUEUE
(paren
id|SCpnt
comma
id|Scsi_Cmnd
comma
id|qCompleted
comma
id|host_scribble
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Callback */
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;  Runs through the list of pending requests&n;  Assumes that mega_lock spin_lock has been acquired.&n;*/
DECL|function|mega_runpendq
r_static
r_void
id|mega_runpendq
c_func
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
multiline_comment|/* Issue any pending commands to the card */
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPending
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_ACTIVE
)paren
(brace
id|megaIssueCmd
c_func
(paren
id|megaCfg
comma
id|pScb-&gt;mboxData
comma
id|pScb
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Add command to the list of completed requests */
DECL|function|mega_cmd_done
r_static
r_void
id|mega_cmd_done
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
comma
r_int
id|status
)paren
(brace
r_int
id|islogical
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|TRACE
c_func
(paren
(paren
l_string|&quot;NULL pScb in mega_cmd_done!&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NULL pScb in mega_cmd_done!&quot;
)paren
suffix:semicolon
)brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
id|freeSCB
c_func
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
(brace
id|TRACE
c_func
(paren
(paren
l_string|&quot;NULL SCpnt in mega_cmd_done!&quot;
)paren
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;pScb-&gt;idx = &quot;
comma
id|pScb-&gt;idx
)paren
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;pScb-&gt;state = &quot;
comma
id|pScb-&gt;state
)paren
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;pScb-&gt;state = &quot;
comma
id|pScb-&gt;state
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Problem...!&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
id|islogical
op_assign
(paren
id|SCpnt-&gt;channel
op_eq
id|megaCfg-&gt;host-&gt;max_channel
op_logical_and
id|SCpnt-&gt;target
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
(paren
(paren
(paren
(paren
id|u_char
op_star
)paren
id|SCpnt-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
id|TYPE_DISK
)paren
op_logical_and
op_logical_neg
id|islogical
)paren
(brace
id|status
op_assign
l_int|0xF0
suffix:semicolon
)brace
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clear result; otherwise, success returns corrupt&n;                         value */
multiline_comment|/* Convert MegaRAID status to Linux error code */
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* SUCCESS */
r_case
l_int|0x02
suffix:colon
multiline_comment|/* ERROR_ABORTED */
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
multiline_comment|/* ERR_DEST_DRIVE_FAILED */
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Add Scsi_Command to end of completed queue */
id|ENQUEUE_NL
c_func
(paren
id|SCpnt
comma
id|Scsi_Cmnd
comma
id|qCompleted
comma
id|host_scribble
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; *&n; *                 Build a SCB from a Scsi_Cmnd&n; *&n; * Returns a SCB pointer, or NULL&n; * If NULL is returned, the scsi_done function MUST have been called&n; *&n; *-------------------------------------------------------------------*/
DECL|function|mega_build_cmd
r_static
id|mega_scb
op_star
id|mega_build_cmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
r_int
id|seg
suffix:semicolon
r_char
id|islogical
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NULL SCpnt in mega_build_cmd!&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
multiline_comment|/* ioctl from megamgr */
r_return
id|mega_ioctl
(paren
id|megaCfg
comma
id|SCpnt
)paren
suffix:semicolon
id|islogical
op_assign
(paren
id|SCpnt-&gt;channel
op_eq
id|megaCfg-&gt;host-&gt;max_channel
op_logical_and
id|SCpnt-&gt;target
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|islogical
op_logical_and
id|SCpnt-&gt;lun
op_ne
l_int|0
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|islogical
op_logical_and
id|SCpnt-&gt;target
op_eq
id|skip_id
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------&n;   *&n;   *               Logical drive commands&n;   *&n;   *-----------------------------------------------------*/
r_if
c_cond
(paren
id|islogical
)paren
(brace
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TEST_UNIT_READY
suffix:colon
id|memset
(paren
id|SCpnt-&gt;request_buffer
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|memset
(paren
id|SCpnt-&gt;request_buffer
comma
l_int|0
comma
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
r_case
id|INQUIRY
suffix:colon
multiline_comment|/* Allocate a SCB and initialize passthru */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;islogical
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|pthru-&gt;dataxferaddr
op_assign
id|virt_to_bus
(paren
id|SCpnt-&gt;request_buffer
)paren
suffix:semicolon
id|pthru-&gt;dataxferlen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox area */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
r_return
id|pScb
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
multiline_comment|/* Allocate a SCB and initialize mailbox */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|mbox-&gt;logdrv
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|mbox-&gt;cmd
op_assign
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
)paren
ques
c_cond
id|MEGA_MBOXCMD_LREAD
suffix:colon
id|MEGA_MBOXCMD_LWRITE
suffix:semicolon
multiline_comment|/* 6-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_6
)paren
(brace
id|mbox-&gt;numsectors
op_assign
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
suffix:semicolon
id|mbox-&gt;lba
op_and_assign
l_int|0x1FFFFF
suffix:semicolon
)brace
multiline_comment|/* 10-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_10
)paren
(brace
id|mbox-&gt;numsectors
op_assign
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|8
)braket
op_or
(paren
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u_long
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|5
)braket
suffix:semicolon
)brace
multiline_comment|/* Calculate Scatter-Gather info */
id|mbox-&gt;numsgelements
op_assign
id|build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u_long
op_star
)paren
op_amp
id|mbox-&gt;xferaddr
comma
(paren
id|u_long
op_star
)paren
op_amp
id|seg
)paren
suffix:semicolon
r_return
id|pScb
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*-----------------------------------------------------&n;   *&n;   *               Passthru drive commands&n;   *&n;   *-----------------------------------------------------*/
r_else
(brace
multiline_comment|/* Allocate a SCB and initialize passthru */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;islogical
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;channel
op_assign
id|SCpnt-&gt;channel
suffix:semicolon
id|pthru-&gt;target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
id|build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u_long
op_star
)paren
op_amp
id|pthru-&gt;dataxferaddr
comma
(paren
id|u_long
op_star
)paren
op_amp
id|pthru-&gt;dataxferlen
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
r_return
id|pScb
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------&n; * build RAID commands for controller, passed down through ioctl()&n; *--------------------------------------------------------------------*/
DECL|function|mega_ioctl
r_static
id|mega_scb
op_star
id|mega_ioctl
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|mega_ioctl_mbox
op_star
id|mbox
suffix:semicolon
id|mega_mailbox
op_star
id|mailbox
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
r_int
id|seg
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;&bslash;nBUF: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;......&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mbox
op_assign
(paren
id|mega_ioctl_mbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|mailbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mailbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* passthrough command */
r_int
r_char
id|cdblen
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;islogical
op_assign
(paren
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x80
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pthru-&gt;timeout
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x07
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;ars
op_assign
(paren
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x08
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|4
)braket
suffix:semicolon
id|pthru-&gt;channel
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|5
)braket
suffix:semicolon
id|pthru-&gt;target
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|6
)braket
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|cdblen
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
op_amp
id|data
(braket
l_int|3
)braket
comma
id|cdblen
)paren
suffix:semicolon
id|mailbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|mailbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
id|build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u_long
op_star
)paren
op_amp
id|pthru-&gt;dataxferaddr
comma
(paren
id|u_long
op_star
)paren
op_amp
id|pthru-&gt;dataxferlen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SCpnt-&gt;request_bufflen
op_minus
id|cdblen
op_minus
l_int|7
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|data
(braket
id|i
op_plus
id|cdblen
op_plus
l_int|7
)braket
suffix:semicolon
)brace
r_return
id|pScb
suffix:semicolon
)brace
multiline_comment|/* else normal (nonpassthru) command */
id|mbox-&gt;cmd
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|mbox-&gt;channel
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|mbox-&gt;param
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|mbox-&gt;pad
(braket
l_int|0
)braket
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|mbox-&gt;logdrv
op_assign
id|data
(braket
l_int|4
)braket
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
id|build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u_long
op_star
)paren
op_amp
id|mbox-&gt;xferaddr
comma
(paren
id|u_long
op_star
)paren
op_amp
id|seg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SCpnt-&gt;request_bufflen
op_minus
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|data
(braket
id|i
op_plus
l_int|6
)braket
suffix:semicolon
)brace
r_return
(paren
id|pScb
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
DECL|function|showMbox
r_static
r_void
id|showMbox
c_func
(paren
id|mega_scb
op_star
id|pScb
)paren
(brace
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|pScb-&gt;mboxData
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%u cmd:%x id:%x #scts:%x lba:%x addr:%x logdrv:%x #sg:%x&bslash;n&quot;
comma
id|pScb-&gt;SCpnt-&gt;pid
comma
id|mbox-&gt;cmd
comma
id|mbox-&gt;cmdid
comma
id|mbox-&gt;numsectors
comma
id|mbox-&gt;lba
comma
id|mbox-&gt;xferaddr
comma
id|mbox-&gt;logdrv
comma
id|mbox-&gt;numsgelements
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*--------------------------------------------------------------------&n; * Interrupt service routine&n; *--------------------------------------------------------------------*/
DECL|function|megaraid_isr
r_static
r_void
id|megaraid_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|devp
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|u_char
id|byte
comma
id|idx
comma
id|sIdx
comma
id|tmpBox
(braket
id|MAILBOX_SIZE
)braket
suffix:semicolon
id|u_long
id|dword
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|qCnt
comma
id|qStatus
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|devp
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|tmpBox
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|megaCfg-&gt;host-&gt;irq
op_eq
id|irq
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ISR
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;ISR called reentrantly!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|megaCfg-&gt;flag
op_or_assign
id|IN_ISR
suffix:semicolon
r_if
c_cond
(paren
id|mega_busyWaitMbox
c_func
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Error: mailbox busy in isr!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if a valid interrupt is pending */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|dword
op_assign
id|RDOUTDOOR
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dword
op_ne
l_int|0x10001234
)paren
(brace
multiline_comment|/* Spurious interrupt */
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WROUTDOOR
(paren
id|megaCfg
comma
id|dword
)paren
suffix:semicolon
multiline_comment|/* Copy to temp location */
id|memcpy
c_func
(paren
id|tmpBox
comma
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
comma
id|MAILBOX_SIZE
)paren
suffix:semicolon
multiline_comment|/* Acknowledge interrupt */
id|WRINDOOR
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
op_or
l_int|0x2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RDINDOOR
(paren
id|megaCfg
)paren
op_amp
l_int|0x02
)paren
suffix:semicolon
)brace
r_else
(brace
id|byte
op_assign
id|READ_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|byte
op_amp
id|VALID_INTR_BYTE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Spurious interrupt */
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
comma
id|byte
)paren
suffix:semicolon
multiline_comment|/* Copy to temp location */
id|memcpy
c_func
(paren
id|tmpBox
comma
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
comma
id|MAILBOX_SIZE
)paren
suffix:semicolon
multiline_comment|/* Acknowledge interrupt */
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
id|qCnt
op_assign
id|mbox-&gt;numstatus
suffix:semicolon
id|qStatus
op_assign
id|mbox-&gt;status
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|qCnt
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|sIdx
op_assign
id|mbox-&gt;completed
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sIdx
OG
l_int|0
)paren
(brace
id|pScb
op_assign
op_amp
id|megaCfg-&gt;scbList
(braket
id|sIdx
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* ASSERT(pScb-&gt;state == SCB_ISSUED); */
macro_line|#if DEBUG
r_if
c_cond
(paren
(paren
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
)paren
OG
id|maxCmdTime
)paren
(brace
id|maxCmdTime
op_assign
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cmd time = %u&bslash;n&quot;
comma
id|maxCmdTime
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_ABORTED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Received aborted SCB! %u&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark command as completed */
id|mega_cmd_done
c_func
(paren
id|megaCfg
comma
id|pScb
comma
id|qStatus
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
id|mega_rundoneq
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Loop through any pending requests */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|mega_runpendq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*==================================================*/
multiline_comment|/* Wait until the controller&squot;s mailbox is available */
multiline_comment|/*==================================================*/
DECL|function|mega_busyWaitMbox
r_static
r_int
id|mega_busyWaitMbox
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_mailbox
op_star
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
suffix:semicolon
r_int
id|counter
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|10000
suffix:semicolon
id|counter
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mbox-&gt;busy
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* give up after 1 second */
)brace
multiline_comment|/*=====================================================&n; * Post a command to the card&n; *&n; * Arguments:&n; *   mega_host_config *megaCfg - Controller structure&n; *   u_char *mboxData - Mailbox area, 16 bytes&n; *   mega_scb *pScb   - SCB posting (or NULL if N/A)&n; *   int intr         - if 1, interrupt, 0 is blocking&n; *=====================================================&n; */
DECL|function|megaIssueCmd
r_static
r_int
id|megaIssueCmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_char
op_star
id|mboxData
comma
id|mega_scb
op_star
id|pScb
comma
r_int
id|intr
)paren
(brace
id|mega_mailbox
op_star
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
suffix:semicolon
id|u_char
id|byte
suffix:semicolon
id|u_long
id|cmdDone
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|mboxData
(braket
l_int|0x1
)braket
op_assign
(paren
id|pScb
ques
c_cond
id|pScb-&gt;idx
op_plus
l_int|1
suffix:colon
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* Set cmdid */
id|mboxData
(braket
l_int|0xF
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set busy */
macro_line|#if 0
r_if
c_cond
(paren
id|intr
op_logical_and
id|mbox-&gt;busy
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Wait until mailbox is free */
r_while
c_loop
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Blocked mailbox!!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
macro_line|#if DEBUG
id|showMbox
c_func
(paren
id|pLastScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Abort command */
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NULL pScb in megaIssue&bslash;n&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;NULL pScb in megaIssue&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
id|freeSCB
c_func
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pLastScb
op_assign
id|pScb
suffix:semicolon
multiline_comment|/* Copy mailbox data into host structure */
id|memcpy
(paren
id|mbox
comma
id|mboxData
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Kick IO */
r_if
c_cond
(paren
id|intr
)paren
(brace
multiline_comment|/* Issue interrupt (non-blocking) command */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0
suffix:semicolon
id|WRINDOOR
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
)brace
r_else
(brace
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ISSUE_COMMAND
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
id|pScb-&gt;state
op_assign
id|SCB_ISSUED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Issue non-ISR (blocking) command */
id|disable_irq
c_func
(paren
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0
suffix:semicolon
id|WRINDOOR
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cmdDone
op_assign
id|RDOUTDOOR
(paren
id|megaCfg
)paren
)paren
op_ne
l_int|0x10001234
)paren
suffix:semicolon
id|WROUTDOOR
(paren
id|megaCfg
comma
id|cmdDone
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScb
)paren
(brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox-&gt;status
)paren
suffix:semicolon
id|mega_rundoneq
(paren
)paren
suffix:semicolon
)brace
id|WRINDOOR
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
op_or
l_int|0x2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RDINDOOR
(paren
id|megaCfg
)paren
op_amp
l_int|0x2
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ISSUE_COMMAND
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|byte
op_assign
id|READ_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
)paren
)paren
op_amp
id|INTR_VALID
)paren
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
comma
id|byte
)paren
suffix:semicolon
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScb
)paren
(brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox-&gt;status
)paren
suffix:semicolon
id|mega_rundoneq
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|TRACE
(paren
(paren
l_string|&quot;Error: NULL pScb!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|enable_irq
c_func
(paren
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Blocked mailbox on exit!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; * Copies data to SGLIST&n; *-------------------------------------------------------------------*/
DECL|function|build_sglist
r_static
r_int
id|build_sglist
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|scb
comma
id|u_long
op_star
id|buffer
comma
id|u_long
op_star
id|length
)paren
(brace
r_struct
id|scatterlist
op_star
id|sgList
suffix:semicolon
r_int
id|idx
suffix:semicolon
multiline_comment|/* Scatter-gather not used */
r_if
c_cond
(paren
id|scb-&gt;SCpnt-&gt;use_sg
op_eq
l_int|0
)paren
(brace
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|scb-&gt;SCpnt-&gt;request_buffer
)paren
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u_long
)paren
id|scb-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sgList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|scb-&gt;SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;SCpnt-&gt;use_sg
op_eq
l_int|1
)paren
(brace
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|sgList
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u_long
)paren
id|sgList
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy Scatter-Gather list info into controller structure */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
id|sgList
(braket
id|idx
)braket
dot
id|address
)paren
suffix:semicolon
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|length
op_assign
(paren
id|u_long
)paren
id|sgList
(braket
id|idx
)braket
dot
id|length
suffix:semicolon
)brace
multiline_comment|/* Reset pointer and length fields */
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|scb-&gt;sgList
)paren
suffix:semicolon
op_star
id|length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Return count of SG requests */
r_return
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------&n; * Initializes the adress of the controller&squot;s mailbox register&n; *  The mailbox register is used to issue commands to the card.&n; *  Format of the mailbox area:&n; *   00 01 command&n; *   01 01 command id&n; *   02 02 # of sectors&n; *   04 04 logical bus address&n; *   08 04 physical buffer address&n; *   0C 01 logical drive #&n; *   0D 01 length of scatter/gather list&n; *   0E 01 reserved&n; *   0F 01 mailbox busy&n; *   10 01 numstatus byte&n; *   11 01 status byte&n; *--------------------------------------------------------------------*/
DECL|function|mega_register_mailbox
r_static
r_int
id|mega_register_mailbox
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_long
id|paddr
)paren
(brace
multiline_comment|/* align on 16-byte boundry */
id|megaCfg-&gt;mbox
op_assign
op_amp
id|megaCfg-&gt;mailbox
suffix:semicolon
id|megaCfg-&gt;mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
(paren
(paren
(paren
(paren
id|ulong
)paren
id|megaCfg-&gt;mbox
)paren
op_plus
l_int|16
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|paddr
op_assign
(paren
id|paddr
op_plus
l_int|16
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
multiline_comment|/* Register mailbox area with the firmware */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
)brace
r_else
(brace
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT0
comma
id|paddr
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT1
comma
(paren
id|paddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT2
comma
(paren
id|paddr
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT3
comma
(paren
id|paddr
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|ENABLE_MBOX_REGION
comma
id|ENABLE_MBOX_BYTE
)paren
suffix:semicolon
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; * Issue an adapter info query to the controller&n; *-------------------------------------------------------------------*/
DECL|function|mega_i_query_adapter
r_static
r_int
id|mega_i_query_adapter
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_RAIDINQ
op_star
id|adapterInfo
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
id|u_long
id|paddr
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|mega_lock
)paren
suffix:semicolon
multiline_comment|/* Initialize adapter inquiry */
id|paddr
op_assign
id|virt_to_bus
(paren
id|megaCfg-&gt;mega_buffer
)paren
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mega_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|megaCfg-&gt;mega_buffer
)paren
)paren
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox registers */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_ADAPTERINQ
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|paddr
suffix:semicolon
multiline_comment|/* Issue a blocking command to the card */
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Initialize host/local structures with Adapter info */
id|adapterInfo
op_assign
(paren
id|mega_RAIDINQ
op_star
)paren
id|megaCfg-&gt;mega_buffer
suffix:semicolon
id|megaCfg-&gt;host-&gt;max_channel
op_assign
id|adapterInfo-&gt;AdpInfo.ChanPresent
suffix:semicolon
multiline_comment|/*  megaCfg-&gt;host-&gt;max_id = adapterInfo-&gt;AdpInfo.MaxTargPerChan; */
id|megaCfg-&gt;host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* max targets/chan */
id|megaCfg-&gt;numldrv
op_assign
id|adapterInfo-&gt;LogdrvInfo.NumLDrv
suffix:semicolon
macro_line|#if 0
id|printk
(paren
l_string|&quot;KERN_DEBUG ---- Logical drive info ----&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|megaCfg-&gt;numldrv
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
(paren
l_string|&quot;%d: size: %ld prop: %x state: %x&bslash;n&quot;
comma
id|i
comma
id|adapterInfo-&gt;LogdrvInfo.LDrvSize
(braket
id|i
)braket
comma
id|adapterInfo-&gt;LogdrvInfo.LDrvProp
(braket
id|i
)braket
comma
id|adapterInfo-&gt;LogdrvInfo.LDrvState
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;---- Physical drive info ----&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PHYSICAL_DRIVES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_logical_and
op_logical_neg
(paren
id|i
op_mod
l_int|8
)paren
)paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%d: %x   &quot;
comma
id|i
comma
id|adapterInfo-&gt;PhysdrvInfo.PDrvState
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|megaCfg-&gt;max_cmds
op_assign
id|adapterInfo-&gt;AdpInfo.MaxConcCmds
suffix:semicolon
macro_line|#ifdef HP&t;&t;&t;/* use HP firmware and bios version encoding */
id|sprintf
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;%c%d%d.%d%d&quot;
comma
id|adapterInfo-&gt;AdpInfo.FwVer
(braket
l_int|2
)braket
comma
id|adapterInfo-&gt;AdpInfo.FwVer
(braket
l_int|1
)braket
op_rshift
l_int|8
comma
id|adapterInfo-&gt;AdpInfo.FwVer
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|adapterInfo-&gt;AdpInfo.FwVer
(braket
l_int|2
)braket
op_rshift
l_int|8
comma
id|adapterInfo-&gt;AdpInfo.FwVer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|sprintf
(paren
id|megaCfg-&gt;biosVer
comma
l_string|&quot;%c%d%d.%d%d&quot;
comma
id|adapterInfo-&gt;AdpInfo.BiosVer
(braket
l_int|2
)braket
comma
id|adapterInfo-&gt;AdpInfo.BiosVer
(braket
l_int|1
)braket
op_rshift
l_int|8
comma
id|adapterInfo-&gt;AdpInfo.BiosVer
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|adapterInfo-&gt;AdpInfo.BiosVer
(braket
l_int|2
)braket
op_rshift
l_int|8
comma
id|adapterInfo-&gt;AdpInfo.BiosVer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
macro_line|#else
id|memcpy
(paren
id|megaCfg-&gt;fwVer
comma
id|adapterInfo-&gt;AdpInfo.FwVer
comma
l_int|4
)paren
suffix:semicolon
id|megaCfg-&gt;fwVer
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|megaCfg-&gt;biosVer
comma
id|adapterInfo-&gt;AdpInfo.BiosVer
comma
l_int|4
)paren
suffix:semicolon
id|megaCfg-&gt;biosVer
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|printk
(paren
id|KERN_INFO
l_string|&quot;megaraid: [%s:%s] detected %d logical drives&quot;
id|CRLFSTR
comma
id|megaCfg-&gt;fwVer
comma
id|megaCfg-&gt;biosVer
comma
id|megaCfg-&gt;numldrv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------&n; *&n; *                      Driver interface functions&n; *&n; *-------------------------------------------------------------------------*/
multiline_comment|/*----------------------------------------------------------&n; * Returns data to be displayed in /proc/scsi/megaraid/X&n; *----------------------------------------------------------*/
DECL|function|megaraid_proc_info
r_int
id|megaraid_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|host_no
comma
r_int
id|inout
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|findCard
r_int
id|findCard
(paren
id|Scsi_Host_Template
op_star
id|pHostTmpl
comma
id|u_short
id|pciVendor
comma
id|u_short
id|pciDev
comma
r_int
id|flag
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|u_char
id|pciBus
comma
id|pciDevFun
comma
id|megaIrq
suffix:semicolon
id|u_long
id|megaBase
suffix:semicolon
id|u_short
id|jdx
comma
id|pciIdx
op_assign
l_int|0
suffix:semicolon
id|u_short
id|numFound
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
r_while
c_loop
(paren
op_logical_neg
id|pcibios_find_device
(paren
id|pciVendor
comma
id|pciDev
comma
id|pciIdx
comma
op_amp
id|pciBus
comma
op_amp
id|pciDevFun
)paren
)paren
(brace
macro_line|#if 0
)brace
multiline_comment|/* keep auto-indenters happy */
macro_line|#endif
macro_line|#else
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_devices
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
(paren
id|pciVendor
comma
id|pciDev
comma
id|pdev
)paren
)paren
)paren
(brace
id|pciBus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|pciDevFun
op_assign
id|pdev-&gt;devfn
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|u_short
id|magic
suffix:semicolon
id|pcibios_read_config_word
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_CONF_AMISIG
comma
op_amp
id|magic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|magic
op_ne
id|AMI_SIGNATURE
)paren
(brace
id|pciIdx
op_increment
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* not an AMI board */
)brace
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;megaraid: found 0x%4.04x:0x%4.04x:idx %d:bus %d:slot %d:fun %d&bslash;n&quot;
comma
id|pciVendor
comma
id|pciDev
comma
id|pciIdx
comma
id|pciBus
comma
id|PCI_SLOT
(paren
id|pciDevFun
)paren
comma
id|PCI_FUNC
(paren
id|pciDevFun
)paren
)paren
suffix:semicolon
multiline_comment|/* Read the base port and IRQ from PCI */
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
id|pcibios_read_config_dword
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_BASE_ADDRESS_0
comma
(paren
id|u_int
op_star
)paren
op_amp
id|megaBase
)paren
suffix:semicolon
id|pcibios_read_config_byte
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|megaIrq
)paren
suffix:semicolon
macro_line|#else
id|megaBase
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
id|megaIrq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#endif
id|pciIdx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|megaBase
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|megaBase
op_assign
(paren
r_int
)paren
id|ioremap
(paren
id|megaBase
comma
l_int|128
)paren
suffix:semicolon
)brace
r_else
(brace
id|megaBase
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|megaBase
op_add_assign
l_int|0x10
suffix:semicolon
)brace
multiline_comment|/* Initialize SCSI Host structure */
id|host
op_assign
id|scsi_register
(paren
id|pHostTmpl
comma
r_sizeof
(paren
id|mega_host_config
)paren
)paren
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
(paren
id|megaCfg
comma
l_int|0
comma
r_sizeof
(paren
id|mega_host_config
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot; scsi%d: Found a MegaRAID controller at 0x%x, IRQ: %d&quot;
id|CRLFSTR
comma
id|host-&gt;host_no
comma
(paren
id|u_int
)paren
id|megaBase
comma
id|megaIrq
)paren
suffix:semicolon
multiline_comment|/* Copy resource info into structure */
id|megaCfg-&gt;qPending
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFree
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;flag
op_assign
id|flag
suffix:semicolon
id|megaCfg-&gt;host
op_assign
id|host
suffix:semicolon
id|megaCfg-&gt;base
op_assign
id|megaBase
suffix:semicolon
id|megaCfg-&gt;host-&gt;irq
op_assign
id|megaIrq
suffix:semicolon
id|megaCfg-&gt;host-&gt;io_port
op_assign
id|megaBase
suffix:semicolon
id|megaCfg-&gt;host-&gt;n_io_port
op_assign
l_int|16
suffix:semicolon
id|megaCfg-&gt;host-&gt;unique_id
op_assign
(paren
id|pciBus
op_lshift
l_int|8
)paren
op_or
id|pciDevFun
suffix:semicolon
id|megaCtlrs
(braket
id|numCtlrs
op_increment
)braket
op_assign
id|megaCfg
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_ne
id|BOARD_QUARTZ
)paren
(brace
multiline_comment|/* Request our IO Range */
r_if
c_cond
(paren
id|check_region
(paren
id|megaBase
comma
l_int|16
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Couldn&squot;t register I/O range!&quot;
id|CRLFSTR
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|request_region
(paren
id|megaBase
comma
l_int|16
comma
l_string|&quot;megaraid&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Request our IRQ */
r_if
c_cond
(paren
id|request_irq
(paren
id|megaIrq
comma
id|megaraid_isr
comma
id|SA_SHIRQ
comma
l_string|&quot;megaraid&quot;
comma
id|megaCfg
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Couldn&squot;t register IRQ %d!&quot;
id|CRLFSTR
comma
id|megaIrq
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mega_register_mailbox
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
op_amp
id|megaCfg-&gt;mailbox
)paren
)paren
suffix:semicolon
id|mega_i_query_adapter
(paren
id|megaCfg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|jdx
op_assign
l_int|0
suffix:semicolon
id|jdx
OL
id|MAX_LOGICAL_DRIVES
suffix:semicolon
id|jdx
op_increment
)paren
(brace
id|megaCfg-&gt;nReads
(braket
id|jdx
)braket
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;nWrites
(braket
id|jdx
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize SCBs */
r_if
c_cond
(paren
id|initSCB
(paren
id|megaCfg
)paren
)paren
(brace
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|numFound
op_increment
suffix:semicolon
)brace
r_return
id|numFound
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------&n; * Detects if a megaraid controller exists in this system&n; *---------------------------------------------------------*/
DECL|function|megaraid_detect
r_int
id|megaraid_detect
(paren
id|Scsi_Host_Template
op_star
id|pHostTmpl
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|pHostTmpl-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_megaraid
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
(paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: PCI bios not present.&quot;
id|CRLFSTR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|skip_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|megaraid
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|megaraid
comma
l_string|&quot;skip&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;skip&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|megaraid
(braket
l_int|4
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|skip_id
op_assign
id|megaraid
(braket
l_int|4
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|megaraid
(braket
l_int|5
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|skip_id
op_assign
(paren
id|skip_id
op_star
l_int|10
)paren
op_plus
(paren
id|megaraid
(braket
l_int|5
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
)brace
id|skip_id
op_assign
(paren
id|skip_id
OG
l_int|15
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
id|skip_id
suffix:semicolon
)brace
id|count
op_add_assign
id|findCard
(paren
id|pHostTmpl
comma
l_int|0x101E
comma
l_int|0x9010
comma
l_int|0
)paren
suffix:semicolon
id|count
op_add_assign
id|findCard
(paren
id|pHostTmpl
comma
l_int|0x101E
comma
l_int|0x9060
comma
l_int|0
)paren
suffix:semicolon
id|count
op_add_assign
id|findCard
(paren
id|pHostTmpl
comma
l_int|0x8086
comma
l_int|0x1960
comma
id|BOARD_QUARTZ
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Release the controller&squot;s resources&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_release
r_int
id|megaraid_release
(paren
r_struct
id|Scsi_Host
op_star
id|pSHost
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
multiline_comment|/* Flush cache to disk */
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|mboxData
(braket
l_int|0
)braket
op_assign
l_int|0xA
suffix:semicolon
id|free_irq
(paren
id|megaCfg-&gt;host-&gt;irq
comma
id|megaCfg
)paren
suffix:semicolon
multiline_comment|/* Must be freed first, otherwise&n;&t;&t;&t;&t;&t;   extra interrupt is generated */
multiline_comment|/* Issue a blocking (interrupts disabled) command to the card */
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Free our resources */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;base
)paren
suffix:semicolon
)brace
r_else
(brace
id|release_region
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
l_int|16
)paren
suffix:semicolon
)brace
id|freeSgList
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|pSHost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|freeSgList
r_static
r_inline
r_void
id|freeSgList
c_func
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
)paren
id|kfree
(paren
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
)paren
suffix:semicolon
multiline_comment|/* free sgList */
)brace
)brace
multiline_comment|/*----------------------------------------------&n; * Get information about the card/driver &n; *----------------------------------------------*/
DECL|function|megaraid_info
r_const
r_char
op_star
id|megaraid_info
(paren
r_struct
id|Scsi_Host
op_star
id|pSHost
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_RAIDINQ
op_star
id|adapterInfo
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|adapterInfo
op_assign
(paren
id|mega_RAIDINQ
op_star
)paren
id|megaCfg-&gt;mega_buffer
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;AMI MegaRAID %s %d commands %d targs %d chans&quot;
comma
id|megaCfg-&gt;fwVer
comma
id|adapterInfo-&gt;AdpInfo.MaxConcCmds
comma
id|megaCfg-&gt;host-&gt;max_id
comma
id|megaCfg-&gt;host-&gt;max_channel
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Perform a SCSI command&n; * Mailbox area:&n; *   00 01 command&n; *   01 01 command id&n; *   02 02 # of sectors&n; *   04 04 logical bus address&n; *   08 04 physical buffer address&n; *   0C 01 logical drive #&n; *   0D 01 length of scatter/gather list&n; *   0E 01 reserved&n; *   0F 01 mailbox busy&n; *   10 01 numstatus byte&n; *   11 01 status byte &n; *-----------------------------------------------------------------*/
DECL|function|megaraid_queue
r_int
id|megaraid_queue
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|pktComp
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|megaCfg-&gt;flag
op_amp
(paren
l_int|1L
op_lshift
id|SCpnt-&gt;channel
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;scsi%d: scanning channel %c for devices.&bslash;n&quot;
comma
id|megaCfg-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;channel
op_plus
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
(paren
l_int|1L
op_lshift
id|SCpnt-&gt;channel
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;scsi_done
op_assign
id|pktComp
suffix:semicolon
multiline_comment|/* If driver in abort or reset.. cancel this command */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ABORT
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
id|ENQUEUE_NL
c_func
(paren
id|SCpnt
comma
id|Scsi_Cmnd
comma
id|qCompleted
comma
id|host_scribble
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_RESET
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
id|ENQUEUE_NL
c_func
(paren
id|SCpnt
comma
id|Scsi_Cmnd
comma
id|qCompleted
comma
id|host_scribble
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Allocate and build a SCB request */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_build_cmd
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Add SCB to the head of the pending queue */
id|ENQUEUE_NL
(paren
id|pScb
comma
id|mega_scb
comma
id|megaCfg-&gt;qPending
comma
id|next
)paren
suffix:semicolon
multiline_comment|/* Issue any pending command to the card if not in ISR */
r_if
c_cond
(paren
op_logical_neg
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ISR
)paren
)paren
(brace
id|mega_runpendq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;IRQ pend...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n; * Issue a blocking command to the controller&n; *----------------------------------------------------------------------*/
DECL|variable|internal_done_flag
r_volatile
r_static
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_volatile
r_static
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|internal_wait
)paren
suffix:semicolon
DECL|function|internal_done
r_static
r_void
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_errcode
op_assign
id|SCpnt-&gt;result
suffix:semicolon
id|internal_done_flag
op_increment
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|internal_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* shouldn&squot;t be used, but included for completeness */
DECL|function|megaraid_command
r_int
id|megaraid_command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Queue command, and wait until it has completed */
id|megaraid_queue
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|internal_wait
)paren
suffix:semicolon
)brace
r_return
id|internal_done_errcode
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Abort a previous SCSI request&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_abort
r_int
id|megaraid_abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_int
id|rc
comma
id|idx
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
id|IN_ABORT
suffix:semicolon
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPending
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;SCpnt
op_eq
id|SCpnt
)paren
(brace
multiline_comment|/* Found an aborting command */
macro_line|#if DEBUG
id|showMbox
c_func
(paren
id|pScb
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;Abort: %d %u&bslash;n&quot;
comma
id|SCpnt-&gt;timeout_per_command
comma
(paren
id|uint
)paren
(paren
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pScb-&gt;state
)paren
(brace
r_case
id|SCB_ABORTED
suffix:colon
multiline_comment|/* Already aborted */
id|rc
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCB_ISSUED
suffix:colon
multiline_comment|/* Waiting on ISR result */
id|rc
op_assign
id|SCSI_ABORT_PENDING
suffix:semicolon
id|pScb-&gt;state
op_assign
id|SCB_ABORTED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#if 0
id|TRACE
(paren
(paren
l_string|&quot;ABORT!!! %.08lx %.02x &lt;%d.%d.%d&gt;&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPending
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;SCpnt
op_eq
id|SCpnt
)paren
(brace
id|ser_printk
c_func
(paren
l_string|&quot;** %d&lt;%x&gt;  %c&bslash;n&quot;
comma
id|pScb-&gt;SCpnt-&gt;pid
comma
id|pScb-&gt;idx
op_plus
l_int|1
comma
id|pScb-&gt;state
op_eq
id|SCB_ACTIVE
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;I&squot;
)paren
suffix:semicolon
macro_line|#if DEBUG
id|showMbox
c_func
(paren
id|pScb
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#endif
multiline_comment|/*&n;   * Walk list of SCBs for any that are still outstanding&n;   */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|state
op_ne
id|SCB_FREE
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|SCpnt
op_eq
id|SCpnt
)paren
(brace
id|freeSCB
(paren
id|megaCfg
comma
op_amp
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
op_or
(paren
id|SUGGEST_RETRY
op_lshift
l_int|24
)paren
suffix:semicolon
id|ENQUEUE_NL
c_func
(paren
id|SCpnt
comma
id|Scsi_Cmnd
comma
id|qCompleted
comma
id|host_scribble
)paren
suffix:semicolon
)brace
)brace
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ABORT
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|mega_rundoneq
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Reset a previous SCSI request&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_reset
r_int
id|megaraid_reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|rstflags
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
id|IN_RESET
suffix:semicolon
id|TRACE
(paren
(paren
l_string|&quot;RESET: %.08lx %.02x &lt;%d.%d.%d&gt;&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * Walk list of SCBs for any that are still outstanding&n;   */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|state
op_ne
id|SCB_FREE
)paren
(brace
id|SCpnt
op_assign
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_ne
l_int|NULL
)paren
(brace
id|freeSCB
(paren
id|megaCfg
comma
op_amp
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
op_or
(paren
id|SUGGEST_RETRY
op_lshift
l_int|24
)paren
suffix:semicolon
id|ENQUEUE_NL
c_func
(paren
id|SCpnt
comma
id|Scsi_Cmnd
comma
id|qCompleted
comma
id|host_scribble
)paren
suffix:semicolon
)brace
)brace
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_RESET
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|mega_lock
comma
id|flags
)paren
suffix:semicolon
id|mega_rundoneq
c_func
(paren
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------&n; * Return the disk geometry for a particular disk&n; * Input:&n; *   Disk *disk - Disk geometry&n; *   kdev_t dev - Device node&n; *   int *geom  - Returns geometry fields&n; *     geom[0] = heads&n; *     geom[1] = sectors&n; *     geom[2] = cylinders&n; *-------------------------------------------------------------*/
DECL|function|megaraid_biosparam
r_int
id|megaraid_biosparam
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|geom
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
multiline_comment|/* Get pointer to host config structure */
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Default heads (64) &amp; sectors (32) */
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
multiline_comment|/* Handle extended translation size for logical drives &gt; 1Gb */
r_if
c_cond
(paren
id|disk-&gt;capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
multiline_comment|/* return result */
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|MEGARAID
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
