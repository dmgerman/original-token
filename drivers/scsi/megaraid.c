multiline_comment|/*===================================================================&n; *&n; *                    Linux MegaRAID device driver&n; *&n; * Copyright 1999 American Megatrends Inc.&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; * Version : 1.07b&n; * &n; * Description: Linux device driver for AMI MegaRAID controller&n; *&n; * Supported controllers: MegaRAID 418, 428, 438, 466, 762, 467, 490&n; * &n; * History:&n; *&n; * Version 0.90:&n; *     Original source contributed by Dell; integrated it into the kernel and&n; *     cleaned up some things.  Added support for 438/466 controllers.&n; *&n; * Version 0.91:&n; *     Aligned mailbox area on 16-byte boundry.&n; *     Added schedule() at the end to properly clean up.&n; *     Made improvements for conformity to linux driver standards.&n; *&n; * Version 0.92:&n; *     Added support for 2.1 kernels.&n; *         Reads from pci_dev struct, so it&squot;s not dependent on pcibios.&n; *         Added some missing virt_to_bus() translations.&n; *     Added support for SMP.&n; *         Changed global cli()&squot;s to spinlocks for 2.1, and simulated&n; *          spinlocks for 2.0.&n; *     Removed setting of SA_INTERRUPT flag when requesting Irq.&n; *&n; * Version 0.92ac:&n; *     Small changes to the comments/formatting. Plus a couple of&n; *      added notes. Returned to the authors. No actual code changes&n; *      save printk levels.&n; *     8 Oct 98        Alan Cox &lt;alan.cox@linux.org&gt;&n; *&n; *     Merged with 2.1.131 source tree.&n; *     12 Dec 98       K. Baranowski &lt;kgb@knm.org.pl&gt;                          &n; *&n; * Version 0.93:&n; *     Added support for vendor specific ioctl commands (0x80+xxh)&n; *     Changed some fields in MEGARAID struct to better values.&n; *     Added signature check for Rp controllers under 2.0 kernels&n; *     Changed busy-wait loop to be time-based&n; *     Fixed SMP race condition in isr&n; *     Added kfree (sgList) on release&n; *     Added #include linux/version.h to megaraid.h for hosts.h&n; *     Changed max_id to represent max logical drives instead of targets.&n; *&n; * Version 0.94:&n; *     Got rid of some excess locking/unlocking&n; *     Fixed slight memory corruption problem while memcpy&squot;ing into mailbox&n; *     Changed logical drives to be reported as luns rather than targets&n; *     Changed max_id to 16 since it is now max targets/chan again.&n; *     Improved ioctl interface for upcoming megamgr&n; *&n; * Version 0.95:&n; *     Fixed problem of queueing multiple commands to adapter;&n; *       still has some strange problems on some setups, so still&n; *       defaults to single.  To enable parallel commands change&n; *       #define MULTI_IO in megaraid.h&n; *     Changed kmalloc allocation to be done in beginning.&n; *     Got rid of C++ style comments&n; *&n; * Version 0.96:&n; *     762 fully supported.&n; *&n; * Version 0.97:&n; *     Changed megaraid_command to use wait_queue.&n; *     Fixed bug of undesirably detecting HP onboard controllers which&n; *       are disabled.&n; *     &n; * Version 1.00:&n; *     Checks to see if an irq ocurred while in isr, and runs through&n; *       routine again.&n; *     Copies mailbox to temp area before processing in isr&n; *     Added barrier() in busy wait to fix volatility bug&n; *     Uses separate list for freed Scbs, keeps track of cmd state&n; *     Put spinlocks around entire queue function for now...&n; *     Full multi-io commands working stablely without previous problems&n; *     Added skipXX LILO option for Madrona motherboard support&n; *&n; * Version 1.01:&n; *     Fixed bug in mega_cmd_done() for megamgr control commands,&n; *       the host_byte in the result code from the scsi request to &n; *       scsi midlayer is set to DID_BAD_TARGET when adapter&squot;s &n; *       returned codes are 0xF0 and 0xF4.  &n; *&n; * Version 1.02:&n; *     Fixed the tape drive bug by extending the adapter timeout value&n; *       for passthrough command to 60 seconds in mega_build_cmd(). &n; *&n; * Version 1.03:&n; *    Fixed Madrona support.&n; *    Changed the adapter timeout value from 60 sec in 1.02 to 10 min&n; *      for bigger and slower tape drive.&n; *    Added driver version printout at driver loadup time&n; *&n; * Version 1.04&n; *    Added code for 40 ld FW support. &n; *    Added new ioctl command 0x81 to support NEW_READ/WRITE_CONFIG with&n; *      data area greater than 4 KB, which is the upper bound for data&n; *      tranfer through scsi_ioctl interface.&n; *    The addtional 32 bit field for 64bit address in the newly defined&n; *      mailbox64 structure is set to 0 at this point.&n; *&n; * Version 1.05&n; *    Changed the queing implementation for handling SCBs and completed&n; *      commands.&n; *    Added spinlocks in the interrupt service routine to enable the dirver&n; *      function in the SMP environment.&n; *    Fixed the problem of unnecessary aborts in the abort entry point, which&n; *      also enables the driver to handle large amount of I/O requests for&n; *      long duration of time.&n; *&n; * Version 1.07&n; *    Removed the usage of uaccess.h file for kernel versions less than&n; *    2.0.36, as this file is not present in those versions.&n; *&n; * Version 1.07b&n; *    The MegaRAID 466 cards with 3.00 firmware lockup and seem to very&n; *    occasionally hang. We check such cards and report them. You can&n; *    get firmware upgrades to flash the board to 3.10 for free.&n; *&n; * BUGS:&n; *     Some older 2.1 kernels (eg. 2.1.90) have a bug in pci.c that&n; *     fails to detect the controller as a pci device on the system.&n; *&n; *     Timeout period for upper scsi layer, i.e. SD_TIMEOUT in&n; *     /drivers/scsi/sd.c, is too short for this controller. SD_TIMEOUT&n; *     value must be increased to (30 * HZ) otherwise false timeouts &n; *     will occur in the upper layer.&n; *&n; *===================================================================*/
DECL|macro|CRLFSTR
mdefine_line|#define CRLFSTR &quot;&bslash;n&quot;
DECL|macro|IOCTL_CMD_NEW
mdefine_line|#define IOCTL_CMD_NEW  0x81
DECL|macro|MEGARAID_VERSION
mdefine_line|#define MEGARAID_VERSION &quot;v107 (December 22, 1999)&quot;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#include &lt;linux/module.h&gt;
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;American Megatrends Inc.&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;AMI MegaRAID driver&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt; 0x020024
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#endif
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;megaraid.h&quot;
multiline_comment|/*================================================================&n; *&n; *                          #Defines&n; *&n; *================================================================&n; */
DECL|macro|MAX_SERBUF
mdefine_line|#define MAX_SERBUF 160
DECL|macro|COM_BASE
mdefine_line|#define COM_BASE 0x2f8
DECL|function|RDINDOOR
id|u32
id|RDINDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_return
id|readl
(paren
id|megaCfg-&gt;base
op_plus
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|WRINDOOR
r_void
id|WRINDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u32
id|value
)paren
(brace
id|writel
(paren
id|value
comma
id|megaCfg-&gt;base
op_plus
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|RDOUTDOOR
id|u32
id|RDOUTDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_return
id|readl
(paren
id|megaCfg-&gt;base
op_plus
l_int|0x2C
)paren
suffix:semicolon
)brace
DECL|function|WROUTDOOR
r_void
id|WROUTDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u32
id|value
)paren
(brace
id|writel
(paren
id|value
comma
id|megaCfg-&gt;base
op_plus
l_int|0x2C
)paren
suffix:semicolon
)brace
multiline_comment|/*================================================================&n; *&n; *                    Function prototypes&n; *&n; *================================================================&n; */
r_static
r_int
id|__init
id|megaraid_setup
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|megaIssueCmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_char
op_star
id|mboxData
comma
id|mega_scb
op_star
id|scb
comma
r_int
id|intr
)paren
suffix:semicolon
r_static
r_int
id|mega_build_sglist
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|scb
comma
id|u32
op_star
id|buffer
comma
id|u32
op_star
id|length
)paren
suffix:semicolon
r_static
r_int
id|mega_busyWaitMbox
c_func
(paren
id|mega_host_config
op_star
)paren
suffix:semicolon
r_static
r_void
id|mega_runpendq
(paren
id|mega_host_config
op_star
)paren
suffix:semicolon
r_static
r_void
id|mega_rundoneq
(paren
id|mega_host_config
op_star
)paren
suffix:semicolon
r_static
r_void
id|mega_cmd_done
(paren
id|mega_host_config
op_star
comma
id|mega_scb
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|mega_scb
op_star
id|mega_ioctl
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
r_static
r_inline
r_void
id|mega_freeSgList
c_func
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
suffix:semicolon
r_static
r_void
id|mega_Convert8ldTo40ld
c_func
(paren
id|mega_RAIDINQ
op_star
id|inquiry
comma
id|mega_Enquiry3
op_star
id|enquiry3
comma
id|megaRaidProductInfo
op_star
id|productInfo
)paren
suffix:semicolon
macro_line|#include &lt;linux/smp.h&gt;
DECL|macro|cpuid
mdefine_line|#define cpuid smp_processor_id()
DECL|macro|DRIVER_LOCK_T
mdefine_line|#define DRIVER_LOCK_T
DECL|macro|DRIVER_LOCK_INIT
mdefine_line|#define DRIVER_LOCK_INIT(p)
DECL|macro|DRIVER_LOCK
mdefine_line|#define DRIVER_LOCK(p)
DECL|macro|DRIVER_UNLOCK
mdefine_line|#define DRIVER_UNLOCK(p)
DECL|macro|IO_LOCK_T
mdefine_line|#define IO_LOCK_T unsigned long io_flags = 0;
DECL|macro|IO_LOCK
mdefine_line|#define IO_LOCK spin_lock_irqsave(&amp;io_request_lock,io_flags);
DECL|macro|IO_UNLOCK
mdefine_line|#define IO_UNLOCK spin_unlock_irqrestore(&amp;io_request_lock,io_flags);
multiline_comment|/* set SERDEBUG to 1 to enable serial debugging */
DECL|macro|SERDEBUG
mdefine_line|#define SERDEBUG 0
macro_line|#if SERDEBUG
r_static
r_void
id|ser_init
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ser_puts
(paren
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_void
id|ser_putc
(paren
r_char
id|c
)paren
suffix:semicolon
r_static
r_int
id|ser_printk
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*================================================================&n; *&n; *                    Global variables&n; *&n; *================================================================&n; */
multiline_comment|/*  Use &quot;megaraid=skipXX&quot; as LILO option to prohibit driver from scanning&n;    XX scsi id on each channel.  Used for Madrona motherboard, where SAF_TE&n;    processor id cannot be scanned */
macro_line|#ifdef MODULE
DECL|variable|megaraid
r_static
r_char
op_star
id|megaraid
op_assign
l_int|NULL
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|megaraid
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|skip_id
r_static
r_int
id|skip_id
suffix:semicolon
DECL|variable|numCtlrs
r_static
r_int
id|numCtlrs
op_assign
l_int|0
suffix:semicolon
DECL|variable|megaCtlrs
r_static
id|mega_host_config
op_star
id|megaCtlrs
(braket
id|FC_MAX_CHANNELS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
macro_line|#if DEBUG
DECL|variable|maxCmdTime
r_static
id|u32
id|maxCmdTime
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|pLastScb
r_static
id|mega_scb
op_star
id|pLastScb
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if SERDEBUG
DECL|variable|serial_lock
r_static
id|spinlock_t
id|serial_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
macro_line|#endif
macro_line|#if SERDEBUG
DECL|variable|strbuf
r_static
r_char
id|strbuf
(braket
id|MAX_SERBUF
op_plus
l_int|1
)braket
suffix:semicolon
DECL|function|ser_init
r_static
r_void
id|ser_init
(paren
)paren
(brace
r_int
id|port
op_assign
id|COM_BASE
suffix:semicolon
id|outb
(paren
l_int|0x80
comma
id|port
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 9600 Baud, if 19200: outb(6,port) */
id|outb
(paren
l_int|12
comma
id|port
)paren
suffix:semicolon
id|outb
(paren
l_int|3
comma
id|port
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ser_puts
r_static
r_void
id|ser_puts
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|ptr
suffix:semicolon
id|ser_init
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|str
suffix:semicolon
op_star
id|ptr
suffix:semicolon
op_increment
id|ptr
)paren
id|ser_putc
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
DECL|function|ser_putc
r_static
r_void
id|ser_putc
(paren
r_char
id|c
)paren
(brace
r_int
id|port
op_assign
id|COM_BASE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
(paren
id|port
op_plus
l_int|5
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outb
(paren
id|c
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0x0a
)paren
(brace
r_while
c_loop
(paren
(paren
id|inb
(paren
id|port
op_plus
l_int|5
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outb
(paren
l_int|0x0d
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|ser_printk
r_static
r_int
id|ser_printk
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|serial_lock
comma
id|flags
)paren
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|i
op_assign
id|vsprintf
(paren
id|strbuf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|ser_puts
(paren
id|strbuf
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|serial_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|macro|TRACE
mdefine_line|#define TRACE(a)    { ser_printk a;}
macro_line|#else
DECL|macro|TRACE
mdefine_line|#define TRACE(A)
macro_line|#endif
DECL|function|callDone
r_static
r_void
id|callDone
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;result
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;*** %.08lx %.02x &lt;%d.%d.%d&gt; = %x&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|SCpnt-&gt;result
)paren
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------&n; *&n; *                      Local functions&n; *&n; *-------------------------------------------------------------------------*/
multiline_comment|/*=======================&n; * Free a SCB structure&n; *=======================&n; */
DECL|function|mega_freeSCB
r_static
r_void
id|mega_freeSCB
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
)paren
(brace
id|mega_scb
op_star
id|pScbtmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pScb
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pScb-&gt;idx
op_ge
l_int|0xFE
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Unlink from pending queue */
r_if
c_cond
(paren
id|pScb
op_eq
id|megaCfg-&gt;qPendingH
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;qPendingH
op_eq
id|megaCfg-&gt;qPendingT
)paren
(brace
id|megaCfg-&gt;qPendingH
op_assign
id|megaCfg-&gt;qPendingT
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qPendingH
op_assign
id|megaCfg-&gt;qPendingH-&gt;next
suffix:semicolon
)brace
id|megaCfg-&gt;qPcnt
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|pScbtmp
op_assign
id|megaCfg-&gt;qPendingH
suffix:semicolon
id|pScbtmp
suffix:semicolon
id|pScbtmp
op_assign
id|pScbtmp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScbtmp-&gt;next
op_eq
id|pScb
)paren
(brace
id|pScbtmp-&gt;next
op_assign
id|pScb-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
id|megaCfg-&gt;qPendingT
)paren
(brace
id|megaCfg-&gt;qPendingT
op_assign
id|pScbtmp
suffix:semicolon
)brace
id|megaCfg-&gt;qPcnt
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Link back into free list */
id|pScb-&gt;state
op_assign
id|SCB_FREE
suffix:semicolon
id|pScb-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qFreeH
op_eq
(paren
id|mega_scb
op_star
)paren
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qFreeH
op_assign
id|megaCfg-&gt;qFreeT
op_assign
id|pScb
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qFreeT-&gt;next
op_assign
id|pScb
suffix:semicolon
id|megaCfg-&gt;qFreeT
op_assign
id|pScb
suffix:semicolon
)brace
id|megaCfg-&gt;qFreeT-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_increment
suffix:semicolon
)brace
multiline_comment|/*===========================&n; * Allocate a SCB structure&n; *===========================&n; */
DECL|function|mega_allocateSCB
r_static
id|mega_scb
op_star
id|mega_allocateSCB
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
multiline_comment|/* Unlink command from Free List */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|megaCfg-&gt;qFreeH
)paren
op_ne
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qFreeH
op_assign
id|pScb-&gt;next
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_decrement
suffix:semicolon
id|pScb-&gt;isrcount
op_assign
id|jiffies
suffix:semicolon
id|pScb-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pScb-&gt;state
op_assign
id|SCB_ACTIVE
suffix:semicolon
id|pScb-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
r_return
id|pScb
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Megaraid: Could not allocate free SCB!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*================================================&n; * Initialize SCB structures&n; *================================================&n; */
DECL|function|mega_initSCB
r_static
r_int
id|mega_initSCB
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_int
id|idx
suffix:semicolon
id|megaCfg-&gt;qFreeH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|megaCfg-&gt;max_cmds
op_ge
id|MAX_COMMANDS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;megaraid:ctlr max cmds = %x : MAX_CMDS = %x&quot;
comma
id|megaCfg-&gt;max_cmds
comma
id|MAX_COMMANDS
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|idx
op_assign
id|megaCfg-&gt;max_cmds
op_minus
l_int|1
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|idx
op_assign
id|idx
suffix:semicolon
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|mega_sglist
)paren
op_star
id|MAX_SGLIST
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t allocate sglist for id %d&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|mega_freeSgList
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idx
OL
id|MAX_COMMANDS
)paren
(brace
multiline_comment|/* Link to free list */
id|mega_freeSCB
c_func
(paren
id|megaCfg
comma
op_amp
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Run through the list of completed requests */
DECL|function|mega_rundoneq
r_static
r_void
id|mega_rundoneq
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_while
c_loop
(paren
(paren
id|SCpnt
op_assign
id|megaCfg-&gt;qCompletedH
)paren
op_ne
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_decrement
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
singleline_comment|// XC : sep 14
multiline_comment|/* Callback */
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Runs through the list of pending requests&n; * Assumes that mega_lock spin_lock has been acquired.&n; */
DECL|function|mega_runpendq
r_static
r_void
id|mega_runpendq
c_func
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
multiline_comment|/* Issue any pending commands to the card */
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPendingH
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_ACTIVE
)paren
(brace
r_if
c_cond
(paren
id|megaIssueCmd
c_func
(paren
id|megaCfg
comma
id|pScb-&gt;mboxData
comma
id|pScb
comma
l_int|1
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Add command to the list of completed requests */
r_static
r_void
DECL|function|mega_cmd_done
id|mega_cmd_done
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
comma
r_int
id|status
)paren
(brace
r_int
id|islogical
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|TRACE
c_func
(paren
(paren
l_string|&quot;NULL pScb in mega_cmd_done!&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NULL pScb in mega_cmd_done!&quot;
)paren
suffix:semicolon
)brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
(brace
id|TRACE
c_func
(paren
(paren
l_string|&quot;NULL SCpnt in mega_cmd_done!&quot;
)paren
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;pScb-&gt;idx = &quot;
comma
id|pScb-&gt;idx
)paren
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;pScb-&gt;state = &quot;
comma
id|pScb-&gt;state
)paren
)paren
suffix:semicolon
id|TRACE
c_func
(paren
(paren
l_string|&quot;pScb-&gt;state = &quot;
comma
id|pScb-&gt;state
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;megaraid:Problem...!&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
id|islogical
op_assign
(paren
id|SCpnt-&gt;channel
op_eq
id|megaCfg-&gt;host-&gt;max_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
(paren
(paren
(paren
(paren
id|u_char
op_star
)paren
id|SCpnt-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
id|TYPE_DISK
)paren
op_logical_and
op_logical_neg
id|islogical
)paren
(brace
id|status
op_assign
l_int|0xF0
suffix:semicolon
)brace
multiline_comment|/* clear result; otherwise, success returns corrupt value */
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
)paren
(brace
multiline_comment|/* i.e. ioctl cmd such as 0x80, 0x81 of megamgr*/
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0xF0
suffix:colon
r_case
l_int|0xF4
suffix:colon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_or_assign
id|status
suffix:semicolon
)brace
multiline_comment|/*end of switch*/
)brace
r_else
(brace
multiline_comment|/* Convert MegaRAID status to Linux error code */
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* SUCCESS , i.e. SCSI_STATUS_GOOD*/
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* ERROR_ABORTED, i.e. SCSI_STATUS_CHECK_CONDITION */
multiline_comment|/*set sense_buffer and result fields*/
r_if
c_cond
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_PASSTHRU
)paren
(brace
id|memcpy
c_func
(paren
id|SCpnt-&gt;sense_buffer
comma
id|pthru-&gt;reqsensearea
comma
l_int|14
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DRIVER_SENSE
op_lshift
l_int|24
)paren
op_or
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_assign
id|ABORTED_COMMAND
suffix:semicolon
id|SCpnt-&gt;result
op_or_assign
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* ERR_DEST_DRIVE_FAILED, i.e. SCSI_STATUS_BUSY */
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|IOCTL_CMD_NEW
)paren
multiline_comment|/* not IOCTL_CMD_NEW SCB, freeSCB()*/
multiline_comment|/* For IOCTL_CMD_NEW SCB, delay freeSCB() in megaraid_queue()&n;   * after copy data back to user space*/
id|mega_freeSCB
c_func
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
multiline_comment|/* Add Scsi_Command to end of completed queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; *&n; *                 Build a SCB from a Scsi_Cmnd&n; *&n; * Returns a SCB pointer, or NULL&n; * If NULL is returned, the scsi_done function MUST have been called&n; *&n; *-------------------------------------------------------------------*/
DECL|function|mega_build_cmd
r_static
id|mega_scb
op_star
id|mega_build_cmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
r_int
id|seg
suffix:semicolon
r_char
id|islogical
suffix:semicolon
r_char
id|lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|0x80
)paren
op_logical_or
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IOCTL_CMD_NEW
)paren
)paren
multiline_comment|/* ioctl */
r_return
id|mega_ioctl
(paren
id|megaCfg
comma
id|SCpnt
)paren
suffix:semicolon
id|islogical
op_assign
(paren
id|SCpnt-&gt;channel
op_eq
id|megaCfg-&gt;host-&gt;max_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|islogical
op_logical_and
id|lun
op_ne
l_int|0
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|islogical
op_logical_and
id|SCpnt-&gt;target
op_eq
id|skip_id
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|islogical
)paren
(brace
id|lun
op_assign
(paren
id|SCpnt-&gt;target
op_star
l_int|8
)paren
op_plus
id|lun
suffix:semicolon
r_if
c_cond
(paren
id|lun
OG
id|FC_MAX_LOGICAL_DRIVES
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*-----------------------------------------------------&n;   *&n;   *               Logical drive commands&n;   *&n;   *-----------------------------------------------------*/
r_if
c_cond
(paren
id|islogical
)paren
(brace
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TEST_UNIT_READY
suffix:colon
id|memset
(paren
id|SCpnt-&gt;request_buffer
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|memset
(paren
id|SCpnt-&gt;request_buffer
comma
l_int|0
comma
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
r_case
id|INQUIRY
suffix:colon
multiline_comment|/* Allocate a SCB and initialize passthru */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;islogical
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|lun
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|pthru-&gt;dataxferaddr
op_assign
id|virt_to_bus
(paren
id|SCpnt-&gt;request_buffer
)paren
suffix:semicolon
id|pthru-&gt;dataxferlen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox area */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
r_return
id|pScb
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
multiline_comment|/* Allocate a SCB and initialize mailbox */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|mbox-&gt;logdrv
op_assign
id|lun
suffix:semicolon
id|mbox-&gt;cmd
op_assign
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
)paren
ques
c_cond
id|MEGA_MBOXCMD_LREAD
suffix:colon
id|MEGA_MBOXCMD_LWRITE
suffix:semicolon
multiline_comment|/* 6-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_6
)paren
(brace
id|mbox-&gt;numsectors
op_assign
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
suffix:semicolon
id|mbox-&gt;lba
op_and_assign
l_int|0x1FFFFF
suffix:semicolon
)brace
multiline_comment|/* 10-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_10
)paren
(brace
id|mbox-&gt;numsectors
op_assign
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|8
)braket
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|5
)braket
suffix:semicolon
)brace
multiline_comment|/* Calculate Scatter-Gather info */
id|mbox-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|mbox-&gt;xferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|seg
)paren
suffix:semicolon
r_return
id|pScb
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*-----------------------------------------------------&n;   *&n;   *               Passthru drive commands&n;   *&n;   *-----------------------------------------------------*/
r_else
(brace
multiline_comment|/* Allocate a SCB and initialize passthru */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;timeout
op_assign
l_int|2
suffix:semicolon
multiline_comment|/*set adapter timeout value to 10 min. for tape drive*/
multiline_comment|/* 0=6sec/1=60sec/2=10min/3=3hrs */
id|pthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;islogical
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;channel
op_assign
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
l_int|0
suffix:colon
id|SCpnt-&gt;channel
suffix:semicolon
id|pthru-&gt;target
op_assign
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
multiline_comment|/*BOARD_40LD*/
(paren
id|SCpnt-&gt;channel
op_lshift
l_int|4
)paren
op_or
id|SCpnt-&gt;target
suffix:colon
id|SCpnt-&gt;target
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferlen
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
r_return
id|pScb
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------&n; * build RAID commands for controller, passed down through ioctl()&n; *--------------------------------------------------------------------*/
DECL|function|mega_ioctl
r_static
id|mega_scb
op_star
id|mega_ioctl
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|mega_ioctl_mbox
op_star
id|mbox
suffix:semicolon
id|mega_mailbox
op_star
id|mailbox
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
id|u8
op_star
id|mboxdata
suffix:semicolon
r_int
id|seg
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mboxdata
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_ioctl_mbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|mailbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mailbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* passthrough command */
r_int
r_char
id|cdblen
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;islogical
op_assign
(paren
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x80
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pthru-&gt;timeout
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x07
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;ars
op_assign
(paren
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x08
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|4
)braket
suffix:semicolon
id|pthru-&gt;channel
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|5
)braket
suffix:semicolon
id|pthru-&gt;target
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|6
)braket
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|cdblen
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
op_amp
id|data
(braket
l_int|3
)braket
comma
id|cdblen
)paren
suffix:semicolon
id|mailbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|mailbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferlen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SCpnt-&gt;request_bufflen
op_minus
id|cdblen
op_minus
l_int|7
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|data
(braket
id|i
op_plus
id|cdblen
op_plus
l_int|7
)braket
suffix:semicolon
)brace
r_return
id|pScb
suffix:semicolon
)brace
multiline_comment|/* else normal (nonpassthru) command */
macro_line|#if LINUX_VERSION_CODE &gt; 0x020024
multiline_comment|/*&n; * usage of the function copy from user is used in case of data more than&n; * 4KB.  This is used only with adapters which supports more than 8 logical&n; * drives.  This feature is disabled on kernels earlier or same as 2.0.36&n; * as the uaccess.h file is not available with those kernels.&n; */
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IOCTL_CMD_NEW
)paren
(brace
multiline_comment|/* use external data area for large xfers  */
multiline_comment|/* If cmnd[0] is set to IOCTL_CMD_NEW then *&n;      *   cmnd[4..7] = external user buffer     *&n;      *   cmnd[8..11] = length of buffer        *&n;      *                                         */
r_char
op_star
id|kern_area
suffix:semicolon
r_char
op_star
id|user_area
op_assign
op_star
(paren
(paren
r_char
op_star
op_star
)paren
op_amp
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|u32
id|xfer_size
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|SCpnt-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|user_area
comma
id|xfer_size
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;megaraid: Got bad user address.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|kern_area
op_assign
id|kmalloc
c_func
(paren
id|xfer_size
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kern_area
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;megaraid: Couldn&squot;t allocate kernel mem.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
id|kern_area
comma
id|user_area
comma
id|xfer_size
)paren
suffix:semicolon
id|pScb-&gt;kern_area
op_assign
id|kern_area
suffix:semicolon
)brace
macro_line|#endif
id|mbox-&gt;cmd
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|mbox-&gt;channel
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|mbox-&gt;param
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|mbox-&gt;pad
(braket
l_int|0
)braket
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|mbox-&gt;logdrv
op_assign
id|data
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IOCTL_CMD_NEW
)paren
(brace
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|DCMD_FC_CMD
)paren
(brace
multiline_comment|/*i.e. 0xA1, then override some mbox data */
op_star
(paren
id|mboxdata
op_plus
l_int|0
)paren
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*mailbox byte 0: DCMD_FC_CMD*/
op_star
(paren
id|mboxdata
op_plus
l_int|2
)paren
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*sub command*/
op_star
(paren
id|mboxdata
op_plus
l_int|3
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*number of elements in SG list*/
id|mbox-&gt;xferaddr
multiline_comment|/*i.e. mboxdata byte 0x8 to 0xb*/
op_assign
id|virt_to_bus
c_func
(paren
id|pScb-&gt;kern_area
)paren
suffix:semicolon
)brace
r_else
(brace
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
c_func
(paren
id|pScb-&gt;kern_area
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|mbox-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|mbox-&gt;xferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|seg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SCpnt-&gt;request_bufflen
op_minus
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|data
(braket
id|i
op_plus
l_int|6
)braket
suffix:semicolon
)brace
)brace
r_return
(paren
id|pScb
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
DECL|function|showMbox
r_static
r_void
id|showMbox
c_func
(paren
id|mega_scb
op_star
id|pScb
)paren
(brace
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|pScb-&gt;mboxData
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%u cmd:%x id:%x #scts:%x lba:%x addr:%x logdrv:%x #sg:%x&bslash;n&quot;
comma
id|pScb-&gt;SCpnt-&gt;pid
comma
id|mbox-&gt;cmd
comma
id|mbox-&gt;cmdid
comma
id|mbox-&gt;numsectors
comma
id|mbox-&gt;lba
comma
id|mbox-&gt;xferaddr
comma
id|mbox-&gt;logdrv
comma
id|mbox-&gt;numsgelements
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if DEBUG
DECL|variable|cum_time
r_static
r_int
r_int
id|cum_time
op_assign
l_int|0
suffix:semicolon
DECL|variable|cum_time_cnt
r_static
r_int
r_int
id|cum_time_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*--------------------------------------------------------------------&n; * Interrupt service routine&n; *--------------------------------------------------------------------*/
DECL|function|megaraid_isr
r_static
r_void
id|megaraid_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|devp
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
id|IO_LOCK_T
macro_line|#endif
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|u_char
id|byte
comma
id|idx
comma
id|sIdx
comma
id|tmpBox
(braket
id|MAILBOX_SIZE
)braket
suffix:semicolon
id|u32
id|dword
op_assign
l_int|0
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|u_char
id|qCnt
comma
id|qStatus
suffix:semicolon
id|u_char
id|completed
(braket
id|MAX_FIRMWARE_STATUS
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|devp
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|tmpBox
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;host-&gt;irq
op_eq
id|irq
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ISR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ISR called reentrantly!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|megaCfg-&gt;flag
op_or_assign
id|IN_ISR
suffix:semicolon
r_if
c_cond
(paren
id|mega_busyWaitMbox
c_func
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Error: mailbox busy in isr!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if a valid interrupt is pending */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|dword
op_assign
id|RDOUTDOOR
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dword
op_ne
l_int|0x10001234
)paren
(brace
multiline_comment|/* Spurious interrupt */
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|byte
op_assign
id|READ_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|byte
op_amp
id|VALID_INTR_BYTE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Spurious interrupt */
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
r_return
suffix:semicolon
)brace
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
comma
id|byte
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|MAX_FIRMWARE_STATUS
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|completed
(braket
id|idx
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|IO_LOCK
suffix:semicolon
id|qCnt
op_assign
l_int|0xff
suffix:semicolon
r_while
c_loop
(paren
(paren
id|qCnt
op_assign
id|megaCfg-&gt;mbox-&gt;numstatus
)paren
op_eq
l_int|0xFF
)paren
suffix:semicolon
id|qStatus
op_assign
l_int|0xff
suffix:semicolon
r_while
c_loop
(paren
(paren
id|qStatus
op_assign
id|megaCfg-&gt;mbox-&gt;status
)paren
op_eq
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* Get list of completed requests */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|qCnt
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|sIdx
op_assign
id|megaCfg-&gt;mbox-&gt;completed
(braket
id|idx
)braket
)paren
op_eq
l_int|0xFF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;p&quot;
)paren
suffix:semicolon
)brace
id|completed
(braket
id|idx
)braket
op_assign
id|sIdx
suffix:semicolon
id|sIdx
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|WROUTDOOR
(paren
id|megaCfg
comma
id|dword
)paren
suffix:semicolon
multiline_comment|/* Acknowledge interrupt */
id|WRINDOOR
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
op_or
l_int|0x2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RDINDOOR
(paren
id|megaCfg
)paren
op_amp
l_int|0x02
)paren
suffix:semicolon
)brace
r_else
(brace
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|qCnt
op_ge
id|MAX_FIRMWARE_STATUS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;megaraid_isr: cmplt=%d &quot;
comma
id|qCnt
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|qCnt
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|sIdx
op_assign
id|completed
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sIdx
OG
l_int|0
)paren
op_logical_and
(paren
id|sIdx
op_le
id|MAX_COMMANDS
)paren
)paren
(brace
id|pScb
op_assign
op_amp
id|megaCfg-&gt;scbList
(braket
id|sIdx
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* ASSERT(pScb-&gt;state == SCB_ISSUED); */
macro_line|#if DEBUG
r_if
c_cond
(paren
(paren
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
)paren
OG
id|maxCmdTime
)paren
(brace
id|maxCmdTime
op_assign
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;megaraid_isr : cmd time = %u&bslash;n&quot;
comma
id|maxCmdTime
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Assuming that the scsi command, for which an abort request was received&n; * earlier has completed.&n; */
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_ABORTED
)paren
(brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_RESET
)paren
(brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
id|mega_freeSCB
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
(paren
id|pScb-&gt;SCpnt-&gt;cmnd
)paren
op_eq
id|IOCTL_CMD_NEW
)paren
(brace
multiline_comment|/* external user buffer */
id|up
c_func
(paren
op_amp
id|pScb-&gt;sem
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark command as completed */
id|mega_cmd_done
c_func
(paren
id|megaCfg
comma
id|pScb
comma
id|qStatus
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;megaraid: wrong cmd id completed from firmware:id=%x&bslash;n&quot;
comma
id|sIdx
)paren
suffix:semicolon
)brace
)brace
id|mega_rundoneq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
multiline_comment|/* Loop through any pending requests */
id|mega_runpendq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
id|IO_UNLOCK
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*==================================================*/
multiline_comment|/* Wait until the controller&squot;s mailbox is available */
multiline_comment|/*==================================================*/
DECL|function|mega_busyWaitMbox
r_static
r_int
id|mega_busyWaitMbox
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_mailbox
op_star
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
suffix:semicolon
r_int
id|counter
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|10000
suffix:semicolon
id|counter
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mbox-&gt;busy
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* give up after 1 second */
)brace
multiline_comment|/*=====================================================&n; * Post a command to the card&n; *&n; * Arguments:&n; *   mega_host_config *megaCfg - Controller structure&n; *   u_char *mboxData - Mailbox area, 16 bytes&n; *   mega_scb *pScb   - SCB posting (or NULL if N/A)&n; *   int intr         - if 1, interrupt, 0 is blocking&n; * Return Value: (added on 7/26 for 40ld/64bit)&n; *   -1: the command was not actually issued out&n; *   othercases:&n; *     intr==0, return ScsiStatus, i.e. mbox-&gt;status&n; *     intr==1, return 0 &n; *=====================================================&n; */
DECL|function|megaIssueCmd
r_static
r_int
id|megaIssueCmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_char
op_star
id|mboxData
comma
id|mega_scb
op_star
id|pScb
comma
r_int
id|intr
)paren
(brace
id|mega_mailbox
op_star
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
suffix:semicolon
id|u_char
id|byte
suffix:semicolon
id|u32
id|cmdDone
suffix:semicolon
id|u32
id|phys_mbox
suffix:semicolon
id|u8
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
id|mboxData
(braket
l_int|0x1
)braket
op_assign
(paren
id|pScb
ques
c_cond
id|pScb-&gt;idx
op_plus
l_int|1
suffix:colon
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* Set cmdid */
id|mboxData
(braket
l_int|0xF
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set busy */
id|phys_mbox
op_assign
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
suffix:semicolon
macro_line|#if DEBUG
id|showMbox
c_func
(paren
id|pScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Wait until mailbox is free */
r_if
c_cond
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Blocked mailbox......!!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
macro_line|#if DEBUG
id|showMbox
c_func
(paren
id|pLastScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Abort command */
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|TRACE
c_func
(paren
(paren
l_string|&quot;NULL pScb in megaIssue&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NULL pScb in megaIssue&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
l_int|0x08
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pLastScb
op_assign
id|pScb
suffix:semicolon
multiline_comment|/* Copy mailbox data into host structure */
id|megaCfg-&gt;mbox64-&gt;xferSegment
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|mbox
comma
id|mboxData
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Kick IO */
r_if
c_cond
(paren
id|intr
)paren
(brace
multiline_comment|/* Issue interrupt (non-blocking) command */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0
suffix:semicolon
id|WRINDOOR
(paren
id|megaCfg
comma
id|phys_mbox
op_or
l_int|0x1
)paren
suffix:semicolon
)brace
r_else
(brace
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ISSUE_COMMAND
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
id|pScb-&gt;state
op_assign
id|SCB_ISSUED
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Issue non-ISR (blocking) command */
id|disable_irq
c_func
(paren
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0
suffix:semicolon
id|WRINDOOR
(paren
id|megaCfg
comma
id|phys_mbox
op_or
l_int|0x1
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cmdDone
op_assign
id|RDOUTDOOR
(paren
id|megaCfg
)paren
)paren
op_ne
l_int|0x10001234
)paren
suffix:semicolon
id|WROUTDOOR
(paren
id|megaCfg
comma
id|cmdDone
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScb
)paren
(brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox-&gt;status
)paren
suffix:semicolon
)brace
id|WRINDOOR
(paren
id|megaCfg
comma
id|phys_mbox
op_or
l_int|0x2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RDINDOOR
(paren
id|megaCfg
)paren
op_amp
l_int|0x2
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ISSUE_COMMAND
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|byte
op_assign
id|READ_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
)paren
)paren
op_amp
id|INTR_VALID
)paren
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
comma
id|byte
)paren
suffix:semicolon
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScb
)paren
(brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox-&gt;status
)paren
suffix:semicolon
)brace
r_else
(brace
id|TRACE
(paren
(paren
l_string|&quot;Error: NULL pScb!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|enable_irq
c_func
(paren
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
id|retval
op_assign
id|mbox-&gt;status
suffix:semicolon
)brace
macro_line|#if DEBUG
r_while
c_loop
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Blocked mailbox on exit......!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; * Copies data to SGLIST&n; *-------------------------------------------------------------------*/
DECL|function|mega_build_sglist
r_static
r_int
id|mega_build_sglist
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|scb
comma
id|u32
op_star
id|buffer
comma
id|u32
op_star
id|length
)paren
(brace
r_struct
id|scatterlist
op_star
id|sgList
suffix:semicolon
r_int
id|idx
suffix:semicolon
multiline_comment|/* Scatter-gather not used */
r_if
c_cond
(paren
id|scb-&gt;SCpnt-&gt;use_sg
op_eq
l_int|0
)paren
(brace
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|scb-&gt;SCpnt-&gt;request_buffer
)paren
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u32
)paren
id|scb-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sgList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|scb-&gt;SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;SCpnt-&gt;use_sg
op_eq
l_int|1
)paren
(brace
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|sgList
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u32
)paren
id|sgList
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy Scatter-Gather list info into controller structure */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
id|sgList
(braket
id|idx
)braket
dot
id|address
)paren
suffix:semicolon
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|length
op_assign
(paren
id|u32
)paren
id|sgList
(braket
id|idx
)braket
dot
id|length
suffix:semicolon
)brace
multiline_comment|/* Reset pointer and length fields */
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|scb-&gt;sgList
)paren
suffix:semicolon
op_star
id|length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Return count of SG requests */
r_return
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------&n; * Initializes the adress of the controller&squot;s mailbox register&n; *  The mailbox register is used to issue commands to the card.&n; *  Format of the mailbox area:&n; *   00 01 command&n; *   01 01 command id&n; *   02 02 # of sectors&n; *   04 04 logical bus address&n; *   08 04 physical buffer address&n; *   0C 01 logical drive #&n; *   0D 01 length of scatter/gather list&n; *   0E 01 reserved&n; *   0F 01 mailbox busy&n; *   10 01 numstatus byte&n; *   11 01 status byte&n; *--------------------------------------------------------------------*/
DECL|function|mega_register_mailbox
r_static
r_int
id|mega_register_mailbox
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u32
id|paddr
)paren
(brace
multiline_comment|/* align on 16-byte boundry */
id|megaCfg-&gt;mbox
op_assign
op_amp
id|megaCfg-&gt;mailbox64.mailbox
suffix:semicolon
id|megaCfg-&gt;mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
(paren
(paren
(paren
(paren
id|u32
)paren
id|megaCfg-&gt;mbox
)paren
op_plus
l_int|16
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|megaCfg-&gt;mbox64
op_assign
(paren
id|mega_mailbox64
op_star
)paren
(paren
id|megaCfg-&gt;mbox
op_minus
l_int|4
)paren
suffix:semicolon
id|paddr
op_assign
(paren
id|paddr
op_plus
l_int|4
op_plus
l_int|16
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
multiline_comment|/* Register mailbox area with the firmware */
r_if
c_cond
(paren
op_logical_neg
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
)paren
(brace
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT0
comma
id|paddr
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT1
comma
(paren
id|paddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT2
comma
(paren
id|paddr
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT3
comma
(paren
id|paddr
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|ENABLE_MBOX_REGION
comma
id|ENABLE_MBOX_BYTE
)paren
suffix:semicolon
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * mega_Convert8ldTo40ld() -- takes all info in AdapterInquiry structure and&n; * puts it into ProductInfo and Enquiry3 structures for later use&n; *---------------------------------------------------------------------------*/
DECL|function|mega_Convert8ldTo40ld
r_static
r_void
id|mega_Convert8ldTo40ld
c_func
(paren
id|mega_RAIDINQ
op_star
id|inquiry
comma
id|mega_Enquiry3
op_star
id|enquiry3
comma
id|megaRaidProductInfo
op_star
id|productInfo
)paren
(brace
r_int
id|i
suffix:semicolon
id|productInfo-&gt;MaxConcCmds
op_assign
id|inquiry-&gt;AdpInfo.MaxConcCmds
suffix:semicolon
id|enquiry3-&gt;rbldRate
op_assign
id|inquiry-&gt;AdpInfo.RbldRate
suffix:semicolon
id|productInfo-&gt;SCSIChanPresent
op_assign
id|inquiry-&gt;AdpInfo.ChanPresent
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|productInfo-&gt;FwVer
(braket
id|i
)braket
op_assign
id|inquiry-&gt;AdpInfo.FwVer
(braket
id|i
)braket
suffix:semicolon
id|productInfo-&gt;BiosVer
(braket
id|i
)braket
op_assign
id|inquiry-&gt;AdpInfo.BiosVer
(braket
id|i
)braket
suffix:semicolon
)brace
id|enquiry3-&gt;cacheFlushInterval
op_assign
id|inquiry-&gt;AdpInfo.CacheFlushInterval
suffix:semicolon
id|productInfo-&gt;DramSize
op_assign
id|inquiry-&gt;AdpInfo.DramSize
suffix:semicolon
id|enquiry3-&gt;numLDrv
op_assign
id|inquiry-&gt;LogdrvInfo.NumLDrv
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_LOGICAL_DRIVES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|enquiry3-&gt;lDrvSize
(braket
id|i
)braket
op_assign
id|inquiry-&gt;LogdrvInfo.LDrvSize
(braket
id|i
)braket
suffix:semicolon
id|enquiry3-&gt;lDrvProp
(braket
id|i
)braket
op_assign
id|inquiry-&gt;LogdrvInfo.LDrvProp
(braket
id|i
)braket
suffix:semicolon
id|enquiry3-&gt;lDrvState
(braket
id|i
)braket
op_assign
id|inquiry-&gt;LogdrvInfo.LDrvState
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|MAX_PHYSICAL_DRIVES
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|enquiry3-&gt;pDrvState
(braket
id|i
)braket
op_assign
id|inquiry-&gt;PhysdrvInfo.PDrvState
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------&n; * Issue an adapter info query to the controller&n; *-------------------------------------------------------------------*/
DECL|function|mega_i_query_adapter
r_static
r_int
id|mega_i_query_adapter
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_Enquiry3
op_star
id|enquiry3Pnt
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
id|u32
id|paddr
suffix:semicolon
id|u8
id|retval
suffix:semicolon
multiline_comment|/* Initialize adapter inquiry mailbox*/
id|paddr
op_assign
id|virt_to_bus
(paren
id|megaCfg-&gt;mega_buffer
)paren
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mega_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|megaCfg-&gt;mega_buffer
)paren
)paren
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n; * Try to issue Enquiry3 command &n; * if not suceeded, then issue MEGA_MBOXCMD_ADAPTERINQ command and &n; * update enquiry3 structure&n; */
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mega_buffer
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox databuffer addr */
id|enquiry3Pnt
op_assign
(paren
id|mega_Enquiry3
op_star
)paren
id|megaCfg-&gt;mega_buffer
suffix:semicolon
multiline_comment|/* point mega_Enguiry3 to the data buf */
id|mboxData
(braket
l_int|0
)braket
op_assign
id|FC_NEW_CONFIG
suffix:semicolon
multiline_comment|/* i.e. mbox-&gt;cmd=0xA1 */
id|mboxData
(braket
l_int|2
)braket
op_assign
id|NC_SUBOP_ENQUIRY3
suffix:semicolon
multiline_comment|/* i.e. 0x0F */
id|mboxData
(braket
l_int|3
)braket
op_assign
id|ENQ3_GET_SOLICITED_FULL
suffix:semicolon
multiline_comment|/* i.e. 0x02 */
multiline_comment|/* Issue a blocking command to the card */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|megaIssueCmd
c_func
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* the adapter does not support 40ld*/
id|mega_RAIDINQ
id|adapterInquiryData
suffix:semicolon
id|mega_RAIDINQ
op_star
id|adapterInquiryPnt
op_assign
op_amp
id|adapterInquiryData
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
id|adapterInquiryPnt
)paren
suffix:semicolon
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_ADAPTERINQ
suffix:semicolon
multiline_comment|/*issue old 0x05 command to adapter*/
multiline_comment|/* Issue a blocking command to the card */
suffix:semicolon
id|retval
op_assign
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*update Enquiry3 and ProductInfo structures with mega_RAIDINQ structure*/
id|mega_Convert8ldTo40ld
c_func
(paren
id|adapterInquiryPnt
comma
id|enquiry3Pnt
comma
(paren
id|megaRaidProductInfo
op_star
)paren
op_amp
id|megaCfg-&gt;productInfo
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* adapter supports 40ld */
id|megaCfg-&gt;flag
op_or_assign
id|BOARD_40LD
suffix:semicolon
multiline_comment|/*get productInfo, which is static information and will be unchanged*/
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
op_amp
id|megaCfg-&gt;productInfo
)paren
suffix:semicolon
id|mboxData
(braket
l_int|0
)braket
op_assign
id|FC_NEW_CONFIG
suffix:semicolon
multiline_comment|/* i.e. mbox-&gt;cmd=0xA1 */
id|mboxData
(braket
l_int|2
)braket
op_assign
id|NC_SUBOP_PRODUCT_INFO
suffix:semicolon
multiline_comment|/* i.e. 0x0E */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|megaIssueCmd
c_func
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ami:Product_info (0x0E) cmd failed with error: %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
)brace
)brace
id|megaCfg-&gt;host-&gt;max_channel
op_assign
id|megaCfg-&gt;productInfo.SCSIChanPresent
suffix:semicolon
id|megaCfg-&gt;host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* max targets per channel */
multiline_comment|/*(megaCfg-&gt;flag &amp; BOARD_40LD)?FC_MAX_TARGETS_PER_CHANNEL:MAX_TARGET+1;*/
id|megaCfg-&gt;host-&gt;max_lun
op_assign
multiline_comment|/* max lun */
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
id|FC_MAX_LOGICAL_DRIVES
suffix:colon
id|MAX_LOGICAL_DRIVES
suffix:semicolon
id|megaCfg-&gt;host-&gt;cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
id|megaCfg-&gt;numldrv
op_assign
id|enquiry3Pnt-&gt;numLDrv
suffix:semicolon
id|megaCfg-&gt;max_cmds
op_assign
id|megaCfg-&gt;productInfo.MaxConcCmds
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;max_cmds
OG
id|MAX_COMMANDS
)paren
(brace
id|megaCfg-&gt;max_cmds
op_assign
id|MAX_COMMANDS
op_minus
l_int|1
suffix:semicolon
)brace
id|megaCfg-&gt;host-&gt;can_queue
op_assign
id|megaCfg-&gt;max_cmds
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;host-&gt;can_queue
op_ge
id|MAX_COMMANDS
)paren
(brace
id|megaCfg-&gt;host-&gt;can_queue
op_assign
id|MAX_COMMANDS
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef HP&t;&t;&t;/* use HP firmware and bios version encoding */
id|sprintf
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;%c%d%d.%d%d&quot;
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|2
)braket
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|1
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|2
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|sprintf
(paren
id|megaCfg-&gt;biosVer
comma
l_string|&quot;%c%d%d.%d%d&quot;
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|2
)braket
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|1
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|2
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
macro_line|#else
id|memcpy
(paren
id|megaCfg-&gt;fwVer
comma
(paren
r_void
op_star
)paren
id|megaCfg-&gt;productInfo.FwVer
comma
l_int|4
)paren
suffix:semicolon
id|megaCfg-&gt;fwVer
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|megaCfg-&gt;biosVer
comma
(paren
r_void
op_star
)paren
id|megaCfg-&gt;productInfo.BiosVer
comma
l_int|4
)paren
suffix:semicolon
id|megaCfg-&gt;biosVer
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|printk
(paren
l_string|&quot;megaraid: [%s:%s] detected %d logical drives&quot;
id|CRLFSTR
comma
id|megaCfg-&gt;fwVer
comma
id|megaCfg-&gt;biosVer
comma
id|megaCfg-&gt;numldrv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------&n; *&n; *                      Driver interface functions&n; *&n; *-------------------------------------------------------------------------*/
multiline_comment|/*----------------------------------------------------------&n; * Returns data to be displayed in /proc/scsi/megaraid/X&n; *----------------------------------------------------------*/
DECL|function|megaraid_proc_info
r_int
id|megaraid_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|host_no
comma
r_int
id|inout
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mega_findCard
r_int
id|mega_findCard
(paren
id|Scsi_Host_Template
op_star
id|pHostTmpl
comma
id|u16
id|pciVendor
comma
id|u16
id|pciDev
comma
r_int
id|flag
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|u_char
id|megaIrq
suffix:semicolon
id|u32
id|megaBase
suffix:semicolon
id|u16
id|numFound
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
(paren
id|pciVendor
comma
id|pciDev
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
op_logical_and
(paren
id|skip_id
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|u16
id|magic
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_CONF_AMISIG
comma
op_amp
id|magic
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|magic
op_ne
id|AMI_SIGNATURE
)paren
op_logical_and
(paren
id|magic
op_ne
id|AMI_SIGNATURE_471
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* not an AMI board */
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;megaraid: found 0x%4.04x:0x%4.04x: in %s&bslash;n&quot;
comma
id|pciVendor
comma
id|pciDev
comma
id|pdev-&gt;slot_name
)paren
suffix:semicolon
multiline_comment|/* Read the base port and IRQ from PCI */
id|megaBase
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|megaIrq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
id|megaBase
op_assign
(paren
r_int
)paren
id|ioremap
(paren
id|megaBase
comma
l_int|128
)paren
suffix:semicolon
r_else
id|megaBase
op_add_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Initialize SCSI Host structure */
id|host
op_assign
id|scsi_register
(paren
id|pHostTmpl
comma
r_sizeof
(paren
id|mega_host_config
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
(paren
id|megaCfg
comma
l_int|0
comma
r_sizeof
(paren
id|mega_host_config
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;scsi%d : Found a MegaRAID controller at 0x%x, IRQ: %d&quot;
id|CRLFSTR
comma
id|host-&gt;host_no
comma
(paren
id|u_int
)paren
id|megaBase
comma
id|megaIrq
)paren
suffix:semicolon
multiline_comment|/* Copy resource info into structure */
id|megaCfg-&gt;qCompletedH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qPendingH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qPendingT
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFreeH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFreeT
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;qPcnt
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;flag
op_assign
id|flag
suffix:semicolon
id|megaCfg-&gt;host
op_assign
id|host
suffix:semicolon
id|megaCfg-&gt;base
op_assign
id|megaBase
suffix:semicolon
id|megaCfg-&gt;host-&gt;irq
op_assign
id|megaIrq
suffix:semicolon
id|megaCfg-&gt;host-&gt;io_port
op_assign
id|megaBase
suffix:semicolon
id|megaCfg-&gt;host-&gt;n_io_port
op_assign
l_int|16
suffix:semicolon
id|megaCfg-&gt;host-&gt;unique_id
op_assign
(paren
id|pdev-&gt;bus-&gt;number
op_lshift
l_int|8
)paren
op_or
id|pdev-&gt;devfn
suffix:semicolon
id|megaCtlrs
(braket
id|numCtlrs
op_increment
)braket
op_assign
id|megaCfg
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_ne
id|BOARD_QUARTZ
)paren
(brace
multiline_comment|/* Request our IO Range */
r_if
c_cond
(paren
id|request_region
(paren
id|megaBase
comma
l_int|16
comma
l_string|&quot;megaraid&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Couldn&squot;t register I/O range!&quot;
id|CRLFSTR
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* Request our IRQ */
r_if
c_cond
(paren
id|request_irq
(paren
id|megaIrq
comma
id|megaraid_isr
comma
id|SA_SHIRQ
comma
l_string|&quot;megaraid&quot;
comma
id|megaCfg
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Couldn&squot;t register IRQ %d!&quot;
id|CRLFSTR
comma
id|megaIrq
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mega_register_mailbox
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
op_amp
id|megaCfg-&gt;mailbox64
)paren
)paren
suffix:semicolon
id|mega_i_query_adapter
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|BOARD_QUARTZ
)paren
(brace
multiline_comment|/* Check to see if this is a Dell PERC RAID controller model 466 */
id|u16
id|subsysid
comma
id|subsysvid
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x20100
id|pcibios_read_config_word
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|subsysvid
)paren
suffix:semicolon
id|pcibios_read_config_word
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subsysid
)paren
suffix:semicolon
macro_line|#else
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|subsysvid
)paren
suffix:semicolon
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subsysid
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|subsysid
op_eq
l_int|0x1111
)paren
op_logical_and
(paren
id|subsysvid
op_eq
l_int|0x1111
)paren
op_logical_and
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;3.00&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;3.01&quot;
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Your card is a Dell PERC 2/SC RAID controller with firmware&bslash;n&quot;
l_string|&quot;megaraid: 3.00 or 3.01.  This driver is known to have corruption issues&bslash;n&quot;
l_string|&quot;megaraid: with those firmware versions on this specific card.  In order&bslash;n&quot;
l_string|&quot;megaraid: to protect your data, please upgrade your firmware to version&bslash;n&quot;
l_string|&quot;megaraid: 3.10 or later, available from the Dell Technical Support web&bslash;n&quot;
l_string|&quot;megaraid: site at&bslash;n&quot;
l_string|&quot;http://support.dell.com/us/en/filelib/download/index.asp?fileid=2940&bslash;n&quot;
)paren
suffix:semicolon
id|megaraid_release
(paren
id|host
)paren
suffix:semicolon
macro_line|#ifdef MODULE&t;
r_continue
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#endif&t;
)brace
)brace
multiline_comment|/* Initialize SCBs */
r_if
c_cond
(paren
id|mega_initSCB
(paren
id|megaCfg
)paren
)paren
(brace
id|megaraid_release
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|numFound
op_increment
suffix:semicolon
)brace
r_return
id|numFound
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------&n; * Detects if a megaraid controller exists in this system&n; *---------------------------------------------------------*/
DECL|function|megaraid_detect
r_int
id|megaraid_detect
(paren
id|Scsi_Host_Template
op_star
id|pHostTmpl
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
id|megaraid
)paren
id|megaraid_setup
c_func
(paren
id|megaraid
)paren
suffix:semicolon
macro_line|#endif
id|pHostTmpl-&gt;proc_name
op_assign
l_string|&quot;megaraid&quot;
suffix:semicolon
id|printk
(paren
l_string|&quot;megaraid: &quot;
id|MEGARAID_VERSION
id|CRLFSTR
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
l_int|0x101E
comma
l_int|0x9010
comma
l_int|0
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
l_int|0x101E
comma
l_int|0x9060
comma
l_int|0
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
l_int|0x8086
comma
l_int|0x1960
comma
id|BOARD_QUARTZ
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Release the controller&squot;s resources&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_release
r_int
id|megaraid_release
(paren
r_struct
id|Scsi_Host
op_star
id|pSHost
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
multiline_comment|/* Flush cache to disk */
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|mboxData
(braket
l_int|0
)braket
op_assign
l_int|0xA
suffix:semicolon
id|free_irq
(paren
id|megaCfg-&gt;host-&gt;irq
comma
id|megaCfg
)paren
suffix:semicolon
multiline_comment|/* Must be freed first, otherwise&n;&t;&t;&t;&t;&t;   extra interrupt is generated */
multiline_comment|/* Issue a blocking (interrupts disabled) command to the card */
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Free our resources */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;base
)paren
suffix:semicolon
)brace
r_else
(brace
id|release_region
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
l_int|16
)paren
suffix:semicolon
)brace
id|mega_freeSgList
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|pSHost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mega_freeSgList
r_static
r_inline
r_void
id|mega_freeSgList
c_func
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
)paren
id|kfree
(paren
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
)paren
suffix:semicolon
multiline_comment|/* free sgList */
)brace
)brace
multiline_comment|/*----------------------------------------------&n; * Get information about the card/driver &n; *----------------------------------------------*/
DECL|function|megaraid_info
r_const
r_char
op_star
id|megaraid_info
(paren
r_struct
id|Scsi_Host
op_star
id|pSHost
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;AMI MegaRAID %s %d commands %d targs %d chans %d luns&quot;
comma
id|megaCfg-&gt;fwVer
comma
id|megaCfg-&gt;productInfo.MaxConcCmds
comma
id|megaCfg-&gt;host-&gt;max_id
comma
id|megaCfg-&gt;host-&gt;max_channel
comma
id|megaCfg-&gt;host-&gt;max_lun
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Perform a SCSI command&n; * Mailbox area:&n; *   00 01 command&n; *   01 01 command id&n; *   02 02 # of sectors&n; *   04 04 logical bus address&n; *   08 04 physical buffer address&n; *   0C 01 logical drive #&n; *   0D 01 length of scatter/gather list&n; *   0E 01 reserved&n; *   0F 01 mailbox busy&n; *   10 01 numstatus byte&n; *   11 01 status byte &n; *-----------------------------------------------------------------*/
DECL|function|megaraid_queue
r_int
id|megaraid_queue
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|pktComp
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|DRIVER_LOCK_T
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|DRIVER_LOCK
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|megaCfg-&gt;flag
op_amp
(paren
l_int|1L
op_lshift
id|SCpnt-&gt;channel
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;channel
OL
id|SCpnt-&gt;host-&gt;max_channel
)paren
id|printk
(paren
multiline_comment|/*KERN_INFO*/
l_string|&quot;scsi%d: scanning channel %c for devices.&bslash;n&quot;
comma
id|megaCfg-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;channel
op_plus
l_char|&squot;1&squot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
multiline_comment|/*KERN_INFO*/
l_string|&quot;scsi%d: scanning virtual channel for logical drives.&bslash;n&quot;
comma
id|megaCfg-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
(paren
l_int|1L
op_lshift
id|SCpnt-&gt;channel
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;scsi_done
op_assign
id|pktComp
suffix:semicolon
multiline_comment|/* If driver in abort or reset.. cancel this command */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ABORT
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Add Scsi_Command to end of completed queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
id|DRIVER_UNLOCK
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_RESET
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Add Scsi_Command to end of completed queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
id|DRIVER_UNLOCK
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|megaCfg-&gt;flag
op_or_assign
id|IN_QUEUE
suffix:semicolon
multiline_comment|/* Allocate and build a SCB request */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_build_cmd
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*build SCpnt for IOCTL_CMD_NEW cmd in mega_ioctl()*/
multiline_comment|/* Add SCB to the head of the pending queue */
multiline_comment|/* Add SCB to the head of the pending queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qPendingH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qPendingH
op_assign
id|megaCfg-&gt;qPendingT
op_assign
id|pScb
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qPendingT-&gt;next
op_assign
id|pScb
suffix:semicolon
id|megaCfg-&gt;qPendingT
op_assign
id|pScb
suffix:semicolon
)brace
id|megaCfg-&gt;qPendingT-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qPcnt
op_increment
suffix:semicolon
id|mega_runpendq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; 0x020024
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IOCTL_CMD_NEW
)paren
(brace
multiline_comment|/* user data from external user buffer */
r_char
op_star
id|user_area
suffix:semicolon
id|u32
id|xfer_size
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|pScb-&gt;sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|pScb-&gt;sem
)paren
suffix:semicolon
id|user_area
op_assign
op_star
(paren
(paren
r_char
op_star
op_star
)paren
op_amp
id|pScb-&gt;SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|xfer_size
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|pScb-&gt;SCpnt-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|user_area
comma
id|pScb-&gt;kern_area
comma
id|xfer_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pScb-&gt;kern_area
)paren
suffix:semicolon
id|mega_freeSCB
c_func
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_QUEUE
suffix:semicolon
id|DRIVER_UNLOCK
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n; * Issue a blocking command to the controller&n; *----------------------------------------------------------------------*/
DECL|variable|internal_done_flag
r_volatile
r_static
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_volatile
r_static
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|internal_wait
)paren
suffix:semicolon
DECL|function|internal_done
r_static
r_void
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_errcode
op_assign
id|SCpnt-&gt;result
suffix:semicolon
id|internal_done_flag
op_increment
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|internal_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* shouldn&squot;t be used, but included for completeness */
DECL|function|megaraid_command
r_int
id|megaraid_command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Queue command, and wait until it has completed */
id|megaraid_queue
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|internal_wait
)paren
suffix:semicolon
)brace
r_return
id|internal_done_errcode
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Abort a previous SCSI request&n; *---------------------------------------------------------------------*/
r_int
DECL|function|megaraid_abort
id|megaraid_abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_int
id|rc
suffix:semicolon
singleline_comment|//, idx;
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
id|IN_ABORT
suffix:semicolon
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPendingH
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;SCpnt
op_eq
id|SCpnt
)paren
(brace
multiline_comment|/* Found an aborting command */
macro_line|#if DEBUG
id|showMbox
c_func
(paren
id|pScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * If the command is queued to be issued to the firmware, abort the scsi cmd,&n; * If the command is already aborted in a previous call to the _abort entry&n; *  point, return SCSI_ABORT_SNOOZE, suggesting a reset.&n; * If the command is issued to the firmware, which might complete after&n; *  some time, we will mark the scb as aborted, and return to the mid layer, &n; *  that abort could not be done.&n; *  In the ISR, when this command actually completes, we will perform a normal&n; *  completion.&n; *&n; * Oct 27, 1999&n; */
r_switch
c_cond
(paren
id|pScb-&gt;state
)paren
(brace
r_case
id|SCB_ABORTED
suffix:colon
multiline_comment|/* Already aborted */
id|rc
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCB_ISSUED
suffix:colon
multiline_comment|/* Waiting on ISR result */
id|rc
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
id|pScb-&gt;state
op_assign
id|SCB_ABORTED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCB_ACTIVE
suffix:colon
multiline_comment|/* still on the pending queue */
id|mega_freeSCB
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;megaraid_abort: unknown command state!!&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ABORT
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_QUEUE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ma:flag is in queue&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ma:qchead == null&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * This is required here to complete any completed requests to be communicated&n; * over to the mid layer.&n; * Calling just mega_rundoneq() did not work.&n; */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
)paren
(brace
id|SCpnt
op_assign
id|megaCfg-&gt;qCompletedH
suffix:semicolon
id|megaCfg-&gt;qCompletedH
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_decrement
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* Callback */
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|mega_rundoneq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Reset a previous SCSI request&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_reset
r_int
id|megaraid_reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|rstflags
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|rc
op_assign
id|SCSI_RESET_NOT_RUNNING
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
id|IN_RESET
suffix:semicolon
id|printk
(paren
l_string|&quot;megaraid_RESET: %.08lx cmd=%.02x &lt;c=%d.t=%d.l=%d&gt;, flag = %x&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|rstflags
)paren
suffix:semicolon
id|TRACE
(paren
(paren
l_string|&quot;RESET: %.08lx %.02x &lt;%d.%d.%d&gt;&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;   * Walk list of SCBs for any that are still outstanding&n;   */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|state
op_ne
id|SCB_FREE
)paren
(brace
id|SCpnt
op_assign
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|SCpnt
suffix:semicolon
id|pScb
op_assign
op_amp
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_ne
l_int|NULL
)paren
(brace
id|pScb-&gt;state
op_assign
id|SCB_RESET
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_RESET
suffix:semicolon
id|mega_rundoneq
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------&n; * Return the disk geometry for a particular disk&n; * Input:&n; *   Disk *disk - Disk geometry&n; *   kdev_t dev - Device node&n; *   int *geom  - Returns geometry fields&n; *     geom[0] = heads&n; *     geom[1] = sectors&n; *     geom[2] = cylinders&n; *-------------------------------------------------------------*/
DECL|function|megaraid_biosparam
r_int
id|megaraid_biosparam
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|geom
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
multiline_comment|/* Get pointer to host config structure */
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Default heads (64) &amp; sectors (32) */
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
multiline_comment|/* Handle extended translation size for logical drives &gt; 1Gb */
r_if
c_cond
(paren
id|disk-&gt;capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
multiline_comment|/* return result */
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|megaraid_setup
r_static
r_int
id|__init
id|megaraid_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|skip_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|str
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;skip&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;skip&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|str
(braket
l_int|4
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|skip_id
op_assign
id|str
(braket
l_int|4
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|str
(braket
l_int|5
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|skip_id
op_assign
(paren
id|skip_id
op_star
l_int|10
)paren
op_plus
(paren
id|str
(braket
l_int|5
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
)brace
id|skip_id
op_assign
(paren
id|skip_id
OG
l_int|15
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
id|skip_id
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;megaraid=&quot;
comma
id|megaraid_setup
)paren
suffix:semicolon
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|MEGARAID
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
