multiline_comment|/**************************************************************************&n; * Initio 9100 device driver for Linux.&n; *&n; * Copyright (c) 1994-1998 Initio Corporation&n; * Copyright (c) 1998 Bas Vermeulen &lt;bvermeul@blackstar.xs4all.nl&gt;&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; see the file COPYING.  If not, write to&n; * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * --------------------------------------------------------------------------&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification, immediately at the beginning of the file.&n; * 2. Redistributions in binary form must reproduce the above copyright&n; *    notice, this list of conditions and the following disclaimer in the&n; *    documentation and/or other materials provided with the distribution.&n; * 3. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Where this Software is combined with software released under the terms of &n; * the GNU Public License (&quot;GPL&quot;) and the terms of the GPL would require the &n; * combined work to also be released under the terms of the GPL, the terms&n; * and conditions of this License will apply in addition to those of the&n; * GPL with the exception of any terms or conditions of this License that&n; * conflict with, or are expressly prohibited by, the GPL.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; ************************************************************************&n;    Module: i91uscsi.c&n;    Description: PCI I/F for INI-910 SCSI Bus Master Controller&n;    Revision History:&n;&t;11/09/94 Tim Chen, Initiali Version 0.90A&n;&t;01/17/95 TC, release ver 1.01&n;&t;02/09/95 TC  modify ReadPCIConfig, try both mechanisms;&n;&t;02/15/95 TC  add support for INI-9100W&n;&t;06/04/96 HC, Change to fit LINUX from jaspci.c&n;&t;11/18/96 HC, Port for tulip&n;&t;07/08/98 hc, Support 0002134A&n;        07/23/98 wh, Change the abort_srb routine.&n;&t;09/16/98 hl, Support ALPHA, Rewrite the returnNumberAdapters&t;&lt;01&gt;&n;&t;12/09/98 bv, Removed unused code, changed tul_se2_wait to&n;&t;&t;     use udelay(30) and tul_do_pause to enable &n;&t;&t;     interrupts for &gt;= 2.1.95&n;&t;12/13/98 bv, Use spinlocks instead of cli() for serialized&n;&t;&t;     access to HCS_Semaph, HCS_FirstAvail and HCS_LastAvail&n;&t;&t;     members of the HCS structure.&n;&t;01/09/98 bv, Fix a deadlock on SMP system.&n;**********************************************************************/
DECL|macro|DEBUG_INTERRUPT
mdefine_line|#define DEBUG_INTERRUPT 0
DECL|macro|DEBUG_QUEUE
mdefine_line|#define DEBUG_QUEUE     0
DECL|macro|DEBUG_STATE
mdefine_line|#define DEBUG_STATE     0
DECL|macro|INT_DISC
mdefine_line|#define INT_DISC&t;0
macro_line|#ifndef CVT_LINUX_VERSION
DECL|macro|CVT_LINUX_VERSION
mdefine_line|#define&t;CVT_LINUX_VERSION(V,P,S)&t;(V * 65536 + P * 256 + S)
macro_line|#endif
macro_line|#ifndef LINUX_VERSION_CODE
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;i91uscsi.h&quot;
multiline_comment|/*--- external functions --*/
r_static
r_void
id|tul_se2_wait
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*--- forward refrence ---*/
r_static
id|SCB
op_star
id|tul_find_busy_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|WORD
id|tarlun
)paren
suffix:semicolon
r_static
id|SCB
op_star
id|tul_find_done_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tulip_main
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_next_state
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_1
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_2
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_3
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_4
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_5
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_6
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_state_7
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_xfer_data_in
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_xfer_data_out
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_xpad_in
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_xpad_out
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_status_msg
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgin
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgin_sync
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgin_accept
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgout_reject
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgin_extend
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgout_ide
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgout_abort_targ
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_msgout_abort_tag
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_bus_device_reset
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_void
id|tul_select_atn
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
suffix:semicolon
r_static
r_void
id|tul_select_atn3
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
suffix:semicolon
r_static
r_void
id|tul_select_atn_stop
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
suffix:semicolon
r_static
r_int
id|int_tul_busfree
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_int
id|int_tul_scsi_rst
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|int_tul_bad_seq
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|int_tul_resel
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_sync_done
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|wdtr_done
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|wait_tulip
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_wait_done_disc
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_wait_disc
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_void
id|tulip_scsi
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_int
id|tul_post_scsi_rst
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
suffix:semicolon
r_static
r_void
id|tul_se2_ew_en
c_func
(paren
id|WORD
id|CurBase
)paren
suffix:semicolon
r_static
r_void
id|tul_se2_ew_ds
c_func
(paren
id|WORD
id|CurBase
)paren
suffix:semicolon
r_static
r_int
id|tul_se2_rd_all
c_func
(paren
id|WORD
id|CurBase
)paren
suffix:semicolon
r_static
r_void
id|tul_se2_update_all
c_func
(paren
id|WORD
id|CurBase
)paren
suffix:semicolon
multiline_comment|/* setup default pattern */
r_static
r_void
id|tul_read_eeprom
c_func
(paren
id|WORD
id|CurBase
)paren
suffix:semicolon
multiline_comment|/* ---- EXTERNAL VARIABLES ---- */
DECL|variable|tul_hcs
id|HCS
id|tul_hcs
(braket
id|MAX_SUPPORTED_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/* ---- INTERNAL VARIABLES ---- */
DECL|variable|i91u_adpt
r_static
id|INI_ADPT_STRUCT
id|i91u_adpt
(braket
id|MAX_SUPPORTED_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/*NVRAM nvram, *nvramp = &amp;nvram; */
DECL|variable|i91unvram
r_static
id|NVRAM
id|i91unvram
suffix:semicolon
DECL|variable|i91unvramp
r_static
id|NVRAM
op_star
id|i91unvramp
suffix:semicolon
DECL|variable|i91udftNvRam
r_static
id|UCHAR
id|i91udftNvRam
(braket
l_int|64
)braket
op_assign
(brace
multiline_comment|/*----------- header -----------*/
l_int|0x25
comma
l_int|0xc9
comma
multiline_comment|/* Signature    */
l_int|0x40
comma
multiline_comment|/* Size         */
l_int|0x01
comma
multiline_comment|/* Revision     */
multiline_comment|/* -- Host Adapter Structure -- */
l_int|0x95
comma
multiline_comment|/* ModelByte0   */
l_int|0x00
comma
multiline_comment|/* ModelByte1   */
l_int|0x00
comma
multiline_comment|/* ModelInfo    */
l_int|0x01
comma
multiline_comment|/* NumOfCh      */
id|NBC1_DEFAULT
comma
multiline_comment|/* BIOSConfig1  */
l_int|0
comma
multiline_comment|/* BIOSConfig2  */
l_int|0
comma
multiline_comment|/* HAConfig1    */
l_int|0
comma
multiline_comment|/* HAConfig2    */
multiline_comment|/* SCSI channel 0 and target Structure  */
l_int|7
comma
multiline_comment|/* SCSIid       */
id|NCC1_DEFAULT
comma
multiline_comment|/* SCSIconfig1  */
l_int|0
comma
multiline_comment|/* SCSIconfig2  */
l_int|0x10
comma
multiline_comment|/* NumSCSItarget */
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
multiline_comment|/* SCSI channel 1 and target Structure  */
l_int|7
comma
multiline_comment|/* SCSIid       */
id|NCC1_DEFAULT
comma
multiline_comment|/* SCSIconfig1  */
l_int|0
comma
multiline_comment|/* SCSIconfig2  */
l_int|0x10
comma
multiline_comment|/* NumSCSItarget */
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
id|NTC_DEFAULT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*      - CheckSum -            */
DECL|variable|tul_rate_tbl
r_static
id|UCHAR
id|tul_rate_tbl
(braket
l_int|8
)braket
op_assign
multiline_comment|/* fast 20      */
(brace
multiline_comment|/* nanosecond devide by 4 */
l_int|12
comma
multiline_comment|/* 50ns,  20M   */
l_int|18
comma
multiline_comment|/* 75ns,  13.3M */
l_int|25
comma
multiline_comment|/* 100ns, 10M   */
l_int|31
comma
multiline_comment|/* 125ns, 8M    */
l_int|37
comma
multiline_comment|/* 150ns, 6.6M  */
l_int|43
comma
multiline_comment|/* 175ns, 5.7M  */
l_int|50
comma
multiline_comment|/* 200ns, 5M    */
l_int|62
multiline_comment|/* 250ns, 4M    */
)brace
suffix:semicolon
r_extern
r_int
id|tul_num_ch
suffix:semicolon
DECL|function|tul_do_pause
r_static
r_void
id|tul_do_pause
c_func
(paren
r_int
id|amount
)paren
(brace
multiline_comment|/* Pause for amount jiffies */
r_int
r_int
id|the_time
op_assign
id|jiffies
op_plus
id|amount
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|the_time
)paren
)paren
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
id|jiffies
OL
id|the_time
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*-- forward reference --*/
multiline_comment|/*******************************************************************&n;&t;Use memeory refresh time        ~ 15us * 2&n;********************************************************************/
DECL|function|tul_se2_wait
r_void
id|tul_se2_wait
c_func
(paren
)paren
(brace
macro_line|#if 1
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
macro_line|#else
id|UCHAR
id|readByte
suffix:semicolon
id|readByte
op_assign
id|TUL_RD
c_func
(paren
l_int|0
comma
l_int|0x61
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readByte
op_amp
l_int|0x10
)paren
op_eq
l_int|0x10
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|readByte
op_assign
id|TUL_RD
c_func
(paren
l_int|0
comma
l_int|0x61
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readByte
op_amp
l_int|0x10
)paren
op_eq
l_int|0x10
)paren
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|readByte
op_assign
id|TUL_RD
c_func
(paren
l_int|0
comma
l_int|0x61
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readByte
op_amp
l_int|0x10
)paren
op_ne
l_int|0x10
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|readByte
op_assign
id|TUL_RD
c_func
(paren
l_int|0
comma
l_int|0x61
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readByte
op_amp
l_int|0x10
)paren
op_eq
l_int|0x10
)paren
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|readByte
op_assign
id|TUL_RD
c_func
(paren
l_int|0
comma
l_int|0x61
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readByte
op_amp
l_int|0x10
)paren
op_ne
l_int|0x10
)paren
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
multiline_comment|/******************************************************************&n; Input: instruction for  Serial E2PROM&n;&n; EX: se2_rd(0 call se2_instr() to send address and read command&n;&n;&t; StartBit  OP_Code   Address                Data&n;&t; --------- --------  ------------------     -------&n;&t; 1         1 , 0     A5,A4,A3,A2,A1,A0      D15-D0&n;&n;&t;&t; +-----------------------------------------------------&n;&t;&t; |&n; CS -----+&n;&t;&t;&t;+--+  +--+  +--+  +--+  +--+&n;&t;&t;&t;^  |  ^  |  ^  |  ^  |  ^  |&n;&t;&t;&t;|  |  |  |  |  |  |  |  |  |&n; CLK -------+  +--+  +--+  +--+  +--+  +--&n; (leading edge trigger)&n;&n;&t;&t; +--1-----1--+&n;&t;&t; | SB    OP  |  OP    A5    A4&n; DI  ----+           +--0------------------&n; (address and cmd sent to nvram)&n;&n;&t; -------------------------------------------+&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;|&n; DO                                             +---&n; (data sent from nvram)&n;&n;&n;******************************************************************/
DECL|function|tul_se2_instr
r_void
id|tul_se2_instr
c_func
(paren
id|WORD
id|CurBase
comma
id|UCHAR
id|instr
)paren
(brace
r_int
id|i
suffix:semicolon
id|UCHAR
id|b
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
op_or
id|SE2DO
)paren
suffix:semicolon
multiline_comment|/* cs+start bit */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
op_or
id|SE2CLK
op_or
id|SE2DO
)paren
suffix:semicolon
multiline_comment|/* +CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|instr
op_amp
l_int|0x80
)paren
id|b
op_assign
id|SE2CS
op_or
id|SE2DO
suffix:semicolon
multiline_comment|/* -CLK+dataBit */
r_else
id|b
op_assign
id|SE2CS
suffix:semicolon
multiline_comment|/* -CLK */
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|b
)paren
suffix:semicolon
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|b
op_or
id|SE2CLK
)paren
suffix:semicolon
multiline_comment|/* +CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|instr
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
)paren
suffix:semicolon
multiline_comment|/* -CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; Function name  : tul_se2_ew_en&n; Description    : Enable erase/write state of serial EEPROM&n;******************************************************************/
DECL|function|tul_se2_ew_en
r_void
id|tul_se2_ew_en
c_func
(paren
id|WORD
id|CurBase
)paren
(brace
id|tul_se2_instr
c_func
(paren
id|CurBase
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* EWEN */
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* -CS  */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; Disable erase/write state of serial EEPROM&n;*************************************************************************/
DECL|function|tul_se2_ew_ds
r_void
id|tul_se2_ew_ds
c_func
(paren
id|WORD
id|CurBase
)paren
(brace
id|tul_se2_instr
c_func
(paren
id|CurBase
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* EWDS */
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* -CS  */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n;&t;Input  :address of Serial E2PROM&n;&t;Output :value stored in  Serial E2PROM&n;*******************************************************************/
DECL|function|tul_se2_rd
id|USHORT
id|tul_se2_rd
c_func
(paren
id|WORD
id|CurBase
comma
id|ULONG
id|adr
)paren
(brace
id|UCHAR
id|instr
comma
id|readByte
suffix:semicolon
id|USHORT
id|readWord
suffix:semicolon
r_int
id|i
suffix:semicolon
id|instr
op_assign
(paren
id|UCHAR
)paren
(paren
id|adr
op_or
l_int|0x80
)paren
suffix:semicolon
id|tul_se2_instr
c_func
(paren
id|CurBase
comma
id|instr
)paren
suffix:semicolon
multiline_comment|/* READ INSTR */
id|readWord
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
op_or
id|SE2CLK
)paren
suffix:semicolon
multiline_comment|/* +CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
)paren
suffix:semicolon
multiline_comment|/* -CLK */
multiline_comment|/* sample data after the following edge of clock  */
id|readByte
op_assign
id|TUL_RD
c_func
(paren
id|CurBase
comma
id|TUL_NVRAM
)paren
suffix:semicolon
id|readByte
op_and_assign
id|SE2DI
suffix:semicolon
id|readWord
op_add_assign
(paren
id|readByte
op_lshift
id|i
)paren
suffix:semicolon
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* 6/20/95 */
)brace
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no chip select */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_return
id|readWord
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; Input: new value in  Serial E2PROM, address of Serial E2PROM&n;*******************************************************************/
DECL|function|tul_se2_wr
r_void
id|tul_se2_wr
c_func
(paren
id|WORD
id|CurBase
comma
id|UCHAR
id|adr
comma
id|USHORT
id|writeWord
)paren
(brace
id|UCHAR
id|readByte
suffix:semicolon
id|UCHAR
id|instr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|instr
op_assign
(paren
id|UCHAR
)paren
(paren
id|adr
op_or
l_int|0x40
)paren
suffix:semicolon
id|tul_se2_instr
c_func
(paren
id|CurBase
comma
id|instr
)paren
suffix:semicolon
multiline_comment|/* WRITE INSTR */
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|writeWord
op_amp
l_int|0x8000
)paren
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
op_or
id|SE2DO
)paren
suffix:semicolon
multiline_comment|/* -CLK+dataBit 1 */
r_else
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
)paren
suffix:semicolon
multiline_comment|/* -CLK+dataBit 0 */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
op_or
id|SE2CLK
)paren
suffix:semicolon
multiline_comment|/* +CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|writeWord
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
)paren
suffix:semicolon
multiline_comment|/* -CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* -CS  */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
)paren
suffix:semicolon
multiline_comment|/* +CS  */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
op_or
id|SE2CLK
)paren
suffix:semicolon
multiline_comment|/* +CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
id|SE2CS
)paren
suffix:semicolon
multiline_comment|/* -CLK */
id|tul_se2_wait
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readByte
op_assign
id|TUL_RD
c_func
(paren
id|CurBase
comma
id|TUL_NVRAM
)paren
)paren
op_amp
id|SE2DI
)paren
r_break
suffix:semicolon
multiline_comment|/* write complete */
)brace
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_NVRAM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* -CS */
r_return
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; Read SCSI H/A configuration parameters from serial EEPROM&n;************************************************************************/
DECL|function|tul_se2_rd_all
r_int
id|tul_se2_rd_all
c_func
(paren
id|WORD
id|CurBase
)paren
(brace
r_int
id|i
suffix:semicolon
id|ULONG
id|chksum
op_assign
l_int|0
suffix:semicolon
id|USHORT
op_star
id|np
suffix:semicolon
id|i91unvramp
op_assign
op_amp
id|i91unvram
suffix:semicolon
id|np
op_assign
(paren
id|USHORT
op_star
)paren
id|i91unvramp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|np
op_increment
op_assign
id|tul_se2_rd
c_func
(paren
id|CurBase
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*--------------------Is signature &quot;ini&quot; ok ? ----------------*/
r_if
c_cond
(paren
id|i91unvramp-&gt;NVM_Signature
op_ne
id|INI_SIGNATURE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*---------------------- Is ckecksum ok ? ----------------------*/
id|np
op_assign
(paren
id|USHORT
op_star
)paren
id|i91unvramp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|31
suffix:semicolon
id|i
op_increment
)paren
id|chksum
op_add_assign
op_star
id|np
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i91unvramp-&gt;NVM_CheckSum
op_ne
(paren
id|USHORT
)paren
id|chksum
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; Update SCSI H/A configuration parameters from serial EEPROM&n;************************************************************************/
DECL|function|tul_se2_update_all
r_void
id|tul_se2_update_all
c_func
(paren
id|WORD
id|CurBase
)paren
(brace
multiline_comment|/* setup default pattern */
r_int
id|i
suffix:semicolon
id|ULONG
id|chksum
op_assign
l_int|0
suffix:semicolon
id|USHORT
op_star
id|np
comma
op_star
id|np1
suffix:semicolon
id|i91unvramp
op_assign
op_amp
id|i91unvram
suffix:semicolon
multiline_comment|/* Calculate checksum first */
id|np
op_assign
(paren
id|USHORT
op_star
)paren
id|i91udftNvRam
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|31
suffix:semicolon
id|i
op_increment
)paren
id|chksum
op_add_assign
op_star
id|np
op_increment
suffix:semicolon
op_star
id|np
op_assign
(paren
id|USHORT
)paren
id|chksum
suffix:semicolon
id|tul_se2_ew_en
c_func
(paren
id|CurBase
)paren
suffix:semicolon
multiline_comment|/* Enable write  */
id|np
op_assign
(paren
id|USHORT
op_star
)paren
id|i91udftNvRam
suffix:semicolon
id|np1
op_assign
(paren
id|USHORT
op_star
)paren
id|i91unvramp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
comma
id|np
op_increment
comma
id|np1
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|np
op_ne
op_star
id|np1
)paren
(brace
id|tul_se2_wr
c_func
(paren
id|CurBase
comma
id|i
comma
op_star
id|np
)paren
suffix:semicolon
)brace
)brace
id|tul_se2_ew_ds
c_func
(paren
id|CurBase
)paren
suffix:semicolon
multiline_comment|/* Disable write   */
r_return
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n; Function name  : read_eeprom&n;**************************************************************************/
DECL|function|tul_read_eeprom
r_void
id|tul_read_eeprom
c_func
(paren
id|WORD
id|CurBase
)paren
(brace
id|UCHAR
id|gctrl
suffix:semicolon
id|i91unvramp
op_assign
op_amp
id|i91unvram
suffix:semicolon
multiline_comment|/*------Enable EEProm programming ---*/
id|gctrl
op_assign
id|TUL_RD
c_func
(paren
id|CurBase
comma
id|TUL_GCTRL
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_GCTRL
comma
id|gctrl
op_or
id|TUL_GCTRL_EEPROM_BIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tul_se2_rd_all
c_func
(paren
id|CurBase
)paren
op_ne
l_int|1
)paren
(brace
id|tul_se2_update_all
c_func
(paren
id|CurBase
)paren
suffix:semicolon
multiline_comment|/* setup default pattern */
id|tul_se2_rd_all
c_func
(paren
id|CurBase
)paren
suffix:semicolon
multiline_comment|/* load again  */
)brace
multiline_comment|/*------ Disable EEProm programming ---*/
id|gctrl
op_assign
id|TUL_RD
c_func
(paren
id|CurBase
comma
id|TUL_GCTRL
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|CurBase
op_plus
id|TUL_GCTRL
comma
id|gctrl
op_amp
op_complement
id|TUL_GCTRL_EEPROM_BIT
)paren
suffix:semicolon
)brace
multiline_comment|/* read_eeprom */
DECL|function|Addi91u_into_Adapter_table
r_int
id|Addi91u_into_Adapter_table
c_func
(paren
id|WORD
id|wBIOS
comma
id|WORD
id|wBASE
comma
id|BYTE
id|bInterrupt
comma
id|BYTE
id|bBus
comma
id|BYTE
id|bDevice
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SUPPORTED_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
OL
id|wBIOS
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
op_eq
id|wBIOS
)paren
(brace
r_if
c_cond
(paren
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
op_eq
id|wBASE
)paren
(brace
r_if
c_cond
(paren
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_Bus
op_ne
l_int|0xFF
)paren
r_return
(paren
id|FAILURE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
OL
id|wBASE
)paren
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
id|MAX_SUPPORTED_ADAPTERS
op_minus
l_int|1
suffix:semicolon
id|j
OG
id|i
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|i91u_adpt
(braket
id|j
)braket
dot
id|ADPT_BASE
op_assign
id|i91u_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_BASE
suffix:semicolon
id|i91u_adpt
(braket
id|j
)braket
dot
id|ADPT_INTR
op_assign
id|i91u_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_INTR
suffix:semicolon
id|i91u_adpt
(braket
id|j
)braket
dot
id|ADPT_BIOS
op_assign
id|i91u_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_BIOS
suffix:semicolon
id|i91u_adpt
(braket
id|j
)braket
dot
id|ADPT_Bus
op_assign
id|i91u_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_Bus
suffix:semicolon
id|i91u_adpt
(braket
id|j
)braket
dot
id|ADPT_Device
op_assign
id|i91u_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_Device
suffix:semicolon
)brace
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
op_assign
id|wBASE
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_INTR
op_assign
id|bInterrupt
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
op_assign
id|wBIOS
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_Bus
op_assign
id|bBus
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_Device
op_assign
id|bDevice
suffix:semicolon
r_return
(paren
id|SUCCESSFUL
)paren
suffix:semicolon
)brace
r_return
(paren
id|FAILURE
)paren
suffix:semicolon
)brace
DECL|function|init_i91uAdapter_table
r_void
id|init_i91uAdapter_table
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SUPPORTED_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Initialize adapter structure */
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
op_assign
l_int|0xffff
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
op_assign
l_int|0xffff
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_INTR
op_assign
l_int|0xff
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_Bus
op_assign
l_int|0xff
suffix:semicolon
id|i91u_adpt
(braket
id|i
)braket
dot
id|ADPT_Device
op_assign
l_int|0xff
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|tul_stop_bm
r_void
id|tul_stop_bm
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XStatus
)paren
op_amp
id|XPEND
)paren
(brace
multiline_comment|/* if DMA xfer is pending, abort DMA xfer */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_X_ABT
op_or
id|TAX_X_CLR_FIFO
)paren
suffix:semicolon
multiline_comment|/* wait Abort DMA xfer done */
r_while
c_loop
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_Int
)paren
op_amp
id|XABT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|get_tulipPCIConfig
r_void
id|get_tulipPCIConfig
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
r_int
id|ch_idx
)paren
(brace
id|pCurHcb-&gt;HCS_Base
op_assign
id|i91u_adpt
(braket
id|ch_idx
)braket
dot
id|ADPT_BASE
suffix:semicolon
multiline_comment|/* Supply base address  */
id|pCurHcb-&gt;HCS_BIOS
op_assign
id|i91u_adpt
(braket
id|ch_idx
)braket
dot
id|ADPT_BIOS
suffix:semicolon
multiline_comment|/* Supply BIOS address  */
id|pCurHcb-&gt;HCS_Intr
op_assign
id|i91u_adpt
(braket
id|ch_idx
)braket
dot
id|ADPT_INTR
suffix:semicolon
multiline_comment|/* Supply interrupt line */
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_reset_scsi
r_int
id|tul_reset_scsi
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
r_int
id|seconds
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_RST_BUS
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|pCurHcb-&gt;HCS_JSInt
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SInt
)paren
)paren
op_amp
id|TSS_SCSIRST_INT
)paren
)paren
suffix:semicolon
multiline_comment|/* reset tulip chip */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Stall for a while, wait for target&squot;s firmware ready,make it 2 sec ! */
multiline_comment|/* SONY 5200 tape drive won&squot;t work if only stall for 1 sec */
id|tul_do_pause
c_func
(paren
id|seconds
op_star
id|HZ
)paren
suffix:semicolon
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SInt
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|init_tulip
r_int
id|init_tulip
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|scbp
comma
r_int
id|tul_num_scb
comma
id|BYTE
op_star
id|pbBiosAdr
comma
r_int
id|seconds
)paren
(brace
r_int
id|i
suffix:semicolon
id|WORD
op_star
id|pwFlags
suffix:semicolon
id|BYTE
op_star
id|pbHeads
suffix:semicolon
id|SCB
op_star
id|pTmpScb
comma
op_star
id|pPrevScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_NumScbs
op_assign
id|tul_num_scb
suffix:semicolon
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|pCurHcb-&gt;HCS_SemaphLock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_JSStatus0
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_Scb
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_NxtPend
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_NxtAvail
op_assign
id|scbp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|pTmpScb
op_assign
id|scbp
suffix:semicolon
id|i
OL
id|tul_num_scb
suffix:semicolon
id|i
op_increment
comma
id|pTmpScb
op_increment
)paren
(brace
id|pTmpScb-&gt;SCB_TagId
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
id|pPrevScb-&gt;SCB_NxtScb
op_assign
id|pTmpScb
suffix:semicolon
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
)brace
id|pPrevScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ScbEnd
op_assign
id|pTmpScb
suffix:semicolon
id|pCurHcb-&gt;HCS_FirstAvail
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastAvail
op_assign
id|pPrevScb
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|pCurHcb-&gt;HCS_AvailLock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_FirstPend
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_LastPend
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_FirstBusy
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_LastBusy
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_FirstDone
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_LastDone
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
l_int|NULL
suffix:semicolon
id|tul_read_eeprom
c_func
(paren
id|pCurHcb-&gt;HCS_Base
)paren
suffix:semicolon
multiline_comment|/*---------- get H/A configuration -------------*/
r_if
c_cond
(paren
id|i91unvramp-&gt;NVM_SCSIInfo
(braket
l_int|0
)braket
dot
id|NVM_NumOfTarg
op_eq
l_int|8
)paren
id|pCurHcb-&gt;HCS_MaxTar
op_assign
l_int|8
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_MaxTar
op_assign
l_int|16
suffix:semicolon
id|pCurHcb-&gt;HCS_Config
op_assign
id|i91unvramp-&gt;NVM_SCSIInfo
(braket
l_int|0
)braket
dot
id|NVM_ChConfig1
suffix:semicolon
id|pCurHcb-&gt;HCS_SCSI_ID
op_assign
id|i91unvramp-&gt;NVM_SCSIInfo
(braket
l_int|0
)braket
dot
id|NVM_ChSCSIID
suffix:semicolon
id|pCurHcb-&gt;HCS_IdMask
op_assign
op_complement
(paren
l_int|1
op_lshift
id|pCurHcb-&gt;HCS_SCSI_ID
)paren
suffix:semicolon
macro_line|#if CHK_PARITY
multiline_comment|/* Enable parity error response */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_PCMD
comma
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_PCMD
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Mask all the interrupt       */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
id|tul_stop_bm
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
multiline_comment|/* --- Initialize the tulip --- */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_RST_CHIP
)paren
suffix:semicolon
multiline_comment|/* program HBA&squot;s SCSI ID        */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SScsiId
comma
id|pCurHcb-&gt;HCS_SCSI_ID
op_lshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Enable Initiator Mode ,phase latch,alternate sync period mode,&n;&t;   disable SCSI reset */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Config
op_amp
id|HCC_EN_PAR
)paren
id|pCurHcb-&gt;HCS_SConf1
op_assign
(paren
id|TSC_INITDEFAULT
op_or
id|TSC_EN_SCSI_PAR
)paren
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_SConf1
op_assign
(paren
id|TSC_INITDEFAULT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|pCurHcb-&gt;HCS_SConf1
)paren
suffix:semicolon
multiline_comment|/* Enable HW reselect           */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SPeriod
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* selection time out = 250 ms */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_STimeOut
comma
l_int|153
)paren
suffix:semicolon
multiline_comment|/*--------- Enable SCSI terminator -----*/
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCtrl
comma
(paren
id|pCurHcb-&gt;HCS_Config
op_amp
(paren
id|HCC_ACT_TERM1
op_or
id|HCC_ACT_TERM2
)paren
)paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_GCTRL1
comma
(paren
(paren
id|pCurHcb-&gt;HCS_Config
op_amp
id|HCC_AUTO_TERM
)paren
op_rshift
l_int|4
)paren
op_or
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_GCTRL1
)paren
op_amp
l_int|0xFE
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|pwFlags
op_assign
(paren
id|WORD
op_star
)paren
op_amp
(paren
id|i91unvramp-&gt;NVM_SCSIInfo
(braket
l_int|0
)braket
dot
id|NVM_Targ0Config
)paren
comma
id|pbHeads
op_assign
id|pbBiosAdr
op_plus
l_int|0x180
suffix:semicolon
id|i
OL
id|pCurHcb-&gt;HCS_MaxTar
suffix:semicolon
id|i
op_increment
comma
id|pwFlags
op_increment
)paren
(brace
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_Flags
op_assign
op_star
id|pwFlags
op_amp
op_complement
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_WDTR_DONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_Flags
op_amp
id|TCF_EN_255
)paren
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvFlags
op_assign
id|TCF_DRV_255_63
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvFlags
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_JS_Period
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_SConfig0
op_assign
id|pCurHcb-&gt;HCS_SConf1
suffix:semicolon
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvHead
op_assign
op_star
id|pbHeads
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvHead
op_eq
l_int|255
)paren
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvFlags
op_assign
id|TCF_DRV_255_63
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvFlags
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_DrvSector
op_assign
op_star
id|pbHeads
op_increment
suffix:semicolon
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_Flags
op_and_assign
op_complement
id|TCF_BUSY
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTags
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_MaxTags
(braket
id|i
)braket
op_assign
l_int|0xFF
suffix:semicolon
)brace
multiline_comment|/* for                          */
id|printk
c_func
(paren
l_string|&quot;i91u: PCI Base=0x%04X, IRQ=%d, BIOS=0x%04X0, SCSI ID=%d&bslash;n&quot;
comma
id|pCurHcb-&gt;HCS_Base
comma
id|pCurHcb-&gt;HCS_Intr
comma
id|pCurHcb-&gt;HCS_BIOS
comma
id|pCurHcb-&gt;HCS_SCSI_ID
)paren
suffix:semicolon
multiline_comment|/*------------------- reset SCSI Bus ---------------------------*/
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Config
op_amp
id|HCC_SCSI_RESET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i91u: Reset SCSI Bus ... &bslash;n&quot;
)paren
suffix:semicolon
id|tul_reset_scsi
c_func
(paren
id|pCurHcb
comma
id|seconds
)paren
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCFG1
comma
l_int|0x17
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SIntEnable
comma
l_int|0xE9
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_alloc_scb
id|SCB
op_star
id|tul_alloc_scb
c_func
(paren
id|HCS
op_star
id|hcsp
)paren
(brace
id|SCB
op_star
id|pTmpScb
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|hcsp-&gt;HCS_AvailLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pTmpScb
op_assign
id|hcsp-&gt;HCS_FirstAvail
)paren
op_ne
l_int|NULL
)paren
(brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;find scb at %08lx&bslash;n&quot;
comma
(paren
id|ULONG
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|hcsp-&gt;HCS_FirstAvail
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|hcsp-&gt;HCS_LastAvail
op_assign
l_int|NULL
suffix:semicolon
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
id|pTmpScb-&gt;SCB_Status
op_assign
id|SCB_RENT
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;HCS_AvailLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pTmpScb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_release_scb
r_void
id|tul_release_scb
c_func
(paren
id|HCS
op_star
id|hcsp
comma
id|SCB
op_star
id|scbp
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;Release SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|scbp
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|hcsp-&gt;HCS_AvailLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|scbp-&gt;SCB_Srb
op_assign
l_int|0
suffix:semicolon
id|scbp-&gt;SCB_Status
op_assign
l_int|0
suffix:semicolon
id|scbp-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|hcsp-&gt;HCS_LastAvail
op_ne
l_int|NULL
)paren
(brace
id|hcsp-&gt;HCS_LastAvail-&gt;SCB_NxtScb
op_assign
id|scbp
suffix:semicolon
id|hcsp-&gt;HCS_LastAvail
op_assign
id|scbp
suffix:semicolon
)brace
r_else
(brace
id|hcsp-&gt;HCS_FirstAvail
op_assign
id|scbp
suffix:semicolon
id|hcsp-&gt;HCS_LastAvail
op_assign
id|scbp
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;HCS_AvailLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_append_pend_scb
r_void
id|tul_append_pend_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|scbp
)paren
(brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;Append pend SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|scbp
)paren
suffix:semicolon
macro_line|#endif
id|scbp-&gt;SCB_Status
op_assign
id|SCB_PEND
suffix:semicolon
id|scbp-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_LastPend
op_ne
l_int|NULL
)paren
(brace
id|pCurHcb-&gt;HCS_LastPend-&gt;SCB_NxtScb
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastPend
op_assign
id|scbp
suffix:semicolon
)brace
r_else
(brace
id|pCurHcb-&gt;HCS_FirstPend
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastPend
op_assign
id|scbp
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_push_pend_scb
r_void
id|tul_push_pend_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|scbp
)paren
(brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;Push pend SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|scbp
)paren
suffix:semicolon
macro_line|#endif
id|scbp-&gt;SCB_Status
op_assign
id|SCB_PEND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scbp-&gt;SCB_NxtScb
op_assign
id|pCurHcb-&gt;HCS_FirstPend
)paren
op_ne
l_int|NULL
)paren
(brace
id|pCurHcb-&gt;HCS_FirstPend
op_assign
id|scbp
suffix:semicolon
)brace
r_else
(brace
id|pCurHcb-&gt;HCS_FirstPend
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastPend
op_assign
id|scbp
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_find_first_pend_scb
id|SCB
op_star
id|tul_find_first_pend_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pFirstPend
suffix:semicolon
id|pFirstPend
op_assign
id|pCurHcb-&gt;HCS_FirstPend
suffix:semicolon
r_while
c_loop
(paren
id|pFirstPend
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pFirstPend-&gt;SCB_Opcode
op_ne
id|ExecSCSI
)paren
(brace
r_return
(paren
id|pFirstPend
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pFirstPend-&gt;SCB_TagMsg
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_ActTags
(braket
id|pFirstPend-&gt;SCB_Target
)braket
op_eq
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pFirstPend-&gt;SCB_Target
)braket
dot
id|TCS_Flags
op_amp
id|TCF_BUSY
)paren
)paren
(brace
r_return
(paren
id|pFirstPend
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_ActTags
(braket
id|pFirstPend-&gt;SCB_Target
)braket
op_ge
id|pCurHcb-&gt;HCS_MaxTags
(braket
id|pFirstPend-&gt;SCB_Target
)braket
)paren
op_or
(paren
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pFirstPend-&gt;SCB_Target
)braket
dot
id|TCS_Flags
op_amp
id|TCF_BUSY
)paren
)paren
(brace
id|pFirstPend
op_assign
id|pFirstPend-&gt;SCB_NxtScb
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
(paren
id|pFirstPend
)paren
suffix:semicolon
)brace
id|pFirstPend
op_assign
id|pFirstPend-&gt;SCB_NxtScb
suffix:semicolon
)brace
r_return
(paren
id|pFirstPend
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_pop_pend_scb
id|SCB
op_star
id|tul_pop_pend_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pTmpScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstPend
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstPend
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastPend
op_assign
l_int|NULL
suffix:semicolon
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;Pop pend SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pTmpScb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_unlink_pend_scb
r_void
id|tul_unlink_pend_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
(brace
id|SCB
op_star
id|pTmpScb
comma
op_star
id|pPrevScb
suffix:semicolon
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;unlink pend SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|pCurScb
)paren
suffix:semicolon
macro_line|#endif
id|pPrevScb
op_assign
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstPend
suffix:semicolon
r_while
c_loop
(paren
id|pTmpScb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pCurScb
op_eq
id|pTmpScb
)paren
(brace
multiline_comment|/* Unlink this SCB              */
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_FirstPend
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstPend
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastPend
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pPrevScb-&gt;SCB_NxtScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_LastPend
)paren
id|pCurHcb-&gt;HCS_LastPend
op_assign
id|pPrevScb
suffix:semicolon
)brace
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
id|pTmpScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_append_busy_scb
r_void
id|tul_append_busy_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|scbp
)paren
(brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;append busy SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|scbp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scbp-&gt;SCB_TagMsg
)paren
id|pCurHcb-&gt;HCS_ActTags
(braket
id|scbp-&gt;SCB_Target
)braket
op_increment
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_Tcs
(braket
id|scbp-&gt;SCB_Target
)braket
dot
id|TCS_Flags
op_or_assign
id|TCF_BUSY
suffix:semicolon
id|scbp-&gt;SCB_Status
op_assign
id|SCB_BUSY
suffix:semicolon
id|scbp-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_LastBusy
op_ne
l_int|NULL
)paren
(brace
id|pCurHcb-&gt;HCS_LastBusy-&gt;SCB_NxtScb
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastBusy
op_assign
id|scbp
suffix:semicolon
)brace
r_else
(brace
id|pCurHcb-&gt;HCS_FirstBusy
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastBusy
op_assign
id|scbp
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_pop_busy_scb
id|SCB
op_star
id|tul_pop_busy_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pTmpScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstBusy
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstBusy
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
l_int|NULL
suffix:semicolon
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_TagMsg
)paren
id|pCurHcb-&gt;HCS_ActTags
(braket
id|pTmpScb-&gt;SCB_Target
)braket
op_decrement
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pTmpScb-&gt;SCB_Target
)braket
dot
id|TCS_Flags
op_and_assign
op_complement
id|TCF_BUSY
suffix:semicolon
)brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;Pop busy SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pTmpScb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_unlink_busy_scb
r_void
id|tul_unlink_busy_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
(brace
id|SCB
op_star
id|pTmpScb
comma
op_star
id|pPrevScb
suffix:semicolon
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;unlink busy SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|pCurScb
)paren
suffix:semicolon
macro_line|#endif
id|pPrevScb
op_assign
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstBusy
suffix:semicolon
r_while
c_loop
(paren
id|pTmpScb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pCurScb
op_eq
id|pTmpScb
)paren
(brace
multiline_comment|/* Unlink this SCB              */
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_FirstBusy
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstBusy
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pPrevScb-&gt;SCB_NxtScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_LastBusy
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
id|pPrevScb
suffix:semicolon
)brace
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_TagMsg
)paren
id|pCurHcb-&gt;HCS_ActTags
(braket
id|pTmpScb-&gt;SCB_Target
)braket
op_decrement
suffix:semicolon
r_else
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pTmpScb-&gt;SCB_Target
)braket
dot
id|TCS_Flags
op_and_assign
op_complement
id|TCF_BUSY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
id|pTmpScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_find_busy_scb
id|SCB
op_star
id|tul_find_busy_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|WORD
id|tarlun
)paren
(brace
id|SCB
op_star
id|pTmpScb
comma
op_star
id|pPrevScb
suffix:semicolon
id|WORD
id|scbp_tarlun
suffix:semicolon
id|pPrevScb
op_assign
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstBusy
suffix:semicolon
r_while
c_loop
(paren
id|pTmpScb
op_ne
l_int|NULL
)paren
(brace
id|scbp_tarlun
op_assign
(paren
id|pTmpScb-&gt;SCB_Lun
op_lshift
l_int|8
)paren
op_or
(paren
id|pTmpScb-&gt;SCB_Target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scbp_tarlun
op_eq
id|tarlun
)paren
(brace
multiline_comment|/* Unlink this SCB              */
r_break
suffix:semicolon
)brace
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
id|pTmpScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;find busy SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pTmpScb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_append_done_scb
r_void
id|tul_append_done_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|scbp
)paren
(brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;append done SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|scbp
)paren
suffix:semicolon
macro_line|#endif
id|scbp-&gt;SCB_Status
op_assign
id|SCB_DONE
suffix:semicolon
id|scbp-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_LastDone
op_ne
l_int|NULL
)paren
(brace
id|pCurHcb-&gt;HCS_LastDone-&gt;SCB_NxtScb
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastDone
op_assign
id|scbp
suffix:semicolon
)brace
r_else
(brace
id|pCurHcb-&gt;HCS_FirstDone
op_assign
id|scbp
suffix:semicolon
id|pCurHcb-&gt;HCS_LastDone
op_assign
id|scbp
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_find_done_scb
id|SCB
op_star
id|tul_find_done_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pTmpScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstDone
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstDone
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastDone
op_assign
l_int|NULL
suffix:semicolon
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#if DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;find done SCB %lx; &quot;
comma
(paren
id|ULONG
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pTmpScb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_abort_srb
r_int
id|tul_abort_srb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|ULONG
id|srbp
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|SCB
op_star
id|pTmpScb
comma
op_star
id|pPrevScb
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_Semaph
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pCurHcb-&gt;HCS_ActScb
op_eq
l_int|NULL
)paren
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* disable Jasmin SCSI Int        */
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|tulip_main
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x0F
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
id|pPrevScb
op_assign
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstPend
suffix:semicolon
multiline_comment|/* Check Pend queue */
r_while
c_loop
(paren
id|pTmpScb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* 07/27/98 */
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_Srb
op_eq
(paren
r_int
r_char
op_star
)paren
id|srbp
)paren
(brace
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_ActScb
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_FirstPend
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstPend
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastPend
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pPrevScb-&gt;SCB_NxtScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_LastPend
)paren
id|pCurHcb-&gt;HCS_LastPend
op_assign
id|pPrevScb
suffix:semicolon
)brace
id|pTmpScb-&gt;SCB_HaStat
op_assign
id|HOST_ABORTED
suffix:semicolon
id|pTmpScb-&gt;SCB_Flags
op_or_assign
id|SCF_DONE
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_Flags
op_amp
id|SCF_POST
)paren
(paren
op_star
id|pTmpScb-&gt;SCB_Post
)paren
(paren
(paren
id|BYTE
op_star
)paren
id|pCurHcb
comma
(paren
id|BYTE
op_star
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
id|pTmpScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
id|pPrevScb
op_assign
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstBusy
suffix:semicolon
multiline_comment|/* Check Busy queue */
r_while
c_loop
(paren
id|pTmpScb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_Srb
op_eq
(paren
r_int
r_char
op_star
)paren
id|srbp
)paren
(brace
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_ActScb
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_TagMsg
op_eq
l_int|0
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
r_else
(brace
id|pCurHcb-&gt;HCS_ActTags
(braket
id|pTmpScb-&gt;SCB_Target
)braket
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_FirstBusy
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstBusy
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pPrevScb-&gt;SCB_NxtScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_LastBusy
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
id|pPrevScb
suffix:semicolon
)brace
id|pTmpScb-&gt;SCB_NxtScb
op_assign
l_int|NULL
suffix:semicolon
id|pTmpScb-&gt;SCB_HaStat
op_assign
id|HOST_ABORTED
suffix:semicolon
id|pTmpScb-&gt;SCB_Flags
op_or_assign
id|SCF_DONE
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_Flags
op_amp
id|SCF_POST
)paren
(paren
op_star
id|pTmpScb-&gt;SCB_Post
)paren
(paren
(paren
id|BYTE
op_star
)paren
id|pCurHcb
comma
(paren
id|BYTE
op_star
)paren
id|pTmpScb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
)brace
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
id|pTmpScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_bad_seq
r_int
id|tul_bad_seq
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tul_bad_seg c=%d&bslash;n&quot;
comma
id|pCurHcb-&gt;HCS_Index
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
)paren
op_ne
l_int|NULL
)paren
(brace
id|tul_unlink_busy_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_BAD_PHAS
suffix:semicolon
id|pCurScb-&gt;SCB_TaStat
op_assign
l_int|0
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
id|tul_stop_bm
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
id|tul_reset_scsi
c_func
(paren
id|pCurHcb
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* 7/29/98 */
r_return
(paren
id|tul_post_scsi_rst
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
DECL|function|tul_device_reset
r_int
id|tul_device_reset
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|ULONG
id|pSrb
comma
r_int
r_int
id|target
comma
r_int
r_int
id|ResetFlags
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|SCB
op_star
id|pScb
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ResetFlags
op_amp
id|SCSI_RESET_ASYNCHRONOUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_Semaph
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pCurHcb-&gt;HCS_ActScb
op_eq
l_int|NULL
)paren
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* disable Jasmin SCSI Int        */
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|tulip_main
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x0F
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_RESET_SNOOZE
suffix:semicolon
)brace
id|pScb
op_assign
id|pCurHcb-&gt;HCS_FirstBusy
suffix:semicolon
multiline_comment|/* Check Busy queue */
r_while
c_loop
(paren
id|pScb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;SCB_Srb
op_eq
(paren
r_int
r_char
op_star
)paren
id|pSrb
)paren
r_break
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to Reset - No SCB Found&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_RESET_NOT_RUNNING
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|tul_alloc_scb
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_RESET_NOT_RUNNING
suffix:semicolon
)brace
id|pScb-&gt;SCB_Opcode
op_assign
id|BusDevRst
suffix:semicolon
id|pScb-&gt;SCB_Flags
op_assign
id|SCF_POST
suffix:semicolon
id|pScb-&gt;SCB_Target
op_assign
id|target
suffix:semicolon
id|pScb-&gt;SCB_Mode
op_assign
l_int|0
suffix:semicolon
id|pScb-&gt;SCB_Srb
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ResetFlags
op_amp
id|SCSI_RESET_SYNCHRONOUS
)paren
(brace
id|pScb-&gt;SCB_Srb
op_assign
(paren
r_int
r_char
op_star
)paren
id|pSrb
suffix:semicolon
)brace
id|tul_push_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pScb
)paren
suffix:semicolon
multiline_comment|/* push this SCB to Pending queue */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Semaph
op_eq
l_int|1
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* disable Jasmin SCSI Int        */
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|tulip_main
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x0F
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
DECL|function|tul_reset_scsi_bus
r_int
id|tul_reset_scsi_bus
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|tul_stop_bm
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
id|tul_reset_scsi
c_func
(paren
id|pCurHcb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 7/29/98 */
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|tul_post_scsi_rst
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|tulip_main
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x0F
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_HOST_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
DECL|function|tul_exec_scb
r_void
id|tul_exec_scb
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|pCurScb-&gt;SCB_Mode
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_SGIdx
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_SGMax
op_assign
id|pCurScb-&gt;SCB_SGLen
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|tul_append_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
multiline_comment|/* Append this SCB to Pending queue */
multiline_comment|/* VVVVV 07/21/98 */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Semaph
op_eq
l_int|1
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* disable Jasmin SCSI Int        */
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|tulip_main
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x0F
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pCurHcb-&gt;HCS_SemaphLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_isr
r_int
id|tul_isr
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
multiline_comment|/* Enter critical section       */
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_Int
)paren
op_amp
id|TSS_INT_PENDING
)paren
(brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Semaph
op_eq
l_int|1
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* Disable Tulip SCSI Int */
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|0
suffix:semicolon
id|tulip_main
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_Semaph
op_assign
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_Mask
comma
l_int|0x0F
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tulip_main
r_int
id|tulip_main
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|tulip_scsi
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
multiline_comment|/* Call tulip_scsi              */
r_while
c_loop
(paren
(paren
id|pCurScb
op_assign
id|tul_find_done_scb
c_func
(paren
id|pCurHcb
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* find done entry */
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_TaStat
op_eq
id|QUEUE_FULL
)paren
(brace
id|pCurHcb-&gt;HCS_MaxTags
(braket
id|pCurScb-&gt;SCB_Target
)braket
op_assign
id|pCurHcb-&gt;HCS_ActTags
(braket
id|pCurScb-&gt;SCB_Target
)braket
op_minus
l_int|1
suffix:semicolon
id|pCurScb-&gt;SCB_TaStat
op_assign
l_int|0
suffix:semicolon
id|tul_append_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pCurScb-&gt;SCB_Mode
op_amp
id|SCM_RSENS
)paren
)paren
(brace
multiline_comment|/* not in auto req. sense mode */
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_TaStat
op_eq
l_int|2
)paren
(brace
multiline_comment|/* clr sync. nego flag */
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_SENSE
)paren
(brace
id|BYTE
id|len
suffix:semicolon
id|len
op_assign
id|pCurScb-&gt;SCB_SenseLen
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
id|len
op_assign
l_int|1
suffix:semicolon
id|pCurScb-&gt;SCB_BufLen
op_assign
id|pCurScb-&gt;SCB_SenseLen
suffix:semicolon
id|pCurScb-&gt;SCB_BufPtr
op_assign
id|pCurScb-&gt;SCB_SensePtr
suffix:semicolon
id|pCurScb-&gt;SCB_Flags
op_and_assign
op_complement
(paren
id|SCF_SG
op_or
id|SCF_DIR
)paren
suffix:semicolon
multiline_comment|/* for xfer_data_in */
multiline_comment|/*                      pCurScb-&gt;SCB_Flags |= SCF_NO_DCHK;      */
multiline_comment|/* so, we won&squot;t report worng direction in xfer_data_in,&n;&t;&t;&t;&t;&t;&t;   and won&squot;t report HOST_DO_DU in state_6 */
id|pCurScb-&gt;SCB_Mode
op_assign
id|SCM_RSENS
suffix:semicolon
id|pCurScb-&gt;SCB_Ident
op_and_assign
l_int|0xBF
suffix:semicolon
multiline_comment|/* Disable Disconnect */
id|pCurScb-&gt;SCB_TagMsg
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_TaStat
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_CDBLen
op_assign
l_int|6
suffix:semicolon
id|pCurScb-&gt;SCB_CDB
(braket
l_int|0
)braket
op_assign
id|SCSICMD_RequestSense
suffix:semicolon
id|pCurScb-&gt;SCB_CDB
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_CDB
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_CDB
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_CDB
(braket
l_int|4
)braket
op_assign
id|len
suffix:semicolon
id|pCurScb-&gt;SCB_CDB
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|tul_push_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* in request sense mode */
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_TaStat
op_eq
l_int|2
)paren
(brace
multiline_comment|/* check contition status again after sending&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;   requset sense cmd 0x3 */
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_BAD_PHAS
suffix:semicolon
)brace
id|pCurScb-&gt;SCB_TaStat
op_assign
l_int|2
suffix:semicolon
)brace
id|pCurScb-&gt;SCB_Flags
op_or_assign
id|SCF_DONE
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_POST
)paren
(brace
(paren
op_star
id|pCurScb-&gt;SCB_Post
)paren
(paren
(paren
id|BYTE
op_star
)paren
id|pCurHcb
comma
(paren
id|BYTE
op_star
)paren
id|pCurScb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* while */
multiline_comment|/* find_active: */
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus0
)paren
op_amp
id|TSS_INT_PENDING
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_ActScb
)paren
(brace
multiline_comment|/* return to OS and wait for xfer_done_ISR/Selected_ISR */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* return to OS, enable interrupt */
)brace
multiline_comment|/* Check pending SCB            */
r_if
c_cond
(paren
id|tul_find_first_pend_scb
c_func
(paren
id|pCurHcb
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* return to OS, enable interrupt */
)brace
)brace
multiline_comment|/* End of for loop */
multiline_comment|/* statement won&squot;t reach here */
)brace
multiline_comment|/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
multiline_comment|/***************************************************************************/
multiline_comment|/***************************************************************************/
multiline_comment|/***************************************************************************/
multiline_comment|/***************************************************************************/
multiline_comment|/***************************************************************************/
DECL|function|tulip_scsi
r_void
id|tulip_scsi
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
suffix:semicolon
multiline_comment|/* make sure to service interrupt asap */
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus0
)paren
)paren
op_amp
id|TSS_INT_PENDING
)paren
(brace
id|pCurHcb-&gt;HCS_Phase
op_assign
id|pCurHcb-&gt;HCS_JSStatus0
op_amp
id|TSS_PH_MASK
suffix:semicolon
id|pCurHcb-&gt;HCS_JSStatus1
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus1
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_JSInt
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SInt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_SCSIRST_INT
)paren
(brace
multiline_comment|/* SCSI bus reset detected      */
id|int_tul_scsi_rst
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_RESEL_INT
)paren
(brace
multiline_comment|/* if selected/reselected interrupt */
r_if
c_cond
(paren
id|int_tul_resel
c_func
(paren
id|pCurHcb
)paren
op_eq
l_int|0
)paren
id|tul_next_state
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_SEL_TIMEOUT
)paren
(brace
id|int_tul_busfree
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_DISC_INT
)paren
(brace
multiline_comment|/* BUS disconnection            */
id|int_tul_busfree
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
multiline_comment|/* unexpected bus free or sel timeout */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
(paren
id|TSS_FUNC_COMP
op_or
id|TSS_BUS_SERV
)paren
)paren
(brace
multiline_comment|/* func complete or Bus service */
r_if
c_cond
(paren
(paren
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
)paren
op_ne
l_int|NULL
)paren
id|tul_next_state
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_ActScb
op_ne
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb
op_assign
id|tul_find_first_pend_scb
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* program HBA&squot;s SCSI ID &amp; target SCSI ID */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SScsiId
comma
(paren
id|pCurHcb-&gt;HCS_SCSI_ID
op_lshift
l_int|4
)paren
op_or
(paren
id|pCurScb-&gt;SCB_Target
op_amp
l_int|0x0F
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Opcode
op_eq
id|ExecSCSI
)paren
(brace
id|pCurTcb
op_assign
op_amp
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pCurScb-&gt;SCB_Target
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_TagMsg
)paren
id|pCurTcb-&gt;TCS_DrvFlags
op_or_assign
id|TCF_DRV_EN_TAG
suffix:semicolon
r_else
id|pCurTcb-&gt;TCS_DrvFlags
op_and_assign
op_complement
id|TCF_DRV_EN_TAG
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SPeriod
comma
id|pCurTcb-&gt;TCS_JS_Period
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurTcb-&gt;TCS_Flags
op_amp
(paren
id|TCF_WDTR_DONE
op_or
id|TCF_NO_WDTR
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* do wdtr negotiation          */
id|tul_select_atn_stop
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pCurTcb-&gt;TCS_Flags
op_amp
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_NO_SYNC_NEGO
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* do sync negotiation          */
id|tul_select_atn_stop
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_TagMsg
)paren
id|tul_select_atn3
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
r_else
id|tul_select_atn
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_POLL
)paren
(brace
r_while
c_loop
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tul_next_state
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Opcode
op_eq
id|BusDevRst
)paren
(brace
id|tul_select_atn_stop
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_POLL
)paren
(brace
r_while
c_loop
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tul_next_state
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Opcode
op_eq
id|AbortCmd
)paren
(brace
id|ULONG
id|srbp
suffix:semicolon
id|srbp
op_assign
(paren
id|ULONG
)paren
id|pCurScb-&gt;SCB_Srb
suffix:semicolon
multiline_comment|/* 08/03/98 */
r_if
c_cond
(paren
id|tul_abort_srb
c_func
(paren
id|pCurHcb
comma
id|srbp
)paren
op_ne
l_int|0
)paren
(brace
id|tul_unlink_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|tul_release_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
r_else
(brace
id|pCurScb-&gt;SCB_Opcode
op_assign
id|BusDevRst
suffix:semicolon
id|tul_select_atn_stop
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|8
suffix:semicolon
)brace
multiline_comment|/* 08/03/98 */
)brace
r_else
(brace
id|tul_unlink_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|pCurScb-&gt;SCB_HaStat
op_assign
l_int|0x16
suffix:semicolon
multiline_comment|/* bad command */
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_next_state
r_int
id|tul_next_state
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_int
id|next
suffix:semicolon
id|next
op_assign
id|pCurHcb-&gt;HCS_ActScb-&gt;SCB_NxtStat
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|next
)paren
(brace
r_case
l_int|1
suffix:colon
id|next
op_assign
id|tul_state_1
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|next
op_assign
id|tul_state_2
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|next
op_assign
id|tul_state_3
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|next
op_assign
id|tul_state_4
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|next
op_assign
id|tul_state_5
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|next
op_assign
id|tul_state_6
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|next
op_assign
id|tul_state_7
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_return
(paren
id|tul_bus_device_reset
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|next
op_le
l_int|0
)paren
r_return
id|next
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* sTate after selection with attention &amp; stop */
DECL|function|tul_state_1
r_int
id|tul_state_1
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s1-&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tul_unlink_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|tul_append_busy_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|pCurTcb-&gt;TCS_SConfig0
)paren
suffix:semicolon
multiline_comment|/* ATN on */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_eq
id|MSG_OUT
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
(paren
id|TSC_EN_BUS_IN
op_or
id|TSC_HW_RESELECT
)paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_Ident
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_TagMsg
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_TagMsg
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_TagId
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pCurTcb-&gt;TCS_Flags
op_amp
(paren
id|TCF_WDTR_DONE
op_or
id|TCF_NO_WDTR
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|pCurTcb-&gt;TCS_Flags
op_or_assign
id|TCF_WDTR_DONE
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_EXTEND
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Extended msg length */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Sync request */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Start from 16 bits */
)brace
r_else
r_if
c_cond
(paren
(paren
id|pCurTcb-&gt;TCS_Flags
op_amp
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_NO_SYNC_NEGO
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|pCurTcb-&gt;TCS_Flags
op_or_assign
id|TCF_SYNC_DONE
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_EXTEND
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* extended msg length */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* sync request */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|tul_rate_tbl
(braket
id|pCurTcb-&gt;TCS_Flags
op_amp
id|TCF_SCSI_RATE
)braket
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MAX_OFFSET
)paren
suffix:semicolon
multiline_comment|/* REQ/ACK offset */
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* state after selection with attention */
multiline_comment|/* state after selection with attention3 */
DECL|function|tul_state_2
r_int
id|tul_state_2
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s2-&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tul_unlink_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|tul_append_busy_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|pCurTcb-&gt;TCS_SConfig0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSStatus1
op_amp
id|TSS_CMD_PH_CMP
)paren
(brace
r_return
(paren
l_int|4
)paren
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* state before CDB xfer is done */
DECL|function|tul_state_3
r_int
id|tul_state_3
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s3-&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
(brace
r_case
id|CMD_OUT
suffix:colon
multiline_comment|/* Command out phase            */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_int
)paren
id|pCurScb-&gt;SCB_CDBLen
suffix:semicolon
id|i
op_increment
)paren
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_CDB
(braket
id|i
)braket
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_eq
id|CMD_OUT
)paren
(brace
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|MSG_IN
suffix:colon
multiline_comment|/* Message in phase             */
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgin
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_IN
suffix:colon
multiline_comment|/* Status phase                 */
r_if
c_cond
(paren
id|tul_status_msg
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_OUT
suffix:colon
multiline_comment|/* Message out phase            */
r_if
c_cond
(paren
id|pCurTcb-&gt;TCS_Flags
op_amp
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_NO_SYNC_NEGO
)paren
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_NOP
)paren
suffix:semicolon
multiline_comment|/* msg nop */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|pCurTcb-&gt;TCS_Flags
op_or_assign
id|TCF_SYNC_DONE
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_EXTEND
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* ext. msg len */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* sync request */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|tul_rate_tbl
(braket
id|pCurTcb-&gt;TCS_Flags
op_amp
id|TCF_SCSI_RATE
)braket
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MAX_OFFSET
)paren
suffix:semicolon
multiline_comment|/* REQ/ACK offset */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_state_4
r_int
id|tul_state_4
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s4-&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_DIR
)paren
op_eq
id|SCF_NO_XF
)paren
(brace
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Go to state 6                */
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_BufLen
op_eq
l_int|0
)paren
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Go to state 6                */
r_switch
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
(brace
r_case
id|STATUS_IN
suffix:colon
multiline_comment|/* Status phase                 */
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_DIR
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* if direction bit set then report data underrun */
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_DO_DU
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tul_status_msg
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_IN
suffix:colon
multiline_comment|/* Message in phase             */
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|0x4
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgin
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_OUT
suffix:colon
multiline_comment|/* Message out phase            */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_amp
id|TSS_PAR_ERROR
)paren
(brace
id|pCurScb-&gt;SCB_BufLen
op_assign
l_int|0
suffix:semicolon
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_DO_DU
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgout_ide
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Go to state 6                */
)brace
r_else
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_NOP
)paren
suffix:semicolon
multiline_comment|/* msg nop */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DATA_IN
suffix:colon
multiline_comment|/* Data in phase                */
r_return
(paren
id|tul_xfer_data_in
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_case
id|DATA_OUT
suffix:colon
multiline_comment|/* Data out phase               */
r_return
(paren
id|tul_xfer_data_out
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* state after dma xfer done or phase change before xfer done */
DECL|function|tul_state_5
r_int
id|tul_state_5
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
r_int
id|cnt
comma
id|xcnt
suffix:semicolon
multiline_comment|/* cannot use unsigned !! code: if (xcnt &lt; 0) */
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s5-&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*------ get remaining count -------*/
id|cnt
op_assign
id|TUL_RDLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SCnt0
)paren
op_amp
l_int|0x0FFFFFF
suffix:semicolon
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XCmd
)paren
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* ----------------------- DATA_IN ----------------------------- */
multiline_comment|/* check scsi parity error */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_amp
id|TSS_PAR_ERROR
)paren
(brace
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_DO_DU
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XStatus
)paren
op_amp
id|XPEND
)paren
(brace
multiline_comment|/* DMA xfer pending, Send STOP  */
multiline_comment|/* tell Hardware  scsi xfer has been terminated */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCtrl
comma
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XCtrl
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* wait until DMA xfer not pending */
r_while
c_loop
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XStatus
)paren
op_amp
id|XPEND
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*-------- DATA OUT -----------*/
r_if
c_cond
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus1
)paren
op_amp
id|TSS_XFER_CMP
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
op_amp
id|TSC_WIDE_SCSI
)paren
id|cnt
op_add_assign
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifoCnt
)paren
op_amp
l_int|0x1F
)paren
op_lshift
l_int|1
suffix:semicolon
r_else
id|cnt
op_add_assign
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifoCnt
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XStatus
)paren
op_amp
id|XPEND
)paren
(brace
multiline_comment|/* if DMA xfer is pending, abort DMA xfer */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_X_ABT
)paren
suffix:semicolon
multiline_comment|/* wait Abort DMA xfer done */
r_while
c_loop
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_Int
)paren
op_amp
id|XABT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cnt
op_eq
l_int|1
)paren
op_logical_and
(paren
id|pCurHcb-&gt;HCS_Phase
op_eq
id|DATA_OUT
)paren
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus1
)paren
op_amp
id|TSS_XFER_CMP
)paren
op_eq
l_int|0
)paren
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cnt
op_eq
l_int|0
)paren
(brace
id|pCurScb-&gt;SCB_BufLen
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Go to state 6                */
)brace
multiline_comment|/* Update active data pointer */
id|xcnt
op_assign
(paren
r_int
)paren
id|pCurScb-&gt;SCB_BufLen
op_minus
id|cnt
suffix:semicolon
multiline_comment|/* xcnt== bytes already xferred */
id|pCurScb-&gt;SCB_BufLen
op_assign
(paren
id|U32
)paren
id|cnt
suffix:semicolon
multiline_comment|/* cnt == bytes left to be xferred */
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_SG
)paren
(brace
r_register
id|SG
op_star
id|sgp
suffix:semicolon
id|ULONG
id|i
suffix:semicolon
id|sgp
op_assign
op_amp
id|pCurScb-&gt;SCB_SGList
(braket
id|pCurScb-&gt;SCB_SGIdx
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|pCurScb-&gt;SCB_SGIdx
suffix:semicolon
id|i
OL
id|pCurScb-&gt;SCB_SGMax
suffix:semicolon
id|sgp
op_increment
comma
id|i
op_increment
)paren
(brace
id|xcnt
op_sub_assign
(paren
r_int
)paren
id|sgp-&gt;SG_Len
suffix:semicolon
r_if
c_cond
(paren
id|xcnt
OL
l_int|0
)paren
(brace
multiline_comment|/* this sgp xfer half done */
id|xcnt
op_add_assign
(paren
r_int
)paren
id|sgp-&gt;SG_Len
suffix:semicolon
multiline_comment|/* xcnt == bytes xferred in this sgp */
id|sgp-&gt;SG_Ptr
op_add_assign
(paren
id|U32
)paren
id|xcnt
suffix:semicolon
multiline_comment|/* new ptr to be xfer */
id|sgp-&gt;SG_Len
op_sub_assign
(paren
id|U32
)paren
id|xcnt
suffix:semicolon
multiline_comment|/* new len to be xfer */
id|pCurScb-&gt;SCB_BufPtr
op_add_assign
(paren
(paren
id|U32
)paren
(paren
id|i
op_minus
id|pCurScb-&gt;SCB_SGIdx
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
multiline_comment|/* new SG table ptr */
id|pCurScb-&gt;SCB_SGLen
op_assign
(paren
id|BYTE
)paren
(paren
id|pCurScb-&gt;SCB_SGMax
op_minus
id|i
)paren
suffix:semicolon
multiline_comment|/* new SG table len */
id|pCurScb-&gt;SCB_SGIdx
op_assign
(paren
id|WORD
)paren
id|i
suffix:semicolon
multiline_comment|/* for next disc and come in this loop */
r_return
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Go to state 4                */
)brace
multiline_comment|/* else (xcnt &gt;= 0 , i.e. this sgp already xferred */
)brace
multiline_comment|/* for */
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Go to state 6                */
)brace
r_else
(brace
id|pCurScb-&gt;SCB_BufPtr
op_add_assign
(paren
id|U32
)paren
id|xcnt
suffix:semicolon
)brace
r_return
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Go to state 4                */
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* state after Data phase */
DECL|function|tul_state_6
r_int
id|tul_state_6
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s6-&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
(brace
r_case
id|STATUS_IN
suffix:colon
multiline_comment|/* Status phase                 */
r_if
c_cond
(paren
(paren
id|tul_status_msg
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_IN
suffix:colon
multiline_comment|/* Message in phase             */
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tul_msgin
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_OUT
suffix:colon
multiline_comment|/* Message out phase            */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_NOP
)paren
suffix:semicolon
multiline_comment|/* msg nop */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DATA_IN
suffix:colon
multiline_comment|/* Data in phase                */
r_return
(paren
id|tul_xpad_in
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_case
id|DATA_OUT
suffix:colon
multiline_comment|/* Data out phase               */
r_return
(paren
id|tul_xpad_out
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_state_7
r_int
id|tul_state_7
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_int
id|cnt
comma
id|i
suffix:semicolon
macro_line|#if DEBUG_STATE
id|printk
c_func
(paren
l_string|&quot;-s7-&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* flush SCSI FIFO */
id|cnt
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifoCnt
)paren
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
id|cnt
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
(brace
r_case
id|DATA_IN
suffix:colon
multiline_comment|/* Data in phase                */
r_case
id|DATA_OUT
suffix:colon
multiline_comment|/* Data out phase               */
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Go to state 6                */
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_xfer_data_in
r_int
id|tul_xfer_data_in
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_DIR
)paren
op_eq
id|SCF_DOUT
)paren
(brace
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* wrong direction */
)brace
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
id|pCurScb-&gt;SCB_BufLen
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_DMA_IN
)paren
suffix:semicolon
multiline_comment|/* 7/25/95 */
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_SG
)paren
(brace
multiline_comment|/* S/G xfer */
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCntH
comma
(paren
(paren
id|ULONG
)paren
id|pCurScb-&gt;SCB_SGLen
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XAddH
comma
id|pCurScb-&gt;SCB_BufPtr
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_SG_IN
)paren
suffix:semicolon
)brace
r_else
(brace
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCntH
comma
id|pCurScb-&gt;SCB_BufLen
)paren
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XAddH
comma
id|pCurScb-&gt;SCB_BufPtr
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_X_IN
)paren
suffix:semicolon
)brace
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|0x5
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* return to OS, wait xfer done , let jas_isr come in */
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_xfer_data_out
r_int
id|tul_xfer_data_out
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_DIR
)paren
op_eq
id|SCF_DIN
)paren
(brace
r_return
(paren
l_int|6
)paren
suffix:semicolon
multiline_comment|/* wrong direction */
)brace
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
id|pCurScb-&gt;SCB_BufLen
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_DMA_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_SG
)paren
(brace
multiline_comment|/* S/G xfer */
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCntH
comma
(paren
(paren
id|ULONG
)paren
id|pCurScb-&gt;SCB_SGLen
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XAddH
comma
id|pCurScb-&gt;SCB_BufPtr
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_SG_OUT
)paren
suffix:semicolon
)brace
r_else
(brace
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCntH
comma
id|pCurScb-&gt;SCB_BufLen
)paren
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XAddH
comma
id|pCurScb-&gt;SCB_BufPtr
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_X_OUT
)paren
suffix:semicolon
)brace
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|0x5
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* return to OS, wait xfer done , let jas_isr come in */
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_xpad_in
r_int
id|tul_xpad_in
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_DIR
)paren
op_ne
id|SCF_NO_DCHK
)paren
(brace
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_DO_DU
suffix:semicolon
multiline_comment|/* over run             */
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pCurTcb-&gt;TCS_JS_Period
op_amp
id|TSC_WIDE_SCSI
)paren
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|2
)paren
suffix:semicolon
r_else
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|DATA_IN
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
r_return
(paren
l_int|6
)paren
suffix:semicolon
)brace
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
)brace
)brace
DECL|function|tul_xpad_out
r_int
id|tul_xpad_out
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Flags
op_amp
id|SCF_DIR
)paren
op_ne
id|SCF_NO_DCHK
)paren
(brace
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_DO_DU
suffix:semicolon
multiline_comment|/* over run             */
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pCurTcb-&gt;TCS_JS_Period
op_amp
id|TSC_WIDE_SCSI
)paren
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|2
)paren
suffix:semicolon
r_else
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|0
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|DATA_OUT
)paren
(brace
multiline_comment|/* Disable wide CPU to allow read 16 bits */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
r_return
(paren
l_int|6
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_status_msg
r_int
id|tul_status_msg
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
multiline_comment|/* status &amp; MSG_IN */
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|BYTE
id|msg
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_CMD_COMP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* get status */
id|pCurScb-&gt;SCB_TaStat
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_eq
id|MSG_OUT
)paren
(brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_amp
id|TSS_PAR_ERROR
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_PARITY
)paren
suffix:semicolon
)brace
r_else
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_NOP
)paren
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_eq
id|MSG_IN
)paren
(brace
id|msg
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_amp
id|TSS_PAR_ERROR
)paren
(brace
multiline_comment|/* Parity error                 */
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_OUT
)paren
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_PARITY
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Command complete             */
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_TaStat
op_amp
l_int|0x18
)paren
op_eq
l_int|0x10
)paren
(brace
multiline_comment|/* No link support              */
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_MSG_ACCEPT
)paren
suffix:semicolon
r_return
id|tul_wait_done_disc
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|msg
op_eq
id|MSG_LINK_COMP
)paren
op_logical_or
(paren
id|msg
op_eq
id|MSG_LINK_FLAG
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_TaStat
op_amp
l_int|0x18
)paren
op_eq
l_int|0x10
)paren
r_return
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* scsi bus free */
DECL|function|int_tul_busfree
r_int
id|int_tul_busfree
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
r_if
c_cond
(paren
id|pCurScb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Status
op_amp
id|SCB_SELECT
)paren
(brace
multiline_comment|/* selection timeout */
id|tul_unlink_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_SEL_TOUT
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Unexpected bus free          */
id|tul_unlink_busy_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_BUS_FREE
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
l_int|NULL
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
multiline_comment|/* Flush SCSI FIFO  */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|TSC_INITDEFAULT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
multiline_comment|/* Enable HW reselect       */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* scsi bus reset */
DECL|function|int_tul_scsi_rst
r_int
id|int_tul_scsi_rst
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* if DMA xfer is pending, abort DMA xfer */
r_if
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_XStatus
)paren
op_amp
l_int|0x01
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_XCmd
comma
id|TAX_X_ABT
op_or
id|TAX_X_CLR_FIFO
)paren
suffix:semicolon
multiline_comment|/* wait Abort DMA xfer done */
r_while
c_loop
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_Int
)paren
op_amp
l_int|0x04
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
)brace
multiline_comment|/* Abort all active &amp; disconnected scb */
r_while
c_loop
(paren
(paren
id|pCurScb
op_assign
id|tul_pop_busy_scb
c_func
(paren
id|pCurHcb
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_BAD_PHAS
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* clr sync nego. done flag */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pCurHcb-&gt;HCS_MaxTar
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_Flags
op_and_assign
op_complement
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_WDTR_DONE
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* scsi reselection */
DECL|function|int_tul_resel
r_int
id|int_tul_resel
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
suffix:semicolon
id|BYTE
id|tag
comma
id|msg
op_assign
l_int|0
suffix:semicolon
id|BYTE
id|tar
comma
id|lun
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Status
op_amp
id|SCB_SELECT
)paren
(brace
multiline_comment|/* if waiting for selection complete */
id|pCurScb-&gt;SCB_Status
op_and_assign
op_complement
id|SCB_SELECT
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* --------- get target id---------------------- */
id|tar
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SBusId
)paren
suffix:semicolon
multiline_comment|/* ------ get LUN from Identify message----------- */
id|lun
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SIdent
)paren
op_amp
l_int|0x0F
suffix:semicolon
multiline_comment|/* 07/22/98 from 0x1F -&gt; 0x0F */
id|pCurTcb
op_assign
op_amp
id|pCurHcb-&gt;HCS_Tcs
(braket
id|tar
)braket
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
id|pCurTcb
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|pCurTcb-&gt;TCS_SConfig0
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SPeriod
comma
id|pCurTcb-&gt;TCS_JS_Period
)paren
suffix:semicolon
multiline_comment|/* ------------- tag queueing ? ------------------- */
r_if
c_cond
(paren
id|pCurTcb-&gt;TCS_DrvFlags
op_amp
id|TCF_DRV_EN_TAG
)paren
(brace
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_IN
)paren
r_goto
id|no_tag
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|msg
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
multiline_comment|/* Read Tag Message    */
r_if
c_cond
(paren
(paren
id|msg
OL
id|MSG_STAG
)paren
op_logical_or
(paren
id|msg
OG
id|MSG_OTAG
)paren
)paren
multiline_comment|/* Is simple Tag      */
r_goto
id|no_tag
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_IN
)paren
r_goto
id|no_tag
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|tag
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
multiline_comment|/* Read Tag ID       */
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_Scb
op_plus
id|tag
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurScb-&gt;SCB_Target
op_ne
id|tar
)paren
op_logical_or
(paren
id|pCurScb-&gt;SCB_Lun
op_ne
id|lun
)paren
)paren
(brace
r_return
id|tul_msgout_abort_tag
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurScb-&gt;SCB_Status
op_ne
id|SCB_BUSY
)paren
(brace
multiline_comment|/* 03/24/95             */
r_return
id|tul_msgout_abort_tag
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActScb
op_assign
id|pCurScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No tag               */
id|no_tag
suffix:colon
r_if
c_cond
(paren
(paren
id|pCurScb
op_assign
id|tul_find_busy_scb
c_func
(paren
id|pCurHcb
comma
id|tar
op_or
(paren
id|lun
op_lshift
l_int|8
)paren
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
id|tul_msgout_abort_targ
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActScb
op_assign
id|pCurScb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pCurTcb-&gt;TCS_DrvFlags
op_amp
id|TCF_DRV_EN_TAG
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|int_tul_bad_seq
r_int
id|int_tul_bad_seq
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
multiline_comment|/* target wrong phase           */
id|SCB
op_star
id|pCurScb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tul_reset_scsi
c_func
(paren
id|pCurHcb
comma
l_int|10
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pCurScb
op_assign
id|tul_pop_busy_scb
c_func
(paren
id|pCurHcb
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_BAD_PHAS
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pCurHcb-&gt;HCS_MaxTar
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_Flags
op_and_assign
op_complement
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_WDTR_DONE
)paren
suffix:semicolon
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgout_abort_targ
r_int
id|tul_msgout_abort_targ
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_OUT
)paren
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_ABORT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
id|tul_wait_disc
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgout_abort_tag
r_int
id|tul_msgout_abort_tag
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_OUT
)paren
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_ABORT_TAG
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
id|tul_wait_disc
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgin
r_int
id|tul_msgin
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|TCS
op_star
id|pCurTcb
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
)paren
(brace
r_case
id|MSG_DISC
suffix:colon
multiline_comment|/* Disconnect msg */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_MSG_ACCEPT
)paren
suffix:semicolon
r_return
id|tul_wait_disc
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_case
id|MSG_SDP
suffix:colon
r_case
id|MSG_RESTORE
suffix:colon
r_case
id|MSG_NOP
suffix:colon
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_REJ
suffix:colon
multiline_comment|/* Clear ATN first              */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
)paren
suffix:semicolon
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurTcb-&gt;TCS_Flags
op_amp
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_NO_SYNC_NEGO
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* do sync nego */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
)brace
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_EXTEND
suffix:colon
multiline_comment|/* extended msg */
id|tul_msgin_extend
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_IGNOREWIDE
suffix:colon
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* get */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* put pad  */
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
multiline_comment|/* get IGNORE field */
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
multiline_comment|/* get pad */
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_COMP
suffix:colon
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_MSG_ACCEPT
)paren
suffix:semicolon
r_return
id|tul_wait_done_disc
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
r_default
suffix:colon
id|tul_msgout_reject
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_IN
)paren
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
)brace
multiline_comment|/* statement won&squot;t reach here */
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgout_reject
r_int
id|tul_msgout_reject
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_eq
id|MSG_OUT
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_REJ
)paren
suffix:semicolon
multiline_comment|/* Msg reject           */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgout_ide
r_int
id|tul_msgout_ide
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_IDE
)paren
suffix:semicolon
multiline_comment|/* Initiator Detected Error */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgin_extend
r_int
id|tul_msgin_extend
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|BYTE
id|len
comma
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
op_ne
id|MSG_IN
)paren
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
multiline_comment|/* Get extended msg length      */
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|len
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|0
)braket
op_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|1
suffix:semicolon
id|len
op_ne
l_int|0
suffix:semicolon
id|len
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_ne
id|MSG_IN
)paren
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
id|TUL_WRLONG
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCnt0
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_Msg
(braket
id|idx
op_increment
)braket
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SFifo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|1
)braket
op_eq
l_int|1
)paren
(brace
multiline_comment|/* if it&squot;s synchronous data transfer request */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|0
)braket
op_ne
l_int|3
)paren
multiline_comment|/* if length is not right */
r_return
(paren
id|tul_msgout_reject
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_amp
id|TCF_NO_SYNC_NEGO
)paren
(brace
multiline_comment|/* Set OFFSET=0 to do async, nego back */
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|tul_msgin_sync
c_func
(paren
id|pCurHcb
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_amp
id|TCF_SYNC_DONE
)paren
)paren
(brace
id|tul_sync_done
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_return
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
op_ne
id|MSG_OUT
)paren
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
multiline_comment|/* sync msg out */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
id|tul_sync_done
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_EXTEND
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|3
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|1
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|0
)braket
op_ne
l_int|2
)paren
op_logical_or
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|1
)braket
op_ne
l_int|3
)paren
)paren
r_return
(paren
id|tul_msgout_reject
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
multiline_comment|/* if it&squot;s WIDE DATA XFER REQ   */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_amp
id|TCF_NO_WDTR
)paren
(brace
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
OG
l_int|2
)paren
multiline_comment|/* &gt; 32 bits            */
r_return
(paren
id|tul_msgout_reject
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_eq
l_int|2
)paren
(brace
multiline_comment|/* == 32                */
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_amp
id|TCF_NO_WDTR
)paren
op_eq
l_int|0
)paren
(brace
id|wdtr_done
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_amp
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_NO_SYNC_NEGO
)paren
)paren
op_eq
l_int|0
)paren
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
r_return
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SSignal
comma
(paren
(paren
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SSignal
)paren
op_amp
(paren
id|TSC_SET_ACK
op_or
l_int|7
)paren
)paren
op_or
id|TSC_SET_ATN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tul_msgin_accept
c_func
(paren
id|pCurHcb
)paren
op_ne
id|MSG_OUT
)paren
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
multiline_comment|/* WDTR msg out                 */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_EXTEND
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|2
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
l_int|3
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgin_sync
r_int
id|tul_msgin_sync
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_char
id|default_period
suffix:semicolon
id|default_period
op_assign
id|tul_rate_tbl
(braket
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_amp
id|TCF_SCSI_RATE
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
OG
id|MAX_OFFSET
)paren
(brace
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
op_assign
id|MAX_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
OL
id|default_period
)paren
(brace
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_assign
id|default_period
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_ge
l_int|59
)paren
(brace
multiline_comment|/* Change to async              */
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* offset requests asynchronous transfers ? */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
OL
id|default_period
)paren
(brace
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_assign
id|default_period
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
op_ge
l_int|59
)paren
(brace
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|wdtr_done
r_int
id|wdtr_done
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_and_assign
op_complement
id|TCF_SYNC_DONE
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_or_assign
id|TCF_WDTR_DONE
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
)paren
(brace
multiline_comment|/* if 16 bit */
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
op_or_assign
id|TSC_WIDE_SCSI
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_SConfig0
op_and_assign
op_complement
id|TSC_ALT_PERIOD
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_SConfig0
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SPeriod
comma
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_sync_done
r_int
id|tul_sync_done
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_int
id|i
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_Flags
op_or_assign
id|TCF_SYNC_DONE
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
)paren
(brace
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
op_or_assign
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|3
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tul_rate_tbl
(braket
id|i
)braket
op_ge
id|pCurHcb-&gt;HCS_Msg
(braket
l_int|2
)braket
)paren
multiline_comment|/* pick the big one */
r_break
suffix:semicolon
)brace
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
op_or_assign
(paren
id|i
op_lshift
l_int|4
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_SConfig0
op_or_assign
id|TSC_ALT_PERIOD
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_SConfig0
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SPeriod
comma
id|pCurHcb-&gt;HCS_ActTcs-&gt;TCS_JS_Period
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|tul_post_scsi_rst
r_int
id|tul_post_scsi_rst
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
l_int|0
suffix:semicolon
id|pCurHcb-&gt;HCS_Flags
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pCurScb
op_assign
id|tul_pop_busy_scb
c_func
(paren
id|pCurHcb
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pCurScb-&gt;SCB_HaStat
op_assign
id|HOST_BAD_PHAS
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
)brace
multiline_comment|/* clear sync done flag         */
id|pCurTcb
op_assign
op_amp
id|pCurHcb-&gt;HCS_Tcs
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pCurHcb-&gt;HCS_MaxTar
suffix:semicolon
id|pCurTcb
op_increment
comma
id|i
op_increment
)paren
(brace
id|pCurTcb-&gt;TCS_Flags
op_and_assign
op_complement
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_WDTR_DONE
)paren
suffix:semicolon
multiline_comment|/* Initialize the sync. xfer register values to an asyn xfer */
id|pCurTcb-&gt;TCS_JS_Period
op_assign
l_int|0
suffix:semicolon
id|pCurTcb-&gt;TCS_SConfig0
op_assign
id|pCurHcb-&gt;HCS_SConf1
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTags
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 07/22/98 */
id|pCurHcb-&gt;HCS_Tcs
(braket
id|i
)braket
dot
id|TCS_Flags
op_and_assign
op_complement
id|TCF_BUSY
suffix:semicolon
multiline_comment|/* 07/22/98 */
)brace
multiline_comment|/* for */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_select_atn_stop
r_void
id|tul_select_atn_stop
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
(brace
id|pCurScb-&gt;SCB_Status
op_or_assign
id|SCB_SELECT
suffix:semicolon
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|0x1
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
id|pCurScb
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
op_amp
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pCurScb-&gt;SCB_Target
)braket
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_SELATNSTOP
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_select_atn
r_void
id|tul_select_atn
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
(brace
r_int
id|i
suffix:semicolon
id|pCurScb-&gt;SCB_Status
op_or_assign
id|SCB_SELECT
suffix:semicolon
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|0x2
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_Ident
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_int
)paren
id|pCurScb-&gt;SCB_CDBLen
suffix:semicolon
id|i
op_increment
)paren
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_CDB
(braket
id|i
)braket
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
op_amp
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pCurScb-&gt;SCB_Target
)braket
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
id|pCurScb
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_SEL_ATN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_select_atn3
r_void
id|tul_select_atn3
c_func
(paren
id|HCS
op_star
id|pCurHcb
comma
id|SCB
op_star
id|pCurScb
)paren
(brace
r_int
id|i
suffix:semicolon
id|pCurScb-&gt;SCB_Status
op_or_assign
id|SCB_SELECT
suffix:semicolon
id|pCurScb-&gt;SCB_NxtStat
op_assign
l_int|0x2
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_Ident
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_TagMsg
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_TagId
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_int
)paren
id|pCurScb-&gt;SCB_CDBLen
suffix:semicolon
id|i
op_increment
)paren
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|pCurScb-&gt;SCB_CDB
(braket
id|i
)braket
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
op_amp
id|pCurHcb-&gt;HCS_Tcs
(braket
id|pCurScb-&gt;SCB_Target
)braket
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
id|pCurScb
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_SEL_ATN3
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* SCSI Bus Device Reset */
DECL|function|tul_bus_device_reset
r_int
id|tul_bus_device_reset
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|SCB
op_star
id|pCurScb
op_assign
id|pCurHcb-&gt;HCS_ActScb
suffix:semicolon
id|TCS
op_star
id|pCurTcb
op_assign
id|pCurHcb-&gt;HCS_ActTcs
suffix:semicolon
id|SCB
op_star
id|pTmpScb
comma
op_star
id|pPrevScb
suffix:semicolon
id|BYTE
id|tar
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Phase
op_ne
id|MSG_OUT
)paren
(brace
r_return
(paren
id|int_tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
multiline_comment|/* Unexpected phase             */
)brace
id|tul_unlink_pend_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|tul_release_scb
c_func
(paren
id|pCurHcb
comma
id|pCurScb
)paren
suffix:semicolon
id|tar
op_assign
id|pCurScb-&gt;SCB_Target
suffix:semicolon
multiline_comment|/* target                       */
id|pCurTcb-&gt;TCS_Flags
op_and_assign
op_complement
(paren
id|TCF_SYNC_DONE
op_or
id|TCF_WDTR_DONE
op_or
id|TCF_BUSY
)paren
suffix:semicolon
multiline_comment|/* clr sync. nego &amp; WDTR flags  07/22/98 */
multiline_comment|/* abort all SCB with same target */
id|pPrevScb
op_assign
id|pTmpScb
op_assign
id|pCurHcb-&gt;HCS_FirstBusy
suffix:semicolon
multiline_comment|/* Check Busy queue */
r_while
c_loop
(paren
id|pTmpScb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pTmpScb-&gt;SCB_Target
op_eq
id|tar
)paren
(brace
multiline_comment|/* unlink it */
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_FirstBusy
)paren
(brace
r_if
c_cond
(paren
(paren
id|pCurHcb-&gt;HCS_FirstBusy
op_assign
id|pTmpScb-&gt;SCB_NxtScb
)paren
op_eq
l_int|NULL
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pPrevScb-&gt;SCB_NxtScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
r_if
c_cond
(paren
id|pTmpScb
op_eq
id|pCurHcb-&gt;HCS_LastBusy
)paren
id|pCurHcb-&gt;HCS_LastBusy
op_assign
id|pPrevScb
suffix:semicolon
)brace
id|pTmpScb-&gt;SCB_HaStat
op_assign
id|HOST_ABORTED
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pTmpScb
)paren
suffix:semicolon
)brace
multiline_comment|/* Previous haven&squot;t change      */
r_else
(brace
id|pPrevScb
op_assign
id|pTmpScb
suffix:semicolon
)brace
id|pTmpScb
op_assign
id|pTmpScb-&gt;SCB_NxtScb
suffix:semicolon
)brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SFifo
comma
id|MSG_DEVRST
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_XF_FIFO_OUT
)paren
suffix:semicolon
r_return
id|tul_wait_disc
c_func
(paren
id|pCurHcb
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_msgin_accept
r_int
id|tul_msgin_accept
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCmd
comma
id|TSC_MSG_ACCEPT
)paren
suffix:semicolon
r_return
(paren
id|wait_tulip
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|wait_tulip
r_int
id|wait_tulip
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus0
)paren
)paren
op_amp
id|TSS_INT_PENDING
)paren
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_JSInt
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SInt
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_Phase
op_assign
id|pCurHcb-&gt;HCS_JSStatus0
op_amp
id|TSS_PH_MASK
suffix:semicolon
id|pCurHcb-&gt;HCS_JSStatus1
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_RESEL_INT
)paren
(brace
multiline_comment|/* if SCSI bus reset detected   */
r_return
(paren
id|int_tul_resel
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_SEL_TIMEOUT
)paren
(brace
multiline_comment|/* if selected/reselected timeout interrupt */
r_return
(paren
id|int_tul_busfree
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_SCSIRST_INT
)paren
(brace
multiline_comment|/* if SCSI bus reset detected   */
r_return
(paren
id|int_tul_scsi_rst
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_DISC_INT
)paren
(brace
multiline_comment|/* BUS disconnection            */
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Flags
op_amp
id|HCF_EXPECT_DONE_DISC
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
multiline_comment|/* Flush SCSI FIFO  */
id|tul_unlink_busy_scb
c_func
(paren
id|pCurHcb
comma
id|pCurHcb-&gt;HCS_ActScb
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb-&gt;SCB_HaStat
op_assign
l_int|0
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurHcb-&gt;HCS_ActScb
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_Flags
op_and_assign
op_complement
id|HCF_EXPECT_DONE_DISC
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|TSC_INITDEFAULT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
multiline_comment|/* Enable HW reselect       */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_Flags
op_amp
id|HCF_EXPECT_DISC
)paren
(brace
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
multiline_comment|/* Flush SCSI FIFO  */
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_ActTcs
op_assign
l_int|NULL
suffix:semicolon
id|pCurHcb-&gt;HCS_Flags
op_and_assign
op_complement
id|HCF_EXPECT_DISC
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|TSC_INITDEFAULT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
multiline_comment|/* Enable HW reselect       */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
id|int_tul_busfree
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
(paren
id|TSS_FUNC_COMP
op_or
id|TSS_BUS_SERV
)paren
)paren
(brace
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
)brace
r_return
(paren
id|pCurHcb-&gt;HCS_Phase
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_wait_disc
r_int
id|tul_wait_disc
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus0
)paren
)paren
op_amp
id|TSS_INT_PENDING
)paren
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_JSInt
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SInt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_SCSIRST_INT
)paren
(brace
multiline_comment|/* if SCSI bus reset detected   */
r_return
(paren
id|int_tul_scsi_rst
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_DISC_INT
)paren
(brace
multiline_comment|/* BUS disconnection            */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
multiline_comment|/* Flush SCSI FIFO  */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|TSC_INITDEFAULT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
multiline_comment|/* Enable HW reselect       */
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|tul_wait_done_disc
r_int
id|tul_wait_done_disc
c_func
(paren
id|HCS
op_star
id|pCurHcb
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|pCurHcb-&gt;HCS_JSStatus0
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SStatus0
)paren
)paren
op_amp
id|TSS_INT_PENDING
)paren
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_JSInt
op_assign
id|TUL_RD
c_func
(paren
id|pCurHcb-&gt;HCS_Base
comma
id|TUL_SInt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_SCSIRST_INT
)paren
(brace
multiline_comment|/* if SCSI bus reset detected   */
r_return
(paren
id|int_tul_scsi_rst
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCurHcb-&gt;HCS_JSInt
op_amp
id|TSS_DISC_INT
)paren
(brace
multiline_comment|/* BUS disconnection            */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl0
comma
id|TSC_FLUSH_FIFO
)paren
suffix:semicolon
multiline_comment|/* Flush SCSI FIFO  */
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SConfig
comma
id|TSC_INITDEFAULT
)paren
suffix:semicolon
id|TUL_WR
c_func
(paren
id|pCurHcb-&gt;HCS_Base
op_plus
id|TUL_SCtrl1
comma
id|TSC_HW_RESELECT
)paren
suffix:semicolon
multiline_comment|/* Enable HW reselect       */
id|tul_unlink_busy_scb
c_func
(paren
id|pCurHcb
comma
id|pCurHcb-&gt;HCS_ActScb
)paren
suffix:semicolon
id|tul_append_done_scb
c_func
(paren
id|pCurHcb
comma
id|pCurHcb-&gt;HCS_ActScb
)paren
suffix:semicolon
id|pCurHcb-&gt;HCS_ActScb
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
id|tul_bad_seq
c_func
(paren
id|pCurHcb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**************************** EOF *********************************/
eof
