multiline_comment|/*&n; * QLogic ISP1020 Intelligent SCSI Processor Driver (PCI)&n; * Written by Erik H. Moe, ehm@cris.com&n; * Copyright 1995, Erik H. Moe&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; */
multiline_comment|/* Renamed and updated to 1.3.x by Michael Griffith &lt;grif@cs.ucr.edu&gt; */
multiline_comment|/*&n; * $Date: 1995/09/22 02:23:15 $&n; * $Revision: 0.5 $&n; *&n; * $Log: isp1020.c,v $&n; * Revision 0.5  1995/09/22  02:23:15  root&n; * do auto request sense&n; *&n; * Revision 0.4  1995/08/07  04:44:33  root&n; * supply firmware with driver.&n; * numerous bug fixes/general cleanup of code.&n; *&n; * Revision 0.3  1995/07/16  16:15:39  root&n; * added reset/abort code.&n; *&n; * Revision 0.2  1995/06/29  03:14:19  root&n; * fixed biosparam.&n; * added queue protocol.&n; *&n; * Revision 0.1  1995/06/25  01:55:45  root&n; * Initial release.&n; *&n; */
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;qlogicisp.h&quot;
multiline_comment|/* Configuration section *****************************************************/
multiline_comment|/* Set the following macro to 1 to reload the ISP1020&squot;s firmware.  This is&n;   the latest firmware provided by QLogic.  This may be an earlier/later&n;   revision than supplied by your board. */
DECL|macro|RELOAD_FIRMWARE
mdefine_line|#define RELOAD_FIRMWARE&t;&t;1
multiline_comment|/* Set the following macro to 1 to reload the ISP1020&squot;s defaults from nvram.&n;   If you are not sure of your settings, leave this alone, the driver will&n;   use a set of &squot;safe&squot; defaults */
DECL|macro|USE_NVRAM_DEFAULTS
mdefine_line|#define USE_NVRAM_DEFAULTS&t;0
multiline_comment|/*  Set this macro to 1 if you want to create a scsi loadable module. */
DECL|macro|MODULE
mdefine_line|#define MODULE&t;&t;&t;0
multiline_comment|/*  Macros used for debugging */
DECL|macro|DEBUG_ISP1020
mdefine_line|#define DEBUG_ISP1020&t;&t;0
DECL|macro|DEBUG_ISP1020_INT
mdefine_line|#define DEBUG_ISP1020_INT&t;0
DECL|macro|DEBUG_ISP1020_SETUP
mdefine_line|#define DEBUG_ISP1020_SETUP&t;0
multiline_comment|/* End Configuration section *************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#if DEBUG_ISP1020
DECL|macro|ENTER
mdefine_line|#define ENTER(x)&t;printk(&quot;isp1020 : entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)&t;printk(&quot;isp1020 : leaving %s()&bslash;n&quot;, x);
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;x
macro_line|#else
DECL|macro|ENTER
mdefine_line|#define ENTER(x)
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)
macro_line|#endif /* DEBUG_ISP1020 */
macro_line|#if DEBUG_ISP1020_INTR
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)&t;printk(&quot;isp1020 : entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)&t;printk(&quot;isp1020 : leaving %s()&bslash;n&quot;, x);
DECL|macro|DEBUG_INTR
mdefine_line|#define DEBUG_INTR(x)&t;x
macro_line|#else
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)
DECL|macro|DEBUG_INTR
mdefine_line|#define DEBUG_INTR(x)
macro_line|#endif /* DEBUG ISP1020_INTR */
DECL|macro|ISP1020_REV_ID
mdefine_line|#define ISP1020_REV_ID&t;1
multiline_comment|/* host configuration and control registers */
DECL|macro|HOST_HCCR
mdefine_line|#define HOST_HCCR&t;0xc0&t;/* host command and control */
multiline_comment|/* pci bus interface registers */
DECL|macro|PCI_ID_LOW
mdefine_line|#define PCI_ID_LOW&t;0x00&t;/* vendor id */
DECL|macro|PCI_ID_HIGH
mdefine_line|#define PCI_ID_HIGH&t;0x02&t;/* device id */
DECL|macro|ISP_CFG0
mdefine_line|#define ISP_CFG0&t;0x04&t;/* configuration register #0 */
DECL|macro|ISP_CFG1
mdefine_line|#define ISP_CFG1&t;0x08&t;/* configuration register #1 */
DECL|macro|PCI_INTF_CTL
mdefine_line|#define PCI_INTF_CTL&t;0x08&t;/* pci interface control */
DECL|macro|PCI_INTF_STS
mdefine_line|#define PCI_INTF_STS&t;0x0a&t;/* pci interface status */
DECL|macro|PCI_SEMAPHORE
mdefine_line|#define PCI_SEMAPHORE&t;0x0c&t;/* pci semaphore */
DECL|macro|PCI_NVRAM
mdefine_line|#define PCI_NVRAM&t;0x0e&t;/* pci nvram interface */
multiline_comment|/* mailbox registers */
DECL|macro|MBOX0
mdefine_line|#define MBOX0&t;&t;0x70&t;/* mailbox 0 */
DECL|macro|MBOX1
mdefine_line|#define MBOX1&t;&t;0x72&t;/* mailbox 1 */
DECL|macro|MBOX2
mdefine_line|#define MBOX2&t;&t;0x74&t;/* mailbox 2 */
DECL|macro|MBOX3
mdefine_line|#define MBOX3&t;&t;0x76&t;/* mailbox 3 */
DECL|macro|MBOX4
mdefine_line|#define MBOX4&t;&t;0x78&t;/* mailbox 4 */
DECL|macro|MBOX5
mdefine_line|#define MBOX5&t;&t;0x7a&t;/* mailbox 5 */
multiline_comment|/* mailbox command complete status codes */
DECL|macro|MBOX_COMMAND_COMPLETE
mdefine_line|#define MBOX_COMMAND_COMPLETE&t;&t;0x4000
DECL|macro|INVALID_COMMAND
mdefine_line|#define INVALID_COMMAND&t;&t;&t;0x4001
DECL|macro|HOST_INTERFACE_ERROR
mdefine_line|#define HOST_INTERFACE_ERROR&t;&t;0x4002
DECL|macro|TEST_FAILED
mdefine_line|#define TEST_FAILED&t;&t;&t;0x4003
DECL|macro|COMMAND_ERROR
mdefine_line|#define COMMAND_ERROR&t;&t;&t;0x4005
DECL|macro|COMMAND_PARAM_ERROR
mdefine_line|#define COMMAND_PARAM_ERROR&t;&t;0x4006
multiline_comment|/* async event status codes */
DECL|macro|ASYNC_SCSI_BUS_RESET
mdefine_line|#define ASYNC_SCSI_BUS_RESET&t;&t;0x8001
DECL|macro|SYSTEM_ERROR
mdefine_line|#define SYSTEM_ERROR&t;&t;&t;0x8002
DECL|macro|REQUEST_TRANSFER
mdefine_line|#define REQUEST_TRANSFER ERROR&t;&t;0x8003
DECL|macro|RESPONSE_TRANSFER_ERROR
mdefine_line|#define RESPONSE_TRANSFER_ERROR&t;&t;0x8004
DECL|macro|REQUEST_QUEUE_WAKEUP
mdefine_line|#define REQUEST_QUEUE_WAKEUP&t;&t;0x8005
DECL|macro|EXECUTION_TIMEOUT_RESET
mdefine_line|#define EXECUTION_TIMEOUT_RESET&t;&t;0x8006
DECL|struct|Entry_header
r_struct
id|Entry_header
(brace
DECL|member|entry_type
id|u_char
id|entry_type
suffix:semicolon
DECL|member|entry_cnt
id|u_char
id|entry_cnt
suffix:semicolon
DECL|member|sys_def_1
id|u_char
id|sys_def_1
suffix:semicolon
DECL|member|flags
id|u_char
id|flags
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* entry header type commands */
DECL|macro|ENTRY_COMMAND
mdefine_line|#define ENTRY_COMMAND&t;&t;1
DECL|macro|ENTRY_CONTINUATION
mdefine_line|#define ENTRY_CONTINUATION&t;2
DECL|macro|ENTRY_STATUS
mdefine_line|#define ENTRY_STATUS&t;&t;3
DECL|macro|ENTRY_MARKER
mdefine_line|#define ENTRY_MARKER&t;&t;4
DECL|macro|ENTRY_EXTENDED_COMMAND
mdefine_line|#define ENTRY_EXTENDED_COMMAND&t;5
multiline_comment|/* entry header flag definitions */
DECL|macro|EFLAG_CONTINUATION
mdefine_line|#define EFLAG_CONTINUATION&t;1
DECL|macro|EFLAG_BUSY
mdefine_line|#define EFLAG_BUSY&t;&t;2
DECL|macro|EFLAG_BAD_HEADER
mdefine_line|#define EFLAG_BAD_HEADER&t;4
DECL|macro|EFLAG_BAD_PAYLOAD
mdefine_line|#define EFLAG_BAD_PAYLOAD&t;8
DECL|struct|dataseg
r_struct
id|dataseg
(brace
DECL|member|d_base
id|caddr_t
id|d_base
suffix:semicolon
DECL|member|d_count
id|u_long
id|d_count
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|Command_Entry
r_struct
id|Command_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|handle
id|caddr_t
id|handle
suffix:semicolon
DECL|member|target_lun
id|u_char
id|target_lun
suffix:semicolon
DECL|member|target_id
id|u_char
id|target_id
suffix:semicolon
DECL|member|cdb_length
id|u_short
id|cdb_length
suffix:semicolon
DECL|member|control_flags
id|u_short
id|control_flags
suffix:semicolon
DECL|member|rsvd
id|u_short
id|rsvd
suffix:semicolon
DECL|member|time_out
id|u_short
id|time_out
suffix:semicolon
DECL|member|segment_cnt
id|u_short
id|segment_cnt
suffix:semicolon
DECL|member|cdb
id|u_char
id|cdb
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|dataseg0
r_struct
id|dataseg
id|dataseg0
suffix:semicolon
DECL|member|dataseg1
r_struct
id|dataseg
id|dataseg1
suffix:semicolon
DECL|member|dataseg2
r_struct
id|dataseg
id|dataseg2
suffix:semicolon
DECL|member|dataseg3
r_struct
id|dataseg
id|dataseg3
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* command entry control flag definitions */
DECL|macro|CFLAG_NODISC
mdefine_line|#define CFLAG_NODISC&t;&t;0x01
DECL|macro|CFLAG_HEAD_TAG
mdefine_line|#define CFLAG_HEAD_TAG&t;&t;0x02
DECL|macro|CFLAG_ORDERED_TAG
mdefine_line|#define CFLAG_ORDERED_TAG&t;0x04
DECL|macro|CFLAG_SIMPLE_TAG
mdefine_line|#define CFLAG_SIMPLE_TAG&t;0x08
DECL|macro|CFLAG_TAR_RTN
mdefine_line|#define CFLAG_TAR_RTN&t;&t;0x10
DECL|macro|CFLAG_READ
mdefine_line|#define CFLAG_READ&t;&t;0x20
DECL|macro|CFLAG_WRITE
mdefine_line|#define CFLAG_WRITE&t;&t;0x40
DECL|struct|Ext_Command_Entry
r_struct
id|Ext_Command_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|handle
id|caddr_t
id|handle
suffix:semicolon
DECL|member|target_lun
id|u_char
id|target_lun
suffix:semicolon
DECL|member|target_id
id|u_char
id|target_id
suffix:semicolon
DECL|member|cdb_length
id|u_short
id|cdb_length
suffix:semicolon
DECL|member|control_flags
id|u_short
id|control_flags
suffix:semicolon
DECL|member|rsvd
id|u_short
id|rsvd
suffix:semicolon
DECL|member|time_out
id|u_short
id|time_out
suffix:semicolon
DECL|member|segment_cnt
id|u_short
id|segment_cnt
suffix:semicolon
DECL|member|cdb
id|u_char
id|cdb
(braket
l_int|44
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|Continuation_Entry
r_struct
id|Continuation_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|reserved
id|u_long
id|reserved
suffix:semicolon
DECL|member|dataseg0
r_struct
id|dataseg
id|dataseg0
suffix:semicolon
DECL|member|dataseg1
r_struct
id|dataseg
id|dataseg1
suffix:semicolon
DECL|member|dataseg2
r_struct
id|dataseg
id|dataseg2
suffix:semicolon
DECL|member|dataseg3
r_struct
id|dataseg
id|dataseg3
suffix:semicolon
DECL|member|dataseg4
r_struct
id|dataseg
id|dataseg4
suffix:semicolon
DECL|member|dataseg5
r_struct
id|dataseg
id|dataseg5
suffix:semicolon
DECL|member|dataseg6
r_struct
id|dataseg
id|dataseg6
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|Marker_Entry
r_struct
id|Marker_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|reserved
id|caddr_t
id|reserved
suffix:semicolon
DECL|member|target_lun
id|u_char
id|target_lun
suffix:semicolon
DECL|member|target_id
id|u_char
id|target_id
suffix:semicolon
DECL|member|modifier
id|u_char
id|modifier
suffix:semicolon
DECL|member|rsvd
id|u_char
id|rsvd
suffix:semicolon
DECL|member|rsvds
id|u_char
id|rsvds
(braket
l_int|52
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* marker entry modifier definitions */
DECL|macro|SYNC_DEVICE
mdefine_line|#define SYNC_DEVICE&t;0
DECL|macro|SYNC_TARGET
mdefine_line|#define SYNC_TARGET&t;1
DECL|macro|SYNC_ALL
mdefine_line|#define SYNC_ALL&t;2
DECL|struct|Status_Entry
r_struct
id|Status_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|handle
id|caddr_t
id|handle
suffix:semicolon
DECL|member|scsi_status
id|u_short
id|scsi_status
suffix:semicolon
DECL|member|completion_status
id|u_short
id|completion_status
suffix:semicolon
DECL|member|state_flags
id|u_short
id|state_flags
suffix:semicolon
DECL|member|status_flags
id|u_short
id|status_flags
suffix:semicolon
DECL|member|time
id|u_short
id|time
suffix:semicolon
DECL|member|req_sense_len
id|u_short
id|req_sense_len
suffix:semicolon
DECL|member|residual
id|u_long
id|residual
suffix:semicolon
DECL|member|rsvd
id|u_char
id|rsvd
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|req_sense_data
id|u_char
id|req_sense_data
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* status entry completion status definitions */
DECL|macro|CS_COMPLETE
mdefine_line|#define CS_COMPLETE&t;&t;&t;0x0000
DECL|macro|CS_INCOMPLETE
mdefine_line|#define CS_INCOMPLETE&t;&t;&t;0x0001
DECL|macro|CS_DMA_ERROR
mdefine_line|#define CS_DMA_ERROR&t;&t;&t;0x0002
DECL|macro|CS_TRANSPORT_ERROR
mdefine_line|#define CS_TRANSPORT_ERROR&t;&t;0x0003
DECL|macro|CS_RESET_OCCURRED
mdefine_line|#define CS_RESET_OCCURRED&t;&t;0x0004
DECL|macro|CS_ABORTED
mdefine_line|#define CS_ABORTED&t;&t;&t;0x0005
DECL|macro|CS_TIMEOUT
mdefine_line|#define CS_TIMEOUT&t;&t;&t;0x0006
DECL|macro|CS_DATA_OVERRUN
mdefine_line|#define CS_DATA_OVERRUN&t;&t;&t;0x0007
DECL|macro|CS_COMMAND_OVERRUN
mdefine_line|#define CS_COMMAND_OVERRUN&t;&t;0x0008
DECL|macro|CS_STATUS_OVERRUN
mdefine_line|#define CS_STATUS_OVERRUN&t;&t;0x0009
DECL|macro|CS_BAD_MESSAGE
mdefine_line|#define CS_BAD_MESSAGE&t;&t;&t;0x000a
DECL|macro|CS_NO_MESSAGE_OUT
mdefine_line|#define CS_NO_MESSAGE_OUT&t;&t;0x000b
DECL|macro|CS_EXT_ID_FAILED
mdefine_line|#define CS_EXT_ID_FAILED&t;&t;0x000c
DECL|macro|CS_IDE_MSG_FAILED
mdefine_line|#define CS_IDE_MSG_FAILED&t;&t;0x000d
DECL|macro|CS_ABORT_MSG_FAILED
mdefine_line|#define CS_ABORT_MSG_FAILED&t;&t;0x000e
DECL|macro|CS_REJECT_MSG_FAILED
mdefine_line|#define CS_REJECT_MSG_FAILED&t;&t;0x000f
DECL|macro|CS_NOP_MSG_FAILED
mdefine_line|#define CS_NOP_MSG_FAILED&t;&t;0x0010
DECL|macro|CS_PARITY_ERROR_MSG_FAILED
mdefine_line|#define CS_PARITY_ERROR_MSG_FAILED&t;0x0011
DECL|macro|CS_DEVICE_RESET_MSG_FAILED
mdefine_line|#define CS_DEVICE_RESET_MSG_FAILED&t;0x0012
DECL|macro|CS_ID_MSG_FAILED
mdefine_line|#define CS_ID_MSG_FAILED&t;&t;0x0013
DECL|macro|CS_UNEXP_BUS_FREE
mdefine_line|#define CS_UNEXP_BUS_FREE&t;&t;0x0014
DECL|macro|CS_DATA_UNDERRUN
mdefine_line|#define CS_DATA_UNDERRUN&t;&t;0x0015
multiline_comment|/* status entry state flag definitions */
DECL|macro|SF_GOT_BUS
mdefine_line|#define SF_GOT_BUS&t;&t;&t;0x0100
DECL|macro|SF_GOT_TARGET
mdefine_line|#define SF_GOT_TARGET&t;&t;&t;0x0200
DECL|macro|SF_SENT_CDB
mdefine_line|#define SF_SENT_CDB&t;&t;&t;0x0400
DECL|macro|SF_TRANSFERRED_DATA
mdefine_line|#define SF_TRANSFERRED_DATA&t;&t;0x0800
DECL|macro|SF_GOT_STATUS
mdefine_line|#define SF_GOT_STATUS&t;&t;&t;0x1000
DECL|macro|SF_GOT_SENSE
mdefine_line|#define SF_GOT_SENSE&t;&t;&t;0x2000
multiline_comment|/* status entry status flag definitions */
DECL|macro|STF_DISCONNECT
mdefine_line|#define STF_DISCONNECT&t;&t;&t;0x0001
DECL|macro|STF_SYNCHRONOUS
mdefine_line|#define STF_SYNCHRONOUS&t;&t;&t;0x0002
DECL|macro|STF_PARITY_ERROR
mdefine_line|#define STF_PARITY_ERROR&t;&t;0x0004
DECL|macro|STF_BUS_RESET
mdefine_line|#define STF_BUS_RESET&t;&t;&t;0x0008
DECL|macro|STF_DEVICE_RESET
mdefine_line|#define STF_DEVICE_RESET&t;&t;0x0010
DECL|macro|STF_ABORTED
mdefine_line|#define STF_ABORTED&t;&t;&t;0x0020
DECL|macro|STF_TIMEOUT
mdefine_line|#define STF_TIMEOUT&t;&t;&t;0x0040
DECL|macro|STF_NEGOTIATION
mdefine_line|#define STF_NEGOTIATION&t;&t;&t;0x0080
multiline_comment|/* host control commands */
DECL|macro|HCCR_NOP
mdefine_line|#define HCCR_NOP&t;&t;&t;0x0000
DECL|macro|HCCR_RESET
mdefine_line|#define HCCR_RESET&t;&t;&t;0x1000
DECL|macro|HCCR_PAUSE
mdefine_line|#define HCCR_PAUSE&t;&t;&t;0x2000
DECL|macro|HCCR_RELEASE
mdefine_line|#define HCCR_RELEASE&t;&t;&t;0x3000
DECL|macro|HCCR_SINGLE_STEP
mdefine_line|#define HCCR_SINGLE_STEP&t;&t;0x4000
DECL|macro|HCCR_SET_HOST_INTR
mdefine_line|#define HCCR_SET_HOST_INTR&t;&t;0x5000
DECL|macro|HCCR_CLEAR_HOST_INTR
mdefine_line|#define HCCR_CLEAR_HOST_INTR&t;&t;0x6000
DECL|macro|HCCR_CLEAR_RISC_INTR
mdefine_line|#define HCCR_CLEAR_RISC_INTR&t;&t;0x7000
DECL|macro|HCCR_BP_ENABLE
mdefine_line|#define HCCR_BP_ENABLE&t;&t;&t;0x8000
DECL|macro|HCCR_BIOS_ENABLE
mdefine_line|#define HCCR_BIOS_ENABLE&t;&t;0x9000
DECL|macro|HCCR_TEST_MODE
mdefine_line|#define HCCR_TEST_MODE&t;&t;&t;0xf000
multiline_comment|/* mailbox commands */
DECL|macro|MBOX_NO_OP
mdefine_line|#define MBOX_NO_OP&t;&t;&t;0x0000
DECL|macro|MBOX_LOAD_RAM
mdefine_line|#define MBOX_LOAD_RAM&t;&t;&t;0x0001
DECL|macro|MBOX_EXEC_FIRMWARE
mdefine_line|#define MBOX_EXEC_FIRMWARE&t;&t;0x0002
DECL|macro|MBOX_DUMP_RAM
mdefine_line|#define MBOX_DUMP_RAM&t;&t;&t;0x0003
DECL|macro|MBOX_WRITE_RAM_WORD
mdefine_line|#define MBOX_WRITE_RAM_WORD&t;&t;0x0004
DECL|macro|MBOX_READ_RAM_WORD
mdefine_line|#define MBOX_READ_RAM_WORD&t;&t;0x0005
DECL|macro|MBOX_MAILBOX_REG_TEST
mdefine_line|#define MBOX_MAILBOX_REG_TEST&t;&t;0x0006
DECL|macro|MBOX_VERIFY_CHECKSUM
mdefine_line|#define MBOX_VERIFY_CHECKSUM&t;&t;0x0007
DECL|macro|MBOX_ABOUT_FIRMWARE
mdefine_line|#define MBOX_ABOUT_FIRMWARE&t;&t;0x0008
DECL|macro|MBOX_CHECK_FIRMWARE
mdefine_line|#define MBOX_CHECK_FIRMWARE&t;&t;0x000e
DECL|macro|MBOX_INIT_REQ_QUEUE
mdefine_line|#define MBOX_INIT_REQ_QUEUE&t;&t;0x0010
DECL|macro|MBOX_INIT_RES_QUEUE
mdefine_line|#define MBOX_INIT_RES_QUEUE&t;&t;0x0011
DECL|macro|MBOX_EXECUTE_IOCB
mdefine_line|#define MBOX_EXECUTE_IOCB&t;&t;0x0012
DECL|macro|MBOX_WAKE_UP
mdefine_line|#define MBOX_WAKE_UP&t;&t;&t;0x0013
DECL|macro|MBOX_STOP_FIRMWARE
mdefine_line|#define MBOX_STOP_FIRMWARE&t;&t;0x0014
DECL|macro|MBOX_ABORT
mdefine_line|#define MBOX_ABORT&t;&t;&t;0x0015
DECL|macro|MBOX_ABORT_DEVICE
mdefine_line|#define MBOX_ABORT_DEVICE&t;&t;0x0016
DECL|macro|MBOX_ABORT_TARGET
mdefine_line|#define MBOX_ABORT_TARGET&t;&t;0x0017
DECL|macro|MBOX_BUS_RESET
mdefine_line|#define MBOX_BUS_RESET&t;&t;&t;0x0018
DECL|macro|MBOX_STOP_QUEUE
mdefine_line|#define MBOX_STOP_QUEUE&t;&t;&t;0x0019
DECL|macro|MBOX_START_QUEUE
mdefine_line|#define MBOX_START_QUEUE&t;&t;0x001a
DECL|macro|MBOX_SINGLE_STEP_QUEUE
mdefine_line|#define MBOX_SINGLE_STEP_QUEUE&t;&t;0x001b
DECL|macro|MBOX_ABORT_QUEUE
mdefine_line|#define MBOX_ABORT_QUEUE&t;&t;0x001c
DECL|macro|MBOX_GET_DEV_QUEUE_STATUS
mdefine_line|#define MBOX_GET_DEV_QUEUE_STATUS&t;0x001d
DECL|macro|MBOX_GET_FIRMWARE_STATUS
mdefine_line|#define MBOX_GET_FIRMWARE_STATUS&t;0x001f
DECL|macro|MBOX_GET_INIT_SCSI_ID
mdefine_line|#define MBOX_GET_INIT_SCSI_ID&t;&t;0x0020
DECL|macro|MBOX_GET_SELECT_TIMEOUT
mdefine_line|#define MBOX_GET_SELECT_TIMEOUT&t;&t;0x0021
DECL|macro|MBOX_GET_RETRY_COUNT
mdefine_line|#define MBOX_GET_RETRY_COUNT&t;&t;0x0022
DECL|macro|MBOX_GET_TAG_AGE_LIMIT
mdefine_line|#define MBOX_GET_TAG_AGE_LIMIT&t;&t;0x0023
DECL|macro|MBOX_GET_CLOCK_RATE
mdefine_line|#define MBOX_GET_CLOCK_RATE&t;&t;0x0024
DECL|macro|MBOX_GET_ACT_NEG_STATE
mdefine_line|#define MBOX_GET_ACT_NEG_STATE&t;&t;0x0025
DECL|macro|MBOX_GET_ASYNC_DATA_SETUP_TIME
mdefine_line|#define MBOX_GET_ASYNC_DATA_SETUP_TIME&t;0x0026
DECL|macro|MBOX_GET_PCI_PARAMS
mdefine_line|#define MBOX_GET_PCI_PARAMS&t;&t;0x0027
DECL|macro|MBOX_GET_TARGET_PARAMS
mdefine_line|#define MBOX_GET_TARGET_PARAMS&t;&t;0x0028
DECL|macro|MBOX_GET_DEV_QUEUE_PARAMS
mdefine_line|#define MBOX_GET_DEV_QUEUE_PARAMS&t;0x0029
DECL|macro|MBOX_SET_INIT_SCSI_ID
mdefine_line|#define MBOX_SET_INIT_SCSI_ID&t;&t;0x0030
DECL|macro|MBOX_SET_SELECT_TIMEOUT
mdefine_line|#define MBOX_SET_SELECT_TIMEOUT&t;&t;0x0031
DECL|macro|MBOX_SET_RETRY_COUNT
mdefine_line|#define MBOX_SET_RETRY_COUNT&t;&t;0x0032
DECL|macro|MBOX_SET_TAG_AGE_LIMIT
mdefine_line|#define MBOX_SET_TAG_AGE_LIMIT&t;&t;0x0033
DECL|macro|MBOX_SET_CLOCK_RATE
mdefine_line|#define MBOX_SET_CLOCK_RATE&t;&t;0x0034
DECL|macro|MBOX_SET_ACTIVE_NEG_STATE
mdefine_line|#define MBOX_SET_ACTIVE_NEG_STATE&t;0x0035
DECL|macro|MBOX_SET_ASYNC_DATA_SETUP_TIME
mdefine_line|#define MBOX_SET_ASYNC_DATA_SETUP_TIME&t;0x0036
DECL|macro|MBOX_SET_PCI_CONTROL_PARAMS
mdefine_line|#define MBOX_SET_PCI_CONTROL_PARAMS&t;0x0037
DECL|macro|MBOX_SET_TARGET_PARAMS
mdefine_line|#define MBOX_SET_TARGET_PARAMS&t;&t;0x0038
DECL|macro|MBOX_SET_DEV_QUEUE_PARAMS
mdefine_line|#define MBOX_SET_DEV_QUEUE_PARAMS&t;0x0039
DECL|macro|MBOX_RETURN_BIOS_BLOCK_ADDR
mdefine_line|#define MBOX_RETURN_BIOS_BLOCK_ADDR&t;0x0040
DECL|macro|MBOX_WRITE_FOUR_RAM_WORDS
mdefine_line|#define MBOX_WRITE_FOUR_RAM_WORDS&t;0x0041
DECL|macro|MBOX_EXEC_BIOS_IOCB
mdefine_line|#define MBOX_EXEC_BIOS_IOCB&t;&t;0x0042
macro_line|#include &quot;qlogicisp_asm.c&quot;
DECL|macro|PACKB
mdefine_line|#define PACKB(a, b)&t;&t;&t;(((a)&lt;&lt;4)|(b))
DECL|variable|mbox_param
id|u_char
id|mbox_param
(braket
)braket
op_assign
(brace
id|PACKB
c_func
(paren
l_int|1
comma
l_int|1
)paren
comma
multiline_comment|/* MBOX_NO_OP */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_LOAD_RAM */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|0
)paren
comma
multiline_comment|/* MBOX_EXEC_FIRMWARE */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_DUMP_RAM */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_WRITE_RAM_WORD */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_READ_RAM_WORD */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_MAILBOX_REG_TEST */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_VERIFY_CHECKSUM&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABOUT_FIRMWARE */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0009 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000d */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_CHECK_FIRMWARE */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000f */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_INIT_REQ_QUEUE */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_INIT_RES_QUEUE */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_EXECUTE_IOCB */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_WAKE_UP&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_STOP_FIRMWARE */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_ABORT */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_ABORT_DEVICE */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABORT_TARGET */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_BUS_RESET */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_STOP_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_START_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SINGLE_STEP_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABORT_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_STATUS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x001e */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_FIRMWARE_STATUS */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_INIT_SCSI_ID */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_SELECT_TIMEOUT */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_RETRY_COUNT&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_TAG_AGE_LIMIT */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_CLOCK_RATE */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_ACT_NEG_STATE */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_ASYNC_DATA_SETUP_TIME */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_PCI_PARAMS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_TARGET_PARAMS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_PARAMS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002d */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002e */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002f */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_INIT_SCSI_ID */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_SELECT_TIMEOUT */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SET_RETRY_COUNT&t;*/
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_TAG_AGE_LIMIT */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_CLOCK_RATE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_ACTIVE_NEG_STATE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_ASYNC_DATA_SETUP_TIME */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SET_PCI_CONTROL_PARAMS */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_SET_TARGET_PARAMS */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_SET_DEV_QUEUE_PARAMS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003d */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003e */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003f */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_RETURN_BIOS_BLOCK_ADDR */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|1
)paren
comma
multiline_comment|/* MBOX_WRITE_FOUR_RAM_WORDS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
multiline_comment|/* MBOX_EXEC_BIOS_IOCB */
)brace
suffix:semicolon
DECL|macro|MAX_MBOX_COMMAND
mdefine_line|#define MAX_MBOX_COMMAND&t;(sizeof(mbox_param)/sizeof(u_short))
DECL|struct|host_param
r_struct
id|host_param
(brace
DECL|member|fifo_threshold
id|u_short
id|fifo_threshold
suffix:semicolon
DECL|member|host_adapter_enable
id|u_short
id|host_adapter_enable
suffix:semicolon
DECL|member|initiator_scsi_id
id|u_short
id|initiator_scsi_id
suffix:semicolon
DECL|member|bus_reset_delay
id|u_short
id|bus_reset_delay
suffix:semicolon
DECL|member|retry_count
id|u_short
id|retry_count
suffix:semicolon
DECL|member|retry_delay
id|u_short
id|retry_delay
suffix:semicolon
DECL|member|async_data_setup_time
id|u_short
id|async_data_setup_time
suffix:semicolon
DECL|member|req_ack_active_negation
id|u_short
id|req_ack_active_negation
suffix:semicolon
DECL|member|data_line_active_negation
id|u_short
id|data_line_active_negation
suffix:semicolon
DECL|member|data_dma_burst_enable
id|u_short
id|data_dma_burst_enable
suffix:semicolon
DECL|member|command_dma_burst_enable
id|u_short
id|command_dma_burst_enable
suffix:semicolon
DECL|member|tag_aging
id|u_short
id|tag_aging
suffix:semicolon
DECL|member|selection_timeout
id|u_short
id|selection_timeout
suffix:semicolon
DECL|member|max_queue_depth
id|u_short
id|max_queue_depth
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Device Flags:&n; *&n; * Bit  Name&n; * ---------&n; *  7   Disconnect Privilege&n; *  6   Parity Checking&n; *  5   Wide Data Transfers&n; *  4   Synchronous Data Transfers&n; *  3   Tagged Queuing&n; *  2   Automatic Request Sense&n; *  1   Stop Queue on Check Condition&n; *  0   Renegotiate on Error&n; */
DECL|struct|dev_param
r_struct
id|dev_param
(brace
DECL|member|device_flags
id|u_short
id|device_flags
suffix:semicolon
DECL|member|execution_throttle
id|u_short
id|execution_throttle
suffix:semicolon
DECL|member|synchronous_period
id|u_short
id|synchronous_period
suffix:semicolon
DECL|member|synchronous_offset
id|u_short
id|synchronous_offset
suffix:semicolon
DECL|member|device_enable
id|u_short
id|device_enable
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|REQ_QUEUE_LEN
mdefine_line|#define REQ_QUEUE_LEN&t;&t;32
DECL|macro|RES_QUEUE_LEN
mdefine_line|#define RES_QUEUE_LEN&t;&t;32
DECL|macro|QUEUE_ENTRY_LEN
mdefine_line|#define QUEUE_ENTRY_LEN&t;&t;64
DECL|struct|isp1020_hostdata
r_struct
id|isp1020_hostdata
(brace
DECL|member|irq
id|u_char
id|irq
suffix:semicolon
DECL|member|bus
id|u_char
id|bus
suffix:semicolon
DECL|member|io_base
id|u_long
id|io_base
suffix:semicolon
DECL|member|revision
id|u_char
id|revision
suffix:semicolon
DECL|member|device_fn
id|u_char
id|device_fn
suffix:semicolon
DECL|member|res_queue_in_ptr
id|u_short
id|res_queue_in_ptr
suffix:semicolon
DECL|member|res_queue_out_ptr
id|u_short
id|res_queue_out_ptr
suffix:semicolon
DECL|member|req_queue_in_ptr
id|u_short
id|req_queue_in_ptr
suffix:semicolon
DECL|member|req_queue_out_ptr
id|u_short
id|req_queue_out_ptr
suffix:semicolon
DECL|member|host_param
r_struct
id|host_param
id|host_param
suffix:semicolon
DECL|member|dev_param
r_struct
id|dev_param
id|dev_param
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|res_queue
r_char
id|res_queue
(braket
id|RES_QUEUE_LEN
)braket
(braket
id|QUEUE_ENTRY_LEN
)braket
suffix:semicolon
DECL|member|req_queue
r_char
id|req_queue
(braket
id|REQ_QUEUE_LEN
)braket
(braket
id|QUEUE_ENTRY_LEN
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|irq2host
r_struct
id|isp1020_hostdata
op_star
id|irq2host
(braket
l_int|16
)braket
suffix:semicolon
r_void
id|isp1020_enable_irqs
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_void
id|isp1020_disable_irqs
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_int
id|isp1020_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_int
id|isp1020_reset_hardware
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_int
id|isp1020_get_defaults
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_int
id|isp1020_set_defaults
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_int
id|isp1020_load_parameters
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_int
id|isp1020_mbox_command
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
comma
id|u_short
(braket
)braket
)paren
suffix:semicolon
id|u_short
id|isp1020_read_nvram_word
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
comma
id|u_short
)paren
suffix:semicolon
r_int
id|isp1020_verify_nvram
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
suffix:semicolon
r_void
id|isp1020_print_status_entry
c_func
(paren
r_struct
id|Status_Entry
op_star
)paren
suffix:semicolon
r_void
id|isp1020_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_void
id|isp1020_scsi_done
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|isp1020_return_status
c_func
(paren
r_struct
id|Status_Entry
op_star
)paren
suffix:semicolon
r_void
id|isp1020_intr_handler
c_func
(paren
r_int
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|function|isp1020_detect
r_int
id|isp1020_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tmpt
)paren
(brace
r_int
id|hosts
op_assign
l_int|0
suffix:semicolon
id|u_short
id|index
suffix:semicolon
id|u_char
id|bus
comma
id|device_fn
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsihost
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_detect&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : PCI bios not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|irq2host
comma
l_int|0
comma
r_sizeof
(paren
id|irq2host
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1020
comma
id|index
comma
op_amp
id|bus
comma
op_amp
id|device_fn
)paren
op_eq
l_int|0
suffix:semicolon
id|index
op_increment
)paren
(brace
id|scsihost
op_assign
id|scsi_register
c_func
(paren
id|tmpt
comma
r_sizeof
(paren
r_struct
id|isp1020_hostdata
)paren
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|scsihost-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|hostdata
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|isp1020_hostdata
)paren
)paren
suffix:semicolon
id|hostdata-&gt;bus
op_assign
id|bus
suffix:semicolon
id|hostdata-&gt;device_fn
op_assign
id|device_fn
suffix:semicolon
r_if
c_cond
(paren
id|isp1020_init
c_func
(paren
id|scsihost
)paren
op_logical_or
id|isp1020_reset_hardware
c_func
(paren
id|hostdata
)paren
macro_line|#if USE_NVRAM_DEFAULTS
op_logical_or
id|isp1020_get_defaults
c_func
(paren
id|hostdata
)paren
macro_line|#else
op_logical_or
id|isp1020_set_defaults
c_func
(paren
id|hostdata
)paren
macro_line|#endif /* USE_NVRAM_DEFAULTS */
op_logical_or
id|isp1020_load_parameters
c_func
(paren
id|hostdata
)paren
)paren
(brace
id|scsi_unregister
c_func
(paren
id|scsihost
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|scsihost-&gt;this_id
op_assign
id|hostdata-&gt;host_param.initiator_scsi_id
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hostdata-&gt;irq
comma
id|isp1020_intr_handler
comma
l_int|0
comma
l_string|&quot;qlogicisp&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : interrupt %d already in use&bslash;n&quot;
comma
id|hostdata-&gt;irq
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|scsihost
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hostdata-&gt;io_base
comma
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : i/o region 0x%04lx-0x%04lx already in use&bslash;n&quot;
comma
id|hostdata-&gt;io_base
comma
id|hostdata-&gt;io_base
op_plus
l_int|0xff
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hostdata-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|scsihost
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|hostdata-&gt;io_base
comma
l_int|0xff
comma
l_string|&quot;qlogicisp&quot;
)paren
suffix:semicolon
id|irq2host
(braket
id|hostdata-&gt;irq
)braket
op_assign
id|hostdata
suffix:semicolon
id|isp1020_enable_irqs
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|hosts
op_increment
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_detect&quot;
)paren
suffix:semicolon
r_return
id|hosts
suffix:semicolon
)brace
DECL|function|isp1020_release
r_int
id|isp1020_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_release&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_INTF_CTL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hostdata-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hostdata-&gt;io_base
comma
l_int|0xff
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_release&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_info
r_const
r_char
op_star
id|isp1020_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|80
)braket
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_info&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;QLogic ISP1020 SCSI on PCI bus %d, device %d, irq %d&quot;
comma
id|hostdata-&gt;bus
comma
(paren
id|hostdata-&gt;device_fn
op_amp
l_int|0xf8
)paren
op_rshift
l_int|3
comma
id|hostdata-&gt;irq
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_info&quot;
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
DECL|macro|REQ_QUEUE_DEPTH
mdefine_line|#define REQ_QUEUE_DEPTH() &bslash;&n;    (hostdata-&gt;req_queue_in_ptr &gt;= hostdata-&gt;req_queue_out_ptr &bslash;&n;        ? hostdata-&gt;req_queue_in_ptr - hostdata-&gt;req_queue_out_ptr &bslash;&n;        : (REQ_QUEUE_LEN - hostdata-&gt;req_queue_out_ptr) &bslash;&n;        + hostdata-&gt;req_queue_in_ptr)
DECL|function|isp1020_queuecommand
r_int
id|isp1020_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
id|i
comma
op_star
id|iptr
comma
id|sg_count
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_struct
id|Command_Entry
op_star
id|cmd
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_queuecommand&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|Cmnd-&gt;host-&gt;hostdata
suffix:semicolon
id|Cmnd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|DEBUG
c_func
(paren
id|isp1020_print_scsi_cmd
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
)paren
id|hostdata-&gt;req_queue_out_ptr
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hostdata-&gt;req_queue_in_ptr
op_plus
l_int|1
)paren
op_mod
id|REQ_QUEUE_LEN
op_eq
id|hostdata-&gt;req_queue_out_ptr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : request queue overflow&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : request queue depth %d&bslash;n&quot;
comma
id|REQ_QUEUE_DEPTH
c_func
(paren
)paren
)paren
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|hostdata-&gt;req_queue
(braket
id|hostdata-&gt;req_queue_in_ptr
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Command_Entry
)paren
)paren
suffix:semicolon
id|cmd-&gt;hdr.entry_type
op_assign
id|ENTRY_COMMAND
suffix:semicolon
id|cmd-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;handle
op_assign
(paren
id|caddr_t
)paren
id|Cmnd
suffix:semicolon
id|cmd-&gt;target_lun
op_assign
id|Cmnd-&gt;lun
suffix:semicolon
id|cmd-&gt;target_id
op_assign
id|Cmnd-&gt;target
suffix:semicolon
id|cmd-&gt;cdb_length
op_assign
id|Cmnd-&gt;cmd_len
suffix:semicolon
id|cmd-&gt;control_flags
op_assign
id|CFLAG_READ
op_or
id|CFLAG_WRITE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|Cmnd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|cmd-&gt;cdb
(braket
id|i
)braket
op_assign
id|Cmnd-&gt;cmnd
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
)paren
(brace
id|cmd-&gt;segment_cnt
op_assign
id|sg_count
op_assign
id|Cmnd-&gt;use_sg
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;request_buffer
suffix:semicolon
id|iptr
op_assign
(paren
r_int
op_star
)paren
op_amp
id|cmd-&gt;dataseg0.d_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sg_count
OG
l_int|0
suffix:semicolon
id|sg_count
op_decrement
comma
id|i
op_increment
)paren
(brace
op_star
id|iptr
op_increment
op_assign
(paren
r_int
)paren
id|sg
(braket
id|i
)braket
dot
id|address
suffix:semicolon
op_star
id|iptr
op_increment
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
)brace
r_else
(brace
id|cmd-&gt;dataseg0.d_base
op_assign
(paren
id|caddr_t
)paren
id|Cmnd-&gt;request_buffer
suffix:semicolon
id|cmd-&gt;dataseg0.d_count
op_assign
(paren
id|u_long
)paren
id|Cmnd-&gt;request_bufflen
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
l_int|1
suffix:semicolon
)brace
id|hostdata-&gt;req_queue_in_ptr
op_assign
(paren
id|hostdata-&gt;req_queue_in_ptr
op_plus
l_int|1
)paren
op_mod
id|REQ_QUEUE_LEN
suffix:semicolon
id|outw
c_func
(paren
id|hostdata-&gt;req_queue_in_ptr
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX4
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_queuecommand&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|RES_QUEUE_DEPTH
mdefine_line|#define RES_QUEUE_DEPTH() &bslash;&n;    (hostdata-&gt;res_queue_in_ptr &gt;= hostdata-&gt;res_queue_out_ptr &bslash;&n;        ? hostdata-&gt;res_queue_in_ptr - hostdata-&gt;res_queue_out_ptr &bslash;&n;        : (RES_QUEUE_LEN - hostdata-&gt;res_queue_out_ptr) &bslash;&n;        + hostdata-&gt;res_queue_in_ptr)
DECL|function|isp1020_abort
r_int
id|isp1020_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_abort&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|Cmnd-&gt;host-&gt;hostdata
suffix:semicolon
id|isp1020_disable_irqs
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : response queue depth %d&bslash;n&quot;
comma
id|RES_QUEUE_DEPTH
c_func
(paren
)paren
)paren
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABORT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
(paren
(paren
id|u_short
)paren
id|Cmnd-&gt;target
)paren
op_lshift
l_int|8
)paren
op_or
id|Cmnd-&gt;lun
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_long
)paren
id|Cmnd
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_long
)paren
id|Cmnd
op_amp
l_int|0xffff
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : scsi abort failure: %x&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
id|isp1020_enable_irqs
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_abort&quot;
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
DECL|function|isp1020_reset
r_int
id|isp1020_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_RESET_SUCCESS
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_reset&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|Cmnd-&gt;host-&gt;hostdata
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_BUS_RESET
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.bus_reset_delay
suffix:semicolon
id|isp1020_disable_irqs
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : scsi bus reset failure: %x&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
id|isp1020_enable_irqs
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_reset&quot;
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
DECL|function|isp1020_biosparam
r_int
id|isp1020_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
r_int
id|n
comma
r_int
id|ip
(braket
)braket
)paren
(brace
r_int
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_biosparam&quot;
)paren
suffix:semicolon
id|ip
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|ip
(braket
l_int|2
)braket
OG
l_int|1024
)paren
(brace
id|ip
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
id|ip
(braket
l_int|0
)braket
op_star
id|ip
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
(braket
l_int|2
)braket
OG
l_int|1023
)paren
id|ip
(braket
l_int|2
)braket
op_assign
l_int|1023
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_biosparam&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_reset_hardware
r_int
id|isp1020_reset_hardware
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_reset_hardware&quot;
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0001
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_INTF_CTL
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_RESET
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_RELEASE
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_BIOS_ENABLE
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX0
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
macro_line|#if DEBUG_ISP1020
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox 0 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox 1 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox 2 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox 3 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX3
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox 4 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX4
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox 5 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX5
)paren
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_ISP1020 */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : loading risc ram&bslash;n&quot;
)paren
suffix:semicolon
)paren
macro_line|#if RELOAD_FIRMWARE
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_length01
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
op_plus
id|i
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|risc_code01
(braket
id|i
)braket
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : firmware load failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif /* RELOAD_FIRMWARE */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : verifying checksum&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_VERIFY_CHECKSUM
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : ram checksum failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : executing firmware&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_EXEC_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABOUT_FIRMWARE
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : about firmware failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : firmware major revision %d&bslash;n&quot;
comma
id|param
(braket
l_int|1
)braket
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : firmware minor revision %d&bslash;n&quot;
comma
id|param
(braket
l_int|2
)braket
)paren
suffix:semicolon
)paren
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_reset_hardware&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_init
r_int
id|isp1020_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
)paren
(brace
id|u_long
id|io_base
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
id|u_char
id|bus
comma
id|device_fn
comma
id|revision
comma
id|irq
suffix:semicolon
id|u_short
id|vendor_id
comma
id|device_id
comma
id|command
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_init&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp1020_hostdata
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
id|bus
op_assign
id|hostdata-&gt;bus
suffix:semicolon
id|device_fn
op_assign
id|hostdata-&gt;device_fn
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|device_fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
op_logical_or
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|device_fn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device_id
)paren
op_logical_or
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|device_fn
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
op_logical_or
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|io_base
)paren
op_logical_or
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|device_fn
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
op_logical_or
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|irq
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : error reading PCI configuration&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_QLOGIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : 0x%04x is not QLogic vendor ID&bslash;n&quot;
comma
id|vendor_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device_id
op_ne
id|PCI_DEVICE_ID_QLOGIC_ISP1020
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : 0x%04x does not match ISP1020 device id&bslash;n&quot;
comma
id|device_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
op_amp
id|PCI_COMMAND_IO
op_logical_and
(paren
id|io_base
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
id|io_base
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : i/o mapping is disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : bus mastering is disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|revision
op_ne
id|ISP1020_REV_ID
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : warning : new isp1020 revision id&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|io_base
op_plus
id|PCI_ID_LOW
)paren
op_ne
id|PCI_VENDOR_ID_QLOGIC
op_logical_or
id|inw
c_func
(paren
id|io_base
op_plus
id|PCI_ID_HIGH
)paren
op_ne
id|PCI_DEVICE_ID_QLOGIC_ISP1020
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : can&squot;t decode i/o address space&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|hostdata-&gt;io_base
op_assign
id|io_base
suffix:semicolon
id|hostdata-&gt;revision
op_assign
id|revision
suffix:semicolon
id|hostdata-&gt;irq
op_assign
id|irq
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_init&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_get_defaults
r_int
id|isp1020_get_defaults
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_short
id|value
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_get_defaults&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isp1020_verify_nvram
c_func
(paren
id|hostdata
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : nvram checksum failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|2
)paren
suffix:semicolon
id|hostdata-&gt;host_param.fifo_threshold
op_assign
(paren
id|value
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
suffix:semicolon
id|hostdata-&gt;host_param.host_adapter_enable
op_assign
(paren
id|value
op_rshift
l_int|11
)paren
op_amp
l_int|0x01
suffix:semicolon
id|hostdata-&gt;host_param.initiator_scsi_id
op_assign
(paren
id|value
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|3
)paren
suffix:semicolon
id|hostdata-&gt;host_param.bus_reset_delay
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|hostdata-&gt;host_param.retry_count
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|4
)paren
suffix:semicolon
id|hostdata-&gt;host_param.retry_delay
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|hostdata-&gt;host_param.async_data_setup_time
op_assign
(paren
id|value
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|hostdata-&gt;host_param.req_ack_active_negation
op_assign
(paren
id|value
op_rshift
l_int|12
)paren
op_amp
l_int|0x01
suffix:semicolon
id|hostdata-&gt;host_param.data_line_active_negation
op_assign
(paren
id|value
op_rshift
l_int|13
)paren
op_amp
l_int|0x01
suffix:semicolon
id|hostdata-&gt;host_param.data_dma_burst_enable
op_assign
(paren
id|value
op_rshift
l_int|14
)paren
op_amp
l_int|0x01
suffix:semicolon
id|hostdata-&gt;host_param.command_dma_burst_enable
op_assign
(paren
id|value
op_rshift
l_int|15
)paren
suffix:semicolon
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|5
)paren
suffix:semicolon
id|hostdata-&gt;host_param.tag_aging
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|6
)paren
suffix:semicolon
id|hostdata-&gt;host_param.selection_timeout
op_assign
id|value
op_amp
l_int|0xffff
suffix:semicolon
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|7
)paren
suffix:semicolon
id|hostdata-&gt;host_param.max_queue_depth
op_assign
id|value
op_amp
l_int|0xffff
suffix:semicolon
macro_line|#if DEBUG_ISP1020_SETUP
id|printk
c_func
(paren
l_string|&quot;qlogicisp : fifo threshold=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.fifo_threshold
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : initiator scsi id=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.initiator_scsi_id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : bus reset delay=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.bus_reset_delay
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : retry count=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.retry_count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : retry delay=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.retry_delay
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : async data setup time=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.async_data_setup_time
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : req/ack active negation=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.req_ack_active_negation
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : data line active negation=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.data_line_active_negation
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : data DMA burst enable=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.data_dma_burst_enable
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : command DMA burst enable=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.command_dma_burst_enable
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : tag age limit=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.tag_aging
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : selection timeout limit=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.selection_timeout
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : max queue depth=%d&bslash;n&quot;
comma
id|hostdata-&gt;host_param.max_queue_depth
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_ISP1020_SETUP */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|14
op_plus
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|execution_throttle
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
l_int|15
op_plus
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_assign
(paren
id|value
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_enable
op_assign
(paren
id|value
op_rshift
l_int|12
)paren
op_amp
l_int|0x01
suffix:semicolon
macro_line|#if DEBUG_ISP1020_SETUP
id|printk
c_func
(paren
l_string|&quot;qlogicisp : target 0x%02x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp :     device flags=0x%02x&bslash;n&quot;
comma
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp :     execution throttle=%d&bslash;n&quot;
comma
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|execution_throttle
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp :     synchronous period=%d&bslash;n&quot;
comma
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp :     synchronous offset=%d&bslash;n&quot;
comma
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp :     device enable=%d&bslash;n&quot;
comma
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_enable
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_ISP1020_SETUP */
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_get_defaults&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_set_defaults
r_int
id|isp1020_set_defaults
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
r_int
id|i
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_set_defaults&quot;
)paren
suffix:semicolon
id|hostdata-&gt;host_param.fifo_threshold
op_assign
l_int|2
suffix:semicolon
id|hostdata-&gt;host_param.host_adapter_enable
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;host_param.initiator_scsi_id
op_assign
l_int|7
suffix:semicolon
id|hostdata-&gt;host_param.bus_reset_delay
op_assign
l_int|3
suffix:semicolon
id|hostdata-&gt;host_param.retry_count
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;host_param.retry_delay
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;host_param.async_data_setup_time
op_assign
l_int|6
suffix:semicolon
id|hostdata-&gt;host_param.req_ack_active_negation
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;host_param.data_line_active_negation
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;host_param.data_dma_burst_enable
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;host_param.command_dma_burst_enable
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;host_param.tag_aging
op_assign
l_int|8
suffix:semicolon
id|hostdata-&gt;host_param.selection_timeout
op_assign
l_int|250
suffix:semicolon
id|hostdata-&gt;host_param.max_queue_depth
op_assign
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_assign
l_int|0xc4
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|execution_throttle
op_assign
l_int|16
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
op_assign
l_int|25
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_assign
l_int|12
suffix:semicolon
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_enable
op_assign
l_int|1
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_set_defaults&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_load_parameters
r_int
id|isp1020_load_parameters
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
r_int
id|i
comma
id|k
suffix:semicolon
id|u_long
id|queue_addr
suffix:semicolon
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
id|u_short
id|isp_cfg1
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp1020_load_parameters&quot;
)paren
suffix:semicolon
id|outw
c_func
(paren
id|hostdata-&gt;host_param.fifo_threshold
comma
id|hostdata-&gt;io_base
op_plus
id|ISP_CFG1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_INIT_SCSI_ID
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.initiator_scsi_id
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set initiator id failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_RETRY_COUNT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.retry_count
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|hostdata-&gt;host_param.retry_delay
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set retry count failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_ASYNC_DATA_SETUP_TIME
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.async_data_setup_time
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : async data setup time failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_ACTIVE_NEG_STATE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|hostdata-&gt;host_param.req_ack_active_negation
op_lshift
l_int|4
)paren
op_or
(paren
id|hostdata-&gt;host_param.data_line_active_negation
op_lshift
l_int|5
)paren
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set active negation state failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_PCI_CONTROL_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.data_dma_burst_enable
op_lshift
l_int|1
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|hostdata-&gt;host_param.command_dma_burst_enable
op_lshift
l_int|1
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set pci control parameter failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|isp_cfg1
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|ISP_CFG1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;host_param.data_dma_burst_enable
op_logical_or
id|hostdata-&gt;host_param.command_dma_burst_enable
)paren
id|isp_cfg1
op_or_assign
l_int|0x0004
suffix:semicolon
r_else
id|isp_cfg1
op_and_assign
l_int|0xfffb
suffix:semicolon
id|outw
c_func
(paren
id|isp_cfg1
comma
id|hostdata-&gt;io_base
op_plus
id|ISP_CFG1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TAG_AGE_LIMIT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.tag_aging
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set tag age limit failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_SELECT_TIMEOUT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|hostdata-&gt;host_param.selection_timeout
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set selection timeout failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_enable
)paren
r_continue
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TARGET_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|i
op_lshift
l_int|8
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_lshift
l_int|8
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_lshift
l_int|8
)paren
op_or
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set target parameter failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_DEV_QUEUE_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
op_or
id|k
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|hostdata-&gt;host_param.max_queue_depth
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
id|hostdata-&gt;dev_param
(braket
id|i
)braket
dot
id|execution_throttle
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set device queue parameter failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|queue_addr
op_assign
(paren
id|u_long
)paren
op_amp
id|hostdata-&gt;res_queue
(braket
l_int|0
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_RES_QUEUE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|RES_QUEUE_LEN
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|queue_addr
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|queue_addr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set response queue failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|queue_addr
op_assign
(paren
id|u_long
)paren
op_amp
id|hostdata-&gt;req_queue
(braket
l_int|0
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_REQ_QUEUE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|REQ_QUEUE_LEN
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|queue_addr
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|queue_addr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|isp1020_mbox_command
c_func
(paren
id|hostdata
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : set request queue failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_load_parameters&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp1020_mbox_command
r_int
id|isp1020_mbox_command
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
comma
id|u_short
id|param
(braket
)braket
)paren
(brace
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
op_amp
l_int|0x0080
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_rshift
l_int|4
)paren
(brace
r_case
l_int|6
suffix:colon
id|outw
c_func
(paren
id|param
(braket
l_int|5
)braket
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX5
)paren
suffix:semicolon
r_case
l_int|5
suffix:colon
id|outw
c_func
(paren
id|param
(braket
l_int|4
)braket
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX4
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
id|outw
c_func
(paren
id|param
(braket
l_int|3
)braket
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX3
)paren
suffix:semicolon
r_case
l_int|3
suffix:colon
id|outw
c_func
(paren
id|param
(braket
l_int|2
)braket
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX2
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|outw
c_func
(paren
id|param
(braket
l_int|1
)braket
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX1
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|outw
c_func
(paren
id|param
(braket
l_int|0
)braket
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX0
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|HCCR_CLEAR_RISC_INTR
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_SET_HOST_INTR
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|PCI_INTF_STS
)paren
op_amp
l_int|0x04
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX0
)paren
op_eq
l_int|0x04
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_CLEAR_RISC_INTR
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|6
suffix:colon
id|param
(braket
l_int|5
)braket
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX5
)paren
suffix:semicolon
r_case
l_int|5
suffix:colon
id|param
(braket
l_int|4
)braket
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX4
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
id|param
(braket
l_int|3
)braket
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX3
)paren
suffix:semicolon
r_case
l_int|3
suffix:colon
id|param
(braket
l_int|2
)braket
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX2
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|param
(braket
l_int|1
)braket
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX1
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|param
(braket
l_int|0
)braket
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|RESPONSE_QUEUE_UPDATE
mdefine_line|#define RESPONSE_QUEUE_UPDATE&t;0x01
DECL|function|isp1020_intr_handler
r_void
id|isp1020_intr_handler
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|Scsi_Cmnd
op_star
id|Cmnd
suffix:semicolon
r_struct
id|Status_Entry
op_star
id|sts
suffix:semicolon
r_struct
id|Marker_Entry
op_star
id|marker
suffix:semicolon
id|u_short
id|status
comma
id|add_marker
op_assign
l_int|0
suffix:semicolon
r_struct
id|isp1020_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER_INTR
c_func
(paren
l_string|&quot;isp1020_intr_handler&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hostdata
op_assign
id|irq2host
(braket
id|irq
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : unexpected interrupt on line %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : interrupt on line %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)paren
r_while
c_loop
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|PCI_INTF_STS
)paren
op_amp
l_int|0x04
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|hostdata-&gt;res_queue_in_ptr
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX5
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_CLEAR_RISC_INTR
comma
id|hostdata-&gt;io_base
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RESPONSE_QUEUE_UPDATE
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : response queue update&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : response queue depth %d&bslash;n&quot;
comma
id|RES_QUEUE_DEPTH
c_func
(paren
)paren
)paren
suffix:semicolon
)paren
r_while
c_loop
(paren
id|hostdata-&gt;res_queue_out_ptr
op_ne
id|hostdata-&gt;res_queue_in_ptr
)paren
(brace
id|sts
op_assign
(paren
r_struct
id|Status_Entry
op_star
)paren
op_amp
id|hostdata-&gt;res_queue
(braket
id|hostdata-&gt;res_queue_out_ptr
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|Cmnd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|sts-&gt;handle
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;completion_status
op_eq
id|CS_RESET_OCCURRED
op_logical_or
id|sts-&gt;completion_status
op_eq
id|CS_ABORTED
op_logical_or
(paren
id|sts-&gt;status_flags
op_amp
id|STF_BUS_RESET
)paren
)paren
id|add_marker
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
id|memcpy
c_func
(paren
id|Cmnd-&gt;sense_buffer
comma
id|sts-&gt;req_sense_data
comma
r_sizeof
(paren
id|Cmnd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DEBUG_INTR
c_func
(paren
id|isp1020_print_status_entry
c_func
(paren
id|sts
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|sts-&gt;hdr.entry_type
op_eq
id|ENTRY_STATUS
)paren
id|Cmnd-&gt;result
op_assign
id|isp1020_return_status
c_func
(paren
id|sts
)paren
suffix:semicolon
r_else
id|Cmnd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|hostdata-&gt;res_queue_out_ptr
op_assign
(paren
id|hostdata-&gt;res_queue_out_ptr
op_plus
l_int|1
)paren
op_mod
id|RES_QUEUE_LEN
suffix:semicolon
id|outw
c_func
(paren
id|hostdata-&gt;res_queue_out_ptr
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX5
)paren
suffix:semicolon
(paren
id|Cmnd-&gt;scsi_done
)paren
(paren
id|Cmnd
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox completion&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|status
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|MBOX0
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : mbox completion status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)paren
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|ASYNC_SCSI_BUS_RESET
suffix:colon
r_case
id|EXECUTION_TIMEOUT_RESET
suffix:colon
id|add_marker
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INVALID_COMMAND
suffix:colon
r_case
id|HOST_INTERFACE_ERROR
suffix:colon
r_case
id|COMMAND_ERROR
suffix:colon
r_case
id|COMMAND_PARAM_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : bad mailbox return status&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|add_marker
)paren
(brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : adding marker entry&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
(paren
id|hostdata-&gt;req_queue_in_ptr
op_plus
l_int|1
)paren
op_mod
id|REQ_QUEUE_LEN
op_eq
id|hostdata-&gt;req_queue_out_ptr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicisp : request queue overflow&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|marker
op_assign
(paren
r_struct
id|Marker_Entry
op_star
)paren
op_amp
id|hostdata-&gt;req_queue
(braket
id|hostdata-&gt;req_queue_in_ptr
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|marker
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Marker_Entry
)paren
)paren
suffix:semicolon
id|marker-&gt;hdr.entry_type
op_assign
id|ENTRY_MARKER
suffix:semicolon
id|marker-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|marker-&gt;modifier
op_assign
id|SYNC_ALL
suffix:semicolon
id|hostdata-&gt;req_queue_in_ptr
op_assign
(paren
id|hostdata-&gt;req_queue_in_ptr
op_plus
l_int|1
)paren
op_mod
id|REQ_QUEUE_LEN
suffix:semicolon
id|outw
c_func
(paren
id|hostdata-&gt;req_queue_in_ptr
comma
id|hostdata-&gt;io_base
op_plus
id|MBOX4
)paren
suffix:semicolon
)brace
id|LEAVE_INTR
c_func
(paren
l_string|&quot;isp1020_intr_handler&quot;
)paren
suffix:semicolon
)brace
DECL|macro|NVRAM_DELAY
mdefine_line|#define NVRAM_DELAY() { &bslash;&n;    int counter = 0; while (counter++ &lt; 0xc8) barrier(); }
DECL|function|isp1020_read_nvram_word
id|u_short
id|isp1020_read_nvram_word
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
comma
id|u_short
id|byte
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_short
id|value
comma
id|output
comma
id|input
suffix:semicolon
id|byte
op_and_assign
l_int|0x3f
suffix:semicolon
id|byte
op_or_assign
l_int|0x0180
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|output
op_assign
(paren
(paren
id|byte
op_rshift
id|i
)paren
op_amp
l_int|0x1
)paren
ques
c_cond
l_int|0x4
suffix:colon
l_int|0x0
suffix:semicolon
id|outw
c_func
(paren
id|output
op_or
l_int|0x2
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|output
op_or
l_int|0x3
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|output
op_or
l_int|0x2
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf
comma
id|value
op_assign
l_int|0
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|value
op_assign
id|value
op_lshift
l_int|0x1
suffix:semicolon
id|outw
c_func
(paren
l_int|0x3
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|input
op_assign
id|inw
c_func
(paren
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x2
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input
op_amp
l_int|0x8
)paren
id|value
op_or_assign
l_int|0x1
suffix:semicolon
)brace
id|outw
c_func
(paren
l_int|0x0
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
DECL|macro|ISP1020_NVRAM_LEN
mdefine_line|#define ISP1020_NVRAM_LEN&t;0x40
DECL|macro|ISP1020_NVRAM_SIG1
mdefine_line|#define ISP1020_NVRAM_SIG1&t;0x5349
DECL|macro|ISP1020_NVRAM_SIG2
mdefine_line|#define ISP1020_NVRAM_SIG2&t;0x2050
DECL|function|isp1020_verify_nvram
r_int
id|isp1020_verify_nvram
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_short
id|value
suffix:semicolon
id|u_char
id|checksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISP1020_NVRAM_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|value
op_assign
id|isp1020_read_nvram_word
c_func
(paren
id|hostdata
comma
id|i
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|value
op_ne
id|ISP1020_NVRAM_SIG1
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|value
op_ne
id|ISP1020_NVRAM_SIG2
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
(paren
id|value
op_amp
l_int|0xff
)paren
op_ne
l_int|0x02
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|checksum
op_add_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|checksum
op_add_assign
id|value
op_rshift
l_int|8
suffix:semicolon
)brace
r_return
(paren
id|checksum
op_eq
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|isp1020_enable_irqs
r_void
id|isp1020_enable_irqs
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
id|outw
c_func
(paren
l_int|0x6
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_INTF_CTL
)paren
suffix:semicolon
)brace
DECL|function|isp1020_disable_irqs
r_void
id|isp1020_disable_irqs
c_func
(paren
r_struct
id|isp1020_hostdata
op_star
id|hostdata
)paren
(brace
id|outw
c_func
(paren
l_int|0x0
comma
id|hostdata-&gt;io_base
op_plus
id|PCI_INTF_CTL
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG_ISP1020_INTR
DECL|function|isp1020_print_status_entry
r_void
id|isp1020_print_status_entry
c_func
(paren
r_struct
id|Status_Entry
op_star
id|status
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : entry count = 0x%02x, type = 0x%02x, flags = 0x%02x&bslash;n&quot;
comma
id|status-&gt;hdr.entry_cnt
comma
id|status-&gt;hdr.entry_type
comma
id|status-&gt;hdr.flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : scsi status = 0x%04x, completion status = 0x%04x&bslash;n&quot;
comma
id|status-&gt;scsi_status
comma
id|status-&gt;completion_status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : state flags = 0x%04x, status flags = 0x%04x&bslash;n&quot;
comma
id|status-&gt;state_flags
comma
id|status-&gt;status_flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : time = 0x%04x, request sense length = 0x%04x&bslash;n&quot;
comma
id|status-&gt;time
comma
id|status-&gt;req_sense_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : residual transfer length = 0x%08lx&bslash;n&quot;
comma
id|status-&gt;residual
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|status-&gt;req_sense_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : sense data = 0x%02x&bslash;n&quot;
comma
id|status-&gt;req_sense_data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif /* DEBUG_ISP1020_INTR */
macro_line|#if DEBUG_ISP1020
DECL|function|isp1020_print_scsi_cmd
r_void
id|isp1020_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : target = 0x%02x, lun = 0x%02x, cmd_len = 0x%02x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : command = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* DEBUG_ISP1020 */
DECL|function|isp1020_return_status
r_int
id|isp1020_return_status
c_func
(paren
r_struct
id|Status_Entry
op_star
id|sts
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
macro_line|#if DEBUG_ISP1020_INTR
r_static
r_char
op_star
id|reason
(braket
)braket
op_assign
(brace
l_string|&quot;DID_OK&quot;
comma
l_string|&quot;DID_NO_CONNECT&quot;
comma
l_string|&quot;DID_BUS_BUSY&quot;
comma
l_string|&quot;DID_TIME_OUT&quot;
comma
l_string|&quot;DID_BAD_TARGET&quot;
comma
l_string|&quot;DID_ABORT&quot;
comma
l_string|&quot;DID_PARITY&quot;
comma
l_string|&quot;DID_ERROR&quot;
comma
l_string|&quot;DID_RESET&quot;
comma
l_string|&quot;DID_BAD_INTR&quot;
)brace
suffix:semicolon
macro_line|#endif /* DEBUG_ISP1020_INTR */
id|ENTER
c_func
(paren
l_string|&quot;isp1020_return_status&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : completion status = 0x%04x&bslash;n&quot;
comma
id|sts-&gt;completion_status
)paren
suffix:semicolon
)paren
r_switch
c_cond
(paren
id|sts-&gt;completion_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_INCOMPLETE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_BUS
)paren
)paren
id|host_status
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_TARGET
)paren
)paren
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_SENT_CDB
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_TRANSFERRED_DATA
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_STATUS
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DMA_ERROR
suffix:colon
r_case
id|CS_TRANSPORT_ERROR
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET_OCCURRED
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
r_case
id|CS_COMMAND_OVERRUN
suffix:colon
r_case
id|CS_STATUS_OVERRUN
suffix:colon
r_case
id|CS_BAD_MESSAGE
suffix:colon
r_case
id|CS_NO_MESSAGE_OUT
suffix:colon
r_case
id|CS_EXT_ID_FAILED
suffix:colon
r_case
id|CS_IDE_MSG_FAILED
suffix:colon
r_case
id|CS_ABORT_MSG_FAILED
suffix:colon
r_case
id|CS_NOP_MSG_FAILED
suffix:colon
r_case
id|CS_PARITY_ERROR_MSG_FAILED
suffix:colon
r_case
id|CS_DEVICE_RESET_MSG_FAILED
suffix:colon
r_case
id|CS_ID_MSG_FAILED
suffix:colon
r_case
id|CS_UNEXP_BUS_FREE
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicisp : unknown completion status 0x%04x&bslash;n&quot;
comma
id|sts-&gt;completion_status
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicisp : host status (%s) scsi status %x&bslash;n&quot;
comma
id|reason
(braket
id|host_status
)braket
comma
id|sts-&gt;scsi_status
)paren
suffix:semicolon
)paren
id|LEAVE
c_func
(paren
l_string|&quot;isp1020_return_status&quot;
)paren
suffix:semicolon
r_return
(paren
id|sts-&gt;scsi_status
op_amp
id|STATUS_MASK
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
macro_line|#if MODULE
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|ISP1020
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif /* MODULE */
eof
