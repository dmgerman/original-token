multiline_comment|/* qlogicpti.c: Performance Technologies QlogicISP sbus card driver.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caipfs.rutgers.edu)&n; *&n; * A lot of this driver was directly stolen from Erik H. Moe&squot;s PCI&n; * Qlogic ISP driver.  Mucho kudos to him for this code.&n; *&n; * An even bigger kudos to John Grana at Performance Technologies&n; * for providing me with the hardware to write this driver, you rule&n; * John you really do.&n; *&n; * May, 2, 1997: Added support for QLGC,isp --jj&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;qlogicpti.h&quot;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/module.h&gt;
DECL|macro|MAX_TARGETS
mdefine_line|#define MAX_TARGETS&t;16
DECL|macro|MAX_LUNS
mdefine_line|#define MAX_LUNS&t;8&t;/* 32 for 1.31 F/W */
DECL|macro|DEFAULT_LOOP_COUNT
mdefine_line|#define DEFAULT_LOOP_COUNT&t;10000
macro_line|#include &quot;qlogicpti_asm.c&quot;
DECL|variable|qptichain
r_static
r_struct
id|qlogicpti
op_star
id|qptichain
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|qptichain_lock
r_static
id|spinlock_t
id|qptichain_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|qptis_running
r_static
r_int
id|qptis_running
op_assign
l_int|0
suffix:semicolon
DECL|macro|PACKB
mdefine_line|#define PACKB(a, b)&t;&t;&t;(((a)&lt;&lt;4)|(b))
DECL|variable|mbox_param
r_const
id|u_char
id|mbox_param
(braket
)braket
op_assign
(brace
id|PACKB
c_func
(paren
l_int|1
comma
l_int|1
)paren
comma
multiline_comment|/* MBOX_NO_OP */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_LOAD_RAM */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|0
)paren
comma
multiline_comment|/* MBOX_EXEC_FIRMWARE */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_DUMP_RAM */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_WRITE_RAM_WORD */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_READ_RAM_WORD */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_MAILBOX_REG_TEST */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_VERIFY_CHECKSUM&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABOUT_FIRMWARE */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0009 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000d */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_CHECK_FIRMWARE */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000f */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_INIT_REQ_QUEUE */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_INIT_RES_QUEUE */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_EXECUTE_IOCB */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_WAKE_UP&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_STOP_FIRMWARE */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_ABORT */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_ABORT_DEVICE */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABORT_TARGET */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_BUS_RESET */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_STOP_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_START_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SINGLE_STEP_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABORT_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_STATUS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x001e */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_FIRMWARE_STATUS */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_INIT_SCSI_ID */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_SELECT_TIMEOUT */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_RETRY_COUNT&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_TAG_AGE_LIMIT */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_CLOCK_RATE */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_ACT_NEG_STATE */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_ASYNC_DATA_SETUP_TIME */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_SBUS_PARAMS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_TARGET_PARAMS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_PARAMS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002d */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002e */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002f */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_INIT_SCSI_ID */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_SELECT_TIMEOUT */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SET_RETRY_COUNT&t;*/
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_TAG_AGE_LIMIT */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_CLOCK_RATE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_ACTIVE_NEG_STATE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_ASYNC_DATA_SETUP_TIME */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SET_SBUS_CONTROL_PARAMS */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_SET_TARGET_PARAMS */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_SET_DEV_QUEUE_PARAMS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003d */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003e */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003f */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0040 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0041 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
multiline_comment|/* 0x0042 */
)brace
suffix:semicolon
DECL|macro|MAX_MBOX_COMMAND
mdefine_line|#define MAX_MBOX_COMMAND&t;(sizeof(mbox_param)/sizeof(u_short))
multiline_comment|/* queue length&squot;s _must_ be power of two: */
DECL|macro|QUEUE_DEPTH
mdefine_line|#define QUEUE_DEPTH(in, out, ql)&t;((in - out) &amp; (ql))
DECL|macro|REQ_QUEUE_DEPTH
mdefine_line|#define REQ_QUEUE_DEPTH(in, out)&t;QUEUE_DEPTH(in, out, &t;&t;     &bslash;&n;&t;&t;&t;&t;&t;&t;    QLOGICPTI_REQ_QUEUE_LEN)
DECL|macro|RES_QUEUE_DEPTH
mdefine_line|#define RES_QUEUE_DEPTH(in, out)&t;QUEUE_DEPTH(in, out, RES_QUEUE_LEN)
DECL|function|qlogicpti_enable_irqs
r_static
r_inline
r_void
id|qlogicpti_enable_irqs
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|sbus_writew
c_func
(paren
id|SBUS_CTRL_ERIRQ
op_or
id|SBUS_CTRL_GENAB
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_disable_irqs
r_static
r_inline
r_void
id|qlogicpti_disable_irqs
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|sbus_writew
c_func
(paren
l_int|0
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
suffix:semicolon
)brace
DECL|function|set_sbus_cfg1
r_static
r_inline
r_void
id|set_sbus_cfg1
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|u16
id|val
suffix:semicolon
id|u8
id|bursts
op_assign
id|qpti-&gt;bursts
suffix:semicolon
macro_line|#if 0&t;/* It appears that at least PTI cards do not support&n;&t; * 64-byte bursts and that setting the B64 bit actually&n;&t; * is a nop and the chip ends up using the smallest burst&n;&t; * size. -DaveM&n;&t; */
r_if
c_cond
(paren
id|sbus_can_burst64
c_func
(paren
id|qpti-&gt;sdev
)paren
op_logical_and
(paren
id|bursts
op_amp
id|DMA_BURST64
)paren
)paren
(brace
id|val
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B64
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST32
)paren
(brace
id|val
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B32
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST16
)paren
(brace
id|val
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST8
)paren
(brace
id|val
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B8
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No sbus bursts for you... */
)brace
id|sbus_writew
c_func
(paren
id|val
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CFG1
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_mbox_command
r_static
r_int
id|qlogicpti_mbox_command
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
comma
id|u_short
id|param
(braket
)braket
comma
r_int
id|force
)paren
(brace
r_int
id|loop_count
suffix:semicolon
id|u16
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Set SBUS semaphore. */
id|tmp
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
id|tmp
op_or_assign
id|SBUS_SEMAPHORE_LCK
suffix:semicolon
id|sbus_writew
c_func
(paren
id|tmp
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
multiline_comment|/* Wait for host IRQ bit to clear. */
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
op_amp
id|HCCTRL_HIRQ
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command loop timeout #1&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Write mailbox command registers. */
r_switch
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_rshift
l_int|4
)paren
(brace
r_case
l_int|6
suffix:colon
id|sbus_writew
c_func
(paren
id|param
(braket
l_int|5
)braket
comma
id|qpti-&gt;qregs
op_plus
id|MBOX5
)paren
suffix:semicolon
r_case
l_int|5
suffix:colon
id|sbus_writew
c_func
(paren
id|param
(braket
l_int|4
)braket
comma
id|qpti-&gt;qregs
op_plus
id|MBOX4
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
id|sbus_writew
c_func
(paren
id|param
(braket
l_int|3
)braket
comma
id|qpti-&gt;qregs
op_plus
id|MBOX3
)paren
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sbus_writew
c_func
(paren
id|param
(braket
l_int|2
)braket
comma
id|qpti-&gt;qregs
op_plus
id|MBOX2
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sbus_writew
c_func
(paren
id|param
(braket
l_int|1
)braket
comma
id|qpti-&gt;qregs
op_plus
id|MBOX1
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sbus_writew
c_func
(paren
id|param
(braket
l_int|0
)braket
comma
id|qpti-&gt;qregs
op_plus
id|MBOX0
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear RISC interrupt. */
id|tmp
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|HCCTRL_CRIRQ
suffix:semicolon
id|sbus_writew
c_func
(paren
id|tmp
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Clear SBUS semaphore. */
id|sbus_writew
c_func
(paren
l_int|0
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
multiline_comment|/* Set HOST interrupt. */
id|tmp
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|HCCTRL_SHIRQ
suffix:semicolon
id|sbus_writew
c_func
(paren
id|tmp
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Wait for HOST interrupt clears. */
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
op_amp
id|HCCTRL_CRIRQ
)paren
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command[%04x] loop timeout #2&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Wait for SBUS semaphore to get set. */
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
op_logical_neg
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
op_amp
id|SBUS_SEMAPHORE_LCK
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Workaround for some buggy chips. */
r_if
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX0
)paren
op_amp
l_int|0x4000
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command[%04x] loop timeout #3&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Wait for MBOX busy condition to go away. */
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX0
)paren
op_eq
l_int|0x04
)paren
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command[%04x] loop timeout #4&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Read back output parameters. */
r_switch
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|6
suffix:colon
id|param
(braket
l_int|5
)braket
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX5
)paren
suffix:semicolon
r_case
l_int|5
suffix:colon
id|param
(braket
l_int|4
)braket
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX4
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
id|param
(braket
l_int|3
)braket
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX3
)paren
suffix:semicolon
r_case
l_int|3
suffix:colon
id|param
(braket
l_int|2
)braket
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX2
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|param
(braket
l_int|1
)braket
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX1
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|param
(braket
l_int|0
)braket
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX0
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear RISC interrupt. */
id|tmp
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|HCCTRL_CRIRQ
suffix:semicolon
id|sbus_writew
c_func
(paren
id|tmp
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Release SBUS semaphore. */
id|tmp
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|SBUS_SEMAPHORE_LCK
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|tmp
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
multiline_comment|/* We&squot;re done. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_set_hostdev_defaults
r_static
r_inline
r_void
id|qlogicpti_set_hostdev_defaults
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_int
id|i
suffix:semicolon
id|qpti-&gt;host_param.initiator_scsi_id
op_assign
id|qpti-&gt;scsi_id
suffix:semicolon
id|qpti-&gt;host_param.bus_reset_delay
op_assign
l_int|3
suffix:semicolon
id|qpti-&gt;host_param.retry_count
op_assign
l_int|0
suffix:semicolon
id|qpti-&gt;host_param.retry_delay
op_assign
l_int|5
suffix:semicolon
id|qpti-&gt;host_param.async_data_setup_time
op_assign
l_int|3
suffix:semicolon
id|qpti-&gt;host_param.req_ack_active_negation
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.data_line_active_negation
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.data_dma_burst_enable
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.command_dma_burst_enable
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.tag_aging
op_assign
l_int|8
suffix:semicolon
id|qpti-&gt;host_param.selection_timeout
op_assign
l_int|250
suffix:semicolon
id|qpti-&gt;host_param.max_queue_depth
op_assign
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * disconnect, parity, arq, reneg on reset, and, oddly enough&n;&t;&t; * tags...the midlayer&squot;s notion of tagged support has to match&n;&t;&t; * our device settings, and since we base whether we enable a&n;&t;&t; * tag on a  per-cmnd basis upon what the midlayer sez, we&n;&t;&t; * actually enable the capability here.&n;&t;&t; */
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_assign
l_int|0xcd
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|execution_throttle
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;ultra
)paren
(brace
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
op_assign
l_int|12
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
op_assign
l_int|25
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_assign
l_int|12
suffix:semicolon
)brace
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_enable
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* this is very important to set! */
id|qpti-&gt;sbits
op_assign
l_int|1
op_lshift
id|qpti-&gt;scsi_id
suffix:semicolon
)brace
DECL|function|qlogicpti_reset_hardware
r_static
r_int
id|qlogicpti_reset_hardware
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|risc_code_addr
suffix:semicolon
r_int
id|loop_count
comma
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|risc_code_addr
op_assign
l_int|0x1000
suffix:semicolon
multiline_comment|/* all load addresses are at 0x1000 */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|HCCTRL_PAUSE
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Only reset the scsi bus if it is not free. */
r_if
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|CPU_PCTRL
)paren
op_amp
id|CPU_PCTRL_BSY
)paren
(brace
id|sbus_writew
c_func
(paren
id|CPU_ORIDE_RMOD
comma
id|qpti-&gt;qregs
op_plus
id|CPU_ORIDE
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|CPU_CMD_BRESET
comma
id|qpti-&gt;qregs
op_plus
id|CPU_CMD
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
id|SBUS_CTRL_RESET
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
comma
id|qpti-&gt;qregs
op_plus
id|CMD_DMA_CTRL
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
comma
id|qpti-&gt;qregs
op_plus
id|DATA_DMA_CTRL
)paren
suffix:semicolon
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX0
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0x04
)paren
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: reset_hardware loop timeout&bslash;n&quot;
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|HCCTRL_PAUSE
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
id|set_sbus_cfg1
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|qlogicpti_enable_irqs
c_func
(paren
id|qpti
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|RISC_PSR
)paren
op_amp
id|RISC_PSR_ULTRA
)paren
(brace
id|qpti-&gt;ultra
op_assign
l_int|1
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|RISC_MTREG_P0ULTRA
op_or
id|RISC_MTREG_P1ULTRA
)paren
comma
id|qpti-&gt;qregs
op_plus
id|RISC_MTREG
)paren
suffix:semicolon
)brace
r_else
(brace
id|qpti-&gt;ultra
op_assign
l_int|0
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|RISC_MTREG_P0DFLT
op_or
id|RISC_MTREG_P1DFLT
)paren
comma
id|qpti-&gt;qregs
op_plus
id|RISC_MTREG
)paren
suffix:semicolon
)brace
multiline_comment|/* reset adapter and per-device default values. */
multiline_comment|/* do it after finding out whether we&squot;re ultra mode capable */
id|qlogicpti_set_hostdev_defaults
c_func
(paren
id|qpti
)paren
suffix:semicolon
multiline_comment|/* Release the RISC processor. */
id|sbus_writew
c_func
(paren
id|HCCTRL_REL
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Get RISC to start executing the firmware code. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_EXEC_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot execute ISP firmware.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set initiator scsi ID. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_INIT_SCSI_ID
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.initiator_scsi_id
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot set initiator SCSI ID.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Initialize state of the queues, both hw and sw. */
id|qpti-&gt;req_in_ptr
op_assign
id|qpti-&gt;res_out_ptr
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_RES_QUEUE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|RES_QUEUE_LEN
op_plus
l_int|1
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;res_dvma
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;res_dvma
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot init response queue.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_REQ_QUEUE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|QLOGICPTI_REQ_QUEUE_LEN
op_plus
l_int|1
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;req_dvma
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;req_dvma
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot init request queue.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_RETRY_COUNT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.retry_count
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|qpti-&gt;host_param.retry_delay
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TAG_AGE_LIMIT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.tag_aging
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_DEV_QUEUE_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_FIRMWARE_STATUS
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_SELECT_TIMEOUT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.selection_timeout
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TARGET_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Since we&squot;re now loading 1.31 f/w, force narrow/async.&n;&t;&t; */
id|param
(braket
l_int|2
)braket
op_or_assign
l_int|0xc0
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no offset, we do not have sync mode yet */
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always (sigh) do an initial bus reset (kicks f/w).&n;&t; */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_BUS_RESET
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.bus_reset_delay
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
id|qpti-&gt;send_marker
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|PTI_RESET_LIMIT
mdefine_line|#define PTI_RESET_LIMIT 400
DECL|function|qlogicpti_load_firmware
r_static
r_int
id|__init
id|qlogicpti_load_firmware
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_int
r_int
id|csum
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
op_star
id|risc_code
comma
id|risc_code_addr
comma
id|risc_code_length
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|timeout
suffix:semicolon
id|risc_code
op_assign
op_amp
id|sbus_risc_code01
(braket
l_int|0
)braket
suffix:semicolon
id|risc_code_addr
op_assign
l_int|0x1000
suffix:semicolon
multiline_comment|/* all f/w modules load at 0x1000 */
id|risc_code_length
op_assign
id|sbus_risc_code_length01
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Verify the checksum twice, one before loading it, and once&n;&t; * afterwards via the mailbox commands.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_length
suffix:semicolon
id|i
op_increment
)paren
id|csum
op_add_assign
id|risc_code
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|csum
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Aieee, firmware checksum failed!&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
id|SBUS_CTRL_RESET
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
comma
id|qpti-&gt;qregs
op_plus
id|CMD_DMA_CTRL
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
comma
id|qpti-&gt;qregs
op_plus
id|DATA_DMA_CTRL
)paren
suffix:semicolon
id|timeout
op_assign
id|PTI_RESET_LIMIT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|timeout
op_logical_and
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
op_amp
id|SBUS_CTRL_RESET
)paren
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot reset the ISP.&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
id|HCCTRL_RESET
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|SBUS_CTRL_GENAB
op_or
id|SBUS_CTRL_ERIRQ
)paren
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
suffix:semicolon
id|set_sbus_cfg1
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|RISC_PSR
)paren
op_amp
id|RISC_PSR_ULTRA
)paren
(brace
id|qpti-&gt;ultra
op_assign
l_int|1
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|RISC_MTREG_P0ULTRA
op_or
id|RISC_MTREG_P1ULTRA
)paren
comma
id|qpti-&gt;qregs
op_plus
id|RISC_MTREG
)paren
suffix:semicolon
)brace
r_else
(brace
id|qpti-&gt;ultra
op_assign
l_int|0
suffix:semicolon
id|sbus_writew
c_func
(paren
(paren
id|RISC_MTREG_P0DFLT
op_or
id|RISC_MTREG_P1DFLT
)paren
comma
id|qpti-&gt;qregs
op_plus
id|RISC_MTREG
)paren
suffix:semicolon
)brace
id|sbus_writew
c_func
(paren
id|HCCTRL_REL
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Pin lines are only stable while RISC is paused. */
id|sbus_writew
c_func
(paren
id|HCCTRL_PAUSE
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|CPU_PDIFF
)paren
op_amp
id|CPU_PDIFF_MODE
)paren
id|qpti-&gt;differential
op_assign
l_int|1
suffix:semicolon
r_else
id|qpti-&gt;differential
op_assign
l_int|0
suffix:semicolon
id|sbus_writew
c_func
(paren
id|HCCTRL_REL
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* This shouldn&squot;t be necessary- we&squot;ve reset things so we should be&n;&t;   running from the ROM now.. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_STOP_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|param
(braket
l_int|2
)braket
op_assign
id|param
(braket
l_int|3
)braket
op_assign
id|param
(braket
l_int|4
)braket
op_assign
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot stop firmware for reload.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Load it up.. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr
op_plus
id|i
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|risc_code
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: Firmware dload failed, I&squot;m bolixed!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset the ISP again. */
id|sbus_writew
c_func
(paren
id|HCCTRL_RESET
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|qlogicpti_enable_irqs
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|HCCTRL_REL
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
multiline_comment|/* Ask ISP to verify the checksum of the new code. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_VERIFY_CHECKSUM
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: New firmware csum failure!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Start using newly downloaded firmware. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_EXEC_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABOUT_FIRMWARE
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: AboutFirmware cmd fails.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Snag the major and minor revisions from the result. */
id|qpti-&gt;fware_majrev
op_assign
id|param
(braket
l_int|1
)braket
suffix:semicolon
id|qpti-&gt;fware_minrev
op_assign
id|param
(braket
l_int|2
)braket
suffix:semicolon
id|qpti-&gt;fware_micrev
op_assign
id|param
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Set the clock rate */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_CLOCK_RATE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;clock
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: could not set clock rate.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qpti-&gt;is_pti
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Load scsi initiator ID and interrupt level into sbus static ram. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|0xff80
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
id|qpti-&gt;scsi_id
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|0xff00
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
l_int|3
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_verify_tmon
r_static
r_int
id|qlogicpti_verify_tmon
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_int
id|curstat
op_assign
id|sbus_readb
c_func
(paren
id|qpti-&gt;sreg
)paren
suffix:semicolon
id|curstat
op_and_assign
l_int|0xf0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|curstat
op_amp
id|SREG_FUSE
)paren
op_logical_and
(paren
id|qpti-&gt;swsreg
op_amp
id|SREG_FUSE
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: Fuse returned to normal state.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|curstat
op_amp
id|SREG_TPOWER
)paren
op_logical_and
(paren
id|qpti-&gt;swsreg
op_amp
id|SREG_TPOWER
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: termpwr back to normal state.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curstat
op_ne
id|qpti-&gt;swsreg
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|curstat
op_amp
id|SREG_FUSE
)paren
(brace
id|error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: Fuse is open!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curstat
op_amp
id|SREG_TPOWER
)paren
(brace
id|error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: termpwr failure&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qpti-&gt;differential
op_logical_and
(paren
id|curstat
op_amp
id|SREG_DSENSE
)paren
op_ne
id|SREG_DSENSE
)paren
(brace
id|error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: You have a single ended device on a &quot;
l_string|&quot;differential bus!  Please fix!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
id|qpti-&gt;swsreg
op_assign
id|curstat
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|qpti_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|function|qpti_chain_add
r_static
r_void
id|__init
id|qpti_chain_add
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|qptichain_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qptichain
op_ne
l_int|NULL
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qlink
op_assign
id|qptichain
suffix:semicolon
r_while
c_loop
(paren
id|qlink-&gt;next
)paren
(brace
id|qlink
op_assign
id|qlink-&gt;next
suffix:semicolon
)brace
id|qlink-&gt;next
op_assign
id|qpti
suffix:semicolon
)brace
r_else
(brace
id|qptichain
op_assign
id|qpti
suffix:semicolon
)brace
id|qpti-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|qptichain_lock
)paren
suffix:semicolon
)brace
DECL|function|qpti_chain_del
r_static
r_void
id|__init
id|qpti_chain_del
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|qptichain_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qptichain
op_eq
id|qpti
)paren
(brace
id|qptichain
op_assign
id|qpti-&gt;next
suffix:semicolon
)brace
r_else
(brace
r_struct
id|qlogicpti
op_star
id|qlink
op_assign
id|qptichain
suffix:semicolon
r_while
c_loop
(paren
id|qlink-&gt;next
op_ne
id|qpti
)paren
(brace
id|qlink
op_assign
id|qlink-&gt;next
suffix:semicolon
)brace
id|qlink-&gt;next
op_assign
id|qpti-&gt;next
suffix:semicolon
)brace
id|qpti-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|qptichain_lock
)paren
suffix:semicolon
)brace
DECL|function|qpti_map_regs
r_static
r_int
id|__init
id|qpti_map_regs
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|qpti-&gt;sdev
suffix:semicolon
id|qpti-&gt;qregs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
comma
l_string|&quot;PTI Qlogic/ISP&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qpti-&gt;qregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PTI: Qlogic/ISP registers are unmappable&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qpti-&gt;is_pti
)paren
(brace
id|qpti-&gt;sreg
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
(paren
l_int|16
op_star
l_int|4096
)paren
comma
r_sizeof
(paren
r_int
r_char
)paren
comma
l_string|&quot;PTI Qlogic/ISP statreg&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qpti-&gt;sreg
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PTI: Qlogic/ISP status register is unmappable&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qpti_register_irq
r_static
r_int
id|__init
id|qpti_register_irq
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|qpti-&gt;sdev
suffix:semicolon
id|qpti-&gt;qhost-&gt;irq
op_assign
id|qpti-&gt;irq
op_assign
id|sdev-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* We used to try various overly-clever things to&n;&t; * reduce the interrupt processing overhead on&n;&t; * sun4c/sun4m when multiple PTI&squot;s shared the&n;&t; * same IRQ.  It was too complex and messy to&n;&t; * sanely maintain.&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|qpti-&gt;irq
comma
id|qpti_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;Qlogic/PTI&quot;
comma
id|qpti
)paren
)paren
r_goto
id|fail
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qpti%d: IRQ %s &quot;
comma
id|qpti-&gt;qpti_id
comma
id|__irq_itoa
c_func
(paren
id|qpti-&gt;irq
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qpti%d: Cannot acquire irq line&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|qpti_get_scsi_id
r_static
r_void
id|__init
id|qpti_get_scsi_id
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|qpti-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;initiator-id&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;scsi_id
op_eq
op_minus
l_int|1
)paren
id|qpti-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;scsi-initiator-id&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;scsi_id
op_eq
op_minus
l_int|1
)paren
id|qpti-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;sdev-&gt;bus-&gt;prom_node
comma
l_string|&quot;scsi-initiator-id&quot;
comma
l_int|7
)paren
suffix:semicolon
id|qpti-&gt;qhost-&gt;this_id
op_assign
id|qpti-&gt;scsi_id
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSI ID %d &quot;
comma
id|qpti-&gt;scsi_id
)paren
suffix:semicolon
)brace
DECL|function|qpti_get_bursts
r_static
r_void
id|qpti_get_bursts
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|qpti-&gt;sdev
suffix:semicolon
id|u8
id|bursts
comma
id|bmask
suffix:semicolon
id|bursts
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|bmask
op_assign
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bmask
op_ne
l_int|0xff
)paren
id|bursts
op_and_assign
id|bmask
suffix:semicolon
r_if
c_cond
(paren
id|bursts
op_eq
l_int|0xff
op_logical_or
(paren
id|bursts
op_amp
id|DMA_BURST16
)paren
op_eq
l_int|0
op_logical_or
(paren
id|bursts
op_amp
id|DMA_BURST32
)paren
op_eq
l_int|0
)paren
id|bursts
op_assign
(paren
id|DMA_BURST32
op_minus
l_int|1
)paren
suffix:semicolon
id|qpti-&gt;bursts
op_assign
id|bursts
suffix:semicolon
)brace
DECL|function|qpti_get_clock
r_static
r_void
id|qpti_get_clock
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_int
r_int
id|cfreq
suffix:semicolon
multiline_comment|/* Check for what the clock input to this card is.&n;&t; * Default to 40Mhz.&n;&t; */
id|cfreq
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;clock-frequency&quot;
comma
l_int|40000000
)paren
suffix:semicolon
id|qpti-&gt;clock
op_assign
(paren
id|cfreq
op_plus
l_int|500000
)paren
op_div
l_int|1000000
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;clock
op_eq
l_int|0
)paren
multiline_comment|/* bullshit */
id|qpti-&gt;clock
op_assign
l_int|40
suffix:semicolon
)brace
multiline_comment|/* The request and response queues must each be aligned&n; * on a page boundry.&n; */
DECL|function|qpti_map_queues
r_static
r_int
id|__init
id|qpti_map_queues
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
id|qpti-&gt;sdev
suffix:semicolon
DECL|macro|QSIZE
mdefine_line|#define QSIZE(entries)&t;(((entries) + 1) * QUEUE_ENTRY_LEN)
id|qpti-&gt;res_cpu
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|sdev
comma
id|QSIZE
c_func
(paren
id|RES_QUEUE_LEN
)paren
comma
op_amp
id|qpti-&gt;res_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;res_cpu
op_eq
l_int|NULL
op_logical_or
id|qpti-&gt;res_dvma
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QPTI: Cannot map response queue.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|qpti-&gt;req_cpu
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|sdev
comma
id|QSIZE
c_func
(paren
id|QLOGICPTI_REQ_QUEUE_LEN
)paren
comma
op_amp
id|qpti-&gt;req_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;req_cpu
op_eq
l_int|NULL
op_logical_or
id|qpti-&gt;req_dvma
op_eq
l_int|0
)paren
(brace
id|sbus_free_consistent
c_func
(paren
id|sdev
comma
id|QSIZE
c_func
(paren
id|RES_QUEUE_LEN
)paren
comma
id|qpti-&gt;res_cpu
comma
id|qpti-&gt;res_dvma
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;QPTI: Cannot map request queue.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|qpti-&gt;res_cpu
comma
l_int|0
comma
id|QSIZE
c_func
(paren
id|RES_QUEUE_LEN
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|qpti-&gt;req_cpu
comma
l_int|0
comma
id|QSIZE
c_func
(paren
id|QLOGICPTI_REQ_QUEUE_LEN
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Detect all PTI Qlogic ISP&squot;s in the machine. */
DECL|function|qlogicpti_detect
r_int
id|__init
id|qlogicpti_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|qpti_host
suffix:semicolon
r_struct
id|sbus_bus
op_star
id|sbus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
r_int
id|nqptis
op_assign
l_int|0
comma
id|nqptis_in_use
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;qlogicpti&quot;
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
multiline_comment|/* Is this a red snapper? */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;ptisp&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;PTI,ptisp&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;QLGC,isp&quot;
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Sometimes Antares cards come up not completely&n;&t;&t;&t; * setup, and we get a report of a zero IRQ.&n;&t;&t;&t; * Skip over them in such cases so we survive.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|sdev-&gt;irqs
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qpti%d: Adapter reports no interrupt, &quot;
l_string|&quot;skipping over this card.&quot;
comma
id|nqptis
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Yep, register and allocate software state. */
id|qpti_host
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|qlogicpti
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qpti_host
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;QPTI: Cannot register PTI Qlogic ISP SCSI host&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|qpti_host-&gt;hostdata
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|qpti-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* We are wide capable, 16 targets. */
id|qpti_host-&gt;max_id
op_assign
id|MAX_TARGETS
suffix:semicolon
multiline_comment|/* Setup back pointers and misc. state. */
id|qpti-&gt;qhost
op_assign
id|qpti_host
suffix:semicolon
id|qpti-&gt;sdev
op_assign
id|sdev
suffix:semicolon
id|qpti-&gt;qpti_id
op_assign
id|nqptis
op_increment
suffix:semicolon
id|qpti-&gt;prom_node
op_assign
id|sdev-&gt;prom_node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;name&quot;
comma
id|qpti-&gt;prom_name
comma
r_sizeof
(paren
id|qpti-&gt;prom_name
)paren
)paren
suffix:semicolon
multiline_comment|/* This is not correct, actually. There&squot;s a switch&n;&t;&t;&t; * on the PTI cards that put them into &quot;emulation&quot;&n;&t;&t;&t; * mode- i.e., report themselves as QLGC,isp&n;&t;&t;&t; * instead of PTI,ptisp. The only real substantive&n;&t;&t;&t; * difference between non-pti and pti cards is&n;&t;&t;&t; * the tmon register. Which is possibly even&n;&t;&t;&t; * there for Qlogic cards, but non-functional.&n;&t;&t;&t; */
id|qpti-&gt;is_pti
op_assign
(paren
id|strcmp
(paren
id|qpti-&gt;prom_name
comma
l_string|&quot;QLGC,isp&quot;
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|qpti_chain_add
c_func
(paren
id|qpti
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti_map_regs
c_func
(paren
id|qpti
)paren
OL
l_int|0
)paren
r_goto
id|fail_unlink
suffix:semicolon
r_if
c_cond
(paren
id|qpti_register_irq
c_func
(paren
id|qpti
)paren
OL
l_int|0
)paren
r_goto
id|fail_unmap_regs
suffix:semicolon
id|qpti_get_scsi_id
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|qpti_get_bursts
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|qpti_get_clock
c_func
(paren
id|qpti
)paren
suffix:semicolon
multiline_comment|/* Clear out Scsi_Cmnd array. */
id|memset
c_func
(paren
id|qpti-&gt;cmd_slots
comma
l_int|0
comma
r_sizeof
(paren
id|qpti-&gt;cmd_slots
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti_map_queues
c_func
(paren
id|qpti
)paren
OL
l_int|0
)paren
r_goto
id|fail_free_irq
suffix:semicolon
multiline_comment|/* Load the firmware. */
r_if
c_cond
(paren
id|qlogicpti_load_firmware
c_func
(paren
id|qpti
)paren
)paren
r_goto
id|fail_unmap_queues
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;is_pti
)paren
(brace
multiline_comment|/* Check the PTI status reg. */
r_if
c_cond
(paren
id|qlogicpti_verify_tmon
c_func
(paren
id|qpti
)paren
)paren
r_goto
id|fail_unmap_queues
suffix:semicolon
)brace
multiline_comment|/* Reset the ISP and init res/req queues. */
r_if
c_cond
(paren
id|qlogicpti_reset_hardware
c_func
(paren
id|qpti_host
)paren
)paren
r_goto
id|fail_unmap_queues
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Firmware v%d.%d.%d)&quot;
comma
id|qpti-&gt;fware_majrev
comma
id|qpti-&gt;fware_minrev
comma
id|qpti-&gt;fware_micrev
)paren
suffix:semicolon
(brace
r_char
id|buffer
(braket
l_int|60
)braket
suffix:semicolon
id|prom_getstring
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;isp-fcode&quot;
comma
id|buffer
comma
l_int|60
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
(braket
l_int|0
)braket
)paren
id|printk
c_func
(paren
l_string|&quot;(Firmware %s)&quot;
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prom_getbool
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;differential&quot;
)paren
)paren
id|qpti-&gt;differential
op_assign
l_int|1
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot; [%s Wide, using %s interface]&bslash;n&quot;
comma
(paren
id|qpti-&gt;ultra
ques
c_cond
l_string|&quot;Ultra&quot;
suffix:colon
l_string|&quot;Fast&quot;
)paren
comma
(paren
id|qpti-&gt;differential
ques
c_cond
l_string|&quot;differential&quot;
suffix:colon
l_string|&quot;single ended&quot;
)paren
)paren
suffix:semicolon
id|nqptis_in_use
op_increment
suffix:semicolon
r_continue
suffix:semicolon
id|fail_unmap_queues
suffix:colon
DECL|macro|QSIZE
mdefine_line|#define QSIZE(entries)&t;(((entries) + 1) * QUEUE_ENTRY_LEN)
id|sbus_free_consistent
c_func
(paren
id|qpti-&gt;sdev
comma
id|QSIZE
c_func
(paren
id|RES_QUEUE_LEN
)paren
comma
id|qpti-&gt;res_cpu
comma
id|qpti-&gt;res_dvma
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|qpti-&gt;sdev
comma
id|QSIZE
c_func
(paren
id|QLOGICPTI_REQ_QUEUE_LEN
)paren
comma
id|qpti-&gt;req_cpu
comma
id|qpti-&gt;req_dvma
)paren
suffix:semicolon
DECL|macro|QSIZE
macro_line|#undef QSIZE
id|fail_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|qpti-&gt;irq
comma
id|qpti
)paren
suffix:semicolon
id|fail_unmap_regs
suffix:colon
id|sbus_iounmap
c_func
(paren
id|qpti-&gt;qregs
comma
id|qpti-&gt;sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;is_pti
)paren
id|sbus_iounmap
c_func
(paren
id|qpti-&gt;sreg
comma
r_sizeof
(paren
r_int
r_char
)paren
)paren
suffix:semicolon
id|fail_unlink
suffix:colon
id|qpti_chain_del
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|qpti-&gt;qhost
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nqptis
)paren
id|printk
c_func
(paren
l_string|&quot;QPTI: Total of %d PTI Qlogic/ISP hosts found, %d actually in use.&bslash;n&quot;
comma
id|nqptis
comma
id|nqptis_in_use
)paren
suffix:semicolon
id|qptis_running
op_assign
id|nqptis_in_use
suffix:semicolon
r_return
id|nqptis
suffix:semicolon
)brace
DECL|function|qlogicpti_release
r_int
id|qlogicpti_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Remove visibility from IRQ handlers. */
id|qpti_chain_del
c_func
(paren
id|qpti
)paren
suffix:semicolon
multiline_comment|/* Shut up the card. */
id|sbus_writew
c_func
(paren
l_int|0
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_CTRL
)paren
suffix:semicolon
multiline_comment|/* Free IRQ handler and unmap Qlogic,ISP and PTI status regs. */
id|free_irq
c_func
(paren
id|qpti-&gt;irq
comma
id|qpti
)paren
suffix:semicolon
DECL|macro|QSIZE
mdefine_line|#define QSIZE(entries)&t;(((entries) + 1) * QUEUE_ENTRY_LEN)
id|sbus_free_consistent
c_func
(paren
id|qpti-&gt;sdev
comma
id|QSIZE
c_func
(paren
id|RES_QUEUE_LEN
)paren
comma
id|qpti-&gt;res_cpu
comma
id|qpti-&gt;res_dvma
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|qpti-&gt;sdev
comma
id|QSIZE
c_func
(paren
id|QLOGICPTI_REQ_QUEUE_LEN
)paren
comma
id|qpti-&gt;req_cpu
comma
id|qpti-&gt;req_dvma
)paren
suffix:semicolon
DECL|macro|QSIZE
macro_line|#undef QSIZE
id|sbus_iounmap
c_func
(paren
id|qpti-&gt;qregs
comma
id|qpti-&gt;sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;is_pti
)paren
id|sbus_iounmap
c_func
(paren
id|qpti-&gt;sreg
comma
r_sizeof
(paren
r_int
r_char
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_info
r_const
r_char
op_star
id|qlogicpti_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|80
)braket
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;PTI Qlogic,ISP SBUS SCSI irq %s regs at %lx&quot;
comma
id|__irq_itoa
c_func
(paren
id|qpti-&gt;qhost-&gt;irq
)paren
comma
id|qpti-&gt;qregs
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
multiline_comment|/* I am a certified frobtronicist. */
DECL|function|marker_frob
r_static
r_inline
r_void
id|marker_frob
c_func
(paren
r_struct
id|Command_Entry
op_star
id|cmd
)paren
(brace
r_struct
id|Marker_Entry
op_star
id|marker
op_assign
(paren
r_struct
id|Marker_Entry
op_star
)paren
id|cmd
suffix:semicolon
id|memset
c_func
(paren
id|marker
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Marker_Entry
)paren
)paren
suffix:semicolon
id|marker-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|marker-&gt;hdr.entry_type
op_assign
id|ENTRY_MARKER
suffix:semicolon
id|marker-&gt;modifier
op_assign
id|SYNC_ALL
suffix:semicolon
id|marker-&gt;rsvd
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|cmd_frob
r_static
r_inline
r_void
id|cmd_frob
c_func
(paren
r_struct
id|Command_Entry
op_star
id|cmd
comma
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Command_Entry
)paren
)paren
suffix:semicolon
id|cmd-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;hdr.entry_type
op_assign
id|ENTRY_COMMAND
suffix:semicolon
id|cmd-&gt;target_id
op_assign
id|Cmnd-&gt;target
suffix:semicolon
id|cmd-&gt;target_lun
op_assign
id|Cmnd-&gt;lun
suffix:semicolon
id|cmd-&gt;cdb_length
op_assign
id|Cmnd-&gt;cmd_len
suffix:semicolon
id|cmd-&gt;control_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;device-&gt;tagged_supported
)paren
(brace
r_if
c_cond
(paren
id|qpti-&gt;cmd_count
(braket
id|Cmnd-&gt;target
)braket
op_eq
l_int|0
)paren
id|qpti-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|qpti-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
)paren
OG
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
id|cmd-&gt;control_flags
op_assign
id|CFLAG_ORDERED_TAG
suffix:semicolon
id|qpti-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
id|cmd-&gt;control_flags
op_assign
id|CFLAG_SIMPLE_TAG
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
op_logical_or
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_10
)paren
op_logical_or
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_12
)paren
)paren
id|cmd-&gt;control_flags
op_or_assign
id|CFLAG_WRITE
suffix:semicolon
r_else
id|cmd-&gt;control_flags
op_or_assign
id|CFLAG_READ
suffix:semicolon
id|cmd-&gt;time_out
op_assign
l_int|30
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;cdb
comma
id|Cmnd-&gt;cmnd
comma
id|Cmnd-&gt;cmd_len
)paren
suffix:semicolon
)brace
multiline_comment|/* Do it to it baby. */
DECL|function|load_cmd
r_static
r_inline
r_int
id|load_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_struct
id|Command_Entry
op_star
id|cmd
comma
r_struct
id|qlogicpti
op_star
id|qpti
comma
id|u_int
id|in_ptr
comma
id|u_int
id|out_ptr
)paren
(brace
r_struct
id|dataseg
op_star
id|ds
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
)paren
(brace
r_int
id|sg_count
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;buffer
suffix:semicolon
id|sg_count
op_assign
id|sbus_map_sg
c_func
(paren
id|qpti-&gt;sdev
comma
id|sg
comma
id|Cmnd-&gt;use_sg
comma
id|scsi_to_sbus_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
id|ds
op_assign
id|cmd-&gt;dataseg
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
id|sg_count
suffix:semicolon
multiline_comment|/* Fill in first four sg entries: */
id|n
op_assign
id|sg_count
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|4
)paren
id|n
op_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|ds
(braket
id|i
)braket
dot
id|d_base
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|ds
(braket
id|i
)braket
dot
id|d_count
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
)brace
id|sg_count
op_sub_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
id|sg_count
OG
l_int|0
)paren
(brace
r_struct
id|Continuation_Entry
op_star
id|cont
suffix:semicolon
op_increment
id|cmd-&gt;hdr.entry_cnt
suffix:semicolon
id|cont
op_assign
(paren
r_struct
id|Continuation_Entry
op_star
)paren
op_amp
id|qpti-&gt;req_cpu
(braket
id|in_ptr
)braket
suffix:semicolon
id|in_ptr
op_assign
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_ptr
op_eq
id|out_ptr
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|cont-&gt;hdr.entry_type
op_assign
id|ENTRY_CONTINUATION
suffix:semicolon
id|cont-&gt;hdr.entry_cnt
op_assign
l_int|0
suffix:semicolon
id|cont-&gt;hdr.sys_def_1
op_assign
l_int|0
suffix:semicolon
id|cont-&gt;hdr.flags
op_assign
l_int|0
suffix:semicolon
id|cont-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|ds
op_assign
id|cont-&gt;dataseg
suffix:semicolon
id|n
op_assign
id|sg_count
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|7
)paren
id|n
op_assign
l_int|7
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|ds
(braket
id|i
)braket
dot
id|d_base
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|ds
(braket
id|i
)braket
dot
id|d_count
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
)brace
id|sg_count
op_sub_assign
id|n
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|Cmnd-&gt;request_bufflen
)paren
(brace
id|Cmnd-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|sbus_map_single
c_func
(paren
id|qpti-&gt;sdev
comma
id|Cmnd-&gt;request_buffer
comma
id|Cmnd-&gt;request_bufflen
comma
id|scsi_to_sbus_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base
op_assign
(paren
id|u32
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd-&gt;SCp.ptr
)paren
suffix:semicolon
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_count
op_assign
id|Cmnd-&gt;request_bufflen
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_count
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Shouldn&squot;t this be 0? */
)brace
multiline_comment|/* Committed, record Scsi_Cmd so we can find it later. */
id|cmd-&gt;handle
op_assign
id|in_ptr
suffix:semicolon
id|qpti-&gt;cmd_slots
(braket
id|in_ptr
)braket
op_assign
id|Cmnd
suffix:semicolon
id|qpti-&gt;cmd_count
(braket
id|Cmnd-&gt;target
)braket
op_increment
suffix:semicolon
id|sbus_writew
c_func
(paren
id|in_ptr
comma
id|qpti-&gt;qregs
op_plus
id|MBOX4
)paren
suffix:semicolon
id|qpti-&gt;req_in_ptr
op_assign
id|in_ptr
suffix:semicolon
r_return
id|in_ptr
suffix:semicolon
)brace
DECL|function|update_can_queue
r_static
r_inline
r_void
id|update_can_queue
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|u_int
id|in_ptr
comma
id|u_int
id|out_ptr
)paren
(brace
multiline_comment|/* Temporary workaround until bug is found and fixed (one bug has been found&n;&t;   already, but fixing it makes things even worse) -jj */
r_int
id|num_free
op_assign
id|QLOGICPTI_REQ_QUEUE_LEN
op_minus
id|REQ_QUEUE_DEPTH
c_func
(paren
id|in_ptr
comma
id|out_ptr
)paren
op_minus
l_int|64
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|host-&gt;host_busy
op_plus
id|num_free
suffix:semicolon
id|host-&gt;sg_tablesize
op_assign
id|QLOGICPTI_MAX_SG
c_func
(paren
id|num_free
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Until we scan the entire bus with inquiries, go throught this fella...&n; */
DECL|function|ourdone
r_static
r_void
id|ourdone
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|Cmnd-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|tgt
op_assign
id|Cmnd-&gt;target
suffix:semicolon
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
multiline_comment|/* This grot added by DaveM, blame him for ugliness.&n;&t; * The issue is that in the 2.3.x driver we use the&n;&t; * host_scribble portion of the scsi command as a&n;&t; * completion linked list at interrupt service time,&n;&t; * so we have to store the done function pointer elsewhere.&n;&t; */
id|done
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd-&gt;SCp.Message
)paren
macro_line|#ifdef __sparc_v9__
op_or
(paren
(paren
r_int
r_int
)paren
id|Cmnd-&gt;SCp.Status
op_lshift
l_int|32UL
)paren
macro_line|#endif
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|qpti-&gt;sbits
op_amp
(paren
l_int|1
op_lshift
id|tgt
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|ok
op_assign
id|host_byte
c_func
(paren
id|Cmnd-&gt;result
)paren
op_eq
id|DID_OK
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|0x12
op_logical_and
id|ok
)paren
(brace
r_int
r_char
op_star
id|iqd
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
op_eq
l_int|0
)paren
(brace
id|iqd
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|Cmnd-&gt;buffer
)paren
suffix:semicolon
)brace
r_else
(brace
id|iqd
op_assign
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;request_buffer
)paren
op_member_access_from_pointer
id|address
suffix:semicolon
)brace
multiline_comment|/* tags handled in midlayer */
multiline_comment|/* enable sync mode? */
r_if
c_cond
(paren
id|iqd
(braket
l_int|7
)braket
op_amp
l_int|0x10
)paren
(brace
id|qpti-&gt;dev_param
(braket
id|tgt
)braket
dot
id|device_flags
op_or_assign
l_int|0x10
suffix:semicolon
)brace
r_else
(brace
id|qpti-&gt;dev_param
(braket
id|tgt
)braket
dot
id|synchronous_offset
op_assign
l_int|0
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|tgt
)braket
dot
id|synchronous_period
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* are we wide capable? */
r_if
c_cond
(paren
id|iqd
(braket
l_int|7
)braket
op_amp
l_int|0x20
)paren
(brace
id|qpti-&gt;dev_param
(braket
id|tgt
)braket
dot
id|device_flags
op_or_assign
l_int|0x20
suffix:semicolon
)brace
id|qpti-&gt;sbits
op_or_assign
(paren
l_int|1
op_lshift
id|tgt
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
id|qpti-&gt;sbits
op_or_assign
(paren
l_int|1
op_lshift
id|tgt
)paren
suffix:semicolon
)brace
)brace
id|done
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_queuecommand_slow
r_int
id|qlogicpti_queuecommand_slow
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|Cmnd-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/*&n;&t; * done checking this host adapter?&n;&t; * If not, then rewrite the command&n;&t; * to finish through ourdone so we&n;&t; * can peek at Inquiry data results.&n;&t; */
r_if
c_cond
(paren
id|qpti-&gt;sbits
op_logical_and
id|qpti-&gt;sbits
op_ne
l_int|0xffff
)paren
(brace
multiline_comment|/* See above about in ourdone this ugliness... */
id|Cmnd-&gt;SCp.Message
op_assign
(paren
(paren
r_int
r_int
)paren
id|done
)paren
op_amp
l_int|0xffffffff
suffix:semicolon
macro_line|#ifdef __sparc_v9__
id|Cmnd-&gt;SCp.Status
op_assign
(paren
(paren
r_int
r_int
)paren
id|done
op_rshift
l_int|32UL
)paren
op_amp
l_int|0xffffffff
suffix:semicolon
macro_line|#endif
r_return
id|qlogicpti_queuecommand
c_func
(paren
id|Cmnd
comma
id|ourdone
)paren
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We&squot;ve peeked at all targets for this bus- time&n;&t; * to set parameters for devices for real now.&n;&t; */
r_if
c_cond
(paren
id|qpti-&gt;sbits
op_eq
l_int|0xffff
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TARGET_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_amp
l_int|0x10
)paren
(brace
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_lshift
l_int|8
)paren
op_or
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
suffix:semicolon
)brace
r_else
(brace
id|param
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
(paren
r_void
)paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * set to zero so any traverse through ourdone&n;&t;&t; * doesn&squot;t start the whole process again,&n;&t;&t; */
id|qpti-&gt;sbits
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check to see if we&squot;re done with all adapters... */
r_for
c_loop
(paren
id|qpti
op_assign
id|qptichain
suffix:semicolon
id|qpti
op_ne
l_int|NULL
suffix:semicolon
id|qpti
op_assign
id|qpti-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|qpti-&gt;sbits
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * if we hit the end of the chain w/o finding adapters still&n;&t; * capability-configuring, then we&squot;re done with all adapters&n;&t; * and can rock on..&n;&t; */
r_if
c_cond
(paren
id|qpti
op_eq
l_int|NULL
)paren
id|Cmnd-&gt;host-&gt;hostt-&gt;queuecommand
op_assign
id|qlogicpti_queuecommand
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|qlogicpti_queuecommand
c_func
(paren
id|Cmnd
comma
id|done
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The middle SCSI layer ensures that queuecommand never gets invoked&n; * concurrently with itself or the interrupt handler (though the&n; * interrupt handler may call this routine as part of&n; * request-completion handling).&n; *&n; * &quot;This code must fly.&quot; -davem&n; */
DECL|function|qlogicpti_queuecommand
r_int
id|qlogicpti_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|Command_Entry
op_star
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u_int
id|out_ptr
suffix:semicolon
r_int
id|in_ptr
suffix:semicolon
id|Cmnd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|in_ptr
op_assign
id|qpti-&gt;req_in_ptr
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|qpti-&gt;req_cpu
(braket
id|in_ptr
)braket
suffix:semicolon
id|out_ptr
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX4
)paren
suffix:semicolon
id|in_ptr
op_assign
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_ptr
op_eq
id|out_ptr
)paren
r_goto
id|toss_command
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;send_marker
)paren
(brace
id|marker_frob
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|qpti-&gt;send_marker
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
op_eq
id|out_ptr
)paren
(brace
id|sbus_writew
c_func
(paren
id|in_ptr
comma
id|qpti-&gt;qregs
op_plus
id|MBOX4
)paren
suffix:semicolon
id|qpti-&gt;req_in_ptr
op_assign
id|in_ptr
suffix:semicolon
r_goto
id|toss_command
suffix:semicolon
)brace
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|qpti-&gt;req_cpu
(braket
id|in_ptr
)braket
suffix:semicolon
id|in_ptr
op_assign
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
suffix:semicolon
)brace
id|cmd_frob
c_func
(paren
id|cmd
comma
id|Cmnd
comma
id|qpti
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_ptr
op_assign
id|load_cmd
c_func
(paren
id|Cmnd
comma
id|cmd
comma
id|qpti
comma
id|in_ptr
comma
id|out_ptr
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_goto
id|toss_command
suffix:semicolon
id|update_can_queue
c_func
(paren
id|host
comma
id|in_ptr
comma
id|out_ptr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|toss_command
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: request queue overflow&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Unfortunately, unless you use the new EH code, which&n;&t; * we don&squot;t, the midlayer will ignore the return value,&n;&t; * which is insane.  We pick up the pieces like this.&n;&t; */
id|Cmnd-&gt;result
op_assign
id|DID_BUS_BUSY
suffix:semicolon
id|done
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|qlogicpti_return_status
r_static
r_int
id|qlogicpti_return_status
c_func
(paren
r_struct
id|Status_Entry
op_star
id|sts
comma
r_int
id|id
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_switch
c_cond
(paren
id|sts-&gt;completion_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_INCOMPLETE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_BUS
)paren
)paren
id|host_status
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_TARGET
)paren
)paren
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_SENT_CDB
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_TRANSFERRED_DATA
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_STATUS
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DMA_ERROR
suffix:colon
r_case
id|CS_TRANSPORT_ERROR
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET_OCCURRED
suffix:colon
r_case
id|CS_BUS_RESET
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
r_case
id|CS_COMMAND_OVERRUN
suffix:colon
r_case
id|CS_STATUS_OVERRUN
suffix:colon
r_case
id|CS_BAD_MESSAGE
suffix:colon
r_case
id|CS_NO_MESSAGE_OUT
suffix:colon
r_case
id|CS_EXT_ID_FAILED
suffix:colon
r_case
id|CS_IDE_MSG_FAILED
suffix:colon
r_case
id|CS_ABORT_MSG_FAILED
suffix:colon
r_case
id|CS_NOP_MSG_FAILED
suffix:colon
r_case
id|CS_PARITY_ERROR_MSG_FAILED
suffix:colon
r_case
id|CS_DEVICE_RESET_MSG_FAILED
suffix:colon
r_case
id|CS_ID_MSG_FAILED
suffix:colon
r_case
id|CS_UNEXP_BUS_FREE
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qpti%d: unknown completion status 0x%04x&bslash;n&quot;
comma
id|id
comma
id|sts-&gt;completion_status
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|sts-&gt;scsi_status
op_amp
id|STATUS_MASK
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_intr_handler
r_static
id|Scsi_Cmnd
op_star
id|qlogicpti_intr_handler
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|Scsi_Cmnd
op_star
id|Cmnd
comma
op_star
id|done_queue
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|Status_Entry
op_star
id|sts
suffix:semicolon
id|u_int
id|in_ptr
comma
id|out_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|SBUS_STAT
)paren
op_amp
id|SBUS_STAT_RINT
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|in_ptr
op_assign
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX5
)paren
suffix:semicolon
id|sbus_writew
c_func
(paren
id|HCCTRL_CRIRQ
comma
id|qpti-&gt;qregs
op_plus
id|HCCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
op_amp
id|SBUS_SEMAPHORE_LCK
)paren
(brace
r_switch
c_cond
(paren
id|sbus_readw
c_func
(paren
id|qpti-&gt;qregs
op_plus
id|MBOX0
)paren
)paren
(brace
r_case
id|ASYNC_SCSI_BUS_RESET
suffix:colon
r_case
id|EXECUTION_TIMEOUT_RESET
suffix:colon
id|qpti-&gt;send_marker
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INVALID_COMMAND
suffix:colon
r_case
id|HOST_INTERFACE_ERROR
suffix:colon
r_case
id|COMMAND_ERROR
suffix:colon
r_case
id|COMMAND_PARAM_ERROR
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|sbus_writew
c_func
(paren
l_int|0
comma
id|qpti-&gt;qregs
op_plus
id|SBUS_SEMAPHORE
)paren
suffix:semicolon
)brace
multiline_comment|/* This looks like a network driver! */
id|out_ptr
op_assign
id|qpti-&gt;res_out_ptr
suffix:semicolon
r_while
c_loop
(paren
id|out_ptr
op_ne
id|in_ptr
)paren
(brace
id|u_int
id|cmd_slot
suffix:semicolon
id|sts
op_assign
(paren
r_struct
id|Status_Entry
op_star
)paren
op_amp
id|qpti-&gt;res_cpu
(braket
id|out_ptr
)braket
suffix:semicolon
id|out_ptr
op_assign
id|NEXT_RES_PTR
c_func
(paren
id|out_ptr
)paren
suffix:semicolon
multiline_comment|/* We store an index in the handle, not the pointer in&n;&t;&t; * some form.  This avoids problems due to the fact&n;&t;&t; * that the handle provided is only 32-bits. -DaveM&n;&t;&t; */
id|cmd_slot
op_assign
id|sts-&gt;handle
suffix:semicolon
id|Cmnd
op_assign
id|qpti-&gt;cmd_slots
(braket
id|cmd_slot
)braket
suffix:semicolon
id|qpti-&gt;cmd_slots
(braket
id|cmd_slot
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;completion_status
op_eq
id|CS_RESET_OCCURRED
op_logical_or
id|sts-&gt;completion_status
op_eq
id|CS_ABORTED
op_logical_or
(paren
id|sts-&gt;status_flags
op_amp
id|STF_BUS_RESET
)paren
)paren
id|qpti-&gt;send_marker
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
id|memcpy
c_func
(paren
id|Cmnd-&gt;sense_buffer
comma
id|sts-&gt;req_sense_data
comma
r_sizeof
(paren
id|Cmnd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;hdr.entry_type
op_eq
id|ENTRY_STATUS
)paren
id|Cmnd-&gt;result
op_assign
id|qlogicpti_return_status
c_func
(paren
id|sts
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_else
id|Cmnd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
)paren
(brace
id|sbus_unmap_sg
c_func
(paren
id|qpti-&gt;sdev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;buffer
comma
id|Cmnd-&gt;use_sg
comma
id|scsi_to_sbus_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|sbus_unmap_single
c_func
(paren
id|qpti-&gt;sdev
comma
(paren
id|__u32
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd-&gt;SCp.ptr
)paren
comma
id|Cmnd-&gt;request_bufflen
comma
id|scsi_to_sbus_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
id|qpti-&gt;cmd_count
(braket
id|Cmnd-&gt;target
)braket
op_decrement
suffix:semicolon
id|sbus_writew
c_func
(paren
id|out_ptr
comma
id|qpti-&gt;qregs
op_plus
id|MBOX5
)paren
suffix:semicolon
id|Cmnd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|done_queue
suffix:semicolon
id|done_queue
op_assign
id|Cmnd
suffix:semicolon
)brace
id|qpti-&gt;res_out_ptr
op_assign
id|out_ptr
suffix:semicolon
r_return
id|done_queue
suffix:semicolon
)brace
DECL|function|qpti_intr
r_static
r_void
id|qpti_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|dq
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dq
op_assign
id|qlogicpti_intr_handler
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|qpti-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dq
op_ne
l_int|NULL
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
r_do
(brace
id|Scsi_Cmnd
op_star
id|next
suffix:semicolon
id|next
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|dq-&gt;host_scribble
suffix:semicolon
id|dq
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|dq
)paren
suffix:semicolon
id|dq
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dq
op_ne
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
)brace
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_abort
r_int
id|qlogicpti_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|cmd_cookie
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qlogicpti : Aborting cmd for tgt[%d] lun[%d]&bslash;n&quot;
comma
(paren
r_int
)paren
id|Cmnd-&gt;target
comma
(paren
r_int
)paren
id|Cmnd-&gt;lun
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|qlogicpti_disable_irqs
c_func
(paren
id|qpti
)paren
suffix:semicolon
multiline_comment|/* Find the 32-bit cookie we gave to the firmware for&n;&t; * this command.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|QLOGICPTI_REQ_QUEUE_LEN
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|qpti-&gt;cmd_slots
(braket
id|i
)braket
op_eq
id|Cmnd
)paren
r_break
suffix:semicolon
id|cmd_cookie
op_assign
id|i
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABORT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
(paren
(paren
id|u_short
)paren
id|Cmnd-&gt;target
)paren
op_lshift
l_int|8
)paren
op_or
id|Cmnd-&gt;lun
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|cmd_cookie
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
id|cmd_cookie
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti : scsi abort failure: %x&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
id|qlogicpti_enable_irqs
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
DECL|function|qlogicpti_reset
r_int
id|qlogicpti_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_RESET_SUCCESS
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qlogicpti : Resetting SCSI bus!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|qlogicpti_disable_irqs
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_BUS_RESET
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.bus_reset_delay
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicisp : scsi bus reset failure: %x&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
id|qlogicpti_enable_irqs
c_func
(paren
id|qpti
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qpti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|QLOGICPTI
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
id|EXPORT_NO_SYMBOLS
suffix:semicolon
eof
