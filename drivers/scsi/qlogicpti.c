multiline_comment|/* qlogicpti.c: Performance Technologies QlogicISP sbus card driver.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caipfs.rutgers.edu)&n; *&n; * A lot of this driver was directly stolen from Erik H. Moe&squot;s PCI&n; * Qlogic ISP driver.  Mucho kudos to him for this code.&n; *&n; * An even bigger kudos to John Grana at Performance Technologies&n; * for providing me with the hardware to write this driver, you rule&n; * John you really do.&n; *&n; * May, 2, 1997: Added support for QLGC,isp --jj&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;qlogicpti.h&quot;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;asm/machines.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/module.h&gt;
DECL|macro|MAX_TARGETS
mdefine_line|#define MAX_TARGETS&t;16
DECL|macro|MAX_LUNS
mdefine_line|#define MAX_LUNS&t;8
DECL|macro|DEFAULT_LOOP_COUNT
mdefine_line|#define DEFAULT_LOOP_COUNT&t;1000000
macro_line|#include &quot;qlogicpti_asm.c&quot;
DECL|variable|qptichain
r_static
r_struct
id|qlogicpti
op_star
id|qptichain
suffix:semicolon
DECL|variable|qptis_running
r_static
r_int
id|qptis_running
op_assign
l_int|0
suffix:semicolon
DECL|macro|PACKB
mdefine_line|#define PACKB(a, b)&t;&t;&t;(((a)&lt;&lt;4)|(b))
DECL|variable|mbox_param
r_const
id|u_char
id|mbox_param
(braket
)braket
op_assign
(brace
id|PACKB
c_func
(paren
l_int|1
comma
l_int|1
)paren
comma
multiline_comment|/* MBOX_NO_OP */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_LOAD_RAM */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|0
)paren
comma
multiline_comment|/* MBOX_EXEC_FIRMWARE */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_DUMP_RAM */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_WRITE_RAM_WORD */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_READ_RAM_WORD */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_MAILBOX_REG_TEST */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_VERIFY_CHECKSUM&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABOUT_FIRMWARE */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0009 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000d */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_CHECK_FIRMWARE */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x000f */
id|PACKB
c_func
(paren
l_int|5
comma
l_int|5
)paren
comma
multiline_comment|/* MBOX_INIT_REQ_QUEUE */
id|PACKB
c_func
(paren
l_int|6
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_INIT_RES_QUEUE */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_EXECUTE_IOCB */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_WAKE_UP&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|6
)paren
comma
multiline_comment|/* MBOX_STOP_FIRMWARE */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_ABORT */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_ABORT_DEVICE */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABORT_TARGET */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_BUS_RESET */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_STOP_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_START_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SINGLE_STEP_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_ABORT_QUEUE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_STATUS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x001e */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_FIRMWARE_STATUS */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_INIT_SCSI_ID */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_SELECT_TIMEOUT */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_RETRY_COUNT&t;*/
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_TAG_AGE_LIMIT */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_CLOCK_RATE */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_ACT_NEG_STATE */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_GET_ASYNC_DATA_SETUP_TIME */
id|PACKB
c_func
(paren
l_int|1
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_GET_SBUS_PARAMS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_TARGET_PARAMS */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_PARAMS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002d */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002e */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x002f */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_INIT_SCSI_ID */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_SELECT_TIMEOUT */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SET_RETRY_COUNT&t;*/
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_TAG_AGE_LIMIT */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_CLOCK_RATE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_ACTIVE_NEG_STATE */
id|PACKB
c_func
(paren
l_int|2
comma
l_int|2
)paren
comma
multiline_comment|/* MBOX_SET_ASYNC_DATA_SETUP_TIME */
id|PACKB
c_func
(paren
l_int|3
comma
l_int|3
)paren
comma
multiline_comment|/* MBOX_SET_SBUS_CONTROL_PARAMS */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_SET_TARGET_PARAMS */
id|PACKB
c_func
(paren
l_int|4
comma
l_int|4
)paren
comma
multiline_comment|/* MBOX_SET_DEV_QUEUE_PARAMS */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003a */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003b */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003c */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003d */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003e */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x003f */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0040 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
multiline_comment|/* 0x0041 */
id|PACKB
c_func
(paren
l_int|0
comma
l_int|0
)paren
multiline_comment|/* 0x0042 */
)brace
suffix:semicolon
DECL|macro|MAX_MBOX_COMMAND
mdefine_line|#define MAX_MBOX_COMMAND&t;(sizeof(mbox_param)/sizeof(u_short))
multiline_comment|/* queue length&squot;s _must_ be power of two: */
DECL|macro|QUEUE_DEPTH
mdefine_line|#define QUEUE_DEPTH(in, out, ql)&t;((in - out) &amp; (ql))
DECL|macro|REQ_QUEUE_DEPTH
mdefine_line|#define REQ_QUEUE_DEPTH(in, out)&t;QUEUE_DEPTH(in, out, &t;&t;     &bslash;&n;&t;&t;&t;&t;&t;&t;    QLOGICISP_REQ_QUEUE_LEN)
DECL|macro|RES_QUEUE_DEPTH
mdefine_line|#define RES_QUEUE_DEPTH(in, out)&t;QUEUE_DEPTH(in, out, RES_QUEUE_LEN)
DECL|variable|proc_scsi_qlogicpti
r_static
r_struct
id|proc_dir_entry
id|proc_scsi_qlogicpti
op_assign
(brace
id|PROC_SCSI_QLOGICPTI
comma
l_int|7
comma
l_string|&quot;qlogicpti&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
DECL|function|qlogicpti_enable_irqs
r_static
r_inline
r_void
id|qlogicpti_enable_irqs
c_func
(paren
r_struct
id|qlogicpti_regs
op_star
id|qregs
)paren
(brace
id|qregs-&gt;sbus_ctrl
op_assign
id|SBUS_CTRL_ERIRQ
op_or
id|SBUS_CTRL_GENAB
suffix:semicolon
)brace
DECL|function|qlogicpti_disable_irqs
r_static
r_inline
r_void
id|qlogicpti_disable_irqs
c_func
(paren
r_struct
id|qlogicpti_regs
op_star
id|qregs
)paren
(brace
id|qregs-&gt;sbus_ctrl
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|set_sbus_cfg1
r_static
r_inline
r_void
id|set_sbus_cfg1
c_func
(paren
r_struct
id|qlogicpti_regs
op_star
id|qregs
comma
r_int
r_char
id|bursts
)paren
(brace
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST32
)paren
(brace
id|qregs-&gt;sbus_cfg1
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B32
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST16
)paren
(brace
id|qregs-&gt;sbus_cfg1
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST8
)paren
(brace
id|qregs-&gt;sbus_cfg1
op_assign
(paren
id|SBUS_CFG1_BENAB
op_or
id|SBUS_CFG1_B8
)paren
suffix:semicolon
)brace
r_else
(brace
id|qregs-&gt;sbus_cfg1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No sbus bursts for you... */
)brace
)brace
DECL|function|qlogicpti_mbox_command
r_static
r_int
id|qlogicpti_mbox_command
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
comma
id|u_short
id|param
(braket
)braket
comma
r_int
id|force
)paren
(brace
r_struct
id|qlogicpti_regs
op_star
id|qregs
op_assign
id|qpti-&gt;qregs
suffix:semicolon
r_int
id|loop_count
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_eq
l_int|0
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
id|qregs-&gt;hcctrl
op_amp
id|HCCTRL_HIRQ
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command loop timeout #1&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_rshift
l_int|4
)paren
(brace
r_case
l_int|6
suffix:colon
id|qregs-&gt;mbox5
op_assign
id|param
(braket
l_int|5
)braket
suffix:semicolon
r_case
l_int|5
suffix:colon
id|qregs-&gt;mbox4
op_assign
id|param
(braket
l_int|4
)braket
suffix:semicolon
r_case
l_int|4
suffix:colon
id|qregs-&gt;mbox3
op_assign
id|param
(braket
l_int|3
)braket
suffix:semicolon
r_case
l_int|3
suffix:colon
id|qregs-&gt;mbox2
op_assign
id|param
(braket
l_int|2
)braket
suffix:semicolon
r_case
l_int|2
suffix:colon
id|qregs-&gt;mbox1
op_assign
id|param
(braket
l_int|1
)braket
suffix:semicolon
r_case
l_int|1
suffix:colon
id|qregs-&gt;mbox0
op_assign
id|param
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|qregs-&gt;hcctrl
op_or_assign
id|HCCTRL_SHIRQ
suffix:semicolon
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
op_logical_neg
(paren
id|qregs-&gt;sbus_semaphore
op_amp
id|SBUS_SEMAPHORE_LCK
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command loop timeout #2&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
id|qregs-&gt;mbox0
op_eq
l_int|0x04
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: mbox_command loop timeout #3&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|force
)paren
(brace
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_CRIRQ
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|qregs-&gt;mbox5
op_minus
id|qpti-&gt;res_out_ptr
)paren
op_eq
l_int|0
)paren
(brace
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_CRIRQ
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|6
suffix:colon
id|param
(braket
l_int|5
)braket
op_assign
id|qregs-&gt;mbox5
suffix:semicolon
r_case
l_int|5
suffix:colon
id|param
(braket
l_int|4
)braket
op_assign
id|qregs-&gt;mbox4
suffix:semicolon
r_case
l_int|4
suffix:colon
id|param
(braket
l_int|3
)braket
op_assign
id|qregs-&gt;mbox3
suffix:semicolon
r_case
l_int|3
suffix:colon
id|param
(braket
l_int|2
)braket
op_assign
id|qregs-&gt;mbox2
suffix:semicolon
r_case
l_int|2
suffix:colon
id|param
(braket
l_int|1
)braket
op_assign
id|qregs-&gt;mbox1
suffix:semicolon
r_case
l_int|1
suffix:colon
id|param
(braket
l_int|0
)braket
op_assign
id|qregs-&gt;mbox0
suffix:semicolon
)brace
id|qregs-&gt;sbus_semaphore
op_and_assign
op_complement
(paren
id|SBUS_SEMAPHORE_LCK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_reset_hardware
r_static
r_int
id|qlogicpti_reset_hardware
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|qlogicpti_regs
op_star
id|qregs
op_assign
id|qpti-&gt;qregs
suffix:semicolon
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|loop_count
comma
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_PAUSE
suffix:semicolon
multiline_comment|/* Only reset the scsi bus if it is not free. */
r_if
c_cond
(paren
id|qregs-&gt;cpu_pctrl
op_amp
id|CPU_PCTRL_BSY
)paren
(brace
id|qregs-&gt;cpu_oride
op_assign
id|CPU_ORIDE_RMOD
suffix:semicolon
id|qregs-&gt;cpu_cmd
op_assign
id|CPU_CMD_BRESET
suffix:semicolon
id|udelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
)brace
id|qregs-&gt;sbus_ctrl
op_assign
id|SBUS_CTRL_RESET
suffix:semicolon
id|qregs-&gt;cmd_dma_ctrl
op_assign
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
suffix:semicolon
id|qregs-&gt;data_dma_ctrl
op_assign
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
suffix:semicolon
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
(paren
(paren
id|qregs-&gt;mbox0
op_amp
l_int|0xff
)paren
op_eq
l_int|0x04
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: reset_hardware loop timeout&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_PAUSE
suffix:semicolon
id|set_sbus_cfg1
c_func
(paren
id|qregs
comma
id|qpti-&gt;bursts
)paren
suffix:semicolon
id|qlogicpti_enable_irqs
c_func
(paren
id|qregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qregs-&gt;risc_psr
op_amp
id|RISC_PSR_ULTRA
)paren
(brace
id|qpti-&gt;ultra
op_assign
l_int|1
suffix:semicolon
id|qregs-&gt;risc_mtreg
op_assign
(paren
id|RISC_MTREG_P0ULTRA
op_or
id|RISC_MTREG_P1ULTRA
)paren
suffix:semicolon
)brace
r_else
(brace
id|qpti-&gt;ultra
op_assign
l_int|0
suffix:semicolon
id|qregs-&gt;risc_mtreg
op_assign
(paren
id|RISC_MTREG_P0DFLT
op_or
id|RISC_MTREG_P1DFLT
)paren
suffix:semicolon
)brace
multiline_comment|/* Release the RISC processor. */
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_REL
suffix:semicolon
multiline_comment|/* Get RISC to start executing the firmware code. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_EXEC_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot execute ISP firmware.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set initiator scsi ID. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_INIT_SCSI_ID
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.initiator_scsi_id
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot set initiator SCSI ID.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Initialize state of the queues, both hw and sw. */
id|qpti-&gt;req_in_ptr
op_assign
id|qpti-&gt;res_out_ptr
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_RES_QUEUE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|RES_QUEUE_LEN
op_plus
l_int|1
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;res_dvma
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;res_dvma
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot init response queue.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_REQ_QUEUE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|QLOGICISP_REQ_QUEUE_LEN
op_plus
l_int|1
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;req_dvma
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|qpti-&gt;req_dvma
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot init request queue.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_RETRY_COUNT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.retry_count
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|qpti-&gt;host_param.retry_delay
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TAG_AGE_LIMIT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.tag_aging
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_DEV_QUEUE_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_FIRMWARE_STATUS
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_SELECT_TIMEOUT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.selection_timeout
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SET_TARGET_PARAMS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_lshift
l_int|8
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_lshift
l_int|8
)paren
op_or
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|PTI_RESET_LIMIT
mdefine_line|#define PTI_RESET_LIMIT 400
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|qlogicpti_load_firmware
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
)paren
(brace
r_struct
id|qlogicpti_regs
op_star
id|qregs
op_assign
id|qpti-&gt;qregs
suffix:semicolon
r_int
r_int
id|csum
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if !defined(MODULE) &amp;&amp; !defined(__sparc_v9__)
r_int
r_int
id|dvma_addr
suffix:semicolon
macro_line|#endif
r_int
id|i
comma
id|timeout
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Verify the checksum twice, one before loading it, and once&n;&t; * afterwards via the mailbox commands.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_length01
suffix:semicolon
id|i
op_increment
)paren
(brace
id|csum
op_add_assign
id|risc_code01
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|csum
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: AIeee, firmware checksum failed!&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|qregs-&gt;sbus_ctrl
op_assign
id|SBUS_CTRL_RESET
suffix:semicolon
id|qregs-&gt;cmd_dma_ctrl
op_assign
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
suffix:semicolon
id|qregs-&gt;data_dma_ctrl
op_assign
(paren
id|DMA_CTRL_CCLEAR
op_or
id|DMA_CTRL_CIRQ
)paren
suffix:semicolon
id|timeout
op_assign
id|PTI_RESET_LIMIT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|timeout
op_logical_and
(paren
id|qregs-&gt;sbus_ctrl
op_amp
id|SBUS_CTRL_RESET
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot reset the ISP.&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_RESET
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|qregs-&gt;sbus_ctrl
op_assign
(paren
id|SBUS_CTRL_GENAB
op_or
id|SBUS_CTRL_ERIRQ
)paren
suffix:semicolon
id|set_sbus_cfg1
c_func
(paren
id|qregs
comma
id|qpti-&gt;bursts
)paren
suffix:semicolon
id|qregs-&gt;sbus_semaphore
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qregs-&gt;risc_psr
op_amp
id|RISC_PSR_ULTRA
)paren
(brace
id|qpti-&gt;ultra
op_assign
l_int|1
suffix:semicolon
id|qregs-&gt;risc_mtreg
op_assign
(paren
id|RISC_MTREG_P0ULTRA
op_or
id|RISC_MTREG_P1ULTRA
)paren
suffix:semicolon
)brace
r_else
(brace
id|qpti-&gt;ultra
op_assign
l_int|0
suffix:semicolon
id|qregs-&gt;risc_mtreg
op_assign
(paren
id|RISC_MTREG_P0DFLT
op_or
id|RISC_MTREG_P1DFLT
)paren
suffix:semicolon
)brace
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_REL
suffix:semicolon
multiline_comment|/* Pin lines are only stable while RISC is paused. */
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_PAUSE
suffix:semicolon
r_if
c_cond
(paren
id|qregs-&gt;cpu_pdiff
op_amp
id|CPU_PDIFF_MODE
)paren
(brace
id|qpti-&gt;differential
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|qpti-&gt;differential
op_assign
l_int|0
suffix:semicolon
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_REL
suffix:semicolon
multiline_comment|/* XXX Talk to PTI engineer about the following, ISP always&n;&t; * XXX returns 0x4001 return status for stop firmware command,&n;&t; * XXX documentation claims this means the cmd is unsupported&n;&t; * XXX on this ISP.  I think something fishy is going on.&n;&t; */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_STOP_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|param
(braket
l_int|2
)braket
op_assign
id|param
(braket
l_int|3
)braket
op_assign
id|param
(braket
l_int|4
)braket
op_assign
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Cannot stop firmware for reload.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Load the firmware. */
macro_line|#if !defined(MODULE) &amp;&amp; !defined(__sparc_v9__)
r_if
c_cond
(paren
id|sparc_cpu_model
op_ne
id|sun4d
)paren
(brace
id|dvma_addr
op_assign
(paren
r_int
r_int
)paren
id|mmu_lockarea
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|risc_code01
(braket
l_int|0
)braket
comma
(paren
r_sizeof
(paren
id|u_short
)paren
op_star
id|risc_code_length01
)paren
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_LOAD_RAM
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|dvma_addr
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|dvma_addr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
(paren
r_sizeof
(paren
id|u_short
)paren
op_star
id|risc_code_length01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: Firmware dload failed, I&squot;m bolixed!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mmu_unlockarea
c_func
(paren
(paren
r_char
op_star
)paren
id|dvma_addr
comma
(paren
r_sizeof
(paren
id|u_short
)paren
op_star
id|risc_code_length01
)paren
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
multiline_comment|/* We need to do it this slow way always on Ultra, SS[12]000. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_length01
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
op_plus
id|i
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|risc_code01
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: Firmware dload failed, I&squot;m bolixed!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset the ISP again. */
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_RESET
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|qlogicpti_enable_irqs
c_func
(paren
id|qregs
)paren
suffix:semicolon
id|qregs-&gt;sbus_semaphore
op_assign
l_int|0
suffix:semicolon
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_REL
suffix:semicolon
multiline_comment|/* Ask ISP to verify the checksum of the new code. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_VERIFY_CHECKSUM
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: New firmware csum failure!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Start using newly downloaded firmware. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_EXEC_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABOUT_FIRMWARE
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: AboutFirmware cmd fails.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Snag the major and minor revisions from the result. */
id|qpti-&gt;fware_majrev
op_assign
id|param
(braket
l_int|1
)braket
suffix:semicolon
id|qpti-&gt;fware_minrev
op_assign
id|param
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Load scsi initiator ID and interrupt level into sbus static ram. */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|0xff80
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
id|qpti-&gt;scsi_id
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|0xff00
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
l_int|3
suffix:semicolon
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_verify_tmon
r_static
r_int
id|qlogicpti_verify_tmon
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_int
id|curstat
op_assign
op_star
id|qpti-&gt;sreg
suffix:semicolon
id|curstat
op_and_assign
l_int|0xf0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|curstat
op_amp
id|SREG_FUSE
)paren
op_logical_and
(paren
id|qpti-&gt;swsreg
op_amp
id|SREG_FUSE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: Fuse returned to normal state.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|curstat
op_amp
id|SREG_TPOWER
)paren
op_logical_and
(paren
id|qpti-&gt;swsreg
op_amp
id|SREG_TPOWER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: termpwr back to normal state.&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curstat
op_ne
id|qpti-&gt;swsreg
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|curstat
op_amp
id|SREG_FUSE
)paren
(brace
id|error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: Fuse is open!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curstat
op_amp
id|SREG_TPOWER
)paren
(brace
id|error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: termpwr failure&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qpti-&gt;differential
op_logical_and
(paren
id|curstat
op_amp
id|SREG_DSENSE
)paren
op_ne
id|SREG_DSENSE
)paren
(brace
id|error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicpti%d: You have a single ended device on a &quot;
l_string|&quot;differential bus!  Please fix!&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
)brace
id|qpti-&gt;swsreg
op_assign
id|curstat
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_set_hostdev_defaults
r_static
r_inline
r_void
id|qlogicpti_set_hostdev_defaults
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
r_int
id|i
suffix:semicolon
id|qpti-&gt;host_param.initiator_scsi_id
op_assign
id|qpti-&gt;scsi_id
suffix:semicolon
id|qpti-&gt;host_param.bus_reset_delay
op_assign
l_int|3
suffix:semicolon
id|qpti-&gt;host_param.retry_count
op_assign
l_int|0
suffix:semicolon
id|qpti-&gt;host_param.retry_delay
op_assign
l_int|5
suffix:semicolon
id|qpti-&gt;host_param.async_data_setup_time
op_assign
l_int|3
suffix:semicolon
id|qpti-&gt;host_param.req_ack_active_negation
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.data_line_active_negation
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.data_dma_burst_enable
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.command_dma_burst_enable
op_assign
l_int|1
suffix:semicolon
id|qpti-&gt;host_param.tag_aging
op_assign
l_int|8
suffix:semicolon
id|qpti-&gt;host_param.selection_timeout
op_assign
l_int|250
suffix:semicolon
id|qpti-&gt;host_param.max_queue_depth
op_assign
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TARGETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_flags
op_assign
l_int|0xf9
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|execution_throttle
op_assign
l_int|16
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_period
op_assign
l_int|16
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|synchronous_offset
op_assign
l_int|12
suffix:semicolon
id|qpti-&gt;dev_param
(braket
id|i
)braket
dot
id|device_enable
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_static
r_void
id|do_qlogicpti_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
macro_line|#ifndef __sparc_v9__
r_static
r_void
id|do_qlogicpti_intr_handler_sun4m
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Detect all PTI Qlogic ISP&squot;s in the machine. */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|qlogicpti_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
comma
op_star
id|qlink
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|qpti_host
suffix:semicolon
r_struct
id|linux_sbus
op_star
id|sbus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|qpti_dev
comma
op_star
id|sbdev_iter
suffix:semicolon
r_struct
id|qlogicpti_regs
op_star
id|qregs
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|sreg
suffix:semicolon
r_int
r_char
id|bsizes
comma
id|bsizes_more
suffix:semicolon
r_int
id|nqptis
op_assign
l_int|0
comma
id|nqptis_in_use
op_assign
l_int|0
suffix:semicolon
r_int
id|qpti_node
suffix:semicolon
r_int
id|is_pti
suffix:semicolon
id|tpnt-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_qlogicpti
suffix:semicolon
id|qptichain
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SBus_chain
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sbdev_iter
comma
id|sbus
)paren
(brace
id|qpti_dev
op_assign
id|sbdev_iter
suffix:semicolon
multiline_comment|/* Is this a red snapper? */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|qpti_dev-&gt;prom_name
comma
l_string|&quot;ptisp&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|qpti_dev-&gt;prom_name
comma
l_string|&quot;PTI,ptisp&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|qpti_dev-&gt;prom_name
comma
l_string|&quot;QLGC,isp&quot;
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Sometimes Antares cards come up not completely&n;&t;&t;&t; * setup, and we get a report of a zero IRQ.&n;&t;&t;&t; * Skip over them in such cases so we survive.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|qpti_dev-&gt;irqs
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qpti%d: Adapter reports no interrupt, &quot;
l_string|&quot;skipping over this card.&quot;
comma
id|nqptis
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Yep, register and allocate software state. */
id|qpti_host
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|qlogicpti
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qpti_host
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Cannot register PTI Qlogic ISP SCSI host&quot;
)paren
suffix:semicolon
)brace
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|qpti_host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qpti
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;No qpti in hostdata&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* We are wide capable, 16 targets. */
id|qpti_host-&gt;max_id
op_assign
id|MAX_TARGETS
suffix:semicolon
multiline_comment|/* Setup back pointers and misc. state. */
id|qpti-&gt;qhost
op_assign
id|qpti_host
suffix:semicolon
id|qpti-&gt;qdev
op_assign
id|qpti_dev
suffix:semicolon
id|qpti-&gt;qpti_id
op_assign
id|nqptis
op_increment
suffix:semicolon
multiline_comment|/* Insert this one into the global interrupt service chain. */
r_if
c_cond
(paren
id|qptichain
)paren
(brace
id|qlink
op_assign
id|qptichain
suffix:semicolon
r_while
c_loop
(paren
id|qlink-&gt;next
)paren
(brace
id|qlink
op_assign
id|qlink-&gt;next
suffix:semicolon
)brace
id|qlink-&gt;next
op_assign
id|qpti
suffix:semicolon
)brace
r_else
(brace
id|qptichain
op_assign
id|qpti
suffix:semicolon
)brace
id|qpti-&gt;next
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* More misc. prom information. */
id|qpti_node
op_assign
id|qpti_dev-&gt;prom_node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|qpti_node
comma
l_string|&quot;name&quot;
comma
id|qpti-&gt;prom_name
comma
r_sizeof
(paren
id|qpti-&gt;prom_name
)paren
)paren
suffix:semicolon
id|qpti-&gt;prom_node
op_assign
id|qpti_node
suffix:semicolon
id|is_pti
op_assign
id|strcmp
(paren
id|qpti-&gt;prom_name
comma
l_string|&quot;QLGC,isp&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup the reg property for this device. */
id|prom_apply_sbus_ranges
c_func
(paren
id|qpti-&gt;qdev-&gt;my_bus
comma
id|qpti-&gt;qdev-&gt;reg_addrs
comma
l_int|1
comma
id|qpti-&gt;qdev
)paren
suffix:semicolon
multiline_comment|/* Map in Qlogic,ISP regs and the PTI status reg. */
id|qpti-&gt;qregs
op_assign
id|qregs
op_assign
(paren
r_struct
id|qlogicpti_regs
op_star
)paren
id|sparc_alloc_io
c_func
(paren
id|qpti-&gt;qdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|qpti-&gt;qdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
comma
l_string|&quot;PTI Qlogic/ISP Registers&quot;
comma
id|qpti-&gt;qdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0x0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qregs
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PTI Qlogic/ISP registers unmappable&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_pti
)paren
(brace
multiline_comment|/* Map this one read only. */
id|qpti-&gt;sreg
op_assign
id|sreg
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|sparc_alloc_io
c_func
(paren
(paren
id|qpti-&gt;qdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
op_plus
(paren
l_int|16
op_star
l_int|4096
)paren
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_int
r_char
)paren
comma
l_string|&quot;PTI Qlogic/ISP Status Reg&quot;
comma
id|qpti-&gt;qdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sreg
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PTI Qlogic/ISP status reg unmappable&quot;
)paren
suffix:semicolon
)brace
id|qpti-&gt;swsreg
op_assign
l_int|0
suffix:semicolon
)brace
id|qpti_host-&gt;base
op_assign
(paren
r_int
r_char
op_star
)paren
id|qregs
suffix:semicolon
id|qpti_host-&gt;io_port
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|qregs
)paren
suffix:semicolon
id|qpti_host-&gt;n_io_port
op_assign
(paren
r_int
r_char
)paren
id|qpti-&gt;qdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|qpti_host-&gt;irq
op_assign
id|qpti-&gt;irq
op_assign
id|qpti-&gt;qdev-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* On Ultra and S{S1,C2}000 we must always call request_irq for each&n;&t;&t;&t; * qpti, so that imap registers get setup etc.&n;&t;&t;&t; * But irq values are different in that case anyway...&n;&t;&t;&t; * Otherwise allocate the irq only if necessary.&n;&t;&t;&t; */
id|for_each_qlogicpti
c_func
(paren
id|qlink
)paren
(brace
r_if
c_cond
(paren
(paren
id|qlink
op_ne
id|qpti
)paren
op_logical_and
(paren
id|qpti-&gt;irq
op_eq
id|qlink-&gt;irq
)paren
)paren
(brace
r_goto
id|qpti_irq_acquired
suffix:semicolon
multiline_comment|/* BASIC rulez */
)brace
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|qpti-&gt;qhost-&gt;irq
comma
macro_line|#ifndef __sparc_v9__&t;&t;&t;
(paren
id|sparc_cpu_model
op_eq
id|sun4m
op_logical_or
id|sparc_cpu_model
op_eq
id|sun4c
)paren
ques
c_cond
id|do_qlogicpti_intr_handler_sun4m
suffix:colon
macro_line|#endif
id|do_qlogicpti_intr_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;PTI Qlogic/ISP SCSI&quot;
comma
id|qpti
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cannot acquire PTI Qlogic/ISP irq line&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX Unmap regs, unregister scsi host, free things. */
r_continue
suffix:semicolon
)brace
id|qpti_irq_acquired
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qpti%d: IRQ %s &quot;
comma
id|qpti-&gt;qpti_id
comma
id|__irq_itoa
c_func
(paren
id|qpti-&gt;qhost-&gt;irq
)paren
)paren
suffix:semicolon
multiline_comment|/* Figure out our scsi ID on the bus */
id|qpti-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;initiator-id&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpti-&gt;scsi_id
op_eq
op_minus
l_int|1
)paren
(brace
id|qpti-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;scsi-initiator-id&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qpti-&gt;scsi_id
op_eq
op_minus
l_int|1
)paren
(brace
id|qpti-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;qdev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;scsi-initiator-id&quot;
comma
l_int|7
)paren
suffix:semicolon
)brace
id|qpti-&gt;qhost-&gt;this_id
op_assign
id|qpti-&gt;scsi_id
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSI ID %d &quot;
comma
id|qpti-&gt;scsi_id
)paren
suffix:semicolon
multiline_comment|/* Check for what the best SBUS burst we can use happens&n;&t;&t;&t; * to be on this machine.&n;&t;&t;&t; */
id|bsizes
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|bsizes
op_and_assign
l_int|0xff
suffix:semicolon
id|bsizes_more
op_assign
id|prom_getintdefault
c_func
(paren
id|qpti-&gt;qdev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bsizes_more
op_ne
l_int|0xff
)paren
(brace
id|bsizes
op_and_assign
id|bsizes_more
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bsizes
op_eq
l_int|0xff
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST16
)paren
op_eq
l_int|0
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST32
)paren
op_eq
l_int|0
)paren
(brace
id|bsizes
op_assign
(paren
id|DMA_BURST32
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|qpti-&gt;bursts
op_assign
id|bsizes
suffix:semicolon
multiline_comment|/* The request and response queues must each be aligned&n;&t;&t;&t; * on a page boundry.&n;&t;&t;&t; */
DECL|macro|QSIZE
mdefine_line|#define QSIZE(entries)&t;(((entries) + 1) * QUEUE_ENTRY_LEN)
id|qpti-&gt;res_cpu
op_assign
id|sparc_dvma_malloc
c_func
(paren
id|QSIZE
c_func
(paren
id|RES_QUEUE_LEN
)paren
comma
l_string|&quot;PTISP Response Queue&quot;
comma
op_amp
id|qpti-&gt;res_dvma
)paren
suffix:semicolon
id|qpti-&gt;req_cpu
op_assign
id|sparc_dvma_malloc
c_func
(paren
id|QSIZE
c_func
(paren
id|QLOGICISP_REQ_QUEUE_LEN
)paren
comma
l_string|&quot;PTISP Request Queue&quot;
comma
op_amp
id|qpti-&gt;req_dvma
)paren
suffix:semicolon
DECL|macro|QSIZE
macro_line|#undef QSIZE
multiline_comment|/* Set adapter and per-device default values. */
id|qlogicpti_set_hostdev_defaults
c_func
(paren
id|qpti
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_pti
)paren
(brace
multiline_comment|/* Load the firmware. */
r_if
c_cond
(paren
id|qlogicpti_load_firmware
c_func
(paren
id|qpti
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PTI Qlogic/ISP firmware load failed&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Check the PTI status reg. */
r_if
c_cond
(paren
id|qlogicpti_verify_tmon
c_func
(paren
id|qpti
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PTI Qlogic/ISP tmon verification failed&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset the ISP and init res/req queues. */
r_if
c_cond
(paren
id|qlogicpti_reset_hardware
c_func
(paren
id|qpti_host
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PTI Qlogic/ISP cannot be reset&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_pti
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(Firmware v%d.%d)&quot;
comma
id|qpti-&gt;fware_majrev
comma
id|qpti-&gt;fware_minrev
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
id|buffer
(braket
l_int|60
)braket
suffix:semicolon
id|prom_getstring
(paren
id|qpti_node
comma
l_string|&quot;isp-fcode&quot;
comma
id|buffer
comma
l_int|60
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Firmware %s)&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot; [%s Wide, using %s interface]&bslash;n&quot;
comma
(paren
id|qpti-&gt;ultra
ques
c_cond
l_string|&quot;Ultra&quot;
suffix:colon
l_string|&quot;Fast&quot;
)paren
comma
(paren
id|qpti-&gt;differential
ques
c_cond
l_string|&quot;differential&quot;
suffix:colon
l_string|&quot;single ended&quot;
)paren
)paren
suffix:semicolon
id|nqptis_in_use
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nqptis
)paren
id|printk
c_func
(paren
l_string|&quot;QPTI: Total of %d PTI Qlogic/ISP hosts found, %d actually in use.&bslash;n&quot;
comma
id|nqptis
comma
id|nqptis_in_use
)paren
suffix:semicolon
id|qptis_running
op_assign
id|nqptis_in_use
suffix:semicolon
r_return
id|nqptis
suffix:semicolon
)brace
DECL|function|qlogicpti_release
r_int
id|qlogicpti_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|qlogicpti_regs
op_star
id|qregs
op_assign
id|qpti-&gt;qregs
suffix:semicolon
multiline_comment|/* Shut up the card. */
id|qregs-&gt;sbus_ctrl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free IRQ handler and unmap Qlogic,ISP and PTI status regs. */
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|unmapioaddr
c_func
(paren
(paren
r_int
r_int
)paren
id|qregs
)paren
suffix:semicolon
multiline_comment|/* QLGC,isp doesn&squot;t have status reg */
r_if
c_cond
(paren
id|strcmp
(paren
id|qpti-&gt;prom_name
comma
l_string|&quot;QLGC,isp&quot;
)paren
)paren
id|unmapioaddr
c_func
(paren
(paren
r_int
r_int
)paren
id|qpti-&gt;sreg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_info
r_const
r_char
op_star
id|qlogicpti_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|80
)braket
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;PTI Qlogic,ISP SBUS SCSI irq %s regs at %08lx&quot;
comma
id|__irq_itoa
c_func
(paren
id|qpti-&gt;qhost-&gt;irq
)paren
comma
(paren
r_int
r_int
)paren
id|qpti-&gt;qregs
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
multiline_comment|/* I am a certified frobtronicist. */
DECL|function|marker_frob
r_static
r_inline
r_void
id|marker_frob
c_func
(paren
r_struct
id|Command_Entry
op_star
id|cmd
)paren
(brace
r_struct
id|Marker_Entry
op_star
id|marker
op_assign
(paren
r_struct
id|Marker_Entry
op_star
)paren
id|cmd
suffix:semicolon
id|memset
c_func
(paren
id|marker
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Marker_Entry
)paren
)paren
suffix:semicolon
id|marker-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|marker-&gt;hdr.entry_type
op_assign
id|ENTRY_MARKER
suffix:semicolon
id|marker-&gt;modifier
op_assign
id|SYNC_ALL
suffix:semicolon
id|marker-&gt;rsvd
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|cmd_frob
r_static
r_inline
r_void
id|cmd_frob
c_func
(paren
r_struct
id|Command_Entry
op_star
id|cmd
comma
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Command_Entry
)paren
)paren
suffix:semicolon
id|cmd-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;hdr.entry_type
op_assign
id|ENTRY_COMMAND
suffix:semicolon
macro_line|#ifdef __sparc_v9__
id|cmd-&gt;handle
op_assign
(paren
id|u_int
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd
)paren
op_minus
id|PAGE_OFFSET
)paren
suffix:semicolon
multiline_comment|/* magic mushroom */
macro_line|#else
id|cmd-&gt;handle
op_assign
(paren
id|u_int
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd
)paren
suffix:semicolon
multiline_comment|/* magic mushroom */
macro_line|#endif
id|cmd-&gt;target_id
op_assign
id|Cmnd-&gt;target
suffix:semicolon
id|cmd-&gt;target_lun
op_assign
id|Cmnd-&gt;lun
suffix:semicolon
id|cmd-&gt;cdb_length
op_assign
id|Cmnd-&gt;cmd_len
suffix:semicolon
id|cmd-&gt;control_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;device-&gt;tagged_supported
)paren
(brace
r_if
c_cond
(paren
id|qpti-&gt;cmd_count
(braket
id|Cmnd-&gt;target
)braket
op_eq
l_int|0
)paren
(brace
id|qpti-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|qpti-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
)paren
OG
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
id|cmd-&gt;control_flags
op_assign
id|CFLAG_ORDERED_TAG
suffix:semicolon
id|qpti-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
id|cmd-&gt;control_flags
op_assign
id|CFLAG_SIMPLE_TAG
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
op_logical_or
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_10
)paren
op_logical_or
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_12
)paren
)paren
(brace
id|cmd-&gt;control_flags
op_or_assign
id|CFLAG_WRITE
suffix:semicolon
)brace
r_else
id|cmd-&gt;control_flags
op_or_assign
id|CFLAG_READ
suffix:semicolon
id|cmd-&gt;time_out
op_assign
l_int|30
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;cdb
comma
id|Cmnd-&gt;cmnd
comma
id|Cmnd-&gt;cmd_len
)paren
suffix:semicolon
)brace
multiline_comment|/* Do it to it baby. */
DECL|function|load_cmd
r_static
r_inline
id|u_int
id|load_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_struct
id|Command_Entry
op_star
id|cmd
comma
r_struct
id|qlogicpti
op_star
id|qpti
comma
r_struct
id|qlogicpti_regs
op_star
id|qregs
comma
id|u_int
id|in_ptr
comma
id|u_int
id|out_ptr
)paren
(brace
r_struct
id|dataseg
op_star
id|ds
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|sg_count
op_assign
id|Cmnd-&gt;use_sg
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|sg_count
)paren
(brace
id|mmu_get_scsi_sgl
c_func
(paren
(paren
r_struct
id|mmu_sglist
op_star
)paren
id|Cmnd-&gt;buffer
comma
(paren
id|Cmnd-&gt;use_sg
op_minus
l_int|1
)paren
comma
id|qpti-&gt;qdev-&gt;my_bus
)paren
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
id|sg_count
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;request_buffer
suffix:semicolon
id|ds
op_assign
id|cmd-&gt;dataseg
suffix:semicolon
multiline_comment|/* Fill in first four sg entries: */
id|n
op_assign
id|sg_count
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|4
)paren
(brace
id|n
op_assign
l_int|4
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|ds
(braket
id|i
)braket
dot
id|d_base
op_assign
(paren
id|u_int
)paren
id|sg-&gt;dvma_address
suffix:semicolon
id|ds
(braket
id|i
)braket
dot
id|d_count
op_assign
(paren
id|u_int
)paren
id|sg-&gt;length
suffix:semicolon
)brace
id|sg_count
op_sub_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
id|sg_count
OG
l_int|0
)paren
(brace
r_struct
id|Continuation_Entry
op_star
id|cont
suffix:semicolon
op_increment
id|cmd-&gt;hdr.entry_cnt
suffix:semicolon
id|cont
op_assign
(paren
r_struct
id|Continuation_Entry
op_star
)paren
op_amp
id|qpti-&gt;req_cpu
(braket
id|in_ptr
)braket
suffix:semicolon
id|in_ptr
op_assign
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_ptr
op_eq
id|out_ptr
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti: Unexpected request queue overflow&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cont-&gt;hdr.entry_type
op_assign
id|ENTRY_CONTINUATION
suffix:semicolon
id|cont-&gt;hdr.entry_cnt
op_assign
l_int|0
suffix:semicolon
id|cont-&gt;hdr.sys_def_1
op_assign
l_int|0
suffix:semicolon
id|cont-&gt;hdr.flags
op_assign
l_int|0
suffix:semicolon
id|cont-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|ds
op_assign
id|cont-&gt;dataseg
suffix:semicolon
id|n
op_assign
id|sg_count
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|7
)paren
(brace
id|n
op_assign
l_int|7
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|ds
(braket
id|i
)braket
dot
id|d_base
op_assign
(paren
id|u_int
)paren
id|sg-&gt;dvma_address
suffix:semicolon
id|ds
(braket
id|i
)braket
dot
id|d_count
op_assign
(paren
id|u_int
)paren
id|sg-&gt;length
suffix:semicolon
)brace
id|sg_count
op_sub_assign
id|n
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* XXX Casts are extremely gross, but with 64-bit cpu addresses&n;&t;&t; * XXX and 32-bit SBUS DVMA addresses what am I to do? -DaveM&n;&t;&t; */
id|Cmnd-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|mmu_get_scsi_one
c_func
(paren
(paren
r_char
op_star
)paren
id|Cmnd-&gt;request_buffer
comma
id|Cmnd-&gt;request_bufflen
comma
id|qpti-&gt;qdev-&gt;my_bus
)paren
)paren
suffix:semicolon
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base
op_assign
(paren
id|u_int
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd-&gt;SCp.ptr
)paren
suffix:semicolon
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_count
op_assign
id|Cmnd-&gt;request_bufflen
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
l_int|1
suffix:semicolon
)brace
id|qpti-&gt;cmd_count
(braket
id|Cmnd-&gt;target
)braket
op_increment
suffix:semicolon
id|qregs-&gt;mbox4
op_assign
id|in_ptr
suffix:semicolon
id|qpti-&gt;req_in_ptr
op_assign
id|in_ptr
suffix:semicolon
r_return
id|in_ptr
suffix:semicolon
)brace
DECL|function|update_can_queue
r_static
r_inline
r_void
id|update_can_queue
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|u_int
id|in_ptr
comma
id|u_int
id|out_ptr
)paren
(brace
multiline_comment|/* Temporary workaround until bug is found and fixed (one bug has been found&n;&t;   already, but fixing it makes things even worse) -jj */
r_int
id|num_free
op_assign
id|QLOGICISP_REQ_QUEUE_LEN
op_minus
id|REQ_QUEUE_DEPTH
c_func
(paren
id|in_ptr
comma
id|out_ptr
)paren
op_minus
l_int|64
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|host-&gt;host_busy
op_plus
id|num_free
suffix:semicolon
id|host-&gt;sg_tablesize
op_assign
id|QLOGICISP_MAX_SG
c_func
(paren
id|num_free
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The middle SCSI layer ensures that queuecommand never gets invoked&n; * concurrently with itself or the interrupt handler (though the&n; * interrupt handler may call this routine as part of&n; * request-completion handling).&n; *&n; * &quot;This code must fly.&quot; -davem&n; */
DECL|function|qlogicpti_queuecommand
r_int
id|qlogicpti_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|qlogicpti_regs
op_star
id|qregs
op_assign
id|qpti-&gt;qregs
suffix:semicolon
id|u_int
id|in_ptr
op_assign
id|qpti-&gt;req_in_ptr
suffix:semicolon
id|u_int
id|out_ptr
op_assign
id|qregs-&gt;mbox4
suffix:semicolon
r_struct
id|Command_Entry
op_star
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|qpti-&gt;req_cpu
(braket
id|in_ptr
)braket
suffix:semicolon
id|Cmnd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|in_ptr
op_assign
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_ptr
op_eq
id|out_ptr
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: request queue overflow&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
multiline_comment|/* Unfortunately, unless you use the new EH code, which&n;&t;&t; * we don&squot;t, the midlayer will ignore the return value,&n;&t;&t; * which is insane.  We pick up the pieces like this.&n;&t;&t; */
id|Cmnd-&gt;result
op_assign
id|DID_BUS_BUSY
suffix:semicolon
id|done
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qpti-&gt;send_marker
)paren
(brace
id|marker_frob
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|qpti-&gt;send_marker
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
op_eq
id|out_ptr
)paren
(brace
id|qregs-&gt;mbox4
op_assign
id|in_ptr
suffix:semicolon
id|qpti-&gt;req_in_ptr
op_assign
id|in_ptr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti%d: request queue overflow&bslash;n&quot;
comma
id|qpti-&gt;qpti_id
)paren
suffix:semicolon
multiline_comment|/* Unfortunately, unless you use the new EH code, which&n;&t;&t;&t; * we don&squot;t, the midlayer will ignore the return value,&n;&t;&t;&t; * which is insane.  We pick up the pieces like this.&n;&t;&t;&t; */
id|Cmnd-&gt;result
op_assign
id|DID_BUS_BUSY
suffix:semicolon
id|done
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|qpti-&gt;req_cpu
(braket
id|in_ptr
)braket
suffix:semicolon
id|in_ptr
op_assign
id|NEXT_REQ_PTR
c_func
(paren
id|in_ptr
)paren
suffix:semicolon
)brace
id|cmd_frob
c_func
(paren
id|cmd
comma
id|Cmnd
comma
id|qpti
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_ptr
op_assign
id|load_cmd
c_func
(paren
id|Cmnd
comma
id|cmd
comma
id|qpti
comma
id|qregs
comma
id|in_ptr
comma
id|out_ptr
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Unfortunately, unless you use the new EH code, which&n;&t;&t; * we don&squot;t, the midlayer will ignore the return value,&n;&t;&t; * which is insane.  We pick up the pieces like this.&n;&t;&t; */
id|Cmnd-&gt;result
op_assign
id|DID_BUS_BUSY
suffix:semicolon
id|done
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|update_can_queue
c_func
(paren
id|host
comma
id|in_ptr
comma
id|out_ptr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qlogicpti_return_status
r_static
r_int
id|qlogicpti_return_status
c_func
(paren
r_struct
id|Status_Entry
op_star
id|sts
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_switch
c_cond
(paren
id|sts-&gt;completion_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_INCOMPLETE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_BUS
)paren
)paren
id|host_status
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_TARGET
)paren
)paren
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_SENT_CDB
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_TRANSFERRED_DATA
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_STATUS
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DMA_ERROR
suffix:colon
r_case
id|CS_TRANSPORT_ERROR
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET_OCCURRED
suffix:colon
r_case
id|CS_BUS_RESET
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
r_case
id|CS_COMMAND_OVERRUN
suffix:colon
r_case
id|CS_STATUS_OVERRUN
suffix:colon
r_case
id|CS_BAD_MESSAGE
suffix:colon
r_case
id|CS_NO_MESSAGE_OUT
suffix:colon
r_case
id|CS_EXT_ID_FAILED
suffix:colon
r_case
id|CS_IDE_MSG_FAILED
suffix:colon
r_case
id|CS_ABORT_MSG_FAILED
suffix:colon
r_case
id|CS_NOP_MSG_FAILED
suffix:colon
r_case
id|CS_PARITY_ERROR_MSG_FAILED
suffix:colon
r_case
id|CS_DEVICE_RESET_MSG_FAILED
suffix:colon
r_case
id|CS_ID_MSG_FAILED
suffix:colon
r_case
id|CS_UNEXP_BUS_FREE
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti : unknown completion status 0x%04x&bslash;n&quot;
comma
id|sts-&gt;completion_status
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|sts-&gt;scsi_status
op_amp
id|STATUS_MASK
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_intr_handler
r_static
id|__inline__
r_int
id|qlogicpti_intr_handler
c_func
(paren
r_struct
id|qlogicpti
op_star
id|qpti
)paren
(brace
id|Scsi_Cmnd
op_star
id|Cmnd
suffix:semicolon
r_struct
id|Status_Entry
op_star
id|sts
suffix:semicolon
id|u_int
id|in_ptr
comma
id|out_ptr
suffix:semicolon
r_struct
id|qlogicpti_regs
op_star
id|qregs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|qpti-&gt;qregs-&gt;sbus_stat
op_amp
id|SBUS_STAT_RINT
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|qregs
op_assign
id|qpti-&gt;qregs
suffix:semicolon
id|in_ptr
op_assign
id|qregs-&gt;mbox5
suffix:semicolon
id|qregs-&gt;hcctrl
op_assign
id|HCCTRL_CRIRQ
suffix:semicolon
r_if
c_cond
(paren
id|qregs-&gt;sbus_semaphore
op_amp
id|SBUS_SEMAPHORE_LCK
)paren
(brace
r_switch
c_cond
(paren
id|qregs-&gt;mbox0
)paren
(brace
r_case
id|ASYNC_SCSI_BUS_RESET
suffix:colon
r_case
id|EXECUTION_TIMEOUT_RESET
suffix:colon
id|qpti-&gt;send_marker
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INVALID_COMMAND
suffix:colon
r_case
id|HOST_INTERFACE_ERROR
suffix:colon
r_case
id|COMMAND_ERROR
suffix:colon
r_case
id|COMMAND_PARAM_ERROR
suffix:colon
r_break
suffix:semicolon
)brace
id|qregs-&gt;sbus_semaphore
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This looks like a network driver! */
id|out_ptr
op_assign
id|qpti-&gt;res_out_ptr
suffix:semicolon
r_while
c_loop
(paren
id|out_ptr
op_ne
id|in_ptr
)paren
(brace
id|sts
op_assign
(paren
r_struct
id|Status_Entry
op_star
)paren
op_amp
id|qpti-&gt;res_cpu
(braket
id|out_ptr
)braket
suffix:semicolon
id|out_ptr
op_assign
id|NEXT_RES_PTR
c_func
(paren
id|out_ptr
)paren
suffix:semicolon
id|Cmnd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|sts-&gt;handle
)paren
op_plus
id|PAGE_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;completion_status
op_eq
id|CS_RESET_OCCURRED
op_logical_or
id|sts-&gt;completion_status
op_eq
id|CS_ABORTED
op_logical_or
(paren
id|sts-&gt;status_flags
op_amp
id|STF_BUS_RESET
)paren
)paren
(brace
id|qpti-&gt;send_marker
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
(brace
id|memcpy
c_func
(paren
id|Cmnd-&gt;sense_buffer
comma
id|sts-&gt;req_sense_data
comma
r_sizeof
(paren
id|Cmnd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sts-&gt;hdr.entry_type
op_eq
id|ENTRY_STATUS
)paren
(brace
id|Cmnd-&gt;result
op_assign
id|qlogicpti_return_status
c_func
(paren
id|sts
)paren
suffix:semicolon
)brace
r_else
id|Cmnd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
)paren
(brace
id|mmu_release_scsi_sgl
c_func
(paren
(paren
r_struct
id|mmu_sglist
op_star
)paren
id|Cmnd-&gt;buffer
comma
id|Cmnd-&gt;use_sg
op_minus
l_int|1
comma
id|qpti-&gt;qdev-&gt;my_bus
)paren
suffix:semicolon
)brace
r_else
id|mmu_release_scsi_one
c_func
(paren
(paren
id|__u32
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd-&gt;SCp.ptr
)paren
comma
id|Cmnd-&gt;request_bufflen
comma
id|qpti-&gt;qdev-&gt;my_bus
)paren
suffix:semicolon
id|qpti-&gt;cmd_count
(braket
id|Cmnd-&gt;target
)braket
op_decrement
suffix:semicolon
id|qregs-&gt;mbox5
op_assign
id|out_ptr
suffix:semicolon
id|Cmnd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|Cmnd
)paren
suffix:semicolon
)brace
id|qpti-&gt;res_out_ptr
op_assign
id|out_ptr
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifndef __sparc_v9__
DECL|function|do_qlogicpti_intr_handler_sun4m
r_static
r_void
id|do_qlogicpti_intr_handler_sun4m
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
suffix:semicolon
r_int
id|again
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|again
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|for_each_qlogicpti
c_func
(paren
id|qpti
)paren
id|again
op_or_assign
id|qlogicpti_intr_handler
c_func
(paren
id|qpti
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|again
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|do_qlogicpti_intr_handler
r_static
r_void
id|do_qlogicpti_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|qlogicpti_intr_handler
c_func
(paren
(paren
r_struct
id|qlogicpti
op_star
)paren
id|dev_id
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|qlogicpti_abort
r_int
id|qlogicpti_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qlogicpti : Aborting cmd for tgt[%d] lun[%d]&bslash;n&quot;
comma
(paren
r_int
)paren
id|Cmnd-&gt;target
comma
(paren
r_int
)paren
id|Cmnd-&gt;lun
)paren
suffix:semicolon
id|qlogicpti_disable_irqs
c_func
(paren
id|qpti-&gt;qregs
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABORT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
(paren
(paren
id|u_short
)paren
id|Cmnd-&gt;target
)paren
op_lshift
l_int|8
)paren
op_or
id|Cmnd-&gt;lun
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd
)paren
)paren
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|Cmnd
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicpti : scsi abort failure: %x&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
id|qlogicpti_enable_irqs
c_func
(paren
id|qpti-&gt;qregs
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
DECL|function|qlogicpti_reset
r_int
id|qlogicpti_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|u_short
id|param
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
r_struct
id|qlogicpti
op_star
id|qpti
op_assign
(paren
r_struct
id|qlogicpti
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_RESET_SUCCESS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qlogicpti : Resetting SCSI bus!&bslash;n&quot;
)paren
suffix:semicolon
id|qlogicpti_disable_irqs
c_func
(paren
id|qpti-&gt;qregs
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_BUS_RESET
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|qpti-&gt;host_param.bus_reset_delay
suffix:semicolon
r_if
c_cond
(paren
id|qlogicpti_mbox_command
c_func
(paren
id|qpti
comma
id|param
comma
l_int|0
)paren
op_logical_or
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;qlogicisp : scsi bus reset failure: %x&bslash;n&quot;
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
id|qlogicpti_enable_irqs
c_func
(paren
id|qpti-&gt;qregs
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|QLOGICPTI
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
id|EXPORT_NO_SYMBOLS
suffix:semicolon
macro_line|#endif /* MODULE */
eof
