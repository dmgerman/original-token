multiline_comment|/************************************************************&n; *                                                          *&n; *                  Linux EATA SCSI driver                  *&n; *                                                          *&n; *  based on the CAM document CAM/89-004 rev. 2.0c,         *&n; *  DPT&squot;s driver kit, some internal documents and source,   *&n; *  and several other Linux scsi drivers and kernel docs.   *&n; *                                                          *&n; *  The driver currently:                                   *&n; *      -supports all ISA based EATA-DMA boards             *&n; *      -supports all EISA based EATA-DMA boards            *&n; *      -supports all PCI based EATA-DMA boards             *&n; *      -supports multiple HBAs with &amp; without IRQ sharing  *&n; *      -supports all SCSI channels on multi channel boards *&n; *      -displays (more or less useful) infos in /proc/scsi *&n; *      -can be loaded as module                            *&n; *                                                          *&n; *  (c)1993,94,95 Michael Neuffer                           *&n; *                neuffer@goofy.zdv.uni-mainz.de            *&n; *                                                          *&n; *  This program is free software; you can redistribute it  *&n; *  and/or modify it under the terms of the GNU General     *&n; *  Public License as published by the Free Software        *&n; *  Foundation; either version 2 of the License, or         *&n; *  (at your option) any later version.                     *&n; *                                                          *&n; *  This program is distributed in the hope that it will be *&n; *  useful, but WITHOUT ANY WARRANTY; without even the      *&n; *  implied warranty of MERCHANTABILITY or FITNESS FOR A    *&n; *  PARTICULAR PURPOSE.  See the GNU General Public License *&n; *  for more details.                                       *&n; *                                                          *&n; *  You should have received a copy of the GNU General      *&n; *  Public License along with this kernel; if not, write to *&n; *  the Free Software Foundation, Inc., 675 Mass Ave,       *&n; *  Cambridge, MA 02139, USA.                               *&n; *                                                          *&n; * I have to thank DPT for their excellent support. I took  *&n; * me almost a year and a stopover at their HQ, on my first *&n; * trip to the USA, to get it, but since then they&squot;ve been  *&n; * very helpful and tried to give me all the infos and      *&n; * support I need.                                          *&n; *                                                          *&n; * Thanks also to Greg Hosler who did a lot of testing and  *&n; * found quite a number of bugs during the development.     *&n; ************************************************************&n; *  last change: 95/04/10       OS: Linux 1.2.00 or higher  *&n; ************************************************************/
multiline_comment|/* Look in eata_dma.h for configuration and revision information */
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &quot;../block/blk.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;linux/scsicam.h&gt;
macro_line|#include &quot;eata_dma.h&quot;
macro_line|#if EATA_DMA_PROC  
macro_line|#include &quot;eata_dma_proc.h&quot;  /* If you&squot;re interested send me a mail */ 
DECL|variable|reads
id|ulong
id|reads
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* /proc/scsi probably won&squot;t get       */
DECL|variable|writes
id|ulong
id|writes
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* into the kernel before pl. 1.3      */
macro_line|#endif
DECL|variable|ISAbases
r_static
id|uint
id|ISAbases
(braket
)braket
op_assign
(brace
l_int|0x1F0
comma
l_int|0x170
comma
l_int|0x330
comma
l_int|0x230
)brace
suffix:semicolon
DECL|variable|EISAbases
r_static
id|unchar
id|EISAbases
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
)brace
suffix:semicolon
DECL|variable|registered_HBAs
r_static
id|uint
id|registered_HBAs
op_assign
l_int|0
suffix:semicolon
DECL|variable|last_HBA
r_static
r_struct
id|Scsi_Host
op_star
id|last_HBA
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|first_HBA
r_static
r_struct
id|Scsi_Host
op_star
id|first_HBA
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|reg_IRQ
r_static
id|unchar
id|reg_IRQ
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|reg_IRQL
r_static
id|unchar
id|reg_IRQL
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|status
r_static
r_struct
id|eata_sp
op_star
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Statuspacket array   */
DECL|variable|dma_scratch
r_static
r_void
op_star
id|dma_scratch
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_command_finished
r_static
id|uint
id|internal_command_finished
op_assign
id|TRUE
suffix:semicolon
DECL|variable|HBA_interpret
r_static
id|unchar
id|HBA_interpret
op_assign
id|FALSE
suffix:semicolon
DECL|variable|fake_int_base
r_static
id|u32
id|fake_int_base
suffix:semicolon
DECL|variable|fake_int_result
r_static
id|u32
id|fake_int_result
suffix:semicolon
DECL|variable|geometry
r_static
r_struct
id|geom_emul
id|geometry
suffix:semicolon
multiline_comment|/* Drive 1 &amp; 2 geometry */
DECL|variable|int_counter
r_static
id|ulong
id|int_counter
op_assign
l_int|0
suffix:semicolon
DECL|variable|queue_counter
r_static
id|ulong
id|queue_counter
op_assign
l_int|0
suffix:semicolon
DECL|function|eata_scsi_done
r_void
id|eata_scsi_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|eata_fake_int_handler
r_void
id|eata_fake_int_handler
c_func
(paren
id|s32
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|fake_int_result
op_assign
id|inb
c_func
(paren
id|fake_int_base
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_INTR3
comma
id|printk
c_func
(paren
l_string|&quot;eata_fake_int_handler called irq%ld base %#lx res %#lx&bslash;n&quot;
comma
id|irq
comma
id|fake_int_base
comma
id|fake_int_result
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if EATA_DMA_PROC 
macro_line|#include &quot;eata_dma_proc.c&quot;
macro_line|#endif
DECL|function|eata_release
r_int
id|eata_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;irq
op_logical_and
id|reg_IRQ
(braket
id|sh-&gt;irq
)braket
op_eq
l_int|1
)paren
id|free_irq
c_func
(paren
id|sh-&gt;irq
)paren
suffix:semicolon
r_else
id|reg_IRQ
(braket
id|sh-&gt;irq
)braket
op_decrement
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_void
op_star
)paren
id|status
comma
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|channel
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;dma_channel
op_ne
l_int|0xff
)paren
id|free_dma
c_func
(paren
id|sh-&gt;dma_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh-&gt;io_port
op_logical_and
id|sh-&gt;n_io_port
)paren
id|release_region
c_func
(paren
id|sh-&gt;io_port
comma
id|sh-&gt;n_io_port
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
DECL|function|eata_info
r_const
r_char
op_star
id|eata_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
op_star
id|information
op_assign
l_string|&quot;EATA SCSI HBA Driver&quot;
suffix:semicolon
r_return
id|information
suffix:semicolon
)brace
DECL|function|eata_int_handler
r_void
id|eata_int_handler
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|uint
id|i
comma
id|result
op_assign
l_int|0
suffix:semicolon
id|uint
id|hba_stat
comma
id|scsi_stat
comma
id|eata_stat
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_struct
id|eata_ccb
op_star
id|cp
suffix:semicolon
r_struct
id|eata_sp
op_star
id|sp
suffix:semicolon
id|uint
id|base
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|uint
id|x
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|1
comma
id|sh
op_assign
id|first_HBA
suffix:semicolon
id|x
op_le
id|registered_HBAs
suffix:semicolon
id|x
op_increment
comma
id|sh
op_assign
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|prev
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;irq
op_ne
id|irq
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
id|sh-&gt;base
op_plus
id|HA_RAUXSTAT
)paren
op_amp
id|HA_AIRQ
)paren
)paren
r_continue
suffix:semicolon
id|int_counter
op_increment
suffix:semicolon
id|sp
op_assign
op_amp
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|sp
suffix:semicolon
id|cp
op_assign
id|sp-&gt;ccb
suffix:semicolon
id|cmd
op_assign
id|cp-&gt;cmd
suffix:semicolon
id|base
op_assign
(paren
id|uint
)paren
id|cmd-&gt;host-&gt;base
suffix:semicolon
id|hba_stat
op_assign
id|sp-&gt;hba_stat
suffix:semicolon
id|scsi_stat
op_assign
(paren
id|sp-&gt;scsi_stat
op_rshift
l_int|1
)paren
op_logical_and
l_int|0x1f
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;EOC
op_eq
id|FALSE
)paren
(brace
id|eata_stat
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_dma: int_handler, board: %x cmd %lx returned &quot;
l_string|&quot;unfinished.&bslash;nEATA: %x HBA: %x SCSI: %x spadr %lx spadrirq &quot;
l_string|&quot;%lx, irq%d&bslash;n&quot;
comma
id|base
comma
(paren
r_int
)paren
id|cp
comma
id|eata_stat
comma
id|hba_stat
comma
id|scsi_stat
comma
(paren
r_int
)paren
op_amp
id|status
comma
(paren
r_int
)paren
op_amp
id|status
(braket
id|irq
)braket
comma
id|irq
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|800
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp-&gt;status
op_eq
id|LOCKED
)paren
(brace
id|cp-&gt;status
op_assign
id|FREE
suffix:semicolon
id|eata_stat
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_dma: int_handler, freeing locked queueslot&bslash;n&quot;
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_INTR
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|800
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|eata_stat
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_INTR
comma
id|printk
c_func
(paren
l_string|&quot;IRQ %d received, base %#.4x, pid %ld, target: &quot;
l_string|&quot;%x, lun: %x, ea_s: %#.2x, hba_s: %#.2x &bslash;n&quot;
comma
id|irq
comma
id|base
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|eata_stat
comma
id|hba_stat
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hba_stat
)paren
(brace
r_case
id|HA_NO_ERROR
suffix:colon
multiline_comment|/* NO Error */
r_if
c_cond
(paren
id|scsi_stat
op_eq
id|CONDITION_GOOD
op_logical_and
id|cmd-&gt;device-&gt;type
op_eq
id|TYPE_DISK
op_logical_and
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_state
(braket
id|cmd-&gt;target
)braket
op_eq
id|RESET
)paren
)paren
id|result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scsi_stat
op_eq
id|GOOD
)paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_state
(braket
id|cmd-&gt;target
)braket
op_assign
id|FALSE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scsi_stat
op_eq
id|CHECK_CONDITION
op_logical_and
id|cmd-&gt;device-&gt;type
op_eq
id|TYPE_DISK
op_logical_and
(paren
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
op_eq
id|RECOVERED_ERROR
)paren
id|result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_else
id|result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_timeout
(braket
id|cmd-&gt;target
)braket
op_assign
id|FALSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HA_ERR_SEL_TO
suffix:colon
multiline_comment|/* Selection Timeout */
id|result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HA_ERR_CMD_TO
suffix:colon
multiline_comment|/* Command Timeout   */
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_timeout
(braket
id|cmd-&gt;target
)braket
OG
l_int|1
)paren
id|result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_else
(brace
id|result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_timeout
(braket
id|cmd-&gt;target
)braket
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HA_ERR_RESET
suffix:colon
multiline_comment|/* SCSI Bus Reset Received */
r_case
id|HA_INIT_POWERUP
suffix:colon
multiline_comment|/* Initial Controller Power-up */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;type
op_ne
id|TYPE_TAPE
)paren
id|result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_else
id|result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXTARGET
suffix:semicolon
id|i
op_increment
)paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_state
(braket
id|i
)braket
op_assign
id|RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HA_UNX_BUSPHASE
suffix:colon
multiline_comment|/* Unexpected Bus Phase */
r_case
id|HA_UNX_BUS_FREE
suffix:colon
multiline_comment|/* Unexpected Bus Free */
r_case
id|HA_BUS_PARITY
suffix:colon
multiline_comment|/* Bus Parity Error */
r_case
id|HA_SCSI_HUNG
suffix:colon
multiline_comment|/* SCSI Hung */
r_case
id|HA_UNX_MSGRJCT
suffix:colon
multiline_comment|/* Unexpected Message Reject */
r_case
id|HA_RESET_STUCK
suffix:colon
multiline_comment|/* SCSI Bus Reset Stuck */
r_case
id|HA_RSENSE_FAIL
suffix:colon
multiline_comment|/* Auto Request-Sense Failed */
r_case
id|HA_PARITY_ERR
suffix:colon
multiline_comment|/* Controller Ram Parity */
r_default
suffix:colon
id|result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cmd-&gt;result
op_assign
id|result
op_or
(paren
id|scsi_stat
op_lshift
l_int|1
)paren
suffix:semicolon
macro_line|#if DBG_INTR2
r_if
c_cond
(paren
id|scsi_stat
op_logical_or
id|result
op_logical_or
id|hba_stat
op_logical_or
id|eata_stat
op_ne
l_int|0x50
)paren
id|printk
c_func
(paren
l_string|&quot;eata_stat: %#x hba_stat: %#.2x,scsi_stat: %#.2x, &quot;
l_string|&quot;sense_key: %#x, result: %#.8x&bslash;n&quot;
comma
id|eata_stat
comma
id|hba_stat
comma
id|scsi_stat
comma
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
comma
id|cmd-&gt;result
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_INTR
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|800
)paren
)paren
suffix:semicolon
macro_line|#endif
id|cp-&gt;status
op_assign
id|FREE
suffix:semicolon
multiline_comment|/* now we can release the slot  */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
op_ne
id|eata_scsi_done
)paren
(brace
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
r_else
(brace
id|internal_command_finished
op_assign
id|TRUE
suffix:semicolon
id|HBA_interpret
op_assign
id|FALSE
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|eata_send_command
r_inline
id|uint
id|eata_send_command
c_func
(paren
id|ulong
id|addr
comma
id|uint
id|base
comma
id|unchar
id|command
)paren
(brace
id|uint
id|loop
op_assign
id|R_LIMIT
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RAUXSTAT
)paren
op_amp
id|HA_ABUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
id|FALSE
suffix:semicolon
id|outb
c_func
(paren
id|addr
op_amp
l_int|0x000000ff
comma
id|base
op_plus
id|HA_WDMAADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|addr
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
comma
id|base
op_plus
id|HA_WDMAADDR
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|addr
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
comma
id|base
op_plus
id|HA_WDMAADDR
op_plus
l_int|2
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|addr
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
comma
id|base
op_plus
id|HA_WDMAADDR
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
id|command
comma
id|base
op_plus
id|HA_WCOMMAND
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
DECL|function|eata_queue
r_int
id|eata_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
op_star
(paren
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|uint
id|i
comma
id|x
comma
id|y
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|hostdata
op_star
id|hd
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
r_struct
id|eata_ccb
op_star
id|cp
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sl
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|queue_counter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|done
op_eq
(paren
r_void
op_star
)paren
id|eata_scsi_done
)paren
(brace
r_if
c_cond
(paren
id|internal_command_finished
op_eq
id|TRUE
)paren
id|internal_command_finished
op_assign
id|FALSE
suffix:semicolon
r_else
id|cmd-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
op_plus
id|QUEUE_FULL
suffix:semicolon
)brace
id|hd
op_assign
id|HD
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|sh
op_assign
id|cmd-&gt;host
suffix:semicolon
multiline_comment|/* check for free slot */
r_for
c_loop
(paren
id|y
op_assign
id|hd-&gt;last_ccb
op_plus
l_int|1
comma
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|sh-&gt;can_queue
suffix:semicolon
id|x
op_increment
comma
id|y
op_increment
)paren
(brace
r_if
c_cond
(paren
id|y
op_ge
id|sh-&gt;can_queue
)paren
id|y
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ccb
(braket
id|y
)braket
dot
id|status
op_eq
id|FREE
)paren
r_break
suffix:semicolon
)brace
id|hd-&gt;last_ccb
op_assign
id|y
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
id|sh-&gt;can_queue
)paren
(brace
id|DBG
c_func
(paren
id|DBG_QUEUE
comma
id|printk
c_func
(paren
l_string|&quot;can_queue %d, x %d, y %d&bslash;n&quot;
comma
id|sh-&gt;can_queue
comma
id|x
comma
id|y
)paren
)paren
suffix:semicolon
macro_line|#if DEBUG_EATA
id|panic
c_func
(paren
l_string|&quot;eata_dma: run out of queue slots cmdno:%ld intrno: %ld&bslash;n&quot;
comma
id|queue_counter
comma
id|int_counter
)paren
suffix:semicolon
macro_line|#else
id|panic
c_func
(paren
l_string|&quot;eata_dma: run out of queue slots....&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cp
op_assign
op_amp
id|hd-&gt;ccb
(braket
id|y
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
)paren
suffix:semicolon
id|cp-&gt;status
op_assign
id|USED
suffix:semicolon
multiline_comment|/* claim free slot */
id|DBG
c_func
(paren
id|DBG_QUEUE
comma
id|printk
c_func
(paren
l_string|&quot;eata_queue pid %ld, target: %x, lun: %x, y %d&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|y
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_QUEUE
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|250
)paren
)paren
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
(paren
r_void
op_star
)paren
id|done
suffix:semicolon
r_switch
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|CHANGE_DEFINITION
suffix:colon
r_case
id|COMPARE
suffix:colon
r_case
id|COPY
suffix:colon
r_case
id|COPY_VERIFY
suffix:colon
r_case
id|LOG_SELECT
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SELECT_10
suffix:colon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_case
id|FORMAT_UNIT
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|SEARCH_EQUAL
suffix:colon
r_case
id|SEARCH_HIGH
suffix:colon
r_case
id|SEARCH_LOW
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_VERIFY
suffix:colon
r_case
id|UPDATE_BLOCK
suffix:colon
r_case
id|WRITE_LONG
suffix:colon
r_case
id|WRITE_SAME
suffix:colon
r_case
id|SEARCH_HIGH_12
suffix:colon
r_case
id|SEARCH_EQUAL_12
suffix:colon
r_case
id|SEARCH_LOW_12
suffix:colon
r_case
id|WRITE_12
suffix:colon
r_case
id|WRITE_VERIFY_12
suffix:colon
r_case
id|SET_WINDOW
suffix:colon
r_case
id|MEDIUM_SCAN
suffix:colon
r_case
id|SEND_VOLUME_TAG
suffix:colon
r_case
l_int|0xea
suffix:colon
multiline_comment|/* alternate number for WRITE LONG */
id|cp-&gt;DataOut
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Output mode */
r_break
suffix:semicolon
r_case
l_int|0x00
suffix:colon
r_default
suffix:colon
id|cp-&gt;DataIn
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Input mode  */
)brace
r_if
c_cond
(paren
id|done
op_eq
(paren
r_void
op_star
)paren
id|eata_scsi_done
op_logical_and
id|HBA_interpret
op_eq
id|TRUE
)paren
id|cp-&gt;Interpret
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Interpret command */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|cp-&gt;scatter
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* SG mode     */
id|cp-&gt;cp_dataDMA
op_assign
id|htonl
c_func
(paren
(paren
r_int
)paren
op_amp
id|cp-&gt;sg_list
)paren
suffix:semicolon
id|cp-&gt;cp_datalen
op_assign
id|htonl
c_func
(paren
id|cmd-&gt;use_sg
op_star
l_int|8
)paren
suffix:semicolon
id|sl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;use_sg
suffix:semicolon
id|i
op_increment
comma
id|sl
op_increment
)paren
(brace
id|cp-&gt;sg_list
(braket
id|i
)braket
dot
id|data
op_assign
id|htonl
c_func
(paren
(paren
id|ulong
)paren
id|sl-&gt;address
)paren
suffix:semicolon
id|cp-&gt;sg_list
(braket
id|i
)braket
dot
id|len
op_assign
id|htonl
c_func
(paren
(paren
id|ulong
)paren
id|sl-&gt;length
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cp-&gt;scatter
op_assign
id|FALSE
suffix:semicolon
id|cp-&gt;cp_datalen
op_assign
id|htonl
c_func
(paren
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|cp-&gt;cp_dataDMA
op_assign
id|htonl
c_func
(paren
(paren
id|ulong
)paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
)brace
id|cp-&gt;Auto_Req_Sen
op_assign
id|TRUE
suffix:semicolon
id|cp-&gt;cp_reqDMA
op_assign
id|htonl
c_func
(paren
(paren
id|ulong
)paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|cp-&gt;reqlen
op_assign
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|cp-&gt;cp_id
op_assign
id|cmd-&gt;target
suffix:semicolon
id|cp-&gt;cp_lun
op_assign
id|cmd-&gt;lun
suffix:semicolon
id|cp-&gt;cp_dispri
op_assign
id|TRUE
suffix:semicolon
id|cp-&gt;cp_identify
op_assign
id|TRUE
suffix:semicolon
id|memcpy
c_func
(paren
id|cp-&gt;cp_cdb
comma
id|cmd-&gt;cmnd
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|cp-&gt;cp_statDMA
op_assign
id|htonl
c_func
(paren
(paren
id|ulong
)paren
op_amp
(paren
id|hd-&gt;sp
)paren
)paren
suffix:semicolon
id|cp-&gt;cp_viraddr
op_assign
id|cp
suffix:semicolon
id|cp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
op_amp
id|hd-&gt;ccb
(braket
id|y
)braket
suffix:semicolon
r_if
c_cond
(paren
id|eata_send_command
c_func
(paren
(paren
id|ulong
)paren
id|cp
comma
(paren
id|uint
)paren
id|sh-&gt;base
comma
id|EATA_CMD_DMA_SEND_CP
)paren
op_eq
id|FALSE
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_queue target %d, pid %ld, HBA busy, returning DID_ERROR, done.&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
op_ne
(paren
r_void
op_star
)paren
id|eata_scsi_done
)paren
(brace
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|DBG_QUEUE
comma
id|printk
c_func
(paren
l_string|&quot;Queued base %#.4lx pid: %ld target: %x lun: %x slot %d irq %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|sh-&gt;base
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|y
comma
id|sh-&gt;irq
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_QUEUE
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|200
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|internal_done_flag
r_static
r_volatile
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_static
r_volatile
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|internal_done_errcode
op_assign
id|cmd-&gt;result
suffix:semicolon
op_increment
id|internal_done_flag
suffix:semicolon
)brace
DECL|function|eata_command
r_int
id|eata_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|DBG
c_func
(paren
id|DBG_COM
comma
id|printk
c_func
(paren
l_string|&quot;eata_command: calling eata_queue&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|eata_queue
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
suffix:semicolon
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|internal_done_errcode
)paren
suffix:semicolon
)brace
DECL|function|eata_abort
r_int
id|eata_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|uint
id|loop
op_assign
id|R_LIMIT
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_abort called pid: %ld target: %x lun: %x reason %x&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;abort_reason
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
(paren
id|cmd-&gt;host-&gt;base
)paren
op_plus
id|HA_RAUXSTAT
)paren
op_amp
id|HA_ABUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eata_dma: abort, timeout error.&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_ERROR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|FREE
)paren
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;Returning: SCSI_ABORT_NOT_RUNNING&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|USED
)paren
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;Returning: SCSI_ABORT_BUSY&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_BUSY
)paren
suffix:semicolon
multiline_comment|/* SNOOZE */
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|RESET
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_dma: abort, command reset error.&bslash;n&quot;
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_ERROR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|LOCKED
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_dma: abort, queue slot locked.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
r_else
id|panic
c_func
(paren
l_string|&quot;eata_dma: abort: invalid slot status&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|eata_reset
r_int
id|eata_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|uint
id|x
comma
id|z
comma
id|time
comma
id|limit
op_assign
l_int|0
suffix:semicolon
id|uint
id|loop
op_assign
id|R_LIMIT
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|unchar
id|success
op_assign
id|FALSE
suffix:semicolon
id|Scsi_Cmnd
op_star
id|sp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_reset called pid:%ld target: %x lun: %x reason %x&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;abort_reason
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|state
op_eq
id|RESET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eata_reset: exit, already in reset.&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_ERROR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
(paren
id|cmd-&gt;host-&gt;base
)paren
op_plus
id|HA_RAUXSTAT
)paren
op_amp
id|HA_ABUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eata_reset: exit, timeout error.&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_ERROR
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|MAXTARGET
suffix:semicolon
id|z
op_increment
)paren
(brace
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_state
(braket
id|z
)braket
op_assign
id|RESET
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|t_timeout
(braket
id|z
)braket
op_assign
id|FALSE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|cmd-&gt;host-&gt;can_queue
suffix:semicolon
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_eq
id|FREE
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_eq
id|LOCKED
)paren
(brace
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_assign
id|FREE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_reset: locked slot %d forced free.&bslash;n&quot;
comma
id|x
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|sp
op_assign
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|cmd
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_assign
id|RESET
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_reset: slot %d in reset, pid %ld.&bslash;n&quot;
comma
id|x
comma
id|sp-&gt;pid
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;eata_reset: slot %d, sp==NULL.&bslash;n&quot;
comma
id|x
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
id|cmd
)paren
id|success
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* hard reset the HBA  */
id|inb
c_func
(paren
(paren
id|uint
)paren
(paren
id|cmd-&gt;host-&gt;base
)paren
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
multiline_comment|/* This might cause trouble */
id|eata_send_command
c_func
(paren
l_int|0
comma
(paren
id|uint
)paren
id|cmd-&gt;host-&gt;base
comma
id|EATA_CMD_RESET
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_reset: board reset done, enabling interrupts.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|state
op_assign
id|RESET
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
(paren
id|time
op_plus
l_int|300
)paren
op_logical_and
id|limit
op_increment
OL
l_int|10000000
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_reset: interrupts disabled, loops %d.&bslash;n&quot;
comma
id|limit
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|cmd-&gt;host-&gt;can_queue
suffix:semicolon
id|x
op_increment
)paren
(brace
multiline_comment|/* Skip slots already set free by interrupt */
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_ne
id|RESET
)paren
r_continue
suffix:semicolon
id|sp
op_assign
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|cmd
suffix:semicolon
id|sp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* This mailbox is still waiting for its interrupt */
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_assign
id|LOCKED
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eata_reset: slot %d locked, DID_RESET, pid %ld done.&bslash;n&quot;
comma
id|x
comma
id|sp-&gt;pid
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sp
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sp
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|state
op_assign
id|FALSE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
)paren
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_reset: exit, success.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_SUCCESS
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
l_string|&quot;eata_reset: exit, wakeup.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
op_logical_and
id|DBG_DELAY
comma
id|DEL2
c_func
(paren
l_int|500
)paren
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_PUNT
)paren
suffix:semicolon
)brace
)brace
DECL|function|get_board_data
r_char
op_star
id|get_board_data
c_func
(paren
id|ulong
id|base
comma
id|uint
id|irq
comma
id|uint
id|id
)paren
(brace
r_struct
id|eata_ccb
id|cp
suffix:semicolon
r_struct
id|eata_sp
id|sp
suffix:semicolon
r_static
r_char
op_star
id|buff
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|buff
op_assign
id|dma_scratch
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|eata_sp
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
l_int|256
)paren
suffix:semicolon
id|cp.DataIn
op_assign
id|TRUE
suffix:semicolon
id|cp.Interpret
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Interpret command */
id|cp.cp_datalen
op_assign
id|htonl
c_func
(paren
l_int|255
)paren
suffix:semicolon
id|cp.cp_dataDMA
op_assign
id|htonl
c_func
(paren
(paren
id|s32
)paren
id|buff
)paren
suffix:semicolon
id|cp.cp_viraddr
op_assign
op_amp
id|cp
suffix:semicolon
id|cp.cp_id
op_assign
id|id
suffix:semicolon
id|cp.cp_lun
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|4
)braket
op_assign
l_int|255
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_statDMA
op_assign
id|htonl
c_func
(paren
(paren
id|ulong
)paren
op_amp
id|sp
)paren
suffix:semicolon
id|fake_int_base
op_assign
id|base
suffix:semicolon
id|fake_int_result
op_assign
l_int|0
suffix:semicolon
id|eata_send_command
c_func
(paren
(paren
id|u32
)paren
op_amp
id|cp
comma
(paren
id|u32
)paren
id|base
comma
id|EATA_CMD_DMA_SEND_CP
)paren
suffix:semicolon
id|i
op_assign
id|jiffies
op_plus
l_int|300
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|fake_int_result
op_logical_and
id|jiffies
op_le
id|i
)paren
multiline_comment|/* nothing */
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_INTR3
comma
id|printk
c_func
(paren
l_string|&quot;fake_int_result: %#lx hbastat %#lx scsistat %#lx,&quot;
l_string|&quot; buff %p sp %p&bslash;n&quot;
comma
id|fake_int_result
comma
(paren
id|u32
)paren
(paren
id|sp.hba_stat
op_amp
l_int|0x7f
)paren
comma
(paren
id|u32
)paren
id|sp.scsi_stat
comma
id|buff
comma
op_amp
id|sp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
OG
id|i
op_logical_or
(paren
id|fake_int_result
op_amp
l_int|1
)paren
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_else
r_return
(paren
id|buff
)paren
suffix:semicolon
)brace
DECL|function|check_blink_state
r_int
id|check_blink_state
c_func
(paren
r_int
id|base
)paren
(brace
id|uint
id|loops
op_assign
l_int|10
suffix:semicolon
id|ulong
id|blinkindicator
op_assign
l_int|0x42445054
suffix:semicolon
id|ulong
id|state
op_assign
l_int|0x12345678
suffix:semicolon
id|ulong
id|oldstate
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|loops
op_decrement
)paren
op_logical_and
(paren
id|state
op_ne
id|oldstate
)paren
)paren
(brace
id|oldstate
op_assign
id|state
suffix:semicolon
id|state
op_assign
id|inl
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|DBG_BLINK
comma
id|printk
c_func
(paren
l_string|&quot;Did Blink check. Status: %d&bslash;n&quot;
comma
(paren
id|state
op_eq
id|oldstate
)paren
op_logical_and
(paren
id|state
op_eq
id|blinkindicator
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_eq
id|oldstate
)paren
op_logical_and
(paren
id|state
op_eq
id|blinkindicator
)paren
)paren
r_return
id|TRUE
suffix:semicolon
r_else
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|get_conf_PIO
r_int
id|get_conf_PIO
c_func
(paren
r_struct
id|eata_register
op_star
id|base
comma
r_struct
id|get_conf
op_star
id|buf
)paren
(brace
id|ulong
id|loop
op_assign
id|R_LIMIT
suffix:semicolon
id|ushort
op_star
id|p
suffix:semicolon
id|u8
id|warning
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
(paren
r_int
)paren
id|base
comma
l_int|9
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|base
op_eq
l_int|0x1f0
op_logical_or
(paren
r_int
)paren
id|base
op_eq
l_int|0x170
)paren
(brace
id|warning
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|get_conf
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_PIO
op_logical_and
id|DBG_PROBE
comma
id|printk
c_func
(paren
l_string|&quot;Issuing PIO READ CONFIG to HBA at %lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|base
)paren
)paren
suffix:semicolon
id|eata_send_command
c_func
(paren
l_int|0
comma
(paren
id|uint
)paren
id|base
comma
id|EATA_CMD_PIO_READ_CONFIG
)paren
suffix:semicolon
id|loop
op_assign
id|R_LIMIT
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
(paren
id|ushort
op_star
)paren
id|buf
suffix:semicolon
(paren
r_int
)paren
id|p
op_le
(paren
(paren
r_int
)paren
id|buf
op_plus
(paren
r_sizeof
(paren
r_struct
id|get_conf
)paren
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|p
op_increment
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|loop
op_assign
id|R_LIMIT
suffix:semicolon
op_star
id|p
op_assign
id|inw
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SERROR
)paren
)paren
(brace
multiline_comment|/* Error ? */
id|DBG
c_func
(paren
id|DBG_PIO
op_logical_and
id|DBG_PROBE
comma
id|printk
c_func
(paren
l_string|&quot;&bslash;nSignature: %c%c%c%c&bslash;n&quot;
comma
(paren
r_char
)paren
id|buf-&gt;sig
(braket
l_int|0
)braket
comma
(paren
r_char
)paren
id|buf-&gt;sig
(braket
l_int|1
)braket
comma
(paren
r_char
)paren
id|buf-&gt;sig
(braket
l_int|2
)braket
comma
(paren
r_char
)paren
id|buf-&gt;sig
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buf-&gt;sig
(braket
l_int|0
)braket
op_eq
l_char|&squot;E&squot;
)paren
op_logical_and
(paren
id|buf-&gt;sig
(braket
l_int|1
)braket
op_eq
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
id|buf-&gt;sig
(braket
l_int|2
)braket
op_eq
l_char|&squot;T&squot;
)paren
op_logical_and
(paren
id|buf-&gt;sig
(braket
l_int|3
)braket
op_eq
l_char|&squot;A&squot;
)paren
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PIO
op_logical_and
id|DBG_PROBE
comma
id|printk
c_func
(paren
l_string|&quot;EATA Controller found at %x &quot;
l_string|&quot;EATA Level: %x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|base
comma
(paren
id|uint
)paren
(paren
id|buf-&gt;version
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
id|inw
c_func
(paren
(paren
id|uint
)paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|warning
op_eq
id|TRUE
)paren
id|printk
c_func
(paren
l_string|&quot;Warning: HBA with IO on 0x%p detected,&bslash;n&quot;
l_string|&quot;         this IO space is already allocated, probably by the IDE driver.&bslash;n&quot;
l_string|&quot;         This might lead to problems.&quot;
comma
id|base
)paren
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
comma
id|printk
c_func
(paren
l_string|&quot;eata_dma: get_conf_PIO, error during transfer &quot;
l_string|&quot;for HBA at %lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|base
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|print_config
r_void
id|print_config
c_func
(paren
r_struct
id|get_conf
op_star
id|gc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Please check values: (read config data)&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;LEN: %d ver:%d OCS:%d TAR:%d TRNXFR:%d MORES:%d DMAS:%d&bslash;n&quot;
comma
(paren
id|uint
)paren
id|ntohl
c_func
(paren
id|gc-&gt;len
)paren
comma
id|gc-&gt;version
comma
id|gc-&gt;OCS_enabled
comma
id|gc-&gt;TAR_support
comma
id|gc-&gt;TRNXFR
comma
id|gc-&gt;MORE_support
comma
id|gc-&gt;DMA_support
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMAV:%d HAAV:%d SCSIID0:%d ID1:%d ID2:%d QUEUE:%d SG:%d SEC:%d&bslash;n&quot;
comma
id|gc-&gt;DMA_valid
comma
id|gc-&gt;HAA_valid
comma
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
comma
id|gc-&gt;scsi_id
(braket
l_int|2
)braket
comma
id|gc-&gt;scsi_id
(braket
l_int|1
)braket
comma
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
comma
id|ntohs
c_func
(paren
id|gc-&gt;SGsiz
)paren
comma
id|gc-&gt;SECOND
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IRQ:%d IRQT:%d DMAC:%d FORCADR:%d MCH:%d RIDQ:%d PCI:%d EISA:%d&bslash;n&quot;
comma
id|gc-&gt;IRQ
comma
id|gc-&gt;IRQ_TR
comma
(paren
l_int|8
op_minus
id|gc-&gt;DMA_channel
)paren
op_amp
l_int|7
comma
id|gc-&gt;FORCADR
comma
id|gc-&gt;MAX_CHAN
comma
id|gc-&gt;ID_qest
comma
id|gc-&gt;is_PCI
comma
id|gc-&gt;is_EISA
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DPT_DEBUG
comma
id|DELAY
c_func
(paren
l_int|1400
)paren
)paren
suffix:semicolon
)brace
DECL|function|register_HBA
r_int
id|register_HBA
c_func
(paren
r_int
id|base
comma
r_struct
id|get_conf
op_star
id|gc
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
id|ulong
id|size
op_assign
l_int|0
suffix:semicolon
id|unchar
id|dma_channel
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|buff
suffix:semicolon
id|uint
id|i
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|hostdata
op_star
id|hd
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_REGISTER
comma
id|print_config
c_func
(paren
id|gc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;HAA_valid
op_eq
id|FALSE
op_logical_or
id|ntohl
c_func
(paren
id|gc-&gt;len
)paren
OL
l_int|0x22
)paren
(brace
id|gc-&gt;MAX_CHAN
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
)paren
(brace
multiline_comment|/* Interrupt already registered ? */
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|gc-&gt;IRQ
comma
(paren
r_void
op_star
)paren
id|eata_fake_int_handler
comma
id|SA_INTERRUPT
comma
l_string|&quot;eata_dma&quot;
)paren
)paren
(brace
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_add_assign
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gc-&gt;IRQ_TR
)paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* IRQ is edge triggered */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t allocate IRQ %d, Sorry.&quot;
comma
id|gc-&gt;IRQ
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* More than one HBA on this IRQ */
r_if
c_cond
(paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_eq
id|TRUE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Can&squot;t support more than one HBA on this IRQ,&bslash;n&quot;
l_string|&quot;  if the IRQ is edge triggered. Sorry.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_else
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_add_assign
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* if gc-&gt;DMA_valid it must be an ISA HBA and we have to register it */
id|dma_channel
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;DMA_valid
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dma_channel
op_assign
(paren
l_int|8
op_minus
id|gc-&gt;DMA_channel
)paren
op_amp
l_int|7
comma
l_string|&quot;eata_dma&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to allocate DMA channel %d for ISA HBA at %#.4lx.&bslash;n&quot;
comma
id|dma_channel
comma
id|base
)paren
suffix:semicolon
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_sub_assign
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_eq
l_int|0
)paren
id|free_irq
c_func
(paren
id|gc-&gt;IRQ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gc-&gt;IRQ_TR
)paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
)brace
id|buff
op_assign
id|get_board_data
c_func
(paren
id|base
comma
id|gc-&gt;IRQ
comma
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|gc-&gt;DMA_support
op_eq
id|FALSE
)paren
id|printk
c_func
(paren
l_string|&quot;HBA at %#.4lx doesn&squot;t support DMA. Sorry&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;HBA at %#.4lx didn&squot;t react on INQUIRY. Sorry.&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;DMA_valid
)paren
id|free_dma
c_func
(paren
id|dma_channel
)paren
suffix:semicolon
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_sub_assign
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_eq
l_int|0
)paren
id|free_irq
c_func
(paren
id|gc-&gt;IRQ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gc-&gt;IRQ_TR
)paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gc-&gt;DMA_support
op_eq
id|FALSE
op_logical_and
id|buff
op_ne
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;HBA %.12sat %#.4lx doesn&squot;t set the DMA_support flag correctly.&bslash;n&quot;
comma
op_amp
id|buff
(braket
l_int|16
)braket
comma
id|base
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|base
comma
l_int|9
comma
l_string|&quot;eata_dma&quot;
)paren
suffix:semicolon
multiline_comment|/* We already checked the &n;                                          * availability, so this could &n;                                          * only fail if we&squot;re on &n;&t;&t;&t;&t;&t;  * 0x1f0 or 0x170.&n;                                          */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
op_eq
l_int|0
)paren
(brace
id|gc-&gt;queuesiz
op_assign
id|ntohs
c_func
(paren
l_int|64
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Warning: Queue size had to be corrected.&bslash;n&quot;
l_string|&quot;This might be a PM2012 with a defective Firmware&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|size
op_assign
r_sizeof
(paren
id|hostdata
)paren
op_plus
(paren
(paren
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
op_star
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
)paren
op_div
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;MAX_CHAN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;This is a multichannel HBA. Linux doesn&squot;t support them,&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;so we&squot;ll try to register every channel as a virtual HBA.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|gc-&gt;MAX_CHAN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sh
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|gc-&gt;DMA_valid
)paren
id|free_dma
c_func
(paren
id|dma_channel
)paren
suffix:semicolon
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_eq
l_int|0
)paren
id|free_irq
c_func
(paren
id|gc-&gt;IRQ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gc-&gt;IRQ_TR
)paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|hd
op_assign
id|SD
c_func
(paren
id|sh
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hd-&gt;ccb
comma
l_int|0
comma
(paren
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
op_star
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
)paren
op_div
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hd-&gt;reads
comma
l_int|0
comma
r_sizeof
(paren
id|ulong
)paren
op_star
l_int|26
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|vendor
comma
op_amp
id|buff
(braket
l_int|8
)braket
comma
l_int|8
)paren
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|vendor
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|name
comma
op_amp
id|buff
(braket
l_int|16
)braket
comma
l_int|17
)paren
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|name
(braket
l_int|17
)braket
op_assign
l_int|0
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|0
)braket
op_assign
id|buff
(braket
l_int|32
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|1
)braket
op_assign
id|buff
(braket
l_int|33
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|2
)braket
op_assign
id|buff
(braket
l_int|34
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|3
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|4
)braket
op_assign
id|buff
(braket
l_int|35
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|ntohl
c_func
(paren
id|gc-&gt;len
)paren
)paren
(brace
r_case
l_int|0x1c
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;a&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;b&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x22
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;c&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;?&squot;
suffix:semicolon
)brace
id|sh-&gt;base
op_assign
(paren
r_char
op_star
)paren
id|base
suffix:semicolon
id|sh-&gt;io_port
op_assign
(paren
id|ushort
)paren
id|base
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
l_int|9
suffix:semicolon
id|sh-&gt;irq
op_assign
id|gc-&gt;IRQ
suffix:semicolon
id|sh-&gt;dma_channel
op_assign
id|dma_channel
suffix:semicolon
id|sh-&gt;this_id
op_assign
id|gc-&gt;scsi_id
(braket
l_int|3
op_minus
id|i
)braket
suffix:semicolon
id|sh-&gt;can_queue
op_assign
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
op_div
(paren
id|gc-&gt;MAX_CHAN
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;OCS_enabled
op_eq
id|TRUE
)paren
(brace
id|sh-&gt;cmd_per_lun
op_assign
id|sh-&gt;can_queue
op_div
id|C_P_L_DIV
suffix:semicolon
macro_line|#if 0   /* The memory management seems to be more stable now */
r_if
c_cond
(paren
id|sh-&gt;cmd_per_lun
OG
id|C_P_L_CURRENT_MAX
)paren
id|sh-&gt;cmd_per_lun
op_assign
id|C_P_L_CURRENT_MAX
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|sh-&gt;cmd_per_lun
op_assign
l_int|1
suffix:semicolon
)brace
id|sh-&gt;sg_tablesize
op_assign
id|ntohs
c_func
(paren
id|gc-&gt;SGsiz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh-&gt;sg_tablesize
OG
id|SG_SIZE
op_logical_or
id|sh-&gt;sg_tablesize
op_eq
l_int|0
)paren
(brace
id|sh-&gt;sg_tablesize
op_assign
id|SG_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|gc-&gt;SGsiz
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Warning: SG size had to be corrected.&bslash;n&quot;
l_string|&quot;This might be a PM2012 with a defective Firmware&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|hd-&gt;channel
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|buff
(braket
l_int|21
)braket
op_eq
l_char|&squot;4&squot;
)paren
id|hd-&gt;bustype
op_assign
l_char|&squot;P&squot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|buff
(braket
l_int|21
)braket
op_eq
l_char|&squot;2&squot;
)paren
id|hd-&gt;bustype
op_assign
l_char|&squot;E&squot;
suffix:semicolon
r_else
id|hd-&gt;bustype
op_assign
l_char|&squot;I&squot;
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;SECOND
)paren
id|hd-&gt;primary
op_assign
id|FALSE
suffix:semicolon
r_else
id|hd-&gt;primary
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;bustype
op_ne
l_char|&squot;I&squot;
)paren
(brace
id|sh-&gt;unchecked_isa_dma
op_assign
id|FALSE
suffix:semicolon
id|sh-&gt;wish_block
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
id|sh-&gt;unchecked_isa_dma
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* We&squot;re doing ISA DMA */
id|sh-&gt;wish_block
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* This will reduce performance */
)brace
r_if
c_cond
(paren
(paren
id|hd-&gt;primary
op_eq
id|TRUE
)paren
op_logical_and
(paren
id|i
op_eq
l_int|0
)paren
op_logical_and
id|HARDCODED
)paren
(brace
id|geometry.drv
(braket
l_int|0
)braket
dot
id|heads
op_assign
id|HEADS0
suffix:semicolon
id|geometry.drv
(braket
l_int|0
)braket
dot
id|sectors
op_assign
id|SECTORS0
suffix:semicolon
id|geometry.drv
(braket
l_int|0
)braket
dot
id|cylinder
op_assign
id|CYLINDER0
suffix:semicolon
id|geometry.drv
(braket
l_int|0
)braket
dot
id|id
op_assign
id|ID0
suffix:semicolon
id|geometry.drv
(braket
l_int|0
)braket
dot
id|trans
op_assign
id|TRUE
suffix:semicolon
id|geometry.drv
(braket
l_int|1
)braket
dot
id|heads
op_assign
id|HEADS1
suffix:semicolon
id|geometry.drv
(braket
l_int|1
)braket
dot
id|sectors
op_assign
id|SECTORS1
suffix:semicolon
id|geometry.drv
(braket
l_int|1
)braket
dot
id|cylinder
op_assign
id|CYLINDER1
suffix:semicolon
id|geometry.drv
(braket
l_int|1
)braket
dot
id|id
op_assign
id|ID1
suffix:semicolon
id|geometry.drv
(braket
l_int|1
)braket
dot
id|trans
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|geometry.drv
(braket
l_int|0
)braket
dot
id|id
op_assign
op_minus
l_int|1
suffix:semicolon
id|geometry.drv
(braket
l_int|1
)braket
dot
id|id
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|hd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* build a linked list of all HBAs */
id|hd-&gt;prev
op_assign
id|last_HBA
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;prev
op_ne
l_int|NULL
)paren
(brace
id|SD
c_func
(paren
id|hd-&gt;prev
)paren
op_member_access_from_pointer
id|next
op_assign
id|sh
suffix:semicolon
)brace
id|last_HBA
op_assign
id|sh
suffix:semicolon
r_if
c_cond
(paren
id|first_HBA
op_eq
l_int|NULL
)paren
id|first_HBA
op_assign
id|sh
suffix:semicolon
id|registered_HBAs
op_increment
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|find_EISA
r_int
id|find_EISA
c_func
(paren
r_struct
id|get_conf
op_star
id|buf
)paren
(brace
r_struct
id|eata_register
op_star
id|base
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if CHECKPAL
r_int
r_char
id|pal1
comma
id|pal2
comma
id|pal3
comma
op_star
id|p
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXEISA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|EISAbases
(braket
id|i
)braket
op_eq
id|TRUE
)paren
(brace
multiline_comment|/* Still a possibility ?          */
id|base
op_assign
(paren
r_void
op_star
)paren
l_int|0x1c88
op_plus
(paren
id|i
op_star
l_int|0x1000
)paren
suffix:semicolon
macro_line|#if CHECKPAL
id|p
op_assign
(paren
r_char
op_star
)paren
id|base
suffix:semicolon
id|pal1
op_assign
op_star
(paren
id|p
op_minus
l_int|8
)paren
suffix:semicolon
id|pal2
op_assign
op_star
(paren
id|p
op_minus
l_int|7
)paren
suffix:semicolon
id|pal3
op_assign
op_star
(paren
id|p
op_minus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pal1
op_eq
l_int|0x12
)paren
op_logical_and
(paren
id|pal2
op_eq
l_int|0x14
)paren
)paren
op_logical_or
(paren
(paren
id|pal1
op_eq
l_int|0x38
)paren
op_logical_and
(paren
id|pal2
op_eq
l_int|0xa3
)paren
op_logical_and
(paren
id|pal3
op_eq
l_int|0x82
)paren
)paren
op_logical_or
(paren
(paren
id|pal1
op_eq
l_int|0x06
)paren
op_logical_and
(paren
id|pal2
op_eq
l_int|0x94
)paren
op_logical_and
(paren
id|pal3
op_eq
l_int|0x24
)paren
)paren
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
comma
id|printk
c_func
(paren
l_string|&quot;EISA EATA id tags found: %x %x %x &bslash;n&quot;
comma
(paren
r_int
)paren
id|pal1
comma
(paren
r_int
)paren
id|pal2
comma
(paren
r_int
)paren
id|pal3
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|get_conf_PIO
c_func
(paren
id|base
comma
id|buf
)paren
op_eq
id|TRUE
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
op_logical_and
id|DBG_EISA
comma
id|print_config
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;IRQ
)paren
(brace
multiline_comment|/* We&squot;ll check the &n;&t;&t;&t;&t;&t;      * primary/secondary stuff&n;&t;&t;&t;&t;&t;      * later&n;&t;&t;&t;&t;&t;      */
id|EISAbases
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
(paren
(paren
id|ulong
)paren
id|base
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;No valid IRQ. HBA removed from list&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Nothing found here so we take it from the list */
id|EISAbases
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#if CHECKPAL
)brace
macro_line|#endif
)brace
)brace
r_return
(paren
l_int|0l
)paren
suffix:semicolon
multiline_comment|/* Nothing found  :-(             */
)brace
DECL|function|find_ISA
r_int
id|find_ISA
c_func
(paren
r_struct
id|get_conf
op_star
id|buf
)paren
(brace
r_int
id|l
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAXISA
suffix:semicolon
id|l
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ISAbases
(braket
id|l
)braket
)paren
(brace
r_if
c_cond
(paren
id|get_conf_PIO
c_func
(paren
(paren
r_struct
id|eata_register
op_star
)paren
id|ISAbases
(braket
id|l
)braket
comma
id|buf
)paren
op_eq
id|TRUE
)paren
(brace
id|ret
op_assign
id|ISAbases
(braket
id|l
)braket
suffix:semicolon
id|ISAbases
(braket
id|l
)braket
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
r_else
id|ISAbases
(braket
id|l
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
(paren
(paren
r_int
)paren
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|find_PCI
r_void
id|find_PCI
c_func
(paren
r_struct
id|get_conf
op_star
id|buf
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
macro_line|#ifndef CONFIG_PCI
id|printk
c_func
(paren
l_string|&quot;Kernel PCI support not enabled. Skipping scan for PCI HBAs.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|unchar
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
r_static
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Device index to PCI BIOS calls */
id|ulong
id|base
op_assign
l_int|0
suffix:semicolon
id|ushort
id|com_adr
suffix:semicolon
id|ushort
id|rev_device
suffix:semicolon
id|uint
id|error
comma
id|i
comma
id|x
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAXPCI
suffix:semicolon
op_increment
id|i
comma
op_increment
id|pci_index
)paren
(brace
r_if
c_cond
(paren
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_DPT
comma
id|PCI_DEVICE_ID_DPT
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
)paren
r_break
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_PROBE
op_logical_and
id|DBG_PCI
comma
id|printk
c_func
(paren
l_string|&quot;eata_dma: HBA at bus %d, device %d,&quot;
l_string|&quot; function %d, index %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|pci_bus
comma
(paren
r_int
)paren
(paren
(paren
id|pci_device_fn
op_amp
l_int|0xf8
)paren
op_rshift
l_int|3
)paren
comma
(paren
r_int
)paren
(paren
id|pci_device_fn
op_amp
l_int|7
)paren
comma
id|pci_index
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|error
op_assign
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_CLASS_DEVICE
comma
op_amp
id|rev_device
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|rev_device
op_eq
id|PCI_CLASS_STORAGE_SCSI
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|error
op_assign
id|pcibios_read_config_word
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_COMMAND
comma
(paren
id|ushort
op_star
)paren
op_amp
id|com_adr
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|com_adr
op_amp
id|PCI_COMMAND_IO
)paren
op_logical_and
(paren
id|com_adr
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HBA has IO or BUSMASTER mode disabled&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;error %x while reading PCI_COMMAND&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;DEVICECLASSID %x didn&squot;t match&bslash;n&quot;
comma
id|rev_device
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;error %x while reading PCI_CLASS_BASE&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|error
op_assign
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|base
)paren
)paren
)paren
(brace
multiline_comment|/* Check if the address is valid */
r_if
c_cond
(paren
id|base
op_amp
l_int|0x01
)paren
(brace
id|base
op_and_assign
l_int|0xfffffffe
suffix:semicolon
multiline_comment|/* EISA tag there ? */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|base
)paren
op_eq
l_int|0x12
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|base
op_plus
l_int|1
)paren
op_eq
l_int|0x14
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Jep, it&squot;s forced, so move on  */
id|base
op_add_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Now, THIS is the real address */
r_if
c_cond
(paren
id|base
op_ne
l_int|0x1f8
)paren
(brace
multiline_comment|/* We didn&squot;t find it in the primary search */
r_if
c_cond
(paren
id|get_conf_PIO
c_func
(paren
(paren
r_struct
id|eata_register
op_star
)paren
id|base
comma
id|buf
)paren
)paren
(brace
r_if
c_cond
(paren
id|buf-&gt;FORCADR
)paren
multiline_comment|/* If the address is forced */
r_continue
suffix:semicolon
multiline_comment|/* we&squot;ll find it later      */
multiline_comment|/* OK. We made it till here, so we can go now  &n;&t;&t;&t;     * and register it. We  only have to check and &n;&t;&t;&t;     * eventually remove it from the EISA and ISA list &n;&t;&t;&t;     */
id|register_HBA
c_func
(paren
id|base
comma
id|buf
comma
id|tpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
OL
l_int|0x1000
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|MAXISA
suffix:semicolon
op_increment
id|x
)paren
(brace
r_if
c_cond
(paren
id|ISAbases
(braket
id|x
)braket
op_eq
id|base
)paren
(brace
id|ISAbases
(braket
id|x
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|base
op_amp
l_int|0x0fff
)paren
op_eq
l_int|0x0c88
)paren
(brace
id|x
op_assign
(paren
id|base
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|EISAbases
(braket
id|x
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_continue
suffix:semicolon
multiline_comment|/*break;*/
)brace
r_else
r_if
c_cond
(paren
id|check_blink_state
c_func
(paren
id|base
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HBA is in BLINK state. Consult your HBAs &quot;
l_string|&quot; Manual to correct this.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;error %x while reading PCI_BASE_ADDRESS_0&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;No BIOS32 extensions present. This release still depends on it.&quot;
l_string|&quot; Sorry.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* #ifndef CONFIG_PCI */
r_return
suffix:semicolon
)brace
DECL|function|eata_detect
r_int
id|eata_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|HBA_ptr
suffix:semicolon
r_struct
id|get_conf
id|gc
suffix:semicolon
id|ulong
id|base
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|geometry.drv
(braket
l_int|0
)braket
dot
id|trans
op_assign
id|geometry.drv
(braket
l_int|1
)braket
dot
id|trans
op_assign
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
(paren
id|DBG_PROBE
op_logical_and
id|DBG_DELAY
)paren
op_logical_or
id|DPT_DEBUG
comma
id|printk
c_func
(paren
l_string|&quot;Using lots of delays to let you read the debugging output&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|scsi_init_malloc
c_func
(paren
l_int|512
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|dma_scratch
op_assign
id|scsi_init_malloc
c_func
(paren
l_int|512
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|find_PCI
c_func
(paren
op_amp
id|gc
comma
id|tpnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXEISA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|base
op_assign
id|find_EISA
c_func
(paren
op_amp
id|gc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
)paren
id|register_HBA
c_func
(paren
id|base
comma
op_amp
id|gc
comma
id|tpnt
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAXISA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|base
op_assign
id|find_ISA
c_func
(paren
op_amp
id|gc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
)paren
id|register_HBA
c_func
(paren
id|base
comma
op_amp
id|gc
comma
id|tpnt
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAXIRQ
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|reg_IRQ
(braket
id|i
)braket
)paren
(brace
id|free_irq
c_func
(paren
id|i
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|i
comma
id|eata_int_handler
comma
id|SA_INTERRUPT
comma
l_string|&quot;EATA-DMA&quot;
)paren
suffix:semicolon
)brace
id|HBA_ptr
op_assign
id|first_HBA
suffix:semicolon
r_if
c_cond
(paren
id|registered_HBAs
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EATA (Extended Attachment) driver version: %d.%d%s&bslash;n&quot;
l_string|&quot;developed in co-operation with DPT&bslash;n&quot;
l_string|&quot;(c) 1993-95 Michael Neuffer  neuffer@goofy.zdv.uni-mainz.de&bslash;n&quot;
comma
id|VER_MAJOR
comma
id|VER_MINOR
comma
id|VER_SUB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Registered HBAs:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HBA no. Boardtype: Revis: EATA: Bus: BaseIO: IRQ: DMA: Ch: ID: Pr: QS: SG: CPL:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|registered_HBAs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%-2d: %.10s v%s 2.0%c  %s %#.4lx   %2d&quot;
comma
id|HBA_ptr-&gt;host_no
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|name
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|revision
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|EATA_revision
comma
(paren
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|bustype
op_eq
l_char|&squot;P&squot;
)paren
ques
c_cond
l_string|&quot;PCI &quot;
suffix:colon
(paren
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|bustype
op_eq
l_char|&squot;E&squot;
)paren
ques
c_cond
l_string|&quot;EISA&quot;
suffix:colon
l_string|&quot;ISA &quot;
comma
(paren
id|u32
)paren
id|HBA_ptr-&gt;base
comma
id|HBA_ptr-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HBA_ptr-&gt;dma_channel
op_ne
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;   %2x &quot;
comma
id|HBA_ptr-&gt;dma_channel
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;  %s&quot;
comma
l_string|&quot;BMST&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  %d   %d   %c  %2d  %2d   %2d&bslash;n&quot;
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|channel
comma
id|HBA_ptr-&gt;this_id
comma
(paren
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|primary
op_eq
id|TRUE
)paren
ques
c_cond
l_char|&squot;Y&squot;
suffix:colon
l_char|&squot;N&squot;
comma
id|HBA_ptr-&gt;can_queue
comma
id|HBA_ptr-&gt;sg_tablesize
comma
id|HBA_ptr-&gt;cmd_per_lun
)paren
suffix:semicolon
id|HBA_ptr
op_assign
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
r_else
id|scsi_init_free
c_func
(paren
(paren
r_void
op_star
)paren
id|status
comma
l_int|512
)paren
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_void
op_star
)paren
id|dma_scratch
comma
l_int|512
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DPT_DEBUG
comma
id|DELAY
c_func
(paren
l_int|1200
)paren
)paren
suffix:semicolon
r_return
(paren
id|registered_HBAs
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|EATA_DMA
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
