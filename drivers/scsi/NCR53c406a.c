multiline_comment|/* &n; *  NCR53c406.c&n; *  Low-level SCSI driver for NCR53c406a chip.&n; *  Copyright (C) 1994, 1995, 1996 Normunds Saumanis (normunds@fi.ibm.com)&n; * &n; *  LILO command line usage: ncr53c406a=&lt;PORTBASE&gt;[,&lt;IRQ&gt;[,&lt;FASTPIO&gt;]]&n; *  Specify IRQ = 0 for non-interrupt driven mode.&n; *  FASTPIO = 1 for fast pio mode, 0 for slow mode.&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the&n; *  Free Software Foundation; either version 2, or (at your option) any&n; *  later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; */
DECL|macro|NCR53C406A_DEBUG
mdefine_line|#define NCR53C406A_DEBUG 0
DECL|macro|VERBOSE_NCR53C406A_DEBUG
mdefine_line|#define VERBOSE_NCR53C406A_DEBUG 0
multiline_comment|/* Set this to 1 for PIO mode (recommended) or to 0 for DMA mode */
DECL|macro|USE_PIO
mdefine_line|#define USE_PIO 1
DECL|macro|USE_BIOS
mdefine_line|#define USE_BIOS 0
multiline_comment|/* #define BIOS_ADDR 0xD8000 */
multiline_comment|/* define this if autoprobe fails */
multiline_comment|/* #define PORT_BASE 0x330 */
multiline_comment|/* define this if autoprobe fails */
multiline_comment|/* #define IRQ_LEV   0&t;*/
multiline_comment|/* define this if autoprobe fails */
DECL|macro|DMA_CHAN
mdefine_line|#define DMA_CHAN  5&t;&t;/* this is ignored if DMA is disabled */
multiline_comment|/* Set this to 0 if you encounter kernel lockups while transferring &n; * data in PIO mode */
DECL|macro|USE_FAST_PIO
mdefine_line|#define USE_FAST_PIO 1
multiline_comment|/* ============= End of user configurable parameters ============= */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;NCR53c406a.h&quot;
multiline_comment|/* ============================================================= */
DECL|macro|WATCHDOG
mdefine_line|#define WATCHDOG 5000000
DECL|macro|SYNC_MODE
mdefine_line|#define SYNC_MODE 0 &t;&t;/* Synchronous transfer mode */
macro_line|#if DEBUG
DECL|macro|NCR53C406A_DEBUG
macro_line|#undef NCR53C406A_DEBUG
DECL|macro|NCR53C406A_DEBUG
mdefine_line|#define NCR53C406A_DEBUG 1
macro_line|#endif
macro_line|#if USE_PIO
DECL|macro|USE_DMA
mdefine_line|#define USE_DMA 0
macro_line|#else
DECL|macro|USE_DMA
mdefine_line|#define USE_DMA 1
macro_line|#endif
multiline_comment|/* Default configuration */
DECL|macro|C1_IMG
mdefine_line|#define C1_IMG   0x07&t;&t;/* ID=7 */
DECL|macro|C2_IMG
mdefine_line|#define C2_IMG   0x48&t;&t;/* FE SCSI2 */
macro_line|#if USE_DMA
DECL|macro|C3_IMG
mdefine_line|#define C3_IMG   0x21&t;&t;/* CDB TE */
macro_line|#else
DECL|macro|C3_IMG
mdefine_line|#define C3_IMG   0x20&t;&t;/* CDB */
macro_line|#endif
DECL|macro|C4_IMG
mdefine_line|#define C4_IMG   0x04&t;&t;/* ANE */
DECL|macro|C5_IMG
mdefine_line|#define C5_IMG   0xb6&t;&t;/* AA PI SIE POL */
DECL|macro|REG0
mdefine_line|#define REG0 (outb(C4_IMG, CONFIG4))
DECL|macro|REG1
mdefine_line|#define REG1 (outb(C5_IMG, CONFIG5))
macro_line|#if NCR53C406A_DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
macro_line|#if VERBOSE_NCR53C406A_DEBUG
DECL|macro|VDEB
mdefine_line|#define VDEB(x) x
macro_line|#else
DECL|macro|VDEB
mdefine_line|#define VDEB(x)
macro_line|#endif
DECL|macro|LOAD_DMA_COUNT
mdefine_line|#define LOAD_DMA_COUNT(count) &bslash;&n;  outb(count &amp; 0xff, TC_LSB); &bslash;&n;  outb((count &gt;&gt; 8) &amp; 0xff, TC_MSB); &bslash;&n;  outb((count &gt;&gt; 16) &amp; 0xff, TC_HIGH);
multiline_comment|/* Chip commands */
DECL|macro|DMA_OP
mdefine_line|#define DMA_OP               0x80
DECL|macro|SCSI_NOP
mdefine_line|#define SCSI_NOP             0x00
DECL|macro|FLUSH_FIFO
mdefine_line|#define FLUSH_FIFO           0x01
DECL|macro|CHIP_RESET
mdefine_line|#define CHIP_RESET           0x02
DECL|macro|SCSI_RESET
mdefine_line|#define SCSI_RESET           0x03
DECL|macro|RESELECT
mdefine_line|#define RESELECT             0x40
DECL|macro|SELECT_NO_ATN
mdefine_line|#define SELECT_NO_ATN        0x41
DECL|macro|SELECT_ATN
mdefine_line|#define SELECT_ATN           0x42
DECL|macro|SELECT_ATN_STOP
mdefine_line|#define SELECT_ATN_STOP      0x43
DECL|macro|ENABLE_SEL
mdefine_line|#define ENABLE_SEL           0x44
DECL|macro|DISABLE_SEL
mdefine_line|#define DISABLE_SEL          0x45
DECL|macro|SELECT_ATN3
mdefine_line|#define SELECT_ATN3          0x46
DECL|macro|RESELECT3
mdefine_line|#define RESELECT3            0x47
DECL|macro|TRANSFER_INFO
mdefine_line|#define TRANSFER_INFO        0x10
DECL|macro|INIT_CMD_COMPLETE
mdefine_line|#define INIT_CMD_COMPLETE    0x11
DECL|macro|MSG_ACCEPT
mdefine_line|#define MSG_ACCEPT           0x12
DECL|macro|TRANSFER_PAD
mdefine_line|#define TRANSFER_PAD         0x18
DECL|macro|SET_ATN
mdefine_line|#define SET_ATN              0x1a
DECL|macro|RESET_ATN
mdefine_line|#define RESET_ATN            0x1b
DECL|macro|SEND_MSG
mdefine_line|#define SEND_MSG             0x20
DECL|macro|SEND_STATUS
mdefine_line|#define SEND_STATUS          0x21
DECL|macro|SEND_DATA
mdefine_line|#define SEND_DATA            0x22
DECL|macro|DISCONN_SEQ
mdefine_line|#define DISCONN_SEQ          0x23
DECL|macro|TERMINATE_SEQ
mdefine_line|#define TERMINATE_SEQ        0x24
DECL|macro|TARG_CMD_COMPLETE
mdefine_line|#define TARG_CMD_COMPLETE    0x25
DECL|macro|DISCONN
mdefine_line|#define DISCONN              0x27
DECL|macro|RECV_MSG
mdefine_line|#define RECV_MSG             0x28
DECL|macro|RECV_CMD
mdefine_line|#define RECV_CMD             0x29
DECL|macro|RECV_DATA
mdefine_line|#define RECV_DATA            0x2a
DECL|macro|RECV_CMD_SEQ
mdefine_line|#define RECV_CMD_SEQ         0x2b
DECL|macro|TARGET_ABORT_DMA
mdefine_line|#define TARGET_ABORT_DMA     0x04
multiline_comment|/*----------------------------------------------------------------*/
multiline_comment|/* the following will set the monitor border color (useful to find&n;   where something crashed or gets stuck at */
multiline_comment|/* 1 = blue&n;   2 = green&n;   3 = cyan&n;   4 = red&n;   5 = magenta&n;   6 = yellow&n;   7 = white&n;*/
macro_line|#if NCR53C406A_DEBUG
DECL|macro|rtrc
mdefine_line|#define rtrc(i) {inb(0x3da);outb(0x31,0x3c0);outb((i),0x3c0);}
macro_line|#else
DECL|macro|rtrc
mdefine_line|#define rtrc(i) {}
macro_line|#endif
multiline_comment|/*----------------------------------------------------------------*/
DECL|enum|Phase
r_enum
id|Phase
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|data_out
id|data_out
comma
DECL|enumerator|data_in
id|data_in
comma
DECL|enumerator|command_ph
id|command_ph
comma
DECL|enumerator|status_ph
id|status_ph
comma
DECL|enumerator|message_out
id|message_out
comma
DECL|enumerator|message_in
id|message_in
)brace
suffix:semicolon
multiline_comment|/* Static function prototypes */
r_static
r_void
id|NCR53c406a_intr
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|do_NCR53c406a_intr
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|wait_intr
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|chip_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|calc_port_addr
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifndef IRQ_LEV
r_static
r_int
id|irq_probe
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* ================================================================= */
macro_line|#if USE_BIOS
DECL|variable|bios_base
r_static
r_void
op_star
id|bios_base
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if PORT_BASE
DECL|variable|port_base
r_static
r_int
id|port_base
op_assign
id|PORT_BASE
suffix:semicolon
macro_line|#else
DECL|variable|port_base
r_static
r_int
id|port_base
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if IRQ_LEV
DECL|variable|irq_level
r_static
r_int
id|irq_level
op_assign
id|IRQ_LEV
suffix:semicolon
macro_line|#else
DECL|variable|irq_level
r_static
r_int
id|irq_level
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* 0 is &squot;no irq&squot;, so use -1 for &squot;uninitialized&squot;*/
macro_line|#endif
macro_line|#if USE_DMA
DECL|variable|dma_chan
r_static
r_int
id|dma_chan
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if USE_PIO
DECL|variable|fast_pio
r_static
r_int
id|fast_pio
op_assign
id|USE_FAST_PIO
suffix:semicolon
macro_line|#endif
DECL|variable|current_SC
r_static
id|Scsi_Cmnd
op_star
id|current_SC
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|internal_done_flag
r_static
r_volatile
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_static
r_volatile
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
DECL|variable|info_msg
r_static
r_char
id|info_msg
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* ================================================================= */
multiline_comment|/* possible BIOS locations */
macro_line|#if USE_BIOS
DECL|variable|addresses
r_static
r_void
op_star
id|addresses
(braket
)braket
op_assign
(brace
(paren
r_void
op_star
)paren
l_int|0xd8000
comma
(paren
r_void
op_star
)paren
l_int|0xc8000
)brace
suffix:semicolon
DECL|macro|ADDRESS_COUNT
mdefine_line|#define ADDRESS_COUNT (sizeof( addresses ) / sizeof( unsigned ))
macro_line|#endif USE_BIOS
multiline_comment|/* possible i/o port addresses */
DECL|variable|ports
r_static
r_int
r_int
id|ports
(braket
)braket
op_assign
(brace
l_int|0x230
comma
l_int|0x330
comma
l_int|0x280
comma
l_int|0x290
comma
l_int|0x330
comma
l_int|0x340
comma
l_int|0x300
comma
l_int|0x310
comma
l_int|0x348
comma
l_int|0x350
)brace
suffix:semicolon
DECL|macro|PORT_COUNT
mdefine_line|#define PORT_COUNT (sizeof( ports ) / sizeof( unsigned short ))
multiline_comment|/* possible interrupt channels */
DECL|variable|intrs
r_static
r_int
r_int
id|intrs
(braket
)braket
op_assign
(brace
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|15
)brace
suffix:semicolon
DECL|macro|INTR_COUNT
mdefine_line|#define INTR_COUNT (sizeof( intrs ) / sizeof( unsigned short ))
multiline_comment|/* signatures for NCR 53c406a based controllers */
macro_line|#if USE_BIOS
DECL|struct|signature
r_struct
id|signature
(brace
DECL|member|signature
r_char
op_star
id|signature
suffix:semicolon
DECL|member|sig_offset
r_int
id|sig_offset
suffix:semicolon
DECL|member|sig_length
r_int
id|sig_length
suffix:semicolon
DECL|variable|__initdata
)brace
id|signatures
(braket
)braket
id|__initdata
op_assign
(brace
multiline_comment|/*          1         2         3         4         5         6 */
multiline_comment|/* 123456789012345678901234567890123456789012345678901234567890 */
(brace
l_string|&quot;Copyright (C) Acculogic, Inc.&bslash;r&bslash;n2.8M Diskette Extension Bios ver 4.04.03 03/01/1993&quot;
comma
l_int|61
comma
l_int|82
)brace
comma
)brace
suffix:semicolon
DECL|macro|SIGNATURE_COUNT
mdefine_line|#define SIGNATURE_COUNT (sizeof( signatures ) / sizeof( struct signature ))
macro_line|#endif USE_BIOS
multiline_comment|/* ============================================================ */
multiline_comment|/* Control Register Set 0 */
DECL|variable|TC_LSB
r_static
r_int
id|TC_LSB
suffix:semicolon
multiline_comment|/* transfer counter lsb &t;*/
DECL|variable|TC_MSB
r_static
r_int
id|TC_MSB
suffix:semicolon
multiline_comment|/* transfer counter msb&t;*/
DECL|variable|SCSI_FIFO
r_static
r_int
id|SCSI_FIFO
suffix:semicolon
multiline_comment|/* scsi fifo register&t;*/
DECL|variable|CMD_REG
r_static
r_int
id|CMD_REG
suffix:semicolon
multiline_comment|/* command register&t;&t;*/
DECL|variable|STAT_REG
r_static
r_int
id|STAT_REG
suffix:semicolon
multiline_comment|/* status register&t;&t;*/
DECL|variable|DEST_ID
r_static
r_int
id|DEST_ID
suffix:semicolon
multiline_comment|/* selection/reselection bus id */
DECL|variable|INT_REG
r_static
r_int
id|INT_REG
suffix:semicolon
multiline_comment|/* interrupt status register    */
DECL|variable|SRTIMOUT
r_static
r_int
id|SRTIMOUT
suffix:semicolon
multiline_comment|/* select/reselect timeout reg  */
DECL|variable|SEQ_REG
r_static
r_int
id|SEQ_REG
suffix:semicolon
multiline_comment|/* sequence step register&t;*/
DECL|variable|SYNCPRD
r_static
r_int
id|SYNCPRD
suffix:semicolon
multiline_comment|/* synchronous transfer period  */
DECL|variable|FIFO_FLAGS
r_static
r_int
id|FIFO_FLAGS
suffix:semicolon
multiline_comment|/* indicates # of bytes in fifo */
DECL|variable|SYNCOFF
r_static
r_int
id|SYNCOFF
suffix:semicolon
multiline_comment|/* synchronous offset register  */
DECL|variable|CONFIG1
r_static
r_int
id|CONFIG1
suffix:semicolon
multiline_comment|/* configuration register&t;*/
DECL|variable|CLKCONV
r_static
r_int
id|CLKCONV
suffix:semicolon
multiline_comment|/* clock conversion reg&t;*/
multiline_comment|/*static int TESTREG;*/
multiline_comment|/* test mode register&t;&t;*/
DECL|variable|CONFIG2
r_static
r_int
id|CONFIG2
suffix:semicolon
multiline_comment|/* Configuration 2 Register     */
DECL|variable|CONFIG3
r_static
r_int
id|CONFIG3
suffix:semicolon
multiline_comment|/* Configuration 3 Register&t;*/
DECL|variable|CONFIG4
r_static
r_int
id|CONFIG4
suffix:semicolon
multiline_comment|/* Configuration 4 Register     */
DECL|variable|TC_HIGH
r_static
r_int
id|TC_HIGH
suffix:semicolon
multiline_comment|/* Transfer Counter High */
multiline_comment|/*static int FIFO_BOTTOM;*/
multiline_comment|/* Reserve FIFO byte register   */
multiline_comment|/* Control Register Set 1 */
multiline_comment|/*static int JUMPER_SENSE;*/
multiline_comment|/* Jumper sense port reg (r/w) */
multiline_comment|/*static int SRAM_PTR;*/
multiline_comment|/* SRAM address pointer reg (r/w) */
multiline_comment|/*static int SRAM_DATA;*/
multiline_comment|/* SRAM data register (r/w) */
DECL|variable|PIO_FIFO
r_static
r_int
id|PIO_FIFO
suffix:semicolon
multiline_comment|/* PIO FIFO registers (r/w) */
multiline_comment|/*static int PIO_FIFO1;*/
multiline_comment|/*  */
multiline_comment|/*static int PIO_FIFO2;*/
multiline_comment|/*  */
multiline_comment|/*static int PIO_FIFO3;*/
multiline_comment|/*  */
DECL|variable|PIO_STATUS
r_static
r_int
id|PIO_STATUS
suffix:semicolon
multiline_comment|/* PIO status (r/w) */
multiline_comment|/*static int ATA_CMD;*/
multiline_comment|/* ATA command/status reg (r/w) */
multiline_comment|/*static int ATA_ERR;*/
multiline_comment|/* ATA features/error register (r/w)*/
DECL|variable|PIO_FLAG
r_static
r_int
id|PIO_FLAG
suffix:semicolon
multiline_comment|/* PIO flag interrupt enable (r/w) */
DECL|variable|CONFIG5
r_static
r_int
id|CONFIG5
suffix:semicolon
multiline_comment|/* Configuration 5 register (r/w) */
multiline_comment|/*static int SIGNATURE;*/
multiline_comment|/* Signature Register (r) */
multiline_comment|/*static int CONFIG6;*/
multiline_comment|/* Configuration 6 register (r) */
multiline_comment|/* ============================================================== */
macro_line|#if USE_DMA
r_static
id|__inline__
r_int
DECL|function|NCR53c406a_dma_setup
id|NCR53c406a_dma_setup
(paren
r_int
r_char
op_star
id|ptr
comma
r_int
r_int
id|count
comma
r_int
r_char
id|mode
)paren
(brace
r_int
id|limit
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;dma: before count=%d   &quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_chan
op_le
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|count
OG
l_int|65536
)paren
id|count
op_assign
l_int|65536
suffix:semicolon
id|limit
op_assign
l_int|65536
op_minus
(paren
(paren
(paren
r_int
)paren
id|ptr
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|count
OG
(paren
l_int|65536
op_lshift
l_int|1
)paren
)paren
id|count
op_assign
(paren
l_int|65536
op_lshift
l_int|1
)paren
suffix:semicolon
id|limit
op_assign
(paren
l_int|65536
op_lshift
l_int|1
)paren
op_minus
(paren
(paren
(paren
r_int
)paren
id|ptr
)paren
op_amp
l_int|0x1FFFF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
id|limit
)paren
id|count
op_assign
id|limit
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;after count=%d&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_amp
l_int|1
)paren
op_logical_or
(paren
(paren
(paren
r_int
)paren
id|ptr
)paren
op_amp
l_int|1
)paren
)paren
id|panic
(paren
l_string|&quot;NCR53c406a: attempted unaligned DMA transfer&bslash;n&quot;
)paren
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|dma_chan
comma
(paren
r_int
)paren
id|ptr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|dma_chan
comma
id|count
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dma_chan
comma
id|mode
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|NCR53c406a_dma_write
id|NCR53c406a_dma_write
c_func
(paren
r_int
r_char
op_star
id|src
comma
r_int
r_int
id|count
)paren
(brace
r_return
id|NCR53c406a_dma_setup
(paren
id|src
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|NCR53c406a_dma_read
id|NCR53c406a_dma_read
c_func
(paren
r_int
r_char
op_star
id|src
comma
r_int
r_int
id|count
)paren
(brace
r_return
id|NCR53c406a_dma_setup
(paren
id|src
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|NCR53c406a_dma_residual
id|NCR53c406a_dma_residual
(paren
r_void
)paren
(brace
r_register
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
id|tmp
op_assign
id|get_dma_residue
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
macro_line|#endif USE_DMA
macro_line|#if USE_PIO
DECL|function|NCR53c406a_pio_read
r_static
id|__inline__
r_int
id|NCR53c406a_pio_read
c_func
(paren
r_int
r_char
op_star
id|request
comma
r_int
r_int
id|reqlen
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* current scsi fifo size */
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|REG1
suffix:semicolon
r_while
c_loop
(paren
id|reqlen
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|PIO_STATUS
)paren
suffix:semicolon
multiline_comment|/*    VDEB(printk(&quot;pio_status=%x&bslash;n&quot;, i)); */
r_if
c_cond
(paren
id|i
op_amp
l_int|0x80
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|i
op_amp
l_int|0x1e
)paren
(brace
r_default
suffix:colon
r_case
l_int|0x10
suffix:colon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0
suffix:colon
id|len
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
id|len
op_assign
l_int|42
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|len
op_assign
l_int|84
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe
suffix:colon
id|len
op_assign
l_int|128
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x40
)paren
op_logical_and
id|len
op_eq
l_int|0
)paren
(brace
multiline_comment|/* fifo empty and interrupt occurred */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OG
id|reqlen
)paren
(brace
id|len
op_assign
id|reqlen
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fast_pio
op_logical_and
id|len
OG
l_int|3
)paren
(brace
id|insl
c_func
(paren
id|PIO_FIFO
comma
id|request
comma
id|len
op_rshift
l_int|2
)paren
suffix:semicolon
id|request
op_add_assign
id|len
op_amp
l_int|0xfc
suffix:semicolon
id|reqlen
op_sub_assign
id|len
op_amp
l_int|0xfc
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
op_star
id|request
op_increment
op_assign
id|inb
c_func
(paren
id|PIO_FIFO
)paren
suffix:semicolon
id|reqlen
op_decrement
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|NCR53c406a_pio_write
r_static
id|__inline__
r_int
id|NCR53c406a_pio_write
c_func
(paren
r_int
r_char
op_star
id|request
comma
r_int
r_int
id|reqlen
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* current scsi fifo size */
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|REG1
suffix:semicolon
r_while
c_loop
(paren
id|reqlen
op_logical_and
op_logical_neg
(paren
id|i
op_amp
l_int|0x40
)paren
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|PIO_STATUS
)paren
suffix:semicolon
multiline_comment|/*    VDEB(printk(&quot;pio_status=%x&bslash;n&quot;, i)); */
r_if
c_cond
(paren
id|i
op_amp
l_int|0x80
)paren
multiline_comment|/* error */
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|i
op_amp
l_int|0x1e
)paren
(brace
r_case
l_int|0x10
suffix:colon
id|len
op_assign
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0
suffix:colon
id|len
op_assign
l_int|84
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
id|len
op_assign
l_int|42
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|len
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|0xe
suffix:colon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OG
id|reqlen
)paren
(brace
id|len
op_assign
id|reqlen
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fast_pio
op_logical_and
id|len
OG
l_int|3
)paren
(brace
id|outsl
c_func
(paren
id|PIO_FIFO
comma
id|request
comma
id|len
op_rshift
l_int|2
)paren
suffix:semicolon
id|request
op_add_assign
id|len
op_amp
l_int|0xfc
suffix:semicolon
id|reqlen
op_sub_assign
id|len
op_amp
l_int|0xfc
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|outb
c_func
(paren
op_star
id|request
op_increment
comma
id|PIO_FIFO
)paren
suffix:semicolon
id|reqlen
op_decrement
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif USE_PIO
r_int
id|__init
DECL|function|NCR53c406a_detect
(def_block
id|NCR53c406a_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
macro_line|#ifndef PORT_BASE
r_int
id|i
suffix:semicolon
macro_line|#endif
macro_line|#if USE_BIOS
r_int
id|ii
comma
id|jj
suffix:semicolon
id|bios_base
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* look for a valid signature */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|ADDRESS_COUNT
op_logical_and
op_logical_neg
id|bios_base
suffix:semicolon
id|ii
op_increment
)paren
r_for
c_loop
(paren
id|jj
op_assign
l_int|0
suffix:semicolon
(paren
id|jj
OL
id|SIGNATURE_COUNT
)paren
op_logical_and
op_logical_neg
id|bios_base
suffix:semicolon
id|jj
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
(paren
r_void
op_star
)paren
id|addresses
(braket
id|ii
)braket
op_plus
id|signatures
(braket
id|jj
)braket
dot
id|sig_offset
comma
(paren
r_void
op_star
)paren
id|signatures
(braket
id|jj
)braket
dot
id|signature
comma
(paren
r_int
)paren
id|signatures
(braket
id|jj
)braket
dot
id|sig_length
)paren
)paren
(brace
id|bios_base
op_assign
id|addresses
(braket
id|ii
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|bios_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: BIOS signature not found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a BIOS found at %X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|bios_base
)paren
suffix:semicolon
)paren
suffix:semicolon
macro_line|#endif USE_BIOS
macro_line|#ifdef PORT_BASE
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|port_base
comma
l_int|0x10
)paren
)paren
multiline_comment|/* ports already snatched */
id|port_base
op_assign
l_int|0
suffix:semicolon
macro_line|#else  /* autodetect */
r_if
c_cond
(paren
id|port_base
)paren
(brace
multiline_comment|/* LILO override */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|port_base
comma
l_int|0x10
)paren
)paren
id|port_base
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PORT_COUNT
op_logical_and
op_logical_neg
id|port_base
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ports
(braket
id|i
)braket
comma
l_int|0x10
)paren
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: port %x in use&bslash;n&quot;
comma
id|ports
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: port %x available&bslash;n&quot;
comma
id|ports
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|C5_IMG
comma
id|ports
(braket
id|i
)braket
op_plus
l_int|0x0d
)paren
suffix:semicolon
multiline_comment|/* reg set 1 */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
l_int|0x0e
)paren
op_xor
id|inb
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
l_int|0x0e
)paren
)paren
op_eq
l_int|7
op_logical_and
(paren
id|inb
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
l_int|0x0e
)paren
op_xor
id|inb
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
l_int|0x0e
)paren
)paren
op_eq
l_int|7
op_logical_and
(paren
id|inb
c_func
(paren
id|ports
(braket
id|i
)braket
op_plus
l_int|0x0e
)paren
op_amp
l_int|0xf8
)paren
op_eq
l_int|0x58
)paren
(brace
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Sig register valid&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;port_base=%x&bslash;n&quot;
comma
id|port_base
)paren
)paren
suffix:semicolon
id|port_base
op_assign
id|ports
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif PORT_BASE
r_if
c_cond
(paren
op_logical_neg
id|port_base
)paren
(brace
multiline_comment|/* no ports found */
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: no available ports found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|calc_port_addr
c_func
(paren
)paren
suffix:semicolon
id|chip_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifndef IRQ_LEV
r_if
c_cond
(paren
id|irq_level
OL
l_int|0
)paren
(brace
multiline_comment|/* LILO override if &gt;= 0*/
id|irq_level
op_assign
id|irq_probe
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_level
OL
l_int|0
)paren
(brace
multiline_comment|/* Trouble */
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: IRQ problem, irq_level=%d, giving up&bslash;n&quot;
comma
id|irq_level
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: using port_base %x&bslash;n&quot;
comma
id|port_base
)paren
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|port_base
comma
l_int|0x10
comma
l_string|&quot;NCR53c406a&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_level
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq_level
comma
id|do_NCR53c406a_intr
comma
l_int|0
comma
l_string|&quot;NCR53c406a&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: unable to allocate IRQ %d&bslash;n&quot;
comma
id|irq_level
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tpnt-&gt;can_queue
op_assign
l_int|1
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: allocated IRQ %d&bslash;n&quot;
comma
id|irq_level
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_level
op_eq
l_int|0
)paren
(brace
id|tpnt-&gt;can_queue
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: No interrupts detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if USE_DMA
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: No interrupts found and DMA mode defined. Giving up.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif USE_DMA
)brace
r_else
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Shouldn&squot;t get here!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if USE_DMA
id|dma_chan
op_assign
id|DMA_CHAN
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dma_chan
comma
l_string|&quot;NCR53c406a&quot;
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: unable to allocate DMA channel %d&bslash;n&quot;
comma
id|dma_chan
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Allocated DMA channel %d&bslash;n&quot;
comma
id|dma_chan
)paren
)paren
suffix:semicolon
macro_line|#endif USE_DMA 
id|tpnt-&gt;present
op_assign
l_int|1
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;NCR53c406a&quot;
suffix:semicolon
id|shpnt
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
l_int|0
)paren
suffix:semicolon
id|shpnt-&gt;irq
op_assign
id|irq_level
suffix:semicolon
id|shpnt-&gt;io_port
op_assign
id|port_base
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
l_int|0x10
suffix:semicolon
macro_line|#if USE_DMA
id|shpnt-&gt;dma
op_assign
id|dma_chan
suffix:semicolon
macro_line|#endif
macro_line|#if USE_DMA
id|sprintf
c_func
(paren
id|info_msg
comma
l_string|&quot;NCR53c406a at 0x%x, IRQ %d, DMA channel %d.&quot;
comma
id|port_base
comma
id|irq_level
comma
id|dma_chan
)paren
suffix:semicolon
macro_line|#else
id|sprintf
c_func
(paren
id|info_msg
comma
l_string|&quot;NCR53c406a at 0x%x, IRQ %d, %s PIO mode.&quot;
comma
id|port_base
comma
id|irq_level
comma
id|fast_pio
ques
c_cond
l_string|&quot;fast&quot;
suffix:colon
l_string|&quot;slow&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|tpnt-&gt;present
)paren
suffix:semicolon
)brace
)def_block
multiline_comment|/* called from init/main.c */
DECL|function|NCR53c406a_setup
r_void
id|__init
id|NCR53c406a_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_static
r_int
id|setup_idx
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Setup called&bslash;n&quot;
)paren
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup_idx
op_ge
id|PORT_COUNT
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Setup called too many times.  Bad LILO params?&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
template_param
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Malformed command line&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Usage: ncr53c406a=&lt;PORTBASE&gt;[,&lt;IRQ&gt;[,&lt;FASTPIO&gt;]]&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PORT_COUNT
op_logical_and
op_logical_neg
id|port_base
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ports
(braket
id|i
)braket
op_eq
id|ints
(braket
l_int|1
)braket
)paren
(brace
id|port_base
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Specified port_base 0x%X&bslash;n&quot;
comma
id|port_base
)paren
suffix:semicolon
)paren
)brace
r_if
c_cond
(paren
op_logical_neg
id|port_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Invalid PORTBASE 0x%X specified&bslash;n&quot;
comma
id|ints
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|2
)braket
op_eq
l_int|0
)paren
(brace
id|irq_level
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Specified irq %d&bslash;n&quot;
comma
id|irq_level
)paren
suffix:semicolon
)paren
)brace
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|INTR_COUNT
op_logical_and
id|irq_level
OL
l_int|0
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|intrs
(braket
id|i
)braket
op_eq
id|ints
(braket
l_int|2
)braket
)paren
(brace
id|irq_level
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Specified irq %d&bslash;n&quot;
comma
id|port_base
)paren
suffix:semicolon
)paren
)brace
r_if
c_cond
(paren
id|irq_level
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Invalid IRQ %d specified&bslash;n&quot;
comma
id|ints
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|2
)paren
id|fast_pio
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: port_base=0x%X, irq=%d, fast_pio=%d&bslash;n&quot;
comma
id|port_base
comma
id|irq_level
comma
id|fast_pio
)paren
suffix:semicolon
)paren
)brace
r_const
r_char
op_star
DECL|function|NCR53c406a_info
(def_block
id|NCR53c406a_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SChost
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_info called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
id|info_msg
)paren
suffix:semicolon
)brace
)def_block
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_errcode
op_assign
id|SCpnt-&gt;result
suffix:semicolon
op_increment
id|internal_done_flag
suffix:semicolon
)brace
DECL|function|wait_intr
r_static
r_void
id|wait_intr
c_func
(paren
)paren
(brace
r_int
id|i
op_assign
id|jiffies
op_plus
id|WATCHDOG
suffix:semicolon
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|i
comma
id|jiffies
)paren
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|STAT_REG
)paren
op_amp
l_int|0xe0
)paren
)paren
(brace
multiline_comment|/* wait for a pseudo-interrupt */
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_before_eq
c_func
(paren
id|i
comma
id|jiffies
)paren
)paren
(brace
multiline_comment|/* Timed out */
id|rtrc
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|current_SC-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_SC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|NCR53c406a_intr
c_func
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|NCR53c406a_command
r_int
(def_block
id|NCR53c406a_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_command called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR53c406a_queue
c_func
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_level
)paren
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
suffix:semicolon
r_else
multiline_comment|/* interrupts not supported */
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
id|wait_intr
c_func
(paren
)paren
suffix:semicolon
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
r_return
id|internal_done_errcode
suffix:semicolon
)brace
)def_block
r_int
DECL|function|NCR53c406a_queue
(def_block
id|NCR53c406a_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_queue called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd=%02x, cmd_len=%02x, target=%02x, lun=%02x, bufflen=%d&bslash;n&quot;
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;cmd_len
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|SCpnt-&gt;request_bufflen
)paren
)paren
suffix:semicolon
macro_line|#if 0
id|VDEB
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;cmd[%d]=%02x  &quot;
comma
id|i
comma
id|SCpnt-&gt;cmnd
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
id|current_SC
op_assign
id|SCpnt
suffix:semicolon
id|current_SC-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|command_ph
suffix:semicolon
id|current_SC-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
id|current_SC-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|REG0
suffix:semicolon
id|outb
c_func
(paren
id|SCpnt-&gt;target
comma
id|DEST_ID
)paren
suffix:semicolon
multiline_comment|/* set destination */
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|CMD_REG
)paren
suffix:semicolon
multiline_comment|/* reset the fifos */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|SCpnt-&gt;cmnd
(braket
id|i
)braket
comma
id|SCSI_FIFO
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|SELECT_NO_ATN
comma
id|CMD_REG
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|rtrc
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
r_int
DECL|function|NCR53c406a_abort
(def_block
id|NCR53c406a_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_abort called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
multiline_comment|/* Don&squot;t know how to abort */
)brace
)def_block
r_int
DECL|function|NCR53c406a_reset
(def_block
id|NCR53c406a_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|ignored
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_reset called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|C4_IMG
comma
id|CONFIG4
)paren
suffix:semicolon
multiline_comment|/* Select reg set 0 */
id|outb
c_func
(paren
id|CHIP_RESET
comma
id|CMD_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SCSI_NOP
comma
id|CMD_REG
)paren
suffix:semicolon
multiline_comment|/* required after reset */
id|outb
c_func
(paren
id|SCSI_RESET
comma
id|CMD_REG
)paren
suffix:semicolon
id|chip_init
c_func
(paren
)paren
suffix:semicolon
id|rtrc
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_level
)paren
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
multiline_comment|/* should get an interrupt */
r_else
r_return
id|SCSI_RESET_WAKEUP
suffix:semicolon
multiline_comment|/* won&squot;t get any interrupts */
)brace
)def_block
r_int
DECL|function|NCR53c406a_biosparm
(def_block
id|NCR53c406a_biosparm
c_func
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|info_array
)paren
(brace
r_int
id|size
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_biosparm called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|info_array
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* heads */
id|info_array
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* sectors */
id|info_array
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
suffix:semicolon
multiline_comment|/* cylinders */
r_if
c_cond
(paren
id|info_array
(braket
l_int|2
)braket
OG
l_int|1024
)paren
(brace
multiline_comment|/* big disk */
id|info_array
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|info_array
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info_array
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)def_block
r_static
r_void
DECL|function|do_NCR53c406a_intr
(def_block
id|do_NCR53c406a_intr
c_func
(paren
r_int
id|unused
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|NCR53c406a_intr
c_func
(paren
l_int|0
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)def_block
r_static
r_void
DECL|function|NCR53c406a_intr
(def_block
id|NCR53c406a_intr
c_func
(paren
r_int
id|unused
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|DEB
c_func
(paren
r_int
r_char
id|fifo_size
suffix:semicolon
)paren
id|DEB
c_func
(paren
r_int
r_char
id|seq_reg
suffix:semicolon
)paren
r_int
r_char
id|status
comma
id|int_reg
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
macro_line|#if USE_PIO
r_int
r_char
id|pio_status
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
r_int
r_int
id|sgcount
suffix:semicolon
macro_line|#endif
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a_intr called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if USE_PIO
id|REG1
suffix:semicolon
id|pio_status
op_assign
id|inb
c_func
(paren
id|PIO_STATUS
)paren
suffix:semicolon
macro_line|#endif
id|REG0
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|STAT_REG
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|seq_reg
op_assign
id|inb
c_func
(paren
id|SEQ_REG
)paren
)paren
suffix:semicolon
id|int_reg
op_assign
id|inb
c_func
(paren
id|INT_REG
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|fifo_size
op_assign
id|inb
c_func
(paren
id|FIFO_FLAGS
)paren
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if NCR53C406A_DEBUG
id|printk
c_func
(paren
l_string|&quot;status=%02x, seq_reg=%02x, int_reg=%02x, fifo_size=%02x&quot;
comma
id|status
comma
id|seq_reg
comma
id|int_reg
comma
id|fifo_size
)paren
suffix:semicolon
macro_line|#if (USE_DMA)
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;, pio=%02x&bslash;n&quot;
comma
id|pio_status
)paren
suffix:semicolon
macro_line|#endif USE_DMA
macro_line|#endif NCR53C406A_DEBUG
r_if
c_cond
(paren
id|int_reg
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* SCSI reset intr */
id|rtrc
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: reset intr received&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_SC-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|current_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_SC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if USE_PIO
r_if
c_cond
(paren
id|pio_status
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53C406A: Warning: PIO error!&bslash;n&quot;
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|current_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_SC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif USE_PIO
r_if
c_cond
(paren
id|status
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* Parity error */
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Warning: parity error!&bslash;n&quot;
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_SC-&gt;result
op_assign
id|DID_PARITY
op_lshift
l_int|16
suffix:semicolon
id|current_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_SC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* Gross error */
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Warning: gross error!&bslash;n&quot;
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|current_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_SC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|int_reg
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* Disconnect */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: disconnect intr received&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_SC-&gt;SCp.phase
op_ne
id|message_in
)paren
(brace
multiline_comment|/* Unexpected disconnect */
id|current_SC-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Command complete, return status and message */
id|current_SC-&gt;result
op_assign
(paren
id|current_SC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|current_SC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
id|rtrc
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|idle
suffix:semicolon
id|current_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|current_SC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
op_amp
l_int|0x07
)paren
(brace
multiline_comment|/* scsi phase */
r_case
l_int|0x00
suffix:colon
multiline_comment|/* DATA-OUT */
r_if
c_cond
(paren
id|int_reg
op_amp
l_int|0x10
)paren
(brace
multiline_comment|/* Target requesting info transfer */
id|rtrc
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|data_out
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Data-Out phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|CMD_REG
)paren
suffix:semicolon
id|LOAD_DMA_COUNT
c_func
(paren
id|current_SC-&gt;request_bufflen
)paren
suffix:semicolon
multiline_comment|/* Max transfer size */
macro_line|#if USE_DMA&t;&t;&t;/* No s/g support for DMA */
id|NCR53c406a_dma_write
c_func
(paren
id|current_SC-&gt;request_buffer
comma
id|current_SC-&gt;request_bufflen
)paren
suffix:semicolon
macro_line|#endif USE_DMA
id|outb
c_func
(paren
id|TRANSFER_INFO
op_or
id|DMA_OP
comma
id|CMD_REG
)paren
suffix:semicolon
macro_line|#if USE_PIO
r_if
c_cond
(paren
op_logical_neg
id|current_SC-&gt;use_sg
)paren
multiline_comment|/* Don&squot;t use scatter-gather */
id|NCR53c406a_pio_write
c_func
(paren
id|current_SC-&gt;request_buffer
comma
id|current_SC-&gt;request_bufflen
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* use scatter-gather */
id|sgcount
op_assign
id|current_SC-&gt;use_sg
suffix:semicolon
id|sglist
op_assign
id|current_SC-&gt;request_buffer
suffix:semicolon
r_while
c_loop
(paren
id|sgcount
op_decrement
)paren
(brace
id|NCR53c406a_pio_write
c_func
(paren
id|sglist-&gt;address
comma
id|sglist-&gt;length
)paren
suffix:semicolon
id|sglist
op_increment
suffix:semicolon
)brace
)brace
id|REG0
suffix:semicolon
macro_line|#endif USE_PIO
)brace
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* DATA-IN */
r_if
c_cond
(paren
id|int_reg
op_amp
l_int|0x10
)paren
(brace
multiline_comment|/* Target requesting info transfer */
id|rtrc
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|data_in
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Data-In phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|CMD_REG
)paren
suffix:semicolon
id|LOAD_DMA_COUNT
c_func
(paren
id|current_SC-&gt;request_bufflen
)paren
suffix:semicolon
multiline_comment|/* Max transfer size */
macro_line|#if USE_DMA&t;&t;&t;/* No s/g support for DMA */
id|NCR53c406a_dma_read
c_func
(paren
id|current_SC-&gt;request_buffer
comma
id|current_SC-&gt;request_bufflen
)paren
suffix:semicolon
macro_line|#endif USE_DMA
id|outb
c_func
(paren
id|TRANSFER_INFO
op_or
id|DMA_OP
comma
id|CMD_REG
)paren
suffix:semicolon
macro_line|#if USE_PIO
r_if
c_cond
(paren
op_logical_neg
id|current_SC-&gt;use_sg
)paren
multiline_comment|/* Don&squot;t use scatter-gather */
id|NCR53c406a_pio_read
c_func
(paren
id|current_SC-&gt;request_buffer
comma
id|current_SC-&gt;request_bufflen
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Use scatter-gather */
id|sgcount
op_assign
id|current_SC-&gt;use_sg
suffix:semicolon
id|sglist
op_assign
id|current_SC-&gt;request_buffer
suffix:semicolon
r_while
c_loop
(paren
id|sgcount
op_decrement
)paren
(brace
id|NCR53c406a_pio_read
c_func
(paren
id|sglist-&gt;address
comma
id|sglist-&gt;length
)paren
suffix:semicolon
id|sglist
op_increment
suffix:semicolon
)brace
)brace
id|REG0
suffix:semicolon
macro_line|#endif USE_PIO
)brace
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* COMMAND */
id|current_SC-&gt;SCp.phase
op_assign
id|command_ph
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Warning: Unknown interrupt occurred in command phase!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* STATUS */
id|rtrc
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|status_ph
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Status phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FLUSH_FIFO
comma
id|CMD_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|INIT_CMD_COMPLETE
comma
id|CMD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Reserved */
r_case
l_int|0x05
suffix:colon
multiline_comment|/* Reserved */
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: WARNING: Reserved phase!!!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* MESSAGE-OUT */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Message-Out phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|message_out
suffix:semicolon
id|outb
c_func
(paren
id|SET_ATN
comma
id|CMD_REG
)paren
suffix:semicolon
multiline_comment|/* Reject the message */
id|outb
c_func
(paren
id|MSG_ACCEPT
comma
id|CMD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
multiline_comment|/* MESSAGE-IN */
id|rtrc
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;NCR53c406a: Message-In phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|current_SC-&gt;SCp.phase
op_assign
id|message_in
suffix:semicolon
id|current_SC-&gt;SCp.Status
op_assign
id|inb
c_func
(paren
id|SCSI_FIFO
)paren
suffix:semicolon
id|current_SC-&gt;SCp.Message
op_assign
id|inb
c_func
(paren
id|SCSI_FIFO
)paren
suffix:semicolon
id|VDEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;SCSI FIFO size=%d&bslash;n&quot;
comma
id|inb
c_func
(paren
id|FIFO_FLAGS
)paren
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Status = %02x  Message = %02x&bslash;n&quot;
comma
id|current_SC-&gt;SCp.Status
comma
id|current_SC-&gt;SCp.Message
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_SC-&gt;SCp.Message
op_eq
id|SAVE_POINTERS
op_logical_or
id|current_SC-&gt;SCp.Message
op_eq
id|DISCONNECT
)paren
(brace
id|outb
c_func
(paren
id|SET_ATN
comma
id|CMD_REG
)paren
suffix:semicolon
multiline_comment|/* Reject message */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Discarding SAVE_POINTERS message&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|MSG_ACCEPT
comma
id|CMD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)def_block
macro_line|#ifndef IRQ_LEV
DECL|function|irq_probe
r_static
r_int
id|irq_probe
c_func
(paren
)paren
(brace
r_int
id|irqs
comma
id|irq
suffix:semicolon
r_int
id|i
suffix:semicolon
id|inb
c_func
(paren
id|INT_REG
)paren
suffix:semicolon
multiline_comment|/* clear the interrupt register */
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Invalid command will cause an interrupt */
id|REG0
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|CMD_REG
)paren
suffix:semicolon
multiline_comment|/* Wait for the interrupt to occur */
id|i
op_assign
id|jiffies
op_plus
id|WATCHDOG
suffix:semicolon
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|i
comma
id|jiffies
)paren
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|STAT_REG
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_before_eq
c_func
(paren
id|i
comma
id|jiffies
)paren
)paren
(brace
multiline_comment|/* Timed out, must be hardware trouble */
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
multiline_comment|/* Kick the chip */
id|outb
c_func
(paren
id|CHIP_RESET
comma
id|CMD_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SCSI_NOP
comma
id|CMD_REG
)paren
suffix:semicolon
id|chip_init
c_func
(paren
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
macro_line|#endif IRQ_LEV
DECL|function|chip_init
r_static
r_void
id|chip_init
c_func
(paren
)paren
(brace
id|REG1
suffix:semicolon
macro_line|#if USE_DMA
id|outb
c_func
(paren
l_int|0x00
comma
id|PIO_STATUS
)paren
suffix:semicolon
macro_line|#else  /* USE_PIO */
id|outb
c_func
(paren
l_int|0x01
comma
id|PIO_STATUS
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
l_int|0x00
comma
id|PIO_FLAG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|C4_IMG
comma
id|CONFIG4
)paren
suffix:semicolon
multiline_comment|/* REG0; */
id|outb
c_func
(paren
id|C3_IMG
comma
id|CONFIG3
)paren
suffix:semicolon
id|outb
c_func
(paren
id|C2_IMG
comma
id|CONFIG2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|C1_IMG
comma
id|CONFIG1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|CLKCONV
)paren
suffix:semicolon
multiline_comment|/* clock conversion factor */
id|outb
c_func
(paren
l_int|0x9C
comma
id|SRTIMOUT
)paren
suffix:semicolon
multiline_comment|/* Selection timeout */
id|outb
c_func
(paren
l_int|0x05
comma
id|SYNCPRD
)paren
suffix:semicolon
multiline_comment|/* Synchronous transfer period */
id|outb
c_func
(paren
id|SYNC_MODE
comma
id|SYNCOFF
)paren
suffix:semicolon
multiline_comment|/* synchronous mode */
)brace
DECL|function|calc_port_addr
r_void
id|__init
id|calc_port_addr
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Control Register Set 0 */
id|TC_LSB
op_assign
(paren
id|port_base
op_plus
l_int|0x00
)paren
suffix:semicolon
id|TC_MSB
op_assign
(paren
id|port_base
op_plus
l_int|0x01
)paren
suffix:semicolon
id|SCSI_FIFO
op_assign
(paren
id|port_base
op_plus
l_int|0x02
)paren
suffix:semicolon
id|CMD_REG
op_assign
(paren
id|port_base
op_plus
l_int|0x03
)paren
suffix:semicolon
id|STAT_REG
op_assign
(paren
id|port_base
op_plus
l_int|0x04
)paren
suffix:semicolon
id|DEST_ID
op_assign
(paren
id|port_base
op_plus
l_int|0x04
)paren
suffix:semicolon
id|INT_REG
op_assign
(paren
id|port_base
op_plus
l_int|0x05
)paren
suffix:semicolon
id|SRTIMOUT
op_assign
(paren
id|port_base
op_plus
l_int|0x05
)paren
suffix:semicolon
id|SEQ_REG
op_assign
(paren
id|port_base
op_plus
l_int|0x06
)paren
suffix:semicolon
id|SYNCPRD
op_assign
(paren
id|port_base
op_plus
l_int|0x06
)paren
suffix:semicolon
id|FIFO_FLAGS
op_assign
(paren
id|port_base
op_plus
l_int|0x07
)paren
suffix:semicolon
id|SYNCOFF
op_assign
(paren
id|port_base
op_plus
l_int|0x07
)paren
suffix:semicolon
id|CONFIG1
op_assign
(paren
id|port_base
op_plus
l_int|0x08
)paren
suffix:semicolon
id|CLKCONV
op_assign
(paren
id|port_base
op_plus
l_int|0x09
)paren
suffix:semicolon
multiline_comment|/* TESTREG&t;&t;= (port_base+0x0A); */
id|CONFIG2
op_assign
(paren
id|port_base
op_plus
l_int|0x0B
)paren
suffix:semicolon
id|CONFIG3
op_assign
(paren
id|port_base
op_plus
l_int|0x0C
)paren
suffix:semicolon
id|CONFIG4
op_assign
(paren
id|port_base
op_plus
l_int|0x0D
)paren
suffix:semicolon
id|TC_HIGH
op_assign
(paren
id|port_base
op_plus
l_int|0x0E
)paren
suffix:semicolon
multiline_comment|/* FIFO_BOTTOM&t;= (port_base+0x0F); */
multiline_comment|/* Control Register Set 1 */
multiline_comment|/* JUMPER_SENSE&t;= (port_base+0x00);*/
multiline_comment|/* SRAM_PTR&t;&t;= (port_base+0x01);*/
multiline_comment|/* SRAM_DATA&t;= (port_base+0x02);*/
id|PIO_FIFO
op_assign
(paren
id|port_base
op_plus
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* PIO_FIFO1&t;= (port_base+0x05);*/
multiline_comment|/* PIO_FIFO2&t;= (port_base+0x06);*/
multiline_comment|/* PIO_FIFO3&t;= (port_base+0x07);*/
id|PIO_STATUS
op_assign
(paren
id|port_base
op_plus
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* ATA_CMD&t;&t;= (port_base+0x09);*/
multiline_comment|/* ATA_ERR&t;&t;= (port_base+0x0A);*/
id|PIO_FLAG
op_assign
(paren
id|port_base
op_plus
l_int|0x0B
)paren
suffix:semicolon
id|CONFIG5
op_assign
(paren
id|port_base
op_plus
l_int|0x0D
)paren
suffix:semicolon
multiline_comment|/* SIGNATURE&t;= (port_base+0x0E);*/
multiline_comment|/* CONFIG6&t;&t;= (port_base+0x0F);*/
)brace
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|NCR53c406a
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
multiline_comment|/*&n; * Overrides for Emacs so that we get a uniform tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
