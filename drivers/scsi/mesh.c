multiline_comment|/*&n; * SCSI low-level driver for the MESH (Macintosh Enhanced SCSI Hardware)&n; * bus adaptor found on Power Macintosh computers.&n; * We assume the MESH is connected to a DBDMA (descriptor-based DMA)&n; * controller.&n; *&n; * Paul Mackerras, August 1996.&n; * Copyright (C) 1996 Paul Mackerras.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hydra.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;mesh.h&quot;
multiline_comment|/*&n; * To do:&n; * - handle aborts correctly&n; * - retry arbitration if lost (unless higher levels do this for us)&n; */
DECL|macro|MESH_NEW_STYLE_EH
mdefine_line|#define MESH_NEW_STYLE_EH
macro_line|#if 1
DECL|macro|KERN_DEBUG
macro_line|#undef KERN_DEBUG
DECL|macro|KERN_DEBUG
mdefine_line|#define KERN_DEBUG KERN_WARNING
macro_line|#endif
macro_line|#if CONFIG_SCSI_MESH_SYNC_RATE == 0
DECL|variable|mesh_sync_period
r_int
id|mesh_sync_period
op_assign
l_int|100
suffix:semicolon
DECL|variable|mesh_sync_offset
r_int
id|mesh_sync_offset
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|variable|mesh_sync_period
r_int
id|mesh_sync_period
op_assign
l_int|1000
op_div
id|CONFIG_SCSI_MESH_SYNC_RATE
suffix:semicolon
multiline_comment|/* ns */
DECL|variable|mesh_sync_offset
r_int
id|mesh_sync_offset
op_assign
l_int|15
suffix:semicolon
macro_line|#endif
DECL|variable|mesh_sync_targets
r_int
id|mesh_sync_targets
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* targets to set synchronous (bitmap) */
DECL|variable|mesh_resel_targets
r_int
id|mesh_resel_targets
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* targets that we let disconnect (bitmap) */
DECL|variable|mesh_debug_targets
r_int
id|mesh_debug_targets
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* print debug for these targets */
DECL|variable|use_active_neg
r_int
r_char
id|use_active_neg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bit mask for SEQ_ACTIVE_NEG if used */
DECL|macro|ALLOW_SYNC
mdefine_line|#define ALLOW_SYNC(tgt)&t;&t;((mesh_sync_targets &gt;&gt; (tgt)) &amp; 1)
DECL|macro|ALLOW_RESEL
mdefine_line|#define ALLOW_RESEL(tgt)&t;((mesh_resel_targets &gt;&gt; (tgt)) &amp; 1)
DECL|macro|ALLOW_DEBUG
mdefine_line|#define ALLOW_DEBUG(tgt)&t;((mesh_debug_targets &gt;&gt; (tgt)) &amp; 1)
DECL|macro|DEBUG_TARGET
mdefine_line|#define DEBUG_TARGET(cmd)&t;((cmd) &amp;&amp; ALLOW_DEBUG((cmd)-&gt;target))
DECL|macro|MESH_DBG
macro_line|#undef MESH_DBG
DECL|macro|N_DBG_LOG
mdefine_line|#define N_DBG_LOG&t;50
DECL|macro|N_DBG_SLOG
mdefine_line|#define N_DBG_SLOG&t;20
DECL|macro|NUM_DBG_EVENTS
mdefine_line|#define NUM_DBG_EVENTS&t;13
DECL|macro|DBG_USE_TB
macro_line|#undef&t;DBG_USE_TB&t;&t;/* bombs on 601 */
DECL|struct|dbglog
r_struct
id|dbglog
(brace
DECL|member|fmt
r_char
op_star
id|fmt
suffix:semicolon
DECL|member|tb
id|u32
id|tb
suffix:semicolon
DECL|member|phase
id|u8
id|phase
suffix:semicolon
DECL|member|bs0
id|u8
id|bs0
suffix:semicolon
DECL|member|bs1
id|u8
id|bs1
suffix:semicolon
DECL|member|tgt
id|u8
id|tgt
suffix:semicolon
DECL|member|d
r_int
id|d
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|mesh_phase
r_enum
id|mesh_phase
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|arbitrating
id|arbitrating
comma
DECL|enumerator|selecting
id|selecting
comma
DECL|enumerator|commanding
id|commanding
comma
DECL|enumerator|dataing
id|dataing
comma
DECL|enumerator|statusing
id|statusing
comma
DECL|enumerator|busfreeing
id|busfreeing
comma
DECL|enumerator|disconnecting
id|disconnecting
comma
DECL|enumerator|reselecting
id|reselecting
)brace
suffix:semicolon
DECL|enum|msg_phase
r_enum
id|msg_phase
(brace
DECL|enumerator|msg_none
id|msg_none
comma
DECL|enumerator|msg_out
id|msg_out
comma
DECL|enumerator|msg_out_xxx
id|msg_out_xxx
comma
DECL|enumerator|msg_out_last
id|msg_out_last
comma
DECL|enumerator|msg_in
id|msg_in
comma
DECL|enumerator|msg_in_bad
id|msg_in_bad
comma
)brace
suffix:semicolon
DECL|enum|sdtr_phase
r_enum
id|sdtr_phase
(brace
DECL|enumerator|do_sdtr
id|do_sdtr
comma
DECL|enumerator|sdtr_sent
id|sdtr_sent
comma
DECL|enumerator|sdtr_done
id|sdtr_done
)brace
suffix:semicolon
DECL|struct|mesh_target
r_struct
id|mesh_target
(brace
DECL|member|sdtr_state
r_enum
id|sdtr_phase
id|sdtr_state
suffix:semicolon
DECL|member|sync_params
r_int
id|sync_params
suffix:semicolon
DECL|member|data_goes_out
r_int
id|data_goes_out
suffix:semicolon
multiline_comment|/* guess as to data direction */
DECL|member|current_req
id|Scsi_Cmnd
op_star
id|current_req
suffix:semicolon
DECL|member|saved_ptr
id|u32
id|saved_ptr
suffix:semicolon
DECL|member|want_abort
r_int
id|want_abort
suffix:semicolon
macro_line|#ifdef MESH_DBG
DECL|member|log_ix
r_int
id|log_ix
suffix:semicolon
DECL|member|n_log
r_int
id|n_log
suffix:semicolon
DECL|member|log
r_struct
id|dbglog
id|log
(braket
id|N_DBG_LOG
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|struct|mesh_state
r_struct
id|mesh_state
(brace
DECL|member|mesh
r_volatile
r_struct
id|mesh_regs
op_star
id|mesh
suffix:semicolon
DECL|member|meshintr
r_int
id|meshintr
suffix:semicolon
DECL|member|dma
r_volatile
r_struct
id|dbdma_regs
op_star
id|dma
suffix:semicolon
DECL|member|dmaintr
r_int
id|dmaintr
suffix:semicolon
DECL|member|host
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
DECL|member|next
r_struct
id|mesh_state
op_star
id|next
suffix:semicolon
DECL|member|request_q
id|Scsi_Cmnd
op_star
id|request_q
suffix:semicolon
DECL|member|request_qtail
id|Scsi_Cmnd
op_star
id|request_qtail
suffix:semicolon
DECL|member|phase
r_enum
id|mesh_phase
id|phase
suffix:semicolon
multiline_comment|/* what we&squot;re currently trying to do */
DECL|member|msgphase
r_enum
id|msg_phase
id|msgphase
suffix:semicolon
DECL|member|conn_tgt
r_int
id|conn_tgt
suffix:semicolon
multiline_comment|/* target we&squot;re connected to */
DECL|member|current_req
id|Scsi_Cmnd
op_star
id|current_req
suffix:semicolon
multiline_comment|/* req we&squot;re currently working on */
DECL|member|data_ptr
r_int
id|data_ptr
suffix:semicolon
DECL|member|dma_started
r_int
id|dma_started
suffix:semicolon
DECL|member|dma_count
r_int
id|dma_count
suffix:semicolon
DECL|member|stat
r_int
id|stat
suffix:semicolon
DECL|member|aborting
r_int
id|aborting
suffix:semicolon
DECL|member|expect_reply
r_int
id|expect_reply
suffix:semicolon
DECL|member|n_msgin
r_int
id|n_msgin
suffix:semicolon
DECL|member|msgin
id|u8
id|msgin
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|n_msgout
r_int
id|n_msgout
suffix:semicolon
DECL|member|last_n_msgout
r_int
id|last_n_msgout
suffix:semicolon
DECL|member|msgout
id|u8
id|msgout
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|dma_cmds
r_struct
id|dbdma_cmd
op_star
id|dma_cmds
suffix:semicolon
multiline_comment|/* space for dbdma commands, aligned */
DECL|member|clk_freq
r_int
id|clk_freq
suffix:semicolon
DECL|member|tgts
r_struct
id|mesh_target
id|tgts
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|dma_cmd_space
r_void
op_star
id|dma_cmd_space
suffix:semicolon
DECL|member|ofnode
r_struct
id|device_node
op_star
id|ofnode
suffix:semicolon
macro_line|#ifndef MESH_NEW_STYLE_EH
DECL|member|completed_q
id|Scsi_Cmnd
op_star
id|completed_q
suffix:semicolon
DECL|member|completed_qtail
id|Scsi_Cmnd
op_star
id|completed_qtail
suffix:semicolon
DECL|member|tqueue
r_struct
id|tq_struct
id|tqueue
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MESH_DBG
DECL|member|log_ix
r_int
id|log_ix
suffix:semicolon
DECL|member|n_log
r_int
id|n_log
suffix:semicolon
DECL|member|log
r_struct
id|dbglog
id|log
(braket
id|N_DBG_SLOG
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
macro_line|#ifdef MESH_DBG
r_static
r_void
id|dlog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_char
op_star
id|fmt
comma
r_int
id|a
)paren
suffix:semicolon
r_static
r_void
id|dumplog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_int
id|tgt
)paren
suffix:semicolon
r_static
r_void
id|dumpslog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
suffix:semicolon
macro_line|#else
DECL|function|dlog
r_static
r_inline
r_void
id|dlog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_char
op_star
id|fmt
comma
r_int
id|a
)paren
(brace
)brace
DECL|function|dumplog
r_static
r_inline
r_void
id|dumplog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_int
id|tgt
)paren
(brace
)brace
DECL|function|dumpslog
r_static
r_inline
r_void
id|dumpslog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
)brace
macro_line|#endif /* MESH_DBG */
DECL|macro|MKWORD
mdefine_line|#define MKWORD(a, b, c, d)&t;(((a) &lt;&lt; 24) + ((b) &lt;&lt; 16) + ((c) &lt;&lt; 8) + (d))
DECL|variable|all_meshes
r_static
r_struct
id|mesh_state
op_star
id|all_meshes
suffix:semicolon
r_static
r_void
id|mesh_init
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_int
id|mesh_notify_reboot
c_func
(paren
r_struct
id|notifier_block
op_star
comma
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|mesh_dump_regs
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|mesh_start
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|mesh_start_cmd
c_func
(paren
r_struct
id|mesh_state
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
macro_line|#ifndef MESH_NEW_STYLE_EH
r_static
r_void
id|finish_cmds
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|add_sdtr_msg
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|set_sdtr
c_func
(paren
r_struct
id|mesh_state
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|start_phase
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|get_msgin
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_int
id|msgin_length
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|cmd_complete
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|phase_mismatch
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|reselected
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|handle_reset
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|handle_error
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|handle_exception
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|mesh_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|do_mesh_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|handle_msgin
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_void
id|mesh_done
c_func
(paren
r_struct
id|mesh_state
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|mesh_completed
c_func
(paren
r_struct
id|mesh_state
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|set_dma_cmds
c_func
(paren
r_struct
id|mesh_state
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|halt_dma
c_func
(paren
r_struct
id|mesh_state
op_star
)paren
suffix:semicolon
r_static
r_int
id|data_goes_out
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|do_abort
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
suffix:semicolon
DECL|variable|mesh_notifier
r_static
r_struct
id|notifier_block
id|mesh_notifier
op_assign
(brace
id|mesh_notify_reboot
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
r_int
DECL|function|mesh_detect
id|mesh_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tp
)paren
(brace
r_struct
id|device_node
op_star
id|mesh
suffix:semicolon
r_int
id|nmeshes
comma
id|tgt
comma
op_star
id|cfp
comma
id|minper
suffix:semicolon
r_struct
id|mesh_state
op_star
id|ms
comma
op_star
op_star
id|prev_statep
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|mesh_host
suffix:semicolon
r_void
op_star
id|dma_cmd_space
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
(brace
id|use_active_neg
op_assign
(paren
id|find_devices
c_func
(paren
l_string|&quot;mac-io&quot;
)paren
ques
c_cond
l_int|0
suffix:colon
id|SEQ_ACTIVE_NEG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* CHRP mac-io */
id|use_active_neg
op_assign
id|SEQ_ACTIVE_NEG
suffix:semicolon
)brace
id|nmeshes
op_assign
l_int|0
suffix:semicolon
id|prev_statep
op_assign
op_amp
id|all_meshes
suffix:semicolon
multiline_comment|/*&n;&t; * On powermacs, the MESH node has device_type &quot;mesh&quot;.&n;&t; * On chrp machines, its device_type is &quot;scsi&quot; with&n;&t; * &quot;chrp,mesh0&quot; as its `compatible&squot; property.&n;&t; */
id|mesh
op_assign
id|find_devices
c_func
(paren
l_string|&quot;mesh&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mesh
op_eq
l_int|0
)paren
id|mesh
op_assign
id|find_compatible_devices
c_func
(paren
l_string|&quot;scsi&quot;
comma
l_string|&quot;chrp,mesh0&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|mesh
op_ne
l_int|0
suffix:semicolon
id|mesh
op_assign
id|mesh-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|mesh-&gt;n_addrs
op_ne
l_int|2
op_logical_or
id|mesh-&gt;n_intrs
op_ne
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: expected 2 addrs and 2 intrs&quot;
l_string|&quot; (got %d,%d)&quot;
comma
id|mesh-&gt;n_addrs
comma
id|mesh-&gt;n_intrs
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mesh_host
op_assign
id|scsi_register
c_func
(paren
id|tp
comma
r_sizeof
(paren
r_struct
id|mesh_state
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mesh_host
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: couldn&squot;t register host&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mesh_host-&gt;unique_id
op_assign
id|nmeshes
suffix:semicolon
macro_line|#if !defined(MODULE)
id|note_scsi_host
c_func
(paren
id|mesh
comma
id|mesh_host
)paren
suffix:semicolon
macro_line|#endif
id|ms
op_assign
(paren
r_struct
id|mesh_state
op_star
)paren
id|mesh_host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;no mesh state&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ms
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ms
)paren
)paren
suffix:semicolon
id|ms-&gt;host
op_assign
id|mesh_host
suffix:semicolon
id|ms-&gt;ofnode
op_assign
id|mesh
suffix:semicolon
id|ms-&gt;mesh
op_assign
(paren
r_volatile
r_struct
id|mesh_regs
op_star
)paren
id|ioremap
c_func
(paren
id|mesh-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|ms-&gt;dma
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
id|ioremap
c_func
(paren
id|mesh-&gt;addrs
(braket
l_int|1
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|ms-&gt;meshintr
op_assign
id|mesh-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|ms-&gt;dmaintr
op_assign
id|mesh-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
suffix:semicolon
multiline_comment|/* Space for dma command list: +1 for stop command,&n;&t;&t;   +1 to allow for aligning. */
id|dma_cmd_space
op_assign
id|kmalloc
c_func
(paren
(paren
id|mesh_host-&gt;sg_tablesize
op_plus
l_int|2
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_cmd_space
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;mesh: couldn&squot;t allocate dma command space&quot;
)paren
suffix:semicolon
id|ms-&gt;dma_cmds
op_assign
(paren
r_struct
id|dbdma_cmd
op_star
)paren
id|DBDMA_ALIGN
c_func
(paren
id|dma_cmd_space
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ms-&gt;dma_cmds
comma
l_int|0
comma
(paren
id|mesh_host-&gt;sg_tablesize
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
id|ms-&gt;dma_cmd_space
op_assign
id|dma_cmd_space
suffix:semicolon
id|ms-&gt;current_req
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
l_int|8
suffix:semicolon
op_increment
id|tgt
)paren
(brace
id|ms-&gt;tgts
(braket
id|tgt
)braket
dot
id|sdtr_state
op_assign
id|do_sdtr
suffix:semicolon
id|ms-&gt;tgts
(braket
id|tgt
)braket
dot
id|sync_params
op_assign
id|ASYNC_PARAMS
suffix:semicolon
id|ms-&gt;tgts
(braket
id|tgt
)braket
dot
id|current_req
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MESH_NEW_STYLE_EH
id|ms-&gt;tqueue.routine
op_assign
id|finish_cmds
suffix:semicolon
id|ms-&gt;tqueue.data
op_assign
id|ms
suffix:semicolon
macro_line|#endif
op_star
id|prev_statep
op_assign
id|ms
suffix:semicolon
id|prev_statep
op_assign
op_amp
id|ms-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|mesh
comma
l_string|&quot;clock-frequency&quot;
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|ms-&gt;clk_freq
op_assign
op_star
id|cfp
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mesh: assuming 50MHz clock frequency&bslash;n&quot;
)paren
suffix:semicolon
id|ms-&gt;clk_freq
op_assign
l_int|50000000
suffix:semicolon
)brace
multiline_comment|/* The maximum sync rate is clock / 5; increase&n;&t;&t;   mesh_sync_period if necessary. */
id|minper
op_assign
l_int|1000000000
op_div
(paren
id|ms-&gt;clk_freq
op_div
l_int|5
)paren
suffix:semicolon
multiline_comment|/* ns */
r_if
c_cond
(paren
id|mesh_sync_period
OL
id|minper
)paren
id|mesh_sync_period
op_assign
id|minper
suffix:semicolon
id|feature_set
c_func
(paren
id|mesh
comma
id|FEATURE_MESH_enable
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|mesh_init
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ms-&gt;meshintr
comma
id|do_mesh_interrupt
comma
l_int|0
comma
l_string|&quot;MESH&quot;
comma
id|ms
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MESH: can&squot;t get irq %d&bslash;n&quot;
comma
id|ms-&gt;meshintr
)paren
suffix:semicolon
)brace
op_increment
id|nmeshes
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
op_logical_and
(paren
id|nmeshes
OG
l_int|0
)paren
)paren
id|register_reboot_notifier
c_func
(paren
op_amp
id|mesh_notifier
)paren
suffix:semicolon
r_return
id|nmeshes
suffix:semicolon
)brace
r_int
DECL|function|mesh_release
id|mesh_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|mesh_state
op_star
id|ms
op_assign
(paren
r_struct
id|mesh_state
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|ms
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;mesh
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ms-&gt;mesh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;dma
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ms-&gt;dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ms-&gt;dma_cmd_space
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ms-&gt;meshintr
comma
id|ms
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|ms-&gt;ofnode
comma
id|FEATURE_MESH_enable
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|mesh_queue
id|mesh_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|mesh_state
op_star
id|ms
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|ms
op_assign
(paren
r_struct
id|mesh_state
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;request_q
op_eq
l_int|NULL
)paren
id|ms-&gt;request_q
op_assign
id|cmd
suffix:semicolon
r_else
id|ms-&gt;request_qtail-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|cmd
suffix:semicolon
id|ms-&gt;request_qtail
op_assign
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;phase
op_eq
id|idle
)paren
id|mesh_start
c_func
(paren
id|ms
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|mesh_abort
id|mesh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|mesh_state
op_star
id|ms
op_assign
(paren
r_struct
id|mesh_state
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh_abort(%p)&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|mesh_dump_regs
c_func
(paren
id|ms
)paren
suffix:semicolon
id|dumplog
c_func
(paren
id|ms
comma
id|cmd-&gt;target
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
r_static
r_void
DECL|function|mesh_dump_regs
id|mesh_dump_regs
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|md
op_assign
id|ms-&gt;dma
suffix:semicolon
r_int
id|t
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: state at %p, regs at %p, dma at %p&bslash;n&quot;
comma
id|ms
comma
id|mr
comma
id|md
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;    ct=%4x seq=%2x bs=%4x fc=%2x &quot;
l_string|&quot;exc=%2x err=%2x im=%2x int=%2x sp=%2x&bslash;n&quot;
comma
(paren
id|mr-&gt;count_hi
op_lshift
l_int|8
)paren
op_plus
id|mr-&gt;count_lo
comma
id|mr-&gt;sequence
comma
(paren
id|mr-&gt;bus_status1
op_lshift
l_int|8
)paren
op_plus
id|mr-&gt;bus_status0
comma
id|mr-&gt;fifo_count
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;intr_mask
comma
id|mr-&gt;interrupt
comma
id|mr-&gt;sync_params
)paren
suffix:semicolon
r_while
c_loop
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;fifo_count
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; fifo data=%.2x&bslash;n&quot;
comma
id|in_8
c_func
(paren
op_amp
id|mr-&gt;fifo
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;    dma stat=%x cmdptr=%x&bslash;n&quot;
comma
id|in_le32
c_func
(paren
op_amp
id|md-&gt;status
)paren
comma
id|in_le32
c_func
(paren
op_amp
id|md-&gt;cmdptr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;    phase=%d msgphase=%d conn_tgt=%d data_ptr=%d&bslash;n&quot;
comma
id|ms-&gt;phase
comma
id|ms-&gt;msgphase
comma
id|ms-&gt;conn_tgt
comma
id|ms-&gt;data_ptr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;    dma_st=%d dma_ct=%d n_msgout=%d&bslash;n&quot;
comma
id|ms-&gt;dma_started
comma
id|ms-&gt;dma_count
comma
id|ms-&gt;n_msgout
)paren
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
l_int|8
suffix:semicolon
op_increment
id|t
)paren
(brace
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|t
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;current_req
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;    target %d: req=%p goes_out=%d saved_ptr=%d&bslash;n&quot;
comma
id|t
comma
id|tp-&gt;current_req
comma
id|tp-&gt;data_goes_out
comma
id|tp-&gt;saved_ptr
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|mesh_reset
id|mesh_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
id|how
)paren
(brace
r_struct
id|mesh_state
op_star
id|ms
op_assign
(paren
r_struct
id|mesh_state
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|md
op_assign
id|ms-&gt;dma
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh_reset %x&bslash;n&quot;
comma
id|how
)paren
suffix:semicolon
id|ret
op_assign
id|SCSI_RESET_BUS_RESET
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|md-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* stop dma */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;exception
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* clear all exception bits */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;error
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* clear all error bits */
r_if
c_cond
(paren
id|how
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_RESETMESH
)paren
suffix:semicolon
id|ret
op_or_assign
id|SCSI_RESET_HOST_RESET
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;intr_mask
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;source_id
comma
id|ms-&gt;host-&gt;this_id
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sel_timeout
comma
l_int|25
)paren
suffix:semicolon
multiline_comment|/* 250ms */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|ASYNC_PARAMS
)paren
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status1
comma
id|BS1_RST
)paren
suffix:semicolon
multiline_comment|/* assert RST */
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
multiline_comment|/* leave it on for &gt;= 25us */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* negate RST */
macro_line|#ifdef DO_ASYNC_RESET
r_if
c_cond
(paren
id|how
op_amp
id|SCSI_RESET_ASYNCHRONOUS
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ret
op_or_assign
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
id|handle_reset
c_func
(paren
id|ms
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifndef MESH_NEW_STYLE_EH
id|finish_cmds
c_func
(paren
id|ms
)paren
suffix:semicolon
macro_line|#endif
id|ret
op_or_assign
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * If we leave drives set for synchronous transfers (especially&n; * CDROMs), and reboot to MacOS, it gets confused, poor thing.&n; * So, on reboot we reset the SCSI bus.&n; */
r_static
r_int
DECL|function|mesh_notify_reboot
id|mesh_notify_reboot
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|code
comma
r_void
op_star
id|x
)paren
(brace
r_struct
id|mesh_state
op_star
id|ms
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|SYS_DOWN
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;resetting MESH scsi bus(es)&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ms
op_assign
id|all_meshes
suffix:semicolon
id|ms
op_ne
l_int|0
suffix:semicolon
id|ms
op_assign
id|ms-&gt;next
)paren
(brace
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;intr_mask
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status1
comma
id|BS1_RST
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status1
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
r_int
DECL|function|mesh_command
id|mesh_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;whoops... mesh_command called&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|mesh_init
id|mesh_init
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|md
op_assign
id|ms-&gt;dma
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|md-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* stop dma */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;exception
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* clear all exception bits */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;error
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* clear all error bits */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_RESETMESH
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;intr_mask
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;source_id
comma
id|ms-&gt;host-&gt;this_id
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sel_timeout
comma
l_int|25
)paren
suffix:semicolon
multiline_comment|/* 250ms */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|ASYNC_PARAMS
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status1
comma
id|BS1_RST
)paren
suffix:semicolon
multiline_comment|/* assert RST */
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
multiline_comment|/* leave it on for &gt;= 25us */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* negate RST */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_FLUSHFIFO
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|ASYNC_PARAMS
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* clear all interrupt bits */
)brace
multiline_comment|/*&n; * Start the next command for a MESH.&n; * Should be called with interrupts disabled.&n; */
r_static
r_void
DECL|function|mesh_start
id|mesh_start
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
comma
op_star
id|prev
comma
op_star
id|next
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;phase
op_ne
id|idle
op_logical_or
id|ms-&gt;current_req
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;inappropriate mesh_start (phase=%d, ms=%p)&quot;
comma
id|ms-&gt;phase
comma
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ms-&gt;phase
op_eq
id|idle
)paren
(brace
id|prev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|cmd
op_assign
id|ms-&gt;request_q
suffix:semicolon
suffix:semicolon
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|cmd-&gt;host_scribble
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;tgts
(braket
id|cmd-&gt;target
)braket
dot
id|current_req
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|prev
op_assign
id|cmd
suffix:semicolon
)brace
id|next
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|cmd-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_eq
l_int|NULL
)paren
id|ms-&gt;request_q
op_assign
id|next
suffix:semicolon
r_else
id|prev-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|next
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
l_int|NULL
)paren
id|ms-&gt;request_qtail
op_assign
id|prev
suffix:semicolon
id|mesh_start_cmd
c_func
(paren
id|ms
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|mesh_start_cmd
id|mesh_start_cmd
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_int
id|t
suffix:semicolon
id|ms-&gt;current_req
op_assign
id|cmd
suffix:semicolon
id|ms-&gt;tgts
(braket
id|cmd-&gt;target
)braket
dot
id|data_goes_out
op_assign
id|data_goes_out
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|ms-&gt;tgts
(braket
id|cmd-&gt;target
)braket
dot
id|current_req
op_assign
id|cmd
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|DEBUG_TARGET
c_func
(paren
id|cmd
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh_start: %p ser=%lu tgt=%d cmd=&quot;
comma
id|cmd
comma
id|cmd-&gt;serial_number
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; use_sg=%d buffer=%p bufflen=%u&bslash;n&quot;
comma
id|cmd-&gt;use_sg
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ms-&gt;phase
op_assign
id|arbitrating
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_none
suffix:semicolon
id|ms-&gt;data_ptr
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;dma_started
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;last_n_msgout
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;expect_reply
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;conn_tgt
op_assign
id|cmd-&gt;target
suffix:semicolon
id|ms-&gt;tgts
(braket
id|cmd-&gt;target
)braket
dot
id|saved_ptr
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;stat
op_assign
id|DID_OK
suffix:semicolon
id|ms-&gt;aborting
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MESH_DBG
id|ms-&gt;tgts
(braket
id|cmd-&gt;target
)braket
dot
id|n_log
op_assign
l_int|0
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;start cmd=%x&quot;
comma
(paren
r_int
)paren
id|cmd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Off we go */
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;about to arb, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mr-&gt;bus_status1
op_amp
(paren
id|BS1_BSY
op_or
id|BS1_SEL
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Some other device has the bus or is arbitrating for it -&n;&t;&t; * probably a target which is about to reselect us.&n;&t;&t; */
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;busy b4 arb, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|100
suffix:semicolon
id|t
OG
l_int|0
suffix:semicolon
op_decrement
id|t
)paren
(brace
r_if
c_cond
(paren
(paren
id|mr-&gt;bus_status1
op_amp
(paren
id|BS1_BSY
op_or
id|BS1_SEL
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
)paren
op_ne
l_int|0
)paren
(brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;intr b4 arb, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
id|mesh_interrupt
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;phase
op_ne
id|arbitrating
)paren
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mr-&gt;bus_status1
op_amp
(paren
id|BS1_BSY
op_or
id|BS1_SEL
)paren
)paren
(brace
multiline_comment|/* XXX should try again in a little while */
id|ms-&gt;stat
op_assign
id|DID_BUS_BUSY
suffix:semicolon
id|ms-&gt;phase
op_assign
id|idle
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Apparently the mesh has a bug where it will assert both its&n;&t; * own bit and the target&squot;s bit on the bus during arbitration.&n;&t; */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;dest_id
comma
id|mr-&gt;source_id
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * There appears to be a race with reselection sometimes,&n;&t; * where a target reselects us just as we issue the&n;&t; * arbitrate command.  It seems that then the arbitrate&n;&t; * command just hangs waiting for the bus to be free&n;&t; * without giving us a reselection exception.&n;&t; * The only way I have found to get it to respond correctly&n;&t; * is this: disable reselection before issuing the arbitrate&n;&t; * command, then after issuing it, if it looks like a target&n;&t; * is trying to reselect us, reset the mesh and then enable&n;&t; * reselection.&n;&t; */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_DISRESEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
)paren
op_ne
l_int|0
)paren
(brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;intr after disresel, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
id|mesh_interrupt
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;phase
op_ne
id|arbitrating
)paren
r_return
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;after intr after disresel, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ARBITRATE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|230
suffix:semicolon
id|t
OG
l_int|0
suffix:semicolon
op_decrement
id|t
)paren
(brace
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;after arb, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mr-&gt;interrupt
op_eq
l_int|0
op_logical_and
(paren
id|mr-&gt;bus_status1
op_amp
id|BS1_SEL
)paren
op_logical_and
(paren
id|mr-&gt;bus_status0
op_amp
id|BS0_IO
)paren
)paren
(brace
multiline_comment|/* looks like a reselection - try resetting the mesh */
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;resel? after arb, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_RESETMESH
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;intr_mask
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|10
suffix:semicolon
id|t
OG
l_int|0
op_logical_and
id|mr-&gt;interrupt
op_eq
l_int|0
suffix:semicolon
op_decrement
id|t
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;tried reset after arb, intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
macro_line|#ifndef MESH_MULTIPLE_HOSTS
r_if
c_cond
(paren
id|mr-&gt;interrupt
op_eq
l_int|0
op_logical_and
(paren
id|mr-&gt;bus_status1
op_amp
id|BS1_SEL
)paren
op_logical_and
(paren
id|mr-&gt;bus_status0
op_amp
id|BS0_IO
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: controller not responding&quot;
l_string|&quot; to reselection!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * If this is a target reselecting us, and the&n;&t;&t;&t; * mesh isn&squot;t responding, the higher levels of&n;&t;&t;&t; * the scsi code will eventually time out and&n;&t;&t;&t; * reset the bus.&n;&t;&t;&t; */
)brace
macro_line|#endif
)brace
)brace
macro_line|#ifndef MESH_NEW_STYLE_EH
r_static
r_void
DECL|function|finish_cmds
id|finish_cmds
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|mesh_state
op_star
id|ms
op_assign
id|data
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|cmd
op_assign
id|ms-&gt;completed_q
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ms-&gt;completed_q
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|cmd-&gt;host_scribble
suffix:semicolon
(paren
op_star
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* MESH_NEW_STYLE_EH */
r_static
r_inline
r_void
DECL|function|add_sdtr_msg
id|add_sdtr_msg
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|i
op_assign
id|ms-&gt;n_msgout
suffix:semicolon
id|ms-&gt;msgout
(braket
id|i
)braket
op_assign
id|EXTENDED_MESSAGE
suffix:semicolon
id|ms-&gt;msgout
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|ms-&gt;msgout
(braket
id|i
op_plus
l_int|2
)braket
op_assign
id|EXTENDED_SDTR
suffix:semicolon
id|ms-&gt;msgout
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|mesh_sync_period
op_div
l_int|4
suffix:semicolon
id|ms-&gt;msgout
(braket
id|i
op_plus
l_int|4
)braket
op_assign
(paren
id|ALLOW_SYNC
c_func
(paren
id|ms-&gt;conn_tgt
)paren
ques
c_cond
id|mesh_sync_offset
suffix:colon
l_int|0
)paren
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
id|i
op_plus
l_int|5
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_sdtr
id|set_sdtr
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_int
id|period
comma
r_int
id|offset
)paren
(brace
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_int
id|v
comma
id|tr
suffix:semicolon
id|tp-&gt;sdtr_state
op_assign
id|sdtr_done
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
l_int|0
)paren
(brace
multiline_comment|/* asynchronous */
r_if
c_cond
(paren
id|SYNC_OFF
c_func
(paren
id|tp-&gt;sync_params
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mesh: target %d now asynchronous&bslash;n&quot;
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|tp-&gt;sync_params
op_assign
id|ASYNC_PARAMS
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|ASYNC_PARAMS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We need to compute ceil(clk_freq * period / 500e6) - 2&n;&t; * without incurring overflow.&n;&t; */
id|v
op_assign
(paren
id|ms-&gt;clk_freq
op_div
l_int|5000
)paren
op_star
id|period
suffix:semicolon
r_if
c_cond
(paren
id|v
op_le
l_int|250000
)paren
(brace
multiline_comment|/* special case: sync_period == 5 * clk_period */
id|v
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* units of tr are 100kB/s */
id|tr
op_assign
(paren
id|ms-&gt;clk_freq
op_plus
l_int|250000
)paren
op_div
l_int|500000
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* sync_period == (v + 2) * 2 * clk_period */
id|v
op_assign
(paren
id|v
op_plus
l_int|99999
)paren
op_div
l_int|100000
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|v
OG
l_int|15
)paren
id|v
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* oops */
id|tr
op_assign
(paren
(paren
id|ms-&gt;clk_freq
op_div
(paren
id|v
op_plus
l_int|2
)paren
)paren
op_plus
l_int|199999
)paren
op_div
l_int|200000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OG
l_int|15
)paren
id|offset
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* can&squot;t happen */
id|tp-&gt;sync_params
op_assign
id|SYNC_PARAMS
c_func
(paren
id|offset
comma
id|v
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|tp-&gt;sync_params
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mesh: target %d synchronous at %d.%d MB/s&bslash;n&quot;
comma
id|ms-&gt;conn_tgt
comma
id|tr
op_div
l_int|10
comma
id|tr
op_mod
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|start_phase
id|start_phase
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|i
comma
id|seq
comma
id|nb
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_volatile
r_struct
id|dbdma_regs
op_star
id|md
op_assign
id|ms-&gt;dma
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|ms-&gt;current_req
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;start_phase nmo/exc/fc/seq = %.8x&quot;
comma
id|MKWORD
c_func
(paren
id|ms-&gt;n_msgout
comma
id|mr-&gt;exception
comma
id|mr-&gt;fifo_count
comma
id|mr-&gt;sequence
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|seq
op_assign
id|use_active_neg
op_plus
(paren
id|ms-&gt;n_msgout
ques
c_cond
id|SEQ_ATN
suffix:colon
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ms-&gt;msgphase
)paren
(brace
r_case
id|msg_none
suffix:colon
r_break
suffix:semicolon
r_case
id|msg_in
suffix:colon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_hi
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGIN
op_plus
id|seq
)paren
suffix:semicolon
id|ms-&gt;n_msgin
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
r_case
id|msg_out
suffix:colon
multiline_comment|/*&n;&t;&t; * To make sure ATN drops before we assert ACK for&n;&t;&t; * the last byte of the message, we have to do the&n;&t;&t; * last byte specially.&n;&t;&t; */
r_if
c_cond
(paren
id|ms-&gt;n_msgout
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: msg_out but n_msgout=%d&bslash;n&quot;
comma
id|ms-&gt;n_msgout
)paren
suffix:semicolon
id|mesh_dump_regs
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_none
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ALLOW_DEBUG
c_func
(paren
id|ms-&gt;conn_tgt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: sending %d msg bytes:&quot;
comma
id|ms-&gt;n_msgout
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ms-&gt;n_msgout
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|ms-&gt;msgout
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;msgout msg=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|ms-&gt;n_msgout
comma
id|ms-&gt;msgout
(braket
l_int|0
)braket
comma
id|ms-&gt;msgout
(braket
l_int|1
)braket
comma
id|ms-&gt;msgout
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_hi
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_FLUSHFIFO
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If ATN is not already asserted, we assert it, then&n;&t;&t; * issue a SEQ_MSGOUT to get the mesh to drop ACK.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mr-&gt;bus_status0
op_amp
id|BS0_ATN
)paren
op_eq
l_int|0
)paren
(brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;bus0 was %.2x explictly asserting ATN&quot;
comma
id|mr-&gt;bus_status0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status0
comma
id|BS0_ATN
)paren
suffix:semicolon
multiline_comment|/* explicit ATN */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGOUT
op_plus
id|seq
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;bus_status0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* release explicit ATN */
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;hace: after explicit ATN bus0=%.2x&quot;
comma
id|mr-&gt;bus_status0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ms-&gt;n_msgout
op_eq
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We can&squot;t issue the SEQ_MSGOUT without ATN&n;&t;&t;&t; * until the target has asserted REQ.  The logic&n;&t;&t;&t; * in cmd_complete handles both situations:&n;&t;&t;&t; * REQ already asserted or not.&n;&t;&t;&t; */
id|cmd_complete
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
id|ms-&gt;n_msgout
op_minus
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGOUT
op_plus
id|seq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ms-&gt;n_msgout
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
id|out_8
c_func
(paren
op_amp
id|mr-&gt;fifo
comma
id|ms-&gt;msgout
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh bug: start_phase msgphase=%d&bslash;n&quot;
comma
id|ms-&gt;msgphase
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ms-&gt;phase
)paren
(brace
r_case
id|selecting
suffix:colon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;dest_id
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_SELECT
op_plus
id|SEQ_ATN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|commanding
suffix:colon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|tp-&gt;sync_params
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_hi
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_COMMAND
op_plus
id|seq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
op_increment
id|i
)paren
id|out_8
c_func
(paren
op_amp
id|mr-&gt;fifo
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|6
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_COMMAND
op_plus
id|seq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
id|out_8
c_func
(paren
op_amp
id|mr-&gt;fifo
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|dataing
suffix:colon
multiline_comment|/* transfer data, if any */
r_if
c_cond
(paren
op_logical_neg
id|ms-&gt;dma_started
)paren
(brace
id|set_dma_cmds
c_func
(paren
id|ms
comma
id|cmd
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|md-&gt;cmdptr
comma
id|virt_to_phys
c_func
(paren
id|ms-&gt;dma_cmds
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|md-&gt;control
comma
(paren
id|RUN
op_lshift
l_int|16
)paren
op_or
id|RUN
)paren
suffix:semicolon
id|ms-&gt;dma_started
op_assign
l_int|1
suffix:semicolon
)brace
id|nb
op_assign
id|ms-&gt;dma_count
suffix:semicolon
r_if
c_cond
(paren
id|nb
OG
l_int|0xfff0
)paren
id|nb
op_assign
l_int|0xfff0
suffix:semicolon
id|ms-&gt;dma_count
op_sub_assign
id|nb
suffix:semicolon
id|ms-&gt;data_ptr
op_add_assign
id|nb
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
id|nb
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_hi
comma
id|nb
op_rshift
l_int|8
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
(paren
id|tp-&gt;data_goes_out
ques
c_cond
id|SEQ_DATAOUT
suffix:colon
id|SEQ_DATAIN
)paren
op_plus
id|SEQ_DMA_MODE
op_plus
id|seq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|statusing
suffix:colon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_hi
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_STATUS
op_plus
id|seq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|busfreeing
suffix:colon
r_case
id|disconnecting
suffix:colon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;enbresel intr/exc/err/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_BUSFREE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: start_phase called with phase=%d&bslash;n&quot;
comma
id|ms-&gt;phase
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|get_msgin
id|get_msgin
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
id|n
op_assign
id|mr-&gt;fifo_count
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|0
)paren
(brace
id|i
op_assign
id|ms-&gt;n_msgin
suffix:semicolon
id|ms-&gt;n_msgin
op_assign
id|i
op_plus
id|n
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
op_decrement
id|n
)paren
id|ms-&gt;msgin
(braket
id|i
op_increment
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|mr-&gt;fifo
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_int
DECL|function|msgin_length
id|msgin_length
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|b
comma
id|n
suffix:semicolon
id|n
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_msgin
OG
l_int|0
)paren
(brace
id|b
op_assign
id|ms-&gt;msgin
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|b
op_eq
l_int|1
)paren
(brace
multiline_comment|/* extended message */
id|n
op_assign
id|ms-&gt;n_msgin
OL
l_int|2
ques
c_cond
l_int|2
suffix:colon
id|ms-&gt;msgin
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
l_int|0x20
op_le
id|b
op_logical_and
id|b
op_le
l_int|0x2f
)paren
(brace
multiline_comment|/* 2-byte message */
id|n
op_assign
l_int|2
suffix:semicolon
)brace
)brace
r_return
id|n
suffix:semicolon
)brace
r_static
r_void
DECL|function|cmd_complete
id|cmd_complete
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|ms-&gt;current_req
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
suffix:semicolon
r_int
id|seq
comma
id|n
comma
id|t
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;cmd_complete fc=%x&quot;
comma
id|mr-&gt;fifo_count
)paren
suffix:semicolon
id|seq
op_assign
id|use_active_neg
op_plus
(paren
id|ms-&gt;n_msgout
ques
c_cond
id|SEQ_ATN
suffix:colon
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ms-&gt;msgphase
)paren
(brace
r_case
id|msg_out_xxx
suffix:colon
multiline_comment|/* huh?  we expected a phase mismatch */
id|ms-&gt;n_msgin
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_in
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|msg_in
suffix:colon
multiline_comment|/* should have some message bytes in fifo */
id|get_msgin
c_func
(paren
id|ms
)paren
suffix:semicolon
id|n
op_assign
id|msgin_length
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_msgin
OL
id|n
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
id|n
op_minus
id|ms-&gt;n_msgin
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGIN
op_plus
id|seq
)paren
suffix:semicolon
)brace
r_else
(brace
id|ms-&gt;msgphase
op_assign
id|msg_none
suffix:semicolon
id|handle_msgin
c_func
(paren
id|ms
)paren
suffix:semicolon
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|msg_in_bad
suffix:colon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_FLUSHFIFO
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGIN
op_plus
id|SEQ_ATN
op_plus
id|use_active_neg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|msg_out
suffix:colon
multiline_comment|/*&n;&t;&t; * To get the right timing on ATN wrt ACK, we have&n;&t;&t; * to get the MESH to drop ACK, wait until REQ gets&n;&t;&t; * asserted, then drop ATN.  To do this we first&n;&t;&t; * issue a SEQ_MSGOUT with ATN and wait for REQ,&n;&t;&t; * then change the command to a SEQ_MSGOUT w/o ATN.&n;&t;&t; * If we don&squot;t see REQ in a reasonable time, we&n;&t;&t; * change the command to SEQ_MSGIN with ATN,&n;&t;&t; * wait for the phase mismatch interrupt, then&n;&t;&t; * issue the SEQ_MSGOUT without ATN.&n;&t;&t; */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGOUT
op_plus
id|use_active_neg
op_plus
id|SEQ_ATN
)paren
suffix:semicolon
id|t
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* wait up to 30us */
r_while
c_loop
(paren
(paren
id|mr-&gt;bus_status0
op_amp
id|BS0_REQ
)paren
op_eq
l_int|0
op_logical_and
op_decrement
id|t
op_ge
l_int|0
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;last_mbyte err/exc/fc/cl=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;error
comma
id|mr-&gt;exception
comma
id|mr-&gt;fifo_count
comma
id|mr-&gt;count_lo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
)paren
op_amp
(paren
id|INT_ERROR
op_or
id|INT_EXCEPTION
)paren
)paren
(brace
multiline_comment|/* whoops, target didn&squot;t do what we expected */
id|ms-&gt;last_n_msgout
op_assign
id|ms-&gt;n_msgout
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
)paren
op_amp
id|INT_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: error %x in msg_out&bslash;n&quot;
comma
id|in_8
c_func
(paren
op_amp
id|mr-&gt;error
)paren
)paren
suffix:semicolon
id|handle_error
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;exception
)paren
op_ne
id|EXC_PHASEMM
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: exc %x in msg_out&bslash;n&quot;
comma
id|in_8
c_func
(paren
op_amp
id|mr-&gt;exception
)paren
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: bs0=%x in msg_out&bslash;n&quot;
comma
id|in_8
c_func
(paren
op_amp
id|mr-&gt;bus_status0
)paren
)paren
suffix:semicolon
id|handle_exception
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mr-&gt;bus_status0
op_amp
id|BS0_REQ
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGOUT
op_plus
id|use_active_neg
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;fifo
comma
id|ms-&gt;msgout
(braket
id|ms-&gt;n_msgout
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_out_last
suffix:semicolon
)brace
r_else
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGIN
op_plus
id|use_active_neg
op_plus
id|SEQ_ATN
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_out_xxx
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|msg_out_last
suffix:colon
id|ms-&gt;last_n_msgout
op_assign
id|ms-&gt;n_msgout
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|ms-&gt;expect_reply
ques
c_cond
id|msg_in
suffix:colon
id|msg_none
suffix:semicolon
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|msg_none
suffix:colon
r_switch
c_cond
(paren
id|ms-&gt;phase
)paren
(brace
r_case
id|idle
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: interrupt in idle phase?&bslash;n&quot;
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|selecting
suffix:colon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;Selecting phase at command completion&quot;
comma
l_int|0
)paren
suffix:semicolon
id|ms-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|IDENTIFY
c_func
(paren
id|ALLOW_RESEL
c_func
(paren
id|ms-&gt;conn_tgt
)paren
comma
(paren
id|cmd
ques
c_cond
id|cmd-&gt;lun
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;expect_reply
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;aborting
)paren
(brace
id|ms-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|ms-&gt;n_msgout
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;sdtr_state
op_eq
id|do_sdtr
)paren
(brace
multiline_comment|/* add SDTR message */
id|add_sdtr_msg
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;expect_reply
op_assign
l_int|1
suffix:semicolon
id|tp-&gt;sdtr_state
op_assign
id|sdtr_sent
suffix:semicolon
)brace
id|ms-&gt;msgphase
op_assign
id|msg_out
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * We need to wait for REQ before dropping ATN.&n;&t;&t;&t; * We wait for at most 30us, then fall back to&n;&t;&t;&t; * a scheme where we issue a SEQ_COMMAND with ATN,&n;&t;&t;&t; * which will give us a phase mismatch interrupt&n;&t;&t;&t; * when REQ does come, and then we send the message.&n;&t;&t;&t; */
id|t
op_assign
l_int|230
suffix:semicolon
multiline_comment|/* wait up to 230us */
r_while
c_loop
(paren
(paren
id|mr-&gt;bus_status0
op_amp
id|BS0_REQ
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|t
OL
l_int|0
)paren
(brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;impatient for req&quot;
comma
id|ms-&gt;n_msgout
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_none
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|dataing
suffix:colon
r_if
c_cond
(paren
id|ms-&gt;dma_count
op_ne
l_int|0
)paren
(brace
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * We can get a phase mismatch here if the target&n;&t;&t;&t; * changes to the status phase, even though we have&n;&t;&t;&t; * had a command complete interrupt.  Then, if we&n;&t;&t;&t; * issue the SEQ_STATUS command, we&squot;ll get a sequence&n;&t;&t;&t; * error interrupt.  Which isn&squot;t so bad except that&n;&t;&t;&t; * occasionally the mesh actually executes the&n;&t;&t;&t; * SEQ_STATUS *as well as* giving us the sequence&n;&t;&t;&t; * error and phase mismatch exception.&n;&t;&t;&t; */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|halt_dma
c_func
(paren
id|ms
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|statusing
suffix:colon
r_if
c_cond
(paren
id|cmd
)paren
(brace
id|cmd-&gt;SCp.Status
op_assign
id|mr-&gt;fifo
suffix:semicolon
r_if
c_cond
(paren
id|DEBUG_TARGET
c_func
(paren
id|cmd
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: status is %x&bslash;n&quot;
comma
id|cmd-&gt;SCp.Status
)paren
suffix:semicolon
)brace
id|ms-&gt;msgphase
op_assign
id|msg_in
suffix:semicolon
r_break
suffix:semicolon
r_case
id|busfreeing
suffix:colon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|disconnecting
suffix:colon
id|ms-&gt;current_req
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;phase
op_assign
id|idle
suffix:semicolon
id|mesh_start
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
op_increment
id|ms-&gt;phase
suffix:semicolon
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|phase_mismatch
r_static
r_void
id|phase_mismatch
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_int
id|phase
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;phasemm ch/cl/seq/fc=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|mr-&gt;count_hi
comma
id|mr-&gt;count_lo
comma
id|mr-&gt;sequence
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
id|phase
op_assign
id|mr-&gt;bus_status0
op_amp
id|BS0_PHASE
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;msgphase
op_eq
id|msg_out_xxx
op_logical_and
id|phase
op_eq
id|BP_MSGOUT
)paren
(brace
multiline_comment|/* output the last byte of the message, without ATN */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;count_lo
comma
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_MSGOUT
op_plus
id|use_active_neg
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;fifo
comma
id|ms-&gt;msgout
(braket
id|ms-&gt;n_msgout
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_out_last
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ms-&gt;msgphase
op_eq
id|msg_in
)paren
(brace
id|get_msgin
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_msgin
)paren
id|handle_msgin
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ms-&gt;dma_started
)paren
id|halt_dma
c_func
(paren
id|ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mr-&gt;fifo_count
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_FLUSHFIFO
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|ms-&gt;msgphase
op_assign
id|msg_none
suffix:semicolon
r_switch
c_cond
(paren
id|phase
)paren
(brace
r_case
id|BP_DATAIN
suffix:colon
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
dot
id|data_goes_out
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;phase
op_assign
id|dataing
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BP_DATAOUT
suffix:colon
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
dot
id|data_goes_out
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;phase
op_assign
id|dataing
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BP_COMMAND
suffix:colon
id|ms-&gt;phase
op_assign
id|commanding
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BP_STATUS
suffix:colon
id|ms-&gt;phase
op_assign
id|statusing
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BP_MSGIN
suffix:colon
id|ms-&gt;msgphase
op_assign
id|msg_in
suffix:semicolon
id|ms-&gt;n_msgin
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BP_MSGOUT
suffix:colon
id|ms-&gt;msgphase
op_assign
id|msg_out
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_msgout
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;aborting
)paren
(brace
id|do_abort
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ms-&gt;last_n_msgout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: no msg to repeat&bslash;n&quot;
)paren
suffix:semicolon
id|ms-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
id|ms-&gt;last_n_msgout
op_assign
l_int|1
suffix:semicolon
)brace
id|ms-&gt;n_msgout
op_assign
id|ms-&gt;last_n_msgout
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: unknown scsi phase %x&bslash;n&quot;
comma
id|phase
)paren
suffix:semicolon
id|ms-&gt;stat
op_assign
id|DID_ERROR
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|reselected
id|reselected
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
suffix:semicolon
r_int
id|b
comma
id|t
comma
id|prev
suffix:semicolon
r_switch
c_cond
(paren
id|ms-&gt;phase
)paren
(brace
r_case
id|idle
suffix:colon
r_break
suffix:semicolon
r_case
id|arbitrating
suffix:colon
r_if
c_cond
(paren
(paren
id|cmd
op_assign
id|ms-&gt;current_req
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* put the command back on the queue */
id|cmd-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|ms-&gt;request_q
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;request_q
op_eq
l_int|NULL
)paren
id|ms-&gt;request_qtail
op_assign
id|cmd
suffix:semicolon
id|ms-&gt;request_q
op_assign
id|cmd
suffix:semicolon
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|cmd-&gt;target
)braket
suffix:semicolon
id|tp-&gt;current_req
op_assign
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|busfreeing
suffix:colon
id|ms-&gt;phase
op_assign
id|reselecting
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|disconnecting
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: reselected in phase %d/%d tgt %d&bslash;n&quot;
comma
id|ms-&gt;msgphase
comma
id|ms-&gt;phase
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|dumplog
c_func
(paren
id|ms
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
id|ms-&gt;current_req
op_assign
l_int|NULL
suffix:semicolon
id|ms-&gt;phase
op_assign
id|dataing
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_in
suffix:semicolon
id|ms-&gt;dma_started
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;last_n_msgout
op_assign
l_int|0
suffix:semicolon
id|prev
op_assign
id|ms-&gt;conn_tgt
suffix:semicolon
multiline_comment|/*&n;&t; * We seem to get abortive reselections sometimes.&n;&t; */
r_while
c_loop
(paren
(paren
id|mr-&gt;bus_status1
op_amp
id|BS1_BSY
)paren
op_eq
l_int|0
)paren
(brace
r_static
r_int
id|mesh_aborted_resels
suffix:semicolon
id|mesh_aborted_resels
op_increment
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;extra resel err/exc/fc = %.6x&quot;
comma
id|MKWORD
c_func
(paren
l_int|0
comma
id|mr-&gt;error
comma
id|mr-&gt;exception
comma
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|ASYNC_PARAMS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Find out who reselected us.&n;&t; */
r_if
c_cond
(paren
id|mr-&gt;fifo_count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: reselection but nothing in fifo?&bslash;n&quot;
)paren
suffix:semicolon
id|ms-&gt;conn_tgt
op_assign
id|ms-&gt;host-&gt;this_id
suffix:semicolon
r_goto
id|bogus
suffix:semicolon
)brace
multiline_comment|/* get the last byte in the fifo */
r_do
(brace
id|b
op_assign
id|in_8
c_func
(paren
op_amp
id|mr-&gt;fifo
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;reseldata %x&quot;
comma
id|b
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|in_8
c_func
(paren
op_amp
id|mr-&gt;fifo_count
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
l_int|8
suffix:semicolon
op_increment
id|t
)paren
r_if
c_cond
(paren
(paren
id|b
op_amp
(paren
l_int|1
op_lshift
id|t
)paren
)paren
op_ne
l_int|0
op_logical_and
id|t
op_ne
id|ms-&gt;host-&gt;this_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|b
op_ne
(paren
l_int|1
op_lshift
id|t
)paren
op_plus
(paren
l_int|1
op_lshift
id|ms-&gt;host-&gt;this_id
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: bad reselection data %x&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
id|ms-&gt;conn_tgt
op_assign
id|ms-&gt;host-&gt;this_id
suffix:semicolon
r_goto
id|bogus
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set up to continue with that target&squot;s transfer.&n;&t; */
id|ms-&gt;conn_tgt
op_assign
id|t
suffix:semicolon
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|t
)braket
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|tp-&gt;sync_params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ALLOW_DEBUG
c_func
(paren
id|t
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: reselected by target %d&bslash;n&quot;
comma
id|t
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: saved_ptr=%x goes_out=%d cmd=%p&bslash;n&quot;
comma
id|tp-&gt;saved_ptr
comma
id|tp-&gt;data_goes_out
comma
id|tp-&gt;current_req
)paren
suffix:semicolon
)brace
id|ms-&gt;current_req
op_assign
id|tp-&gt;current_req
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;current_req
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: reselected by tgt %d but no cmd!&bslash;n&quot;
comma
id|t
)paren
suffix:semicolon
r_goto
id|bogus
suffix:semicolon
)brace
id|ms-&gt;data_ptr
op_assign
id|tp-&gt;saved_ptr
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;resel prev tgt=%d&quot;
comma
id|prev
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;resel err/exc=%.4x&quot;
comma
id|MKWORD
c_func
(paren
l_int|0
comma
l_int|0
comma
id|mr-&gt;error
comma
id|mr-&gt;exception
)paren
)paren
suffix:semicolon
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
id|bogus
suffix:colon
id|dumplog
c_func
(paren
id|ms
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;data_ptr
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;aborting
op_assign
l_int|1
suffix:semicolon
id|start_phase
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
DECL|function|do_abort
r_static
r_void
id|do_abort
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
id|ms-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;aborting
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;stat
op_assign
id|DID_ABORT
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;abort&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|handle_reset
id|handle_reset
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|tgt
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
l_int|8
suffix:semicolon
op_increment
id|tgt
)paren
(brace
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|tgt
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_assign
id|tp-&gt;current_req
)paren
op_ne
l_int|NULL
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|tp-&gt;current_req
op_assign
l_int|NULL
suffix:semicolon
id|mesh_completed
c_func
(paren
id|ms
comma
id|cmd
)paren
suffix:semicolon
)brace
id|ms-&gt;tgts
(braket
id|tgt
)braket
dot
id|sdtr_state
op_assign
id|do_sdtr
suffix:semicolon
id|ms-&gt;tgts
(braket
id|tgt
)braket
dot
id|sync_params
op_assign
id|ASYNC_PARAMS
suffix:semicolon
)brace
id|ms-&gt;current_req
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cmd
op_assign
id|ms-&gt;request_q
)paren
op_ne
l_int|NULL
)paren
(brace
id|ms-&gt;request_q
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|cmd-&gt;host_scribble
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|mesh_completed
c_func
(paren
id|ms
comma
id|cmd
)paren
suffix:semicolon
)brace
id|ms-&gt;phase
op_assign
id|idle
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_none
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_FLUSHFIFO
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sync_params
comma
id|ASYNC_PARAMS
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|do_mesh_interrupt
id|do_mesh_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|mesh_interrupt
c_func
(paren
id|irq
comma
id|dev_id
comma
id|ptregs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|handle_error
r_static
r_void
id|handle_error
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|err
comma
id|exc
comma
id|count
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
id|err
op_assign
id|in_8
c_func
(paren
op_amp
id|mr-&gt;error
)paren
suffix:semicolon
id|exc
op_assign
id|in_8
c_func
(paren
op_amp
id|mr-&gt;exception
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_ERROR
op_or
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;error err/exc/fc/cl=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|err
comma
id|exc
comma
id|mr-&gt;fifo_count
comma
id|mr-&gt;count_lo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_amp
id|ERR_SCSIRESET
)paren
(brace
multiline_comment|/* SCSI bus was reset */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mesh: SCSI bus reset detected: &quot;
l_string|&quot;waiting for end...&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mr-&gt;bus_status1
op_amp
id|BS1_RST
)paren
op_ne
l_int|0
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
id|handle_reset
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/* request_q is empty, no point in mesh_start() */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_amp
id|ERR_UNEXPDISC
)paren
(brace
multiline_comment|/* Unexpected disconnect */
r_if
c_cond
(paren
id|exc
op_amp
id|EXC_RESELECTED
)paren
(brace
id|reselected
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ms-&gt;aborting
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mesh: target %d aborted&bslash;n&quot;
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|dumplog
c_func
(paren
id|ms
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_CMDDONE
)paren
suffix:semicolon
id|ms-&gt;stat
op_assign
id|DID_ABORT
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_amp
id|ERR_PARITY
)paren
(brace
r_if
c_cond
(paren
id|ms-&gt;msgphase
op_eq
id|msg_in
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: msg parity error, target %d&bslash;n&quot;
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|ms-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|MSG_PARITY_ERROR
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_in_bad
suffix:semicolon
id|cmd_complete
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ms-&gt;stat
op_eq
id|DID_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: parity error, target %d&bslash;n&quot;
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|ms-&gt;stat
op_assign
id|DID_PARITY
suffix:semicolon
)brace
id|count
op_assign
(paren
id|mr-&gt;count_hi
op_lshift
l_int|8
)paren
op_plus
id|mr-&gt;count_lo
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|cmd_complete
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* reissue the data transfer command */
id|out_8
c_func
(paren
op_amp
id|mr-&gt;sequence
comma
id|mr-&gt;sequence
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_amp
id|ERR_SEQERR
)paren
(brace
r_if
c_cond
(paren
id|exc
op_amp
id|EXC_RESELECTED
)paren
(brace
multiline_comment|/* This can happen if we issue a command to&n;&t;&t;&t;   get the bus just after the target reselects us. */
r_static
r_int
id|mesh_resel_seqerr
suffix:semicolon
id|mesh_resel_seqerr
op_increment
suffix:semicolon
id|reselected
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|exc
op_eq
id|EXC_PHASEMM
)paren
(brace
r_static
r_int
id|mesh_phasemm_seqerr
suffix:semicolon
id|mesh_phasemm_seqerr
op_increment
suffix:semicolon
id|phase_mismatch
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: sequence error (err=%x exc=%x)&bslash;n&quot;
comma
id|err
comma
id|exc
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: unknown error %x (exc=%x)&bslash;n&quot;
comma
id|err
comma
id|exc
)paren
suffix:semicolon
)brace
id|mesh_dump_regs
c_func
(paren
id|ms
)paren
suffix:semicolon
id|dumplog
c_func
(paren
id|ms
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;phase
OG
id|selecting
op_logical_and
(paren
id|mr-&gt;bus_status1
op_amp
id|BS1_BSY
)paren
)paren
(brace
multiline_comment|/* try to do what the target wants */
id|do_abort
c_func
(paren
id|ms
)paren
suffix:semicolon
id|phase_mismatch
c_func
(paren
id|ms
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ms-&gt;stat
op_assign
id|DID_ERROR
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|handle_exception
r_static
r_void
id|handle_exception
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|exc
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
id|exc
op_assign
id|in_8
c_func
(paren
op_amp
id|mr-&gt;exception
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_EXCEPTION
op_or
id|INT_CMDDONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exc
op_amp
id|EXC_RESELECTED
)paren
(brace
r_static
r_int
id|mesh_resel_exc
suffix:semicolon
id|mesh_resel_exc
op_increment
suffix:semicolon
id|reselected
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exc
op_eq
id|EXC_ARBLOST
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: lost arbitration&bslash;n&quot;
)paren
suffix:semicolon
id|ms-&gt;stat
op_assign
id|DID_BUS_BUSY
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exc
op_eq
id|EXC_SELTO
)paren
(brace
multiline_comment|/* selection timed out */
id|ms-&gt;stat
op_assign
id|DID_BAD_TARGET
suffix:semicolon
id|mesh_done
c_func
(paren
id|ms
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exc
op_eq
id|EXC_PHASEMM
)paren
(brace
multiline_comment|/* target wants to do something different:&n;&t;&t;   find out what it wants and do it. */
id|phase_mismatch
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: can&squot;t cope with exception %x&bslash;n&quot;
comma
id|exc
)paren
suffix:semicolon
id|mesh_dump_regs
c_func
(paren
id|ms
)paren
suffix:semicolon
id|dumplog
c_func
(paren
id|ms
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|do_abort
c_func
(paren
id|ms
)paren
suffix:semicolon
id|phase_mismatch
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|mesh_interrupt
id|mesh_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|mesh_state
op_star
id|ms
op_assign
(paren
r_struct
id|mesh_state
op_star
)paren
id|dev_id
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
r_int
id|intr
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ALLOW_DEBUG
c_func
(paren
id|ms-&gt;conn_tgt
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh_intr, bs0=%x int=%x exc=%x err=%x &quot;
l_string|&quot;phase=%d msgphase=%d&bslash;n&quot;
comma
id|mr-&gt;bus_status0
comma
id|mr-&gt;interrupt
comma
id|mr-&gt;exception
comma
id|mr-&gt;error
comma
id|ms-&gt;phase
comma
id|ms-&gt;msgphase
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|intr
op_assign
id|in_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;interrupt intr/err/exc/seq=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|intr
comma
id|mr-&gt;error
comma
id|mr-&gt;exception
comma
id|mr-&gt;sequence
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|INT_ERROR
)paren
(brace
id|handle_error
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|intr
op_amp
id|INT_EXCEPTION
)paren
(brace
id|handle_exception
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|intr
op_amp
id|INT_CMDDONE
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|mr-&gt;interrupt
comma
id|INT_CMDDONE
)paren
suffix:semicolon
id|cmd_complete
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|handle_msgin
id|handle_msgin
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_int
id|i
comma
id|code
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|ms-&gt;current_req
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_msgin
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|code
op_assign
id|ms-&gt;msgin
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ALLOW_DEBUG
c_func
(paren
id|ms-&gt;conn_tgt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;got %d message bytes:&quot;
comma
id|ms-&gt;n_msgin
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ms-&gt;n_msgin
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|ms-&gt;msgin
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;msgin msg=%.8x&quot;
comma
id|MKWORD
c_func
(paren
id|ms-&gt;n_msgin
comma
id|code
comma
id|ms-&gt;msgin
(braket
l_int|1
)braket
comma
id|ms-&gt;msgin
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|ms-&gt;expect_reply
op_assign
l_int|0
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_msgin
OL
id|msgin_length
c_func
(paren
id|ms
)paren
)paren
r_goto
id|reject
suffix:semicolon
r_if
c_cond
(paren
id|cmd
)paren
id|cmd-&gt;SCp.Message
op_assign
id|code
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|COMMAND_COMPLETE
suffix:colon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_switch
c_cond
(paren
id|ms-&gt;msgin
(braket
l_int|2
)braket
)paren
(brace
r_case
id|EXTENDED_MODIFY_DATA_POINTER
suffix:colon
id|ms-&gt;data_ptr
op_add_assign
(paren
id|ms-&gt;msgin
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_plus
id|ms-&gt;msgin
(braket
l_int|6
)braket
op_plus
(paren
id|ms-&gt;msgin
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|ms-&gt;msgin
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_SDTR
suffix:colon
r_if
c_cond
(paren
id|tp-&gt;sdtr_state
op_ne
id|sdtr_sent
)paren
(brace
multiline_comment|/* reply with an SDTR */
id|add_sdtr_msg
c_func
(paren
id|ms
)paren
suffix:semicolon
multiline_comment|/* limit period to at least his value,&n;&t;&t;&t;&t;   offset to no more than his */
r_if
c_cond
(paren
id|ms-&gt;msgout
(braket
l_int|3
)braket
OL
id|ms-&gt;msgin
(braket
l_int|3
)braket
)paren
id|ms-&gt;msgout
(braket
l_int|3
)braket
op_assign
id|ms-&gt;msgin
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;msgout
(braket
l_int|4
)braket
OG
id|ms-&gt;msgin
(braket
l_int|4
)braket
)paren
id|ms-&gt;msgout
(braket
l_int|4
)braket
op_assign
id|ms-&gt;msgin
(braket
l_int|4
)braket
suffix:semicolon
id|set_sdtr
c_func
(paren
id|ms
comma
id|ms-&gt;msgout
(braket
l_int|3
)braket
comma
id|ms-&gt;msgout
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_out
suffix:semicolon
)brace
r_else
(brace
id|set_sdtr
c_func
(paren
id|ms
comma
id|ms-&gt;msgin
(braket
l_int|3
)braket
comma
id|ms-&gt;msgin
(braket
l_int|4
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|reject
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
id|tp-&gt;saved_ptr
op_assign
id|ms-&gt;data_ptr
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESTORE_POINTERS
suffix:colon
id|ms-&gt;data_ptr
op_assign
id|tp-&gt;saved_ptr
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISCONNECT
suffix:colon
id|ms-&gt;phase
op_assign
id|disconnecting
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ABORT
suffix:colon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
r_if
c_cond
(paren
id|tp-&gt;sdtr_state
op_eq
id|sdtr_sent
)paren
id|set_sdtr
c_func
(paren
id|ms
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NOP
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|IDENTIFY_BASE
op_le
id|code
op_logical_and
id|code
op_le
id|IDENTIFY_BASE
op_plus
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|do_abort
c_func
(paren
id|ms
)paren
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_ne
id|cmd-&gt;lun
op_plus
id|IDENTIFY_BASE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mesh: lun mismatch &quot;
l_string|&quot;(%d != %d) on reselection from &quot;
l_string|&quot;target %d&bslash;n&quot;
comma
id|i
comma
id|cmd-&gt;lun
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_goto
id|reject
suffix:semicolon
)brace
r_return
suffix:semicolon
id|reject
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mesh: rejecting message from target %d:&quot;
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ms-&gt;n_msgin
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|ms-&gt;msgin
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ms-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|MESSAGE_REJECT
suffix:semicolon
id|ms-&gt;n_msgout
op_assign
l_int|1
suffix:semicolon
id|ms-&gt;msgphase
op_assign
id|msg_out
suffix:semicolon
)brace
r_static
r_void
DECL|function|mesh_done
id|mesh_done
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_int
id|start_next
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
suffix:semicolon
id|cmd
op_assign
id|ms-&gt;current_req
suffix:semicolon
id|ms-&gt;current_req
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;current_req
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
id|ms-&gt;stat
op_lshift
l_int|16
)paren
op_plus
id|cmd-&gt;SCp.Status
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;stat
op_eq
id|DID_OK
)paren
id|cmd-&gt;result
op_add_assign
(paren
id|cmd-&gt;SCp.Message
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DEBUG_TARGET
c_func
(paren
id|cmd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh_done: result = %x, data_ptr=%d, buflen=%d&bslash;n&quot;
comma
id|cmd-&gt;result
comma
id|ms-&gt;data_ptr
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_or
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|0x12
op_logical_or
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|3
)paren
op_logical_and
id|cmd-&gt;request_buffer
op_ne
l_int|0
)paren
(brace
r_int
r_char
op_star
id|b
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;buffer = %x %x %x %x %x %x %x %x&bslash;n&quot;
comma
id|b
(braket
l_int|0
)braket
comma
id|b
(braket
l_int|1
)braket
comma
id|b
(braket
l_int|2
)braket
comma
id|b
(braket
l_int|3
)braket
comma
id|b
(braket
l_int|4
)braket
comma
id|b
(braket
l_int|5
)braket
comma
id|b
(braket
l_int|6
)braket
comma
id|b
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
)brace
id|cmd-&gt;SCp.this_residual
op_sub_assign
id|ms-&gt;data_ptr
suffix:semicolon
id|mesh_completed
c_func
(paren
id|ms
comma
id|cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start_next
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|ms-&gt;mesh-&gt;sequence
comma
id|SEQ_ENBRESEL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ms-&gt;phase
op_assign
id|idle
suffix:semicolon
id|mesh_start
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|mesh_completed
id|mesh_completed
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
macro_line|#ifdef MESH_NEW_STYLE_EH
(paren
op_star
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|ms-&gt;completed_q
op_eq
l_int|NULL
)paren
id|ms-&gt;completed_q
op_assign
id|cmd
suffix:semicolon
r_else
id|ms-&gt;completed_qtail-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|cmd
suffix:semicolon
id|ms-&gt;completed_qtail
op_assign
id|cmd
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|ms-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
macro_line|#endif /* MESH_NEW_STYLE_EH */
)brace
multiline_comment|/*&n; * Set up DMA commands for transferring data.&n; */
r_static
r_void
DECL|function|set_dma_cmds
id|set_dma_cmds
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_int
id|i
comma
id|dma_cmd
comma
id|total
comma
id|off
comma
id|dtot
suffix:semicolon
r_struct
id|scatterlist
op_star
id|scl
suffix:semicolon
r_struct
id|dbdma_cmd
op_star
id|dcmds
suffix:semicolon
id|dma_cmd
op_assign
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
dot
id|data_goes_out
ques
c_cond
id|OUTPUT_MORE
suffix:colon
id|INPUT_MORE
suffix:semicolon
id|dcmds
op_assign
id|ms-&gt;dma_cmds
suffix:semicolon
id|dtot
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
)paren
(brace
id|cmd-&gt;SCp.this_residual
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
OG
l_int|0
)paren
(brace
id|total
op_assign
l_int|0
suffix:semicolon
id|scl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;buffer
suffix:semicolon
id|off
op_assign
id|ms-&gt;data_ptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;use_sg
suffix:semicolon
op_increment
id|i
comma
op_increment
id|scl
)paren
(brace
id|total
op_add_assign
id|scl-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|scl-&gt;length
)paren
(brace
id|off
op_sub_assign
id|scl-&gt;length
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scl-&gt;length
OG
l_int|0xffff
)paren
id|panic
c_func
(paren
l_string|&quot;mesh: scatterlist element &gt;= 64k&quot;
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|dcmds-&gt;req_count
comma
id|scl-&gt;length
op_minus
id|off
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|dcmds-&gt;command
comma
id|dma_cmd
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dcmds-&gt;phy_addr
comma
id|virt_to_phys
c_func
(paren
id|scl-&gt;address
)paren
op_plus
id|off
)paren
suffix:semicolon
id|dcmds-&gt;xfer_status
op_assign
l_int|0
suffix:semicolon
op_increment
id|dcmds
suffix:semicolon
id|dtot
op_add_assign
id|scl-&gt;length
op_minus
id|off
suffix:semicolon
id|off
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ms-&gt;data_ptr
OL
id|cmd-&gt;request_bufflen
)paren
(brace
id|dtot
op_assign
id|cmd-&gt;request_bufflen
op_minus
id|ms-&gt;data_ptr
suffix:semicolon
r_if
c_cond
(paren
id|dtot
OG
l_int|0xffff
)paren
id|panic
c_func
(paren
l_string|&quot;mesh: transfer size &gt;= 64k&quot;
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|dcmds-&gt;req_count
comma
id|dtot
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dcmds-&gt;phy_addr
comma
id|virt_to_phys
c_func
(paren
id|cmd-&gt;request_buffer
)paren
op_plus
id|ms-&gt;data_ptr
)paren
suffix:semicolon
id|dcmds-&gt;xfer_status
op_assign
l_int|0
suffix:semicolon
op_increment
id|dcmds
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dtot
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Either the target has overrun our buffer,&n;&t;&t;   or the caller didn&squot;t provide a buffer. */
r_static
r_char
id|mesh_extra_buf
(braket
l_int|64
)braket
suffix:semicolon
id|dtot
op_assign
r_sizeof
(paren
id|mesh_extra_buf
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|dcmds-&gt;req_count
comma
id|dtot
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dcmds-&gt;phy_addr
comma
id|virt_to_phys
c_func
(paren
id|mesh_extra_buf
)paren
)paren
suffix:semicolon
id|dcmds-&gt;xfer_status
op_assign
l_int|0
suffix:semicolon
op_increment
id|dcmds
suffix:semicolon
)brace
id|dma_cmd
op_add_assign
id|OUTPUT_LAST
op_minus
id|OUTPUT_MORE
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|dcmds
(braket
op_minus
l_int|1
)braket
dot
id|command
comma
id|dma_cmd
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dcmds
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dcmds
)paren
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|dcmds-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
id|ms-&gt;dma_count
op_assign
id|dtot
suffix:semicolon
)brace
r_static
r_void
DECL|function|halt_dma
id|halt_dma
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|md
op_assign
id|ms-&gt;dma
suffix:semicolon
r_volatile
r_struct
id|mesh_regs
op_star
id|mr
op_assign
id|ms-&gt;mesh
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|ms-&gt;current_req
suffix:semicolon
r_int
id|t
comma
id|nb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
dot
id|data_goes_out
)paren
(brace
multiline_comment|/* wait a little while until the fifo drains */
id|t
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
id|t
OG
l_int|0
op_logical_and
id|mr-&gt;fifo_count
op_ne
l_int|0
op_logical_and
(paren
id|in_le32
c_func
(paren
op_amp
id|md-&gt;status
)paren
op_amp
id|ACTIVE
)paren
op_ne
l_int|0
)paren
(brace
op_decrement
id|t
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|out_le32
c_func
(paren
op_amp
id|md-&gt;control
comma
id|RUN
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* turn off RUN bit */
id|nb
op_assign
(paren
id|mr-&gt;count_hi
op_lshift
l_int|8
)paren
op_plus
id|mr-&gt;count_lo
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;halt_dma fc/count=%.6x&quot;
comma
id|MKWORD
c_func
(paren
l_int|0
comma
id|mr-&gt;fifo_count
comma
l_int|0
comma
id|nb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
dot
id|data_goes_out
)paren
id|nb
op_add_assign
id|mr-&gt;fifo_count
suffix:semicolon
multiline_comment|/* nb is the number of bytes not yet transferred&n;&t;   to/from the target. */
id|ms-&gt;data_ptr
op_sub_assign
id|nb
suffix:semicolon
id|dlog
c_func
(paren
id|ms
comma
l_string|&quot;data_ptr %x&quot;
comma
id|ms-&gt;data_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;data_ptr
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mesh: halt_dma: data_ptr=%d (nb=%d, ms=%p)&bslash;n&quot;
comma
id|ms-&gt;data_ptr
comma
id|nb
comma
id|ms
)paren
suffix:semicolon
id|ms-&gt;data_ptr
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MESH_DBG
id|dumplog
c_func
(paren
id|ms
comma
id|ms-&gt;conn_tgt
)paren
suffix:semicolon
id|dumpslog
c_func
(paren
id|ms
)paren
suffix:semicolon
macro_line|#endif /* MESH_DBG */
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_logical_and
id|cmd-&gt;request_bufflen
op_ne
l_int|0
op_logical_and
id|ms-&gt;data_ptr
OG
id|cmd-&gt;request_bufflen
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh: target %d overrun, &quot;
l_string|&quot;data_ptr=%x total=%x goes_out=%d&bslash;n&quot;
comma
id|ms-&gt;conn_tgt
comma
id|ms-&gt;data_ptr
comma
id|cmd-&gt;request_bufflen
comma
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
dot
id|data_goes_out
)paren
suffix:semicolon
)brace
id|ms-&gt;dma_started
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Work out whether we expect data to go out from the host adaptor or into it.&n; * (If this information is available from somewhere else in the scsi&n; * code, somebody please let me know :-)&n; */
r_static
r_int
DECL|function|data_goes_out
id|data_goes_out
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|CHANGE_DEFINITION
suffix:colon
r_case
id|COMPARE
suffix:colon
r_case
id|COPY
suffix:colon
r_case
id|COPY_VERIFY
suffix:colon
r_case
id|FORMAT_UNIT
suffix:colon
r_case
id|LOG_SELECT
suffix:colon
r_case
id|MEDIUM_SCAN
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SELECT_10
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|SEARCH_EQUAL
suffix:colon
r_case
id|SEARCH_EQUAL_12
suffix:colon
r_case
id|SEARCH_HIGH
suffix:colon
r_case
id|SEARCH_HIGH_12
suffix:colon
r_case
id|SEARCH_LOW
suffix:colon
r_case
id|SEARCH_LOW_12
suffix:colon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|SEND_VOLUME_TAG
suffix:colon
r_case
id|SET_WINDOW
suffix:colon
r_case
id|UPDATE_BLOCK
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
r_case
id|WRITE_LONG
suffix:colon
r_case
id|WRITE_LONG_2
suffix:colon
multiline_comment|/* alternate code for WRITE_LONG */
r_case
id|WRITE_SAME
suffix:colon
r_case
id|WRITE_VERIFY
suffix:colon
r_case
id|WRITE_VERIFY_12
suffix:colon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#ifdef MESH_DBG
DECL|function|readtb
r_static
r_inline
id|u32
id|readtb
c_func
(paren
r_void
)paren
(brace
id|u32
id|tb
suffix:semicolon
macro_line|#ifdef DBG_USE_TB
multiline_comment|/* Beware: if you enable this, it will crash on 601s. */
id|asm
(paren
l_string|&quot;mftb %0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tb
)paren
suffix:colon
)paren
suffix:semicolon
macro_line|#else
id|tb
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
id|tb
suffix:semicolon
)brace
DECL|function|dlog
r_static
r_void
id|dlog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_char
op_star
id|fmt
comma
r_int
id|a
)paren
(brace
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|ms-&gt;conn_tgt
)braket
suffix:semicolon
r_struct
id|dbglog
op_star
id|tlp
comma
op_star
id|slp
suffix:semicolon
id|tlp
op_assign
op_amp
id|tp-&gt;log
(braket
id|tp-&gt;log_ix
)braket
suffix:semicolon
id|slp
op_assign
op_amp
id|ms-&gt;log
(braket
id|ms-&gt;log_ix
)braket
suffix:semicolon
id|tlp-&gt;fmt
op_assign
id|fmt
suffix:semicolon
id|tlp-&gt;tb
op_assign
id|readtb
c_func
(paren
)paren
suffix:semicolon
id|tlp-&gt;phase
op_assign
(paren
id|ms-&gt;msgphase
op_lshift
l_int|4
)paren
op_plus
id|ms-&gt;phase
suffix:semicolon
id|tlp-&gt;bs0
op_assign
id|ms-&gt;mesh-&gt;bus_status0
suffix:semicolon
id|tlp-&gt;bs1
op_assign
id|ms-&gt;mesh-&gt;bus_status1
suffix:semicolon
id|tlp-&gt;tgt
op_assign
id|ms-&gt;conn_tgt
suffix:semicolon
id|tlp-&gt;d
op_assign
id|a
suffix:semicolon
op_star
id|slp
op_assign
op_star
id|tlp
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|tp-&gt;log_ix
op_ge
id|N_DBG_LOG
)paren
id|tp-&gt;log_ix
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;n_log
OL
id|N_DBG_LOG
)paren
op_increment
id|tp-&gt;n_log
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|ms-&gt;log_ix
op_ge
id|N_DBG_SLOG
)paren
id|ms-&gt;log_ix
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_log
OL
id|N_DBG_SLOG
)paren
op_increment
id|ms-&gt;n_log
suffix:semicolon
)brace
DECL|function|dumplog
r_static
r_void
id|dumplog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
comma
r_int
id|t
)paren
(brace
r_struct
id|mesh_target
op_star
id|tp
op_assign
op_amp
id|ms-&gt;tgts
(braket
id|t
)braket
suffix:semicolon
r_struct
id|dbglog
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;n_log
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|i
op_assign
id|tp-&gt;log_ix
op_minus
id|tp-&gt;n_log
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|i
op_add_assign
id|N_DBG_LOG
suffix:semicolon
id|tp-&gt;n_log
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|lp
op_assign
op_amp
id|tp-&gt;log
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh log %d: bs=%.2x%.2x ph=%.2x &quot;
comma
id|t
comma
id|lp-&gt;bs1
comma
id|lp-&gt;bs0
comma
id|lp-&gt;phase
)paren
suffix:semicolon
macro_line|#ifdef DBG_USE_TB
id|printk
c_func
(paren
l_string|&quot;tb=%10u &quot;
comma
id|lp-&gt;tb
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|lp-&gt;fmt
comma
id|lp-&gt;d
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_DBG_LOG
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ne
id|tp-&gt;log_ix
)paren
suffix:semicolon
)brace
DECL|function|dumpslog
r_static
r_void
id|dumpslog
c_func
(paren
r_struct
id|mesh_state
op_star
id|ms
)paren
(brace
r_struct
id|dbglog
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ms-&gt;n_log
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|i
op_assign
id|ms-&gt;log_ix
op_minus
id|ms-&gt;n_log
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|i
op_add_assign
id|N_DBG_SLOG
suffix:semicolon
id|ms-&gt;n_log
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|lp
op_assign
op_amp
id|ms-&gt;log
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mesh log: bs=%.2x%.2x ph=%.2x t%d &quot;
comma
id|lp-&gt;bs1
comma
id|lp-&gt;bs0
comma
id|lp-&gt;phase
comma
id|lp-&gt;tgt
)paren
suffix:semicolon
macro_line|#ifdef DBG_USE_TB
id|printk
c_func
(paren
l_string|&quot;tb=%10u &quot;
comma
id|lp-&gt;tb
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|lp-&gt;fmt
comma
id|lp-&gt;d
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|N_DBG_SLOG
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ne
id|ms-&gt;log_ix
)paren
suffix:semicolon
)brace
macro_line|#endif /* MESH_DBG */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|SCSI_MESH
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
