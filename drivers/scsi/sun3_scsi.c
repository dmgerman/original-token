multiline_comment|/*&n; * Sun3 SCSI stuff by Erik Verbruggen (erik@bigmama.xtdnet.nl)&n; *&n; * Adapted from mac_scsinew.c:&n; */
multiline_comment|/*&n; * Generic Macintosh NCR5380 driver&n; *&n; * Copyright 1998, Michael Schmitz &lt;mschmitz@lbl.gov&gt;&n; *&n; * derived in part from:&n; */
multiline_comment|/*&n; * Generic Generic NCR5380 driver&n; *&n; * Copyright 1995, Russell King&n; *&n; * ALPHA RELEASE 1.&n; *&n; * For more information, please consult&n; *&n; * NCR 5380 Family&n; * SCSI Protocol Controller&n; * Databook&n; *&n; * NCR Microelectronics&n; * 1635 Aeroplaza Drive&n; * Colorado Springs, CO 80916&n; * 1+ (719) 578-3400&n; * 1+ (800) 334-5454&n; */
multiline_comment|/*&n; * This is from mac_scsi.h, but hey, maybe this is usefull for Sun3 too! :)&n; *&n; * Options :&n; *&n; * PARITY - enable parity checking.  Not supported.&n; *&n; * SCSI2 - enable support for SCSI-II tagged queueing.  Untested.&n; *&n; * USLEEP - enable support for devices that don&squot;t disconnect.  Untested.&n; */
multiline_comment|/*&n; * $Log: mac_NCR5380.c,v $&n; */
DECL|macro|AUTOSENSE
mdefine_line|#define AUTOSENSE
macro_line|#if 0
mdefine_line|#define PSEUDO_DMA
macro_line|#endif
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sun3ints.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;sun3_scsi.h&quot;
macro_line|#include &quot;NCR5380.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#if 0
mdefine_line|#define NDEBUG (NDEBUG_INTR | NDEBUG_PSEUDO_DMA | NDEBUG_ARBITRATION | NDEBUG_SELECTION | NDEBUG_RESELECTION)
mdefine_line|#define NCR_TIMEOUT 100
macro_line|#else
DECL|macro|NDEBUG
mdefine_line|#define NDEBUG (NDEBUG_ABORT)
macro_line|#endif
DECL|macro|USE_WRAPPER
mdefine_line|#define USE_WRAPPER
DECL|macro|RESET_BOOT
mdefine_line|#define RESET_BOOT
DECL|macro|DRIVER_SETUP
mdefine_line|#define DRIVER_SETUP
multiline_comment|/*&n; * BUG can be used to trigger a strange code-size related hang on 2.1 kernels&n; */
macro_line|#ifdef BUG
DECL|macro|RESET_BOOT
macro_line|#undef RESET_BOOT
DECL|macro|DRIVER_SETUP
macro_line|#undef DRIVER_SETUP
macro_line|#endif
DECL|macro|ENABLE_IRQ
mdefine_line|#define&t;ENABLE_IRQ()&t;sun3_enable_irq( IRQ_SUN3_SCSI ); 
DECL|macro|DISABLE_IRQ
mdefine_line|#define&t;DISABLE_IRQ()&t;sun3_enable_irq( IRQ_SUN3_SCSI );
multiline_comment|/* extern void via_scsi_clear(void); */
r_static
r_void
id|scsi_sun3_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dummy
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_char
id|sun3scsi_read
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|reg
)paren
suffix:semicolon
r_static
r_void
id|sun3scsi_write
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|reg
comma
r_int
id|value
)paren
suffix:semicolon
DECL|variable|setup_can_queue
r_static
r_int
id|setup_can_queue
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|setup_cmd_per_lun
r_static
r_int
id|setup_cmd_per_lun
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|setup_sg_tablesize
r_static
r_int
id|setup_sg_tablesize
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef SUPPORT_TAGS
DECL|variable|setup_use_tagged_queuing
r_static
r_int
id|setup_use_tagged_queuing
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|setup_hostid
r_static
r_int
id|setup_hostid
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|polled_scsi_on
r_static
r_int
id|polled_scsi_on
op_assign
l_int|0
suffix:semicolon
DECL|macro|AFTER_RESET_DELAY
mdefine_line|#define&t;AFTER_RESET_DELAY&t;(HZ/2)
DECL|variable|sun3_scsi_regp
r_static
r_volatile
r_int
r_char
op_star
id|sun3_scsi_regp
op_assign
id|IOBASE_SUN3_SCSI
suffix:semicolon
multiline_comment|/*&n;static volatile unsigned char *sun3_scsi_drq  = NULL;&n;static volatile unsigned char *sun3_scsi_nodrq = NULL;&n;*/
multiline_comment|/*&n; * Function : sun3_scsi_setup(char *str, int *ints)&n; *&n; * Purpose : booter command line initialization of the overrides array,&n; *&n; * Inputs : str - unused, ints - array of integer parameters with ints[0]&n; *&t;equal to the number of ints.&n; *&n; * TODO: make it actually work!&n; *&n; */
DECL|function|sun3_scsi_setup
r_void
id|sun3_scsi_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sun3_scsi_setup() called&bslash;n&quot;
)paren
suffix:semicolon
id|setup_can_queue
op_assign
op_minus
l_int|1
suffix:semicolon
id|setup_cmd_per_lun
op_assign
op_minus
l_int|1
suffix:semicolon
id|setup_sg_tablesize
op_assign
op_minus
l_int|1
suffix:semicolon
id|setup_hostid
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef SUPPORT_TAGS
id|setup_use_tagged_queuing
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;sun3_scsi_setup() done&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * XXX: status debug&n; */
DECL|variable|default_instance
r_static
r_struct
id|Scsi_Host
op_star
id|default_instance
suffix:semicolon
multiline_comment|/*&n; * Function : int sun3scsi_detect(Scsi_Host_Template * tpnt)&n; *&n; * Purpose : initializes mac NCR5380 driver based on the&n; *&t;command line / compile time port and irq definitions.&n; *&n; * Inputs : tpnt - template for this SCSI adapter.&n; *&n; * Returns : 1 if a host adapter was found, 0 if not.&n; *&n; */
DECL|function|sun3scsi_detect
r_int
id|sun3scsi_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_int
id|ioaddr
comma
id|iopte
suffix:semicolon
r_int
r_int
op_star
id|ioptr
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;sun3scsi_detect(0x%p)&bslash;n&quot;
comma
id|tpnt
)paren
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;Sun3 5380 SCSI&quot;
suffix:semicolon
multiline_comment|/* Could you spell &quot;ewww...&quot;? */
multiline_comment|/* setup variables */
id|tpnt-&gt;can_queue
op_assign
(paren
id|setup_can_queue
OG
l_int|0
)paren
ques
c_cond
id|setup_can_queue
suffix:colon
id|CAN_QUEUE
suffix:semicolon
id|tpnt-&gt;cmd_per_lun
op_assign
(paren
id|setup_cmd_per_lun
OG
l_int|0
)paren
ques
c_cond
id|setup_cmd_per_lun
suffix:colon
id|CMD_PER_LUN
suffix:semicolon
id|tpnt-&gt;sg_tablesize
op_assign
(paren
id|setup_sg_tablesize
op_ge
l_int|0
)paren
ques
c_cond
id|setup_sg_tablesize
suffix:colon
id|SG_TABLESIZE
suffix:semicolon
r_if
c_cond
(paren
id|setup_hostid
op_ge
l_int|0
)paren
id|tpnt-&gt;this_id
op_assign
id|setup_hostid
suffix:semicolon
r_else
(brace
multiline_comment|/* use 7 as default */
id|tpnt-&gt;this_id
op_assign
l_int|7
suffix:semicolon
)brace
multiline_comment|/* Taken from Sammy&squot;s lance driver: */
multiline_comment|/* IOBASE_SUN3_SCSI can be found within the IO pmeg with some effort */
r_for
c_loop
(paren
id|ioaddr
op_assign
l_int|0xfe00000
suffix:semicolon
id|ioaddr
OL
(paren
l_int|0xfe00000
op_plus
id|SUN3_PMEG_SIZE
)paren
suffix:semicolon
id|ioaddr
op_add_assign
id|SUN3_PTE_SIZE
)paren
(brace
id|iopte
op_assign
id|sun3_get_pte
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iopte
op_amp
id|SUN3_PAGE_TYPE_IO
)paren
)paren
(brace
multiline_comment|/* this an io page? */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iopte
op_amp
id|SUN3_PAGE_PGNUM_MASK
)paren
op_lshift
id|PAGE_SHIFT
)paren
op_eq
id|IOBASE_SUN3_SCSI
)paren
(brace
id|count
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found ioaddr in pmeg&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No Sun3 NCR5380 found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sun3_scsi_regp
op_assign
id|ioaddr
suffix:semicolon
multiline_comment|/* doing some stuff like resetting DVMA: */
id|ioptr
op_assign
id|ioaddr
suffix:semicolon
op_star
(paren
id|ioptr
op_plus
l_int|8
)paren
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
op_star
(paren
id|ioptr
op_plus
l_int|9
)paren
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
op_star
(paren
id|ioptr
op_plus
l_int|12
)paren
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
op_star
(paren
id|ioptr
op_plus
l_int|12
)paren
op_assign
l_int|0x7
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSI status reg = %x&bslash;n&quot;
comma
op_star
(paren
id|ioptr
op_plus
l_int|12
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
op_star
(paren
id|ioptr
op_plus
l_int|13
)paren
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
macro_line|#ifdef SUPPORT_TAGS
r_if
c_cond
(paren
id|setup_use_tagged_queuing
OL
l_int|0
)paren
id|setup_use_tagged_queuing
op_assign
id|DEFAULT_USE_TAGGED_QUEUING
suffix:semicolon
macro_line|#endif
id|instance
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|NCR5380_hostdata
)paren
)paren
suffix:semicolon
id|default_instance
op_assign
id|instance
suffix:semicolon
multiline_comment|/*&n;&t;if (macintosh_config-&gt;ident == MAC_MODEL_IIFX) {&n;&t;&t;mac_scsi_regp  = via1_regp+0x8000;&n;&t;&t;mac_scsi_drq   = via1_regp+0x6000;&n;&t;&t;mac_scsi_nodrq = via1_regp+0x12000;&n;&t;} else {&n;&t;&t;mac_scsi_regp  = via1_regp+0x10000;&n;&t;&t;mac_scsi_drq   = via1_regp+0x6000;&n;&t;&t;mac_scsi_nodrq = via1_regp+0x12000;&n;&t;}&n;*/
id|instance-&gt;io_port
op_assign
(paren
r_int
r_int
)paren
id|ioaddr
suffix:semicolon
id|instance-&gt;irq
op_assign
id|IRQ_SUN3_SCSI
suffix:semicolon
id|NCR5380_init
c_func
(paren
id|instance
comma
l_int|0
)paren
suffix:semicolon
id|instance-&gt;n_io_port
op_assign
l_int|32
suffix:semicolon
(paren
(paren
r_struct
id|NCR5380_hostdata
op_star
)paren
id|instance-&gt;hostdata
)paren
op_member_access_from_pointer
id|ctrl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;irq
op_ne
id|IRQ_NONE
)paren
r_if
c_cond
(paren
id|sun3_request_irq
c_func
(paren
id|instance-&gt;irq
comma
id|sun3scsi_intr
comma
l_int|0
comma
l_string|&quot;Sun3SCSI-5380&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: IRQ%d not free, interrupts disabled&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|instance-&gt;irq
)paren
suffix:semicolon
id|instance-&gt;irq
op_assign
id|IRQ_NONE
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: generic 5380 at port %lX irq&quot;
comma
id|instance-&gt;host_no
comma
id|instance-&gt;io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;irq
op_eq
id|IRQ_NONE
)paren
id|printk
(paren
l_string|&quot;s disabled&quot;
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot; %d&quot;
comma
id|instance-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; options CAN_QUEUE=%d CMD_PER_LUN=%d release=%d&quot;
comma
id|instance-&gt;can_queue
comma
id|instance-&gt;cmd_per_lun
comma
id|SUN3SCSI_PUBLIC_RELEASE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nscsi%d:&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|NCR5380_print_options
c_func
(paren
id|instance
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|called
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sun3scsi_release
r_int
id|sun3scsi_release
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_if
c_cond
(paren
id|shpnt-&gt;irq
op_ne
id|IRQ_NONE
)paren
id|free_irq
(paren
id|shpnt-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef RESET_BOOT
multiline_comment|/*&n; * Our &squot;bus reset on boot&squot; function&n; */
DECL|function|sun3_scsi_reset_boot
r_static
r_void
id|sun3_scsi_reset_boot
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|NCR5380_local_declare
c_func
(paren
)paren
suffix:semicolon
id|NCR5380_setup
c_func
(paren
id|instance
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Do a SCSI reset to clean up the bus during initialization. No&n;&t; * messing with the queues, interrupts, or locks necessary here.&n;&t; */
id|printk
c_func
(paren
l_string|&quot;Sun3 SCSI: resetting the SCSI bus...&quot;
)paren
suffix:semicolon
multiline_comment|/* switch off SCSI IRQ - catch an interrupt without IRQ bit set else */
id|sun3_disable_irq
c_func
(paren
id|IRQ_SUN3_SCSI
)paren
suffix:semicolon
multiline_comment|/* get in phase */
id|NCR5380_write
c_func
(paren
id|TARGET_COMMAND_REG
comma
id|PHASE_SR_TO_TCR
c_func
(paren
id|NCR5380_read
c_func
(paren
id|STATUS_REG
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* assert RST */
id|NCR5380_write
c_func
(paren
id|INITIATOR_COMMAND_REG
comma
id|ICR_BASE
op_or
id|ICR_ASSERT_RST
)paren
suffix:semicolon
multiline_comment|/* The min. reset hold time is 25us, so 40us should be enough */
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* reset RST and interrupt */
id|NCR5380_write
c_func
(paren
id|INITIATOR_COMMAND_REG
comma
id|ICR_BASE
)paren
suffix:semicolon
id|NCR5380_read
c_func
(paren
id|RESET_PARITY_INTERRUPT_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|end
op_assign
id|jiffies
op_plus
id|AFTER_RESET_DELAY
suffix:semicolon
id|jiffies
OL
id|end
suffix:semicolon
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* switch on SCSI IRQ again */
id|sun3_enable_irq
c_func
(paren
id|IRQ_SUN3_SCSI
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; done&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|sun3scsi_info
r_const
r_char
op_star
id|sun3scsi_info
(paren
r_struct
id|Scsi_Host
op_star
id|spnt
)paren
(brace
r_return
l_string|&quot;&quot;
suffix:semicolon
)brace
multiline_comment|/*&n; * NCR 5380 register access functions&n; */
DECL|function|sun3scsi_read
r_static
r_char
id|sun3scsi_read
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|reg
)paren
(brace
multiline_comment|/*&n;printk(&quot;sun3scsi_read(instance=0x%p, reg=0x%x): @0x%p= %d&bslash;n&quot;,instance,reg,sun3_scsi_regp,sun3_scsi_regp[reg]);&n;*/
r_return
id|sun3_scsi_regp
(braket
id|reg
)braket
suffix:semicolon
)brace
DECL|function|sun3scsi_write
r_static
r_void
id|sun3scsi_write
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|reg
comma
r_int
id|value
)paren
(brace
multiline_comment|/*&n;&t;printk(&quot;sun3scsi_write(instance=0x%p, reg=0x%x, value=0x%x)&bslash;n&quot;, instance, reg, value);&n;*/
id|sun3_scsi_regp
(braket
id|reg
)braket
op_assign
id|value
suffix:semicolon
)brace
macro_line|#include &quot;NCR5380.c&quot;
multiline_comment|/*&n; * Debug stuff - to be called on NMI, or sysrq key. Use at your own risk; &n; * reentering NCR5380_print_status seems to have ugly side effects&n; */
DECL|function|sun3_sun3_debug
r_void
id|sun3_sun3_debug
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|NCR5380_local_declare
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|default_instance
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|NCR5380_print_status
c_func
(paren
id|default_instance
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|polled_scsi_on
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Helper function for interrupt trouble. More ugly side effects here.&n; */
DECL|function|scsi_sun3_polled
r_void
id|scsi_sun3_polled
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|NCR5380_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
id|instance
op_assign
id|default_instance
suffix:semicolon
id|NCR5380_setup
c_func
(paren
id|instance
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NCR5380_read
c_func
(paren
id|BUS_AND_STATUS_REG
)paren
op_amp
id|BASR_IRQ
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSI poll&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sun3scsi_intr
c_func
(paren
id|IRQ_SUN3_SCSI
comma
id|instance
comma
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|SUN3_NCR5380
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
