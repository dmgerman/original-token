multiline_comment|/* esp.c:  EnhancedScsiProcessor Sun SCSI driver code.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;esp.h&quot;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/machines.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|DEBUG_ESP
mdefine_line|#define DEBUG_ESP
multiline_comment|/* #define DEBUG_ESP_SG */
macro_line|#if defined(DEBUG_ESP)
DECL|macro|ESPLOG
mdefine_line|#define ESPLOG(foo)  printk foo
macro_line|#else
DECL|macro|ESPLOG
mdefine_line|#define ESPLOG(foo)
macro_line|#endif /* (DEBUG_ESP) */
DECL|macro|INTERNAL_ESP_ERROR
mdefine_line|#define INTERNAL_ESP_ERROR &bslash;&n;        (panic (&quot;Internal ESP driver error in file %s, line %d&bslash;n&quot;, &bslash;&n;&t;&t;__FILE__, __LINE__))
DECL|macro|INTERNAL_ESP_ERROR_NOPANIC
mdefine_line|#define INTERNAL_ESP_ERROR_NOPANIC &bslash;&n;        (printk (&quot;Internal ESP driver error in file %s, line %d&bslash;n&quot;, &bslash;&n;&t;&t; __FILE__, __LINE__))
multiline_comment|/* This enum will be expanded when we have sync code written. */
r_enum
(brace
DECL|enumerator|not_issued
id|not_issued
op_assign
l_int|0x01
comma
multiline_comment|/* Still in the issue_SC queue.          */
DECL|enumerator|in_selection
id|in_selection
op_assign
l_int|0x02
comma
multiline_comment|/* ESP is arbitrating, awaiting IRQ      */
DECL|enumerator|in_datain
id|in_datain
op_assign
l_int|0x04
comma
multiline_comment|/* Data is transferring over the bus     */
DECL|enumerator|in_dataout
id|in_dataout
op_assign
l_int|0x08
comma
multiline_comment|/* Data is transferring over the bus     */
DECL|enumerator|in_status
id|in_status
op_assign
l_int|0x10
comma
multiline_comment|/* Awaiting status/msg bytes from target */
DECL|enumerator|in_finale
id|in_finale
op_assign
l_int|0x11
comma
multiline_comment|/* Sent Msg ack, awaiting disconnect     */
)brace
suffix:semicolon
DECL|variable|proc_scsi_esp
r_struct
id|proc_dir_entry
id|proc_scsi_esp
op_assign
(brace
id|PROC_SCSI_ESP
comma
l_int|3
comma
l_string|&quot;esp&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
DECL|variable|espchain
r_struct
id|Sparc_ESP
op_star
id|espchain
suffix:semicolon
r_static
r_void
id|esp_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|pregs
)paren
suffix:semicolon
r_static
r_void
id|esp_done
c_func
(paren
r_struct
id|Sparc_ESP
op_star
id|esp
comma
r_int
id|error
)paren
suffix:semicolon
multiline_comment|/* Debugging routines */
DECL|struct|esp_cmdstrings
r_struct
id|esp_cmdstrings
(brace
DECL|member|cmdchar
id|unchar
id|cmdchar
suffix:semicolon
DECL|member|text
r_char
op_star
id|text
suffix:semicolon
DECL|variable|esp_cmd_strings
)brace
id|esp_cmd_strings
(braket
)braket
op_assign
(brace
multiline_comment|/* Miscellaneous */
(brace
id|ESP_CMD_NULL
comma
l_string|&quot;ESP_NOP&quot;
comma
)brace
comma
(brace
id|ESP_CMD_FLUSH
comma
l_string|&quot;FIFO_FLUSH&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RC
comma
l_string|&quot;RSTESP&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RS
comma
l_string|&quot;RSTSCSI&quot;
comma
)brace
comma
multiline_comment|/* Disconnected State Group */
(brace
id|ESP_CMD_RSEL
comma
l_string|&quot;RESLCTSEQ&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SEL
comma
l_string|&quot;SLCTNATN&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SELA
comma
l_string|&quot;SLCTATN&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SELAS
comma
l_string|&quot;SLCTATNSTOP&quot;
comma
)brace
comma
(brace
id|ESP_CMD_ESEL
comma
l_string|&quot;ENSLCTRESEL&quot;
comma
)brace
comma
(brace
id|ESP_CMD_DSEL
comma
l_string|&quot;DISSELRESEL&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SA3
comma
l_string|&quot;SLCTATN3&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RSEL3
comma
l_string|&quot;RESLCTSEQ&quot;
comma
)brace
comma
multiline_comment|/* Target State Group */
(brace
id|ESP_CMD_SMSG
comma
l_string|&quot;SNDMSG&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SSTAT
comma
l_string|&quot;SNDSTATUS&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SDATA
comma
l_string|&quot;SNDDATA&quot;
comma
)brace
comma
(brace
id|ESP_CMD_DSEQ
comma
l_string|&quot;DISCSEQ&quot;
comma
)brace
comma
(brace
id|ESP_CMD_TSEQ
comma
l_string|&quot;TERMSEQ&quot;
comma
)brace
comma
(brace
id|ESP_CMD_TCCSEQ
comma
l_string|&quot;TRGTCMDCOMPSEQ&quot;
comma
)brace
comma
(brace
id|ESP_CMD_DCNCT
comma
l_string|&quot;DISC&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RMSG
comma
l_string|&quot;RCVMSG&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RCMD
comma
l_string|&quot;RCVCMD&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RDATA
comma
l_string|&quot;RCVDATA&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RCSEQ
comma
l_string|&quot;RCVCMDSEQ&quot;
comma
)brace
comma
multiline_comment|/* Initiator State Group */
(brace
id|ESP_CMD_TI
comma
l_string|&quot;TRANSINFO&quot;
comma
)brace
comma
(brace
id|ESP_CMD_ICCSEQ
comma
l_string|&quot;INICMDSEQCOMP&quot;
comma
)brace
comma
(brace
id|ESP_CMD_MOK
comma
l_string|&quot;MSGACCEPTED&quot;
comma
)brace
comma
(brace
id|ESP_CMD_TPAD
comma
l_string|&quot;TPAD&quot;
comma
)brace
comma
(brace
id|ESP_CMD_SATN
comma
l_string|&quot;SATN&quot;
comma
)brace
comma
(brace
id|ESP_CMD_RATN
comma
l_string|&quot;RATN&quot;
comma
)brace
comma
)brace
suffix:semicolon
DECL|macro|NUM_ESP_COMMANDS
mdefine_line|#define NUM_ESP_COMMANDS  ((sizeof(esp_cmd_strings)) / (sizeof(struct esp_cmdstrings)))
multiline_comment|/* Print textual representation of an ESP command */
DECL|function|esp_print_cmd
r_static
r_inline
r_void
id|esp_print_cmd
c_func
(paren
id|unchar
id|espcmd
)paren
(brace
id|unchar
id|dma_bit
op_assign
id|espcmd
op_amp
id|ESP_CMD_DMA
suffix:semicolon
r_int
id|i
suffix:semicolon
id|espcmd
op_and_assign
op_complement
id|dma_bit
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ESP_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|esp_cmd_strings
(braket
id|i
)braket
dot
id|cmdchar
op_eq
id|espcmd
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NUM_ESP_COMMANDS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ESP_Unknown&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s%s&quot;
comma
id|esp_cmd_strings
(braket
id|i
)braket
dot
id|text
comma
(paren
(paren
id|dma_bit
)paren
ques
c_cond
l_string|&quot;+DMA&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Print the status register&squot;s value */
DECL|function|esp_print_statreg
r_static
r_inline
r_void
id|esp_print_statreg
c_func
(paren
id|unchar
id|statreg
)paren
(brace
id|unchar
id|phase
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STATUS&lt;&quot;
)paren
suffix:semicolon
id|phase
op_assign
id|statreg
op_amp
id|ESP_STAT_PMASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s,&quot;
comma
(paren
id|phase
op_eq
id|ESP_DOP
ques
c_cond
l_string|&quot;DATA-OUT&quot;
suffix:colon
(paren
id|phase
op_eq
id|ESP_DIP
ques
c_cond
l_string|&quot;DATA-IN&quot;
suffix:colon
(paren
id|phase
op_eq
id|ESP_CMDP
ques
c_cond
l_string|&quot;COMMAND&quot;
suffix:colon
(paren
id|phase
op_eq
id|ESP_STATP
ques
c_cond
l_string|&quot;STATUS&quot;
suffix:colon
(paren
id|phase
op_eq
id|ESP_MOP
ques
c_cond
l_string|&quot;MSG-OUT&quot;
suffix:colon
(paren
id|phase
op_eq
id|ESP_MIP
ques
c_cond
l_string|&quot;MSG_IN&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|statreg
op_amp
id|ESP_STAT_TDONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TRANS_DONE,&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|statreg
op_amp
id|ESP_STAT_TCNT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TCOUNT_ZERO,&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|statreg
op_amp
id|ESP_STAT_PERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;P_ERROR,&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|statreg
op_amp
id|ESP_STAT_SPAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SPAM,&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|statreg
op_amp
id|ESP_STAT_INTR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IRQ,&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&gt;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Print the interrupt register&squot;s value */
DECL|function|esp_print_ireg
r_static
r_inline
r_void
id|esp_print_ireg
c_func
(paren
id|unchar
id|intreg
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;INTREG&lt; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_S
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SLCT_NATN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_SATN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SLCT_ATN &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_RSEL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RSLCT &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_FDONE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FDONE &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_BSERV
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BSERV &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_DC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DISCNCT &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_IC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ILL_CMD &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intreg
op_amp
id|ESP_INTR_SR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCSI_BUS_RESET &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&gt;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Print the sequence step registers contents */
DECL|function|esp_print_seqreg
r_static
r_inline
r_void
id|esp_print_seqreg
c_func
(paren
id|unchar
id|stepreg
)paren
(brace
id|stepreg
op_and_assign
id|ESP_STEP_VBITS
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STEP&lt;%s&gt;&quot;
comma
(paren
id|stepreg
op_eq
id|ESP_STEP_ASEL
ques
c_cond
l_string|&quot;SLCT_ARB_CMPLT&quot;
suffix:colon
(paren
id|stepreg
op_eq
id|ESP_STEP_SID
ques
c_cond
l_string|&quot;1BYTE_MSG_SENT&quot;
suffix:colon
(paren
id|stepreg
op_eq
id|ESP_STEP_NCMD
ques
c_cond
l_string|&quot;NOT_IN_CMD_PHASE&quot;
suffix:colon
(paren
id|stepreg
op_eq
id|ESP_STEP_PPC
ques
c_cond
l_string|&quot;CMD_BYTES_LOST&quot;
suffix:colon
(paren
id|stepreg
op_eq
id|ESP_STEP_FINI
ques
c_cond
l_string|&quot;CMD_SENT_OK&quot;
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Manipulation of the ESP command queues.  Thanks to the aha152x driver&n; * and its author, Juergen E. Fischer, for the methods used here.&n; * Note that these are per-ESP queues, not global queues like&n; * the aha152x driver uses.&n; */
DECL|function|append_SC
r_static
r_inline
r_void
id|append_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
id|Scsi_Cmnd
op_star
id|new_SC
)paren
(brace
id|Scsi_Cmnd
op_star
id|end
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|new_SC-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|SC
)paren
(brace
op_star
id|SC
op_assign
id|new_SC
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|end
op_assign
op_star
id|SC
suffix:semicolon
id|end-&gt;host_scribble
suffix:semicolon
id|end
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|end-&gt;host_scribble
)paren
(brace
suffix:semicolon
)brace
id|end-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|new_SC
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|remove_first_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_first_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ptr
op_assign
op_star
id|SC
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
(brace
op_star
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
op_star
id|SC
)paren
op_member_access_from_pointer
id|host_scribble
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|remove_SC
r_static
r_inline
id|Scsi_Cmnd
op_star
id|remove_SC
c_func
(paren
id|Scsi_Cmnd
op_star
op_star
id|SC
comma
r_int
id|target
comma
r_int
id|lun
)paren
(brace
id|Scsi_Cmnd
op_star
id|ptr
comma
op_star
id|prev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
op_star
id|SC
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_logical_and
(paren
(paren
id|ptr-&gt;target
op_ne
id|target
)paren
op_logical_or
(paren
id|ptr-&gt;lun
op_ne
id|lun
)paren
)paren
suffix:semicolon
id|prev
op_assign
id|ptr
comma
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
(brace
id|prev-&gt;host_scribble
op_assign
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
r_else
op_star
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|do_pause
r_static
r_inline
r_void
id|do_pause
c_func
(paren
r_int
id|amount
)paren
(brace
r_int
r_int
id|the_time
op_assign
id|jiffies
op_plus
id|amount
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|the_time
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Not really needed, but... */
)brace
multiline_comment|/* This places the ESP into a known state at boot time. */
DECL|function|esp_bootup_reset
r_static
r_inline
r_void
id|esp_bootup_reset
c_func
(paren
r_struct
id|Sparc_ESP
op_star
id|esp
comma
r_struct
id|Sparc_ESP_regs
op_star
id|eregs
)paren
(brace
r_struct
id|sparc_dma_registers
op_star
id|dregs
op_assign
id|esp-&gt;dregs
suffix:semicolon
r_volatile
id|unchar
id|trash
suffix:semicolon
multiline_comment|/* Punt the DVMA into a known state. */
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_RST_SCSI
suffix:semicolon
id|do_pause
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|dregs-&gt;cond_reg
op_and_assign
op_complement
(paren
id|DMA_RST_SCSI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|esp-&gt;dma-&gt;revision
op_eq
id|dvmarev2
)paren
r_if
c_cond
(paren
id|esp-&gt;erev
op_ne
id|esp100
)paren
(brace
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_3CLKS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;dma-&gt;revision
op_eq
id|dvmarev3
)paren
r_if
c_cond
(paren
id|esp-&gt;erev
op_eq
id|fas236
op_logical_or
id|esp-&gt;erev
op_eq
id|fas100a
)paren
(brace
id|dregs-&gt;cond_reg
op_and_assign
op_complement
(paren
id|DMA_3CLKS
)paren
suffix:semicolon
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_2CLKS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;dma-&gt;revision
op_eq
id|dvmaesc1
)paren
(brace
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_ADD_ENABLE
suffix:semicolon
)brace
id|DMA_INTSON
c_func
(paren
id|dregs
)paren
suffix:semicolon
multiline_comment|/* Now reset the ESP chip */
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_RC
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_NULL
op_or
id|ESP_CMD_DMA
)paren
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_NULL
op_or
id|ESP_CMD_DMA
)paren
suffix:semicolon
multiline_comment|/* borken hardware... */
multiline_comment|/* Reload the configuration registers */
id|eregs-&gt;esp_cfg1
op_assign
id|esp-&gt;config1
suffix:semicolon
id|eregs-&gt;esp_cfact
op_assign
id|esp-&gt;cfact
suffix:semicolon
id|eregs-&gt;esp_stp
op_assign
l_int|0
suffix:semicolon
id|eregs-&gt;esp_soff
op_assign
l_int|0
suffix:semicolon
id|eregs-&gt;esp_timeo
op_assign
id|esp-&gt;sync_defp
suffix:semicolon
r_if
c_cond
(paren
id|esp-&gt;erev
op_eq
id|esp100a
op_logical_or
id|esp-&gt;erev
op_eq
id|esp236
)paren
(brace
id|eregs-&gt;esp_cfg2
op_assign
id|esp-&gt;config2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|esp-&gt;erev
op_eq
id|esp236
)paren
(brace
id|eregs-&gt;esp_cfg3
op_assign
id|esp-&gt;config3
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* Eat any bitrot in the chip */
id|trash
op_assign
id|eregs-&gt;esp_intrpt
suffix:semicolon
multiline_comment|/* Reset the SCSI bus, but tell ESP not to generate an irq */
id|eregs-&gt;esp_cfg1
op_or_assign
id|ESP_CONFIG1_SRRDISAB
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_RS
suffix:semicolon
id|do_pause
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|eregs-&gt;esp_cfg1
op_assign
id|esp-&gt;config1
suffix:semicolon
multiline_comment|/* Eat any bitrot in the chip and we are done... */
id|trash
op_assign
id|eregs-&gt;esp_intrpt
suffix:semicolon
)brace
multiline_comment|/* Detecting ESP chips on the machine.  This is the simple and easy&n; * version.&n; */
DECL|function|esp_detect
r_int
id|esp_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Sparc_ESP
op_star
id|esp
comma
op_star
id|elink
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|esp_host
suffix:semicolon
r_struct
id|linux_sbus
op_star
id|sbus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|esp_dev
comma
op_star
id|sbdev_iter
suffix:semicolon
r_struct
id|Sparc_ESP_regs
op_star
id|eregs
suffix:semicolon
r_struct
id|sparc_dma_registers
op_star
id|dregs
suffix:semicolon
r_struct
id|Linux_SBus_DMA
op_star
id|dma
comma
op_star
id|dlink
suffix:semicolon
r_int
r_int
id|fmhz
suffix:semicolon
id|unchar
id|ccf
comma
id|bsizes
comma
id|bsizes_more
suffix:semicolon
r_int
id|nesps
op_assign
l_int|0
suffix:semicolon
r_int
id|esp_node
suffix:semicolon
id|espchain
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SBus_chain
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;No SBUS in esp_detect()&quot;
)paren
suffix:semicolon
)brace
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sbdev_iter
comma
id|sbus
)paren
(brace
multiline_comment|/* Is it an esp sbus device? */
id|esp_dev
op_assign
id|sbdev_iter
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|esp_dev-&gt;prom_name
comma
l_string|&quot;esp&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|esp_dev-&gt;prom_name
comma
l_string|&quot;SUNW,esp&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|esp_dev-&gt;child
op_logical_or
id|strcmp
c_func
(paren
id|esp_dev-&gt;prom_name
comma
l_string|&quot;espdma&quot;
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* nope... */
id|esp_dev
op_assign
id|esp_dev-&gt;child
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|esp_dev-&gt;prom_name
comma
l_string|&quot;esp&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|esp_dev-&gt;prom_name
comma
l_string|&quot;SUNW,esp&quot;
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* how can this happen? */
)brace
id|esp_host
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|Sparc_ESP
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|esp_host
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Cannot register ESP SCSI host&quot;
)paren
suffix:semicolon
)brace
id|esp
op_assign
(paren
r_struct
id|Sparc_ESP
op_star
)paren
id|esp_host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|esp
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;No esp in hostdata&quot;
)paren
suffix:semicolon
)brace
id|esp-&gt;ehost
op_assign
id|esp_host
suffix:semicolon
id|esp-&gt;edev
op_assign
id|esp_dev
suffix:semicolon
multiline_comment|/* Put into the chain of esp chips detected */
r_if
c_cond
(paren
id|espchain
)paren
(brace
id|elink
op_assign
id|espchain
suffix:semicolon
r_while
c_loop
(paren
id|elink-&gt;next
)paren
(brace
id|elink
op_assign
id|elink-&gt;next
suffix:semicolon
)brace
id|elink-&gt;next
op_assign
id|esp
suffix:semicolon
)brace
r_else
(brace
id|espchain
op_assign
id|esp
suffix:semicolon
)brace
id|esp-&gt;next
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Get misc. prom information */
DECL|macro|ESP_IS_MY_DVMA
mdefine_line|#define ESP_IS_MY_DVMA(esp, dma)  &bslash;&n;&t;((esp-&gt;edev-&gt;my_bus == dma-&gt;SBus_dev-&gt;my_bus) &amp;&amp; &bslash;&n;         (esp-&gt;edev-&gt;slot == dma-&gt;SBus_dev-&gt;slot) &amp;&amp; &bslash;&n;&t; (!strcmp(dma-&gt;SBus_dev-&gt;prom_name, &quot;dma&quot;) || &bslash;&n;&t;  !strcmp(dma-&gt;SBus_dev-&gt;prom_name, &quot;espdma&quot;)))
id|esp_node
op_assign
id|esp_dev-&gt;prom_node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|esp_node
comma
l_string|&quot;name&quot;
comma
id|esp-&gt;prom_name
comma
r_sizeof
(paren
id|esp-&gt;prom_name
)paren
)paren
suffix:semicolon
id|esp-&gt;prom_node
op_assign
id|esp_node
suffix:semicolon
id|for_each_dvma
c_func
(paren
id|dlink
)paren
(brace
r_if
c_cond
(paren
id|ESP_IS_MY_DVMA
c_func
(paren
id|esp
comma
id|dlink
)paren
op_logical_and
op_logical_neg
id|dlink-&gt;allocated
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
DECL|macro|ESP_IS_MY_DVMA
macro_line|#undef ESP_IS_MY_DVMA
multiline_comment|/* If we don&squot;t know how to handle the dvma, do not use this device */
r_if
c_cond
(paren
op_logical_neg
id|dlink
)paren
(brace
id|printk
(paren
l_string|&quot;Cannot find dvma for ESP SCSI&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|esp_host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dlink-&gt;allocated
)paren
(brace
id|printk
(paren
l_string|&quot;esp: can&squot;t use my espdma&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|esp_host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dlink-&gt;allocated
op_assign
l_int|1
suffix:semicolon
id|dma
op_assign
id|dlink
suffix:semicolon
id|esp-&gt;dma
op_assign
id|dma
suffix:semicolon
id|esp-&gt;dregs
op_assign
id|dregs
op_assign
id|dma-&gt;regs
suffix:semicolon
multiline_comment|/* Map in the ESP registers from I/O space */
id|prom_apply_sbus_ranges
c_func
(paren
id|esp-&gt;edev-&gt;reg_addrs
comma
l_int|1
)paren
suffix:semicolon
id|esp-&gt;eregs
op_assign
id|eregs
op_assign
(paren
r_struct
id|Sparc_ESP_regs
op_star
)paren
id|sparc_alloc_io
c_func
(paren
id|esp-&gt;edev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;ESP Registers&quot;
comma
id|esp-&gt;edev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0x0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|eregs
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;ESP registers unmappable&quot;
)paren
suffix:semicolon
)brace
id|esp-&gt;esp_command
op_assign
id|sparc_dvma_malloc
c_func
(paren
l_int|16
comma
l_string|&quot;ESP DVMA Cmd Block&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|esp-&gt;esp_command
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;ESP DVMA transport area unmappable&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up the irq&squot;s etc. */
id|esp-&gt;ehost-&gt;base
op_assign
(paren
r_int
r_char
op_star
)paren
id|esp-&gt;eregs
suffix:semicolon
id|esp-&gt;ehost-&gt;io_port
op_assign
(paren
r_int
r_int
)paren
id|esp-&gt;eregs
suffix:semicolon
id|esp-&gt;ehost-&gt;n_io_port
op_assign
(paren
r_int
r_char
)paren
id|esp-&gt;edev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
multiline_comment|/* XXX The following may be different on sun4ms XXX */
id|esp-&gt;ehost-&gt;irq
op_assign
id|esp-&gt;irq
op_assign
id|esp-&gt;edev-&gt;irqs
(braket
l_int|0
)braket
dot
id|pri
suffix:semicolon
multiline_comment|/* Allocate the irq only if necessary */
id|for_each_esp
c_func
(paren
id|elink
)paren
(brace
r_if
c_cond
(paren
(paren
id|elink
op_ne
id|esp
)paren
op_logical_and
(paren
id|esp-&gt;irq
op_eq
id|elink-&gt;irq
)paren
)paren
(brace
r_goto
id|esp_irq_acquired
suffix:semicolon
multiline_comment|/* BASIC rulez */
)brace
)brace
multiline_comment|/* XXX We have shared interrupts per level now, maybe&n;&t;&t;&t; * XXX use them, maybe not...&n;&t;&t;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|esp-&gt;ehost-&gt;irq
comma
id|esp_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;Sparc ESP SCSI&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Cannot acquire ESP irq line&quot;
)paren
suffix:semicolon
)brace
id|esp_irq_acquired
suffix:colon
id|printk
c_func
(paren
l_string|&quot;esp%d: IRQ %d &quot;
comma
id|nesps
comma
id|esp-&gt;ehost-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Figure out our scsi ID on the bus */
id|esp-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;prom_node
comma
l_string|&quot;initiator-id&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|esp-&gt;scsi_id
op_eq
op_minus
l_int|1
)paren
(brace
id|esp-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;prom_node
comma
l_string|&quot;scsi-initiator-id&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|esp-&gt;scsi_id
op_eq
op_minus
l_int|1
)paren
(brace
id|esp-&gt;scsi_id
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;edev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;scsi-initiator-id&quot;
comma
l_int|7
)paren
suffix:semicolon
)brace
id|esp-&gt;ehost-&gt;this_id
op_assign
id|esp-&gt;scsi_id
suffix:semicolon
id|esp-&gt;scsi_id_mask
op_assign
(paren
l_int|1
op_lshift
id|esp-&gt;scsi_id
)paren
suffix:semicolon
multiline_comment|/* Check for differential bus */
id|esp-&gt;diff
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;prom_node
comma
l_string|&quot;differential&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|esp-&gt;diff
op_assign
(paren
id|esp-&gt;diff
op_eq
op_minus
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Check out the clock properties of the chip */
id|fmhz
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;prom_node
comma
l_string|&quot;clock-frequency&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmhz
op_eq
op_minus
l_int|1
)paren
(brace
id|fmhz
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;edev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;clock-frequency&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fmhz
op_le
(paren
l_int|5000
)paren
)paren
(brace
id|ccf
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ccf
op_assign
(paren
(paren
(paren
l_int|5000
op_minus
l_int|1
)paren
op_plus
(paren
id|fmhz
)paren
)paren
op_div
(paren
l_int|5000
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ccf
op_logical_or
id|ccf
OG
l_int|8
)paren
(brace
id|ccf
op_assign
id|ESP_CCF_F4
suffix:semicolon
id|fmhz
op_assign
(paren
l_int|5000
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ccf
op_eq
(paren
id|ESP_CCF_F7
op_plus
l_int|1
)paren
)paren
(brace
id|esp-&gt;cfact
op_assign
id|ESP_CCF_F0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ccf
op_eq
id|ESP_CCF_NEVER
)paren
(brace
id|esp-&gt;cfact
op_assign
id|ESP_CCF_F2
suffix:semicolon
)brace
r_else
id|esp-&gt;cfact
op_assign
id|ccf
suffix:semicolon
id|esp-&gt;cfreq
op_assign
id|fmhz
suffix:semicolon
id|esp-&gt;ccycle
op_assign
(paren
(paren
l_int|1000000000
)paren
op_div
(paren
(paren
id|fmhz
)paren
op_div
l_int|1000
)paren
)paren
suffix:semicolon
id|esp-&gt;ctick
op_assign
(paren
(paren
l_int|7682
op_star
id|esp-&gt;cfact
op_star
id|esp-&gt;ccycle
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|esp-&gt;sync_defp
op_assign
(paren
(paren
l_int|7682
op_plus
id|esp-&gt;ctick
op_minus
l_int|1
)paren
op_div
id|esp-&gt;ctick
)paren
suffix:semicolon
multiline_comment|/* XXX HACK HACK HACK XXX */
r_if
c_cond
(paren
id|esp-&gt;sync_defp
OL
l_int|153
)paren
id|esp-&gt;sync_defp
op_assign
l_int|153
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSI ID %d  Clock %d MHz Period %2x &quot;
comma
id|esp-&gt;scsi_id
comma
(paren
id|fmhz
op_div
l_int|1000
)paren
comma
id|esp-&gt;sync_defp
)paren
suffix:semicolon
multiline_comment|/* Find the burst sizes this dma supports. */
id|bsizes
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|bsizes_more
op_assign
id|prom_getintdefault
c_func
(paren
id|esp-&gt;edev-&gt;my_bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bsizes_more
op_ne
l_int|0xff
)paren
(brace
id|bsizes
op_and_assign
id|bsizes_more
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bsizes
op_eq
l_int|0xff
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST16
)paren
op_eq
l_int|0
op_logical_or
(paren
id|bsizes
op_amp
id|DMA_BURST32
)paren
op_eq
l_int|0
)paren
(brace
id|bsizes
op_assign
(paren
id|DMA_BURST32
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|esp-&gt;bursts
op_assign
id|bsizes
suffix:semicolon
multiline_comment|/* Probe the revision of this esp */
id|esp-&gt;config1
op_assign
(paren
id|ESP_CONFIG1_PENABLE
op_or
(paren
id|esp-&gt;scsi_id
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|esp-&gt;config2
op_assign
(paren
id|ESP_CONFIG2_SCSI2ENAB
op_or
id|ESP_CONFIG2_REGPARITY
)paren
suffix:semicolon
id|esp-&gt;config3
(braket
l_int|0
)braket
op_assign
id|ESP_CONFIG3_TENB
suffix:semicolon
id|eregs-&gt;esp_cfg2
op_assign
id|esp-&gt;config2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eregs-&gt;esp_cfg2
op_amp
op_complement
(paren
id|ESP_CONFIG2_MAGIC
)paren
)paren
op_ne
(paren
id|ESP_CONFIG2_SCSI2ENAB
op_or
id|ESP_CONFIG2_REGPARITY
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53C90(esp100) detected&bslash;n&quot;
)paren
suffix:semicolon
id|esp-&gt;erev
op_assign
id|esp100
suffix:semicolon
)brace
r_else
(brace
id|eregs-&gt;esp_cfg2
op_assign
id|esp-&gt;config2
op_assign
l_int|0
suffix:semicolon
id|eregs-&gt;esp_cfg3
op_assign
l_int|0
suffix:semicolon
id|eregs-&gt;esp_cfg3
op_assign
id|esp-&gt;config3
(braket
l_int|0
)braket
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|eregs-&gt;esp_cfg3
op_ne
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53C90A(esp100a) detected&bslash;n&quot;
)paren
suffix:semicolon
id|esp-&gt;erev
op_assign
id|esp100a
suffix:semicolon
)brace
r_else
(brace
r_int
id|target
suffix:semicolon
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
l_int|8
suffix:semicolon
id|target
op_increment
)paren
(brace
id|esp-&gt;config3
(braket
id|target
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|eregs-&gt;esp_cfg3
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|esp-&gt;cfact
OG
id|ESP_CCF_F5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53C9XF(espfast) detected&bslash;n&quot;
)paren
suffix:semicolon
id|esp-&gt;erev
op_assign
id|fast
suffix:semicolon
id|esp-&gt;config2
op_or_assign
id|ESP_CONFIG2_FENAB
suffix:semicolon
id|eregs-&gt;esp_cfg2
op_assign
id|esp-&gt;config2
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;NCR53C9x(esp236) detected&bslash;n&quot;
)paren
suffix:semicolon
id|esp-&gt;erev
op_assign
id|esp236
suffix:semicolon
id|eregs-&gt;esp_cfg2
op_assign
id|esp-&gt;config2
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Initialize the command queues */
id|esp-&gt;current_SC
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;disconnected_SC
op_assign
l_int|0
suffix:semicolon
id|esp-&gt;issue_SC
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset the thing before we try anything... */
id|esp_bootup_reset
c_func
(paren
id|esp
comma
id|eregs
)paren
suffix:semicolon
id|nesps
op_increment
suffix:semicolon
macro_line|#ifdef THREADED_ESP_DRIVER
id|kernel_thread
c_func
(paren
id|esp_kernel_thread
comma
id|esp
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* for each sbusdev */
)brace
multiline_comment|/* for each sbus */
r_return
id|nesps
suffix:semicolon
)brace
multiline_comment|/*&n; * The info function will return whatever useful&n; * information the developer sees fit.  If not provided, then&n; * the name field will be used instead.&n; */
DECL|function|esp_info
r_const
r_char
op_star
id|esp_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|Sparc_ESP
op_star
id|esp
suffix:semicolon
id|esp
op_assign
(paren
r_struct
id|Sparc_ESP
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_switch
c_cond
(paren
id|esp-&gt;erev
)paren
(brace
r_case
id|esp100
suffix:colon
r_return
l_string|&quot;Sparc ESP100 (NCR53C90)&quot;
suffix:semicolon
r_case
id|esp100a
suffix:colon
r_return
l_string|&quot;Sparc ESP100A (NCR53C90A)&quot;
suffix:semicolon
r_case
id|esp236
suffix:colon
r_return
l_string|&quot;Sparc ESP236&quot;
suffix:semicolon
r_case
id|fast
suffix:colon
r_return
l_string|&quot;Sparc ESP-FAST (236 or 100A)&quot;
suffix:semicolon
r_case
id|fas236
suffix:colon
r_return
l_string|&quot;Sparc ESP236-FAST&quot;
suffix:semicolon
r_case
id|fas100a
suffix:colon
r_return
l_string|&quot;Sparc ESP100A-FAST&quot;
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;Bogon ESP revision&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
multiline_comment|/* Execute a SCSI command when the bus is free.   All callers&n; * turn off all interrupts, so we don&squot;t need to explicitly do&n; * it here.&n; */
DECL|function|esp_exec_cmd
r_static
r_inline
r_void
id|esp_exec_cmd
c_func
(paren
r_struct
id|Sparc_ESP
op_star
id|esp
)paren
(brace
r_struct
id|sparc_dma_registers
op_star
id|dregs
suffix:semicolon
r_struct
id|Sparc_ESP_regs
op_star
id|eregs
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCptr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|eregs
op_assign
id|esp-&gt;eregs
suffix:semicolon
id|dregs
op_assign
id|esp-&gt;dregs
suffix:semicolon
multiline_comment|/* Grab first member of the issue queue. */
id|SCptr
op_assign
id|esp-&gt;current_SC
op_assign
id|remove_first_SC
c_func
(paren
op_amp
id|esp-&gt;issue_SC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCptr
)paren
(brace
r_goto
id|bad
suffix:semicolon
)brace
id|SCptr-&gt;SCp.phase
op_assign
id|in_selection
suffix:semicolon
multiline_comment|/* NCR docs say:&n;&t; * 1) Load select/reselect Bus ID register with target ID&n;&t; * 2) Load select/reselect Timeout Reg with desired value&n;&t; * 3) Load Synchronous offset register with zero (for&n;&t; *    asynchronous transfers).&n;&t; * 4) Load Synchronous Transfer Period register (if&n;&t; *    synchronous)&n;&t; * 5) Load FIFO with 6, 10, or 12 byte SCSI command&n;&t; * 6) Issue SELECTION_WITHOUT_ATTENTION command&n;&t; *&n;&t; * They also mention that a DMA NOP command must be issued&n;&t; * to the SCSI chip under many circumstances, plus it&squot;s&n;&t; * also a good idea to flush out the fifo just in case.&n;&t; */
multiline_comment|/* Load zeros into COUNTER via 2 DMA NOP chip commands&n;&t; * due to flaky implementations of the 53C9x which don&squot;t&n;&t; * get the idea the first time around.&n;&t; */
id|dregs-&gt;cond_reg
op_assign
(paren
id|DMA_INT_ENAB
op_or
id|DMA_FIFO_INV
)paren
suffix:semicolon
id|eregs-&gt;esp_tclow
op_assign
l_int|0
suffix:semicolon
id|eregs-&gt;esp_tcmed
op_assign
l_int|0
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_NULL
op_or
id|ESP_CMD_DMA
)paren
suffix:semicolon
multiline_comment|/* Flush the fifo of excess garbage. */
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_FLUSH
suffix:semicolon
multiline_comment|/* Load bus-id and timeout values. */
id|eregs-&gt;esp_busid
op_assign
(paren
id|SCptr-&gt;target
op_amp
l_int|7
)paren
suffix:semicolon
id|eregs-&gt;esp_timeo
op_assign
id|esp-&gt;sync_defp
suffix:semicolon
id|eregs-&gt;esp_soff
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This means async transfer... */
id|eregs-&gt;esp_stp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Load FIFO with the actual SCSI command. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCptr-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|eregs-&gt;esp_fdata
op_assign
id|SCptr-&gt;cmnd
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Make sure the dvma forwards the ESP interrupt. */
id|dregs-&gt;cond_reg
op_assign
id|DMA_INT_ENAB
suffix:semicolon
multiline_comment|/* Tell ESP to SELECT without asserting ATN. */
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_SEL
suffix:semicolon
r_return
suffix:semicolon
id|bad
suffix:colon
id|panic
c_func
(paren
l_string|&quot;esp: daaarrrkk starrr crashesss....&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Queue a SCSI command delivered from the mid-level Linux SCSI code. */
DECL|function|esp_queue
r_int
id|esp_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Sparc_ESP
op_star
id|esp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set up func ptr and initial driver cmd-phase. */
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|SCpnt-&gt;SCp.phase
op_assign
id|not_issued
suffix:semicolon
id|esp
op_assign
(paren
r_struct
id|Sparc_ESP
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* We use the scratch area. */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;use_sg
)paren
(brace
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
id|CHECK_CONDITION
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.have_data_in
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
id|mmu_get_scsi_one
c_func
(paren
(paren
r_char
op_star
)paren
id|SCpnt-&gt;SCp.buffer
comma
id|SCpnt-&gt;SCp.this_residual
comma
id|esp-&gt;edev-&gt;my_bus
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef DEBUG_ESP_SG
id|printk
c_func
(paren
l_string|&quot;esp: sglist at %p with %d buffers&bslash;n&quot;
comma
id|SCpnt-&gt;buffer
comma
id|SCpnt-&gt;use_sg
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|mmu_get_scsi_sgl
c_func
(paren
(paren
r_struct
id|mmu_sglist
op_star
)paren
id|SCpnt-&gt;SCp.buffer
comma
id|SCpnt-&gt;SCp.buffers_residual
comma
id|esp-&gt;edev-&gt;my_bus
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;SCp.buffer-&gt;alt_address
suffix:semicolon
)brace
multiline_comment|/* Place into our queue. */
id|append_SC
c_func
(paren
op_amp
id|esp-&gt;issue_SC
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Run it now if we can */
r_if
c_cond
(paren
op_logical_neg
id|esp-&gt;current_SC
)paren
(brace
id|esp_exec_cmd
c_func
(paren
id|esp
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Only queuing supported in this ESP driver. */
DECL|function|esp_command
r_int
id|esp_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;esp: esp_command() called...&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Abort a command.  Those that are on the bus force a SCSI bus&n; * reset.&n; */
DECL|function|esp_abort
r_int
id|esp_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;esp_abort: Not implemented yet&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
multiline_comment|/* Reset ESP chip, reset hanging bus, then kill active and&n; * disconnected commands for targets without soft reset.&n; */
DECL|function|esp_reset
r_int
id|esp_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCptr
comma
r_int
r_int
id|how
)paren
(brace
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;esp_reset: Not implemented yet&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
multiline_comment|/* Internal ESP done function. */
DECL|function|esp_done
r_static
r_inline
r_void
id|esp_done
c_func
(paren
r_struct
id|Sparc_ESP
op_star
id|esp
comma
r_int
id|error
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|done_SC
suffix:semicolon
r_if
c_cond
(paren
id|esp-&gt;current_SC
)paren
(brace
multiline_comment|/* Critical section... */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|done_SC
op_assign
id|esp-&gt;current_SC
suffix:semicolon
id|esp-&gt;current_SC
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Free dvma entry. */
r_if
c_cond
(paren
op_logical_neg
id|done_SC-&gt;use_sg
)paren
(brace
id|mmu_release_scsi_one
c_func
(paren
id|done_SC-&gt;SCp.ptr
comma
id|done_SC-&gt;SCp.this_residual
comma
id|esp-&gt;edev-&gt;my_bus
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|scatterlist
op_star
id|scl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|done_SC-&gt;buffer
suffix:semicolon
macro_line|#ifdef DEBUG_ESP_SG
id|printk
c_func
(paren
l_string|&quot;esp: unmapping sg &quot;
)paren
suffix:semicolon
macro_line|#endif
id|mmu_release_scsi_sgl
c_func
(paren
(paren
r_struct
id|mmu_sglist
op_star
)paren
id|scl
comma
id|done_SC-&gt;use_sg
op_minus
l_int|1
comma
id|esp-&gt;edev-&gt;my_bus
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_ESP_SG
id|printk
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|done_SC-&gt;result
op_assign
id|error
suffix:semicolon
r_if
c_cond
(paren
id|done_SC-&gt;scsi_done
)paren
(brace
id|done_SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|done_SC
)paren
suffix:semicolon
)brace
r_else
id|panic
c_func
(paren
l_string|&quot;esp: esp-&gt;current_SC-&gt;scsi_done() == NULL&quot;
)paren
suffix:semicolon
multiline_comment|/* Bus is free, issue any commands in the queue. */
r_if
c_cond
(paren
id|esp-&gt;issue_SC
)paren
(brace
id|esp_exec_cmd
c_func
(paren
id|esp
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* End of critical section... */
)brace
r_else
id|panic
c_func
(paren
l_string|&quot;esp: done() called with NULL esp-&gt;current_SC&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef THREADED_ESP_DRIVER /* planning stage... */
multiline_comment|/* With multiple lots of commands being processed I frequently&n; * see a situation where we see galloping esp herds.  esp_done()&n; * wakes the entire world up and each interrupt causes a reschedule.&n; * This kernel thread fixes some of these unwanted effects during&n; * IO intensive activity.... I hope...&n; */
DECL|function|esp_kernel_thread
r_static
r_void
id|esp_kernel_thread
c_func
(paren
r_void
op_star
id|opaque
)paren
(brace
r_struct
id|Sparc_ESP
op_star
id|esp
op_assign
id|opaque
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|esp-&gt;eatme_SC
)paren
(brace
r_struct
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|SCpnt
op_assign
id|remove_first_SC
c_func
(paren
id|esp-&gt;eatme_SC
)paren
suffix:semicolon
id|esp_done
c_func
(paren
id|esp
comma
id|error
comma
id|SCpnt
)paren
suffix:semicolon
)brace
id|sleep
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Read the interrupt status registers on this ESP board */
DECL|function|esp_updatesoft
r_static
r_inline
r_void
id|esp_updatesoft
c_func
(paren
r_struct
id|Sparc_ESP
op_star
id|esp
comma
r_struct
id|Sparc_ESP_regs
op_star
id|eregs
)paren
(brace
multiline_comment|/* Update our software copies of the three ESP status&n;&t; * registers for this ESP.  Be careful, reading the&n;&t; * ESP interrupt register clears the status and sequence&n;&t; * step registers (unlatches them, you get the idea).&n;&t; * So read the interrupt register last.&n;&t; */
id|esp-&gt;seqreg
op_assign
id|eregs-&gt;esp_sstep
suffix:semicolon
id|esp-&gt;sreg
op_assign
id|eregs-&gt;esp_status
suffix:semicolon
multiline_comment|/* Supposedly, the ESP100A and above assert the highest&n;&t; * bit in the status register if an interrupt is pending.&n;&t; * I&squot;ve never seen this work properly, so let&squot;s clear it&n;&t; * manually while we are here.  If I see any esp chips&n;&t; * for which this bit is reliable I will conditionalize&n;&t; * this.  However, I don&squot;t see what this extra bit can&n;&t; * buy me with all the tests I&squot;ll have to place all over&n;&t; * the code to actually use it when I &squot;can&squot;.  Plus the&n;&t; * &squot;pending interrupt&squot; condition can more than reliably&n;&t; * be obtained from the DVMA control register.&n;&t; *&n;&t; * &quot;Broken hardware&quot;  -Linus&n;&t; */
id|esp-&gt;sreg
op_and_assign
(paren
op_complement
id|ESP_STAT_INTR
)paren
suffix:semicolon
id|esp-&gt;ireg
op_assign
id|eregs-&gt;esp_intrpt
suffix:semicolon
multiline_comment|/* Must be last or we lose */
)brace
multiline_comment|/* #define ESP_IRQ_TRACE */
macro_line|#ifdef ESP_IRQ_TRACE
DECL|macro|ETRACE
mdefine_line|#define ETRACE(foo)  printk foo
macro_line|#else
DECL|macro|ETRACE
mdefine_line|#define ETRACE(foo)
macro_line|#endif
DECL|variable|last_fflags
DECL|variable|last_status
DECL|variable|last_msg
r_static
r_char
id|last_fflags
comma
id|last_status
comma
id|last_msg
suffix:semicolon
multiline_comment|/* Main interrupt handler for an esp adapter. */
DECL|function|esp_handle
r_static
r_inline
r_void
id|esp_handle
c_func
(paren
r_struct
id|Sparc_ESP
op_star
id|esp
)paren
(brace
r_struct
id|sparc_dma_registers
op_star
id|dregs
suffix:semicolon
r_struct
id|Sparc_ESP_regs
op_star
id|eregs
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCptr
suffix:semicolon
id|eregs
op_assign
id|esp-&gt;eregs
suffix:semicolon
id|dregs
op_assign
id|esp-&gt;dregs
suffix:semicolon
id|SCptr
op_assign
id|esp-&gt;current_SC
suffix:semicolon
id|DMA_IRQ_ENTRY
c_func
(paren
id|esp-&gt;dma
comma
id|dregs
)paren
suffix:semicolon
id|esp_updatesoft
c_func
(paren
id|esp
comma
id|eregs
)paren
suffix:semicolon
id|ETRACE
c_func
(paren
(paren
l_string|&quot;ESPIRQ: &lt;%2x,%2x,%2x&gt; --&gt; &quot;
comma
id|esp-&gt;ireg
comma
id|esp-&gt;sreg
comma
id|esp-&gt;seqreg
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
op_logical_neg
id|SCptr
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;esp_handle: current_SC == penguin within interrupt!&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* At this point in time, this esp driver should not see&n;&t; * scsibus resets, parity errors, or gross errors unless&n;&t; * something truly terrible happens which we are not ready&n;&t; * to properly recover from yet.&n;&t; */
r_if
c_cond
(paren
(paren
id|esp-&gt;ireg
op_amp
(paren
id|ESP_INTR_SR
op_or
id|ESP_INTR_IC
)paren
)paren
op_logical_or
(paren
id|esp-&gt;sreg
op_amp
(paren
id|ESP_STAT_PERR
op_or
id|ESP_STAT_SPAM
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;esp: really bad error detected&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp: intr&lt;%2x&gt; stat&lt;%2x&gt; seq&lt;%2x&gt;&quot;
comma
id|esp-&gt;ireg
comma
id|esp-&gt;sreg
comma
id|esp-&gt;seqreg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp: SCptr-&gt;SCp.phase = %d&bslash;n&quot;
comma
id|SCptr-&gt;SCp.phase
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;esp: cannot continue&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dregs-&gt;cond_reg
op_amp
id|DMA_HNDL_ERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;esp: DMA shows an error cond_reg&lt;%08lx&gt; addr&lt;%p&gt;&bslash;n&quot;
comma
id|dregs-&gt;cond_reg
comma
id|dregs-&gt;st_addr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp: intr&lt;%2x&gt; stat&lt;%2x&gt; seq&lt;%2x&gt;&quot;
comma
id|esp-&gt;ireg
comma
id|esp-&gt;sreg
comma
id|esp-&gt;seqreg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp: SCptr-&gt;SCp.phase = %d&bslash;n&quot;
comma
id|SCptr-&gt;SCp.phase
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;esp: cannot continue&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|esp-&gt;sreg
op_amp
id|ESP_STAT_PERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;esp: SCSI bus parity error&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp: intr&lt;%2x&gt; stat&lt;%2x&gt; seq&lt;%2x&gt;&quot;
comma
id|esp-&gt;ireg
comma
id|esp-&gt;sreg
comma
id|esp-&gt;seqreg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp: SCptr-&gt;SCp.phase = %d&bslash;n&quot;
comma
id|SCptr-&gt;SCp.phase
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;esp: cannot continue&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Service interrupt. */
r_switch
c_cond
(paren
id|SCptr-&gt;SCp.phase
)paren
(brace
r_case
id|not_issued
suffix:colon
id|panic
c_func
(paren
l_string|&quot;Unexpected ESP interrupt, current_SC not issued.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|in_selection
suffix:colon
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_RSEL
)paren
(brace
multiline_comment|/* XXX Some day XXX */
id|panic
c_func
(paren
l_string|&quot;ESP penguin reselected in async mode.&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_DC
)paren
(brace
multiline_comment|/* Either we are scanning the bus and no-one&n;&t;&t;&t; * lives at this target or it didn&squot;t respond.&n;&t;&t;&t; */
id|ETRACE
c_func
(paren
(paren
l_string|&quot;DISCONNECT&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifdef THREADED_ESP_DRIVER
id|append_SC
c_func
(paren
id|esp-&gt;eatme_SC
comma
id|esp-&gt;current_SC
)paren
suffix:semicolon
id|esp-&gt;current_SC
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
id|esp_kernel_thread
)paren
suffix:semicolon
macro_line|#else
id|esp_done
c_func
(paren
id|esp
comma
(paren
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|esp-&gt;ireg
op_amp
(paren
id|ESP_INTR_FDONE
op_or
id|ESP_INTR_BSERV
)paren
)paren
op_eq
(paren
id|ESP_INTR_FDONE
op_or
id|ESP_INTR_BSERV
)paren
)paren
(brace
multiline_comment|/* Selection successful, check the sequence step. */
multiline_comment|/* XXX I know, I know... add error recovery.  XXX */
r_switch
c_cond
(paren
id|esp-&gt;seqreg
op_amp
id|ESP_STEP_VBITS
)paren
(brace
r_case
id|ESP_STEP_NCMD
suffix:colon
id|panic
c_func
(paren
l_string|&quot;esp: penguin didn&squot;t enter cmd phase.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ESP_STEP_PPC
suffix:colon
id|panic
c_func
(paren
l_string|&quot;esp: penguin prematurely changed from cmd phase.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ESP_STEP_FINI
suffix:colon
multiline_comment|/* At the completion of every command&n;&t;&t;&t;&t; * or message-out phase, we _must_&n;&t;&t;&t;&t; * unlatch the fifo-flags register&n;&t;&t;&t;&t; * with an ESP nop command.&n;&t;&t;&t;&t; */
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_NULL
suffix:semicolon
multiline_comment|/* Selection/Command sequence completed.  We&n;&t;&t;&t;&t; * (at least for this driver) will be in&n;&t;&t;&t;&t; * either one of the data phases or status&n;&t;&t;&t;&t; * phase, check the status register to find&n;&t;&t;&t;&t; * out.&n;&t;&t;&t;&t; */
r_switch
c_cond
(paren
id|esp-&gt;sreg
op_amp
id|ESP_STAT_PMASK
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;esp: Not datain/dataout/status.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;esp: penguin phase transition after selection.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ESP_DOP
suffix:colon
multiline_comment|/* Data out phase. */
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_FIFO_INV
suffix:semicolon
r_while
c_loop
(paren
id|dregs-&gt;cond_reg
op_amp
id|DMA_FIFO_ISDRAIN
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|SCptr-&gt;SCp.phase
op_assign
id|in_dataout
suffix:semicolon
macro_line|#ifdef DEBUG_ESP_SG
r_if
c_cond
(paren
id|SCptr-&gt;use_sg
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;esp: sg-start &lt;%p,%d&gt;&quot;
comma
id|SCptr-&gt;SCp.ptr
comma
id|SCptr-&gt;SCp.this_residual
)paren
suffix:semicolon
)brace
macro_line|#endif
id|eregs-&gt;esp_tclow
op_assign
id|SCptr-&gt;SCp.this_residual
suffix:semicolon
id|eregs-&gt;esp_tcmed
op_assign
(paren
id|SCptr-&gt;SCp.this_residual
op_rshift
l_int|8
)paren
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_DMA
op_or
id|ESP_CMD_NULL
)paren
suffix:semicolon
multiline_comment|/* This is either the one buffer dvma ptr,&n;&t;&t;&t;&t;&t; * or the first one in the scatter gather&n;&t;&t;&t;&t;&t; * list.  Check out esp_queue to see how&n;&t;&t;&t;&t;&t; * this is set up.&n;&t;&t;&t;&t;&t; */
id|dregs-&gt;st_addr
op_assign
id|SCptr-&gt;SCp.ptr
suffix:semicolon
id|dregs-&gt;cond_reg
op_and_assign
op_complement
(paren
id|DMA_ST_WRITE
)paren
suffix:semicolon
id|dregs-&gt;cond_reg
op_or_assign
(paren
id|DMA_ENABLE
op_or
id|DMA_INT_ENAB
)paren
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_DMA
op_or
id|ESP_CMD_TI
)paren
suffix:semicolon
id|ETRACE
c_func
(paren
(paren
l_string|&quot;DATA_OUT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
r_case
id|ESP_DIP
suffix:colon
multiline_comment|/* Data in phase. */
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_FIFO_INV
suffix:semicolon
r_while
c_loop
(paren
id|dregs-&gt;cond_reg
op_amp
id|DMA_FIFO_ISDRAIN
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|SCptr-&gt;SCp.phase
op_assign
id|in_datain
suffix:semicolon
macro_line|#ifdef DEBUG_ESP_SG
r_if
c_cond
(paren
id|SCptr-&gt;use_sg
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;esp: sg-start &lt;%p,%d&gt;&quot;
comma
id|SCptr-&gt;SCp.ptr
comma
id|SCptr-&gt;SCp.this_residual
)paren
suffix:semicolon
)brace
macro_line|#endif
id|eregs-&gt;esp_tclow
op_assign
id|SCptr-&gt;SCp.this_residual
suffix:semicolon
id|eregs-&gt;esp_tcmed
op_assign
(paren
id|SCptr-&gt;SCp.this_residual
op_rshift
l_int|8
)paren
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_DMA
op_or
id|ESP_CMD_NULL
)paren
suffix:semicolon
multiline_comment|/* This is either the one buffer dvma ptr,&n;&t;&t;&t;&t;&t; * or the first one in the scatter gather&n;&t;&t;&t;&t;&t; * list.  Check out esp_queue to see how&n;&t;&t;&t;&t;&t; * this is set up.&n;&t;&t;&t;&t;&t; */
id|dregs-&gt;st_addr
op_assign
id|SCptr-&gt;SCp.ptr
suffix:semicolon
id|dregs-&gt;cond_reg
op_or_assign
(paren
id|DMA_ENABLE
op_or
id|DMA_ST_WRITE
op_or
id|DMA_INT_ENAB
)paren
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_DMA
op_or
id|ESP_CMD_TI
)paren
suffix:semicolon
id|ETRACE
c_func
(paren
(paren
l_string|&quot;DATA_IN&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
r_case
id|ESP_STATP
suffix:colon
multiline_comment|/* Status phase. */
id|SCptr-&gt;SCp.phase
op_assign
id|in_status
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_ICCSEQ
suffix:semicolon
id|ETRACE
c_func
(paren
(paren
l_string|&quot;STATUS&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
multiline_comment|/* Wait for message. */
)brace
suffix:semicolon
)brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_FDONE
)paren
(brace
multiline_comment|/* I&squot;d like to investigate why this happens... */
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;esp: This is weird, halfway through &quot;
)paren
)paren
suffix:semicolon
id|ESPLOG
c_func
(paren
(paren
l_string|&quot;selection, trying to continue anyways.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
(brace
id|panic
c_func
(paren
l_string|&quot;esp: Did not get bus service during selection.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;esp: Mr. Potatoe Head is on the loose!&quot;
)paren
suffix:semicolon
r_case
id|in_datain
suffix:colon
multiline_comment|/* Drain the fifo for writes to memory. */
r_switch
c_cond
(paren
id|esp-&gt;dma-&gt;revision
)paren
(brace
r_case
id|dvmarev0
suffix:colon
r_case
id|dvmarev1
suffix:colon
r_case
id|dvmarevplus
suffix:colon
r_case
id|dvmarev2
suffix:colon
r_case
id|dvmarev3
suffix:colon
multiline_comment|/* Force a drain. */
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_FIFO_STDRAIN
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|dvmaesc1
suffix:colon
multiline_comment|/* Wait for the fifo to drain completely. */
r_while
c_loop
(paren
id|dregs-&gt;cond_reg
op_amp
id|DMA_FIFO_ISDRAIN
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
suffix:semicolon
r_case
id|in_dataout
suffix:colon
id|dregs-&gt;cond_reg
op_and_assign
op_complement
id|DMA_ENABLE
suffix:semicolon
multiline_comment|/* We may be pipelining an sg-list. */
r_if
c_cond
(paren
id|SCptr-&gt;use_sg
)paren
(brace
r_if
c_cond
(paren
id|SCptr-&gt;SCp.buffers_residual
)paren
(brace
multiline_comment|/* If we do not see a BUS SERVICE interrupt&n;&t;&t;&t;&t; * at this point, or we see that we have left&n;&t;&t;&t;&t; * the current data phase, then we lose.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_BSERV
)paren
op_logical_or
(paren
(paren
id|esp-&gt;sreg
op_amp
id|ESP_STAT_PMASK
)paren
OG
l_int|1
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;esp: Aiee penguin on the SCSI-bus.&quot;
)paren
suffix:semicolon
)brace
op_increment
id|SCptr-&gt;SCp.buffer
suffix:semicolon
op_decrement
id|SCptr-&gt;SCp.buffers_residual
suffix:semicolon
id|SCptr-&gt;SCp.this_residual
op_assign
id|SCptr-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|SCptr-&gt;SCp.ptr
op_assign
id|SCptr-&gt;SCp.buffer-&gt;alt_address
suffix:semicolon
macro_line|#ifdef DEBUG_ESP_SG
id|printk
c_func
(paren
l_string|&quot;&lt;%p,%d&gt; &quot;
comma
id|SCptr-&gt;SCp.ptr
comma
id|SCptr-&gt;SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Latch in new esp counters... */
id|eregs-&gt;esp_tclow
op_assign
id|SCptr-&gt;SCp.this_residual
suffix:semicolon
id|eregs-&gt;esp_tcmed
op_assign
(paren
id|SCptr-&gt;SCp.this_residual
op_rshift
l_int|8
)paren
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_DMA
op_or
id|ESP_CMD_NULL
)paren
suffix:semicolon
multiline_comment|/* Reload DVMA gate array with new vaddr and enab. */
id|dregs-&gt;st_addr
op_assign
id|SCptr-&gt;SCp.ptr
suffix:semicolon
id|dregs-&gt;cond_reg
op_or_assign
id|DMA_ENABLE
suffix:semicolon
multiline_comment|/* Tell the esp to start transferring. */
id|eregs-&gt;esp_cmd
op_assign
(paren
id|ESP_CMD_DMA
op_or
id|ESP_CMD_TI
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_ESP_SG
id|printk
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Take a look at what happened. */
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_DC
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;esp: target disconnects during data transfer.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_BSERV
)paren
(brace
r_if
c_cond
(paren
(paren
id|esp-&gt;sreg
op_amp
id|ESP_STAT_PMASK
)paren
op_ne
id|ESP_STATP
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;esp: Not status phase after data phase.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
id|SCptr-&gt;SCp.phase
op_assign
id|in_status
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_ICCSEQ
suffix:semicolon
id|ETRACE
c_func
(paren
(paren
l_string|&quot;STATUS&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
multiline_comment|/* Wait for message. */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;esp: did not get bus service after data transfer.&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp_status: intr&lt;%2x&gt; stat&lt;%2x&gt; seq&lt;%2x&gt;&bslash;n&quot;
comma
id|esp-&gt;ireg
comma
id|esp-&gt;sreg
comma
id|esp-&gt;seqreg
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;esp: penguin data transfer.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_case
id|in_status
suffix:colon
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_DC
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;esp: penguin disconnects in status phase.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_FDONE
)paren
(brace
multiline_comment|/* Status and Message now sit in the fifo for us. */
id|last_fflags
op_assign
id|eregs-&gt;esp_fflags
suffix:semicolon
id|SCptr-&gt;SCp.phase
op_assign
id|in_finale
suffix:semicolon
id|last_status
op_assign
id|SCptr-&gt;SCp.Status
op_assign
id|eregs-&gt;esp_fdata
suffix:semicolon
id|last_msg
op_assign
id|SCptr-&gt;SCp.Message
op_assign
id|eregs-&gt;esp_fdata
suffix:semicolon
id|eregs-&gt;esp_cmd
op_assign
id|ESP_CMD_MOK
suffix:semicolon
id|ETRACE
c_func
(paren
(paren
l_string|&quot;FINALE&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
(brace
id|panic
c_func
(paren
l_string|&quot;esp: penguin status phase.&quot;
)paren
suffix:semicolon
)brace
r_case
id|in_finale
suffix:colon
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_BSERV
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;esp: penguin doesn&squot;t disconnect after status msg-ack.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|esp-&gt;ireg
op_amp
id|ESP_INTR_DC
)paren
(brace
multiline_comment|/* Nexus is complete. */
macro_line|#ifdef THREADED_ESP_DRIVER
id|append_SC
c_func
(paren
id|esp-&gt;eatme_SC
comma
id|esp-&gt;current_SC
)paren
suffix:semicolon
id|esp-&gt;current_SC
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
id|esp_kernel_thread
)paren
suffix:semicolon
macro_line|#else
id|esp_done
c_func
(paren
id|esp
comma
(paren
(paren
id|SCptr-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|SCptr-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ETRACE
c_func
(paren
(paren
l_string|&quot;NEXUS_COMPLETE&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;esp: wacky state while in in_finale phase.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esp_status: intr&lt;%2x&gt; stat&lt;%2x&gt; seq&lt;%2x&gt;&bslash;n&quot;
comma
id|esp-&gt;ireg
comma
id|esp-&gt;sreg
comma
id|esp-&gt;seqreg
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;esp: penguin esp state.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;esp: detected penguin phase.&quot;
)paren
suffix:semicolon
r_goto
id|esp_handle_done
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;esp: Heading to the promised land.&quot;
)paren
suffix:semicolon
id|esp_handle_done
suffix:colon
id|DMA_IRQ_EXIT
c_func
(paren
id|esp-&gt;dma
comma
id|dregs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|esp_intr
r_static
r_void
id|esp_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|pregs
)paren
(brace
r_struct
id|Sparc_ESP
op_star
id|esp
suffix:semicolon
multiline_comment|/* Handle all ESP interrupts showing */
id|for_each_esp
c_func
(paren
id|esp
)paren
(brace
r_if
c_cond
(paren
id|DMA_IRQ_P
c_func
(paren
id|esp-&gt;dregs
)paren
)paren
(brace
id|esp_handle
c_func
(paren
id|esp
)paren
suffix:semicolon
)brace
)brace
)brace
eof
