multiline_comment|/*&n; * sim710.c - Copyright (C) 1999 Richard Hirst &lt;richard@sleepie.demon.co.uk&gt;&n; *&n; *----------------------------------------------------------------------------&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by &n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *----------------------------------------------------------------------------&n; *&n; * MCA card detection code by Trent McNair.&n; *&n; * Various bits of code in this driver have been copied from 53c7,8xx,c,&n; * which is coyright Drew Eckhardt.  The scripts for the SCSI chip are&n; * compiled with the script compiler written by Drew.&n; *&n; * This is a simple driver for the NCR53c710.  More complex drivers&n; * for this chip (e.g. 53c7xx.c) require that the scsi chip be able to&n; * do DMA block moves between memory and on-chip registers, which can&n; * be a problem if those registers are in the I/O address space.  There&n; * can also be problems on hardware where the registers are memory&n; * mapped, if the design is such that memory-to-memory transfers initiated&n; * by the scsi chip cannot access the chip registers.&n; *&n; * This driver is designed to avoid these problems and is intended to&n; * work with any Intel machines using 53c710 chips, including various&n; * Compaq and NCR machines.  It was initially written for the Tadpole&n; * TP34V VME board which is 68030 based.&n; *&n; * The driver supports boot-time parameters similar to&n; *&t;sim710=addr:0x9000,irq:15&n; * and insmod parameters similar to&n; *&t;sim710=&quot;addr:0x9000 irq:15&quot;&n; *&n; * The complete list of options are:&n; *&n; * addr:0x9000&t;&t;Specifies the base I/O port (or address) of the 53C710.&n; * irq:15&t;&t;Specifies the IRQ number used by the 53c710.&n; * debug:0xffff&t;&t;Generates lots of debug output.&n; * ignore:0x0a&t;&t;Makes the driver ignore SCSI IDs 0 and 2.&n; * nodisc:0x70&t;&t;Prevents disconnects from IDs 6, 5 and 4.&n; * noneg:0x10&t;&t;Prevents SDTR negotiation on ID 4.&n; *&n; * Current limitations:&n; *&n; * o  Async only&n; * o  Severely lacking in error recovery&n; * o  Auto detection of IRQs and chip addresses only on MCA architectures&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,17)
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#elif LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,93)
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#ifdef CONFIG_TP34V_SCSI
macro_line|#include &lt;asm/tp34vhw.h&gt;
DECL|macro|MEM_MAPPED
mdefine_line|#define MEM_MAPPED
macro_line|#elif defined(CONFIG_MCA)
DECL|macro|IO_MAPPED
mdefine_line|#define IO_MAPPED
multiline_comment|/*&n; * For each known microchannel card using the 53c710 we need a list&n; * of possible IRQ and IO settings, as well as their corresponding&n; * bit assignment in pos[].  This might get cumbersome if there&n; * are more than a few cards (I only know of 2 at this point).&n; */
DECL|macro|MCA_53C710_IDS
mdefine_line|#define MCA_53C710_IDS { 0x01bb, 0x01ba, 0x004f }
multiline_comment|/* CARD ID 01BB and 01BA use the same pos values */
DECL|macro|MCA_01BB_IO_PORTS
mdefine_line|#define MCA_01BB_IO_PORTS { 0x0000, 0x0000, 0x0800, 0x0C00, 0x1000, 0x1400, &bslash;&n;&t;&t;&t;    0x1800, 0x1C00, 0x2000, 0x2400, 0x2800, &bslash;&n;&t;&t;&t;    0x2C00, 0x3000, 0x3400, 0x3800, 0x3C00, &bslash;&n;&t;&t;&t;    0x4000, 0x4400, 0x4800, 0x4C00, 0x5000  }
DECL|macro|MCA_01BB_IRQS
mdefine_line|#define MCA_01BB_IRQS { 3, 5, 11, 14 }
multiline_comment|/* CARD ID 004f */
DECL|macro|MCA_004F_IO_PORTS
mdefine_line|#define MCA_004F_IO_PORTS { 0x0000, 0x0200, 0x0300, 0x0400, 0x0500,  0x0600 }
DECL|macro|MCA_004F_IRQS
mdefine_line|#define MCA_004F_IRQS { 5, 9, 14 }
macro_line|#else
multiline_comment|/* Assume an Intel platform */
DECL|macro|IO_MAPPED
mdefine_line|#define IO_MAPPED
macro_line|#endif
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;sim710.h&quot;
macro_line|#include&lt;linux/stat.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
DECL|macro|DEBUG_LIMIT_INTS
macro_line|#undef DEBUG_LIMIT_INTS&t;&t;/* Define to 10 to hang driver after 10 ints */
multiline_comment|/* Debug options available via the &quot;debug:0x1234&quot; parameter&t;&t;*/
DECL|macro|DEB_NONE
mdefine_line|#define DEB_NONE&t;0x0000&t;/* Nothing&t;&t;&t;&t;*/
DECL|macro|DEB_HALT
mdefine_line|#define DEB_HALT&t;0x0001&t;/* Detailed trace of chip halt funtion&t;*/
DECL|macro|DEB_REGS
mdefine_line|#define DEB_REGS&t;0x0002&t;/* All chip register read/writes&t;*/
DECL|macro|DEB_SYNC
mdefine_line|#define DEB_SYNC&t;0x0004&t;/* Sync/async negotiation&t;&t;*/
DECL|macro|DEB_PMM
mdefine_line|#define DEB_PMM&t;&t;0x0008&t;/* Phase mis-match handling&t;&t;*/
DECL|macro|DEB_INTS
mdefine_line|#define DEB_INTS&t;0x0010&t;/* General interrupt trace&t;&t;*/
DECL|macro|DEB_TOUT
mdefine_line|#define DEB_TOUT&t;0x0020&t;/* Selection timeouts&t;&t;&t;*/
DECL|macro|DEB_RESUME
mdefine_line|#define DEB_RESUME&t;0x0040&t;/* Resume addresses for the script&t;*/
DECL|macro|DEB_CMND
mdefine_line|#define DEB_CMND&t;0x0080&t;/* Commands and status returned&t;&t;*/
DECL|macro|DEB_FIXUP
mdefine_line|#define DEB_FIXUP&t;0x0100&t;/* Fixup of scsi addresses&t;&t;*/
DECL|macro|DEB_DISC
mdefine_line|#define DEB_DISC&t;0x0200&t;/* Disconnect/reselect handling&t;&t;*/
DECL|macro|DEB_ANY
mdefine_line|#define DEB_ANY&t;&t;0xffff&t;/* Any and all debug options&t;&t;*/
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(m,x) if (sim710_debug &amp; m) x
DECL|variable|sim710_debug
r_int
id|sim710_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(m,x)
macro_line|#endif
multiline_comment|/* Redefine scsi_done to force renegotiation of (a)sync transfers&n; * following any failed command.&n; */
DECL|macro|SCSI_DONE
mdefine_line|#define SCSI_DONE(cmd)&t;{ &bslash;&n;&t;DEB(DEB_CMND, printk(&quot;scsi%d: Complete %08x&bslash;n&quot;, &bslash;&n;&t;&t;host-&gt;host_no, cmd-&gt;result)); &bslash;&n;&t;if (cmd-&gt;result) &bslash;&n;&t;    hostdata-&gt;negotiate |= (1 &lt;&lt; cmd-&gt;target); &bslash;&n;&t;cmd-&gt;scsi_done(cmd); &bslash;&n;    }
macro_line|#ifndef offsetof
DECL|macro|offsetof
mdefine_line|#define offsetof(t, m)      ((size_t) (&amp;((t *)0)-&gt;m))
macro_line|#endif
DECL|macro|STATE_INITIALISED
mdefine_line|#define STATE_INITIALISED&t;0
DECL|macro|STATE_HALTED
mdefine_line|#define STATE_HALTED&t;&t;1
DECL|macro|STATE_IDLE
mdefine_line|#define STATE_IDLE&t;&t;2
DECL|macro|STATE_BUSY
mdefine_line|#define STATE_BUSY&t;&t;3
DECL|macro|STATE_DISABLED
mdefine_line|#define STATE_DISABLED&t;&t;4
DECL|macro|MAXBOARDS
mdefine_line|#define MAXBOARDS 2&t;/* Increase this and the sizes of the&n;&t;&t;&t;   arrays below, if you need more.. */
macro_line|#ifdef MODULE
DECL|variable|sim710
r_char
op_star
id|sim710
suffix:semicolon
multiline_comment|/* command line passed by insmod */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Richard Hirst&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Simple NCR53C710 driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sim710
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|sim710_errors
r_static
r_int
id|sim710_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Count of error interrupts */
DECL|variable|sim710_intrs
r_static
r_int
id|sim710_intrs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Count of all interrupts */
DECL|variable|ignore_ids
r_static
r_int
id|ignore_ids
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Accept all SCSI IDs */
DECL|variable|opt_nodisc
r_static
r_int
id|opt_nodisc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allow disconnect on all IDs */
DECL|variable|opt_noneg
r_static
r_int
id|opt_noneg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allow SDTR negotiation on all IDs */
macro_line|#ifdef CONFIG_TP34V_SCSI
multiline_comment|/* Special hardwired case for Tadpole TP34V at the moment, otherwise&n; * boot parameters &squot;sim710=addr:0x8000,irq:15&squot; (for example) must be given.&n; */
DECL|variable|no_of_boards
r_static
r_int
id|no_of_boards
op_assign
l_int|2
suffix:semicolon
DECL|variable|bases
r_static
r_int
r_int
id|bases
(braket
id|MAXBOARDS
)braket
op_assign
(brace
id|TP34V_SCSI0_BASE
comma
id|TP34V_SCSI1_BASE
)brace
suffix:semicolon
DECL|variable|irq_vectors
r_static
r_int
r_int
id|irq_vectors
(braket
id|MAXBOARDS
)braket
op_assign
(brace
id|TP34V_SCSI0_VECTOR
comma
id|TP34V_SCSI1_VECTOR
)brace
suffix:semicolon
DECL|variable|irq_index
r_static
r_int
r_int
id|irq_index
(braket
id|MAXBOARDS
)braket
op_assign
(brace
id|TP34V_SCSI0_IRQ_INDEX
comma
id|TP34V_SCSI1_IRQ_INDEX
)brace
suffix:semicolon
macro_line|#else
multiline_comment|/* All other cases use boot/module params, or auto-detect */
DECL|variable|no_of_boards
r_static
r_int
id|no_of_boards
op_assign
l_int|0
suffix:semicolon
DECL|variable|bases
r_static
r_int
r_int
id|bases
(braket
id|MAXBOARDS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|irq_vectors
r_static
r_int
r_int
id|irq_vectors
(braket
id|MAXBOARDS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* The SCSI Script!!! */
macro_line|#include &quot;sim710_d.h&quot;
multiline_comment|/* Now define offsets in the DSA, as (A_dsa_xxx/4) */
DECL|macro|DSA_SELECT
mdefine_line|#define DSA_SELECT&t;(A_dsa_select/4)
DECL|macro|DSA_MSGOUT
mdefine_line|#define DSA_MSGOUT&t;(A_dsa_msgout/4)
DECL|macro|DSA_CMND
mdefine_line|#define DSA_CMND&t;(A_dsa_cmnd/4)
DECL|macro|DSA_STATUS
mdefine_line|#define DSA_STATUS&t;(A_dsa_status/4)
DECL|macro|DSA_MSGIN
mdefine_line|#define DSA_MSGIN&t;(A_dsa_msgin/4)
DECL|macro|DSA_DATAIN
mdefine_line|#define DSA_DATAIN&t;(A_dsa_datain/4)
DECL|macro|DSA_DATAOUT
mdefine_line|#define DSA_DATAOUT&t;(A_dsa_dataout/4)
DECL|macro|DSA_SIZE
mdefine_line|#define DSA_SIZE&t;(A_dsa_size/4)
DECL|macro|MAX_SG
mdefine_line|#define MAX_SG&t;&t;128&t;/* Scatter/Gather elements */
DECL|macro|MAX_MSGOUT
mdefine_line|#define MAX_MSGOUT&t;8
DECL|macro|MAX_MSGIN
mdefine_line|#define MAX_MSGIN&t;8
DECL|macro|MAX_CMND
mdefine_line|#define MAX_CMND&t;12
DECL|macro|MAX_STATUS
mdefine_line|#define MAX_STATUS&t;1
DECL|struct|sim710_hostdata
r_struct
id|sim710_hostdata
(brace
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|issue_queue
id|Scsi_Cmnd
op_star
id|issue_queue
suffix:semicolon
DECL|member|running
id|Scsi_Cmnd
op_star
id|running
suffix:semicolon
DECL|member|chip
r_int
id|chip
suffix:semicolon
DECL|member|negotiate
id|u8
id|negotiate
suffix:semicolon
DECL|member|reselected_identify
id|u8
id|reselected_identify
suffix:semicolon
DECL|member|msgin_buf
id|u8
id|msgin_buf
(braket
id|MAX_MSGIN
)braket
suffix:semicolon
DECL|struct|sim710_target
r_struct
id|sim710_target
(brace
DECL|member|cur_cmd
id|Scsi_Cmnd
op_star
id|cur_cmd
suffix:semicolon
DECL|member|resume_offset
id|u32
id|resume_offset
suffix:semicolon
DECL|member|data_in_jump
id|u32
id|data_in_jump
suffix:semicolon
DECL|member|data_out_jump
id|u32
id|data_out_jump
suffix:semicolon
DECL|member|dsa
id|u32
id|dsa
(braket
id|DSA_SIZE
)braket
suffix:semicolon
multiline_comment|/* SCSI Script DSA area */
DECL|member|dsa_msgout
id|u8
id|dsa_msgout
(braket
id|MAX_MSGOUT
)braket
suffix:semicolon
DECL|member|dsa_msgin
id|u8
id|dsa_msgin
(braket
id|MAX_MSGIN
)braket
suffix:semicolon
DECL|member|dsa_cdb
id|u8
id|dsa_cdb
(braket
id|MAX_CMND
)braket
suffix:semicolon
DECL|member|dsa_status
id|u8
id|dsa_status
(braket
id|MAX_STATUS
)braket
suffix:semicolon
DECL|member|target
)brace
id|target
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|script
id|u32
id|script
(braket
r_sizeof
(paren
id|SCRIPT
)paren
op_div
l_int|4
)braket
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Template to request asynchronous transfers */
DECL|variable|async_message
r_static
r_const
r_int
r_char
id|async_message
(braket
)braket
op_assign
(brace
id|EXTENDED_MESSAGE
comma
l_int|3
multiline_comment|/* length */
comma
id|EXTENDED_SDTR
comma
l_int|0
comma
l_int|0
multiline_comment|/* asynchronous */
)brace
suffix:semicolon
r_static
r_void
id|sim710_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|do_sim710_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|run_process_issue_queue
c_func
(paren
r_struct
id|sim710_hostdata
op_star
)paren
suffix:semicolon
r_static
r_void
id|process_issue_queue
(paren
r_struct
id|sim710_hostdata
op_star
comma
r_int
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|full_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
multiline_comment|/*&n; * Function: int param_setup(char *str)&n; */
macro_line|#ifdef MODULE
DECL|macro|ARG_SEP
mdefine_line|#define ARG_SEP &squot; &squot;
macro_line|#else
DECL|macro|ARG_SEP
mdefine_line|#define ARG_SEP &squot;,&squot;
macro_line|#endif
r_static
r_int
DECL|function|param_setup
id|param_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|cur
op_assign
id|str
suffix:semicolon
r_char
op_star
id|pc
comma
op_star
id|pv
suffix:semicolon
r_int
id|val
suffix:semicolon
r_int
id|base
suffix:semicolon
r_int
id|c
suffix:semicolon
id|no_of_boards
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_ne
l_int|NULL
op_logical_and
(paren
id|pc
op_assign
id|strchr
c_func
(paren
id|cur
comma
l_char|&squot;:&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_char
op_star
id|pe
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|pv
op_assign
id|pc
suffix:semicolon
id|c
op_assign
op_star
op_increment
id|pv
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;n&squot;
)paren
id|val
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;y&squot;
)paren
id|val
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|base
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|pv
comma
op_amp
id|pe
comma
id|base
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;addr:&quot;
comma
l_int|5
)paren
)paren
(brace
id|bases
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
id|no_of_boards
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;irq:&quot;
comma
l_int|4
)paren
)paren
id|irq_vectors
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;ignore:&quot;
comma
l_int|7
)paren
)paren
id|ignore_ids
op_assign
id|val
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;nodisc:&quot;
comma
l_int|7
)paren
)paren
id|opt_nodisc
op_assign
id|val
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;noneg:&quot;
comma
l_int|6
)paren
)paren
id|opt_noneg
op_assign
id|val
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;disabled:&quot;
comma
l_int|5
)paren
)paren
(brace
id|no_of_boards
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|cur
comma
l_string|&quot;debug:&quot;
comma
l_int|6
)paren
)paren
(brace
id|sim710_debug
op_assign
id|val
suffix:semicolon
)brace
macro_line|#endif
r_else
id|printk
c_func
(paren
l_string|&quot;sim710: unexpected boot option &squot;%.*s&squot; ignored&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|pc
op_minus
id|cur
op_plus
l_int|1
)paren
comma
id|cur
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|strchr
c_func
(paren
id|cur
comma
id|ARG_SEP
)paren
)paren
op_ne
l_int|NULL
)paren
op_increment
id|cur
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,13)
macro_line|#ifndef MODULE
id|__setup
c_func
(paren
l_string|&quot;sim710=&quot;
comma
id|param_setup
)paren
suffix:semicolon
macro_line|#endif
macro_line|#else
multiline_comment|/* Old boot param syntax support */
r_void
DECL|function|sim710_setup
id|sim710_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|param_setup
c_func
(paren
id|str
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Function: static const char *sbcl_to_phase (int sbcl)&n; */
r_static
r_const
r_char
op_star
DECL|function|sbcl_to_phase
id|sbcl_to_phase
(paren
r_int
id|sbcl
)paren
(brace
r_switch
c_cond
(paren
id|sbcl
op_amp
id|SBCL_PHASE_MASK
)paren
(brace
r_case
id|SBCL_PHASE_DATAIN
suffix:colon
r_return
l_string|&quot;DATAIN&quot;
suffix:semicolon
r_case
id|SBCL_PHASE_DATAOUT
suffix:colon
r_return
l_string|&quot;DATAOUT&quot;
suffix:semicolon
r_case
id|SBCL_PHASE_MSGIN
suffix:colon
r_return
l_string|&quot;MSGIN&quot;
suffix:semicolon
r_case
id|SBCL_PHASE_MSGOUT
suffix:colon
r_return
l_string|&quot;MSGOUT&quot;
suffix:semicolon
r_case
id|SBCL_PHASE_CMDOUT
suffix:colon
r_return
l_string|&quot;CMDOUT&quot;
suffix:semicolon
r_case
id|SBCL_PHASE_STATIN
suffix:colon
r_return
l_string|&quot;STATUSIN&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;unknown&quot;
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function: static void disable (struct Scsi_Host *host)&n; */
r_static
r_void
DECL|function|disable
id|disable
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_DISABLED
suffix:semicolon
id|printk
(paren
id|KERN_ALERT
l_string|&quot;scsi%d : disabled.  Unload and reload&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : static int ncr_halt (struct Scsi_Host *host)&n; *&n; * Purpose : halts the SCSI SCRIPTS(tm) processor on the NCR chip&n; *&n; * Inputs : host - SCSI chip to halt&n; *&n; * Returns : 0 on success&n; */
r_static
r_int
DECL|function|ncr_halt
id|ncr_halt
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|istat
comma
id|tmp
suffix:semicolon
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|stage
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Stage 0 : eat all interrupts&n;       Stage 1 : set ABORT&n;       Stage 2 : eat all but abort interrupts&n;       Stage 3 : eat all interrupts&n;     */
r_for
c_loop
(paren
id|stage
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|stage
op_eq
l_int|1
)paren
(brace
id|DEB
c_func
(paren
id|DEB_HALT
comma
id|printk
c_func
(paren
l_string|&quot;ncr_halt: writing ISTAT_ABRT&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|ISTAT_REG
comma
id|ISTAT_ABRT
)paren
suffix:semicolon
op_increment
id|stage
suffix:semicolon
)brace
id|istat
op_assign
id|NCR_read8
(paren
id|ISTAT_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|istat
op_amp
id|ISTAT_SIP
)paren
(brace
id|DEB
c_func
(paren
id|DEB_HALT
comma
id|printk
c_func
(paren
l_string|&quot;ncr_halt: got ISTAT_SIP, istat=%02x&bslash;n&quot;
comma
id|istat
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|NCR_read8
c_func
(paren
id|SSTAT0_REG
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_HALT
comma
id|printk
c_func
(paren
l_string|&quot;ncr_halt: got SSTAT0_REG=%02x&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|istat
op_amp
id|ISTAT_DIP
)paren
(brace
id|DEB
c_func
(paren
id|DEB_HALT
comma
id|printk
c_func
(paren
l_string|&quot;ncr_halt: got ISTAT_DIP, istat=%02x&bslash;n&quot;
comma
id|istat
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|NCR_read8
c_func
(paren
id|DSTAT_REG
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_HALT
comma
id|printk
c_func
(paren
l_string|&quot;ncr_halt: got DSTAT_REG=%02x&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stage
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|tmp
op_amp
id|DSTAT_ABRT
)paren
(brace
id|DEB
c_func
(paren
id|DEB_HALT
comma
id|printk
c_func
(paren
l_string|&quot;ncr_halt: got DSTAT_ABRT, clearing istat&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|ISTAT_REG
comma
l_int|0
)paren
suffix:semicolon
op_increment
id|stage
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;scsi%d : could not halt NCR chip&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|disable
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|istat
op_amp
(paren
id|ISTAT_SIP
op_or
id|ISTAT_DIP
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|stage
op_eq
l_int|0
)paren
op_increment
id|stage
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stage
op_eq
l_int|3
)paren
r_break
suffix:semicolon
)brace
)brace
id|hostdata-&gt;state
op_assign
id|STATE_HALTED
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : static void sim710_soft_reset (struct Scsi_Host *host)&n; *&n; * Purpose :  perform a soft reset of the NCR53c7xx chip&n; *&n; * Inputs : host - pointer to this host adapter&squot;s structure&n; *&n; * Preconditions : sim710_init must have been called for this&n; *      host.&n; *&n; */
r_static
r_void
DECL|function|sim710_soft_reset
id|sim710_soft_reset
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CONFIG_TP34V_SCSI
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_TP34V_SCSI
id|tpvic.loc_icr
(braket
id|irq_index
(braket
id|hostdata-&gt;chip
)braket
)braket
dot
id|icr
op_assign
l_int|0x80
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     * Do a soft reset of the chip so that everything is&n;     * reinitialized to the power-on state.&n;     *&n;     * Basically follow the procedure outlined in the NCR53c700&n;     * data manual under Chapter Six, How to Use, Steps Necessary to&n;     * Start SCRIPTS, with the exception of actually starting the&n;     * script and setting up the synchronous transfer gunk.&n;     */
multiline_comment|/* XXX Should we reset the scsi bus here? */
id|NCR_write8
c_func
(paren
id|SCNTL1_REG
comma
id|SCNTL1_RST
)paren
suffix:semicolon
multiline_comment|/* Reset the bus */
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SCNTL1_REG
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|ISTAT_REG
comma
id|ISTAT_10_SRST
)paren
suffix:semicolon
multiline_comment|/* Reset the chip */
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|ISTAT_REG
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Let devices recover */
id|NCR_write8
c_func
(paren
id|DCNTL_REG
comma
id|DCNTL_10_COM
op_or
id|DCNTL_700_CF_3
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|CTEST7_REG
comma
id|CTEST7_10_CDIS
op_or
id|CTEST7_STD
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|DMODE_REG
comma
id|DMODE_10_BL_8
op_or
id|DMODE_10_FC2
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SCID_REG
comma
l_int|1
op_lshift
id|host-&gt;this_id
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SBCL_REG
comma
l_int|0
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SXFER_REG
comma
l_int|0
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SCNTL1_REG
comma
id|SCNTL1_ESR_700
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SCNTL0_REG
comma
id|SCNTL0_EPC
op_or
id|SCNTL0_EPG_700
op_or
id|SCNTL0_ARB1
op_or
id|SCNTL0_ARB2
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|DIEN_REG
comma
id|DIEN_700_BF
op_or
id|DIEN_ABRT
op_or
id|DIEN_SSI
op_or
id|DIEN_SIR
op_or
id|DIEN_700_OPC
)paren
suffix:semicolon
id|NCR_write8
c_func
(paren
id|SIEN_REG_700
comma
id|SIEN_PAR
op_or
id|SIEN_700_STO
op_or
id|SIEN_RST
op_or
id|SIEN_UDC
op_or
id|SIEN_SGE
op_or
id|SIEN_MA
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_TP34V_SCSI
id|tpvic.loc_icr
(braket
id|irq_index
(braket
id|hostdata-&gt;chip
)braket
)braket
dot
id|icr
op_assign
l_int|0x30
op_or
id|TP34V_SCSI0n1_IPL
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : static void sim710_driver_init (struct Scsi_Host *host)&n; *&n; * Purpose : Initialize internal structures, as required on startup, or&n; *&t;after a SCSI bus reset.&n; *&n; * Inputs : host - pointer to this host adapter&squot;s structure&n; */
r_static
r_void
DECL|function|sim710_driver_init
id|sim710_driver_init
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hostdata-&gt;running
op_assign
l_int|NULL
suffix:semicolon
id|memcpy
(paren
id|hostdata-&gt;script
comma
id|SCRIPT
comma
r_sizeof
(paren
id|SCRIPT
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PATCHES
suffix:semicolon
id|i
op_increment
)paren
id|hostdata-&gt;script
(braket
id|LABELPATCHES
(braket
id|i
)braket
)braket
op_add_assign
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
)paren
suffix:semicolon
id|patch_abs_32
(paren
id|hostdata-&gt;script
comma
l_int|0
comma
id|reselected_identify
comma
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
(paren
id|hostdata-&gt;reselected_identify
)paren
)paren
)paren
suffix:semicolon
id|patch_abs_32
(paren
id|hostdata-&gt;script
comma
l_int|0
comma
id|msgin_buf
comma
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
(paren
id|hostdata-&gt;msgin_buf
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_INITIALISED
suffix:semicolon
id|hostdata-&gt;negotiate
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* Handle incoming Synchronous data transfer request.  If our negotiate&n; * flag is set then this is a response to our request, otherwise it is&n; * spurious request from the target.  Don&squot;t really expect target initiated&n; * SDTRs, because we always negotiate on the first command.  Could still&n; * get them though..&n; * The chip is currently paused with ACK asserted o the last byte of the&n; * SDTR.&n; * resa is the resume address if the message is in response to our outgoing&n; * SDTR.  Only possible on initial identify.&n; * resb is the resume address if the message exchange is initiated by the&n; * target.&n; */
r_static
id|u32
DECL|function|handle_sdtr
id|handle_sdtr
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
id|u32
id|resa
comma
id|u32
id|resb
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|sim710_target
op_star
id|targdata
op_assign
id|hostdata-&gt;target
op_plus
id|cmd-&gt;target
suffix:semicolon
id|u32
id|resume_offset
suffix:semicolon
r_if
c_cond
(paren
id|resa
op_logical_and
id|hostdata-&gt;negotiate
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
)paren
(brace
id|DEB
c_func
(paren
id|DEB_SYNC
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Response to host SDTR = %02x %02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|hostdata-&gt;msgin_buf
(braket
l_int|3
)braket
comma
id|hostdata-&gt;msgin_buf
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* We always issue an SDTR with the identify, so we must issue&n;&t; * the CDB next.&n;&t; */
id|resume_offset
op_assign
id|resa
suffix:semicolon
id|hostdata-&gt;negotiate
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEB
c_func
(paren
id|DEB_SYNC
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Target initiated SDTR = %02x %02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|hostdata-&gt;msgin_buf
(braket
l_int|3
)braket
comma
id|hostdata-&gt;msgin_buf
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|targdata-&gt;dsa_msgout
comma
id|async_message
comma
r_sizeof
(paren
id|async_message
)paren
)paren
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_MSGOUT
)braket
op_assign
r_sizeof
(paren
id|async_message
)paren
suffix:semicolon
multiline_comment|/* I guess the target could do this anytime; we have to send our&n;&t; * response, and then continue (sending the CDB if not already done).&n;&t; */
id|resume_offset
op_assign
id|resb
suffix:semicolon
)brace
r_return
id|resume_offset
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : static int datapath_residual (Scsi_Host *host)&n; *&n; * Purpose : return residual data count of what&squot;s in the chip.&n; *&n; * Inputs : host - SCSI host&n; */
r_static
r_int
DECL|function|datapath_residual
id|datapath_residual
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_int
id|count
comma
id|synchronous
comma
id|sstat
suffix:semicolon
r_int
r_int
id|ddir
suffix:semicolon
id|count
op_assign
(paren
(paren
id|NCR_read8
(paren
id|DFIFO_REG
)paren
op_amp
id|DFIFO_10_BO_MASK
)paren
op_minus
(paren
id|NCR_read32
(paren
id|DBC_REG
)paren
op_amp
id|DFIFO_10_BO_MASK
)paren
)paren
op_amp
id|DFIFO_10_BO_MASK
suffix:semicolon
id|synchronous
op_assign
id|NCR_read8
(paren
id|SXFER_REG
)paren
op_amp
id|SXFER_MO_MASK
suffix:semicolon
id|ddir
op_assign
id|NCR_read8
(paren
id|CTEST0_REG_700
)paren
op_amp
id|CTEST0_700_DDIR
suffix:semicolon
r_if
c_cond
(paren
id|ddir
)paren
(brace
multiline_comment|/* Receive */
r_if
c_cond
(paren
id|synchronous
)paren
id|count
op_add_assign
(paren
id|NCR_read8
(paren
id|SSTAT2_REG
)paren
op_amp
id|SSTAT2_FF_MASK
)paren
op_rshift
id|SSTAT2_FF_SHIFT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|NCR_read8
(paren
id|SSTAT1_REG
)paren
op_amp
id|SSTAT1_ILF
)paren
op_increment
id|count
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Send */
id|sstat
op_assign
id|NCR_read8
(paren
id|SSTAT1_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sstat
op_amp
id|SSTAT1_OLF
)paren
op_increment
id|count
suffix:semicolon
r_if
c_cond
(paren
id|synchronous
op_logical_and
(paren
id|sstat
op_amp
id|SSTAT1_ORF
)paren
)paren
op_increment
id|count
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
r_static
id|u32
DECL|function|handle_idd
id|handle_idd
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|sim710_target
op_star
id|targdata
op_assign
id|hostdata-&gt;target
op_plus
id|cmd-&gt;target
suffix:semicolon
id|u32
id|resume_offset
op_assign
l_int|0
comma
id|index
suffix:semicolon
id|index
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u32
op_star
)paren
(paren
id|bus_to_virt
c_func
(paren
id|NCR_read32
c_func
(paren
id|DSP_REG
)paren
)paren
)paren
op_minus
id|hostdata-&gt;script
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|index
)paren
(brace
r_case
id|Ent_wait_disc_complete
op_div
l_int|4
op_plus
l_int|2
suffix:colon
id|cmd-&gt;result
op_assign
id|targdata-&gt;dsa_status
(braket
l_int|0
)braket
suffix:semicolon
id|SCSI_DONE
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|targdata-&gt;cur_cmd
op_assign
l_int|NULL
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_wait_disc2
op_div
l_int|4
op_plus
l_int|2
suffix:colon
multiline_comment|/* Disconnect after command - just wait for a reselect */
id|targdata-&gt;resume_offset
op_assign
id|Ent_resume_msgin2a
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_wait_disc3
op_div
l_int|4
op_plus
l_int|2
suffix:colon
multiline_comment|/* Disconnect after the data phase */
id|targdata-&gt;resume_offset
op_assign
id|Ent_resume_msgin3a
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_wait_disc1
op_div
l_int|4
op_plus
l_int|2
suffix:colon
multiline_comment|/* Disconnect before command - not expected */
id|targdata-&gt;resume_offset
op_assign
id|Ent_resume_msgin1a
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unexpected Illegal Instruction, script[%04x]&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|index
)paren
suffix:semicolon
id|sim710_errors
op_increment
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause host reset */
)brace
r_return
id|resume_offset
suffix:semicolon
)brace
multiline_comment|/* Handle a phase mismatch.&n; */
r_static
id|u32
DECL|function|handle_phase_mismatch
id|handle_phase_mismatch
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|sim710_target
op_star
id|targdata
op_assign
id|hostdata-&gt;target
op_plus
id|cmd-&gt;target
suffix:semicolon
id|u32
id|resume_offset
op_assign
l_int|0
comma
id|index
suffix:semicolon
r_int
r_char
id|sbcl
suffix:semicolon
id|sbcl
op_assign
id|NCR_read8
c_func
(paren
id|SBCL_REG
)paren
op_amp
id|SBCL_PHASE_MASK
suffix:semicolon
id|index
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u32
op_star
)paren
(paren
id|bus_to_virt
c_func
(paren
id|NCR_read32
c_func
(paren
id|DSP_REG
)paren
)paren
)paren
op_minus
id|hostdata-&gt;script
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_PMM
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Phase mismatch, phase %s (%x) at script[0x%x]&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sbcl_to_phase
c_func
(paren
id|sbcl
)paren
comma
id|sbcl
comma
id|index
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_PMM
comma
id|print_command
c_func
(paren
id|cmd-&gt;cmnd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|Ent_done_ident
op_div
l_int|4
)paren
(brace
multiline_comment|/* Sending initial message out - probably rejecting our sync&n;&t; * negotiation request.&n;&t; */
id|NCR_write8
c_func
(paren
id|SOCL_REG
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Negate ATN */
r_if
c_cond
(paren
id|sbcl
op_eq
id|SBCL_PHASE_MSGIN
)paren
id|resume_offset
op_assign
id|Ent_resume_rej_ident
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sbcl
op_eq
id|SBCL_PHASE_CMDOUT
)paren
(brace
multiline_comment|/* Some old devices (SQ555) switch to cmdout after the first&n;&t;     * byte of an identify message, regardless of whether we&n;&t;     * have more bytes to send!&n;&t;     */
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unexpected switch to CMDOUT during IDENTIFY&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|resume_offset
op_assign
id|Ent_resume_cmd
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unexpected phase change to %s on initial msgout&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sbcl_to_phase
c_func
(paren
id|sbcl
)paren
)paren
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
id|hostdata-&gt;negotiate
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|index
OG
id|Ent_patch_input_data
op_div
l_int|4
op_logical_and
id|index
OL
id|Ent_patch_output_data
op_div
l_int|4
)paren
(brace
multiline_comment|/* DataIn transfer phase */
id|u32
id|sg_id
comma
id|oaddr
comma
id|olen
comma
id|naddr
comma
id|nlen
suffix:semicolon
r_int
id|residual
suffix:semicolon
id|sg_id
op_assign
(paren
id|index
op_minus
id|Ent_patch_input_data
op_div
l_int|4
op_minus
l_int|4
)paren
op_div
l_int|2
suffix:semicolon
id|targdata-&gt;data_in_jump
op_assign
id|hostdata-&gt;script
(braket
id|Ent_patch_input_data
op_div
l_int|4
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|Ent_patch_input_data
op_div
l_int|4
op_plus
id|sg_id
op_star
l_int|2
op_plus
l_int|2
)paren
suffix:semicolon
id|olen
op_assign
id|targdata-&gt;dsa
(braket
id|DSA_DATAIN
op_plus
id|sg_id
op_star
l_int|2
)braket
suffix:semicolon
id|oaddr
op_assign
id|targdata-&gt;dsa
(braket
id|DSA_DATAIN
op_plus
id|sg_id
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
id|residual
op_assign
id|datapath_residual
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|residual
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: Residual count %d on DataIn - NOT expected!!!&quot;
comma
id|host-&gt;host_no
comma
id|residual
)paren
suffix:semicolon
id|naddr
op_assign
id|NCR_read32
c_func
(paren
id|DNAD_REG
)paren
op_minus
id|residual
suffix:semicolon
id|nlen
op_assign
(paren
id|NCR_read32
c_func
(paren
id|DBC_REG
)paren
op_amp
l_int|0x00ffffff
)paren
op_plus
id|residual
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_PMM
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: DIN sg %d, old %08x/%08x, new %08x/%08x (%d)&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sg_id
comma
id|oaddr
comma
id|olen
comma
id|naddr
comma
id|nlen
comma
id|residual
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oaddr
op_plus
id|olen
op_ne
id|naddr
op_plus
id|nlen
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: PMM DIN counts error: 0x%x + 0x%x != 0x%x + 0x%x&quot;
comma
id|host-&gt;host_no
comma
id|oaddr
comma
id|olen
comma
id|naddr
comma
id|nlen
)paren
suffix:semicolon
)brace
r_else
(brace
id|targdata-&gt;dsa
(braket
id|DSA_DATAIN
op_plus
id|sg_id
op_star
l_int|2
)braket
op_assign
id|nlen
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_DATAIN
op_plus
id|sg_id
op_star
l_int|2
op_plus
l_int|1
)braket
op_assign
id|naddr
suffix:semicolon
id|resume_offset
op_assign
id|Ent_resume_pmm
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|index
OG
id|Ent_patch_output_data
op_div
l_int|4
op_logical_and
id|index
op_le
id|Ent_end_data_trans
op_div
l_int|4
)paren
(brace
multiline_comment|/* Dataout transfer phase */
id|u32
id|sg_id
comma
id|oaddr
comma
id|olen
comma
id|naddr
comma
id|nlen
suffix:semicolon
r_int
id|residual
suffix:semicolon
id|sg_id
op_assign
(paren
id|index
op_minus
id|Ent_patch_output_data
op_div
l_int|4
op_minus
l_int|4
)paren
op_div
l_int|2
suffix:semicolon
id|targdata-&gt;data_out_jump
op_assign
id|hostdata-&gt;script
(braket
id|Ent_patch_output_data
op_div
l_int|4
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|Ent_patch_output_data
op_div
l_int|4
op_plus
id|sg_id
op_star
l_int|2
op_plus
l_int|2
)paren
suffix:semicolon
id|olen
op_assign
id|targdata-&gt;dsa
(braket
id|DSA_DATAOUT
op_plus
id|sg_id
op_star
l_int|2
)braket
suffix:semicolon
id|oaddr
op_assign
id|targdata-&gt;dsa
(braket
id|DSA_DATAOUT
op_plus
id|sg_id
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
id|residual
op_assign
id|datapath_residual
(paren
id|host
)paren
suffix:semicolon
id|naddr
op_assign
id|NCR_read32
c_func
(paren
id|DNAD_REG
)paren
op_minus
id|residual
suffix:semicolon
id|nlen
op_assign
(paren
id|NCR_read32
c_func
(paren
id|DBC_REG
)paren
op_amp
l_int|0x00ffffff
)paren
op_plus
id|residual
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_PMM
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: DOUT sg %d, old %08x/%08x, new %08x/%08x (%d)&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sg_id
comma
id|oaddr
comma
id|olen
comma
id|naddr
comma
id|nlen
comma
id|residual
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oaddr
op_plus
id|olen
op_ne
id|naddr
op_plus
id|nlen
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: PMM DOUT counts error: 0x%x + 0x%x != 0x%x + 0x%x&quot;
comma
id|host-&gt;host_no
comma
id|oaddr
comma
id|olen
comma
id|naddr
comma
id|nlen
)paren
suffix:semicolon
)brace
r_else
(brace
id|targdata-&gt;dsa
(braket
id|DSA_DATAOUT
op_plus
id|sg_id
op_star
l_int|2
)braket
op_assign
id|nlen
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_DATAOUT
op_plus
id|sg_id
op_star
l_int|2
op_plus
l_int|1
)braket
op_assign
id|naddr
suffix:semicolon
id|resume_offset
op_assign
id|Ent_resume_pmm
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unexpected phase change to %s at index 0x%x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sbcl_to_phase
c_func
(paren
id|sbcl
)paren
comma
id|index
)paren
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
multiline_comment|/* Flush DMA FIFO */
id|NCR_write8
(paren
id|CTEST8_REG
comma
id|CTEST8_10_CLF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|NCR_read8
(paren
id|CTEST8_REG
)paren
op_amp
id|CTEST8_10_CLF
)paren
suffix:semicolon
r_return
id|resume_offset
suffix:semicolon
)brace
r_static
id|u32
DECL|function|handle_script_int
id|handle_script_int
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|sim710_target
op_star
id|targdata
op_assign
id|hostdata-&gt;target
op_plus
id|cmd-&gt;target
suffix:semicolon
id|u32
id|dsps
comma
id|resume_offset
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|sbcl
suffix:semicolon
id|dsps
op_assign
id|NCR_read32
c_func
(paren
id|DSPS_REG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dsps
)paren
(brace
r_case
id|A_int_cmd_complete
suffix:colon
id|cmd-&gt;result
op_assign
id|targdata-&gt;dsa_status
(braket
l_int|0
)braket
suffix:semicolon
id|SCSI_DONE
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|targdata-&gt;cur_cmd
op_assign
l_int|NULL
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_msg_sdtr1
suffix:colon
id|resume_offset
op_assign
id|handle_sdtr
c_func
(paren
id|host
comma
id|cmd
comma
id|Ent_resume_msgin1a
comma
id|Ent_resume_msgin1b
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_msg_sdtr2
suffix:colon
id|resume_offset
op_assign
id|handle_sdtr
c_func
(paren
id|host
comma
id|cmd
comma
l_int|0
comma
id|Ent_resume_msgin2b
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_msg_sdtr3
suffix:colon
id|resume_offset
op_assign
id|handle_sdtr
c_func
(paren
id|host
comma
id|cmd
comma
l_int|0
comma
id|Ent_resume_msgin3b
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_disc1
suffix:colon
multiline_comment|/* Disconnect before command - not expected */
id|targdata-&gt;resume_offset
op_assign
id|Ent_resume_msgin1a
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_disc2
suffix:colon
multiline_comment|/* Disconnect after command - just wait for a reselect */
id|targdata-&gt;resume_offset
op_assign
id|Ent_resume_msgin2a
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_disc3
suffix:colon
multiline_comment|/* Disconnect after the data phase */
id|targdata-&gt;resume_offset
op_assign
id|Ent_resume_msgin3a
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_reselected
suffix:colon
id|hostdata-&gt;script
(braket
id|Ent_patch_output_data
op_div
l_int|4
op_plus
l_int|1
)braket
op_assign
id|targdata-&gt;data_out_jump
suffix:semicolon
id|hostdata-&gt;script
(braket
id|Ent_patch_input_data
op_div
l_int|4
op_plus
l_int|1
)braket
op_assign
id|targdata-&gt;data_in_jump
suffix:semicolon
id|NCR_write32
c_func
(paren
id|DSA_REG
comma
id|virt_to_bus
c_func
(paren
id|targdata-&gt;dsa
)paren
)paren
suffix:semicolon
id|resume_offset
op_assign
id|targdata-&gt;resume_offset
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_data_bad_phase
suffix:colon
id|sbcl
op_assign
id|NCR_read8
c_func
(paren
id|SBCL_REG
)paren
op_amp
id|SBCL_PHASE_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: int_data_bad_phase, phase %s (%x)&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sbcl_to_phase
c_func
(paren
id|sbcl
)paren
comma
id|sbcl
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_int_bad_extmsg1a
suffix:colon
r_case
id|A_int_bad_extmsg1b
suffix:colon
r_case
id|A_int_bad_extmsg2a
suffix:colon
r_case
id|A_int_bad_extmsg2b
suffix:colon
r_case
id|A_int_bad_extmsg3a
suffix:colon
r_case
id|A_int_bad_extmsg3b
suffix:colon
r_case
id|A_int_bad_msg1
suffix:colon
r_case
id|A_int_bad_msg2
suffix:colon
r_case
id|A_int_bad_msg3
suffix:colon
r_case
id|A_int_cmd_bad_phase
suffix:colon
r_case
id|A_int_no_msgout1
suffix:colon
r_case
id|A_int_no_msgout2
suffix:colon
r_case
id|A_int_no_msgout3
suffix:colon
r_case
id|A_int_not_cmd_complete
suffix:colon
r_case
id|A_int_sel_no_ident
suffix:colon
r_case
id|A_int_sel_not_cmd
suffix:colon
r_case
id|A_int_status_not_msgin
suffix:colon
r_case
id|A_int_resel_not_msgin
suffix:colon
r_case
id|A_int_selected
suffix:colon
r_case
id|A_int_not_rej
suffix:colon
r_default
suffix:colon
id|sbcl
op_assign
id|NCR_read8
c_func
(paren
id|SBCL_REG
)paren
op_amp
id|SBCL_PHASE_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unimplemented script interrupt: %08x, phase %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|dsps
comma
id|sbcl_to_phase
c_func
(paren
id|sbcl
)paren
)paren
suffix:semicolon
id|sim710_errors
op_increment
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
r_return
id|resume_offset
suffix:semicolon
)brace
multiline_comment|/* A quick wrapper for sim710_intr_handle to grab the spin lock */
r_static
r_void
DECL|function|do_sim710_intr_handle
id|do_sim710_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|sim710_intr_handle
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* A &quot;high&quot; level interrupt handler */
r_static
r_void
DECL|function|sim710_intr_handle
id|sim710_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_int
r_char
id|istat
comma
id|dstat
suffix:semicolon
r_int
r_char
id|sstat0
suffix:semicolon
id|u32
id|dsps
comma
id|resume_offset
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sim710_intrs
op_increment
suffix:semicolon
r_while
c_loop
(paren
(paren
id|istat
op_assign
id|NCR_read8
c_func
(paren
id|ISTAT_REG
)paren
)paren
op_amp
(paren
id|ISTAT_SIP
op_or
id|ISTAT_DIP
)paren
)paren
(brace
id|dsps
op_assign
id|NCR_read32
c_func
(paren
id|DSPS_REG
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_HALTED
suffix:semicolon
id|sstat0
op_assign
id|dstat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|istat
op_amp
id|ISTAT_SIP
)paren
(brace
id|sstat0
op_assign
id|NCR_read8
c_func
(paren
id|SSTAT0_REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istat
op_amp
id|ISTAT_DIP
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Some comment somewhere about 10cycles&n;&t;&t;&t;&t; * between accesses to sstat0 and dstat ??? */
id|dstat
op_assign
id|NCR_read8
c_func
(paren
id|DSTAT_REG
)paren
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|DEB_INTS
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Int %d, istat %02x, sstat0 %02x &quot;
l_string|&quot;dstat %02x, dsp [%04x], scratch %02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sim710_intrs
comma
id|istat
comma
id|sstat0
comma
id|dstat
comma
(paren
id|u32
op_star
)paren
(paren
id|bus_to_virt
c_func
(paren
id|NCR_read32
c_func
(paren
id|DSP_REG
)paren
)paren
)paren
op_minus
id|hostdata-&gt;script
comma
id|NCR_read32
c_func
(paren
id|SCRATCH_REG
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dstat
op_amp
id|DSTAT_SIR
)paren
op_logical_and
id|dsps
op_eq
id|A_int_reselected
)paren
(brace
multiline_comment|/* Reselected.  Identify the target from LCRC_REG, and&n;&t;     * update current command.  If we were trying to select&n;&t;     * a device, then that command needs to go back on the&n;&t;     * issue_queue for later.&n;&t;     */
r_int
r_char
id|lcrc
op_assign
id|NCR_read8
c_func
(paren
id|LCRC_REG_10
)paren
suffix:semicolon
r_int
id|id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lcrc
op_amp
l_int|0x7f
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Reselected with LCRC = %02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|lcrc
)paren
suffix:semicolon
id|cmd
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|lcrc
op_amp
l_int|1
)paren
)paren
(brace
id|id
op_increment
suffix:semicolon
id|lcrc
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|DEB_DISC
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Reselected by ID %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;running
)paren
(brace
multiline_comment|/* Clear SIGP */
(paren
r_void
)paren
id|NCR_read8
c_func
(paren
id|CTEST2_REG_700
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_DISC
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Select of %d interrupted &quot;
l_string|&quot;by reselect from %d (%p)&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|hostdata-&gt;running-&gt;target
comma
id|id
comma
id|hostdata-&gt;target
(braket
id|id
)braket
dot
id|cur_cmd
)paren
)paren
suffix:semicolon
id|cmd
op_assign
id|hostdata-&gt;running
suffix:semicolon
id|hostdata-&gt;target
(braket
id|cmd-&gt;target
)braket
dot
id|cur_cmd
op_assign
l_int|NULL
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
id|cmd
suffix:semicolon
)brace
id|cmd
op_assign
id|hostdata-&gt;running
op_assign
id|hostdata-&gt;target
(braket
id|id
)braket
dot
id|cur_cmd
suffix:semicolon
)brace
)brace
r_else
id|cmd
op_assign
id|hostdata-&gt;running
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: No active command!&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Int %d, istat %02x, sstat0 %02x &quot;
l_string|&quot;dstat %02x, dsp [%04x], scratch %02x, dsps %08x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sim710_intrs
comma
id|istat
comma
id|sstat0
comma
id|dstat
comma
(paren
id|u32
op_star
)paren
(paren
id|bus_to_virt
c_func
(paren
id|NCR_read32
c_func
(paren
id|DSP_REG
)paren
)paren
)paren
op_minus
id|hostdata-&gt;script
comma
id|NCR_read32
c_func
(paren
id|SCRATCH_REG
)paren
comma
id|dsps
)paren
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
id|SSTAT0_700_STO
)paren
(brace
id|DEB
c_func
(paren
id|DEB_TOUT
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Selection timeout&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|SCSI_DONE
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|hostdata-&gt;target
(braket
id|cmd-&gt;target
)braket
dot
id|cur_cmd
op_assign
l_int|NULL
suffix:semicolon
id|resume_offset
op_assign
id|Ent_reselect
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dstat
op_amp
id|DSTAT_SIR
)paren
id|resume_offset
op_assign
id|handle_script_int
c_func
(paren
id|host
comma
id|cmd
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
id|SSTAT0_MA
)paren
(brace
id|resume_offset
op_assign
id|handle_phase_mismatch
c_func
(paren
id|host
comma
id|cmd
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
(paren
id|SSTAT0_MA
op_or
id|SSTAT0_SGE
op_or
id|SSTAT0_UDC
op_or
id|SSTAT0_RST
op_or
id|SSTAT0_PAR
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Serious error, sstat0 = %02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|sstat0
)paren
suffix:semicolon
id|sim710_errors
op_increment
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
r_else
r_if
c_cond
(paren
id|dstat
op_amp
(paren
id|DSTAT_BF
op_or
id|DSTAT_ABRT
op_or
id|DSTAT_SSI
op_or
id|DSTAT_WTD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Serious error, dstat = %02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|dstat
)paren
suffix:semicolon
id|sim710_errors
op_increment
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
r_else
r_if
c_cond
(paren
id|dstat
op_amp
id|DSTAT_IID
)paren
(brace
multiline_comment|/* This can be due to a quick reselect while doing a WAIT&n;&t;     * DISCONNECT.&n;&t;     */
id|resume_offset
op_assign
id|handle_idd
c_func
(paren
id|host
comma
id|cmd
)paren
suffix:semicolon
)brace
r_else
(brace
id|sim710_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Spurious interrupt!&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* resume_offset is zero, which will cause a host reset */
)brace
)brace
r_if
c_cond
(paren
id|resume_offset
)paren
(brace
r_if
c_cond
(paren
id|resume_offset
op_eq
id|Ent_reselect
)paren
(brace
id|hostdata-&gt;running
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_IDLE
suffix:semicolon
)brace
r_else
id|hostdata-&gt;state
op_assign
id|STATE_BUSY
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_RESUME
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Resuming at script[0x%x]&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|resume_offset
op_div
l_int|4
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_LIMIT_INTS
r_if
c_cond
(paren
id|sim710_intrs
OL
id|DEBUG_LIMIT_INTS
)paren
macro_line|#endif
id|NCR_write32
c_func
(paren
id|DSP_REG
comma
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|resume_offset
op_div
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resume_offset
op_eq
id|Ent_reselect
)paren
id|run_process_issue_queue
c_func
(paren
id|hostdata
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Failed to handle interrupt.  Failing commands &quot;
l_string|&quot;and resetting SCSI bus and chip&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* Give chance to read screen!! */
id|full_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|run_command
id|run_command
(paren
r_struct
id|sim710_hostdata
op_star
id|hostdata
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
r_struct
id|sim710_target
op_star
id|targdata
op_assign
id|hostdata-&gt;target
op_plus
id|cmd-&gt;target
suffix:semicolon
r_int
id|i
comma
id|datain
comma
id|dataout
comma
id|sg_start
suffix:semicolon
id|u32
op_star
id|dip
comma
op_star
id|dop
comma
id|dsa
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_CMND
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: id%d starting &quot;
comma
id|host-&gt;host_no
comma
id|cmd-&gt;target
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_CMND
comma
id|print_command
c_func
(paren
id|cmd-&gt;cmnd
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|INQUIRY
suffix:colon
r_case
id|MODE_SENSE
suffix:colon
r_case
id|READ_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|READ_CAPACITY
suffix:colon
r_case
id|REQUEST_SENSE
suffix:colon
r_case
id|READ_BLOCK_LIMITS
suffix:colon
r_case
id|READ_TOC
suffix:colon
id|datain
op_assign
l_int|1
suffix:semicolon
id|dataout
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
id|datain
op_assign
l_int|0
suffix:semicolon
id|dataout
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_case
id|START_STOP
suffix:colon
id|datain
op_assign
id|dataout
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|datain
op_assign
id|dataout
op_assign
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|targdata-&gt;dsa_cdb
comma
id|cmd-&gt;cmnd
comma
id|MAX_CMND
)paren
suffix:semicolon
id|targdata-&gt;dsa_msgout
(braket
l_int|0
)braket
op_assign
id|IDENTIFY
c_func
(paren
(paren
id|opt_nodisc
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;negotiate
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
)paren
(brace
r_if
c_cond
(paren
id|opt_noneg
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
)paren
(brace
id|hostdata-&gt;negotiate
op_xor_assign
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_MSGOUT
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DEB
c_func
(paren
id|DEB_SYNC
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: Negotiating async transfers &quot;
l_string|&quot;for ID %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|cmd-&gt;target
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|targdata-&gt;dsa_msgout
op_plus
l_int|1
comma
id|async_message
comma
r_sizeof
(paren
id|async_message
)paren
)paren
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_MSGOUT
)braket
op_assign
r_sizeof
(paren
id|async_message
)paren
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|targdata-&gt;dsa
(braket
id|DSA_MSGOUT
)braket
op_assign
l_int|1
suffix:semicolon
id|targdata-&gt;dsa_msgin
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|targdata-&gt;dsa_status
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_SELECT
)braket
op_assign
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
op_lshift
l_int|16
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_MSGOUT
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|targdata-&gt;dsa_msgout
)paren
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_CMND
)braket
op_assign
id|cmd-&gt;cmd_len
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_CMND
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|targdata-&gt;dsa_cdb
)paren
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_STATUS
)braket
op_assign
l_int|1
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_STATUS
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|targdata-&gt;dsa_status
)paren
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_MSGIN
)braket
op_assign
l_int|1
suffix:semicolon
id|targdata-&gt;dsa
(braket
id|DSA_MSGIN
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|targdata-&gt;dsa_msgin
)paren
suffix:semicolon
id|sg_start
op_assign
(paren
id|MAX_SG
op_minus
(paren
id|cmd-&gt;use_sg
ques
c_cond
id|cmd-&gt;use_sg
suffix:colon
l_int|1
)paren
)paren
op_star
l_int|2
suffix:semicolon
id|dip
op_assign
id|targdata-&gt;dsa
op_plus
id|DSA_DATAIN
op_plus
id|sg_start
suffix:semicolon
id|dop
op_assign
id|targdata-&gt;dsa
op_plus
id|DSA_DATAOUT
op_plus
id|sg_start
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;use_sg
ques
c_cond
(paren
id|i
OL
id|cmd-&gt;use_sg
)paren
suffix:colon
op_logical_neg
id|i
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|vbuf
op_assign
id|cmd-&gt;use_sg
ques
c_cond
(paren
id|u32
)paren
(paren
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;buffer
)paren
(braket
id|i
)braket
dot
id|address
)paren
suffix:colon
(paren
id|u32
)paren
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
id|u32
id|bbuf
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|vbuf
)paren
suffix:semicolon
id|u32
id|cnt
op_assign
id|cmd-&gt;use_sg
ques
c_cond
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;buffer
)paren
(braket
id|i
)braket
dot
id|length
suffix:colon
id|cmd-&gt;request_bufflen
suffix:semicolon
r_if
c_cond
(paren
id|datain
)paren
(brace
macro_line|#ifdef CONFIG_TP34V_SCSI
id|cache_clear
c_func
(paren
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|vbuf
)paren
comma
id|cnt
)paren
suffix:semicolon
macro_line|#endif
op_star
id|dip
op_increment
op_assign
id|cnt
suffix:semicolon
op_star
id|dip
op_increment
op_assign
id|bbuf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dataout
)paren
(brace
macro_line|#ifdef CONFIG_TP34V_SCSI
id|cache_push
c_func
(paren
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|vbuf
)paren
comma
id|cnt
)paren
suffix:semicolon
macro_line|#endif
op_star
id|dop
op_increment
op_assign
id|cnt
suffix:semicolon
op_star
id|dop
op_increment
op_assign
id|bbuf
suffix:semicolon
)brace
)brace
id|targdata-&gt;data_out_jump
op_assign
id|hostdata-&gt;script
(braket
id|Ent_patch_output_data
op_div
l_int|4
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|Ent_patch_output_data
op_div
l_int|4
op_plus
id|sg_start
op_plus
l_int|2
)paren
suffix:semicolon
id|targdata-&gt;data_in_jump
op_assign
id|hostdata-&gt;script
(braket
id|Ent_patch_input_data
op_div
l_int|4
op_plus
l_int|1
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|Ent_patch_input_data
op_div
l_int|4
op_plus
id|sg_start
op_plus
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|dsa
op_assign
id|virt_to_bus
c_func
(paren
id|targdata-&gt;dsa
)paren
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|v
op_assign
id|hostdata-&gt;script
(braket
id|Ent_patch_new_dsa
op_div
l_int|4
op_plus
id|i
op_star
l_int|2
)braket
suffix:semicolon
id|v
op_and_assign
op_complement
l_int|0x0000ff00
suffix:semicolon
id|v
op_or_assign
(paren
id|dsa
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
suffix:semicolon
id|hostdata-&gt;script
(braket
id|Ent_patch_new_dsa
op_div
l_int|4
op_plus
id|i
op_star
l_int|2
)braket
op_assign
id|v
suffix:semicolon
id|dsa
op_rshift_assign
l_int|8
suffix:semicolon
)brace
id|hostdata-&gt;running
op_assign
id|targdata-&gt;cur_cmd
op_assign
id|cmd
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_BUSY
suffix:semicolon
id|NCR_write8
c_func
(paren
id|ISTAT_REG
comma
id|ISTAT_10_SIGP
)paren
suffix:semicolon
)brace
DECL|variable|process_issue_queue_running
r_static
r_volatile
r_int
id|process_issue_queue_running
op_assign
l_int|0
suffix:semicolon
r_static
id|__inline__
r_void
DECL|function|run_process_issue_queue
id|run_process_issue_queue
c_func
(paren
r_struct
id|sim710_hostdata
op_star
id|hostdata
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|process_issue_queue_running
)paren
(brace
id|process_issue_queue_running
op_assign
l_int|1
suffix:semicolon
id|process_issue_queue
c_func
(paren
id|hostdata
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * process_issue_queue_running is cleared in process_issue_queue&n;&t; * once it can&squot;t do more work, and process_issue_queue exits with&n;&t; * interrupts disabled.&n;&t; */
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : process_issue_queue (hostdata, flags)&n; *&n; * Purpose : Start next command for any idle target.&n; * &n; * NOTE : process_issue_queue exits with interrupts *disabled*, so the &n; *&t;caller must reenable them if it desires.&n; * &n; * NOTE : process_issue_queue should be called from both &n; *&t;sim710_queue_command() and from the interrupt handler &n; *&t;after command completion.&n; */
r_static
r_void
DECL|function|process_issue_queue
id|process_issue_queue
(paren
r_struct
id|sim710_hostdata
op_star
id|hostdata
comma
r_int
r_int
id|flags
)paren
(brace
id|Scsi_Cmnd
op_star
id|tmp
comma
op_star
id|prev
suffix:semicolon
r_int
id|done
suffix:semicolon
multiline_comment|/*&n;     * We run (with interrupts disabled) until we&squot;re sure that none of &n;     * the host adapters have anything that can be done, at which point &n;     * we set process_issue_queue_running to 0 and exit.&n;     *&n;     * Interrupts are enabled before doing various other internal &n;     * instructions, after we&squot;ve decided that we need to run through&n;     * the loop again.&n;     *&n;     */
r_do
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Freeze request queues */
id|done
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;issue_queue
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;state
op_eq
id|STATE_DISABLED
)paren
(brace
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;SCp.ptr
suffix:semicolon
id|tmp-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|tmp-&gt;scsi_done
(paren
id|tmp
)paren
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hostdata-&gt;state
op_eq
id|STATE_IDLE
)paren
(brace
r_for
c_loop
(paren
id|tmp
op_assign
id|hostdata-&gt;issue_queue
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|tmp
suffix:semicolon
id|prev
op_assign
id|tmp
comma
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;SCp.ptr
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;target
(braket
id|tmp-&gt;target
)braket
dot
id|cur_cmd
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
id|prev-&gt;SCp.ptr
op_assign
id|tmp-&gt;SCp.ptr
suffix:semicolon
r_else
id|hostdata-&gt;issue_queue
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;SCp.ptr
suffix:semicolon
id|tmp-&gt;SCp.ptr
op_assign
l_int|NULL
suffix:semicolon
id|run_command
(paren
id|hostdata
comma
id|tmp
)paren
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if target/lun is not busy */
)brace
multiline_comment|/* scan issue queue for work */
)brace
multiline_comment|/* host is idle */
)brace
multiline_comment|/* if hostdata-&gt;issue_queue */
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
suffix:semicolon
id|process_issue_queue_running
op_assign
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|sim710_queuecommand
id|sim710_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;lun
)paren
(brace
multiline_comment|/* Silently ignore luns other than zero! */
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|DEB_CMND
comma
id|printk
c_func
(paren
l_string|&quot;scsi%d: id%d queuing &quot;
comma
id|host-&gt;host_no
comma
id|cmd-&gt;target
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_CMND
comma
id|print_command
c_func
(paren
id|cmd-&gt;cmnd
)paren
)paren
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
l_int|NULL
suffix:semicolon
id|cmd-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ignore_ids
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;target
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: ignoring target %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|cmd-&gt;target
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_LIMIT_INTS
r_if
c_cond
(paren
id|sim710_intrs
OG
id|DEBUG_LIMIT_INTS
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|cmd-&gt;use_sg
OG
id|MAX_SG
)paren
id|panic
(paren
l_string|&quot;cmd-&gt;use_sg = %d&bslash;n&quot;
comma
id|cmd-&gt;use_sg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hostdata-&gt;issue_queue
)paren
op_logical_or
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
)paren
(brace
id|cmd-&gt;SCp.ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
id|cmd
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|tmp
op_assign
id|hostdata-&gt;issue_queue
suffix:semicolon
id|tmp-&gt;SCp.ptr
suffix:semicolon
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;SCp.ptr
)paren
suffix:semicolon
id|tmp-&gt;SCp.ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|cmd
suffix:semicolon
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|run_process_issue_queue
c_func
(paren
id|hostdata
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|sim710_detect
id|sim710_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_char
id|irq_vector
suffix:semicolon
r_int
r_char
id|scsi_id
suffix:semicolon
r_int
r_int
id|base_addr
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sim710_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|chips
op_assign
l_int|0
suffix:semicolon
r_int
id|indx
suffix:semicolon
r_int
id|revision
suffix:semicolon
r_int
id|order
comma
id|size
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
id|sim710
)paren
id|param_setup
c_func
(paren
id|sim710
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|no_of_boards
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sim710: NCR53C710 driver disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_MCA
multiline_comment|/* If board details have been specified via boot/module parameters,&n;     * then don&squot;t bother probing.&n;     */
r_if
c_cond
(paren
id|no_of_boards
op_eq
l_int|0
)paren
(brace
r_int
id|slot
suffix:semicolon
r_int
id|pos
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|mca_53c710_ids
(braket
)braket
op_assign
id|MCA_53C710_IDS
suffix:semicolon
r_int
op_star
id|id_to_check
op_assign
id|mca_53c710_ids
suffix:semicolon
r_static
r_int
id|io_004f_by_pos
(braket
)braket
op_assign
id|MCA_004F_IO_PORTS
suffix:semicolon
r_static
r_int
id|irq_004f_by_pos
(braket
)braket
op_assign
id|MCA_004F_IRQS
suffix:semicolon
r_static
r_int
id|io_01bb_by_pos
(braket
)braket
op_assign
id|MCA_01BB_IO_PORTS
suffix:semicolon
r_static
r_int
id|irq_01bb_by_pos
(braket
)braket
op_assign
id|MCA_01BB_IRQS
suffix:semicolon
r_while
c_loop
(paren
op_star
id|id_to_check
op_logical_and
id|no_of_boards
OL
id|MAXBOARDS
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|MCA_bus
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
op_star
id|id_to_check
comma
l_int|0
)paren
)paren
op_ne
id|MCA_NOTFOUND
)paren
(brace
id|pos
(braket
l_int|0
)braket
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|2
)paren
suffix:semicolon
id|pos
(braket
l_int|1
)braket
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|3
)paren
suffix:semicolon
id|pos
(braket
l_int|2
)braket
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * 01BB &amp; 01BA port base by bits 7,6,5,4,3,2 in pos[2]&n;&t;&t; *&n;&t;&t; *    000000  &lt;disabled&gt;   001010  0x2800&n;&t;&t; *    000001  &lt;invalid&gt;    001011  0x2C00&n;&t;&t; *    000010  0x0800       001100  0x3000&n;&t;&t; *    000011  0x0C00       001101  0x3400&n;&t;&t; *    000100  0x1000       001110  0x3800&n;&t;&t; *    000101  0x1400       001111  0x3C00&n;&t;&t; *    000110  0x1800       010000  0x4000&n;&t;&t; *    000111  0x1C00       010001  0x4400&n;&t;&t; *    001000  0x2000       010010  0x4800&n;&t;&t; *    001001  0x2400       010011  0x4C00&n;&t;&t; *                         010100  0x5000&n;&t;&t; *&n;&t;&t; * 00F4 port base by bits 3,2,1 in pos[0]&n;&t;&t; *&n;&t;&t; *    000  &lt;disabled&gt;      001    0x200&n;&t;&t; *    010  0x300           011    0x400&n;&t;&t; *    100  0x500           101    0x600&n;&t;&t; *&n;&t;&t; * 01BB &amp; 01BA IRQ is specified in pos[0] bits 7 and 6:&n;&t;&t; *&n;&t;&t; *    00   3               10   11&n;&t;&t; *    01   5               11   14&n;&t;&t; *&n;&t;&t; * 00F4 IRQ specified by bits 6,5,4 in pos[0]&n;&t;&t; *&n;&t;&t; *    100   5              101    9&n;&t;&t; *    110   14&n;&t;&t; */
r_if
c_cond
(paren
op_star
id|id_to_check
op_eq
l_int|0x01bb
op_logical_or
op_star
id|id_to_check
op_eq
l_int|0x01ba
)paren
(brace
id|bases
(braket
id|no_of_boards
)braket
op_assign
id|io_01bb_by_pos
(braket
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xFC
)paren
op_rshift
l_int|2
)braket
suffix:semicolon
id|irq_vectors
(braket
id|no_of_boards
)braket
op_assign
id|irq_01bb_by_pos
(braket
(paren
(paren
id|pos
(braket
l_int|0
)braket
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bases
(braket
id|no_of_boards
)braket
op_eq
l_int|0x0000
)paren
id|printk
c_func
(paren
l_string|&quot;sim710: NCR53C710 Adapter ID 0x01bb is disabled.&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|no_of_boards
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|id_to_check
op_eq
l_int|0x01bb
)paren
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;NCR 3360/3430 SCSI SubSystem&quot;
)paren
suffix:semicolon
r_else
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;NCR Dual SIOP SCSI Host Adapter Board&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_star
id|id_to_check
op_eq
l_int|0x004f
)paren
(brace
id|bases
(braket
id|no_of_boards
)braket
op_assign
id|io_004f_by_pos
(braket
(paren
(paren
id|pos
(braket
l_int|0
)braket
op_amp
l_int|0x0E
)paren
op_rshift
l_int|1
)paren
)braket
suffix:semicolon
id|irq_vectors
(braket
id|no_of_boards
)braket
op_assign
id|irq_004f_by_pos
(braket
(paren
(paren
id|pos
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
)paren
op_minus
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bases
(braket
id|no_of_boards
)braket
op_eq
l_int|0x0000
)paren
id|printk
c_func
(paren
l_string|&quot;sim710: NCR53C710 Adapter ID 0x004f is disabled.&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|no_of_boards
op_increment
suffix:semicolon
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;NCR 53c710 SCSI Host Adapter Board&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
id|id_to_check
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|no_of_boards
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sim710: No NCR53C710 adapter found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|size
op_assign
r_sizeof
(paren
r_struct
id|sim710_hostdata
)paren
suffix:semicolon
id|order
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
)paren
id|order
op_increment
suffix:semicolon
id|size
op_assign
id|PAGE_SIZE
op_lshift
id|order
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_ANY
comma
id|printk
c_func
(paren
l_string|&quot;sim710: hostdata %d bytes, size %d, order %d&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|sim710_hostdata
)paren
comma
id|size
comma
id|order
)paren
)paren
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;sim710&quot;
suffix:semicolon
r_for
c_loop
(paren
id|indx
op_assign
l_int|0
suffix:semicolon
id|indx
OL
id|no_of_boards
suffix:semicolon
id|indx
op_increment
)paren
(brace
r_int
r_int
id|page
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sim710: out of memory registering board %d.&bslash;n&quot;
comma
id|indx
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|host
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
id|host-&gt;hostdata
(braket
l_int|0
)braket
op_assign
id|page
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|hostdata
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_TP34V_SCSI
id|cache_push
c_func
(paren
id|virt_to_phys
c_func
(paren
id|hostdata
)paren
comma
id|size
)paren
suffix:semicolon
id|cache_clear
c_func
(paren
id|virt_to_phys
c_func
(paren
id|hostdata
)paren
comma
id|size
)paren
suffix:semicolon
id|kernel_set_cachemode
c_func
(paren
(paren
r_void
op_star
)paren
id|hostdata
comma
id|size
comma
id|IOMAP_NOCACHE_SER
)paren
suffix:semicolon
macro_line|#endif
id|scsi_id
op_assign
l_int|7
suffix:semicolon
id|base_addr
op_assign
id|bases
(braket
id|indx
)braket
suffix:semicolon
id|irq_vector
op_assign
id|irq_vectors
(braket
id|indx
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sim710: Configuring Sim710 (SCSI-ID %d) at %x, IRQ %d&bslash;n&quot;
comma
id|scsi_id
comma
id|base_addr
comma
id|irq_vector
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|DEB_ANY
comma
id|printk
c_func
(paren
l_string|&quot;sim710: hostdata = %p (%d bytes), dsa0 = %p&bslash;n&quot;
comma
id|hostdata
comma
r_sizeof
(paren
r_struct
id|sim710_hostdata
)paren
comma
id|hostdata-&gt;target
(braket
l_int|0
)braket
dot
id|dsa
)paren
)paren
suffix:semicolon
id|hostdata-&gt;chip
op_assign
id|indx
suffix:semicolon
id|host-&gt;irq
op_assign
id|irq_vector
suffix:semicolon
id|host-&gt;this_id
op_assign
id|scsi_id
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|base_addr
suffix:semicolon
id|host-&gt;base
op_assign
id|base_addr
suffix:semicolon
id|ncr_halt
c_func
(paren
id|host
)paren
suffix:semicolon
id|revision
op_assign
(paren
id|NCR_read8
c_func
(paren
id|CTEST8_REG
)paren
op_amp
l_int|0xF0
)paren
op_rshift
l_int|4
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Revision 0x%x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|revision
)paren
suffix:semicolon
id|sim710_soft_reset
c_func
(paren
id|host
)paren
suffix:semicolon
id|sim710_driver_init
c_func
(paren
id|host
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_TP34V_SCSI
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq_vector
comma
id|do_sim710_intr_handle
comma
l_int|0
comma
l_string|&quot;sim710&quot;
comma
id|host
)paren
)paren
macro_line|#else
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq_vector
comma
id|do_sim710_intr_handle
comma
id|SA_INTERRUPT
comma
l_string|&quot;sim710&quot;
comma
id|host
)paren
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d : IRQ%d not free, detaching&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|host-&gt;irq
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef IO_MAPPED
id|request_region
c_func
(paren
(paren
id|u32
)paren
id|host-&gt;base
comma
l_int|64
comma
l_string|&quot;sim710&quot;
)paren
suffix:semicolon
macro_line|#endif
id|chips
op_increment
suffix:semicolon
)brace
id|NCR_write32
c_func
(paren
id|DSP_REG
comma
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|Ent_reselect
op_div
l_int|4
)paren
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_IDLE
suffix:semicolon
)brace
r_return
id|chips
suffix:semicolon
)brace
r_int
DECL|function|sim710_abort
id|sim710_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unable to abort command for target %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/*&n; * This is a device reset.  Need to select and send a Bus Device Reset msg.&n; */
r_int
DECL|function|sim710_dev_reset
id|sim710_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unable to send Bus Device Reset for target %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/*&n; * This is bus reset.  We need to reset the bus and fail any active commands.&n; */
r_int
DECL|function|sim710_bus_reset
id|sim710_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unable to do SCSI bus reset&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_static
r_int
DECL|function|full_reset
id|full_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|sim710_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|sim710_hostdata
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|target
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|ncr_halt
c_func
(paren
id|host
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: dsp = %08x (script[0x%04x]), scratch = %08x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|NCR_read32
c_func
(paren
id|DSP_REG
)paren
comma
(paren
(paren
id|u32
)paren
id|bus_to_virt
c_func
(paren
id|NCR_read32
c_func
(paren
id|DSP_REG
)paren
)paren
op_minus
(paren
id|u32
)paren
id|hostdata-&gt;script
)paren
op_div
l_int|4
comma
id|NCR_read32
c_func
(paren
id|SCRATCH_REG
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
l_int|7
suffix:semicolon
id|target
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|cmd
op_assign
id|hostdata-&gt;target
(braket
id|target
)braket
dot
id|cur_cmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Failing command for ID%d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|target
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|hostdata-&gt;target
(braket
id|target
)braket
dot
id|cur_cmd
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|sim710_soft_reset
c_func
(paren
id|host
)paren
suffix:semicolon
id|sim710_driver_init
c_func
(paren
id|host
)paren
suffix:semicolon
id|NCR_write32
c_func
(paren
id|DSP_REG
comma
id|virt_to_bus
c_func
(paren
id|hostdata-&gt;script
op_plus
id|Ent_reselect
op_div
l_int|4
)paren
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|STATE_IDLE
suffix:semicolon
id|run_process_issue_queue
c_func
(paren
id|hostdata
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * This is host reset.  We need to reset the chip and the bus.&n; */
r_int
DECL|function|sim710_host_reset
id|sim710_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Host reset &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
r_return
id|full_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|sim710_release
id|sim710_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|host
)paren
suffix:semicolon
macro_line|#ifdef IO_MAPPED
id|release_region
c_func
(paren
(paren
id|u32
)paren
id|host-&gt;base
comma
l_int|64
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|SIM710_SCSI
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
