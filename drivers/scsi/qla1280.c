multiline_comment|/********************************************************************************&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP1x80/1x160 device driver for Linux 2.3.x (redhat 6.X).&n; *&n; * COPYRIGHT (C) 1999-2000 QLOGIC CORPORATION    &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the Qlogic&squot;s Linux Software License. See below.&n; *&n; * This program is WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  &n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; *&n; * 1. Redistribution&squot;s or source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification, immediately at the beginning of the file.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; ********************************************************************************/
multiline_comment|/*****************************************************************************************&n;&t;&t;&t;QLOGIC CORPORATION SOFTWARE&n;           &quot;GNU&quot; GENERAL PUBLIC LICENSE&n;    TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION&n;                 AND MODIFICATION&n;&n;This GNU General Public License (&quot;License&quot;) applies solely to QLogic Linux &n;Software (&quot;Software&quot;) and may be distributed under the terms of this License.  &n; &n;1. You may copy and distribute verbatim copies of the Software&squot;s source code as &n;you receive it, in any medium, provided that you conspicuously and appropriately &n;publish on each copy an appropriate copyright notice and disclaimer of warranty;&n;keep intact all the notices that refer to this License and to the absence of any&n;warranty; and give any other recipients of the Software a copy of this License along&n;with the Software. &n;&n;You may charge a fee for the physical act of transferring a copy, and you may at your&n;option offer warranty protection in exchange for a fee.&n; &n;2. You may modify your copy or copies of the Software or any portion of it, thus forming&n;a work based on the Software, and copy and distribute such modifications or work under&n;the terms of Section 1 above, provided that you also meet all of these conditions:&n; &n;* a) You must cause the modified files to carry prominent notices stating that you&n;changed the files and the date of any change. &n;&n;* b) You must cause any work that you distribute or publish that in whole or in part&n;contains or is derived from the Software or any part thereof, to be licensed as a&n;whole at no charge to all third parties under the terms of this License. &n;&n;* c) If the modified Software normally reads commands interactively when run, you&n;must cause it, when started running for such interactive use in the most ordinary way,&n;to print or display an announcement including an appropriate copyright notice and a &n;notice that there is no warranty (or else, saying that you provide a warranty) and that&n;users may redistribute the Software under these conditions, and telling the user how to&n;view a copy of this License. (Exception:if the Software itself is interactive but does &n;not normally print such an announcement, your work based on the Software is not required&n;to print an announcement.) &n;&n;These requirements apply to the modified work as a whole. If identifiable sections of&n;that work are not derived from the Software, and can be reasonably considered independent&n;and separate works in themselves, then this License, and its terms, do not apply to those&n;sections when you distribute them as separate works. But when you distribute the same&n;sections as part of a whole which is a work based on the Software, the distribution of the&n;whole must be on the terms of this License, whose permissions for other licensees extend&n;to the entire whole, and thus to each and every part regardless of who wrote it. &n;&n;3. You may copy and distribute the Software (or a work based on it, under Section 2) in &n;object code or executable form under the terms of Sections 1 and 2 above provided that&n;you also do one of the following: &n;&n;* a) Accompany it with the complete corresponding machine-readable source code, which must&n;be distributed under the terms of Sections 1 and 2 above on a medium customarily used for&n;software interchange; or, &n;&n;* b) Accompany it with a written offer, valid for at least three years, to give any third&n;party, for a charge no more than your cost of physically performing source distribution,&n;a complete machine-readable copy of the corresponding source code, to be distributed under&n;the terms of Sections 1 and 2 above on a medium customarily used for software interchange;&n;or,&n;&n;* c) Accompany it with the information you received as to the offer to distribute &n;corresponding source code. (This alternative is allowed only for noncommercial distribution&n;and only if you received the Software in object code or executable form with such an offer,&n;in accord with Subsection b above.) &n;&n;The source code for a work means the preferred form of the work for making modifications&n;to it. For an executable work, complete source code means all the source code for all &n;modules it contains, plus any associated interface definition files, plus the scripts used&n;to control compilation and installation of the executable.     &n;&n;If distribution of executable or object code is made by offering access to copy from a &n;designated place, then offering equivalent access to copy the source code from the same&n;place counts as distribution of the source code, even though third parties are not &n;compelled to copy the source along with the object code. &n;&n;4. You may not copy, modify, sublicense, or distribute the Software except as expressly &n;provided under this License. Any attempt otherwise to copy, modify, sublicense or &n;distribute the Software is void, and will automatically terminate your rights under this&n;License. However, parties who have received copies, or rights, from you under this License&n;will not have their licenses terminated so long as such parties remain in full compliance. &n;&n;5. This license grants you world wide, royalty free non-exclusive rights to modify or &n;distribute the Software or its derivative works. These actions are prohibited by law &n;if you do not accept this License. Therefore, by modifying or distributing the Software&n;(or any work based on the Software), you indicate your acceptance of this License to do&n;so, and all its terms and conditions for copying, distributing or modifying the Software&n;or works based on it.&n; &n;6. Each time you redistribute the Software (or any work based on the Software), the &n;recipient automatically receives a license from the original licensor to copy, distribute&n;or modify the Software subject to these terms and conditions. You may not impose any &n;further restrictions on the recipients&squot; exercise of the rights granted herein. You are&n;not responsible for enforcing compliance by third parties to this License.&n; &n;7. If, as a consequence of a court judgment or allegation of patent infringement or for&n;any other reason (not limited to patent issues), conditions are imposed on you &n;(whether by court order, agreement or otherwise) that contradict the conditions of this&n;License, they do not excuse you from the conditions of this License. If you cannot &n;distribute so as to satisfy simultaneously your obligations under this License &n;and any other pertinent obligations, then as a consequence you may not distribute the&n;Software at all.    &n;&n;If any portion of this section is held invalid or unenforceable under any particular &n;circumstance, the balance of the section is intended to apply and the section as a whole&n;is intended to apply in other circumstances. &n;NO WARRANTY&n;&n;11. THE SOFTWARE IS PROVIDED WITHOUT A WARRANTY OF ANY KIND. THERE IS NO &n;WARRANTY FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. &n;EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR &n;OTHER PARTIES PROVIDE THE SOFTWARE &quot;AS IS&quot; WITHOUT WARRANTY OF ANY KIND, &n;EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED &n;WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE &n;ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU. &n;SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL &n;NECESSARY SERVICING, REPAIR OR CORRECTION.&n; &n;12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING &n;WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR &n;REDISTRIBUTE THE SOFTWARE AS PERMITTED ABOVE, BE LIABLE TO YOU FOR &n;DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL &n;DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE SOFTWARE (INCLUDING &n;BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR &n;LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO &n;OPERATE WITH ANY OTHER SOFTWARES), EVEN IF SUCH HOLDER OR OTHER PARTY HAS &n;BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES. &n;END OF TERMS AND CONDITIONS &n;&n;*******************************************************************************************/
multiline_comment|/****************************************************************************&n;    Revision History:&n;    Rev. 3.00       Jan 17, 1999    DG  Qlogic&n;&t;   - Added 64-bit support.&n;    Rev. 2.07       Nov 9, 1999     DG  Qlogic&n;&t;   - Added new routine to set target parameters for ISP12160. &n;    Rev. 2.06       Sept 10, 1999     DG  Qlogic&n;       - Added support for ISP12160 Ultra 3 chip.&n;    Rev. 2.03       August 3, 1999    Fred Lewis, Intel DuPont&n;&t;- Modified code to remove errors generated when compiling with&n;&t;  Cygnus IA64 Compiler.&n;        - Changed conversion of pointers to unsigned longs instead of integers.&n;        - Changed type of I/O port variables from uint32_t to unsigned long.&n;        - Modified OFFSET macro to work with 64-bit as well as 32-bit.&n;        - Changed sprintf and printk format specifiers for pointers to %p.&n;        - Changed some int to long type casts where needed in sprintf &amp; printk.&n;        - Added l modifiers to sprintf and printk format specifiers for longs.&n;        - Removed unused local variables.&n;    Rev. 1.20       June 8, 1999      DG,  Qlogic&n;         Changes to support RedHat release 6.0 (kernel 2.2.5).  &n;       - Added SCSI exclusive access lock (io_request_lock) when accessing &n;         the adapter.&n;       - Added changes for the new LINUX interface template. Some new error&n;         handling routines have been added to the template, but for now we&n;         will use the old ones.&n;    -   Initial Beta Release.  &n;*****************************************************************************/
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#endif
DECL|macro|QLA1280_VERSION
mdefine_line|#define QLA1280_VERSION      &quot; 3.00-Beta&quot;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
multiline_comment|/* MRS #include &lt;linux/tasks.h&gt; */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
macro_line|# include &lt;linux/bios32.h&gt;
macro_line|#endif
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
DECL|macro|UNIQUE_FW_NAME
mdefine_line|#define UNIQUE_FW_NAME
macro_line|#include &quot;qla1280.h&quot;
macro_line|#include &quot;ql12160_fw.h&quot;                     /* ISP RISC code */
macro_line|#include &quot;ql1280_fw.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;        /* for kmalloc() */
macro_line|#ifndef KERNEL_VERSION
DECL|macro|KERNEL_VERSION
macro_line|#  define KERNEL_VERSION(x,y,z) (((x)&lt;&lt;16)+((y)&lt;&lt;8)+(z))
macro_line|#endif
multiline_comment|/*&n; * Compile time Options: &n; *            0 - Disable and 1 - Enable &n; */
DECL|macro|QLA1280_64BIT_SUPPORT
mdefine_line|#define  QLA1280_64BIT_SUPPORT         1   /* 64-bit Support */
DECL|macro|QL1280_TARGET_MODE_SUPPORT
mdefine_line|#define  QL1280_TARGET_MODE_SUPPORT    0   /* Target mode support */
DECL|macro|WATCHDOGTIMER
mdefine_line|#define  WATCHDOGTIMER                 0
DECL|macro|MEMORY_MAPPED_IO
mdefine_line|#define  MEMORY_MAPPED_IO              0
DECL|macro|DEBUG_QLA1280_INTR
mdefine_line|#define  DEBUG_QLA1280_INTR            0
DECL|macro|USE_NVRAM_DEFAULTS
mdefine_line|#define  USE_NVRAM_DEFAULTS&t;       0
DECL|macro|DEBUG_PRINT_NVRAM
mdefine_line|#define  DEBUG_PRINT_NVRAM             0
DECL|macro|LOADING_RISC_ACTIVITY
mdefine_line|#define  LOADING_RISC_ACTIVITY         0
DECL|macro|AUTO_ESCALATE_RESET
mdefine_line|#define  AUTO_ESCALATE_RESET           0   /* Automatically escalate resets */
DECL|macro|AUTO_ESCALATE_ABORT
mdefine_line|#define  AUTO_ESCALATE_ABORT           0   /* Automatically escalate aborts */
DECL|macro|STOP_ON_ERROR
mdefine_line|#define  STOP_ON_ERROR                 0   /* Stop on aborts and resets  */
DECL|macro|STOP_ON_RESET
mdefine_line|#define  STOP_ON_RESET                 0 
DECL|macro|STOP_ON_ABORT
mdefine_line|#define  STOP_ON_ABORT                 0 
DECL|macro|DYNAMIC_MEM_ALLOC
macro_line|#undef   DYNAMIC_MEM_ALLOC
DECL|macro|DEBUG_QLA1280
mdefine_line|#define  DEBUG_QLA1280                 0    /* Debugging  */
multiline_comment|/* #define CHECKSRBSIZE */
multiline_comment|/*&n; * These macros to assist programming&n; */
DECL|macro|BZERO
mdefine_line|#define&t;BZERO(ptr, amt)&t;&t;memset(ptr, 0, amt)
DECL|macro|BCOPY
mdefine_line|#define&t;BCOPY(src, dst, amt)&t;memcpy(dst, src, amt)
DECL|macro|KMALLOC
mdefine_line|#define&t;KMALLOC(siz)&t;kmalloc((siz), GFP_ATOMIC)
DECL|macro|KMFREE
mdefine_line|#define&t;KMFREE(ip,siz)&t;kfree((ip))
DECL|macro|SYS_DELAY
mdefine_line|#define&t;SYS_DELAY(x)&t;&t;udelay(x);barrier()
DECL|macro|QLA1280_DELAY
mdefine_line|#define QLA1280_DELAY(sec)  mdelay(sec * 1000)
DECL|macro|VIRT_TO_BUS
mdefine_line|#define VIRT_TO_BUS(a) virt_to_bus((a))
macro_line|#if  QLA1280_64BIT_SUPPORT
macro_line|#if  BITS_PER_LONG &lt;= 32
DECL|macro|VIRT_TO_BUS_LOW
mdefine_line|#define  VIRT_TO_BUS_LOW(a) (uint32_t)virt_to_bus((a))
DECL|macro|VIRT_TO_BUS_HIGH
mdefine_line|#define  VIRT_TO_BUS_HIGH(a) (uint32_t)(0x0)
macro_line|#else
DECL|macro|VIRT_TO_BUS_LOW
mdefine_line|#define  VIRT_TO_BUS_LOW(a) (uint32_t)(0xffffffff &amp; virt_to_bus((a)))
DECL|macro|VIRT_TO_BUS_HIGH
mdefine_line|#define  VIRT_TO_BUS_HIGH(a) (uint32_t)(0xffffffff &amp; (virt_to_bus((a))&gt;&gt;32))
macro_line|#endif
macro_line|#endif  /* QLA1280_64BIT_SUPPORT */
DECL|macro|STATIC
mdefine_line|#define STATIC     
DECL|macro|NVRAM_DELAY
mdefine_line|#define NVRAM_DELAY() udelay(500) /* 2 microsecond delay */
r_void
id|qla1280_device_queue_depth
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|Scsi_Device
op_star
)paren
suffix:semicolon
DECL|macro|CACHE_FLUSH
mdefine_line|#define  CACHE_FLUSH(a) (RD_REG_WORD(a))
DECL|macro|INVALID_HANDLE
mdefine_line|#define  INVALID_HANDLE    (MAX_OUTSTANDING_COMMANDS+1)
DECL|macro|MSW
mdefine_line|#define  MSW(x)          (uint16_t)((uint32_t)(x) &gt;&gt; 16)
DECL|macro|LSW
mdefine_line|#define  LSW(x)          (uint16_t)(x)
DECL|macro|MSB
mdefine_line|#define  MSB(x)          (uint8_t)((uint16_t)(x) &gt;&gt; 8)
DECL|macro|LSB
mdefine_line|#define  LSB(x)          (uint8_t)(x)
macro_line|#if  BITS_PER_LONG &lt;= 32
DECL|macro|LS_64BITS
mdefine_line|#define  LS_64BITS(x) (uint32_t)(x)
DECL|macro|MS_64BITS
mdefine_line|#define  MS_64BITS(x) (uint32_t)(0x0)
macro_line|#else
DECL|macro|LS_64BITS
mdefine_line|#define  LS_64BITS(x) (uint32_t)(0xffffffff &amp; (x))
DECL|macro|MS_64BITS
mdefine_line|#define  MS_64BITS(x) (uint32_t)(0xffffffff &amp; ((x)&gt;&gt;32) )
macro_line|#endif
multiline_comment|/*&n; *  QLogic Driver Support Function Prototypes.&n; */
id|STATIC
r_void
id|qla1280_done
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_next
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|scsi_lu_t
op_star
comma
r_uint8
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_putq_t
c_func
(paren
id|scsi_lu_t
op_star
comma
id|srb_t
op_star
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_done_q_put
c_func
(paren
id|srb_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
id|Scsi_Device
op_star
)paren
suffix:semicolon
macro_line|#ifdef  QLA1280_UNUSED 
r_static
r_void
id|qla1280_dump_regs
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if  STOP_ON_ERROR 
r_static
r_void
id|qla1280_panic
c_func
(paren
r_char
op_star
comma
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
macro_line|#endif
r_void
id|qla1280_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_abort_queue_single
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
comma
r_uint32
comma
r_uint32
comma
r_uint32
)paren
suffix:semicolon
id|STATIC
r_int
id|qla1280_return_status
c_func
(paren
id|sts_entry_t
op_star
id|sts
comma
id|Scsi_Cmnd
op_star
id|cp
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_removeq
c_func
(paren
id|scsi_lu_t
op_star
id|q
comma
id|srb_t
op_star
id|sp
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_mem_free
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
r_void
id|qla1280_do_dpc
c_func
(paren
r_void
op_star
id|p
)paren
suffix:semicolon
macro_line|#ifdef  QLA1280_UNUSED 
r_static
r_void
id|qla1280_set_flags
c_func
(paren
r_char
op_star
id|s
)paren
suffix:semicolon
macro_line|#endif
r_static
r_char
op_star
id|qla1280_get_token
c_func
(paren
r_char
op_star
comma
r_char
op_star
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)
id|STATIC
r_inline
r_void
id|mdelay
c_func
(paren
r_int
)paren
suffix:semicolon
macro_line|#endif
r_static
r_inline
r_void
id|qla1280_enable_intrs
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla1280_disable_intrs
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; *  QLogic ISP1280 Hardware Support Function Prototypes.&n; */
id|STATIC
r_uint8
id|qla1280_initialize_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_enable_tgt
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_isp_firmware
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_pci_config
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_chip_diag
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_setup_chip
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_init_rings
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_nvram_config
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_mailbox_command
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
comma
r_uint16
op_star
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_bus_reset
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_device_reset
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
comma
r_uint32
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_abort_device
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
comma
r_uint32
comma
r_uint32
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_abort_command
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|srb_t
op_star
)paren
comma
macro_line|#if  QLA1280_64BIT_SUPPORT
id|qla1280_64bit_start_scsi
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|srb_t
op_star
)paren
comma
macro_line|#endif
id|qla1280_32bit_start_scsi
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|srb_t
op_star
)paren
comma
id|qla1280_abort_isp
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_nv_write
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint16
)paren
comma
id|qla1280_nv_delay
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
comma
id|qla1280_poll
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
comma
id|qla1280_reset_adapter
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
comma
id|qla1280_marker
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
comma
r_uint32
comma
r_uint32
comma
r_uint8
)paren
comma
id|qla1280_isp_cmd
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
comma
id|qla1280_isr
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
comma
id|qla1280_rst_aen
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
comma
id|qla1280_status_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|sts_entry_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
comma
id|qla1280_error_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|response_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
comma
id|qla1280_restart_queues
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
comma
id|qla1280_abort_queues
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
id|STATIC
r_uint16
id|qla1280_get_nvram_word
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
)paren
comma
id|qla1280_nvram_request
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
)paren
comma
id|qla1280_debounce_register
c_func
(paren
r_volatile
r_uint16
op_star
)paren
suffix:semicolon
id|STATIC
id|request_t
op_star
id|qla1280_req_pkt
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_int
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_mem_alloc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla1280_register_with_Linux
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|maxchannels
)paren
suffix:semicolon
id|STATIC
r_uint8
id|qla12160_set_target_parameters
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
comma
r_uint32
comma
r_uint32
comma
id|nvram160_t
op_star
)paren
suffix:semicolon
id|STATIC
r_void
id|qla12160_get_target_parameters
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
comma
r_uint32
comma
r_uint32
)paren
suffix:semicolon
macro_line|#if QL1280_TARGET_MODE_SUPPORT
id|STATIC
r_void
id|qla1280_enable_lun
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
comma
r_uint32
)paren
comma
id|qla1280_notify_ack
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|notify_entry_t
op_star
)paren
comma
id|qla1280_immed_notify
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|notify_entry_t
op_star
)paren
comma
id|qla1280_accept_io
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|ctio_ret_entry_t
op_star
)paren
comma
macro_line|#if  QLA1280_64BIT_SUPPORT
id|qla1280_64bit_continue_io
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|atio_entry_t
op_star
comma
r_uint32
comma
id|paddr32_t
op_star
)paren
comma
macro_line|#endif
id|qla1280_32bit_continue_io
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|atio_entry_t
op_star
comma
r_uint32
comma
id|paddr32_t
op_star
)paren
comma
id|qla1280_atio_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|atio_entry_t
op_star
)paren
comma
id|qla1280_notify_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|notify_entry_t
op_star
)paren
suffix:semicolon
macro_line|#endif  /* QLA1280_TARGET_MODE_SUPPORT */
macro_line|#ifdef QL_DEBUG_ROUTINES
multiline_comment|/*&n; *  Driver Debug Function Prototypes.&n; */
id|STATIC
r_uint8
id|qla1280_getbyte
c_func
(paren
r_uint8
op_star
)paren
suffix:semicolon
id|STATIC
r_uint16
id|qla1280_getword
c_func
(paren
r_uint16
op_star
)paren
suffix:semicolon
id|STATIC
r_uint32
id|qla1280_getdword
c_func
(paren
r_uint32
op_star
)paren
suffix:semicolon
id|STATIC
r_void
id|qla1280_putbyte
c_func
(paren
r_uint8
op_star
comma
r_uint8
)paren
comma
id|qla1280_putword
c_func
(paren
r_uint16
op_star
comma
r_uint16
)paren
comma
id|qla1280_putdword
c_func
(paren
r_uint32
op_star
comma
r_uint32
)paren
comma
id|qla1280_print
c_func
(paren
id|caddr_t
)paren
comma
id|qla1280_output_number
c_func
(paren
r_uint32
comma
r_uint8
)paren
comma
id|qla1280_putc
c_func
(paren
r_uint8
)paren
comma
id|qla1280_dump_buffer
c_func
(paren
id|caddr_t
comma
r_uint32
)paren
suffix:semicolon
DECL|variable|debug_buff
r_char
id|debug_buff
(braket
l_int|80
)braket
suffix:semicolon
macro_line|#if DEBUG_QLA1280 
DECL|variable|ql_debug_print
id|STATIC
r_uint8
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|ql_debug_print
id|STATIC
r_uint8
id|ql_debug_print
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#endif
multiline_comment|/*&n; * insmod needs to find the variable and make it point to something&n; */
macro_line|#ifdef MODULE
DECL|variable|options
r_static
r_char
op_star
id|options
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,18)
multiline_comment|/* insmod qla1280 options=verbose&quot; */
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Just in case someone uses commas to separate items on the insmod&n; * command line, we define a dummy buffer here to avoid having insmod&n; * write wild stuff into our code segment&n; */
DECL|variable|dummy_buffer
r_static
r_char
id|dummy_buffer
(braket
l_int|60
)braket
op_assign
l_string|&quot;Please don&squot;t add commas in your insmod command!!&bslash;n&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/* We use the Scsi_Pointer structure that&squot;s included with each command&n; * SCSI_Cmnd as a scratchpad for our SRB.&n; *&n; * SCp will always point to the SRB structure (defined in qla1280.h).&n; * It is define as follows:&n; *  - SCp.ptr  -- &gt; pointer back to the cmd&n; *  - SCp.this_residual --&gt; used as forward pointer to next srb&n; *  - SCp.buffer --&gt; used as backward pointer to next srb&n; *  - SCp.buffers_residual --&gt; used as flags field&n; *  - SCp.have_data_in --&gt; not used&n; *  - SCp.sent_command --&gt; not used&n; *  - SCp.phase --&gt; not used&n; */
DECL|macro|CMD_SP
mdefine_line|#define&t;CMD_SP(Cmnd)&t;&t;(&amp;(Cmnd)-&gt;SCp)
DECL|macro|CMD_XFRLEN
mdefine_line|#define&t;CMD_XFRLEN(Cmnd)&t;(Cmnd)-&gt;request_bufflen
DECL|macro|CMD_CDBLEN
mdefine_line|#define&t;CMD_CDBLEN(Cmnd)&t;(Cmnd)-&gt;cmd_len
DECL|macro|CMD_CDBP
mdefine_line|#define&t;CMD_CDBP(Cmnd)&t;&t;(Cmnd)-&gt;cmnd
DECL|macro|CMD_SNSP
mdefine_line|#define&t;CMD_SNSP(Cmnd)&t;&t;(Cmnd)-&gt;sense_buffer
DECL|macro|CMD_SNSLEN
mdefine_line|#define&t;CMD_SNSLEN(Cmnd)&t;(sizeof (Cmnd)-&gt;sense_buffer)
DECL|macro|CMD_RESULT
mdefine_line|#define&t;CMD_RESULT(Cmnd)&t;((Cmnd)-&gt;result)
DECL|macro|CMD_HANDLE
mdefine_line|#define&t;CMD_HANDLE(Cmnd)&t;((Cmnd)-&gt;host_scribble)
multiline_comment|/*****************************************/
multiline_comment|/*   ISP Boards supported by this driver */
multiline_comment|/*****************************************/
DECL|macro|QLA1280_VENDOR_ID
mdefine_line|#define QLA1280_VENDOR_ID   0x1077
DECL|macro|QLA1080_DEVICE_ID
mdefine_line|#define QLA1080_DEVICE_ID   0x1080
DECL|macro|QLA1240_DEVICE_ID
mdefine_line|#define QLA1240_DEVICE_ID   0x1240
DECL|macro|QLA1280_DEVICE_ID
mdefine_line|#define QLA1280_DEVICE_ID   0x1280
DECL|macro|QLA12160_DEVICE_ID
mdefine_line|#define QLA12160_DEVICE_ID  0x1216
DECL|macro|QLA10160_DEVICE_ID
mdefine_line|#define QLA10160_DEVICE_ID  0x1016
DECL|macro|NUM_OF_ISP_DEVICES
mdefine_line|#define NUM_OF_ISP_DEVICES        6
DECL|struct|_qlaboards
r_typedef
r_struct
id|_qlaboards
(brace
DECL|member|bdName
r_int
r_char
id|bdName
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Board ID String */
DECL|member|device_id
r_int
r_int
id|device_id
suffix:semicolon
multiline_comment|/* Device PCI ID   */
DECL|member|numPorts
r_int
id|numPorts
suffix:semicolon
multiline_comment|/* Number of SCSI ports */
DECL|member|fwcode
r_int
r_int
op_star
id|fwcode
suffix:semicolon
multiline_comment|/* pointer to FW array         */
DECL|member|fwlen
r_int
r_int
op_star
id|fwlen
suffix:semicolon
multiline_comment|/* number of words in array    */
DECL|member|fwstart
r_int
r_int
op_star
id|fwstart
suffix:semicolon
multiline_comment|/* start address for F/W       */
DECL|member|fwver
r_int
r_char
op_star
id|fwver
suffix:semicolon
multiline_comment|/* Ptr to F/W version array    */
DECL|typedef|qla_boards_t
)brace
id|qla_boards_t
suffix:semicolon
DECL|variable|QLBoardTbl
r_struct
id|_qlaboards
id|QLBoardTbl
(braket
id|NUM_OF_ISP_DEVICES
)braket
op_assign
(brace
multiline_comment|/* Name ,  Board PCI Device ID,         Number of ports */
(brace
l_string|&quot;QLA1080 &quot;
comma
id|QLA1080_DEVICE_ID
comma
l_int|1
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1240 &quot;
comma
id|QLA1240_DEVICE_ID
comma
l_int|2
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1280 &quot;
comma
id|QLA1280_DEVICE_ID
comma
l_int|2
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA12160 &quot;
comma
id|QLA12160_DEVICE_ID
comma
l_int|2
comma
op_amp
id|fw12160i_code01
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|fw12160i_length01
comma
op_amp
id|fw12160i_addr01
comma
op_amp
id|fw12160i_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA10160 &quot;
comma
id|QLA10160_DEVICE_ID
comma
l_int|1
comma
op_amp
id|fw12160i_code01
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|fw12160i_length01
comma
op_amp
id|fw12160i_addr01
comma
op_amp
id|fw12160i_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;        &quot;
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|qla1280_verbose
r_static
r_int
r_int
id|qla1280_verbose
op_assign
l_int|1L
suffix:semicolon
DECL|variable|qla1280_hostlist
r_static
id|scsi_qla_host_t
op_star
id|qla1280_hostlist
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef QLA1280_PROFILE
DECL|variable|qla1280_buffer_size
r_static
r_int
id|qla1280_buffer_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|qla1280_buffer
r_static
r_char
op_star
id|qla1280_buffer
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3 
DECL|macro|ENTER
mdefine_line|#define ENTER(x)&t;sprintf(debug_buff,&quot;qla1280 : Entering %s()&bslash;n&bslash;r&quot;, x); &bslash;&n;                        qla1280_print(debug_buff);
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)&t;sprintf(debug_buff,&quot;qla1280 : Leaving %s()&bslash;n&bslash;r&quot;, x); &bslash;&n;                        qla1280_print(debug_buff);
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)&t;sprintf(debug_buff,&quot;qla1280 : Entering %s()&bslash;n&bslash;r&quot;, x); &bslash;&n;                        qla1280_print(debug_buff);
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)&t;sprintf(debug_buff,&quot;qla1280 : Leaving %s()&bslash;n&bslash;r&quot;, x); &bslash;&n;                        qla1280_print(debug_buff);
DECL|macro|DEBUG3
mdefine_line|#define DEBUG3(x)&t;x
macro_line|#else
DECL|macro|ENTER
mdefine_line|#define ENTER(x)
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)
DECL|macro|DEBUG3
mdefine_line|#define DEBUG3(x)
macro_line|#endif
macro_line|#if  DEBUG_QLA1280  
DECL|macro|COMTRACE
mdefine_line|#define COMTRACE(x)
multiline_comment|/* #define COMTRACE(x)     qla1280_putc(x); */
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;x
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)
DECL|macro|COMTRACE
mdefine_line|#define COMTRACE(x)
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_2 
DECL|macro|DEBUG2
mdefine_line|#define DEBUG2(x)&t;x
macro_line|#else
DECL|macro|DEBUG2
mdefine_line|#define DEBUG2(x)
macro_line|#endif
DECL|macro|DEBUG5
mdefine_line|#define DEBUG5(x)
macro_line|#if (BITS_PER_LONG==64)
DECL|macro|OFFSET
macro_line|#   define OFFSET(w)   (((uint64_t) &amp;w) &amp; 0xFF)   /* 256 byte offsets */
macro_line|#else
DECL|macro|OFFSET
macro_line|#   define OFFSET(w)   (((uint32_t) &amp;w) &amp; 0xFF)   /* 256 byte offsets */
macro_line|#endif
DECL|macro|SCSI_BUS_32
mdefine_line|#define SCSI_BUS_32(scp)   ((scp)-&gt;channel)
DECL|macro|SCSI_TCN_32
mdefine_line|#define SCSI_TCN_32(scp)    ((scp)-&gt;target)
DECL|macro|SCSI_LUN_32
mdefine_line|#define SCSI_LUN_32(scp)    ((scp)-&gt;lun)
multiline_comment|/****************************************************************************/
multiline_comment|/*  LINUX -  Loadable Module Functions.                                     */
multiline_comment|/****************************************************************************/
multiline_comment|/*************************************************************************&n; *   qla1280_set_info&n; *&n; * Description:&n; *   Set parameters for the driver from the /proc filesystem.&n; *&n; * Returns:&n; *************************************************************************/
r_int
DECL|function|qla1280_set_info
id|qla1280_set_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|length
comma
r_struct
id|Scsi_Host
op_star
id|HBAptr
)paren
(brace
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
multiline_comment|/* Currently this is a no-op */
)brace
multiline_comment|/*************************************************************************&n; * qla1280_proc_info&n; *&n; * Description:&n; *   Return information to handle /proc support for the driver.&n; *&n; * buffer - ptrs to a page buffer&n; *&n; * Returns:&n; *************************************************************************/
macro_line|#ifdef QLA1280_PROFILE
DECL|macro|PROC_BUF
mdefine_line|#define&t;PROC_BUF&t;(&amp;qla1280_buffer[size])
DECL|macro|LUN_ID
mdefine_line|#define LUN_ID       (targ_lun&gt;&gt;(MAX_T_BITS+MAX_L_BITS)),((targ_lun&gt;&gt;MAX_L_BITS)&amp;0xf), targ_lun&amp;0x7 
macro_line|#endif
r_int
DECL|function|qla1280_proc_info
id|qla1280_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
macro_line|#ifdef QLA1280_PROFILE
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_int
id|targ_lun
suffix:semicolon
id|scsi_lu_t
op_star
id|up
suffix:semicolon
r_int
id|no_devices
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Entering proc_info 0x%p,0x%lx,0x%x,0x%x&bslash;n&quot;
comma
id|buffer
comma
id|offset
comma
id|length
comma
id|hostno
)paren
suffix:semicolon
id|host
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* find the host they want to look at */
r_for
c_loop
(paren
id|ha
op_assign
id|qla1280_hostlist
suffix:semicolon
(paren
id|ha
op_ne
l_int|NULL
)paren
op_logical_and
id|ha-&gt;host-&gt;host_no
op_ne
id|hostno
suffix:semicolon
id|ha
op_assign
id|ha-&gt;next
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|size
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Can&squot;t find adapter for host number %d&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|length
)paren
(brace
r_return
(paren
id|size
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
id|length
)paren
suffix:semicolon
)brace
)brace
id|host
op_assign
id|ha-&gt;host
suffix:semicolon
r_if
c_cond
(paren
id|inout
op_eq
id|TRUE
)paren
multiline_comment|/* Has data been written to the file? */
(brace
r_return
(paren
id|qla1280_set_info
c_func
(paren
id|buffer
comma
id|length
comma
id|host
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* compute number of active devices */
id|no_devices
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|targ_lun
op_assign
l_int|0
suffix:semicolon
id|targ_lun
OL
id|MAX_EQ
suffix:semicolon
id|targ_lun
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|up
op_assign
id|ha-&gt;dev
(braket
id|targ_lun
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|no_devices
op_increment
suffix:semicolon
)brace
multiline_comment|/* size = 112 * no_devices; */
id|size
op_assign
l_int|4096
suffix:semicolon
multiline_comment|/* round up to the next page */
multiline_comment|/* &n;   * if our old buffer is the right size use it otherwise &n;   * allocate a new one.&n;   */
r_if
c_cond
(paren
id|qla1280_buffer_size
op_ne
id|size
)paren
(brace
multiline_comment|/* deallocate this buffer and get a new one */
r_if
c_cond
(paren
id|qla1280_buffer
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer_size
op_assign
l_int|0
suffix:semicolon
)brace
id|qla1280_buffer
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla1280_buffer
op_eq
l_int|NULL
)paren
(brace
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;qla1280 - kmalloc error at line %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
id|qla1280_buffer_size
op_assign
id|size
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Qlogic 1280/1080 SCSI driver version: &quot;
)paren
suffix:semicolon
multiline_comment|/* 43 bytes */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;%5s, &quot;
comma
id|QLA1280_VERSION
)paren
suffix:semicolon
multiline_comment|/* 5        */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Qlogic Firmware version: &quot;
)paren
suffix:semicolon
multiline_comment|/* 25       */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;%2d.%2d.%2d&quot;
comma
id|_firmware_version
(braket
l_int|0
)braket
comma
multiline_comment|/* 8        */
id|ql12_firmware_version
(braket
l_int|1
)braket
comma
id|ql12_firmware_version
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* 1       */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;SCSI Host Adapter Information: %s&bslash;n&quot;
comma
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|bdName
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Request Queue = 0x%lx, Response Queue = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;request_dma
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Request Queue count= 0x%x, Response Queue count= 0x%x&bslash;n&quot;
comma
id|REQUEST_ENTRY_CNT
comma
id|RESPONSE_ENTRY_CNT
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of pending commands = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;actthreads
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of queued commands = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;qthreads
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of free request entries = %d&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* 1       */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Attached devices:&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* scan for all equipment stats */
r_for
c_loop
(paren
id|targ_lun
op_assign
l_int|0
suffix:semicolon
id|targ_lun
OL
id|MAX_EQ
suffix:semicolon
id|targ_lun
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|up
op_assign
id|ha-&gt;dev
(braket
id|targ_lun
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up-&gt;io_cnt
op_eq
l_int|0
)paren
(brace
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;(%2d:%2d:%2d) No stats&bslash;n&quot;
comma
id|LUN_ID
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* total reads since boot */
multiline_comment|/* total writes since boot */
multiline_comment|/* total requests since boot  */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Total requests %ld,&quot;
comma
id|up-&gt;io_cnt
)paren
suffix:semicolon
multiline_comment|/* current number of pending requests */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;(%2d:%2d:%2d) pending requests %d,&quot;
comma
id|LUN_ID
comma
id|up-&gt;q_outcnt
)paren
suffix:semicolon
multiline_comment|/* avg response time */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Avg response time %ld%%,&quot;
comma
(paren
id|up-&gt;resp_time
op_div
id|up-&gt;io_cnt
)paren
op_star
l_int|100
)paren
suffix:semicolon
multiline_comment|/* avg active time */
id|size
op_add_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Avg active time %ld%%&bslash;n&quot;
comma
(paren
id|up-&gt;act_time
op_div
id|up-&gt;io_cnt
)paren
op_star
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_ge
id|qla1280_buffer_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Overflow buffer in qla1280_proc.c&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OG
id|size
op_minus
l_int|1
)paren
(brace
id|kfree
c_func
(paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer
op_assign
l_int|NULL
suffix:semicolon
id|qla1280_buffer_size
op_assign
id|length
op_assign
l_int|0
suffix:semicolon
op_star
id|start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|start
op_assign
op_amp
id|qla1280_buffer
(braket
id|offset
)braket
suffix:semicolon
multiline_comment|/* Start of wanted data */
r_if
c_cond
(paren
id|size
op_minus
id|offset
OL
id|length
)paren
(brace
id|length
op_assign
id|size
op_minus
id|offset
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
(paren
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1280_detect&n; *    This routine will probe for Qlogic 1280 SCSI host adapters.&n; *    It returns the number of host adapters of a particular&n; *    type that were found.&t; It also initialize all data necessary for &n; *    the driver.  It is passed-in the host number, so that it&n; *    knows where its first entry is in the scsi_hosts[] array.&n; *&n; * Input:&n; *     template - pointer to SCSI template&n; *&n; * Returns:&n; *  num - number of host adapters found.  &n; **************************************************************************/
r_int
DECL|function|qla1280_detect
id|qla1280_detect
c_func
(paren
id|Scsi_Host_Template
op_star
r_template
)paren
(brace
r_int
id|num_hosts
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
comma
op_star
id|cur_ha
suffix:semicolon
r_struct
id|_qlaboards
op_star
id|bdp
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt;= KERNEL_VERSION(2,1,95)
r_int
r_int
id|piobase
suffix:semicolon
r_int
r_char
id|pci_bus
comma
id|pci_devfn
comma
id|pci_irq
suffix:semicolon
id|config_reg_t
op_star
id|cfgp
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|device_reg_t
op_star
id|reg
suffix:semicolon
r_char
op_star
id|cp
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,95)
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#else
r_int
id|index
suffix:semicolon
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_detect&quot;
)paren
suffix:semicolon
macro_line|#ifdef CHECKSRBSIZE
r_if
c_cond
(paren
r_sizeof
(paren
id|srb_t
)paren
OG
r_sizeof
(paren
id|Scsi_Pointer
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Redefine SRB - its too big&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef MODULE
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;DEBUG: qla1280_detect starts at address = %p&bslash;n&quot;
comma
id|qla1280_detect
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
)paren
multiline_comment|/*&n;    * If we are called as a module, the qla1280 pointer may not be null&n;    * and it would point to our bootup string, just like on the lilo&n;    * command line.  IF not NULL, then process this config string with&n;    * qla1280_setup&n;    *&n;    * Boot time Options&n;    * To add options at boot time add a line to your lilo.conf file like:&n;    * append=&quot;qla1280=verbose,max_tags:{{255,255,255,255},{255,255,255,255}}&quot;&n;    * which will result in the first four devices on the first two&n;    * controllers being set to a tagged queue depth of 32.&n;    */
r_if
c_cond
(paren
id|options
)paren
(brace
id|qla1280_setup
c_func
(paren
id|options
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dummy_buffer
(braket
l_int|0
)braket
op_ne
l_char|&squot;P&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Please read the file /usr/src/linux/drivers&quot;
l_string|&quot;/scsi/README.qla1280&bslash;n&quot;
l_string|&quot;qla1280: to see the proper way to specify options to the qla1280 &quot;
l_string|&quot;module&bslash;n&quot;
l_string|&quot;qla1280: Specifically, don&squot;t use any commas when passing arguments to&bslash;n&quot;
l_string|&quot;qla1280: insmod or else it might trash certain memory areas.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
r_int
)paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi: PCI not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end of IF */
id|bdp
op_assign
op_amp
id|QLBoardTbl
(braket
l_int|0
)braket
suffix:semicolon
id|qla1280_hostlist
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if 0
r_template
op_member_access_from_pointer
id|proc_dir
op_assign
op_amp
id|proc_scsi_qla1280
suffix:semicolon
macro_line|#else
r_template
op_member_access_from_pointer
id|proc_name
op_assign
l_string|&quot;qla1280&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/* Try and find each different type of adapter we support */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;device_id
op_ne
l_int|0
op_logical_and
id|i
OL
id|NUM_OF_ISP_DEVICES
suffix:semicolon
id|i
op_increment
comma
id|bdp
op_increment
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,95)
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|QLA1280_VENDOR_ID
comma
id|bdp-&gt;device_id
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
op_logical_neg
(paren
id|pcibios_find_device
c_func
(paren
id|QLA1280_VENDOR_ID
comma
id|bdp-&gt;device_id
comma
id|index
op_increment
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_devfn
)paren
)paren
)paren
(brace
macro_line|#endif
multiline_comment|/* found a adapter */
id|host
op_assign
id|scsi_register
c_func
(paren
r_template
comma
r_sizeof
(paren
id|scsi_qla_host_t
)paren
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Clear our data area */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|cp
op_assign
(paren
r_char
op_star
)paren
id|ha
suffix:semicolon
id|j
OL
r_sizeof
(paren
id|scsi_qla_host_t
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|cp
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Sanitize the information from PCI BIOS.  */
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,95)
id|host-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|host-&gt;io_port
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|ha-&gt;pci_bus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|ha-&gt;pci_device_fn
op_assign
id|pdev-&gt;devfn
suffix:semicolon
id|ha-&gt;pdev
op_assign
id|pdev
suffix:semicolon
macro_line|#else
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_devfn
comma
id|OFFSET
c_func
(paren
id|cfgp-&gt;interrupt_line
)paren
comma
op_amp
id|pci_irq
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_devfn
comma
id|OFFSET
c_func
(paren
id|cfgp-&gt;base_port
)paren
comma
op_amp
id|piobase
)paren
suffix:semicolon
id|host-&gt;irq
op_assign
id|pci_irq
suffix:semicolon
id|host-&gt;io_port
op_assign
(paren
r_int
r_int
)paren
id|piobase
suffix:semicolon
id|host-&gt;io_port
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|ha-&gt;pci_bus
op_assign
id|pci_bus
suffix:semicolon
id|ha-&gt;pci_device_fn
op_assign
id|pci_devfn
suffix:semicolon
macro_line|#endif
id|ha-&gt;device_id
op_assign
id|bdp-&gt;device_id
suffix:semicolon
id|ha-&gt;devnum
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_mem_alloc
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed to allocate memory for adapter&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ha-&gt;ports
op_assign
id|bdp-&gt;numPorts
suffix:semicolon
id|ha-&gt;iobase
op_assign
(paren
id|device_reg_t
op_star
)paren
id|host-&gt;io_port
suffix:semicolon
id|ha-&gt;host
op_assign
id|host
suffix:semicolon
id|ha-&gt;host_no
op_assign
id|host-&gt;host_no
suffix:semicolon
multiline_comment|/* load the F/W, read paramaters, and init the H/W */
r_if
c_cond
(paren
id|qla1280_initialize_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed to initialized adapter&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|host-&gt;max_channel
op_assign
id|bdp-&gt;numPorts
op_minus
l_int|1
suffix:semicolon
id|ha-&gt;instance
op_assign
id|num_hosts
suffix:semicolon
multiline_comment|/* Register our resources with Linux */
r_if
c_cond
(paren
id|qla1280_register_with_Linux
c_func
(paren
id|ha
comma
id|bdp-&gt;numPorts
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed to register our resources&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|qla1280_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Insure mailbox registers are free. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_HOST_INT
)paren
suffix:semicolon
multiline_comment|/* Enable chip interrupts. */
id|qla1280_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Insert new entry into the list of adapters */
id|ha-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_hostlist
op_eq
l_int|NULL
)paren
(brace
id|cur_ha
op_assign
id|qla1280_hostlist
op_assign
id|ha
suffix:semicolon
)brace
r_else
(brace
id|cur_ha
op_assign
id|qla1280_hostlist
suffix:semicolon
r_while
c_loop
(paren
id|cur_ha-&gt;next
op_ne
l_int|NULL
)paren
(brace
id|cur_ha
op_assign
id|cur_ha-&gt;next
suffix:semicolon
)brace
id|cur_ha-&gt;next
op_assign
id|ha
suffix:semicolon
)brace
id|num_hosts
op_increment
suffix:semicolon
)brace
multiline_comment|/* end of WHILE */
)brace
multiline_comment|/* end of FOR */
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_detect&quot;
)paren
suffix:semicolon
r_return
id|num_hosts
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;*   qla1280_register_with_Linux&n;*&n;* Description:&n;*   Free the passed in Scsi_Host memory structures prior to unloading the&n;*   module.&n;*&n;* Input:&n;*     ha - pointer to host adapter structure&n;*     maxchannels - MAX number of channels.&n;*&n;* Returns:&n;*  0 - Sucessfully reserved resources.&n;*  1 - Failed to reserved a resource.&n;**************************************************************************/
DECL|function|qla1280_register_with_Linux
id|STATIC
r_uint8
id|qla1280_register_with_Linux
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|maxchannels
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|ha-&gt;host
suffix:semicolon
id|host-&gt;can_queue
op_assign
l_int|0xfffff
suffix:semicolon
multiline_comment|/* unlimited  */
id|host-&gt;cmd_per_lun
op_assign
l_int|1
suffix:semicolon
id|host-&gt;select_queue_depths
op_assign
id|qla1280_select_queue_depth
suffix:semicolon
id|host-&gt;n_io_port
op_assign
l_int|0xFF
suffix:semicolon
id|host-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|ha-&gt;mmpbase
suffix:semicolon
id|host-&gt;max_channel
op_assign
id|maxchannels
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|MAX_LUNS
op_minus
l_int|1
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|ha-&gt;instance
suffix:semicolon
id|host-&gt;max_id
op_assign
id|MAX_TARGETS
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|ha-&gt;instance
suffix:semicolon
multiline_comment|/* set our host ID  (need to do something about our two IDs) */
id|host-&gt;this_id
op_assign
id|ha-&gt;bus_settings
(braket
l_int|0
)braket
dot
id|id
suffix:semicolon
multiline_comment|/* Register the IRQ with Linux (sharable) */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|host-&gt;irq
comma
id|qla1280_intr_handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;qla1280&quot;
comma
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : Failed to reserved interrupt %d already in use&bslash;n&quot;
comma
id|host-&gt;irq
)paren
suffix:semicolon
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Register the I/O space with Linux */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : Failed to reserved i/o region 0x%04lx-0x%04lx already in use&bslash;n&quot;
comma
id|host-&gt;io_port
comma
id|host-&gt;io_port
op_plus
l_int|0xff
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
comma
l_string|&quot;qla1280&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_release&n; *   Free the passed in Scsi_Host memory structures prior to unloading the&n; *   module.&n; **************************************************************************/
r_int
DECL|function|qla1280_release
id|qla1280_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_release&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.online
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* turn-off interrupts on the card */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Detach interrupts */
r_if
c_cond
(paren
id|host-&gt;irq
)paren
(brace
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|ha
)paren
suffix:semicolon
)brace
multiline_comment|/* release io space registers  */
r_if
c_cond
(paren
id|host-&gt;io_port
)paren
(brace
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
suffix:semicolon
)brace
macro_line|#if MEMORY_MAPPED_IO
r_if
c_cond
(paren
id|ha-&gt;mmpbase
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;mmpbase
)paren
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
macro_line|#else
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;mmpbase
)paren
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* MEMORY_MAPPED_IO */
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_release&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_info&n; *     Return a string describing the driver.&n; **************************************************************************/
r_const
r_char
op_star
DECL|function|qla1280_info
id|qla1280_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|qla1280_buffer
(braket
l_int|125
)braket
suffix:semicolon
r_char
op_star
id|bp
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|qla_boards_t
op_star
id|bdp
suffix:semicolon
id|bp
op_assign
op_amp
id|qla1280_buffer
(braket
l_int|0
)braket
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|bdp
op_assign
op_amp
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
suffix:semicolon
id|memset
c_func
(paren
id|bp
comma
l_int|0
comma
r_sizeof
(paren
id|qla1280_buffer
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|bp
comma
l_string|&quot;QLogic %sPCI to SCSI Host Adapter: bus %d device %d irq %d&bslash;n&quot;
l_string|&quot;       Firmware version: %2d.%02d.%02d, Driver version %s&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|bdp-&gt;bdName
(braket
l_int|0
)braket
comma
id|ha-&gt;pci_bus
comma
(paren
id|ha-&gt;pci_device_fn
op_amp
l_int|0xf8
)paren
op_rshift
l_int|3
comma
id|host-&gt;irq
comma
id|bdp-&gt;fwver
(braket
l_int|0
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|1
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|2
)braket
comma
id|QLA1280_VERSION
)paren
suffix:semicolon
r_return
id|bp
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1200_queuecommand&n; *     Queue a command to the controller.&n; *&n; * Note:&n; * The mid-level driver tries to ensures that queuecommand never gets invoked&n; * concurrently with itself or the interrupt handler (although the&n; * interrupt handler may call this routine as part of request-completion&n; * handling).   Unfortunely, it sometimes calls the scheduler in interrupt&n; * context which is a big NO! NO!.&n; **************************************************************************/
r_int
DECL|function|qla1280_queuecommand
id|qla1280_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|fn
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
id|u_long
id|handle
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_queuecommand&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;C&squot;
)paren
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* send command to adapter */
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|sp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|fn
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;flags
op_eq
l_int|0
)paren
multiline_comment|/* new command */
(brace
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
id|DEBUG5
c_func
(paren
id|qla1280_print_scsi_cmd
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|DRIVER_LOCK
r_if
c_cond
(paren
(paren
id|q
op_assign
(paren
id|scsi_lu_t
op_star
)paren
id|KMALLOC
c_func
(paren
r_sizeof
(paren
r_struct
id|scsi_lu
)paren
)paren
)paren
)paren
(brace
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
op_assign
id|q
suffix:semicolon
id|BZERO
c_func
(paren
id|q
comma
r_sizeof
(paren
r_struct
id|scsi_lu
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;Allocate new device queue 0x%x&bslash;n&quot;
comma
id|q
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
id|DRIVER_UNLOCK
)brace
r_else
(brace
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
(paren
r_int
)paren
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|ha-&gt;run_qla_bh
)paren
suffix:semicolon
id|ha-&gt;flags.dpc_sched
op_assign
id|TRUE
suffix:semicolon
id|DRIVER_UNLOCK
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Set an invalid handle until we issue the command to ISP */
multiline_comment|/* then we will set the real handle value.                 */
id|handle
op_assign
id|INVALID_HANDLE
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
id|handle
suffix:semicolon
multiline_comment|/* Bookkeeping information */
id|sp-&gt;r_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* time the request was recieved */
id|sp-&gt;u_start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* add the command to our queue */
id|ha-&gt;qthreads
op_increment
suffix:semicolon
id|qla1280_putq_t
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280_queuecmd: queue pid=%d, hndl=0x%x&bslash;n&bslash;r&quot;
comma
id|cmd-&gt;pid
comma
id|handle
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
multiline_comment|/* send command to adapter */
id|DRIVER_LOCK
r_if
c_cond
(paren
id|q-&gt;q_outcnt
op_eq
l_int|0
)paren
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DRIVER_UNLOCK
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_queuecommand&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1200_abort&n; *     Abort the speciifed SCSI command(s).&n; **************************************************************************/
r_int
DECL|function|qla1280_abort
id|qla1280_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_long
id|handle
suffix:semicolon
id|u_short
id|data
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;A&squot;
)paren
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|DRIVER_LOCK
multiline_comment|/* Get the SCSI request ptr */
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|handle
op_assign
(paren
id|u_long
)paren
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): ABORT Command=0x%lx, handle=0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|cmd
comma
id|handle
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
id|handle
op_eq
l_int|0L
)paren
(brace
id|COMTRACE
c_func
(paren
l_char|&squot;a&squot;
)paren
multiline_comment|/* we never got this command */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Aborting a NULL handle&bslash;n&quot;
)paren
suffix:semicolon
id|DRIVER_UNLOCK
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
)brace
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ha-&gt;flags.in_isr
)paren
op_logical_and
(paren
id|data
op_amp
id|RISC_INT
)paren
)paren
(brace
multiline_comment|/* put any pending command in done queue */
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
id|handle
op_assign
(paren
id|u_long
)paren
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|COMTRACE
c_func
(paren
l_char|&squot;a&squot;
)paren
multiline_comment|/* No lun queue -- command must not be active */
id|DRIVER_UNLOCK
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280 (%d:%d:%d): No LUN queue for the specified device&bslash;n&quot;
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
)brace
macro_line|#if AUTO_ESCALATE_ABORT
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORTED
)paren
)paren
(brace
id|DRIVER_UNLOCK
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_abort: Abort escalayted - returning SCSI_ABORT_SNOOZE.&bslash;n&bslash;r&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORT_PENDING
)paren
)paren
(brace
id|COMTRACE
c_func
(paren
l_char|&squot;a&squot;
)paren
id|DRIVER_UNLOCK
r_if
c_cond
(paren
id|qla1280_verbose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi(): Command has a pending abort message - ABORT_PENDING.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280: Command has a pending abort message - ABORT_PENDING.&bslash;n&bslash;r&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
macro_line|#if  STOP_ON_ABORT 
id|printk
c_func
(paren
l_string|&quot;Scsi layer issued a ABORT command= 0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|qla1280_print_scsi_cmd
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ha-&gt;flags.in_abort
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;    * Normally, would would need to search our queue for the specified command&n;    * but; since our sp contains the cmd ptr, we can just remove it from our&n;    * LUN queue.&n;    */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
id|SRB_SENT
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi(): Command returned from queue aborted.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280: Command returned from queue aborted.&bslash;n&bslash;r&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Remove srb from SCSI LU queue. */
id|qla1280_removeq
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* find the command in our active list */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sp
op_eq
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
(brace
id|found
op_increment
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280: RISC aborting command.&bslash;n&bslash;r&quot;
)paren
)paren
suffix:semicolon
id|qla1280_abort_command
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_PENDING
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#if  STOP_ON_ABORT 
id|qla1280_panic
c_func
(paren
l_string|&quot;qla1280_abort&quot;
comma
id|ha-&gt;host
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
id|return_status
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280_abort: Aborted status returned = 0x%x.&bslash;n&bslash;r&quot;
comma
id|return_status
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
(brace
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
(brace
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|ha-&gt;flags.in_abort
op_assign
id|FALSE
suffix:semicolon
id|DRIVER_UNLOCK
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;a&squot;
)paren
r_return
id|return_status
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1200_reset&n; *    The reset function will reset the SCSI bus and abort any executing&n; *    commands. &n; *&n; * Input:&n; *      cmd = Linux SCSI command packet of the command that cause the&n; *            bus reset.&n; *      flags = SCSI bus reset option flags (see scsi.h)&n; *&n; * Returns:&n; *      DID_RESET in cmd.host_byte of aborted command(s) &n; *&n; * Note:&n; *      Resetting the bus always succeeds - is has to, otherwise the&n; *      kernel will panic! Try a surgical technique - sending a BUS&n; *      DEVICE RESET message - on the offending target before pulling&n; *      the SCSI bus reset line.&n; **************************************************************************/
r_int
DECL|function|qla1280_reset
id|qla1280_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|flags
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_typedef
r_enum
(brace
id|ABORT_DEVICE
op_assign
l_int|1
comma
id|DEVICE_RESET
op_assign
l_int|2
comma
id|BUS_RESET
op_assign
l_int|3
comma
id|ADAPTER_RESET
op_assign
l_int|4
comma
id|RESET_DELAYED
op_assign
l_int|5
comma
id|FAIL
op_assign
l_int|6
)brace
id|action_t
suffix:semicolon
id|action_t
id|action
op_assign
id|ADAPTER_RESET
suffix:semicolon
id|u_short
id|data
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_reset&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;R&squot;
)paren
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
l_string|&quot;scsi(): Resetting Cmnd=0x%lx, Handle=0x%lx, flags=0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd
comma
(paren
r_int
)paren
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(scsi?:?:?:?) Reset called with NULL Scsi_Cmnd &quot;
l_string|&quot;pointer, failing.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SNOOZE
suffix:semicolon
)brace
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#if  STOP_ON_RESET 
id|qla1280_panic
c_func
(paren
l_string|&quot;qla1280_reset&quot;
comma
id|ha-&gt;host
)paren
suffix:semicolon
macro_line|#endif 
id|DRIVER_LOCK
multiline_comment|/* Check for pending interrupts. */
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ha-&gt;flags.in_isr
)paren
op_logical_and
(paren
id|data
op_amp
id|RISC_INT
)paren
)paren
(brace
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
id|DRIVER_UNLOCK
multiline_comment|/*&n;    * Determine the suggested action that the mid-level driver wants&n;    * us to perform.&n;    */
r_if
c_cond
(paren
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
op_eq
(paren
r_int
r_char
op_star
)paren
l_int|0
)paren
(brace
multiline_comment|/* &n;        * if mid-level driver called reset with a orphan SCSI_Cmnd &n;        * (i.e. a command that&squot;s not pending ), so perform the &n;        * function specified.&n;        */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
)paren
(brace
id|action
op_assign
id|ADAPTER_RESET
suffix:semicolon
)brace
r_else
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &n;        * Mid-level driver has called reset with this SCSI_Cmnd and &n;        * its pending.&n;        */
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
(brace
id|action
op_assign
id|ADAPTER_RESET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SUGGEST_BUS_RESET
)paren
(brace
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
r_else
id|action
op_assign
id|DEVICE_RESET
suffix:semicolon
)brace
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
macro_line|#if AUTO_ESCALATE_RESET
r_if
c_cond
(paren
(paren
id|action
op_amp
id|DEVICE_RESET
)paren
op_logical_and
(paren
id|q-&gt;q_flag
op_amp
id|QLA1280_QRESET
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%d): Bus device reset already sent to &quot;
l_string|&quot;device, escalating.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|action
op_amp
id|DEVICE_RESET
)paren
op_logical_and
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORT_PENDING
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%d):Have already attempted to reach &quot;
l_string|&quot;device with abort device&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%d):message, will escalate to BUS &quot;
l_string|&quot;RESET.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;    *  By this point, we want to already know what we are going to do,&n;    *  so we only need to perform the course of action.&n;    */
id|DRIVER_LOCK
id|result
op_assign
id|SCSI_RESET_ERROR
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|FAIL
suffix:colon
r_break
suffix:semicolon
r_case
id|RESET_DELAYED
suffix:colon
id|result
op_assign
id|SCSI_RESET_PENDING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ABORT_DEVICE
suffix:colon
id|ha-&gt;flags.in_reset
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): Queueing abort device command.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
)paren
suffix:semicolon
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
comma
id|DID_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_abort_device
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
op_eq
l_int|0
)paren
(brace
id|result
op_assign
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DEVICE_RESET
suffix:colon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): Queueing device reset command.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
comma
id|DID_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_device_reset
c_func
(paren
id|ha
comma
id|b
comma
id|t
)paren
op_eq
l_int|0
)paren
(brace
id|result
op_assign
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
id|q-&gt;q_flag
op_or_assign
id|QLA1280_QRESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_RESET
suffix:colon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%d:%d:%d:%d): Issuing BUS DEVICE RESET.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
comma
id|DID_RESET
)paren
suffix:semicolon
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|b
)paren
suffix:semicolon
multiline_comment|/*&n;                * The bus reset routine returns all the outstanding commands back&n;                * with &quot;DID_RESET&quot; in the status field after a short delay&n;                * by the firmware. If the mid-level time out the SCSI reset before&n;                * our delay we may need to ignore it.&n;                */
multiline_comment|/* result = SCSI_RESET_PENDING | SCSI_RESET_BUS_RESET; */
id|result
op_assign
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_BUS_RESET
suffix:semicolon
id|mdelay
c_func
(paren
l_int|4
op_star
l_int|1000
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SYNCHRONOUS
)paren
(brace
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
(paren
r_int
)paren
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* ha-&gt;reset_start = jiffies; */
r_break
suffix:semicolon
r_case
id|ADAPTER_RESET
suffix:colon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): Issued an ADAPTER RESET.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): I/O processing will continue automatically.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
)paren
suffix:semicolon
)brace
id|ha-&gt;flags.reset_active
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* &n;                * We restarted all of the commands automatically, so the mid-level code can expect &n;                * completions momentitarily.&n;                */
r_if
c_cond
(paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
op_eq
l_int|0
)paren
(brace
id|result
op_assign
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_HOST_RESET
suffix:semicolon
)brace
id|ha-&gt;flags.reset_active
op_assign
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
(brace
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
id|FALSE
suffix:semicolon
id|DRIVER_UNLOCK
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;RESET returning %d&bslash;n&quot;
comma
id|result
)paren
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;r&squot;
)paren
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_reset&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1200_biosparam&n; *   Return the disk geometry for the given SCSI device.&n; **************************************************************************/
r_int
DECL|function|qla1280_biosparam
id|qla1280_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cylinders
OG
l_int|1024
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
multiline_comment|/* if (cylinders &gt; 1023)&n;        cylinders = 1023; */
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1280_intr_handler&n; *   Handles the H/W interrupt&n; **************************************************************************/
DECL|function|qla1280_intr_handler
r_void
id|qla1280_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|u_short
id|data
suffix:semicolon
id|device_reg_t
op_star
id|reg
suffix:semicolon
id|ENTER_INTR
c_func
(paren
l_string|&quot;qla1280_intr_handler&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;I&squot;
)paren
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(): Interrupt with NULL host ptr&bslash;n&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;X&squot;
)paren
r_return
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|QLA1280_IN_ISR_BIT
comma
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
id|COMTRACE
c_func
(paren
l_char|&squot;X&squot;
)paren
r_return
suffix:semicolon
)brace
id|ha-&gt;isr_count
op_increment
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* disable our interrupt. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_amp
id|RISC_INT
)paren
)paren
(brace
multiline_comment|/* spurious interrupts can happen legally */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Spurious interrupt - ignoring&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;X&squot;
)paren
)brace
r_else
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|QLA1280_IN_ISR_BIT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
macro_line|#else  /* LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95) */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|QLA1280_IN_ISR_BIT
comma
(paren
r_int
op_star
)paren
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
id|COMTRACE
c_func
(paren
l_char|&squot;X&squot;
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d): Already in interrupt - returning &bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|QLA1280_IN_ISR_BIT
comma
(paren
r_int
op_star
)paren
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|ha-&gt;isr_count
op_increment
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* disable our interrupt. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_amp
id|RISC_INT
)paren
)paren
(brace
multiline_comment|/* spurious interrupts can happen legally */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Spurious interrupt - ignoring&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;X&squot;
)paren
)brace
r_else
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
multiline_comment|/* if no work to do then call the SCSI mid-level right away */
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
(brace
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
multiline_comment|/* Schedule the DPC routine */
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
op_logical_or
id|ha-&gt;flags.reset_marker
op_logical_or
id|ha-&gt;done_q_first
)paren
(brace
id|ha-&gt;run_qla_bh.data
op_assign
(paren
r_void
op_star
)paren
id|ha
suffix:semicolon
id|ha-&gt;run_qla_bh.routine
op_assign
id|qla1280_do_dpc
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;P&squot;
)paren
id|schedule_task
c_func
(paren
op_amp
id|ha-&gt;run_qla_bh
)paren
suffix:semicolon
id|ha-&gt;flags.dpc_sched
op_assign
id|TRUE
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|QLA1280_IN_ISR_BIT
comma
(paren
r_int
op_star
)paren
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* enable our interrupt. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_EN_INT
op_plus
id|ISP_EN_RISC
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;i&squot;
)paren
id|LEAVE_INTR
c_func
(paren
l_string|&quot;qla1280_intr_handler&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_do_dpc&n; *&n; * Description:&n; * This routine is a task that is schedule by the interrupt handler &n; * to perform the background processing for interrupts.  We put it &n; * on a task queue that is consumed whenever the scheduler runs; that&squot;s&n; * so you can do anything (i.e. put the process to sleep etc).  In fact, the &n; * mid-level tries to sleep when it reaches the driver threshold &n; * &quot;host-&gt;can_queue&quot;. This can cause a panic if we were in our interrupt&n; * code .&n; **************************************************************************/
DECL|function|qla1280_do_dpc
r_static
r_void
id|qla1280_do_dpc
c_func
(paren
r_void
op_star
id|p
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|p
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|COMTRACE
c_func
(paren
l_char|&squot;p&squot;
)paren
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,95)
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
)paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|ha-&gt;flags.dpc_sched
op_assign
id|FALSE
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,95)
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_device_queue_depth&n; *&n; * Description:&n; *   Determines the queue depth for a given device.  There are two ways&n; *   a queue depth can be obtained for a tagged queueing device.  One&n; *   way is the default queue depth which is determined by whether&n; *   If it is defined, then it is used&n; *   as the default queue depth.  Otherwise, we use either 4 or 8 as the&n; *   default queue depth (dependent on the number of hardware SCBs).&n; **************************************************************************/
DECL|function|qla1280_device_queue_depth
id|STATIC
r_void
id|qla1280_device_queue_depth
c_func
(paren
id|scsi_qla_host_t
op_star
id|p
comma
id|Scsi_Device
op_star
id|device
)paren
(brace
r_int
id|default_depth
op_assign
l_int|3
suffix:semicolon
r_int
id|bus
op_assign
id|device-&gt;channel
suffix:semicolon
r_int
id|target
op_assign
id|device-&gt;id
suffix:semicolon
id|device-&gt;queue_depth
op_assign
id|default_depth
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tagged_supported
op_logical_and
(paren
id|p-&gt;bus_settings
(braket
id|bus
)braket
dot
id|qtag_enables
op_amp
(paren
id|BIT_0
op_lshift
id|target
)paren
)paren
)paren
(brace
id|device-&gt;tagged_queue
op_assign
l_int|1
suffix:semicolon
id|device-&gt;current_tag
op_assign
l_int|0
suffix:semicolon
id|device-&gt;queue_depth
op_assign
id|p-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
suffix:semicolon
multiline_comment|/* device-&gt;queue_depth = 20; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): Enabled tagged queuing, queue depth %d.&bslash;n&quot;
comma
(paren
r_int
)paren
id|p-&gt;host_no
comma
id|device-&gt;channel
comma
id|device-&gt;id
comma
id|device-&gt;lun
comma
id|device-&gt;queue_depth
)paren
suffix:semicolon
)brace
id|qla12160_get_target_parameters
c_func
(paren
id|p
comma
id|bus
comma
id|target
comma
id|device-&gt;lun
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_select_queue_depth&n; *&n; *   Sets the queue depth for each SCSI device hanging off the input&n; *   host adapter.  We use a queue depth of 2 for devices that do not&n; *   support tagged queueing.&n; **************************************************************************/
id|STATIC
r_void
DECL|function|qla1280_select_queue_depth
id|qla1280_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Device
op_star
id|scsi_devs
)paren
(brace
id|Scsi_Device
op_star
id|device
suffix:semicolon
id|scsi_qla_host_t
op_star
id|p
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_select_queue_depth&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|device
op_assign
id|scsi_devs
suffix:semicolon
id|device
op_ne
l_int|NULL
suffix:semicolon
id|device
op_assign
id|device-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;host
op_eq
id|host
)paren
id|qla1280_device_queue_depth
c_func
(paren
id|p
comma
id|device
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_select_queue_depth&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*--------------------------**&n;** Driver Support Routines  **&n;**--------------------------*/
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)
multiline_comment|/*&n; * mdelay&n; *      Delay in milliseconds &n; *&n; * Input:&n; *      milliseconds  = delay &n; */
DECL|function|mdelay
id|STATIC
r_inline
r_void
id|mdelay
c_func
(paren
r_int
id|milliseconds
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|milliseconds
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * qla1280_done&n; *      Process completed commands.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_done
id|qla1280_done
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_done&quot;
)paren
suffix:semicolon
id|COMTRACE
c_func
(paren
l_char|&squot;D&squot;
)paren
id|DRIVER_LOCK
r_while
c_loop
(paren
op_star
id|done_q_first
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* remove command from done list */
id|sp
op_assign
op_star
id|done_q_first
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|done_q_first
op_assign
id|sp-&gt;s_next
)paren
)paren
op_star
id|done_q_last
op_assign
l_int|NULL
suffix:semicolon
r_else
(paren
op_star
id|done_q_first
)paren
op_member_access_from_pointer
id|s_prev
op_assign
l_int|NULL
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* Decrement outstanding commands on device. */
r_if
c_cond
(paren
id|q-&gt;q_outcnt
)paren
id|q-&gt;q_outcnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
OL
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|hiwat
)paren
(brace
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QBUSY
suffix:semicolon
)brace
id|q-&gt;resp_time
op_add_assign
id|jiffies
op_minus
id|sp-&gt;r_start
suffix:semicolon
multiline_comment|/* Lun bookkeeping information */
id|q-&gt;act_time
op_add_assign
id|jiffies
op_minus
id|sp-&gt;u_start
suffix:semicolon
id|q-&gt;io_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;dir
op_amp
id|BIT_5
)paren
(brace
id|q-&gt;r_cnt
op_increment
suffix:semicolon
)brace
r_else
id|q-&gt;w_cnt
op_increment
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_rshift
l_int|16
)paren
)paren
(brace
r_case
id|DID_RESET
suffix:colon
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QRESET
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
l_int|0
comma
id|MK_SYNC_ID
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_ABORT
suffix:colon
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_ABORT_PENDING
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_TIMEOUT
)paren
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* Call the mid-level driver interrupt handler */
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|0
suffix:semicolon
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
id|sti
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#endif
id|qla1280_next
c_func
(paren
id|ha
comma
id|q
comma
id|b
)paren
suffix:semicolon
)brace
id|DRIVER_UNLOCK
id|COMTRACE
c_func
(paren
l_char|&squot;d&squot;
)paren
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_done&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Translates a ISP error to a Linux SCSI error&n; */
DECL|function|qla1280_return_status
id|STATIC
r_int
id|qla1280_return_status
c_func
(paren
id|sts_entry_t
op_star
id|sts
comma
id|Scsi_Cmnd
op_star
id|cp
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
macro_line|#if DEBUG_QLA1280_INTR
id|STATIC
r_char
op_star
id|reason
(braket
)braket
op_assign
(brace
l_string|&quot;DID_OK&quot;
comma
l_string|&quot;DID_NO_CONNECT&quot;
comma
l_string|&quot;DID_BUS_BUSY&quot;
comma
l_string|&quot;DID_TIME_OUT&quot;
comma
l_string|&quot;DID_BAD_TARGET&quot;
comma
l_string|&quot;DID_ABORT&quot;
comma
l_string|&quot;DID_PARITY&quot;
comma
l_string|&quot;DID_ERROR&quot;
comma
l_string|&quot;DID_RESET&quot;
comma
l_string|&quot;DID_BAD_INTR&quot;
)brace
suffix:semicolon
macro_line|#endif /* DEBUG_QLA1280_INTR */
id|ENTER
c_func
(paren
l_string|&quot;qla1280_return_status&quot;
)paren
suffix:semicolon
macro_line|#if DEBUG_QLA1280_INTR
multiline_comment|/*&n;    DEBUG(printk(&quot;qla1280_return_status: compl status = 0x%04x&bslash;n&quot;, sts-&gt;comp_status));&n;    */
macro_line|#endif
r_switch
c_cond
(paren
id|sts-&gt;comp_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_INCOMPLETE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_BUS
)paren
)paren
id|host_status
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_TARGET
)paren
)paren
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_SENT_CDB
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_TRANSFERRED_DATA
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_STATUS
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_2 
id|printk
c_func
(paren
l_string|&quot;Data overrun 0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|sts-&gt;residual_length
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;rqla1280_isr: response packet data&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|sts
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
r_if
c_cond
(paren
(paren
id|CMD_XFRLEN
c_func
(paren
id|cp
)paren
op_minus
id|sts-&gt;residual_length
)paren
OL
id|cp-&gt;underflow
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi: Underflow detected - retrying command.&bslash;n&quot;
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
)brace
r_else
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if DEBUG_QLA1280_INTR
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 ISP status: host status (%s) scsi status %x&bslash;n&bslash;r&quot;
comma
id|reason
(braket
id|host_status
)braket
comma
id|sts-&gt;scsi_status
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_return_status&quot;
)paren
suffix:semicolon
r_return
(paren
id|sts-&gt;scsi_status
op_amp
l_int|0xff
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_done_q_put&n; *      Place SRB command on done queue.&n; *&n; * Input:&n; *      sp           = srb pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_done_q_put
id|qla1280_done_q_put
c_func
(paren
id|srb_t
op_star
id|sp
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_put_done_q&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Place block on done queue */
id|DRIVER_LOCK
id|sp-&gt;s_next
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;s_prev
op_assign
op_star
id|done_q_last
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|done_q_first
)paren
op_star
id|done_q_first
op_assign
id|sp
suffix:semicolon
r_else
(paren
op_star
id|done_q_last
)paren
op_member_access_from_pointer
id|s_next
op_assign
id|sp
suffix:semicolon
op_star
id|done_q_last
op_assign
id|sp
suffix:semicolon
id|DRIVER_UNLOCK
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_put_done_q&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_next&n; *      Retrieve and process next job in the queue.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      q  = SCSI LU pointer.&n; *      b  = SCSI bus number.&n; *      SCSI_LU_Q lock must be already obtained and no other locks.&n; *&n; * Output:&n; *      Releases SCSI_LU_Q upon exit.&n; */
id|STATIC
r_void
DECL|function|qla1280_next
id|qla1280_next
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|scsi_lu_t
op_star
id|q
comma
r_uint8
id|b
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
r_uint8
id|status
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_next&quot;
)paren
suffix:semicolon
id|DRIVER_LOCK
r_while
c_loop
(paren
(paren
(paren
id|sp
op_assign
id|q-&gt;q_first
)paren
op_ne
l_int|NULL
)paren
op_logical_and
multiline_comment|/* we have a queue pending */
op_logical_neg
(paren
id|q-&gt;q_flag
op_amp
id|QLA1280_QBUSY
)paren
op_logical_and
multiline_comment|/* device not busy */
op_logical_neg
id|ha-&gt;flags.abort_isp_active
op_logical_and
multiline_comment|/* not resetting the adapter */
op_logical_neg
(paren
id|q-&gt;q_flag
op_amp
id|QLA1280_QSUSP
)paren
)paren
multiline_comment|/* device not suspended */
(brace
multiline_comment|/* Remove srb from SCSI LU queue. */
id|qla1280_removeq
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;starting request 0x%p&lt;-(0x%p)&bslash;n&bslash;r&quot;
comma
id|q
comma
id|sp
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
(brace
multiline_comment|/* Set busy flag if reached high water mark. */
id|q-&gt;q_outcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
op_ge
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|hiwat
)paren
id|q-&gt;q_flag
op_or_assign
id|QLA1280_QBUSY
suffix:semicolon
macro_line|#if  QLA1280_64BIT_SUPPORT
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|status
op_assign
id|qla1280_64bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_else
macro_line|#endif
id|status
op_assign
id|qla1280_32bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
multiline_comment|/* if couldn&squot;t start the request */
(brace
r_if
c_cond
(paren
id|q-&gt;q_outcnt
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Release SCSI LU queue specific lock */
id|QLA1280_SCSILU_UNLOCK
c_func
(paren
id|q
)paren
suffix:semicolon
multiline_comment|/* Wait for 30 sec for command to be accepted. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
macro_line|#if  QLA1280_64BIT_SUPPORT
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|status
op_assign
id|qla1280_64bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_else
macro_line|#endif
id|status
op_assign
id|qla1280_32bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Go check for pending interrupts. */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
id|SYS_DELAY
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 10 */
)brace
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
(brace
multiline_comment|/* Set timeout status */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
macro_line|#if WATCHDOGTIMER
multiline_comment|/* Remove command from watchdog queue. */
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_WATCHDOG
)paren
id|qla1280_timeout_remove
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
macro_line|#endif
id|COMTRACE
c_func
(paren
l_char|&squot;M&squot;
)paren
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|0
suffix:semicolon
multiline_comment|/* Call the mid-level driver interrupt handler */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
id|sti
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
(paren
id|sp-&gt;cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
(paren
op_star
(paren
id|sp-&gt;cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Acquire LU queue specific lock */
id|QLA1280_SCSILU_LOCK
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
)paren
id|q-&gt;q_outcnt
op_decrement
suffix:semicolon
)brace
r_else
multiline_comment|/* Acquire LU queue specific lock */
id|QLA1280_SCSILU_LOCK
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Place request back on top of device queue. */
id|qla1280_putq_t
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
)paren
id|q-&gt;q_outcnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
OL
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|hiwat
)paren
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QBUSY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|DRIVER_UNLOCK
multiline_comment|/* Release SCSI LU queue specific lock */
id|QLA1280_SCSILU_UNLOCK
c_func
(paren
id|q
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_next&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_putq_t&n; *      Add the standard SCB job to the top of standard SCB commands.&n; *&n; * Input:&n; *      q  = SCSI LU pointer.&n; *      sp = srb pointer.&n; *      SCSI_LU_Q lock must be already obtained.&n; */
id|STATIC
r_void
DECL|function|qla1280_putq_t
id|qla1280_putq_t
c_func
(paren
id|scsi_lu_t
op_star
id|q
comma
id|srb_t
op_star
id|sp
)paren
(brace
id|srb_t
op_star
id|srb_p
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_putq_t&quot;
)paren
suffix:semicolon
macro_line|#endif
id|DRIVER_LOCK
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;Adding to device 0x%p&lt;-(0x%p)&bslash;n&bslash;r&quot;
comma
id|q
comma
id|sp
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
id|sp-&gt;s_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q-&gt;q_first
)paren
multiline_comment|/* If queue empty */
(brace
id|sp-&gt;s_prev
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;q_first
op_assign
id|sp
suffix:semicolon
id|q-&gt;q_last
op_assign
id|sp
suffix:semicolon
)brace
r_else
(brace
id|srb_p
op_assign
id|q-&gt;q_first
suffix:semicolon
r_while
c_loop
(paren
id|srb_p
)paren
id|srb_p
op_assign
id|srb_p-&gt;s_next
suffix:semicolon
r_if
c_cond
(paren
id|srb_p
)paren
(brace
id|sp-&gt;s_prev
op_assign
id|srb_p-&gt;s_prev
suffix:semicolon
r_if
c_cond
(paren
id|srb_p-&gt;s_prev
)paren
id|srb_p-&gt;s_prev-&gt;s_next
op_assign
id|sp
suffix:semicolon
r_else
id|q-&gt;q_first
op_assign
id|sp
suffix:semicolon
id|srb_p-&gt;s_prev
op_assign
id|sp
suffix:semicolon
id|sp-&gt;s_next
op_assign
id|srb_p
suffix:semicolon
)brace
r_else
(brace
id|sp-&gt;s_prev
op_assign
id|q-&gt;q_last
suffix:semicolon
id|q-&gt;q_last-&gt;s_next
op_assign
id|sp
suffix:semicolon
id|q-&gt;q_last
op_assign
id|sp
suffix:semicolon
)brace
)brace
id|DRIVER_UNLOCK
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_putq_t&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_removeq&n; *      Function used to remove a command block from the&n; *      LU queue.&n; *&n; * Input:&n; *      q  = SCSI LU pointer.&n; *      sp = srb pointer.&n; *      SCSI_LU_Q lock must be already obtained.&n; */
id|STATIC
r_void
DECL|function|qla1280_removeq
id|qla1280_removeq
c_func
(paren
id|scsi_lu_t
op_star
id|q
comma
id|srb_t
op_star
id|sp
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;Removing from device_q (0x%p)-&gt;(0x%p)&bslash;n&bslash;r&quot;
comma
id|q
comma
id|sp
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
id|DRIVER_LOCK
r_if
c_cond
(paren
id|sp-&gt;s_prev
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp-&gt;s_prev-&gt;s_next
op_assign
id|sp-&gt;s_next
)paren
op_ne
l_int|NULL
)paren
id|sp-&gt;s_next-&gt;s_prev
op_assign
id|sp-&gt;s_prev
suffix:semicolon
r_else
id|q-&gt;q_last
op_assign
id|sp-&gt;s_prev
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|q-&gt;q_first
op_assign
id|sp-&gt;s_next
)paren
)paren
id|q-&gt;q_last
op_assign
l_int|NULL
suffix:semicolon
r_else
id|q-&gt;q_first-&gt;s_prev
op_assign
l_int|NULL
suffix:semicolon
id|DRIVER_UNLOCK
)brace
multiline_comment|/*&n;* qla1280_mem_alloc&n;*      Allocates adapter memory.&n;*&n;* Returns:&n;*      0  = success.&n;*      1  = failure.&n;*/
id|STATIC
r_uint8
DECL|function|qla1280_mem_alloc
id|qla1280_mem_alloc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint8
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_mem_alloc&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DYNAMIC_MEM_ALLOC
id|ha-&gt;request_ring
op_assign
id|qla1280_alloc_phys
c_func
(paren
id|REQUEST_ENTRY_SIZE
op_star
id|REQUEST_ENTRY_CNT
comma
op_amp
id|ha-&gt;request_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;request_ring
)paren
(brace
id|ha-&gt;response_ring
op_assign
id|qla1280_alloc_phys
c_func
(paren
id|RESPONSE_ENTRY_SIZE
op_star
id|RESPONSE_ENTRY_CNT
comma
op_amp
id|ha-&gt;response_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;response_ring
)paren
(brace
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#else
id|ha-&gt;request_ring
op_assign
op_amp
id|ha-&gt;req
(braket
l_int|0
)braket
suffix:semicolon
id|ha-&gt;request_dma
op_assign
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|ha-&gt;req
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ha-&gt;response_ring
op_assign
op_amp
id|ha-&gt;res
(braket
l_int|0
)braket
suffix:semicolon
id|ha-&gt;response_dma
op_assign
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|ha-&gt;res
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
(brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_mem_alloc: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_mem_alloc&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_mem_free&n; *      Frees adapter allocated memory.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_mem_free
id|qla1280_mem_free
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qlc1280_mem_free&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha
)paren
(brace
multiline_comment|/* Free device queues. */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|MAX_BUSES
suffix:semicolon
id|b
op_increment
)paren
(brace
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|id
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
r_if
c_cond
(paren
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
op_ne
l_int|NULL
op_logical_and
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
op_ne
id|q
)paren
id|KMFREE
c_func
(paren
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
comma
r_sizeof
(paren
r_struct
id|scsi_lu
)paren
)paren
suffix:semicolon
id|KMFREE
c_func
(paren
id|q
comma
r_sizeof
(paren
r_struct
id|scsi_lu
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|MAX_EQ
suffix:semicolon
id|b
op_increment
)paren
(brace
id|ha-&gt;dev
(braket
id|b
)braket
op_assign
(paren
id|scsi_lu_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qlc1280_mem_free&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                QLogic ISP1280 Hardware Support Functions.                */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; * qla2100_enable_intrs&n; * qla2100_disable_intrs&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      None      &n; */
DECL|function|qla1280_enable_intrs
r_static
r_inline
r_void
id|qla1280_enable_intrs
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ha-&gt;flags.interrupts_on
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* enable risc and host interrupts */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
(paren
id|ISP_EN_INT
op_plus
id|ISP_EN_RISC
)paren
)paren
suffix:semicolon
)brace
DECL|function|qla1280_disable_intrs
r_static
r_inline
r_void
id|qla1280_disable_intrs
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ha-&gt;flags.interrupts_on
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable risc and host interrupts */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_initialize_adapter&n; *      Initialize board.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_initialize_adapter
id|qla1280_initialize_adapter
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
suffix:semicolon
r_uint8
id|status
suffix:semicolon
multiline_comment|/* uint8_t      cnt; */
r_uint8
id|b
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_initialize_adapter&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Clear adapter flags. */
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.disable_host_adapter
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.reset_active
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.watchdog_enabled
op_assign
id|FALSE
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Configure PCI space for adapter...&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_pci_config
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Insure mailbox registers are free. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_HOST_INT
)paren
suffix:semicolon
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Determining if RISC is loaded...&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_isp_firmware
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Verifying chip...&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_chip_diag
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Setup chip...&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
id|status
op_assign
id|qla1280_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Setup adapter based on NVRAM parameters. */
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Configure NVRAM parameters...&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
)paren
suffix:semicolon
id|qla1280_nvram_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.disable_host_adapter
op_logical_and
op_logical_neg
id|qla1280_init_rings
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* Issue SCSI reset. */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|disable_scsi_reset
)paren
(brace
multiline_comment|/* dg 03/13 if we can&squot;t reset twice then bus is dead */
r_if
c_cond
(paren
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|b
)paren
)paren
r_if
c_cond
(paren
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|b
)paren
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|scsi_bus_dead
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_do
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|reset_marker
op_assign
id|FALSE
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
suffix:semicolon
id|ha-&gt;flags.online
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Enable host adapter target mode. */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_enable_tgt
c_func
(paren
id|ha
comma
id|b
)paren
)paren
)paren
(brace
multiline_comment|/* for (cnt = 0; cnt &lt; MAX_LUNS; cnt++)&n;                            {&n;                                qla1280_enable_lun(ha, b, cnt);&n;                                 qla1280_poll(ha);&n;                            }*/
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
r_else
id|status
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_initialize_adapter: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_initialize_adapter&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_enable_tgt&n; *      Enable target mode.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      b  = SCSI bus number.&n; *&n; * Returns:&n; *      0 = success.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_enable_tgt
id|qla1280_enable_tgt
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|b
)paren
(brace
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  uint16_t    mb[MAILBOX_REGISTER_COUNT]; */
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_enable_tgt: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable target mode. */
multiline_comment|/*&n;    mb[0] = MBC_ENABLE_TARGET_MODE;&n;    mb[1] = BIT_15;&n;    mb[2] = (uint16_t)(b &lt;&lt; 15);&n;    status = qla1280_mailbox_command(ha, BIT_2|BIT_1|BIT_0, &amp;mb[0]);&n;    */
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_enable_tgt: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_enable_tgt: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * ISP Firmware Test&n; *      Checks if present version of RISC firmware is older than&n; *      driver firmware.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = firmware does not need to be loaded.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_isp_firmware
id|qla1280_isp_firmware
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|nvram_t
op_star
id|nv
op_assign
(paren
id|nvram_t
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint8
id|chksum
suffix:semicolon
r_uint8
id|cnt
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dg 2/27 always loads RISC */
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isp_firmware&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify valid NVRAM checksum. */
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280_isp_firmware: Reading NVRAM&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|chksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
r_sizeof
(paren
id|nvram_t
)paren
op_div
l_int|2
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|qla1280_get_nvram_word
c_func
(paren
id|ha
comma
id|cnt
)paren
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
op_star
id|wptr
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280_isp_firmware: Completed Reading NVRAM&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_3)
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280_isp_firmware: NVRAM Magic ID= %c %c %c&bslash;n&bslash;r&quot;
comma
(paren
r_char
op_star
)paren
id|nv-&gt;id
(braket
l_int|0
)braket
comma
id|nv-&gt;id
(braket
l_int|1
)braket
comma
id|nv-&gt;id
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Bad NVRAM data, load RISC code. */
r_if
c_cond
(paren
id|chksum
op_logical_or
id|nv-&gt;id
(braket
l_int|0
)braket
op_ne
l_char|&squot;I&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|1
)braket
op_ne
l_char|&squot;S&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|3
)braket
op_ne
l_char|&squot; &squot;
op_logical_or
id|nv-&gt;version
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280_isp_firmware: Bad checksum or magic number or version in NVRAM.&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.disable_risc_code_load
)paren
(brace
macro_line|#if defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isp_firmware: Telling RISC to verify checksum of loaded BIOS code.&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Verify checksum of loaded RISC code. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Start firmware execution. */
macro_line|#if defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isp_firmware: Startng F/W execution.&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: RISC checksum failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280: NVRAM configured to load RISC load.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isp_firmware: **** Load RISC code ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isp_firmware&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * PCI configuration&n; *      Setup device PCI configuration registers.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_pci_config
id|qla1280_pci_config
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint8
id|status
op_assign
l_int|1
suffix:semicolon
r_uint32
id|command
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
r_uint32
id|page_offset
comma
id|base
suffix:semicolon
r_uint32
id|mmapbase
suffix:semicolon
macro_line|#endif
id|config_reg_t
op_star
id|creg
op_assign
l_int|0
suffix:semicolon
r_uint16
id|buf_wd
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_pci_config&quot;
)paren
suffix:semicolon
multiline_comment|/* Get command register. */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|OFFSET
c_func
(paren
id|creg-&gt;command
)paren
comma
op_amp
id|buf_wd
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|command
op_assign
id|buf_wd
suffix:semicolon
multiline_comment|/*&n;        * Set Bus Master Enable, Memory Address Space Enable and&n;        * reset any error bits.&n;        */
id|buf_wd
op_and_assign
op_complement
l_int|0x7
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280: MEMORY MAPPED IO is enabled.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|buf_wd
op_or_assign
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
suffix:semicolon
macro_line|#else
id|buf_wd
op_or_assign
id|BIT_2
op_plus
id|BIT_0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|OFFSET
c_func
(paren
id|creg-&gt;command
)paren
comma
id|buf_wd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Could not write config word.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get expansion ROM address. */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|OFFSET
c_func
(paren
id|creg-&gt;expansion_rom
)paren
comma
op_amp
id|buf_wd
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
multiline_comment|/* Reset expansion ROM address decode enable. */
id|buf_wd
op_and_assign
op_complement
id|BIT_0
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|OFFSET
c_func
(paren
id|creg-&gt;expansion_rom
)paren
comma
id|buf_wd
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
multiline_comment|/* Get memory mapped I/O address. */
id|pci_read_config_dword
c_func
(paren
id|ha-&gt;pdev
comma
id|OFFSET
c_func
(paren
id|cfgp-&gt;mem_base_addr
)paren
comma
op_amp
id|mmapbase
)paren
suffix:semicolon
id|mmapbase
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
multiline_comment|/* Find proper memory chunk for memory map I/O reg. */
id|base
op_assign
id|mmapbase
op_amp
id|PAGE_MASK
suffix:semicolon
id|page_offset
op_assign
id|mmapbase
op_minus
id|base
suffix:semicolon
multiline_comment|/* Get virtual address for I/O registers. */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
id|ha-&gt;mmpbase
op_assign
id|ioremap_nocache
c_func
(paren
id|base
comma
id|page_offset
op_plus
l_int|256
)paren
suffix:semicolon
macro_line|#else
id|ha-&gt;mmpbase
op_assign
id|vremap
c_func
(paren
id|base
comma
id|page_offset
op_plus
l_int|256
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;mmpbase
)paren
(brace
id|ha-&gt;mmpbase
op_add_assign
id|page_offset
suffix:semicolon
multiline_comment|/* ha-&gt;iobase = ha-&gt;mmpbase; */
id|status
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else /* MEMORY_MAPPED_IO */
id|status
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* MEMORY_MAPPED_IO */
)brace
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_pci_config&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Chip diagnostics&n; *      Test chip for proper operation.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_chip_diag
id|qla1280_chip_diag
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_uint16
id|data
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280_chip_diag: testing device at 0x%p &bslash;n&bslash;r&quot;
comma
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Soft reset chip and wait for it to finish. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_RESET
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
op_logical_and
id|data
op_amp
id|ISP_RESET
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|SYS_DELAY
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
)paren
(brace
multiline_comment|/* Reset register not cleared by chip reset. */
macro_line|#if defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_chip_diag: reset register cleared by chip reset&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset RISC and disable BIOS which&n;        allows RISC to execute out of RAM. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_DISABLE_BIOS
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
op_logical_and
id|data
op_eq
id|MBS_BUSY
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|SYS_DELAY
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
)paren
(brace
multiline_comment|/* Check product ID of chip */
macro_line|#if defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_chip_diag: Checking product ID of chip&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
op_ne
id|PROD_ID_1
op_logical_or
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
op_ne
id|PROD_ID_2
op_logical_and
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
op_ne
id|PROD_ID_2a
)paren
op_logical_or
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
op_ne
id|PROD_ID_3
op_logical_or
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
op_ne
id|PROD_ID_4
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Wrong product ID = 0x%x,0x%x,0x%x,0x%x&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280_chip_diag: Checking mailboxes of chip&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Wrap Incoming Mailboxes Test. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_MAILBOX_REGISTER_TEST
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|0xAAAA
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0x5555
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
l_int|0xAA55
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
l_int|0x55AA
suffix:semicolon
id|mb
(braket
l_int|5
)braket
op_assign
l_int|0xA5A5
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
l_int|0x5A5A
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
l_int|0x2525
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
(paren
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_5
op_or
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
)paren
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
op_ne
l_int|0xAAAA
op_logical_or
id|mb
(braket
l_int|2
)braket
op_ne
l_int|0x5555
op_logical_or
id|mb
(braket
l_int|3
)braket
op_ne
l_int|0xAA55
op_logical_or
id|mb
(braket
l_int|4
)braket
op_ne
l_int|0x55AA
)paren
id|status
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|5
)braket
op_ne
l_int|0xA5A5
op_logical_or
id|mb
(braket
l_int|6
)braket
op_ne
l_int|0x5A5A
op_logical_or
id|mb
(braket
l_int|7
)braket
op_ne
l_int|0x2525
)paren
id|status
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed mailbox check&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_chip_diag: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_chip_diag: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup chip&n; *      Load and start RISC firmware.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_setup_chip
id|qla1280_setup_chip
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_uint16
id|risc_address
suffix:semicolon
r_uint16
op_star
id|risc_code_address
suffix:semicolon
r_int
id|risc_code_size
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
macro_line|#ifdef QLA1280_UNUSED
r_uint8
op_star
id|sp
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#endif
r_uint16
id|cnt
suffix:semicolon
r_int
id|num
suffix:semicolon
r_uint8
op_star
id|tbuf
suffix:semicolon
id|u_long
id|p_tbuf
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_setup_chip&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tbuf
op_assign
(paren
r_uint8
op_star
)paren
id|KMALLOC
c_func
(paren
l_int|8000
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;setup_chip: couldn&squot;t alloacte memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|p_tbuf
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|tbuf
)paren
suffix:semicolon
multiline_comment|/* Load RISC code. */
multiline_comment|/* &n;    risc_address      = ql12_risc_code_addr01;&n;    risc_code_address = &amp;ql12_risc_code01[0];&n;    risc_code_size    = ql12_risc_code_length01;&n;    */
id|risc_address
op_assign
op_star
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|risc_code_address
op_assign
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwcode
suffix:semicolon
id|risc_code_size
op_assign
(paren
r_int
)paren
(paren
op_star
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwlen
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280: DMAing RISC code (%d) words.&bslash;n&quot;
comma
(paren
r_int
)paren
id|risc_code_size
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280_setup_chip:  Loading RISC code size =(%ld).&bslash;n&bslash;r&quot;
comma
id|risc_code_size
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|risc_code_size
OG
l_int|0
op_logical_and
op_logical_neg
id|status
)paren
(brace
id|cnt
op_assign
l_int|2000
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|risc_code_size
)paren
id|cnt
op_assign
id|risc_code_size
suffix:semicolon
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280_setup_chip:  loading risc @ =(0x%p),%d,%d(0x%x).&bslash;n&bslash;r&quot;
comma
id|risc_code_address
comma
id|cnt
comma
id|num
comma
id|risc_address
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280_setup_chip:  loading risc @ =code=(0x%p),cnt=%d,seg=%d,addr=0x%x&bslash;n&bslash;r&quot;
comma
id|risc_code_address
comma
id|cnt
comma
id|num
comma
id|risc_address
)paren
)paren
suffix:semicolon
id|BCOPY
c_func
(paren
(paren
id|caddr_t
)paren
id|risc_code_address
comma
(paren
id|caddr_t
)paren
id|ha-&gt;request_ring
comma
(paren
id|cnt
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RAM
suffix:semicolon
multiline_comment|/* mb[0] = MBC_LOAD_RAM_A64; */
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|cnt
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
(paren
r_uint16
)paren
id|ha-&gt;request_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|ha-&gt;request_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|MS_64BITS
c_func
(paren
id|ha-&gt;request_dma
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|MS_64BITS
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280_setup_chip: op=%d  0x%lx = 0x%4x,0x%4x,0x%4x,0x%4x&bslash;n&quot;
comma
id|mb
(braket
l_int|0
)braket
comma
id|ha-&gt;request_dma
comma
id|mb
(braket
l_int|6
)braket
comma
id|mb
(braket
l_int|7
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to load partial segment of f/w&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* dump it back */
macro_line|#if 0
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_DUMP_RAM_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|cnt
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
(paren
r_uint16
)paren
id|p_tbuf
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|p_tbuf
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|p_tbuf
op_rshift
l_int|32
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|p_tbuf
op_rshift
l_int|48
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to dump partial segment of f/w&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sp
op_assign
(paren
r_uint8
op_star
)paren
id|ha-&gt;request_ring
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|cnt
op_lshift
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tbuf
(braket
id|i
)braket
op_ne
id|sp
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : firmware compare error @ byte (0x%x)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
id|risc_address
op_add_assign
id|cnt
suffix:semicolon
id|risc_code_size
op_assign
id|risc_code_size
op_minus
id|cnt
suffix:semicolon
id|risc_code_address
op_assign
id|risc_code_address
op_plus
id|cnt
suffix:semicolon
id|num
op_increment
suffix:semicolon
)brace
macro_line|#ifdef QLA1280_UNUSED
id|DEBUG
c_func
(paren
id|ql_debug_print
op_assign
l_int|0
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ql12_risc_code_length01
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mb
(braket
l_int|0
)braket
op_assign
l_int|0x4
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|ql12_risc_code_addr01
op_plus
id|i
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|ql12_risc_code01
(braket
id|i
)braket
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : firmware load failure&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mb
(braket
l_int|0
)braket
op_assign
l_int|0x5
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|ql12_risc_code_addr01
op_plus
id|i
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : firmware dump failure&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mb
(braket
l_int|2
)braket
op_ne
id|ql12_risc_code01
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : firmware compare error @ (0x%x)&bslash;n&quot;
comma
id|ql12_risc_code_addr01
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
id|DEBUG
c_func
(paren
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
)paren
macro_line|#endif
multiline_comment|/* Verify checksum of loaded RISC code. */
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla1280_setup_chip: Verifying checksum of loaded RISC code.&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Start firmware execution. */
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_setup_chip: start firmware running.&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)paren
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|QLBoardTbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;qla1280_setup_chip: Failed checksum.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|KMFREE
c_func
(paren
id|tbuf
comma
l_int|8000
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_setup_chip: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_setup_chip&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize rings&n; *&n; * Input:&n; *      ha                = adapter block pointer.&n; *      ha-&gt;request_ring  = request ring virtual address&n; *      ha-&gt;response_ring = response ring virtual address&n; *      ha-&gt;request_dma   = request ring physical address&n; *      ha-&gt;response_dma  = response ring physical address&n; *&n; * Returns:&n; *      0 = success.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_init_rings
id|qla1280_init_rings
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_init_rings&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Clear outstanding commands array. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize request queue. */
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
suffix:semicolon
multiline_comment|/* mb[0] = MBC_INIT_REQUEST_QUEUE; */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_INIT_REQUEST_QUEUE_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|REQUEST_ENTRY_CNT
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
(paren
r_uint16
)paren
id|LS_64BITS
c_func
(paren
id|ha-&gt;request_dma
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|LS_64BITS
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
(paren
r_uint16
)paren
id|MS_64BITS
c_func
(paren
id|ha-&gt;request_dma
)paren
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|MS_64BITS
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Initialize response queue. */
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mb[0] = MBC_INIT_RESPONSE_QUEUE; */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_INIT_RESPONSE_QUEUE_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|RESPONSE_ENTRY_CNT
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
(paren
r_uint16
)paren
id|LS_64BITS
c_func
(paren
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|LS_64BITS
c_func
(paren
id|ha-&gt;response_dma
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|mb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
(paren
r_uint16
)paren
id|MS_64BITS
c_func
(paren
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|MS_64BITS
c_func
(paren
id|ha-&gt;response_dma
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_5
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_init_rings: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_init_rings&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * NVRAM configuration.&n; *&n; * Input:&n; *      ha                = adapter block pointer.&n; *      ha-&gt;request_ring  = request ring virtual address&n; *&n; * Output:&n; *      host adapters parameters in host adapter block&n; *&n; * Returns:&n; *      0 = success.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_nvram_config
id|qla1280_nvram_config
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|nvram_t
op_star
id|nv
op_assign
(paren
id|nvram_t
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint8
id|cnt
suffix:semicolon
r_uint8
id|chksum
suffix:semicolon
r_uint32
id|nvsize
suffix:semicolon
macro_line|#if defined(QL_DEBUG_ROUTINES) &amp;&amp; !defined(QL_DEBUG_LEVEL_4)
r_uint8
id|saved_print_status
op_assign
id|ql_debug_print
suffix:semicolon
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_nvram_config&quot;
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_ROUTINES) &amp;&amp; !defined(QL_DEBUG_LEVEL_4)
id|ql_debug_print
op_assign
id|FALSE
suffix:semicolon
macro_line|#endif
multiline_comment|/* Verify valid NVRAM checksum. */
macro_line|#if  USE_NVRAM_DEFAULTS
id|chksum
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
id|chksum
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;device_id
op_eq
id|QLA12160_DEVICE_ID
op_logical_or
id|ha-&gt;device_id
op_eq
id|QLA10160_DEVICE_ID
)paren
(brace
id|nvsize
op_assign
r_sizeof
(paren
id|nvram160_t
)paren
op_div
l_int|2
suffix:semicolon
)brace
r_else
id|nvsize
op_assign
r_sizeof
(paren
id|nvram_t
)paren
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|nvsize
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|qla1280_get_nvram_word
c_func
(paren
id|ha
comma
id|cnt
)paren
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
op_star
id|wptr
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Bad NVRAM data, set defaults parameters. */
r_if
c_cond
(paren
id|chksum
op_logical_or
id|nv-&gt;id
(braket
l_int|0
)braket
op_ne
l_char|&squot;I&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|1
)braket
op_ne
l_char|&squot;S&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|3
)braket
op_ne
l_char|&squot; &squot;
op_logical_or
id|nv-&gt;version
OL
l_int|1
)paren
(brace
macro_line|#if  USE_NVRAM_DEFAULTS
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Using defaults for NVRAM&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#else
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Using defaults for NVRAM: &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;checksum=0x%x, Id=%c, version=0x%x&bslash;n&quot;
comma
id|chksum
comma
id|nv-&gt;id
(braket
l_int|0
)braket
comma
id|nv-&gt;version
)paren
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_3)
multiline_comment|/* ql_debug_print = 1;&n;        qla1280_dump_buffer((caddr_t)ha-&gt;response_ring, REQUEST_ENTRY_SIZE);&n;        ql_debug_print = 0; */
macro_line|#endif
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
r_sizeof
(paren
id|nvram_t
)paren
op_div
l_int|2
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|wptr
op_increment
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* nv-&gt;cntr_flags_1.disable_loading_risc_code = 1; */
id|nv-&gt;firmware_feature.w
op_assign
id|BIT_0
suffix:semicolon
id|nv-&gt;termination.f.scsi_bus_0_control
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;termination.f.scsi_bus_1_control
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;termination.f.auto_term_support
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|MAX_BUSES
suffix:semicolon
id|b
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|config_1.initiator_id
op_assign
l_int|7
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|bus_reset_delay
op_assign
l_int|5
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|config_2.async_data_setup_time
op_assign
l_int|9
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|config_2.req_ack_active_negation
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|config_2.data_line_active_negation
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|selection_timeout
op_assign
l_int|250
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|max_queue_depth
op_assign
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.f.auto_request_sense
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.f.disconnect_allowed
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.f.tag_queuing
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.device_enable
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if  USE_NVRAM_DEFAULTS
id|status
op_assign
l_int|0
suffix:semicolon
macro_line|#else
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Always force AUTO sense for LINUX SCSI */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|MAX_BUSES
suffix:semicolon
id|b
op_increment
)paren
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.f.auto_request_sense
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if  DEBUG_PRINT_NVRAM
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : initiator scsi id bus[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_1.initiator_id
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : initiator scsi id bus[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_1.initiator_id
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : bus reset delay[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|bus_reset_delay
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : bus reset delay[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|bus_reset_delay
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : retry count[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_count
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : retry delay[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_delay
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : retry count[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_count
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : retry delay[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_delay
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : async data setup time[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.async_data_setup_time
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : async data setup time[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.async_data_setup_time
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : req/ack active negation[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.req_ack_active_negation
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : req/ack active negation[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.req_ack_active_negation
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : data line active negation[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.data_line_active_negation
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : data line active negation[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.data_line_active_negation
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : disable loading risc code=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : enable 64bit addressing=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;cntr_flags_1.enable_64bit_addressing
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : selection timeout limit[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : selection timeout limit[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : max queue depth[0]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;qla1280 : max queue depth[1]=%d&bslash;n&bslash;r&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
macro_line|#endif
id|DEBUG
c_func
(paren
id|ql_debug_print
op_assign
l_int|0
suffix:semicolon
)paren
multiline_comment|/* Disable RISC load of firmware. */
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
suffix:semicolon
multiline_comment|/* Enable 64bit addressing. */
id|ha-&gt;flags.enable_64bit_addressing
op_assign
id|nv-&gt;cntr_flags_1.enable_64bit_addressing
suffix:semicolon
multiline_comment|/* Set ISP hardware DMA burst */
id|mb
(braket
l_int|0
)braket
op_assign
id|nv-&gt;isp_config.c
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Set SCSI termination. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;gpio_enable
comma
(paren
id|BIT_3
op_plus
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
)paren
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|nv-&gt;termination.c
op_amp
(paren
id|BIT_3
op_plus
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;gpio_data
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* ISP parameter word. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_SYSTEM_PARAMETER
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;isp_parameter
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Firmware feature word. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_FIRMWARE_FEATURES
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;firmware_feature.w
op_amp
(paren
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Retry count and delay. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_RETRY_COUNT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_count
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_delay
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_count
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_delay
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* ASYNC data setup time. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_ASYNC_DATA_SETUP
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.async_data_setup_time
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.async_data_setup_time
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Active negation states. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_ACTIVE_NEGATION
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.req_ack_active_negation
)paren
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_5
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.data_line_active_negation
)paren
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_4
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.req_ack_active_negation
)paren
id|mb
(braket
l_int|2
)braket
op_or_assign
id|BIT_5
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.data_line_active_negation
)paren
id|mb
(braket
l_int|2
)braket
op_or_assign
id|BIT_4
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Selection timeout. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_SELECTION_TIMEOUT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|selection_timeout
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|selection_timeout
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
(brace
multiline_comment|/* SCSI Reset Disable. */
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|disable_scsi_reset
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|config_1.scsi_reset_disable
suffix:semicolon
multiline_comment|/* Initiator ID. */
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|id
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|config_1.initiator_id
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_INITIATOR_ID
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|b
ques
c_cond
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|id
op_or
id|BIT_7
suffix:colon
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|id
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset Delay. */
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|bus_reset_delay
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|bus_reset_delay
suffix:semicolon
multiline_comment|/* Command queue depth per device. */
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|hiwat
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|max_queue_depth
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set target parameters. */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;device_id
op_eq
id|QLA12160_DEVICE_ID
op_logical_or
id|ha-&gt;device_id
op_eq
id|QLA10160_DEVICE_ID
)paren
(brace
id|status
op_assign
id|qla12160_set_target_parameters
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
l_int|0
comma
(paren
id|nvram160_t
op_star
)paren
id|nv
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set Target Parameters. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|b
ques
c_cond
id|t
op_or
id|BIT_7
suffix:colon
id|t
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.c
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_or_assign
id|TP_AUTO_REQUEST_SENSE
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_and_assign
op_complement
id|TP_STOP_QUEUE
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.sync_offset
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_or_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|sync_period
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Save Tag queuing enable flag. */
id|mb
(braket
l_int|0
)braket
op_assign
id|BIT_0
op_lshift
id|t
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.f.tag_queuing
)paren
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|qtag_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Save Device enable flag. */
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.device_enable
)paren
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|device_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Save LUN disable flag. */
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.lun_disable
)paren
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|lun_disables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Set Device Queue Parameters. */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
(brace
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_DEVICE_QUEUE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|b
ques
c_cond
id|t
op_or
id|BIT_7
suffix:colon
id|t
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|mb
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|l
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|max_queue_depth
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|execution_throttle
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
id|DEBUG
c_func
(paren
id|ql_debug_print
op_assign
l_int|0
suffix:semicolon
)paren
macro_line|#if defined(QL_DEBUG_ROUTINES) &amp;&amp; !defined(QL_DEBUG_LEVEL_4)
id|ql_debug_print
op_assign
id|saved_print_status
suffix:semicolon
macro_line|#endif
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|DEBUG
c_func
(paren
r_if
(paren
id|status
)paren
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_nvram_config: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)paren
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_nvram_config&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Get NVRAM data word&n; *      Calculates word position in NVRAM and calls request routine to&n; *      get the word from NVRAM.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      address = NVRAM word address.&n; *&n; * Returns:&n; *      data word.&n; */
id|STATIC
r_uint16
DECL|function|qla1280_get_nvram_word
id|qla1280_get_nvram_word
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|address
)paren
(brace
r_uint32
id|nv_cmd
suffix:semicolon
r_uint16
id|data
suffix:semicolon
macro_line|#ifdef QL_DEBUG_ROUTINES
r_uint8
id|saved_print_status
op_assign
id|ql_debug_print
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_4
id|ENTER
c_func
(paren
l_string|&quot;qla1280_get_nvram_word&quot;
)paren
suffix:semicolon
macro_line|#endif
id|nv_cmd
op_assign
id|address
op_lshift
l_int|16
suffix:semicolon
id|nv_cmd
op_or_assign
id|NV_READ_OP
suffix:semicolon
macro_line|#ifdef QL_DEBUG_ROUTINES
id|ql_debug_print
op_assign
id|FALSE
suffix:semicolon
macro_line|#endif
id|data
op_assign
id|qla1280_nvram_request
c_func
(paren
id|ha
comma
id|nv_cmd
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_ROUTINES
id|ql_debug_print
op_assign
id|saved_print_status
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_4
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_get_nvram_word: exiting normally NVRAM data = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|data
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|data
suffix:semicolon
)brace
multiline_comment|/*&n; * NVRAM request&n; *      Sends read command to NVRAM and gets data from NVRAM.&n; *&n; * Input:&n; *      ha     = adapter block pointer.&n; *      nv_cmd = Bit 26     = start bit&n; *               Bit 25, 24 = opcode&n; *               Bit 23-16  = address&n; *               Bit 15-0   = write data&n; *&n; * Returns:&n; *      data word.&n; */
id|STATIC
r_uint16
DECL|function|qla1280_nvram_request
id|qla1280_nvram_request
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|nv_cmd
)paren
(brace
r_uint8
id|cnt
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint16
id|data
op_assign
l_int|0
suffix:semicolon
r_uint16
id|reg_data
suffix:semicolon
multiline_comment|/* Send command to NVRAM. */
id|nv_cmd
op_lshift_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|11
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|nv_cmd
op_amp
id|BIT_31
)paren
id|qla1280_nv_write
c_func
(paren
id|ha
comma
id|NV_DATA_OUT
)paren
suffix:semicolon
r_else
id|qla1280_nv_write
c_func
(paren
id|ha
comma
l_int|0
)paren
suffix:semicolon
id|nv_cmd
op_lshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Read data from NVRAM. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|16
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_SELECT
op_plus
id|NV_CLOCK
)paren
suffix:semicolon
multiline_comment|/* qla1280_nv_delay(ha); */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|data
op_lshift_assign
l_int|1
suffix:semicolon
id|reg_data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_data
op_amp
id|NV_DATA_IN
)paren
id|data
op_or_assign
id|BIT_0
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_SELECT
)paren
suffix:semicolon
multiline_comment|/* qla1280_nv_delay(ha); */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Deselect chip. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_DESELECT
)paren
suffix:semicolon
multiline_comment|/* qla1280_nv_delay(ha); */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
id|STATIC
r_void
DECL|function|qla1280_nv_write
id|qla1280_nv_write
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|data
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* qla1280_nv_delay(ha); */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
op_or
id|NV_CLOCK
)paren
suffix:semicolon
multiline_comment|/* qla1280_nv_delay(ha); */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
)paren
suffix:semicolon
multiline_comment|/* qla1280_nv_delay(ha); */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
id|STATIC
r_void
DECL|function|qla1280_nv_delay
id|qla1280_nv_delay
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_int
id|cnt
op_assign
id|NV_DELAY_COUNT
suffix:semicolon
r_uint16
id|data
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
id|data
op_or_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Mailbox Command&n; *      Issue mailbox command and waits for completion.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      mr = mailbox registers to load.&n; *      mb = data pointer for mailbox registers.&n; *&n; * Output:&n; *      mb[MAILBOX_REGISTER_COUNT] = returned mailbox data.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_mailbox_command
id|qla1280_mailbox_command
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|mr
comma
r_uint16
op_star
id|mb
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
r_uint16
op_star
id|optr
comma
op_star
id|iptr
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|srb_t
op_star
id|done_q_first
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|done_q_last
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_mailbox_command&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Acquire interrupt specific lock */
id|QLA1280_INTR_LOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DRIVER_LOCK
id|ha-&gt;flags.mbox_busy
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Load mailbox registers. */
id|optr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|reg-&gt;mailbox0
suffix:semicolon
id|iptr
op_assign
id|mb
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mr
op_amp
id|BIT_0
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
id|optr
comma
(paren
op_star
id|iptr
)paren
)paren
suffix:semicolon
)brace
id|mr
op_rshift_assign
l_int|1
suffix:semicolon
id|optr
op_increment
suffix:semicolon
id|iptr
op_increment
suffix:semicolon
)brace
multiline_comment|/* Issue set host interrupt command. */
id|ha-&gt;flags.mbox_int
op_assign
id|FALSE
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_SET_HOST_INT
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/* Wait for 30 seconds for command to finish. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|30000000
suffix:semicolon
id|cnt
OG
l_int|0
op_logical_and
op_logical_neg
id|ha-&gt;flags.mbox_int
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
(brace
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_last
)paren
suffix:semicolon
)brace
id|SYS_DELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for mailbox command timeout. */
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_mailbox_command: **** Command Timeout, mailbox0 = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mb
(braket
l_int|0
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_ne
id|MBS_CMD_CMP
)paren
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Load return mailbox registers. */
id|optr
op_assign
id|mb
suffix:semicolon
id|iptr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
suffix:semicolon
id|mr
op_assign
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
r_while
c_loop
(paren
id|mr
op_decrement
)paren
op_star
id|optr
op_increment
op_assign
op_star
id|iptr
op_increment
suffix:semicolon
multiline_comment|/* Go check for any response interrupts pending. */
id|ha-&gt;flags.mbox_busy
op_assign
id|FALSE
suffix:semicolon
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_last
)paren
suffix:semicolon
multiline_comment|/* Release interrupt specific lock */
id|QLA1280_INTR_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DRIVER_UNLOCK
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
)paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_last
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_mailbox_command: **** FAILED, mailbox0 = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mb
(braket
l_int|0
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_mailbox_command&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_poll&n; *      Polls ISP for interrupts.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_poll
id|qla1280_poll
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|srb_t
op_star
id|done_q_first
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|done_q_last
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
multiline_comment|/* ENTER(&quot;qla1280_poll&quot;); */
macro_line|#endif
multiline_comment|/* Acquire interrupt specific lock */
id|QLA1280_INTR_LOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
id|qla1280_isr
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_last
)paren
suffix:semicolon
multiline_comment|/* Release interrupt specific lock */
id|QLA1280_INTR_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.mbox_busy
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
)paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|done_q_last
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
multiline_comment|/* LEAVE(&quot;qla1280_poll&quot;); */
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_bus_reset&n; *      Issue SCSI bus reset.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      b  = SCSI bus number.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_bus_reset
id|qla1280_bus_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|b
)paren
(brace
r_uint8
id|status
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_bus_reset: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|qla1280_verbose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi(%d): Resetting SCSI BUS (%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
id|b
)paren
suffix:semicolon
)brace
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_BUS_RESET
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|bus_reset_delay
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
id|b
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|failed_reset_count
OG
l_int|2
)paren
multiline_comment|/* dg - 03/13/99 */
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|scsi_bus_dead
op_assign
id|TRUE
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|failed_reset_count
op_increment
suffix:semicolon
)brace
r_else
(brace
id|QLA1280_DELAY
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|scsi_bus_dead
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* dg - 03/13/99 */
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|failed_reset_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_bus_reset: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_bus_reset: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_device_reset&n; *      Issue bus device reset message to the target.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      b  = SCSI BUS number.&n; *      t  = SCSI ID.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_device_reset
id|qla1280_device_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|b
comma
r_uint32
id|t
)paren
(brace
r_uint8
id|status
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_device_reset&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_TARGET
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|b
ques
c_cond
(paren
id|t
op_or
id|BIT_7
)paren
suffix:colon
id|t
)paren
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
l_int|0
comma
id|MK_SYNC_ID
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_device_reset: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_device_reset&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_abort_device&n; *      Issue an abort message to the device&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      b  = SCSI BUS.&n; *      t  = SCSI ID.&n; *      l  = SCSI LUN.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_abort_device
id|qla1280_abort_device
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|b
comma
r_uint32
id|t
comma
r_uint32
id|l
)paren
(brace
r_uint8
id|status
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_device&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_DEVICE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|b
ques
c_cond
id|t
op_or
id|BIT_7
suffix:colon
id|t
)paren
op_lshift
l_int|8
op_or
id|l
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
comma
id|MK_SYNC_ID_LUN
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_abort_device: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_device&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_abort_command&n; *      Abort command aborts a specified IOCB.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SB structure pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_abort_command
id|qla1280_abort_command
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_uint8
id|status
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
r_uint32
id|handle
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_command&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Locate handle number. */
r_for
c_loop
(paren
id|handle
op_assign
l_int|0
suffix:semicolon
id|handle
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|handle
op_increment
)paren
r_if
c_cond
(paren
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
op_eq
id|sp
)paren
r_break
suffix:semicolon
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_COMMAND
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|b
ques
c_cond
id|t
op_or
id|BIT_7
suffix:colon
id|t
)paren
op_lshift
l_int|8
op_or
id|l
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|handle
op_rshift
l_int|16
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
(paren
r_uint16
)paren
id|handle
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_abort_command: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|sp-&gt;flags
op_or_assign
id|SRB_ABORT_PENDING
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_command&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_reset_adapter&n; *      Reset adapter.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_reset_adapter
id|qla1280_reset_adapter
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_reset_adapter&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Disable ISP chip */
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_RESET
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_DISABLE_BIOS
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_reset_adapter&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *  Issue marker command.&n; *      Function issues marker IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      b    = SCSI BUS number&n; *      t    = SCSI ID&n; *      l    = SCSI LUN&n; *      type = marker modifier&n; */
id|STATIC
r_void
DECL|function|qla1280_marker
id|qla1280_marker
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|b
comma
r_uint32
id|t
comma
r_uint32
id|l
comma
r_uint8
id|type
)paren
(brace
id|mrk_entry_t
op_star
id|pkt
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_marker&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
(paren
id|pkt
op_assign
(paren
id|mrk_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|MARKER_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
(paren
r_uint8
)paren
id|l
suffix:semicolon
id|pkt-&gt;target
op_assign
(paren
r_uint8
)paren
(paren
id|b
ques
c_cond
(paren
id|t
op_or
id|BIT_7
)paren
suffix:colon
id|t
)paren
suffix:semicolon
id|pkt-&gt;modifier
op_assign
id|type
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_marker&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if  QLA1280_64BIT_SUPPORT
multiline_comment|/*&n; * qla1280_64bit_start_scsi&n; *      The start SCSI is responsible for building request packets on&n; *      request ring and modifying ISP input pointer.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SB structure pointer.&n; *&n; * Returns:&n; *      0 = success, was able to issue command.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_64bit_start_scsi
id|qla1280_64bit_start_scsi
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
id|cmd_a64_entry_t
op_star
id|pkt
suffix:semicolon
r_uint16
id|req_cnt
suffix:semicolon
r_uint16
id|seg_cnt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
l_int|NULL
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi:&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|ha
comma
id|sp
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Calculate number of entries and segments required. */
id|seg_cnt
op_assign
l_int|0
suffix:semicolon
id|req_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|seg_cnt
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|seg_cnt
OG
l_int|2
)paren
(brace
id|req_cnt
op_add_assign
(paren
r_uint16
)paren
(paren
id|seg_cnt
op_minus
l_int|2
)paren
op_div
l_int|5
suffix:semicolon
r_if
c_cond
(paren
(paren
r_uint16
)paren
(paren
id|seg_cnt
op_minus
l_int|2
)paren
op_mod
l_int|5
)paren
id|req_cnt
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
multiline_comment|/* If data transfer. */
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Single data transfer (0x%x)&bslash;n&quot;
comma
id|cmd-&gt;request_bufflen
)paren
)paren
suffix:semicolon
id|seg_cnt
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Acquire ring specific lock */
id|QLA1280_RING_LOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_uint16
)paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* If room for request in request ring. */
r_if
c_cond
(paren
(paren
r_uint16
)paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
OL
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Check for room in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
op_logical_and
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_ne
l_int|0
suffix:semicolon
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
id|sp
suffix:semicolon
id|ha-&gt;req_q_cnt
op_sub_assign
id|req_cnt
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|u_long
)paren
id|cnt
suffix:semicolon
multiline_comment|/*&n;            * Build command packet.&n;            */
id|pkt
op_assign
(paren
id|cmd_a64_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|pkt-&gt;entry_type
op_assign
id|COMMAND_A64_TYPE
suffix:semicolon
id|pkt-&gt;entry_count
op_assign
(paren
r_uint8
)paren
id|req_cnt
suffix:semicolon
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
id|pkt-&gt;handle
op_assign
(paren
r_uint32
)paren
id|cnt
suffix:semicolon
multiline_comment|/* Zero out remaining portion of packet. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
op_plus
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|2
suffix:semicolon
id|cnt
OL
id|REQUEST_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set ISP command timeout. */
id|pkt-&gt;timeout
op_assign
(paren
r_uint16
)paren
l_int|30
suffix:semicolon
multiline_comment|/* Set device target ID and LUN */
id|pkt-&gt;lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;target
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
ques
c_cond
(paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
op_or
id|BIT_7
)paren
suffix:colon
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Enable simple tag queuing if device supports it. */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;tagged_queue
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_3
suffix:semicolon
multiline_comment|/* Load SCSI command packet. */
id|pkt-&gt;cdb_len
op_assign
(paren
r_uint16
)paren
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|BCOPY
c_func
(paren
op_amp
(paren
id|CMD_CDBP
c_func
(paren
id|cmd
)paren
)paren
comma
id|pkt-&gt;scsi_cdb
comma
id|pkt-&gt;cdb_len
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Build packet for command[0]=0x%x&bslash;n&quot;
comma
id|pkt-&gt;scsi_cdb
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;            * Load data segments.&n;            */
r_if
c_cond
(paren
id|seg_cnt
)paren
multiline_comment|/* If data transfer. */
(brace
multiline_comment|/* Set transfer direction. */
r_if
c_cond
(paren
(paren
id|cmd-&gt;data_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_6
suffix:semicolon
r_else
id|pkt-&gt;control_flags
op_or_assign
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
id|sp-&gt;dir
op_assign
id|pkt-&gt;control_flags
op_amp
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
multiline_comment|/* Set total data segment count. */
id|pkt-&gt;dseg_count
op_assign
id|seg_cnt
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
op_amp
id|pkt-&gt;dseg_0_address
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
multiline_comment|/* If scatter gather */
(brace
multiline_comment|/* Load command entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|2
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;SG Segment ap=0x%p, len=0x%x&bslash;n&bslash;r&quot;
comma
id|sg-&gt;address
comma
id|sg-&gt;length
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS_LOW
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS_HIGH
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|sg-&gt;length
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: Scatter/gather command packet data - &quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;b &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; t &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; d &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;                    * Build continuation packets.&n;                    */
r_while
c_loop
(paren
id|seg_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
id|pkt
op_assign
(paren
id|cmd_a64_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|REQUEST_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Load packet defaults. */
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_type
op_assign
id|CONTINUE_A64_TYPE
suffix:semicolon
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_count
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
op_amp
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|dseg_0_address
suffix:semicolon
multiline_comment|/* Load continuation entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|5
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS_LOW
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS_HIGH
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|sg-&gt;length
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: continuation packet data - c&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; b &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; t &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; d &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
multiline_comment|/* No scatter gather data transfer */
(brace
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS_LOW
c_func
(paren
id|cmd-&gt;request_buffer
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS_HIGH
c_func
(paren
id|cmd-&gt;request_buffer
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_assign
(paren
r_uint32
)paren
id|cmd-&gt;request_bufflen
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: No scatter/gather command packet data - c&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; b &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; t &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; d &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_5
r_else
multiline_comment|/* No data transfer */
(brace
op_star
id|dword_ptr
op_increment
op_assign
(paren
r_uint32
)paren
l_int|0
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
(paren
r_uint32
)paren
l_int|0
suffix:semicolon
op_star
id|dword_ptr
op_assign
(paren
r_uint32
)paren
l_int|0
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: No data, command packet data - c&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; b &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; t &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; d &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: NO ROOM IN OUTSTANDING ARRAY&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; req_q_cnt=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;req_q_cnt
comma
l_int|16
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: in-ptr=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;req_ring_index
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; req_q_cnt=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;req_q_cnt
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; req_cnt=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|req_cnt
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Release ring specific lock */
id|QLA1280_RING_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
id|status
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif  /* QLA1280_64BIT_SUPPORT */
multiline_comment|/*&n; * qla1280_32bit_start_scsi&n; *      The start SCSI is responsible for building request packets on&n; *      request ring and modifying ISP input pointer.&n; *&n; *      The Qlogic firmware interface allows every queue slot to have a SCSI&n; *      command and up to 4 scatter/gather (SG) entries.  If we need more&n; *      than 4 SG entries, then continuation entries are used that can &n; *      hold another 7 entries each.  The start routine determines if there&n; *      is eought empty slots then build the combination of requests to &n; *      fulfill the OS request.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SCSI Request Block structure pointer.&n; *&n; * Returns:&n; *      0 = success, was able to issue command.&n; */
id|STATIC
r_uint8
DECL|function|qla1280_32bit_start_scsi
id|qla1280_32bit_start_scsi
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
id|cmd_entry_t
op_star
id|pkt
suffix:semicolon
r_uint16
id|req_cnt
suffix:semicolon
r_uint16
id|seg_cnt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
l_int|NULL
suffix:semicolon
r_uint8
op_star
id|data_ptr
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|ha
comma
id|sp
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Calculate number of entries and segments required. */
id|req_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/*&n;        * We must build an SG list in adapter format, as the kernel&squot;s SG list&n;        * cannot be used directly because of data field size (__alpha__)&n;        * differences and the kernel SG list uses virtual addresses where&n;        * we need physical addresses.&n;        */
id|seg_cnt
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
multiline_comment|/* &n;        * if greater than four sg entries then we need to allocate&n;        * continuation entries&n;        */
r_if
c_cond
(paren
id|seg_cnt
OG
l_int|4
)paren
(brace
id|req_cnt
op_add_assign
(paren
r_uint16
)paren
(paren
id|seg_cnt
op_minus
l_int|4
)paren
op_div
l_int|7
suffix:semicolon
r_if
c_cond
(paren
(paren
r_uint16
)paren
(paren
id|seg_cnt
op_minus
l_int|4
)paren
op_mod
l_int|7
)paren
id|req_cnt
op_increment
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;S/G for data transfer -num segs(%d), req blk cnt(%d)&bslash;n&bslash;r&quot;
comma
id|seg_cnt
comma
id|req_cnt
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
multiline_comment|/* If data transfer. */
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Single data transfer (0x%x)&bslash;n&quot;
comma
id|cmd-&gt;request_bufflen
)paren
)paren
suffix:semicolon
id|seg_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;No data transfer &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|seg_cnt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Acquire ring specific lock */
id|QLA1280_RING_LOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_uint16
)paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;Number of free entries = (%d)&bslash;n&bslash;r&quot;
comma
id|ha-&gt;req_q_cnt
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
multiline_comment|/* If room for request in request ring. */
r_if
c_cond
(paren
(paren
r_uint16
)paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
OL
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Check for empty slot in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
op_logical_and
(paren
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_ne
l_int|0
)paren
suffix:semicolon
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|cnt
suffix:semicolon
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
id|sp
suffix:semicolon
id|ha-&gt;req_q_cnt
op_sub_assign
id|req_cnt
suffix:semicolon
multiline_comment|/*&n;            * Build command packet.&n;            */
id|pkt
op_assign
(paren
id|cmd_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|pkt-&gt;entry_type
op_assign
id|COMMAND_TYPE
suffix:semicolon
id|pkt-&gt;entry_count
op_assign
(paren
r_uint8
)paren
id|req_cnt
suffix:semicolon
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
id|pkt-&gt;handle
op_assign
(paren
r_uint32
)paren
id|cnt
suffix:semicolon
multiline_comment|/* Zero out remaining portion of packet. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
op_plus
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|2
suffix:semicolon
id|cnt
OL
id|REQUEST_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set ISP command timeout. */
id|pkt-&gt;timeout
op_assign
(paren
r_uint16
)paren
l_int|30
suffix:semicolon
multiline_comment|/* Set device target ID and LUN */
id|pkt-&gt;lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;target
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
ques
c_cond
(paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
op_or
id|BIT_7
)paren
suffix:colon
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Enable simple tag queuing if device supports it. */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;tagged_queue
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_3
suffix:semicolon
multiline_comment|/* Load SCSI command packet. */
id|pkt-&gt;cdb_len
op_assign
(paren
r_uint16
)paren
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|data_ptr
op_assign
(paren
r_uint8
op_star
)paren
op_amp
(paren
id|CMD_CDBP
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|pkt-&gt;cdb_len
suffix:semicolon
id|cnt
op_increment
)paren
id|pkt-&gt;scsi_cdb
(braket
id|cnt
)braket
op_assign
op_star
id|data_ptr
op_increment
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Build packet for command[0]=0x%x&bslash;n&quot;
comma
id|pkt-&gt;scsi_cdb
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;            * Load data segments.&n;            */
r_if
c_cond
(paren
id|seg_cnt
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;loading data segments..&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Set transfer direction (READ and WRITE) */
multiline_comment|/* Linux doesn&squot;t tell us                   */
multiline_comment|/*&n;                * 3/10 dg - Normally, we should need this check with our F/W&n;                * but because of a small issue with it we do.&n;                *&n;                * For block devices, cmd-&gt;request.cmd has the operation &n;                * For character devices, this isn&squot;t always set properly, so&n;                * we need to check data_cmnd[0].  This catches the conditions&n;                * for st.c, but not sg. Generic commands are pass down to us.&n;                */
r_if
c_cond
(paren
(paren
id|cmd-&gt;data_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_6
suffix:semicolon
r_else
id|pkt-&gt;control_flags
op_or_assign
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
id|sp-&gt;dir
op_assign
id|pkt-&gt;control_flags
op_amp
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
multiline_comment|/* Set total data segment count. */
id|pkt-&gt;dseg_count
op_assign
id|seg_cnt
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
op_amp
id|pkt-&gt;dseg_0_address
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
multiline_comment|/* If scatter gather */
(brace
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;Building S/G data segments..&bslash;n&bslash;r&quot;
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|sg
comma
l_int|4
op_star
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* Load command entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|4
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
op_star
id|dword_ptr
op_increment
op_assign
(paren
r_uint32
)paren
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|sg-&gt;length
suffix:semicolon
id|DEBUG
c_func
(paren
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;SG Segment ap=0x%p, len=0x%x&bslash;n&bslash;r&quot;
comma
id|sg-&gt;address
comma
id|sg-&gt;length
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;                    * Build continuation packets.&n;                    */
r_while
c_loop
(paren
id|seg_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
id|pkt
op_assign
(paren
id|cmd_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|REQUEST_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Load packet defaults. */
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_type
op_assign
id|CONTINUE_TYPE
suffix:semicolon
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_count
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
op_amp
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|dseg_0_address
suffix:semicolon
multiline_comment|/* Load continuation entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|7
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
op_star
id|dword_ptr
op_increment
op_assign
(paren
id|u_int
)paren
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|sg-&gt;length
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi: continuation packet data - scsi(&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
comma
l_int|10
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;)&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
multiline_comment|/* No scatter gather data transfer */
(brace
op_star
id|dword_ptr
op_increment
op_assign
(paren
r_uint32
)paren
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|cmd-&gt;request_buffer
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_assign
(paren
r_uint32
)paren
id|cmd-&gt;request_bufflen
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Single Segment ap=0x%p, len=0x%x&bslash;n&quot;
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* No data transfer */
(brace
op_star
id|dword_ptr
op_increment
op_assign
(paren
r_uint32
)paren
l_int|0
suffix:semicolon
op_star
id|dword_ptr
op_assign
(paren
r_uint32
)paren
l_int|0
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi: No data, command packet data - &quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi: First IOCB block:&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|ha-&gt;request_ring_ptr
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi: Wakeup RISC for pending command&bslash;n&bslash;r&quot;
)paren
)paren
suffix:semicolon
id|ha-&gt;qthreads
op_decrement
suffix:semicolon
id|sp-&gt;u_start
op_assign
id|jiffies
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_SENT
suffix:semicolon
id|ha-&gt;actthreads
op_increment
suffix:semicolon
multiline_comment|/* qla1280_output_number((uint32_t)ha-&gt;actthreads++, 16); */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi: NO ROOM IN OUTSTANDING ARRAY&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; req_q_cnt=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;req_q_cnt
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_2
multiline_comment|/*  qla1280_print(&quot;qla1280_32bit_start_scsi: in-ptr=&quot;);&n;        qla1280_output_number((uint32_t)ha-&gt;req_ring_index, 16);&n;        qla1280_print(&quot; req_q_cnt=&quot;);&n;        qla1280_output_number((uint32_t)ha-&gt;req_q_cnt, 16);&n;        qla1280_print(&quot; req_cnt=&quot;);&n;        qla1280_output_number((uint32_t)req_cnt, 16);&n;        qla1280_print(&quot;&bslash;n&bslash;r&quot;); */
macro_line|#endif
)brace
multiline_comment|/* Release ring specific lock */
id|QLA1280_RING_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
multiline_comment|/* if (status)&n;    qla1280_print(&quot;qla1280_32bit_start_scsi: **** FAILED ****&bslash;n&bslash;r&quot;); */
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_req_pkt&n; *      Function is responsible for locking ring and&n; *      getting a zeroed out request packet.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *&n; * Returns:&n; *      0 = failed to get slot.&n; */
id|STATIC
id|request_t
op_star
DECL|function|qla1280_req_pkt
id|qla1280_req_pkt
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|request_t
op_star
id|pkt
op_assign
l_int|0
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
r_uint32
id|timer
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_req_pkt&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Wait for 30 seconds for slot. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|15000000
suffix:semicolon
id|timer
suffix:semicolon
id|timer
op_decrement
)paren
(brace
multiline_comment|/* Acquire ring specific lock */
id|QLA1280_RING_LOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* Found empty request ring slot? */
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OG
l_int|0
)paren
(brace
id|ha-&gt;req_q_cnt
op_decrement
suffix:semicolon
id|pkt
op_assign
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|REQUEST_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set system defined field. */
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Set entry count. */
id|pkt-&gt;entry_count
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Release ring specific lock */
id|QLA1280_RING_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
id|SYS_DELAY
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 10 */
multiline_comment|/* Check for pending interrupts. */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_req_pkt: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_req_pkt: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pkt
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_isp_cmd&n; *      Function is responsible for modifying ISP input pointer.&n; *      Releases ring lock.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_isp_cmd
id|qla1280_isp_cmd
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isp_cmd&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isp_cmd: IOCB data:&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|ha-&gt;request_ring_ptr
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
multiline_comment|/* Release ring specific lock */
id|QLA1280_RING_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isp_cmd&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_enable_lun&n; *      Issue enable LUN entry IOCB.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      b  = SCSI BUS number.&n; *      l  = LUN number.&n; */
id|STATIC
r_void
DECL|function|qla1280_enable_lun
id|qla1280_enable_lun
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|b
comma
r_uint32
id|l
)paren
(brace
id|elun_entry_t
op_star
id|pkt
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_enable_lun: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
multiline_comment|/*&n;    if (pkt = (elun_entry_t *)qla1280_req_pkt(ha))&n;    {&n;    pkt-&gt;entry_type = ENABLE_LUN_TYPE;&n;    pkt-&gt;lun = (uint16_t)(b ? l | BIT_15 : l);&n;    pkt-&gt;command_count = 32;&n;    pkt-&gt;immed_notify_count = 1;&n;    pkt-&gt;group_6_length = MAX_CMDSZ;&n;    pkt-&gt;group_7_length = MAX_CMDSZ;&n;    pkt-&gt;timeout = 0x30;&n;&n;    qla1280_isp_cmd(ha);&n;    }&n;    */
id|pkt
op_assign
(paren
id|elun_entry_t
op_star
)paren
l_int|1
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_enable_lun: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_enable_lun: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
multiline_comment|/****************************************************************************/
multiline_comment|/*                      Target Mode Support Functions.                      */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; * qla1280_notify_ack&n; *      Issue notify acknowledge IOCB.&n; *      If sequence ID is zero, acknowledgement of&n; *      SCSI bus reset or bus device reset is assumed.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      inotify = immediate notify entry pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_notify_ack
id|qla1280_notify_ack
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|notify_entry_t
op_star
id|inotify
)paren
(brace
id|nack_entry_t
op_star
id|pkt
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_notify_ack: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|nack_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|NOTIFY_ACK_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|inotify-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|inotify-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|inotify-&gt;target_id
suffix:semicolon
r_if
c_cond
(paren
id|inotify-&gt;seq_id
op_eq
l_int|0
)paren
id|pkt-&gt;event
op_assign
id|BIT_7
suffix:semicolon
r_else
id|pkt-&gt;seq_id
op_assign
id|inotify-&gt;seq_id
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_notify_ack: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_notify_ack: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_immed_notify&n; *      Issue immediate notify IOCB for LUN 0.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      inotify = immediate notify entry pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_immed_notify
id|qla1280_immed_notify
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|notify_entry_t
op_star
id|inotify
)paren
(brace
id|notify_entry_t
op_star
id|pkt
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_immed_notify: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|notify_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|IMMED_NOTIFY_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|inotify-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|inotify-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|inotify-&gt;target_id
suffix:semicolon
id|pkt-&gt;status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_immed_notify: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_immed_notify: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_accept_io&n; *      Issue accept target I/O IOCB for LUN 0.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      ctio = ctio returned entry pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_accept_io
id|qla1280_accept_io
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|ctio_ret_entry_t
op_star
id|ctio
)paren
(brace
id|atio_entry_t
op_star
id|pkt
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_accept_io: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|atio_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|ACCEPT_TGT_IO_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|ctio-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|ctio-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|ctio-&gt;target_id
suffix:semicolon
id|pkt-&gt;tag_value
op_assign
id|ctio-&gt;tag_value
suffix:semicolon
id|pkt-&gt;status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_accept_io: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_accept_io: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_64bit_continue_io&n; *      Issue continue target I/O IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      atio = atio pointer.&n; *      len  = total bytecount.&n; *      addr = physical address pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_64bit_continue_io
id|qla1280_64bit_continue_io
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|atio_entry_t
op_star
id|atio
comma
r_uint32
id|len
comma
id|paddr32_t
op_star
id|addr
)paren
(brace
id|ctio_a64_entry_t
op_star
id|pkt
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_continue_io: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|ctio_a64_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|CTIO_A64_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|atio-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|atio-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|atio-&gt;target_id
suffix:semicolon
id|pkt-&gt;option_flags
op_assign
id|atio-&gt;option_flags
suffix:semicolon
id|pkt-&gt;tag_value
op_assign
id|atio-&gt;tag_value
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|atio-&gt;scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;dseg_count
op_assign
l_int|1
suffix:semicolon
id|pkt-&gt;transfer_length
op_assign
id|len
suffix:semicolon
id|pkt-&gt;dseg_0_length
op_assign
id|len
suffix:semicolon
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|addr
suffix:semicolon
id|pkt-&gt;dseg_0_address
(braket
l_int|0
)braket
op_assign
op_star
id|dword_ptr
op_increment
suffix:semicolon
id|pkt-&gt;dseg_0_address
(braket
l_int|1
)braket
op_assign
op_star
id|dword_ptr
suffix:semicolon
)brace
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_continue_io: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_64bit_continue_io: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_32bit_continue_io&n; *      Issue continue target I/O IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      atio = atio pointer.&n; *      len  = total bytecount.&n; *      addr = physical address pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_32bit_continue_io
id|qla1280_32bit_continue_io
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|atio_entry_t
op_star
id|atio
comma
r_uint32
id|len
comma
id|paddr32_t
op_star
id|addr
)paren
(brace
id|ctio_entry_t
op_star
id|pkt
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_continue_io: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|ctio_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|CONTINUE_TGT_IO_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|atio-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|atio-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|atio-&gt;target_id
suffix:semicolon
id|pkt-&gt;option_flags
op_assign
id|atio-&gt;option_flags
suffix:semicolon
id|pkt-&gt;tag_value
op_assign
id|atio-&gt;tag_value
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|atio-&gt;scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;dseg_count
op_assign
l_int|1
suffix:semicolon
id|pkt-&gt;transfer_length
op_assign
id|len
suffix:semicolon
id|pkt-&gt;dseg_0_length
op_assign
id|len
suffix:semicolon
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|addr
suffix:semicolon
id|pkt-&gt;dseg_0_address
op_assign
op_star
id|dword_ptr
suffix:semicolon
)brace
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_continue_io: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_32bit_continue_io: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* QL1280_TARGET_MODE_SUPPORT */
multiline_comment|/****************************************************************************/
multiline_comment|/*                        Interrupt Service Routine.                        */
multiline_comment|/****************************************************************************/
multiline_comment|/****************************************************************************&n; *  qla1280_isr&n; *      Calls I/O done on command completion.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; *      INTR_LOCK must be already obtained.&n; ****************************************************************************/
id|STATIC
r_void
DECL|function|qla1280_isr
id|qla1280_isr
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|response_t
op_star
id|pkt
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_uint16
id|mailbox
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint32
id|index
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isr&quot;
)paren
suffix:semicolon
multiline_comment|/* Save mailbox register 5 */
id|mailbox
(braket
l_int|5
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
)paren
suffix:semicolon
multiline_comment|/* Check for mailbox interrupt. */
id|mailbox
(braket
l_int|0
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
op_amp
id|BIT_0
)paren
(brace
multiline_comment|/* Get mailbox data. */
id|wptr
op_assign
op_amp
id|mailbox
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
suffix:semicolon
op_star
id|wptr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
op_ne
id|MBA_SCSI_COMPLETION
)paren
(brace
id|wptr
op_increment
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox6
)paren
suffix:semicolon
op_star
id|wptr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox7
)paren
suffix:semicolon
)brace
multiline_comment|/* Release mailbox registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: mailbox interrupt mailbox[0] = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|0
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Handle asynchronous event */
r_switch
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MBA_SCSI_COMPLETION
suffix:colon
multiline_comment|/* Response completion */
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: mailbox response completion&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;flags.online
)paren
(brace
multiline_comment|/* Get outstanding command index. */
id|index
op_assign
(paren
r_uint32
)paren
(paren
id|mailbox
(braket
l_int|2
)braket
op_lshift
l_int|16
op_or
id|mailbox
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|index
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save ISP completion status */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Place block on done queue */
id|sp-&gt;s_next
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;s_prev
op_assign
op_star
id|done_q_last
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|done_q_first
)paren
op_star
id|done_q_first
op_assign
id|sp
suffix:semicolon
r_else
(paren
op_star
id|done_q_last
)paren
op_member_access_from_pointer
id|s_next
op_assign
id|sp
suffix:semicolon
op_star
id|done_q_last
op_assign
id|sp
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ISP invalid handle&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP invalid handle&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|MBA_BUS_RESET
suffix:colon
multiline_comment|/* SCSI Bus Reset */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: asynchronous BUS_RESET&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ha-&gt;flags.reset_marker
op_assign
id|TRUE
suffix:semicolon
id|index
op_assign
id|mailbox
(braket
l_int|6
)braket
op_amp
id|BIT_0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|index
)braket
dot
id|reset_marker
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_SYSTEM_ERR
suffix:colon
multiline_comment|/* System Error */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ISP System Error - mbx1=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|1
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;, mbx2=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|2
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;, mbx3=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|3
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP System Error - mbx1=%xh, mbx2=%xh, mbx3=%xh&bslash;n&quot;
comma
id|mailbox
(braket
l_int|1
)braket
comma
id|mailbox
(braket
l_int|2
)braket
comma
id|mailbox
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_REQ_TRANSFER_ERR
suffix:colon
multiline_comment|/* Request Transfer Error */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ISP Request Transfer Error&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP Request Transfer Error&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_RSP_TRANSFER_ERR
suffix:colon
multiline_comment|/* Response Transfer Error */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ISP Response Transfer Error&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP Response Transfer Error&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_WAKEUP_THRES
suffix:colon
multiline_comment|/* Request Queue Wake-up */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: asynchronous WAKEUP_THRES&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MBA_TIMEOUT_RESET
suffix:colon
multiline_comment|/* Execution Timeout Reset */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: asynchronous TIMEOUT_RESET&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MBA_DEVICE_RESET
suffix:colon
multiline_comment|/* Bus Device Reset */
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: asynchronous BUS_DEVICE_RESET&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ha-&gt;flags.reset_marker
op_assign
id|TRUE
suffix:semicolon
id|index
op_assign
id|mailbox
(braket
l_int|6
)braket
op_amp
id|BIT_0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|index
)braket
dot
id|reset_marker
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_BUS_MODE_CHANGE
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: asynchronous BUS_MODE_CHANGE&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
OL
id|MBA_ASYNC_EVENT
)paren
(brace
id|wptr
op_assign
op_amp
id|mailbox
(braket
l_int|0
)braket
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|1
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|2
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|3
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|4
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|5
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|6
)braket
op_assign
op_star
id|wptr
op_increment
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|7
)braket
op_assign
op_star
id|wptr
suffix:semicolon
id|ha-&gt;flags.mbox_int
op_assign
id|TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
multiline_comment|/*&n;    * Response ring&n;    */
r_if
c_cond
(paren
id|ha-&gt;flags.online
op_logical_and
op_logical_neg
id|ha-&gt;flags.mbox_busy
)paren
(brace
r_if
c_cond
(paren
id|mailbox
(braket
l_int|5
)braket
OL
id|RESPONSE_ENTRY_CNT
)paren
(brace
r_while
c_loop
(paren
id|ha-&gt;rsp_ring_index
op_ne
id|mailbox
(braket
l_int|5
)braket
)paren
(brace
id|pkt
op_assign
id|ha-&gt;response_ring_ptr
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_5
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;rsp_ring_index
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; mailbox[5] = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|5
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;rqla1280_isr: response packet data&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(QL_DEBUG_LEVEL_2) &amp;&amp; !defined(QL_DEBUG_LEVEL_5)
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
)paren
(brace
r_if
c_cond
(paren
(paren
r_uint8
)paren
(paren
id|pkt-&gt;scsi_status
)paren
op_logical_or
id|pkt-&gt;comp_status
op_logical_or
id|pkt-&gt;entry_status
)paren
(brace
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;rsp_ring_index
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot; mailbox[5] = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|5
)braket
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r comp_status = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;comp_status
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;, &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot; scsi_status = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;scsi_status
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)paren
multiline_comment|/* qla1280_print(&n;                        &quot;&bslash;n&bslash;rqla1280_isr: response packet data&bslash;n&bslash;r&quot;);&n;                        qla1280_dump_buffer((caddr_t)pkt,&n;                        RESPONSE_ENTRY_SIZE); */
)brace
)brace
r_else
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ha-&gt;rsp_ring_index
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; mailbox[5] = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|mailbox
(braket
l_int|5
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;rqla1280_isr: response packet data&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
id|pkt
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
op_logical_or
id|pkt-&gt;entry_status
)paren
(brace
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
)paren
id|qla1280_status_entry
c_func
(paren
id|ha
comma
(paren
id|sts_entry_t
op_star
)paren
id|pkt
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
r_else
id|qla1280_error_entry
c_func
(paren
id|ha
comma
id|pkt
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;rsp_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rsp_ring_index
op_eq
id|RESPONSE_ENTRY_CNT
)paren
(brace
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;response_ring_ptr
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
comma
id|ha-&gt;rsp_ring_index
)paren
suffix:semicolon
)brace
macro_line|#if QLA1280_TARGET_MODE_SUPPORT
r_else
(brace
id|pkt
op_assign
op_amp
id|response_entry
suffix:semicolon
multiline_comment|/* Copy packet. */
id|dptr1
op_assign
(paren
r_uint32
op_star
)paren
id|ha-&gt;response_ring_ptr
suffix:semicolon
id|dptr2
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|RESPONSE_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|index
op_increment
)paren
op_star
id|dptr2
op_increment
op_assign
op_star
id|dptr1
op_increment
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;rsp_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rsp_ring_index
op_eq
id|RESPONSE_ENTRY_CNT
)paren
(brace
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;response_ring_ptr
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
comma
id|ha-&gt;rsp_ring_index
)paren
suffix:semicolon
multiline_comment|/* Release interrupt specific lock */
id|QLA1280_INTR_UNLOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;entry_type
)paren
(brace
r_case
id|ACCEPT_TGT_IO_TYPE
suffix:colon
id|qla1280_atio_entry
c_func
(paren
id|ha
comma
(paren
id|atio_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMMED_NOTIFY_TYPE
suffix:colon
id|qla1280_notify_entry
c_func
(paren
id|ha
comma
(paren
id|notify_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTIO_RET_TYPE
suffix:colon
id|qla1280_accept_io
c_func
(paren
id|ha
comma
(paren
id|ctio_ret_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* Acquire interrupt specific lock */
id|QLA1280_INTR_LOCK
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
r_else
(brace
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_isr: Response pointer Error&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isr&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_rst_aen&n; *      Processes asynchronous reset.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_rst_aen
id|qla1280_rst_aen
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
id|notify_entry_t
id|nentry
suffix:semicolon
macro_line|#endif
r_uint8
id|b
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_rst_aen&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;flags.online
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_active
op_logical_and
op_logical_neg
id|ha-&gt;flags.abort_isp_active
)paren
(brace
id|ha-&gt;flags.reset_active
op_assign
id|TRUE
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_marker
suffix:semicolon
id|b
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|reset_marker
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|reset_marker
op_assign
id|FALSE
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.reset_marker
)paren
(brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
multiline_comment|/* Issue notify acknowledgement command. */
id|bzero
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|nentry
comma
r_sizeof
(paren
id|notify_entry_t
)paren
)paren
suffix:semicolon
id|nentry.initiator_id
op_assign
id|nentry.target_id
op_assign
id|b
ques
c_cond
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|id
op_or
id|BIT_7
suffix:colon
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|id
suffix:semicolon
id|qla1280_notify_entry
c_func
(paren
id|ha
comma
op_amp
id|nentry
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Asynchronous event notification */
)brace
)brace
)brace
)brace
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_rst_aen&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
multiline_comment|/*&n; *  qla1280_atio_entry&n; *      Processes received ISP accept target I/O entry.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      pkt = entry pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_atio_entry
id|qla1280_atio_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|atio_entry_t
op_star
id|pkt
)paren
(brace
r_uint64
op_star
id|a64
suffix:semicolon
r_uint64
op_star
id|end_a64
suffix:semicolon
id|paddr32_t
id|phy_addr
(braket
l_int|2
)braket
suffix:semicolon
id|paddr32_t
id|end_addr
(braket
l_int|2
)braket
suffix:semicolon
r_uint32
id|len
suffix:semicolon
r_uint32
id|offset
suffix:semicolon
r_uint8
id|t
suffix:semicolon
r_uint8
op_star
id|sense_ptr
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|t
op_assign
id|pkt-&gt;initiator_id
suffix:semicolon
id|sense_ptr
op_assign
id|ha-&gt;tsense
op_plus
id|t
op_star
id|TARGET_SENSE_SIZE
suffix:semicolon
id|a64
op_assign
(paren
r_uint64
op_star
)paren
op_amp
id|phy_addr
(braket
l_int|0
)braket
suffix:semicolon
id|end_a64
op_assign
(paren
r_uint64
op_star
)paren
op_amp
id|end_addr
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;status
op_amp
op_complement
id|BIT_7
)paren
(brace
r_case
l_int|7
suffix:colon
multiline_comment|/* Path invalid */
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Path invalid&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x14
suffix:colon
multiline_comment|/* Target Bus Phase Sequence Failure */
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Target Bus Phase Sequence Failure&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pkt-&gt;status
op_amp
id|BIT_7
)paren
(brace
id|BCOPY
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|pkt-&gt;sense_data
comma
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|bzero
c_func
(paren
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_HARDERR
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_SELFAIL
suffix:semicolon
)brace
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|qla1280_64bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
id|qla1280_32bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x16
suffix:colon
multiline_comment|/* Requested Capability Not Available */
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Target Bus Phase Sequence Failure&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x17
suffix:colon
multiline_comment|/* Bus Device Reset Message Received */
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Target Bus Phase Sequence Failure&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
l_int|0x3D
suffix:colon
multiline_comment|/* CDB Received */
multiline_comment|/* Check for invalid LUN */
r_if
c_cond
(paren
id|pkt-&gt;lun
op_logical_and
id|pkt-&gt;cdb
(braket
l_int|0
)braket
op_ne
id|SS_INQUIR
op_logical_and
id|pkt-&gt;cdb
(braket
l_int|0
)braket
op_ne
id|SS_REQSEN
)paren
id|pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|SS_TEST
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SS_TEST
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SS_TEST&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|bzero
c_func
(paren
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;lun
op_eq
l_int|0
)paren
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
r_else
(brace
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_INVLUN
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
)brace
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SS_REQSEN
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SS_REQSEN&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tsense_dma
suffix:semicolon
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|a64
op_add_assign
id|t
op_star
id|TARGET_SENSE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|4
)braket
OG
id|TARGET_SENSE_SIZE
)paren
id|len
op_assign
id|TARGET_SENSE_SIZE
suffix:semicolon
r_else
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_IN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SS_INQUIR
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SS_INQUIR&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|bzero
c_func
(paren
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tbuf_dma
suffix:semicolon
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|a64
op_add_assign
id|TARGET_INQ_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;lun
op_eq
l_int|0
)paren
(brace
id|ha-&gt;tbuf-&gt;inq.id_type
op_assign
id|ID_PROCESOR
suffix:semicolon
id|ha-&gt;tbuf-&gt;inq.id_pqual
op_assign
id|ID_QOK
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;tbuf-&gt;inq.id_type
op_assign
id|ID_NODEV
suffix:semicolon
id|ha-&gt;tbuf-&gt;inq.id_pqual
op_assign
id|ID_QNOLU
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|4
)braket
OG
r_sizeof
(paren
r_struct
id|ident
)paren
)paren
id|len
op_assign
r_sizeof
(paren
r_struct
id|ident
)paren
suffix:semicolon
r_else
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_IN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_WRDB
suffix:colon
id|bzero
c_func
(paren
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|offset
op_assign
id|pkt-&gt;cdb
(braket
l_int|5
)braket
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
op_lshift
l_int|8
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|3
)braket
op_lshift
l_int|16
suffix:semicolon
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|8
)braket
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|6
)braket
op_lshift
l_int|16
suffix:semicolon
id|end_addr
(braket
l_int|0
)braket
op_assign
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tbuf_dma
suffix:semicolon
id|end_addr
(braket
l_int|1
)braket
op_assign
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|end_a64
op_add_assign
id|TARGET_DATA_OFFSET
op_plus
id|TARGET_DATA_SIZE
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|1
)braket
op_amp
l_int|7
)paren
(brace
r_case
id|RW_BUF_HDATA
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB, RW_BUF_HDATA&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
OG
id|TARGET_DATA_SIZE
op_plus
l_int|4
)paren
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB, length &gt; buffer size&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_OUT
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Issuing SDI_TARMOD_WRCOMP&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|sdi_xaen
c_func
(paren
id|SDI_TARMOD_WRCOMP
comma
id|ha-&gt;cntlr
comma
id|pkt-&gt;target_id
comma
id|pkt-&gt;lun
comma
l_int|0
comma
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB, zero length&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RW_BUF_DATA
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB, RW_BUF_DATA&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|a64
op_add_assign
id|offset
op_plus
id|TARGET_DATA_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
op_ne
l_int|0
op_logical_or
op_star
id|a64
op_ge
op_star
id|end_a64
op_logical_or
op_star
id|a64
op_plus
id|len
OG
op_star
id|end_a64
)paren
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB, RW_BUF_DATA BAD&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;buf_id=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;, offset=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|offset
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;, length=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|len
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_OUT
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Issuing SDI_TARMOD_WRCOMP&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|sdi_xaen
c_func
(paren
id|SDI_TARMOD_WRCOMP
comma
id|ha-&gt;cntlr
comma
id|pkt-&gt;target_id
comma
id|pkt-&gt;lun
comma
l_int|0
comma
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB, zero length&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_WRDB unknown mode&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SM_RDDB
suffix:colon
id|bzero
c_func
(paren
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|offset
op_assign
id|pkt-&gt;cdb
(braket
l_int|5
)braket
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
op_lshift
l_int|8
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|3
)braket
op_lshift
l_int|16
suffix:semicolon
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|8
)braket
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|6
)braket
op_lshift
l_int|16
suffix:semicolon
id|end_addr
(braket
l_int|0
)braket
op_assign
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tbuf_dma
suffix:semicolon
id|end_addr
(braket
l_int|1
)braket
op_assign
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|end_a64
op_add_assign
id|TARGET_DATA_OFFSET
op_plus
id|TARGET_DATA_SIZE
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|1
)braket
op_amp
l_int|7
)paren
(brace
r_case
id|RW_BUF_HDATA
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, RW_BUF_HDATA&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
)paren
(brace
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|1
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|16
)paren
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|2
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|8
)paren
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|3
)braket
op_assign
(paren
r_uint8
)paren
id|TARGET_DATA_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|TARGET_DATA_SIZE
op_plus
l_int|4
)paren
id|len
op_assign
id|TARGET_DATA_SIZE
op_plus
l_int|4
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_IN
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, zero length&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RW_BUF_DATA
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, RW_BUF_DATA&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|a64
op_add_assign
id|offset
op_plus
id|TARGET_DATA_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
op_ne
l_int|0
op_logical_or
op_star
id|a64
op_ge
op_star
id|end_a64
)paren
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, RW_BUF_DATA BAD&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;buf_id=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;, offset=&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|offset
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|a64
op_plus
id|len
OG
op_star
id|end_a64
)paren
id|len
op_assign
op_star
id|end_a64
op_minus
op_star
id|a64
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_IN
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, zero length&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|RW_BUF_DESC
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, RW_BUF_DESC&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|4
)paren
id|len
op_assign
l_int|4
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
op_ne
l_int|0
)paren
(brace
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|1
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|16
)paren
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|2
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|8
)paren
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|3
)braket
op_assign
(paren
r_uint8
)paren
id|TARGET_DATA_SIZE
suffix:semicolon
)brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_DATA_IN
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB, zero length&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: SM_RDDB unknown mode&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: Unknown SCSI command&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|pkt-&gt;cdb
(braket
l_int|0
)braket
comma
id|pkt-&gt;cdb_len
)paren
suffix:semicolon
macro_line|#endif
id|bzero
c_func
(paren
id|sense_ptr
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_INVOPCODE
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
r_uint32
)paren
id|OF_SSTS
op_or
(paren
r_uint32
)paren
id|OF_NO_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|qla1280_64bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
id|len
comma
(paren
id|paddr32_t
op_star
)paren
op_amp
id|phy_addr
)paren
suffix:semicolon
r_else
id|qla1280_32bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
id|len
comma
(paren
id|paddr32_t
op_star
)paren
op_amp
id|phy_addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_atio_entry: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *  qla1280_notify_entry&n; *      Processes received ISP immediate notify entry.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      pkt = entry pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_notify_entry
id|qla1280_notify_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|notify_entry_t
op_star
id|pkt
)paren
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_notify_entry: entered&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Acknowledge immediate notify */
id|qla1280_notify_ack
c_func
(paren
id|ha
comma
id|pkt
)paren
suffix:semicolon
multiline_comment|/* Issue notify entry to increment resource count */
id|qla1280_immed_notify
c_func
(paren
id|ha
comma
id|pkt
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_notify_entry: exiting normally&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif  /* QLA1280_TARGET_MODE_SUPPORT */
multiline_comment|/*&n; *  qla1280_status_entry&n; *      Processes received ISP status entry.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      pkt          = entry pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_status_entry
id|qla1280_status_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sts_entry_t
op_star
id|pkt
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
r_uint8
id|sense_sz
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cp
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_status_entry&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_assign
l_int|0
suffix:semicolon
id|cp
op_assign
id|sp-&gt;cmd
suffix:semicolon
multiline_comment|/* Generate LU queue on cntrl, target, LUN */
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cp
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cp
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cp
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;comp_status
op_logical_or
id|pkt-&gt;scsi_status
)paren
(brace
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;scsi: comp_status = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;comp_status
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;, &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot; scsi_status = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;scsi_status
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;, handle = &quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|pkt-&gt;handle
comma
l_int|16
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)paren
)brace
multiline_comment|/* Target busy */
r_if
c_cond
(paren
id|pkt-&gt;scsi_status
op_amp
id|SS_BUSY_CONDITION
op_logical_and
id|pkt-&gt;scsi_status
op_ne
id|SS_RESERVE_CONFLICT
)paren
(brace
id|CMD_RESULT
c_func
(paren
id|cp
)paren
op_assign
(paren
r_int
)paren
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
op_or
(paren
id|pkt-&gt;scsi_status
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Save ISP completion status */
id|CMD_RESULT
c_func
(paren
id|cp
)paren
op_assign
id|qla1280_return_status
c_func
(paren
id|pkt
comma
id|cp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
id|BZERO
c_func
(paren
id|cp-&gt;sense_buffer
comma
id|CMD_SNSLEN
c_func
(paren
id|cp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;comp_status
op_ne
id|CS_ARS_FAILED
)paren
(brace
r_if
c_cond
(paren
id|pkt-&gt;req_sense_length
OL
id|CMD_SNSLEN
c_func
(paren
id|cp
)paren
)paren
id|sense_sz
op_assign
id|pkt-&gt;req_sense_length
suffix:semicolon
r_else
id|sense_sz
op_assign
id|CMD_SNSLEN
c_func
(paren
id|cp
)paren
op_minus
l_int|1
suffix:semicolon
id|BCOPY
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|pkt-&gt;req_sense_data
comma
id|cp-&gt;sense_buffer
comma
id|sense_sz
)paren
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_status_entry: Check condition Sense data, b&quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|b
comma
l_int|10
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;t&quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|t
comma
l_int|10
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;d&quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|l
comma
l_int|10
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
r_if
(paren
id|sense_sz
)paren
)paren
id|DEBUG
c_func
(paren
id|qla1280_dump_buffer
c_func
(paren
id|cp-&gt;sense_buffer
comma
id|sense_sz
)paren
suffix:semicolon
)paren
macro_line|#endif
)brace
)brace
multiline_comment|/* Place command on done queue. */
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_status_entry: ISP Invalid handle&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Status Entry invalid handle&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_status_entry&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *  qla1280_error_entry&n; *      Processes error entry.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      pkt          = entry pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_error_entry
id|qla1280_error_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|response_t
op_star
id|pkt
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_error_entry&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_2
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_3
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_error_entry: BAD PAYLOAD flag error&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_2
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_error_entry: BAD HEADER flag error&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_1
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_error_entry: FULL flag error&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
r_else
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_error_entry: UNKNOWN flag error&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Bad payload or header */
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
(paren
id|BIT_3
op_plus
id|BIT_2
)paren
)paren
(brace
multiline_comment|/* Bad payload or header, set error status. */
multiline_comment|/* CMD_RESULT(sp-&gt;cmd) = CS_BAD_PAYLOAD; */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
)paren
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_1
)paren
multiline_comment|/* FULL flag */
(brace
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
)paren
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set error status. */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
)paren
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* Place command on done queue. */
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
)brace
macro_line|#if  QLA1280_64BIT_SUPPORT
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|COMMAND_A64_TYPE
)paren
(brace
macro_line|#ifdef QL_DEBUG_LEVEL_2
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_error_entry: ISP Invalid handle&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;!qla1280: Error Entry invalid handle&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_error_entry&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *  qla1280_abort_isp&n; *      Resets ISP and aborts all outstanding commands.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
id|STATIC
r_uint8
DECL|function|qla1280_abort_isp
id|qla1280_abort_isp
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_isp&quot;
)paren
suffix:semicolon
macro_line|#endif
id|DRIVER_LOCK
id|ha-&gt;flags.isp_abort_needed
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.abort_isp_active
op_logical_and
id|ha-&gt;flags.online
)paren
(brace
id|ha-&gt;flags.abort_isp_active
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Dequeue all commands in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Generate LU queue on controller, target, LUN */
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|t
op_assign
id|SCSI_TCN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|l
op_assign
id|SCSI_LUN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|q
op_assign
(paren
id|scsi_lu_t
op_star
)paren
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* Reset outstanding command count. */
id|q-&gt;q_outcnt
op_assign
l_int|0
suffix:semicolon
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QBUSY
suffix:semicolon
id|q-&gt;q_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Adjust watchdog timer for command. */
multiline_comment|/* if (sp-&gt;flags &amp; SRB_WATCHDOG)&n;                sp-&gt;timeout += 2; */
multiline_comment|/* Place request back on top of device queue. */
multiline_comment|/* sp-&gt;flags &amp;= ~(SRB_SENT | SRB_TIMEOUT); */
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|qla1280_putq_t
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
id|qla1280_isp_firmware
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_chip_diag
c_func
(paren
id|ha
)paren
)paren
)paren
id|status
op_assign
id|qla1280_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Setup adapter based on NVRAM parameters. */
id|qla1280_nvram_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_init_rings
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
multiline_comment|/* Issue SCSI reset. */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
(brace
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|b
)paren
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|reset_marker
op_assign
id|FALSE
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|b
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
suffix:semicolon
multiline_comment|/* Enable host adapter target mode. */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_enable_tgt
c_func
(paren
id|ha
comma
id|b
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_LUNS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
multiline_comment|/* qla1280_enable_lun(ha, b, cnt); */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Enable ISP interrupts. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_EN_INT
op_plus
id|ISP_EN_RISC
)paren
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* Restart queues that may have been stopped. */
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP error recovery failed, board disabled&quot;
)paren
suffix:semicolon
id|qla1280_reset_adapter
c_func
(paren
id|ha
)paren
suffix:semicolon
id|qla1280_abort_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3)
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_abort_isp: **** FAILED ****&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
r_else
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_isp&quot;
)paren
suffix:semicolon
macro_line|#endif
id|DRIVER_UNLOCK
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_restart_queues&n; *      Restart all device queues.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_restart_queues
id|qla1280_restart_queues
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|ENTER
c_func
(paren
l_string|&quot;qla1280_restart_queues&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
(brace
id|q
op_assign
(paren
id|scsi_lu_t
op_star
)paren
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Acquire LU queue specific lock */
id|QLA1280_SCSILU_LOCK
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_first
)paren
id|qla1280_next
c_func
(paren
id|ha
comma
id|q
comma
id|b
)paren
suffix:semicolon
r_else
multiline_comment|/* Release LU queue specific lock */
id|QLA1280_SCSILU_UNLOCK
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef QL_DEBUG_LEVEL_3
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_restart_queues: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *  qla1280_abort_queue_single&n; *      Abort all commands on a device queues.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
DECL|function|qla1280_abort_queue_single
id|STATIC
r_void
id|qla1280_abort_queue_single
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|b
comma
r_uint32
id|t
comma
r_uint32
id|l
comma
r_uint32
id|stat
)paren
(brace
id|scsi_lu_t
op_star
id|q
suffix:semicolon
id|srb_t
op_star
id|sp
comma
op_star
id|sp_next
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_queue_single&quot;
)paren
suffix:semicolon
id|q
op_assign
(paren
id|scsi_lu_t
op_star
)paren
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Acquire LU queue specific lock */
id|QLA1280_SCSILU_LOCK
c_func
(paren
id|q
)paren
suffix:semicolon
id|sp
op_assign
id|q-&gt;q_first
suffix:semicolon
id|q-&gt;q_first
op_assign
id|q-&gt;q_last
op_assign
l_int|NULL
suffix:semicolon
id|QLA1280_SCSILU_UNLOCK
c_func
(paren
id|q
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sp
)paren
(brace
id|sp_next
op_assign
id|sp-&gt;s_next
suffix:semicolon
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|stat
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_first
comma
(paren
id|srb_t
op_star
op_star
)paren
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|sp
op_assign
id|sp_next
suffix:semicolon
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_queue_single&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_abort_queues&n; *      Abort all commands on device queues.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
id|STATIC
r_void
DECL|function|qla1280_abort_queues
id|qla1280_abort_queues
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_queues&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|ha-&gt;ports
suffix:semicolon
id|b
op_increment
)paren
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
comma
id|DID_RESET
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_queues&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_debounce_register&n; *      Debounce register.&n; *&n; * Input:&n; *      port = register address.&n; *&n; * Returns:&n; *      register value.&n; */
id|STATIC
r_uint16
DECL|function|qla1280_debounce_register
id|qla1280_debounce_register
c_func
(paren
r_volatile
r_uint16
op_star
id|addr
)paren
(brace
r_volatile
r_uint16
id|ret
suffix:semicolon
r_volatile
r_uint16
id|ret2
suffix:semicolon
r_do
(brace
id|ret
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ret2
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_ne
id|ret2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Declarations for load module&n; */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|QLA1280_LINUX_TEMPLATE
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
multiline_comment|/************************************************************************&n; * qla1280_check_for_dead_scsi_bus                                      *&n; *                                                                      *&n; *    This routine checks for a dead SCSI bus                           *&n; ************************************************************************/
DECL|macro|SET_SXP_BANK
mdefine_line|#define SET_SXP_BANK            0x0100
DECL|macro|SCSI_PHASE_INVALID
mdefine_line|#define SCSI_PHASE_INVALID      0x87FF
DECL|function|qla1280_check_for_dead_scsi_bus
r_int
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_uint16
id|config_reg
comma
id|scsi_control
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint32
id|b
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cp
suffix:semicolon
multiline_comment|/*&n;     * If SCSI Bus is Dead because of bad termination,&n;     * we will return a status of Selection timeout.&n;     */
id|cp
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|b
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|scsi_bus_dead
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_PAUSE_RISC
)paren
suffix:semicolon
id|config_reg
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|SET_SXP_BANK
)paren
suffix:semicolon
id|scsi_control
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;scsiControlPins
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|config_reg
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_control
op_eq
id|SCSI_PHASE_INVALID
)paren
(brace
id|CMD_RESULT
c_func
(paren
id|cp
)paren
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|cp
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|0
suffix:semicolon
multiline_comment|/* ha-&gt;actthreads--; */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,95)
id|sti
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
(paren
id|cp
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cp
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
(paren
op_star
(paren
id|cp
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cp
)paren
suffix:semicolon
macro_line|#endif
r_return
id|TRUE
suffix:semicolon
multiline_comment|/* bus is dead */
)brace
r_else
(brace
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|scsi_bus_dead
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|b
)braket
dot
id|failed_reset_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* bus is not dead */
)brace
id|STATIC
r_uint8
DECL|function|qla12160_set_target_parameters
id|qla12160_set_target_parameters
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|b
comma
r_uint32
id|t
comma
r_uint32
id|l
comma
id|nvram160_t
op_star
id|nv
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
multiline_comment|/* Set Target Parameters. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|b
ques
c_cond
id|t
op_or
id|BIT_7
suffix:colon
id|t
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|parameter.c
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_or_assign
id|TP_AUTO_REQUEST_SENSE
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_and_assign
op_complement
id|TP_STOP_QUEUE
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_or_assign
(paren
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.enable_ppr
op_lshift
l_int|5
)paren
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.sync_offset
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_or_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|sync_period
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.ppr_options
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_or_assign
id|nv-&gt;bus
(braket
id|b
)braket
dot
id|target
(braket
id|t
)braket
dot
id|flags.ppr_bus_width
suffix:semicolon
r_return
(paren
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_6
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|STATIC
r_void
DECL|function|qla12160_get_target_parameters
id|qla12160_get_target_parameters
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|b
comma
r_uint32
id|t
comma
r_uint32
id|l
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|b
ques
c_cond
id|t
op_or
id|BIT_7
suffix:colon
id|t
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_6
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|3
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): Synchronous tranfer at period %d, offset %d. &bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
(paren
id|mb
(braket
l_int|3
)braket
op_amp
l_int|0xff
)paren
comma
(paren
id|mb
(braket
l_int|3
)braket
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mb
(braket
l_int|2
)braket
op_amp
id|BIT_5
)paren
op_logical_and
(paren
(paren
id|mb
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ge
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%d:%d:%d:%d): Dual Transition enabled.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
)brace
macro_line|#ifdef QL_DEBUG_ROUTINES
multiline_comment|/****************************************************************************/
multiline_comment|/*                         Driver Debug Functions.                          */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; *  Get byte from I/O port&n; */
id|STATIC
r_uint8
DECL|function|qla1280_getbyte
id|qla1280_getbyte
c_func
(paren
r_uint8
op_star
id|port
)paren
(brace
r_uint8
id|ret
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ret
op_assign
op_star
id|port
suffix:semicolon
macro_line|#else
id|ret
op_assign
id|inb
c_func
(paren
(paren
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_getbyte: address = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|port
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; data = 0x&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ret
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  Get word from I/O port&n; */
id|STATIC
r_uint16
DECL|function|qla1280_getword
id|qla1280_getword
c_func
(paren
r_uint16
op_star
id|port
)paren
(brace
r_uint16
id|ret
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ret
op_assign
op_star
id|port
suffix:semicolon
macro_line|#else
id|ret
op_assign
id|inw
c_func
(paren
(paren
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_getword: address = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|port
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; data = 0x&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ret
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  Get double word from I/O port&n; */
id|STATIC
r_uint32
DECL|function|qla1280_getdword
id|qla1280_getdword
c_func
(paren
r_uint32
op_star
id|port
)paren
(brace
r_uint32
id|ret
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ret
op_assign
op_star
id|port
suffix:semicolon
macro_line|#else
id|ret
op_assign
id|inl
c_func
(paren
(paren
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_getdword: address = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|port
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; data = 0x&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|ret
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send byte to I/O port&n; */
id|STATIC
r_void
DECL|function|qla1280_putbyte
id|qla1280_putbyte
c_func
(paren
r_uint8
op_star
id|port
comma
r_uint8
id|data
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
op_star
id|port
op_assign
id|data
suffix:semicolon
macro_line|#else
id|outb
c_func
(paren
id|data
comma
(paren
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_putbyte: address = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|port
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; data = 0x&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|data
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  Send word to I/O port&n; */
id|STATIC
r_void
DECL|function|qla1280_putword
id|qla1280_putword
c_func
(paren
r_uint16
op_star
id|port
comma
r_uint16
id|data
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
op_star
id|port
op_assign
id|data
suffix:semicolon
macro_line|#else
macro_line|#ifdef _LINUX_IOPORTS
id|outw
c_func
(paren
id|data
comma
(paren
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|outw
c_func
(paren
(paren
r_int
)paren
id|port
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_putword: address = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|port
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; data = 0x&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|data
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  Send double word to I/O port&n; */
id|STATIC
r_void
DECL|function|qla1280_putdword
id|qla1280_putdword
c_func
(paren
r_uint32
op_star
id|port
comma
r_uint32
id|data
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
op_star
id|port
op_assign
id|data
suffix:semicolon
macro_line|#else
macro_line|#ifdef _LINUX_IOPORTS
id|outl
c_func
(paren
id|data
comma
(paren
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|outl
c_func
(paren
(paren
r_int
)paren
id|port
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot;qla1280_putdword: address = &quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|port
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; data = 0x&quot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|data
comma
l_int|16
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Dummy function to prevent warnings for&n; * declared and unused debug functions&n; */
r_void
DECL|function|qla1280_debug
id|qla1280_debug
c_func
(paren
r_void
)paren
(brace
id|qla1280_getbyte
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|qla1280_getword
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|qla1280_getdword
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|qla1280_putbyte
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|qla1280_putword
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|qla1280_putdword
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Out character to COM2 port.&n; *      PORT must be at standard address for COM2 = 0x2F8,&n; *      or COM1 = 0x3F8&n; */
DECL|macro|OUTB
mdefine_line|#define OUTB(addr,data)   outb((data),(addr))
id|STATIC
r_void
DECL|function|qla1280_putc
id|qla1280_putc
c_func
(paren
r_uint8
id|c
)paren
(brace
macro_line|#ifdef QL_DEBUG_CONSOLE
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|c
)paren
suffix:semicolon
macro_line|#else
r_int
id|com_addr
op_assign
l_int|0x2f8
suffix:semicolon
r_int
id|hardware_flow_control
op_assign
l_int|1
suffix:semicolon
r_int
id|software_flow_control
op_assign
l_int|0
suffix:semicolon
r_uint8
id|data
suffix:semicolon
multiline_comment|/* Wait for transmitter holding and shift registers for empty. */
r_do
(brace
id|data
op_assign
id|inb
c_func
(paren
id|com_addr
op_plus
l_int|5
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|data
op_amp
id|BIT_6
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    * Set BAUD rate for COM2 to 19200 (0x6)&n;    */
multiline_comment|/* Select rate divisor. */
id|OUTB
c_func
(paren
id|com_addr
op_plus
l_int|3
comma
l_int|0x83
)paren
suffix:semicolon
multiline_comment|/* BAUD rate divisor LSB. */
id|OUTB
c_func
(paren
id|com_addr
comma
l_int|0xc
)paren
suffix:semicolon
multiline_comment|/* 0xC = 9600 baud */
multiline_comment|/* BAUD rate divisor MSB. */
id|OUTB
c_func
(paren
id|com_addr
op_plus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set No parity, 8 bits, 1 stop bit and&n;    select interrupt enable register. */
id|OUTB
c_func
(paren
id|com_addr
op_plus
l_int|3
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts. */
id|OUTB
c_func
(paren
id|com_addr
op_plus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set data terminal ready and request to send */
id|OUTB
c_func
(paren
id|com_addr
op_plus
l_int|4
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hardware_flow_control
)paren
(brace
multiline_comment|/* Wait for clear-to-send and data-set-ready */
r_do
(brace
id|data
op_assign
id|inb
c_func
(paren
id|com_addr
op_plus
l_int|6
)paren
op_amp
(paren
id|BIT_5
op_plus
id|BIT_4
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|data
op_ne
(paren
id|BIT_5
op_plus
id|BIT_4
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|software_flow_control
)paren
(brace
multiline_comment|/* Test for data ready. */
id|data
op_assign
id|inb
c_func
(paren
id|com_addr
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|BIT_0
)paren
(brace
multiline_comment|/* If XOFF */
id|data
op_assign
id|inb
c_func
(paren
id|com_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_char|&squot;&bslash;023&squot;
)paren
(brace
multiline_comment|/* Wait for XON */
r_do
(brace
multiline_comment|/* Wait for char */
r_do
(brace
id|data
op_assign
id|inb
c_func
(paren
id|com_addr
op_plus
l_int|5
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|data
op_amp
id|BIT_0
)paren
)paren
suffix:semicolon
id|data
op_assign
id|inb
c_func
(paren
id|com_addr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|data
op_ne
l_char|&squot;&bslash;021&squot;
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Output character. */
id|OUTB
c_func
(paren
id|com_addr
comma
id|c
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *  Out NULL terminated string to COM port.&n; */
id|STATIC
r_void
DECL|function|qla1280_print
id|qla1280_print
c_func
(paren
id|caddr_t
id|s
)paren
(brace
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
macro_line|#ifdef QL_DEBUG_CONSOLE
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|s
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Output string. */
r_while
c_loop
(paren
op_star
id|s
)paren
id|qla1280_putc
c_func
(paren
op_star
id|s
op_increment
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; *  Output long number to COM port.&n; */
id|STATIC
r_void
DECL|function|qla1280_output_number
id|qla1280_output_number
c_func
(paren
r_uint32
id|n
comma
r_uint8
id|base
)paren
(brace
r_int8
id|str
(braket
l_int|12
)braket
suffix:semicolon
r_int8
op_star
id|s
op_assign
op_amp
id|str
(braket
l_int|11
)braket
suffix:semicolon
r_int8
id|output
op_assign
l_int|0
suffix:semicolon
r_int8
id|hex
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
r_if
c_cond
(paren
id|base
op_eq
l_int|10
op_logical_or
id|base
op_eq
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|base
op_eq
l_int|16
op_logical_and
id|n
OG
l_int|9
)paren
id|hex
op_assign
id|TRUE
suffix:semicolon
op_star
id|s
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|s
op_decrement
suffix:semicolon
op_star
id|s
op_assign
id|n
op_mod
id|base
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
OG
l_int|9
)paren
op_star
id|s
op_add_assign
l_int|55
suffix:semicolon
r_else
op_star
id|s
op_add_assign
l_char|&squot;0&squot;
suffix:semicolon
id|n
op_div_assign
id|base
suffix:semicolon
)brace
r_while
c_loop
(paren
id|n
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|s
suffix:semicolon
id|s
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|s
op_ne
l_char|&squot;0&squot;
)paren
id|output
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|output
)paren
id|qla1280_putc
c_func
(paren
op_star
id|s
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|output
)paren
id|qla1280_putc
c_func
(paren
op_star
op_decrement
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hex
)paren
id|qla1280_putc
c_func
(paren
l_char|&squot;h&squot;
)paren
suffix:semicolon
)brace
)brace
)brace
id|STATIC
r_void
DECL|function|qla1280_dump_buffer
id|qla1280_dump_buffer
c_func
(paren
id|caddr_t
id|b
comma
r_uint32
id|size
)paren
(brace
r_uint32
id|cnt
suffix:semicolon
r_uint8
id|c
suffix:semicolon
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|qla1280_print
c_func
(paren
l_string|&quot; 0   1   2   3   4   5   6   7   8   9   Ah  Bh  Ch  Dh  Eh  Fh&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;---------------------------------------------------------------&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|size
suffix:semicolon
)paren
(brace
id|c
op_assign
op_star
id|b
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_int|16
)paren
id|qla1280_putc
c_func
(paren
l_char|&squot; &squot;
)paren
suffix:semicolon
id|qla1280_output_number
c_func
(paren
(paren
r_uint32
)paren
id|c
comma
l_int|16
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cnt
op_mod
l_int|16
)paren
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|c
OL
l_int|10
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
r_else
id|qla1280_putc
c_func
(paren
l_char|&squot; &squot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_mod
l_int|16
)paren
id|qla1280_print
c_func
(paren
l_string|&quot;&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**************************************************************************&n; *   ql1280_print_scsi_cmd&n; *&n; **************************************************************************/
DECL|function|qla1280_print_scsi_cmd
r_void
id|qla1280_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
multiline_comment|/* struct scatterlist *sg; */
r_int
id|i
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;SCSI Command @= 0x%p, Handle=0x%p&bslash;n&bslash;r&quot;
comma
id|cmd
comma
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;  chan=%d, target = 0x%02x, lun = 0x%02x, cmd_len = 0x%02x&bslash;n&bslash;r&quot;
comma
id|cmd-&gt;channel
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot; CDB = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;0x%02x &quot;
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;  seg_cnt =%d&bslash;n&bslash;r&quot;
comma
id|cmd-&gt;use_sg
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;  request buffer=0x%p, request buffer len=0x%x&bslash;n&bslash;r&quot;
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
multiline_comment|/* if( cmd-&gt;use_sg )&n;    {&n;       sg = (struct scatterlist *) cmd-&gt;request_buffer;&n;       qla1280_print(&quot;  SG buffer: &bslash;n&bslash;r&quot;);&n;       qla1280_dump_buffer((caddr_t)sg, (cmd-&gt;use_sg*sizeof(struct scatterlist)) );&n;    } */
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;  tag=%d, flags=0x%x, transfersize=0x%x &bslash;n&bslash;r&quot;
comma
id|cmd-&gt;tag
comma
id|cmd-&gt;flags
comma
id|cmd-&gt;transfersize
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;  Pid=%d, SP=0x%p&bslash;n&bslash;r&quot;
comma
(paren
r_int
)paren
id|cmd-&gt;pid
comma
id|CMD_SP
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot;  r_start=0x%lx, u_start=0x%lx&bslash;n&bslash;r&quot;
comma
id|sp-&gt;r_start
comma
id|sp-&gt;u_start
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|debug_buff
comma
l_string|&quot; underflow size = 0x%x, direction=0x%x, req.cmd=0x%x &bslash;n&bslash;r&quot;
comma
id|cmd-&gt;underflow
comma
id|sp-&gt;dir
comma
id|cmd-&gt;request.cmd
)paren
suffix:semicolon
id|qla1280_print
c_func
(paren
id|debug_buff
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   ql1280_dump_device&n; *&n; **************************************************************************/
r_void
DECL|function|ql1280_dump_device
id|ql1280_dump_device
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|Scsi_Cmnd
op_star
id|cp
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|qla1280_print
c_func
(paren
l_string|&quot;Outstanding Commands on controller:&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cp
op_assign
id|sp-&gt;cmd
)paren
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|qla1280_print_scsi_cmd
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef  QLA1280_UNUSED 
multiline_comment|/**************************************************************************&n; *   ql1280_dump_regs&n; *&n; **************************************************************************/
DECL|function|qla1280_dump_regs
r_static
r_void
id|qla1280_dump_regs
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Mailbox registers:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 : mbox 0 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
l_int|0x70
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 : mbox 1 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
l_int|0x72
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 : mbox 2 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
l_int|0x74
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 : mbox 3 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
l_int|0x76
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 : mbox 4 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
l_int|0x78
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 : mbox 5 0x%04x &bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
l_int|0x7a
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if  STOP_ON_ERROR 
multiline_comment|/**************************************************************************&n; *   ql1280_panic&n; *&n; **************************************************************************/
DECL|function|qla1280_panic
r_static
r_void
id|qla1280_panic
c_func
(paren
r_char
op_star
id|cp
comma
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
r_int
op_star
id|fp
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1280 - PANIC:  %s&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Current time=0x%lx&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Number of pending commands =0x%lx&bslash;n&quot;
comma
id|ha-&gt;actthreads
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Number of SCSI queued commands =0x%lx&bslash;n&quot;
comma
id|ha-&gt;qthreads
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Number of free entries = (%d)&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Request Queue @ 0x%lx, Response Queue @ 0x%lx&bslash;n&quot;
comma
id|ha-&gt;request_dma
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Request In Ptr %d&bslash;n&quot;
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
id|fp
op_assign
(paren
r_int
op_star
)paren
op_amp
id|ha-&gt;flags
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HA flags =0x%lx&bslash;n&quot;
comma
op_star
id|fp
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
)paren
multiline_comment|/* DEBUG2(ql1280_dump_device((scsi_qla_host_t *) host-&gt;hostdata)); */
macro_line|#ifdef  QLA1280_UNUSED 
id|qla1280_dump_regs
c_func
(paren
id|host
)paren
suffix:semicolon
macro_line|#endif
id|sti
c_func
(paren
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Ooops&quot;
)paren
suffix:semicolon
multiline_comment|/* cli(); &n;    for(;;)&n;    { &n;        barrier();&n;    sti();  &n;    }&n;    */
)brace
macro_line|#endif
macro_line|#ifdef  QLA1280_UNUSED 
DECL|function|qla1280_set_flags
r_static
r_void
id|qla1280_set_flags
c_func
(paren
r_char
op_star
id|s
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/**************************************************************************&n; *   qla1280_setup&n; *&n; *   Handle Linux boot parameters. This routine allows for assigning a value&n; *   to a parameter with a &squot;:&squot; between the parameter and the value.&n; *   ie. qla1280=max_reqs:0x0A,verbose&n; **************************************************************************/
r_void
DECL|function|qla1280_setup
id|qla1280_setup
c_func
(paren
r_char
op_star
id|s
comma
r_int
op_star
id|dummy
)paren
(brace
r_char
op_star
id|end
comma
op_star
id|str
comma
op_star
id|cp
suffix:semicolon
macro_line|#ifdef  QLA1280_UNUSED 
r_static
r_struct
(brace
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|siz
suffix:semicolon
r_void
(paren
op_star
id|func
)paren
(paren
)paren
suffix:semicolon
r_int
id|arg
suffix:semicolon
)brace
id|options
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;dump_regs&quot;
comma
l_int|9
comma
op_amp
id|qla1280_dump_regs
comma
l_int|0
)brace
comma
(brace
l_string|&quot;verbose&quot;
comma
l_int|7
comma
op_amp
id|qla1280_set_flags
comma
l_int|0x1
)brace
comma
(brace
l_string|&quot;&quot;
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)brace
)brace
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;scsi: Processing Option str = %s&bslash;n&quot;
comma
id|s
)paren
suffix:semicolon
id|end
op_assign
id|strchr
c_func
(paren
id|s
comma
l_char|&squot;&bslash;0&squot;
)paren
suffix:semicolon
multiline_comment|/* locate command */
id|str
op_assign
id|s
suffix:semicolon
r_for
c_loop
(paren
id|cp
op_assign
id|s
suffix:semicolon
op_star
id|cp
op_logical_and
id|cp
op_ne
id|end
suffix:semicolon
id|cp
op_increment
)paren
(brace
id|cp
op_assign
id|qla1280_get_token
c_func
(paren
id|cp
comma
id|str
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi: token str = %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
multiline_comment|/* if found execute routine */
)brace
)brace
DECL|function|qla1280_get_token
r_static
r_char
op_star
id|qla1280_get_token
c_func
(paren
r_char
op_star
id|cmdline
comma
r_char
op_star
id|str
)paren
(brace
r_register
r_char
op_star
id|cp
op_assign
id|cmdline
suffix:semicolon
multiline_comment|/* skip preceeding spaces */
r_while
c_loop
(paren
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot; &squot;
)paren
)paren
(brace
op_increment
id|cp
suffix:semicolon
)brace
multiline_comment|/* symbol starts here */
id|str
op_assign
id|cp
suffix:semicolon
multiline_comment|/* skip char if not a space or : */
r_while
c_loop
(paren
op_star
id|cp
op_logical_and
op_logical_neg
(paren
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot; &squot;
)paren
op_logical_or
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
id|cp
op_increment
suffix:semicolon
op_star
id|cp
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|cp
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we almost follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 2&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -2&n; * c-argdecl-indent: 2&n; * c-label-offset: -2&n; * c-continued-statement-offset: 2&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
