multiline_comment|/***********************************************************************&n; *&t;FILE NAME : TMSCSIM.C&t;&t;&t;&t;&t;       *&n; *&t;     BY   : C.L. Huang,  ching@tekram.com.tw&t;&t;       *&n; *&t;Description: Device Driver for Tekram DC-390(T) PCI SCSI       *&n; *&t;&t;     Bus Master Host Adapter&t;&t;&t;       *&n; * (C)Copyright 1995-1996 Tekram Technology Co., Ltd.&t;&t;       *&n; ***********************************************************************/
multiline_comment|/* (C) Copyright: put under GNU GPL in 10/96  (see README.tmscsim)&t;*&n;*************************************************************************/
multiline_comment|/* $Id: tmscsim.c,v 2.60.2.30 2000/12/20 01:07:12 garloff Exp $&t;&t;*/
multiline_comment|/*&t;Enhancements and bugfixes by&t;&t;&t;&t;&t;*&n; *&t;Kurt Garloff &lt;kurt@garloff.de&gt;&t;&lt;garloff@suse.de&gt;&t;&t;*&n; ***********************************************************************/
multiline_comment|/*&t;HISTORY:&t;&t;&t;&t;&t;&t;&t;*&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; *&t;REV#&t;DATE&t;NAME&t;DESCRIPTION&t;&t;&t;&t;*&n; *&t;1.00  96/04/24&t;CLH&t;First release&t;&t;&t;&t;*&n; *&t;1.01  96/06/12&t;CLH&t;Fixed bug of Media Change for Removable *&n; *&t;&t;&t;&t;Device, scan all LUN. Support Pre2.0.10 *&n; *&t;1.02  96/06/18&t;CLH&t;Fixed bug of Command timeout ...&t;*&n; *&t;1.03  96/09/25&t;KG&t;Added tmscsim_proc_info()&t;&t;*&n; *&t;1.04  96/10/11&t;CLH&t;Updating for support KV 2.0.x&t;&t;*&n; *&t;1.05  96/10/18&t;KG&t;Fixed bug in DC390_abort(null ptr deref)*&n; *&t;1.06  96/10/25&t;KG&t;Fixed module support&t;&t;&t;*&n; *&t;1.07  96/11/09&t;KG&t;Fixed tmscsim_proc_info()&t;&t;*&n; *&t;1.08  96/11/18&t;KG&t;Fixed null ptr in DC390_Disconnect()&t;*&n; *&t;1.09  96/11/30&t;KG&t;Added register the allocated IO space&t;*&n; *&t;1.10  96/12/05&t;CLH&t;Modified tmscsim_proc_info(), and reset *&n; *&t;&t;&t;&t;pending interrupt in DC390_detect()&t;*&n; *&t;1.11  97/02/05&t;KG/CLH&t;Fixeds problem with partitions greater&t;*&n; *&t;&t;&t;&t;than 1GB&t;&t;&t;&t;*&n; *&t;1.12  98/02/15  MJ      Rewritten PCI probing&t;&t;&t;*&n; *&t;1.13  98/04/08&t;KG&t;Support for non DC390, __initfunc decls,*&n; *&t;&t;&t;&t;changed max devs from 10 to 16&t;&t;*&n; *&t;1.14a 98/05/05&t;KG&t;Dynamic DCB allocation, add-single-dev&t;*&n; *&t;&t;&t;&t;for LUNs if LUN_SCAN (BIOS) not set&t;*&n; *&t;&t;&t;&t;runtime config using /proc interface&t;*&n; *&t;1.14b 98/05/06&t;KG&t;eliminated cli (); sti (); spinlocks&t;*&n; *&t;1.14c 98/05/07&t;KG&t;2.0.x compatibility&t;&t;&t;*&n; *&t;1.20a 98/05/07&t;KG&t;changed names of funcs to be consistent *&n; *&t;&t;&t;&t;DC390_ (entry points), dc390_ (internal)*&n; *&t;&t;&t;&t;reworked locking&t;&t;&t;*&n; *&t;1.20b 98/05/12&t;KG&t;bugs: version, kfree, _ctmp&t;&t;*&n; *&t;&t;&t;&t;debug output&t;&t;&t;&t;*&n; *&t;1.20c 98/05/12&t;KG&t;bugs: kfree, parsing, EEpromDefaults&t;*&n; *&t;1.20d 98/05/14&t;KG&t;bugs: list linkage, clear flag after  &t;*&n; *&t;&t;&t;&t;reset on startup, code cleanup&t;&t;*&n; *&t;1.20e 98/05/15&t;KG&t;spinlock comments, name space cleanup&t;*&n; *&t;&t;&t;&t;pLastDCB now part of ACB structure&t;*&n; *&t;&t;&t;&t;added stats, timeout for 2.1, TagQ bug&t;*&n; *&t;&t;&t;&t;RESET and INQUIRY interface commands&t;*&n; *&t;1.20f 98/05/18&t;KG&t;spinlocks fixes, max_lun fix, free DCBs&t;*&n; *&t;&t;&t;&t;for missing LUNs, pending int&t;&t;*&n; *&t;1.20g 98/05/19&t;KG&t;Clean up: Avoid short&t;&t;&t;*&n; *&t;1.20h 98/05/21&t;KG&t;Remove AdaptSCSIID, max_lun ...&t;&t;*&n; *&t;1.20i 98/05/21&t;KG&t;Aiiie: Bug with TagQMask       &t;&t;*&n; *&t;1.20j 98/05/24&t;KG&t;Handle STAT_BUSY, handle pACB-&gt;pLinkDCB&t;*&n; *&t;&t;&t;&t;== 0 in remove_dev and DoingSRB_Done&t;*&n; *&t;1.20k 98/05/25&t;KG&t;DMA_INT&t;(experimental)&t;       &t;&t;*&n; *&t;1.20l 98/05/27&t;KG&t;remove DMA_INT; DMA_IDLE cmds added;&t;*&n; *&t;1.20m 98/06/10&t;KG&t;glitch configurable; made some global&t;*&n; *&t;&t;&t;&t;vars part of ACB; use DC390_readX&t;*&n; *&t;1.20n 98/06/11&t;KG&t;startup params&t;&t;&t;&t;*&n; *&t;1.20o 98/06/15&t;KG&t;added TagMaxNum to boot/module params&t;*&n; *&t;&t;&t;&t;Device Nr -&gt; Idx, TagMaxNum power of 2  *&n; *&t;1.20p 98/06/17&t;KG&t;Docu updates. Reset depends on settings *&n; *&t;&t;&t;&t;pci_set_master added; 2.0.xx: pcibios_*&t;*&n; *&t;&t;&t;&t;used instead of MechNum things ...&t;*&n; *&t;1.20q 98/06/23&t;KG&t;Changed defaults. Added debug code for&t;*&n; *&t;&t;&t;&t;removable media and fixed it. TagMaxNum&t;*&n; *&t;&t;&t;&t;fixed for DC390. Locking: ACB, DRV for&t;*&n; *&t;&t;&t;&t;better IRQ sharing. Spelling: Queueing&t;*&n; *&t;&t;&t;&t;Parsing and glitch_cfg changes. Display&t;*&n; *&t;&t;&t;&t;real SyncSpeed value. Made DisConn&t;*&n; *&t;&t;&t;&t;functional (!)&t;&t;&t;&t;*&n; *&t;1.20r 98/06/30&t;KG&t;Debug macros, allow disabling DsCn, set&t;*&n; *&t;&t;&t;&t;BIT4 in CtrlR4, EN_PAGE_INT, 2.0 module&t;*&n; *&t;&t;&t;&t;param -1 fixed.&t;&t;&t;&t;*&n; *&t;1.20s 98/08/20&t;KG&t;Debug info on abort(), try to check PCI,*&n; *&t;&t;&t;&t;phys_to_bus instead of phys_to_virt,&t;*&n; *&t;&t;&t;&t;fixed sel. process, fixed locking,&t;*&n; *&t;&t;&t;&t;added MODULE_XXX infos, changed IRQ&t;*&n; *&t;&t;&t;&t;request flags, disable DMA_INT&t;&t;*&n; *&t;1.20t 98/09/07&t;KG&t;TagQ report fixed; Write Erase DMA Stat;*&n; *&t;&t;&t;&t;initfunc -&gt; __init; better abort;&t;*&n; *&t;&t;&t;&t;Timeout for XFER_DONE &amp; BLAST_COMPLETE;&t;*&n; *&t;&t;&t;&t;Allow up to 33 commands being processed *&n; *&t;2.0a  98/10/14&t;KG&t;Max Cmnds back to 17. DMA_Stat clearing *&n; *&t;&t;&t;&t;all flags. Clear within while() loops&t;*&n; *&t;&t;&t;&t;in DataIn_0/Out_0. Null ptr in dumpinfo&t;*&n; *&t;&t;&t;&t;for pSRB==0. Better locking during init.*&n; *&t;&t;&t;&t;bios_param() now respects part. table.&t;*&n; *&t;2.0b  98/10/24&t;KG&t;Docu fixes. Timeout Msg in DMA Blast.&t;*&n; *&t;&t;&t;&t;Disallow illegal idx in INQUIRY/REMOVE&t;*&n; *&t;2.0c  98/11/19&t;KG&t;Cleaned up detect/init for SMP boxes, &t;*&n; *&t;&t;&t;&t;Write Erase DMA (1.20t) caused problems&t;*&n; *&t;2.0d  98/12/25&t;KG&t;Christmas release ;-) Message handling  *&n; *&t;&t;&t;&t;completely reworked. Handle target ini-&t;*&n; *&t;&t;&t;&t;tiated SDTR correctly.&t;&t;&t;*&n; *&t;2.0d1 99/01/25&t;KG&t;Try to handle RESTORE_PTR&t;&t;*&n; *&t;2.0d2 99/02/08&t;KG&t;Check for failure of kmalloc, correct &t;*&n; *&t;&t;&t;&t;inclusion of scsicam.h, DelayReset&t;*&n; *&t;2.0d3 99/05/31&t;KG&t;DRIVER_OK -&gt; DID_OK, DID_NO_CONNECT,&t;*&n; *&t;&t;&t;&t;detect Target mode and warn.&t;&t;*&n; *&t;&t;&t;&t;pcmd-&gt;result handling cleaned up.&t;*&n; *&t;2.0d4 99/06/01&t;KG&t;Cleaned selection process. Found bug&t;*&n; *&t;&t;&t;&t;which prevented more than 16 tags. Now:&t;*&n; *&t;&t;&t;&t;24. SDTR cleanup. Cleaner multi-LUN&t;*&n; *&t;&t;&t;&t;handling. Don&squot;t modify ControlRegs/FIFO&t;*&n; *&t;&t;&t;&t;when connected.&t;&t;&t;&t;*&n; *&t;2.0d5 99/06/01&t;KG&t;Clear DevID, Fix INQUIRY after cfg chg.&t;*&n; *&t;2.0d6 99/06/02&t;KG&t;Added ADD special command to allow cfg.&t;*&n; *&t;&t;&t;&t;before detection. Reset SYNC_NEGO_DONE&t;*&n; *&t;&t;&t;&t;after a bus reset.&t;&t;&t;*&n; *&t;2.0d7 99/06/03&t;KG&t;Fixed bugs wrt add,remove commands&t;*&n; *&t;2.0d8 99/06/04&t;KG&t;Removed copying of cmnd into CmdBlock.&t;*&n; *&t;&t;&t;&t;Fixed Oops in _release().&t;&t;*&n; *&t;2.0d9 99/06/06&t;KG&t;Also tag queue INQUIRY, T_U_R, ...&t;*&n; *&t;&t;&t;&t;Allow arb. no. of Tagged Cmnds. Max 32&t;*&n; *&t;2.0d1099/06/20&t;KG&t;TagMaxNo changes now honoured! Queueing *&n; *&t;&t;&t;&t;clearified (renamed ..) TagMask handling*&n; *&t;&t;&t;&t;cleaned.&t;&t;&t;&t;*&n; *&t;2.0d1199/06/28&t;KG&t;cmd-&gt;result now identical to 2.0d2&t;*&n; *&t;2.0d1299/07/04&t;KG&t;Changed order of processing in IRQ&t;*&n; *&t;2.0d1399/07/05&t;KG&t;Don&squot;t update DCB fields if removed&t;*&n; *&t;2.0d1499/07/05&t;KG&t;remove_dev: Move kfree() to the end&t;*&n; *&t;2.0d1599/07/12&t;KG&t;use_new_eh_code: 0, ULONG -&gt; UINT where&t;*&n; *&t;&t;&t;&t;appropriate&t;&t;&t;&t;*&n; *&t;2.0d1699/07/13&t;KG&t;Reenable StartSCSI interrupt, Retry msg&t;*&n; *&t;2.0d1799/07/15&t;KG&t;Remove debug msg. Disable recfg. when&t;*&n; *&t;&t;&t;&t;there are queued cmnds&t;&t;&t;*&n; *&t;2.0d1899/07/18&t;KG&t;Selection timeout: Don&squot;t requeue&t;*&n; *&t;2.0d1999/07/18&t;KG&t;Abort: Only call scsi_done if dequeued&t;*&n; *&t;2.0d2099/07/19&t;KG&t;Rst_Detect: DoingSRB_Done&t;&t;*&n; *&t;2.0d2199/08/15&t;KG&t;dev_id for request/free_irq, cmnd[0] for*&n; *&t;&t;&t;&t;RETRY, SRBdone does DID_ABORT for the &t;*&n; *&t;&t;&t;&t;cmd passed by DC390_reset()&t;&t;*&n; *&t;2.0d2299/08/25&t;KG&t;dev_id fixed. can_queue: 42&t;&t;*&n; *&t;2.0d2399/08/25&t;KG&t;Removed some debugging code. dev_id &t;*&n; *&t;&t;&t;&t;now is set to pACB. Use u8,u16,u32. &t;*&n; *&t;2.0d2499/11/14&t;KG&t;Unreg. I/O if failed IRQ alloc. Call&t;*&n; * &t;&t;&t;&t;done () w/ DID_BAD_TARGET in case of&t;*&n; *&t;&t;&t;&t;missing DCB. We&t;are old EH!!&t;&t;*&n; *&t;2.0d2500/01/15&t;KG&t;2.3.3x compat from Andreas Schultz&t;*&n; *&t;&t;&t;&t;set unique_id. Disable RETRY message.&t;*&n; *&t;2.0d2600/01/29&t;KG&t;Go to new EH.&t;&t;&t;&t;*&n; *&t;2.0d2700/01/31&t;KG&t;... but maintain 2.0 compat.&t;&t;*&n; *&t;&t;&t;&t;and fix DCB freeing&t;&t;&t;*&n; *&t;2.0d2800/02/14&t;KG&t;Queue statistics fixed, dump special cmd*&n; *&t;&t;&t;&t;Waiting_Timer for failed StartSCSI&t;*&n; *&t;&t;&t;&t;New EH: Don&squot;t return cmnds to ML on RST *&n; *&t;&t;&t;&t;Use old EH (don&squot;t have new EH fns yet)&t;*&n; * &t;&t;&t;&t;Reset: Unlock, but refuse to queue&t;*&n; * &t;&t;&t;&t;2.3 __setup function&t;&t;&t;*&n; *&t;2.0e  00/05/22&t;KG&t;Return residual for 2.3&t;&t;&t;*&n; *&t;2.0e1 00/05/25&t;KG&t;Compile fixes for 2.3.99&t;&t;*&n; *&t;2.0e2 00/05/27&t;KG&t;Jeff Garzik&squot;s pci_enable_device()&t;*&n; *&t;2.0e3 00/09/29&t;KG&t;Some 2.4 changes. Don&squot;t try Sync Nego&t;*&n; *&t;&t;&t;&t;before INQUIRY has reported ability. &t;*&n; *&t;&t;&t;&t;Recognise INQUIRY as scanning command.&t;*&n; *&t;2.0e4 00/10/13&t;KG&t;Allow compilation into 2.4 kernel&t;*&n; *&t;2.0e5 00/11/17&t;KG&t;Store Inq.flags in DCB&t;&t;&t;*&n; *&t;2.0e6 00/11/22  KG&t;2.4 init function (Thx to O.Schumann)&t;*&n; * &t;&t;&t;&t;2.4 PCI device table (Thx to A.Richter)&t;*&n; *&t;2.0e7 00/11/28&t;KG&t;Allow overriding of BIOS settings&t;*&n; *&t;2.0f  00/12/20&t;KG&t;Handle failed INQUIRYs during scan&t;*&n; ***********************************************************************/
multiline_comment|/* Uncomment SA_INTERRUPT, if the driver refuses to share its IRQ with other devices */
DECL|macro|DC390_IRQ
mdefine_line|#define DC390_IRQ SA_SHIRQ /* | SA_INTERRUPT */
multiline_comment|/* DEBUG options */
singleline_comment|//#define DC390_DEBUG0
singleline_comment|//#define DC390_DEBUG1
singleline_comment|//#define DC390_DCBDEBUG
singleline_comment|//#define DC390_PARSEDEBUG
singleline_comment|//#define DC390_REMOVABLEDEBUG
singleline_comment|//#define DC390_LOCKDEBUG
multiline_comment|/* Debug definitions */
macro_line|#ifdef DC390_DEBUG0
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x) x;
macro_line|#else
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x)
macro_line|#endif
macro_line|#ifdef DC390_DEBUG1
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x) x;
macro_line|#else
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x)
macro_line|#endif
macro_line|#ifdef DC390_DCBDEBUG
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x) x;
macro_line|#else
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x)
macro_line|#endif
macro_line|#ifdef DC390_PARSEDEBUG
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x) x;
macro_line|#else
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x)
macro_line|#endif
macro_line|#ifdef DC390_REMOVABLEDEBUG
DECL|macro|REMOVABLEDEBUG
macro_line|# define REMOVABLEDEBUG(x) x;
macro_line|#else
DECL|macro|REMOVABLEDEBUG
macro_line|# define REMOVABLEDEBUG(x)
macro_line|#endif
DECL|macro|DCBDEBUG1
mdefine_line|#define DCBDEBUG1(x)
multiline_comment|/* Includes */
macro_line|#ifdef MODULE
macro_line|# include &lt;linux/module.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;scsi/scsicam.h&gt;
macro_line|#include &quot;dc390.h&quot;
DECL|macro|PCI_DEVICE_ID_AMD53C974
mdefine_line|#define PCI_DEVICE_ID_AMD53C974 &t;PCI_DEVICE_ID_AMD_SCSI
multiline_comment|/* Locking */
multiline_comment|/* Note: Starting from 2.1.9x, the mid-level scsi code issues a &n; * spinlock_irqsave (&amp;io_request_lock) before calling the driver&squot;s &n; * routines, so we don&squot;t need to lock, except in the IRQ handler.&n; * The policy 3, let the midlevel scsi code do the io_request_locks&n; * and us locking on a driver specific lock, shouldn&squot;t hurt anybody; it&n; * just causes a minor performance degradation for setting the locks.&n; */
multiline_comment|/* spinlock things&n; * level 3: lock on both adapter specific locks and (global) io_request_lock&n; * level 2: lock on adapter specific locks only&n; * level 1: rely on the locking of the mid level code (io_request_lock)&n; * undef  : traditional save_flags; cli; restore_flags;&n; */
singleline_comment|//#define DEBUG_SPINLOCKS 2&t;/* Set to 0, 1 or 2 in include/linux/spinlock.h */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,30)
macro_line|# include &lt;linux/init.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,30)
macro_line|# include &lt;linux/spinlock.h&gt;
macro_line|#else
macro_line|# include &lt;asm/spinlock.h&gt;
macro_line|#endif
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,93) 
DECL|macro|USE_SPINLOCKS
macro_line|# define USE_SPINLOCKS 1
DECL|macro|NEW_PCI
macro_line|# define NEW_PCI 1
macro_line|#else
DECL|macro|NEW_PCI
macro_line|# undef NEW_PCI
macro_line|# if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,30)
DECL|macro|USE_SPINLOCKS
macro_line|#  define USE_SPINLOCKS 2
macro_line|# endif
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,99)
DECL|variable|__initdata
r_static
r_struct
id|pci_device_id
id|tmscsim_pci_tbl
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|vendor
suffix:colon
id|PCI_VENDOR_ID_AMD
comma
id|device
suffix:colon
id|PCI_DEVICE_ID_AMD53C974
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tmscsim_pci_tbl
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef USE_SPINLOCKS
macro_line|# if USE_SPINLOCKS == 3 /* both */
macro_line|#  if defined (CONFIG_SMP) || DEBUG_SPINLOCKS &gt; 0
DECL|macro|DC390_LOCKA_INIT
macro_line|#   define DC390_LOCKA_INIT { spinlock_t __unlocked = SPIN_LOCK_UNLOCKED; pACB-&gt;lock = __unlocked; };
macro_line|#  else
DECL|macro|DC390_LOCKA_INIT
macro_line|#   define DC390_LOCKA_INIT
macro_line|#  endif
DECL|variable|dc390_drvlock
id|spinlock_t
id|dc390_drvlock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|macro|DC390_AFLAGS
macro_line|#  define DC390_AFLAGS unsigned long aflags;
DECL|macro|DC390_IFLAGS
macro_line|#  define DC390_IFLAGS unsigned long iflags;
DECL|macro|DC390_DFLAGS
macro_line|#  define DC390_DFLAGS unsigned long dflags; 
DECL|macro|DC390_LOCK_IO
macro_line|#  define DC390_LOCK_IO spin_lock_irqsave (&amp;io_request_lock, iflags)
DECL|macro|DC390_UNLOCK_IO
macro_line|#  define DC390_UNLOCK_IO spin_unlock_irqrestore (&amp;io_request_lock, iflags)
DECL|macro|DC390_LOCK_DRV
macro_line|#  define DC390_LOCK_DRV spin_lock_irqsave (&amp;dc390_drvlock, dflags)
DECL|macro|DC390_UNLOCK_DRV
macro_line|#  define DC390_UNLOCK_DRV spin_unlock_irqrestore (&amp;dc390_drvlock, dflags)
DECL|macro|DC390_LOCK_DRV_NI
macro_line|#  define DC390_LOCK_DRV_NI spin_lock (&amp;dc390_drvlock)
DECL|macro|DC390_UNLOCK_DRV_NI
macro_line|#  define DC390_UNLOCK_DRV_NI spin_unlock (&amp;dc390_drvlock)
DECL|macro|DC390_LOCK_ACB
macro_line|#  define DC390_LOCK_ACB spin_lock_irqsave (&amp;(pACB-&gt;lock), aflags)
DECL|macro|DC390_UNLOCK_ACB
macro_line|#  define DC390_UNLOCK_ACB spin_unlock_irqrestore (&amp;(pACB-&gt;lock), aflags)
DECL|macro|DC390_LOCK_ACB_NI
macro_line|#  define DC390_LOCK_ACB_NI spin_lock (&amp;(pACB-&gt;lock))
DECL|macro|DC390_UNLOCK_ACB_NI
macro_line|#  define DC390_UNLOCK_ACB_NI spin_unlock (&amp;(pACB-&gt;lock))
singleline_comment|//#  define DC390_LOCKA_INIT spin_lock_init (&amp;(pACB-&gt;lock))
macro_line|# else
macro_line|#  if USE_SPINLOCKS == 2 /* adapter specific locks */
macro_line|#   if defined (CONFIG_SMP) || DEBUG_SPINLOCKS &gt; 0
DECL|macro|DC390_LOCKA_INIT
macro_line|#    define DC390_LOCKA_INIT { spinlock_t __unlocked = SPIN_LOCK_UNLOCKED; pACB-&gt;lock = __unlocked; };
macro_line|#   else
DECL|macro|DC390_LOCKA_INIT
macro_line|#    define DC390_LOCKA_INIT
macro_line|#   endif
DECL|variable|dc390_drvlock
id|spinlock_t
id|dc390_drvlock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|macro|DC390_AFLAGS
macro_line|#   define DC390_AFLAGS unsigned long aflags;
DECL|macro|DC390_IFLAGS
macro_line|#   define DC390_IFLAGS 
DECL|macro|DC390_DFLAGS
macro_line|#  define DC390_DFLAGS unsigned long dflags; 
DECL|macro|DC390_LOCK_IO
macro_line|#   define DC390_LOCK_IO /* spin_lock_irqsave (&amp;io_request_lock, iflags) */
DECL|macro|DC390_UNLOCK_IO
macro_line|#   define DC390_UNLOCK_IO /* spin_unlock_irqrestore (&amp;io_request_lock, iflags) */
DECL|macro|DC390_LOCK_DRV
macro_line|#   define DC390_LOCK_DRV spin_lock_irqsave (&amp;dc390_drvlock, dflags)
DECL|macro|DC390_UNLOCK_DRV
macro_line|#   define DC390_UNLOCK_DRV spin_unlock_irqrestore (&amp;dc390_drvlock, dflags)
DECL|macro|DC390_LOCK_DRV_NI
macro_line|#   define DC390_LOCK_DRV_NI spin_lock (&amp;dc390_drvlock)
DECL|macro|DC390_UNLOCK_DRV_NI
macro_line|#   define DC390_UNLOCK_DRV_NI spin_unlock (&amp;dc390_drvlock)
DECL|macro|DC390_LOCK_ACB
macro_line|#   define DC390_LOCK_ACB spin_lock_irqsave (&amp;(pACB-&gt;lock), aflags)
DECL|macro|DC390_UNLOCK_ACB
macro_line|#   define DC390_UNLOCK_ACB spin_unlock_irqrestore (&amp;(pACB-&gt;lock), aflags)
DECL|macro|DC390_LOCK_ACB_NI
macro_line|#   define DC390_LOCK_ACB_NI spin_lock (&amp;(pACB-&gt;lock))
DECL|macro|DC390_UNLOCK_ACB_NI
macro_line|#   define DC390_UNLOCK_ACB_NI spin_unlock (&amp;(pACB-&gt;lock))
singleline_comment|//#   define DC390_LOCKA_INIT spin_lock_init (&amp;(pACB-&gt;lock))
macro_line|#  else /* USE_SPINLOCKS == 1: global lock io_request_lock */
DECL|macro|DC390_AFLAGS
macro_line|#   define DC390_AFLAGS 
DECL|macro|DC390_IFLAGS
macro_line|#   define DC390_IFLAGS unsigned long iflags;
DECL|macro|DC390_DFLAGS
macro_line|#   define DC390_DFLAGS unsigned long dflags; 
DECL|variable|dc390_drvlock
id|spinlock_t
id|dc390_drvlock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|macro|DC390_LOCK_IO
macro_line|#   define DC390_LOCK_IO spin_lock_irqsave (&amp;io_request_lock, iflags)
DECL|macro|DC390_UNLOCK_IO
macro_line|#   define DC390_UNLOCK_IO spin_unlock_irqrestore (&amp;io_request_lock, iflags)
DECL|macro|DC390_LOCK_DRV
macro_line|#   define DC390_LOCK_DRV spin_lock_irqsave (&amp;dc390_drvlock, dflags)
DECL|macro|DC390_UNLOCK_DRV
macro_line|#   define DC390_UNLOCK_DRV spin_unlock_irqrestore (&amp;dc390_drvlock, dflags)
DECL|macro|DC390_LOCK_DRV_NI
macro_line|#   define DC390_LOCK_DRV_NI spin_lock (&amp;dc390_drvlock)
DECL|macro|DC390_UNLOCK_DRV_NI
macro_line|#   define DC390_UNLOCK_DRV_NI spin_unlock (&amp;dc390_drvlock)
DECL|macro|DC390_LOCK_ACB
macro_line|#   define DC390_LOCK_ACB /* DC390_LOCK_IO */
DECL|macro|DC390_UNLOCK_ACB
macro_line|#   define DC390_UNLOCK_ACB /* DC390_UNLOCK_IO */
DECL|macro|DC390_LOCK_ACB_NI
macro_line|#   define DC390_LOCK_ACB_NI /* spin_lock (&amp;(pACB-&gt;lock)) */
DECL|macro|DC390_UNLOCK_ACB_NI
macro_line|#   define DC390_UNLOCK_ACB_NI /* spin_unlock (&amp;(pACB-&gt;lock)) */
DECL|macro|DC390_LOCKA_INIT
macro_line|#   define DC390_LOCKA_INIT /* DC390_LOCKA_INIT */
macro_line|#  endif /* 2 */
macro_line|# endif /* 3 */
macro_line|#else /* USE_SPINLOCKS undefined */
DECL|macro|DC390_AFLAGS
macro_line|# define DC390_AFLAGS unsigned long aflags;
DECL|macro|DC390_IFLAGS
macro_line|# define DC390_IFLAGS unsigned long iflags;
DECL|macro|DC390_DFLAGS
macro_line|# define DC390_DFLAGS unsigned long dflags; 
DECL|macro|DC390_LOCK_IO
macro_line|# define DC390_LOCK_IO save_flags (iflags); cli ()
DECL|macro|DC390_UNLOCK_IO
macro_line|# define DC390_UNLOCK_IO restore_flags (iflags)
DECL|macro|DC390_LOCK_DRV
macro_line|# define DC390_LOCK_DRV save_flags (dflags); cli ()
DECL|macro|DC390_UNLOCK_DRV
macro_line|# define DC390_UNLOCK_DRV restore_flags (dflags)
DECL|macro|DC390_LOCK_DRV_NI
macro_line|# define DC390_LOCK_DRV_NI
DECL|macro|DC390_UNLOCK_DRV_NI
macro_line|# define DC390_UNLOCK_DRV_NI
DECL|macro|DC390_LOCK_ACB
macro_line|# define DC390_LOCK_ACB save_flags (aflags); cli ()
DECL|macro|DC390_UNLOCK_ACB
macro_line|# define DC390_UNLOCK_ACB restore_flags (aflags)
DECL|macro|DC390_LOCK_ACB_NI
macro_line|# define DC390_LOCK_ACB_NI
DECL|macro|DC390_UNLOCK_ACB_NI
macro_line|# define DC390_UNLOCK_ACB_NI
DECL|macro|DC390_LOCKA_INIT
macro_line|# define DC390_LOCKA_INIT
macro_line|#endif /* def */
multiline_comment|/* These macros are used for uniform access to 2.0.x and 2.1.x PCI config space*/
macro_line|#ifdef NEW_PCI
DECL|macro|PDEV
macro_line|# define PDEV pdev
DECL|macro|PDEVDECL
macro_line|# define PDEVDECL struct pci_dev *pdev
DECL|macro|PDEVDECL0
macro_line|# define PDEVDECL0 struct pci_dev *pdev = NULL
DECL|macro|PDEVDECL1
macro_line|# define PDEVDECL1 struct pci_dev *pdev
DECL|macro|PDEVSET
macro_line|# define PDEVSET pACB-&gt;pdev=pdev
DECL|macro|PDEVSET1
macro_line|# define PDEVSET1 pdev=pACB-&gt;pdev
DECL|macro|PCI_WRITE_CONFIG_BYTE
macro_line|# define PCI_WRITE_CONFIG_BYTE(pd, rv, bv) pci_write_config_byte (pd, rv, bv)
DECL|macro|PCI_READ_CONFIG_BYTE
macro_line|# define PCI_READ_CONFIG_BYTE(pd, rv, bv) pci_read_config_byte (pd, rv, bv)
DECL|macro|PCI_WRITE_CONFIG_WORD
macro_line|# define PCI_WRITE_CONFIG_WORD(pd, rv, bv) pci_write_config_word (pd, rv, bv)
DECL|macro|PCI_READ_CONFIG_WORD
macro_line|# define PCI_READ_CONFIG_WORD(pd, rv, bv) pci_read_config_word (pd, rv, bv)
DECL|macro|PCI_BUS_DEV
macro_line|# define PCI_BUS_DEV pdev-&gt;bus-&gt;number, pdev-&gt;devfn
DECL|macro|PCI_PRESENT
macro_line|# define PCI_PRESENT pci_present ()
DECL|macro|PCI_SET_MASTER
macro_line|# define PCI_SET_MASTER pci_set_master (pdev)
DECL|macro|PCI_FIND_DEVICE
macro_line|# define PCI_FIND_DEVICE(vend, id) (pdev = pci_find_device (vend, id, pdev))
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,10)
DECL|macro|PCI_GET_IO_AND_IRQ
macro_line|# define PCI_GET_IO_AND_IRQ io_port = pci_resource_start (pdev, 0); irq = pdev-&gt;irq
macro_line|#else
DECL|macro|PCI_GET_IO_AND_IRQ
macro_line|# define PCI_GET_IO_AND_IRQ io_port = pdev-&gt;base_address[0] &amp; PCI_BASE_ADDRESS_IO_MASK; irq = pdev-&gt;irq
macro_line|#endif
macro_line|#else
macro_line|# include &lt;linux/bios32.h&gt;
DECL|macro|PDEV
macro_line|# define PDEV pbus, pdevfn
DECL|macro|PDEVDECL
macro_line|# define PDEVDECL UCHAR pbus, UCHAR pdevfn
DECL|macro|PDEVDECL0
macro_line|# define PDEVDECL0 UCHAR pbus = 0; UCHAR pdevfn = 0; USHORT pci_index = 0; int error
DECL|macro|PDEVDECL1
macro_line|# define PDEVDECL1 UCHAR pbus; UCHAR pdevfn /*; USHORT pci_index */
DECL|macro|PDEVSET
macro_line|# define PDEVSET pACB-&gt;pbus=pbus; pACB-&gt;pdevfn=pdevfn /*; pACB-&gt;pci_index=pci_index */
DECL|macro|PDEVSET1
macro_line|# define PDEVSET1 pbus=pACB-&gt;pbus; pdevfn=pACB-&gt;pdevfn /*; pci_index=pACB-&gt;pci_index */
DECL|macro|PCI_WRITE_CONFIG_BYTE
macro_line|# define PCI_WRITE_CONFIG_BYTE(pd, rv, bv) pcibios_write_config_byte (pd, rv, bv)
DECL|macro|PCI_READ_CONFIG_BYTE
macro_line|# define PCI_READ_CONFIG_BYTE(pd, rv, bv) pcibios_read_config_byte (pd, rv, bv)
DECL|macro|PCI_WRITE_CONFIG_WORD
macro_line|# define PCI_WRITE_CONFIG_WORD(pd, rv, bv) pcibios_write_config_word (pd, rv, bv)
DECL|macro|PCI_READ_CONFIG_WORD
macro_line|# define PCI_READ_CONFIG_WORD(pd, rv, bv) pcibios_read_config_word (pd, rv, bv)
DECL|macro|PCI_BUS_DEV
macro_line|# define PCI_BUS_DEV pbus, pdevfn
DECL|macro|PCI_PRESENT
macro_line|# define PCI_PRESENT pcibios_present ()
DECL|macro|PCI_SET_MASTER
macro_line|# define PCI_SET_MASTER dc390_set_master (pbus, pdevfn)
DECL|macro|PCI_FIND_DEVICE
macro_line|# define PCI_FIND_DEVICE(vend, id) (!pcibios_find_device (vend, id, pci_index++, &amp;pbus, &amp;pdevfn))
DECL|macro|PCI_GET_IO_AND_IRQ
macro_line|# define PCI_GET_IO_AND_IRQ error = pcibios_read_config_dword (pbus, pdevfn, PCI_BASE_ADDRESS_0, &amp;io_port);&t;&bslash;&n; error |= pcibios_read_config_byte (pbus, pdevfn, PCI_INTERRUPT_LINE, &amp;irq);&t;&bslash;&n; io_port &amp;= 0xfffe;&t;&bslash;&n; if (error) { printk (KERN_ERR &quot;DC390_detect: Error reading PCI config registers!&bslash;n&quot;); continue; }
macro_line|#endif 
macro_line|#include &quot;tmscsim.h&quot;
macro_line|#ifndef __init
DECL|macro|__init
macro_line|# define __init
macro_line|#endif
id|UCHAR
id|dc390_StartSCSI
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_void
id|dc390_DataOut_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_void
id|dc390_DataIn_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Command_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Status_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgOut_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_void
id|dc390_MsgIn_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataOutPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataInPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_void
id|dc390_CommandPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_StatusPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_void
id|dc390_MsgOutPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgInPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Nop_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Nop_1
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_SetXferRate
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
suffix:semicolon
r_void
id|dc390_Disconnect
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_void
id|dc390_Reselect
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_void
id|dc390_SRBdone
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_void
id|dc390_DoingSRB_Done
c_func
(paren
id|PACB
id|pACB
comma
id|PSCSICMD
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|dc390_ScsiRstDetect
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_ResetSCSIBus
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|__inline__
id|dc390_RequestSense
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|__inline__
id|dc390_InvalidCmd
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|__inline__
id|dc390_EnableMsgOut_Abort
(paren
id|PACB
comma
id|PSRB
)paren
suffix:semicolon
r_static
r_void
id|dc390_remove_dev
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
suffix:semicolon
r_void
id|do_DC390_Interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_int
id|dc390_initAdapter
c_func
(paren
id|PSH
id|psh
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|UCHAR
id|index
)paren
suffix:semicolon
r_void
id|dc390_initDCB
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
op_star
id|ppDCB
comma
id|UCHAR
id|id
comma
id|UCHAR
id|lun
)paren
suffix:semicolon
r_void
id|dc390_updateDCB
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_int
id|DC390_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
r_static
r_int
id|dc390_shutdown
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//static PSHT&t;dc390_pSHT_start = NULL;
singleline_comment|//static PSH&t;dc390_pSH_start = NULL;
singleline_comment|//static PSH&t;dc390_pSH_current = NULL;
DECL|variable|dc390_pACB_start
r_static
id|PACB
id|dc390_pACB_start
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dc390_pACB_current
r_static
id|PACB
id|dc390_pACB_current
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dc390_lastabortedpid
r_static
id|ULONG
id|dc390_lastabortedpid
op_assign
l_int|0
suffix:semicolon
DECL|variable|dc390_laststatus
r_static
id|UINT
id|dc390_laststatus
op_assign
l_int|0
suffix:semicolon
DECL|variable|dc390_adapterCnt
r_static
id|UCHAR
id|dc390_adapterCnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Startup values, to be overriden on the commandline */
DECL|variable|tmscsim
r_int
id|tmscsim
(braket
)braket
op_assign
(brace
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
)brace
suffix:semicolon
macro_line|# if defined(MODULE) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,30)
id|MODULE_PARM
c_func
(paren
id|tmscsim
comma
l_string|&quot;1-6i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tmscsim
comma
l_string|&quot;Host SCSI ID, Speed (0=10MHz), Device Flags, Adapter Flags, Max Tags (log2(tags)-1), DelayReset (s)&quot;
)paren
suffix:semicolon
macro_line|# endif
macro_line|#if defined(MODULE) &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,30)
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;C.L. Huang / Kurt Garloff&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI host adapter driver for Tekram DC390 and other AMD53C974A based PCI SCSI adapters&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;sd,sr,sg,st&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|dc390_phase0
r_static
id|PVOID
id|dc390_phase0
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|dc390_phase1
r_static
id|PVOID
id|dc390_phase1
(braket
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef DC390_DEBUG1
DECL|variable|dc390_p0_str
r_static
r_char
op_star
id|dc390_p0_str
(braket
)braket
op_assign
(brace
l_string|&quot;dc390_DataOut_0&quot;
comma
l_string|&quot;dc390_DataIn_0&quot;
comma
l_string|&quot;dc390_Command_0&quot;
comma
l_string|&quot;dc390_Status_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_MsgOut_0&quot;
comma
l_string|&quot;dc390_MsgIn_0&quot;
comma
l_string|&quot;dc390_Nop_1&quot;
)brace
suffix:semicolon
DECL|variable|dc390_p1_str
r_static
r_char
op_star
id|dc390_p1_str
(braket
)braket
op_assign
(brace
l_string|&quot;dc390_DataOutPhase&quot;
comma
l_string|&quot;dc390_DataInPhase&quot;
comma
l_string|&quot;dc390_CommandPhase&quot;
comma
l_string|&quot;dc390_StatusPhase&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_MsgOutPhase&quot;
comma
l_string|&quot;dc390_MsgInPhase&quot;
comma
l_string|&quot;dc390_Nop_1&quot;
)brace
suffix:semicolon
macro_line|#endif   
multiline_comment|/* Devices erroneously pretending to be able to do TagQ */
DECL|variable|dc390_baddevname1
id|UCHAR
id|dc390_baddevname1
(braket
l_int|2
)braket
(braket
l_int|28
)braket
op_assign
initialization_block
suffix:semicolon
DECL|macro|BADDEVCNT
mdefine_line|#define BADDEVCNT&t;2
DECL|variable|dc390_adapname
r_static
r_char
op_star
id|dc390_adapname
op_assign
l_string|&quot;DC390&quot;
suffix:semicolon
DECL|variable|dc390_eepromBuf
id|UCHAR
id|dc390_eepromBuf
(braket
id|MAX_ADAPTER_NUM
)braket
(braket
id|EE_LEN
)braket
suffix:semicolon
DECL|variable|dc390_clock_period1
id|UCHAR
id|dc390_clock_period1
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|10
comma
l_int|13
comma
l_int|20
)brace
suffix:semicolon
DECL|variable|dc390_clock_speed
id|UCHAR
id|dc390_clock_speed
(braket
)braket
op_assign
(brace
l_int|100
comma
l_int|80
comma
l_int|67
comma
l_int|57
comma
l_int|50
comma
l_int|40
comma
l_int|31
comma
l_int|20
)brace
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,30)
DECL|variable|DC390_proc_scsi_tmscsim
r_struct
id|proc_dir_entry
id|DC390_proc_scsi_tmscsim
op_assign
initialization_block
suffix:semicolon
macro_line|#endif
multiline_comment|/***********************************************************************&n; * Functions for access to DC390 EEPROM&n; * and some to emulate it&n; *&n; **********************************************************************/
DECL|function|dc390_EnDisableCE
r_static
r_void
id|__init
id|dc390_EnDisableCE
c_func
(paren
id|UCHAR
id|mode
comma
id|PDEVDECL
comma
id|PUCHAR
id|regval
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|ENABLE_CE
)paren
(brace
op_star
id|regval
op_assign
l_int|0xc0
suffix:semicolon
)brace
r_else
op_star
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|DISABLE_CE
)paren
(brace
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
multiline_comment|/* Override EEprom values with explicitly set values */
DECL|function|dc390_EEprom_Override
r_static
r_void
id|__init
id|dc390_EEprom_Override
(paren
id|UCHAR
id|index
)paren
(brace
id|PUCHAR
id|ptr
suffix:semicolon
id|UCHAR
id|id
suffix:semicolon
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|dc390_eepromBuf
(braket
id|index
)braket
suffix:semicolon
multiline_comment|/* Adapter Settings */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_ADAPT_SCSI_ID
)braket
op_assign
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Adapter ID */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|3
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_MODE2
)braket
op_assign
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|5
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_DELAY
)braket
op_assign
id|tmscsim
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Reset delay */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|4
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_TAG_CMD_NUM
)braket
op_assign
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Tagged Cmds */
multiline_comment|/* Device Settings */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|MAX_SCSI_ID
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|2
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|id
op_lshift
l_int|2
)braket
op_assign
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* EE_MODE1 */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|1
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
(paren
id|id
op_lshift
l_int|2
)paren
op_plus
l_int|1
)braket
op_assign
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* EE_Speed */
)brace
suffix:semicolon
)brace
multiline_comment|/* Handle &quot;-1&quot; case */
DECL|function|dc390_check_for_safe_settings
r_static
r_void
id|__init
id|dc390_check_for_safe_settings
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
op_logical_or
id|tmscsim
(braket
l_int|0
)braket
OG
l_int|15
)paren
multiline_comment|/* modules-2.0.0 passes -1 as string */
(brace
id|tmscsim
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
id|tmscsim
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|tmscsim
(braket
l_int|2
)braket
op_assign
l_int|0x09
suffix:semicolon
id|tmscsim
(braket
l_int|3
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|tmscsim
(braket
l_int|4
)braket
op_assign
l_int|2
suffix:semicolon
id|tmscsim
(braket
l_int|5
)braket
op_assign
l_int|10
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Using safe settings.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifndef CONFIG_SCSI_DC390T_NOGENSUPP
DECL|variable|tmscsim_def
r_int
id|__initdata
id|tmscsim_def
(braket
)braket
op_assign
(brace
l_int|7
comma
l_int|0
multiline_comment|/* 10MHz */
comma
id|PARITY_CHK_
op_or
id|SEND_START_
op_or
id|EN_DISCONNECT_
op_or
id|SYNC_NEGO_
op_or
id|TAG_QUEUEING_
comma
id|MORE2_DRV
op_or
id|GREATER_1G
op_or
id|RST_SCSI_BUS
op_or
id|ACTIVE_NEGATION
multiline_comment|/* | NO_SEEK */
macro_line|# ifdef CONFIG_SCSI_MULTI_LUN
op_or
id|LUN_CHECK
macro_line|# endif
comma
l_int|3
multiline_comment|/* 16 Tags per LUN */
comma
l_int|1
multiline_comment|/* s delay after Reset */
)brace
suffix:semicolon
multiline_comment|/* Copy defaults over set values where missing */
DECL|function|dc390_fill_with_defaults
r_static
r_void
id|__init
id|dc390_fill_with_defaults
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|PARSEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: setup %08x %08x %08x %08x %08x %08x&bslash;n&quot;
comma
id|tmscsim
(braket
l_int|0
)braket
comma
"&bslash;"
id|tmscsim
(braket
l_int|1
)braket
comma
id|tmscsim
(braket
l_int|2
)braket
comma
id|tmscsim
(braket
l_int|3
)braket
comma
id|tmscsim
(braket
l_int|4
)braket
comma
id|tmscsim
(braket
l_int|5
)braket
)paren
suffix:semicolon
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
id|i
)braket
template_param
l_int|255
)paren
id|tmscsim
(braket
id|i
)braket
op_assign
id|tmscsim_def
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
OG
l_int|7
)paren
id|tmscsim
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|1
)braket
OG
l_int|7
)paren
id|tmscsim
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|4
)braket
OG
l_int|5
)paren
id|tmscsim
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|5
)braket
OG
l_int|180
)paren
id|tmscsim
(braket
l_int|5
)braket
op_assign
l_int|180
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Override defaults on cmdline:&n; * tmscsim: AdaptID, MaxSpeed (Index), DevMode (Bitmapped), AdaptMode (Bitmapped)&n; */
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,13)
DECL|function|dc390_setup
r_void
id|__init
id|dc390_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|i
comma
id|im
suffix:semicolon
(paren
r_void
)paren
id|get_options
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
macro_line|#else
r_void
id|__init
id|dc390_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
comma
id|im
suffix:semicolon
macro_line|#endif
id|im
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|im
OG
l_int|6
)paren
(brace
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;DC390: ignore extra params!&bslash;n&quot;
)paren
suffix:semicolon
id|im
op_assign
l_int|6
suffix:semicolon
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|im
suffix:semicolon
id|i
op_increment
)paren
id|tmscsim
(braket
id|i
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* dc390_checkparams (); */
)brace
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,13)
macro_line|#ifndef MODULE
id|__setup
c_func
(paren
l_string|&quot;tmscsim=&quot;
comma
id|dc390_setup
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
DECL|function|dc390_EEpromOutDI
r_static
r_void
id|__init
id|dc390_EEpromOutDI
c_func
(paren
id|PDEVDECL
comma
id|PUCHAR
id|regval
comma
id|UCHAR
id|Carry
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|Carry
)paren
(brace
id|bval
op_assign
l_int|0x40
suffix:semicolon
op_star
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|bval
op_or_assign
l_int|0x80
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
DECL|function|dc390_EEpromInDO
r_static
id|UCHAR
id|__init
id|dc390_EEpromInDO
c_func
(paren
id|PDEVDECL
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
l_int|0x80
comma
l_int|0x40
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|PCI_READ_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
l_int|0x00
comma
op_amp
id|bval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_eq
l_int|0x22
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dc390_EEpromGetData1
r_static
id|USHORT
id|__init
id|dc390_EEpromGetData1
c_func
(paren
id|PDEVDECL
)paren
(brace
id|UCHAR
id|i
suffix:semicolon
id|UCHAR
id|carryFlag
suffix:semicolon
id|USHORT
id|wval
suffix:semicolon
id|wval
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|wval
op_lshift_assign
l_int|1
suffix:semicolon
id|carryFlag
op_assign
id|dc390_EEpromInDO
c_func
(paren
id|PDEV
)paren
suffix:semicolon
id|wval
op_or_assign
id|carryFlag
suffix:semicolon
)brace
r_return
id|wval
suffix:semicolon
)brace
DECL|function|dc390_Prepare
r_static
r_void
id|__init
id|dc390_Prepare
c_func
(paren
id|PDEVDECL
comma
id|PUCHAR
id|regval
comma
id|UCHAR
id|EEpromCmd
)paren
(brace
id|UCHAR
id|i
comma
id|j
suffix:semicolon
id|UCHAR
id|carryFlag
suffix:semicolon
id|carryFlag
op_assign
l_int|1
suffix:semicolon
id|j
op_assign
l_int|0x80
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dc390_EEpromOutDI
c_func
(paren
id|PDEV
comma
id|regval
comma
id|carryFlag
)paren
suffix:semicolon
id|carryFlag
op_assign
(paren
id|EEpromCmd
op_amp
id|j
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|j
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|dc390_ReadEEprom
r_static
r_void
id|__init
id|dc390_ReadEEprom
c_func
(paren
id|PDEVDECL
comma
id|PUSHORT
id|ptr
)paren
(brace
id|UCHAR
id|regval
comma
id|cmd
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|cmd
op_assign
id|EEPROM_READ
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dc390_EnDisableCE
c_func
(paren
id|ENABLE_CE
comma
id|PDEV
comma
op_amp
id|regval
)paren
suffix:semicolon
id|dc390_Prepare
c_func
(paren
id|PDEV
comma
op_amp
id|regval
comma
id|cmd
op_increment
)paren
suffix:semicolon
op_star
id|ptr
op_increment
op_assign
id|dc390_EEpromGetData1
c_func
(paren
id|PDEV
)paren
suffix:semicolon
id|dc390_EnDisableCE
c_func
(paren
id|DISABLE_CE
comma
id|PDEV
comma
op_amp
id|regval
)paren
suffix:semicolon
)brace
)brace
DECL|function|dc390_interpret_delay
r_static
r_void
id|__init
id|dc390_interpret_delay
(paren
id|UCHAR
id|index
)paren
(brace
r_char
id|interpd
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|3
comma
l_int|5
comma
l_int|10
comma
l_int|16
comma
l_int|30
comma
l_int|60
comma
l_int|120
)brace
suffix:semicolon
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_DELAY
)braket
op_assign
id|interpd
(braket
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_DELAY
)braket
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dc390_CheckEEpromCheckSum
r_static
id|UCHAR
id|__init
id|dc390_CheckEEpromCheckSum
c_func
(paren
id|PDEVDECL
comma
id|UCHAR
id|index
)paren
(brace
id|UCHAR
id|i
suffix:semicolon
r_char
id|EEbuf
(braket
l_int|128
)braket
suffix:semicolon
id|USHORT
id|wval
comma
op_star
id|ptr
op_assign
(paren
id|PUSHORT
)paren
id|EEbuf
suffix:semicolon
id|dc390_ReadEEprom
c_func
(paren
id|PDEV
comma
id|ptr
)paren
suffix:semicolon
id|memcpy
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
comma
id|EEbuf
comma
id|EE_ADAPT_SCSI_ID
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
comma
op_amp
id|EEbuf
(braket
id|REAL_EE_ADAPT_SCSI_ID
)braket
comma
id|EE_LEN
op_minus
id|EE_ADAPT_SCSI_ID
)paren
suffix:semicolon
id|dc390_interpret_delay
(paren
id|index
)paren
suffix:semicolon
id|wval
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
comma
id|ptr
op_increment
)paren
(brace
id|wval
op_add_assign
op_star
id|ptr
suffix:semicolon
)brace
r_return
(paren
id|wval
op_eq
l_int|0x1234
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Functions for the management of the internal structures &n; * (DCBs, SRBs, Queueing)&n; *&n; **********************************************************************/
DECL|function|dc390_findDCB
r_static
id|PDCB
id|__inline__
id|dc390_findDCB
(paren
id|PACB
id|pACB
comma
id|UCHAR
id|id
comma
id|UCHAR
id|lun
)paren
(brace
id|PDCB
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pDCB-&gt;TargetID
op_ne
id|id
op_logical_or
id|pDCB-&gt;TargetLUN
op_ne
id|lun
)paren
(brace
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
(brace
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: DCB not found (DCB=%p, DCBmap[%2x]=%2x)&bslash;n&quot;
comma
id|pDCB
comma
id|id
comma
id|pACB-&gt;DCBmap
(braket
id|id
)braket
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
suffix:semicolon
id|DCBDEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DCB %p (%02x,%02x) found.&bslash;n&quot;
comma
"&bslash;"
id|pDCB
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
)paren
r_return
id|pDCB
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Queueing philosphy:&n; * There are a couple of lists:&n; * - Query: Contains the Scsi Commands not yet turned into SRBs (per ACB)&n; *   (Note: For new EH, it is unecessary!)&n; * - Waiting: Contains a list of SRBs not yet sent (per DCB)&n; * - Free: List of free SRB slots&n; * &n; * If there are no waiting commands for the DCB, the new one is sent to the bus&n; * otherwise the oldest one is taken from the Waiting list and the new one is &n; * queued to the Waiting List&n; * &n; * Lists are managed using two pointers and eventually a counter&n; */
macro_line|#if 0
multiline_comment|/* Look for a SCSI cmd in a SRB queue */
r_static
id|PSRB
id|dc390_find_cmd_in_SRBq
(paren
id|PSCSICMD
id|cmd
comma
id|PSRB
id|queue
)paren
(brace
id|PSRB
id|q
op_assign
id|queue
suffix:semicolon
r_while
c_loop
(paren
id|q
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;pcmd
op_eq
id|cmd
)paren
r_return
id|q
suffix:semicolon
id|q
op_assign
id|q-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
id|queue
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|q
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Append to Query List */
DECL|function|dc390_Query_append
r_static
r_void
id|dc390_Query_append
c_func
(paren
id|PSCSICMD
id|cmd
comma
id|PACB
id|pACB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Append cmd %li to Query&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;QueryCnt
)paren
(brace
id|pACB-&gt;pQueryHead
op_assign
id|cmd
suffix:semicolon
)brace
r_else
id|pACB-&gt;pQueryTail-&gt;next
op_assign
id|cmd
suffix:semicolon
id|pACB-&gt;pQueryTail
op_assign
id|cmd
suffix:semicolon
id|pACB-&gt;QueryCnt
op_increment
suffix:semicolon
id|pACB-&gt;CmdOutOfSRB
op_increment
suffix:semicolon
id|cmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Return next cmd from Query list */
DECL|function|dc390_Query_get
r_static
id|PSCSICMD
id|dc390_Query_get
(paren
id|PACB
id|pACB
)paren
(brace
id|PSCSICMD
id|pcmd
suffix:semicolon
id|pcmd
op_assign
id|pACB-&gt;pQueryHead
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmd
)paren
r_return
id|pcmd
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Get cmd %li from Query&bslash;n&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|pACB-&gt;pQueryHead
op_assign
id|pcmd-&gt;next
suffix:semicolon
id|pcmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;pQueryHead
)paren
id|pACB-&gt;pQueryTail
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;QueryCnt
op_decrement
suffix:semicolon
r_return
id|pcmd
suffix:semicolon
)brace
multiline_comment|/* Return next free SRB */
DECL|function|dc390_Free_get
r_static
id|__inline__
id|PSRB
id|dc390_Free_get
(paren
id|PACB
id|pACB
)paren
(brace
id|PSRB
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Get Free SRB %p&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Insert SRB oin top of free list */
DECL|function|dc390_Free_insert
r_static
id|__inline__
r_void
id|dc390_Free_insert
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Free SRB %p&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
id|pSRB-&gt;pNextSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Inserts a SRB to the top of the Waiting list */
DECL|function|dc390_Waiting_insert
r_static
id|__inline__
r_void
id|dc390_Waiting_insert
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Insert pSRB %p cmd %li to Waiting&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|pSRB-&gt;pNextSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_increment
suffix:semicolon
)brace
multiline_comment|/* Queue SRB to waiting list */
DECL|function|dc390_Waiting_append
r_static
id|__inline__
r_void
id|dc390_Waiting_append
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Append pSRB %p cmd %li to Waiting&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pDCB-&gt;pWaitLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_increment
suffix:semicolon
id|pDCB-&gt;pDCBACB-&gt;CmdInQ
op_increment
suffix:semicolon
)brace
DECL|function|dc390_Going_append
r_static
id|__inline__
r_void
id|dc390_Going_append
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|pDCB-&gt;GoingSRBCnt
op_increment
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Append SRB %p to Going&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
multiline_comment|/* Append to the list of Going commands */
r_if
c_cond
(paren
id|pDCB-&gt;pGoingSRB
)paren
(brace
id|pDCB-&gt;pGoingLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
multiline_comment|/* No next one in sent list */
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dc390_Going_remove
r_static
id|__inline__
r_void
id|dc390_Going_remove
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Remove SRB %p from Going&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingSRB
)paren
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_else
(brace
id|PSRB
id|psrb
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_while
c_loop
(paren
id|psrb
op_logical_and
id|psrb-&gt;pNextSRB
op_ne
id|pSRB
)paren
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psrb
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Remove non-ex. SRB %p from Going!&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|psrb-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingLast
)paren
id|pDCB-&gt;pGoingLast
op_assign
id|psrb
suffix:semicolon
)brace
id|pDCB-&gt;GoingSRBCnt
op_decrement
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Moves SRB from Going list to the top of Waiting list */
DECL|function|dc390_Going_to_Waiting
r_static
r_void
id|dc390_Going_to_Waiting
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Going_to_Waiting (SRB %p) pid = %li&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
multiline_comment|/* Remove SRB from Going */
id|dc390_Going_remove
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Insert on top of Waiting */
id|dc390_Waiting_insert
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Tag Mask must be freed elsewhere ! (KG, 99/06/18) */
)brace
multiline_comment|/* Moves first SRB from Waiting list to Going list */
DECL|function|dc390_Waiting_to_Going
r_static
id|__inline__
r_void
id|dc390_Waiting_to_Going
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
multiline_comment|/* Remove from waiting list */
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Remove SRB %p from head of Waiting&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pDCB-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pDCB-&gt;WaitSRBCnt
op_decrement
suffix:semicolon
id|dc390_Going_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
multiline_comment|/* 2.0 timer compatibility */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,30)
DECL|function|timer_pending
r_static
r_inline
r_int
id|timer_pending
c_func
(paren
r_struct
id|timer_list
op_star
id|timer
)paren
(brace
r_return
id|timer-&gt;prev
op_ne
l_int|NULL
suffix:semicolon
)brace
DECL|macro|time_after
mdefine_line|#define time_after(a,b)         ((long)(b) - (long)(a) &lt; 0)
DECL|macro|time_before
mdefine_line|#define time_before(a,b)        time_after(b,a)
macro_line|#endif
r_void
id|DC390_waiting_timed_out
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Sets the timer to wake us up */
DECL|function|dc390_waiting_timer
r_static
r_void
id|dc390_waiting_timer
(paren
id|PACB
id|pACB
comma
r_int
r_int
id|to
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
r_return
suffix:semicolon
id|init_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|pACB-&gt;Waiting_Timer.function
op_assign
id|DC390_waiting_timed_out
suffix:semicolon
id|pACB-&gt;Waiting_Timer.data
op_assign
(paren
r_int
r_int
)paren
id|pACB
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
op_plus
id|to
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
)paren
)paren
id|pACB-&gt;Waiting_Timer.expires
op_assign
id|pACB-&gt;pScsiHost-&gt;last_reset
op_plus
l_int|1
suffix:semicolon
r_else
id|pACB-&gt;Waiting_Timer.expires
op_assign
id|jiffies
op_plus
id|to
op_plus
l_int|1
suffix:semicolon
id|add_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Send the next command from the waiting list to the bus */
DECL|function|dc390_Waiting_process
r_static
r_void
id|dc390_Waiting_process
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|ptr
comma
id|ptr1
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|ptr
op_assign
id|pACB-&gt;pDCBRunRobin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
id|ptr
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr
suffix:semicolon
)brace
id|ptr1
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr1
)paren
r_return
suffix:semicolon
r_do
(brace
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB
op_assign
id|ptr1-&gt;pWaitingSRB
)paren
op_logical_or
(paren
id|ptr1-&gt;MaxCommand
op_le
id|ptr1-&gt;GoingSRBCnt
)paren
)paren
(brace
id|ptr1
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Try to send to the bus */
r_if
c_cond
(paren
op_logical_neg
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|ptr1
comma
id|pSRB
)paren
)paren
(brace
id|dc390_Waiting_to_Going
(paren
id|ptr1
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ptr1
op_ne
id|ptr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Wake up waiting queue */
DECL|function|DC390_waiting_timed_out
r_void
id|DC390_waiting_timed_out
(paren
r_int
r_int
id|ptr
)paren
(brace
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
id|ptr
suffix:semicolon
id|DC390_IFLAGS
id|DC390_AFLAGS
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Debug: Waiting queue woken up by timer!&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DC390_LOCK_IO
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function: static void dc390_SendSRB (PACB pACB, PSRB pSRB)&n; *&n; * Purpose: Send SCSI Request Block (pSRB) to adapter (pACB)&n; *&n; ***********************************************************************/
DECL|function|dc390_SendSRB
r_static
r_void
id|dc390_SendSRB
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|PDCB
id|pDCB
suffix:semicolon
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;MaxCommand
op_le
id|pDCB-&gt;GoingSRBCnt
)paren
op_logical_or
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
id|dc390_Waiting_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|dc390_Waiting_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*&t;pSRB = GetWaitingSRB(pDCB); */
multiline_comment|/* non-existent */
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
multiline_comment|/* Remove from waiting list */
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
id|dc390_Going_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_else
(brace
id|dc390_Waiting_insert
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function: static void dc390_BuildSRB (Scsi_Cmd *pcmd, PDCB pDCB, &n; * &t;&t;&t;&t;&t; PSRB pSRB)&n; *&n; * Purpose: Prepare SRB for being sent to Device DCB w/ command *pcmd&n; *&n; ***********************************************************************/
DECL|function|dc390_BuildSRB
r_static
r_void
id|dc390_BuildSRB
(paren
id|Scsi_Cmnd
op_star
id|pcmd
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|pSRB-&gt;pSRBDCB
op_assign
id|pDCB
suffix:semicolon
id|pSRB-&gt;pcmd
op_assign
id|pcmd
suffix:semicolon
singleline_comment|//pSRB-&gt;ScsiCmdLen = pcmd-&gt;cmd_len;
singleline_comment|//memcpy (pSRB-&gt;CmdBlock, pcmd-&gt;cmnd, pcmd-&gt;cmd_len);
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
(paren
id|UCHAR
)paren
id|pcmd-&gt;use_sg
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevType
op_ne
id|TYPE_TAPE
)paren
(brace
id|pSRB-&gt;RetryCnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pSRB-&gt;RetryCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;EndMessage
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TagNumber
op_assign
l_int|255
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Put cmnd from Query to Waiting list and send next Waiting cmnd */
DECL|function|dc390_Query_to_Waiting
r_static
r_void
id|dc390_Query_to_Waiting
(paren
id|PACB
id|pACB
)paren
(brace
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|PDCB
id|pDCB
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pACB-&gt;QueryCnt
)paren
(brace
id|pSRB
op_assign
id|dc390_Free_get
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
r_return
suffix:semicolon
id|pcmd
op_assign
id|dc390_Query_get
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmd
)paren
(brace
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* should not happen */
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|pcmd-&gt;target
comma
id|pcmd-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Command in queue to non-existing device!&bslash;n&quot;
)paren
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
id|DRIVER_ERROR
comma
id|DID_ERROR
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB_NI
suffix:semicolon
id|pcmd-&gt;done
(paren
id|pcmd
)paren
suffix:semicolon
id|DC390_LOCK_ACB_NI
suffix:semicolon
)brace
suffix:semicolon
id|dc390_BuildSRB
(paren
id|pcmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Waiting_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC390_queue_command (Scsi_Cmnd *cmd,&n; *&t;&t;&t;&t;&t;       void (*done)(Scsi_Cmnd *))&n; *&n; * Purpose : enqueues a SCSI command&n; *&n; * Inputs : cmd - SCSI command, done - callback function called on &n; *&t;    completion, with a pointer to the command descriptor.&n; *&n; * Returns : (depending on kernel version)&n; * 2.0.x: always return 0&n; * 2.1.x: old model: (use_new_eh_code == 0): like 2.0.x&n; *&t;  TO BE DONE:&n; *&t;  new model: return 0 if successful&n; *&t;  &t;     return 1 if command cannot be queued (queue full)&n; *&t;&t;     command will be inserted in midlevel queue then ...&n; *&n; ***********************************************************************/
DECL|function|DC390_queue_command
r_int
id|DC390_queue_command
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|PDCB
id|pDCB
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|DC390_AFLAGS
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|DEBUG0
c_func
(paren
multiline_comment|/*  if(pACB-&gt;scan_devices) */
"&bslash;"
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Queue Cmd=%02x,Tgt=%d,LUN=%d (pid=%li)&bslash;n&quot;
comma
"&bslash;"
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
id|DC390_LOCK_ACB
suffix:semicolon
multiline_comment|/* Assume BAD_TARGET; will be cleared later */
id|cmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* TODO: Change the policy: Alway accept TEST_UNIT_READY or INQUIRY &n;     * commands and alloc a DCB for the device if not yet there. DCB will&n;     * be removed in dc390_SRBdone if SEL_TIMEOUT */
r_if
c_cond
(paren
(paren
id|pACB-&gt;scan_devices
op_eq
id|END_SCAN
)paren
op_logical_and
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|INQUIRY
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pACB-&gt;scan_devices
)paren
op_logical_and
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cmd-&gt;target
op_ge
id|pACB-&gt;pScsiHost-&gt;max_id
)paren
op_logical_or
(paren
id|cmd-&gt;lun
op_ge
id|pACB-&gt;pScsiHost-&gt;max_lun
)paren
)paren
(brace
multiline_comment|/*&t;printk (&quot;DC390: Ignore target %d lun %d&bslash;n&quot;,&n;&t;&t;cmd-&gt;target, cmd-&gt;lun); */
id|DC390_UNLOCK_ACB
suffix:semicolon
singleline_comment|//return (1);
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pACB-&gt;scan_devices
op_logical_or
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
op_logical_or
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
op_logical_neg
(paren
id|pACB-&gt;DCBmap
(braket
id|cmd-&gt;target
)braket
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|dc390_initDCB
c_func
(paren
id|pACB
comma
op_amp
id|pDCB
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: kmalloc for DCB failed, target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: No DCB in queue_command!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef USE_NEW_EH
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;scan_devices
)paren
op_logical_and
op_logical_neg
(paren
id|pACB-&gt;DCBmap
(braket
id|cmd-&gt;target
)braket
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Ignore target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
singleline_comment|//return (1);
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
multiline_comment|/* should never happen */
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: no DCB failed, target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: No DCB in queuecommand (2)!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef USE_NEW_EH
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
)brace
id|pACB-&gt;Cmds
op_increment
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|dc390_Query_to_Waiting
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;QueryCnt
)paren
multiline_comment|/* Unsent commands ? */
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: QueryCnt != 0&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|dc390_Query_append
(paren
id|cmd
comma
id|pACB
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pSRB
op_assign
id|dc390_Free_get
(paren
id|pACB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
r_if
(paren
op_logical_neg
id|pSRB
)paren
id|printk
(paren
l_string|&quot;DC390: No free SRB but Waiting&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;DC390: Free SRB w/ Waiting&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
id|dc390_Query_append
(paren
id|cmd
comma
id|pACB
)paren
suffix:semicolon
r_else
(brace
id|dc390_BuildSRB
(paren
id|cmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Waiting_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
id|pSRB
op_assign
id|dc390_Free_get
(paren
id|pACB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
r_if
(paren
op_logical_neg
id|pSRB
)paren
id|printk
(paren
l_string|&quot;DC390: No free SRB w/o Waiting&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;DC390: Free SRB w/o Waiting&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
id|dc390_Query_append
(paren
id|cmd
comma
id|pACB
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
id|dc390_BuildSRB
(paren
id|cmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_SendSRB
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; ... command (pid %li) queued successfully.&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We ignore mapping problems, as we expect everybody to respect &n; * valid partition tables. Waiting for complaints ;-) */
macro_line|#ifdef CONFIG_SCSI_DC390T_TRADMAP
multiline_comment|/* &n; * The next function, partsize(), is copied from scsicam.c.&n; *&n; * This is ugly code duplication, but I didn&squot;t find another way to solve it:&n; * We want to respect the partition table and if it fails, we apply the &n; * DC390 BIOS heuristic. Too bad, just calling scsicam_bios_param() doesn&squot;t do&n; * the job, because we don&squot;t know, whether the values returned are from&n; * the part. table or determined by setsize(). Unfortunately the setsize() &n; * values differ from the ones chosen by the DC390 BIOS.&n; *&n; * Looking forward to seeing suggestions for a better solution! KG, 98/10/14&n; */
macro_line|#include &lt;asm/unaligned.h&gt;
multiline_comment|/*&n; * Function : static int partsize(struct buffer_head *bh, unsigned long &n; *     capacity,unsigned int *cyls, unsigned int *hds, unsigned int *secs);&n; *&n; * Purpose : to determine the BIOS mapping used to create the partition&n; *&t;table, storing the results in *cyls, *hds, and *secs &n; *&n; * Returns : -1 on failure, 0 on success.&n; *&n; */
DECL|function|partsize
r_static
r_int
id|partsize
c_func
(paren
r_struct
id|buffer_head
op_star
id|bh
comma
r_int
r_int
id|capacity
comma
r_int
r_int
op_star
id|cyls
comma
r_int
r_int
op_star
id|hds
comma
r_int
r_int
op_star
id|secs
)paren
(brace
r_struct
id|partition
op_star
id|p
comma
op_star
id|largest
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|largest_cyl
suffix:semicolon
r_int
id|cyl
comma
id|ext_cyl
comma
id|end_head
comma
id|end_cyl
comma
id|end_sector
suffix:semicolon
r_int
r_int
id|logical_end
comma
id|physical_end
comma
id|ext_physical_end
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|bh-&gt;b_data
op_plus
l_int|510
)paren
op_eq
l_int|0xAA55
)paren
(brace
r_for
c_loop
(paren
id|largest_cyl
op_assign
op_minus
l_int|1
comma
id|p
op_assign
(paren
r_struct
id|partition
op_star
)paren
(paren
l_int|0x1BE
op_plus
id|bh-&gt;b_data
)paren
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
op_increment
id|i
comma
op_increment
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;sys_ind
)paren
r_continue
suffix:semicolon
id|cyl
op_assign
id|p-&gt;cyl
op_plus
(paren
(paren
id|p-&gt;sector
op_amp
l_int|0xc0
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cyl
OG
id|largest_cyl
)paren
(brace
id|largest_cyl
op_assign
id|cyl
suffix:semicolon
id|largest
op_assign
id|p
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|largest
)paren
(brace
id|end_cyl
op_assign
id|largest-&gt;end_cyl
op_plus
(paren
(paren
id|largest-&gt;end_sector
op_amp
l_int|0xc0
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|end_head
op_assign
id|largest-&gt;end_head
suffix:semicolon
id|end_sector
op_assign
id|largest-&gt;end_sector
op_amp
l_int|0x3f
suffix:semicolon
id|physical_end
op_assign
id|end_cyl
op_star
(paren
id|end_head
op_plus
l_int|1
)paren
op_star
id|end_sector
op_plus
id|end_head
op_star
id|end_sector
op_plus
id|end_sector
suffix:semicolon
multiline_comment|/* This is the actual _sector_ number at the end */
id|logical_end
op_assign
id|get_unaligned
c_func
(paren
op_amp
id|largest-&gt;start_sect
)paren
op_plus
id|get_unaligned
c_func
(paren
op_amp
id|largest-&gt;nr_sects
)paren
suffix:semicolon
multiline_comment|/* This is for &gt;1023 cylinders */
id|ext_cyl
op_assign
(paren
id|logical_end
op_minus
(paren
id|end_head
op_star
id|end_sector
op_plus
id|end_sector
)paren
)paren
op_div
(paren
id|end_head
op_plus
l_int|1
)paren
op_div
id|end_sector
suffix:semicolon
id|ext_physical_end
op_assign
id|ext_cyl
op_star
(paren
id|end_head
op_plus
l_int|1
)paren
op_star
id|end_sector
op_plus
id|end_head
op_star
id|end_sector
op_plus
id|end_sector
suffix:semicolon
r_if
c_cond
(paren
(paren
id|logical_end
op_eq
id|physical_end
)paren
op_logical_or
(paren
id|end_cyl
op_eq
l_int|1023
op_logical_and
id|ext_physical_end
op_eq
id|logical_end
)paren
)paren
(brace
op_star
id|secs
op_assign
id|end_sector
suffix:semicolon
op_star
id|hds
op_assign
id|end_head
op_plus
l_int|1
suffix:semicolon
op_star
id|cyls
op_assign
id|capacity
op_div
(paren
(paren
id|end_head
op_plus
l_int|1
)paren
op_star
id|end_sector
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function:&n; *   DC390_bios_param&n; *&n; * Description:&n; *   Return the disk geometry for the given SCSI device.&n; *   Respect the partition table, otherwise try own heuristic&n; *&n; * Note:&n; *   In contrary to other externally callable funcs (DC390_), we don&squot;t lock&n; ***********************************************************************/
DECL|function|DC390_bios_param
r_int
id|DC390_bios_param
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|devno
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|ret_code
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bh
op_assign
id|bread
c_func
(paren
id|MKDEV
c_func
(paren
id|MAJOR
c_func
(paren
id|devno
)paren
comma
id|MINOR
c_func
(paren
id|devno
)paren
op_amp
op_complement
l_int|0xf
)paren
comma
l_int|0
comma
l_int|1024
)paren
)paren
)paren
(brace
multiline_comment|/* try to infer mapping from partition table */
id|ret_code
op_assign
id|partsize
(paren
id|bh
comma
(paren
r_int
r_int
)paren
id|size
comma
(paren
r_int
r_int
op_star
)paren
id|geom
op_plus
l_int|2
comma
(paren
r_int
r_int
op_star
)paren
id|geom
op_plus
l_int|0
comma
(paren
r_int
r_int
op_star
)paren
id|geom
op_plus
l_int|1
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret_code
op_eq
op_minus
l_int|1
)paren
(brace
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|size
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pACB-&gt;Gmode2
op_amp
id|GREATER_1G
)paren
op_logical_and
(paren
id|cylinders
OG
l_int|1024
)paren
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|size
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|DC390_bios_param
r_int
id|DC390_bios_param
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|devno
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_return
id|scsicam_bios_param
(paren
id|disk
comma
id|devno
comma
id|geom
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
DECL|function|dc390_dumpinfo
r_void
id|dc390_dumpinfo
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|USHORT
id|pstat
suffix:semicolon
id|PDEVDECL1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_and
id|pDCB
)paren
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: SRB: Xferred %08lx, Remain %08lx, State %08x, Phase %02x&bslash;n&quot;
comma
id|pSRB-&gt;TotalXferredLen
comma
id|pSRB-&gt;SGToBeXferLen
comma
id|pSRB-&gt;SRBState
comma
id|pSRB-&gt;ScsiPhase
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: AdpaterStatus: %02x, SRB Status %02x&bslash;n&quot;
comma
id|pSRB-&gt;AdaptStatus
comma
id|pSRB-&gt;SRBStatus
)paren
suffix:semicolon
)brace
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Status of last IRQ (DMA/SC/Int/IRQ): %08x&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: SCSI block:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: XferCnt  Cmd Stat IntS IRQS FFIS Ctl1 Ctl2 Ctl3 Ctl4&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390:  %06x   %02x   %02x   %02x&quot;
comma
id|DC390_read8
c_func
(paren
id|CtcReg_Low
)paren
op_plus
(paren
id|DC390_read8
c_func
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|DC390_read8
c_func
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
)paren
comma
id|DC390_read8
c_func
(paren
id|ScsiCmd
)paren
comma
id|DC390_read8
c_func
(paren
id|Scsi_Status
)paren
comma
id|DC390_read8
c_func
(paren
id|Intern_State
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;   %02x   %02x   %02x   %02x   %02x   %02x&bslash;n&quot;
comma
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
comma
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg2
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg3
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg4
)paren
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|WRT_ERASE_DMA_STAT
op_or
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: FIFO:&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|DC390_read8
c_func
(paren
id|ScsiFifo
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: DMA engine:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Cmd   STrCnt    SBusA    WrkBC    WrkAC Stat SBusCtrl&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390:  %02x %08x %08x %08x %08x   %02x %08x&bslash;n&quot;
comma
id|DC390_read8
c_func
(paren
id|DMA_Cmd
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_XferCnt
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_XferAddr
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_Wk_ByteCntr
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_Wk_AddrCntr
)paren
comma
id|DC390_read8
c_func
(paren
id|DMA_Status
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_ScsiBusCtrl
)paren
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
id|PDEVSET1
suffix:semicolon
id|PCI_READ_CONFIG_WORD
c_func
(paren
id|PDEV
comma
id|PCI_STATUS
comma
op_amp
id|pstat
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: PCI Status: %04x&bslash;n&quot;
comma
id|pstat
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: In case of driver trouble read linux/drivers/scsi/README.tmscsim&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Function : int DC390_abort (Scsi_Cmnd *cmd)&n; *&n; * Purpose : Abort an errant SCSI command&n; *&n; * Inputs : cmd - command to abort&n; *&n; * Returns : 0 on success, -1 on failure.&n; *&n; * Status: Buggy !&n; ***********************************************************************/
DECL|function|DC390_abort
r_int
id|DC390_abort
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|PDCB
id|pDCB
suffix:semicolon
id|PSRB
id|pSRB
comma
id|psrb
suffix:semicolon
id|UINT
id|count
comma
id|i
suffix:semicolon
id|PSCSICMD
id|pcmd
suffix:semicolon
r_int
id|status
suffix:semicolon
singleline_comment|//ULONG sbac;
id|DC390_AFLAGS
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Abort command (pid %li, Device %02i-%02i)&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
multiline_comment|/* First scan Query list */
r_if
c_cond
(paren
id|pACB-&gt;QueryCnt
)paren
(brace
id|pcmd
op_assign
id|pACB-&gt;pQueryHead
suffix:semicolon
r_if
c_cond
(paren
id|pcmd
op_eq
id|cmd
)paren
(brace
multiline_comment|/* Found: Dequeue */
id|pACB-&gt;pQueryHead
op_assign
id|pcmd-&gt;next
suffix:semicolon
id|pcmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|pACB-&gt;pQueryTail
)paren
id|pACB-&gt;pQueryTail
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;QueryCnt
op_decrement
suffix:semicolon
id|status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
r_for
c_loop
(paren
id|count
op_assign
id|pACB-&gt;QueryCnt
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pcmd-&gt;next
op_eq
id|cmd
)paren
(brace
id|pcmd-&gt;next
op_assign
id|cmd-&gt;next
suffix:semicolon
id|cmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|pACB-&gt;pQueryTail
)paren
id|pACB-&gt;pQueryTail
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;QueryCnt
op_decrement
suffix:semicolon
id|status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
r_else
(brace
id|pcmd
op_assign
id|pcmd-&gt;next
suffix:semicolon
)brace
)brace
)brace
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
r_goto
id|NOT_RUN
suffix:semicolon
)brace
multiline_comment|/* Added 98/07/02 KG */
multiline_comment|/*&n;    pSRB = pDCB-&gt;pActiveSRB;&n;    if (pSRB &amp;&amp; pSRB-&gt;pcmd == cmd )&n;&t;goto ON_GOING;&n;     */
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
r_goto
id|ON_GOING
suffix:semicolon
)brace
multiline_comment|/* Now scan Waiting queue */
r_if
c_cond
(paren
id|pSRB-&gt;pcmd
op_eq
id|cmd
)paren
(brace
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_goto
id|IN_WAIT
suffix:semicolon
)brace
r_else
(brace
id|psrb
op_assign
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|psrb-&gt;pNextSRB
)paren
)paren
(brace
r_goto
id|ON_GOING
suffix:semicolon
)brace
r_while
c_loop
(paren
id|psrb-&gt;pNextSRB-&gt;pcmd
op_ne
id|cmd
)paren
(brace
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|psrb-&gt;pNextSRB
)paren
op_logical_or
id|psrb
op_eq
id|pSRB
)paren
(brace
r_goto
id|ON_GOING
suffix:semicolon
)brace
)brace
id|pSRB
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
id|psrb-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pWaitLast
)paren
(brace
id|pDCB-&gt;pWaitLast
op_assign
id|psrb
suffix:semicolon
)brace
id|IN_WAIT
suffix:colon
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_decrement
suffix:semicolon
id|cmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
multiline_comment|/* SRB has already been sent ! */
id|ON_GOING
suffix:colon
multiline_comment|/* abort() is too stupid for already sent commands at the moment. &n;     * If it&squot;s called we are in trouble anyway, so let&squot;s dump some info &n;     * into the syslog at least. (KG, 98/08/20,99/06/20) */
id|dc390_dumpinfo
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
multiline_comment|/* Now for the hard part: The command is currently processed */
r_for
c_loop
(paren
id|count
op_assign
id|pDCB-&gt;GoingSRBCnt
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;pcmd
op_ne
id|cmd
)paren
(brace
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pACB-&gt;pActiveDCB
op_eq
id|pDCB
)paren
op_logical_and
(paren
id|pDCB-&gt;pActiveSRB
op_eq
id|pSRB
)paren
)paren
(brace
id|status
op_assign
id|SCSI_ABORT_BUSY
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Abort current command (pid %li, SRB %p)&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|pSRB
)paren
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
)brace
)brace
id|NOT_RUN
suffix:colon
id|status
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
id|ABO_X
suffix:colon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Aborted pid %li with status %i&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|status
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|cmd-&gt;pid
op_eq
id|dc390_lastabortedpid
)paren
multiline_comment|/* repeated failure ? */
(brace
multiline_comment|/* Let&squot;s do something to help the bus getting clean again */
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|DMA_COMMAND
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (ScsiCmd, CLEAR_FIFO_CMD);
singleline_comment|//DC390_write8 (ScsiCmd, RESET_ATN_CMD);
id|DC390_write8
(paren
id|ScsiCmd
comma
id|NOP_CMD
)paren
suffix:semicolon
singleline_comment|//udelay (10000);
singleline_comment|//DC390_read8 (INT_Status);
singleline_comment|//DC390_write8 (ScsiCmd, EN_SEL_RESEL);
)brace
suffix:semicolon
id|sbac
op_assign
id|DC390_read32
(paren
id|DMA_ScsiBusCtrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbac
op_amp
id|SCSI_BUSY
)paren
(brace
multiline_comment|/* clear BSY, SEL and ATN */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Reset SCSI device: &quot;
)paren
suffix:semicolon
singleline_comment|//DC390_write32 (DMA_ScsiBusCtrl, (sbac | SCAM) &amp; ~SCSI_LINES);
singleline_comment|//udelay (250);
singleline_comment|//sbac = DC390_read32 (DMA_ScsiBusCtrl);
singleline_comment|//printk (&quot;%08lx &quot;, sbac);
singleline_comment|//DC390_write32 (DMA_ScsiBusCtrl, sbac &amp; ~(SCSI_LINES | SCAM));
singleline_comment|//udelay (100);
singleline_comment|//sbac = DC390_read32 (DMA_ScsiBusCtrl);
singleline_comment|//printk (&quot;%08lx &quot;, sbac);
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RST_DEVICE_CMD
)paren
suffix:semicolon
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|NOP_CMD
)paren
suffix:semicolon
id|sbac
op_assign
id|DC390_read32
(paren
id|DMA_ScsiBusCtrl
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%08lx&bslash;n&quot;
comma
id|sbac
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
id|dc390_lastabortedpid
op_assign
id|cmd-&gt;pid
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
singleline_comment|//do_DC390_Interrupt (pACB-&gt;IRQLevel, 0, 0);
macro_line|#ifndef USE_NEW_EH&t;
r_if
c_cond
(paren
id|status
op_eq
id|SCSI_ABORT_SUCCESS
)paren
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
id|status
suffix:semicolon
)brace
DECL|function|dc390_ResetDevParam
r_static
r_void
id|dc390_ResetDevParam
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|pDCB
comma
id|pdcb
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_and_assign
id|NEGATE_REQACKDATA
op_or
id|CTRL4_RESERVED
op_or
id|NEGATE_REQACK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
id|pACB-&gt;ACBFlag
op_and_assign
op_complement
(paren
id|RESET_DEV
op_or
id|RESET_DONE
op_or
id|RESET_DETECT
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Moves all SRBs from Going to Waiting for all DCBs */
r_static
r_void
id|dc390_RecoverSRB
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|pDCB
comma
id|pdcb
suffix:semicolon
id|PSRB
id|psrb
comma
id|psrb2
suffix:semicolon
id|UINT
id|cnt
comma
id|i
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
r_return
suffix:semicolon
)brace
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|cnt
op_assign
id|pdcb-&gt;GoingSRBCnt
suffix:semicolon
id|psrb
op_assign
id|pdcb-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psrb2
op_assign
id|psrb
suffix:semicolon
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
multiline_comment|/*&t;    dc390_RewaitSRB( pDCB, psrb ); */
r_if
c_cond
(paren
id|pdcb-&gt;pWaitingSRB
)paren
(brace
id|psrb2-&gt;pNextSRB
op_assign
id|pdcb-&gt;pWaitingSRB
suffix:semicolon
id|pdcb-&gt;pWaitingSRB
op_assign
id|psrb2
suffix:semicolon
)brace
r_else
(brace
id|pdcb-&gt;pWaitingSRB
op_assign
id|psrb2
suffix:semicolon
id|pdcb-&gt;pWaitLast
op_assign
id|psrb2
suffix:semicolon
id|psrb2-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|pdcb-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pdcb-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pdcb-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pdcb
op_assign
id|pdcb-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/***********************************************************************&n; * Function : int DC390_reset (Scsi_Cmnd *cmd, ...)&n; *&n; * Purpose : perform a hard reset on the SCSI bus&n; *&n; * Inputs : cmd - command which caused the SCSI RESET&n; *&t;    resetFlags - how hard to try&n; *&n; * Returns : 0 on success.&n; ***********************************************************************/
DECL|function|DC390_reset
r_int
id|DC390_reset
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|resetFlags
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|DC390_AFLAGS
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: RESET ... &quot;
)paren
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|bval
op_assign
id|DC390_read8
(paren
id|CtrlReg1
)paren
suffix:semicolon
id|bval
op_or_assign
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* disable IRQ on bus reset */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DEV
suffix:semicolon
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_read8
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|dc390_DoingSRB_Done
c_func
(paren
id|pACB
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* dc390_RecoverSRB (pACB); */
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|bval
op_assign
id|DC390_read8
(paren
id|CtrlReg1
)paren
suffix:semicolon
id|bval
op_and_assign
op_complement
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupt */
id|dc390_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
macro_line|#include &quot;scsiiom.c&quot;
multiline_comment|/***********************************************************************&n; * Function : static void dc390_initDCB()&n; *&n; * Purpose :  initialize the internal structures for a DCB (to be malloced)&n; *&n; * Inputs : SCSI id and lun&n; ***********************************************************************/
DECL|function|dc390_initDCB
r_void
id|dc390_initDCB
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
op_star
id|ppDCB
comma
id|UCHAR
id|id
comma
id|UCHAR
id|lun
)paren
(brace
id|PEEprom
id|prom
suffix:semicolon
id|UCHAR
id|index
suffix:semicolon
id|PDCB
id|pDCB
comma
id|pDCB2
suffix:semicolon
id|pDCB
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|DC390_DCB
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: alloc mem for DCB (ID %i, LUN %i): %p&bslash;n&quot;
"&bslash;"
id|id
comma
id|lun
comma
id|pDCB
)paren
suffix:semicolon
)paren
op_star
id|ppDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;DCBCnt
op_eq
l_int|0
)paren
(brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB
suffix:semicolon
)brace
r_else
(brace
id|pACB-&gt;pLastDCB-&gt;pNextDCB
op_assign
id|pDCB
suffix:semicolon
)brace
suffix:semicolon
id|pACB-&gt;DCBCnt
op_increment
suffix:semicolon
id|pDCB-&gt;pNextDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pDCBACB
op_assign
id|pACB
suffix:semicolon
id|pDCB-&gt;TargetID
op_assign
id|id
suffix:semicolon
id|pDCB-&gt;TargetLUN
op_assign
id|lun
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
id|index
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Is there a corresp. LUN==0 device ? */
r_if
c_cond
(paren
id|lun
op_ne
l_int|0
)paren
id|pDCB2
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|id
comma
l_int|0
)paren
suffix:semicolon
id|prom
op_assign
(paren
id|PEEprom
)paren
op_amp
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|id
op_lshift
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Some values are for all LUNs: Copy them */
multiline_comment|/* In a clean way: We would have an own structure for a SCSI-ID */
r_if
c_cond
(paren
id|pDCB2
)paren
(brace
id|pDCB-&gt;DevMode
op_assign
id|pDCB2-&gt;DevMode
suffix:semicolon
id|pDCB-&gt;SyncMode
op_assign
id|pDCB2-&gt;SyncMode
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
id|pDCB2-&gt;SyncPeriod
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
id|pDCB2-&gt;SyncOffset
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
id|pDCB2-&gt;NegoPeriod
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|pDCB2-&gt;CtrlR3
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|pDCB2-&gt;CtrlR4
suffix:semicolon
id|pDCB-&gt;Inquiry7
op_assign
id|pDCB2-&gt;Inquiry7
suffix:semicolon
)brace
r_else
(brace
id|pDCB-&gt;DevMode
op_assign
id|prom-&gt;EE_MODE1
suffix:semicolon
id|pDCB-&gt;SyncMode
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
(paren
id|dc390_clock_period1
(braket
id|prom-&gt;EE_SPEED
)braket
op_star
l_int|25
)paren
op_rshift
l_int|2
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|pACB-&gt;glitch_cfg
op_or
id|CTRL4_RESERVED
suffix:semicolon
r_if
c_cond
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
(brace
id|pDCB-&gt;CtrlR4
op_or_assign
id|NEGATE_REQACKDATA
op_or
id|NEGATE_REQACK
suffix:semicolon
)brace
id|pDCB-&gt;Inquiry7
op_assign
l_int|0
suffix:semicolon
)brace
id|pACB-&gt;DCBmap
(braket
id|id
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|lun
)paren
suffix:semicolon
id|dc390_updateDCB
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : static void dc390_updateDCB()&n; *&n; * Purpose :  Set the configuration dependent DCB parameters&n; ***********************************************************************/
DECL|function|dc390_updateDCB
r_void
id|dc390_updateDCB
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
id|pDCB-&gt;SyncMode
op_and_assign
id|EN_TAG_QUEUEING
op_or
id|SYNC_NEGO_DONE
multiline_comment|/*| EN_ATN_STOP*/
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|TAG_QUEUEING_
)paren
(brace
singleline_comment|//if (pDCB-&gt;SyncMode &amp; EN_TAG_QUEUEING) pDCB-&gt;MaxCommand = pACB-&gt;TagMaxNum;
)brace
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|EN_TAG_QUEUEING
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|SYNC_NEGO_
)paren
(brace
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_ENABLE
suffix:semicolon
)brace
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_DONE
op_or
id|SYNC_ENABLE
)paren
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
)brace
suffix:semicolon
singleline_comment|//if (! (pDCB-&gt;DevMode &amp; EN_DISCONNECT_)) pDCB-&gt;SyncMode &amp;= ~EN_ATN_STOP; 
id|pDCB-&gt;CtrlR1
op_assign
id|pACB-&gt;pScsiHost-&gt;this_id
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|PARITY_CHK_
)paren
(brace
id|pDCB-&gt;CtrlR1
op_or_assign
id|PARITY_ERR_REPO
suffix:semicolon
)brace
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Function : static void dc390_updateDCBs ()&n; *&n; * Purpose :  Set the configuration dependent DCB params for all DCBs&n; ***********************************************************************/
DECL|function|dc390_updateDCBs
r_static
r_void
id|dc390_updateDCBs
(paren
id|PACB
id|pACB
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDCB
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dc390_updateDCB
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Function : static void dc390_initSRB()&n; *&n; * Purpose :  initialize the internal structures for a given SRB&n; *&n; * Inputs : psrb - pointer to this scsi request block structure&n; ***********************************************************************/
DECL|function|dc390_initSRB
r_static
r_void
id|__inline__
id|dc390_initSRB
c_func
(paren
id|PSRB
id|psrb
)paren
(brace
multiline_comment|/* psrb-&gt;PhysSRB = virt_to_phys( psrb ); */
)brace
DECL|function|dc390_linkSRB
r_void
id|dc390_linkSRB
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|UINT
id|count
comma
id|i
suffix:semicolon
id|count
op_assign
id|pACB-&gt;SRBCount
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
id|count
op_minus
l_int|1
)paren
(brace
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_else
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|dc390_initSRB
c_func
(paren
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : static void dc390_initACB ()&n; *&n; * Purpose :  initialize the internal structures for a given SCSI host&n; *&n; * Inputs : psh - pointer to this host adapter&squot;s structure&n; *&t;    io_port, Irq, index: Resources and adapter index&n; ***********************************************************************/
DECL|function|dc390_initACB
r_void
id|__init
id|dc390_initACB
(paren
id|PSH
id|psh
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|UCHAR
id|index
)paren
(brace
id|PACB
id|pACB
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|DC390_AFLAGS
id|psh-&gt;can_queue
op_assign
id|MAX_CMD_QUEUE
suffix:semicolon
id|psh-&gt;cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
id|psh-&gt;this_id
op_assign
(paren
r_int
)paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
suffix:semicolon
id|psh-&gt;io_port
op_assign
id|io_port
suffix:semicolon
id|psh-&gt;n_io_port
op_assign
l_int|0x80
suffix:semicolon
id|psh-&gt;irq
op_assign
id|Irq
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,50)
id|psh-&gt;base
op_assign
id|io_port
suffix:semicolon
macro_line|#else
id|psh-&gt;base
op_assign
(paren
r_char
op_star
)paren
id|io_port
suffix:semicolon
macro_line|#endif&t;
id|psh-&gt;unique_id
op_assign
id|io_port
suffix:semicolon
id|psh-&gt;dma_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|psh-&gt;last_reset
op_assign
id|jiffies
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
id|DC390_LOCKA_INIT
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
id|pACB-&gt;pScsiHost
op_assign
id|psh
suffix:semicolon
id|pACB-&gt;IOPortBase
op_assign
(paren
id|USHORT
)paren
id|io_port
suffix:semicolon
id|pACB-&gt;IRQLevel
op_assign
id|Irq
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Adapter index %i, ID %i, IO 0x%08x, IRQ 0x%02x&bslash;n&quot;
comma
"&bslash;"
id|index
comma
id|psh-&gt;this_id
comma
(paren
r_int
)paren
id|io_port
comma
id|Irq
)paren
suffix:semicolon
)paren
id|psh-&gt;max_id
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|psh-&gt;max_id
op_minus
l_int|1
op_eq
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
)paren
(brace
id|psh-&gt;max_id
op_decrement
suffix:semicolon
)brace
id|psh-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|LUN_CHECK
)paren
(brace
id|psh-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
)brace
id|pACB-&gt;pLinkDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pACB-&gt;SRB_array
suffix:semicolon
id|pACB-&gt;SRBCount
op_assign
id|MAX_SRB_CNT
suffix:semicolon
id|pACB-&gt;QueryCnt
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;pQueryHead
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;AdapterIndex
op_assign
id|index
suffix:semicolon
id|pACB-&gt;status
op_assign
l_int|0
suffix:semicolon
id|psh-&gt;this_id
op_assign
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
suffix:semicolon
id|pACB-&gt;DeviceCnt
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;DCBCnt
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;TagMaxNum
op_assign
l_int|2
op_lshift
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_TAG_CMD_NUM
)braket
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;Ignore_IRQ
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;Gmode2
op_assign
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
suffix:semicolon
id|dc390_linkSRB
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|pACB-&gt;pTmpSRB
op_assign
op_amp
id|pACB-&gt;TmpSRB
suffix:semicolon
id|dc390_initSRB
c_func
(paren
id|pACB-&gt;pTmpSRB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SCSI_ID
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pACB-&gt;DCBmap
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|pACB-&gt;sel_timeout
op_assign
id|SEL_TIMEOUT
suffix:semicolon
id|pACB-&gt;glitch_cfg
op_assign
id|EATER_25NS
suffix:semicolon
id|pACB-&gt;Cmds
op_assign
id|pACB-&gt;CmdInQ
op_assign
id|pACB-&gt;CmdOutOfSRB
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;SelLost
op_assign
id|pACB-&gt;SelConn
op_assign
l_int|0
suffix:semicolon
id|init_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : static int dc390_initAdapter ()&n; *&n; * Purpose :  initialize the SCSI chip ctrl registers&n; *&n; * Inputs : psh - pointer to this host adapter&squot;s structure&n; *&t;    io_port, Irq, index: Resources&n; *&n; * Outputs: 0 on success, -1 on error&n; ***********************************************************************/
DECL|function|dc390_initAdapter
r_int
id|__init
id|dc390_initAdapter
(paren
id|PSH
id|psh
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|UCHAR
id|index
)paren
(brace
id|PACB
id|pACB
comma
id|pACB2
suffix:semicolon
id|UCHAR
id|dstate
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|check_region
(paren
id|io_port
comma
id|psh-&gt;n_io_port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: register IO ports error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|request_region
(paren
id|io_port
comma
id|psh-&gt;n_io_port
comma
l_string|&quot;tmscsim&quot;
)paren
suffix:semicolon
id|DC390_read8_
(paren
id|INT_Status
comma
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|request_irq
c_func
(paren
id|Irq
comma
id|do_DC390_Interrupt
comma
id|DC390_IRQ
comma
l_string|&quot;tmscsim&quot;
comma
id|pACB
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: register IRQ error!&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
(paren
id|io_port
comma
id|psh-&gt;n_io_port
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dc390_pACB_start
)paren
(brace
id|pACB2
op_assign
l_int|NULL
suffix:semicolon
id|dc390_pACB_start
op_assign
id|pACB
suffix:semicolon
id|dc390_pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pACB2
op_assign
id|dc390_pACB_current
suffix:semicolon
id|dc390_pACB_current-&gt;pNextACB
op_assign
id|pACB
suffix:semicolon
id|dc390_pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
l_int|NULL
suffix:semicolon
)brace
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|DIS_INT_ON_SCSI_RST
op_or
id|psh-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* Disable SCSI bus reset interrupt */
r_if
c_cond
(paren
id|pACB-&gt;Gmode2
op_amp
id|RST_SCSI_BUS
)paren
(brace
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
multiline_comment|/*&n;&t;for( i=0; i&lt;(500 + 1000*dc390_eepromBuf[pACB-&gt;AdapterIndex][EE_DELAY]); i++ )&n;&t;&t;udelay(1000);&n;&t; */
)brace
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|DC390_read8
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|DC390_write8
(paren
id|Scsi_TimeOut
comma
id|SEL_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* 250ms selection timeout */
id|DC390_write8
(paren
id|Clk_Factor
comma
id|CLK_FREQ_40MHZ
)paren
suffix:semicolon
multiline_comment|/* Conversion factor = 0 , 40MHz clock */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|NOP_CMD
)paren
suffix:semicolon
multiline_comment|/* NOP cmd - clear command register */
id|DC390_write8
(paren
id|CtrlReg2
comma
id|EN_FEATURE
op_plus
id|EN_SCSI2_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable Feature and SCSI-2 */
id|DC390_write8
(paren
id|CtrlReg3
comma
id|FAST_CLK
)paren
suffix:semicolon
multiline_comment|/* fast clock */
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pACB-&gt;glitch_cfg
op_or
multiline_comment|/* glitch eater */
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
ques
c_cond
id|NEGATE_REQACKDATA
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Negation */
id|DC390_write8
(paren
id|CtcReg_High
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear Transfer Count High: ID */
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Status
comma
id|dstate
)paren
suffix:semicolon
multiline_comment|/* clear */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC390_init (struct Scsi_Host *host, ...)&n; *&n; * Purpose :  initialize the internal structures for a given SCSI host&n; *&n; * Inputs : host - pointer to this host adapter&squot;s structure&n; *&t;    io_port - IO ports mapped to this adapter&n; *&t;    Irq - IRQ assigned to this adpater&n; *&t;    PDEVDECL - PCI access handle&n; *&t;    index - Adapter index&n; *&n; * Outputs: 0 on success, -1 on error&n; *&n; * Note: written in capitals, because the locking is only done here,&n; *&t;not in DC390_detect, called from outside &n; ***********************************************************************/
DECL|function|DC390_init
r_static
r_int
id|__init
id|DC390_init
(paren
id|PSHT
id|psht
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|PDEVDECL
comma
id|UCHAR
id|index
)paren
(brace
id|PSH
id|psh
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
id|DC390_AFLAGS
r_if
c_cond
(paren
id|dc390_CheckEEpromCheckSum
(paren
id|PDEV
comma
id|index
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_DC390T_NOGENSUPP
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390_init: No EEPROM found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#else
r_int
id|speed
suffix:semicolon
id|dc390_adapname
op_assign
l_string|&quot;AM53C974&quot;
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390_init: No EEPROM found! Trying default settings ...&bslash;n&quot;
)paren
suffix:semicolon
id|dc390_check_for_safe_settings
(paren
)paren
suffix:semicolon
id|dc390_fill_with_defaults
(paren
)paren
suffix:semicolon
id|dc390_EEprom_Override
(paren
id|index
)paren
suffix:semicolon
id|speed
op_assign
id|dc390_clock_speed
(braket
id|tmscsim
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Used defaults: AdaptID=%i, SpeedIdx=%i (%i.%i MHz),&quot;
l_string|&quot; DevMode=0x%02x, AdaptMode=0x%02x, TaggedCmnds=%i (%i), DelayReset=%is&bslash;n&quot;
comma
id|tmscsim
(braket
l_int|0
)braket
comma
id|tmscsim
(braket
l_int|1
)braket
comma
id|speed
op_div
l_int|10
comma
id|speed
op_mod
l_int|10
comma
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|2
)braket
comma
(paren
id|UCHAR
)paren
id|tmscsim
(braket
l_int|3
)braket
comma
id|tmscsim
(braket
l_int|4
)braket
comma
l_int|2
op_lshift
(paren
id|tmscsim
(braket
l_int|4
)braket
)paren
comma
id|tmscsim
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|dc390_check_for_safe_settings
(paren
)paren
suffix:semicolon
id|dc390_EEprom_Override
(paren
id|index
)paren
suffix:semicolon
)brace
id|psh
op_assign
id|scsi_register
c_func
(paren
id|psht
comma
r_sizeof
(paren
id|DC390_ACB
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psh
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
id|DC390_LOCKA_INIT
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|dc390_pSH_start
)paren
(brace
id|dc390_pSH_start
op_assign
id|psh
suffix:semicolon
id|dc390_pSH_current
op_assign
id|psh
suffix:semicolon
)brace
r_else
(brace
id|dc390_pSH_current-&gt;next
op_assign
id|psh
suffix:semicolon
id|dc390_pSH_current
op_assign
id|psh
suffix:semicolon
)brace
macro_line|#endif
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: pSH = %8x,&quot;
comma
(paren
id|UINT
)paren
id|psh
)paren
suffix:semicolon
)paren
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; Index %02i,&quot;
comma
id|index
)paren
suffix:semicolon
)paren
id|dc390_initACB
c_func
(paren
id|psh
comma
id|io_port
comma
id|Irq
comma
id|index
)paren
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
id|PDEVSET
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dc390_initAdapter
c_func
(paren
id|psh
comma
id|io_port
comma
id|Irq
comma
id|index
)paren
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;nDC390: pACB = %8x, pDCBmap = %8x, pSRB_array = %8x&bslash;n&quot;
comma
"&bslash;"
(paren
id|UINT
)paren
id|pACB
comma
(paren
id|UINT
)paren
id|pACB-&gt;DCBmap
comma
(paren
id|UINT
)paren
id|pACB-&gt;SRB_array
)paren
suffix:semicolon
)paren
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: ACB size= %4x, DCB size= %4x, SRB size= %4x&bslash;n&quot;
comma
"&bslash;"
r_sizeof
(paren
id|DC390_ACB
)paren
comma
r_sizeof
(paren
id|DC390_DCB
)paren
comma
r_sizeof
(paren
id|DC390_SRB
)paren
)paren
suffix:semicolon
)paren
id|DC390_UNLOCK_ACB
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//dc390_pSH_start = NULL;
id|scsi_unregister
c_func
(paren
id|psh
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : int DC390_detect(Scsi_Host_Template *psht)&n; *&n; * Purpose : detects and initializes AMD53C974 SCSI chips&n; *&t;     that were autoprobed, overridden on the LILO command line,&n; *&t;     or specified at compile time.&n; *&n; * Inputs : psht - template for this SCSI adapter&n; *&n; * Returns : number of host adapters detected&n; *&n; ***********************************************************************/
macro_line|#ifndef NEW_PCI
multiline_comment|/* Acc. to PCI 2.1 spec it&squot;s up to the driver to enable Bus mastering:&n; * We use pci_set_master () for 2.1.x and this func for 2.0.x:&t;*/
DECL|function|dc390_set_master
r_static
r_void
id|__init
id|dc390_set_master
(paren
id|PDEVDECL
)paren
(brace
id|USHORT
id|cmd
suffix:semicolon
id|UCHAR
id|lat
suffix:semicolon
id|PCI_READ_CONFIG_WORD
(paren
id|PDEV
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Enabling bus mastering for device %02x:%02x&bslash;n&quot;
comma
id|PCI_BUS_DEV
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|PCI_WRITE_CONFIG_WORD
c_func
(paren
id|PDEV
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
id|PCI_READ_CONFIG_BYTE
(paren
id|PDEV
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|lat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lat
OL
l_int|16
multiline_comment|/* || lat == 255 */
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Setting latency timer of device %02x:%02x from %i to 64&bslash;n&quot;
comma
id|PCI_BUS_DEV
comma
id|lat
)paren
suffix:semicolon
id|PCI_WRITE_CONFIG_BYTE
c_func
(paren
id|PDEV
comma
id|PCI_LATENCY_TIMER
comma
l_int|64
)paren
suffix:semicolon
)brace
)brace
suffix:semicolon
macro_line|#endif /* ! NEW_PCI */
DECL|function|dc390_set_pci_cfg
r_static
r_void
id|__init
id|dc390_set_pci_cfg
(paren
id|PDEVDECL
)paren
(brace
id|USHORT
id|cmd
suffix:semicolon
id|PCI_READ_CONFIG_WORD
(paren
id|PDEV
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_SERR
op_or
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_IO
suffix:semicolon
id|PCI_WRITE_CONFIG_WORD
(paren
id|PDEV
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
id|PCI_WRITE_CONFIG_WORD
(paren
id|PDEV
comma
id|PCI_STATUS
comma
(paren
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|DC390_detect
r_int
id|__init
id|DC390_detect
(paren
id|Scsi_Host_Template
op_star
id|psht
)paren
(brace
id|PDEVDECL0
suffix:semicolon
id|UCHAR
id|irq
suffix:semicolon
id|UINT
id|io_port
suffix:semicolon
singleline_comment|//DC390_IFLAGS
id|DC390_DFLAGS
id|DC390_LOCK_DRV
suffix:semicolon
singleline_comment|//dc390_pSHT_start = psht;
id|dc390_pACB_start
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|PCI_PRESENT
)paren
r_while
c_loop
(paren
id|PCI_FIND_DEVICE
(paren
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD53C974
)paren
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,30)
r_if
c_cond
(paren
id|pci_enable_device
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
macro_line|#endif
singleline_comment|//DC390_LOCK_IO;&t;&t;/* Remove this when going to new eh */
id|PCI_GET_IO_AND_IRQ
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390(%i): IO_PORT=%04x,IRQ=%x&bslash;n&quot;
comma
id|dc390_adapterCnt
comma
(paren
id|UINT
)paren
id|io_port
comma
id|irq
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|DC390_init
c_func
(paren
id|psht
comma
id|io_port
comma
id|irq
comma
id|PDEV
comma
id|dc390_adapterCnt
)paren
)paren
(brace
id|PCI_SET_MASTER
suffix:semicolon
id|dc390_set_pci_cfg
(paren
id|PDEV
)paren
suffix:semicolon
id|dc390_adapterCnt
op_increment
suffix:semicolon
)brace
suffix:semicolon
singleline_comment|//DC390_UNLOCK_IO;&t;&t;/* Remove when going to new eh */
)brace
r_else
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: No PCI BIOS found!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dc390_adapterCnt
)paren
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,30)
id|psht-&gt;proc_name
op_assign
l_string|&quot;tmscsim&quot;
suffix:semicolon
macro_line|#else
id|psht-&gt;proc_dir
op_assign
op_amp
id|DC390_proc_scsi_tmscsim
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: %i adapters found&bslash;n&quot;
comma
id|dc390_adapterCnt
)paren
suffix:semicolon
id|DC390_UNLOCK_DRV
suffix:semicolon
r_return
id|dc390_adapterCnt
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Functions: dc390_inquiry(), dc390_inquiry_done()&n; *&n; * Purpose: When changing speed etc., we have to issue an INQUIRY&n; *&t;    command to make sure, we agree upon the nego parameters&n; *&t;    with the device&n; ***********************************************************************/
DECL|function|dc390_inquiry_done
r_static
r_void
id|dc390_inquiry_done
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: INQUIRY (ID %02x LUN %02x) returned %08x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;result
)paren
(brace
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|PDCB
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Unsetting DsCn, Sync and TagQ!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
id|pDCB-&gt;DevMode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_
op_or
id|TAG_QUEUEING_
op_or
id|EN_DISCONNECT_
)paren
suffix:semicolon
id|dc390_updateDCB
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
id|kfree
(paren
id|cmd
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dc390_inquiry
r_void
id|dc390_inquiry
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
r_char
op_star
id|buffer
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|cmd
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_plus
l_int|256
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: kmalloc failed in inquiry!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
id|buffer
op_assign
(paren
r_char
op_star
)paren
id|cmd
op_plus
r_sizeof
(paren
id|Scsi_Cmnd
)paren
suffix:semicolon
id|memset
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_plus
l_int|256
)paren
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_assign
(paren
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
op_amp
l_int|0xe0
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|0xff
suffix:semicolon
id|cmd-&gt;cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmd-&gt;old_cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmd-&gt;host
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
id|cmd-&gt;target
op_assign
id|pDCB-&gt;TargetID
suffix:semicolon
id|cmd-&gt;lun
op_assign
id|pDCB-&gt;TargetLUN
suffix:semicolon
id|cmd-&gt;serial_number
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;pid
op_assign
l_int|390
suffix:semicolon
id|cmd-&gt;bufflen
op_assign
l_int|128
suffix:semicolon
id|cmd-&gt;buffer
op_assign
id|buffer
suffix:semicolon
id|cmd-&gt;request_bufflen
op_assign
l_int|128
suffix:semicolon
id|cmd-&gt;request_buffer
op_assign
op_amp
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
id|cmd-&gt;done
op_assign
id|dc390_inquiry_done
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|dc390_inquiry_done
suffix:semicolon
id|cmd-&gt;timeout_per_command
op_assign
id|HZ
suffix:semicolon
id|cmd-&gt;request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Queue INQUIRY command to dev ID %02x LUN %02x&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|DC390_queue_command
(paren
id|cmd
comma
id|dc390_inquiry_done
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Functions: dc390_sendstart(), dc390_sendstart_done()&n; *&n; * Purpose: When changing speed etc., we have to issue an INQUIRY&n; *&t;    command to make sure, we agree upon the nego parameters&n; *&t;    with the device&n; ***********************************************************************/
DECL|function|dc390_sendstart_done
r_static
r_void
id|dc390_sendstart_done
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: SENDSTART (ID %02x LUN %02x) returned %08x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;result
)paren
suffix:semicolon
id|kfree
(paren
id|cmd
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dc390_sendstart
r_void
id|dc390_sendstart
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
r_char
op_star
id|buffer
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|cmd
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_plus
l_int|256
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: kmalloc failed in sendstart!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
id|buffer
op_assign
(paren
r_char
op_star
)paren
id|cmd
op_plus
r_sizeof
(paren
id|Scsi_Cmnd
)paren
suffix:semicolon
id|memset
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_plus
l_int|256
)paren
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
l_int|0x1b
suffix:semicolon
multiline_comment|/* START_STOP_UNIT */
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_assign
(paren
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
op_amp
l_int|0xe0
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* START */
id|cmd-&gt;cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmd-&gt;old_cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmd-&gt;host
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
id|cmd-&gt;target
op_assign
id|pDCB-&gt;TargetID
suffix:semicolon
id|cmd-&gt;lun
op_assign
id|pDCB-&gt;TargetLUN
suffix:semicolon
id|cmd-&gt;serial_number
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;pid
op_assign
l_int|310
suffix:semicolon
id|cmd-&gt;bufflen
op_assign
l_int|128
suffix:semicolon
id|cmd-&gt;buffer
op_assign
id|buffer
suffix:semicolon
id|cmd-&gt;request_bufflen
op_assign
l_int|128
suffix:semicolon
id|cmd-&gt;request_buffer
op_assign
op_amp
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
id|cmd-&gt;done
op_assign
id|dc390_sendstart_done
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|dc390_sendstart_done
suffix:semicolon
id|cmd-&gt;timeout_per_command
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|cmd-&gt;request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Queue SEND_START command to dev ID %02x LUN %02x&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|DC390_queue_command
(paren
id|cmd
comma
id|dc390_sendstart_done
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/********************************************************************&n; * Function: dc390_set_info()&n; *&n; * Purpose: Change adapter config&n; *&n; * Strings are parsed similar to the output of tmscsim_proc_info ()&n; * &squot;-&squot; means no change&n; *******************************************************************/
DECL|function|dc390_scanf
r_static
r_int
id|dc390_scanf
(paren
r_char
op_star
op_star
id|p1
comma
r_char
op_star
op_star
id|p2
comma
r_int
op_star
id|var
)paren
(brace
op_star
id|p2
op_assign
op_star
id|p1
suffix:semicolon
op_star
id|var
op_assign
id|simple_strtoul
(paren
op_star
id|p2
comma
id|p1
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p2
op_eq
op_star
id|p1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|p1
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;.&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SCANF
mdefine_line|#define SCANF(p1, p2, var, min, max)&t;&t;&bslash;&n;if (dc390_scanf (&amp;p1, &amp;p2, &amp;var)) goto einv;&t;&bslash;&n;else if (var&lt;min || var&gt;max) goto einv2
DECL|function|dc390_yesno
r_static
r_int
id|dc390_yesno
(paren
r_char
op_star
op_star
id|p
comma
r_char
op_star
id|var
comma
r_char
id|bmask
)paren
(brace
r_switch
c_cond
(paren
op_star
op_star
id|p
)paren
(brace
r_case
l_char|&squot;Y&squot;
suffix:colon
op_star
id|var
op_or_assign
id|bmask
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;N&squot;
suffix:colon
op_star
id|var
op_and_assign
op_complement
id|bmask
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;-&squot;
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|p
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|YESNO
mdefine_line|#define YESNO(p, var, bmask)&t;&t;&t;&bslash;&n;if (dc390_yesno (&amp;p, &amp;var, bmask)) goto einv;&t;&bslash;&n;else dc390_updateDCB (pACB, pDCB);&t;&t;&bslash;&n;if (!p) goto ok
DECL|function|dc390_search
r_static
r_int
id|dc390_search
(paren
r_char
op_star
op_star
id|p1
comma
r_char
op_star
op_star
id|p2
comma
r_char
op_star
id|var
comma
r_char
op_star
id|txt
comma
r_int
id|max
comma
r_int
id|scale
comma
r_char
op_star
id|ign
)paren
(brace
r_int
id|dum
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
op_star
id|p1
comma
id|txt
comma
id|strlen
c_func
(paren
id|txt
)paren
)paren
)paren
(brace
op_star
id|p2
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|p2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dum
op_assign
id|simple_strtoul
(paren
op_star
id|p2
comma
id|p1
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p2
op_eq
op_star
id|p1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dum
op_ge
l_int|0
op_logical_and
id|dum
op_le
id|max
)paren
(brace
op_star
id|var
op_assign
(paren
id|dum
op_star
l_int|100
)paren
op_div
id|scale
suffix:semicolon
)brace
r_else
r_return
op_minus
l_int|2
suffix:semicolon
op_star
id|p1
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ign
op_logical_and
op_star
id|p1
op_logical_and
id|strlen
c_func
(paren
op_star
id|p1
)paren
op_ge
id|strlen
c_func
(paren
id|ign
)paren
op_logical_and
op_logical_neg
(paren
id|memcmp
(paren
op_star
id|p1
comma
id|ign
comma
id|strlen
c_func
(paren
id|ign
)paren
)paren
)paren
)paren
op_star
id|p1
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SEARCH
mdefine_line|#define SEARCH(p1, p2, var, txt, max)&t;&t;&t;&t;&t;&t;&bslash;&n;if (dc390_search (&amp;p1, &amp;p2, (PUCHAR)(&amp;var), txt, max, 100, &quot;&quot;)) goto einv2;&t;&bslash;&n;else if (!p1) goto ok2
DECL|macro|SEARCH2
mdefine_line|#define SEARCH2(p1, p2, var, txt, max, scale)&t;&t;&t;&t;&t;&bslash;&n;if (dc390_search (&amp;p1, &amp;p2, &amp;var, txt, max, scale, &quot;&quot;)) goto einv2; &t;&t;&bslash;&n;else if (!p1) goto ok2
DECL|macro|SEARCH3
mdefine_line|#define SEARCH3(p1, p2, var, txt, max, scale, ign)&t;&t;&t;&t;&bslash;&n;if (dc390_search (&amp;p1, &amp;p2, &amp;var, txt, max, scale, ign)) goto einv2;&t;&t;&bslash;&n;else if (!p1) goto ok2
macro_line|#ifdef DC390_PARSEDEBUG
DECL|variable|_prstr
r_static
r_char
id|_prstr
(braket
l_int|256
)braket
suffix:semicolon
DECL|function|prstr
r_char
op_star
id|prstr
(paren
r_char
op_star
id|p
comma
r_char
op_star
id|e
)paren
(brace
r_char
op_star
id|c
op_assign
id|_prstr
suffix:semicolon
r_while
c_loop
(paren
id|p
OL
id|e
)paren
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0
)paren
(brace
op_star
id|c
op_increment
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|10
)paren
(brace
op_star
id|c
op_increment
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
op_star
id|c
op_increment
op_assign
l_char|&squot;n&squot;
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_else
op_star
id|c
op_increment
op_assign
op_star
id|p
op_increment
suffix:semicolon
op_star
id|c
op_assign
l_int|0
suffix:semicolon
r_return
id|_prstr
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
DECL|function|dc390_set_info
r_int
id|dc390_set_info
(paren
r_char
op_star
id|buffer
comma
r_int
id|length
comma
id|PACB
id|pACB
)paren
(brace
r_char
op_star
id|pos
op_assign
id|buffer
comma
op_star
id|p0
op_assign
id|buffer
suffix:semicolon
r_char
id|needs_inquiry
op_assign
l_int|0
suffix:semicolon
r_int
id|dum
op_assign
l_int|0
suffix:semicolon
r_char
id|dev
suffix:semicolon
id|PDCB
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|DC390_IFLAGS
id|DC390_AFLAGS
id|pos
(braket
id|length
)braket
op_assign
l_int|0
suffix:semicolon
id|DC390_LOCK_IO
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
multiline_comment|/* UPPERCASE */
multiline_comment|/* Don&squot;t use kernel toupper, because of 2.0.x bug: ctmp unexported */
r_while
c_loop
(paren
op_star
id|pos
)paren
(brace
r_if
c_cond
(paren
op_star
id|pos
op_ge
l_char|&squot;a&squot;
op_logical_and
op_star
id|pos
op_le
l_char|&squot;z&squot;
)paren
op_star
id|pos
op_assign
op_star
id|pos
op_plus
l_char|&squot;A&squot;
op_minus
l_char|&squot;a&squot;
suffix:semicolon
id|pos
op_increment
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* We should protect __strtok ! */
multiline_comment|/* spin_lock (strtok_lock); */
multiline_comment|/* Remove WS */
id|pos
op_assign
id|strtok
(paren
id|buffer
comma
l_string|&quot; &bslash;t:&bslash;n=,;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
id|next
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
id|pos
comma
l_string|&quot;RESET&quot;
comma
l_int|5
)paren
)paren
r_goto
id|reset
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
id|pos
comma
l_string|&quot;INQUIRY&quot;
comma
l_int|7
)paren
)paren
r_goto
id|inquiry
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
id|pos
comma
l_string|&quot;REMOVE&quot;
comma
l_int|6
)paren
)paren
r_goto
id|remove
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
id|pos
comma
l_string|&quot;ADD&quot;
comma
l_int|3
)paren
)paren
r_goto
id|add
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
id|pos
comma
l_string|&quot;START&quot;
comma
l_int|5
)paren
)paren
r_goto
id|start
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|memcmp
(paren
id|pos
comma
l_string|&quot;DUMP&quot;
comma
l_int|4
)paren
)paren
r_goto
id|dump
suffix:semicolon
r_if
c_cond
(paren
id|isdigit
(paren
op_star
id|pos
)paren
)paren
(brace
multiline_comment|/* Device config line */
r_int
id|dev
comma
id|id
comma
id|lun
suffix:semicolon
r_char
op_star
id|pdec
suffix:semicolon
r_char
id|olddevmode
suffix:semicolon
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|dev
comma
l_int|0
comma
id|pACB-&gt;DCBCnt
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|id
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_goto
id|einv
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|lun
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_goto
id|einv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|einv
suffix:semicolon
id|PARSEDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: config line %i %i %i:&bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|dev
comma
id|id
comma
id|lun
comma
id|prstr
(paren
id|pos
comma
op_amp
id|buffer
(braket
id|length
)braket
)paren
)paren
suffix:semicolon
)paren
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|dum
op_assign
l_int|0
suffix:semicolon
id|dum
OL
id|dev
suffix:semicolon
id|dum
op_increment
)paren
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
multiline_comment|/* Sanity Check */
r_if
c_cond
(paren
id|pDCB-&gt;TargetID
op_ne
id|id
op_logical_or
id|pDCB-&gt;TargetLUN
op_ne
id|lun
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: no such device: Idx=%02i ID=%02i LUN=%02i&bslash;n&quot;
comma
id|dev
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_goto
id|einv2
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
op_logical_or
id|pDCB-&gt;pGoingSRB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Cannot change dev (%i-%i) cfg: Pending requests&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_goto
id|einv
suffix:semicolon
)brace
suffix:semicolon
id|olddevmode
op_assign
id|pDCB-&gt;DevMode
suffix:semicolon
id|YESNO
(paren
id|pos
comma
id|pDCB-&gt;DevMode
comma
id|PARITY_CHK_
)paren
suffix:semicolon
id|needs_inquiry
op_increment
suffix:semicolon
id|YESNO
(paren
id|pos
comma
id|pDCB-&gt;DevMode
comma
id|SYNC_NEGO_
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|olddevmode
op_amp
id|SYNC_NEGO_
)paren
op_eq
(paren
id|pDCB-&gt;DevMode
op_amp
id|SYNC_NEGO_
)paren
)paren
id|needs_inquiry
op_decrement
suffix:semicolon
id|needs_inquiry
op_increment
suffix:semicolon
id|YESNO
(paren
id|pos
comma
id|pDCB-&gt;DevMode
comma
id|EN_DISCONNECT_
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|olddevmode
op_amp
id|EN_DISCONNECT_
)paren
op_eq
(paren
id|pDCB-&gt;DevMode
op_amp
id|EN_DISCONNECT_
)paren
)paren
id|needs_inquiry
op_decrement
suffix:semicolon
id|YESNO
(paren
id|pos
comma
id|pDCB-&gt;DevMode
comma
id|SEND_START_
)paren
suffix:semicolon
id|needs_inquiry
op_increment
suffix:semicolon
id|YESNO
(paren
id|pos
comma
id|pDCB-&gt;DevMode
comma
id|TAG_QUEUEING_
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|olddevmode
op_amp
id|TAG_QUEUEING_
)paren
op_eq
(paren
id|pDCB-&gt;DevMode
op_amp
id|TAG_QUEUEING_
)paren
)paren
id|needs_inquiry
op_decrement
suffix:semicolon
id|dc390_updateDCB
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
id|olddevmode
op_assign
id|pDCB-&gt;NegoPeriod
suffix:semicolon
multiline_comment|/* Look for decimal point (Speed) */
id|pdec
op_assign
id|pos
suffix:semicolon
r_while
c_loop
(paren
id|pdec
op_increment
OL
op_amp
id|buffer
(braket
id|length
)braket
)paren
r_if
c_cond
(paren
op_star
id|pdec
op_eq
l_char|&squot;.&squot;
)paren
r_break
suffix:semicolon
multiline_comment|/* NegoPeriod */
r_if
c_cond
(paren
op_star
id|pos
op_ne
l_char|&squot;-&squot;
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|dum
comma
l_int|72
comma
l_int|800
)paren
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
id|dum
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;NegoPeriod
op_ne
id|olddevmode
)paren
id|needs_inquiry
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
(paren
id|pos
comma
l_string|&quot;NS&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;.&quot;
)paren
suffix:semicolon
)brace
r_else
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
multiline_comment|/* Sync Speed in MHz */
r_if
c_cond
(paren
op_star
id|pos
op_ne
l_char|&squot;-&squot;
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|dum
comma
l_int|1
comma
l_int|13
)paren
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
(paren
l_int|1000
op_div
id|dum
)paren
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;NegoPeriod
op_ne
id|olddevmode
op_logical_and
op_logical_neg
id|pos
)paren
id|needs_inquiry
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
multiline_comment|/* decimal */
r_if
c_cond
(paren
id|pos
op_minus
l_int|1
op_eq
id|pdec
)paren
(brace
r_int
id|dumold
op_assign
id|dum
suffix:semicolon
id|dum
op_assign
id|simple_strtoul
(paren
id|pos
comma
op_amp
id|p0
comma
l_int|10
)paren
op_star
l_int|10
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p0
op_minus
id|pos
OG
l_int|1
suffix:semicolon
id|p0
op_decrement
)paren
id|dum
op_div_assign
l_int|10
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
(paren
l_int|100000
op_div
(paren
l_int|100
op_star
id|dumold
op_plus
id|dum
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;NegoPeriod
OL
l_int|19
)paren
id|pDCB-&gt;NegoPeriod
op_assign
l_int|19
suffix:semicolon
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pos
op_eq
l_char|&squot;M&squot;
)paren
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;NegoPeriod
op_ne
id|olddevmode
)paren
id|needs_inquiry
op_increment
suffix:semicolon
)brace
r_else
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
multiline_comment|/* dc390_updateDCB (pACB, pDCB); */
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
id|olddevmode
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
multiline_comment|/* SyncOffs */
r_if
c_cond
(paren
op_star
id|pos
op_ne
l_char|&squot;-&squot;
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|dum
comma
l_int|0
comma
l_int|0x0f
)paren
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
id|dum
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
OG
id|olddevmode
)paren
id|needs_inquiry
op_increment
suffix:semicolon
)brace
r_else
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|ok
suffix:semicolon
id|dc390_updateDCB
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
singleline_comment|//olddevmode = pDCB-&gt;MaxCommand;
multiline_comment|/* MaxCommand (Tags) */
r_if
c_cond
(paren
op_star
id|pos
op_ne
l_char|&squot;-&squot;
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|dum
comma
l_int|1
comma
l_int|32
multiline_comment|/*pACB-&gt;TagMaxNum*/
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
id|pDCB-&gt;MaxCommand
op_assign
id|dum
suffix:semicolon
r_else
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Can&squot;t set MaxCmd larger than one without Tag Queueing!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n:=,;&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
op_star
id|p1
op_assign
id|pos
suffix:semicolon
id|UCHAR
id|dum
comma
id|newadaptid
suffix:semicolon
id|PARSEDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: chg adapt cfg &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|prstr
(paren
id|pos
comma
op_amp
id|buffer
(braket
id|length
)braket
)paren
)paren
suffix:semicolon
)paren
id|dum
op_assign
id|GLITCH_TO_NS
(paren
id|pACB-&gt;glitch_cfg
)paren
suffix:semicolon
multiline_comment|/* Adapter setting */
id|SEARCH
(paren
id|pos
comma
id|p0
comma
id|pACB-&gt;pScsiHost-&gt;max_id
comma
l_string|&quot;MAXID&quot;
comma
l_int|8
)paren
suffix:semicolon
id|SEARCH
(paren
id|pos
comma
id|p0
comma
id|pACB-&gt;pScsiHost-&gt;max_lun
comma
l_string|&quot;MAXLUN&quot;
comma
l_int|8
)paren
suffix:semicolon
id|SEARCH
(paren
id|pos
comma
id|p0
comma
id|newadaptid
comma
l_string|&quot;ADAPTERID&quot;
comma
l_int|7
)paren
suffix:semicolon
id|SEARCH
(paren
id|pos
comma
id|p0
comma
id|pACB-&gt;TagMaxNum
comma
l_string|&quot;TAGMAXNUM&quot;
comma
l_int|32
)paren
suffix:semicolon
id|SEARCH
(paren
id|pos
comma
id|p0
comma
id|pACB-&gt;ACBFlag
comma
l_string|&quot;ACBFLAG&quot;
comma
l_int|255
)paren
suffix:semicolon
id|SEARCH3
(paren
id|pos
comma
id|p0
comma
id|dum
comma
l_string|&quot;GLITCHEATER&quot;
comma
l_int|40
comma
l_int|1000
comma
l_string|&quot;NS&quot;
)paren
suffix:semicolon
id|SEARCH3
(paren
id|pos
comma
id|p0
comma
id|pACB-&gt;sel_timeout
comma
l_string|&quot;SELTIMEOUT&quot;
comma
l_int|400
comma
l_int|163
comma
l_string|&quot;MS&quot;
)paren
suffix:semicolon
id|SEARCH3
(paren
id|pos
comma
id|p0
comma
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
comma
l_string|&quot;DELAYRESET&quot;
comma
l_int|180
comma
l_int|100
comma
l_string|&quot;S&quot;
)paren
suffix:semicolon
id|ok2
suffix:colon
id|pACB-&gt;glitch_cfg
op_assign
id|NS_TO_GLITCH
(paren
id|dum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;sel_timeout
OL
l_int|60
)paren
id|pACB-&gt;sel_timeout
op_assign
l_int|60
suffix:semicolon
id|DC390_write8
(paren
id|Scsi_TimeOut
comma
id|pACB-&gt;sel_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newadaptid
op_ne
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
(brace
id|pACB-&gt;pScsiHost-&gt;this_id
op_assign
id|newadaptid
suffix:semicolon
id|dc390_ResetDevParam
(paren
id|pACB
)paren
suffix:semicolon
)brace
singleline_comment|//dum = 0; while (1 &lt;&lt; dum &lt;= pACB-&gt;TagMaxNum) dum ++;
singleline_comment|//pACB-&gt;TagMaxNum &amp;= (1 &lt;&lt; --dum);
id|dc390_updateDCBs
(paren
id|pACB
)paren
suffix:semicolon
singleline_comment|// All devs should be INQUIRED now
r_if
c_cond
(paren
id|pos
op_eq
id|p1
)paren
r_goto
id|einv
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
)paren
r_goto
id|next
suffix:semicolon
id|ok
suffix:colon
multiline_comment|/* spin_unlock (strtok_lock); */
id|DC390_UNLOCK_ACB
suffix:semicolon
r_if
c_cond
(paren
id|needs_inquiry
)paren
(brace
id|dc390_updateDCB
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|dc390_inquiry
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
id|einv2
suffix:colon
id|pos
op_assign
id|p0
suffix:semicolon
id|einv
suffix:colon
multiline_comment|/* spin_unlock (strtok_lock); */
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: parse error near &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
(paren
id|pos
ques
c_cond
id|pos
suffix:colon
l_string|&quot;NULL&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|reset
suffix:colon
(brace
id|Scsi_Cmnd
id|cmd
suffix:semicolon
id|cmd.host
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Driver reset requested!&bslash;n&quot;
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_reset
(paren
op_amp
id|cmd
comma
l_int|0
)paren
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
id|dump
suffix:colon
(brace
id|dc390_dumpinfo
(paren
id|pACB
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
r_return
(paren
id|length
)paren
suffix:semicolon
id|inquiry
suffix:colon
(brace
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n.:;=&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|einv
suffix:semicolon
id|dev
op_assign
id|simple_strtoul
(paren
id|pos
comma
op_amp
id|p0
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|pACB-&gt;DCBCnt
)paren
r_goto
id|einv_dev
suffix:semicolon
r_for
c_loop
(paren
id|dum
op_assign
l_int|0
suffix:semicolon
id|dum
OL
id|dev
suffix:semicolon
id|dum
op_increment
)paren
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|printk
(paren
id|KERN_NOTICE
l_string|&quot; DC390: Issue INQUIRY command to Dev(Idx) %i SCSI ID %i LUN %i&bslash;n&quot;
comma
id|dev
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|dc390_inquiry
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
id|remove
suffix:colon
(brace
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n.:;=&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pos
)paren
r_goto
id|einv
suffix:semicolon
id|dev
op_assign
id|simple_strtoul
(paren
id|pos
comma
op_amp
id|p0
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|pACB-&gt;DCBCnt
)paren
r_goto
id|einv_dev
suffix:semicolon
r_for
c_loop
(paren
id|dum
op_assign
l_int|0
suffix:semicolon
id|dum
OL
id|dev
suffix:semicolon
id|dum
op_increment
)paren
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|printk
(paren
id|KERN_NOTICE
l_string|&quot; DC390: Remove DCB for Dev(Idx) %i SCSI ID %i LUN %i&bslash;n&quot;
comma
id|dev
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
multiline_comment|/* TO DO: We should make sure no pending commands are left */
id|dc390_remove_dev
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
id|add
suffix:colon
(brace
r_int
id|id
comma
id|lun
suffix:semicolon
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n.:;=&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|id
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_goto
id|einv
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|lun
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_goto
id|einv
suffix:semicolon
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: ADD: Device already existing&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|einv
suffix:semicolon
)brace
suffix:semicolon
id|dc390_initDCB
(paren
id|pACB
comma
op_amp
id|pDCB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|dc390_inquiry
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
id|start
suffix:colon
(brace
r_int
id|id
comma
id|lun
suffix:semicolon
id|pos
op_assign
id|strtok
(paren
l_int|0
comma
l_string|&quot; &bslash;t&bslash;n.:;=&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|id
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_goto
id|einv
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|SCANF
(paren
id|pos
comma
id|p0
comma
id|lun
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_goto
id|einv
suffix:semicolon
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
id|printk
(paren
l_string|&quot;DC390: SendStart: Device already existing ...&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dc390_initDCB
(paren
id|pACB
comma
op_amp
id|pDCB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|dc390_sendstart
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|dc390_inquiry
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
)brace
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
id|einv_dev
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Ignore cmnd to illegal Dev(Idx) %i. Valid range: 0 - %i.&bslash;n&quot;
comma
id|dev
comma
id|pACB-&gt;DCBCnt
op_minus
l_int|1
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
DECL|macro|SEARCH
macro_line|#undef SEARCH
DECL|macro|YESNO
macro_line|#undef YESNO
DECL|macro|SCANF
macro_line|#undef SCANF
multiline_comment|/********************************************************************&n; * Function: DC390_proc_info(char* buffer, char **start,&n; *&t;&t;&t;     off_t offset, int length, int hostno, int inout)&n; *&n; * Purpose: return SCSI Adapter/Device Info&n; *&n; * Input: buffer: Pointer to a buffer where to write info&n; *&t;  start :&n; *&t;  offset:&n; *&t;  hostno: Host adapter index&n; *&t;  inout : Read (=0) or set(!=0) info&n; *&n; * Output: buffer: contains info&n; *&t;   length; length of info in buffer&n; *&n; * return value: length&n; *&n; ********************************************************************/
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) pos += sprintf(pos, ## args)
DECL|macro|YESNO
mdefine_line|#define YESNO(YN)&t;&t;&bslash;&n; if (YN) SPRINTF(&quot; Yes &quot;);&t;&bslash;&n; else SPRINTF(&quot; No  &quot;)
DECL|function|DC390_proc_info
r_int
id|DC390_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_int
id|dev
comma
id|spd
comma
id|spd1
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
id|PSH
id|shpnt
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
id|PDCB
id|pDCB
suffix:semicolon
id|PSCSICMD
id|pcmd
suffix:semicolon
id|DC390_AFLAGS
id|pACB
op_assign
id|dc390_pACB_start
suffix:semicolon
r_while
c_loop
(paren
id|pACB
op_ne
(paren
id|PACB
)paren
op_minus
l_int|1
)paren
(brace
id|shpnt
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
r_if
c_cond
(paren
id|shpnt-&gt;host_no
op_eq
id|hostno
)paren
r_break
suffix:semicolon
id|pACB
op_assign
id|pACB-&gt;pNextACB
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pACB
op_eq
(paren
id|PACB
)paren
op_minus
l_int|1
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inout
)paren
(brace
multiline_comment|/* Has data been written to the file ? */
r_return
id|dc390_set_info
c_func
(paren
id|buffer
comma
id|length
comma
id|pACB
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;Tekram DC390/AM53C974 PCI SCSI Host Adapter, &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Driver Version %s&bslash;n&quot;
comma
id|DC390_VERSION
)paren
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSI Host Nr %i, &quot;
comma
id|shpnt-&gt;host_no
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%s Adapter Nr %i&bslash;n&quot;
comma
id|dc390_adapname
comma
id|pACB-&gt;AdapterIndex
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IOPortBase 0x%04x, &quot;
comma
id|pACB-&gt;IOPortBase
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IRQ %02i&bslash;n&quot;
comma
id|pACB-&gt;IRQLevel
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;MaxID %i, MaxLUN %i, &quot;
comma
id|shpnt-&gt;max_id
comma
id|shpnt-&gt;max_lun
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;AdapterID %i, SelTimeout %i ms, DelayReset %i s&bslash;n&quot;
comma
id|shpnt-&gt;this_id
comma
(paren
id|pACB-&gt;sel_timeout
op_star
l_int|164
)paren
op_div
l_int|100
comma
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;TagMaxNum %i, Status 0x%02x, ACBFlag 0x%02x, GlitchEater %i ns&bslash;n&quot;
comma
id|pACB-&gt;TagMaxNum
comma
id|pACB-&gt;status
comma
id|pACB-&gt;ACBFlag
comma
id|GLITCH_TO_NS
c_func
(paren
id|pACB-&gt;glitch_cfg
)paren
op_star
l_int|12
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Statistics: Cmnds %li, Cmnds not sent directly %i, Out of SRB conds %i&bslash;n&quot;
comma
id|pACB-&gt;Cmds
comma
id|pACB-&gt;CmdInQ
comma
id|pACB-&gt;CmdOutOfSRB
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;            Lost arbitrations %i, Sel. connected %i, Connected: %s&bslash;n&quot;
comma
id|pACB-&gt;SelLost
comma
id|pACB-&gt;SelConn
comma
id|pACB-&gt;Connected
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Nr of attached devices: %i, Nr of DCBs: %i&bslash;n&quot;
comma
id|pACB-&gt;DeviceCnt
comma
id|pACB-&gt;DCBCnt
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Map of attached LUNs: %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|pACB-&gt;DCBmap
(braket
l_int|0
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|1
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|2
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|3
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|4
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|5
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|6
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Idx ID LUN Prty Sync DsCn SndS TagQ NegoPeriod SyncSpeed SyncOffs MaxCmd&bslash;n&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|dev
op_increment
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;%02i  %02i  %02i &quot;
comma
id|dev
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|PARITY_CHK_
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|EN_DISCONNECT_
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|SEND_START_
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
(brace
r_int
id|sp
op_assign
id|pDCB-&gt;SyncPeriod
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;CtrlR3
op_amp
id|FAST_SCSI
)paren
)paren
id|sp
op_increment
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;  %03i ns &quot;
comma
(paren
id|pDCB-&gt;NegoPeriod
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|spd
op_assign
l_int|40
op_div
(paren
id|sp
)paren
suffix:semicolon
id|spd1
op_assign
l_int|40
op_mod
(paren
id|sp
)paren
suffix:semicolon
id|spd1
op_assign
(paren
id|spd1
op_star
l_int|10
op_plus
id|sp
op_div
l_int|2
)paren
op_div
(paren
id|sp
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;   %2i.%1i M      %02i&quot;
comma
id|spd
comma
id|spd1
comma
(paren
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot; (%03i ns)                 &quot;
comma
(paren
id|pDCB-&gt;NegoPeriod
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Add more info ...*/
id|SPRINTF
(paren
l_string|&quot;      %02i&bslash;n&quot;
comma
id|pDCB-&gt;MaxCommand
)paren
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
id|SPRINTF
(paren
l_string|&quot;Commands in Queues: Query: %li:&quot;
comma
id|pACB-&gt;QueryCnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pcmd
op_assign
id|pACB-&gt;pQueryHead
suffix:semicolon
id|pcmd
suffix:semicolon
id|pcmd
op_assign
id|pcmd-&gt;next
)paren
id|SPRINTF
(paren
l_string|&quot; %li&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|SPRINTF
(paren
l_string|&quot;Waiting queue timer running&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|SPRINTF
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|dev
op_increment
)paren
(brace
id|PSRB
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;WaitSRBCnt
)paren
id|SPRINTF
(paren
l_string|&quot;DCB (%02i-%i): Waiting: %i:&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB-&gt;WaitSRBCnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
)paren
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;GoingSRBCnt
)paren
id|SPRINTF
(paren
l_string|&quot;&bslash;nDCB (%02i-%i): Going  : %i:&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB-&gt;GoingSRBCnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
)paren
macro_line|#if 0 
singleline_comment|//def DC390_DEBUGTRACE
id|SPRINTF
c_func
(paren
l_string|&quot; %s&bslash;n  &quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
macro_line|#else
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pDCB-&gt;WaitSRBCnt
op_logical_or
id|pDCB-&gt;GoingSRBCnt
)paren
id|SPRINTF
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
macro_line|#ifdef DC390_DEBUGDCB
id|SPRINTF
(paren
l_string|&quot;DCB list for ACB %p:&bslash;n&quot;
comma
id|pACB
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;%p&quot;
comma
id|pDCB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|dev
op_increment
comma
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
)paren
id|SPRINTF
(paren
l_string|&quot;-&gt;%p&quot;
comma
id|pDCB-&gt;pNextDCB
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|DC390_UNLOCK_ACB
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
OL
id|offset
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
OL
id|length
)paren
r_return
id|pos
op_minus
id|buffer
op_minus
id|offset
suffix:semicolon
r_else
r_return
id|length
suffix:semicolon
)brace
DECL|macro|YESNO
macro_line|#undef YESNO
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
macro_line|#ifdef MODULE
multiline_comment|/***********************************************************************&n; * Function : static int dc390_shutdown (struct Scsi_Host *host)&n; *&n; * Purpose : does a clean (we hope) shutdown of the SCSI chip.&n; *&t;     Use prior to dumping core, unloading the driver, etc.&n; *&n; * Returns : 0 on success&n; ***********************************************************************/
DECL|function|dc390_shutdown
r_static
r_int
id|dc390_shutdown
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
multiline_comment|/*  pACB-&gt;soft_reset(host); */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: shutdown&bslash;n&quot;
)paren
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
id|RESET_DEV
suffix:semicolon
id|bval
op_assign
id|DC390_read8
(paren
id|CtrlReg1
)paren
suffix:semicolon
id|bval
op_or_assign
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* disable interrupt */
r_if
c_cond
(paren
id|pACB-&gt;Gmode2
op_amp
id|RST_SCSI_BUS
)paren
id|dc390_ResetSCSIBus
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dc390_freeDCBs
r_void
id|dc390_freeDCBs
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|PDCB
id|pDCB
comma
id|nDCB
suffix:semicolon
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
r_do
(brace
id|nDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Free DCB (ID %i, LUN %i): %p&bslash;n&quot;
comma
"&bslash;"
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB
)paren
suffix:semicolon
)paren
singleline_comment|//kfree (pDCB);
id|dc390_remove_dev
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|pDCB
op_assign
id|nDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pDCB
op_logical_and
id|pACB-&gt;pLinkDCB
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|DC390_release
r_int
id|DC390_release
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|DC390_AFLAGS
id|DC390_IFLAGS
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
id|DC390_LOCK_IO
suffix:semicolon
id|DC390_LOCK_ACB
suffix:semicolon
multiline_comment|/* TO DO: We should check for outstanding commands first. */
id|dc390_shutdown
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;irq
op_ne
id|IRQ_NONE
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Free IRQ %i&bslash;n&quot;
comma
id|host-&gt;irq
)paren
suffix:semicolon
)paren
id|free_irq
(paren
id|host-&gt;irq
comma
id|pACB
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
id|host-&gt;n_io_port
)paren
suffix:semicolon
id|dc390_freeDCBs
(paren
id|host
)paren
suffix:semicolon
id|DC390_UNLOCK_ACB
suffix:semicolon
id|DC390_UNLOCK_IO
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* def MODULE */
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,99)
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|DC390_T
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#elif defined(MODULE)
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|DC390_T
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
