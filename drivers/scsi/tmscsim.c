multiline_comment|/***********************************************************************&n; *&t;FILE NAME : TMSCSIM.C&t;&t;&t;&t;&t;       *&n; *&t;     BY   : C.L. Huang,  ching@tekram.com.tw&t;&t;       *&n; *&t;Description: Device Driver for Tekram DC-390(T) PCI SCSI       *&n; *&t;&t;     Bus Master Host Adapter&t;&t;&t;       *&n; * (C)Copyright 1995-1996 Tekram Technology Co., Ltd.&t;&t;       *&n; ***********************************************************************/
multiline_comment|/*&t;Minor enhancements and bugfixes by&t;&t;&t;&t;*&n; *&t;Kurt Garloff &lt;K.Garloff@ping.de&gt;&t;&t;&t;&t;*&n; ***********************************************************************/
multiline_comment|/*&t;HISTORY:&t;&t;&t;&t;&t;&t;&t;*&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; *&t;REV#&t;DATE&t;NAME&t;DESCRIPTION&t;&t;&t;&t;*&n; *&t;1.00  04/24/96&t;CLH&t;First release&t;&t;&t;&t;*&n; *&t;1.01  06/12/96&t;CLH&t;Fixed bug of Media Change for Removable *&n; *&t;&t;&t;&t;Device, scan all LUN. Support Pre2.0.10 *&n; *&t;1.02  06/18/96&t;CLH&t;Fixed bug of Command timeout ...&t;*&n; *&t;1.03  09/25/96&t;KG&t;Added tmscsim_proc_info()&t;&t;*&n; *&t;1.04  10/11/96&t;CLH&t;Updating for support KV 2.0.x&t;&t;*&n; *&t;1.05  10/18/96&t;KG&t;Fixed bug in DC390_abort(null ptr deref)*&n; *&t;1.06  10/25/96&t;KG&t;Fixed module support&t;&t;&t;*&n; *&t;1.07  11/09/96&t;KG&t;Fixed tmscsim_proc_info()&t;&t;*&n; *&t;1.08  11/18/96&t;KG&t;Fixed null ptr in DC390_Disconnect()&t;*&n; *&t;1.09  11/30/96&t;KG&t;Added register the allocated IO space&t;*&n; *&t;1.10  12/05/96&t;CLH&t;Modified tmscsim_proc_info(), and reset *&n; *&t;&t;&t;&t;pending interrupt in DC390_detect()&t;*&n; * &t;1.11  02/05/97&t;KG/CLH&t;Fixeds problem with partitions greater&t;*&n; * &t;&t;&t;&t;than 1GB&t;&t;&t;&t;*&n; *      1.12  15/02/98  MJ      Rewritten PCI probing&t;&t;&t;*&n; ***********************************************************************/
DECL|macro|DC390_DEBUG
mdefine_line|#define DC390_DEBUG
DECL|macro|SCSI_MALLOC
mdefine_line|#define SCSI_MALLOC
macro_line|#ifdef MODULE
macro_line|# include &lt;linux/module.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;tmscsim.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &quot;dc390.h&quot;
DECL|macro|PCI_DEVICE_ID_AMD53C974
mdefine_line|#define PCI_DEVICE_ID_AMD53C974 &t;PCI_DEVICE_ID_AMD_SCSI
DECL|variable|proc_scsi_tmscsim
r_struct
id|proc_dir_entry
id|proc_scsi_tmscsim
op_assign
initialization_block
suffix:semicolon
r_static
id|USHORT
id|DC390_StartSCSI
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DC390_DataOut_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_DataIn_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_Command_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_Status_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_MsgOut_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_MsgIn_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_DataOutPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_DataInPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_CommandPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_StatusPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_MsgOutPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_MsgInPhase
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_Nop_0
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|DC390_Nop_1
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
comma
id|PUCHAR
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|SetXferRate
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
suffix:semicolon
r_static
r_void
id|DC390_Disconnect
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|DC390_Reselect
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|SRBdone
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DoingSRB_Done
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|DC390_ScsiRstDetect
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|DC390_ResetSCSIBus
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|RequestSense
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|EnableMsgOut2
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|EnableMsgOut
c_func
(paren
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DC390_InvalidCmd
c_func
(paren
id|PACB
id|pACB
)paren
suffix:semicolon
r_int
id|DC390_initAdapter
c_func
(paren
id|PSH
id|psh
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|USHORT
id|index
)paren
suffix:semicolon
r_void
id|DC390_initDCB
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSCSICMD
id|cmd
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_int
id|DC390_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
r_static
r_int
id|DC390_shutdown
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|pSHT_start
r_static
id|PSHT
id|pSHT_start
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pSH_start
r_static
id|PSH
id|pSH_start
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pSH_current
r_static
id|PSH
id|pSH_current
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pACB_start
r_static
id|PACB
id|pACB_start
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pACB_current
r_static
id|PACB
id|pACB_current
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pPrevDCB
r_static
id|PDCB
id|pPrevDCB
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|adapterCnt
r_static
id|USHORT
id|adapterCnt
op_assign
l_int|0
suffix:semicolon
DECL|variable|InitialTime
r_static
id|USHORT
id|InitialTime
op_assign
l_int|0
suffix:semicolon
DECL|variable|CurrSyncOffset
r_static
id|USHORT
id|CurrSyncOffset
op_assign
l_int|0
suffix:semicolon
DECL|variable|DC390_phase0
r_static
id|PVOID
id|DC390_phase0
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|DC390_phase1
r_static
id|PVOID
id|DC390_phase1
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|eepromBuf
id|UCHAR
id|eepromBuf
(braket
id|MAX_ADAPTER_NUM
)braket
(braket
l_int|128
)braket
suffix:semicolon
DECL|variable|clock_period1
id|UCHAR
id|clock_period1
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|10
comma
l_int|13
comma
l_int|20
)brace
suffix:semicolon
DECL|variable|baddevname1
id|UCHAR
id|baddevname1
(braket
l_int|2
)braket
(braket
l_int|28
)braket
op_assign
initialization_block
suffix:semicolon
DECL|macro|BADDEVCNT
mdefine_line|#define BADDEVCNT&t;2
multiline_comment|/***********************************************************************&n; *&n; *&n; *&n; **********************************************************************/
r_static
r_void
DECL|function|QLinkcmd
id|QLinkcmd
c_func
(paren
id|PSCSICMD
id|cmd
comma
id|PDCB
id|pDCB
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|PSCSICMD
id|pcmd
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;QIORBCnt
)paren
(brace
id|pDCB-&gt;pQIORBhead
op_assign
id|cmd
suffix:semicolon
id|pDCB-&gt;pQIORBtail
op_assign
id|cmd
suffix:semicolon
id|pDCB-&gt;QIORBCnt
op_increment
suffix:semicolon
id|cmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pcmd
op_assign
id|pDCB-&gt;pQIORBtail
suffix:semicolon
id|pcmd-&gt;next
op_assign
id|cmd
suffix:semicolon
id|pDCB-&gt;pQIORBtail
op_assign
id|cmd
suffix:semicolon
id|pDCB-&gt;QIORBCnt
op_increment
suffix:semicolon
id|cmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
id|PSCSICMD
DECL|function|Getcmd
id|Getcmd
c_func
(paren
id|PDCB
id|pDCB
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|PSCSICMD
id|pcmd
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pcmd
op_assign
id|pDCB-&gt;pQIORBhead
suffix:semicolon
id|pDCB-&gt;pQIORBhead
op_assign
id|pcmd-&gt;next
suffix:semicolon
id|pcmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;QIORBCnt
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|pcmd
suffix:semicolon
)brace
r_static
id|PSRB
DECL|function|GetSRB
id|GetSRB
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|pSRB
suffix:semicolon
)brace
r_static
r_void
DECL|function|RewaitSRB0
id|RewaitSRB0
c_func
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|PSRB
id|psrb1
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|psrb1
op_assign
id|pDCB-&gt;pWaitingSRB
)paren
)paren
(brace
id|pSRB-&gt;pNextSRB
op_assign
id|psrb1
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|RewaitSRB
id|RewaitSRB
c_func
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
id|PSRB
id|psrb1
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
id|UCHAR
id|bval
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_decrement
suffix:semicolon
id|psrb1
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|psrb1
)paren
(brace
id|pDCB-&gt;pGoingSRB
op_assign
id|psrb1-&gt;pNextSRB
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pSRB
op_ne
id|psrb1-&gt;pNextSRB
)paren
(brace
id|psrb1
op_assign
id|psrb1-&gt;pNextSRB
suffix:semicolon
)brace
id|psrb1-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingLast
)paren
(brace
id|pDCB-&gt;pGoingLast
op_assign
id|psrb1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|psrb1
op_assign
id|pDCB-&gt;pWaitingSRB
)paren
)paren
(brace
id|pSRB-&gt;pNextSRB
op_assign
id|psrb1
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
)brace
id|bval
op_assign
id|pSRB-&gt;TagNumber
suffix:semicolon
id|pDCB-&gt;TagMask
op_and_assign
(paren
op_complement
(paren
l_int|1
op_lshift
id|bval
)paren
)paren
suffix:semicolon
multiline_comment|/* Free TAG number */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|DoWaitingSRB
id|DoWaitingSRB
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|PDCB
id|ptr
comma
id|ptr1
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_and
op_logical_neg
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
id|ptr
op_assign
id|pACB-&gt;pDCBRunRobin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
id|ptr
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr
suffix:semicolon
)brace
id|ptr1
op_assign
id|ptr
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|ptr1
suffix:semicolon
)paren
(brace
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ptr1-&gt;MaxCommand
OG
id|ptr1-&gt;GoingSRBCnt
)paren
op_logical_or
op_logical_neg
(paren
id|pSRB
op_assign
id|ptr1-&gt;pWaitingSRB
)paren
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;pDCBRunRobin
op_eq
id|ptr
)paren
(brace
r_break
suffix:semicolon
)brace
id|ptr1
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|DC390_StartSCSI
c_func
(paren
id|pACB
comma
id|ptr1
comma
id|pSRB
)paren
)paren
(brace
id|ptr1-&gt;GoingSRBCnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ptr1-&gt;pWaitLast
op_eq
id|pSRB
)paren
(brace
id|ptr1-&gt;pWaitingSRB
op_assign
l_int|NULL
suffix:semicolon
id|ptr1-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|ptr1-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
)brace
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ptr1-&gt;pGoingSRB
)paren
(brace
id|ptr1-&gt;pGoingLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
id|ptr1-&gt;pGoingSRB
op_assign
id|pSRB
suffix:semicolon
id|ptr1-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|SRBwaiting
id|SRBwaiting
c_func
(paren
id|PDCB
id|pDCB
comma
id|PSRB
id|pSRB
)paren
(brace
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pDCB-&gt;pWaitLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|SendSRB
id|SendSRB
c_func
(paren
id|PSCSICMD
id|pcmd
comma
id|PACB
id|pACB
comma
id|PSRB
id|pSRB
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|PDCB
id|pDCB
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;MaxCommand
OG
id|pDCB-&gt;GoingSRBCnt
)paren
op_logical_or
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
id|SRBwaiting
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_goto
id|SND_EXIT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|SRBwaiting
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*&t;pSRB = GetWaitingSRB(pDCB); */
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|DC390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
(brace
id|pDCB-&gt;GoingSRBCnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;pGoingSRB
)paren
(brace
id|pDCB-&gt;pGoingLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
(brace
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
)brace
)brace
r_else
id|RewaitSRB0
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|SND_EXIT
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC390_queue_command (Scsi_Cmnd *cmd,&n; *&t;&t;&t;&t;&t;       void (*done)(Scsi_Cmnd *))&n; *&n; * Purpose : enqueues a SCSI command&n; *&n; * Inputs : cmd - SCSI command, done - function called on completion, with&n; *&t;    a pointer to the command descriptor.&n; *&n; * Returns : 0&n; *&n; ***********************************************************************/
r_int
DECL|function|DC390_queue_command
id|DC390_queue_command
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|USHORT
id|ioport
comma
id|i
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|psh
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
id|PDCB
id|pDCB
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
id|PUCHAR
id|ptr
comma
id|ptr1
suffix:semicolon
id|psh
op_assign
id|cmd-&gt;host
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
id|ioport
op_assign
id|pACB-&gt;IOPortBase
suffix:semicolon
macro_line|#ifdef DC390_DEBUG0
multiline_comment|/*  if(pACB-&gt;scan_devices) */
id|printk
c_func
(paren
l_string|&quot;Cmd=%2x,ID=%d,LUN=%d,&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pACB-&gt;scan_devices
op_eq
id|END_SCAN
)paren
op_logical_and
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|INQUIRY
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pACB-&gt;scan_devices
)paren
op_logical_and
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|8
)paren
)paren
(brace
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cmd-&gt;target
OG
id|pACB-&gt;max_id
)paren
op_logical_or
(paren
id|cmd-&gt;lun
OG
id|pACB-&gt;max_lun
)paren
)paren
(brace
multiline_comment|/*&t;printk(&quot;DC390: Ignore target %d lun %d&bslash;n&quot;,&n;&t;&t;cmd-&gt;target, cmd-&gt;lun); */
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pACB-&gt;scan_devices
)paren
op_logical_and
op_logical_neg
(paren
id|pACB-&gt;DCBmap
(braket
id|cmd-&gt;target
)braket
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;DeviceCnt
OL
id|MAX_DEVICES
)paren
(brace
id|pACB-&gt;DCBmap
(braket
id|cmd-&gt;target
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pDCB_free
suffix:semicolon
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;pDCB=%8x,ID=%2x,&quot;
comma
(paren
id|UINT
)paren
id|pDCB
comma
id|cmd-&gt;target
)paren
suffix:semicolon
macro_line|#endif
id|DC390_initDCB
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|cmd
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* ???? */
(brace
multiline_comment|/*&t;    printk(&quot;DC390: Ignore target %d lun %d&bslash;n&quot;,&n;&t;&t;    cmd-&gt;target, cmd-&gt;lun); */
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;scan_devices
)paren
op_logical_and
op_logical_neg
(paren
id|pACB-&gt;DCBmap
(braket
id|cmd-&gt;target
)braket
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
)paren
)paren
(brace
multiline_comment|/*&t;printk(&quot;DC390: Ignore target %d lun %d&bslash;n&quot;,&n;&t;&t;cmd-&gt;target, cmd-&gt;lun); */
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pDCB-&gt;UnitSCSIID
op_ne
id|cmd-&gt;target
)paren
op_logical_or
(paren
id|pDCB-&gt;UnitSCSILUN
op_ne
id|cmd-&gt;lun
)paren
)paren
(brace
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;pDCB=%8x,ID=%2x,&quot;
comma
(paren
id|UINT
)paren
id|pDCB
comma
id|cmd-&gt;target
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;QIORBCnt
)paren
(brace
id|QLinkcmd
c_func
(paren
id|cmd
comma
id|pDCB
)paren
suffix:semicolon
id|pcmd
op_assign
id|Getcmd
c_func
(paren
id|pDCB
)paren
suffix:semicolon
)brace
r_else
id|pcmd
op_assign
id|cmd
suffix:semicolon
id|pSRB
op_assign
id|GetSRB
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
id|QLinkcmd
c_func
(paren
id|pcmd
comma
id|pDCB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  BuildSRB(pSRB); */
id|pSRB-&gt;pSRBDCB
op_assign
id|pDCB
suffix:semicolon
id|pSRB-&gt;pcmd
op_assign
id|pcmd
suffix:semicolon
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|pSRB-&gt;CmdBlock
suffix:semicolon
id|ptr1
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;cmnd
suffix:semicolon
id|pSRB-&gt;ScsiCmdLen
op_assign
id|pcmd-&gt;cmd_len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pcmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|ptr
op_assign
op_star
id|ptr1
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|ptr1
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
(paren
id|UCHAR
)paren
id|pcmd-&gt;use_sg
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevType
op_ne
id|TYPE_TAPE
)paren
(brace
id|pSRB-&gt;RetryCnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pSRB-&gt;RetryCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGPhysAddr
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;EndMessage
op_assign
l_int|0
suffix:semicolon
id|SendSRB
c_func
(paren
id|pcmd
comma
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|DoNextCmd
id|DoNextCmd
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
)paren
(brace
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
id|PSRB
id|pSRB
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
id|PUCHAR
id|ptr
comma
id|ptr1
suffix:semicolon
id|USHORT
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pcmd
op_assign
id|Getcmd
c_func
(paren
id|pDCB
)paren
suffix:semicolon
id|pSRB
op_assign
id|GetSRB
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
id|QLinkcmd
c_func
(paren
id|pcmd
comma
id|pDCB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pSRB-&gt;pSRBDCB
op_assign
id|pDCB
suffix:semicolon
id|pSRB-&gt;pcmd
op_assign
id|pcmd
suffix:semicolon
id|ptr
op_assign
(paren
id|PUCHAR
)paren
id|pSRB-&gt;CmdBlock
suffix:semicolon
id|ptr1
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;cmnd
suffix:semicolon
id|pSRB-&gt;ScsiCmdLen
op_assign
id|pcmd-&gt;cmd_len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pcmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|ptr
op_assign
op_star
id|ptr1
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|ptr1
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
(paren
id|UCHAR
)paren
id|pcmd-&gt;use_sg
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
(brace
id|pSRB-&gt;SGcount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
id|PSGL
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
id|pSRB-&gt;Segmentx.address
op_assign
(paren
id|PUCHAR
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;Segmentx.length
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevType
op_ne
id|TYPE_TAPE
)paren
(brace
id|pSRB-&gt;RetryCnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pSRB-&gt;RetryCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGPhysAddr
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;EndMessage
op_assign
l_int|0
suffix:semicolon
id|SendSRB
c_func
(paren
id|pcmd
comma
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function:&n; *   DC390_bios_param&n; *&n; * Description:&n; *   Return the disk geometry for the given SCSI device.&n; ***********************************************************************/
DECL|function|DC390_bios_param
r_int
id|DC390_bios_param
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|devno
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pACB-&gt;Gmode2
op_amp
id|GREATER_1G
)paren
op_logical_and
(paren
id|cylinders
OG
l_int|1024
)paren
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : int DC390_abort (Scsi_Cmnd *cmd)&n; *&n; * Purpose : Abort an errant SCSI command&n; *&n; * Inputs : cmd - command to abort&n; *&n; * Returns : 0 on success, -1 on failure.&n; ***********************************************************************/
r_int
DECL|function|DC390_abort
id|DC390_abort
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
id|PDCB
id|pDCB
comma
id|pdcb
suffix:semicolon
id|PSRB
id|pSRB
comma
id|psrb
suffix:semicolon
id|USHORT
id|count
comma
id|i
suffix:semicolon
id|PSCSICMD
id|pcmd
comma
id|pcmd1
suffix:semicolon
r_int
id|status
suffix:semicolon
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390 : Abort Cmd.&quot;
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pDCB-&gt;UnitSCSIID
op_ne
id|cmd-&gt;target
)paren
op_logical_or
(paren
id|pDCB-&gt;UnitSCSILUN
op_ne
id|cmd-&gt;lun
)paren
)paren
(brace
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pdcb
)paren
(brace
r_goto
id|NOT_RUN
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pDCB-&gt;QIORBCnt
)paren
(brace
id|pcmd
op_assign
id|pDCB-&gt;pQIORBhead
suffix:semicolon
r_if
c_cond
(paren
id|pcmd
op_eq
id|cmd
)paren
(brace
id|pDCB-&gt;pQIORBhead
op_assign
id|pcmd-&gt;next
suffix:semicolon
id|pcmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;QIORBCnt
op_decrement
suffix:semicolon
id|status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
r_for
c_loop
(paren
id|count
op_assign
id|pDCB-&gt;QIORBCnt
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pcmd-&gt;next
op_eq
id|cmd
)paren
(brace
id|pcmd1
op_assign
id|pcmd-&gt;next
suffix:semicolon
id|pcmd-&gt;next
op_assign
id|pcmd1-&gt;next
suffix:semicolon
id|pcmd1-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;QIORBCnt
op_decrement
suffix:semicolon
id|status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
r_else
(brace
id|pcmd
op_assign
id|pcmd-&gt;next
suffix:semicolon
)brace
)brace
)brace
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
r_goto
id|ON_GOING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSRB-&gt;pcmd
op_eq
id|cmd
)paren
(brace
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_goto
id|IN_WAIT
suffix:semicolon
)brace
r_else
(brace
id|psrb
op_assign
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|psrb-&gt;pNextSRB
)paren
)paren
(brace
r_goto
id|ON_GOING
suffix:semicolon
)brace
r_while
c_loop
(paren
id|psrb-&gt;pNextSRB-&gt;pcmd
op_ne
id|cmd
)paren
(brace
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|psrb-&gt;pNextSRB
)paren
)paren
(brace
r_goto
id|ON_GOING
suffix:semicolon
)brace
)brace
id|pSRB
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
id|psrb-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pWaitLast
)paren
(brace
id|pDCB-&gt;pWaitLast
op_assign
id|psrb
suffix:semicolon
)brace
multiline_comment|/* No check for psrb == NULL ? */
id|IN_WAIT
suffix:colon
id|pSRB-&gt;pNextSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB
suffix:semicolon
id|cmd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
id|ON_GOING
suffix:colon
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
id|pDCB-&gt;GoingSRBCnt
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;pcmd
op_ne
id|cmd
)paren
(brace
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pACB-&gt;pActiveDCB
op_eq
id|pDCB
)paren
op_logical_and
(paren
id|pDCB-&gt;pActiveSRB
op_eq
id|pSRB
)paren
)paren
(brace
id|status
op_assign
id|SCSI_ABORT_BUSY
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_goto
id|ABO_X
suffix:semicolon
)brace
)brace
)brace
id|NOT_RUN
suffix:colon
id|status
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
id|ABO_X
suffix:colon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_void
DECL|function|ResetDevParam
id|ResetDevParam
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|pDCB
comma
id|pdcb
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_and_assign
id|NEGATE_REQACKDATA
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_or_assign
id|EATER_25NS
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|RecoverSRB
id|RecoverSRB
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|PDCB
id|pDCB
comma
id|pdcb
suffix:semicolon
id|PSRB
id|psrb
comma
id|psrb2
suffix:semicolon
id|USHORT
id|cnt
comma
id|i
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|cnt
op_assign
id|pdcb-&gt;GoingSRBCnt
suffix:semicolon
id|psrb
op_assign
id|pdcb-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psrb2
op_assign
id|psrb
suffix:semicolon
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
multiline_comment|/*&t;    RewaitSRB( pDCB, psrb ); */
r_if
c_cond
(paren
id|pdcb-&gt;pWaitingSRB
)paren
(brace
id|psrb2-&gt;pNextSRB
op_assign
id|pdcb-&gt;pWaitingSRB
suffix:semicolon
id|pdcb-&gt;pWaitingSRB
op_assign
id|psrb2
suffix:semicolon
)brace
r_else
(brace
id|pdcb-&gt;pWaitingSRB
op_assign
id|psrb2
suffix:semicolon
id|pdcb-&gt;pWaitLast
op_assign
id|psrb2
suffix:semicolon
id|psrb2-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|pdcb-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pdcb-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pdcb-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pdcb
op_assign
id|pdcb-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : int DC390_reset (Scsi_Cmnd *cmd, ...)&n; *&n; * Purpose : perform a hard reset on the SCSI bus&n; *&n; * Inputs : cmd - command which caused the SCSI RESET&n; *&n; * Returns : 0 on success.&n; ***********************************************************************/
DECL|function|DC390_reset
r_int
id|DC390_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|resetFlags
)paren
(brace
id|USHORT
id|ioport
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
id|UCHAR
id|bval
suffix:semicolon
id|USHORT
id|i
suffix:semicolon
macro_line|#ifdef DC390_DEBUG1
id|printk
c_func
(paren
l_string|&quot;DC390: RESET,&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pACB
op_assign
(paren
id|PACB
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|ioport
op_assign
id|pACB-&gt;IOPortBase
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
id|bval
op_or_assign
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
multiline_comment|/* disable interrupt */
id|DC390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|500
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
id|bval
op_assign
id|inb
c_func
(paren
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
id|bval
op_and_assign
op_complement
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupt */
id|bval
op_assign
id|DMA_IDLE_CMD
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|DMA_Cmd
)paren
suffix:semicolon
id|bval
op_assign
id|CLEAR_FIFO_CMD
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|ScsiCmd
)paren
suffix:semicolon
id|ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DoingSRB_Done
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|DoWaitingSRB
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef DC390_DEBUG1
id|printk
c_func
(paren
l_string|&quot;DC390: RESET1,&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
macro_line|#include &quot;scsiiom.c&quot;
multiline_comment|/***********************************************************************&n; * Function : static void DC390_initDCB&n; *&n; * Purpose :  initialize the internal structures for a given DCB&n; *&n; * Inputs : cmd - pointer to this scsi cmd request block structure&n; *&n; ***********************************************************************/
DECL|function|DC390_initDCB
r_void
id|DC390_initDCB
c_func
(paren
id|PACB
id|pACB
comma
id|PDCB
id|pDCB
comma
id|PSCSICMD
id|cmd
)paren
(brace
id|PEEprom
id|prom
suffix:semicolon
id|UCHAR
id|bval
suffix:semicolon
id|USHORT
id|index
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;DeviceCnt
op_eq
l_int|0
)paren
(brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pNextDCB
op_assign
id|pDCB
suffix:semicolon
id|pPrevDCB
op_assign
id|pDCB
suffix:semicolon
)brace
r_else
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pDCBACB
op_assign
id|pACB
suffix:semicolon
id|pDCB-&gt;QIORBCnt
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;UnitSCSIID
op_assign
id|cmd-&gt;target
suffix:semicolon
id|pDCB-&gt;UnitSCSILUN
op_assign
id|cmd-&gt;lun
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
id|pDCB-&gt;AdaptIndex
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|index
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_assign
l_int|0
suffix:semicolon
id|prom
op_assign
(paren
id|PEEprom
)paren
op_amp
id|eepromBuf
(braket
id|index
)braket
(braket
id|cmd-&gt;target
op_lshift
l_int|2
)braket
suffix:semicolon
id|pDCB-&gt;DevMode
op_assign
id|prom-&gt;EE_MODE1
suffix:semicolon
id|pDCB-&gt;AdpMode
op_assign
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|EN_DISCONNECT_
)paren
(brace
id|bval
op_assign
l_int|0xC0
suffix:semicolon
)brace
r_else
id|bval
op_assign
l_int|0x80
suffix:semicolon
id|bval
op_or_assign
id|cmd-&gt;lun
suffix:semicolon
id|pDCB-&gt;IdentifyMsg
op_assign
id|bval
suffix:semicolon
id|pDCB-&gt;SyncMode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|SYNC_NEGO_
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd-&gt;lun
)paren
op_logical_or
id|CurrSyncOffset
)paren
(brace
id|pDCB-&gt;SyncMode
op_assign
id|SYNC_ENABLE
suffix:semicolon
)brace
)brace
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
(paren
id|clock_period1
(braket
id|prom-&gt;EE_SPEED
)braket
op_star
l_int|25
)paren
op_rshift
l_int|2
suffix:semicolon
id|pDCB-&gt;CtrlR1
op_assign
id|pACB-&gt;AdaptSCSIID
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|PARITY_CHK_
)paren
(brace
id|pDCB-&gt;CtrlR1
op_or_assign
id|PARITY_ERR_REPO
suffix:semicolon
)brace
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|EATER_25NS
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;AdpMode
op_amp
id|ACTIVE_NEGATION
)paren
(brace
id|pDCB-&gt;CtrlR4
op_or_assign
id|NEGATE_REQACKDATA
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : static void DC390_initSRB&n; *&n; * Purpose :  initialize the internal structures for a given SRB&n; *&n; * Inputs : psrb - pointer to this scsi request block structure&n; *&n; ***********************************************************************/
DECL|function|DC390_initSRB
r_void
id|DC390_initSRB
c_func
(paren
id|PSRB
id|psrb
)paren
(brace
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390 init: %08lx %08lx,&quot;
comma
(paren
id|ULONG
)paren
id|psrb
comma
(paren
id|ULONG
)paren
id|virt_to_bus
c_func
(paren
id|psrb
)paren
)paren
suffix:semicolon
macro_line|#endif
id|psrb-&gt;PhysSRB
op_assign
id|virt_to_bus
c_func
(paren
id|psrb
)paren
suffix:semicolon
)brace
DECL|function|DC390_linkSRB
r_void
id|DC390_linkSRB
c_func
(paren
id|PACB
id|pACB
)paren
(brace
id|USHORT
id|count
comma
id|i
suffix:semicolon
id|PSRB
id|psrb
suffix:semicolon
id|count
op_assign
id|pACB-&gt;SRBCount
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
id|count
op_minus
l_int|1
)paren
(brace
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_else
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|psrb
op_assign
(paren
id|PSRB
)paren
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
)braket
suffix:semicolon
id|DC390_initSRB
c_func
(paren
id|psrb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : static void DC390_initACB&n; *&n; * Purpose :  initialize the internal structures for a given SCSI host&n; *&n; * Inputs : psh - pointer to this host adapter&squot;s structure&n; *&n; ***********************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|DC390_initACB
c_func
(paren
id|PSH
id|psh
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|USHORT
id|index
)paren
)paren
(brace
id|PACB
id|pACB
suffix:semicolon
id|USHORT
id|i
suffix:semicolon
id|psh-&gt;can_queue
op_assign
id|MAX_CMD_QUEUE
suffix:semicolon
id|psh-&gt;cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
id|psh-&gt;this_id
op_assign
(paren
r_int
)paren
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
suffix:semicolon
id|psh-&gt;io_port
op_assign
id|io_port
suffix:semicolon
id|psh-&gt;n_io_port
op_assign
l_int|0x80
suffix:semicolon
id|psh-&gt;irq
op_assign
id|Irq
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
id|psh-&gt;max_id
op_assign
l_int|8
suffix:semicolon
macro_line|#ifdef&t;CONFIG_SCSI_MULTI_LUN
r_if
c_cond
(paren
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|LUN_CHECK
)paren
(brace
id|psh-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
)brace
r_else
macro_line|#endif
id|psh-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
id|pACB-&gt;max_id
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;max_id
op_eq
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
)paren
(brace
id|pACB-&gt;max_id
op_decrement
suffix:semicolon
)brace
macro_line|#ifdef&t;CONFIG_SCSI_MULTI_LUN
r_if
c_cond
(paren
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|LUN_CHECK
)paren
(brace
id|pACB-&gt;max_lun
op_assign
l_int|7
suffix:semicolon
)brace
r_else
macro_line|#endif
id|pACB-&gt;max_lun
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;pScsiHost
op_assign
id|psh
suffix:semicolon
id|pACB-&gt;IOPortBase
op_assign
(paren
id|USHORT
)paren
id|io_port
suffix:semicolon
id|pACB-&gt;pLinkDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pACB-&gt;SRB_array
suffix:semicolon
id|pACB-&gt;SRBCount
op_assign
id|MAX_SRB_CNT
suffix:semicolon
id|pACB-&gt;AdapterIndex
op_assign
id|index
suffix:semicolon
id|pACB-&gt;status
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;AdaptSCSIID
op_assign
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
suffix:semicolon
id|pACB-&gt;HostID_Bit
op_assign
(paren
l_int|1
op_lshift
id|pACB-&gt;AdaptSCSIID
)paren
suffix:semicolon
id|pACB-&gt;AdaptSCSILUN
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;DeviceCnt
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;IRQLevel
op_assign
id|Irq
suffix:semicolon
id|pACB-&gt;TagMaxNum
op_assign
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_TAG_CMD_NUM
)braket
op_lshift
l_int|2
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|pACB-&gt;Gmode2
op_assign
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|LUN_CHECK
)paren
(brace
id|pACB-&gt;LUNchk
op_assign
l_int|1
suffix:semicolon
)brace
id|pACB-&gt;pDCB_free
op_assign
op_amp
id|pACB-&gt;DCB_array
(braket
l_int|0
)braket
suffix:semicolon
id|DC390_linkSRB
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|pACB-&gt;pTmpSRB
op_assign
op_amp
id|pACB-&gt;TmpSRB
suffix:semicolon
id|DC390_initSRB
c_func
(paren
id|pACB-&gt;pTmpSRB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SCSI_ID
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pACB-&gt;DCBmap
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC390_initAdapter&n; *&n; * Purpose :  initialize the SCSI chip ctrl registers&n; *&n; * Inputs : psh - pointer to this host adapter&squot;s structure&n; *&n; ***********************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|DC390_initAdapter
c_func
(paren
id|PSH
id|psh
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
id|USHORT
id|index
)paren
)paren
(brace
id|USHORT
id|ioport
suffix:semicolon
id|UCHAR
id|bval
suffix:semicolon
id|PACB
id|pACB
comma
id|pacb
suffix:semicolon
id|USHORT
id|used_irq
op_assign
l_int|0
suffix:semicolon
id|pacb
op_assign
id|pACB_start
suffix:semicolon
r_if
c_cond
(paren
id|pacb
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
(paren
id|pacb
op_ne
(paren
id|PACB
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pacb-&gt;IRQLevel
op_eq
id|Irq
)paren
(brace
id|used_irq
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|pacb
op_assign
id|pacb-&gt;pNextACB
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|used_irq
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|Irq
comma
id|DC390_Interrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;tmscsim&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DC390: register IRQ error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|request_region
c_func
(paren
id|io_port
comma
id|psh-&gt;n_io_port
comma
l_string|&quot;tmscsim&quot;
)paren
suffix:semicolon
id|ioport
op_assign
(paren
id|USHORT
)paren
id|io_port
suffix:semicolon
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
id|bval
op_assign
id|SEL_TIMEOUT
suffix:semicolon
multiline_comment|/* 250ms selection timeout */
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|Scsi_TimeOut
)paren
suffix:semicolon
id|bval
op_assign
id|CLK_FREQ_40MHZ
suffix:semicolon
multiline_comment|/* Conversion factor = 0 , 40MHz clock */
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|Clk_Factor
)paren
suffix:semicolon
id|bval
op_assign
id|NOP_CMD
suffix:semicolon
multiline_comment|/* NOP cmd - clear command register */
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|ScsiCmd
)paren
suffix:semicolon
id|bval
op_assign
id|EN_FEATURE
op_plus
id|EN_SCSI2_CMD
suffix:semicolon
multiline_comment|/* Enable Feature and SCSI-2 */
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg2
)paren
suffix:semicolon
id|bval
op_assign
id|FAST_CLK
suffix:semicolon
multiline_comment|/* fast clock */
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg3
)paren
suffix:semicolon
id|bval
op_assign
id|EATER_25NS
suffix:semicolon
r_if
c_cond
(paren
id|eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
(brace
id|bval
op_or_assign
id|NEGATE_REQACKDATA
suffix:semicolon
)brace
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg4
)paren
suffix:semicolon
id|bval
op_assign
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
multiline_comment|/* Disable SCSI bus reset interrupt */
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|DC390_EnDisableCE
id|DC390_EnDisableCE
c_func
(paren
id|UCHAR
id|mode
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
id|PUCHAR
id|regval
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|ENABLE_CE
)paren
(brace
op_star
id|regval
op_assign
l_int|0xc0
suffix:semicolon
)brace
r_else
op_star
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|DISABLE_CE
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
r_void
DECL|function|DC390_EEpromOutDI
id|DC390_EEpromOutDI
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|PUCHAR
id|regval
comma
id|USHORT
id|Carry
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|Carry
)paren
(brace
id|bval
op_assign
l_int|0x40
suffix:semicolon
op_star
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|bval
op_or_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
id|UCHAR
DECL|function|DC390_EEpromInDO
id|DC390_EEpromInDO
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0x40
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x00
comma
op_amp
id|bval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_eq
l_int|0x22
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
id|USHORT
DECL|function|EEpromGetData1
id|EEpromGetData1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|UCHAR
id|i
suffix:semicolon
id|UCHAR
id|carryFlag
suffix:semicolon
id|USHORT
id|wval
suffix:semicolon
id|wval
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|wval
op_lshift_assign
l_int|1
suffix:semicolon
id|carryFlag
op_assign
id|DC390_EEpromInDO
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|wval
op_or_assign
id|carryFlag
suffix:semicolon
)brace
r_return
id|wval
suffix:semicolon
)brace
r_void
DECL|function|DC390_Prepare
id|DC390_Prepare
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|PUCHAR
id|regval
comma
id|UCHAR
id|EEpromCmd
)paren
(brace
id|UCHAR
id|i
comma
id|j
suffix:semicolon
id|USHORT
id|carryFlag
suffix:semicolon
id|carryFlag
op_assign
l_int|1
suffix:semicolon
id|j
op_assign
l_int|0x80
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC390_EEpromOutDI
c_func
(paren
id|pdev
comma
id|regval
comma
id|carryFlag
)paren
suffix:semicolon
id|carryFlag
op_assign
(paren
id|EEpromCmd
op_amp
id|j
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|j
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_void
DECL|function|DC390_ReadEEprom
id|DC390_ReadEEprom
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|index
)paren
(brace
id|UCHAR
id|regval
comma
id|cmd
suffix:semicolon
id|PUSHORT
id|ptr
suffix:semicolon
id|USHORT
id|i
suffix:semicolon
id|ptr
op_assign
(paren
id|PUSHORT
)paren
op_amp
id|eepromBuf
(braket
id|index
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|cmd
op_assign
id|EEPROM_READ
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC390_EnDisableCE
c_func
(paren
id|ENABLE_CE
comma
id|pdev
comma
op_amp
id|regval
)paren
suffix:semicolon
id|DC390_Prepare
c_func
(paren
id|pdev
comma
op_amp
id|regval
comma
id|cmd
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|EEpromGetData1
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|cmd
op_increment
suffix:semicolon
id|DC390_EnDisableCE
c_func
(paren
id|DISABLE_CE
comma
id|pdev
comma
op_amp
id|regval
)paren
suffix:semicolon
)brace
)brace
id|USHORT
DECL|function|DC390_CheckEEpromCheckSum
id|DC390_CheckEEpromCheckSum
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|index
)paren
(brace
id|USHORT
id|wval
comma
id|rc
comma
op_star
id|ptr
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|DC390_ReadEEprom
c_func
(paren
id|pdev
comma
id|index
)paren
suffix:semicolon
id|wval
op_assign
l_int|0
suffix:semicolon
id|ptr
op_assign
(paren
id|PUSHORT
)paren
op_amp
id|eepromBuf
(braket
id|index
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_add_assign
l_int|2
comma
id|ptr
op_increment
)paren
(brace
id|wval
op_add_assign
op_star
id|ptr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wval
op_eq
l_int|0x1234
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC390_init (struct Scsi_Host *host)&n; *&n; * Purpose :  initialize the internal structures for a given SCSI host&n; *&n; * Inputs : host - pointer to this host adapter&squot;s structure/&n; *&n; * Preconditions : when this function is called, the chip_type&n; *&t;field of the pACB structure MUST have been set.&n; ***********************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|DC390_init
(paren
id|PSHT
id|psht
comma
id|ULONG
id|io_port
comma
id|UCHAR
id|Irq
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|index
)paren
)paren
(brace
id|PSH
id|psh
suffix:semicolon
id|PACB
id|pACB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DC390_CheckEEpromCheckSum
c_func
(paren
id|pdev
comma
id|index
)paren
)paren
(brace
id|psh
op_assign
id|scsi_register
c_func
(paren
id|psht
comma
r_sizeof
(paren
id|DC390_ACB
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psh
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pSH_start
)paren
(brace
id|pSH_start
op_assign
id|psh
suffix:semicolon
id|pSH_current
op_assign
id|psh
suffix:semicolon
)brace
r_else
(brace
id|pSH_current-&gt;next
op_assign
id|psh
suffix:semicolon
id|pSH_current
op_assign
id|psh
suffix:semicolon
)brace
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390: pSH = %8x,&quot;
comma
(paren
id|UINT
)paren
id|psh
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DC390: Index %02i,&quot;
comma
id|index
)paren
suffix:semicolon
macro_line|#endif
id|DC390_initACB
c_func
(paren
id|psh
comma
id|io_port
comma
id|Irq
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DC390_initAdapter
c_func
(paren
id|psh
comma
id|io_port
comma
id|Irq
comma
id|index
)paren
)paren
(brace
id|pACB
op_assign
(paren
id|PACB
)paren
id|psh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB_start
)paren
(brace
id|pACB_start
op_assign
id|pACB
suffix:semicolon
id|pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
(paren
id|PACB
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|pACB_current-&gt;pNextACB
op_assign
id|pACB
suffix:semicolon
id|pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
(paren
id|PACB
)paren
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390: pACB = %8x, pDCB_array = %8x, pSRB_array = %8x&bslash;n&quot;
comma
(paren
id|UINT
)paren
id|pACB
comma
(paren
id|UINT
)paren
id|pACB-&gt;DCB_array
comma
(paren
id|UINT
)paren
id|pACB-&gt;SRB_array
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DC390: ACB size= %4x, DCB size= %4x, SRB size= %4x&bslash;n&quot;
comma
r_sizeof
(paren
id|DC390_ACB
)paren
comma
r_sizeof
(paren
id|DC390_DCB
)paren
comma
r_sizeof
(paren
id|DC390_SRB
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|pSH_start
op_assign
l_int|NULL
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|psh
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;DC390_init: EEPROM reading error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : int DC390_detect(Scsi_Host_Template *psht)&n; *&n; * Purpose : detects and initializes AMD53C974 SCSI chips&n; *&t;     that were autoprobed, overridden on the LILO command line,&n; *&t;     or specified at compile time.&n; *&n; * Inputs : psht - template for this SCSI adapter&n; *&n; * Returns : number of host adapters detected&n; *&n; ***********************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|DC390_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|psht
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
id|UINT
id|irq
suffix:semicolon
id|UINT
id|io_port
suffix:semicolon
id|USHORT
id|adaptCnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Number of boards detected */
id|psht-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_tmscsim
suffix:semicolon
id|InitialTime
op_assign
l_int|1
suffix:semicolon
id|pSHT_start
op_assign
id|psht
suffix:semicolon
id|pACB_start
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
)paren
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD53C974
comma
id|pdev
)paren
)paren
)paren
(brace
id|io_port
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390: IO_PORT=%4x,IRQ=%x,&bslash;n&quot;
comma
(paren
id|UINT
)paren
id|io_port
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|DC390_init
c_func
(paren
id|psht
comma
id|io_port
comma
id|irq
comma
id|pdev
comma
id|adaptCnt
)paren
)paren
(brace
id|adaptCnt
op_increment
suffix:semicolon
)brace
)brace
id|InitialTime
op_assign
l_int|0
suffix:semicolon
id|adapterCnt
op_assign
id|adaptCnt
suffix:semicolon
r_return
id|adaptCnt
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n; * Function: tmscsim_set_info()&n; *&n; * Purpose: Set adapter info (!)&n; *&n; * Not yet implemented&n; *&n; *******************************************************************/
DECL|function|tmscsim_set_info
r_int
id|tmscsim_set_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|length
comma
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
multiline_comment|/* Currently this is a no-op */
)brace
multiline_comment|/********************************************************************&n; * Function: tmscsim_proc_info(char* buffer, char **start,&n; *&t;&t;&t;     off_t offset, int length, int hostno, int inout)&n; *&n; * Purpose: return SCSI Adapter/Device Info&n; *&n; * Input: buffer: Pointer to a buffer where to write info&n; *&t;  start :&n; *&t;  offset:&n; *&t;  hostno: Host adapter index&n; *&t;  inout : Read (=0) or set(!=0) info&n; *&n; * Output: buffer: contains info&n; *&t;   length; length of info in buffer&n; *&n; * return value: length&n; *&n; ********************************************************************/
multiline_comment|/* KG: proc_info taken from driver aha152x.c */
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) pos += sprintf(pos, ## args)
DECL|macro|YESNO
mdefine_line|#define YESNO(YN)&bslash;&n;if (YN) SPRINTF(&quot; Yes &quot;);&bslash;&n;else SPRINTF(&quot; No  &quot;)
DECL|function|tmscsim_proc_info
r_int
id|tmscsim_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_int
id|dev
comma
id|spd
comma
id|spd1
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
id|PSH
id|shpnt
suffix:semicolon
id|PACB
id|acbpnt
suffix:semicolon
id|PDCB
id|dcbpnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*  Scsi_Cmnd *ptr; */
id|acbpnt
op_assign
id|pACB_start
suffix:semicolon
r_while
c_loop
(paren
id|acbpnt
op_ne
(paren
id|PACB
)paren
op_minus
l_int|1
)paren
(brace
id|shpnt
op_assign
id|acbpnt-&gt;pScsiHost
suffix:semicolon
r_if
c_cond
(paren
id|shpnt-&gt;host_no
op_eq
id|hostno
)paren
r_break
suffix:semicolon
id|acbpnt
op_assign
id|acbpnt-&gt;pNextACB
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acbpnt
op_eq
(paren
id|PACB
)paren
op_minus
l_int|1
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inout
)paren
(brace
multiline_comment|/* Has data been written to the file ? */
r_return
id|tmscsim_set_info
c_func
(paren
id|buffer
comma
id|length
comma
id|shpnt
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;Tekram DC390(T) PCI SCSI Host Adadpter, &quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Driver Version 1.12, 1998/02/25&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSI Host Nr %i, &quot;
comma
id|shpnt-&gt;host_no
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DC390 Adapter Nr %i&bslash;n&quot;
comma
id|acbpnt-&gt;AdapterIndex
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IOPortBase 0x%04x, &quot;
comma
id|acbpnt-&gt;IOPortBase
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IRQLevel 0x%02x&bslash;n&quot;
comma
id|acbpnt-&gt;IRQLevel
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;MaxID %i, MaxLUN %i, &quot;
comma
id|acbpnt-&gt;max_id
comma
id|acbpnt-&gt;max_lun
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;AdapterID %i, AdapterLUN %i&bslash;n&quot;
comma
id|acbpnt-&gt;AdaptSCSIID
comma
id|acbpnt-&gt;AdaptSCSILUN
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;TagMaxNum %i, Status %i&bslash;n&quot;
comma
id|acbpnt-&gt;TagMaxNum
comma
id|acbpnt-&gt;status
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Nr of attached devices: %i&bslash;n&quot;
comma
id|acbpnt-&gt;DeviceCnt
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Un ID LUN Prty Sync DsCn SndS TagQ NegoPeriod SyncSpeed SyncOffs&bslash;n&quot;
)paren
suffix:semicolon
id|dcbpnt
op_assign
id|acbpnt-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|acbpnt-&gt;DeviceCnt
suffix:semicolon
id|dev
op_increment
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;%02i %02i  %02i &quot;
comma
id|dev
comma
id|dcbpnt-&gt;UnitSCSIID
comma
id|dcbpnt-&gt;UnitSCSILUN
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcbpnt-&gt;DevMode
op_amp
id|PARITY_CHK_
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcbpnt-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcbpnt-&gt;DevMode
op_amp
id|EN_DISCONNECT_
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcbpnt-&gt;DevMode
op_amp
id|SEND_START_
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcbpnt-&gt;SyncMode
op_amp
id|EN_TAG_QUEUING
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;  %03i ns &quot;
comma
(paren
id|dcbpnt-&gt;NegoPeriod
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcbpnt-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
(brace
id|spd
op_assign
l_int|1000
op_div
(paren
id|dcbpnt-&gt;NegoPeriod
op_lshift
l_int|2
)paren
suffix:semicolon
id|spd1
op_assign
l_int|1000
op_mod
(paren
id|dcbpnt-&gt;NegoPeriod
op_lshift
l_int|2
)paren
suffix:semicolon
id|spd1
op_assign
(paren
id|spd1
op_star
l_int|10
)paren
op_div
(paren
id|dcbpnt-&gt;NegoPeriod
op_lshift
l_int|2
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;   %2i.%1i M      %02i&bslash;n&quot;
comma
id|spd
comma
id|spd1
comma
(paren
id|dcbpnt-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Add more info ...*/
id|dcbpnt
op_assign
id|dcbpnt-&gt;pNextDCB
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
OL
id|offset
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
OL
id|length
)paren
r_return
id|pos
op_minus
id|buffer
op_minus
id|offset
suffix:semicolon
r_else
r_return
id|length
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/***********************************************************************&n; * Function : static int DC390_shutdown (struct Scsi_Host *host)&n; *&n; * Purpose : does a clean (we hope) shutdown of the SCSI chip.&n; *&t;     Use prior to dumping core, unloading the driver, etc.&n; *&n; * Returns : 0 on success&n; ***********************************************************************/
r_static
r_int
DECL|function|DC390_shutdown
id|DC390_shutdown
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|UCHAR
id|bval
suffix:semicolon
id|USHORT
id|ioport
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|PACB
id|pACB
op_assign
(paren
id|PACB
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
id|ioport
op_assign
(paren
r_int
r_int
)paren
id|pACB-&gt;IOPortBase
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*  pACB-&gt;soft_reset(host); */
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390: shutdown,&quot;
)paren
suffix:semicolon
macro_line|#endif
id|bval
op_assign
id|inb
c_func
(paren
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
id|bval
op_or_assign
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|ioport
op_plus
id|CtrlReg1
)paren
suffix:semicolon
multiline_comment|/* disable interrupt */
id|DC390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|DC390_release
r_int
id|DC390_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_int
id|irq_count
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|tmp
suffix:semicolon
id|DC390_shutdown
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;irq
op_ne
id|IRQ_NONE
)paren
(brace
r_for
c_loop
(paren
id|irq_count
op_assign
l_int|0
comma
id|tmp
op_assign
id|pSH_start
suffix:semicolon
id|tmp
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;irq
op_eq
id|host-&gt;irq
)paren
op_increment
id|irq_count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq_count
op_eq
l_int|1
)paren
(brace
macro_line|#ifdef DC390_DEBUG0
id|printk
c_func
(paren
l_string|&quot;DC390: Free IRQ %i.&quot;
comma
id|host-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
id|host-&gt;n_io_port
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|DC390_T
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif /* def MODULE */
eof
