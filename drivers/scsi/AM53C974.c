macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;AM53C974.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#include &quot;sd.h&quot;
multiline_comment|/* AM53/79C974 (PCscsi) driver release 0.5&n;&n; * The architecture and much of the code of this device&n; * driver was originally developed by Drew Eckhardt for&n; * the NCR5380. The following copyrights apply:&n; *  For the architecture and all pieces of code which can also be found &n; *    in the NCR5380 device driver:&n; *   Copyright 1993, Drew Eckhardt&n; *      Visionary Computing &n; *      (Unix and Linux consulting and custom programming)&n; *      drew@colorado.edu&n; *      +1 (303) 666-5836&n; *&n; *  The AM53C974_nobios_detect code was originally developed by&n; *   Robin Cutshaw (robin@xfree86.org) and is used here in a &n; *   slightly modified form.&n; *&n; *  PCI detection rewritten by Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;&n; *&n; *  For the remaining code:&n; *    Copyright 1994, D. Frieauff&n; *    EMail: fri@rsx42sun0.dofn.de&n; *    Phone: x49-7545-8-2256 , x49-7541-42305&n; */
multiline_comment|/*&n; * $Log: AM53C974.c,v $&n; */
macro_line|#ifdef AM53C974_DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#ifdef AM53C974_DEBUG_KEYWAIT
DECL|macro|KEYWAIT
mdefine_line|#define KEYWAIT() AM53C974_keywait()
macro_line|#else
DECL|macro|KEYWAIT
mdefine_line|#define KEYWAIT()
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_INIT
DECL|macro|DEB_INIT
mdefine_line|#define DEB_INIT(x) x
macro_line|#else
DECL|macro|DEB_INIT
mdefine_line|#define DEB_INIT(x)
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_MSG
DECL|macro|DEB_MSG
mdefine_line|#define DEB_MSG(x) x
macro_line|#else
DECL|macro|DEB_MSG
mdefine_line|#define DEB_MSG(x)
macro_line|#endif
macro_line|#ifdef AM53C974_DEB_RESEL
DECL|macro|DEB_RESEL
mdefine_line|#define DEB_RESEL(x) x
macro_line|#else
DECL|macro|DEB_RESEL
mdefine_line|#define DEB_RESEL(x)
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_QUEUE
DECL|macro|DEB_QUEUE
mdefine_line|#define DEB_QUEUE(x) x
DECL|macro|LIST
mdefine_line|#define LIST(x,y) {printk(&quot;LINE:%d   Adding %p to %p&bslash;n&quot;, __LINE__, (void*)(x), (void*)(y)); if ((x)==(y)) udelay(5); }
DECL|macro|REMOVE
mdefine_line|#define REMOVE(w,x,y,z) {printk(&quot;LINE:%d   Removing: %p-&gt;%p  %p-&gt;%p &bslash;n&quot;, __LINE__, (void*)(w), (void*)(x), (void*)(y), (void*)(z)); if ((x)==(y)) udelay(5); }
macro_line|#else
DECL|macro|DEB_QUEUE
mdefine_line|#define DEB_QUEUE(x)
DECL|macro|LIST
mdefine_line|#define LIST(x,y)
DECL|macro|REMOVE
mdefine_line|#define REMOVE(w,x,y,z)
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_INFO
DECL|macro|DEB_INFO
mdefine_line|#define DEB_INFO(x) x
macro_line|#else
DECL|macro|DEB_INFO
mdefine_line|#define DEB_INFO(x)
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_LINKED
DECL|macro|DEB_LINKED
mdefine_line|#define DEB_LINKED(x) x
macro_line|#else
DECL|macro|DEB_LINKED
mdefine_line|#define DEB_LINKED(x)
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_INTR
DECL|macro|DEB_INTR
mdefine_line|#define DEB_INTR(x) x
macro_line|#else
DECL|macro|DEB_INTR
mdefine_line|#define DEB_INTR(x)
macro_line|#endif
macro_line|#else
DECL|macro|DEB_INIT
mdefine_line|#define DEB_INIT(x)
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|DEB_QUEUE
mdefine_line|#define DEB_QUEUE(x)
DECL|macro|LIST
mdefine_line|#define LIST(x,y)
DECL|macro|REMOVE
mdefine_line|#define REMOVE(w,x,y,z)
DECL|macro|DEB_INFO
mdefine_line|#define DEB_INFO(x)
DECL|macro|DEB_LINKED
mdefine_line|#define DEB_LINKED(x)
DECL|macro|DEB_INTR
mdefine_line|#define DEB_INTR(x)
DECL|macro|DEB_MSG
mdefine_line|#define DEB_MSG(x)
DECL|macro|DEB_RESEL
mdefine_line|#define DEB_RESEL(x)
DECL|macro|KEYWAIT
mdefine_line|#define KEYWAIT()
macro_line|#endif
macro_line|#ifdef AM53C974_DEBUG_ABORT
DECL|macro|DEB_ABORT
mdefine_line|#define DEB_ABORT(x) x
macro_line|#else
DECL|macro|DEB_ABORT
mdefine_line|#define DEB_ABORT(x)
macro_line|#endif
macro_line|#ifdef VERBOSE_AM53C974_DEBUG
DECL|macro|VDEB
mdefine_line|#define VDEB(x) x
macro_line|#else
DECL|macro|VDEB
mdefine_line|#define VDEB(x)
macro_line|#endif
DECL|macro|INSIDE
mdefine_line|#define INSIDE(x,l,h) ( ((x) &gt;= (l)) &amp;&amp; ((x) &lt;= (h)) )
macro_line|#include &lt;scsi/scsicam.h&gt;
multiline_comment|/***************************************************************************************&n;* Default setting of the controller&squot;s SCSI id. Edit and uncomment this only if your    *&n;* BIOS does not correctly initialize the controller&squot;s SCSI id.                         *&n;* If you don&squot;t get a warning during boot, it is correctly initialized.                 *&n;****************************************************************************************/
multiline_comment|/* #define AM53C974_SCSI_ID 7 */
multiline_comment|/***************************************************************************************&n;* Default settings for sync. negotiation enable, transfer rate and sync. offset.       *&n;* These settings can be replaced by LILO overrides (append) with the following syntax:          *&n;* AM53C974=host-scsi-id, target-scsi-id, max-rate, max-offset                          *&n;* Sync. negotiation is disabled by default and will be enabled for those targets which *&n;* are specified in the LILO override                                                   *&n;****************************************************************************************/
DECL|macro|DEFAULT_SYNC_NEGOTIATION_ENABLED
mdefine_line|#define DEFAULT_SYNC_NEGOTIATION_ENABLED 0&t;/* 0 or 1 */
DECL|macro|DEFAULT_RATE
mdefine_line|#define DEFAULT_RATE&t;&t;&t; 5&t;/* MHz, min: 3; max: 10 */
DECL|macro|DEFAULT_SYNC_OFFSET
mdefine_line|#define DEFAULT_SYNC_OFFSET&t;&t; 0&t;/* bytes, min: 0; max: 15; use 0 for async. mode */
multiline_comment|/***************************************************************************************&n;* If defined, don&squot;t allow targets to disconnect during commands.  This will reduce     *&n;* performance, but may be worthwhile if you suspect the driver of corrupting data when *&n;* a disconnect happens.                                                                *&n;***************************************************************************************/
DECL|macro|AM53C974_PROHIBIT_DISCONNECT
mdefine_line|#define AM53C974_PROHIBIT_DISCONNECT
multiline_comment|/* --------------------- don&squot;t edit below here  --------------------- */
DECL|macro|AM53C974_DRIVER_REVISION_MAJOR
mdefine_line|#define AM53C974_DRIVER_REVISION_MAJOR 0
DECL|macro|AM53C974_DRIVER_REVISION_MINOR
mdefine_line|#define AM53C974_DRIVER_REVISION_MINOR 5
DECL|macro|SEPARATOR_LINE
mdefine_line|#define SEPARATOR_LINE  &bslash;&n;&quot;--------------------------------------------------------------------------&bslash;n&quot;
multiline_comment|/* debug control */
multiline_comment|/* #define AM53C974_DEBUG */
multiline_comment|/* #define AM53C974_DEBUG_MSG */
multiline_comment|/* #define AM53C974_DEBUG_KEYWAIT */
multiline_comment|/* #define AM53C974_DEBUG_INIT */
multiline_comment|/* #define AM53C974_DEBUG_QUEUE */
multiline_comment|/* #define AM53C974_DEBUG_INFO */
multiline_comment|/* #define AM53C974_DEBUG_LINKED */
multiline_comment|/* #define VERBOSE_AM53C974_DEBUG */
multiline_comment|/* #define AM53C974_DEBUG_INTR */
multiline_comment|/* #define AM53C974_DEB_RESEL */
DECL|macro|AM53C974_DEBUG_ABORT
mdefine_line|#define AM53C974_DEBUG_ABORT
multiline_comment|/* #define AM53C974_OPTION_DEBUG_PROBE_ONLY */
multiline_comment|/* special options/constants */
DECL|macro|DEF_CLK
mdefine_line|#define DEF_CLK                 40&t;/* chip clock freq. in MHz */
DECL|macro|MIN_PERIOD
mdefine_line|#define MIN_PERIOD               4&t;/* for negotiation: min. number of clocks per cycle */
DECL|macro|MAX_PERIOD
mdefine_line|#define MAX_PERIOD              13&t;/* for negotiation: max. number of clocks per cycle */
DECL|macro|MAX_OFFSET
mdefine_line|#define MAX_OFFSET              15&t;/* for negotiation: max. offset (0=async) */
DECL|macro|DEF_SCSI_TIMEOUT
mdefine_line|#define DEF_SCSI_TIMEOUT        245&t;/* STIMREG value, 40 Mhz */
DECL|macro|DEF_STP
mdefine_line|#define DEF_STP                 8&t;/* STPREG value assuming 5.0 MB/sec, FASTCLK, FASTSCSI */
DECL|macro|DEF_SOF_RAD
mdefine_line|#define DEF_SOF_RAD             0&t;/* REQ/ACK deassertion delay */
DECL|macro|DEF_SOF_RAA
mdefine_line|#define DEF_SOF_RAA             0&t;/* REQ/ACK assertion delay */
DECL|macro|DEF_ETM
mdefine_line|#define DEF_ETM                 0&t;/* CNTLREG1, ext. timing mode */
DECL|macro|DEF_PERE
mdefine_line|#define DEF_PERE                1&t;/* CNTLREG1, parity error reporting */
DECL|macro|DEF_CLKF
mdefine_line|#define DEF_CLKF                0&t;/* CLKFREG,  0=40 Mhz */
DECL|macro|DEF_ENF
mdefine_line|#define DEF_ENF                 1&t;/* CNTLREG2, enable features */
DECL|macro|DEF_ADIDCHK
mdefine_line|#define DEF_ADIDCHK             0&t;/* CNTLREG3, additional ID check */
DECL|macro|DEF_FASTSCSI
mdefine_line|#define DEF_FASTSCSI            1&t;/* CNTLREG3, fast SCSI */
DECL|macro|DEF_FASTCLK
mdefine_line|#define DEF_FASTCLK             1&t;/* CNTLREG3, fast clocking, 5 MB/sec at 40MHz chip clk */
DECL|macro|DEF_GLITCH
mdefine_line|#define DEF_GLITCH              1&t;/* CNTLREG4, glitch eater, 0=12ns, 1=35ns, 2=25ns, 3=off */
DECL|macro|DEF_PWD
mdefine_line|#define DEF_PWD                 0&t;/* CNTLREG4, reduced power feature */
DECL|macro|DEF_RAE
mdefine_line|#define DEF_RAE                 0&t;/* CNTLREG4, RAE active negation on REQ, ACK only */
DECL|macro|DEF_RADE
mdefine_line|#define DEF_RADE                1&t;/* 1CNTLREG4, active negation on REQ, ACK and data */
multiline_comment|/*** SCSI block ***/
DECL|macro|CTCLREG
mdefine_line|#define CTCLREG&t;&t;    &t;0x00&t;/* r      current transf. count, low byte    */
DECL|macro|CTCMREG
mdefine_line|#define CTCMREG&t;&t;   &t;0x04&t;/* r      current transf. count, middle byte */
DECL|macro|CTCHREG
mdefine_line|#define CTCHREG&t;&t;    &t;0x38&t;/* r      current transf. count, high byte   */
DECL|macro|STCLREG
mdefine_line|#define STCLREG&t;&t;    &t;0x00&t;/* w      start transf. count, low byte      */
DECL|macro|STCMREG
mdefine_line|#define STCMREG&t;&t;    &t;0x04&t;/* w      start transf. count, middle byte   */
DECL|macro|STCHREG
mdefine_line|#define STCHREG&t;&t;    &t;0x38&t;/* w      start transf. count, high byte     */
DECL|macro|FFREG
mdefine_line|#define FFREG&t;&t;    &t;0x08&t;/* rw     SCSI FIFO reg.                     */
DECL|macro|STIMREG
mdefine_line|#define STIMREG&t;&t;    &t;0x14&t;/* w      SCSI timeout reg.                  */
DECL|macro|SDIDREG
mdefine_line|#define SDIDREG&t;&t;    &t;0x10&t;/* w      SCSI destination ID reg.           */
DECL|macro|SDIREG_MASK
mdefine_line|#define SDIREG_MASK&t;&t;0x07&t;/* mask                                      */
DECL|macro|STPREG
mdefine_line|#define STPREG&t;&t;    &t;0x18&t;/* w      synchronous transf. period reg.    */
DECL|macro|STPREG_STP
mdefine_line|#define STPREG_STP&t;&t;0x1F&t;/* synchr. transfer period                   */
DECL|macro|CLKFREG
mdefine_line|#define CLKFREG&t;&t;    &t;0x24&t;/* w      clock factor reg.                  */
DECL|macro|CLKFREG_MASK
mdefine_line|#define CLKFREG_MASK&t;&t;0x07&t;/* mask                                      */
DECL|macro|CMDREG
mdefine_line|#define CMDREG&t;&t;    &t;0x0C&t;/* rw     SCSI command reg.                  */
DECL|macro|CMDREG_DMA
mdefine_line|#define CMDREG_DMA         &t;0x80&t;/* set DMA mode (set together with opcodes below) */
DECL|macro|CMDREG_IT
mdefine_line|#define CMDREG_IT          &t;0x10&t;/* information transfer              */
DECL|macro|CMDREG_ICCS
mdefine_line|#define CMDREG_ICCS&t;&t;0x11&t;/* initiator command complete steps          */
DECL|macro|CMDREG_MA
mdefine_line|#define CMDREG_MA&t;&t;0x12&t;/* message accepted                          */
DECL|macro|CMDREG_TPB
mdefine_line|#define CMDREG_TPB&t;&t;0x98&t;/* transfer pad bytes, DMA mode only         */
DECL|macro|CMDREG_SATN
mdefine_line|#define CMDREG_SATN&t;&t;0x1A&t;/* set ATN                                   */
DECL|macro|CMDREG_RATN
mdefine_line|#define CMDREG_RATN&t;&t;0x1B&t;/* reset ATN                                 */
DECL|macro|CMDREG_SOAS
mdefine_line|#define CMDREG_SOAS&t;&t;0x41&t;/* select without ATN steps                  */
DECL|macro|CMDREG_SAS
mdefine_line|#define CMDREG_SAS&t;&t;0x42&t;/* select with ATN steps (1 msg byte)        */
DECL|macro|CMDREG_SASS
mdefine_line|#define CMDREG_SASS&t;&t;0x43&t;/* select with ATN and stop steps            */
DECL|macro|CMDREG_ESR
mdefine_line|#define CMDREG_ESR&t;&t;0x44&t;/* enable selection/reselection      */
DECL|macro|CMDREG_DSR
mdefine_line|#define CMDREG_DSR&t;&t;0x45&t;/* disable selection/reselection     */
DECL|macro|CMDREG_SA3S
mdefine_line|#define CMDREG_SA3S&t;&t;0x46&t;/* select with ATN 3 steps  (3 msg bytes)  */
DECL|macro|CMDREG_NOP
mdefine_line|#define CMDREG_NOP&t;&t;0x00&t;/* no operation                      */
DECL|macro|CMDREG_CFIFO
mdefine_line|#define CMDREG_CFIFO&t;&t;0x01&t;/* clear FIFO                                */
DECL|macro|CMDREG_RDEV
mdefine_line|#define CMDREG_RDEV&t;&t;0x02&t;/* reset device                      */
DECL|macro|CMDREG_RBUS
mdefine_line|#define CMDREG_RBUS&t;&t;0x03&t;/* reset SCSI bus                            */
DECL|macro|STATREG
mdefine_line|#define STATREG&t;&t;    &t;0x10&t;/* r      SCSI status reg.                   */
DECL|macro|STATREG_INT
mdefine_line|#define STATREG_INT&t;&t;0x80&t;/* SCSI interrupt condition detected         */
DECL|macro|STATREG_IOE
mdefine_line|#define STATREG_IOE&t;&t;0x40&t;/* SCSI illegal operation error detected   */
DECL|macro|STATREG_PE
mdefine_line|#define STATREG_PE&t;&t;0x20&t;/* SCSI parity error detected                */
DECL|macro|STATREG_CTZ
mdefine_line|#define STATREG_CTZ&t;&t;0x10&t;/* CTC reg decremented to zero               */
DECL|macro|STATREG_MSG
mdefine_line|#define STATREG_MSG&t;&t;0x04&t;/* SCSI MSG phase (latched?)                 */
DECL|macro|STATREG_CD
mdefine_line|#define STATREG_CD&t;&t;0x02&t;/* SCSI C/D phase (latched?)                 */
DECL|macro|STATREG_IO
mdefine_line|#define STATREG_IO&t;&t;0x01&t;/* SCSI I/O phase (latched?)                 */
DECL|macro|STATREG_PHASE
mdefine_line|#define STATREG_PHASE           0x07&t;/* SCSI phase mask                           */
DECL|macro|INSTREG
mdefine_line|#define INSTREG&t;&t;    &t;0x14&t;/* r      interrupt status reg.              */
DECL|macro|INSTREG_SRST
mdefine_line|#define INSTREG_SRST&t;&t;0x80&t;/* SCSI reset detected                       */
DECL|macro|INSTREG_ICMD
mdefine_line|#define INSTREG_ICMD&t;&t;0x40&t;/* SCSI invalid command detected     */
DECL|macro|INSTREG_DIS
mdefine_line|#define INSTREG_DIS&t;&t;0x20&t;/* target disconnected or sel/resel timeout */
DECL|macro|INSTREG_SR
mdefine_line|#define INSTREG_SR&t;&t;0x10&t;/* device on bus has service request       */
DECL|macro|INSTREG_SO
mdefine_line|#define INSTREG_SO&t;&t;0x08&t;/* successful operation                      */
DECL|macro|INSTREG_RESEL
mdefine_line|#define INSTREG_RESEL&t;&t;0x04&t;/* device reselected as initiator    */
DECL|macro|ISREG
mdefine_line|#define ISREG&t;&t;    &t;0x18&t;/* r      internal state reg.                */
DECL|macro|ISREG_SOF
mdefine_line|#define ISREG_SOF&t;&t;0x08&t;/* synchronous offset flag (act. low)        */
DECL|macro|ISREG_IS
mdefine_line|#define ISREG_IS&t;&t;0x07&t;/* status of intermediate op.                */
DECL|macro|ISREG_OK_NO_STOP
mdefine_line|#define ISREG_OK_NO_STOP        0x04&t;/* selection successful                    */
DECL|macro|ISREG_OK_STOP
mdefine_line|#define ISREG_OK_STOP           0x01&t;/* selection successful                    */
DECL|macro|CFIREG
mdefine_line|#define CFIREG&t;&t;    &t;0x1C&t;/* r      current FIFO/internal state reg.   */
DECL|macro|CFIREG_IS
mdefine_line|#define CFIREG_IS&t;&t;0xE0&t;/* status of intermediate op.                */
DECL|macro|CFIREG_CF
mdefine_line|#define CFIREG_CF&t;&t;0x1F&t;/* number of bytes in SCSI FIFO              */
DECL|macro|SOFREG
mdefine_line|#define SOFREG&t;&t;    &t;0x1C&t;/* w      synchr. offset reg.                */
DECL|macro|SOFREG_RAD
mdefine_line|#define SOFREG_RAD&t;&t;0xC0&t;/* REQ/ACK deassertion delay (sync.)         */
DECL|macro|SOFREG_RAA
mdefine_line|#define SOFREG_RAA&t;&t;0x30&t;/* REQ/ACK assertion delay (sync.)           */
DECL|macro|SOFREG_SO
mdefine_line|#define SOFREG_SO&t;&t;0x0F&t;/* synch. offset (sync.)             */
DECL|macro|CNTLREG1
mdefine_line|#define CNTLREG1&t;    &t;0x20&t;/* rw     control register one               */
DECL|macro|CNTLREG1_ETM
mdefine_line|#define CNTLREG1_ETM&t;&t;0x80&t;/* set extended timing mode                  */
DECL|macro|CNTLREG1_DISR
mdefine_line|#define CNTLREG1_DISR&t;&t;0x40&t;/* disable interrupt on SCSI reset           */
DECL|macro|CNTLREG1_PERE
mdefine_line|#define CNTLREG1_PERE&t;&t;0x10&t;/* enable parity error reporting     */
DECL|macro|CNTLREG1_SID
mdefine_line|#define CNTLREG1_SID&t;&t;0x07&t;/* host adapter SCSI ID                      */
DECL|macro|CNTLREG2
mdefine_line|#define CNTLREG2&t;    &t;0x2C&t;/* rw     control register two               */
DECL|macro|CNTLREG2_ENF
mdefine_line|#define CNTLREG2_ENF&t;&t;0x40&t;/* enable features                           */
DECL|macro|CNTLREG3
mdefine_line|#define CNTLREG3&t;    &t;0x30&t;/* rw     control register three             */
DECL|macro|CNTLREG3_ADIDCHK
mdefine_line|#define CNTLREG3_ADIDCHK&t;0x80&t;/* additional ID check                       */
DECL|macro|CNTLREG3_FASTSCSI
mdefine_line|#define CNTLREG3_FASTSCSI&t;0x10&t;/* fast SCSI                                 */
DECL|macro|CNTLREG3_FASTCLK
mdefine_line|#define CNTLREG3_FASTCLK&t;0x08&t;/* fast SCSI clocking                        */
DECL|macro|CNTLREG4
mdefine_line|#define CNTLREG4&t;    &t;0x34&t;/* rw     control register four              */
DECL|macro|CNTLREG4_GLITCH
mdefine_line|#define CNTLREG4_GLITCH&t;&t;0xC0&t;/* glitch eater                              */
DECL|macro|CNTLREG4_PWD
mdefine_line|#define CNTLREG4_PWD&t;&t;0x20&t;/* reduced power feature             */
DECL|macro|CNTLREG4_RAE
mdefine_line|#define CNTLREG4_RAE&t;&t;0x08&t;/* write only, active negot. ctrl.           */
DECL|macro|CNTLREG4_RADE
mdefine_line|#define CNTLREG4_RADE&t;&t;0x04&t;/* active negot. ctrl.                       */
DECL|macro|CNTLREG4_RES
mdefine_line|#define CNTLREG4_RES&t;&t;0x10&t;/* reserved bit, must be 1                   */
multiline_comment|/*** DMA block ***/
DECL|macro|DMACMD
mdefine_line|#define DMACMD&t;&t;    &t;0x40&t;/* rw     command                            */
DECL|macro|DMACMD_DIR
mdefine_line|#define DMACMD_DIR&t;&t;0x80&t;/* transfer direction (1=read from device) */
DECL|macro|DMACMD_INTE_D
mdefine_line|#define DMACMD_INTE_D&t;&t;0x40&t;/* DMA transfer interrupt enable     */
DECL|macro|DMACMD_INTE_P
mdefine_line|#define DMACMD_INTE_P&t;&t;0x20&t;/* page transfer interrupt enable            */
DECL|macro|DMACMD_MDL
mdefine_line|#define DMACMD_MDL&t;&t;0x10&t;/* map to memory descriptor list     */
DECL|macro|DMACMD_DIAG
mdefine_line|#define DMACMD_DIAG&t;&t;0x04&t;/* diagnostics, set to 0             */
DECL|macro|DMACMD_IDLE
mdefine_line|#define DMACMD_IDLE &t;&t;0x00&t;/* idle cmd                                  */
DECL|macro|DMACMD_BLAST
mdefine_line|#define DMACMD_BLAST&t;&t;0x01&t;/* flush FIFO to memory                      */
DECL|macro|DMACMD_ABORT
mdefine_line|#define DMACMD_ABORT&t;&t;0x02&t;/* terminate DMA                     */
DECL|macro|DMACMD_START
mdefine_line|#define DMACMD_START&t;&t;0x03&t;/* start DMA                                 */
DECL|macro|DMASTATUS
mdefine_line|#define DMASTATUS&t;      &t;0x54&t;/* r      status register                    */
DECL|macro|DMASTATUS_BCMPLT
mdefine_line|#define DMASTATUS_BCMPLT&t;0x20&t;/* BLAST complete                    */
DECL|macro|DMASTATUS_SCSIINT
mdefine_line|#define DMASTATUS_SCSIINT&t;0x10&t;/* SCSI interrupt pending            */
DECL|macro|DMASTATUS_DONE
mdefine_line|#define DMASTATUS_DONE&t;&t;0x08&t;/* DMA transfer terminated                   */
DECL|macro|DMASTATUS_ABORT
mdefine_line|#define DMASTATUS_ABORT&t;&t;0x04&t;/* DMA transfer aborted                      */
DECL|macro|DMASTATUS_ERROR
mdefine_line|#define DMASTATUS_ERROR&t;&t;0x02&t;/* DMA transfer error                        */
DECL|macro|DMASTATUS_PWDN
mdefine_line|#define DMASTATUS_PWDN&t;&t;0x02&t;/* power down indicator                      */
DECL|macro|DMASTC
mdefine_line|#define DMASTC&t;&t;    &t;0x44&t;/* rw     starting transfer count            */
DECL|macro|DMASPA
mdefine_line|#define DMASPA&t;&t;    &t;0x48&t;/* rw     starting physical address          */
DECL|macro|DMAWBC
mdefine_line|#define DMAWBC&t;&t;    &t;0x4C&t;/* r      working byte counter               */
DECL|macro|DMAWAC
mdefine_line|#define DMAWAC&t;&t;    &t;0x50&t;/* r      working address counter            */
DECL|macro|DMASMDLA
mdefine_line|#define DMASMDLA&t;    &t;0x58&t;/* rw     starting MDL address               */
DECL|macro|DMAWMAC
mdefine_line|#define DMAWMAC&t;&t;    &t;0x5C&t;/* r      working MDL counter                */
multiline_comment|/*** SCSI phases ***/
DECL|macro|PHASE_MSGIN
mdefine_line|#define PHASE_MSGIN             0x07
DECL|macro|PHASE_MSGOUT
mdefine_line|#define PHASE_MSGOUT            0x06
DECL|macro|PHASE_RES_1
mdefine_line|#define PHASE_RES_1             0x05
DECL|macro|PHASE_RES_0
mdefine_line|#define PHASE_RES_0             0x04
DECL|macro|PHASE_STATIN
mdefine_line|#define PHASE_STATIN            0x03
DECL|macro|PHASE_CMDOUT
mdefine_line|#define PHASE_CMDOUT            0x02
DECL|macro|PHASE_DATAIN
mdefine_line|#define PHASE_DATAIN            0x01
DECL|macro|PHASE_DATAOUT
mdefine_line|#define PHASE_DATAOUT           0x00
DECL|macro|AM53C974_local_declare
mdefine_line|#define AM53C974_local_declare()&t;unsigned long io_port
DECL|macro|AM53C974_setio
mdefine_line|#define AM53C974_setio(instance)&t;io_port = instance-&gt;io_port
DECL|macro|AM53C974_read_8
mdefine_line|#define AM53C974_read_8(addr)           inb(io_port + (addr))
DECL|macro|AM53C974_write_8
mdefine_line|#define AM53C974_write_8(addr,x)        outb((x), io_port + (addr))
DECL|macro|AM53C974_read_16
mdefine_line|#define AM53C974_read_16(addr)          inw(io_port + (addr))
DECL|macro|AM53C974_write_16
mdefine_line|#define AM53C974_write_16(addr,x)       outw((x), io_port + (addr))
DECL|macro|AM53C974_read_32
mdefine_line|#define AM53C974_read_32(addr)          inl(io_port + (addr))
DECL|macro|AM53C974_write_32
mdefine_line|#define AM53C974_write_32(addr,x)       outl((x), io_port + (addr))
DECL|macro|AM53C974_poll_int
mdefine_line|#define AM53C974_poll_int()             { do { statreg = AM53C974_read_8(STATREG); } &bslash;&n;                                             while (!(statreg &amp; STATREG_INT)) ; &bslash;&n;                                          AM53C974_read_8(INSTREG) ; }&t;/* clear int */
DECL|macro|AM53C974_cfifo
mdefine_line|#define AM53C974_cfifo()&t;&t;(AM53C974_read_8(CFIREG) &amp; CFIREG_CF)
multiline_comment|/* These are &quot;special&quot; values for the tag parameter passed to AM53C974_select. */
DECL|macro|TAG_NEXT
mdefine_line|#define TAG_NEXT&t;-1&t;/* Use next free tag */
DECL|macro|TAG_NONE
mdefine_line|#define TAG_NONE&t;-2&t;/* Establish I_T_L nexus instead of I_T_L_Q&n;&t;&t;&t;&t;   * even on SCSI-II devices */
multiline_comment|/************ LILO overrides *************/
DECL|struct|_override_t
r_typedef
r_struct
id|_override_t
(brace
DECL|member|host_scsi_id
r_int
id|host_scsi_id
suffix:semicolon
multiline_comment|/* SCSI id of the bus controller */
DECL|member|target_scsi_id
r_int
id|target_scsi_id
suffix:semicolon
multiline_comment|/* SCSI id of target */
DECL|member|max_rate
r_int
id|max_rate
suffix:semicolon
multiline_comment|/* max. transfer rate */
DECL|member|max_offset
r_int
id|max_offset
suffix:semicolon
multiline_comment|/* max. sync. offset, 0 = asynchronous */
DECL|typedef|override_t
)brace
id|override_t
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG
r_static
r_void
id|AM53C974_print_phase
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_print_queues
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* AM53C974_DEBUG */
r_static
r_void
id|AM53C974_print
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_keywait
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|__inline__
r_int
id|AM53C974_pci_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
suffix:semicolon
r_static
r_int
id|AM53C974_init
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_config_after_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|initialize_SCp
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|run_main
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_main
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|do_AM53C974_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_intr_disconnect
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
suffix:semicolon
r_static
r_int
id|AM53C974_sync_neg
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|target
comma
r_int
r_char
op_star
id|msg
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|AM53C974_set_async
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|target
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|AM53C974_set_sync
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|target
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_information_transfer
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
r_char
id|statreg
comma
r_int
r_char
id|isreg
comma
r_int
r_char
id|instreg
comma
r_int
r_char
id|cfifo
comma
r_int
r_char
id|dmastatus
)paren
suffix:semicolon
r_static
r_int
id|AM53C974_message
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_char
id|msg
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_select
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
id|tag
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_intr_reselect
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
r_char
id|statreg
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|AM53C974_transfer_dma
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|dir
comma
r_int
r_int
id|length
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_dma_blast
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
r_char
id|dmastatus
comma
r_int
r_char
id|statreg
)paren
suffix:semicolon
r_static
r_void
id|AM53C974_intr_bus_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
suffix:semicolon
DECL|variable|first_instance
r_static
r_struct
id|Scsi_Host
op_star
id|first_instance
suffix:semicolon
DECL|variable|the_template
r_static
id|Scsi_Host_Template
op_star
id|the_template
suffix:semicolon
DECL|variable|first_host
r_static
r_struct
id|Scsi_Host
op_star
id|first_host
suffix:semicolon
multiline_comment|/* Head of list of AMD boards */
DECL|variable|main_running
r_static
r_volatile
r_int
id|main_running
suffix:semicolon
DECL|variable|commandline_current
r_static
r_int
id|commandline_current
suffix:semicolon
DECL|variable|overrides
id|override_t
id|overrides
(braket
l_int|7
)braket
op_assign
(brace
(brace
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* LILO overrides */
macro_line|#ifdef AM53C974_DEBUG
DECL|variable|deb_stop
r_static
r_int
id|deb_stop
op_assign
l_int|1
suffix:semicolon
r_static
r_struct
(brace
DECL|member|value
r_int
r_char
id|value
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|variable|phases
)brace
id|phases
(braket
)braket
op_assign
(brace
(brace
id|PHASE_DATAOUT
comma
l_string|&quot;DATAOUT&quot;
)brace
comma
(brace
id|PHASE_DATAIN
comma
l_string|&quot;DATAIN&quot;
)brace
comma
(brace
id|PHASE_CMDOUT
comma
l_string|&quot;CMDOUT&quot;
)brace
comma
(brace
id|PHASE_STATIN
comma
l_string|&quot;STATIN&quot;
)brace
comma
(brace
id|PHASE_MSGOUT
comma
l_string|&quot;MSGOUT&quot;
)brace
comma
(brace
id|PHASE_MSGIN
comma
l_string|&quot;MSGIN&quot;
)brace
comma
(brace
id|PHASE_RES_0
comma
l_string|&quot;RESERVED 0&quot;
)brace
comma
(brace
id|PHASE_RES_1
comma
l_string|&quot;RESERVED 1&quot;
)brace
)brace
suffix:semicolon
multiline_comment|/************************************************************************** &n; * Function : void AM53C974_print_phase(struct Scsi_Host *instance)&n; *&n; * Purpose : print the current SCSI phase for debugging purposes&n; *&n; * Input : instance - which AM53C974&n; **************************************************************************/
DECL|function|AM53C974_print_phase
r_static
r_void
id|AM53C974_print_phase
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
r_char
id|statreg
comma
id|latched
suffix:semicolon
r_int
id|i
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|latched
op_assign
(paren
id|AM53C974_read_8
c_func
(paren
id|CNTLREG2
)paren
)paren
op_amp
id|CNTLREG2_ENF
suffix:semicolon
id|statreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|STATREG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|phases
(braket
id|i
)braket
dot
id|value
op_ne
id|PHASE_RES_1
)paren
op_logical_and
(paren
id|phases
(braket
id|i
)braket
dot
id|value
op_ne
(paren
id|statreg
op_amp
id|STATREG_PHASE
)paren
)paren
suffix:semicolon
op_increment
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|latched
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : phase %s, latched at end of last command&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|phases
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;scsi%d : phase %s, real time&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|phases
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * Function : void AM53C974_print_queues(struct Scsi_Host *instance)&n; *&n; * Purpose : print commands in the various queues&n; *&n; * Inputs : instance - which AM53C974&n; **************************************************************************/
DECL|function|AM53C974_print_queues
r_static
r_void
id|AM53C974_print_queues
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|ptr
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AM53C974: coroutine is%s running.&bslash;n&quot;
comma
id|main_running
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;n&squot;t&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;connected
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: no currently connected command&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
)brace
r_else
(brace
id|print_Scsi_Cmnd
c_func
(paren
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;connected
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;sel_cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: no currently arbitrating command&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
)brace
r_else
(brace
id|print_Scsi_Cmnd
c_func
(paren
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;sel_cmd
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: issue_queue &quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;issue_queue
)paren
id|printk
c_func
(paren
l_string|&quot;empty&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
id|print_Scsi_Cmnd
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: disconnected_queue &quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;disconnected_queue
)paren
id|printk
c_func
(paren
l_string|&quot;empty&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;disconnected_queue
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|ptr-&gt;host_scribble
)paren
id|print_Scsi_Cmnd
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* AM53C974_DEBUG */
multiline_comment|/**************************************************************************&n; * Function : void AM53C974_print(struct Scsi_Host *instance)&n; *&n; * Purpose : dump the chip registers for debugging purposes&n; *&n; * Input : instance - which AM53C974&n; **************************************************************************/
DECL|function|AM53C974_print
r_static
r_void
id|AM53C974_print
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctcreg
comma
id|dmastc
comma
id|dmaspa
comma
id|dmawbc
comma
id|dmawac
suffix:semicolon
r_int
r_char
id|cmdreg
comma
id|statreg
comma
id|isreg
comma
id|cfireg
comma
id|cntlreg
(braket
l_int|4
)braket
comma
id|dmacmd
comma
id|dmastatus
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ctcreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|CTCHREG
)paren
op_lshift
l_int|16
suffix:semicolon
id|ctcreg
op_or_assign
id|AM53C974_read_8
c_func
(paren
id|CTCMREG
)paren
op_lshift
l_int|8
suffix:semicolon
id|ctcreg
op_or_assign
id|AM53C974_read_8
c_func
(paren
id|CTCLREG
)paren
suffix:semicolon
id|cmdreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|CMDREG
)paren
suffix:semicolon
id|statreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|STATREG
)paren
suffix:semicolon
id|isreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|ISREG
)paren
suffix:semicolon
id|cfireg
op_assign
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
suffix:semicolon
id|cntlreg
(braket
l_int|0
)braket
op_assign
id|AM53C974_read_8
c_func
(paren
id|CNTLREG1
)paren
suffix:semicolon
id|cntlreg
(braket
l_int|1
)braket
op_assign
id|AM53C974_read_8
c_func
(paren
id|CNTLREG2
)paren
suffix:semicolon
id|cntlreg
(braket
l_int|2
)braket
op_assign
id|AM53C974_read_8
c_func
(paren
id|CNTLREG3
)paren
suffix:semicolon
id|cntlreg
(braket
l_int|3
)braket
op_assign
id|AM53C974_read_8
c_func
(paren
id|CNTLREG4
)paren
suffix:semicolon
id|dmacmd
op_assign
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
suffix:semicolon
id|dmastc
op_assign
id|AM53C974_read_32
c_func
(paren
id|DMASTC
)paren
suffix:semicolon
id|dmaspa
op_assign
id|AM53C974_read_32
c_func
(paren
id|DMASPA
)paren
suffix:semicolon
id|dmawbc
op_assign
id|AM53C974_read_32
c_func
(paren
id|DMAWBC
)paren
suffix:semicolon
id|dmawac
op_assign
id|AM53C974_read_32
c_func
(paren
id|DMAWAC
)paren
suffix:semicolon
id|dmastatus
op_assign
id|AM53C974_read_8
c_func
(paren
id|DMASTATUS
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AM53C974 register dump:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IO base: 0x%04lx; CTCREG: 0x%04lx; CMDREG: 0x%02x; STATREG: 0x%02x; ISREG: 0x%02x&bslash;n&quot;
comma
id|io_port
comma
id|ctcreg
comma
id|cmdreg
comma
id|statreg
comma
id|isreg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CFIREG: 0x%02x; CNTLREG1-4: 0x%02x; 0x%02x; 0x%02x; 0x%02x&bslash;n&quot;
comma
id|cfireg
comma
id|cntlreg
(braket
l_int|0
)braket
comma
id|cntlreg
(braket
l_int|1
)braket
comma
id|cntlreg
(braket
l_int|2
)braket
comma
id|cntlreg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMACMD: 0x%02x; DMASTC: 0x%04lx; DMASPA: 0x%04lx&bslash;n&quot;
comma
id|dmacmd
comma
id|dmastc
comma
id|dmaspa
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMAWBC: 0x%04lx; DMAWAC: 0x%04lx; DMASTATUS: 0x%02x&bslash;n&quot;
comma
id|dmawbc
comma
id|dmawac
comma
id|dmastatus
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;---------------------------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* Function : void AM53C974_keywait(void)&n;*&n;* Purpose : wait until a key is pressed, if it was the &squot;r&squot; key leave singlestep mode;&n;*           this function is used for debugging only&n;*&n;* Input : none&n;**************************************************************************/
DECL|function|AM53C974_keywait
r_static
r_void
id|AM53C974_keywait
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG
r_int
id|key
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|deb_stop
)paren
r_return
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb_p
c_func
(paren
l_int|0x64
)paren
op_amp
l_int|0x01
)paren
op_ne
l_int|0x01
)paren
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG
id|key
op_assign
id|inb
c_func
(paren
l_int|0x60
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
l_int|0x93
)paren
id|deb_stop
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t stop if &squot;r&squot; was pressed */
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/**************************************************************************&n;* Function : AM53C974_setup(char *str)&n;*&n;* Purpose : LILO command line initialization of the overrides array,&n;* &n;* Input : str - parameter string.&n;*&n;* Returns : 1.&n;*&n;* NOTE : this function needs to be declared as an external function&n;*         in init/main.c and included there in the bootsetups list&n;***************************************************************************/
DECL|function|AM53C974_setup
r_static
r_int
id|AM53C974_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|5
)braket
suffix:semicolon
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OL
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;AM53C974_setup: wrong number of parameters;&bslash;n correct syntax is: AM53C974=host-scsi-id, target-scsi-id, max-rate, max-offset&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|commandline_current
OL
(paren
r_sizeof
(paren
id|overrides
)paren
op_div
r_sizeof
(paren
id|override_t
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|ints
(braket
l_int|1
)braket
OL
l_int|0
)paren
op_logical_or
(paren
id|ints
(braket
l_int|1
)braket
OG
l_int|7
)paren
op_logical_or
(paren
id|ints
(braket
l_int|2
)braket
OL
l_int|0
)paren
op_logical_or
(paren
id|ints
(braket
l_int|2
)braket
OG
l_int|7
)paren
op_logical_or
(paren
id|ints
(braket
l_int|1
)braket
op_eq
id|ints
(braket
l_int|2
)braket
)paren
op_logical_or
(paren
id|ints
(braket
l_int|3
)braket
OL
(paren
id|DEF_CLK
op_div
id|MAX_PERIOD
)paren
)paren
op_logical_or
(paren
id|ints
(braket
l_int|3
)braket
OG
(paren
id|DEF_CLK
op_div
id|MIN_PERIOD
)paren
)paren
op_logical_or
(paren
id|ints
(braket
l_int|4
)braket
OL
l_int|0
)paren
op_logical_or
(paren
id|ints
(braket
l_int|4
)braket
OG
id|MAX_OFFSET
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;AM53C974_setup: illegal parameter&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|overrides
(braket
id|commandline_current
)braket
dot
id|host_scsi_id
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|overrides
(braket
id|commandline_current
)braket
dot
id|target_scsi_id
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|overrides
(braket
id|commandline_current
)braket
dot
id|max_rate
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|overrides
(braket
id|commandline_current
)braket
dot
id|max_offset
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|commandline_current
op_increment
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;AM53C974_setup: too many overrides&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;AM53C974=&quot;
comma
id|AM53C974_setup
)paren
suffix:semicolon
macro_line|#endif /* !MODULE */
multiline_comment|/**************************************************************************&n;* Function : int AM53C974_pci_detect(Scsi_Host_Template *tpnt)&n;*&n;* Purpose : detects and initializes AM53C974 SCSI chips with PCI Bios&n;*&n;* Inputs : tpnt - host template&n;* &n;* Returns : number of host adapters detected&n;**************************************************************************/
DECL|function|AM53C974_pci_detect
r_static
r_int
id|__init
id|AM53C974_pci_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of boards detected */
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|command
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD_SCSI
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
multiline_comment|/* check whether device is I/O mapped -- should be */
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|PCI_COMMAND_IO
)paren
)paren
r_continue
suffix:semicolon
id|pci_set_master
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* everything seems OK now, so initialize */
r_if
c_cond
(paren
id|AM53C974_init
c_func
(paren
id|tpnt
comma
id|pdev
)paren
)paren
id|count
op_increment
suffix:semicolon
)brace
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* Function : int AM53C974_init(Scsi_Host_Template *tpnt, struct pci_dev *pdev)&n;*&n;* Purpose : initializes instance and corresponding AM53/79C974 chip,&n;*&n;* Inputs : tpnt - template, pci_config - PCI configuration,&n;* &n;* Returns : 1 on success, 0 on failure.&n;* &n;* NOTE: If no override for the controller&squot;s SCSI id is given and AM53C974_SCSI_ID &n;*       is not defined we assume that the SCSI address of this controller is correctly&n;*       set up by the BIOS (as reflected by contents of register CNTLREG1).&n;*       This is the only BIOS assistance we need.&n;**************************************************************************/
DECL|function|AM53C974_init
r_static
r_int
id|__init
id|AM53C974_init
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
comma
op_star
id|search
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
suffix:semicolon
macro_line|#ifdef AM53C974_OPTION_DEBUG_PROBE_ONLY
id|printk
c_func
(paren
l_string|&quot;AM53C974: probe only enabled, aborting initialization&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
id|instance
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|AM53C974_hostdata
)paren
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|instance-&gt;base
op_assign
l_int|0
suffix:semicolon
id|instance-&gt;io_port
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|instance-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|instance-&gt;dma_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
macro_line|#ifdef AM53C974_SCSI_ID
id|instance-&gt;this_id
op_assign
id|AM53C974_SCSI_ID
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG1
comma
id|instance-&gt;this_id
op_amp
id|CNTLREG1_SID
)paren
suffix:semicolon
macro_line|#else
id|instance-&gt;this_id
op_assign
id|AM53C974_read_8
c_func
(paren
id|CNTLREG1
)paren
op_amp
id|CNTLREG1_SID
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;this_id
op_ne
l_int|7
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: WARNING: unusual hostadapter SCSI id %d; please verify!&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|instance-&gt;this_id
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|hostdata-&gt;msgout
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hostdata-&gt;msgout
(braket
id|i
)braket
op_assign
id|NOP
suffix:semicolon
id|hostdata-&gt;last_message
(braket
id|i
)braket
op_assign
id|NOP
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hostdata-&gt;busy
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;sync_per
(braket
id|i
)braket
op_assign
id|DEF_STP
suffix:semicolon
id|hostdata-&gt;sync_off
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;sync_neg
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;sync_en
(braket
id|i
)braket
op_assign
id|DEFAULT_SYNC_NEGOTIATION_ENABLED
suffix:semicolon
id|hostdata-&gt;max_rate
(braket
id|i
)braket
op_assign
id|DEFAULT_RATE
suffix:semicolon
id|hostdata-&gt;max_offset
(braket
id|i
)braket
op_assign
id|DEFAULT_SYNC_OFFSET
suffix:semicolon
)brace
multiline_comment|/* overwrite defaults by LILO overrides */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|commandline_current
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|overrides
(braket
id|i
)braket
dot
id|host_scsi_id
op_eq
id|instance-&gt;this_id
)paren
(brace
id|j
op_assign
id|overrides
(braket
id|i
)braket
dot
id|target_scsi_id
suffix:semicolon
id|hostdata-&gt;sync_en
(braket
id|j
)braket
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;max_rate
(braket
id|j
)braket
op_assign
id|overrides
(braket
id|i
)braket
dot
id|max_rate
suffix:semicolon
id|hostdata-&gt;max_offset
(braket
id|j
)braket
op_assign
id|overrides
(braket
id|i
)braket
dot
id|max_offset
suffix:semicolon
)brace
)brace
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;connected
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;disconnected_queue
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;in_reset
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set up an interrupt handler if we aren&squot;t already sharing an IRQ with another board */
r_for
c_loop
(paren
id|search
op_assign
id|first_host
suffix:semicolon
id|search
op_logical_and
(paren
(paren
(paren
id|the_template
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|search-&gt;hostt
op_ne
id|the_template
)paren
)paren
op_logical_or
(paren
id|search-&gt;irq
op_ne
id|instance-&gt;irq
)paren
op_logical_or
(paren
id|search
op_eq
id|instance
)paren
)paren
suffix:semicolon
id|search
op_assign
id|search-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|search
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|instance-&gt;irq
comma
id|do_AM53C974_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;AM53C974&quot;
comma
id|instance
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: IRQ%d not free, detaching&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|instance-&gt;irq
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|instance
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: using interrupt handler previously installed for scsi%d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|search-&gt;host_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|the_template
)paren
(brace
id|the_template
op_assign
id|instance-&gt;hostt
suffix:semicolon
id|first_instance
op_assign
id|instance
suffix:semicolon
)brace
multiline_comment|/* do hard reset */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_RDEV
)paren
suffix:semicolon
multiline_comment|/* reset device */
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_NOP
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG1
comma
id|CNTLREG1_DISR
op_or
id|instance-&gt;this_id
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_RBUS
)paren
suffix:semicolon
multiline_comment|/* reset SCSI bus */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|AM53C974_config_after_reset
c_func
(paren
id|instance
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n;* Function : AM53C974_config_after_reset(struct Scsi_Host *instance) *&n;*                                                                    *&n;* Purpose : initializes chip registers after reset                   *&n;*                                                                    *&n;* Inputs : instance - which AM53C974                                 *&n;*                                                                    *&n;* Returns : nothing                                                  *&n;**********************************************************************/
DECL|function|AM53C974_config_after_reset
r_static
r_void
id|AM53C974_config_after_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
multiline_comment|/* clear SCSI FIFO */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
multiline_comment|/* configure device */
id|AM53C974_write_8
c_func
(paren
id|STIMREG
comma
id|DEF_SCSI_TIMEOUT
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|STPREG
comma
id|DEF_STP
op_amp
id|STPREG_STP
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|SOFREG
comma
(paren
id|DEF_SOF_RAD
op_lshift
l_int|6
)paren
op_or
(paren
id|DEF_SOF_RAA
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CLKFREG
comma
id|DEF_CLKF
op_amp
id|CLKFREG_MASK
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG1
comma
(paren
id|DEF_ETM
op_lshift
l_int|7
)paren
op_or
id|CNTLREG1_DISR
op_or
(paren
id|DEF_PERE
op_lshift
l_int|4
)paren
op_or
id|instance-&gt;this_id
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG2
comma
(paren
id|DEF_ENF
op_lshift
l_int|6
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG3
comma
(paren
id|DEF_ADIDCHK
op_lshift
l_int|7
)paren
op_or
(paren
id|DEF_FASTSCSI
op_lshift
l_int|4
)paren
op_or
(paren
id|DEF_FASTCLK
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG4
comma
(paren
id|DEF_GLITCH
op_lshift
l_int|6
)paren
op_or
(paren
id|DEF_PWD
op_lshift
l_int|5
)paren
op_or
(paren
id|DEF_RAE
op_lshift
l_int|3
)paren
op_or
(paren
id|DEF_RADE
op_lshift
l_int|2
)paren
op_or
id|CNTLREG4_RES
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n;* Function : const char *AM53C974_info(struct Scsi_Host *instance)     *&n;*                                                                      *&n;* Purpose : return device driver information                           *&n;*                                                                      *&n;* Inputs : instance - which AM53C974                                   *&n;*                                                                      *&n;* Returns : info string                                                *&n;************************************************************************/
DECL|function|AM53C974_info
r_static
r_const
r_char
op_star
id|AM53C974_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
r_static
r_char
id|info
(braket
l_int|100
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|info
comma
l_string|&quot;AM53/79C974 PCscsi driver rev. %d.%d; host I/O address: 0x%lx; irq: %d&bslash;n&quot;
comma
id|AM53C974_DRIVER_REVISION_MAJOR
comma
id|AM53C974_DRIVER_REVISION_MINOR
comma
id|instance-&gt;io_port
comma
id|instance-&gt;irq
)paren
suffix:semicolon
r_return
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : int AM53C974_command (Scsi_Cmnd *SCpnt)                      *&n;*                                                                         *&n;* Purpose : the unqueued SCSI command function, replaced by the           *&n;*           AM53C974_queue_command function                               *&n;*                                                                         *&n;* Inputs : SCpnt - pointer to command structure                           *&n;*                                                                         *&n;* Returns :status, see hosts.h for details                                *&n;***************************************************************************/
DECL|function|AM53C974_command
r_static
r_int
id|AM53C974_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;AM53C974_command called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* Function : void initialize_SCp(Scsi_Cmnd *cmd)                          *&n;*                                                                         *&n;* Purpose : initialize the saved data pointers for cmd to point to the    *&n;*&t;    start of the buffer.                                          *                              &n;*                                                                         *&n;* Inputs : cmd - Scsi_Cmnd structure to have pointers reset.              *&n;*                                                                         *&n;* Returns : nothing                                                       *&n;**************************************************************************/
DECL|function|initialize_SCp
r_static
id|__inline__
r_void
id|initialize_SCp
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|cmd-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;buffer
suffix:semicolon
id|cmd-&gt;SCp.buffers_residual
op_assign
id|cmd-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|cmd-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|cmd-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|cmd-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
)brace
)brace
multiline_comment|/**************************************************************************&n;* Function : run_main(void)                                               *&n;*                                                                         *&n;* Purpose : insure that the coroutine is running and will process our     *&n;* &t;    request.  main_running is checked/set here (in an inline      *&n;*           function rather than in AM53C974_main itself to reduce the    *&n;*           chances of stack overflow.                                    *&n;*                                                                         *&n;*                                                                         *&n;* Inputs : none                                                           *&n;*                                                                         *&n;* Returns : nothing                                                       *&n;**************************************************************************/
DECL|function|run_main
r_static
id|__inline__
r_void
id|run_main
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|main_running
)paren
(brace
multiline_comment|/* main_running is cleared in AM53C974_main once it can&squot;t do &n;&t;&t;   more work, and AM53C974_main exits with interrupts disabled. */
id|main_running
op_assign
l_int|1
suffix:semicolon
id|AM53C974_main
c_func
(paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : int AM53C974_queue_command(Scsi_Cmnd *cmd, void (*done)(Scsi_Cmnd *))&n;*&n;* Purpose : writes SCSI command into AM53C974 FIFO &n;*&n;* Inputs : cmd - SCSI command, done - function called on completion, with&n;*&t;a pointer to the command descriptor.&n;* &n;* Returns : status, see hosts.h for details&n;*&n;* Side effects : &n;*      cmd is added to the per instance issue_queue, with minor &n;*&t;twiddling done to the host specific fields of cmd.  If the &n;*&t;main coroutine is not running, it is restarted.&n;**************************************************************************/
DECL|function|AM53C974_queue_command
r_static
r_int
id|AM53C974_queue_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
op_assign
id|cmd-&gt;host
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|tmp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DEB_QUEUE
c_func
(paren
id|printk
c_func
(paren
id|SEPARATOR_LINE
)paren
)paren
suffix:semicolon
id|DEB_QUEUE
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: AM53C974_queue_command called&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEB_QUEUE
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd=%02x target=%02x lun=%02x bufflen=%d use_sg = %02x&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;use_sg
)paren
)paren
suffix:semicolon
multiline_comment|/* We use the host_scribble field as a pointer to the next command in a queue */
id|cmd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;device-&gt;disconnect
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Insert the cmd into the issue queue. Note that REQUEST SENSE &n; * commands are added to the head of the queue since any command will&n; * clear the contingent allegiance condition that exists and the &n; * sense data is only guaranteed to be valid while the condition exists. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hostdata-&gt;issue_queue
)paren
op_logical_or
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
)paren
(brace
id|LIST
c_func
(paren
id|cmd
comma
id|hostdata-&gt;issue_queue
)paren
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
id|cmd
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|tmp-&gt;host_scribble
suffix:semicolon
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
)paren
suffix:semicolon
id|LIST
c_func
(paren
id|cmd
comma
id|tmp
)paren
suffix:semicolon
id|tmp-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|cmd
suffix:semicolon
)brace
id|DEB_QUEUE
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : command added to %s of queue&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
ques
c_cond
l_string|&quot;head&quot;
suffix:colon
l_string|&quot;tail&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Run the coroutine if it isn&squot;t already running. */
id|run_main
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * Function : AM53C974_main (void) &n; *&n; * Purpose : AM53C974_main is a coroutine that runs as long as more work can &n; *&t;be done on the AM53C974 host adapters in a system.  Both &n; *&t;AM53C974_queue_command() and AM53C974_intr() will try to start it &n; *&t;in case it is not running.&n; * &n; * NOTE : AM53C974_main exits with interrupts *disabled*, the caller should &n; *  reenable them.  This prevents reentrancy and kernel stack overflow.&n; **************************************************************************/
DECL|function|AM53C974_main
r_static
r_void
id|AM53C974_main
c_func
(paren
r_void
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|tmp
comma
op_star
id|prev
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|done
suffix:semicolon
multiline_comment|/* We run (with interrupts disabled) until we&squot;re sure that none of &n; * the host adapters have anything that can be done, at which point &n; * we set main_running to 0 and exit. */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Freeze request queues */
r_do
(brace
id|done
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|instance
op_assign
id|first_instance
suffix:semicolon
id|instance
op_logical_and
id|instance-&gt;hostt
op_eq
id|the_template
suffix:semicolon
id|instance
op_assign
id|instance-&gt;next
)paren
(brace
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
multiline_comment|/* start to select target if we are not connected and not in the &n;&t;&t;&t;   selection process */
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;connected
op_logical_and
op_logical_neg
id|hostdata-&gt;sel_cmd
)paren
(brace
multiline_comment|/* Search through the issue_queue for a command destined for a target &n;&t;&t;&t;&t;   that is not busy. */
r_for
c_loop
(paren
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;issue_queue
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|tmp
suffix:semicolon
id|prev
op_assign
id|tmp
comma
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
)paren
(brace
multiline_comment|/*  When we find one, remove it from the issue queue. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hostdata-&gt;busy
(braket
id|tmp-&gt;target
)braket
op_amp
(paren
l_int|1
op_lshift
id|tmp-&gt;lun
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
(brace
id|REMOVE
c_func
(paren
id|prev
comma
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
id|prev-&gt;host_scribble
)paren
comma
id|tmp
comma
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
id|tmp-&gt;host_scribble
)paren
)paren
suffix:semicolon
id|prev-&gt;host_scribble
op_assign
id|tmp-&gt;host_scribble
suffix:semicolon
)brace
r_else
(brace
id|REMOVE
c_func
(paren
op_minus
l_int|1
comma
id|hostdata-&gt;issue_queue
comma
id|tmp
comma
id|tmp-&gt;host_scribble
)paren
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
suffix:semicolon
)brace
id|tmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* go into selection mode, disable reselection and wait for&n;&t;&t;&t;&t;&t;&t;   SO interrupt which will continue with the selection process */
id|hostdata-&gt;selecting
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
id|tmp
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_DSR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* if target/lun is not busy */
)brace
multiline_comment|/* for */
)brace
multiline_comment|/* if (!hostdata-&gt;connected) */
r_else
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;main: connected; cmd = 0x%lx, sel_cmd = 0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;connected
comma
(paren
r_int
)paren
id|hostdata-&gt;sel_cmd
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* for instance */
)brace
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
suffix:semicolon
id|main_running
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n;* Function : AM53C974_intr(int irq, void *dev_id, struct pt_regs *regs) *&n;*                                                                       *&n;* Purpose : interrupt handler                                           *&n;*                                                                       *&n;* Inputs : irq - interrupt line, regs - ?                               *&n;*                                                                       *&n;* Returns : nothing                                                     *&n;************************************************************************/
DECL|function|do_AM53C974_intr
r_static
r_void
id|do_AM53C974_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|AM53C974_intr
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n;* Function : AM53C974_intr(int irq, void *dev_id, struct pt_regs *regs) *&n;*                                                                       *&n;* Purpose : interrupt handler                                           *&n;*                                                                       *&n;* Inputs : irq - interrupt line, regs - ?                               *&n;*                                                                       *&n;* Returns : nothing                                                     *&n;************************************************************************/
DECL|function|AM53C974_intr
r_static
r_void
id|AM53C974_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
r_char
id|cmdreg
comma
id|dmastatus
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
suffix:semicolon
multiline_comment|/* find AM53C974 hostadapter responsible for this interrupt */
r_for
c_loop
(paren
id|instance
op_assign
id|first_instance
suffix:semicolon
id|instance
suffix:semicolon
id|instance
op_assign
id|instance-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|instance-&gt;irq
op_eq
id|irq
)paren
op_logical_and
(paren
id|instance-&gt;hostt
op_eq
id|the_template
)paren
)paren
r_goto
id|FOUND
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* found; now decode and process */
id|FOUND
suffix:colon
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|dmastatus
op_assign
id|AM53C974_read_8
c_func
(paren
id|DMASTATUS
)paren
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
id|SEPARATOR_LINE
)paren
)paren
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;AM53C974 interrupt; dmastatus=0x%02x&bslash;n&quot;
comma
id|dmastatus
)paren
)paren
suffix:semicolon
id|KEYWAIT
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*** DMA related interrupts ***/
r_if
c_cond
(paren
id|hostdata-&gt;connected
op_logical_and
(paren
id|dmastatus
op_amp
(paren
id|DMASTATUS_ERROR
op_or
id|DMASTATUS_PWDN
op_or
id|DMASTATUS_ABORT
)paren
)paren
)paren
(brace
multiline_comment|/* DMA error or POWERDOWN */
id|printk
c_func
(paren
l_string|&quot;scsi%d: DMA error or powerdown; dmastatus: 0x%02x&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|dmastatus
)paren
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|panic
c_func
(paren
l_string|&quot;scsi%d: cannot recover&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;connected
op_logical_and
(paren
id|dmastatus
op_amp
id|DMASTATUS_DONE
)paren
)paren
(brace
multiline_comment|/* DMA transfer done */
r_int
r_int
id|residual
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
op_amp
id|DMACMD_DIR
)paren
)paren
(brace
r_do
(brace
id|dmastatus
op_assign
id|AM53C974_read_8
c_func
(paren
id|DMASTATUS
)paren
suffix:semicolon
id|residual
op_assign
id|AM53C974_read_8
c_func
(paren
id|CTCLREG
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCMREG
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCHREG
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|residual
op_add_assign
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|dmastatus
op_amp
id|DMASTATUS_SCSIINT
)paren
op_logical_and
id|residual
)paren
suffix:semicolon
id|residual
op_assign
id|AM53C974_read_8
c_func
(paren
id|CTCLREG
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCMREG
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCHREG
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|residual
op_add_assign
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
suffix:semicolon
)brace
r_else
id|residual
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;connected-&gt;SCp.ptr
op_add_assign
id|hostdata-&gt;connected-&gt;SCp.this_residual
op_minus
id|residual
suffix:semicolon
id|hostdata-&gt;connected-&gt;SCp.this_residual
op_assign
id|residual
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
multiline_comment|/* if service request missed before, process it now (ugly) */
r_if
c_cond
(paren
id|hostdata-&gt;dma_busy
)paren
(brace
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|cmdreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|CMDREG
)paren
suffix:semicolon
id|statreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|STATREG
)paren
suffix:semicolon
id|isreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|ISREG
)paren
suffix:semicolon
id|instreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|INSTREG
)paren
suffix:semicolon
id|cfifo
op_assign
id|AM53C974_cfifo
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_information_transfer
c_func
(paren
id|instance
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
comma
id|dmastatus
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dmastatus
op_amp
id|DMASTATUS_SCSIINT
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*** SCSI related interrupts ***/
id|cmdreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|CMDREG
)paren
suffix:semicolon
id|statreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|STATREG
)paren
suffix:semicolon
id|isreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|ISREG
)paren
suffix:semicolon
id|instreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|INSTREG
)paren
suffix:semicolon
id|cfifo
op_assign
id|AM53C974_cfifo
c_func
(paren
)paren
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: statreg: 0x%02x; isreg: 0x%02x; instreg: 0x%02x; cfifo: 0x%02x&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|statreg
op_amp
id|STATREG_PE
)paren
(brace
multiline_comment|/* parity error */
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;scsi%d : PARITY error&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;connected
)paren
id|hostdata-&gt;sync_off
(braket
id|hostdata-&gt;connected-&gt;target
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup asynchronous transfer */
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|statreg
op_amp
id|STATREG_IOE
)paren
(brace
multiline_comment|/* illegal operation error */
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;scsi%d : ILLEGAL OPERATION error&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cmdreg:  0x%02x; dmacmd:  0x%02x; statreg: 0x%02x; &bslash;n&quot;
l_string|&quot;isreg:   0x%02x; instreg: 0x%02x; cfifo:   0x%02x&bslash;n&quot;
comma
id|cmdreg
comma
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;in_reset
op_logical_and
(paren
id|instreg
op_amp
id|INSTREG_SRST
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* RESET INTERRUPT */
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Bus reset interrupt received&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|AM53C974_intr_bus_reset
c_func
(paren
id|instance
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;connected
)paren
(brace
id|hostdata-&gt;connected-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|hostdata-&gt;connected
op_member_access_from_pointer
id|scsi_done
c_func
(paren
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;connected
)paren
suffix:semicolon
id|hostdata-&gt;connected
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hostdata-&gt;sel_cmd
)paren
(brace
id|hostdata-&gt;sel_cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;sel_cmd
)paren
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;in_reset
op_eq
l_int|1
)paren
r_goto
id|EXIT
suffix:semicolon
r_else
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instreg
op_amp
id|INSTREG_ICMD
)paren
(brace
multiline_comment|/* INVALID COMMAND INTERRUPT */
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;scsi%d: Invalid command interrupt&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cmdreg:  0x%02x; dmacmd:  0x%02x; statreg: 0x%02x; dmastatus: 0x%02x; &bslash;n&quot;
l_string|&quot;isreg:   0x%02x; instreg: 0x%02x; cfifo:   0x%02x&bslash;n&quot;
comma
id|cmdreg
comma
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
comma
id|statreg
comma
id|dmastatus
comma
id|isreg
comma
id|instreg
comma
id|cfifo
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;scsi%d: cannot recover&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instreg
op_amp
id|INSTREG_DIS
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* DISCONNECT INTERRUPT */
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Disconnect interrupt received; &quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_intr_disconnect
c_func
(paren
id|instance
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|EXIT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instreg
op_amp
id|INSTREG_RESEL
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* RESELECTION INTERRUPT */
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Reselection interrupt received&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_intr_reselect
c_func
(paren
id|instance
comma
id|statreg
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|EXIT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instreg
op_amp
id|INSTREG_SO
)paren
(brace
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Successful operation interrupt received&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;selecting
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DSR completed, starting select&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_select
c_func
(paren
id|instance
comma
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;sel_cmd
comma
(paren
id|hostdata-&gt;sel_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
ques
c_cond
id|TAG_NONE
suffix:colon
id|TAG_NEXT
)paren
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
id|AM53C974_set_sync
c_func
(paren
id|instance
comma
id|hostdata-&gt;sel_cmd-&gt;target
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;sel_cmd
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|isreg
op_amp
id|ISREG_IS
)paren
op_ne
id|ISREG_OK_NO_STOP
)paren
op_logical_and
(paren
(paren
id|isreg
op_amp
id|ISREG_IS
)paren
op_ne
id|ISREG_OK_STOP
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* UNSUCCESSFUL SELECTION */
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;unsuccessful selection&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|LIST
c_func
(paren
id|hostdata-&gt;sel_cmd
comma
id|hostdata-&gt;issue_queue
)paren
suffix:semicolon
id|hostdata-&gt;sel_cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
id|hostdata-&gt;sel_cmd
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|EXIT
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* SUCCESSFUL SELECTION */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;successful selection; cmd=0x%02lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;sel_cmd
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;connected
op_assign
id|hostdata-&gt;sel_cmd
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SCSI2
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;connected-&gt;device-&gt;tagged_queue
)paren
macro_line|#endif
id|hostdata-&gt;busy
(braket
id|hostdata-&gt;connected-&gt;target
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|hostdata-&gt;connected-&gt;lun
)paren
suffix:semicolon
multiline_comment|/* very strange -- use_sg is sometimes nonzero for request sense commands !! */
r_if
c_cond
(paren
(paren
id|hostdata-&gt;connected-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_and
id|hostdata-&gt;connected-&gt;use_sg
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: REQUEST_SENSE command with nonzero use_sg&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|KEYWAIT
c_func
(paren
)paren
suffix:semicolon
id|hostdata-&gt;connected-&gt;use_sg
op_assign
l_int|0
suffix:semicolon
)brace
id|initialize_SCp
c_func
(paren
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;connected
)paren
suffix:semicolon
id|hostdata-&gt;connected-&gt;SCp.phase
op_assign
id|PHASE_CMDOUT
suffix:semicolon
id|AM53C974_information_transfer
c_func
(paren
id|instance
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
comma
id|dmastatus
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_information_transfer
c_func
(paren
id|instance
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
comma
id|dmastatus
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|instreg
op_amp
id|INSTREG_SR
)paren
(brace
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Service request interrupt received, &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;connected
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;calling information_transfer&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_information_transfer
c_func
(paren
id|instance
comma
id|statreg
comma
id|isreg
comma
id|instreg
comma
id|cfifo
comma
id|dmastatus
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: weird: service request when no command connected&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
)brace
multiline_comment|/* clear FIFO */
r_return
suffix:semicolon
)brace
id|EXIT
suffix:colon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;intr: starting main&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|run_main
c_func
(paren
)paren
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;end of intr&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_intr_disconnect(struct Scsi_Host *instance)&n;*&n;* Purpose : manage target disconnection&n;*&n;* Inputs : instance -- which AM53C974&n;* &n;* Returns : nothing&n;**************************************************************************/
DECL|function|AM53C974_intr_disconnect
r_static
r_void
id|AM53C974_intr_disconnect
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;sel_cmd
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* normal selection timeout, typical for nonexisting targets */
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;sel_cmd
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;bad target&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_goto
id|EXIT_FINISHED
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;connected
)paren
(brace
multiline_comment|/* can happen if controller was reset, a device tried to reconnect,&n;&t;&t;   failed and disconnects now */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;disconnecting
)paren
(brace
multiline_comment|/* target sent disconnect message, so we are prepared */
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;connected
suffix:semicolon
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : disc. from cmnd %d for ta %d, lun %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;disconnect
)paren
(brace
multiline_comment|/* target wants to reselect later */
id|DEB_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ok, re-enabling selection&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|LIST
c_func
(paren
id|cmd
comma
id|hostdata-&gt;disconnected_queue
)paren
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;disconnected_queue
suffix:semicolon
id|hostdata-&gt;disconnected_queue
op_assign
id|cmd
suffix:semicolon
id|DEB_QUEUE
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : command for target %d lun %d this %d was moved from connected to&quot;
l_string|&quot;  the disconnected_queue&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|hostdata-&gt;disconnected_queue-&gt;SCp.this_residual
)paren
)paren
suffix:semicolon
id|DEB_QUEUE
c_func
(paren
id|AM53C974_print_queues
c_func
(paren
id|instance
)paren
)paren
suffix:semicolon
r_goto
id|EXIT_UNFINISHED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* target does not want to reselect later, we are really finished */
macro_line|#ifdef AM53C974_DEBUG
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Request sense data dump:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;request_bufflen
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
(paren
(paren
r_char
op_star
)paren
(paren
id|cmd-&gt;request_buffer
)paren
op_plus
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_logical_and
op_logical_neg
(paren
id|i
op_mod
l_int|16
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_goto
id|EXIT_FINISHED
suffix:semicolon
)brace
multiline_comment|/* !cmd-&gt;device-&gt;disconnect */
)brace
multiline_comment|/* if (hostdata-&gt;disconnecting) */
multiline_comment|/* no disconnect message received; unexpected disconnection */
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;connected
suffix:semicolon
r_if
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Unexpected disconnect; phase: %d; target: %d; this_residual: %d; buffers_residual: %d; message: %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;SCp.phase
comma
id|cmd-&gt;target
comma
id|cmd-&gt;SCp.this_residual
comma
id|cmd-&gt;SCp.buffers_residual
comma
id|cmd-&gt;SCp.Message
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cmdreg: 0x%02x; statreg: 0x%02x; isreg: 0x%02x; cfifo: 0x%02x&bslash;n&quot;
comma
id|AM53C974_read_8
c_func
(paren
id|CMDREG
)paren
comma
id|AM53C974_read_8
c_func
(paren
id|STATREG
)paren
comma
id|AM53C974_read_8
c_func
(paren
id|ISREG
)paren
comma
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hostdata-&gt;last_message
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
op_logical_and
(paren
id|hostdata-&gt;last_message
(braket
l_int|2
)braket
op_eq
id|EXTENDED_SDTR
)paren
)paren
(brace
multiline_comment|/* sync. negotiation was aborted, setup asynchronous transfer with target */
id|hostdata-&gt;sync_off
(braket
id|cmd-&gt;target
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;aborted
op_logical_or
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_eq
id|ABORT
)paren
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_else
id|cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_goto
id|EXIT_FINISHED
suffix:semicolon
)brace
id|EXIT_FINISHED
suffix:colon
id|hostdata-&gt;aborted
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;connected
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;busy
(braket
id|cmd-&gt;target
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;disconnect; issue_queue: 0x%lx, disconnected_queue: 0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;issue_queue
comma
(paren
r_int
)paren
id|hostdata-&gt;disconnected_queue
)paren
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;selecting
)paren
(brace
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_ESR
)paren
suffix:semicolon
)brace
multiline_comment|/* allow reselect */
r_return
suffix:semicolon
id|EXIT_UNFINISHED
suffix:colon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;connected
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;disconnect; issue_queue: 0x%lx, disconnected_queue: 0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;issue_queue
comma
(paren
r_int
)paren
id|hostdata-&gt;disconnected_queue
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;selecting
)paren
(brace
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_ESR
)paren
suffix:semicolon
)brace
multiline_comment|/* allow reselect */
r_return
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : int AM53C974_sync_neg(struct Scsi_Host *instance, int target, unsigned char *msg)&n;*&n;* Purpose : setup message string for sync. negotiation&n;*&n;* Inputs : instance -- which AM53C974&n;*          target -- which SCSI target to deal with&n;*          msg -- input message string&n;* &n;* Returns : 0 if parameters accepted or 1 if not accepted&n;*&n;* Side effects: hostdata is changed&n;*&n;* Note: we assume here that fastclk is enabled&n;**************************************************************************/
DECL|function|AM53C974_sync_neg
r_static
r_int
id|AM53C974_sync_neg
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|target
comma
r_int
r_char
op_star
id|msg
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
id|period
comma
id|offset
comma
id|i
comma
id|rate
comma
id|rate_rem
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|period
op_assign
(paren
id|DEF_CLK
op_star
id|msg
(braket
l_int|3
)braket
op_star
l_int|8
op_plus
l_int|1000
)paren
op_div
l_int|2000
suffix:semicolon
r_if
c_cond
(paren
id|period
OL
id|MIN_PERIOD
)paren
(brace
id|period
op_assign
id|MIN_PERIOD
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|3
)braket
op_assign
id|period
op_div
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|period
OG
id|MAX_PERIOD
)paren
(brace
id|period
op_assign
id|MAX_PERIOD
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|3
)braket
op_assign
id|period
op_div
l_int|4
suffix:semicolon
)brace
r_else
id|hostdata-&gt;msgout
(braket
l_int|3
)braket
op_assign
id|msg
(braket
l_int|3
)braket
suffix:semicolon
id|offset
op_assign
id|msg
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
id|MAX_OFFSET
)paren
id|offset
op_assign
id|MAX_OFFSET
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|4
)braket
op_assign
id|offset
suffix:semicolon
id|hostdata-&gt;sync_per
(braket
id|target
)braket
op_assign
id|period
suffix:semicolon
id|hostdata-&gt;sync_off
(braket
id|target
)braket
op_assign
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|hostdata-&gt;msgout
(braket
id|i
)braket
op_assign
id|msg
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hostdata-&gt;msgout
(braket
l_int|3
)braket
op_ne
id|msg
(braket
l_int|3
)braket
)paren
op_logical_or
(paren
id|msg
(braket
l_int|4
)braket
op_ne
id|offset
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|rate
op_assign
id|DEF_CLK
op_div
id|period
suffix:semicolon
id|rate_rem
op_assign
l_int|10
op_star
(paren
id|DEF_CLK
op_minus
id|period
op_star
id|rate
)paren
op_div
id|period
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;ntarget %d: rate=%d.%d Mhz, synchronous, sync offset=%d bytes&bslash;n&quot;
comma
id|target
comma
id|rate
comma
id|rate_rem
comma
id|offset
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;ntarget %d: rate=%d.%d Mhz, asynchronous&bslash;n&quot;
comma
id|target
comma
id|rate
comma
id|rate_rem
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_set_async(struct Scsi_Host *instance, int target)&n;*&n;* Purpose : put controller into async. mode&n;*&n;* Inputs : instance -- which AM53C974&n;*          target -- which SCSI target to deal with&n;* &n;* Returns : nothing&n;**************************************************************************/
DECL|function|AM53C974_set_async
r_static
id|__inline__
r_void
id|AM53C974_set_async
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|target
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|STPREG
comma
id|hostdata-&gt;sync_per
(braket
id|target
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|SOFREG
comma
(paren
id|DEF_SOF_RAD
op_lshift
l_int|6
)paren
op_or
(paren
id|DEF_SOF_RAA
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_set_sync(struct Scsi_Host *instance, int target)&n;*&n;* Purpose : put controller into sync. mode&n;*&n;* Inputs : instance -- which AM53C974&n;*          target -- which SCSI target to deal with&n;* &n;* Returns : nothing&n;**************************************************************************/
DECL|function|AM53C974_set_sync
r_static
id|__inline__
r_void
id|AM53C974_set_sync
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|target
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|STPREG
comma
id|hostdata-&gt;sync_per
(braket
id|target
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|SOFREG
comma
(paren
id|SOFREG_SO
op_amp
id|hostdata-&gt;sync_off
(braket
id|target
)braket
)paren
op_or
(paren
id|DEF_SOF_RAD
op_lshift
l_int|6
)paren
op_or
(paren
id|DEF_SOF_RAA
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n;* Function : AM53C974_information_transfer(struct Scsi_Host *instance, *&n;*                          unsigned char statreg, unsigned char isreg, *&n;*                         unsigned char instreg, unsigned char cfifo,  *&n;*                         unsigned char dmastatus)                     *&n;*                                                                      *&n;* Purpose : handle phase changes                                       *&n;*                                                                      *&n;* Inputs : instance - which AM53C974                                   *&n;*          statreg - status register                                     *&n;*          isreg - internal state register                             *&n;*          instreg - interrupt status register                         *&n;*          cfifo - number of bytes in FIFO                             *&n;*          dmastatus - dma status register                             *&n;*                                                                      *&n;* Returns : nothing                                                    *&n;************************************************************************/
DECL|function|AM53C974_information_transfer
r_static
r_void
id|AM53C974_information_transfer
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
r_char
id|statreg
comma
r_int
r_char
id|isreg
comma
r_int
r_char
id|instreg
comma
r_int
r_char
id|cfifo
comma
r_int
r_char
id|dmastatus
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;connected
suffix:semicolon
r_int
id|ret
comma
id|i
comma
id|len
comma
id|residual
op_assign
op_minus
l_int|1
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
id|SEPARATOR_LINE
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|statreg
op_amp
id|STATREG_PHASE
)paren
(brace
multiline_comment|/* scsi phase */
r_case
id|PHASE_DATAOUT
suffix:colon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Dataout phase; cmd=0x%lx, sel_cmd=0x%lx, this_residual=%d, buffers_residual=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;connected
comma
(paren
r_int
)paren
id|hostdata-&gt;sel_cmd
comma
id|cmd-&gt;SCp.this_residual
comma
id|cmd-&gt;SCp.buffers_residual
)paren
)paren
suffix:semicolon
id|cmd-&gt;SCp.phase
op_assign
id|PHASE_DATAOUT
suffix:semicolon
r_goto
id|PHASE_DATA_IO
suffix:semicolon
r_case
id|PHASE_DATAIN
suffix:colon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Datain phase; cmd=0x%lx, sel_cmd=0x%lx, this_residual=%d, buffers_residual=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;connected
comma
(paren
r_int
)paren
id|hostdata-&gt;sel_cmd
comma
id|cmd-&gt;SCp.this_residual
comma
id|cmd-&gt;SCp.buffers_residual
)paren
)paren
suffix:semicolon
id|cmd-&gt;SCp.phase
op_assign
id|PHASE_DATAIN
suffix:semicolon
id|PHASE_DATA_IO
suffix:colon
r_if
c_cond
(paren
id|hostdata-&gt;aborted
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|cmd-&gt;SCp.this_residual
)paren
op_logical_and
id|cmd-&gt;SCp.buffers_residual
)paren
(brace
id|cmd-&gt;SCp.buffer
op_increment
suffix:semicolon
id|cmd-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|cmd-&gt;SCp.buffer-&gt;address
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|cmd-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd-&gt;SCp.this_residual
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
op_amp
id|DMACMD_START
)paren
)paren
(brace
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|AM53C974_transfer_dma
c_func
(paren
id|instance
comma
id|statreg
op_amp
id|STATREG_IO
comma
(paren
r_int
r_int
)paren
id|cmd-&gt;SCp.this_residual
comma
id|cmd-&gt;SCp.ptr
)paren
suffix:semicolon
)brace
r_else
id|hostdata-&gt;dma_busy
op_assign
l_int|1
suffix:semicolon
)brace
r_return
suffix:semicolon
r_case
id|PHASE_MSGIN
suffix:colon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Message-In phase; cmd=0x%lx, sel_cmd=0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|hostdata-&gt;connected
comma
(paren
r_int
)paren
id|hostdata-&gt;sel_cmd
)paren
)paren
suffix:semicolon
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;SCp.phase
op_eq
id|PHASE_DATAIN
)paren
id|AM53C974_dma_blast
c_func
(paren
id|instance
comma
id|dmastatus
comma
id|statreg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd-&gt;SCp.phase
op_eq
id|PHASE_DATAOUT
)paren
op_logical_and
(paren
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
op_amp
id|DMACMD_START
)paren
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
id|residual
op_assign
id|cfifo
op_plus
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCLREG
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCMREG
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCHREG
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_add_assign
id|cmd-&gt;SCp.this_residual
op_minus
id|residual
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|cfifo
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
id|cfifo
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cmd-&gt;SCp.phase
op_eq
id|PHASE_STATIN
)paren
(brace
r_while
c_loop
(paren
(paren
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
)paren
OL
l_int|2
)paren
suffix:semicolon
id|cmd-&gt;SCp.Status
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
id|cmd-&gt;SCp.Message
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Message-In phase; status=0x%02x, message=0x%02x&bslash;n&quot;
comma
id|cmd-&gt;SCp.Status
comma
id|cmd-&gt;SCp.Message
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|AM53C974_message
c_func
(paren
id|instance
comma
id|cmd
comma
id|cmd-&gt;SCp.Message
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|cfifo
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_IT
)paren
suffix:semicolon
id|AM53C974_poll_int
c_func
(paren
)paren
suffix:semicolon
id|cmd-&gt;SCp.Message
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|AM53C974_message
c_func
(paren
id|instance
comma
id|cmd
comma
id|cmd-&gt;SCp.Message
)paren
suffix:semicolon
)brace
id|cmd-&gt;SCp.phase
op_assign
id|PHASE_MSGIN
suffix:semicolon
id|AM53C974_set_sync
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_MSGOUT
suffix:colon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Message-Out phase; cfifo=%d; msgout[0]=0x%02x&bslash;n&quot;
comma
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
comma
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|hostdata-&gt;last_message
)paren
suffix:semicolon
id|i
op_increment
)paren
id|hostdata-&gt;last_message
(braket
id|i
)braket
op_assign
id|hostdata-&gt;msgout
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
op_logical_or
id|INSIDE
c_func
(paren
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
comma
l_int|0x02
comma
l_int|0x1F
)paren
op_logical_or
id|INSIDE
c_func
(paren
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
comma
l_int|0x80
comma
l_int|0xFF
)paren
)paren
id|len
op_assign
l_int|1
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
macro_line|#ifdef AM53C974_DEBUG_INFO
id|printk
c_func
(paren
l_string|&quot;Extended message dump:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hostdata-&gt;msgout
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|hostdata-&gt;msgout
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_logical_and
op_logical_neg
(paren
id|i
op_mod
l_int|16
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|len
op_assign
id|hostdata-&gt;msgout
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
)brace
r_else
id|len
op_assign
l_int|2
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|hostdata-&gt;msgout
(braket
id|i
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_IT
)paren
suffix:semicolon
id|cmd-&gt;SCp.phase
op_assign
id|PHASE_MSGOUT
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
id|AM53C974_set_sync
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_CMDOUT
suffix:colon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Command-Out phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_IT
)paren
suffix:semicolon
id|cmd-&gt;SCp.phase
op_assign
id|PHASE_CMDOUT
suffix:semicolon
id|AM53C974_set_sync
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHASE_STATIN
suffix:colon
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Status phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;SCp.phase
op_eq
id|PHASE_DATAIN
)paren
id|AM53C974_dma_blast
c_func
(paren
id|instance
comma
id|dmastatus
comma
id|statreg
)paren
suffix:semicolon
id|AM53C974_set_async
c_func
(paren
id|instance
comma
id|cmd-&gt;target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;SCp.phase
op_eq
id|PHASE_DATAOUT
)paren
(brace
r_int
r_int
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|AM53C974_read_8
c_func
(paren
id|DMACMD
)paren
op_amp
id|DMACMD_START
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
id|residual
op_assign
id|cfifo
op_plus
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCLREG
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCMREG
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCHREG
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_add_assign
id|cmd-&gt;SCp.this_residual
op_minus
id|residual
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|residual
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfifo
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
id|cfifo
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|cmd-&gt;SCp.phase
op_assign
id|PHASE_STATIN
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_ICCS
)paren
suffix:semicolon
multiline_comment|/* command complete */
r_break
suffix:semicolon
r_case
id|PHASE_RES_0
suffix:colon
r_case
id|PHASE_RES_1
suffix:colon
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|DEB_INFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Reserved phase&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|KEYWAIT
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n;* Function : int AM53C974_message(struct Scsi_Host *instance, Scsi_Cmnd *cmd,&n;*                                 unsigned char msg)                &n;*&n;* Purpose : handle SCSI messages&n;*&n;* Inputs : instance -- which AM53C974&n;*          cmd -- SCSI command the message belongs to&n;*          msg -- message id byte&n;* &n;* Returns : 1 on success, 0 on failure.&n;**************************************************************************/
DECL|function|AM53C974_message
r_static
r_int
id|AM53C974_message
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_char
id|msg
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_static
r_int
r_char
id|extended_msg
(braket
l_int|10
)braket
suffix:semicolon
r_int
r_char
id|statreg
suffix:semicolon
r_int
id|len
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG_MSG
r_int
id|j
suffix:semicolon
macro_line|#endif
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
id|SEPARATOR_LINE
)paren
)paren
suffix:semicolon
multiline_comment|/* Linking lets us reduce the time required to get the &n; * next command out to the device, hopefully this will&n; * mean we don&squot;t waste another revolution due to the delays&n; * required by ARBITRATION and another SELECTION.&n; * In the current implementation proposal, low level drivers&n; * merely have to start the next command, pointed to by &n; * next_link, done() is called as with unlinked commands. */
r_switch
c_cond
(paren
id|msg
)paren
(brace
macro_line|#ifdef LINKED
r_case
id|LINKED_CMD_COMPLETE
suffix:colon
r_case
id|LINKED_FLG_CMD_COMPLETE
suffix:colon
multiline_comment|/* Accept message by releasing ACK */
id|DEB_LINKED
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : target %d lun %d linked command complete.&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/* Sanity check : A linked command should only terminate with&n;&t;&t; * one of these messages if there are more linked commands available. */
r_if
c_cond
(paren
op_logical_neg
id|cmd-&gt;next_link
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d : target %d lun %d linked command complete, no next_link&bslash;n&quot;
id|instance-&gt;host_no
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;aborted
)paren
(brace
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ATN set for cmnd %d upon reception of LINKED_CMD_COMPLETE or&quot;
l_string|&quot;LINKED_FLG_CMD_COMPLETE message&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
)brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
id|initialize_SCp
c_func
(paren
id|cmd-&gt;next_link
)paren
suffix:semicolon
multiline_comment|/* The next command is still part of this process */
id|cmd-&gt;next_link-&gt;tag
op_assign
id|cmd-&gt;tag
suffix:semicolon
id|cmd-&gt;result
op_assign
id|cmd-&gt;SCp.Status
op_or
(paren
id|cmd-&gt;SCp.Message
op_lshift
l_int|8
)paren
suffix:semicolon
id|DEB_LINKED
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : target %d lun %d linked request done, calling scsi_done().&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|cmd
op_assign
id|hostdata-&gt;connected
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* def LINKED */
r_case
id|ABORT
suffix:colon
r_case
id|COMMAND_COMPLETE
suffix:colon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: command complete message received; cmd %d for target %d, lun %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;device-&gt;disconnect
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* I&squot;m not sure what the correct thing to do here is : &n;&n;&t;&t; * If the command that just executed is NOT a request &n;&t;&t; * sense, the obvious thing to do is to set the result&n;&t;&t; * code to the values of the stored parameters.&n;&t;&t; * If it was a REQUEST SENSE command, we need some way &n;&t;&t; * to differentiate between the failure code of the original&n;&t;&t; * and the failure code of the REQUEST sense - the obvious&n;&t;&t; * case is success, where we fall through and leave the result&n;&t;&t; * code unchanged.&n;&t;&t; * &n;&t;&t; * The non-obvious place is where the REQUEST SENSE failed  */
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
)paren
id|cmd-&gt;result
op_assign
id|cmd-&gt;SCp.Status
op_or
(paren
id|cmd-&gt;SCp.Message
op_lshift
l_int|8
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd-&gt;SCp.Status
op_ne
id|GOOD
)paren
id|cmd-&gt;result
op_assign
(paren
id|cmd-&gt;result
op_amp
l_int|0x00ffff
)paren
op_or
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;aborted
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ATN set for cmnd %d upon reception of ABORT or&quot;
l_string|&quot;COMMAND_COMPLETE message&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
)paren
op_logical_and
(paren
id|cmd-&gt;SCp.Status
op_eq
id|CHECK_CONDITION
)paren
)paren
(brace
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : performing request sense&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_and_assign
l_int|0xe0
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
op_assign
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|cmd-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|cmd-&gt;sense_buffer
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|LIST
c_func
(paren
id|cmd
comma
id|hostdata-&gt;issue_queue
)paren
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|cmd
suffix:semicolon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : REQUEST SENSE added to head of issue queue&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Accept message by clearing ACK */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: reject message received; cmd %d for target %d, lun %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hostdata-&gt;last_message
(braket
l_int|0
)braket
)paren
(brace
r_case
id|EXTENDED_MESSAGE
suffix:colon
r_if
c_cond
(paren
id|hostdata-&gt;last_message
(braket
l_int|2
)braket
op_eq
id|EXTENDED_SDTR
)paren
(brace
multiline_comment|/* sync. negotiation was rejected, setup asynchronous transfer with target */
id|printk
c_func
(paren
l_string|&quot;&bslash;ntarget %d: rate=%d Mhz, asynchronous (sync. negotiation rejected)&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|DEF_CLK
op_div
id|DEF_STP
)paren
suffix:semicolon
id|hostdata-&gt;sync_off
(braket
id|cmd-&gt;target
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;sync_per
(braket
id|cmd-&gt;target
)braket
op_assign
id|DEF_STP
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
id|cmd-&gt;device-&gt;tagged_queue
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;busy
(braket
id|cmd-&gt;target
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|cmd-&gt;lun
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;aborted
)paren
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISCONNECT
suffix:colon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: disconnect message received; cmd %d for target %d, lun %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
id|cmd-&gt;device-&gt;disconnect
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
multiline_comment|/* Accept message by clearing ACK */
r_break
suffix:semicolon
r_case
id|SAVE_POINTERS
suffix:colon
r_case
id|RESTORE_POINTERS
suffix:colon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: save/restore pointers message received; cmd %d for target %d, lun %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/* The SCSI data pointer is *IMPLICITLY* saved on a disconnect&n;&t;&t; * operation, in violation of the SCSI spec so we can safely &n;&t;&t; * ignore SAVE/RESTORE pointers calls.&n;&t;&t; *&n;&t;&t; * Unfortunately, some disks violate the SCSI spec and &n;&t;&t; * don&squot;t issue the required SAVE_POINTERS message before&n;&t;&t; * disconnecting, and we have to break spec to remain &n;&t;&t; * compatible. */
r_if
c_cond
(paren
id|hostdata-&gt;aborted
)paren
(brace
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ATN set for cmnd %d upon reception of SAVE/REST. POINTERS message&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
)brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
id|DEB_MSG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: extended message received; cmd %d for target %d, lun %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/* Extended messages are sent in the following format :&n;&t;&t; * Byte    &n;&t;&t; * 0           EXTENDED_MESSAGE == 1&n;&t;&t; * 1           length (includes one byte for code, doesn&squot;t include first two bytes)&n;&t;&t; * 2           code&n;&t;&t; * 3..length+1 arguments&n;&t;&t; */
multiline_comment|/* BEWARE!! THIS CODE IS EXTREMELY UGLY */
id|extended_msg
(braket
l_int|0
)braket
op_assign
id|EXTENDED_MESSAGE
suffix:semicolon
id|AM53C974_read_8
c_func
(paren
id|INSTREG
)paren
suffix:semicolon
multiline_comment|/* clear int */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
multiline_comment|/* ack. msg byte, then wait for SO */
id|AM53C974_poll_int
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* get length */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_IT
)paren
suffix:semicolon
id|AM53C974_poll_int
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
multiline_comment|/* ack. msg byte, then wait for SO */
id|AM53C974_poll_int
c_func
(paren
)paren
suffix:semicolon
id|extended_msg
(braket
l_int|1
)braket
op_assign
id|len
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
multiline_comment|/* get length */
id|p
op_assign
id|extended_msg
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* read the remaining (len) bytes */
r_while
c_loop
(paren
id|len
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_IT
)paren
suffix:semicolon
id|AM53C974_poll_int
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
multiline_comment|/* ack. msg byte, then wait for SO */
id|AM53C974_poll_int
c_func
(paren
)paren
suffix:semicolon
)brace
op_star
id|p
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
)brace
macro_line|#ifdef AM53C974_DEBUG_MSG
id|printk
c_func
(paren
l_string|&quot;scsi%d: received extended message: &quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|extended_msg
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|extended_msg
(braket
id|j
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_logical_and
op_logical_neg
(paren
id|j
op_mod
l_int|16
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* check message */
r_if
c_cond
(paren
id|extended_msg
(braket
l_int|2
)braket
op_eq
id|EXTENDED_SDTR
)paren
id|ret
op_assign
id|AM53C974_sync_neg
c_func
(paren
id|instance
comma
id|cmd-&gt;target
comma
id|extended_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_or
id|hostdata-&gt;aborted
)paren
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d: unknown message 0x%02x received&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|msg
)paren
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* reject message */
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|MESSAGE_REJECT
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch (msg) */
id|KEYWAIT
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_select(struct Scsi_Host *instance, Scsi_Cmnd *cmd, int tag)&n;*&n;* Purpose : try to establish nexus for the command;&n;*           start sync negotiation via start stop and transfer the command in &n;*           cmdout phase in case of an inquiry or req. sense command with no &n;*           sync. neg. performed yet&n;*&n;* Inputs : instance -- which AM53C974&n;*          cmd -- command which requires the selection&n;*          tag -- tagged queueing&n;* &n;* Returns : nothing&n;*        &n;* Note: this function initializes the selection process, which is continued &n;*       in the interrupt handler&n;**************************************************************************/
DECL|function|AM53C974_select
r_static
r_void
id|AM53C974_select
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
id|tag
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
r_char
id|cfifo
comma
id|tmp
(braket
l_int|3
)braket
suffix:semicolon
r_int
r_int
id|i
comma
id|len
comma
id|cmd_size
op_assign
id|COMMAND_SIZE
c_func
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|cfifo
op_assign
id|AM53C974_cfifo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfifo
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: select error; %d residual bytes in FIFO&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cfifo
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
multiline_comment|/* clear FIFO */
)brace
macro_line|#ifdef AM53C974_PROHIBIT_DISCONNECT
id|tmp
(braket
l_int|0
)braket
op_assign
id|IDENTIFY
c_func
(paren
l_int|0
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
macro_line|#else
id|tmp
(braket
l_int|0
)braket
op_assign
id|IDENTIFY
c_func
(paren
l_int|1
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef SCSI2
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;tagged_queue
op_logical_and
(paren
id|tag
op_ne
id|TAG_NONE
)paren
)paren
(brace
id|tmp
(braket
l_int|1
)braket
op_assign
id|SIMPLE_QUEUE_TAG
suffix:semicolon
r_if
c_cond
(paren
id|tag
op_eq
id|TAG_NEXT
)paren
(brace
multiline_comment|/* 0 is TAG_NONE, used to imply no tag for this command */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;current_tag
op_eq
l_int|0
)paren
id|cmd-&gt;device-&gt;current_tag
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;tag
op_assign
id|cmd-&gt;device-&gt;current_tag
suffix:semicolon
id|cmd-&gt;device-&gt;current_tag
op_increment
suffix:semicolon
)brace
r_else
id|cmd-&gt;tag
op_assign
(paren
r_int
r_char
)paren
id|tag
suffix:semicolon
id|tmp
(braket
l_int|2
)braket
op_assign
id|cmd-&gt;tag
suffix:semicolon
id|hostdata-&gt;last_message
(braket
l_int|0
)braket
op_assign
id|SIMPLE_QUEUE_TAG
suffix:semicolon
id|len
op_assign
l_int|3
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|tmp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|tmp
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|tmp
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif&t;&t;&t;&t;/* def SCSI2 */
(brace
id|len
op_assign
l_int|1
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|tmp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cmd-&gt;tag
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* in case of an inquiry or req. sense command with no sync. neg performed yet, we start&n;   sync negotiation via start stops and transfer the command in cmdout phase */
r_if
c_cond
(paren
(paren
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_or
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|hostdata-&gt;sync_neg
(braket
id|cmd-&gt;target
)braket
)paren
op_logical_and
id|hostdata-&gt;sync_en
(braket
id|cmd-&gt;target
)braket
)paren
(brace
id|hostdata-&gt;sync_neg
(braket
id|cmd-&gt;target
)braket
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|EXTENDED_MESSAGE
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|2
)braket
op_assign
id|EXTENDED_SDTR
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|3
)braket
op_assign
l_int|250
op_div
(paren
r_int
)paren
id|hostdata-&gt;max_rate
(braket
id|cmd-&gt;target
)braket
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|4
)braket
op_assign
id|hostdata-&gt;max_offset
(braket
id|cmd-&gt;target
)braket
suffix:semicolon
id|len
op_add_assign
l_int|5
suffix:semicolon
)brace
id|AM53C974_write_8
c_func
(paren
id|SDIDREG
comma
id|SDIREG_MASK
op_amp
id|cmd-&gt;target
)paren
suffix:semicolon
multiline_comment|/* setup dest. id  */
id|AM53C974_write_8
c_func
(paren
id|STIMREG
comma
id|DEF_SCSI_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* setup timeout reg */
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd_size
suffix:semicolon
id|i
op_increment
)paren
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SAS
)paren
suffix:semicolon
multiline_comment|/* select with ATN, 1 msg byte */
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd_size
suffix:semicolon
id|i
op_increment
)paren
id|AM53C974_write_8
c_func
(paren
id|FFREG
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SA3S
)paren
suffix:semicolon
multiline_comment|/* select with ATN, 3 msg bytes */
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SASS
)paren
suffix:semicolon
multiline_comment|/* select with ATN, stop steps; continue in message out phase */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_intr_select(struct Scsi_Host *instance, unsigned char statreg)&n;*&n;* Purpose : handle reselection &n;*&n;* Inputs : instance -- which AM53C974&n;*          statreg -- status register&n;* &n;* Returns : nothing&n;*&n;* side effects: manipulates hostdata&n;**************************************************************************/
DECL|function|AM53C974_intr_reselect
r_static
r_void
id|AM53C974_intr_reselect
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
r_char
id|statreg
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
r_char
id|cfifo
comma
id|msg
(braket
l_int|3
)braket
comma
id|lun
comma
id|t
comma
id|target
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SCSI2
r_int
r_char
id|tag
suffix:semicolon
macro_line|#endif
id|Scsi_Cmnd
op_star
id|tmp
op_assign
l_int|NULL
comma
op_star
id|prev
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|cfifo
op_assign
id|AM53C974_cfifo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;selecting
)paren
(brace
multiline_comment|/* caught reselect interrupt in selection process;&n;&t;&t;   put selecting command back into the issue queue and continue with the&n;&t;&t;   reselecting command */
id|DEB_RESEL
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;AM53C974_intr_reselect: in selection process&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|LIST
c_func
(paren
id|hostdata-&gt;sel_cmd
comma
id|hostdata-&gt;issue_queue
)paren
suffix:semicolon
id|hostdata-&gt;sel_cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
id|hostdata-&gt;sel_cmd
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 2 bytes must be in the FIFO now */
r_if
c_cond
(paren
id|cfifo
op_ne
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi %d: error: %d bytes in fifo, 2 expected&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|cfifo
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
r_goto
id|EXIT_ABORT
suffix:semicolon
)brace
multiline_comment|/* determine target which reselected */
id|t
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|t
op_amp
(paren
l_int|1
op_lshift
id|instance-&gt;this_id
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi %d: error: invalid host id&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
r_goto
id|EXIT_ABORT
suffix:semicolon
)brace
id|t
op_xor_assign
(paren
l_int|1
op_lshift
id|instance-&gt;this_id
)paren
suffix:semicolon
id|target
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|t
op_ne
l_int|1
)paren
(brace
id|t
op_rshift_assign
l_int|1
suffix:semicolon
id|target
op_increment
suffix:semicolon
)brace
id|DEB_RESEL
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi %d: reselect; target: %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|target
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;aborted
)paren
r_goto
id|EXIT_ABORT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|statreg
op_amp
id|STATREG_PHASE
)paren
op_ne
id|PHASE_MSGIN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi %d: error: upon reselection interrupt not in MSGIN&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
r_goto
id|EXIT_ABORT
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: error: expecting IDENTIFY message, got &quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
id|print_msg
c_func
(paren
id|msg
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
r_goto
id|EXIT_ABORT
suffix:semicolon
)brace
id|lun
op_assign
(paren
id|msg
(braket
l_int|0
)braket
op_amp
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* We need to add code for SCSI-II to track which devices have&n; * I_T_L_Q nexuses established, and which have simple I_T_L&n; * nexuses so we can chose to do additional data transfer. */
macro_line|#ifdef SCSI2
macro_line|#error &quot;SCSI-II tagged queueing is not supported yet&quot;
macro_line|#endif
multiline_comment|/* Find the command corresponding to the I_T_L or I_T_L_Q  nexus we &n; * just reestablished, and remove it from the disconnected queue. */
r_for
c_loop
(paren
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;disconnected_queue
comma
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|tmp
suffix:semicolon
id|prev
op_assign
id|tmp
comma
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
)paren
r_if
c_cond
(paren
(paren
id|target
op_eq
id|tmp-&gt;target
)paren
op_logical_and
(paren
id|lun
op_eq
id|tmp-&gt;lun
)paren
macro_line|#ifdef SCSI2
op_logical_and
(paren
id|tag
op_eq
id|tmp-&gt;tag
)paren
macro_line|#endif
)paren
(brace
r_if
c_cond
(paren
id|prev
)paren
(brace
id|REMOVE
c_func
(paren
id|prev
comma
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
id|prev-&gt;host_scribble
)paren
comma
id|tmp
comma
(paren
id|Scsi_Cmnd
op_star
)paren
(paren
id|tmp-&gt;host_scribble
)paren
)paren
suffix:semicolon
id|prev-&gt;host_scribble
op_assign
id|tmp-&gt;host_scribble
suffix:semicolon
)brace
r_else
(brace
id|REMOVE
c_func
(paren
op_minus
l_int|1
comma
id|hostdata-&gt;disconnected_queue
comma
id|tmp
comma
id|tmp-&gt;host_scribble
)paren
suffix:semicolon
id|hostdata-&gt;disconnected_queue
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
suffix:semicolon
)brace
id|tmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;connected
op_assign
id|tmp
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
macro_line|#ifdef SCSI2
id|printk
c_func
(paren
l_string|&quot;scsi%d: warning : target %d lun %d tag %d not in disconnect_queue.&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|target
comma
id|lun
comma
id|tag
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;scsi%d: warning : target %d lun %d not in disconnect_queue.&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|target
comma
id|lun
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Since we have an established nexus that we can&squot;t do anything with, we must abort it. */
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
id|DEB
c_func
(paren
id|AM53C974_keywait
c_func
(paren
)paren
)paren
suffix:semicolon
r_goto
id|EXIT_ABORT
suffix:semicolon
)brace
r_else
r_goto
id|EXIT_OK
suffix:semicolon
id|EXIT_ABORT
suffix:colon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_SATN
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
r_return
suffix:semicolon
id|EXIT_OK
suffix:colon
id|DEB_RESEL
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: nexus established, target = %d, lun = %d, tag = %d&bslash;n&quot;
comma
id|instance-&gt;host_no
comma
id|target
comma
id|tmp-&gt;lun
comma
id|tmp-&gt;tag
)paren
)paren
suffix:semicolon
id|AM53C974_set_sync
c_func
(paren
id|instance
comma
id|target
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|SDIDREG
comma
id|SDIREG_MASK
op_amp
id|target
)paren
suffix:semicolon
multiline_comment|/* setup dest. id  */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_MA
)paren
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;connected-&gt;SCp.phase
op_assign
id|PHASE_CMDOUT
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_transfer_dma(struct Scsi_Host *instance, short dir,&n;*                                  unsigned long length, char *data)&n;*&n;* Purpose : setup DMA transfer&n;*&n;* Inputs : instance -- which AM53C974&n;*          dir -- direction flag, 0: write to device, read from memory; &n;*                                 1: read from device, write to memory&n;*          length -- number of bytes to transfer to from buffer&n;*          data -- pointer to data buffer&n;* &n;* Returns : nothing&n;**************************************************************************/
DECL|function|AM53C974_transfer_dma
r_static
id|__inline__
r_void
id|AM53C974_transfer_dma
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
id|dir
comma
r_int
r_int
id|length
comma
r_char
op_star
id|data
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_NOP
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
(paren
id|dir
op_lshift
l_int|7
)paren
op_or
id|DMACMD_INTE_D
)paren
suffix:semicolon
multiline_comment|/* idle command */
id|AM53C974_write_8
c_func
(paren
id|STCLREG
comma
(paren
r_int
r_char
)paren
(paren
id|length
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|STCMREG
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|length
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|STCHREG
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|length
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|AM53C974_write_32
c_func
(paren
id|DMASTC
comma
id|length
op_amp
l_int|0xffffff
)paren
suffix:semicolon
id|AM53C974_write_32
c_func
(paren
id|DMASPA
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_IT
op_or
id|CMDREG_DMA
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
(paren
id|dir
op_lshift
l_int|7
)paren
op_or
id|DMACMD_INTE_D
op_or
id|DMACMD_START
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_dma_blast(struct Scsi_Host *instance, unsigned char dmastatus,&n;*                               unsigned char statreg)&n;*&n;* Purpose : cleanup DMA transfer&n;*&n;* Inputs : instance -- which AM53C974&n;*          dmastatus -- dma status register&n;*          statreg -- status register&n;* &n;* Returns : nothing&n;**************************************************************************/
DECL|function|AM53C974_dma_blast
r_static
r_void
id|AM53C974_dma_blast
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
r_int
r_char
id|dmastatus
comma
r_int
r_char
id|statreg
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
r_int
r_int
id|ctcreg
suffix:semicolon
r_int
id|dir
op_assign
id|statreg
op_amp
id|STATREG_IO
suffix:semicolon
r_int
id|cfifo
comma
id|pio
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
r_do
(brace
id|cfifo
op_assign
id|AM53C974_cfifo
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cfifo
op_logical_and
(paren
id|i
OL
l_int|50000
)paren
)paren
suffix:semicolon
id|pio
op_assign
(paren
id|i
op_eq
l_int|50000
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|statreg
op_amp
id|STATREG_CTZ
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmastatus
op_amp
id|DMASTATUS_DONE
)paren
(brace
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
(paren
(paren
id|dir
op_lshift
l_int|7
)paren
op_amp
id|DMACMD_DIR
)paren
op_or
id|DMACMD_BLAST
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|AM53C974_read_8
c_func
(paren
id|DMASTATUS
)paren
op_amp
id|DMASTATUS_BCMPLT
)paren
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|DMACMD
comma
id|DMACMD_IDLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pio
)paren
(brace
multiline_comment|/* transfer residual bytes via PIO */
r_int
r_char
op_star
id|wac
op_assign
(paren
r_int
r_char
op_star
)paren
id|AM53C974_read_32
c_func
(paren
id|DMAWAC
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pio mode, residual=%d&bslash;n&quot;
comma
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|AM53C974_read_8
c_func
(paren
id|CFIREG
)paren
op_amp
id|CFIREG_CF
)paren
op_star
(paren
id|wac
op_increment
)paren
op_assign
id|AM53C974_read_8
c_func
(paren
id|FFREG
)paren
suffix:semicolon
)brace
id|ctcreg
op_assign
id|AM53C974_read_8
c_func
(paren
id|CTCLREG
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCMREG
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|AM53C974_read_8
c_func
(paren
id|CTCHREG
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|hostdata-&gt;connected-&gt;SCp.ptr
op_add_assign
id|hostdata-&gt;connected-&gt;SCp.this_residual
op_minus
id|ctcreg
suffix:semicolon
id|hostdata-&gt;connected-&gt;SCp.this_residual
op_assign
id|ctcreg
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : AM53C974_intr_bus_reset(struct Scsi_Host *instance)&n;*&n;* Purpose : handle bus reset interrupt&n;*&n;* Inputs : instance -- which AM53C974&n;* &n;* Returns : nothing&n;**************************************************************************/
DECL|function|AM53C974_intr_bus_reset
r_static
r_void
id|AM53C974_intr_bus_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
r_char
id|cntlreg1
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_CFIFO
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_NOP
)paren
suffix:semicolon
id|cntlreg1
op_assign
id|AM53C974_read_8
c_func
(paren
id|CNTLREG1
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CNTLREG1
comma
id|cntlreg1
op_or
id|CNTLREG1_DISR
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* Function : int AM53C974_abort(Scsi_Cmnd *cmd)&n;*&n;* Purpose : abort a command&n;*&n;* Inputs : cmd - the Scsi_Cmnd to abort, code - code to set the &n;* &t;host byte of the result field to, if zero DID_ABORTED is &n;*&t;used.&n;*&n;* Returns : 0 - success, -1 on failure.&n; **************************************************************************/
DECL|function|AM53C974_abort
r_static
r_int
id|AM53C974_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
op_assign
id|cmd-&gt;host
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|Scsi_Cmnd
op_star
id|tmp
comma
op_star
op_star
id|prev
suffix:semicolon
macro_line|#ifdef AM53C974_DEBUG
id|deb_stop
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
id|SEPARATOR_LINE
)paren
)paren
suffix:semicolon
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : AM53C974_abort called -- trouble starts!!&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEB_ABORT
c_func
(paren
id|AM53C974_print
c_func
(paren
id|instance
)paren
)paren
suffix:semicolon
id|DEB_ABORT
c_func
(paren
id|AM53C974_keywait
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Case 1 : If the command is the currently executing command, &n;   we&squot;ll set the aborted flag and return control so that the&n;   information transfer routine can exit cleanly. */
r_if
c_cond
(paren
(paren
id|hostdata-&gt;connected
op_eq
id|cmd
)paren
op_logical_or
(paren
id|hostdata-&gt;sel_cmd
op_eq
id|cmd
)paren
)paren
(brace
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: aborting connected command&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_PENDING
)paren
suffix:semicolon
)brace
multiline_comment|/* Case 2 : If the command hasn&squot;t been issued yet,&n;   we simply remove it from the issue queue. */
r_for
c_loop
(paren
id|prev
op_assign
(paren
id|Scsi_Cmnd
op_star
op_star
)paren
op_amp
(paren
id|hostdata-&gt;issue_queue
)paren
comma
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;issue_queue
suffix:semicolon
id|tmp
suffix:semicolon
id|prev
op_assign
(paren
id|Scsi_Cmnd
op_star
op_star
)paren
op_amp
(paren
id|tmp-&gt;host_scribble
)paren
comma
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|tmp
)paren
(brace
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : abort removed command from issue queue.&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|REMOVE
c_func
(paren
l_int|5
comma
op_star
id|prev
comma
id|tmp
comma
id|tmp-&gt;host_scribble
)paren
suffix:semicolon
(paren
op_star
id|prev
)paren
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
suffix:semicolon
id|tmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|tmp-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_member_access_from_pointer
id|done
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_SUCCESS
)paren
suffix:semicolon
)brace
macro_line|#ifdef AM53C974_DEBUG_ABORT
r_else
(brace
r_if
c_cond
(paren
id|prev
op_eq
(paren
id|Scsi_Cmnd
op_star
op_star
)paren
id|tmp
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : LOOP&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* Case 3 : If any commands are connected, we&squot;re going to fail the abort&n; *        and let the high level SCSI driver retry at a later time or &n; *          issue a reset.&n; *&n; *          Timeouts, and therefore aborted commands, will be highly unlikely&n; *          and handling them cleanly in this situation would make the common&n; *          case of noresets less efficient, and would pollute our code.  So,&n; *          we fail. */
r_if
c_cond
(paren
id|hostdata-&gt;connected
op_logical_or
id|hostdata-&gt;sel_cmd
)paren
(brace
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : abort failed, other command connected.&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
multiline_comment|/* Case 4: If the command is currently disconnected from the bus, and &n; *       there are no connected commands, we reconnect the I_T_L or &n; *         I_T_L_Q nexus associated with it, go into message out, and send &n; *         an abort message. */
r_for
c_loop
(paren
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|hostdata-&gt;disconnected_queue
suffix:semicolon
id|tmp
suffix:semicolon
id|tmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|tmp-&gt;host_scribble
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|tmp
)paren
(brace
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: aborting disconnected command&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
id|tmp
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_DSR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_PENDING
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Case 5 : If we reached this point, the command was not found in any of &n; *        the queues.&n; *&n; * We probably reached this point because of an unlikely race condition&n; * between the command completing successfully and the abortion code,&n; * so we won&squot;t panic, but we will notify the user in case something really&n; * broke. */
id|DEB_ABORT
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d : abort failed, command not found.&bslash;n&quot;
comma
id|instance-&gt;host_no
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************** &n;* Function : int AM53C974_reset(Scsi_Cmnd *cmd)&n;*&n;* Purpose : reset the SCSI controller and bus&n;*&n;* Inputs : cmd -- which command within the command block was responsible for the reset&n;* &n;* Returns : status (SCSI_ABORT_SUCCESS)&n;* &n;* FIXME(eric) the reset_flags are ignored.&n;**************************************************************************/
DECL|function|AM53C974_reset
r_static
r_int
id|AM53C974_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|AM53C974_local_declare
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|instance
op_assign
id|cmd-&gt;host
suffix:semicolon
r_struct
id|AM53C974_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|AM53C974_hostdata
op_star
)paren
id|instance-&gt;hostdata
suffix:semicolon
id|AM53C974_setio
c_func
(paren
id|instance
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;AM53C974_reset called; &quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AM53C974_reset called&bslash;n&quot;
)paren
suffix:semicolon
id|AM53C974_print
c_func
(paren
id|instance
)paren
suffix:semicolon
id|AM53C974_keywait
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* do hard reset */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_RDEV
)paren
suffix:semicolon
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_NOP
)paren
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hostdata-&gt;busy
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;sync_per
(braket
id|i
)braket
op_assign
id|DEF_STP
suffix:semicolon
id|hostdata-&gt;sync_off
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;sync_neg
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|hostdata-&gt;last_message
(braket
l_int|0
)braket
op_assign
id|NOP
suffix:semicolon
id|hostdata-&gt;sel_cmd
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;connected
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;issue_queue
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;disconnected_queue
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;in_reset
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;aborted
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;selecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;disconnecting
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;dma_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset bus */
id|AM53C974_write_8
c_func
(paren
id|CNTLREG1
comma
id|CNTLREG1_DISR
op_or
id|instance-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* disable interrupt upon SCSI RESET */
id|AM53C974_write_8
c_func
(paren
id|CMDREG
comma
id|CMDREG_RBUS
)paren
suffix:semicolon
multiline_comment|/* reset SCSI bus */
id|udelay
c_func
(paren
l_int|40
)paren
suffix:semicolon
id|AM53C974_config_after_reset
c_func
(paren
id|instance
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * AM53C974_release()&n; *&n; * Release resources allocated for a single AM53C974 adapter.&n; */
DECL|function|AM53C974_release
r_static
r_int
id|AM53C974_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shp
)paren
(brace
id|free_irq
c_func
(paren
id|shp-&gt;irq
comma
id|shp
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|shp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* You can specify overrides=a,b,c,d in the same format at AM53C974=a,b,c,d&n;   on boot up */
id|MODULE_PARM
c_func
(paren
id|overrides
comma
l_string|&quot;1-32i&quot;
)paren
suffix:semicolon
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|AM53C974
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
