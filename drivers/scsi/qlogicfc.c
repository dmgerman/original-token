multiline_comment|/*&n; * QLogic ISP2x00 SCSI-FCP&n; * Written by Erik H. Moe, ehm@cris.com&n; * Copyright 1995, Erik H. Moe&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; */
multiline_comment|/* Renamed and updated to 1.3.x by Michael Griffith &lt;grif@cs.ucr.edu&gt; */
multiline_comment|/* This is a version of the isp1020 driver which was modified by&n; * Chris Loveland &lt;cwl@iol.unh.edu&gt; to support the isp2100 and isp2200&n; *&n; * Big endian support and dynamic DMA mapping added&n; * by Jakub Jelinek &lt;jakub@redhat.com&gt;.&n; */
multiline_comment|/*&n; * $Date: 1995/09/22 02:23:15 $&n; * $Revision: 0.5 $&n; *&n; * $Log: isp1020.c,v $&n; * Revision 0.5  1995/09/22  02:23:15  root&n; * do auto request sense&n; *&n; * Revision 0.4  1995/08/07  04:44:33  root&n; * supply firmware with driver.&n; * numerous bug fixes/general cleanup of code.&n; *&n; * Revision 0.3  1995/07/16  16:15:39  root&n; * added reset/abort code.&n; *&n; * Revision 0.2  1995/06/29  03:14:19  root&n; * fixed biosparam.&n; * added queue protocol.&n; *&n; * Revision 0.1  1995/06/25  01:55:45  root&n; * Initial release.&n; *&n; */
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#if 1
multiline_comment|/* Once pci64_ DMA mapping interface is in, kill this. */
DECL|typedef|dma64_addr_t
r_typedef
id|dma_addr_t
id|dma64_addr_t
suffix:semicolon
DECL|macro|pci64_alloc_consistent
mdefine_line|#define pci64_alloc_consistent(d,s,p) pci_alloc_consistent((d),(s),(p))
DECL|macro|pci64_free_consistent
mdefine_line|#define pci64_free_consistent(d,s,c,a) pci_free_consistent((d),(s),(c),(a))
DECL|macro|pci64_map_single
mdefine_line|#define pci64_map_single(d,c,s,dir) pci_map_single((d),(c),(s),(dir))
DECL|macro|pci64_map_sg
mdefine_line|#define pci64_map_sg(d,s,n,dir) pci_map_sg((d),(s),(n),(dir))
DECL|macro|pci64_unmap_single
mdefine_line|#define pci64_unmap_single(d,a,s,dir) pci_unmap_single((d),(a),(s),(dir))
DECL|macro|pci64_unmap_sg
mdefine_line|#define pci64_unmap_sg(d,s,n,dir) pci_unmap_sg((d),(s),(n),(dir))
macro_line|#if BITS_PER_LONG &gt; 32
DECL|macro|pci64_dma_hi32
mdefine_line|#define pci64_dma_hi32(a) ((u32) (0xffffffff &amp; (((u64)(a))&gt;&gt;32)))
DECL|macro|pci64_dma_lo32
mdefine_line|#define pci64_dma_lo32(a) ((u32) (0xffffffff &amp; (((u64)(a)))))
macro_line|#else
DECL|macro|pci64_dma_hi32
mdefine_line|#define pci64_dma_hi32(a) 0
DECL|macro|pci64_dma_lo32
mdefine_line|#define pci64_dma_lo32(a) (a)
macro_line|#endif&t;/* BITS_PER_LONG */
DECL|macro|pci64_dma_build
mdefine_line|#define pci64_dma_build(hi,lo) (lo)
DECL|macro|sg_dma64_address
mdefine_line|#define sg_dma64_address(s) sg_dma_address(s)
DECL|macro|sg_dma64_len
mdefine_line|#define sg_dma64_len(s) sg_dma_len(s)
macro_line|#if BITS_PER_LONG &gt; 32
DECL|macro|PCI64_DMA_BITS
mdefine_line|#define PCI64_DMA_BITS 64
macro_line|#else
DECL|macro|PCI64_DMA_BITS
mdefine_line|#define PCI64_DMA_BITS&t;32
macro_line|#endif &t;/* BITS_PER_LONG */
macro_line|#endif
macro_line|#include &quot;qlogicfc.h&quot;
multiline_comment|/* Configuration section **************************************************** */
multiline_comment|/* Set the following macro to 1 to reload the ISP2x00&squot;s firmware.  This is&n;   version 1.17.30 of the isp2100&squot;s firmware and version 2.00.40 of the &n;   isp2200&squot;s firmware. &n;*/
DECL|macro|RELOAD_FIRMWARE
mdefine_line|#define RELOAD_FIRMWARE&t;&t;1
DECL|macro|USE_NVRAM_DEFAULTS
mdefine_line|#define USE_NVRAM_DEFAULTS      1
DECL|macro|ISP2x00_PORTDB
mdefine_line|#define ISP2x00_PORTDB          1
multiline_comment|/* Set the following to 1 to include fabric support, fabric support is &n; * currently not as well tested as the other aspects of the driver */
DECL|macro|ISP2x00_FABRIC
mdefine_line|#define ISP2x00_FABRIC          1
multiline_comment|/*  Macros used for debugging */
DECL|macro|DEBUG_ISP2x00
mdefine_line|#define DEBUG_ISP2x00&t;&t;0
DECL|macro|DEBUG_ISP2x00_INT
mdefine_line|#define DEBUG_ISP2x00_INT&t;0
DECL|macro|DEBUG_ISP2x00_INTR
mdefine_line|#define DEBUG_ISP2x00_INTR&t;0
DECL|macro|DEBUG_ISP2x00_SETUP
mdefine_line|#define DEBUG_ISP2x00_SETUP&t;0
DECL|macro|DEBUG_ISP2x00_FABRIC
mdefine_line|#define DEBUG_ISP2x00_FABRIC    0
DECL|macro|TRACE_ISP
mdefine_line|#define TRACE_ISP &t;&t;0 
DECL|macro|DEFAULT_LOOP_COUNT
mdefine_line|#define DEFAULT_LOOP_COUNT&t;1000000000
multiline_comment|/* End Configuration section ************************************************ */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#if TRACE_ISP
DECL|macro|TRACE_BUF_LEN
mdefine_line|#define TRACE_BUF_LEN&t;(32*1024)
r_struct
(brace
DECL|member|next
id|u_long
id|next
suffix:semicolon
r_struct
(brace
DECL|member|time
id|u_long
id|time
suffix:semicolon
DECL|member|index
id|u_int
id|index
suffix:semicolon
DECL|member|addr
id|u_int
id|addr
suffix:semicolon
DECL|member|name
id|u_char
op_star
id|name
suffix:semicolon
DECL|member|buf
)brace
id|buf
(braket
id|TRACE_BUF_LEN
)braket
suffix:semicolon
DECL|variable|trace
)brace
id|trace
suffix:semicolon
DECL|macro|TRACE
mdefine_line|#define TRACE(w, i, a)&t;&t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;unsigned long flags;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;save_flags(flags);&t;&t;&t;&t;&t;&bslash;&n;&t;cli();&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;trace.buf[trace.next].name  = (w);&t;&t;&t;&bslash;&n;&t;trace.buf[trace.next].time  = jiffies;&t;&t;&t;&bslash;&n;&t;trace.buf[trace.next].index = (i);&t;&t;&t;&bslash;&n;&t;trace.buf[trace.next].addr  = (long) (a);&t;&t;&bslash;&n;&t;trace.next = (trace.next + 1) &amp; (TRACE_BUF_LEN - 1);&t;&bslash;&n;&t;restore_flags(flags);&t;&t;&t;&t;&t;&bslash;&n;}
macro_line|#else
DECL|macro|TRACE
mdefine_line|#define TRACE(w, i, a)
macro_line|#endif
macro_line|#if DEBUG_ISP2x00_FABRIC
DECL|macro|DEBUG_FABRIC
mdefine_line|#define DEBUG_FABRIC(x)&t;x
macro_line|#else
DECL|macro|DEBUG_FABRIC
mdefine_line|#define DEBUG_FABRIC(x)
macro_line|#endif&t;&t;&t;&t;/* DEBUG_ISP2x00_FABRIC */
macro_line|#if DEBUG_ISP2x00
DECL|macro|ENTER
mdefine_line|#define ENTER(x)&t;printk(&quot;isp2x00 : entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)&t;printk(&quot;isp2x00 : leaving %s()&bslash;n&quot;, x);
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;x
macro_line|#else
DECL|macro|ENTER
mdefine_line|#define ENTER(x)
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)
macro_line|#endif&t;&t;&t;&t;/* DEBUG_ISP2x00 */
macro_line|#if DEBUG_ISP2x00_INTR
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)&t;printk(&quot;isp2x00 : entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)&t;printk(&quot;isp2x00 : leaving %s()&bslash;n&quot;, x);
DECL|macro|DEBUG_INTR
mdefine_line|#define DEBUG_INTR(x)&t;x
macro_line|#else
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)
DECL|macro|DEBUG_INTR
mdefine_line|#define DEBUG_INTR(x)
macro_line|#endif&t;&t;&t;&t;/* DEBUG ISP2x00_INTR */
DECL|macro|ISP2100_REV_ID1
mdefine_line|#define ISP2100_REV_ID1&t;       1
DECL|macro|ISP2100_REV_ID3
mdefine_line|#define ISP2100_REV_ID3        3
DECL|macro|ISP2200_REV_ID5
mdefine_line|#define ISP2200_REV_ID5        5
multiline_comment|/* host configuration and control registers */
DECL|macro|HOST_HCCR
mdefine_line|#define HOST_HCCR&t;0xc0&t;/* host command and control */
multiline_comment|/* pci bus interface registers */
DECL|macro|FLASH_BIOS_ADDR
mdefine_line|#define FLASH_BIOS_ADDR&t;0x00
DECL|macro|FLASH_BIOS_DATA
mdefine_line|#define FLASH_BIOS_DATA&t;0x02
DECL|macro|ISP_CTRL_STATUS
mdefine_line|#define ISP_CTRL_STATUS&t;0x06&t;/* configuration register #1 */
DECL|macro|PCI_INTER_CTL
mdefine_line|#define PCI_INTER_CTL&t;0x08&t;/* pci interupt control */
DECL|macro|PCI_INTER_STS
mdefine_line|#define PCI_INTER_STS&t;0x0a&t;/* pci interupt status */
DECL|macro|PCI_SEMAPHORE
mdefine_line|#define PCI_SEMAPHORE&t;0x0c&t;/* pci semaphore */
DECL|macro|PCI_NVRAM
mdefine_line|#define PCI_NVRAM&t;0x0e&t;/* pci nvram interface */
multiline_comment|/* mailbox registers */
DECL|macro|MBOX0
mdefine_line|#define MBOX0&t;&t;0x10&t;/* mailbox 0 */
DECL|macro|MBOX1
mdefine_line|#define MBOX1&t;&t;0x12&t;/* mailbox 1 */
DECL|macro|MBOX2
mdefine_line|#define MBOX2&t;&t;0x14&t;/* mailbox 2 */
DECL|macro|MBOX3
mdefine_line|#define MBOX3&t;&t;0x16&t;/* mailbox 3 */
DECL|macro|MBOX4
mdefine_line|#define MBOX4&t;&t;0x18&t;/* mailbox 4 */
DECL|macro|MBOX5
mdefine_line|#define MBOX5&t;&t;0x1a&t;/* mailbox 5 */
DECL|macro|MBOX6
mdefine_line|#define MBOX6&t;&t;0x1c&t;/* mailbox 6 */
DECL|macro|MBOX7
mdefine_line|#define MBOX7&t;&t;0x1e&t;/* mailbox 7 */
multiline_comment|/* mailbox command complete status codes */
DECL|macro|MBOX_COMMAND_COMPLETE
mdefine_line|#define MBOX_COMMAND_COMPLETE&t;&t;0x4000
DECL|macro|INVALID_COMMAND
mdefine_line|#define INVALID_COMMAND&t;&t;&t;0x4001
DECL|macro|HOST_INTERFACE_ERROR
mdefine_line|#define HOST_INTERFACE_ERROR&t;&t;0x4002
DECL|macro|TEST_FAILED
mdefine_line|#define TEST_FAILED&t;&t;&t;0x4003
DECL|macro|COMMAND_ERROR
mdefine_line|#define COMMAND_ERROR&t;&t;&t;0x4005
DECL|macro|COMMAND_PARAM_ERROR
mdefine_line|#define COMMAND_PARAM_ERROR&t;&t;0x4006
DECL|macro|PORT_ID_USED
mdefine_line|#define PORT_ID_USED                    0x4007
DECL|macro|LOOP_ID_USED
mdefine_line|#define LOOP_ID_USED                    0x4008
DECL|macro|ALL_IDS_USED
mdefine_line|#define ALL_IDS_USED                    0x4009
multiline_comment|/* async event status codes */
DECL|macro|RESET_DETECTED
mdefine_line|#define RESET_DETECTED  &t;&t;0x8001
DECL|macro|SYSTEM_ERROR
mdefine_line|#define SYSTEM_ERROR&t;&t;&t;0x8002
DECL|macro|REQUEST_TRANSFER_ERROR
mdefine_line|#define REQUEST_TRANSFER_ERROR&t;&t;0x8003
DECL|macro|RESPONSE_TRANSFER_ERROR
mdefine_line|#define RESPONSE_TRANSFER_ERROR&t;&t;0x8004
DECL|macro|REQUEST_QUEUE_WAKEUP
mdefine_line|#define REQUEST_QUEUE_WAKEUP&t;&t;0x8005
DECL|macro|LIP_OCCURED
mdefine_line|#define LIP_OCCURED                     0x8010
DECL|macro|LOOP_UP
mdefine_line|#define LOOP_UP                         0x8011
DECL|macro|LOOP_DOWN
mdefine_line|#define LOOP_DOWN                       0x8012
DECL|macro|LIP_RECEIVED
mdefine_line|#define LIP_RECEIVED                    0x8013
DECL|macro|PORT_DB_CHANGED
mdefine_line|#define PORT_DB_CHANGED                 0x8014
DECL|macro|CHANGE_NOTIFICATION
mdefine_line|#define CHANGE_NOTIFICATION             0x8015
DECL|macro|SCSI_COMMAND_COMPLETE
mdefine_line|#define SCSI_COMMAND_COMPLETE           0x8020
DECL|macro|POINT_TO_POINT_UP
mdefine_line|#define POINT_TO_POINT_UP               0x8030
DECL|macro|CONNECTION_MODE
mdefine_line|#define CONNECTION_MODE                 0x8036
DECL|struct|Entry_header
r_struct
id|Entry_header
(brace
DECL|member|entry_type
id|u_char
id|entry_type
suffix:semicolon
DECL|member|entry_cnt
id|u_char
id|entry_cnt
suffix:semicolon
DECL|member|sys_def_1
id|u_char
id|sys_def_1
suffix:semicolon
DECL|member|flags
id|u_char
id|flags
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* entry header type commands */
macro_line|#if PCI64_DMA_BITS &gt; 32
DECL|macro|ENTRY_COMMAND
mdefine_line|#define ENTRY_COMMAND&t;&t;0x19
DECL|macro|ENTRY_CONTINUATION
mdefine_line|#define ENTRY_CONTINUATION&t;0x0a
macro_line|#else
DECL|macro|ENTRY_COMMAND
mdefine_line|#define ENTRY_COMMAND&t;&t;0x11
DECL|macro|ENTRY_CONTINUATION
mdefine_line|#define ENTRY_CONTINUATION&t;0x02
macro_line|#endif
DECL|macro|ENTRY_STATUS
mdefine_line|#define ENTRY_STATUS&t;&t;0x03
DECL|macro|ENTRY_MARKER
mdefine_line|#define ENTRY_MARKER&t;&t;0x04
multiline_comment|/* entry header flag definitions */
DECL|macro|EFLAG_BUSY
mdefine_line|#define EFLAG_BUSY&t;&t;2
DECL|macro|EFLAG_BAD_HEADER
mdefine_line|#define EFLAG_BAD_HEADER&t;4
DECL|macro|EFLAG_BAD_PAYLOAD
mdefine_line|#define EFLAG_BAD_PAYLOAD&t;8
macro_line|#if PCI64_DMA_BITS &gt; 32
DECL|struct|dataseg
r_struct
id|dataseg
(brace
DECL|member|d_base
id|u_int
id|d_base
suffix:semicolon
DECL|member|d_base_hi
id|u_int
id|d_base_hi
suffix:semicolon
DECL|member|d_count
id|u_int
id|d_count
suffix:semicolon
)brace
suffix:semicolon
macro_line|#else
DECL|struct|dataseg
r_struct
id|dataseg
(brace
DECL|member|d_base
id|u_int
id|d_base
suffix:semicolon
DECL|member|d_count
id|u_int
id|d_count
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
DECL|struct|Command_Entry
r_struct
id|Command_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|handle
id|u_int
id|handle
suffix:semicolon
DECL|member|target_lun
id|u_char
id|target_lun
suffix:semicolon
DECL|member|target_id
id|u_char
id|target_id
suffix:semicolon
DECL|member|expanded_lun
id|u_short
id|expanded_lun
suffix:semicolon
DECL|member|control_flags
id|u_short
id|control_flags
suffix:semicolon
DECL|member|rsvd2
id|u_short
id|rsvd2
suffix:semicolon
DECL|member|time_out
id|u_short
id|time_out
suffix:semicolon
DECL|member|segment_cnt
id|u_short
id|segment_cnt
suffix:semicolon
DECL|member|cdb
id|u_char
id|cdb
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|total_byte_cnt
id|u_int
id|total_byte_cnt
suffix:semicolon
DECL|member|dataseg
r_struct
id|dataseg
id|dataseg
(braket
id|DATASEGS_PER_COMMAND
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* command entry control flag definitions */
DECL|macro|CFLAG_NODISC
mdefine_line|#define CFLAG_NODISC&t;&t;0x01
DECL|macro|CFLAG_HEAD_TAG
mdefine_line|#define CFLAG_HEAD_TAG&t;&t;0x02
DECL|macro|CFLAG_ORDERED_TAG
mdefine_line|#define CFLAG_ORDERED_TAG&t;0x04
DECL|macro|CFLAG_SIMPLE_TAG
mdefine_line|#define CFLAG_SIMPLE_TAG&t;0x08
DECL|macro|CFLAG_TAR_RTN
mdefine_line|#define CFLAG_TAR_RTN&t;&t;0x10
DECL|macro|CFLAG_READ
mdefine_line|#define CFLAG_READ&t;&t;0x20
DECL|macro|CFLAG_WRITE
mdefine_line|#define CFLAG_WRITE&t;&t;0x40
macro_line|#if PCI64_DMA_BITS &gt; 32
DECL|struct|Continuation_Entry
r_struct
id|Continuation_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|dataseg
r_struct
id|dataseg
id|dataseg
(braket
id|DATASEGS_PER_CONT
)braket
suffix:semicolon
)brace
suffix:semicolon
macro_line|#else
DECL|struct|Continuation_Entry
r_struct
id|Continuation_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|rsvd
id|u32
id|rsvd
suffix:semicolon
DECL|member|dataseg
r_struct
id|dataseg
id|dataseg
(braket
id|DATASEGS_PER_CONT
)braket
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
DECL|struct|Marker_Entry
r_struct
id|Marker_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|reserved
id|u_int
id|reserved
suffix:semicolon
DECL|member|target_lun
id|u_char
id|target_lun
suffix:semicolon
DECL|member|target_id
id|u_char
id|target_id
suffix:semicolon
DECL|member|modifier
id|u_char
id|modifier
suffix:semicolon
DECL|member|expanded_lun
id|u_char
id|expanded_lun
suffix:semicolon
DECL|member|rsvds
id|u_char
id|rsvds
(braket
l_int|52
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* marker entry modifier definitions */
DECL|macro|SYNC_DEVICE
mdefine_line|#define SYNC_DEVICE&t;0
DECL|macro|SYNC_TARGET
mdefine_line|#define SYNC_TARGET&t;1
DECL|macro|SYNC_ALL
mdefine_line|#define SYNC_ALL&t;2
DECL|struct|Status_Entry
r_struct
id|Status_Entry
(brace
DECL|member|hdr
r_struct
id|Entry_header
id|hdr
suffix:semicolon
DECL|member|handle
id|u_int
id|handle
suffix:semicolon
DECL|member|scsi_status
id|u_short
id|scsi_status
suffix:semicolon
DECL|member|completion_status
id|u_short
id|completion_status
suffix:semicolon
DECL|member|state_flags
id|u_short
id|state_flags
suffix:semicolon
DECL|member|status_flags
id|u_short
id|status_flags
suffix:semicolon
DECL|member|res_info_len
id|u_short
id|res_info_len
suffix:semicolon
DECL|member|req_sense_len
id|u_short
id|req_sense_len
suffix:semicolon
DECL|member|residual
id|u_int
id|residual
suffix:semicolon
DECL|member|res_info
id|u_char
id|res_info
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|req_sense_data
id|u_char
id|req_sense_data
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* status entry completion status definitions */
DECL|macro|CS_COMPLETE
mdefine_line|#define CS_COMPLETE&t;&t;&t;0x0000
DECL|macro|CS_DMA_ERROR
mdefine_line|#define CS_DMA_ERROR&t;&t;&t;0x0002
DECL|macro|CS_RESET_OCCURRED
mdefine_line|#define CS_RESET_OCCURRED&t;&t;0x0004
DECL|macro|CS_ABORTED
mdefine_line|#define CS_ABORTED&t;&t;&t;0x0005
DECL|macro|CS_TIMEOUT
mdefine_line|#define CS_TIMEOUT&t;&t;&t;0x0006
DECL|macro|CS_DATA_OVERRUN
mdefine_line|#define CS_DATA_OVERRUN&t;&t;&t;0x0007
DECL|macro|CS_DATA_UNDERRUN
mdefine_line|#define CS_DATA_UNDERRUN&t;&t;0x0015
DECL|macro|CS_QUEUE_FULL
mdefine_line|#define CS_QUEUE_FULL&t;&t;&t;0x001c
DECL|macro|CS_PORT_UNAVAILABLE
mdefine_line|#define CS_PORT_UNAVAILABLE             0x0028
DECL|macro|CS_PORT_LOGGED_OUT
mdefine_line|#define CS_PORT_LOGGED_OUT              0x0029
DECL|macro|CS_PORT_CONFIG_CHANGED
mdefine_line|#define CS_PORT_CONFIG_CHANGED&t;&t;0x002a
multiline_comment|/* status entry state flag definitions */
DECL|macro|SF_SENT_CDB
mdefine_line|#define SF_SENT_CDB&t;&t;&t;0x0400
DECL|macro|SF_TRANSFERRED_DATA
mdefine_line|#define SF_TRANSFERRED_DATA&t;&t;0x0800
DECL|macro|SF_GOT_STATUS
mdefine_line|#define SF_GOT_STATUS&t;&t;&t;0x1000
multiline_comment|/* status entry status flag definitions */
DECL|macro|STF_BUS_RESET
mdefine_line|#define STF_BUS_RESET&t;&t;&t;0x0008
DECL|macro|STF_DEVICE_RESET
mdefine_line|#define STF_DEVICE_RESET&t;&t;0x0010
DECL|macro|STF_ABORTED
mdefine_line|#define STF_ABORTED&t;&t;&t;0x0020
DECL|macro|STF_TIMEOUT
mdefine_line|#define STF_TIMEOUT&t;&t;&t;0x0040
multiline_comment|/* interupt control commands */
DECL|macro|ISP_EN_INT
mdefine_line|#define ISP_EN_INT&t;&t;&t;0x8000
DECL|macro|ISP_EN_RISC
mdefine_line|#define ISP_EN_RISC&t;&t;&t;0x0008
multiline_comment|/* host control commands */
DECL|macro|HCCR_NOP
mdefine_line|#define HCCR_NOP&t;&t;&t;0x0000
DECL|macro|HCCR_RESET
mdefine_line|#define HCCR_RESET&t;&t;&t;0x1000
DECL|macro|HCCR_PAUSE
mdefine_line|#define HCCR_PAUSE&t;&t;&t;0x2000
DECL|macro|HCCR_RELEASE
mdefine_line|#define HCCR_RELEASE&t;&t;&t;0x3000
DECL|macro|HCCR_SINGLE_STEP
mdefine_line|#define HCCR_SINGLE_STEP&t;&t;0x4000
DECL|macro|HCCR_SET_HOST_INTR
mdefine_line|#define HCCR_SET_HOST_INTR&t;&t;0x5000
DECL|macro|HCCR_CLEAR_HOST_INTR
mdefine_line|#define HCCR_CLEAR_HOST_INTR&t;&t;0x6000
DECL|macro|HCCR_CLEAR_RISC_INTR
mdefine_line|#define HCCR_CLEAR_RISC_INTR&t;&t;0x7000
DECL|macro|HCCR_BP_ENABLE
mdefine_line|#define HCCR_BP_ENABLE&t;&t;&t;0x8000
DECL|macro|HCCR_BIOS_DISABLE
mdefine_line|#define HCCR_BIOS_DISABLE&t;&t;0x9000
DECL|macro|HCCR_TEST_MODE
mdefine_line|#define HCCR_TEST_MODE&t;&t;&t;0xf000
DECL|macro|RISC_BUSY
mdefine_line|#define RISC_BUSY&t;&t;&t;0x0004
multiline_comment|/* mailbox commands */
DECL|macro|MBOX_NO_OP
mdefine_line|#define MBOX_NO_OP&t;&t;&t;0x0000
DECL|macro|MBOX_LOAD_RAM
mdefine_line|#define MBOX_LOAD_RAM&t;&t;&t;0x0001
DECL|macro|MBOX_EXEC_FIRMWARE
mdefine_line|#define MBOX_EXEC_FIRMWARE&t;&t;0x0002
DECL|macro|MBOX_DUMP_RAM
mdefine_line|#define MBOX_DUMP_RAM&t;&t;&t;0x0003
DECL|macro|MBOX_WRITE_RAM_WORD
mdefine_line|#define MBOX_WRITE_RAM_WORD&t;&t;0x0004
DECL|macro|MBOX_READ_RAM_WORD
mdefine_line|#define MBOX_READ_RAM_WORD&t;&t;0x0005
DECL|macro|MBOX_MAILBOX_REG_TEST
mdefine_line|#define MBOX_MAILBOX_REG_TEST&t;&t;0x0006
DECL|macro|MBOX_VERIFY_CHECKSUM
mdefine_line|#define MBOX_VERIFY_CHECKSUM&t;&t;0x0007
DECL|macro|MBOX_ABOUT_FIRMWARE
mdefine_line|#define MBOX_ABOUT_FIRMWARE&t;&t;0x0008
DECL|macro|MBOX_LOAD_RISC_RAM
mdefine_line|#define MBOX_LOAD_RISC_RAM              0x0009
DECL|macro|MBOX_DUMP_RISC_RAM
mdefine_line|#define MBOX_DUMP_RISC_RAM              0x000a
DECL|macro|MBOX_CHECK_FIRMWARE
mdefine_line|#define MBOX_CHECK_FIRMWARE&t;&t;0x000e
DECL|macro|MBOX_INIT_REQ_QUEUE
mdefine_line|#define MBOX_INIT_REQ_QUEUE&t;&t;0x0010
DECL|macro|MBOX_INIT_RES_QUEUE
mdefine_line|#define MBOX_INIT_RES_QUEUE&t;&t;0x0011
DECL|macro|MBOX_EXECUTE_IOCB
mdefine_line|#define MBOX_EXECUTE_IOCB&t;&t;0x0012
DECL|macro|MBOX_WAKE_UP
mdefine_line|#define MBOX_WAKE_UP&t;&t;&t;0x0013
DECL|macro|MBOX_STOP_FIRMWARE
mdefine_line|#define MBOX_STOP_FIRMWARE&t;&t;0x0014
DECL|macro|MBOX_ABORT_IOCB
mdefine_line|#define MBOX_ABORT_IOCB&t;&t;&t;0x0015
DECL|macro|MBOX_ABORT_DEVICE
mdefine_line|#define MBOX_ABORT_DEVICE&t;&t;0x0016
DECL|macro|MBOX_ABORT_TARGET
mdefine_line|#define MBOX_ABORT_TARGET&t;&t;0x0017
DECL|macro|MBOX_BUS_RESET
mdefine_line|#define MBOX_BUS_RESET&t;&t;&t;0x0018
DECL|macro|MBOX_STOP_QUEUE
mdefine_line|#define MBOX_STOP_QUEUE&t;&t;&t;0x0019
DECL|macro|MBOX_START_QUEUE
mdefine_line|#define MBOX_START_QUEUE&t;&t;0x001a
DECL|macro|MBOX_SINGLE_STEP_QUEUE
mdefine_line|#define MBOX_SINGLE_STEP_QUEUE&t;&t;0x001b
DECL|macro|MBOX_ABORT_QUEUE
mdefine_line|#define MBOX_ABORT_QUEUE&t;&t;0x001c
DECL|macro|MBOX_GET_DEV_QUEUE_STATUS
mdefine_line|#define MBOX_GET_DEV_QUEUE_STATUS&t;0x001d
DECL|macro|MBOX_GET_FIRMWARE_STATUS
mdefine_line|#define MBOX_GET_FIRMWARE_STATUS&t;0x001f
DECL|macro|MBOX_GET_INIT_SCSI_ID
mdefine_line|#define MBOX_GET_INIT_SCSI_ID&t;&t;0x0020
DECL|macro|MBOX_GET_RETRY_COUNT
mdefine_line|#define MBOX_GET_RETRY_COUNT&t;&t;0x0022
DECL|macro|MBOX_GET_TARGET_PARAMS
mdefine_line|#define MBOX_GET_TARGET_PARAMS&t;&t;0x0028
DECL|macro|MBOX_GET_DEV_QUEUE_PARAMS
mdefine_line|#define MBOX_GET_DEV_QUEUE_PARAMS&t;0x0029
DECL|macro|MBOX_SET_RETRY_COUNT
mdefine_line|#define MBOX_SET_RETRY_COUNT&t;&t;0x0032
DECL|macro|MBOX_SET_TARGET_PARAMS
mdefine_line|#define MBOX_SET_TARGET_PARAMS&t;&t;0x0038
DECL|macro|MBOX_SET_DEV_QUEUE_PARAMS
mdefine_line|#define MBOX_SET_DEV_QUEUE_PARAMS&t;0x0039
DECL|macro|MBOX_EXECUTE_IOCB64
mdefine_line|#define MBOX_EXECUTE_IOCB64             0x0054
DECL|macro|MBOX_INIT_FIRMWARE
mdefine_line|#define MBOX_INIT_FIRMWARE              0x0060
DECL|macro|MBOX_GET_INIT_CB
mdefine_line|#define MBOX_GET_INIT_CB                0x0061
DECL|macro|MBOX_INIT_LIP
mdefine_line|#define MBOX_INIT_LIP&t;&t;&t;0x0062
DECL|macro|MBOX_GET_POS_MAP
mdefine_line|#define MBOX_GET_POS_MAP                0x0063
DECL|macro|MBOX_GET_PORT_DB
mdefine_line|#define MBOX_GET_PORT_DB                0x0064
DECL|macro|MBOX_CLEAR_ACA
mdefine_line|#define MBOX_CLEAR_ACA                  0x0065
DECL|macro|MBOX_TARGET_RESET
mdefine_line|#define MBOX_TARGET_RESET               0x0066
DECL|macro|MBOX_CLEAR_TASK_SET
mdefine_line|#define MBOX_CLEAR_TASK_SET             0x0067
DECL|macro|MBOX_ABORT_TASK_SET
mdefine_line|#define MBOX_ABORT_TASK_SET             0x0068
DECL|macro|MBOX_GET_FIRMWARE_STATE
mdefine_line|#define MBOX_GET_FIRMWARE_STATE         0x0069
DECL|macro|MBOX_GET_PORT_NAME
mdefine_line|#define MBOX_GET_PORT_NAME              0x006a
DECL|macro|MBOX_SEND_SNS
mdefine_line|#define MBOX_SEND_SNS                   0x006e
DECL|macro|MBOX_PORT_LOGIN
mdefine_line|#define MBOX_PORT_LOGIN                 0x006f
DECL|macro|MBOX_SEND_CHANGE_REQUEST
mdefine_line|#define MBOX_SEND_CHANGE_REQUEST        0x0070
DECL|macro|MBOX_PORT_LOGOUT
mdefine_line|#define MBOX_PORT_LOGOUT                0x0071
macro_line|#include &quot;qlogicfc_asm.c&quot;
multiline_comment|/* Each element in mbox_param is an 8 bit bitmap where each bit indicates&n;   if that mbox should be copied as input.  For example 0x2 would mean&n;   only copy mbox1. */
DECL|variable|mbox_param
r_const
id|u_char
id|mbox_param
(braket
)braket
op_assign
(brace
l_int|0x01
comma
multiline_comment|/* MBOX_NO_OP */
l_int|0x1f
comma
multiline_comment|/* MBOX_LOAD_RAM */
l_int|0x03
comma
multiline_comment|/* MBOX_EXEC_FIRMWARE */
l_int|0x1f
comma
multiline_comment|/* MBOX_DUMP_RAM */
l_int|0x07
comma
multiline_comment|/* MBOX_WRITE_RAM_WORD */
l_int|0x03
comma
multiline_comment|/* MBOX_READ_RAM_WORD */
l_int|0xff
comma
multiline_comment|/* MBOX_MAILBOX_REG_TEST */
l_int|0x03
comma
multiline_comment|/* MBOX_VERIFY_CHECKSUM */
l_int|0x01
comma
multiline_comment|/* MBOX_ABOUT_FIRMWARE */
l_int|0xff
comma
multiline_comment|/* MBOX_LOAD_RISC_RAM */
l_int|0xff
comma
multiline_comment|/* MBOX_DUMP_RISC_RAM */
l_int|0x00
comma
multiline_comment|/* 0x000b */
l_int|0x00
comma
multiline_comment|/* 0x000c */
l_int|0x00
comma
multiline_comment|/* 0x000d */
l_int|0x01
comma
multiline_comment|/* MBOX_CHECK_FIRMWARE */
l_int|0x00
comma
multiline_comment|/* 0x000f */
l_int|0x1f
comma
multiline_comment|/* MBOX_INIT_REQ_QUEUE */
l_int|0x2f
comma
multiline_comment|/* MBOX_INIT_RES_QUEUE */
l_int|0x0f
comma
multiline_comment|/* MBOX_EXECUTE_IOCB */
l_int|0x03
comma
multiline_comment|/* MBOX_WAKE_UP */
l_int|0x01
comma
multiline_comment|/* MBOX_STOP_FIRMWARE */
l_int|0x0f
comma
multiline_comment|/* MBOX_ABORT_IOCB */
l_int|0x03
comma
multiline_comment|/* MBOX_ABORT_DEVICE */
l_int|0x07
comma
multiline_comment|/* MBOX_ABORT_TARGET */
l_int|0x03
comma
multiline_comment|/* MBOX_BUS_RESET */
l_int|0x03
comma
multiline_comment|/* MBOX_STOP_QUEUE */
l_int|0x03
comma
multiline_comment|/* MBOX_START_QUEUE */
l_int|0x03
comma
multiline_comment|/* MBOX_SINGLE_STEP_QUEUE */
l_int|0x03
comma
multiline_comment|/* MBOX_ABORT_QUEUE */
l_int|0x03
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_STATUS */
l_int|0x00
comma
multiline_comment|/* 0x001e */
l_int|0x01
comma
multiline_comment|/* MBOX_GET_FIRMWARE_STATUS */
l_int|0x01
comma
multiline_comment|/* MBOX_GET_INIT_SCSI_ID */
l_int|0x00
comma
multiline_comment|/* 0x0021 */
l_int|0x01
comma
multiline_comment|/* MBOX_GET_RETRY_COUNT */
l_int|0x00
comma
multiline_comment|/* 0x0023 */
l_int|0x00
comma
multiline_comment|/* 0x0024 */
l_int|0x00
comma
multiline_comment|/* 0x0025 */
l_int|0x00
comma
multiline_comment|/* 0x0026 */
l_int|0x00
comma
multiline_comment|/* 0x0027 */
l_int|0x03
comma
multiline_comment|/* MBOX_GET_TARGET_PARAMS */
l_int|0x03
comma
multiline_comment|/* MBOX_GET_DEV_QUEUE_PARAMS */
l_int|0x00
comma
multiline_comment|/* 0x002a */
l_int|0x00
comma
multiline_comment|/* 0x002b */
l_int|0x00
comma
multiline_comment|/* 0x002c */
l_int|0x00
comma
multiline_comment|/* 0x002d */
l_int|0x00
comma
multiline_comment|/* 0x002e */
l_int|0x00
comma
multiline_comment|/* 0x002f */
l_int|0x00
comma
multiline_comment|/* 0x0030 */
l_int|0x00
comma
multiline_comment|/* 0x0031 */
l_int|0x07
comma
multiline_comment|/* MBOX_SET_RETRY_COUNT */
l_int|0x00
comma
multiline_comment|/* 0x0033 */
l_int|0x00
comma
multiline_comment|/* 0x0034 */
l_int|0x00
comma
multiline_comment|/* 0x0035 */
l_int|0x00
comma
multiline_comment|/* 0x0036 */
l_int|0x00
comma
multiline_comment|/* 0x0037 */
l_int|0x0f
comma
multiline_comment|/* MBOX_SET_TARGET_PARAMS */
l_int|0x0f
comma
multiline_comment|/* MBOX_SET_DEV_QUEUE_PARAMS */
l_int|0x00
comma
multiline_comment|/* 0x003a */
l_int|0x00
comma
multiline_comment|/* 0x003b */
l_int|0x00
comma
multiline_comment|/* 0x003c */
l_int|0x00
comma
multiline_comment|/* 0x003d */
l_int|0x00
comma
multiline_comment|/* 0x003e */
l_int|0x00
comma
multiline_comment|/* 0x003f */
l_int|0x00
comma
multiline_comment|/* 0x0040 */
l_int|0x00
comma
multiline_comment|/* 0x0041 */
l_int|0x00
comma
multiline_comment|/* 0x0042 */
l_int|0x00
comma
multiline_comment|/* 0x0043 */
l_int|0x00
comma
multiline_comment|/* 0x0044 */
l_int|0x00
comma
multiline_comment|/* 0x0045 */
l_int|0x00
comma
multiline_comment|/* 0x0046 */
l_int|0x00
comma
multiline_comment|/* 0x0047 */
l_int|0x00
comma
multiline_comment|/* 0x0048 */
l_int|0x00
comma
multiline_comment|/* 0x0049 */
l_int|0x00
comma
multiline_comment|/* 0x004a */
l_int|0x00
comma
multiline_comment|/* 0x004b */
l_int|0x00
comma
multiline_comment|/* 0x004c */
l_int|0x00
comma
multiline_comment|/* 0x004d */
l_int|0x00
comma
multiline_comment|/* 0x004e */
l_int|0x00
comma
multiline_comment|/* 0x004f */
l_int|0x00
comma
multiline_comment|/* 0x0050 */
l_int|0x00
comma
multiline_comment|/* 0x0051 */
l_int|0x00
comma
multiline_comment|/* 0x0052 */
l_int|0x00
comma
multiline_comment|/* 0x0053 */
l_int|0xcf
comma
multiline_comment|/* MBOX_EXECUTE_IOCB64 */
l_int|0x00
comma
multiline_comment|/* 0x0055 */
l_int|0x00
comma
multiline_comment|/* 0x0056 */
l_int|0x00
comma
multiline_comment|/* 0x0057 */
l_int|0x00
comma
multiline_comment|/* 0x0058 */
l_int|0x00
comma
multiline_comment|/* 0x0059 */
l_int|0x00
comma
multiline_comment|/* 0x005a */
l_int|0x00
comma
multiline_comment|/* 0x005b */
l_int|0x00
comma
multiline_comment|/* 0x005c */
l_int|0x00
comma
multiline_comment|/* 0x005d */
l_int|0x00
comma
multiline_comment|/* 0x005e */
l_int|0x00
comma
multiline_comment|/* 0x005f */
l_int|0xff
comma
multiline_comment|/* MBOX_INIT_FIRMWARE */
l_int|0xcd
comma
multiline_comment|/* MBOX_GET_INIT_CB */
l_int|0x01
comma
multiline_comment|/* MBOX_INIT_LIP */
l_int|0xcd
comma
multiline_comment|/* MBOX_GET_POS_MAP */
l_int|0xcf
comma
multiline_comment|/* MBOX_GET_PORT_DB */
l_int|0x03
comma
multiline_comment|/* MBOX_CLEAR_ACA */
l_int|0x03
comma
multiline_comment|/* MBOX_TARGET_RESET */
l_int|0x03
comma
multiline_comment|/* MBOX_CLEAR_TASK_SET */
l_int|0x03
comma
multiline_comment|/* MBOX_ABORT_TASK_SET */
l_int|0x01
comma
multiline_comment|/* MBOX_GET_FIRMWARE_STATE */
l_int|0x03
comma
multiline_comment|/* MBOX_GET_PORT_NAME */
l_int|0x00
comma
multiline_comment|/* 0x006b */
l_int|0x00
comma
multiline_comment|/* 0x006c */
l_int|0x00
comma
multiline_comment|/* 0x006d */
l_int|0xcf
comma
multiline_comment|/* MBOX_SEND_SNS */
l_int|0x0f
comma
multiline_comment|/* MBOX_PORT_LOGIN */
l_int|0x03
comma
multiline_comment|/* MBOX_SEND_CHANGE_REQUEST */
l_int|0x03
comma
multiline_comment|/* MBOX_PORT_LOGOUT */
)brace
suffix:semicolon
DECL|macro|MAX_MBOX_COMMAND
mdefine_line|#define MAX_MBOX_COMMAND&t;(sizeof(mbox_param)/sizeof(u_short))
DECL|struct|id_name_map
r_struct
id|id_name_map
(brace
DECL|member|wwn
id|u64
id|wwn
suffix:semicolon
DECL|member|loop_id
id|u_char
id|loop_id
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sns_cb
r_struct
id|sns_cb
(brace
DECL|member|len
id|u_short
id|len
suffix:semicolon
DECL|member|res1
id|u_short
id|res1
suffix:semicolon
DECL|member|response_low
id|u_int
id|response_low
suffix:semicolon
DECL|member|response_high
id|u_int
id|response_high
suffix:semicolon
DECL|member|sub_len
id|u_short
id|sub_len
suffix:semicolon
DECL|member|res2
id|u_short
id|res2
suffix:semicolon
DECL|member|data
id|u_char
id|data
(braket
l_int|44
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* address of instance of this struct is passed to adapter to initialize things&n; */
DECL|struct|init_cb
r_struct
id|init_cb
(brace
DECL|member|version
id|u_char
id|version
suffix:semicolon
DECL|member|reseverd1
id|u_char
id|reseverd1
(braket
l_int|1
)braket
suffix:semicolon
DECL|member|firm_opts
id|u_short
id|firm_opts
suffix:semicolon
DECL|member|max_frame_len
id|u_short
id|max_frame_len
suffix:semicolon
DECL|member|max_iocb
id|u_short
id|max_iocb
suffix:semicolon
DECL|member|exec_throttle
id|u_short
id|exec_throttle
suffix:semicolon
DECL|member|retry_cnt
id|u_char
id|retry_cnt
suffix:semicolon
DECL|member|retry_delay
id|u_char
id|retry_delay
suffix:semicolon
DECL|member|node_name
id|u_short
id|node_name
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|hard_addr
id|u_short
id|hard_addr
suffix:semicolon
DECL|member|reserved2
id|u_char
id|reserved2
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|req_queue_out
id|u_short
id|req_queue_out
suffix:semicolon
DECL|member|res_queue_in
id|u_short
id|res_queue_in
suffix:semicolon
DECL|member|req_queue_len
id|u_short
id|req_queue_len
suffix:semicolon
DECL|member|res_queue_len
id|u_short
id|res_queue_len
suffix:semicolon
DECL|member|req_queue_addr_lo
id|u_int
id|req_queue_addr_lo
suffix:semicolon
DECL|member|req_queue_addr_high
id|u_int
id|req_queue_addr_high
suffix:semicolon
DECL|member|res_queue_addr_lo
id|u_int
id|res_queue_addr_lo
suffix:semicolon
DECL|member|res_queue_addr_high
id|u_int
id|res_queue_addr_high
suffix:semicolon
multiline_comment|/* the rest of this structure only applies to the isp2200 */
DECL|member|lun_enables
id|u_short
id|lun_enables
suffix:semicolon
DECL|member|cmd_resource_cnt
id|u_char
id|cmd_resource_cnt
suffix:semicolon
DECL|member|notify_resource_cnt
id|u_char
id|notify_resource_cnt
suffix:semicolon
DECL|member|timeout
id|u_short
id|timeout
suffix:semicolon
DECL|member|reserved3
id|u_short
id|reserved3
suffix:semicolon
DECL|member|add_firm_opts
id|u_short
id|add_firm_opts
suffix:semicolon
DECL|member|res_accum_timer
id|u_char
id|res_accum_timer
suffix:semicolon
DECL|member|irq_delay_timer
id|u_char
id|irq_delay_timer
suffix:semicolon
DECL|member|special_options
id|u_short
id|special_options
suffix:semicolon
DECL|member|reserved4
id|u_short
id|reserved4
(braket
l_int|13
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * The result queue can be quite a bit smaller since continuation entries&n; * do not show up there:&n; */
DECL|macro|RES_QUEUE_LEN
mdefine_line|#define RES_QUEUE_LEN&t;&t;((QLOGICFC_REQ_QUEUE_LEN + 1) / 8 - 1)
DECL|macro|QUEUE_ENTRY_LEN
mdefine_line|#define QUEUE_ENTRY_LEN&t;&t;64
macro_line|#if ISP2x00_FABRIC
DECL|macro|QLOGICFC_MAX_ID
mdefine_line|#define QLOGICFC_MAX_ID    0xff
macro_line|#else
DECL|macro|QLOGICFC_MAX_ID
mdefine_line|#define QLOGICFC_MAX_ID    0x7d
macro_line|#endif
DECL|macro|QLOGICFC_MAX_LUN
mdefine_line|#define QLOGICFC_MAX_LUN&t;128
DECL|macro|QLOGICFC_MAX_LOOP_ID
mdefine_line|#define QLOGICFC_MAX_LOOP_ID&t;0x7d
multiline_comment|/* the following connection options only apply to the 2200.  i have only&n; * had success with LOOP_ONLY and P2P_ONLY.&n; */
DECL|macro|LOOP_ONLY
mdefine_line|#define LOOP_ONLY              0
DECL|macro|P2P_ONLY
mdefine_line|#define P2P_ONLY               1
DECL|macro|LOOP_PREFERED
mdefine_line|#define LOOP_PREFERED          2
DECL|macro|P2P_PREFERED
mdefine_line|#define P2P_PREFERED           3
DECL|macro|CONNECTION_PREFERENCE
mdefine_line|#define CONNECTION_PREFERENCE  LOOP_ONLY
multiline_comment|/* adapter_state values */
DECL|macro|AS_FIRMWARE_DEAD
mdefine_line|#define AS_FIRMWARE_DEAD      -1
DECL|macro|AS_LOOP_DOWN
mdefine_line|#define AS_LOOP_DOWN           0
DECL|macro|AS_LOOP_GOOD
mdefine_line|#define AS_LOOP_GOOD           1
DECL|macro|AS_REDO_FABRIC_PORTDB
mdefine_line|#define AS_REDO_FABRIC_PORTDB  2
DECL|macro|AS_REDO_LOOP_PORTDB
mdefine_line|#define AS_REDO_LOOP_PORTDB    4
DECL|macro|RES_SIZE
mdefine_line|#define RES_SIZE&t;((RES_QUEUE_LEN + 1)*QUEUE_ENTRY_LEN)
DECL|macro|REQ_SIZE
mdefine_line|#define REQ_SIZE&t;((QLOGICFC_REQ_QUEUE_LEN + 1)*QUEUE_ENTRY_LEN)
DECL|struct|isp2x00_hostdata
r_struct
id|isp2x00_hostdata
(brace
DECL|member|revision
id|u_char
id|revision
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
multiline_comment|/* result and request queues (shared with isp2x00): */
DECL|member|req_in_ptr
id|u_int
id|req_in_ptr
suffix:semicolon
multiline_comment|/* index of next request slot */
DECL|member|res_out_ptr
id|u_int
id|res_out_ptr
suffix:semicolon
multiline_comment|/* index of next result slot */
multiline_comment|/* this is here so the queues are nicely aligned */
DECL|member|send_marker
r_int
id|send_marker
suffix:semicolon
multiline_comment|/* do we need to send a marker? */
DECL|member|res
r_char
op_star
id|res
suffix:semicolon
DECL|member|req
r_char
op_star
id|req
suffix:semicolon
DECL|member|control_block
r_struct
id|init_cb
id|control_block
suffix:semicolon
DECL|member|adapter_state
r_int
id|adapter_state
suffix:semicolon
DECL|member|tag_ages
r_int
r_int
r_int
id|tag_ages
(braket
id|QLOGICFC_MAX_ID
op_plus
l_int|1
)braket
suffix:semicolon
DECL|member|handle_ptrs
id|Scsi_Cmnd
op_star
id|handle_ptrs
(braket
id|QLOGICFC_REQ_QUEUE_LEN
op_plus
l_int|1
)braket
suffix:semicolon
DECL|member|handle_serials
r_int
r_int
id|handle_serials
(braket
id|QLOGICFC_REQ_QUEUE_LEN
op_plus
l_int|1
)braket
suffix:semicolon
DECL|member|port_db
r_struct
id|id_name_map
id|port_db
(braket
id|QLOGICFC_MAX_ID
op_plus
l_int|1
)braket
suffix:semicolon
DECL|member|mbox_done
id|u_char
id|mbox_done
suffix:semicolon
DECL|member|wwn
id|u64
id|wwn
suffix:semicolon
DECL|member|port_id
id|u_int
id|port_id
suffix:semicolon
DECL|member|queued
id|u_char
id|queued
suffix:semicolon
DECL|member|host_id
id|u_char
id|host_id
suffix:semicolon
DECL|member|explore_timer
r_struct
id|timer_list
id|explore_timer
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* queue length&squot;s _must_ be power of two: */
DECL|macro|QUEUE_DEPTH
mdefine_line|#define QUEUE_DEPTH(in, out, ql)&t;((in - out) &amp; (ql))
DECL|macro|REQ_QUEUE_DEPTH
mdefine_line|#define REQ_QUEUE_DEPTH(in, out)&t;QUEUE_DEPTH(in, out, &t;&t;     &bslash;&n;&t;&t;&t;&t;&t;&t;    QLOGICFC_REQ_QUEUE_LEN)
DECL|macro|RES_QUEUE_DEPTH
mdefine_line|#define RES_QUEUE_DEPTH(in, out)&t;QUEUE_DEPTH(in, out, RES_QUEUE_LEN)
r_static
r_void
id|isp2x00_enable_irqs
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_static
r_void
id|isp2x00_disable_irqs
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_static
r_int
id|isp2x00_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_static
r_int
id|isp2x00_reset_hardware
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_static
r_int
id|isp2x00_mbox_command
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
id|u_short
(braket
)braket
)paren
suffix:semicolon
r_static
r_int
id|isp2x00_return_status
c_func
(paren
id|Scsi_Cmnd
op_star
comma
r_struct
id|Status_Entry
op_star
)paren
suffix:semicolon
r_static
r_void
id|isp2x00_intr_handler
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|do_isp2x00_intr_handler
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|isp2x00_make_portdb
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
macro_line|#if ISP2x00_FABRIC
r_static
r_int
id|isp2x00_init_fabric
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
r_struct
id|id_name_map
op_star
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if USE_NVRAM_DEFAULTS
r_static
r_int
id|isp2x00_get_nvram_defaults
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
r_struct
id|init_cb
op_star
)paren
suffix:semicolon
r_static
id|u_short
id|isp2x00_read_nvram_word
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
id|u_short
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG_ISP2x00
r_static
r_void
id|isp2x00_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG_ISP2x00_INTR
r_static
r_void
id|isp2x00_print_status_entry
c_func
(paren
r_struct
id|Status_Entry
op_star
)paren
suffix:semicolon
macro_line|#endif
DECL|function|isp2x00_enable_irqs
r_static
r_inline
r_void
id|isp2x00_enable_irqs
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|outw
c_func
(paren
id|ISP_EN_INT
op_or
id|ISP_EN_RISC
comma
id|host-&gt;io_port
op_plus
id|PCI_INTER_CTL
)paren
suffix:semicolon
)brace
DECL|function|isp2x00_disable_irqs
r_static
r_inline
r_void
id|isp2x00_disable_irqs
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|outw
c_func
(paren
l_int|0x0
comma
id|host-&gt;io_port
op_plus
id|PCI_INTER_CTL
)paren
suffix:semicolon
)brace
DECL|function|isp2x00_detect
r_int
id|isp2x00_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tmpt
)paren
(brace
r_int
id|hosts
op_assign
l_int|0
suffix:semicolon
r_int
id|wait_time
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|device_ids
(braket
l_int|2
)braket
suffix:semicolon
id|dma64_addr_t
id|busaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_detect&quot;
)paren
suffix:semicolon
id|device_ids
(braket
l_int|0
)braket
op_assign
id|PCI_DEVICE_ID_QLOGIC_ISP2100
suffix:semicolon
id|device_ids
(braket
l_int|1
)braket
op_assign
id|PCI_DEVICE_ID_QLOGIC_ISP2200
suffix:semicolon
id|tmpt-&gt;proc_name
op_assign
l_string|&quot;isp2x00&quot;
suffix:semicolon
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc : PCI not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_QLOGIC
comma
id|device_ids
(braket
id|i
)braket
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
id|host
op_assign
id|scsi_register
c_func
(paren
id|tmpt
comma
r_sizeof
(paren
r_struct
id|isp2x00_hostdata
)paren
)paren
suffix:semicolon
id|host-&gt;max_id
op_assign
id|QLOGICFC_MAX_ID
op_plus
l_int|1
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|QLOGICFC_MAX_LUN
suffix:semicolon
id|host-&gt;hostt-&gt;use_new_eh_code
op_assign
l_int|1
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|hostdata
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|isp2x00_hostdata
)paren
)paren
suffix:semicolon
id|hostdata-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|hostdata-&gt;res
op_assign
id|pci64_alloc_consistent
c_func
(paren
id|pdev
comma
id|RES_SIZE
op_plus
id|REQ_SIZE
comma
op_amp
id|busaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;res
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : could not allocate memory for request and response queue.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|hostdata-&gt;req
op_assign
id|hostdata-&gt;res
op_plus
(paren
id|RES_QUEUE_LEN
op_plus
l_int|1
)paren
op_star
id|QUEUE_ENTRY_LEN
suffix:semicolon
id|hostdata-&gt;queued
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set up the control block */
id|hostdata-&gt;control_block.version
op_assign
l_int|0x1
suffix:semicolon
id|hostdata-&gt;control_block.firm_opts
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x800e
)paren
suffix:semicolon
id|hostdata-&gt;control_block.max_frame_len
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2048
)paren
suffix:semicolon
id|hostdata-&gt;control_block.max_iocb
op_assign
id|cpu_to_le16
c_func
(paren
id|QLOGICFC_REQ_QUEUE_LEN
)paren
suffix:semicolon
id|hostdata-&gt;control_block.exec_throttle
op_assign
id|cpu_to_le16
c_func
(paren
id|QLOGICFC_CMD_PER_LUN
)paren
suffix:semicolon
id|hostdata-&gt;control_block.retry_delay
op_assign
l_int|5
suffix:semicolon
id|hostdata-&gt;control_block.retry_cnt
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;control_block.node_name
(braket
l_int|0
)braket
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x0020
)paren
suffix:semicolon
id|hostdata-&gt;control_block.node_name
(braket
l_int|1
)braket
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0xE000
)paren
suffix:semicolon
id|hostdata-&gt;control_block.node_name
(braket
l_int|2
)braket
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x008B
)paren
suffix:semicolon
id|hostdata-&gt;control_block.node_name
(braket
l_int|3
)braket
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x0000
)paren
suffix:semicolon
id|hostdata-&gt;control_block.hard_addr
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x0003
)paren
suffix:semicolon
id|hostdata-&gt;control_block.req_queue_len
op_assign
id|cpu_to_le16
c_func
(paren
id|QLOGICFC_REQ_QUEUE_LEN
op_plus
l_int|1
)paren
suffix:semicolon
id|hostdata-&gt;control_block.res_queue_len
op_assign
id|cpu_to_le16
c_func
(paren
id|RES_QUEUE_LEN
op_plus
l_int|1
)paren
suffix:semicolon
id|hostdata-&gt;control_block.res_queue_addr_lo
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
)paren
suffix:semicolon
id|hostdata-&gt;control_block.res_queue_addr_high
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
)paren
suffix:semicolon
id|hostdata-&gt;control_block.req_queue_addr_lo
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
op_plus
id|RES_SIZE
)paren
)paren
suffix:semicolon
id|hostdata-&gt;control_block.req_queue_addr_high
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
op_plus
id|RES_SIZE
)paren
)paren
suffix:semicolon
id|hostdata-&gt;control_block.add_firm_opts
op_or_assign
id|cpu_to_le16
c_func
(paren
id|CONNECTION_PREFERENCE
op_lshift
l_int|4
)paren
suffix:semicolon
id|hostdata-&gt;adapter_state
op_assign
id|AS_LOOP_DOWN
suffix:semicolon
id|hostdata-&gt;explore_timer.data
op_assign
l_int|1
suffix:semicolon
id|hostdata-&gt;host_id
op_assign
id|hosts
suffix:semicolon
r_if
c_cond
(paren
id|isp2x00_init
c_func
(paren
id|host
)paren
op_logical_or
id|isp2x00_reset_hardware
c_func
(paren
id|host
)paren
)paren
(brace
id|pci64_free_consistent
(paren
id|pdev
comma
id|RES_SIZE
op_plus
id|REQ_SIZE
comma
id|hostdata-&gt;res
comma
id|busaddr
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|host-&gt;this_id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|host-&gt;irq
comma
id|do_isp2x00_intr_handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;qlogicfc&quot;
comma
id|host
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : interrupt %d already in use&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|host-&gt;irq
)paren
suffix:semicolon
id|pci64_free_consistent
(paren
id|pdev
comma
id|RES_SIZE
op_plus
id|REQ_SIZE
comma
id|hostdata-&gt;res
comma
id|busaddr
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : i/o region 0x%lx-0x%lx already &quot;
l_string|&quot;in use&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|host-&gt;io_port
comma
id|host-&gt;io_port
op_plus
l_int|0xff
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|host
)paren
suffix:semicolon
id|pci64_free_consistent
(paren
id|pdev
comma
id|RES_SIZE
op_plus
id|REQ_SIZE
comma
id|hostdata-&gt;res
comma
id|busaddr
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
comma
l_string|&quot;qlogicfc&quot;
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|host-&gt;io_port
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_CLEAR_RISC_INTR
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|isp2x00_enable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* wait for the loop to come up */
r_for
c_loop
(paren
id|wait_time
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|wait_time
OG
id|jiffies
op_logical_and
id|hostdata-&gt;adapter_state
op_eq
id|AS_LOOP_DOWN
suffix:semicolon
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_eq
id|AS_LOOP_DOWN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : link is not up&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
)brace
id|hosts
op_increment
suffix:semicolon
id|hostdata-&gt;explore_timer.data
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* this busy loop should not be needed but the isp2x00 seems to need &n;&t;   some time before recognizing it is attached to a fabric */
macro_line|#if ISP2x00_FABRIC
r_for
c_loop
(paren
id|wait_time
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|wait_time
OG
id|jiffies
suffix:semicolon
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_detect&quot;
)paren
suffix:semicolon
r_return
id|hosts
suffix:semicolon
)brace
DECL|function|isp2x00_make_portdb
r_static
r_int
id|isp2x00_make_portdb
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_int
id|param
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|id_name_map
id|temp
(braket
id|QLOGICFC_MAX_ID
op_plus
l_int|1
)braket
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|isp2x00_disable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
id|memset
c_func
(paren
id|temp
comma
l_int|0
comma
r_sizeof
(paren
id|temp
)paren
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
macro_line|#if ISP2x00_FABRIC
r_for
c_loop
(paren
id|i
op_assign
l_int|0x81
suffix:semicolon
id|i
OL
id|QLOGICFC_MAX_ID
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_PORT_LOGOUT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|i
op_lshift
l_int|8
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : logout failed %x  %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|i
comma
id|param
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_INIT_SCSI_ID
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_eq
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|hostdata-&gt;port_id
op_assign
(paren
(paren
id|u_int
)paren
id|param
(braket
l_int|3
)braket
)paren
op_lshift
l_int|16
suffix:semicolon
id|hostdata-&gt;port_id
op_or_assign
id|param
(braket
l_int|2
)braket
suffix:semicolon
id|temp
(braket
l_int|0
)braket
dot
id|loop_id
op_assign
id|param
(braket
l_int|1
)braket
suffix:semicolon
id|temp
(braket
l_int|0
)braket
dot
id|wwn
op_assign
id|hostdata-&gt;wwn
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : error getting scsi id.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|QLOGICFC_MAX_ID
suffix:semicolon
id|i
op_increment
)paren
id|temp
(braket
id|i
)braket
dot
id|loop_id
op_assign
id|temp
(braket
l_int|0
)braket
dot
id|loop_id
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|QLOGICFC_MAX_LOOP_ID
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_PORT_NAME
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_eq
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|temp
(braket
id|j
)braket
dot
id|loop_id
op_assign
id|i
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_assign
(paren
(paren
id|u64
)paren
(paren
id|param
(braket
l_int|2
)braket
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|56
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
(paren
id|param
(braket
l_int|2
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|48
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
id|param
(braket
l_int|3
)braket
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|40
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
(paren
id|param
(braket
l_int|3
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|32
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
id|param
(braket
l_int|6
)braket
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|24
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
(paren
id|param
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
id|param
(braket
l_int|7
)braket
op_amp
l_int|0xff
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|temp
(braket
id|j
)braket
dot
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
(paren
(paren
id|param
(braket
l_int|7
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
)brace
macro_line|#if ISP2x00_FABRIC
id|isp2x00_init_fabric
c_func
(paren
id|host
comma
id|temp
comma
id|j
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|QLOGICFC_MAX_ID
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|temp
(braket
id|i
)braket
dot
id|wwn
op_ne
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|QLOGICFC_MAX_ID
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|temp
(braket
id|j
)braket
dot
id|wwn
op_eq
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
)paren
(brace
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
op_assign
id|temp
(braket
id|j
)braket
dot
id|loop_id
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|j
op_eq
id|QLOGICFC_MAX_ID
op_plus
l_int|1
)paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
op_assign
id|temp
(braket
l_int|0
)braket
dot
id|loop_id
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|QLOGICFC_MAX_ID
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;port_db
(braket
id|j
)braket
dot
id|wwn
op_eq
id|temp
(braket
id|i
)braket
dot
id|wwn
op_logical_or
op_logical_neg
id|hostdata-&gt;port_db
(braket
id|j
)braket
dot
id|wwn
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|j
op_eq
id|QLOGICFC_MAX_ID
op_plus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Too many scsi devices, no more room in port map.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;port_db
(braket
id|j
)braket
dot
id|wwn
)paren
(brace
id|hostdata-&gt;port_db
(braket
id|j
)braket
dot
id|loop_id
op_assign
id|temp
(braket
id|i
)braket
dot
id|loop_id
suffix:semicolon
id|hostdata-&gt;port_db
(braket
id|j
)braket
dot
id|wwn
op_assign
id|temp
(braket
id|i
)braket
dot
id|wwn
suffix:semicolon
)brace
)brace
r_else
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
op_assign
id|temp
(braket
id|i
)braket
dot
id|loop_id
suffix:semicolon
)brace
id|isp2x00_enable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if ISP2x00_FABRIC
DECL|macro|FABRIC_PORT
mdefine_line|#define FABRIC_PORT          0x7e
DECL|macro|FABRIC_CONTROLLER
mdefine_line|#define FABRIC_CONTROLLER    0x7f
DECL|macro|FABRIC_SNS
mdefine_line|#define FABRIC_SNS           0x80
DECL|function|isp2x00_init_fabric
r_int
id|isp2x00_init_fabric
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|id_name_map
op_star
id|port_db
comma
r_int
id|cur_scsi_id
)paren
(brace
id|u_short
id|param
(braket
l_int|8
)braket
suffix:semicolon
id|u64
id|wwn
suffix:semicolon
r_int
id|done
op_assign
l_int|0
suffix:semicolon
id|u_short
id|loop_id
op_assign
l_int|0x81
suffix:semicolon
id|u_short
id|scsi_id
op_assign
id|cur_scsi_id
suffix:semicolon
id|u_int
id|port_id
suffix:semicolon
r_struct
id|sns_cb
op_star
id|req
suffix:semicolon
id|u_char
op_star
id|sns_response
suffix:semicolon
id|dma64_addr_t
id|busaddr
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Checking for a fabric.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_PORT_NAME
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|u16
)paren
id|FABRIC_PORT
op_lshift
l_int|8
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : fabric check result %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Fabric found.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|req
op_assign
(paren
r_struct
id|sns_cb
op_star
)paren
id|pci64_alloc_consistent
c_func
(paren
id|hostdata-&gt;pci_dev
comma
r_sizeof
(paren
op_star
id|req
)paren
op_plus
l_int|608
comma
op_amp
id|busaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Could not allocate DMA resources for fabric initialization&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sns_response
op_assign
(paren
id|u_char
op_star
)paren
(paren
id|req
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_LOOP_PORTDB
)paren
(brace
id|memset
c_func
(paren
id|req
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
id|req-&gt;len
op_assign
id|cpu_to_le16
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|req-&gt;response_low
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
op_plus
r_sizeof
(paren
op_star
id|req
)paren
)paren
)paren
suffix:semicolon
id|req-&gt;response_high
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
op_plus
r_sizeof
(paren
op_star
id|req
)paren
)paren
)paren
suffix:semicolon
id|req-&gt;sub_len
op_assign
id|cpu_to_le16
c_func
(paren
l_int|22
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x17
suffix:semicolon
id|req-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|req-&gt;data
(braket
l_int|8
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|hostdata-&gt;port_id
op_amp
l_int|0xff
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|9
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|hostdata-&gt;port_id
op_rshift
l_int|8
op_amp
l_int|0xff
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|10
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|hostdata-&gt;port_id
op_rshift
l_int|16
op_amp
l_int|0xff
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|13
)braket
op_assign
l_int|0x01
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SEND_SNS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|30
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
suffix:semicolon
id|param
(braket
l_int|6
)braket
op_assign
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|7
)braket
op_assign
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : error sending RFC-4&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
)brace
id|port_id
op_assign
id|hostdata-&gt;port_id
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
id|memset
c_func
(paren
id|req
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
id|req-&gt;len
op_assign
id|cpu_to_le16
c_func
(paren
l_int|304
)paren
suffix:semicolon
id|req-&gt;response_low
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
op_plus
r_sizeof
(paren
op_star
id|req
)paren
)paren
)paren
suffix:semicolon
id|req-&gt;response_high
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
op_plus
r_sizeof
(paren
op_star
id|req
)paren
)paren
)paren
suffix:semicolon
id|req-&gt;sub_len
op_assign
id|cpu_to_le16
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|req-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|req-&gt;data
(braket
l_int|8
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|port_id
op_amp
l_int|0xff
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|9
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|port_id
op_rshift
l_int|8
op_amp
l_int|0xff
)paren
suffix:semicolon
id|req-&gt;data
(braket
l_int|10
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|port_id
op_rshift
l_int|16
op_amp
l_int|0xff
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_SEND_SNS
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|14
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
suffix:semicolon
id|param
(braket
l_int|6
)braket
op_assign
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
op_rshift
l_int|16
suffix:semicolon
id|param
(braket
l_int|7
)braket
op_assign
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_eq
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : found node %02x%02x%02x%02x%02x%02x%02x%02x &quot;
comma
id|hostdata-&gt;host_id
comma
id|sns_response
(braket
l_int|20
)braket
comma
id|sns_response
(braket
l_int|21
)braket
comma
id|sns_response
(braket
l_int|22
)braket
comma
id|sns_response
(braket
l_int|23
)braket
comma
id|sns_response
(braket
l_int|24
)braket
comma
id|sns_response
(braket
l_int|25
)braket
comma
id|sns_response
(braket
l_int|26
)braket
comma
id|sns_response
(braket
l_int|27
)braket
)paren
)paren
suffix:semicolon
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;  port id: %02x%02x%02x&bslash;n&quot;
comma
id|sns_response
(braket
l_int|17
)braket
comma
id|sns_response
(braket
l_int|18
)braket
comma
id|sns_response
(braket
l_int|19
)braket
)paren
)paren
suffix:semicolon
id|port_id
op_assign
(paren
(paren
id|u_int
)paren
id|sns_response
(braket
l_int|17
)braket
)paren
op_lshift
l_int|16
suffix:semicolon
id|port_id
op_or_assign
(paren
(paren
id|u_int
)paren
id|sns_response
(braket
l_int|18
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|port_id
op_or_assign
(paren
(paren
id|u_int
)paren
id|sns_response
(braket
l_int|19
)braket
)paren
suffix:semicolon
id|wwn
op_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|20
)braket
)paren
op_lshift
l_int|56
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|21
)braket
)paren
op_lshift
l_int|48
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|22
)braket
)paren
op_lshift
l_int|40
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|23
)braket
)paren
op_lshift
l_int|32
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|24
)braket
)paren
op_lshift
l_int|24
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|25
)braket
)paren
op_lshift
l_int|16
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|26
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|wwn
op_or_assign
(paren
(paren
id|u64
)paren
id|sns_response
(braket
l_int|27
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;port_id
op_rshift
l_int|8
op_ne
id|port_id
op_rshift
l_int|8
)paren
(brace
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : adding a fabric port: %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|port_id
)paren
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_PORT_LOGIN
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|loop_id
op_lshift
l_int|8
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|port_id
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|port_id
)paren
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_eq
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|port_db
(braket
id|scsi_id
)braket
dot
id|wwn
op_assign
id|wwn
suffix:semicolon
id|port_db
(braket
id|scsi_id
)braket
dot
id|loop_id
op_assign
id|loop_id
suffix:semicolon
id|loop_id
op_increment
suffix:semicolon
id|scsi_id
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Error performing port login %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|DEBUG_FABRIC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : loop_id: %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|loop_id
)paren
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_PORT_LOGOUT
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|loop_id
op_lshift
l_int|8
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hostdata-&gt;port_id
op_eq
id|port_id
)paren
id|done
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Get All Next failed %x.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pci64_free_consistent
c_func
(paren
id|hostdata-&gt;pci_dev
comma
r_sizeof
(paren
op_star
id|req
)paren
op_plus
l_int|608
comma
id|req
comma
id|busaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|pci64_free_consistent
c_func
(paren
id|hostdata-&gt;pci_dev
comma
r_sizeof
(paren
op_star
id|req
)paren
op_plus
l_int|608
comma
id|req
comma
id|busaddr
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* ISP2x00_FABRIC */
DECL|function|isp2x00_release
r_int
id|isp2x00_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|dma64_addr_t
id|busaddr
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_release&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|host-&gt;io_port
op_plus
id|PCI_INTER_CTL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|host
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
suffix:semicolon
id|busaddr
op_assign
id|pci64_dma_build
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|hostdata-&gt;control_block.res_queue_addr_high
)paren
comma
id|le32_to_cpu
c_func
(paren
id|hostdata-&gt;control_block.res_queue_addr_lo
)paren
)paren
suffix:semicolon
id|pci64_free_consistent
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|RES_SIZE
op_plus
id|REQ_SIZE
comma
id|hostdata-&gt;res
comma
id|busaddr
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_release&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp2x00_info
r_const
r_char
op_star
id|isp2x00_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|80
)braket
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_info&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;QLogic ISP%04x SCSI on PCI bus %02x device %02x irq %d base 0x%lx&quot;
comma
id|hostdata-&gt;pci_dev-&gt;device
comma
id|hostdata-&gt;pci_dev-&gt;bus-&gt;number
comma
id|hostdata-&gt;pci_dev-&gt;devfn
comma
id|host-&gt;irq
comma
id|host-&gt;io_port
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_info&quot;
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
multiline_comment|/*&n; * The middle SCSI layer ensures that queuecommand never gets invoked&n; * concurrently with itself or the interrupt handler (though the&n; * interrupt handler may call this routine as part of&n; * request-completion handling).&n; */
DECL|function|isp2x00_queuecommand
r_int
id|isp2x00_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
id|i
comma
id|sg_count
comma
id|n
comma
id|num_free
suffix:semicolon
id|u_int
id|in_ptr
comma
id|out_ptr
suffix:semicolon
r_struct
id|dataseg
op_star
id|ds
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_struct
id|Command_Entry
op_star
id|cmd
suffix:semicolon
r_struct
id|Continuation_Entry
op_star
id|cont
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_queuecommand&quot;
)paren
suffix:semicolon
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|Cmnd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|DEBUG
c_func
(paren
id|isp2x00_print_scsi_cmd
c_func
(paren
id|Cmnd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_FABRIC_PORTDB
op_logical_or
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_LOOP_PORTDB
)paren
(brace
id|isp2x00_make_portdb
c_func
(paren
id|host
)paren
suffix:semicolon
id|hostdata-&gt;adapter_state
op_assign
id|AS_LOOP_GOOD
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Port Database&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wwn: %08x%08x  scsi_id: %x  loop_id: &quot;
comma
(paren
id|u_int
)paren
(paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
op_rshift
l_int|32
)paren
comma
(paren
id|u_int
)paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
op_ne
id|hostdata-&gt;port_db
(braket
l_int|0
)braket
dot
id|loop_id
op_logical_or
id|i
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%x&quot;
comma
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Not Available&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_eq
id|AS_FIRMWARE_DEAD
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : The firmware is dead, just return.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|host-&gt;max_id
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|out_ptr
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
suffix:semicolon
id|in_ptr
op_assign
id|hostdata-&gt;req_in_ptr
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : request queue depth %d&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|REQ_QUEUE_DEPTH
c_func
(paren
id|in_ptr
comma
id|out_ptr
)paren
)paren
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|hostdata-&gt;req
(braket
id|in_ptr
op_star
id|QUEUE_ENTRY_LEN
)braket
suffix:semicolon
id|in_ptr
op_assign
(paren
id|in_ptr
op_plus
l_int|1
)paren
op_amp
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
r_if
c_cond
(paren
id|in_ptr
op_eq
id|out_ptr
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : request queue overflow&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;send_marker
)paren
(brace
r_struct
id|Marker_Entry
op_star
id|marker
suffix:semicolon
id|TRACE
c_func
(paren
l_string|&quot;queue marker&quot;
comma
id|in_ptr
comma
l_int|0
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : adding marker entry&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
id|marker
op_assign
(paren
r_struct
id|Marker_Entry
op_star
)paren
id|cmd
suffix:semicolon
id|memset
c_func
(paren
id|marker
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Marker_Entry
)paren
)paren
suffix:semicolon
id|marker-&gt;hdr.entry_type
op_assign
id|ENTRY_MARKER
suffix:semicolon
id|marker-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|marker-&gt;modifier
op_assign
id|SYNC_ALL
suffix:semicolon
id|hostdata-&gt;send_marker
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|in_ptr
op_plus
l_int|1
)paren
op_amp
id|QLOGICFC_REQ_QUEUE_LEN
)paren
op_eq
id|out_ptr
)paren
(brace
id|outw
c_func
(paren
id|in_ptr
comma
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
suffix:semicolon
id|hostdata-&gt;req_in_ptr
op_assign
id|in_ptr
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : request queue overflow&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|cmd
op_assign
(paren
r_struct
id|Command_Entry
op_star
)paren
op_amp
id|hostdata-&gt;req
(braket
id|in_ptr
op_star
id|QUEUE_ENTRY_LEN
)braket
suffix:semicolon
id|in_ptr
op_assign
(paren
id|in_ptr
op_plus
l_int|1
)paren
op_amp
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
)brace
id|TRACE
c_func
(paren
l_string|&quot;queue command&quot;
comma
id|in_ptr
comma
id|Cmnd
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Command_Entry
)paren
)paren
suffix:semicolon
multiline_comment|/* find a free handle mapping slot */
r_for
c_loop
(paren
id|i
op_assign
id|in_ptr
suffix:semicolon
id|i
op_ne
(paren
id|in_ptr
op_minus
l_int|1
)paren
op_logical_and
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
suffix:semicolon
id|i
op_assign
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
(paren
id|QLOGICFC_REQ_QUEUE_LEN
op_plus
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
)paren
(brace
id|cmd-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|i
)paren
suffix:semicolon
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_assign
id|Cmnd
suffix:semicolon
id|hostdata-&gt;handle_serials
(braket
id|i
)braket
op_assign
id|Cmnd-&gt;serial_number
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : no handle slots, this should not happen.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hostdata-&gt;queued is %x, in_ptr: %x&bslash;n&quot;
comma
id|hostdata-&gt;queued
comma
id|in_ptr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;slot %d has %p&bslash;n&quot;
comma
id|i
comma
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|cmd-&gt;hdr.entry_type
op_assign
id|ENTRY_COMMAND
suffix:semicolon
id|cmd-&gt;hdr.entry_cnt
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;target_lun
op_assign
id|Cmnd-&gt;lun
suffix:semicolon
id|cmd-&gt;expanded_lun
op_assign
id|cpu_to_le16
c_func
(paren
id|Cmnd-&gt;lun
)paren
suffix:semicolon
macro_line|#if ISP2x00_PORTDB
id|cmd-&gt;target_id
op_assign
id|hostdata-&gt;port_db
(braket
id|Cmnd-&gt;target
)braket
dot
id|loop_id
suffix:semicolon
macro_line|#else
id|cmd-&gt;target_id
op_assign
id|Cmnd-&gt;target
suffix:semicolon
macro_line|#endif
id|cmd-&gt;total_byte_cnt
op_assign
id|cpu_to_le32
c_func
(paren
id|Cmnd-&gt;request_bufflen
)paren
suffix:semicolon
id|cmd-&gt;time_out
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;cdb
comma
id|Cmnd-&gt;cmnd
comma
id|Cmnd-&gt;cmd_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
)paren
(brace
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;request_buffer
suffix:semicolon
id|sg_count
op_assign
id|pci64_map_sg
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|sg
comma
id|Cmnd-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
id|cpu_to_le16
c_func
(paren
id|sg_count
)paren
suffix:semicolon
id|ds
op_assign
id|cmd-&gt;dataseg
suffix:semicolon
multiline_comment|/* fill in first two sg entries: */
id|n
op_assign
id|sg_count
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|DATASEGS_PER_COMMAND
)paren
id|n
op_assign
id|DATASEGS_PER_COMMAND
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ds
(braket
id|i
)braket
dot
id|d_base
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|sg_dma64_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
macro_line|#if PCI64_DMA_BITS &gt; 32
id|ds
(braket
id|i
)braket
dot
id|d_base_hi
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|sg_dma64_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ds
(braket
id|i
)braket
dot
id|d_count
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma64_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
op_increment
id|sg
suffix:semicolon
)brace
id|sg_count
op_sub_assign
id|DATASEGS_PER_COMMAND
suffix:semicolon
r_while
c_loop
(paren
id|sg_count
OG
l_int|0
)paren
(brace
op_increment
id|cmd-&gt;hdr.entry_cnt
suffix:semicolon
id|cont
op_assign
(paren
r_struct
id|Continuation_Entry
op_star
)paren
op_amp
id|hostdata-&gt;req
(braket
id|in_ptr
op_star
id|QUEUE_ENTRY_LEN
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cont
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|Continuation_Entry
)paren
)paren
suffix:semicolon
id|in_ptr
op_assign
(paren
id|in_ptr
op_plus
l_int|1
)paren
op_amp
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
r_if
c_cond
(paren
id|in_ptr
op_eq
id|out_ptr
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : unexpected request queue overflow&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|TRACE
c_func
(paren
l_string|&quot;queue continuation&quot;
comma
id|in_ptr
comma
l_int|0
)paren
suffix:semicolon
id|cont-&gt;hdr.entry_type
op_assign
id|ENTRY_CONTINUATION
suffix:semicolon
id|ds
op_assign
id|cont-&gt;dataseg
suffix:semicolon
id|n
op_assign
id|sg_count
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|DATASEGS_PER_CONT
)paren
id|n
op_assign
id|DATASEGS_PER_CONT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
op_increment
id|i
)paren
(brace
id|ds
(braket
id|i
)braket
dot
id|d_base
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|sg_dma64_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
macro_line|#if PCI64_DMA_BITS &gt; 32
id|ds
(braket
id|i
)braket
dot
id|d_base_hi
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|sg_dma64_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ds
(braket
id|i
)braket
dot
id|d_count
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma64_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
op_increment
id|sg
suffix:semicolon
)brace
id|sg_count
op_sub_assign
id|n
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|Cmnd-&gt;request_bufflen
op_logical_and
id|Cmnd-&gt;sc_data_direction
op_ne
id|PCI_DMA_NONE
)paren
(brace
id|dma64_addr_t
id|busaddr
op_assign
id|pci64_map_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|Cmnd-&gt;request_buffer
comma
id|Cmnd-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
op_star
(paren
id|dma64_addr_t
op_star
)paren
op_amp
id|Cmnd-&gt;SCp
op_assign
id|busaddr
suffix:semicolon
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
)paren
suffix:semicolon
macro_line|#if PCI64_DMA_BITS &gt; 32
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base_hi
op_assign
id|cpu_to_le32
c_func
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_count
op_assign
id|cpu_to_le32
c_func
(paren
id|Cmnd-&gt;request_bufflen
)paren
suffix:semicolon
id|cmd-&gt;segment_cnt
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base
op_assign
l_int|0
suffix:semicolon
macro_line|#if PCI64_DMA_BITS &gt; 32
id|cmd-&gt;dataseg
(braket
l_int|0
)braket
dot
id|d_base_hi
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|cmd-&gt;segment_cnt
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Shouldn&squot;t this be 0? */
)brace
r_switch
c_cond
(paren
id|Cmnd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TEST_UNIT_READY
suffix:colon
r_case
id|START_STOP
suffix:colon
r_break
suffix:semicolon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
id|cmd-&gt;control_flags
op_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_WRITE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cmd-&gt;control_flags
op_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Cmnd-&gt;device-&gt;tagged_supported
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|hostdata-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
)paren
OG
(paren
l_int|2
op_star
id|SCSI_TIMEOUT
)paren
)paren
(brace
id|cmd-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_ORDERED_TAG
)paren
suffix:semicolon
id|hostdata-&gt;tag_ages
(braket
id|Cmnd-&gt;target
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|Cmnd-&gt;tag
)paren
(brace
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
id|cmd-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_HEAD_TAG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
id|cmd-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_ORDERED_TAG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cmd-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_SIMPLE_TAG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * TEST_UNIT_READY commands from scsi_scan will fail due to &quot;overlapped&n;&t; * commands attempted&quot; unless we setup at least a simple queue (midlayer &n;&t; * will embelish this once it can do an INQUIRY command to the device)&n;&t; */
r_else
id|cmd-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|CFLAG_SIMPLE_TAG
)paren
suffix:semicolon
id|outw
c_func
(paren
id|in_ptr
comma
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
suffix:semicolon
id|hostdata-&gt;req_in_ptr
op_assign
id|in_ptr
suffix:semicolon
id|hostdata-&gt;queued
op_increment
suffix:semicolon
id|num_free
op_assign
id|QLOGICFC_REQ_QUEUE_LEN
op_minus
id|REQ_QUEUE_DEPTH
c_func
(paren
id|in_ptr
comma
id|out_ptr
)paren
suffix:semicolon
id|num_free
op_assign
(paren
id|num_free
OG
l_int|2
)paren
ques
c_cond
id|num_free
op_minus
l_int|2
suffix:colon
l_int|0
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|hostdata-&gt;queued
op_plus
id|num_free
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;can_queue
OG
id|QLOGICFC_REQ_QUEUE_LEN
)paren
id|host-&gt;can_queue
op_assign
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
id|host-&gt;sg_tablesize
op_assign
id|QLOGICFC_MAX_SG
c_func
(paren
id|num_free
)paren
suffix:semicolon
multiline_comment|/* this is really gross */
r_if
c_cond
(paren
id|host-&gt;can_queue
op_le
id|host-&gt;host_busy
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;can_queue
op_plus
l_int|2
OL
id|host-&gt;host_busy
)paren
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d.c crosses its fingers.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|host-&gt;host_busy
op_plus
l_int|1
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_queuecommand&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* we have received an event, such as a lip or an RSCN, which may mean that&n; * our port database is incorrect so the port database must be recreated.&n; */
DECL|function|redo_port_db
r_static
r_void
id|redo_port_db
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|hostdata-&gt;explore_timer.data
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hostdata-&gt;explore_timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_FABRIC_PORTDB
op_logical_or
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_LOOP_PORTDB
)paren
(brace
id|isp2x00_make_portdb
c_func
(paren
id|host
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Port Database&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wwn: %08x%08x  scsi_id: %x  loop_id: &quot;
comma
(paren
id|u_int
)paren
(paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
op_rshift
l_int|32
)paren
comma
(paren
id|u_int
)paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|wwn
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
op_ne
id|hostdata-&gt;port_db
(braket
l_int|0
)braket
dot
id|loop_id
op_logical_or
id|i
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%x&quot;
comma
id|hostdata-&gt;port_db
(braket
id|i
)braket
dot
id|loop_id
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Not Available&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_logical_and
(paren
id|hostdata-&gt;port_db
(braket
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_member_access_from_pointer
id|target
)braket
dot
id|loop_id
OG
id|QLOGICFC_MAX_LOOP_ID
op_logical_or
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_LOOP_PORTDB
)paren
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;port_db
(braket
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_member_access_from_pointer
id|target
)braket
dot
id|loop_id
op_ne
id|hostdata-&gt;port_db
(braket
l_int|0
)braket
dot
id|loop_id
)paren
(brace
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_member_access_from_pointer
id|result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_member_access_from_pointer
id|scsi_done
)paren
(brace
(paren
op_star
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : done is null?&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;handle_serials
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|hostdata-&gt;adapter_state
op_assign
id|AS_LOOP_GOOD
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|ASYNC_EVENT_INTERRUPT
mdefine_line|#define ASYNC_EVENT_INTERRUPT&t;0x01
DECL|function|do_isp2x00_intr_handler
r_void
id|do_isp2x00_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|isp2x00_intr_handler
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|isp2x00_intr_handler
r_void
id|isp2x00_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|Scsi_Cmnd
op_star
id|Cmnd
suffix:semicolon
r_struct
id|Status_Entry
op_star
id|sts
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|dev_id
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|u_int
id|in_ptr
comma
id|out_ptr
comma
id|handle
comma
id|num_free
suffix:semicolon
id|u_short
id|status
suffix:semicolon
id|ENTER_INTR
c_func
(paren
l_string|&quot;isp2x00_intr_handler&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : interrupt on line %d&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|irq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|PCI_INTER_STS
)paren
op_amp
l_int|0x08
)paren
)paren
(brace
multiline_comment|/* spurious interrupts can happen legally */
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : got spurious interrupt&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|in_ptr
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
id|out_ptr
op_assign
id|hostdata-&gt;res_out_ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|PCI_SEMAPHORE
)paren
op_amp
id|ASYNC_EVENT_INTERRUPT
)paren
)paren
(brace
id|status
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX0
)paren
suffix:semicolon
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox completion status: %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|status
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|LOOP_UP
suffix:colon
r_case
id|POINT_TO_POINT_UP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Link is Up&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|hostdata-&gt;adapter_state
op_assign
id|AS_REDO_FABRIC_PORTDB
op_or
id|AS_REDO_LOOP_PORTDB
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_DOWN
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Link is Down&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|hostdata-&gt;adapter_state
op_assign
id|AS_LOOP_DOWN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CONNECTION_MODE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;received CONNECTION_MODE irq %x&bslash;n&quot;
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CHANGE_NOTIFICATION
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : RSCN Received&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_eq
id|AS_LOOP_GOOD
)paren
id|hostdata-&gt;adapter_state
op_assign
id|AS_REDO_FABRIC_PORTDB
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LIP_OCCURED
suffix:colon
r_case
id|LIP_RECEIVED
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Loop Reinitialized&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;adapter_state
op_eq
id|AS_LOOP_GOOD
)paren
id|hostdata-&gt;adapter_state
op_assign
id|AS_REDO_LOOP_PORTDB
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYSTEM_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : The firmware just choked.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|hostdata-&gt;adapter_state
op_assign
id|AS_FIRMWARE_DEAD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_COMMAND_COMPLETE
suffix:colon
id|handle
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX1
)paren
op_or
(paren
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX2
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|Cmnd
op_assign
id|hostdata-&gt;handle_ptrs
(braket
id|handle
)braket
suffix:semicolon
id|hostdata-&gt;handle_ptrs
(braket
id|handle
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hostdata-&gt;handle_serials
(braket
id|handle
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;queued
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd
op_ne
l_int|NULL
)paren
(brace
id|Cmnd-&gt;result
op_assign
l_int|0x0
suffix:semicolon
(paren
op_star
id|Cmnd-&gt;scsi_done
)paren
(paren
id|Cmnd
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d.c : got a null value out of handle_ptrs, this sucks&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBOX_COMMAND_COMPLETE
suffix:colon
r_case
id|INVALID_COMMAND
suffix:colon
r_case
id|HOST_INTERFACE_ERROR
suffix:colon
r_case
id|TEST_FAILED
suffix:colon
r_case
id|COMMAND_ERROR
suffix:colon
r_case
id|COMMAND_PARAM_ERROR
suffix:colon
r_case
id|PORT_ID_USED
suffix:colon
r_case
id|LOOP_ID_USED
suffix:colon
r_case
id|ALL_IDS_USED
suffix:colon
id|hostdata-&gt;mbox_done
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_CLEAR_RISC_INTR
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : got an unknown status? %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_LOOP_PORTDB
op_logical_or
id|hostdata-&gt;adapter_state
op_amp
id|AS_REDO_FABRIC_PORTDB
)paren
op_logical_and
id|hostdata-&gt;explore_timer.data
op_eq
l_int|0
)paren
(brace
id|hostdata-&gt;explore_timer.function
op_assign
id|redo_port_db
suffix:semicolon
id|hostdata-&gt;explore_timer.data
op_assign
(paren
r_int
r_int
)paren
id|host
suffix:semicolon
id|hostdata-&gt;explore_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hostdata-&gt;explore_timer
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hostdata-&gt;explore_timer
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
l_int|0x0
comma
id|host-&gt;io_port
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : response queue update&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : response queue depth %d&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|RES_QUEUE_DEPTH
c_func
(paren
id|in_ptr
comma
id|out_ptr
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|out_ptr
op_ne
id|in_ptr
)paren
(brace
r_int
id|le_hand
suffix:semicolon
id|sts
op_assign
(paren
r_struct
id|Status_Entry
op_star
)paren
op_amp
id|hostdata-&gt;res
(braket
id|out_ptr
op_star
id|QUEUE_ENTRY_LEN
)braket
suffix:semicolon
id|out_ptr
op_assign
(paren
id|out_ptr
op_plus
l_int|1
)paren
op_amp
id|RES_QUEUE_LEN
suffix:semicolon
id|TRACE
c_func
(paren
l_string|&quot;done&quot;
comma
id|out_ptr
comma
id|Cmnd
)paren
suffix:semicolon
id|DEBUG_INTR
c_func
(paren
id|isp2x00_print_status_entry
c_func
(paren
id|sts
)paren
)paren
suffix:semicolon
id|le_hand
op_assign
id|le32_to_cpu
c_func
(paren
id|sts-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;hdr.entry_type
op_eq
id|ENTRY_STATUS
op_logical_and
(paren
id|Cmnd
op_assign
id|hostdata-&gt;handle_ptrs
(braket
id|le_hand
)braket
)paren
)paren
(brace
id|Cmnd-&gt;result
op_assign
id|isp2x00_return_status
c_func
(paren
id|Cmnd
comma
id|sts
)paren
suffix:semicolon
id|hostdata-&gt;queued
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;use_sg
)paren
id|pci64_unmap_sg
c_func
(paren
id|hostdata-&gt;pci_dev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|Cmnd-&gt;buffer
comma
id|Cmnd-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Cmnd-&gt;request_bufflen
op_logical_and
id|Cmnd-&gt;sc_data_direction
op_ne
id|PCI_DMA_NONE
)paren
id|pci64_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
op_star
(paren
id|dma64_addr_t
op_star
)paren
op_amp
id|Cmnd-&gt;SCp
comma
id|Cmnd-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|Cmnd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t; * if any of the following are true we do not&n;&t;&t;&t;&t; * call scsi_done.  if the status is CS_ABORTED&n;&t;&t;&t;&t; * we dont have to call done because the upper&n;&t;&t;&t;&t; * level should already know its aborted.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|hostdata-&gt;handle_serials
(braket
id|le_hand
)braket
op_ne
id|Cmnd-&gt;serial_number
op_logical_or
id|le16_to_cpu
c_func
(paren
id|sts-&gt;completion_status
)paren
op_eq
id|CS_ABORTED
)paren
(brace
id|hostdata-&gt;handle_serials
(braket
id|le_hand
)braket
op_assign
l_int|0
suffix:semicolon
id|hostdata-&gt;handle_ptrs
(braket
id|le_hand
)braket
op_assign
l_int|NULL
suffix:semicolon
id|outw
c_func
(paren
id|out_ptr
comma
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * if we get back an error indicating the port&n;&t;&t;&t;&t; * is not there or if the link is down and &n;&t;&t;&t;&t; * this is a device that used to be there &n;&t;&t;&t;&t; * allow the command to timeout.&n;&t;&t;&t;&t; * the device may well be back in a couple of&n;&t;&t;&t;&t; * seconds.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|hostdata-&gt;adapter_state
op_eq
id|AS_LOOP_DOWN
op_logical_or
id|sts-&gt;completion_status
op_eq
id|cpu_to_le16
c_func
(paren
id|CS_PORT_UNAVAILABLE
)paren
op_logical_or
id|sts-&gt;completion_status
op_eq
id|cpu_to_le16
c_func
(paren
id|CS_PORT_LOGGED_OUT
)paren
op_logical_or
id|sts-&gt;completion_status
op_eq
id|cpu_to_le16
c_func
(paren
id|CS_PORT_CONFIG_CHANGED
)paren
)paren
op_logical_and
id|hostdata-&gt;port_db
(braket
id|Cmnd-&gt;target
)braket
dot
id|wwn
)paren
(brace
id|outw
c_func
(paren
id|out_ptr
comma
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
id|outw
c_func
(paren
id|out_ptr
comma
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|hostdata-&gt;handle_ptrs
(braket
id|le_hand
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sts-&gt;completion_status
op_eq
id|cpu_to_le16
c_func
(paren
id|CS_RESET_OCCURRED
)paren
op_logical_or
(paren
id|sts-&gt;status_flags
op_amp
id|cpu_to_le16
c_func
(paren
id|STF_BUS_RESET
)paren
)paren
)paren
id|hostdata-&gt;send_marker
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|sts-&gt;scsi_status
)paren
op_amp
l_int|0x0200
)paren
id|memcpy
c_func
(paren
id|Cmnd-&gt;sense_buffer
comma
id|sts-&gt;req_sense_data
comma
r_sizeof
(paren
id|Cmnd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|out_ptr
comma
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Cmnd-&gt;scsi_done
op_ne
l_int|NULL
)paren
(brace
(paren
op_star
id|Cmnd-&gt;scsi_done
)paren
(paren
id|Cmnd
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Ouch, scsi done is NULL&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
)brace
id|hostdata-&gt;res_out_ptr
op_assign
id|out_ptr
suffix:semicolon
)brace
id|out_ptr
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
suffix:semicolon
id|in_ptr
op_assign
id|hostdata-&gt;req_in_ptr
suffix:semicolon
id|num_free
op_assign
id|QLOGICFC_REQ_QUEUE_LEN
op_minus
id|REQ_QUEUE_DEPTH
c_func
(paren
id|in_ptr
comma
id|out_ptr
)paren
suffix:semicolon
id|num_free
op_assign
(paren
id|num_free
OG
l_int|2
)paren
ques
c_cond
id|num_free
op_minus
l_int|2
suffix:colon
l_int|0
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|hostdata-&gt;queued
op_plus
id|num_free
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;can_queue
OG
id|QLOGICFC_REQ_QUEUE_LEN
)paren
id|host-&gt;can_queue
op_assign
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
id|host-&gt;sg_tablesize
op_assign
id|QLOGICFC_MAX_SG
c_func
(paren
id|num_free
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;can_queue
op_le
id|host-&gt;host_busy
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;can_queue
op_plus
l_int|2
OL
id|host-&gt;host_busy
)paren
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : crosses its fingers.&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|host-&gt;host_busy
op_plus
l_int|1
suffix:semicolon
)brace
id|outw
c_func
(paren
id|HCCR_CLEAR_RISC_INTR
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|LEAVE_INTR
c_func
(paren
l_string|&quot;isp2x00_intr_handler&quot;
)paren
suffix:semicolon
)brace
DECL|function|isp2x00_return_status
r_static
r_int
id|isp2x00_return_status
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_struct
id|Status_Entry
op_star
id|sts
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
macro_line|#if DEBUG_ISP2x00_INTR
r_static
r_char
op_star
id|reason
(braket
)braket
op_assign
(brace
l_string|&quot;DID_OK&quot;
comma
l_string|&quot;DID_NO_CONNECT&quot;
comma
l_string|&quot;DID_BUS_BUSY&quot;
comma
l_string|&quot;DID_TIME_OUT&quot;
comma
l_string|&quot;DID_BAD_TARGET&quot;
comma
l_string|&quot;DID_ABORT&quot;
comma
l_string|&quot;DID_PARITY&quot;
comma
l_string|&quot;DID_ERROR&quot;
comma
l_string|&quot;DID_RESET&quot;
comma
l_string|&quot;DID_BAD_INTR&quot;
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DEBUG_ISP2x00_INTR */
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_return_status&quot;
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc : completion status = 0x%04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|sts-&gt;completion_status
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|sts-&gt;completion_status
)paren
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DMA_ERROR
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET_OCCURRED
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
r_if
c_cond
(paren
id|Cmnd-&gt;underflow
op_le
(paren
id|Cmnd-&gt;request_bufflen
op_minus
id|le32_to_cpu
c_func
(paren
id|sts-&gt;residual
)paren
)paren
)paren
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_else
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_PORT_UNAVAILABLE
suffix:colon
r_case
id|CS_PORT_LOGGED_OUT
suffix:colon
r_case
id|CS_PORT_CONFIG_CHANGED
suffix:colon
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_QUEUE_FULL
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : unknown completion status 0x%04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|sts-&gt;completion_status
)paren
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DEBUG_INTR
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc : host status (%s) scsi status %x&bslash;n&quot;
comma
id|reason
(braket
id|host_status
)braket
comma
id|le16_to_cpu
c_func
(paren
id|sts-&gt;scsi_status
)paren
)paren
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_return_status&quot;
)paren
suffix:semicolon
r_return
(paren
id|le16_to_cpu
c_func
(paren
id|sts-&gt;scsi_status
)paren
op_amp
id|STATUS_MASK
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|isp2x00_abort
r_int
id|isp2x00_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
)paren
(brace
id|u_short
id|param
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_abort&quot;
)paren
suffix:semicolon
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|QLOGICFC_REQ_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hostdata-&gt;handle_ptrs
(braket
id|i
)braket
op_eq
id|Cmnd
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|QLOGICFC_REQ_QUEUE_LEN
)paren
(brace
r_return
id|SUCCESS
suffix:semicolon
)brace
id|isp2x00_disable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABORT_IOCB
suffix:semicolon
macro_line|#if ISP2x00_PORTDB
id|param
(braket
l_int|1
)braket
op_assign
(paren
(paren
(paren
id|u_short
)paren
id|hostdata-&gt;port_db
(braket
id|Cmnd-&gt;target
)braket
dot
id|loop_id
)paren
op_lshift
l_int|8
)paren
op_or
id|Cmnd-&gt;lun
suffix:semicolon
macro_line|#else
id|param
(braket
l_int|1
)braket
op_assign
(paren
(paren
(paren
id|u_short
)paren
id|Cmnd-&gt;target
)paren
op_lshift
l_int|8
)paren
op_or
id|Cmnd-&gt;lun
suffix:semicolon
macro_line|#endif
id|param
(braket
l_int|2
)braket
op_assign
id|i
op_amp
l_int|0xffff
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
id|i
op_rshift
l_int|16
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : scsi abort failure: %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_eq
l_int|0x4005
)paren
id|Cmnd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_eq
l_int|0x4006
)paren
id|Cmnd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
id|return_status
op_assign
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|return_status
op_ne
id|SUCCESS
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_FIRMWARE_STATE
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : abort failed&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : firmware status is %x %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
comma
id|param
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|isp2x00_enable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_abort&quot;
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
DECL|function|isp2x00_reset
r_int
id|isp2x00_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|Cmnd
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|u_short
id|param
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_RESET_SUCCESS
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_reset&quot;
)paren
suffix:semicolon
id|host
op_assign
id|Cmnd-&gt;host
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_BUS_RESET
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|isp2x00_disable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : scsi bus reset failure: %x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
id|isp2x00_enable_irqs
c_func
(paren
id|host
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_reset&quot;
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
suffix:semicolon
)brace
DECL|function|isp2x00_biosparam
r_int
id|isp2x00_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|n
comma
r_int
id|ip
(braket
)braket
)paren
(brace
r_int
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_biosparam&quot;
)paren
suffix:semicolon
id|ip
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|ip
(braket
l_int|2
)braket
OG
l_int|1024
)paren
(brace
id|ip
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
id|ip
(braket
l_int|0
)braket
op_star
id|ip
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_biosparam&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isp2x00_reset_hardware
r_static
r_int
id|isp2x00_reset_hardware
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|u_short
id|param
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
r_int
id|loop_count
suffix:semicolon
id|dma64_addr_t
id|busaddr
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_reset_hardware&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|outw
c_func
(paren
l_int|0x01
comma
id|host-&gt;io_port
op_plus
id|ISP_CTRL_STATUS
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_RESET
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_RELEASE
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_BIOS_DISABLE
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
op_eq
id|RISC_BUSY
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : reset_hardware loop timeout&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
macro_line|#if DEBUG_ISP2x00
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 0 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 1 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 2 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 3 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX3
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 4 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 5 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 6 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX6
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox 7 0x%04x &bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX7
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DEBUG_ISP2x00 */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : verifying checksum&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
macro_line|#if RELOAD_FIRMWARE
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
op_star
id|risc_code
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|risc_code_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;pci_dev-&gt;device
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP2100
)paren
(brace
id|risc_code
op_assign
id|risc_code2100
suffix:semicolon
id|risc_code_len
op_assign
id|risc_code_length2100
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hostdata-&gt;pci_dev-&gt;device
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP2200
)paren
(brace
id|risc_code
op_assign
id|risc_code2200
suffix:semicolon
id|risc_code_len
op_assign
id|risc_code_length2200
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_WRITE_RAM_WORD
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
op_plus
id|i
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|risc_code
(braket
id|i
)braket
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : firmware load failure&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* RELOAD_FIRMWARE */
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_VERIFY_CHECKSUM
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : ram checksum failure&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : executing firmware&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_EXEC_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|risc_code_addr01
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_ABOUT_FIRMWARE
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : about firmware failure&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : firmware major revision %d&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : firmware minor revision %d&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
macro_line|#ifdef USE_NVRAM_DEFAULTS
r_if
c_cond
(paren
id|isp2x00_get_nvram_defaults
c_func
(paren
id|host
comma
op_amp
id|hostdata-&gt;control_block
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : Could not read from NVRAM&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
)brace
macro_line|#endif
id|hostdata-&gt;wwn
op_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|0
)braket
)paren
)paren
op_lshift
l_int|56
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xff00
)paren
op_lshift
l_int|48
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xff00
)paren
op_lshift
l_int|24
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|1
)braket
)paren
op_amp
l_int|0x00ff
)paren
op_lshift
l_int|48
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|2
)braket
)paren
op_amp
l_int|0x00ff
)paren
op_lshift
l_int|24
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|2
)braket
)paren
op_amp
l_int|0xff00
)paren
op_lshift
l_int|8
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|3
)braket
)paren
op_amp
l_int|0x00ff
)paren
op_lshift
l_int|8
suffix:semicolon
id|hostdata-&gt;wwn
op_or_assign
(paren
id|u64
)paren
(paren
id|cpu_to_le16
c_func
(paren
id|hostdata-&gt;control_block.node_name
(braket
l_int|3
)braket
)paren
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
multiline_comment|/* FIXME: If the DMA transfer goes one way only, this should use PCI_DMA_TODEVICE and below as well. */
id|busaddr
op_assign
id|pci64_map_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
op_amp
id|hostdata-&gt;control_block
comma
r_sizeof
(paren
id|hostdata-&gt;control_block
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_INIT_FIRMWARE
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|pci64_dma_lo32
c_func
(paren
id|busaddr
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|6
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|param
(braket
l_int|7
)braket
op_assign
(paren
id|u_short
)paren
(paren
id|pci64_dma_hi32
c_func
(paren
id|busaddr
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d.c: Ouch 0x%04x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pci64_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|busaddr
comma
r_sizeof
(paren
id|hostdata-&gt;control_block
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
id|MBOX_GET_FIRMWARE_STATE
suffix:semicolon
id|isp2x00_mbox_command
c_func
(paren
id|host
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|MBOX_COMMAND_COMPLETE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d.c: 0x%04x&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|param
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pci64_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|busaddr
comma
r_sizeof
(paren
id|hostdata-&gt;control_block
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|pci64_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|busaddr
comma
r_sizeof
(paren
id|hostdata-&gt;control_block
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_reset_hardware&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef USE_NVRAM_DEFAULTS
DECL|function|isp2x00_get_nvram_defaults
r_static
r_int
id|isp2x00_get_nvram_defaults
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|init_cb
op_star
id|control_block
)paren
(brace
id|u_short
id|value
suffix:semicolon
r_if
c_cond
(paren
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|0
)paren
op_ne
l_int|0x5349
)paren
r_return
l_int|1
suffix:semicolon
id|value
op_assign
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|8
)paren
suffix:semicolon
id|control_block-&gt;node_name
(braket
l_int|0
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|9
)paren
)paren
suffix:semicolon
id|control_block-&gt;node_name
(braket
l_int|1
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|10
)paren
)paren
suffix:semicolon
id|control_block-&gt;node_name
(braket
l_int|2
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|11
)paren
)paren
suffix:semicolon
id|control_block-&gt;node_name
(braket
l_int|3
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|12
)paren
)paren
suffix:semicolon
id|control_block-&gt;hard_addr
op_assign
id|cpu_to_le16
c_func
(paren
id|isp2x00_read_nvram_word
c_func
(paren
id|host
comma
l_int|13
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|isp2x00_init
r_static
r_int
id|isp2x00_init
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
)paren
(brace
id|u_long
id|io_base
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
suffix:semicolon
id|u_char
id|revision
suffix:semicolon
id|u_int
id|irq
suffix:semicolon
id|u_short
id|command
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;isp2x00_init&quot;
)paren
suffix:semicolon
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
id|pdev
op_assign
id|hostdata-&gt;pci_dev
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
op_logical_or
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : error reading PCI configuration&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|io_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_ne
id|PCI_VENDOR_ID_QLOGIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : 0x%04x is not QLogic vendor ID&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|pdev-&gt;vendor
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;device
op_ne
id|PCI_DEVICE_ID_QLOGIC_ISP2100
op_logical_and
id|pdev-&gt;device
op_ne
id|PCI_DEVICE_ID_QLOGIC_ISP2200
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : 0x%04x does not match ISP2100 or ISP2200 device id&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|pdev-&gt;device
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|PCI_COMMAND_IO
)paren
op_logical_or
op_logical_neg
(paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : i/o mapping is disabled&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : bus mastering is disabled&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|revision
op_ne
id|ISP2100_REV_ID1
op_logical_and
id|revision
op_ne
id|ISP2100_REV_ID3
op_logical_and
id|revision
op_ne
id|ISP2200_REV_ID5
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : new isp2x00 revision ID (%d)&bslash;n&quot;
comma
id|hostdata-&gt;host_id
comma
id|revision
)paren
suffix:semicolon
id|hostdata-&gt;revision
op_assign
id|revision
suffix:semicolon
id|sh-&gt;irq
op_assign
id|irq
suffix:semicolon
id|sh-&gt;io_port
op_assign
id|io_base
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;isp2x00_init&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if USE_NVRAM_DEFAULTS
DECL|macro|NVRAM_DELAY
mdefine_line|#define NVRAM_DELAY() udelay(10)&t;/* 10 microsecond delay */
DECL|function|isp2x00_read_nvram_word
id|u_short
id|isp2x00_read_nvram_word
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|u_short
id|byte
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_short
id|value
comma
id|output
comma
id|input
suffix:semicolon
id|outw
c_func
(paren
l_int|0x2
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x3
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|byte
op_and_assign
l_int|0xff
suffix:semicolon
id|byte
op_or_assign
l_int|0x0600
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|output
op_assign
(paren
(paren
id|byte
op_rshift
id|i
)paren
op_amp
l_int|0x1
)paren
ques
c_cond
l_int|0x4
suffix:colon
l_int|0x0
suffix:semicolon
id|outw
c_func
(paren
id|output
op_or
l_int|0x2
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|output
op_or
l_int|0x3
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|output
op_or
l_int|0x2
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf
comma
id|value
op_assign
l_int|0
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|value
op_lshift_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
l_int|0x3
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|input
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x2
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input
op_amp
l_int|0x8
)paren
id|value
op_or_assign
l_int|1
suffix:semicolon
)brace
id|outw
c_func
(paren
l_int|0x0
comma
id|host-&gt;io_port
op_plus
id|PCI_NVRAM
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* USE_NVRAM_DEFAULTS */
multiline_comment|/*&n; * currently, this is only called during initialization or abort/reset,&n; * at which times interrupts are disabled, so polling is OK, I guess...&n; */
DECL|function|isp2x00_mbox_command
r_static
r_int
id|isp2x00_mbox_command
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|u_short
id|param
(braket
)braket
)paren
(brace
r_int
id|loop_count
suffix:semicolon
r_struct
id|isp2x00_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|isp2x00_hostdata
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_eq
l_int|0
op_logical_or
id|hostdata-&gt;adapter_state
op_eq
id|AS_FIRMWARE_DEAD
)paren
r_return
l_int|1
suffix:semicolon
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
op_amp
l_int|0x0080
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox_command loop timeout #1&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|0x4006
suffix:semicolon
id|hostdata-&gt;adapter_state
op_assign
id|AS_FIRMWARE_DEAD
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|hostdata-&gt;mbox_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : invalid mbox command&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x80
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|7
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x40
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|6
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x20
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|5
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x10
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|4
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x08
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|3
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x04
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|2
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x02
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|1
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox_param
(braket
id|param
(braket
l_int|0
)braket
)braket
op_amp
l_int|0x01
)paren
id|outw
c_func
(paren
id|param
(braket
l_int|0
)braket
comma
id|host-&gt;io_port
op_plus
id|MBOX0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|HCCR_SET_HOST_INTR
comma
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
op_logical_neg
(paren
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|PCI_INTER_STS
)paren
op_amp
l_int|0x08
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
(brace
id|hostdata-&gt;adapter_state
op_assign
id|AS_FIRMWARE_DEAD
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox_command loop timeout #2&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|isp2x00_intr_handler
c_func
(paren
id|host-&gt;irq
comma
id|host
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;mbox_done
op_eq
l_int|1
)paren
r_break
suffix:semicolon
)brace
id|loop_count
op_assign
id|DEFAULT_LOOP_COUNT
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|loop_count
op_logical_and
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX0
)paren
op_eq
l_int|0x04
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loop_count
)paren
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox_command loop timeout #3&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
id|param
(braket
l_int|7
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX7
)paren
suffix:semicolon
id|param
(braket
l_int|6
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX6
)paren
suffix:semicolon
id|param
(braket
l_int|5
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX5
)paren
suffix:semicolon
id|param
(braket
l_int|4
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX4
)paren
suffix:semicolon
id|param
(braket
l_int|3
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX3
)paren
suffix:semicolon
id|param
(braket
l_int|2
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX2
)paren
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX1
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|MBOX0
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|host-&gt;io_port
op_plus
id|PCI_SEMAPHORE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|host-&gt;io_port
op_plus
id|HOST_HCCR
)paren
op_amp
l_int|0x0080
)paren
(brace
id|hostdata-&gt;adapter_state
op_assign
id|AS_FIRMWARE_DEAD
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc%d : mbox op is still pending&bslash;n&quot;
comma
id|hostdata-&gt;host_id
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG_ISP2x00_INTR
DECL|function|isp2x00_print_status_entry
r_void
id|isp2x00_print_status_entry
c_func
(paren
r_struct
id|Status_Entry
op_star
id|status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qlogicfc : entry count = 0x%02x, type = 0x%02x, flags = 0x%02x&bslash;n&quot;
comma
id|status-&gt;hdr.entry_cnt
comma
id|status-&gt;hdr.entry_type
comma
id|status-&gt;hdr.flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : scsi status = 0x%04x, completion status = 0x%04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|status-&gt;scsi_status
)paren
comma
id|le16_to_cpu
c_func
(paren
id|status-&gt;completion_status
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : state flags = 0x%04x, status flags = 0x%04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|status-&gt;state_flags
)paren
comma
id|le16_to_cpu
c_func
(paren
id|status-&gt;status_flags
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : response info length = 0x%04x, request sense length = 0x%04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|status-&gt;res_info_len
)paren
comma
id|le16_to_cpu
c_func
(paren
id|status-&gt;req_sense_len
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : residual transfer length = 0x%08x, response = 0x%02x&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|status-&gt;residual
)paren
comma
id|status-&gt;res_info
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif                         /* DEBUG_ISP2x00_INTR */
macro_line|#if DEBUG_ISP2x00
DECL|function|isp2x00_print_scsi_cmd
r_void
id|isp2x00_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : target = 0x%02x, lun = 0x%02x, cmd_len = 0x%02x&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qlogicfc : command = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* DEBUG_ISP2x00 */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|QLOGICFC
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
