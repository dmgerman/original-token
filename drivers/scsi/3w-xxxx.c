multiline_comment|/* &n;   3w-xxxx.c -- 3ware Storage Controller device driver for Linux.&n;&n;   Written By: Adam Radford &lt;linux@3ware.com&gt;&n;   Modifications By: Joel Jacobson &lt;linux@3ware.com&gt;&n;   &t;&t;     Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n;&n;   Copyright (C) 1999-2000 3ware Inc.&n;&n;   Kernel compatablity By: &t;Andre Hedrick &lt;andre@suse.com&gt;&n;   Non-Copyright (C) 2000&t;Andre Hedrick &lt;andre@suse.com&gt;&n;   &n;   Further tiny build fixes and trivial hoovering    Alan Cox&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License as published by&n;   the Free Software Foundation; version 2 of the License.&n;&n;   This program is distributed in the hope that it will be useful,           &n;   but WITHOUT ANY WARRANTY; without even the implied warranty of            &n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             &n;   GNU General Public License for more details.                              &n;&n;   NO WARRANTY                                                               &n;   THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR        &n;   CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT      &n;   LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,      &n;   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is    &n;   solely responsible for determining the appropriateness of using and       &n;   distributing the Program and assumes all risks associated with its        &n;   exercise of rights under this Agreement, including but not limited to     &n;   the risks and costs of program errors, damage to or loss of data,         &n;   programs or equipment, and unavailability or interruption of operations.  &n;&n;   DISCLAIMER OF LIABILITY                                                   &n;   NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY   &n;   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL        &n;   DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND   &n;   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR     &n;   TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE    &n;   USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED  &n;   HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES             &n;&n;   You should have received a copy of the GNU General Public License         &n;   along with this program; if not, write to the Free Software               &n;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA &n;&n;   Bugs/Comments/Suggestions should be mailed to:                            &n;   linux@3ware.com&n;&n;   For more information, goto:&n;   http://www.3ware.com&n;&n;   History&n;   -------&n;   0.1.000 -     Initial release.&n;   0.4.000 -     Added support for Asynchronous Event Notification through&n;                 ioctls for 3DM.&n;   1.0.000 -     Added DPO &amp; FUA bit support for WRITE_10 &amp; WRITE_6 cdb&n;                 to disable drive write-cache before writes.&n;   1.1.000 -     Fixed performance bug with DPO &amp; FUA not existing for WRITE_6.&n;   1.2.000 -     Added support for clean shutdown notification/feature table.&n;   1.02.00.001 - Added support for full command packet posts through ioctls&n;                 for 3DM.&n;                 Bug fix so hot spare drives don&squot;t show up.&n;   1.02.00.002 - Fix bug with tw_setfeature() call that caused oops on some&n;                 systems.&n;   08/21/00    - release previously allocated resources on failure at&n;                 tw_allocate_memory (acme)&n;*/
macro_line|#include &lt;linux/module.h&gt;
id|MODULE_AUTHOR
(paren
l_string|&quot;3ware Inc.&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;3ware Storage Controller Linux Driver&quot;
)paren
suffix:semicolon
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|__3W_C
mdefine_line|#define __3W_C&t;&t;&t;/* let 3w-xxxx.h know it is use */
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;3w-xxxx.h&quot;
r_static
r_int
id|tw_copy_info
c_func
(paren
id|TW_Info
op_star
id|info
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
r_static
r_void
id|tw_copy_mem_info
c_func
(paren
id|TW_Info
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|tw_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|tw_halt
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
id|ulong
id|event
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
multiline_comment|/* Notifier block to get a notify on system shutdown/halt/reboot */
DECL|variable|tw_notifier
r_static
r_struct
id|notifier_block
id|tw_notifier
op_assign
(brace
id|tw_halt
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Globals */
DECL|variable|tw_driver_version
r_char
op_star
id|tw_driver_version
op_assign
l_string|&quot;1.02.00.002&quot;
suffix:semicolon
DECL|variable|tw_device_extension_list
id|TW_Device_Extension
op_star
id|tw_device_extension_list
(braket
id|TW_MAX_SLOT
)braket
suffix:semicolon
DECL|variable|tw_device_extension_count
r_int
id|tw_device_extension_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Functions */
multiline_comment|/* This function will complete an aen request from the isr */
DECL|function|tw_aen_complete
r_int
id|tw_aen_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
r_int
id|aen
comma
id|aen_code
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|aen
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|param-&gt;data
)paren
suffix:semicolon
id|aen_code
op_assign
(paren
id|aen
op_amp
l_int|0x0ff
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_complete(): Queue&squot;d code 0x%x&bslash;n&quot;
comma
id|aen_code
)paren
suffix:semicolon
multiline_comment|/* Now queue the code */
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_tail
)braket
op_assign
id|aen_code
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|tw_dev-&gt;aen_tail
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|tw_dev-&gt;aen_tail
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_head
op_assign
id|tw_dev-&gt;aen_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_aen_complete() */
multiline_comment|/* This function will drain the aen queue after a soft reset */
DECL|function|tw_aen_drain_queue
r_int
id|tw_aen_drain_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
id|tries
op_assign
l_int|0
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
id|u32
id|command_que_value
op_assign
l_int|0
comma
id|command_que_addr
suffix:semicolon
id|u32
id|status_reg_value
op_assign
l_int|0
comma
id|status_reg_addr
suffix:semicolon
id|u32
id|param_value
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
id|u32
id|response_que_addr
suffix:semicolon
r_int
r_int
id|aen
suffix:semicolon
r_int
r_int
id|aen_code
suffix:semicolon
r_int
id|finished
op_assign
l_int|0
suffix:semicolon
r_int
id|first_reset
op_assign
l_int|0
suffix:semicolon
r_int
id|queue
op_assign
l_int|0
suffix:semicolon
r_int
id|imax
comma
id|i
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue()&bslash;n&quot;
)paren
suffix:semicolon
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|response_que_addr
op_assign
id|tw_dev-&gt;registers.response_que_addr
suffix:semicolon
r_if
c_cond
(paren
id|tw_poll_status
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_ATTENTION_INTERRUPT
comma
l_int|15
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): No attention interrupt for card %d&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Initialize command packet */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_GET_PARAM
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|0x401
suffix:semicolon
multiline_comment|/* AEN table */
id|param-&gt;parameter_id
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Unit code */
id|param-&gt;parameter_size_bytes
op_assign
l_int|2
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|imax
op_assign
id|TW_POLL_MAX_RETRIES
suffix:semicolon
multiline_comment|/* Now drain the controller&squot;s aen queue */
r_do
(brace
multiline_comment|/* Post command packet */
id|outl
c_func
(paren
id|command_que_value
comma
id|command_que_addr
)paren
suffix:semicolon
multiline_comment|/* Now poll for completion */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|response_que_addr
)paren
suffix:semicolon
id|request_id
op_assign
(paren
r_int
r_char
)paren
id|response_queue.u.response_id
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|command_packet-&gt;flags
op_ne
id|TW_AEN_TABLE_UNDEFINED
)paren
(brace
multiline_comment|/* Bad response */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad response, status = 0x%x, flags = 0x%x.&bslash;n&quot;
comma
id|command_packet-&gt;status
comma
id|command_packet-&gt;flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We know this is a 3w-1x00, and doesn&squot;t support aen&squot;s */
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Now check the aen */
id|aen
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|param-&gt;data
)paren
suffix:semicolon
id|aen_code
op_assign
(paren
id|aen
op_amp
l_int|0x0ff
)paren
suffix:semicolon
id|queue
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|aen_code
)paren
(brace
r_case
id|TW_AEN_QUEUE_EMPTY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_QUEUE_EMPTY.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_reset
op_ne
l_int|1
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
id|finished
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TW_AEN_SOFT_RESET
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_SOFT_RESET.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_reset
op_eq
l_int|0
)paren
(brace
id|first_reset
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|queue
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TW_AEN_DEGRADED_MIRROR
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_DEGRADED_MIRROR.&bslash;n&quot;
)paren
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_AEN_CONTROLLER_ERROR
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_CONTROLLER_ERROR.&bslash;n&quot;
)paren
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_AEN_REBUILD_FAIL
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_REBUILD_FAIL.&bslash;n&quot;
)paren
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_AEN_REBUILD_DONE
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_REBUILD_DONE.&bslash;n&quot;
)paren
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_AEN_QUEUE_FULL
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Found TW_AEN_QUEUE_FULL.&bslash;n&quot;
)paren
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Unknown AEN code 0x%x.&bslash;n&quot;
comma
id|aen_code
)paren
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now put the aen on the aen_queue */
r_if
c_cond
(paren
id|queue
op_eq
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_tail
)braket
op_assign
id|aen_code
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|tw_dev-&gt;aen_tail
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|tw_dev-&gt;aen_tail
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_head
op_assign
id|tw_dev-&gt;aen_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Response never received.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|tries
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|tries
OL
id|TW_MAX_AEN_TRIES
)paren
op_logical_and
(paren
id|finished
op_eq
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tries
op_ge
id|TW_MAX_AEN_TRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Aen queue error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_aen_drain_queue() */
multiline_comment|/* This function will read the aen queue from the isr */
DECL|function|tw_aen_read_queue
r_int
id|tw_aen_read_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|u32
id|command_que_value
op_assign
l_int|0
comma
id|command_que_addr
suffix:semicolon
id|u32
id|status_reg_value
op_assign
l_int|0
comma
id|status_reg_addr
suffix:semicolon
id|u32
id|param_value
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_read_queue()&bslash;n&quot;
)paren
suffix:semicolon
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_GET_PARAM
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|0x401
suffix:semicolon
multiline_comment|/* AEN table */
id|param-&gt;parameter_id
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Unit code */
id|param-&gt;parameter_size_bytes
op_assign
l_int|2
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
multiline_comment|/* Now post the command packet */
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_QUEUE_FULL
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Post succeeded.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flag internal command */
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_POSTED
suffix:semicolon
id|outl
c_func
(paren
id|command_que_value
comma
id|command_que_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Post failed, will retry.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_aen_read_queue() */
multiline_comment|/* This function will allocate memory and check if it is 16 d-word aligned */
DECL|function|tw_allocate_memory
r_int
id|tw_allocate_memory
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|size
comma
r_int
id|which
)paren
(brace
id|u32
op_star
id|virt_addr
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_allocate_memory()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|virt_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_allocate_memory(): kmalloc() failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|u32
)paren
id|virt_addr
op_mod
id|TW_ALIGNMENT
)paren
(brace
id|kfree
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_allocate_memory(): Found unaligned address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|which
op_eq
l_int|0
)paren
(brace
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_assign
id|virt_addr
suffix:semicolon
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_assign
id|virt_addr
suffix:semicolon
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_allocate_memory() */
multiline_comment|/* This function will check the status register for unexpected bits */
DECL|function|tw_check_bits
r_int
id|tw_check_bits
c_func
(paren
id|u32
id|status_reg_value
)paren
(brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_EXPECTED_BITS
)paren
op_ne
id|TW_STATUS_EXPECTED_BITS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_check_bits(): No expected bits (0x%x).&bslash;n&quot;
comma
id|status_reg_value
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_UNEXPECTED_BITS
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_check_bits(): Found unexpected bits (0x%x).&bslash;n&quot;
comma
id|status_reg_value
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_check_bits() */
multiline_comment|/* This function will report controller error status */
DECL|function|tw_check_errors
r_int
id|tw_check_errors
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TW_STATUS_ERRORS
c_func
(paren
id|status_reg_value
)paren
op_logical_or
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_check_errors() */
multiline_comment|/* This function will clear the attention interrupt */
DECL|function|tw_clear_attention_interrupt
r_void
id|tw_clear_attention_interrupt
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_addr
comma
id|control_reg_value
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
id|TW_CONTROL_CLEAR_ATTENTION_INTERRUPT
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_clear_attention_interrupt() */
multiline_comment|/* This function will clear the host interrupt */
DECL|function|tw_clear_host_interrupt
r_void
id|tw_clear_host_interrupt
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_addr
comma
id|control_reg_value
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
id|TW_CONTROL_CLEAR_HOST_INTERRUPT
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_clear_host_interrupt() */
multiline_comment|/* This function is called by tw_scsi_proc_info */
DECL|function|tw_copy_info
r_static
r_int
id|tw_copy_info
c_func
(paren
id|TW_Info
op_star
id|info
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
l_int|81
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|len
op_assign
id|vsprintf
c_func
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|tw_copy_mem_info
c_func
(paren
id|info
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* End tw_copy_info() */
multiline_comment|/* This function is called by tw_scsi_proc_info */
DECL|function|tw_copy_mem_info
r_static
r_void
id|tw_copy_mem_info
c_func
(paren
id|TW_Info
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;position
op_plus
id|len
OG
id|info-&gt;length
)paren
id|len
op_assign
id|info-&gt;length
op_minus
id|info-&gt;position
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;position
op_plus
id|len
OL
id|info-&gt;offset
)paren
(brace
id|info-&gt;position
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;position
OL
id|info-&gt;offset
)paren
(brace
id|data
op_add_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;position
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;position
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|info-&gt;buffer
op_plus
id|info-&gt;position
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|info-&gt;position
op_add_assign
id|len
suffix:semicolon
)brace
)brace
multiline_comment|/* End tw_copy_mem_info() */
multiline_comment|/* This function will disable interrupts on the controller */
DECL|function|tw_disable_interrupts
r_void
id|tw_disable_interrupts
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_value
comma
id|control_reg_addr
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
id|TW_CONTROL_DISABLE_INTERRUPTS
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_disable_interrupts() */
multiline_comment|/* This function will empty the response que */
DECL|function|tw_empty_response_que
r_int
id|tw_empty_response_que
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|u32
id|response_que_addr
comma
id|response_que_value
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|response_que_addr
op_assign
id|tw_dev-&gt;registers.response_que_addr
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_empty_response_queue(): Unexpected bits 1.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_que_value
op_assign
id|inl
c_func
(paren
id|response_que_addr
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_empty_response_queue(): Unexpected bits 2.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_empty_response_que() */
multiline_comment|/* This function will enable interrupts on the controller */
DECL|function|tw_enable_interrupts
r_void
id|tw_enable_interrupts
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_value
comma
id|control_reg_addr
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
(paren
id|TW_CONTROL_CLEAR_ATTENTION_INTERRUPT
op_or
id|TW_CONTROL_UNMASK_RESPONSE_INTERRUPT
op_or
id|TW_CONTROL_ENABLE_INTERRUPTS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_enable_interrupts() */
multiline_comment|/* This function will find and initialize all cards */
DECL|function|tw_findcards
r_int
id|tw_findcards
c_func
(paren
id|Scsi_Host_Template
op_star
id|tw_host
)paren
(brace
r_int
id|numcards
op_assign
l_int|0
comma
id|tries
op_assign
l_int|0
comma
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev2
suffix:semicolon
r_struct
id|pci_dev
op_star
id|tw_pci_dev
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_char
id|c
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_findcards()&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tw_pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|TW_VENDOR_ID
comma
id|TW_DEVICE_ID
comma
id|tw_pci_dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|tw_pci_dev
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Prepare temporary device extension */
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|TW_Device_Extension
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): kmalloc() failed for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tw_dev
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
id|error
op_assign
id|tw_initialize_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Couldn&squot;t initialize device extension for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Calculate the cards register addresses */
id|tw_dev-&gt;registers.base_addr
op_assign
id|pci_resource_start
c_func
(paren
id|tw_pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|tw_dev-&gt;registers.control_reg_addr
op_assign
id|pci_resource_start
c_func
(paren
id|tw_pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|tw_dev-&gt;registers.status_reg_addr
op_assign
id|pci_resource_start
c_func
(paren
id|tw_pci_dev
comma
l_int|0
)paren
op_plus
l_int|0x4
suffix:semicolon
id|tw_dev-&gt;registers.command_que_addr
op_assign
id|pci_resource_start
c_func
(paren
id|tw_pci_dev
comma
l_int|0
)paren
op_plus
l_int|0x8
suffix:semicolon
id|tw_dev-&gt;registers.response_que_addr
op_assign
id|pci_resource_start
c_func
(paren
id|tw_pci_dev
comma
l_int|0
)paren
op_plus
l_int|0xC
suffix:semicolon
multiline_comment|/* Save pci_dev struct to device extension */
id|tw_dev-&gt;tw_pci_dev
op_assign
id|tw_pci_dev
suffix:semicolon
multiline_comment|/* Poll status register for 60 secs for &squot;Controller Ready&squot; flag */
r_if
c_cond
(paren
id|tw_poll_status
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_MICROCONTROLLER_READY
comma
l_int|60
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Microcontroller not ready for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts on the card */
id|tw_disable_interrupts
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tries
OL
id|TW_MAX_RESET_TRIES
)paren
(brace
multiline_comment|/* Do soft reset */
id|tw_soft_reset
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|error
op_assign
id|tw_aen_drain_queue
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): No attention interrupt for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Check for controller errors */
r_if
c_cond
(paren
id|tw_check_errors
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Controller errors found, soft resetting card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Empty the response queue */
id|error
op_assign
id|tw_empty_response_que
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Couldn&squot;t empty response queue for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Now the controller is in a good state */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
op_ge
id|TW_MAX_RESET_TRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Controller error or no attention interrupt: giving up for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Make sure that io region isn&squot;t already taken */
r_if
c_cond
(paren
id|check_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Couldn&squot;t get io range 0x%lx-0x%lx for card %d.&bslash;n&quot;
comma
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
op_plus
id|TW_IO_ADDRESS_RANGE
comma
id|numcards
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Reserve the io address space */
id|request_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
comma
id|TW_DEVICE_NAME
)paren
suffix:semicolon
id|error
op_assign
id|tw_initialize_units
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Couldn&squot;t initialize units for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|release_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|error
op_assign
id|tw_initconnection
c_func
(paren
id|tw_dev
comma
id|TW_INIT_MESSAGE_CREDITS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Couldn&squot;t initconnection for card %d.&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
id|release_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Calculate max cmds per lun */
r_if
c_cond
(paren
id|tw_dev-&gt;num_units
OG
l_int|0
)paren
id|tw_host-&gt;cmd_per_lun
op_assign
(paren
id|TW_Q_LENGTH
op_minus
l_int|2
)paren
op_div
id|tw_dev-&gt;num_units
suffix:semicolon
multiline_comment|/* Register the card with the kernel SCSI layer */
id|host
op_assign
id|scsi_register
c_func
(paren
id|tw_host
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|release_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|tw_dev-&gt;registers.status_reg_addr
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d : Found a 3ware Storage Controller at 0x%x, IRQ: %d P-chip: %d.%d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
(paren
id|u32
)paren
(paren
id|tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|tw_pci_dev-&gt;irq
comma
(paren
id|status_reg_value
op_amp
id|TW_STATUS_MAJOR_VERSION_MASK
)paren
op_rshift
l_int|28
comma
(paren
id|status_reg_value
op_amp
id|TW_STATUS_MINOR_VERSION_MASK
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;hostdata
)paren
(brace
id|tw_dev2
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memcpy
c_func
(paren
id|tw_dev2
comma
id|tw_dev
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
id|tw_device_extension_list
(braket
id|tw_device_extension_count
)braket
op_assign
id|tw_dev2
suffix:semicolon
id|numcards
op_increment
suffix:semicolon
id|tw_device_extension_count
op_assign
id|numcards
suffix:semicolon
id|tw_dev2-&gt;host
op_assign
id|host
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Bad scsi host data for card %d.&bslash;n&quot;
comma
id|numcards
op_minus
l_int|1
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
id|release_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Re-enable interrupts on the card */
id|tw_enable_interrupts
c_func
(paren
id|tw_dev2
)paren
suffix:semicolon
multiline_comment|/* Now setup the interrupt handler */
id|error
op_assign
id|tw_setup_irq
c_func
(paren
id|tw_dev2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): Error requesting irq for card %d.&bslash;n&quot;
comma
id|numcards
op_minus
l_int|1
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
id|release_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
suffix:semicolon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|numcards
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Free the temporary device extension */
r_if
c_cond
(paren
id|tw_dev
)paren
id|kfree
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Tell the firmware we support shutdown notification*/
id|tw_setfeature
c_func
(paren
id|tw_dev2
comma
l_int|2
comma
l_int|1
comma
op_amp
id|c
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|numcards
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_findcards(): No cards found.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|register_reboot_notifier
c_func
(paren
op_amp
id|tw_notifier
)paren
suffix:semicolon
r_return
id|numcards
suffix:semicolon
)brace
multiline_comment|/* End tw_findcards() */
multiline_comment|/* This function will free up device extension resources */
DECL|function|tw_free_device_extension
r_void
id|tw_free_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|i
comma
id|imax
suffix:semicolon
id|imax
op_assign
id|TW_Q_LENGTH
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_free_device_extension()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Free command packet and generic buffer memory */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* End tw_free_device_extension() */
multiline_comment|/* Clean shutdown routine */
DECL|function|tw_halt
r_static
r_int
id|tw_halt
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
id|ulong
id|event
comma
r_void
op_star
id|buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tw_device_extension_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: Notifying card #%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|tw_shutdown_device
c_func
(paren
id|tw_device_extension_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|tw_notifier
)paren
suffix:semicolon
r_return
id|NOTIFY_OK
suffix:semicolon
)brace
multiline_comment|/* End tw_halt() */
multiline_comment|/* This function will send an initconnection command to controller */
DECL|function|tw_initconnection
r_int
id|tw_initconnection
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|message_credits
)paren
(brace
id|u32
id|command_que_addr
comma
id|command_que_value
suffix:semicolon
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|u32
id|response_que_addr
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|imax
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initconnection()&bslash;n&quot;
)paren
suffix:semicolon
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|response_que_addr
op_assign
id|tw_dev-&gt;registers.response_que_addr
suffix:semicolon
multiline_comment|/* Initialize InitConnection command packet */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_INIT_CONNECTION
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;size
op_assign
id|TW_INIT_COMMAND_PACKET_SIZE
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;byte6.message_credits
op_assign
id|message_credits
suffix:semicolon
id|command_packet-&gt;byte8.init_connection.response_queue_pointer
op_assign
l_int|0x0
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Send command packet to the board */
id|outl
c_func
(paren
id|command_que_value
comma
id|command_que_addr
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
id|imax
op_assign
id|TW_POLL_MAX_RETRIES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|response_que_addr
)paren
suffix:semicolon
id|request_id
op_assign
(paren
r_int
r_char
)paren
id|response_queue.u.response_id
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Bad response, status = 0x%x, flags = 0x%x.&bslash;n&quot;
comma
id|command_packet-&gt;status
comma
id|command_packet-&gt;flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* Response was okay, so we exit */
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_initconnection() */
multiline_comment|/* This function will initialize the fields of a device extension */
DECL|function|tw_initialize_device_extension
r_int
id|tw_initialize_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|i
comma
id|imax
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initialize_device_extension()&bslash;n&quot;
)paren
suffix:semicolon
id|imax
op_assign
id|TW_Q_LENGTH
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Initialize command packet buffers */
id|tw_allocate_memory
c_func
(paren
id|tw_dev
comma
id|i
comma
r_sizeof
(paren
id|TW_Sector
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_device_extension(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize generic buffer */
id|tw_allocate_memory
c_func
(paren
id|tw_dev
comma
id|i
comma
r_sizeof
(paren
id|TW_Sector
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_device_extension(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;free_queue
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
id|tw_dev-&gt;ioctl_size
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;aen_queue
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_MAX_UNITS
suffix:semicolon
id|i
op_increment
)paren
id|tw_dev-&gt;is_unit_present
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;num_units
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;num_aborts
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;num_resets
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
id|TW_Q_LENGTH
op_minus
l_int|1
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;max_posted_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;max_sgl_entries
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;sgl_entries
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;host
op_assign
l_int|NULL
suffix:semicolon
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;aen_head
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;aen_tail
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;sector_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;max_sector_count
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
id|tw_dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_initialize_device_extension() */
multiline_comment|/* This function will get unit info from the controller */
DECL|function|tw_initialize_units
r_int
id|tw_initialize_units
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|request_id
op_assign
l_int|0
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
id|i
comma
id|imax
comma
id|num_units
op_assign
l_int|0
suffix:semicolon
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|u32
id|command_que_addr
comma
id|command_que_value
suffix:semicolon
id|u32
id|response_que_addr
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
id|u32
id|param_value
suffix:semicolon
r_int
r_char
op_star
id|is_unit_present
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initialize_units()&bslash;n&quot;
)paren
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|response_que_addr
op_assign
id|tw_dev-&gt;registers.response_que_addr
suffix:semicolon
multiline_comment|/* Setup the command packet */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_GET_PARAM
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.block_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unit summary table */
id|param-&gt;parameter_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unitstatus parameter */
id|param-&gt;parameter_size_bytes
op_assign
id|TW_MAX_UNITS
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
multiline_comment|/* Post the command packet to the board */
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|outl
c_func
(paren
id|command_que_value
comma
id|command_que_addr
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
id|imax
op_assign
id|TW_POLL_MAX_RETRIES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|response_que_addr
)paren
suffix:semicolon
id|request_id
op_assign
(paren
r_int
r_char
)paren
id|response_queue.u.response_id
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): Bad response, status = 0x%x, flags = 0x%x.&bslash;n&quot;
comma
id|command_packet-&gt;status
comma
id|command_packet-&gt;flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
(brace
multiline_comment|/* response never received */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initialize_units(): No response.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|is_unit_present
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Show all units present */
id|imax
op_assign
id|TW_MAX_UNITS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|is_unit_present
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|i
)braket
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is_unit_present
(braket
id|i
)braket
op_amp
id|TW_UNIT_ONLINE
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initialize_units(): Unit %d found.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|tw_dev-&gt;is_unit_present
(braket
id|i
)braket
op_assign
id|TRUE
suffix:semicolon
id|num_units
op_increment
suffix:semicolon
)brace
)brace
)brace
id|tw_dev-&gt;num_units
op_assign
id|num_units
suffix:semicolon
r_if
c_cond
(paren
id|num_units
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initialize_units(): No units found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_initialize_units() */
multiline_comment|/* This function is the interrupt service routine */
DECL|function|tw_interrupt
r_static
r_void
id|tw_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|request_id
suffix:semicolon
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|u32
id|response_que_addr
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|dev_instance
suffix:semicolon
id|TW_Response_Queue
id|response_que
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|do_response_interrupt
op_assign
l_int|0
suffix:semicolon
r_int
id|do_attention_interrupt
op_assign
l_int|0
suffix:semicolon
r_int
id|do_host_interrupt
op_assign
l_int|0
suffix:semicolon
r_int
id|do_command_interrupt
op_assign
l_int|0
suffix:semicolon
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
id|flags2
op_assign
l_int|0
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|TW_IN_INTR
comma
op_amp
id|tw_dev-&gt;flags
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
op_eq
id|irq
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags2
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Read the registers */
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|response_que_addr
op_assign
id|tw_dev-&gt;registers.response_que_addr
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
multiline_comment|/* Check which interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_HOST_INTERRUPT
)paren
id|do_host_interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_ATTENTION_INTERRUPT
)paren
id|do_attention_interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_INTERRUPT
)paren
id|do_command_interrupt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_INTERRUPT
)paren
id|do_response_interrupt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Handle host interrupt */
r_if
c_cond
(paren
id|do_host_interrupt
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): Received host interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_clear_host_interrupt
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle attention interrupt */
r_if
c_cond
(paren
id|do_attention_interrupt
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): Received attention interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_state_request_start
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
id|error
op_assign
id|tw_aen_read_queue
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Error reading aen queue.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Clearing attention interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_clear_attention_interrupt
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle command interrupt */
r_if
c_cond
(paren
id|do_command_interrupt
)paren
(brace
multiline_comment|/* Drain as many pending commands as we can */
r_while
c_loop
(paren
id|tw_dev-&gt;pending_request_count
OG
l_int|0
)paren
(brace
id|request_id
op_assign
id|tw_dev-&gt;pending_queue
(braket
id|tw_dev-&gt;pending_head
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Found request id that wasn&squot;t pending.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;pending_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;pending_head
op_assign
id|tw_dev-&gt;pending_head
op_plus
l_int|1
suffix:semicolon
)brace
id|tw_dev-&gt;pending_request_count
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* If there are no more pending requests, we mask command interrupt */
r_if
c_cond
(paren
id|tw_dev-&gt;pending_request_count
op_eq
l_int|0
)paren
id|tw_mask_command_interrupt
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle response interrupt */
r_if
c_cond
(paren
id|do_response_interrupt
)paren
(brace
multiline_comment|/* Drain the response queue from the board */
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_que.value
op_assign
id|inl
c_func
(paren
id|response_que_addr
)paren
suffix:semicolon
id|request_id
op_assign
id|response_que.u.response_id
suffix:semicolon
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Bad response, status = 0x%x, flags = 0x%x.&bslash;n&quot;
comma
id|command_packet-&gt;status
comma
id|command_packet-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_POSTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Received a request id (%d) (opcode = 0x%x) that wasn&squot;t posted.&bslash;n&quot;
comma
id|request_id
comma
id|command_packet-&gt;byte0.opcode
)paren
suffix:semicolon
)brace
id|error
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): Response queue request id: %d.&bslash;n&quot;
comma
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Check for internal command */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Found internally posted command.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_aen_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Error completing aen.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_10
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught READ_10&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|READ_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught READ_6&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE_10
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught WRITE_10&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|WRITE_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught WRITE_6&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught INQUIRY&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_inquiry_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught READ_CAPACITY&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_read_capacity_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught TW_IOCTL&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_ioctl_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Unknown scsi opcode: 0x%x.&bslash;n&quot;
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
multiline_comment|/* Tell scsi layer there was an error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Scsi Error.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Tell scsi layer command was a success */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags2
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|TW_IN_INTR
comma
op_amp
id|tw_dev-&gt;flags
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_interrupt() */
multiline_comment|/* This function handles ioctls from userspace to the driver */
DECL|function|tw_ioctl
r_int
id|tw_ioctl
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
id|opcode
suffix:semicolon
r_int
id|bufflen
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|u32
id|param_value
suffix:semicolon
id|TW_Ioctl
op_star
id|ioctl
op_assign
l_int|NULL
suffix:semicolon
r_int
id|tw_aen_code
suffix:semicolon
id|ioctl
op_assign
(paren
id|TW_Ioctl
op_star
)paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bufflen
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;opcode = %d table_id = %d parameter_id = %d parameter_size_bytes = %d&bslash;n&quot;
comma
id|ioctl-&gt;opcode
comma
id|ioctl-&gt;table_id
comma
id|ioctl-&gt;parameter_id
comma
comma
id|ioctl-&gt;parameter_size_bytes
)paren
suffix:semicolon
id|opcode
op_assign
id|ioctl-&gt;opcode
suffix:semicolon
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|TW_OP_NOP
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl(): caught TW_OP_NOP.&bslash;n&quot;
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_NOP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_OP_GET_PARAM
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl(): caught TW_OP_GET_PARAM.&bslash;n&quot;
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_GET_PARAM
suffix:semicolon
id|param-&gt;table_id
op_assign
id|ioctl-&gt;table_id
suffix:semicolon
id|param-&gt;parameter_id
op_assign
id|ioctl-&gt;parameter_id
suffix:semicolon
id|param-&gt;parameter_size_bytes
op_assign
id|ioctl-&gt;parameter_size_bytes
suffix:semicolon
id|tw_dev-&gt;ioctl_size
(braket
id|request_id
)braket
op_assign
id|ioctl-&gt;parameter_size_bytes
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;table_id = %d parameter_id = %d parameter_size_bytes %d&bslash;n&quot;
comma
id|param-&gt;table_id
comma
id|param-&gt;parameter_id
comma
id|param-&gt;parameter_size_bytes
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_OP_SET_PARAM
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl(): caught TW_OP_SET_PARAM: table_id = %d, parameter_id = %d, parameter_size_bytes = %d.&bslash;n&quot;
comma
id|ioctl-&gt;table_id
comma
id|ioctl-&gt;parameter_id
comma
id|ioctl-&gt;parameter_size_bytes
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_SET_PARAM
suffix:semicolon
id|param-&gt;table_id
op_assign
id|ioctl-&gt;table_id
suffix:semicolon
id|param-&gt;parameter_id
op_assign
id|ioctl-&gt;parameter_id
suffix:semicolon
id|param-&gt;parameter_size_bytes
op_assign
id|ioctl-&gt;parameter_size_bytes
suffix:semicolon
id|memcpy
c_func
(paren
id|param-&gt;data
comma
id|ioctl-&gt;data
comma
id|ioctl-&gt;parameter_size_bytes
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_OP_AEN_LISTEN
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl(): caught TW_OP_AEN_LISTEN.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|tw_dev-&gt;aen_tail
)paren
(brace
multiline_comment|/* aen queue empty */
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl(): Aen queue empty.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_aen_code
op_assign
id|TW_AEN_QUEUE_EMPTY
suffix:semicolon
id|memcpy
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
comma
op_amp
id|tw_aen_code
comma
id|ioctl-&gt;parameter_size_bytes
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Copy aen queue entry to request buffer */
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl(): Returning aen 0x%x&bslash;n&quot;
comma
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_head
)braket
)paren
suffix:semicolon
id|tw_aen_code
op_assign
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_head
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
comma
op_amp
id|tw_aen_code
comma
id|ioctl-&gt;parameter_size_bytes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_head
op_assign
id|tw_dev-&gt;aen_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TW_CMD_PACKET
suffix:colon
id|memcpy
c_func
(paren
id|command_packet
comma
id|ioctl-&gt;data
comma
r_sizeof
(paren
id|TW_Command
)paren
)paren
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Unknown ioctl 0x%x.&bslash;n&quot;
comma
id|opcode
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now try to post the command to the board */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_ioctl() */
multiline_comment|/* This function is called by the isr to complete ioctl requests */
DECL|function|tw_ioctl_complete
r_int
id|tw_ioctl_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
op_star
id|param_data
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl_complete()&bslash;n&quot;
)paren
suffix:semicolon
id|buff
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl_complete(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_ioctl_complete(): Request_bufflen = %d&bslash;n&quot;
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param_data
op_assign
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
comma
id|param_data
comma
id|tw_dev-&gt;ioctl_size
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_ioctl_complete() */
multiline_comment|/* This function will mask the command interrupt */
DECL|function|tw_mask_command_interrupt
r_void
id|tw_mask_command_interrupt
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_addr
comma
id|control_reg_value
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
id|TW_CONTROL_MASK_COMMAND_INTERRUPT
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_mask_command_interrupt() */
multiline_comment|/* This function will poll the status register for a flag */
DECL|function|tw_poll_status
r_int
id|tw_poll_status
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|flag
comma
r_int
id|seconds
)paren
(brace
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
r_struct
id|timeval
id|before
comma
id|timeout
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|before
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|flag
)paren
op_ne
id|flag
)paren
(brace
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|before.tv_sec
op_plus
id|seconds
OL
id|timeout.tv_sec
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_poll_status(): Flag 0x%x not found.&bslash;n&quot;
comma
id|flag
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_poll_status() */
multiline_comment|/* This function will attempt to post a command packet to the board */
DECL|function|tw_post_command_packet
r_int
id|tw_post_command_packet
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|u32
id|command_que_addr
comma
id|command_que_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_post_command_packet()&bslash;n&quot;
)paren
suffix:semicolon
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_post_command_packet(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_QUEUE_FULL
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* We successfully posted the command packet */
id|outl
c_func
(paren
id|command_que_value
comma
id|command_que_addr
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_POSTED
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;posted_request_count
OG
id|tw_dev-&gt;max_posted_request_count
)paren
(brace
id|tw_dev-&gt;max_posted_request_count
op_assign
id|tw_dev-&gt;posted_request_count
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Couldn&squot;t post the command packet, so we do it in the isr */
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_PENDING
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;pending_request_count
OG
id|tw_dev-&gt;max_pending_request_count
)paren
(brace
id|tw_dev-&gt;max_pending_request_count
op_assign
id|tw_dev-&gt;pending_request_count
suffix:semicolon
)brace
id|tw_dev-&gt;pending_queue
(braket
id|tw_dev-&gt;pending_tail
)braket
op_assign
id|request_id
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;pending_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;pending_tail
op_assign
id|tw_dev-&gt;pending_tail
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|tw_unmask_command_interrupt
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_post_command_packet() */
multiline_comment|/* This function will reset a device extension */
DECL|function|tw_reset_device_extension
r_int
id|tw_reset_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|imax
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|Scsi_Cmnd
op_star
id|srb
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_reset_device_extension()&bslash;n&quot;
)paren
suffix:semicolon
id|imax
op_assign
id|TW_Q_LENGTH
suffix:semicolon
r_if
c_cond
(paren
id|tw_reset_sequence
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_reset_device_extension(): Reset sequence failed for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Abort all requests that are in progress */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_FINISHED
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_INITIAL
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_COMPLETED
)paren
)paren
(brace
id|srb
op_assign
id|tw_dev-&gt;srb
(braket
id|i
)braket
suffix:semicolon
id|srb-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|i
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset queues and counts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tw_dev-&gt;free_queue
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
)brace
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
id|TW_Q_LENGTH
op_minus
l_int|1
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_reset_device_extension() */
multiline_comment|/* This function will reset a controller */
DECL|function|tw_reset_sequence
r_int
id|tw_reset_sequence
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|tries
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|tw_disable_interrupts
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Reset the board */
r_while
c_loop
(paren
id|tries
OL
id|TW_MAX_RESET_TRIES
)paren
(brace
id|tw_soft_reset
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|error
op_assign
id|tw_aen_drain_queue
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_reset_sequence(): No attention interrupt for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Check for controller errors */
r_if
c_cond
(paren
id|tw_check_errors
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_reset_sequence(): Controller errors found, soft resetting card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Empty the response queue again */
id|error
op_assign
id|tw_empty_response_que
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_reset_sequence(): Couldn&squot;t empty response queue for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Now the controller is in a good state */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
op_ge
id|TW_MAX_RESET_TRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_reset_sequence(): Controller error or no attention interrupt: giving up for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|error
op_assign
id|tw_initconnection
c_func
(paren
id|tw_dev
comma
id|TW_INIT_MESSAGE_CREDITS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_reset_sequence(): Couldn&squot;t initconnection for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Re-enable interrupts */
id|tw_enable_interrupts
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_reset_sequence() */
multiline_comment|/* This funciton returns unit geometry in cylinders/heads/sectors */
DECL|function|tw_scsi_biosparam
r_int
id|tw_scsi_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_biosparam()&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_biosparam(): heads = %d, sectors = %d, cylinders = %d&bslash;n&quot;
comma
id|heads
comma
id|sectors
comma
id|cylinders
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_biosparam() */
multiline_comment|/* This function will find and initialize any cards */
DECL|function|tw_scsi_detect
r_int
id|tw_scsi_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tw_host
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_detect()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check if the kernel has PCI interface compiled in */
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_detect(): No pci interface present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|tw_findcards
c_func
(paren
id|tw_host
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_detect() */
multiline_comment|/* This is the new scsi eh abort function */
DECL|function|tw_scsi_eh_abort
r_int
id|tw_scsi_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_eh_abort()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_abort(): Invalid Scsi_Cmnd.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_abort(): Invalid device extension.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
id|tw_dev-&gt;num_aborts
op_increment
suffix:semicolon
multiline_comment|/* If the command hasn&squot;t been posted yet, we can do the abort */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
op_eq
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_eq
id|TW_S_STARTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_abort(): Abort succeeded for started Scsi_Cmnd 0x%x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|i
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_eq
id|TW_S_PENDING
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_abort(): Abort succeeded for pending Scsi_Cmnd 0x%x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;pending_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;pending_head
op_assign
id|tw_dev-&gt;pending_head
op_plus
l_int|1
suffix:semicolon
)brace
id|tw_dev-&gt;pending_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|i
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If the command has already been posted, we have to reset the card */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_abort(): Abort failed for unknown Scsi_Cmnd 0x%x, resetting card %d.&bslash;n&quot;
comma
(paren
id|u32
)paren
id|SCpnt
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_reset_device_extension
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_abort(): Reset failed for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_eh_abort() */
multiline_comment|/* This is the new scsi eh reset function */
DECL|function|tw_scsi_eh_reset
r_int
id|tw_scsi_eh_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_eh_reset()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_reset(): Invalid Scsi_Cmnd.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_reset(): Invalid device extension.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
id|tw_dev-&gt;num_resets
op_increment
suffix:semicolon
multiline_comment|/* Now reset the card and some of the device extension data */
r_if
c_cond
(paren
id|tw_reset_device_extension
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_reset(): Reset failed for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_eh_reset(): Reset succeeded for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_eh_reset() */
multiline_comment|/* This function handles input and output from /proc/scsi/3w-xxxx/x */
DECL|function|tw_scsi_proc_info
r_int
id|tw_scsi_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
l_int|NULL
suffix:semicolon
id|TW_Info
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_proc_info()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Find the correct device extension */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tw_device_extension_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|tw_device_extension_list
(braket
id|i
)braket
op_member_access_from_pointer
id|host-&gt;host_no
op_eq
id|hostno
)paren
id|tw_dev
op_assign
id|tw_device_extension_list
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_proc_info(): Couldn&squot;t locate device extension.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|info.buffer
op_assign
id|buffer
suffix:semicolon
id|info.length
op_assign
id|length
suffix:semicolon
id|info.offset
op_assign
id|offset
suffix:semicolon
id|info.position
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inout
)paren
(brace
multiline_comment|/* Write */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|buffer
comma
l_string|&quot;debug&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3w-xxxx: Posted commands:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|TW_Q_LENGTH
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|j
)braket
op_eq
id|TW_S_POSTED
)paren
(brace
id|TW_Command
op_star
id|command
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|j
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3w-xxxx: Request_id: %d&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Opcode: 0x%x&bslash;n&quot;
comma
id|command-&gt;byte0.opcode
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Block_count: 0x%x&bslash;n&quot;
comma
id|command-&gt;byte6.block_count
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LBA: 0x%x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|command-&gt;byte8.io.lba
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Physical command packet addr: 0x%x&bslash;n&quot;
comma
id|tw_dev-&gt;command_packet_physical_address
(braket
id|j
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Scsi_Cmnd: 0x%x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|tw_dev-&gt;srb
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3w-xxxx: Free_head: %3d&bslash;n&quot;
comma
id|tw_dev-&gt;free_head
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3w-xxxx: Free_tail: %3d&bslash;n&quot;
comma
id|tw_dev-&gt;free_tail
)paren
suffix:semicolon
)brace
r_return
id|length
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Read */
r_if
c_cond
(paren
id|start
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
)brace
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;scsi%d: 3ware Storage Controller&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Driver version: %s&bslash;n&quot;
comma
id|tw_driver_version
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Current commands posted:       %3d&bslash;n&quot;
comma
id|tw_dev-&gt;posted_request_count
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Max commands posted:           %3d&bslash;n&quot;
comma
id|tw_dev-&gt;max_posted_request_count
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Current pending commands:      %3d&bslash;n&quot;
comma
id|tw_dev-&gt;pending_request_count
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Max pending commands:          %3d&bslash;n&quot;
comma
id|tw_dev-&gt;max_pending_request_count
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Last sgl length:               %3d&bslash;n&quot;
comma
id|tw_dev-&gt;sgl_entries
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Max sgl length:                %3d&bslash;n&quot;
comma
id|tw_dev-&gt;max_sgl_entries
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Last sector count:             %3d&bslash;n&quot;
comma
id|tw_dev-&gt;sector_count
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Max sector count:              %3d&bslash;n&quot;
comma
id|tw_dev-&gt;max_sector_count
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Resets:                        %3d&bslash;n&quot;
comma
id|tw_dev-&gt;num_resets
)paren
suffix:semicolon
id|tw_copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Aborts:                        %3d&bslash;n&quot;
comma
id|tw_dev-&gt;num_aborts
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.position
OG
id|info.offset
)paren
(brace
r_return
(paren
id|info.position
op_minus
id|info.offset
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* End tw_scsi_proc_info() */
multiline_comment|/* This is the main scsi queue function to handle scsi opcodes */
DECL|function|tw_scsi_queue
r_int
id|tw_scsi_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_char
op_star
id|command
op_assign
id|SCpnt-&gt;cmnd
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Skip scsi command if it isn&squot;t for us */
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;is_unit_present
(braket
id|SCpnt-&gt;target
)braket
op_eq
id|FALSE
)paren
op_logical_or
(paren
id|SCpnt-&gt;lun
op_ne
l_int|0
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|done
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_queue(): Invalid done function.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsi_queue(): Invalid device extension.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Save done function into Scsi_Cmnd struct */
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* Queue the command and get a request id */
id|tw_state_request_start
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Save the scsi command for use by the ISR */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
id|SCpnt
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|command
)paren
(brace
r_case
id|READ_10
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught READ_10.&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|READ_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught READ_6.&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|WRITE_10
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught WRITE_10.&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|WRITE_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught WRITE_6.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_read_write
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught TEST_UNIT_READY.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_test_unit_ready
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught INQUIRY.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_inquiry
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught READ_CAPACITY.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_read_capacity
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught TW_SCSI_IOCTL.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_ioctl
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): Unknown scsi opcode: 0x%x&bslash;n&quot;
comma
op_star
id|command
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tw_dev-&gt;tw_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_queue() */
multiline_comment|/* This function will release the resources on an rmmod call */
DECL|function|tw_scsi_release
r_int
id|tw_scsi_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|tw_host
)paren
(brace
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|tw_host-&gt;hostdata
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_release()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Free up the IO region */
id|release_region
c_func
(paren
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
comma
id|TW_IO_ADDRESS_RANGE
)paren
suffix:semicolon
multiline_comment|/* Free up the IRQ */
id|free_irq
c_func
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
comma
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Free up device extension resources */
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Tell kernel scsi-layer we are gone */
id|scsi_unregister
c_func
(paren
id|tw_host
)paren
suffix:semicolon
multiline_comment|/* Fake like we just shut down, so notify the card that&n;&t; * we &quot;shut down cleanly&quot;.&n;&t; */
id|tw_halt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// parameters aren&squot;t actually used
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_release() */
multiline_comment|/* This function handles scsi inquiry commands */
DECL|function|tw_scsiop_inquiry
r_int
id|tw_scsiop_inquiry
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|u32
id|command_que_value
comma
id|command_que_addr
suffix:semicolon
id|u32
id|param_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_inquiry()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_GET_PARAM
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unit summary table */
id|param-&gt;parameter_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unitsstatus parameter */
id|param-&gt;parameter_size_bytes
op_assign
id|TW_MAX_UNITS
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command packet */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_inquiry() */
multiline_comment|/* This function is called by the isr to complete an inquiry command */
DECL|function|tw_scsiop_inquiry_complete
r_int
id|tw_scsiop_inquiry_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
op_star
id|is_unit_present
suffix:semicolon
r_int
r_char
op_star
id|request_buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Fill request buffer */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|request_buffer
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
id|memset
c_func
(paren
id|request_buffer
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|request_buffer
(braket
l_int|0
)braket
op_assign
id|TYPE_DISK
suffix:semicolon
multiline_comment|/* Peripheral device type */
id|request_buffer
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Device type modifier */
id|request_buffer
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No ansi/iso compliance */
id|request_buffer
(braket
l_int|4
)braket
op_assign
l_int|31
suffix:semicolon
multiline_comment|/* Additional length */
id|memcpy
c_func
(paren
op_amp
id|request_buffer
(braket
l_int|8
)braket
comma
l_string|&quot;3ware   &quot;
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Vendor ID */
id|memcpy
c_func
(paren
op_amp
id|request_buffer
(braket
l_int|16
)braket
comma
l_string|&quot;3w-xxxx         &quot;
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Product ID */
id|memcpy
c_func
(paren
op_amp
id|request_buffer
(braket
l_int|32
)braket
comma
id|tw_driver_version
comma
l_int|3
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|is_unit_present
op_assign
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_MAX_UNITS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|is_unit_present
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|i
)braket
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is_unit_present
(braket
id|i
)braket
op_amp
id|TW_UNIT_ONLINE
)paren
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|i
)braket
op_assign
id|TRUE
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete: Unit %d found.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_inquiry_complete() */
multiline_comment|/* This function handles scsi read_capacity commands */
DECL|function|tw_scsiop_read_capacity
r_int
id|tw_scsiop_read_capacity
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|u32
id|command_que_addr
comma
id|command_que_value
suffix:semicolon
id|u32
id|param_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_GET_PARAM
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|target
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.block_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
id|TW_UNIT_INFORMATION_TABLE_BASE
op_plus
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|target
suffix:semicolon
id|param-&gt;parameter_id
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* unitcapacity parameter */
id|param-&gt;parameter_size_bytes
op_assign
l_int|4
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command to the board */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_read_capacity() */
multiline_comment|/* This function is called by the isr to complete a readcapacity command */
DECL|function|tw_scsiop_read_capacity_complete
r_int
id|tw_scsiop_read_capacity_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
op_star
id|param_data
suffix:semicolon
id|u32
id|capacity
suffix:semicolon
r_char
op_star
id|buff
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete()&bslash;n&quot;
)paren
suffix:semicolon
id|buff
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param_data
op_assign
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|capacity
op_assign
(paren
id|param_data
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|param_data
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|param_data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|param_data
(braket
l_int|0
)braket
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Capacity = 0x%x.&bslash;n&quot;
comma
id|capacity
)paren
suffix:semicolon
multiline_comment|/* Number of LBA&squot;s */
id|buff
(braket
l_int|0
)braket
op_assign
(paren
id|capacity
op_rshift
l_int|24
)paren
suffix:semicolon
id|buff
(braket
l_int|1
)braket
op_assign
(paren
id|capacity
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|2
)braket
op_assign
(paren
id|capacity
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|3
)braket
op_assign
id|capacity
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* Block size in bytes (512) */
id|buff
(braket
l_int|4
)braket
op_assign
(paren
id|TW_BLOCK_SIZE
op_rshift
l_int|24
)paren
suffix:semicolon
id|buff
(braket
l_int|5
)braket
op_assign
(paren
id|TW_BLOCK_SIZE
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|6
)braket
op_assign
(paren
id|TW_BLOCK_SIZE
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|7
)braket
op_assign
id|TW_BLOCK_SIZE
op_amp
l_int|0xff
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_read_capacity_complete() */
multiline_comment|/* This function handles scsi read or write commands */
DECL|function|tw_scsiop_read_write
r_int
id|tw_scsiop_read_write
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|u32
id|command_que_addr
comma
id|command_que_value
op_assign
l_int|0
suffix:semicolon
id|u32
id|lba
op_assign
l_int|0x0
comma
id|num_sectors
op_assign
l_int|0x0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|Scsi_Cmnd
op_star
id|srb
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sglist
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
id|srb
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
)paren
(brace
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_READ
suffix:semicolon
)brace
r_else
(brace
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_WRITE
suffix:semicolon
)brace
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|3
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|5
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte3.unit
op_assign
id|srb-&gt;target
suffix:semicolon
id|command_packet-&gt;byte3.host_id
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_10
)paren
(brace
r_if
c_cond
(paren
(paren
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x8
)paren
op_logical_or
(paren
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
)paren
id|command_packet-&gt;flags
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
(brace
id|lba
op_assign
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|3
)braket
suffix:semicolon
id|num_sectors
op_assign
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_else
(brace
id|lba
op_assign
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|5
)braket
suffix:semicolon
id|num_sectors
op_assign
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|8
)braket
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* Update sector statistic */
id|tw_dev-&gt;sector_count
op_assign
id|num_sectors
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;sector_count
OG
id|tw_dev-&gt;max_sector_count
)paren
id|tw_dev-&gt;max_sector_count
op_assign
id|tw_dev-&gt;sector_count
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): lba = 0x%x num_sectors = 0x%x&bslash;n&quot;
comma
id|lba
comma
id|num_sectors
)paren
suffix:semicolon
id|command_packet-&gt;byte8.io.lba
op_assign
id|lba
suffix:semicolon
id|command_packet-&gt;byte6.block_count
op_assign
id|num_sectors
suffix:semicolon
multiline_comment|/* Do this if there are no sg list entries */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): SG = 0&bslash;n&quot;
)paren
suffix:semicolon
id|command_packet-&gt;byte8.io.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
)paren
suffix:semicolon
id|command_packet-&gt;byte8.io.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
suffix:semicolon
)brace
multiline_comment|/* Do this if we have multiple sg list entries */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|command_packet-&gt;byte8.io.sgl
(braket
id|i
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|sglist
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
id|command_packet-&gt;byte8.io.sgl
(braket
id|i
)braket
dot
id|length
op_assign
id|sglist
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|command_packet-&gt;size
op_add_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
OG
l_int|1
)paren
id|command_packet-&gt;size
op_sub_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Update SG statistics */
id|tw_dev-&gt;sgl_entries
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;sgl_entries
OG
id|tw_dev-&gt;max_sgl_entries
)paren
id|tw_dev-&gt;max_sgl_entries
op_assign
id|tw_dev-&gt;sgl_entries
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command to the board */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_read_write() */
multiline_comment|/* This function will handle test unit ready scsi command */
DECL|function|tw_scsiop_test_unit_ready
r_int
id|tw_scsiop_test_unit_ready
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Tell the scsi layer were done */
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_test_unit_ready() */
multiline_comment|/* Set a value in the features table */
DECL|function|tw_setfeature
r_int
id|tw_setfeature
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|parm
comma
r_int
id|param_size
comma
r_int
r_char
op_star
id|val
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
id|u32
id|command_que_value
comma
id|command_que_addr
suffix:semicolon
id|u32
id|status_reg_addr
comma
id|status_reg_value
suffix:semicolon
id|u32
id|response_que_addr
suffix:semicolon
id|u32
id|param_value
suffix:semicolon
r_int
id|imax
comma
id|i
suffix:semicolon
multiline_comment|/* Initialize SetParam command packet */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|command_packet-&gt;byte0.opcode
op_assign
id|TW_OP_SET_PARAM
suffix:semicolon
id|command_packet-&gt;byte0.sgl_offset
op_assign
l_int|2
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|0x404
suffix:semicolon
multiline_comment|/* Features table */
id|param-&gt;parameter_id
op_assign
id|parm
suffix:semicolon
id|param-&gt;parameter_size_bytes
op_assign
id|param_size
suffix:semicolon
id|memcpy
c_func
(paren
id|param-&gt;data
comma
id|val
comma
id|param_size
)paren
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_que_addr
op_assign
id|tw_dev-&gt;registers.command_que_addr
suffix:semicolon
id|status_reg_addr
op_assign
id|tw_dev-&gt;registers.status_reg_addr
suffix:semicolon
id|response_que_addr
op_assign
id|tw_dev-&gt;registers.response_que_addr
suffix:semicolon
multiline_comment|/* Send command packet to the board */
id|outl
c_func
(paren
id|command_que_value
comma
id|command_que_addr
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
id|imax
op_assign
id|TW_POLL_MAX_RETRIES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|imax
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|status_reg_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|response_que_addr
)paren
suffix:semicolon
id|request_id
op_assign
(paren
r_int
r_char
)paren
id|response_queue.u.response_id
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Bad response, status = 0x%x, flags = 0x%x.&bslash;n&quot;
comma
id|command_packet-&gt;status
comma
id|command_packet-&gt;flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* Response was okay, so we exit */
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_setfeature() */
multiline_comment|/* This function will setup the interrupt handler */
DECL|function|tw_setup_irq
r_int
id|tw_setup_irq
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_char
op_star
id|device
op_assign
id|TW_DEVICE_NAME
suffix:semicolon
r_int
id|error
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_setup_irq()&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|request_irq
c_func
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
comma
id|tw_interrupt
comma
id|SA_SHIRQ
comma
id|device
comma
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setup_irq(): Error requesting IRQ: %d for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;tw_pci_dev-&gt;irq
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_setup_irq() */
multiline_comment|/* This function will tell the controller we&squot;re shutting down by sending&n;   initconnection with a 1 */
DECL|function|tw_shutdown_device
r_int
id|tw_shutdown_device
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|error
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|tw_disable_interrupts
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* poke the board */
id|error
op_assign
id|tw_initconnection
c_func
(paren
id|tw_dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_shutdown_device(): Couldn&squot;t initconnection for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx shutdown succeeded&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Re-enable interrupts */
id|tw_enable_interrupts
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_shutdown_device() */
multiline_comment|/* This function will soft reset the controller */
DECL|function|tw_soft_reset
r_void
id|tw_soft_reset
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_addr
comma
id|control_reg_value
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
(paren
id|TW_CONTROL_ISSUE_SOFT_RESET
op_or
id|TW_CONTROL_CLEAR_HOST_INTERRUPT
op_or
id|TW_CONTROL_CLEAR_ATTENTION_INTERRUPT
op_or
id|TW_CONTROL_MASK_COMMAND_INTERRUPT
op_or
id|TW_CONTROL_MASK_RESPONSE_INTERRUPT
op_or
id|TW_CONTROL_CLEAR_ERROR_STATUS
op_or
id|TW_CONTROL_DISABLE_INTERRUPTS
)paren
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_soft_reset() */
multiline_comment|/* This function will free a request_id */
DECL|function|tw_state_request_finish
r_int
id|tw_state_request_finish
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_state_request_finish()&bslash;n&quot;
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;free_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;free_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;free_tail
op_assign
id|tw_dev-&gt;free_tail
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|tw_dev-&gt;state
(braket
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_tail
)braket
)braket
op_ne
id|TW_S_COMPLETED
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_tail
)braket
op_assign
id|request_id
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_FINISHED
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_state_request_finish(): Freeing request_id %d&bslash;n&quot;
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_state_request_finish() */
multiline_comment|/* This function will assign an available request_id */
DECL|function|tw_state_request_start
r_int
id|tw_state_request_start
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
op_star
id|request_id
)paren
(brace
r_int
id|id
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_state_request_start()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Obtain next free request_id */
r_do
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;free_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;free_head
op_assign
id|tw_dev-&gt;free_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|tw_dev-&gt;state
(braket
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
)braket
op_eq
id|TW_S_STARTED
)paren
op_logical_or
(paren
id|tw_dev-&gt;state
(braket
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
)braket
op_eq
id|TW_S_POSTED
)paren
op_logical_or
(paren
id|tw_dev-&gt;state
(braket
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
)braket
op_eq
id|TW_S_PENDING
)paren
op_logical_or
(paren
id|tw_dev-&gt;state
(braket
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
)braket
op_eq
id|TW_S_COMPLETED
)paren
)paren
suffix:semicolon
id|id
op_assign
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;free_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;free_head
op_assign
id|tw_dev-&gt;free_head
op_plus
l_int|1
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_state_request_start(): id = %d.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
op_star
id|request_id
op_assign
id|id
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|id
)braket
op_assign
id|TW_S_STARTED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_state_request_start() */
multiline_comment|/* This function will unmask the command interrupt on the controller */
DECL|function|tw_unmask_command_interrupt
r_void
id|tw_unmask_command_interrupt
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|control_reg_addr
comma
id|control_reg_value
suffix:semicolon
id|control_reg_addr
op_assign
id|tw_dev-&gt;registers.control_reg_addr
suffix:semicolon
id|control_reg_value
op_assign
id|TW_CONTROL_UNMASK_COMMAND_INTERRUPT
suffix:semicolon
id|outl
c_func
(paren
id|control_reg_value
comma
id|control_reg_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_unmask_command_interrupt() */
multiline_comment|/* Now get things going */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|TWXXXX
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
