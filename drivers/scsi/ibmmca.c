multiline_comment|/*&n; * Low Level Driver for the IBM Microchannel SCSI Subsystem&n; *&n; * Copyright (c) 1995 Strom Systems, Inc. under the terms of the GNU &n; * General Public License. Written by Martin Kolinek, December 1995.&n; */
multiline_comment|/* Update history:&n;   Jan 15 1996:  First public release.&n;&n;   Jan 23 1996:  Scrapped code which reassigned scsi devices to logical&n;   device numbers. Instead, the existing assignment (created&n;   when the machine is powered-up or rebooted) is used. &n;   A side effect is that the upper layer of Linux SCSI &n;   device driver gets bogus scsi ids (this is benign), &n;   and also the hard disks are ordered under Linux the &n;   same way as they are under dos (i.e., C: disk is sda, &n;   D: disk is sdb, etc.).&n;&n;   I think that the CD-ROM is now detected only if a CD is &n;   inside CD_ROM while Linux boots. This can be fixed later,&n;   once the driver works on all types of PS/2&squot;s.&n;&n;   Feb 7 1996:   Modified biosparam function. Fixed the CD-ROM detection. &n;   For now, devices other than harddisk and CD_ROM are &n;   ignored. Temporarily modified abort() function &n;   to behave like reset(). &n;&n;   Mar 31 1996:  The integrated scsi subsystem is correctly found&n;   in PS/2 models 56,57, but not in model 76. Therefore&n;   the ibmmca_scsi_setup() function has been added today.&n;   This function allows the user to force detection of&n;   scsi subsystem. The kernel option has format&n;   ibmmcascsi=n&n;   where n is the scsi_id (pun) of the subsystem. Most&n;   likely, n is 7. &n;&n;   Aug 21 1996:  Modified the code which maps ldns to (pun,0).  It was&n;   insufficient for those of us with CD-ROM changers.&n;   - Chris Beauregard&n;&n;   Mar 16 1997: Modified driver to run as a module and to support&n;   multiple adapters.&n;   - Klaus Kudielka&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ibmmca.h&quot;
multiline_comment|/*--------------------------------------------------------------------*/
multiline_comment|/*&n;   Driver Description&n;&n;   (A) Subsystem Detection&n;   This is done in the ibmmca_detect() function and is easy, since&n;   the information about MCA integrated subsystems and plug-in &n;   adapters is readily available in structure *mca_info.&n;&n;   (B) Physical Units, Logical Units, and Logical Devices&n;   There can be up to 56 devices on SCSI bus (besides the adapter):&n;   there are up to 7 &quot;physical units&quot; (each identified by physical unit &n;   number or pun, also called the scsi id, this is the number you select&n;   with hardware jumpers), and each physical unit can have up to 8 &n;   &quot;logical units&quot; (each identified by logical unit number, or lun, &n;   between 0 and 7). &n;&n;   Typically the adapter has pun=7, so puns of other physical units&n;   are between 0 and 6. Almost all physical units have only one   &n;   logical unit, with lun=0. A CD-ROM jukebox would be an example of &n;   a physical unit with more than one logical unit.&n;&n;   The embedded microprocessor of IBM SCSI subsystem hides the complex&n;   two-dimensional (pun,lun) organization from the operating system.&n;   When the machine is powered-up (or rebooted, I am not sure), the &n;   embedded microprocessor checks, on it own, all 56 possible (pun,lun) &n;   combinations, and first 15 devices found are assigned into a &n;   one-dimensional array of so-called &quot;logical devices&quot;, identified by &n;   &quot;logical device numbers&quot; or ldn. The last ldn=15 is reserved for &n;   the subsystem itself. &n;&n;   One consequence of information hiding is that the real (pun,lun)    &n;   numbers are also hidden. Therefore this driver takes the following&n;   approach: It checks the ldn&squot;s (0 to 6) to find out which ldn&squot;s&n;   have devices assigned. This is done by function check_devices() and&n;   device_exists(). The interrupt handler has a special paragraph of code&n;   (see local_checking_phase_flag) to assist in the checking. Assume, for&n;   example, that three logical devices were found assigned at ldn 0, 1, 2.&n;   These are presented to the upper layer of Linux SCSI driver&n;   as devices with bogus (pun, lun) equal to (0,0), (1,0), (2,0). &n;   On the other hand, if the upper layer issues a command to device&n;   say (4,0), this driver returns DID_NO_CONNECT error.&n;&n;   That last paragraph is no longer correct, but is left for&n;   historical purposes.  It limited the number of devices to 7, far&n;   fewer than the 15 that it could use.  Now it just maps&n;   ldn -&gt; (ldn/8,ldn%8).  We end up with a real mishmash of puns&n;   and luns, but it all seems to work. - Chris Beaurgard&n;&n;   (C) Regular Processing &n;   Only three functions get involved: ibmmca_queuecommand(), issue_cmd(),&n;   and interrupt_handler().&n;&n;   The upper layer issues a scsi command by calling function &n;   ibmmca_queuecommand(). This function fills a &quot;subsystem control block&quot;&n;   (scb) and calls a local function issue_cmd(), which writes a scb &n;   command into subsystem I/O ports. Once the scb command is carried out, &n;   interrupt_handler() is invoked.&n;&n;   (D) Abort, Reset.&n;   These are implemented with busy waiting for interrupt to arrive.&n;   The abort does not worked well for me, so I instead call the &n;   ibmmca_reset() from the ibmmca_abort() function.&n;&n;   (E) Disk Geometry&n;   The ibmmca_biosparams() function should return same disk geometry &n;   as bios. This is needed for fdisk, etc. The returned geometry is &n;   certainly correct for disk smaller than 1 gigabyte, but I am not &n;   100% sure that it is correct for larger disks.&n;&n;   (F) Kernel Boot Option &n;   The function ibmmca_scsi_setup() is called if option ibmmcascsi=... &n;   is passed to the kernel. See file linux/init/main.c for details.&n; */
multiline_comment|/*--------------------------------------------------------------------*/
multiline_comment|/* Here are the values and structures specific for the subsystem. &n; * The source of information is &quot;Update for the PS/2 Hardware &n; * Interface Technical Reference, Common Interfaces&quot;, September 1991, &n; * part number 04G3281, available in the U.S. for $21.75 at &n; * 1-800-IBM-PCTB, elsewhere call your local friendly IBM &n; * representative.&n; * In addition to SCSI subsystem, this update contains fairly detailed &n; * (at hardware register level) sections on diskette  controller,&n; * keyboard controller, serial port controller, VGA, and XGA.&n; */
multiline_comment|/* driver configuration */
DECL|macro|IM_MAX_HOSTS
mdefine_line|#define IM_MAX_HOSTS      8             /* maximum number of host adapters */
DECL|macro|IM_RESET_DELAY
mdefine_line|#define IM_RESET_DELAY    10            /* seconds allowed for a reset */
multiline_comment|/* driver debugging - #undef all for normal operation */
DECL|macro|IM_DEBUG_TIMEOUT
macro_line|#undef  IM_DEBUG_TIMEOUT  50            /* if defined: count interrupts&n;&t;&t;&t;&t;&t;   and ignore this special one */
DECL|macro|IM_DEBUG_INT
macro_line|#undef  IM_DEBUG_INT                    /* verbose interrupt */
DECL|macro|IM_DEBUG_CMD
macro_line|#undef  IM_DEBUG_CMD                    /* verbose queuecommand */
multiline_comment|/* addresses of hardware registers on the subsystem */
DECL|macro|IM_CMD_REG
mdefine_line|#define IM_CMD_REG   (shpnt-&gt;io_port)&t;/*Command Interface, (4 bytes long) */
DECL|macro|IM_ATTN_REG
mdefine_line|#define IM_ATTN_REG  (shpnt-&gt;io_port+4)&t;/*Attention (1 byte) */
DECL|macro|IM_CTR_REG
mdefine_line|#define IM_CTR_REG   (shpnt-&gt;io_port+5)&t;/*Basic Control (1 byte) */
DECL|macro|IM_INTR_REG
mdefine_line|#define IM_INTR_REG  (shpnt-&gt;io_port+6)&t;/*Interrupt Status (1 byte, r/o) */
DECL|macro|IM_STAT_REG
mdefine_line|#define IM_STAT_REG  (shpnt-&gt;io_port+7)&t;/*Basic Status (1 byte, read only) */
DECL|macro|IM_IO_PORT
mdefine_line|#define IM_IO_PORT   0x3540
DECL|macro|IM_N_IO_PORT
mdefine_line|#define IM_N_IO_PORT 8
multiline_comment|/*requests going into the upper nibble of the Attention register */
multiline_comment|/*note: the lower nibble specifies the device(0-14), or subsystem(15) */
DECL|macro|IM_IMM_CMD
mdefine_line|#define IM_IMM_CMD   0x10&t;/*immediate command */
DECL|macro|IM_SCB
mdefine_line|#define IM_SCB       0x30&t;/*Subsystem Control Block command */
DECL|macro|IM_LONG_SCB
mdefine_line|#define IM_LONG_SCB  0x40&t;/*long Subsystem Control Block command */
DECL|macro|IM_EOI
mdefine_line|#define IM_EOI       0xe0&t;/*end-of-interrupt request */
multiline_comment|/*values for bits 7,1,0 of Basic Control reg. (bits 6-2 reserved) */
DECL|macro|IM_HW_RESET
mdefine_line|#define IM_HW_RESET     0x80&t;/*hardware reset */
DECL|macro|IM_ENABLE_DMA
mdefine_line|#define IM_ENABLE_DMA   0x02&t;/*enable subsystem&squot;s busmaster DMA */
DECL|macro|IM_ENABLE_INTR
mdefine_line|#define IM_ENABLE_INTR  0x01&t;/*enable interrupts to the system */
multiline_comment|/*to interpret the upper nibble of Interrupt Status register */
multiline_comment|/*note: the lower nibble specifies the device(0-14), or subsystem(15) */
DECL|macro|IM_SCB_CMD_COMPLETED
mdefine_line|#define IM_SCB_CMD_COMPLETED               0x10
DECL|macro|IM_SCB_CMD_COMPLETED_WITH_RETRIES
mdefine_line|#define IM_SCB_CMD_COMPLETED_WITH_RETRIES  0x50
DECL|macro|IM_ADAPTER_HW_FAILURE
mdefine_line|#define IM_ADAPTER_HW_FAILURE              0x70
DECL|macro|IM_IMMEDIATE_CMD_COMPLETED
mdefine_line|#define IM_IMMEDIATE_CMD_COMPLETED         0xa0
DECL|macro|IM_CMD_COMPLETED_WITH_FAILURE
mdefine_line|#define IM_CMD_COMPLETED_WITH_FAILURE      0xc0
DECL|macro|IM_CMD_ERROR
mdefine_line|#define IM_CMD_ERROR                       0xe0
DECL|macro|IM_SOFTWARE_SEQUENCING_ERROR
mdefine_line|#define IM_SOFTWARE_SEQUENCING_ERROR       0xf0
multiline_comment|/*to interpret bits 3-0 of Basic Status register (bits 7-4 reserved) */
DECL|macro|IM_CMD_REG_FULL
mdefine_line|#define IM_CMD_REG_FULL   0x08
DECL|macro|IM_CMD_REG_EMPTY
mdefine_line|#define IM_CMD_REG_EMPTY  0x04
DECL|macro|IM_INTR_REQUEST
mdefine_line|#define IM_INTR_REQUEST   0x02
DECL|macro|IM_BUSY
mdefine_line|#define IM_BUSY           0x01
multiline_comment|/*immediate commands (word written into low 2 bytes of command reg) */
DECL|macro|IM_RESET_IMM_CMD
mdefine_line|#define IM_RESET_IMM_CMD        0x0400
DECL|macro|IM_FORMAT_PREP_IMM_CMD
mdefine_line|#define IM_FORMAT_PREP_IMM_CMD  0x0417
DECL|macro|IM_FEATURE_CTR_IMM_CMD
mdefine_line|#define IM_FEATURE_CTR_IMM_CMD  0x040c
DECL|macro|IM_DMA_PACING_IMM_CMD
mdefine_line|#define IM_DMA_PACING_IMM_CMD   0x040d
DECL|macro|IM_ASSIGN_IMM_CMD
mdefine_line|#define IM_ASSIGN_IMM_CMD       0x040e
DECL|macro|IM_ABORT_IMM_CMD
mdefine_line|#define IM_ABORT_IMM_CMD        0x040f
multiline_comment|/*SCB (Subsystem Control Block) structure */
DECL|struct|im_scb
r_struct
id|im_scb
(brace
DECL|member|command
r_int
r_int
id|command
suffix:semicolon
multiline_comment|/*command word (read, etc.) */
DECL|member|enable
r_int
r_int
id|enable
suffix:semicolon
multiline_comment|/*enable word, modifies cmd */
r_union
(brace
DECL|member|log_blk_adr
r_int
r_int
id|log_blk_adr
suffix:semicolon
multiline_comment|/*block address on SCSI device */
DECL|member|scsi_cmd_length
r_int
r_char
id|scsi_cmd_length
suffix:semicolon
multiline_comment|/*6,10,12, for other scsi cmd */
)brace
DECL|member|u1
id|u1
suffix:semicolon
DECL|member|sys_buf_adr
r_int
r_int
id|sys_buf_adr
suffix:semicolon
multiline_comment|/*physical system memory adr */
DECL|member|sys_buf_length
r_int
r_int
id|sys_buf_length
suffix:semicolon
multiline_comment|/*size of sys mem buffer */
DECL|member|tsb_adr
r_int
r_int
id|tsb_adr
suffix:semicolon
multiline_comment|/*Termination Status Block adr */
DECL|member|scb_chain_adr
r_int
r_int
id|scb_chain_adr
suffix:semicolon
multiline_comment|/*optional SCB chain address */
r_union
(brace
r_struct
(brace
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/*block count, on SCSI device */
DECL|member|length
r_int
r_int
id|length
suffix:semicolon
multiline_comment|/*block length, on SCSI device */
)brace
DECL|member|blk
id|blk
suffix:semicolon
DECL|member|scsi_command
r_int
r_char
id|scsi_command
(braket
l_int|12
)braket
suffix:semicolon
multiline_comment|/*other scsi command */
)brace
DECL|member|u2
id|u2
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*structure scatter-gather element (for list of system memory areas) */
DECL|struct|im_sge
r_struct
id|im_sge
(brace
DECL|member|address
r_void
op_star
id|address
suffix:semicolon
DECL|member|byte_length
r_int
r_int
id|byte_length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*values for SCB command word */
DECL|macro|IM_NO_SYNCHRONOUS
mdefine_line|#define IM_NO_SYNCHRONOUS      0x0040&t;/*flag for any command */
DECL|macro|IM_NO_DISCONNECT
mdefine_line|#define IM_NO_DISCONNECT       0x0080&t;/*flag for any command */
DECL|macro|IM_READ_DATA_CMD
mdefine_line|#define IM_READ_DATA_CMD       0x1c01
DECL|macro|IM_WRITE_DATA_CMD
mdefine_line|#define IM_WRITE_DATA_CMD      0x1c02
DECL|macro|IM_READ_VERIFY_CMD
mdefine_line|#define IM_READ_VERIFY_CMD     0x1c03
DECL|macro|IM_WRITE_VERIFY_CMD
mdefine_line|#define IM_WRITE_VERIFY_CMD    0x1c04
DECL|macro|IM_REQUEST_SENSE_CMD
mdefine_line|#define IM_REQUEST_SENSE_CMD   0x1c08
DECL|macro|IM_READ_CAPACITY_CMD
mdefine_line|#define IM_READ_CAPACITY_CMD   0x1c09
DECL|macro|IM_DEVICE_INQUIRY_CMD
mdefine_line|#define IM_DEVICE_INQUIRY_CMD  0x1c0b
DECL|macro|IM_OTHER_SCSI_CMD_CMD
mdefine_line|#define IM_OTHER_SCSI_CMD_CMD  0x241f
multiline_comment|/*values to set bits in the enable word of SCB */
DECL|macro|IM_READ_CONTROL
mdefine_line|#define IM_READ_CONTROL              0x8000
DECL|macro|IM_REPORT_TSB_ONLY_ON_ERROR
mdefine_line|#define IM_REPORT_TSB_ONLY_ON_ERROR  0x4000
DECL|macro|IM_RETRY_ENABLE
mdefine_line|#define IM_RETRY_ENABLE              0x2000
DECL|macro|IM_POINTER_TO_LIST
mdefine_line|#define IM_POINTER_TO_LIST           0x1000
DECL|macro|IM_SUPRESS_EXCEPTION_SHORT
mdefine_line|#define IM_SUPRESS_EXCEPTION_SHORT   0x0400
DECL|macro|IM_CHAIN_ON_NO_ERROR
mdefine_line|#define IM_CHAIN_ON_NO_ERROR         0x0001
multiline_comment|/*TSB (Termination Status Block) structure */
DECL|struct|im_tsb
r_struct
id|im_tsb
(brace
DECL|member|end_status
r_int
r_int
id|end_status
suffix:semicolon
DECL|member|reserved1
r_int
r_int
id|reserved1
suffix:semicolon
DECL|member|residual_byte_count
r_int
r_int
id|residual_byte_count
suffix:semicolon
DECL|member|sg_list_element_adr
r_int
r_int
id|sg_list_element_adr
suffix:semicolon
DECL|member|status_length
r_int
r_int
id|status_length
suffix:semicolon
DECL|member|dev_status
r_int
r_char
id|dev_status
suffix:semicolon
DECL|member|cmd_status
r_int
r_char
id|cmd_status
suffix:semicolon
DECL|member|dev_error
r_int
r_char
id|dev_error
suffix:semicolon
DECL|member|cmd_error
r_int
r_char
id|cmd_error
suffix:semicolon
DECL|member|reserved2
r_int
r_int
id|reserved2
suffix:semicolon
DECL|member|reserved3
r_int
r_int
id|reserved3
suffix:semicolon
DECL|member|low_of_last_scb_adr
r_int
r_int
id|low_of_last_scb_adr
suffix:semicolon
DECL|member|high_of_last_scb_adr
r_int
r_int
id|high_of_last_scb_adr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*subsystem uses interrupt request level 14 */
DECL|macro|IM_IRQ
mdefine_line|#define IM_IRQ  14
multiline_comment|/*PS2 disk led is turned on/off by bits 6,7 of system control port */
DECL|macro|PS2_SYS_CTR
mdefine_line|#define PS2_SYS_CTR  0x92
DECL|macro|PS2_DISK_LED_ON
mdefine_line|#define PS2_DISK_LED_ON()   outb(inb(PS2_SYS_CTR) | 0xc0, PS2_SYS_CTR)
DECL|macro|PS2_DISK_LED_OFF
mdefine_line|#define PS2_DISK_LED_OFF()  outb(inb(PS2_SYS_CTR) &amp; 0x3f, PS2_SYS_CTR)
multiline_comment|/*--------------------------------------------------------------------*/
multiline_comment|/*list of supported subsystems */
DECL|struct|subsys_list_struct
r_struct
id|subsys_list_struct
(brace
DECL|member|mca_id
r_int
r_int
id|mca_id
suffix:semicolon
DECL|member|description
r_char
op_star
id|description
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|subsys_list
r_struct
id|subsys_list_struct
id|subsys_list
(braket
)braket
op_assign
(brace
(brace
l_int|0x8efc
comma
l_string|&quot;IBM Fast SCSI-2 Adapter&quot;
)brace
comma
(brace
l_int|0x8efd
comma
l_string|&quot;IBM 7568 Industrial Computer SCSI Adapter w/cache&quot;
)brace
comma
(brace
l_int|0x8ef8
comma
l_string|&quot;IBM Expansion Unit SCSI Controller&quot;
)brace
comma
(brace
l_int|0x8eff
comma
l_string|&quot;IBM SCSI Adapter w/Cache&quot;
)brace
comma
(brace
l_int|0x8efe
comma
l_string|&quot;IBM SCSI Adapter&quot;
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*for /proc filesystem */
DECL|variable|proc_scsi_ibmmca
r_struct
id|proc_dir_entry
id|proc_scsi_ibmmca
op_assign
(brace
id|PROC_SCSI_IBMMCA
comma
l_int|6
comma
l_string|&quot;ibmmca&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
multiline_comment|/*max number of logical devices (can be up to 15) */
DECL|macro|MAX_LOG_DEV
mdefine_line|#define MAX_LOG_DEV  15
multiline_comment|/*local data for a logical device */
DECL|struct|logical_device
r_struct
id|logical_device
(brace
DECL|member|scb
r_struct
id|im_scb
id|scb
suffix:semicolon
DECL|member|tsb
r_struct
id|im_tsb
id|tsb
suffix:semicolon
DECL|member|sge
r_struct
id|im_sge
id|sge
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|cmd
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
DECL|member|is_disk
r_int
id|is_disk
suffix:semicolon
DECL|member|block_length
r_int
id|block_length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* data structure for each host adapter */
DECL|struct|ibmmca_hostdata
r_struct
id|ibmmca_hostdata
(brace
multiline_comment|/* array of logical devices */
DECL|member|_ld
r_struct
id|logical_device
id|_ld
(braket
id|MAX_LOG_DEV
)braket
suffix:semicolon
multiline_comment|/* array to convert (pun, lun) into logical device number */
DECL|member|_get_ldn
r_int
r_char
id|_get_ldn
(braket
l_int|8
)braket
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* used only when checking logical devices */
DECL|member|_local_checking_phase_flag
r_int
id|_local_checking_phase_flag
suffix:semicolon
DECL|member|_got_interrupt
r_int
id|_got_interrupt
suffix:semicolon
DECL|member|_stat_result
r_int
id|_stat_result
suffix:semicolon
multiline_comment|/* reset status (used only when doing reset) */
DECL|member|_reset_status
r_int
id|_reset_status
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* reset status values */
DECL|macro|IM_RESET_NOT_IN_PROGRESS
mdefine_line|#define IM_RESET_NOT_IN_PROGRESS   0
DECL|macro|IM_RESET_IN_PROGRESS
mdefine_line|#define IM_RESET_IN_PROGRESS       1
DECL|macro|IM_RESET_FINISHED_OK
mdefine_line|#define IM_RESET_FINISHED_OK       2
DECL|macro|IM_RESET_FINISHED_FAIL
mdefine_line|#define IM_RESET_FINISHED_FAIL     3
multiline_comment|/* macros to access host data structure */
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(shpnt) ((struct ibmmca_hostdata *) shpnt-&gt;hostdata)
DECL|macro|subsystem_pun
mdefine_line|#define subsystem_pun (shpnt-&gt;this_id)
DECL|macro|ld
mdefine_line|#define ld (HOSTDATA(shpnt)-&gt;_ld)
DECL|macro|get_ldn
mdefine_line|#define get_ldn (HOSTDATA(shpnt)-&gt;_get_ldn)
DECL|macro|local_checking_phase_flag
mdefine_line|#define local_checking_phase_flag (HOSTDATA(shpnt)-&gt;_local_checking_phase_flag)
DECL|macro|got_interrupt
mdefine_line|#define got_interrupt (HOSTDATA(shpnt)-&gt;_got_interrupt)
DECL|macro|stat_result
mdefine_line|#define stat_result (HOSTDATA(shpnt)-&gt;_stat_result)
DECL|macro|reset_status
mdefine_line|#define reset_status (HOSTDATA(shpnt)-&gt;_reset_status)
multiline_comment|/*--------------------------------------------------------------------*/
multiline_comment|/* if this is nonzero, ibmmcascsi option has been passed to the kernel */
DECL|variable|io_port
r_static
r_int
id|io_port
(braket
id|IM_MAX_HOSTS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|scsi_id
r_static
r_int
id|scsi_id
(braket
id|IM_MAX_HOSTS
)braket
op_assign
(brace
l_int|7
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io_port
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IM_MAX_HOSTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scsi_id
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IM_MAX_HOSTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*counter of concurrent disk read/writes, to turn on/off disk led */
DECL|variable|disk_rw_in_progress
r_static
r_int
id|disk_rw_in_progress
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* host information */
DECL|variable|found
r_static
r_int
id|found
op_assign
l_int|0
suffix:semicolon
DECL|variable|hosts
r_static
r_struct
id|Scsi_Host
op_star
id|hosts
(braket
id|IM_MAX_HOSTS
op_plus
l_int|1
)braket
op_assign
(brace
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*--------------------------------------------------------------------*/
multiline_comment|/*local functions */
r_static
r_void
id|interrupt_handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|issue_cmd
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
r_int
id|cmd_reg
comma
r_int
r_char
id|attn_reg
)paren
suffix:semicolon
r_static
r_void
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|check_devices
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_int
id|device_exists
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
id|ldn
comma
r_int
op_star
id|is_disk
comma
r_int
op_star
id|block_length
)paren
suffix:semicolon
r_static
r_struct
id|Scsi_Host
op_star
id|ibmmca_register
c_func
(paren
id|Scsi_Host_Template
op_star
r_template
comma
r_int
id|port
comma
r_int
id|id
)paren
suffix:semicolon
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|interrupt_handler
id|interrupt_handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
r_int
id|intr_reg
suffix:semicolon
r_int
r_int
id|cmd_result
suffix:semicolon
r_int
r_int
id|ldn
suffix:semicolon
r_do
id|shpnt
op_assign
id|hosts
(braket
id|i
op_increment
)braket
suffix:semicolon
r_while
c_loop
(paren
id|shpnt
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|IM_STAT_REG
)paren
op_amp
id|IM_INTR_REQUEST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
r_return
suffix:semicolon
multiline_comment|/*get command result and logical device */
id|intr_reg
op_assign
id|inb
c_func
(paren
id|IM_INTR_REG
)paren
suffix:semicolon
id|cmd_result
op_assign
id|intr_reg
op_amp
l_int|0xf0
suffix:semicolon
id|ldn
op_assign
id|intr_reg
op_amp
l_int|0x0f
suffix:semicolon
multiline_comment|/*must wait for attention reg not busy, then send EOI to subsystem */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
(paren
id|IM_STAT_REG
)paren
op_amp
id|IM_BUSY
)paren
)paren
r_break
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
)brace
id|outb
(paren
id|IM_EOI
op_or
id|ldn
comma
id|IM_ATTN_REG
)paren
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
multiline_comment|/*these should never happen (hw fails, or a local programming bug) */
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_ADAPTER_HW_FAILURE
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: subsystem hardware failure.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_CMD_ERROR
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: command error.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_SOFTWARE_SEQUENCING_ERROR
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: software sequencing error.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*only for local checking phase */
r_if
c_cond
(paren
id|local_checking_phase_flag
)paren
(brace
id|stat_result
op_assign
id|cmd_result
suffix:semicolon
id|got_interrupt
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*handling of commands coming from upper level of scsi driver */
r_else
(brace
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
multiline_comment|/*verify ldn, and may handle rare reset immediate command */
r_if
c_cond
(paren
id|ldn
op_ge
id|MAX_LOG_DEV
)paren
(brace
r_if
c_cond
(paren
id|ldn
op_eq
l_int|0xf
op_logical_and
id|reset_status
op_eq
id|IM_RESET_IN_PROGRESS
)paren
(brace
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_CMD_COMPLETED_WITH_FAILURE
)paren
(brace
id|reset_status
op_assign
id|IM_RESET_FINISHED_FAIL
suffix:semicolon
)brace
r_else
(brace
id|reset_status
op_assign
id|IM_RESET_FINISHED_OK
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
id|panic
(paren
l_string|&quot;IBM MCA SCSI: invalid logical device number.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef IM_DEBUG_TIMEOUT
(brace
r_static
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|count
op_eq
id|IM_DEBUG_TIMEOUT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Ignoring interrupt.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*if no command structure, just return, else clear cmd */
id|cmd
op_assign
id|ld
(braket
id|ldn
)braket
dot
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
r_return
suffix:semicolon
id|ld
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef IM_DEBUG_INT
id|printk
c_func
(paren
l_string|&quot;cmd=%02x ireg=%02x ds=%02x cs=%02x de=%02x ce=%02x&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|intr_reg
comma
id|ld
(braket
id|ldn
)braket
dot
id|tsb.dev_status
comma
id|ld
(braket
id|ldn
)braket
dot
id|tsb.cmd_status
comma
id|ld
(braket
id|ldn
)braket
dot
id|tsb.dev_error
comma
id|ld
(braket
id|ldn
)braket
dot
id|tsb.cmd_error
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*if this is end of disk read/write, may turn off PS/2 disk led */
r_if
c_cond
(paren
id|ld
(braket
id|ldn
)braket
dot
id|is_disk
)paren
(brace
r_switch
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_if
c_cond
(paren
op_decrement
id|disk_rw_in_progress
op_eq
l_int|0
)paren
id|PS2_DISK_LED_OFF
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*write device status into cmd-&gt;result, and call done function */
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_CMD_COMPLETED_WITH_FAILURE
)paren
id|cmd-&gt;result
op_assign
id|ld
(braket
id|ldn
)braket
dot
id|tsb.dev_status
op_amp
l_int|0x1e
suffix:semicolon
r_else
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|issue_cmd
id|issue_cmd
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
r_int
id|cmd_reg
comma
r_int
r_char
id|attn_reg
)paren
(brace
multiline_comment|/*must wait for attention reg not busy */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
(paren
id|IM_STAT_REG
)paren
op_amp
id|IM_BUSY
)paren
)paren
r_break
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*write registers and enable system interrupts */
id|outl
(paren
id|cmd_reg
comma
id|IM_CMD_REG
)paren
suffix:semicolon
id|outb
(paren
id|attn_reg
comma
id|IM_ATTN_REG
)paren
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|internal_done
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|cmd-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|ibmmca_getinfo
id|ibmmca_getinfo
(paren
r_char
op_star
id|buf
comma
r_int
id|slot
comma
r_void
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|dev
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Subsystem PUN: %d&bslash;n&quot;
comma
id|subsystem_pun
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;I/O base address: 0x%x&bslash;n&quot;
comma
id|shpnt-&gt;io_port
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|check_devices
id|check_devices
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|is_disk
comma
id|block_length
suffix:semicolon
r_int
id|ldn
suffix:semicolon
r_int
id|num_ldn
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check ldn&squot;s from 0 to MAX_LOG_DEV to find which devices exist */
r_for
c_loop
(paren
id|ldn
op_assign
l_int|0
suffix:semicolon
id|ldn
OL
id|MAX_LOG_DEV
suffix:semicolon
id|ldn
op_increment
)paren
(brace
r_if
c_cond
(paren
id|device_exists
c_func
(paren
id|shpnt
comma
id|ldn
comma
op_amp
id|is_disk
comma
op_amp
id|block_length
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: logical device found at ldn=%d.&bslash;n&quot;
comma
id|ldn
)paren
suffix:semicolon
id|ld
(braket
id|ldn
)braket
dot
id|is_disk
op_assign
id|is_disk
suffix:semicolon
id|ld
(braket
id|ldn
)braket
dot
id|block_length
op_assign
id|block_length
suffix:semicolon
id|get_ldn
(braket
id|num_ldn
op_div
l_int|8
)braket
(braket
id|num_ldn
op_mod
l_int|8
)braket
op_assign
id|ldn
suffix:semicolon
id|num_ldn
op_increment
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|device_exists
id|device_exists
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
comma
r_int
id|ldn
comma
r_int
op_star
id|is_disk
comma
r_int
op_star
id|block_length
)paren
(brace
r_struct
id|im_scb
id|scb
suffix:semicolon
r_struct
id|im_tsb
id|tsb
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|retries
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|0
suffix:semicolon
id|retries
OL
l_int|3
suffix:semicolon
id|retries
op_increment
)paren
(brace
multiline_comment|/*fill scb with inquiry command */
id|scb.command
op_assign
id|IM_DEVICE_INQUIRY_CMD
suffix:semicolon
id|scb.enable
op_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
suffix:semicolon
multiline_comment|/* I think this virt_to_bus is needed.. ??? AC */
id|scb.sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
id|scb.sys_buf_length
op_assign
l_int|255
suffix:semicolon
id|scb.tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|tsb
)paren
suffix:semicolon
multiline_comment|/*issue scb to passed ldn, and busy wait for interrupt */
id|got_interrupt
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|shpnt
comma
id|virt_to_bus
c_func
(paren
op_amp
id|scb
)paren
comma
id|IM_SCB
op_or
id|ldn
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if command succesful, break */
r_if
c_cond
(paren
id|stat_result
op_eq
id|IM_SCB_CMD_COMPLETED
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*if all three retries failed, return &quot;no device at this ldn&quot; */
r_if
c_cond
(paren
id|retries
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*if device is CD_ROM, assume block size 2048 and return */
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_eq
id|TYPE_ROM
)paren
(brace
op_star
id|is_disk
op_assign
l_int|0
suffix:semicolon
op_star
id|block_length
op_assign
l_int|2048
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*if device is disk, use &quot;read capacity&quot; to find its block size */
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_eq
id|TYPE_DISK
)paren
(brace
op_star
id|is_disk
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|0
suffix:semicolon
id|retries
OL
l_int|3
suffix:semicolon
id|retries
op_increment
)paren
(brace
multiline_comment|/*fill scb with read capacity command */
id|scb.command
op_assign
id|IM_READ_CAPACITY_CMD
suffix:semicolon
id|scb.enable
op_assign
id|IM_READ_CONTROL
suffix:semicolon
id|scb.sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
id|scb.sys_buf_length
op_assign
l_int|8
suffix:semicolon
id|scb.tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|tsb
)paren
suffix:semicolon
multiline_comment|/*issue scb to passed ldn, and busy wait for interrupt */
id|got_interrupt
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|shpnt
comma
id|virt_to_bus
c_func
(paren
op_amp
id|scb
)paren
comma
id|IM_SCB
op_or
id|ldn
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if got capacity, get block length and return one device found */
r_if
c_cond
(paren
id|stat_result
op_eq
id|IM_SCB_CMD_COMPLETED
)paren
(brace
op_star
id|block_length
op_assign
id|buf
(braket
l_int|7
)braket
op_plus
(paren
id|buf
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|buf
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|buf
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*if all three retries failed, return &quot;no device at this ldn&quot; */
r_if
c_cond
(paren
id|retries
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*for now, ignore tape and other devices - return 0 */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_SCSI_IBMMCA
r_void
DECL|function|ibmmca_scsi_setup
id|ibmmca_scsi_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IM_MAX_HOSTS
op_logical_and
id|i
OL
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_port
(braket
id|i
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_detect
id|ibmmca_detect
(paren
id|Scsi_Host_Template
op_star
r_template
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
id|port
comma
id|id
comma
id|i
comma
id|list_size
comma
id|slot
suffix:semicolon
r_int
id|pos2
comma
id|pos3
suffix:semicolon
multiline_comment|/* if this is not MCA machine, return &quot;nothing found&quot; */
r_if
c_cond
(paren
op_logical_neg
id|MCA_bus
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* get interrupt request level */
r_if
c_cond
(paren
id|request_irq
(paren
id|IM_IRQ
comma
id|interrupt_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;ibmmca&quot;
comma
id|hosts
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to get IRQ %d.&bslash;n&quot;
comma
id|IM_IRQ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if ibmmcascsi setup option was passed to kernel, return &quot;found&quot; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IM_MAX_HOSTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|io_port
(braket
id|i
)braket
OG
l_int|0
op_logical_and
id|scsi_id
(braket
id|i
)braket
op_ge
l_int|0
op_logical_and
id|scsi_id
(braket
id|i
)braket
OL
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: forced detection, io=0x%x, scsi id=%d.&bslash;n&quot;
comma
id|io_port
(braket
id|i
)braket
comma
id|scsi_id
(braket
id|i
)braket
)paren
suffix:semicolon
id|ibmmca_register
c_func
(paren
r_template
comma
id|io_port
(braket
id|i
)braket
comma
id|scsi_id
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
r_return
id|found
suffix:semicolon
multiline_comment|/* first look for the SCSI integrated on the motherboard */
id|pos2
op_assign
id|mca_read_stored_pos
c_func
(paren
id|MCA_INTEGSCSI
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos2
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|pos3
op_assign
id|mca_read_stored_pos
c_func
(paren
id|MCA_INTEGSCSI
comma
l_int|3
)paren
suffix:semicolon
id|port
op_assign
id|IM_IO_PORT
op_plus
(paren
(paren
id|pos2
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|id
op_assign
(paren
id|pos3
op_amp
l_int|0xe0
)paren
op_rshift
l_int|5
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: integrated SCSI found, io=0x%x, scsi id=%d.&bslash;n&quot;
comma
id|port
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shpnt
op_assign
id|ibmmca_register
c_func
(paren
r_template
comma
id|port
comma
id|id
)paren
)paren
)paren
(brace
id|mca_set_adapter_name
c_func
(paren
id|MCA_INTEGSCSI
comma
l_string|&quot;PS/2 Integrated SCSI&quot;
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|MCA_INTEGSCSI
comma
(paren
id|MCA_ProcFn
)paren
id|ibmmca_getinfo
comma
id|shpnt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* now look for other adapters */
id|list_size
op_assign
r_sizeof
(paren
id|subsys_list
)paren
op_div
r_sizeof
(paren
r_struct
id|subsys_list_struct
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|list_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|slot
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|subsys_list
(braket
id|i
)braket
dot
id|mca_id
comma
id|slot
)paren
)paren
op_ne
id|MCA_NOTFOUND
)paren
(brace
id|pos2
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|2
)paren
suffix:semicolon
id|pos3
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|3
)paren
suffix:semicolon
id|port
op_assign
id|IM_IO_PORT
op_plus
(paren
(paren
id|pos2
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|id
op_assign
(paren
id|pos3
op_amp
l_int|0xe0
)paren
op_rshift
l_int|5
suffix:semicolon
id|printk
(paren
l_string|&quot;IBM MCA SCSI: %s found in slot %d, io=0x%x, scsi id=%d.&bslash;n&quot;
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
comma
id|slot
op_plus
l_int|1
comma
id|port
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shpnt
op_assign
id|ibmmca_register
c_func
(paren
r_template
comma
id|port
comma
id|id
)paren
)paren
)paren
(brace
id|mca_set_adapter_name
(paren
id|slot
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
)paren
suffix:semicolon
id|mca_set_adapter_procfn
(paren
id|slot
comma
(paren
id|MCA_ProcFn
)paren
id|ibmmca_getinfo
comma
id|shpnt
)paren
suffix:semicolon
)brace
id|slot
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
id|free_irq
(paren
id|IM_IRQ
comma
id|hosts
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: No adapter attached.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|found
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_static
r_struct
id|Scsi_Host
op_star
DECL|function|ibmmca_register
id|ibmmca_register
c_func
(paren
id|Scsi_Host_Template
op_star
r_template
comma
r_int
id|port
comma
r_int
id|id
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* check I/O region */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|port
comma
id|IM_N_IO_PORT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to get I/O region 0x%x-0x%x.&bslash;n&quot;
comma
id|port
comma
id|port
op_plus
id|IM_N_IO_PORT
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* register host */
id|shpnt
op_assign
id|scsi_register
c_func
(paren
r_template
comma
r_sizeof
(paren
r_struct
id|ibmmca_hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to register host.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* request I/O region */
id|request_region
c_func
(paren
id|port
comma
id|IM_N_IO_PORT
comma
l_string|&quot;ibmmca&quot;
)paren
suffix:semicolon
id|hosts
(braket
id|found
op_increment
)braket
op_assign
id|shpnt
suffix:semicolon
id|shpnt-&gt;irq
op_assign
id|IM_IRQ
suffix:semicolon
id|shpnt-&gt;io_port
op_assign
id|port
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
id|IM_N_IO_PORT
suffix:semicolon
id|shpnt-&gt;this_id
op_assign
id|id
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
id|get_ldn
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|MAX_LOG_DEV
suffix:semicolon
multiline_comment|/* check which logical devices exist */
id|local_checking_phase_flag
op_assign
l_int|1
suffix:semicolon
id|check_devices
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|local_checking_phase_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* an ibm mca subsystem has been detected */
r_return
id|shpnt
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_release
id|ibmmca_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|release_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|shpnt-&gt;n_io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|found
)paren
)paren
id|free_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|hosts
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_command
id|ibmmca_command
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|ibmmca_queuecommand
(paren
id|cmd
comma
id|internal_done
)paren
suffix:semicolon
id|cmd-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cmd-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_return
id|cmd-&gt;result
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_queuecommand
id|ibmmca_queuecommand
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|ldn
suffix:semicolon
r_int
r_int
id|scsi_cmd
suffix:semicolon
r_struct
id|im_scb
op_star
id|scb
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
multiline_comment|/*if (target,lun) unassigned, return error */
id|ldn
op_assign
id|get_ldn
(braket
id|cmd-&gt;target
)braket
(braket
id|cmd-&gt;lun
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ldn
op_ge
id|MAX_LOG_DEV
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*verify there is no command already in progress for this log dev */
r_if
c_cond
(paren
id|ld
(braket
id|ldn
)braket
dot
id|cmd
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: cmd already in progress for this ldn.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*save done in cmd, and save cmd for the interrupt handler */
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|ld
(braket
id|ldn
)braket
dot
id|cmd
op_assign
id|cmd
suffix:semicolon
multiline_comment|/*fill scb information independent of the scsi command */
id|scb
op_assign
op_amp
(paren
id|ld
(braket
id|ldn
)braket
dot
id|scb
)paren
suffix:semicolon
id|scb-&gt;enable
op_assign
id|IM_REPORT_TSB_ONLY_ON_ERROR
suffix:semicolon
id|scb-&gt;tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ld
(braket
id|ldn
)braket
dot
id|tsb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_int
id|i
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|16
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: scatter-gather list too long.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|ld
(braket
id|ldn
)braket
dot
id|sge
(braket
id|i
)braket
dot
id|address
op_assign
(paren
r_void
op_star
)paren
id|virt_to_bus
c_func
(paren
id|sl
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
id|ld
(braket
id|ldn
)braket
dot
id|sge
(braket
id|i
)braket
dot
id|byte_length
op_assign
id|sl
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
id|scb-&gt;enable
op_or_assign
id|IM_POINTER_TO_LIST
suffix:semicolon
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ld
(braket
id|ldn
)braket
dot
id|sge
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|scb-&gt;sys_buf_length
op_assign
id|cmd-&gt;use_sg
op_star
r_sizeof
(paren
r_struct
id|im_sge
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
id|scb-&gt;sys_buf_length
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
)brace
multiline_comment|/*fill scb information dependent on scsi command */
id|scsi_cmd
op_assign
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef IM_DEBUG_CMD
id|printk
c_func
(paren
l_string|&quot;issue scsi cmd=%02x to ldn=%d&bslash;n&quot;
comma
id|scsi_cmd
comma
id|ldn
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|scsi_cmd
)paren
(brace
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_if
c_cond
(paren
id|scsi_cmd
op_eq
id|READ_6
op_logical_or
id|scsi_cmd
op_eq
id|READ_10
)paren
(brace
id|scb-&gt;command
op_assign
id|IM_READ_DATA_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;command
op_assign
id|IM_WRITE_DATA_CMD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_cmd
op_eq
id|READ_6
op_logical_or
id|scsi_cmd
op_eq
id|WRITE_6
)paren
(brace
id|scb-&gt;u1.log_blk_adr
op_assign
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|3
)braket
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
)paren
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|scb-&gt;u2.blk.count
op_assign
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;u1.log_blk_adr
op_assign
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|5
)braket
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|3
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|2
)braket
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|scb-&gt;u2.blk.count
op_assign
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|8
)braket
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|7
)braket
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|scb-&gt;u2.blk.length
op_assign
id|ld
(braket
id|ldn
)braket
dot
id|block_length
suffix:semicolon
r_if
c_cond
(paren
id|ld
(braket
id|ldn
)braket
dot
id|is_disk
)paren
(brace
r_if
c_cond
(paren
op_increment
id|disk_rw_in_progress
op_eq
l_int|1
)paren
id|PS2_DISK_LED_ON
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|scb-&gt;command
op_assign
id|IM_DEVICE_INQUIRY_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|scb-&gt;command
op_assign
id|IM_READ_CAPACITY_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
suffix:semicolon
multiline_comment|/*the length of system memory buffer must be exactly 8 bytes */
r_if
c_cond
(paren
id|scb-&gt;sys_buf_length
op_ge
l_int|8
)paren
id|scb-&gt;sys_buf_length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|scb-&gt;command
op_assign
id|IM_REQUEST_SENSE_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|scb-&gt;command
op_assign
id|IM_OTHER_SCSI_CMD_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
suffix:semicolon
id|scb-&gt;u1.scsi_cmd_length
op_assign
id|cmd-&gt;cmd_len
suffix:semicolon
id|memcpy
(paren
id|scb-&gt;u2.scsi_command
comma
id|cmd-&gt;cmnd
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*issue scb command, and return */
id|issue_cmd
(paren
id|shpnt
comma
id|virt_to_bus
c_func
(paren
id|scb
)paren
comma
id|IM_SCB
op_or
id|ldn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_abort
id|ibmmca_abort
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
multiline_comment|/* The code below doesn&squot;t work right now, so we tell the upper layer&n;     that we can&squot;t abort. This eventually causes a reset.&n;     */
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
macro_line|#if 0
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
r_int
r_int
id|ldn
suffix:semicolon
r_void
(paren
op_star
id|saved_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
multiline_comment|/*get logical device number, and disable system interrupts */
id|printk
(paren
l_string|&quot;IBM MCA SCSI: sending abort to device id=%d lun=%d.&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|ldn
op_assign
id|get_ldn
(braket
id|cmd-&gt;target
)braket
(braket
id|cmd-&gt;lun
)braket
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/*if cmd for this ldn has already finished, no need to abort */
r_if
c_cond
(paren
op_logical_neg
id|ld
(braket
id|ldn
)braket
dot
id|cmd
)paren
(brace
id|sti
(paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
multiline_comment|/* Clear ld.cmd, save done function, install internal done, &n;   * send abort immediate command (this enables sys. interrupts), &n;   * and wait until the interrupt arrives. &n;   */
id|ld
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|0
suffix:semicolon
id|saved_done
op_assign
id|cmd-&gt;scsi_done
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|internal_done
suffix:semicolon
id|cmd-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|shpnt
comma
id|IM_ABORT_IMM_CMD
comma
id|IM_IMM_CMD
op_or
id|ldn
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cmd-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if abort went well, call saved done, then return success or error */
r_if
c_cond
(paren
id|cmd-&gt;result
op_eq
l_int|0
)paren
(brace
id|cmd-&gt;result
op_or_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|saved_done
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
r_else
r_return
id|SCSI_ABORT_ERROR
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_reset
id|ibmmca_reset
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|reset_flags
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
r_int
id|ticks
op_assign
id|IM_RESET_DELAY
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|local_checking_phase_flag
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: unable to reset while checking devices.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SNOOZE
suffix:semicolon
)brace
multiline_comment|/* issue reset immediate command to subsystem, and wait for interrupt */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: resetting all devices.&bslash;n&quot;
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|reset_status
op_assign
id|IM_RESET_IN_PROGRESS
suffix:semicolon
id|issue_cmd
(paren
id|shpnt
comma
id|IM_RESET_IMM_CMD
comma
id|IM_IMM_CMD
op_or
l_int|0xf
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reset_status
op_eq
id|IM_RESET_IN_PROGRESS
op_logical_and
op_decrement
id|ticks
)paren
(brace
id|udelay
c_func
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* if reset did not complete, just return an error*/
r_if
c_cond
(paren
op_logical_neg
id|ticks
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: reset did not complete within %d seconds.&bslash;n&quot;
comma
id|IM_RESET_DELAY
)paren
suffix:semicolon
id|reset_status
op_assign
id|IM_RESET_FINISHED_FAIL
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
multiline_comment|/* if reset failed, just return an error */
r_if
c_cond
(paren
id|reset_status
op_eq
id|IM_RESET_FINISHED_FAIL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: reset failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
multiline_comment|/* so reset finished ok - call outstanding done&squot;s, and return success */
id|printk
(paren
l_string|&quot;IBM MCA SCSI: reset completed without error.&bslash;n&quot;
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_LOG_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|ld
(braket
id|i
)braket
dot
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_logical_and
id|cmd-&gt;scsi_done
)paren
(brace
id|ld
(braket
id|i
)braket
dot
id|cmd
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_RESET
suffix:semicolon
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
r_int
DECL|function|ibmmca_biosparam
id|ibmmca_biosparam
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|info
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
id|info
(braket
l_int|0
)braket
op_star
id|info
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|128
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
id|info
(braket
l_int|0
)braket
op_star
id|info
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
id|info
(braket
l_int|0
)braket
op_star
id|info
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
id|info
(braket
l_int|2
)braket
op_assign
l_int|1023
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*/
macro_line|#ifdef MODULE
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|IBMMCA
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
