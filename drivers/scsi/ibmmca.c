multiline_comment|/*&n; Low Level Linux Driver for the IBM Microchannel SCSI Subsystem for&n; Linux Kernel &gt;= 2.4.0.&n; Copyright (c) 1995 Strom Systems, Inc. under the terms of the GNU&n; General Public License. Written by Martin Kolinek, December 1995.&n; Further development by: Chris Beauregard, Klaus Kudielka, Michael Lang&n; See the file README.ibmmca for a detailed description of this driver,&n; the commandline arguments and the history of its development.&n; See the WWW-page: http://www.uni-mainz.de/~langm000/linux.html for latest&n; updates, info and ADF-files for adapters supported by this driver.&n;*/
macro_line|#ifndef LINUX_VERSION_CODE
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,0)
macro_line|#error &quot;This driver works only with kernel 2.4.0 or higher!&quot;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ibmmca.h&quot;
macro_line|#include &lt;linux/config.h&gt;
multiline_comment|/* current version of this driver-source: */
DECL|macro|IBMMCA_SCSI_DRIVER_VERSION
mdefine_line|#define IBMMCA_SCSI_DRIVER_VERSION &quot;4.0a&quot;
DECL|macro|IBMLOCK
mdefine_line|#define IBMLOCK spin_lock_irqsave(&amp;io_request_lock, flags);
DECL|macro|IBMUNLOCK
mdefine_line|#define IBMUNLOCK spin_unlock_irqrestore(&amp;io_request_lock, flags);
multiline_comment|/* driver configuration */
DECL|macro|IM_MAX_HOSTS
mdefine_line|#define IM_MAX_HOSTS     8 /* maximum number of host adapters */
DECL|macro|IM_RESET_DELAY
mdefine_line|#define IM_RESET_DELAY&t;60 /* seconds allowed for a reset */
multiline_comment|/* driver debugging - #undef all for normal operation */
multiline_comment|/* if defined: count interrupts and ignore this special one: */
DECL|macro|IM_DEBUG_TIMEOUT
macro_line|#undef&t;IM_DEBUG_TIMEOUT&t;50            
DECL|macro|TIMEOUT_PUN
mdefine_line|#define TIMEOUT_PUN&t;0
DECL|macro|TIMEOUT_LUN
mdefine_line|#define TIMEOUT_LUN&t;0
multiline_comment|/* verbose interrupt: */
DECL|macro|IM_DEBUG_INT
macro_line|#undef IM_DEBUG_INT                   
multiline_comment|/* verbose queuecommand: */
DECL|macro|IM_DEBUG_CMD
macro_line|#undef IM_DEBUG_CMD    
multiline_comment|/* verbose queucommand for specific SCSI-device type: */
DECL|macro|IM_DEBUG_CMD_SPEC_DEV
macro_line|#undef IM_DEBUG_CMD_SPEC_DEV
multiline_comment|/* verbose device probing */
DECL|macro|IM_DEBUG_PROBE
macro_line|#undef IM_DEBUG_PROBE
multiline_comment|/* device type that shall be displayed on syslog (only during debugging): */
DECL|macro|IM_DEBUG_CMD_DEVICE
mdefine_line|#define IM_DEBUG_CMD_DEVICE&t;TYPE_TAPE
multiline_comment|/* relative addresses of hardware registers on a subsystem */
DECL|macro|IM_CMD_REG
mdefine_line|#define IM_CMD_REG(hi)&t;(hosts[(hi)]-&gt;io_port)   /*Command Interface, (4 bytes long) */
DECL|macro|IM_ATTN_REG
mdefine_line|#define IM_ATTN_REG(hi)&t;(hosts[(hi)]-&gt;io_port+4) /*Attention (1 byte) */
DECL|macro|IM_CTR_REG
mdefine_line|#define IM_CTR_REG(hi)&t;(hosts[(hi)]-&gt;io_port+5) /*Basic Control (1 byte) */
DECL|macro|IM_INTR_REG
mdefine_line|#define IM_INTR_REG(hi)&t;(hosts[(hi)]-&gt;io_port+6) /*Interrupt Status (1 byte, r/o) */
DECL|macro|IM_STAT_REG
mdefine_line|#define IM_STAT_REG(hi)&t;(hosts[(hi)]-&gt;io_port+7) /*Basic Status (1 byte, read only) */
multiline_comment|/* basic I/O-port of first adapter */
DECL|macro|IM_IO_PORT
mdefine_line|#define IM_IO_PORT&t;0x3540
multiline_comment|/* maximum number of hosts that can be found */
DECL|macro|IM_N_IO_PORT
mdefine_line|#define IM_N_IO_PORT&t;8
multiline_comment|/*requests going into the upper nibble of the Attention register */
multiline_comment|/*note: the lower nibble specifies the device(0-14), or subsystem(15) */
DECL|macro|IM_IMM_CMD
mdefine_line|#define IM_IMM_CMD&t;0x10&t;/*immediate command */
DECL|macro|IM_SCB
mdefine_line|#define IM_SCB&t;&t;0x30&t;/*Subsystem Control Block command */
DECL|macro|IM_LONG_SCB
mdefine_line|#define IM_LONG_SCB&t;0x40&t;/*long Subsystem Control Block command */
DECL|macro|IM_EOI
mdefine_line|#define IM_EOI&t;&t;0xe0&t;/*end-of-interrupt request */
multiline_comment|/*values for bits 7,1,0 of Basic Control reg. (bits 6-2 reserved) */
DECL|macro|IM_HW_RESET
mdefine_line|#define IM_HW_RESET&t;0x80&t;/*hardware reset */
DECL|macro|IM_ENABLE_DMA
mdefine_line|#define IM_ENABLE_DMA&t;0x02&t;/*enable subsystem&squot;s busmaster DMA */
DECL|macro|IM_ENABLE_INTR
mdefine_line|#define IM_ENABLE_INTR&t;0x01&t;/*enable interrupts to the system */
multiline_comment|/*to interpret the upper nibble of Interrupt Status register */
multiline_comment|/*note: the lower nibble specifies the device(0-14), or subsystem(15) */
DECL|macro|IM_SCB_CMD_COMPLETED
mdefine_line|#define IM_SCB_CMD_COMPLETED&t;&t;&t;0x10
DECL|macro|IM_SCB_CMD_COMPLETED_WITH_RETRIES
mdefine_line|#define IM_SCB_CMD_COMPLETED_WITH_RETRIES&t;0x50
DECL|macro|IM_LOOP_SCATTER_BUFFER_FULL
mdefine_line|#define IM_LOOP_SCATTER_BUFFER_FULL&t;&t;0x60
DECL|macro|IM_ADAPTER_HW_FAILURE
mdefine_line|#define IM_ADAPTER_HW_FAILURE&t;&t;&t;0x70
DECL|macro|IM_IMMEDIATE_CMD_COMPLETED
mdefine_line|#define IM_IMMEDIATE_CMD_COMPLETED&t;&t;0xa0
DECL|macro|IM_CMD_COMPLETED_WITH_FAILURE
mdefine_line|#define IM_CMD_COMPLETED_WITH_FAILURE&t;&t;0xc0
DECL|macro|IM_CMD_ERROR
mdefine_line|#define IM_CMD_ERROR&t;&t;&t;&t;0xe0
DECL|macro|IM_SOFTWARE_SEQUENCING_ERROR
mdefine_line|#define IM_SOFTWARE_SEQUENCING_ERROR&t;&t;0xf0
multiline_comment|/*to interpret bits 3-0 of Basic Status register (bits 7-4 reserved) */
DECL|macro|IM_CMD_REG_FULL
mdefine_line|#define IM_CMD_REG_FULL&t;&t;0x08
DECL|macro|IM_CMD_REG_EMPTY
mdefine_line|#define IM_CMD_REG_EMPTY&t;0x04
DECL|macro|IM_INTR_REQUEST
mdefine_line|#define IM_INTR_REQUEST&t;&t;0x02
DECL|macro|IM_BUSY
mdefine_line|#define IM_BUSY&t;&t;&t;0x01
multiline_comment|/*immediate commands (word written into low 2 bytes of command reg) */
DECL|macro|IM_RESET_IMM_CMD
mdefine_line|#define IM_RESET_IMM_CMD&t;0x0400
DECL|macro|IM_FEATURE_CTR_IMM_CMD
mdefine_line|#define IM_FEATURE_CTR_IMM_CMD&t;0x040c
DECL|macro|IM_DMA_PACING_IMM_CMD
mdefine_line|#define IM_DMA_PACING_IMM_CMD&t;0x040d
DECL|macro|IM_ASSIGN_IMM_CMD
mdefine_line|#define IM_ASSIGN_IMM_CMD&t;0x040e
DECL|macro|IM_ABORT_IMM_CMD
mdefine_line|#define IM_ABORT_IMM_CMD&t;0x040f
DECL|macro|IM_FORMAT_PREP_IMM_CMD
mdefine_line|#define IM_FORMAT_PREP_IMM_CMD&t;0x0417
multiline_comment|/*SCB (Subsystem Control Block) structure */
DECL|struct|im_scb
r_struct
id|im_scb
(brace
DECL|member|command
r_int
r_int
id|command
suffix:semicolon
multiline_comment|/*command word (read, etc.) */
DECL|member|enable
r_int
r_int
id|enable
suffix:semicolon
multiline_comment|/*enable word, modifies cmd */
r_union
(brace
DECL|member|log_blk_adr
r_int
r_int
id|log_blk_adr
suffix:semicolon
multiline_comment|/*block address on SCSI device */
DECL|member|scsi_cmd_length
r_int
r_char
id|scsi_cmd_length
suffix:semicolon
multiline_comment|/*6,10,12, for other scsi cmd */
DECL|member|u1
)brace
id|u1
suffix:semicolon
DECL|member|sys_buf_adr
r_int
r_int
id|sys_buf_adr
suffix:semicolon
multiline_comment|/*physical system memory adr */
DECL|member|sys_buf_length
r_int
r_int
id|sys_buf_length
suffix:semicolon
multiline_comment|/*size of sys mem buffer */
DECL|member|tsb_adr
r_int
r_int
id|tsb_adr
suffix:semicolon
multiline_comment|/*Termination Status Block adr */
DECL|member|scb_chain_adr
r_int
r_int
id|scb_chain_adr
suffix:semicolon
multiline_comment|/*optional SCB chain address */
r_union
(brace
r_struct
(brace
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/*block count, on SCSI device */
DECL|member|length
r_int
r_int
id|length
suffix:semicolon
multiline_comment|/*block length, on SCSI device */
DECL|member|blk
)brace
id|blk
suffix:semicolon
DECL|member|scsi_command
r_int
r_char
id|scsi_command
(braket
l_int|12
)braket
suffix:semicolon
multiline_comment|/*other scsi command */
DECL|member|u2
)brace
id|u2
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*structure scatter-gather element (for list of system memory areas) */
DECL|struct|im_sge
r_struct
id|im_sge
(brace
DECL|member|address
r_void
op_star
id|address
suffix:semicolon
DECL|member|byte_length
r_int
r_int
id|byte_length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*structure returned by a get_pos_info command: */
DECL|struct|im_pos_info
r_struct
id|im_pos_info
(brace
DECL|member|pos_id
r_int
r_int
id|pos_id
suffix:semicolon
multiline_comment|/* adapter id */
DECL|member|pos_3a
r_int
r_char
id|pos_3a
suffix:semicolon
multiline_comment|/* pos 3 (if pos 6 = 0) */
DECL|member|pos_2
r_int
r_char
id|pos_2
suffix:semicolon
multiline_comment|/* pos 2 */
DECL|member|int_level
r_int
r_char
id|int_level
suffix:semicolon
multiline_comment|/* interrupt level IRQ 11 or 14 */
DECL|member|pos_4a
r_int
r_char
id|pos_4a
suffix:semicolon
multiline_comment|/* pos 4 (if pos 6 = 0) */
DECL|member|connector_size
r_int
r_int
id|connector_size
suffix:semicolon
multiline_comment|/* MCA connector size: 16 or 32 Bit */
DECL|member|num_luns
r_int
r_char
id|num_luns
suffix:semicolon
multiline_comment|/* number of supported luns per device */
DECL|member|num_puns
r_int
r_char
id|num_puns
suffix:semicolon
multiline_comment|/* number of supported puns */
DECL|member|pacing_factor
r_int
r_char
id|pacing_factor
suffix:semicolon
multiline_comment|/* pacing factor */
DECL|member|num_ldns
r_int
r_char
id|num_ldns
suffix:semicolon
multiline_comment|/* number of ldns available */
DECL|member|eoi_off
r_int
r_char
id|eoi_off
suffix:semicolon
multiline_comment|/* time EOI and interrupt inactive */
DECL|member|max_busy
r_int
r_char
id|max_busy
suffix:semicolon
multiline_comment|/* time between reset and busy on */
DECL|member|cache_stat
r_int
r_int
id|cache_stat
suffix:semicolon
multiline_comment|/* ldn cachestat. Bit=1 = not cached */
DECL|member|retry_stat
r_int
r_int
id|retry_stat
suffix:semicolon
multiline_comment|/* retry status of ldns. Bit=1=disabled */
DECL|member|pos_4b
r_int
r_char
id|pos_4b
suffix:semicolon
multiline_comment|/* pos 4 (if pos 6 = 1) */
DECL|member|pos_3b
r_int
r_char
id|pos_3b
suffix:semicolon
multiline_comment|/* pos 3 (if pos 6 = 1) */
DECL|member|pos_6
r_int
r_char
id|pos_6
suffix:semicolon
multiline_comment|/* pos 6 */
DECL|member|pos_5
r_int
r_char
id|pos_5
suffix:semicolon
multiline_comment|/* pos 5 */
DECL|member|max_overlap
r_int
r_int
id|max_overlap
suffix:semicolon
multiline_comment|/* maximum overlapping requests */
DECL|member|num_bus
r_int
r_int
id|num_bus
suffix:semicolon
multiline_comment|/* number of SCSI-busses */
)brace
suffix:semicolon
multiline_comment|/*values for SCB command word */
DECL|macro|IM_NO_SYNCHRONOUS
mdefine_line|#define IM_NO_SYNCHRONOUS      0x0040&t;/*flag for any command */
DECL|macro|IM_NO_DISCONNECT
mdefine_line|#define IM_NO_DISCONNECT       0x0080&t;/*flag for any command */
DECL|macro|IM_READ_DATA_CMD
mdefine_line|#define IM_READ_DATA_CMD       0x1c01
DECL|macro|IM_WRITE_DATA_CMD
mdefine_line|#define IM_WRITE_DATA_CMD      0x1c02
DECL|macro|IM_READ_VERIFY_CMD
mdefine_line|#define IM_READ_VERIFY_CMD     0x1c03
DECL|macro|IM_WRITE_VERIFY_CMD
mdefine_line|#define IM_WRITE_VERIFY_CMD    0x1c04
DECL|macro|IM_REQUEST_SENSE_CMD
mdefine_line|#define IM_REQUEST_SENSE_CMD   0x1c08
DECL|macro|IM_READ_CAPACITY_CMD
mdefine_line|#define IM_READ_CAPACITY_CMD   0x1c09
DECL|macro|IM_DEVICE_INQUIRY_CMD
mdefine_line|#define IM_DEVICE_INQUIRY_CMD  0x1c0b
DECL|macro|IM_READ_LOGICAL_CMD
mdefine_line|#define IM_READ_LOGICAL_CMD    0x1c2a
DECL|macro|IM_OTHER_SCSI_CMD_CMD
mdefine_line|#define IM_OTHER_SCSI_CMD_CMD  0x241f
multiline_comment|/* unused, but supported, SCB commands */
DECL|macro|IM_GET_COMMAND_COMPLETE_STATUS_CMD
mdefine_line|#define IM_GET_COMMAND_COMPLETE_STATUS_CMD   0x1c07 /* command status */
DECL|macro|IM_GET_POS_INFO_CMD
mdefine_line|#define IM_GET_POS_INFO_CMD                  0x1c0a /* returns neat stuff */
DECL|macro|IM_READ_PREFETCH_CMD
mdefine_line|#define IM_READ_PREFETCH_CMD                 0x1c31 /* caching controller only */
DECL|macro|IM_FOMAT_UNIT_CMD
mdefine_line|#define IM_FOMAT_UNIT_CMD                    0x1c16 /* format unit */
DECL|macro|IM_REASSIGN_BLOCK_CMD
mdefine_line|#define IM_REASSIGN_BLOCK_CMD                0x1c18 /* in case of error */
multiline_comment|/*values to set bits in the enable word of SCB */
DECL|macro|IM_READ_CONTROL
mdefine_line|#define IM_READ_CONTROL              0x8000
DECL|macro|IM_REPORT_TSB_ONLY_ON_ERROR
mdefine_line|#define IM_REPORT_TSB_ONLY_ON_ERROR  0x4000
DECL|macro|IM_RETRY_ENABLE
mdefine_line|#define IM_RETRY_ENABLE              0x2000
DECL|macro|IM_POINTER_TO_LIST
mdefine_line|#define IM_POINTER_TO_LIST           0x1000
DECL|macro|IM_SUPRESS_EXCEPTION_SHORT
mdefine_line|#define IM_SUPRESS_EXCEPTION_SHORT   0x0400
DECL|macro|IM_BYPASS_BUFFER
mdefine_line|#define IM_BYPASS_BUFFER             0x0200
DECL|macro|IM_CHAIN_ON_NO_ERROR
mdefine_line|#define IM_CHAIN_ON_NO_ERROR         0x0001
multiline_comment|/*TSB (Termination Status Block) structure */
DECL|struct|im_tsb
r_struct
id|im_tsb
(brace
DECL|member|end_status
r_int
r_int
id|end_status
suffix:semicolon
DECL|member|reserved1
r_int
r_int
id|reserved1
suffix:semicolon
DECL|member|residual_byte_count
r_int
r_int
id|residual_byte_count
suffix:semicolon
DECL|member|sg_list_element_adr
r_int
r_int
id|sg_list_element_adr
suffix:semicolon
DECL|member|status_length
r_int
r_int
id|status_length
suffix:semicolon
DECL|member|dev_status
r_int
r_char
id|dev_status
suffix:semicolon
DECL|member|cmd_status
r_int
r_char
id|cmd_status
suffix:semicolon
DECL|member|dev_error
r_int
r_char
id|dev_error
suffix:semicolon
DECL|member|cmd_error
r_int
r_char
id|cmd_error
suffix:semicolon
DECL|member|reserved2
r_int
r_int
id|reserved2
suffix:semicolon
DECL|member|reserved3
r_int
r_int
id|reserved3
suffix:semicolon
DECL|member|low_of_last_scb_adr
r_int
r_int
id|low_of_last_scb_adr
suffix:semicolon
DECL|member|high_of_last_scb_adr
r_int
r_int
id|high_of_last_scb_adr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*subsystem uses interrupt request level 14 */
DECL|macro|IM_IRQ
mdefine_line|#define IM_IRQ     14
multiline_comment|/*SCSI-2 F/W may evade to interrupt 11 */
DECL|macro|IM_IRQ_FW
mdefine_line|#define IM_IRQ_FW  11
multiline_comment|/* Model 95 has an additional alphanumeric display, which can be used&n;   to display SCSI-activities. 8595 models do not have any disk led, which&n;   makes this feature quite useful.&n;   The regular PS/2 disk led is turned on/off by bits 6,7 of system&n;   control port. */
multiline_comment|/* LED display-port (actually, last LED on display) */
DECL|macro|MOD95_LED_PORT
mdefine_line|#define MOD95_LED_PORT&t;   0x108
multiline_comment|/* system-control-register of PS/2s with diskindicator */
DECL|macro|PS2_SYS_CTR
mdefine_line|#define PS2_SYS_CTR        0x92
multiline_comment|/* activity displaying methods */
DECL|macro|LED_DISP
mdefine_line|#define LED_DISP           1
DECL|macro|LED_ADISP
mdefine_line|#define LED_ADISP          2
DECL|macro|LED_ACTIVITY
mdefine_line|#define LED_ACTIVITY       4
multiline_comment|/* failed intr */
DECL|macro|CMD_FAIL
mdefine_line|#define CMD_FAIL           255
multiline_comment|/* The SCSI-ID(!) of the accessed SCSI-device is shown on PS/2-95 machines&squot; LED&n;   displays. ldn is no longer displayed here, because the ldn mapping is now &n;   done dynamically and the ldn &lt;-&gt; pun,lun maps can be looked-up at boottime &n;   or during uptime in /proc/scsi/ibmmca/&lt;host_no&gt; in case of trouble, &n;   interest, debugging or just for having fun. The left number gives the&n;   host-adapter number and the right shows the accessed SCSI-ID. */
multiline_comment|/* display_mode is set by the ibmmcascsi= command line arg */
DECL|variable|display_mode
r_static
r_int
id|display_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set default adapter timeout */
DECL|variable|adapter_timeout
r_static
r_int
r_int
id|adapter_timeout
op_assign
l_int|45
suffix:semicolon
multiline_comment|/* for probing on feature-command: */
DECL|variable|global_command_error_excuse
r_static
r_int
r_int
id|global_command_error_excuse
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* global setting by command line for adapter_speed */
DECL|variable|global_adapter_speed
r_static
r_int
id|global_adapter_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* full speed by default */
multiline_comment|/* Panel / LED on, do it right for F/W addressin, too. adisplay will&n; * just ignore ids&gt;7, as the panel has only 7 digits available */
DECL|macro|PS2_DISK_LED_ON
mdefine_line|#define PS2_DISK_LED_ON(ad,id) { if (display_mode &amp; LED_DISP) { if (id&gt;9) &bslash;&n;    outw((ad+48)|((id+55)&lt;&lt;8), MOD95_LED_PORT ); else &bslash;&n;    outw((ad+48)|((id+48)&lt;&lt;8), MOD95_LED_PORT ); } else &bslash;&n;    if (display_mode &amp; LED_ADISP) { if (id&lt;7) outb((char)(id+48),MOD95_LED_PORT+1+id); &bslash;&n;    outb((char)(ad+48), MOD95_LED_PORT); } &bslash;&n;    if ((display_mode &amp; LED_ACTIVITY)||(!display_mode)) &bslash;&n;    outb(inb(PS2_SYS_CTR) | 0xc0, PS2_SYS_CTR); }
multiline_comment|/* Panel / LED off */
multiline_comment|/* bug fixed, Dec 15, 1997, where | was replaced by &amp; here */
DECL|macro|PS2_DISK_LED_OFF
mdefine_line|#define PS2_DISK_LED_OFF() { if (display_mode &amp; LED_DISP) &bslash;&n;    outw(0x2020, MOD95_LED_PORT ); else if (display_mode &amp; LED_ADISP) { &bslash;&n;    outl(0x20202020,MOD95_LED_PORT); outl(0x20202020,MOD95_LED_PORT+4); } &bslash;&n;    if ((display_mode &amp; LED_ACTIVITY)||(!display_mode)) &bslash;&n;    outb(inb(PS2_SYS_CTR) &amp; 0x3f, PS2_SYS_CTR); }
multiline_comment|/*list of supported subsystems */
DECL|struct|subsys_list_struct
r_struct
id|subsys_list_struct
(brace
DECL|member|mca_id
r_int
r_int
id|mca_id
suffix:semicolon
DECL|member|description
r_char
op_star
id|description
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* types of different supported hardware that goes to hostdata special */
DECL|macro|IBM_SCSI2_FW
mdefine_line|#define IBM_SCSI2_FW     0
DECL|macro|IBM_7568_WCACHE
mdefine_line|#define IBM_7568_WCACHE  1
DECL|macro|IBM_EXP_UNIT
mdefine_line|#define IBM_EXP_UNIT     2
DECL|macro|IBM_SCSI_WCACHE
mdefine_line|#define IBM_SCSI_WCACHE  3
DECL|macro|IBM_SCSI
mdefine_line|#define IBM_SCSI         4
multiline_comment|/* other special flags for hostdata structure */
DECL|macro|FORCED_DETECTION
mdefine_line|#define FORCED_DETECTION         100
DECL|macro|INTEGRATED_SCSI
mdefine_line|#define INTEGRATED_SCSI          101
multiline_comment|/* List of possible IBM-SCSI-adapters */
DECL|variable|subsys_list
r_struct
id|subsys_list_struct
id|subsys_list
(braket
)braket
op_assign
(brace
(brace
l_int|0x8efc
comma
l_string|&quot;IBM SCSI-2 F/W Adapter&quot;
)brace
comma
multiline_comment|/* special = 0 */
(brace
l_int|0x8efd
comma
l_string|&quot;IBM 7568 Industrial Computer SCSI Adapter w/Cache&quot;
)brace
comma
multiline_comment|/* special = 1 */
(brace
l_int|0x8ef8
comma
l_string|&quot;IBM Expansion Unit SCSI Controller&quot;
)brace
comma
multiline_comment|/* special = 2 */
(brace
l_int|0x8eff
comma
l_string|&quot;IBM SCSI Adapter w/Cache&quot;
)brace
comma
multiline_comment|/* special = 3 */
(brace
l_int|0x8efe
comma
l_string|&quot;IBM SCSI Adapter&quot;
)brace
comma
multiline_comment|/* special = 4 */
)brace
suffix:semicolon
multiline_comment|/* Max number of logical devices (can be up from 0 to 14).  15 is the address&n;of the adapter itself. */
DECL|macro|MAX_LOG_DEV
mdefine_line|#define MAX_LOG_DEV  15
multiline_comment|/*local data for a logical device */
DECL|struct|logical_device
r_struct
id|logical_device
(brace
DECL|member|scb
r_struct
id|im_scb
id|scb
suffix:semicolon
multiline_comment|/* SCSI-subsystem-control-block structure */
DECL|member|tsb
r_struct
id|im_tsb
id|tsb
suffix:semicolon
multiline_comment|/* SCSI command complete status block structure */
DECL|member|sge
r_struct
id|im_sge
id|sge
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* scatter gather list structure */
DECL|member|buf
r_int
r_char
id|buf
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* SCSI command return data buffer */
DECL|member|cmd
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
multiline_comment|/* SCSI-command that is currently in progress */
DECL|member|device_type
r_int
id|device_type
suffix:semicolon
multiline_comment|/* type of the SCSI-device. See include/scsi/scsi.h&n;&t;&t;       for interpretation of the possible values */
DECL|member|block_length
r_int
id|block_length
suffix:semicolon
multiline_comment|/* blocksize of a particular logical SCSI-device */
DECL|member|cache_flag
r_int
id|cache_flag
suffix:semicolon
multiline_comment|/* 1 if this is uncached, 0 if cache is present for ldn */
DECL|member|retry_flag
r_int
id|retry_flag
suffix:semicolon
multiline_comment|/* 1 if adapter retry is disabled, 0 if enabled */
)brace
suffix:semicolon
multiline_comment|/* statistics of the driver during operations (for proc_info) */
DECL|struct|Driver_Statistics
r_struct
id|Driver_Statistics
(brace
multiline_comment|/* SCSI statistics on the adapter */
DECL|member|ldn_access
r_int
id|ldn_access
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* total accesses on a ldn */
DECL|member|ldn_read_access
r_int
id|ldn_read_access
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* total read-access on a ldn */
DECL|member|ldn_write_access
r_int
id|ldn_write_access
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* total write-access on a ldn */
DECL|member|ldn_inquiry_access
r_int
id|ldn_inquiry_access
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* total inquiries on a ldn */
DECL|member|ldn_modeselect_access
r_int
id|ldn_modeselect_access
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* total mode selects on ldn */
DECL|member|scbs
r_int
id|scbs
suffix:semicolon
multiline_comment|/* short SCBs queued */
DECL|member|long_scbs
r_int
id|long_scbs
suffix:semicolon
multiline_comment|/* long SCBs queued */
DECL|member|total_accesses
r_int
id|total_accesses
suffix:semicolon
multiline_comment|/* total accesses on all ldns */
DECL|member|total_interrupts
r_int
id|total_interrupts
suffix:semicolon
multiline_comment|/* total interrupts (should be&n;&t;&t;&t;&t;&t;     same as total_accesses) */
DECL|member|total_errors
r_int
id|total_errors
suffix:semicolon
multiline_comment|/* command completed with error */
multiline_comment|/* dynamical assignment statistics */
DECL|member|total_scsi_devices
r_int
id|total_scsi_devices
suffix:semicolon
multiline_comment|/* number of physical pun,lun */
DECL|member|dyn_flag
r_int
id|dyn_flag
suffix:semicolon
multiline_comment|/* flag showing dynamical mode */
DECL|member|dynamical_assignments
r_int
id|dynamical_assignments
suffix:semicolon
multiline_comment|/* number of remappings of ldns */
DECL|member|ldn_assignments
r_int
id|ldn_assignments
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* number of remappings of each&n;&t;&t;&t;&t;&t;     ldn */
)brace
suffix:semicolon
multiline_comment|/* data structure for each host adapter */
DECL|struct|ibmmca_hostdata
r_struct
id|ibmmca_hostdata
(brace
multiline_comment|/* array of logical devices: */
DECL|member|_ld
r_struct
id|logical_device
id|_ld
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* array to convert (pun, lun) into logical device number: */
DECL|member|_get_ldn
r_int
r_char
id|_get_ldn
(braket
l_int|16
)braket
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/*array that contains the information about the physical SCSI-devices&n;    attached to this host adapter: */
DECL|member|_get_scsi
r_int
r_char
id|_get_scsi
(braket
l_int|16
)braket
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* used only when checking logical devices: */
DECL|member|_local_checking_phase_flag
r_int
id|_local_checking_phase_flag
suffix:semicolon
multiline_comment|/* report received interrupt: */
DECL|member|_got_interrupt
r_int
id|_got_interrupt
suffix:semicolon
multiline_comment|/* report termination-status of SCSI-command: */
DECL|member|_stat_result
r_int
id|_stat_result
suffix:semicolon
multiline_comment|/* reset status (used only when doing reset): */
DECL|member|_reset_status
r_int
id|_reset_status
suffix:semicolon
multiline_comment|/* code of the last SCSI command (needed for panic info): */
DECL|member|_last_scsi_command
r_int
id|_last_scsi_command
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* identifier of the last SCSI-command type */
DECL|member|_last_scsi_type
r_int
id|_last_scsi_type
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* last blockcount */
DECL|member|_last_scsi_blockcount
r_int
id|_last_scsi_blockcount
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* last locgical block address */
DECL|member|_last_scsi_logical_block
r_int
r_int
id|_last_scsi_logical_block
(braket
id|MAX_LOG_DEV
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Counter that points on the next reassignable ldn for dynamical&n;      remapping. The default value is 7, that is the first reassignable&n;      number in the list at boottime: */
DECL|member|_next_ldn
r_int
id|_next_ldn
suffix:semicolon
multiline_comment|/* Statistics-structure for this IBM-SCSI-host: */
DECL|member|_IBM_DS
r_struct
id|Driver_Statistics
id|_IBM_DS
suffix:semicolon
multiline_comment|/* This hostadapters pos-registers pos2 until pos6 */
DECL|member|_pos
r_int
r_int
id|_pos
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* assign a special variable, that contains dedicated info about the&n;    adaptertype */
DECL|member|_special
r_int
id|_special
suffix:semicolon
multiline_comment|/* connector size on the MCA bus */
DECL|member|_connector_size
r_int
id|_connector_size
suffix:semicolon
multiline_comment|/* synchronous SCSI transfer rate bitpattern */
DECL|member|_adapter_speed
r_int
id|_adapter_speed
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* macros to access host data structure */
DECL|macro|subsystem_pun
mdefine_line|#define subsystem_pun(hi) (hosts[(hi)]-&gt;this_id)
DECL|macro|subsystem_maxid
mdefine_line|#define subsystem_maxid(hi) (hosts[(hi)]-&gt;max_id)
DECL|macro|ld
mdefine_line|#define ld(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_ld)
DECL|macro|get_ldn
mdefine_line|#define get_ldn(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_get_ldn)
DECL|macro|get_scsi
mdefine_line|#define get_scsi(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_get_scsi)
DECL|macro|local_checking_phase_flag
mdefine_line|#define local_checking_phase_flag(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_local_checking_phase_flag)
DECL|macro|got_interrupt
mdefine_line|#define got_interrupt(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_got_interrupt)
DECL|macro|stat_result
mdefine_line|#define stat_result(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_stat_result)
DECL|macro|reset_status
mdefine_line|#define reset_status(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_reset_status)
DECL|macro|last_scsi_command
mdefine_line|#define last_scsi_command(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_last_scsi_command)
DECL|macro|last_scsi_type
mdefine_line|#define last_scsi_type(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_last_scsi_type)
DECL|macro|last_scsi_blockcount
mdefine_line|#define last_scsi_blockcount(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_last_scsi_blockcount)
DECL|macro|last_scsi_logical_block
mdefine_line|#define last_scsi_logical_block(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_last_scsi_logical_block)
DECL|macro|last_scsi_type
mdefine_line|#define last_scsi_type(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_last_scsi_type)
DECL|macro|next_ldn
mdefine_line|#define next_ldn(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_next_ldn)
DECL|macro|IBM_DS
mdefine_line|#define IBM_DS(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_IBM_DS)
DECL|macro|special
mdefine_line|#define special(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_special)
DECL|macro|subsystem_connector_size
mdefine_line|#define subsystem_connector_size(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_connector_size)
DECL|macro|adapter_speed
mdefine_line|#define adapter_speed(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_adapter_speed)
DECL|macro|pos2
mdefine_line|#define pos2(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_pos[2])
DECL|macro|pos3
mdefine_line|#define pos3(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_pos[3])
DECL|macro|pos4
mdefine_line|#define pos4(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_pos[4])
DECL|macro|pos5
mdefine_line|#define pos5(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_pos[5])
DECL|macro|pos6
mdefine_line|#define pos6(hi) (((struct ibmmca_hostdata *) hosts[(hi)]-&gt;hostdata)-&gt;_pos[6])
multiline_comment|/* Define a arbitrary number as subsystem-marker-type. This number is, as&n;   described in the ANSI-SCSI-standard, not occupied by other device-types. */
DECL|macro|TYPE_IBM_SCSI_ADAPTER
mdefine_line|#define TYPE_IBM_SCSI_ADAPTER   0x2F
multiline_comment|/* Define 0xFF for no device type, because this type is not defined within&n;   the ANSI-SCSI-standard, therefore, it can be used and should not cause any&n;   harm. */
DECL|macro|TYPE_NO_DEVICE
mdefine_line|#define TYPE_NO_DEVICE          0xFF
multiline_comment|/* define medium-changer. If this is not defined previously, e.g. Linux&n;   2.0.x, define this type here. */
macro_line|#ifndef TYPE_MEDIUM_CHANGER
DECL|macro|TYPE_MEDIUM_CHANGER
mdefine_line|#define TYPE_MEDIUM_CHANGER     0x08
macro_line|#endif
multiline_comment|/* define possible operations for the immediate_assign command */
DECL|macro|SET_LDN
mdefine_line|#define SET_LDN        0
DECL|macro|REMOVE_LDN
mdefine_line|#define REMOVE_LDN     1
multiline_comment|/* ldn which is used to probe the SCSI devices */
DECL|macro|PROBE_LDN
mdefine_line|#define PROBE_LDN      0
multiline_comment|/* reset status flag contents */
DECL|macro|IM_RESET_NOT_IN_PROGRESS
mdefine_line|#define IM_RESET_NOT_IN_PROGRESS         0
DECL|macro|IM_RESET_IN_PROGRESS
mdefine_line|#define IM_RESET_IN_PROGRESS             1
DECL|macro|IM_RESET_FINISHED_OK
mdefine_line|#define IM_RESET_FINISHED_OK             2
DECL|macro|IM_RESET_FINISHED_FAIL
mdefine_line|#define IM_RESET_FINISHED_FAIL           3
DECL|macro|IM_RESET_NOT_IN_PROGRESS_NO_INT
mdefine_line|#define IM_RESET_NOT_IN_PROGRESS_NO_INT  4
DECL|macro|IM_RESET_FINISHED_OK_NO_INT
mdefine_line|#define IM_RESET_FINISHED_OK_NO_INT      5
multiline_comment|/* define undefined SCSI-command */
DECL|macro|NO_SCSI
mdefine_line|#define NO_SCSI                  0xffff
multiline_comment|/*-----------------------------------------------------------------------*/
multiline_comment|/* if this is nonzero, ibmmcascsi option has been passed to the kernel */
DECL|variable|io_port
r_static
r_int
id|io_port
(braket
id|IM_MAX_HOSTS
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|scsi_id
r_static
r_int
id|scsi_id
(braket
id|IM_MAX_HOSTS
)braket
op_assign
(brace
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
)brace
suffix:semicolon
multiline_comment|/* fill module-parameters only, when this define is present.&n;   (that is kernel version 2.1.x) */
macro_line|#if defined(MODULE)
DECL|variable|boot_options
r_static
r_char
op_star
id|boot_options
op_assign
l_int|NULL
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
id|MODULE_PARM
c_func
(paren
id|boot_options
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io_port
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IM_MAX_HOSTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scsi_id
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IM_MAX_HOSTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|display
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|adisplay
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|normal
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ansi
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*counter of concurrent disk read/writes, to turn on/off disk led */
DECL|variable|disk_rw_in_progress
r_static
r_int
id|disk_rw_in_progress
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* host information */
DECL|variable|found
r_static
r_int
id|found
op_assign
l_int|0
suffix:semicolon
DECL|variable|hosts
r_static
r_struct
id|Scsi_Host
op_star
id|hosts
(braket
id|IM_MAX_HOSTS
op_plus
l_int|1
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|pos
r_static
r_int
r_int
id|pos
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* whole pos register-line for diagnosis */
multiline_comment|/* Taking into account the additions, made by ZP Gu.&n; * This selects now the preset value from the configfile and&n; * offers the &squot;normal&squot; commandline option to be accepted */
macro_line|#ifdef CONFIG_IBMMCA_SCSI_ORDER_STANDARD
DECL|variable|ibm_ansi_order
r_static
r_char
id|ibm_ansi_order
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|ibm_ansi_order
r_static
r_char
id|ibm_ansi_order
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_static
r_void
id|interrupt_handler
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|issue_cmd
(paren
r_int
comma
r_int
r_int
comma
r_int
r_char
)paren
suffix:semicolon
r_static
r_void
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|check_devices
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|immediate_assign
c_func
(paren
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|immediate_feature
c_func
(paren
r_int
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IBMMCA_SCSI_DEV_RESET
r_static
r_int
id|immediate_reset
c_func
(paren
r_int
comma
r_int
r_int
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|device_inquiry
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|read_capacity
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|get_pos_info
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_char
op_star
id|ti_p
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_char
op_star
id|ti_l
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_char
op_star
id|ibmrate
c_func
(paren
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|probe_display
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|probe_bus_mode
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|device_exists
(paren
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_static
r_struct
id|Scsi_Host
op_star
id|ibmmca_register
c_func
(paren
id|Scsi_Host_Template
op_star
comma
r_int
comma
r_int
comma
r_int
comma
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|option_setup
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
multiline_comment|/* local functions needed for proc_info */
r_static
r_int
id|ldn_access_load
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ldn_access_total_read_write
c_func
(paren
r_int
)paren
suffix:semicolon
DECL|function|interrupt_handler
r_static
r_void
id|interrupt_handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|host_index
comma
id|ihost_index
suffix:semicolon
r_int
r_int
id|intr_reg
suffix:semicolon
r_int
r_int
id|cmd_result
suffix:semicolon
r_int
r_int
id|ldn
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_int
id|lastSCSI
suffix:semicolon
id|IBMLOCK
multiline_comment|/* search for one adapter-response on shared interrupt */
r_for
c_loop
(paren
id|host_index
op_assign
l_int|0
suffix:semicolon
id|hosts
(braket
id|host_index
)braket
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|IM_STAT_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
id|IM_INTR_REQUEST
)paren
suffix:semicolon
id|host_index
op_increment
)paren
suffix:semicolon
multiline_comment|/* return if some other device on this IRQ caused the interrupt */
r_if
c_cond
(paren
op_logical_neg
id|hosts
(braket
id|host_index
)braket
)paren
(brace
id|IBMUNLOCK
r_return
suffix:semicolon
)brace
multiline_comment|/* the reset-function already did all the job, even ints got&n;      renabled on the subsystem, so just return */
r_if
c_cond
(paren
(paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_eq
id|IM_RESET_NOT_IN_PROGRESS_NO_INT
)paren
op_logical_or
(paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_eq
id|IM_RESET_FINISHED_OK_NO_INT
)paren
)paren
(brace
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_NOT_IN_PROGRESS
suffix:semicolon
id|IBMUNLOCK
r_return
suffix:semicolon
)brace
multiline_comment|/*must wait for attention reg not busy, then send EOI to subsystem */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
(paren
id|IM_STAT_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
id|IM_BUSY
)paren
)paren
r_break
suffix:semicolon
id|IBMUNLOCK
multiline_comment|/* cycle interrupt */
id|IBMLOCK
)brace
id|ihost_index
op_assign
id|host_index
suffix:semicolon
multiline_comment|/*get command result and logical device */
id|intr_reg
op_assign
(paren
r_int
r_char
)paren
(paren
id|inb
(paren
id|IM_INTR_REG
c_func
(paren
id|ihost_index
)paren
)paren
)paren
suffix:semicolon
id|cmd_result
op_assign
id|intr_reg
op_amp
l_int|0xf0
suffix:semicolon
id|ldn
op_assign
id|intr_reg
op_amp
l_int|0x0f
suffix:semicolon
multiline_comment|/* get the last_scsi_command here */
id|lastSCSI
op_assign
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
suffix:semicolon
id|outb
(paren
id|IM_EOI
op_or
id|ldn
comma
id|IM_ATTN_REG
c_func
(paren
id|ihost_index
)paren
)paren
suffix:semicolon
id|IBMUNLOCK
multiline_comment|/*these should never happen (hw fails, or a local programming bug) */
r_if
c_cond
(paren
op_logical_neg
id|global_command_error_excuse
)paren
(brace
r_switch
c_cond
(paren
id|cmd_result
)paren
(brace
multiline_comment|/* Prevent from Ooopsing on error to show the real reason */
r_case
id|IM_ADAPTER_HW_FAILURE
suffix:colon
r_case
id|IM_SOFTWARE_SEQUENCING_ERROR
suffix:colon
r_case
id|IM_CMD_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;nIBM MCA SCSI: Fatal Subsystem ERROR!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              Last cmd=0x%x, ena=%x, len=&quot;
comma
id|lastSCSI
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.enable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
)paren
id|printk
c_func
(paren
l_string|&quot;%ld/%ld,&quot;
comma
(paren
r_int
)paren
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd-&gt;request_bufflen
)paren
comma
(paren
r_int
)paren
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.sys_buf_length
)paren
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;none,&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
)paren
id|printk
c_func
(paren
l_string|&quot;Blocksize=%d&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.u2.blk.length
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Blocksize=none&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, host=0x%x, ldn=0x%x&bslash;n&quot;
comma
id|ihost_index
comma
id|ldn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Blockcount=%d/%d&bslash;n&quot;
comma
id|last_scsi_blockcount
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.u2.blk.count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Logical block=%lx/%lx&bslash;n&quot;
comma
id|last_scsi_logical_block
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.u1.log_blk_adr
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Reason given: %s&bslash;n&quot;
comma
(paren
id|cmd_result
op_eq
id|IM_ADAPTER_HW_FAILURE
)paren
ques
c_cond
l_string|&quot;HARDWARE FAILURE&quot;
suffix:colon
(paren
id|cmd_result
op_eq
id|IM_SOFTWARE_SEQUENCING_ERROR
)paren
ques
c_cond
l_string|&quot;SOFTWARE SEQUENCING ERROR&quot;
suffix:colon
(paren
id|cmd_result
op_eq
id|IM_CMD_ERROR
)paren
ques
c_cond
l_string|&quot;COMMAND ERROR&quot;
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
suffix:semicolon
multiline_comment|/* if errors appear, enter this section to give detailed info */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Subsystem Error-Status follows:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              Command Type................: %x&bslash;n&quot;
comma
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              Attention Register..........: %x&bslash;n&quot;
comma
id|inb
(paren
id|IM_ATTN_REG
c_func
(paren
id|ihost_index
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              Basic Control Register......: %x&bslash;n&quot;
comma
id|inb
(paren
id|IM_CTR_REG
c_func
(paren
id|ihost_index
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              Interrupt Status Register...: %x&bslash;n&quot;
comma
id|intr_reg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              Basic Status Register.......: %x&bslash;n&quot;
comma
id|inb
(paren
id|IM_STAT_REG
c_func
(paren
id|ihost_index
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_eq
id|IM_SCB
)paren
op_logical_or
(paren
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_eq
id|IM_LONG_SCB
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;              SCB-Command.................: %x&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-Enable..................: %x&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.enable
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-logical block address...: %lx&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.u1.log_blk_adr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-system buffer address...: %lx&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.sys_buf_adr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-system buffer length....: %lx&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.sys_buf_length
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-tsb address.............: %lx&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.tsb_adr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-Chain address...........: %lx&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.scb_chain_adr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-block count.............: %x&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.u2.blk.count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SCB-block length............: %x&bslash;n&quot;
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|scb.u2.blk.length
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;              Send this report to the maintainer.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;IBM MCA SCSI: Fatal errormessage from the subsystem (0x%X,0x%X)!&bslash;n&quot;
comma
id|lastSCSI
comma
id|cmd_result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* The command error handling is made silent, but we tell the&n;       * calling function, that there is a reported error from the&n;       * adapter. */
r_switch
c_cond
(paren
id|cmd_result
)paren
(brace
r_case
id|IM_ADAPTER_HW_FAILURE
suffix:colon
r_case
id|IM_SOFTWARE_SEQUENCING_ERROR
suffix:colon
r_case
id|IM_CMD_ERROR
suffix:colon
id|global_command_error_excuse
op_assign
id|CMD_FAIL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|global_command_error_excuse
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* if no panic appeared, increase the interrupt-counter */
id|IBM_DS
c_func
(paren
id|ihost_index
)paren
dot
id|total_interrupts
op_increment
suffix:semicolon
multiline_comment|/*only for local checking phase */
r_if
c_cond
(paren
id|local_checking_phase_flag
c_func
(paren
id|ihost_index
)paren
)paren
(brace
id|stat_result
c_func
(paren
id|ihost_index
)paren
op_assign
id|cmd_result
suffix:semicolon
id|got_interrupt
c_func
(paren
id|ihost_index
)paren
op_assign
l_int|1
suffix:semicolon
id|reset_status
c_func
(paren
id|ihost_index
)paren
op_assign
id|IM_RESET_FINISHED_OK
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
id|NO_SCSI
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* handling of commands coming from upper level of scsi driver */
r_if
c_cond
(paren
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_eq
id|IM_IMM_CMD
)paren
(brace
multiline_comment|/* verify ldn, and may handle rare reset immediate command */
r_if
c_cond
(paren
(paren
id|reset_status
c_func
(paren
id|ihost_index
)paren
op_eq
id|IM_RESET_IN_PROGRESS
)paren
op_logical_and
(paren
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_eq
id|IM_RESET_IMM_CMD
)paren
)paren
(brace
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_CMD_COMPLETED_WITH_FAILURE
)paren
(brace
id|disk_rw_in_progress
op_assign
l_int|0
suffix:semicolon
id|PS2_DISK_LED_OFF
(paren
)paren
suffix:semicolon
id|reset_status
c_func
(paren
id|ihost_index
)paren
op_assign
id|IM_RESET_FINISHED_FAIL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*reset disk led counter, turn off disk led */
id|disk_rw_in_progress
op_assign
l_int|0
suffix:semicolon
id|PS2_DISK_LED_OFF
(paren
)paren
suffix:semicolon
id|reset_status
c_func
(paren
id|ihost_index
)paren
op_assign
id|IM_RESET_FINISHED_OK
suffix:semicolon
)brace
id|stat_result
c_func
(paren
id|ihost_index
)paren
op_assign
id|cmd_result
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
id|NO_SCSI
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_eq
id|IM_ABORT_IMM_CMD
)paren
(brace
multiline_comment|/* react on SCSI abort command */
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Interrupt from SCSI-abort.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|disk_rw_in_progress
op_assign
l_int|0
suffix:semicolon
id|PS2_DISK_LED_OFF
c_func
(paren
)paren
suffix:semicolon
id|cmd
op_assign
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
suffix:semicolon
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_CMD_COMPLETED_WITH_FAILURE
)paren
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_else
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|stat_result
c_func
(paren
id|ihost_index
)paren
op_assign
id|cmd_result
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
id|NO_SCSI
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* should be the internal_done */
r_return
suffix:semicolon
)brace
r_else
(brace
id|disk_rw_in_progress
op_assign
l_int|0
suffix:semicolon
id|PS2_DISK_LED_OFF
(paren
)paren
suffix:semicolon
id|reset_status
c_func
(paren
id|ihost_index
)paren
op_assign
id|IM_RESET_FINISHED_OK
suffix:semicolon
id|stat_result
c_func
(paren
id|ihost_index
)paren
op_assign
id|cmd_result
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
id|NO_SCSI
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|last_scsi_command
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
id|NO_SCSI
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
suffix:semicolon
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef IM_DEBUG_TIMEOUT
r_if
c_cond
(paren
id|cmd
)paren
(brace
r_if
c_cond
(paren
(paren
id|cmd-&gt;target
op_eq
id|TIMEOUT_PUN
)paren
op_logical_and
(paren
id|cmd-&gt;lun
op_eq
id|TIMEOUT_LUN
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Ignoring interrupt from pun=%x, lun=%x.&bslash;n&quot;
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*if no command structure, just return, else clear cmd */
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
r_return
suffix:semicolon
macro_line|#ifdef IM_DEBUG_INT
id|printk
c_func
(paren
l_string|&quot;cmd=%02x ireg=%02x ds=%02x cs=%02x de=%02x ce=%02x&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|intr_reg
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.dev_status
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.cmd_status
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.dev_error
comma
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.cmd_error
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*if this is end of media read/write, may turn off PS/2 disk led */
r_if
c_cond
(paren
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
op_ne
id|TYPE_NO_LUN
)paren
op_logical_and
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
op_ne
id|TYPE_NO_DEVICE
)paren
)paren
(brace
multiline_comment|/* only access this, if there was a valid device addressed */
r_if
c_cond
(paren
op_decrement
id|disk_rw_in_progress
op_eq
l_int|0
)paren
id|PS2_DISK_LED_OFF
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* IBM describes the status-mask to be 0x1e, but this is not conform&n;    * with SCSI-definition, I suppose, the reason for it is that IBM&n;    * adapters do not support CMD_TERMINATED, TASK_SET_FULL and&n;    * ACA_ACTIVE as returning statusbyte information. (ML) */
r_if
c_cond
(paren
id|cmd_result
op_eq
id|IM_CMD_COMPLETED_WITH_FAILURE
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
r_int
r_char
)paren
(paren
id|ld
c_func
(paren
id|ihost_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.dev_status
op_amp
l_int|0x1e
)paren
suffix:semicolon
id|IBM_DS
c_func
(paren
id|ihost_index
)paren
dot
id|total_errors
op_increment
suffix:semicolon
)brace
r_else
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* write device status into cmd-&gt;result, and call done function */
r_if
c_cond
(paren
id|lastSCSI
op_eq
id|NO_SCSI
)paren
(brace
multiline_comment|/* unexpected interrupt :-( */
id|cmd-&gt;result
op_or_assign
id|DID_BAD_INTR
op_lshift
l_int|16
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: WARNING - Interrupt from non-pending SCSI-command!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* things went right :-) */
id|cmd-&gt;result
op_or_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|issue_cmd
r_static
r_void
id|issue_cmd
(paren
r_int
id|host_index
comma
r_int
r_int
id|cmd_reg
comma
r_int
r_char
id|attn_reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* must wait for attention reg not busy */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|IBMLOCK
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|IM_STAT_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
id|IM_BUSY
)paren
)paren
r_break
suffix:semicolon
id|IBMUNLOCK
)brace
multiline_comment|/* write registers and enable system interrupts */
id|outl
(paren
id|cmd_reg
comma
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|outb
(paren
id|attn_reg
comma
id|IM_ATTN_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|IBMUNLOCK
r_return
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|cmd-&gt;SCp.Status
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* SCSI-SCB-command for device_inquiry */
DECL|function|device_inquiry
r_static
r_int
id|device_inquiry
c_func
(paren
r_int
id|host_index
comma
r_int
id|ldn
)paren
(brace
r_int
id|retr
suffix:semicolon
r_struct
id|im_scb
op_star
id|scb
suffix:semicolon
r_struct
id|im_tsb
op_star
id|tsb
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|scb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|scb
)paren
suffix:semicolon
id|tsb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|tsb
)paren
suffix:semicolon
id|buf
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|buf
)paren
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.dev_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* prepare statusblock */
r_for
c_loop
(paren
id|retr
op_assign
l_int|0
suffix:semicolon
id|retr
OL
l_int|3
suffix:semicolon
id|retr
op_increment
)paren
(brace
multiline_comment|/* fill scb with inquiry command */
id|scb-&gt;command
op_assign
id|IM_DEVICE_INQUIRY_CMD
op_or
id|IM_NO_DISCONNECT
suffix:semicolon
id|scb-&gt;enable
op_assign
id|IM_REPORT_TSB_ONLY_ON_ERROR
op_or
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
op_or
id|IM_RETRY_ENABLE
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_DEVICE_INQUIRY_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_SCB
suffix:semicolon
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
id|scb-&gt;sys_buf_length
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* maximum bufferlength gives max info */
id|scb-&gt;tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
id|tsb
)paren
suffix:semicolon
multiline_comment|/* issue scb to passed ldn, and busy wait for interrupt */
id|got_interrupt
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|host_index
comma
id|virt_to_bus
c_func
(paren
id|scb
)paren
comma
id|IM_SCB
op_or
id|ldn
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
c_func
(paren
id|host_index
)paren
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if command succesful, break */
r_if
c_cond
(paren
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_SCB_CMD_COMPLETED
)paren
op_logical_or
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_SCB_CMD_COMPLETED_WITH_RETRIES
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*if all three retries failed, return &quot;no device at this ldn&quot; */
r_if
c_cond
(paren
id|retr
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|read_capacity
r_static
r_int
id|read_capacity
c_func
(paren
r_int
id|host_index
comma
r_int
id|ldn
)paren
(brace
r_int
id|retr
suffix:semicolon
r_struct
id|im_scb
op_star
id|scb
suffix:semicolon
r_struct
id|im_tsb
op_star
id|tsb
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|scb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|scb
)paren
suffix:semicolon
id|tsb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|tsb
)paren
suffix:semicolon
id|buf
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|buf
)paren
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.dev_status
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|retr
op_assign
l_int|0
suffix:semicolon
id|retr
OL
l_int|3
suffix:semicolon
id|retr
op_increment
)paren
(brace
multiline_comment|/*fill scb with read capacity command */
id|scb-&gt;command
op_assign
id|IM_READ_CAPACITY_CMD
suffix:semicolon
id|scb-&gt;enable
op_assign
id|IM_REPORT_TSB_ONLY_ON_ERROR
op_or
id|IM_READ_CONTROL
op_or
id|IM_RETRY_ENABLE
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_READ_CAPACITY_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_SCB
suffix:semicolon
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
id|scb-&gt;sys_buf_length
op_assign
l_int|8
suffix:semicolon
id|scb-&gt;tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
id|tsb
)paren
suffix:semicolon
multiline_comment|/*issue scb to passed ldn, and busy wait for interrupt */
id|got_interrupt
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|host_index
comma
id|virt_to_bus
c_func
(paren
id|scb
)paren
comma
id|IM_SCB
op_or
id|ldn
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
c_func
(paren
id|host_index
)paren
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if got capacity, get block length and return one device found */
r_if
c_cond
(paren
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_SCB_CMD_COMPLETED
)paren
op_logical_or
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_SCB_CMD_COMPLETED_WITH_RETRIES
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*if all three retries failed, return &quot;no device at this ldn&quot; */
r_if
c_cond
(paren
id|retr
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|get_pos_info
r_static
r_int
id|get_pos_info
c_func
(paren
r_int
id|host_index
)paren
(brace
r_int
id|retr
suffix:semicolon
r_struct
id|im_scb
op_star
id|scb
suffix:semicolon
r_struct
id|im_tsb
op_star
id|tsb
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|scb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
dot
id|scb
)paren
suffix:semicolon
id|tsb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
dot
id|tsb
)paren
suffix:semicolon
id|buf
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
dot
id|buf
)paren
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
dot
id|tsb.dev_status
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|retr
op_assign
l_int|0
suffix:semicolon
id|retr
OL
l_int|3
suffix:semicolon
id|retr
op_increment
)paren
(brace
multiline_comment|/*fill scb with get_pos_info command */
id|scb-&gt;command
op_assign
id|IM_GET_POS_INFO_CMD
suffix:semicolon
id|scb-&gt;enable
op_assign
id|IM_READ_CONTROL
op_or
id|IM_REPORT_TSB_ONLY_ON_ERROR
op_or
id|IM_RETRY_ENABLE
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
op_assign
id|IM_GET_POS_INFO_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
op_assign
id|IM_SCB
suffix:semicolon
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|special
c_func
(paren
id|host_index
)paren
op_eq
id|IBM_SCSI2_FW
)paren
id|scb-&gt;sys_buf_length
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* get all info from F/W adapter */
r_else
id|scb-&gt;sys_buf_length
op_assign
l_int|18
suffix:semicolon
multiline_comment|/* get exactly 18 bytes for other SCSI */
id|scb-&gt;tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
id|tsb
)paren
suffix:semicolon
multiline_comment|/*issue scb to ldn=15, and busy wait for interrupt */
id|got_interrupt
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|host_index
comma
id|virt_to_bus
c_func
(paren
id|scb
)paren
comma
id|IM_SCB
op_or
id|MAX_LOG_DEV
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
c_func
(paren
id|host_index
)paren
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if got POS-stuff, get block length and return one device found */
r_if
c_cond
(paren
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_SCB_CMD_COMPLETED
)paren
op_logical_or
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_SCB_CMD_COMPLETED_WITH_RETRIES
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* if all three retries failed, return &quot;no device at this ldn&quot; */
r_if
c_cond
(paren
id|retr
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* SCSI-immediate-command for assign. This functions maps/unmaps specific&n; ldn-numbers on SCSI (PUN,LUN). It is needed for presetting of the&n; subsystem and for dynamical remapping od ldns. */
DECL|function|immediate_assign
r_static
r_int
id|immediate_assign
c_func
(paren
r_int
id|host_index
comma
r_int
r_int
id|pun
comma
r_int
r_int
id|lun
comma
r_int
r_int
id|ldn
comma
r_int
r_int
id|operation
)paren
(brace
r_int
id|retr
suffix:semicolon
r_int
r_int
id|imm_cmd
suffix:semicolon
r_for
c_loop
(paren
id|retr
op_assign
l_int|0
suffix:semicolon
id|retr
OL
l_int|3
suffix:semicolon
id|retr
op_increment
)paren
(brace
multiline_comment|/* select mutation level of the SCSI-adapter */
r_switch
c_cond
(paren
id|special
c_func
(paren
id|host_index
)paren
)paren
(brace
r_case
id|IBM_SCSI2_FW
suffix:colon
id|imm_cmd
op_assign
(paren
r_int
r_int
)paren
(paren
id|IM_ASSIGN_IMM_CMD
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|lun
op_amp
l_int|7
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|operation
op_amp
l_int|1
)paren
op_lshift
l_int|23
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|pun
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
op_or
(paren
(paren
id|pun
op_amp
l_int|8
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|ldn
op_amp
l_int|15
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|imm_cmd
op_assign
id|inl
c_func
(paren
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|imm_cmd
op_and_assign
(paren
r_int
r_int
)paren
(paren
l_int|0xF8000000
)paren
suffix:semicolon
multiline_comment|/* keep reserved bits */
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
id|IM_ASSIGN_IMM_CMD
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|lun
op_amp
l_int|7
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|operation
op_amp
l_int|1
)paren
op_lshift
l_int|23
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|pun
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|ldn
op_amp
l_int|15
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
op_assign
id|IM_ASSIGN_IMM_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
op_assign
id|IM_IMM_CMD
suffix:semicolon
id|got_interrupt
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
id|issue_cmd
(paren
id|host_index
comma
(paren
r_int
r_int
)paren
(paren
id|imm_cmd
)paren
comma
id|IM_IMM_CMD
op_or
id|MAX_LOG_DEV
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
c_func
(paren
id|host_index
)paren
)paren
id|barrier
(paren
)paren
suffix:semicolon
multiline_comment|/*if command succesful, break */
r_if
c_cond
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_IMMEDIATE_CMD_COMPLETED
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retr
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|immediate_feature
r_static
r_int
id|immediate_feature
c_func
(paren
r_int
id|host_index
comma
r_int
r_int
id|speed
comma
r_int
r_int
id|timeout
)paren
(brace
r_int
id|retr
suffix:semicolon
r_int
r_int
id|imm_cmd
suffix:semicolon
r_for
c_loop
(paren
id|retr
op_assign
l_int|0
suffix:semicolon
id|retr
OL
l_int|3
suffix:semicolon
id|retr
op_increment
)paren
(brace
multiline_comment|/* select mutation level of the SCSI-adapter */
id|imm_cmd
op_assign
id|IM_FEATURE_CTR_IMM_CMD
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|speed
op_amp
l_int|0x7
)paren
op_lshift
l_int|29
)paren
suffix:semicolon
id|imm_cmd
op_or_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|timeout
op_amp
l_int|0x1fff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
op_assign
id|IM_FEATURE_CTR_IMM_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
op_assign
id|IM_IMM_CMD
suffix:semicolon
id|got_interrupt
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we need to run into command errors in order to probe for the&n;       * right speed! */
id|global_command_error_excuse
op_assign
l_int|1
suffix:semicolon
id|issue_cmd
(paren
id|host_index
comma
(paren
r_int
r_int
)paren
(paren
id|imm_cmd
)paren
comma
id|IM_IMM_CMD
op_or
id|MAX_LOG_DEV
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|got_interrupt
c_func
(paren
id|host_index
)paren
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|global_command_error_excuse
op_eq
id|CMD_FAIL
)paren
(brace
id|global_command_error_excuse
op_assign
l_int|0
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
r_else
id|global_command_error_excuse
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*if command succesful, break */
r_if
c_cond
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_IMMEDIATE_CMD_COMPLETED
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retr
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IBMMCA_SCSI_DEV_RESET
DECL|function|immediate_reset
r_static
r_int
id|immediate_reset
c_func
(paren
r_int
id|host_index
comma
r_int
r_int
id|ldn
)paren
(brace
r_int
id|retries
suffix:semicolon
r_int
id|ticks
suffix:semicolon
r_int
r_int
id|imm_command
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|0
suffix:semicolon
id|retries
OL
l_int|3
suffix:semicolon
id|retries
op_increment
)paren
(brace
id|imm_command
op_assign
id|inl
c_func
(paren
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|imm_command
op_and_assign
(paren
r_int
r_int
)paren
(paren
l_int|0xFFFF0000
)paren
suffix:semicolon
multiline_comment|/* keep reserved bits */
id|imm_command
op_or_assign
(paren
r_int
r_int
)paren
(paren
id|IM_RESET_IMM_CMD
)paren
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_RESET_IMM_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_IMM_CMD
suffix:semicolon
id|got_interrupt
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_IN_PROGRESS
suffix:semicolon
id|issue_cmd
(paren
id|host_index
comma
(paren
r_int
r_int
)paren
(paren
id|imm_command
)paren
comma
id|IM_IMM_CMD
op_or
id|ldn
)paren
suffix:semicolon
id|ticks
op_assign
id|IM_RESET_DELAY
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_eq
id|IM_RESET_IN_PROGRESS
op_logical_and
op_decrement
id|ticks
)paren
(brace
id|udelay
c_func
(paren
(paren
l_int|1
op_plus
l_int|999
op_div
id|HZ
)paren
op_star
l_int|1000
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* if reset did not complete, just complain */
r_if
c_cond
(paren
op_logical_neg
id|ticks
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: reset did not complete within %d seconds.&bslash;n&quot;
comma
id|IM_RESET_DELAY
)paren
suffix:semicolon
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_FINISHED_OK
suffix:semicolon
multiline_comment|/* did not work, finish */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*if command succesful, break */
r_if
c_cond
(paren
id|stat_result
c_func
(paren
id|host_index
)paren
op_eq
id|IM_IMMEDIATE_CMD_COMPLETED
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retries
op_ge
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* type-interpreter for physical device numbers */
DECL|function|ti_p
r_static
r_char
op_star
id|ti_p
c_func
(paren
r_int
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|dev
)paren
(brace
r_case
id|TYPE_IBM_SCSI_ADAPTER
suffix:colon
r_return
l_string|&quot;A&quot;
suffix:semicolon
r_case
id|TYPE_DISK
suffix:colon
r_return
l_string|&quot;D&quot;
suffix:semicolon
r_case
id|TYPE_TAPE
suffix:colon
r_return
l_string|&quot;T&quot;
suffix:semicolon
r_case
id|TYPE_PROCESSOR
suffix:colon
r_return
l_string|&quot;P&quot;
suffix:semicolon
r_case
id|TYPE_WORM
suffix:colon
r_return
l_string|&quot;W&quot;
suffix:semicolon
r_case
id|TYPE_ROM
suffix:colon
r_return
l_string|&quot;R&quot;
suffix:semicolon
r_case
id|TYPE_SCANNER
suffix:colon
r_return
l_string|&quot;S&quot;
suffix:semicolon
r_case
id|TYPE_MOD
suffix:colon
r_return
l_string|&quot;M&quot;
suffix:semicolon
r_case
id|TYPE_MEDIUM_CHANGER
suffix:colon
r_return
l_string|&quot;C&quot;
suffix:semicolon
r_case
id|TYPE_NO_LUN
suffix:colon
r_return
l_string|&quot;+&quot;
suffix:semicolon
multiline_comment|/* show NO_LUN */
)brace
r_return
l_string|&quot;-&quot;
suffix:semicolon
multiline_comment|/* TYPE_NO_DEVICE and others */
)brace
multiline_comment|/* interpreter for logical device numbers (ldn) */
DECL|function|ti_l
r_static
r_char
op_star
id|ti_l
c_func
(paren
r_int
id|val
)paren
(brace
r_const
r_char
id|hex
(braket
l_int|16
)braket
op_assign
l_string|&quot;0123456789abcdef&quot;
suffix:semicolon
r_static
r_char
id|answer
(braket
l_int|2
)braket
suffix:semicolon
id|answer
(braket
l_int|1
)braket
op_assign
(paren
r_char
)paren
(paren
l_int|0x0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_le
id|MAX_LOG_DEV
)paren
id|answer
(braket
l_int|0
)braket
op_assign
id|hex
(braket
id|val
)braket
suffix:semicolon
r_else
id|answer
(braket
l_int|0
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
op_amp
id|answer
suffix:semicolon
)brace
multiline_comment|/* transfers bitpattern of the feature command to values in MHz */
DECL|function|ibmrate
r_static
r_char
op_star
id|ibmrate
c_func
(paren
r_int
r_int
id|speed
comma
r_int
id|i
)paren
(brace
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;5.00&quot;
suffix:colon
l_string|&quot;10.00&quot;
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;4.00&quot;
suffix:colon
l_string|&quot;8.00&quot;
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;3.33&quot;
suffix:colon
l_string|&quot;6.66&quot;
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;2.86&quot;
suffix:colon
l_string|&quot;5.00&quot;
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;2.50&quot;
suffix:colon
l_string|&quot;4.00&quot;
suffix:semicolon
r_case
l_int|5
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;2.22&quot;
suffix:colon
l_string|&quot;3.10&quot;
suffix:semicolon
r_case
l_int|6
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;2.00&quot;
suffix:colon
l_string|&quot;2.50&quot;
suffix:semicolon
r_case
l_int|7
suffix:colon
r_return
id|i
ques
c_cond
l_string|&quot;1.82&quot;
suffix:colon
l_string|&quot;2.00&quot;
suffix:semicolon
)brace
r_return
l_string|&quot;---&quot;
suffix:semicolon
)brace
DECL|function|probe_display
r_static
r_int
id|probe_display
c_func
(paren
r_int
id|what
)paren
(brace
r_static
r_int
id|rotator
op_assign
l_int|0
suffix:semicolon
r_const
r_char
id|rotor
(braket
)braket
op_assign
l_string|&quot;|/-&bslash;&bslash;&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|display_mode
op_amp
id|LED_DISP
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|what
)paren
(brace
id|outl
c_func
(paren
l_int|0x20202020
comma
id|MOD95_LED_PORT
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x20202020
comma
id|MOD95_LED_PORT
op_plus
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
l_char|&squot;S&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|7
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;C&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|6
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;S&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|5
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;I&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;i&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;n&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|2
)paren
suffix:semicolon
id|outb
c_func
(paren
l_char|&squot;i&squot;
comma
id|MOD95_LED_PORT
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_char
)paren
(paren
id|rotor
(braket
id|rotator
)braket
)paren
comma
id|MOD95_LED_PORT
)paren
suffix:semicolon
id|rotator
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rotator
OG
l_int|3
)paren
id|rotator
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|probe_bus_mode
r_static
r_int
id|probe_bus_mode
c_func
(paren
r_int
id|host_index
)paren
(brace
r_struct
id|im_pos_info
op_star
id|info
suffix:semicolon
r_int
id|num_bus
op_assign
l_int|0
suffix:semicolon
r_int
id|ldn
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|im_pos_info
op_star
)paren
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|MAX_LOG_DEV
)braket
dot
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_pos_info
c_func
(paren
id|host_index
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;connector_size
op_amp
l_int|0xf000
)paren
id|subsystem_connector_size
c_func
(paren
id|host_index
)paren
op_assign
l_int|16
suffix:semicolon
r_else
id|subsystem_connector_size
c_func
(paren
id|host_index
)paren
op_assign
l_int|32
suffix:semicolon
id|num_bus
op_or_assign
(paren
id|info-&gt;pos_4b
op_amp
l_int|8
)paren
op_rshift
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|ldn
op_assign
l_int|0
suffix:semicolon
id|ldn
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|ldn
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|special
c_func
(paren
id|host_index
)paren
op_eq
id|IBM_SCSI_WCACHE
)paren
op_logical_or
(paren
id|special
c_func
(paren
id|host_index
)paren
op_eq
id|IBM_7568_WCACHE
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|info-&gt;cache_stat
op_rshift
id|ldn
)paren
op_amp
l_int|1
)paren
)paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cache_flag
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|info-&gt;retry_stat
op_rshift
id|ldn
)paren
op_amp
l_int|1
)paren
)paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|retry_flag
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: SCSI-Cache bits: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ldn
op_assign
l_int|0
suffix:semicolon
id|ldn
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|ldn
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d&quot;
comma
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cache_flag
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nIBM MCA SCSI: SCSI-Retry bits: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ldn
op_assign
l_int|0
suffix:semicolon
id|ldn
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|ldn
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d&quot;
comma
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|retry_flag
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|num_bus
suffix:semicolon
)brace
multiline_comment|/* probing scsi devices */
DECL|function|check_devices
r_static
r_void
id|check_devices
(paren
r_int
id|host_index
comma
r_int
id|adaptertype
)paren
(brace
r_int
id|id
comma
id|lun
comma
id|ldn
comma
id|ticks
suffix:semicolon
r_int
id|count_devices
suffix:semicolon
multiline_comment|/* local counter for connected device */
r_int
id|max_pun
suffix:semicolon
r_int
id|num_bus
suffix:semicolon
r_int
id|speedrun
suffix:semicolon
multiline_comment|/* local adapter_speed check variable */
multiline_comment|/* assign default values to certain variables */
id|ticks
op_assign
l_int|0
suffix:semicolon
id|count_devices
op_assign
l_int|0
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dyn_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* normally no need for dynamical ldn management */
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set errorcounter to 0 */
id|next_ldn
c_func
(paren
id|host_index
)paren
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* next ldn to be assigned is 7, because 0-6 is &squot;hardwired&squot;*/
multiline_comment|/* initialize the very important driver-informational arrays/structs */
id|memset
(paren
id|ld
c_func
(paren
id|host_index
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|ld
c_func
(paren
id|host_index
)paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ldn
op_assign
l_int|0
suffix:semicolon
id|ldn
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|ldn
op_increment
)paren
(brace
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|NO_SCSI
suffix:semicolon
multiline_comment|/* emptify last SCSI-command storage */
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
l_int|0
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cache_flag
op_assign
l_int|1
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|retry_flag
op_assign
l_int|1
suffix:semicolon
)brace
id|memset
(paren
id|get_ldn
c_func
(paren
id|host_index
)paren
comma
id|TYPE_NO_DEVICE
comma
r_sizeof
(paren
id|get_ldn
c_func
(paren
id|host_index
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* this is essential ! */
id|memset
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
comma
id|TYPE_NO_DEVICE
comma
r_sizeof
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* this is essential ! */
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
(brace
multiline_comment|/* mark the adapter at its pun on all luns*/
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)braket
(braket
id|lun
)braket
op_assign
id|TYPE_IBM_SCSI_ADAPTER
suffix:semicolon
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)braket
(braket
id|lun
)braket
op_assign
id|MAX_LOG_DEV
suffix:semicolon
multiline_comment|/* make sure, the subsystem&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;  ldn is active for all&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;  luns. */
)brace
id|probe_display
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Supercool display usage during SCSI-probing. */
multiline_comment|/* This makes sense, when booting without any */
multiline_comment|/* monitor connected on model XX95. */
multiline_comment|/* STEP 1: */
id|adapter_speed
c_func
(paren
id|host_index
)paren
op_assign
id|global_adapter_speed
suffix:semicolon
id|speedrun
op_assign
id|adapter_speed
c_func
(paren
id|host_index
)paren
suffix:semicolon
r_while
c_loop
(paren
id|immediate_feature
c_func
(paren
id|host_index
comma
id|speedrun
comma
id|adapter_timeout
)paren
op_eq
l_int|2
)paren
(brace
id|probe_display
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speedrun
op_eq
l_int|7
)paren
id|panic
c_func
(paren
l_string|&quot;IBM MCA SCSI: Cannot set Synchronous-Transfer-Rate!&bslash;n&quot;
)paren
suffix:semicolon
id|speedrun
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|speedrun
OG
l_int|7
)paren
id|speedrun
op_assign
l_int|7
suffix:semicolon
)brace
id|adapter_speed
c_func
(paren
id|host_index
)paren
op_assign
id|speedrun
suffix:semicolon
multiline_comment|/* Get detailed information about the current adapter, necessary for&n;    * device operations: */
id|num_bus
op_assign
id|probe_bus_mode
c_func
(paren
id|host_index
)paren
suffix:semicolon
multiline_comment|/* num_bus contains only valid data for the F/W adapter! */
r_if
c_cond
(paren
id|adaptertype
op_eq
id|IBM_SCSI2_FW
)paren
(brace
multiline_comment|/* F/W SCSI adapter: */
multiline_comment|/* F/W adapter PUN-space extension evaluation: */
r_if
c_cond
(paren
id|num_bus
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Seperate bus mode (wide-addressing enabled)&bslash;n&quot;
)paren
suffix:semicolon
id|subsystem_maxid
c_func
(paren
id|host_index
)paren
op_assign
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Combined bus mode (wide-addressing disabled)&bslash;n&quot;
)paren
suffix:semicolon
id|subsystem_maxid
c_func
(paren
id|host_index
)paren
op_assign
l_int|8
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Sync.-Rate (F/W: 20, Int.: 10, Ext.: %s) MBytes/s&bslash;n&quot;
comma
id|ibmrate
c_func
(paren
id|speedrun
comma
id|adaptertype
)paren
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* all other IBM SCSI adapters: */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Synchronous-SCSI-Transfer-Rate: %s MBytes/s&bslash;n&quot;
comma
id|ibmrate
c_func
(paren
id|speedrun
comma
id|adaptertype
)paren
)paren
suffix:semicolon
multiline_comment|/* assign correct PUN device space */
id|max_pun
op_assign
id|subsystem_maxid
c_func
(paren
id|host_index
)paren
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Current SCSI-host index: %d&bslash;n&quot;
comma
id|host_index
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Removing default logical SCSI-device mapping.&quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Dev. Order: %s, Mapping (takes &lt;2min): &quot;
comma
(paren
id|ibm_ansi_order
)paren
ques
c_cond
l_string|&quot;ANSI&quot;
suffix:colon
l_string|&quot;New&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|ldn
op_assign
l_int|0
suffix:semicolon
id|ldn
OL
id|MAX_LOG_DEV
suffix:semicolon
id|ldn
op_increment
)paren
(brace
id|probe_display
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
macro_line|#endif
id|immediate_assign
c_func
(paren
id|host_index
comma
l_int|0
comma
l_int|0
comma
id|ldn
comma
id|REMOVE_LDN
)paren
suffix:semicolon
multiline_comment|/* remove ldn (wherever)*/
)brace
id|lun
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default lun is 0 */
macro_line|#ifndef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;cleared,&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* STEP 2: */
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;&bslash;nIBM MCA SCSI: Scanning SCSI-devices.&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
suffix:semicolon
id|id
op_increment
)paren
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
macro_line|#endif
(brace
id|probe_display
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|id
op_ne
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
(brace
multiline_comment|/* if pun is not the adapter: */
multiline_comment|/* set ldn=0 to pun,lun*/
id|immediate_assign
c_func
(paren
id|host_index
comma
id|id
comma
id|lun
comma
id|PROBE_LDN
comma
id|SET_LDN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_inquiry
c_func
(paren
id|host_index
comma
id|PROBE_LDN
)paren
)paren
(brace
multiline_comment|/* probe device */
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|PROBE_LDN
)braket
dot
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* entry, even for NO_LUN */
r_if
c_cond
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|PROBE_LDN
)braket
dot
id|buf
(braket
l_int|0
)braket
op_ne
id|TYPE_NO_LUN
)paren
id|count_devices
op_increment
suffix:semicolon
multiline_comment|/* a existing device is found */
)brace
multiline_comment|/* remove ldn */
id|immediate_assign
c_func
(paren
id|host_index
comma
id|id
comma
id|lun
comma
id|PROBE_LDN
comma
id|REMOVE_LDN
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifndef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;scanned,&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* STEP 3: */
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;&bslash;nIBM MCA SCSI: Mapping SCSI-devices.&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ldn
op_assign
l_int|0
suffix:semicolon
id|lun
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
op_logical_and
id|ldn
OL
id|MAX_LOG_DEV
suffix:semicolon
id|lun
op_increment
)paren
macro_line|#endif
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
op_logical_and
id|ldn
OL
id|MAX_LOG_DEV
suffix:semicolon
id|id
op_increment
)paren
(brace
id|probe_display
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|id
op_ne
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
(brace
r_if
c_cond
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_ne
id|TYPE_NO_LUN
op_logical_and
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_ne
id|TYPE_NO_DEVICE
)paren
(brace
multiline_comment|/* Only map if accepted type. Always enter for&n;&t;       lun == 0 to get no gaps into ldn-mapping for ldn&lt;7. */
id|immediate_assign
c_func
(paren
id|host_index
comma
id|id
comma
id|lun
comma
id|ldn
comma
id|SET_LDN
)paren
suffix:semicolon
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
id|ldn
suffix:semicolon
multiline_comment|/* map ldn */
r_if
c_cond
(paren
id|device_exists
(paren
id|host_index
comma
id|ldn
comma
op_amp
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|block_length
comma
op_amp
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
)paren
)paren
(brace
macro_line|#ifdef CONFIG_IBMMCA_SCSI_DEV_RESET
id|printk
c_func
(paren
l_string|&quot;resetting device at ldn=%x ... &quot;
comma
id|ldn
)paren
suffix:semicolon
id|immediate_reset
c_func
(paren
id|host_index
comma
id|ldn
)paren
suffix:semicolon
macro_line|#endif
id|ldn
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* device vanished, probably because we don&squot;t know how to&n;&t;&t;  * handle it or because it has problems */
r_if
c_cond
(paren
id|lun
OG
l_int|0
)paren
(brace
multiline_comment|/* remove mapping */
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
id|TYPE_NO_DEVICE
suffix:semicolon
id|immediate_assign
c_func
(paren
id|host_index
comma
l_int|0
comma
l_int|0
comma
id|ldn
comma
id|REMOVE_LDN
)paren
suffix:semicolon
)brace
r_else
id|ldn
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|lun
op_eq
l_int|0
)paren
(brace
multiline_comment|/* map lun == 0, even if no device exists */
id|immediate_assign
c_func
(paren
id|host_index
comma
id|id
comma
id|lun
comma
id|ldn
comma
id|SET_LDN
)paren
suffix:semicolon
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
id|ldn
suffix:semicolon
multiline_comment|/* map ldn */
id|ldn
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* STEP 4: */
multiline_comment|/* map remaining ldns to non-existing devices */
r_for
c_loop
(paren
id|lun
op_assign
l_int|1
suffix:semicolon
id|lun
OL
l_int|8
op_logical_and
id|ldn
OL
id|MAX_LOG_DEV
suffix:semicolon
id|lun
op_increment
)paren
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
op_logical_and
id|ldn
OL
id|MAX_LOG_DEV
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_eq
id|TYPE_NO_LUN
op_logical_or
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_eq
id|TYPE_NO_DEVICE
)paren
(brace
id|probe_display
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Map remaining ldns only to NON-existing pun,lun&n;&t;    combinations to make sure an inquiry will fail.&n;&t;    For MULTI_LUN, it is needed to avoid adapter autonome&n;&t;    SCSI-remapping. */
id|immediate_assign
c_func
(paren
id|host_index
comma
id|id
comma
id|lun
comma
id|ldn
comma
id|SET_LDN
)paren
suffix:semicolon
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
id|ldn
suffix:semicolon
id|ldn
op_increment
suffix:semicolon
)brace
)brace
macro_line|#ifndef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;mapped.&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
r_if
c_cond
(paren
id|ibm_ansi_order
)paren
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Device order: IBM/ANSI (pun=7 is first).&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Device order: New Industry Standard (pun=0 is first).&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IM_DEBUG_PROBE
multiline_comment|/* Show the physical and logical mapping during boot. */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Determined SCSI-device-mapping:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    Physical SCSI-Device Map               Logical SCSI-Device Map&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ID&bslash;&bslash;LUN  0  1  2  3  4  5  6  7       ID&bslash;&bslash;LUN  0  1  2  3  4  5  6  7&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
suffix:semicolon
id|id
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2d     &quot;
comma
id|id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2s &quot;
comma
id|ti_p
c_func
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      %2d     &quot;
comma
id|id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2s &quot;
comma
id|ti_l
c_func
(paren
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* assign total number of found SCSI-devices to the statistics struct */
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_scsi_devices
op_assign
id|count_devices
suffix:semicolon
multiline_comment|/* decide for output in /proc-filesystem, if the configuration of&n;      SCSI-devices makes dynamical reassignment of devices necessary */
r_if
c_cond
(paren
id|count_devices
op_ge
id|MAX_LOG_DEV
)paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dyn_flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* dynamical assignment is necessary */
r_else
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dyn_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dynamical assignment is not necessary */
multiline_comment|/* If no SCSI-devices are assigned, return 1 in order to cause message. */
r_if
c_cond
(paren
id|ldn
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Warning: No SCSI-devices found/assigned!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reset the counters for statistics on the current adapter */
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|scbs
op_assign
l_int|0
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|long_scbs
op_assign
l_int|0
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_accesses
op_assign
l_int|0
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_interrupts
op_assign
l_int|0
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dynamical_assignments
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_access
comma
l_int|0x0
comma
r_sizeof
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_access
)paren
)paren
suffix:semicolon
id|memset
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_read_access
comma
l_int|0x0
comma
r_sizeof
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_read_access
)paren
)paren
suffix:semicolon
id|memset
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_write_access
comma
l_int|0x0
comma
r_sizeof
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_write_access
)paren
)paren
suffix:semicolon
id|memset
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_inquiry_access
comma
l_int|0x0
comma
r_sizeof
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_inquiry_access
)paren
)paren
suffix:semicolon
id|memset
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_modeselect_access
comma
l_int|0x0
comma
r_sizeof
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_modeselect_access
)paren
)paren
suffix:semicolon
id|memset
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_assignments
comma
l_int|0x0
comma
r_sizeof
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_assignments
)paren
)paren
suffix:semicolon
id|probe_display
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|device_exists
r_static
r_int
id|device_exists
(paren
r_int
id|host_index
comma
r_int
id|ldn
comma
r_int
op_star
id|block_length
comma
r_int
op_star
id|device_type
)paren
(brace
r_int
r_char
op_star
id|buf
suffix:semicolon
multiline_comment|/* if no valid device found, return immediately with 0 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|device_inquiry
c_func
(paren
id|host_index
comma
id|ldn
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|buf
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_ROM
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_ROM
suffix:semicolon
op_star
id|block_length
op_assign
l_int|2048
suffix:semicolon
multiline_comment|/* (standard blocksize for yellow-/red-book) */
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_WORM
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_WORM
suffix:semicolon
op_star
id|block_length
op_assign
l_int|2048
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_DISK
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_DISK
suffix:semicolon
r_if
c_cond
(paren
id|read_capacity
c_func
(paren
id|host_index
comma
id|ldn
)paren
)paren
(brace
op_star
id|block_length
op_assign
op_star
(paren
id|buf
op_plus
l_int|7
)paren
op_plus
(paren
op_star
(paren
id|buf
op_plus
l_int|6
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
op_star
(paren
id|buf
op_plus
l_int|5
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
op_star
(paren
id|buf
op_plus
l_int|4
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_MOD
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_MOD
suffix:semicolon
r_if
c_cond
(paren
id|read_capacity
c_func
(paren
id|host_index
comma
id|ldn
)paren
)paren
(brace
op_star
id|block_length
op_assign
op_star
(paren
id|buf
op_plus
l_int|7
)paren
op_plus
(paren
op_star
(paren
id|buf
op_plus
l_int|6
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
op_star
(paren
id|buf
op_plus
l_int|5
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
op_star
(paren
id|buf
op_plus
l_int|4
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_TAPE
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_TAPE
suffix:semicolon
op_star
id|block_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not in use (setting by mt and mtst in op.) */
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_PROCESSOR
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_PROCESSOR
suffix:semicolon
op_star
id|block_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* they set their stuff on drivers */
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_SCANNER
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_SCANNER
suffix:semicolon
op_star
id|block_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* they set their stuff on drivers */
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
id|TYPE_MEDIUM_CHANGER
)paren
(brace
op_star
id|device_type
op_assign
id|TYPE_MEDIUM_CHANGER
suffix:semicolon
op_star
id|block_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* One never knows, what to expect on a medium&n;&t;&t;&t;    changer device. */
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_ibmmca_scsi_setup
r_void
id|internal_ibmmca_scsi_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
comma
id|j
comma
id|io_base
comma
id|id_base
suffix:semicolon
r_char
op_star
id|token
suffix:semicolon
id|io_base
op_assign
l_int|0
suffix:semicolon
id|id_base
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|str
)paren
(brace
id|token
op_assign
id|strtok
c_func
(paren
id|str
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|token
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;activity&quot;
)paren
)paren
id|display_mode
op_or_assign
id|LED_ACTIVITY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;display&quot;
)paren
)paren
id|display_mode
op_or_assign
id|LED_DISP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;adisplay&quot;
)paren
)paren
id|display_mode
op_or_assign
id|LED_ADISP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;normal&quot;
)paren
)paren
id|ibm_ansi_order
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;ansi&quot;
)paren
)paren
id|ibm_ansi_order
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;fast&quot;
)paren
)paren
id|global_adapter_speed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;medium&quot;
)paren
)paren
id|global_adapter_speed
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|token
comma
l_string|&quot;slow&quot;
)paren
)paren
id|global_adapter_speed
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|token
op_eq
l_char|&squot;-&squot;
)paren
op_logical_or
(paren
id|isdigit
c_func
(paren
op_star
id|token
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_mod
l_int|2
)paren
op_logical_and
(paren
id|io_base
OL
id|IM_MAX_HOSTS
)paren
)paren
id|io_port
(braket
id|io_base
op_increment
)braket
op_assign
id|simple_strtoul
c_func
(paren
id|token
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_mod
l_int|2
)paren
op_logical_and
(paren
id|id_base
OL
id|IM_MAX_HOSTS
)paren
)paren
id|scsi_id
(braket
id|id_base
op_increment
)braket
op_assign
id|simple_strtoul
c_func
(paren
id|token
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|token
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ints
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IM_MAX_HOSTS
op_logical_and
l_int|2
op_star
id|i
op_plus
l_int|2
OL
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_port
(braket
id|i
)braket
op_assign
id|ints
(braket
l_int|2
op_star
id|i
op_plus
l_int|2
)braket
suffix:semicolon
id|scsi_id
(braket
id|i
)braket
op_assign
id|ints
(braket
l_int|2
op_star
id|i
op_plus
l_int|2
)braket
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|ibmmca_getinfo
r_static
r_int
id|ibmmca_getinfo
(paren
r_char
op_star
id|buf
comma
r_int
id|slot
comma
r_void
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
id|len
comma
id|speciale
comma
id|connectore
comma
id|k
suffix:semicolon
r_int
r_int
id|pos
(braket
l_int|8
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IBMLOCK
id|shpnt
op_assign
id|dev
suffix:semicolon
multiline_comment|/* assign host-structure to local pointer */
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set filled text-buffer index to 0 */
multiline_comment|/* get the _special contents of the hostdata structure */
id|speciale
op_assign
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_special
suffix:semicolon
id|connectore
op_assign
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_connector_size
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|2
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
id|pos
(braket
id|k
)braket
op_assign
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_pos
(braket
id|k
)braket
suffix:semicolon
r_if
c_cond
(paren
id|speciale
op_eq
id|FORCED_DETECTION
)paren
(brace
multiline_comment|/* forced detection */
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Adapter category: forced detected&bslash;n&quot;
l_string|&quot;***************************************&bslash;n&quot;
l_string|&quot;***  Forced detected SCSI Adapter   ***&bslash;n&quot;
l_string|&quot;***  No chip-information available  ***&bslash;n&quot;
l_string|&quot;***************************************&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|speciale
op_eq
id|INTEGRATED_SCSI
)paren
(brace
multiline_comment|/* if the integrated subsystem has been found automatically: */
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Adapter category: integrated&bslash;n&quot;
l_string|&quot;Chip revision level: %d&bslash;n&quot;
l_string|&quot;Chip status: %s&bslash;n&quot;
l_string|&quot;8 kByte NVRAM status: %s&bslash;n&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|2
)paren
ques
c_cond
l_string|&quot;locked&quot;
suffix:colon
l_string|&quot;accessible&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|speciale
op_ge
l_int|0
)paren
op_logical_and
(paren
id|speciale
OL
(paren
r_sizeof
(paren
id|subsys_list
)paren
op_div
r_sizeof
(paren
r_struct
id|subsys_list_struct
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* if the subsystem is a slot adapter */
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Adapter category: slot-card&bslash;n&quot;
l_string|&quot;ROM Segment Address: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xf0
)paren
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;off&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;0x%x&bslash;n&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_lshift
l_int|13
)paren
op_plus
l_int|0xc0000
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Chip status: %s&bslash;n&quot;
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Adapter I/O Offset: 0x%x&bslash;n&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Adapter category: unknown&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* common subsystem information to write to the slotn file */
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Subsystem PUN: %d&bslash;n&quot;
comma
id|shpnt-&gt;this_id
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;I/O base address range: 0x%x-0x%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|shpnt-&gt;io_port
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|shpnt-&gt;io_port
op_plus
l_int|7
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;MCA-slot size: %d bits&quot;
comma
id|connectore
)paren
suffix:semicolon
multiline_comment|/* Now make sure, the bufferlength is devidable by 4 to avoid&n;    * paging problems of the buffer. */
r_while
c_loop
(paren
id|len
op_mod
r_sizeof
(paren
r_int
)paren
op_ne
(paren
r_sizeof
(paren
r_int
)paren
op_minus
l_int|1
)paren
)paren
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|IBMUNLOCK
r_return
id|len
suffix:semicolon
)brace
DECL|function|ibmmca_detect
r_int
id|ibmmca_detect
(paren
id|Scsi_Host_Template
op_star
id|scsi_template
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
id|port
comma
id|id
comma
id|i
comma
id|j
comma
id|k
comma
id|list_size
comma
id|slot
suffix:semicolon
r_int
id|devices_on_irq_11
op_assign
l_int|0
suffix:semicolon
r_int
id|devices_on_irq_14
op_assign
l_int|0
suffix:semicolon
r_int
id|IRQ14_registered
op_assign
l_int|0
suffix:semicolon
r_int
id|IRQ11_registered
op_assign
l_int|0
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* make absolutely sure, that found is set to 0 */
multiline_comment|/* First of all, print the version number of the driver. This is&n;    * important to allow better user bugreports in case of already&n;    * having problems with the MCA_bus probing. */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Version %s&bslash;n&quot;
comma
id|IBMMCA_SCSI_DRIVER_VERSION
)paren
suffix:semicolon
multiline_comment|/* if this is not MCA machine, return &quot;nothing found&quot; */
r_if
c_cond
(paren
op_logical_neg
id|MCA_bus
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI:  No Microchannel-bus present --&gt; Aborting.&bslash;n&quot;
l_string|&quot;      &t;     This machine does not have any IBM MCA-bus&bslash;n&quot;
l_string|&quot;    &t;     or the MCA-Kernel-support is not enabled!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* If the driver is run as module, read from conf.modules or cmd-line */
r_if
c_cond
(paren
id|boot_options
)paren
id|option_setup
c_func
(paren
id|boot_options
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* get interrupt request level */
r_if
c_cond
(paren
id|request_irq
(paren
id|IM_IRQ
comma
id|interrupt_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;ibmmcascsi&quot;
comma
id|hosts
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to get shared IRQ %d.&bslash;n&quot;
comma
id|IM_IRQ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|IRQ14_registered
op_increment
suffix:semicolon
multiline_comment|/* if ibmmcascsi setup option was passed to kernel, return &quot;found&quot; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IM_MAX_HOSTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|io_port
(braket
id|i
)braket
OG
l_int|0
op_logical_and
id|scsi_id
(braket
id|i
)braket
op_ge
l_int|0
op_logical_and
id|scsi_id
(braket
id|i
)braket
OL
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: forced detected SCSI Adapter, io=0x%x, scsi id=%d.&bslash;n&quot;
comma
id|io_port
(braket
id|i
)braket
comma
id|scsi_id
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shpnt
op_assign
id|ibmmca_register
c_func
(paren
id|scsi_template
comma
id|io_port
(braket
id|i
)braket
comma
id|scsi_id
(braket
id|i
)braket
comma
id|FORCED_DETECTION
comma
l_string|&quot;forced detected SCSI Adapter&quot;
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|2
suffix:semicolon
id|k
OL
l_int|7
suffix:semicolon
id|k
op_increment
)paren
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_pos
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_special
op_assign
id|FORCED_DETECTION
suffix:semicolon
id|mca_set_adapter_name
c_func
(paren
id|MCA_INTEGSCSI
comma
l_string|&quot;forced detected SCSI Adapter&quot;
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|MCA_INTEGSCSI
comma
(paren
id|MCA_ProcFn
)paren
id|ibmmca_getinfo
comma
id|shpnt
)paren
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|MCA_INTEGSCSI
)paren
suffix:semicolon
id|devices_on_irq_14
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found
)paren
r_return
id|found
suffix:semicolon
multiline_comment|/* The POS2-register of all PS/2 model SCSI-subsystems has the following&n;    * interpretation of bits:&n;    *                             Bit 7 - 4 : Chip Revision ID (Release)&n;    *                             Bit 3 - 2 : Reserved&n;    *                             Bit 1     : 8k NVRAM Disabled&n;    *                             Bit 0     : Chip Enable (EN-Signal)&n;    * The POS3-register is interpreted as follows:&n;    *                             Bit 7 - 5 : SCSI ID&n;    *                             Bit 4     : Reserved = 0&n;    *                             Bit 3 - 0 : Reserved = 0&n;    * (taken from &quot;IBM, PS/2 Hardware Interface Technical Reference, Common&n;    * Interfaces (1991)&quot;).&n;    * In short words, this means, that IBM PS/2 machines only support&n;    * 1 single subsystem by default. The slot-adapters must have another&n;    * configuration on pos2. Here, one has to assume the following&n;    * things for POS2-register:&n;    *                             Bit 7 - 4 : Chip Revision ID (Release)&n;    *                             Bit 3 - 1 : port offset factor&n;    *                             Bit 0     : Chip Enable (EN-Signal)&n;    * As I found a patch here, setting the IO-registers to 0x3540 forced,&n;    * as there was a 0x05 in POS2 on a model 56, I assume, that the&n;    * port 0x3540 must be fix for integrated SCSI-controllers.&n;    * Ok, this discovery leads to the following implementation: (M.Lang) */
multiline_comment|/* first look for the IBM SCSI integrated subsystem on the motherboard */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
multiline_comment|/* read the pos-information */
id|pos
(braket
id|j
)braket
op_assign
id|mca_read_stored_pos
c_func
(paren
id|MCA_INTEGSCSI
comma
id|j
)paren
suffix:semicolon
multiline_comment|/* pos2 = pos3 = 0xff if there is no integrated SCSI-subsystem present, but&n;    * if we ignore the settings of all surrounding pos registers, it is not&n;    * completely sufficient to only check pos2 and pos3. */
multiline_comment|/* Therefore, now the following if statement is used to&n;    * make sure, we see a real integrated onboard SCSI-interface and no&n;    * internal system information, which gets mapped to some pos registers&n;    * on models 95xx. */
r_if
c_cond
(paren
(paren
op_logical_neg
id|pos
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|pos
(braket
l_int|1
)braket
op_logical_and
id|pos
(braket
l_int|2
)braket
OG
l_int|0
op_logical_and
id|pos
(braket
l_int|3
)braket
OG
l_int|0
op_logical_and
op_logical_neg
id|pos
(braket
l_int|4
)braket
op_logical_and
op_logical_neg
id|pos
(braket
l_int|5
)braket
op_logical_and
op_logical_neg
id|pos
(braket
l_int|6
)braket
op_logical_and
op_logical_neg
id|pos
(braket
l_int|7
)braket
)paren
op_logical_or
(paren
id|pos
(braket
l_int|0
)braket
op_eq
l_int|0xff
op_logical_and
id|pos
(braket
l_int|1
)braket
op_eq
l_int|0xff
op_logical_and
id|pos
(braket
l_int|2
)braket
OL
l_int|0xff
op_logical_and
id|pos
(braket
l_int|3
)braket
OL
l_int|0xff
op_logical_and
id|pos
(braket
l_int|4
)braket
op_eq
l_int|0xff
op_logical_and
id|pos
(braket
l_int|5
)braket
op_eq
l_int|0xff
op_logical_and
id|pos
(braket
l_int|6
)braket
op_eq
l_int|0xff
op_logical_and
id|pos
(braket
l_int|7
)braket
op_eq
l_int|0xff
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
op_eq
l_int|1
)paren
multiline_comment|/* is the subsystem chip enabled ? */
id|port
op_assign
id|IM_IO_PORT
suffix:semicolon
r_else
(brace
multiline_comment|/* if disabled, no IRQs will be generated, as the chip won&squot;t&n;&t;      * listen to the incomming commands and will do really nothing,&n;&t;      * except for listening to the pos-register settings. If this&n;&t;      * happens, I need to hugely think about it, as one has to&n;&t;      * write something to the MCA-Bus pos register in order to&n;&t;      * enable the chip. Normally, IBM-SCSI won&squot;t pass the POST,&n;&t;      * when the chip is disabled (see IBM tech. ref.). */
id|port
op_assign
id|IM_IO_PORT
suffix:semicolon
multiline_comment|/* anyway, set the portnumber and warn */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: WARNING - Your SCSI-subsystem is disabled!&bslash;n&quot;
l_string|&quot;              SCSI-operations may not work.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|id
op_assign
(paren
id|pos
(braket
l_int|3
)braket
op_amp
l_int|0xe0
)paren
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* this is correct and represents the PUN */
multiline_comment|/* give detailed information on the subsystem. This helps me&n;       * additionally during debugging and analyzing bug-reports. */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: IBM Integrated SCSI Controller found, io=0x%x, scsi id=%d,&bslash;n&quot;
l_string|&quot;              chip rev.=%d, 8K NVRAM=%s, subsystem=%s&bslash;n&quot;
comma
id|port
comma
id|id
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|2
)paren
ques
c_cond
l_string|&quot;locked&quot;
suffix:colon
l_string|&quot;accessible&quot;
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;enabled.&quot;
suffix:colon
l_string|&quot;disabled.&quot;
)paren
suffix:semicolon
multiline_comment|/* register the found integrated SCSI-subsystem */
r_if
c_cond
(paren
(paren
id|shpnt
op_assign
id|ibmmca_register
c_func
(paren
id|scsi_template
comma
id|port
comma
id|id
comma
id|INTEGRATED_SCSI
comma
l_string|&quot;IBM Integrated SCSI Controller&quot;
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|2
suffix:semicolon
id|k
OL
l_int|7
suffix:semicolon
id|k
op_increment
)paren
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_pos
(braket
id|k
)braket
op_assign
id|pos
(braket
id|k
)braket
suffix:semicolon
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_special
op_assign
id|INTEGRATED_SCSI
suffix:semicolon
id|mca_set_adapter_name
c_func
(paren
id|MCA_INTEGSCSI
comma
l_string|&quot;IBM Integrated SCSI Controller&quot;
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|MCA_INTEGSCSI
comma
(paren
id|MCA_ProcFn
)paren
id|ibmmca_getinfo
comma
id|shpnt
)paren
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|MCA_INTEGSCSI
)paren
suffix:semicolon
id|devices_on_irq_14
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* now look for other adapters in MCA slots, */
multiline_comment|/* determine the number of known IBM-SCSI-subsystem types */
multiline_comment|/* see the pos[2] dependence to get the adapter port-offset. */
id|list_size
op_assign
r_sizeof
(paren
id|subsys_list
)paren
op_div
r_sizeof
(paren
r_struct
id|subsys_list_struct
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|list_size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* scan each slot for a fitting adapter id */
id|slot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* start at slot 0 */
r_while
c_loop
(paren
(paren
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|subsys_list
(braket
id|i
)braket
dot
id|mca_id
comma
id|slot
)paren
)paren
op_ne
id|MCA_NOTFOUND
)paren
(brace
multiline_comment|/* scan through all slots */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
multiline_comment|/* read the pos-information */
id|pos
(braket
id|j
)braket
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
op_eq
l_int|1
)paren
multiline_comment|/* is the subsystem chip enabled ? */
multiline_comment|/* (explanations see above) */
id|port
op_assign
id|IM_IO_PORT
op_plus
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* anyway, set the portnumber and warn */
id|port
op_assign
id|IM_IO_PORT
op_plus
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: WARNING - Your SCSI-subsystem is disabled!&bslash;n&quot;
l_string|&quot;              SCSI-operations may not work.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
op_logical_and
(paren
id|pos
(braket
l_int|6
)braket
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: ERROR - Wrong POS(6)-register setting!&bslash;n&quot;
l_string|&quot;              Impossible to determine adapter PUN!&bslash;n&quot;
l_string|&quot;              Guessing adapter PUN = 7.&bslash;n&quot;
)paren
suffix:semicolon
id|id
op_assign
l_int|7
suffix:semicolon
)brace
r_else
(brace
id|id
op_assign
(paren
id|pos
(braket
l_int|3
)braket
op_amp
l_int|0xe0
)paren
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* get subsystem PUN */
r_if
c_cond
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
(brace
id|id
op_or_assign
(paren
id|pos
(braket
l_int|3
)braket
op_amp
l_int|0x10
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* get subsystem PUN high-bit&n;&t;&t;&t;&t;&t;    * for F/W adapters */
)brace
)brace
r_if
c_cond
(paren
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
op_logical_and
(paren
id|pos
(braket
l_int|4
)braket
op_amp
l_int|0x01
)paren
op_logical_and
(paren
id|pos
(braket
l_int|6
)braket
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* IRQ11 is used by SCSI-2 F/W Adapter/A */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: SCSI-2 F/W adapter needs IRQ 11.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* get interrupt request level */
r_if
c_cond
(paren
id|request_irq
(paren
id|IM_IRQ_FW
comma
id|interrupt_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;ibmmcascsi&quot;
comma
id|hosts
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to get shared IRQ %d.&bslash;n&quot;
comma
id|IM_IRQ_FW
)paren
suffix:semicolon
)brace
r_else
id|IRQ11_registered
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: %s found in slot %d, io=0x%x, scsi id=%d,&bslash;n&quot;
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
comma
id|slot
op_plus
l_int|1
comma
id|port
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xf0
)paren
id|printk
c_func
(paren
l_string|&quot;              ROM Addr.=off,&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;              ROM Addr.=0x%x,&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_lshift
l_int|13
)paren
op_plus
l_int|0xc0000
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; port-offset=0x%x, subsystem=%s&bslash;n&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;enabled.&quot;
suffix:colon
l_string|&quot;disabled.&quot;
)paren
suffix:semicolon
multiline_comment|/* register the hostadapter */
r_if
c_cond
(paren
(paren
id|shpnt
op_assign
id|ibmmca_register
c_func
(paren
id|scsi_template
comma
id|port
comma
id|id
comma
id|i
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|2
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_pos
(braket
id|k
)braket
op_assign
id|pos
(braket
id|k
)braket
suffix:semicolon
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_special
op_assign
id|i
suffix:semicolon
id|mca_set_adapter_name
(paren
id|slot
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
)paren
suffix:semicolon
id|mca_set_adapter_procfn
(paren
id|slot
comma
(paren
id|MCA_ProcFn
)paren
id|ibmmca_getinfo
comma
id|shpnt
)paren
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
op_logical_and
(paren
id|pos
(braket
l_int|4
)braket
op_amp
l_int|0x01
)paren
op_logical_and
(paren
id|pos
(braket
l_int|6
)braket
op_eq
l_int|0
)paren
)paren
id|devices_on_irq_11
op_increment
suffix:semicolon
r_else
id|devices_on_irq_14
op_increment
suffix:semicolon
)brace
id|slot
op_increment
suffix:semicolon
multiline_comment|/* advance to next slot */
)brace
multiline_comment|/* advance to next adapter id in the list of IBM-SCSI-subsystems*/
)brace
multiline_comment|/* now check for SCSI-adapters, mapped to the integrated SCSI&n;    * area. E.g. a W/Cache in MCA-slot 9(!). Do the check correct here,&n;    * as this is a known effect on some models 95xx. */
id|list_size
op_assign
r_sizeof
(paren
id|subsys_list
)paren
op_div
r_sizeof
(paren
r_struct
id|subsys_list_struct
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|list_size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* scan each slot for a fitting adapter id */
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|subsys_list
(braket
id|i
)braket
dot
id|mca_id
comma
id|MCA_INTEGSCSI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_ne
id|MCA_NOTFOUND
)paren
(brace
multiline_comment|/* scan through all slots */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
multiline_comment|/* read the pos-information */
id|pos
(braket
id|j
)braket
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* is the subsystem chip enabled ? */
multiline_comment|/* (explanations see above) */
id|port
op_assign
id|IM_IO_PORT
op_plus
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* anyway, set the portnumber and warn */
id|port
op_assign
id|IM_IO_PORT
op_plus
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: WARNING - Your SCSI-subsystem is disabled!&bslash;n&quot;
l_string|&quot;              SCSI-operations may not work.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
op_logical_and
(paren
id|pos
(braket
l_int|6
)braket
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: ERROR - Wrong POS(6)-register setting!&bslash;n&quot;
l_string|&quot;              Impossible to determine adapter PUN!&bslash;n&quot;
l_string|&quot;              Guessing adapter PUN = 7.&bslash;n&quot;
)paren
suffix:semicolon
id|id
op_assign
l_int|7
suffix:semicolon
)brace
r_else
(brace
id|id
op_assign
(paren
id|pos
(braket
l_int|3
)braket
op_amp
l_int|0xe0
)paren
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* get subsystem PUN */
r_if
c_cond
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
id|id
op_or_assign
(paren
id|pos
(braket
l_int|3
)braket
op_amp
l_int|0x10
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* get subsystem PUN high-bit&n;&t;&t;&t;&t;&t;   * for F/W adapters */
)brace
r_if
c_cond
(paren
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
op_logical_and
(paren
id|pos
(braket
l_int|4
)braket
op_amp
l_int|0x01
)paren
op_logical_and
(paren
id|pos
(braket
l_int|6
)braket
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* IRQ11 is used by SCSI-2 F/W Adapter/A */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: SCSI-2 F/W adapter needs IRQ 11.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* get interrupt request level */
r_if
c_cond
(paren
id|request_irq
(paren
id|IM_IRQ_FW
comma
id|interrupt_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;ibmmcascsi&quot;
comma
id|hosts
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to get shared IRQ %d.&bslash;n&quot;
comma
id|IM_IRQ_FW
)paren
suffix:semicolon
r_else
id|IRQ11_registered
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: %s found in slot %d, io=0x%x, scsi id=%d,&bslash;n&quot;
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
comma
id|slot
op_plus
l_int|1
comma
id|port
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xf0
)paren
id|printk
c_func
(paren
l_string|&quot;              ROM Addr.=off,&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;              ROM Addr.=0x%x,&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_lshift
l_int|13
)paren
op_plus
l_int|0xc0000
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; port-offset=0x%x, subsystem=%s&bslash;n&quot;
comma
(paren
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|0x0e
)paren
op_lshift
l_int|2
)paren
comma
(paren
id|pos
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;enabled.&quot;
suffix:colon
l_string|&quot;disabled.&quot;
)paren
suffix:semicolon
multiline_comment|/* register the hostadapter */
r_if
c_cond
(paren
(paren
id|shpnt
op_assign
id|ibmmca_register
c_func
(paren
id|scsi_template
comma
id|port
comma
id|id
comma
id|i
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|2
suffix:semicolon
id|k
OL
l_int|7
suffix:semicolon
id|k
op_increment
)paren
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_pos
(braket
id|k
)braket
op_assign
id|pos
(braket
id|k
)braket
suffix:semicolon
(paren
(paren
r_struct
id|ibmmca_hostdata
op_star
)paren
id|shpnt-&gt;hostdata
)paren
op_member_access_from_pointer
id|_special
op_assign
id|i
suffix:semicolon
id|mca_set_adapter_name
(paren
id|slot
comma
id|subsys_list
(braket
id|i
)braket
dot
id|description
)paren
suffix:semicolon
id|mca_set_adapter_procfn
(paren
id|slot
comma
(paren
id|MCA_ProcFn
)paren
id|ibmmca_getinfo
comma
id|shpnt
)paren
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
id|IBM_SCSI2_FW
)paren
op_logical_and
(paren
id|pos
(braket
l_int|4
)braket
op_amp
l_int|0x01
)paren
op_logical_and
(paren
id|pos
(braket
l_int|6
)braket
op_eq
l_int|0
)paren
)paren
id|devices_on_irq_11
op_increment
suffix:semicolon
r_else
id|devices_on_irq_14
op_increment
suffix:semicolon
)brace
id|slot
op_increment
suffix:semicolon
multiline_comment|/* advance to next slot */
)brace
multiline_comment|/* advance to next adapter id in the list of IBM-SCSI-subsystems*/
)brace
r_if
c_cond
(paren
id|IRQ11_registered
op_logical_and
op_logical_neg
id|devices_on_irq_11
)paren
id|free_irq
c_func
(paren
id|IM_IRQ_FW
comma
id|hosts
)paren
suffix:semicolon
multiline_comment|/* no devices on IRQ 11 */
r_if
c_cond
(paren
id|IRQ14_registered
op_logical_and
op_logical_neg
id|devices_on_irq_14
)paren
id|free_irq
c_func
(paren
id|IM_IRQ
comma
id|hosts
)paren
suffix:semicolon
multiline_comment|/* no devices on IRQ 14 */
r_if
c_cond
(paren
op_logical_neg
id|devices_on_irq_11
op_logical_and
op_logical_neg
id|devices_on_irq_14
)paren
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: No IBM SCSI-subsystem adapter attached.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|found
suffix:semicolon
multiline_comment|/* return the number of found SCSI hosts. Should be 1 or 0. */
)brace
r_static
r_struct
id|Scsi_Host
op_star
DECL|function|ibmmca_register
id|ibmmca_register
c_func
(paren
id|Scsi_Host_Template
op_star
id|scsi_template
comma
r_int
id|port
comma
r_int
id|id
comma
r_int
id|adaptertype
comma
r_char
op_star
id|hostname
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* check I/O region */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|port
comma
id|IM_N_IO_PORT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to get I/O region 0x%x-0x%x (%d ports).&bslash;n&quot;
comma
id|port
comma
id|port
op_plus
id|IM_N_IO_PORT
op_minus
l_int|1
comma
id|IM_N_IO_PORT
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* register host */
id|shpnt
op_assign
id|scsi_register
c_func
(paren
id|scsi_template
comma
r_sizeof
(paren
r_struct
id|ibmmca_hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Unable to register host.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* request I/O region */
id|request_region
c_func
(paren
id|port
comma
id|IM_N_IO_PORT
comma
id|hostname
)paren
suffix:semicolon
id|hosts
(braket
id|found
)braket
op_assign
id|shpnt
suffix:semicolon
multiline_comment|/* add new found hostadapter to the list */
id|special
c_func
(paren
id|found
)paren
op_assign
id|adaptertype
suffix:semicolon
multiline_comment|/* important assignment or else crash! */
id|subsystem_connector_size
c_func
(paren
id|found
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* preset slot-size */
id|shpnt-&gt;irq
op_assign
id|IM_IRQ
suffix:semicolon
multiline_comment|/* assign necessary stuff for the adapter */
id|shpnt-&gt;io_port
op_assign
id|port
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
id|IM_N_IO_PORT
suffix:semicolon
id|shpnt-&gt;this_id
op_assign
id|id
suffix:semicolon
id|shpnt-&gt;max_id
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8 PUNs are default */
multiline_comment|/* now, the SCSI-subsystem is connected to Linux */
id|ctrl
op_assign
(paren
r_int
r_int
)paren
(paren
id|inb
c_func
(paren
id|IM_CTR_REG
c_func
(paren
id|found
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get control-register status */
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Control Register contents: %x, status: %x&bslash;n&quot;
comma
id|ctrl
comma
id|inb
c_func
(paren
id|IM_STAT_REG
c_func
(paren
id|found
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: This adapters&squot; POS-registers: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
id|pos
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|reset_status
c_func
(paren
id|found
)paren
op_assign
id|IM_RESET_NOT_IN_PROGRESS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* reset the tables */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
id|get_ldn
c_func
(paren
id|found
)paren
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|MAX_LOG_DEV
suffix:semicolon
multiline_comment|/* check which logical devices exist */
multiline_comment|/* after this line, local interrupting is possible: */
id|local_checking_phase_flag
c_func
(paren
id|found
)paren
op_assign
l_int|1
suffix:semicolon
id|check_devices
c_func
(paren
id|found
comma
id|adaptertype
)paren
suffix:semicolon
multiline_comment|/* call by value, using the global variable hosts*/
id|local_checking_phase_flag
c_func
(paren
id|found
)paren
op_assign
l_int|0
suffix:semicolon
id|found
op_increment
suffix:semicolon
multiline_comment|/* now increase index to be prepared for next found subsystem */
multiline_comment|/* an ibm mca subsystem has been detected */
r_return
id|shpnt
suffix:semicolon
)brace
DECL|function|ibmmca_command
r_int
id|ibmmca_command
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|ibmmca_queuecommand
(paren
id|cmd
comma
id|internal_done
)paren
suffix:semicolon
id|cmd-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cmd-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_return
id|cmd-&gt;result
suffix:semicolon
)brace
DECL|function|ibmmca_release
r_int
id|ibmmca_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|release_region
c_func
(paren
id|shpnt-&gt;io_port
comma
id|shpnt-&gt;n_io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|found
)paren
)paren
id|free_irq
c_func
(paren
id|shpnt-&gt;irq
comma
id|hosts
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The following routine is the SCSI command queue for the midlevel driver */
DECL|function|ibmmca_queuecommand
r_int
id|ibmmca_queuecommand
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|ldn
suffix:semicolon
r_int
r_int
id|scsi_cmd
suffix:semicolon
r_struct
id|im_scb
op_star
id|scb
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
id|current_ldn
suffix:semicolon
r_int
id|id
comma
id|lun
suffix:semicolon
r_int
id|target
suffix:semicolon
r_int
id|host_index
suffix:semicolon
r_int
id|max_pun
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sl
suffix:semicolon
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
multiline_comment|/* search for the right hostadapter */
r_for
c_loop
(paren
id|host_index
op_assign
l_int|0
suffix:semicolon
id|hosts
(braket
id|host_index
)braket
op_logical_and
id|hosts
(braket
id|host_index
)braket
op_member_access_from_pointer
id|host_no
op_ne
id|shpnt-&gt;host_no
suffix:semicolon
id|host_index
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hosts
(braket
id|host_index
)braket
)paren
(brace
multiline_comment|/* invalid hostadapter descriptor address */
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|max_pun
op_assign
id|subsystem_maxid
c_func
(paren
id|host_index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibm_ansi_order
)paren
(brace
id|target
op_assign
id|max_pun
op_minus
l_int|1
op_minus
id|cmd-&gt;target
suffix:semicolon
r_if
c_cond
(paren
(paren
id|target
op_le
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
op_logical_and
(paren
id|cmd-&gt;target
op_le
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
)paren
id|target
op_decrement
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|target
op_ge
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
op_logical_and
(paren
id|cmd-&gt;target
op_ge
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
)paren
id|target
op_increment
suffix:semicolon
)brace
r_else
id|target
op_assign
id|cmd-&gt;target
suffix:semicolon
multiline_comment|/* if (target,lun) is NO LUN or not existing at all, return error */
r_if
c_cond
(paren
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|target
)braket
(braket
id|cmd-&gt;lun
)braket
op_eq
id|TYPE_NO_LUN
)paren
op_logical_or
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|target
)braket
(braket
id|cmd-&gt;lun
)braket
op_eq
id|TYPE_NO_DEVICE
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*if (target,lun) unassigned, do further checks... */
id|ldn
op_assign
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|target
)braket
(braket
id|cmd-&gt;lun
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ldn
op_ge
id|MAX_LOG_DEV
)paren
(brace
multiline_comment|/* on invalid ldn do special stuff */
r_if
c_cond
(paren
id|ldn
OG
id|MAX_LOG_DEV
)paren
(brace
multiline_comment|/* dynamical remapping if ldn unassigned */
id|current_ldn
op_assign
id|next_ldn
c_func
(paren
id|host_index
)paren
suffix:semicolon
multiline_comment|/* stop-value for one circle */
r_while
c_loop
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|next_ldn
c_func
(paren
id|host_index
)paren
)braket
dot
id|cmd
)paren
(brace
multiline_comment|/* search for a occupied, but not in */
multiline_comment|/* command-processing ldn. */
id|next_ldn
c_func
(paren
id|host_index
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|next_ldn
c_func
(paren
id|host_index
)paren
op_ge
id|MAX_LOG_DEV
)paren
id|next_ldn
c_func
(paren
id|host_index
)paren
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|current_ldn
op_eq
id|next_ldn
c_func
(paren
id|host_index
)paren
)paren
(brace
multiline_comment|/* One circle done ? */
multiline_comment|/* no non-processing ldn found */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Cannot assign SCSI-device dynamically!&bslash;n&quot;
"&bslash;"
l_string|&quot;              On ldn 7-14 SCSI-commands everywhere in progress.&bslash;n&quot;
"&bslash;"
l_string|&quot;              Reporting DID_NO_CONNECT for device (%d,%d).&bslash;n&quot;
comma
id|target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* return no connect*/
r_if
c_cond
(paren
id|done
)paren
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* unmap non-processing ldn */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
suffix:semicolon
id|id
op_increment
)paren
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
(brace
r_if
c_cond
(paren
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_eq
id|next_ldn
c_func
(paren
id|host_index
)paren
)paren
(brace
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
id|TYPE_NO_DEVICE
suffix:semicolon
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_assign
id|TYPE_NO_DEVICE
suffix:semicolon
multiline_comment|/* unmap entry */
)brace
)brace
multiline_comment|/* set reduced interrupt_handler-mode for checking */
id|local_checking_phase_flag
c_func
(paren
id|host_index
)paren
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* map found ldn to pun,lun */
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|target
)braket
(braket
id|cmd-&gt;lun
)braket
op_assign
id|next_ldn
c_func
(paren
id|host_index
)paren
suffix:semicolon
multiline_comment|/* change ldn to the right value, that is now next_ldn */
id|ldn
op_assign
id|next_ldn
c_func
(paren
id|host_index
)paren
suffix:semicolon
multiline_comment|/* unassign all ldns (pun,lun,ldn does not matter for remove) */
id|immediate_assign
c_func
(paren
id|host_index
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|REMOVE_LDN
)paren
suffix:semicolon
multiline_comment|/* set only LDN for remapped device */
id|immediate_assign
c_func
(paren
id|host_index
comma
id|target
comma
id|cmd-&gt;lun
comma
id|ldn
comma
id|SET_LDN
)paren
suffix:semicolon
multiline_comment|/* get device information for ld[ldn] */
r_if
c_cond
(paren
id|device_exists
(paren
id|host_index
comma
id|ldn
comma
op_amp
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|block_length
comma
op_amp
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
)paren
)paren
(brace
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* To prevent panic set 0, because&n;&t;&t;&t;&t;&t;       devices that were not assigned,&n;&t;&t;&t;&t;&t;       should have nothing in progress. */
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|target
)braket
(braket
id|cmd-&gt;lun
)braket
op_assign
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
suffix:semicolon
multiline_comment|/* increase assignment counters for statistics in /proc */
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dynamical_assignments
op_increment
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_assignments
(braket
id|ldn
)braket
op_increment
suffix:semicolon
)brace
r_else
multiline_comment|/* panic here, because a device, found at boottime has&n;&t;      vanished */
id|panic
c_func
(paren
l_string|&quot;IBM MCA SCSI: ldn=0x%x, SCSI-device on (%d,%d) vanished!&bslash;n&quot;
comma
id|ldn
comma
id|target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
multiline_comment|/* unassign again all ldns (pun,lun,ldn does not matter for remove) */
id|immediate_assign
c_func
(paren
id|host_index
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|REMOVE_LDN
)paren
suffix:semicolon
multiline_comment|/* remap all ldns, as written in the pun/lun table */
id|lun
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
macro_line|#endif
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
op_le
id|MAX_LOG_DEV
)paren
id|immediate_assign
c_func
(paren
id|host_index
comma
id|id
comma
id|lun
comma
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
comma
id|SET_LDN
)paren
suffix:semicolon
)brace
multiline_comment|/* set back to normal interrupt_handling */
id|local_checking_phase_flag
c_func
(paren
id|host_index
)paren
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
multiline_comment|/* Information on syslog terminal */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: ldn=0x%x dynamically reassigned to (%d,%d).&bslash;n&quot;
comma
id|ldn
comma
id|target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* increase next_ldn for next dynamical assignment */
id|next_ldn
c_func
(paren
id|host_index
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|next_ldn
c_func
(paren
id|host_index
)paren
op_ge
id|MAX_LOG_DEV
)paren
id|next_ldn
c_func
(paren
id|host_index
)paren
op_assign
l_int|7
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* wall against Linux accesses to the subsystem adapter */
id|cmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|done
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*verify there is no command already in progress for this log dev */
r_if
c_cond
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: cmd already in progress for this ldn.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*save done in cmd, and save cmd for the interrupt handler */
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
op_assign
id|cmd
suffix:semicolon
multiline_comment|/*fill scb information independent of the scsi command */
id|scb
op_assign
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|scb
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|tsb.dev_status
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;enable
op_assign
id|IM_REPORT_TSB_ONLY_ON_ERROR
op_or
id|IM_RETRY_ENABLE
suffix:semicolon
id|scb-&gt;tsb_adr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|tsb
)paren
)paren
suffix:semicolon
id|scsi_cmd
op_assign
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|i
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
id|sl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|16
)paren
id|panic
(paren
l_string|&quot;IBM MCA SCSI: scatter-gather list too long.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|sge
(braket
id|i
)braket
dot
id|address
op_assign
(paren
r_void
op_star
)paren
(paren
id|virt_to_bus
c_func
(paren
id|sl
(braket
id|i
)braket
dot
id|address
)paren
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|sge
(braket
id|i
)braket
dot
id|byte_length
op_assign
id|sl
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
id|scb-&gt;enable
op_or_assign
id|IM_POINTER_TO_LIST
suffix:semicolon
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|sge
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|scb-&gt;sys_buf_length
op_assign
id|cmd-&gt;use_sg
op_star
r_sizeof
(paren
r_struct
id|im_sge
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;sys_buf_adr
op_assign
id|virt_to_bus
c_func
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
multiline_comment|/* recent Linux midlevel SCSI places 1024 byte for inquiry&n;       * command. Far too much for old PS/2 hardware. */
r_switch
c_cond
(paren
id|scsi_cmd
)paren
(brace
multiline_comment|/* avoid command errors by setting bufferlengths to&n;&t;  * ANSI-standard. Beware of forcing it to 255,&n;&t;  * this could SEGV the kernel!!! */
r_case
id|INQUIRY
suffix:colon
r_case
id|REQUEST_SENSE
suffix:colon
r_case
id|MODE_SENSE
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
OG
l_int|255
)paren
id|scb-&gt;sys_buf_length
op_assign
l_int|255
suffix:semicolon
r_else
id|scb-&gt;sys_buf_length
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|scb-&gt;sys_buf_length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|scb-&gt;sys_buf_length
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*fill scb information dependent on scsi command */
macro_line|#ifdef IM_DEBUG_CMD
id|printk
c_func
(paren
l_string|&quot;issue scsi cmd=%02x to ldn=%d&bslash;n&quot;
comma
id|scsi_cmd
comma
id|ldn
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* for specific device-type debugging: */
macro_line|#ifdef IM_DEBUG_CMD_SPEC_DEV
r_if
c_cond
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
op_eq
id|IM_DEBUG_CMD_DEVICE
)paren
id|printk
c_func
(paren
l_string|&quot;(SCSI-device-type=0x%x) issue scsi cmd=%02x to ldn=%d&bslash;n&quot;
comma
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
comma
id|scsi_cmd
comma
id|ldn
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* for possible panics store current command */
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|scsi_cmd
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_SCB
suffix:semicolon
multiline_comment|/* update statistical info */
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_accesses
op_increment
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_access
(braket
id|ldn
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|scsi_cmd
)paren
(brace
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|READ_12
suffix:colon
r_case
id|WRITE_12
suffix:colon
multiline_comment|/* Distinguish between disk and other devices. Only disks (that are the&n;&t; most frequently accessed devices) should be supported by the&n;       IBM-SCSI-Subsystem commands. */
r_switch
c_cond
(paren
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|device_type
)paren
(brace
r_case
id|TYPE_DISK
suffix:colon
multiline_comment|/* for harddisks enter here ... */
r_case
id|TYPE_MOD
suffix:colon
multiline_comment|/* ... try it also for MO-drives (send flames as */
multiline_comment|/*     you like, if this won&squot;t work.) */
r_if
c_cond
(paren
id|scsi_cmd
op_eq
id|READ_6
op_logical_or
id|scsi_cmd
op_eq
id|READ_10
op_logical_or
id|scsi_cmd
op_eq
id|READ_12
)paren
(brace
multiline_comment|/* read command preparations */
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_read_access
(braket
id|ldn
)braket
op_increment
suffix:semicolon
multiline_comment|/* increase READ-access on ldn stat. */
id|scb-&gt;command
op_assign
id|IM_READ_DATA_CMD
op_or
id|IM_NO_DISCONNECT
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write command preparations */
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_write_access
(braket
id|ldn
)braket
op_increment
suffix:semicolon
multiline_comment|/* increase write-count on ldn stat.*/
id|scb-&gt;command
op_assign
id|IM_WRITE_DATA_CMD
op_or
id|IM_NO_DISCONNECT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_cmd
op_eq
id|READ_6
op_logical_or
id|scsi_cmd
op_eq
id|WRITE_6
)paren
(brace
id|scb-&gt;u1.log_blk_adr
op_assign
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|3
)braket
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
)paren
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|scb-&gt;u2.blk.count
op_assign
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;u1.log_blk_adr
op_assign
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|5
)braket
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|3
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|2
)braket
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|scb-&gt;u2.blk.count
op_assign
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|8
)braket
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
r_int
)paren
id|cmd-&gt;cmnd
(braket
l_int|7
)braket
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|last_scsi_logical_block
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|scb-&gt;u1.log_blk_adr
suffix:semicolon
id|last_scsi_blockcount
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|scb-&gt;u2.blk.count
suffix:semicolon
id|scb-&gt;u2.blk.length
op_assign
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|block_length
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* for other devices, enter here. Other types are not known by&n;&t;    Linux! TYPE_NO_LUN is forbidden as valid device. */
r_case
id|TYPE_ROM
suffix:colon
r_case
id|TYPE_TAPE
suffix:colon
r_case
id|TYPE_PROCESSOR
suffix:colon
r_case
id|TYPE_WORM
suffix:colon
r_case
id|TYPE_SCANNER
suffix:colon
r_case
id|TYPE_MEDIUM_CHANGER
suffix:colon
multiline_comment|/* If there is a sequential-device, IBM recommends to use&n;&t;  IM_OTHER_SCSI_CMD_CMD instead of subsystem READ/WRITE.&n;&t;  This includes CD-ROM devices, too, due to the partial sequential&n;&t;  read capabilities. */
id|scb-&gt;command
op_assign
id|IM_OTHER_SCSI_CMD_CMD
suffix:semicolon
r_if
c_cond
(paren
id|scsi_cmd
op_eq
id|READ_6
op_logical_or
id|scsi_cmd
op_eq
id|READ_10
op_logical_or
id|scsi_cmd
op_eq
id|READ_12
)paren
multiline_comment|/* enable READ */
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_BYPASS_BUFFER
suffix:semicolon
id|scb-&gt;u1.scsi_cmd_length
op_assign
id|cmd-&gt;cmd_len
suffix:semicolon
id|memcpy
(paren
id|scb-&gt;u2.scsi_command
comma
id|cmd-&gt;cmnd
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_LONG_SCB
suffix:semicolon
multiline_comment|/* Read/write on this non-disk devices is also displayworthy,&n;&t;    so flash-up the LED/display. */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_inquiry_access
(braket
id|ldn
)braket
op_increment
suffix:semicolon
id|scb-&gt;command
op_assign
id|IM_DEVICE_INQUIRY_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
id|scb-&gt;u1.log_blk_adr
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|scb-&gt;command
op_assign
id|IM_OTHER_SCSI_CMD_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
id|scb-&gt;u1.log_blk_adr
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;u1.scsi_cmd_length
op_assign
l_int|6
suffix:semicolon
id|memcpy
(paren
id|scb-&gt;u2.scsi_command
comma
id|cmd-&gt;cmnd
comma
l_int|6
)paren
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_LONG_SCB
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
multiline_comment|/* the length of system memory buffer must be exactly 8 bytes */
id|scb-&gt;command
op_assign
id|IM_READ_CAPACITY_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;sys_buf_length
OG
l_int|8
)paren
id|scb-&gt;sys_buf_length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Commands that need read-only-mode (system &lt;- device): */
r_case
id|REQUEST_SENSE
suffix:colon
id|scb-&gt;command
op_assign
id|IM_REQUEST_SENSE_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Commands that need write-only-mode (system -&gt; device): */
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SELECT_10
suffix:colon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_modeselect_access
(braket
id|ldn
)braket
op_increment
suffix:semicolon
id|scb-&gt;command
op_assign
id|IM_OTHER_SCSI_CMD_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_SUPRESS_EXCEPTION_SHORT
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
multiline_comment|/*Select needs WRITE-enabled*/
id|scb-&gt;u1.scsi_cmd_length
op_assign
id|cmd-&gt;cmd_len
suffix:semicolon
id|memcpy
(paren
id|scb-&gt;u2.scsi_command
comma
id|cmd-&gt;cmnd
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_LONG_SCB
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* For other commands, read-only is useful. Most other commands are&n;       running without an input-data-block. */
r_default
suffix:colon
id|scb-&gt;command
op_assign
id|IM_OTHER_SCSI_CMD_CMD
suffix:semicolon
id|scb-&gt;enable
op_or_assign
id|IM_READ_CONTROL
op_or
id|IM_SUPRESS_EXCEPTION_SHORT
op_or
id|IM_BYPASS_BUFFER
suffix:semicolon
id|scb-&gt;u1.scsi_cmd_length
op_assign
id|cmd-&gt;cmd_len
suffix:semicolon
id|memcpy
(paren
id|scb-&gt;u2.scsi_command
comma
id|cmd-&gt;cmnd
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_LONG_SCB
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*issue scb command, and return */
r_if
c_cond
(paren
op_increment
id|disk_rw_in_progress
op_eq
l_int|1
)paren
id|PS2_DISK_LED_ON
(paren
id|shpnt-&gt;host_no
comma
id|target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_eq
id|IM_LONG_SCB
)paren
(brace
id|issue_cmd
(paren
id|host_index
comma
id|virt_to_bus
c_func
(paren
id|scb
)paren
comma
id|IM_LONG_SCB
op_or
id|ldn
)paren
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|long_scbs
op_increment
suffix:semicolon
)brace
r_else
(brace
id|issue_cmd
(paren
id|host_index
comma
id|virt_to_bus
c_func
(paren
id|scb
)paren
comma
id|IM_SCB
op_or
id|ldn
)paren
suffix:semicolon
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|scbs
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmmca_abort
r_int
id|ibmmca_abort
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
multiline_comment|/* Abort does not work, as the adapter never generates an interrupt on&n;    * whatever situation is simulated, even when really pending commands&n;    * are running on the adapters&squot; hardware ! */
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
r_int
id|ldn
suffix:semicolon
r_void
(paren
op_star
id|saved_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|target
suffix:semicolon
r_int
id|host_index
suffix:semicolon
r_int
id|max_pun
suffix:semicolon
r_static
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|imm_command
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Abort subroutine called...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|IBMLOCK
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
multiline_comment|/* search for the right hostadapter */
r_for
c_loop
(paren
id|host_index
op_assign
l_int|0
suffix:semicolon
id|hosts
(braket
id|host_index
)braket
op_logical_and
id|hosts
(braket
id|host_index
)braket
op_member_access_from_pointer
id|host_no
op_ne
id|shpnt-&gt;host_no
suffix:semicolon
id|host_index
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hosts
(braket
id|host_index
)braket
)paren
(brace
multiline_comment|/* invalid hostadapter descriptor address */
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
id|IBMUNLOCK
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Abort adapter selection failed!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
id|max_pun
op_assign
id|subsystem_maxid
c_func
(paren
id|host_index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibm_ansi_order
)paren
(brace
id|target
op_assign
id|max_pun
op_minus
l_int|1
op_minus
id|cmd-&gt;target
suffix:semicolon
r_if
c_cond
(paren
(paren
id|target
op_le
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
op_logical_and
(paren
id|cmd-&gt;target
op_le
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
)paren
id|target
op_decrement
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|target
op_ge
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
op_logical_and
(paren
id|cmd-&gt;target
op_ge
id|subsystem_pun
c_func
(paren
id|host_index
)paren
)paren
)paren
id|target
op_increment
suffix:semicolon
)brace
r_else
id|target
op_assign
id|cmd-&gt;target
suffix:semicolon
multiline_comment|/* get logical device number, and disable system interrupts */
id|printk
(paren
l_string|&quot;IBM MCA SCSI: Sending abort to device pun=%d, lun=%d.&bslash;n&quot;
comma
id|target
comma
id|cmd-&gt;lun
)paren
suffix:semicolon
id|ldn
op_assign
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|target
)braket
(braket
id|cmd-&gt;lun
)braket
suffix:semicolon
multiline_comment|/*if cmd for this ldn has already finished, no need to abort */
r_if
c_cond
(paren
op_logical_neg
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
)paren
(brace
id|IBMUNLOCK
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
multiline_comment|/* Clear ld.cmd, save done function, install internal done,&n;    * send abort immediate command (this enables sys. interrupts),&n;    * and wait until the interrupt arrives.&n;    */
id|saved_done
op_assign
id|cmd-&gt;scsi_done
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|internal_done
suffix:semicolon
id|cmd-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_ABORT_IMM_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
op_assign
id|IM_IMM_CMD
suffix:semicolon
id|imm_command
op_assign
id|inl
c_func
(paren
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|imm_command
op_and_assign
(paren
r_int
r_int
)paren
(paren
l_int|0xffff0000
)paren
suffix:semicolon
multiline_comment|/* mask reserved stuff */
id|imm_command
op_or_assign
(paren
r_int
r_int
)paren
(paren
id|IM_ABORT_IMM_CMD
)paren
suffix:semicolon
multiline_comment|/* must wait for attention reg not busy */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
(paren
id|IM_STAT_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
id|IM_BUSY
)paren
)paren
r_break
suffix:semicolon
id|IBMUNLOCK
id|IBMLOCK
)brace
multiline_comment|/* write registers and enable system interrupts */
id|outl
(paren
id|imm_command
comma
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|outb
(paren
id|IM_IMM_CMD
op_or
id|ldn
comma
id|IM_ATTN_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|IBMUNLOCK
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Abort queued to adapter...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
op_logical_neg
id|cmd-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|saved_done
suffix:semicolon
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Abort returned with adapter response...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*if abort went well, call saved done, then return success or error */
r_if
c_cond
(paren
id|cmd-&gt;result
op_eq
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
)paren
(brace
id|IBMLOCK
id|cmd-&gt;result
op_or_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|NULL
suffix:semicolon
id|IBMUNLOCK
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Abort finished with success.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|IBMLOCK
id|cmd-&gt;result
op_or_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|ldn
)braket
dot
id|cmd
op_assign
l_int|NULL
suffix:semicolon
id|IBMUNLOCK
macro_line|#ifdef IM_DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Abort failed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
)brace
DECL|function|ibmmca_reset
r_int
id|ibmmca_reset
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|reset_flags
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd_aid
suffix:semicolon
r_int
id|ticks
comma
id|i
suffix:semicolon
r_int
id|host_index
suffix:semicolon
r_static
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|imm_command
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: Reset called with NULL-command!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SNOOZE
suffix:semicolon
)brace
id|IBMLOCK
id|ticks
op_assign
id|IM_RESET_DELAY
op_star
id|HZ
suffix:semicolon
id|shpnt
op_assign
id|cmd-&gt;host
suffix:semicolon
multiline_comment|/* search for the right hostadapter */
r_for
c_loop
(paren
id|host_index
op_assign
l_int|0
suffix:semicolon
id|hosts
(braket
id|host_index
)braket
op_logical_and
id|hosts
(braket
id|host_index
)braket
op_member_access_from_pointer
id|host_no
op_ne
id|shpnt-&gt;host_no
suffix:semicolon
id|host_index
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hosts
(braket
id|host_index
)braket
)paren
multiline_comment|/* invalid hostadapter descriptor address */
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_if
c_cond
(paren
id|local_checking_phase_flag
c_func
(paren
id|host_index
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: unable to reset while checking devices.&bslash;n&quot;
)paren
suffix:semicolon
id|IBMUNLOCK
r_return
id|SCSI_RESET_SNOOZE
suffix:semicolon
)brace
multiline_comment|/* issue reset immediate command to subsystem, and wait for interrupt */
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: resetting all devices.&bslash;n&quot;
)paren
suffix:semicolon
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_IN_PROGRESS
suffix:semicolon
id|last_scsi_command
c_func
(paren
id|host_index
)paren
(braket
l_int|0xf
)braket
op_assign
id|IM_RESET_IMM_CMD
suffix:semicolon
id|last_scsi_type
c_func
(paren
id|host_index
)paren
(braket
l_int|0xf
)braket
op_assign
id|IM_IMM_CMD
suffix:semicolon
id|imm_command
op_assign
id|inl
c_func
(paren
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|imm_command
op_and_assign
(paren
r_int
r_int
)paren
(paren
l_int|0xffff0000
)paren
suffix:semicolon
multiline_comment|/* mask reserved stuff */
id|imm_command
op_or_assign
(paren
r_int
r_int
)paren
(paren
id|IM_RESET_IMM_CMD
)paren
suffix:semicolon
multiline_comment|/* must wait for attention reg not busy */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
(paren
id|IM_STAT_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
id|IM_BUSY
)paren
)paren
r_break
suffix:semicolon
id|IBMUNLOCK
id|IBMLOCK
)brace
multiline_comment|/*write registers and enable system interrupts */
id|outl
(paren
id|imm_command
comma
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|outb
(paren
id|IM_IMM_CMD
op_or
l_int|0xf
comma
id|IM_ATTN_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for interrupt finished or intr_stat register to be set, as the&n;    * interrupt will not be executed, while we are in here! */
r_while
c_loop
(paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_eq
id|IM_RESET_IN_PROGRESS
op_logical_and
op_decrement
id|ticks
op_logical_and
(paren
(paren
id|inb
c_func
(paren
id|IM_INTR_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
l_int|0x8f
)paren
op_ne
l_int|0x8f
)paren
)paren
(brace
id|udelay
c_func
(paren
(paren
l_int|1
op_plus
l_int|999
op_div
id|HZ
)paren
op_star
l_int|1000
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* if reset did not complete, just return an error*/
r_if
c_cond
(paren
op_logical_neg
id|ticks
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: reset did not complete within %d seconds.&bslash;n&quot;
comma
id|IM_RESET_DELAY
)paren
suffix:semicolon
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_FINISHED_FAIL
suffix:semicolon
id|IBMUNLOCK
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|IM_INTR_REG
c_func
(paren
id|host_index
)paren
)paren
op_amp
l_int|0x8f
)paren
op_eq
l_int|0x8f
)paren
(brace
multiline_comment|/* analysis done by this routine and not by the intr-routine */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|IM_INTR_REG
c_func
(paren
id|host_index
)paren
)paren
op_eq
l_int|0xaf
)paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_FINISHED_OK_NO_INT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|inb
c_func
(paren
id|IM_INTR_REG
c_func
(paren
id|host_index
)paren
)paren
op_eq
l_int|0xcf
)paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_FINISHED_FAIL
suffix:semicolon
r_else
multiline_comment|/* failed, 4get it */
id|reset_status
c_func
(paren
id|host_index
)paren
op_assign
id|IM_RESET_NOT_IN_PROGRESS_NO_INT
suffix:semicolon
id|outb
(paren
id|IM_EOI
op_or
l_int|0xf
comma
id|IM_ATTN_REG
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* if reset failed, just return an error */
r_if
c_cond
(paren
id|reset_status
c_func
(paren
id|host_index
)paren
op_eq
id|IM_RESET_FINISHED_FAIL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IBM MCA SCSI: reset failed.&bslash;n&quot;
)paren
suffix:semicolon
id|IBMUNLOCK
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
multiline_comment|/* so reset finished ok - call outstanding done&squot;s, and return success */
id|printk
(paren
l_string|&quot;IBM MCA SCSI: Reset successfully completed.&bslash;n&quot;
)paren
suffix:semicolon
id|IBMUNLOCK
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_LOG_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cmd_aid
op_assign
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|i
)braket
dot
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|cmd_aid
op_logical_and
id|cmd_aid-&gt;scsi_done
)paren
(brace
id|ld
c_func
(paren
id|host_index
)paren
(braket
id|i
)braket
dot
id|cmd
op_assign
l_int|NULL
suffix:semicolon
id|cmd_aid-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|reset_flags
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
r_return
(paren
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_HOST_RESET
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|reset_flags
op_amp
id|SCSI_RESET_SUGGEST_BUS_RESET
)paren
r_return
(paren
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_BUS_RESET
)paren
suffix:semicolon
r_else
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
DECL|function|ibmmca_biosparam
r_int
id|ibmmca_biosparam
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|info
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
id|info
(braket
l_int|0
)braket
op_star
id|info
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|128
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
id|info
(braket
l_int|0
)braket
op_star
id|info
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|disk-&gt;capacity
op_div
(paren
id|info
(braket
l_int|0
)braket
op_star
id|info
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
id|info
(braket
l_int|2
)braket
op_assign
l_int|1023
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* calculate percentage of total accesses on a ldn */
DECL|function|ldn_access_load
r_static
r_int
id|ldn_access_load
c_func
(paren
r_int
id|host_index
comma
r_int
id|ldn
)paren
(brace
r_if
c_cond
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_accesses
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_access
(braket
id|ldn
)braket
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_access
(braket
id|ldn
)braket
op_star
l_int|100
)paren
op_div
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_accesses
suffix:semicolon
)brace
multiline_comment|/* calculate total amount of r/w-accesses */
DECL|function|ldn_access_total_read_write
r_static
r_int
id|ldn_access_total_read_write
c_func
(paren
r_int
id|host_index
)paren
(brace
r_int
id|a
suffix:semicolon
r_int
id|i
suffix:semicolon
id|a
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|i
op_increment
)paren
id|a
op_add_assign
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_read_access
(braket
id|i
)braket
op_plus
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_write_access
(braket
id|i
)braket
suffix:semicolon
r_return
id|a
suffix:semicolon
)brace
DECL|function|ldn_access_total_inquiry
r_static
r_int
id|ldn_access_total_inquiry
c_func
(paren
r_int
id|host_index
)paren
(brace
r_int
id|a
suffix:semicolon
r_int
id|i
suffix:semicolon
id|a
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|i
op_increment
)paren
id|a
op_add_assign
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_inquiry_access
(braket
id|i
)braket
suffix:semicolon
r_return
id|a
suffix:semicolon
)brace
DECL|function|ldn_access_total_modeselect
r_static
r_int
id|ldn_access_total_modeselect
c_func
(paren
r_int
id|host_index
)paren
(brace
r_int
id|a
suffix:semicolon
r_int
id|i
suffix:semicolon
id|a
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|i
op_increment
)paren
id|a
op_add_assign
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_modeselect_access
(braket
id|i
)braket
suffix:semicolon
r_return
id|a
suffix:semicolon
)brace
multiline_comment|/* routine to display info in the proc-fs-structure (a deluxe feature) */
DECL|function|ibmmca_proc_info
r_int
id|ibmmca_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|id
comma
id|lun
comma
id|host_index
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|max_pun
suffix:semicolon
id|IBMLOCK
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|hosts
(braket
id|i
)braket
op_logical_and
id|hosts
(braket
id|i
)braket
op_member_access_from_pointer
id|host_no
op_ne
id|hostno
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
id|shpnt
op_assign
id|hosts
(braket
id|i
)braket
suffix:semicolon
id|host_index
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;nIBM MCA SCSI: Can&squot;t find adapter for host number %d&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
id|max_pun
op_assign
id|subsystem_maxid
c_func
(paren
id|host_index
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;n             IBM-SCSI-Subsystem-Linux-Driver, Version %s&bslash;n&bslash;n&bslash;n&quot;
comma
id|IBMMCA_SCSI_DRIVER_VERSION
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; SCSI Access-Statistics:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Device Scanning Order....: %s&bslash;n&quot;
comma
(paren
id|ibm_ansi_order
)paren
ques
c_cond
l_string|&quot;IBM/ANSI&quot;
suffix:colon
l_string|&quot;New Industry Standard&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Multiple LUN probing.....: Yes&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Multiple LUN probing.....: No&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               This Hostnumber..........: %d&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Base I/O-Port............: 0x%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|IM_CMD_REG
c_func
(paren
id|host_index
)paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               (Shared) IRQ.............: %d&bslash;n&quot;
comma
id|IM_IRQ
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Total Interrupts.........: %d&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_interrupts
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Total SCSI Accesses......: %d&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_accesses
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Total short SCBs.........: %d&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|scbs
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Total long SCBs..........: %d&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|long_scbs
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;                 Total SCSI READ/WRITE..: %d&bslash;n&quot;
comma
id|ldn_access_total_read_write
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;                 Total SCSI Inquiries...: %d&bslash;n&quot;
comma
id|ldn_access_total_inquiry
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;                 Total SCSI Modeselects.: %d&bslash;n&quot;
comma
id|ldn_access_total_modeselect
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;                 Total SCSI other cmds..: %d&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_accesses
op_minus
id|ldn_access_total_read_write
c_func
(paren
id|host_index
)paren
op_minus
id|ldn_access_total_modeselect
c_func
(paren
id|host_index
)paren
op_minus
id|ldn_access_total_inquiry
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Total SCSI command fails.: %d&bslash;n&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_errors
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; Logical-Device-Number (LDN) Access-Statistics:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;         LDN | Accesses [%%] |   READ    |   WRITE   | ASSIGNMENTS&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;        -----|--------------|-----------|-----------|--------------&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAX_LOG_DEV
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;         %2X  |    %3d       |  %8d |  %8d | %8d&bslash;n&quot;
comma
id|i
comma
id|ldn_access_load
c_func
(paren
id|host_index
comma
id|i
)paren
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_read_access
(braket
id|i
)braket
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_write_access
(braket
id|i
)braket
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|ldn_assignments
(braket
id|i
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;        -----------------------------------------------------------&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; Dynamical-LDN-Assignment-Statistics:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Number of physical SCSI-devices..: %d (+ Adapter)&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|total_scsi_devices
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Dynamical Assignment necessary...: %s&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dyn_flag
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No &quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Next LDN to be assigned..........: 0x%x&bslash;n&quot;
comma
id|next_ldn
c_func
(paren
id|host_index
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;               Dynamical assignments done yet...: %d&bslash;n&quot;
comma
id|IBM_DS
c_func
(paren
id|host_index
)paren
dot
id|dynamical_assignments
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;n Current SCSI-Device-Mapping:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;        Physical SCSI-Device Map               Logical SCSI-Device Map&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;    ID&bslash;&bslash;LUN  0  1  2  3  4  5  6  7       ID&bslash;&bslash;LUN  0  1  2  3  4  5  6  7&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|max_pun
suffix:semicolon
id|id
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;    %2d     &quot;
comma
id|id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%2s &quot;
comma
id|ti_p
c_func
(paren
id|get_scsi
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;      %2d     &quot;
comma
id|id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
l_int|8
suffix:semicolon
id|lun
op_increment
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%2s &quot;
comma
id|ti_l
c_func
(paren
id|get_ldn
c_func
(paren
id|host_index
)paren
(braket
id|id
)braket
(braket
id|lun
)braket
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;(A = IBM-Subsystem, D = Harddisk, T = Tapedrive, P = Processor, W = WORM,&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; R = CD-ROM, S = Scanner, M = MO-Drive, C = Medium-Changer, + = unprovided LUN,&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; - = nothing found, nothing assigned or unprobed LUN)&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
id|IBMUNLOCK
r_return
id|len
suffix:semicolon
)brace
DECL|function|ibmmca_scsi_setup
r_void
id|ibmmca_scsi_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|internal_ibmmca_scsi_setup
(paren
id|str
comma
id|ints
)paren
suffix:semicolon
)brace
DECL|function|option_setup
r_static
r_int
id|option_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
id|IM_MAX_HOSTS
)braket
suffix:semicolon
r_char
op_star
id|cur
op_assign
id|str
suffix:semicolon
r_int
id|i
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_logical_and
id|isdigit
c_func
(paren
op_star
id|cur
)paren
op_logical_and
id|i
op_le
id|IM_MAX_HOSTS
)paren
(brace
id|ints
(braket
id|i
op_increment
)braket
op_assign
id|simple_strtoul
c_func
(paren
id|cur
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|strchr
c_func
(paren
id|cur
comma
l_char|&squot;,&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
id|cur
op_increment
suffix:semicolon
)brace
id|ints
(braket
l_int|0
)braket
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
id|internal_ibmmca_scsi_setup
c_func
(paren
id|cur
comma
id|ints
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;ibmmcascsi=&quot;
comma
id|option_setup
)paren
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|IBMMCA
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
