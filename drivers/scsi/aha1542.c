multiline_comment|/* $Id: aha1542.c,v 1.1 1992/07/24 06:27:38 root Exp root $&n; *  linux/kernel/aha1542.c&n; *&n; *  Copyright (C) 1992  Tommy Thorn&n; *  Copyright (C) 1993, 1994, 1995 Eric Youngdale&n; *&n; *  Modified by Eric Youngdale&n; *        Use request_irq and request_dma to help prevent unexpected conflicts&n; *        Set up on-board DMA controller, such that we do not have to&n; *        have the bios enabled to use the aha1542.&n; *  Modified by David Gentzel&n; *        Don&squot;t call request_dma if dma mask is 0 (for BusLogic BT-445S VL-Bus&n; *        controller).&n; *  Modified by Matti Aarnio&n; *        Accept parameters from LILO cmd-line. -- 1-Oct-94&n; *  Modified by Mike McLagan &lt;mike.mclagan@linux.org&gt;&n; *        Recognise extended mode on AHA1542CP, different bit than 1542CF&n; *        1-Jan-97&n; *  Modified by Bjorn L. Thordarson and Einar Thor Einarsson&n; *        Recognize that DMA0 is valid DMA channel -- 13-Jul-98&n; *  Modified by Chris Faulhaber &lt;jedgar@fxp.org&gt;&n; *        Added module command-line options&n; *        19-Jul-99&n; *  Modified by Adam Fritzler &lt;mid@auk.cx&gt;&n; *        Added proper detection of the AHA-1640 (MCA version of AHA-1540)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/isapnp.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;aha1542.h&quot;
DECL|macro|SCSI_PA
mdefine_line|#define SCSI_PA(address) virt_to_bus(address)
DECL|function|BAD_DMA
r_static
r_void
id|BAD_DMA
c_func
(paren
r_void
op_star
id|address
comma
r_int
r_int
id|length
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;buf vaddress %p paddress 0x%lx length %d&bslash;n&quot;
comma
id|address
comma
id|SCSI_PA
c_func
(paren
id|address
)paren
comma
id|length
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Buffer at physical address &gt; 16Mb used for aha1542&quot;
)paren
suffix:semicolon
)brace
DECL|function|BAD_SG_DMA
r_static
r_void
id|BAD_SG_DMA
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_struct
id|scatterlist
op_star
id|sgpnt
comma
r_int
id|nseg
comma
r_int
id|badseg
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;sgpnt[%d:%d] addr %p/0x%lx alt %p/0x%lx length %d&bslash;n&quot;
comma
id|badseg
comma
id|nseg
comma
id|sgpnt
(braket
id|badseg
)braket
dot
id|address
comma
id|SCSI_PA
c_func
(paren
id|sgpnt
(braket
id|badseg
)braket
dot
id|address
)paren
comma
id|sgpnt
(braket
id|badseg
)braket
dot
id|alt_address
comma
id|sgpnt
(braket
id|badseg
)braket
dot
id|alt_address
ques
c_cond
id|SCSI_PA
c_func
(paren
id|sgpnt
(braket
id|badseg
)braket
dot
id|alt_address
)paren
suffix:colon
l_int|0
comma
id|sgpnt
(braket
id|badseg
)braket
dot
id|length
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Not safe to continue.&n;&t; */
id|panic
c_func
(paren
l_string|&quot;Buffer at physical address &gt; 16Mb used for aha1542&quot;
)paren
suffix:semicolon
)brace
macro_line|#include&lt;linux/stat.h&gt;
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
multiline_comment|/*&n;   static const char RCSid[] = &quot;$Header: /usr/src/linux/kernel/blk_drv/scsi/RCS/aha1542.c,v 1.1 1992/07/24 06:27:38 root Exp root $&quot;;&n; */
multiline_comment|/* The adaptec can be configured for quite a number of addresses, but&n;   I generally do not want the card poking around at random.  We allow&n;   two addresses - this allows people to use the Adaptec with a Midi&n;   card, which also used 0x330 -- can be overridden with LILO! */
DECL|macro|MAXBOARDS
mdefine_line|#define MAXBOARDS 4&t;&t;/* Increase this and the sizes of the&n;&t;&t;&t;&t;   arrays below, if you need more.. */
multiline_comment|/* Boards 3,4 slots are reserved for ISAPnP/MCA scans */
DECL|variable|bases
r_static
r_int
r_int
id|bases
(braket
id|MAXBOARDS
)braket
op_assign
(brace
l_int|0x330
comma
l_int|0x334
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* set by aha1542_setup according to the command line */
DECL|variable|setup_called
r_static
r_int
id|setup_called
(braket
id|MAXBOARDS
)braket
suffix:semicolon
DECL|variable|setup_buson
r_static
r_int
id|setup_buson
(braket
id|MAXBOARDS
)braket
suffix:semicolon
DECL|variable|setup_busoff
r_static
r_int
id|setup_busoff
(braket
id|MAXBOARDS
)braket
suffix:semicolon
DECL|variable|setup_dmaspeed
r_static
r_int
id|setup_dmaspeed
(braket
id|MAXBOARDS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|setup_str
r_static
r_char
op_star
id|setup_str
(braket
id|MAXBOARDS
)braket
suffix:semicolon
multiline_comment|/*&n; * LILO/Module params:  aha1542=&lt;PORTBASE&gt;[,&lt;BUSON&gt;,&lt;BUSOFF&gt;[,&lt;DMASPEED&gt;]]&n; *&n; * Where:  &lt;PORTBASE&gt; is any of the valid AHA addresses:&n; *                      0x130, 0x134, 0x230, 0x234, 0x330, 0x334&n; *         &lt;BUSON&gt;  is the time (in microsecs) that AHA spends on the AT-bus&n; *                  when transferring data.  1542A power-on default is 11us,&n; *                  valid values are in range: 2..15 (decimal)&n; *         &lt;BUSOFF&gt; is the time that AHA spends OFF THE BUS after while&n; *                  it is transferring data (not to monopolize the bus).&n; *                  Power-on default is 4us, valid range: 1..64 microseconds.&n; *         &lt;DMASPEED&gt; Default is jumper selected (1542A: on the J1),&n; *                  but experimenter can alter it with this.&n; *                  Valid values: 5, 6, 7, 8, 10 (MB/s)&n; *                  Factory default is 5 MB/s.&n; */
macro_line|#if defined(MODULE)
DECL|variable|isapnp
r_int
id|isapnp
op_assign
l_int|0
suffix:semicolon
DECL|variable|aha1542
r_int
id|aha1542
(braket
)braket
op_assign
(brace
l_int|0x330
comma
l_int|11
comma
l_int|4
comma
op_minus
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aha1542
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|isapnp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|variable|isapnp
r_int
id|isapnp
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|macro|BIOS_TRANSLATION_1632
mdefine_line|#define BIOS_TRANSLATION_1632 0&t;/* Used by some old 1542A boards */
DECL|macro|BIOS_TRANSLATION_6432
mdefine_line|#define BIOS_TRANSLATION_6432 1&t;/* Default case these days */
DECL|macro|BIOS_TRANSLATION_25563
mdefine_line|#define BIOS_TRANSLATION_25563 2&t;/* Big disk case */
DECL|struct|aha1542_hostdata
r_struct
id|aha1542_hostdata
(brace
multiline_comment|/* This will effectively start both of them at the first mailbox */
DECL|member|bios_translation
r_int
id|bios_translation
suffix:semicolon
multiline_comment|/* Mapping bios uses - for compatibility */
DECL|member|aha1542_last_mbi_used
r_int
id|aha1542_last_mbi_used
suffix:semicolon
DECL|member|aha1542_last_mbo_used
r_int
id|aha1542_last_mbo_used
suffix:semicolon
DECL|member|SCint
id|Scsi_Cmnd
op_star
id|SCint
(braket
id|AHA1542_MAILBOXES
)braket
suffix:semicolon
DECL|member|mb
r_struct
id|mailbox
id|mb
(braket
l_int|2
op_star
id|AHA1542_MAILBOXES
)braket
suffix:semicolon
DECL|member|ccb
r_struct
id|ccb
id|ccb
(braket
id|AHA1542_MAILBOXES
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(host) ((struct aha1542_hostdata *) &amp;host-&gt;hostdata)
DECL|variable|aha_host
r_static
r_struct
id|Scsi_Host
op_star
id|aha_host
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* One for each IRQ level (9-15) */
DECL|macro|WAITnexttimeout
mdefine_line|#define WAITnexttimeout 3000000
r_static
r_void
id|setup_mailboxes
c_func
(paren
r_int
id|base_io
comma
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
suffix:semicolon
r_static
r_int
id|aha1542_restart
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shost
)paren
suffix:semicolon
r_static
r_void
id|aha1542_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|do_aha1542_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|macro|aha1542_intr_reset
mdefine_line|#define aha1542_intr_reset(base)  outb(IRST, CONTROL(base))
DECL|macro|WAIT
mdefine_line|#define WAIT(port, mask, allof, noneof)&t;&t;&t;&t;&t;&bslash;&n; { register int WAITbits;&t;&t;&t;&t;&t;&t;&bslash;&n;   register int WAITtimeout = WAITnexttimeout;&t;&t;&t;&t;&bslash;&n;   while (1) {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;     WAITbits = inb(port) &amp; (mask);&t;&t;&t;&t;&t;&bslash;&n;     if ((WAITbits &amp; (allof)) == (allof) &amp;&amp; ((WAITbits &amp; (noneof)) == 0)) &bslash;&n;       break;                                                         &t;&bslash;&n;     if (--WAITtimeout == 0) goto fail;&t;&t;&t;&t;&t;&bslash;&n;   }&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n; }
multiline_comment|/* Similar to WAIT, except we use the udelay call to regulate the&n;   amount of time we wait.  */
DECL|macro|WAITd
mdefine_line|#define WAITd(port, mask, allof, noneof, timeout)&t;&t;&t;&bslash;&n; { register int WAITbits;&t;&t;&t;&t;&t;&t;&bslash;&n;   register int WAITtimeout = timeout;&t;&t;&t;&t;&t;&bslash;&n;   while (1) {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;     WAITbits = inb(port) &amp; (mask);&t;&t;&t;&t;&t;&bslash;&n;     if ((WAITbits &amp; (allof)) == (allof) &amp;&amp; ((WAITbits &amp; (noneof)) == 0)) &bslash;&n;       break;                                                         &t;&bslash;&n;     mdelay(1);&t;&t;&t;&t;&t;&t;&t;&bslash;&n;     if (--WAITtimeout == 0) goto fail;&t;&t;&t;&t;&t;&bslash;&n;   }&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n; }
DECL|function|aha1542_stat
r_static
r_void
id|aha1542_stat
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&t;int s = inb(STATUS), i = inb(INTRFLAGS);&n;&t;printk(&quot;status=%x intrflags=%x&bslash;n&quot;, s, i, WAITnexttimeout-WAITtimeout); */
)brace
multiline_comment|/* This is a bit complicated, but we need to make sure that an interrupt&n;   routine does not send something out while we are in the middle of this.&n;   Fortunately, it is only at boot time that multi-byte messages&n;   are ever sent. */
DECL|function|aha1542_out
r_static
r_int
id|aha1542_out
c_func
(paren
r_int
r_int
id|base
comma
id|unchar
op_star
id|cmdp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
(brace
r_while
c_loop
(paren
l_int|1
op_eq
l_int|1
)paren
(brace
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|base
)paren
comma
id|CDF
comma
l_int|0
comma
id|CDF
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|base
)paren
)paren
op_amp
id|CDF
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|outb
c_func
(paren
op_star
id|cmdp
comma
id|DATA
c_func
(paren
id|base
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|base
)paren
comma
id|CDF
comma
l_int|0
comma
id|CDF
)paren
suffix:semicolon
id|outb
c_func
(paren
op_star
id|cmdp
op_increment
comma
id|DATA
c_func
(paren
id|base
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_out failed(%d): &quot;
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|aha1542_stat
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Only used at boot time, so we do not need to worry about latency as much&n;   here */
DECL|function|aha1542_in
r_static
r_int
id|aha1542_in
c_func
(paren
r_int
r_int
id|base
comma
id|unchar
op_star
id|cmdp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|base
)paren
comma
id|DF
comma
id|DF
comma
l_int|0
)paren
suffix:semicolon
op_star
id|cmdp
op_increment
op_assign
id|inb
c_func
(paren
id|DATA
c_func
(paren
id|base
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_in failed(%d): &quot;
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|aha1542_stat
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Similar to aha1542_in, except that we wait a very short period of time.&n;   We use this if we know the board is alive and awake, but we are not sure&n;   if the board will respond to the command we are about to send or not */
DECL|function|aha1542_in1
r_static
r_int
id|aha1542_in1
c_func
(paren
r_int
r_int
id|base
comma
id|unchar
op_star
id|cmdp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|WAITd
c_func
(paren
id|STATUS
c_func
(paren
id|base
)paren
comma
id|DF
comma
id|DF
comma
l_int|0
comma
l_int|100
)paren
suffix:semicolon
op_star
id|cmdp
op_increment
op_assign
id|inb
c_func
(paren
id|DATA
c_func
(paren
id|base
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|makecode
r_static
r_int
id|makecode
c_func
(paren
r_int
id|hosterr
comma
r_int
id|scsierr
)paren
(brace
r_switch
c_cond
(paren
id|hosterr
)paren
(brace
r_case
l_int|0x0
suffix:colon
r_case
l_int|0xa
suffix:colon
multiline_comment|/* Linked command complete without error and linked normally */
r_case
l_int|0xb
suffix:colon
multiline_comment|/* Linked command complete without error, interrupt generated */
id|hosterr
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x11
suffix:colon
multiline_comment|/* Selection time out-The initiator selection or target&n;&t;&t;&t;&t;   reselection was not complete within the SCSI Time out period */
id|hosterr
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x12
suffix:colon
multiline_comment|/* Data overrun/underrun-The target attempted to transfer more data&n;&t;&t;&t;&t;   than was allocated by the Data Length field or the sum of the&n;&t;&t;&t;&t;   Scatter / Gather Data Length fields. */
r_case
l_int|0x13
suffix:colon
multiline_comment|/* Unexpected bus free-The target dropped the SCSI BSY at an unexpected time. */
r_case
l_int|0x15
suffix:colon
multiline_comment|/* MBO command was not 00, 01 or 02-The first byte of the CB was&n;&t;&t;&t;&t;   invalid. This usually indicates a software failure. */
r_case
l_int|0x16
suffix:colon
multiline_comment|/* Invalid CCB Operation Code-The first byte of the CCB was invalid.&n;&t;&t;&t;&t;   This usually indicates a software failure. */
r_case
l_int|0x17
suffix:colon
multiline_comment|/* Linked CCB does not have the same LUN-A subsequent CCB of a set&n;&t;&t;&t;&t;   of linked CCB&squot;s does not specify the same logical unit number as&n;&t;&t;&t;&t;   the first. */
r_case
l_int|0x18
suffix:colon
multiline_comment|/* Invalid Target Direction received from Host-The direction of a&n;&t;&t;&t;&t;   Target Mode CCB was invalid. */
r_case
l_int|0x19
suffix:colon
multiline_comment|/* Duplicate CCB Received in Target Mode-More than once CCB was&n;&t;&t;&t;&t;   received to service data transfer between the same target LUN&n;&t;&t;&t;&t;   and initiator SCSI ID in the same direction. */
r_case
l_int|0x1a
suffix:colon
multiline_comment|/* Invalid CCB or Segment List Parameter-A segment list with a zero&n;&t;&t;&t;&t;   length segment or invalid segment list boundaries was received.&n;&t;&t;&t;&t;   A CCB parameter was invalid. */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Aha1542: %x %x&bslash;n&quot;
comma
id|hosterr
comma
id|scsierr
)paren
)paren
suffix:semicolon
id|hosterr
op_assign
id|DID_ERROR
suffix:semicolon
multiline_comment|/* Couldn&squot;t find any better */
r_break
suffix:semicolon
r_case
l_int|0x14
suffix:colon
multiline_comment|/* Target bus phase sequence failure-An invalid bus phase or bus&n;&t;&t;&t;&t;   phase sequence was requested by the target. The host adapter&n;&t;&t;&t;&t;   will generate a SCSI Reset Condition, notifying the host with&n;&t;&t;&t;&t;   a SCRD interrupt */
id|hosterr
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542: makecode: unknown hoststatus %x&bslash;n&quot;
comma
id|hosterr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|scsierr
op_or
(paren
id|hosterr
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|aha1542_test_port
r_static
r_int
id|aha1542_test_port
c_func
(paren
r_int
id|bse
comma
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|unchar
id|inquiry_cmd
(braket
)braket
op_assign
(brace
id|CMD_INQUIRY
)brace
suffix:semicolon
id|unchar
id|inquiry_result
(braket
l_int|4
)braket
suffix:semicolon
id|unchar
op_star
id|cmdp
suffix:semicolon
r_int
id|len
suffix:semicolon
r_volatile
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Quick and dirty test for presence of the card. */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|bse
)paren
)paren
op_eq
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Reset the adapter. I ought to make a hard reset, but it&squot;s not really necessary */
multiline_comment|/*  DEB(printk(&quot;aha1542_test_port called &bslash;n&quot;)); */
multiline_comment|/* In case some other card was probing here, reset interrupts */
id|aha1542_intr_reset
c_func
(paren
id|bse
)paren
suffix:semicolon
multiline_comment|/* reset interrupts, so they don&squot;t block */
id|outb
c_func
(paren
id|SRST
op_or
id|IRST
multiline_comment|/*|SCRST */
comma
id|CONTROL
c_func
(paren
id|bse
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Wait a little bit for things to settle down. */
id|debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Expect INIT and IDLE, any of the others are bad */
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|bse
)paren
comma
id|STATMASK
comma
id|INIT
op_or
id|IDLE
comma
id|STST
op_or
id|DIAGF
op_or
id|INVDCMD
op_or
id|DF
op_or
id|CDF
)paren
suffix:semicolon
id|debug
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Shouldn&squot;t have generated any interrupts during reset */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|bse
)paren
)paren
op_amp
id|INTRMASK
)paren
r_goto
id|fail
suffix:semicolon
multiline_comment|/* Perform a host adapter inquiry instead so we do not need to set&n;&t;   up the mailboxes ahead of time */
id|aha1542_out
c_func
(paren
id|bse
comma
id|inquiry_cmd
comma
l_int|1
)paren
suffix:semicolon
id|debug
op_assign
l_int|3
suffix:semicolon
id|len
op_assign
l_int|4
suffix:semicolon
id|cmdp
op_assign
op_amp
id|inquiry_result
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|bse
)paren
comma
id|DF
comma
id|DF
comma
l_int|0
)paren
suffix:semicolon
op_star
id|cmdp
op_increment
op_assign
id|inb
c_func
(paren
id|DATA
c_func
(paren
id|bse
)paren
)paren
suffix:semicolon
)brace
id|debug
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Reading port should reset DF */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|bse
)paren
)paren
op_amp
id|DF
)paren
r_goto
id|fail
suffix:semicolon
id|debug
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* When HACC, command is completed, and we&squot;re though testing */
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|bse
)paren
comma
id|HACC
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* now initialize adapter */
id|debug
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Clear interrupts */
id|outb
c_func
(paren
id|IRST
comma
id|CONTROL
c_func
(paren
id|bse
)paren
)paren
suffix:semicolon
id|debug
op_assign
l_int|11
suffix:semicolon
r_return
id|debug
suffix:semicolon
multiline_comment|/* 1 = ok */
id|fail
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* 0 = not ok */
)brace
multiline_comment|/* A quick wrapper for do_aha1542_intr_handle to grab the spin lock */
DECL|function|do_aha1542_intr_handle
r_static
r_void
id|do_aha1542_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|aha1542_intr_handle
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* A &quot;high&quot; level interrupt handler */
DECL|function|aha1542_intr_handle
r_static
r_void
id|aha1542_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
r_int
id|errstatus
comma
id|mbi
comma
id|mbo
comma
id|mbistatus
suffix:semicolon
r_int
id|number_serviced
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shost
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
r_int
id|flag
suffix:semicolon
r_int
id|needs_restart
suffix:semicolon
r_struct
id|mailbox
op_star
id|mb
suffix:semicolon
r_struct
id|ccb
op_star
id|ccb
suffix:semicolon
id|shost
op_assign
id|aha_host
(braket
id|irq
op_minus
l_int|9
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
id|panic
c_func
(paren
l_string|&quot;Splunge!&quot;
)paren
suffix:semicolon
id|mb
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|mb
suffix:semicolon
id|ccb
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|ccb
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
id|flag
op_assign
id|inb
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|shost-&gt;io_port
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha1542_intr_handle: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
op_amp
id|ANYINTR
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;no interrupt?&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|MBIF
)paren
id|printk
c_func
(paren
l_string|&quot;MBIF &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|MBOA
)paren
id|printk
c_func
(paren
l_string|&quot;MBOF &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|HACC
)paren
id|printk
c_func
(paren
l_string|&quot;HACC &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|SCRD
)paren
id|printk
c_func
(paren
l_string|&quot;SCRD &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;status %02x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|shost-&gt;io_port
)paren
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
id|number_serviced
op_assign
l_int|0
suffix:semicolon
id|needs_restart
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
op_eq
l_int|1
)paren
(brace
id|flag
op_assign
id|inb
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|shost-&gt;io_port
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for unusual interrupts.  If any of these happen, we should&n;&t;&t;   probably do something special, but for now just printing a message&n;&t;&t;   is sufficient.  A SCSI reset detected is something that we really&n;&t;&t;   need to deal with in some way. */
r_if
c_cond
(paren
id|flag
op_amp
op_complement
id|MBIF
)paren
(brace
r_if
c_cond
(paren
id|flag
op_amp
id|MBOA
)paren
id|printk
c_func
(paren
l_string|&quot;MBOF &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|HACC
)paren
id|printk
c_func
(paren
l_string|&quot;HACC &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|SCRD
)paren
(brace
id|needs_restart
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCRD &quot;
)paren
suffix:semicolon
)brace
)brace
id|aha1542_intr_reset
c_func
(paren
id|shost-&gt;io_port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mbi
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|aha1542_last_mbi_used
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mbi
op_ge
l_int|2
op_star
id|AHA1542_MAILBOXES
)paren
id|mbi
op_assign
id|AHA1542_MAILBOXES
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|mb
(braket
id|mbi
)braket
dot
id|status
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|mbi
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mbi
op_ge
l_int|2
op_star
id|AHA1542_MAILBOXES
)paren
id|mbi
op_assign
id|AHA1542_MAILBOXES
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mbi
op_ne
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|aha1542_last_mbi_used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
id|mbi
)braket
dot
id|status
op_eq
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Hmm, no mail.  Must have read it the last time around */
r_if
c_cond
(paren
op_logical_neg
id|number_serviced
op_logical_and
op_logical_neg
id|needs_restart
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;aha1542.c: interrupt received, but no mail.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We detected a reset.  Restart all pending commands for&n;&t;&t;&t;   devices that use the hard reset option */
r_if
c_cond
(paren
id|needs_restart
)paren
id|aha1542_restart
c_func
(paren
id|shost
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
id|mbo
op_assign
(paren
id|scsi2int
c_func
(paren
id|mb
(braket
id|mbi
)braket
dot
id|ccbptr
)paren
op_minus
(paren
id|SCSI_PA
c_func
(paren
op_amp
id|ccb
(braket
l_int|0
)braket
)paren
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|ccb
)paren
suffix:semicolon
id|mbistatus
op_assign
id|mb
(braket
id|mbi
)braket
dot
id|status
suffix:semicolon
id|mb
(braket
id|mbi
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|aha1542_last_mbi_used
op_assign
id|mbi
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
r_if
c_cond
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
op_or
id|ccb
(braket
id|mbo
)braket
dot
id|hastat
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha1542_command: returning %x (status %d)&bslash;n&quot;
comma
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
op_plus
(paren
(paren
r_int
)paren
id|ccb
(braket
id|mbo
)braket
dot
id|hastat
op_lshift
l_int|16
)paren
comma
id|mb
(braket
id|mbi
)braket
dot
id|status
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mbistatus
op_eq
l_int|3
)paren
r_continue
suffix:semicolon
multiline_comment|/* Aborted command not found */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;...done %d %d&bslash;n&quot;
comma
id|mbo
comma
id|mbi
)paren
suffix:semicolon
macro_line|#endif
id|SCtmp
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCtmp
op_logical_or
op_logical_neg
id|SCtmp-&gt;scsi_done
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;aha1542_intr_handle: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tarstat=%x, hastat=%x idlun=%x ccb#=%d &bslash;n&quot;
comma
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
comma
id|ccb
(braket
id|mbo
)braket
dot
id|hastat
comma
id|ccb
(braket
id|mbo
)braket
dot
id|idlun
comma
id|mbo
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|my_done
op_assign
id|SCtmp-&gt;scsi_done
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
(brace
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
id|SCtmp-&gt;host_scribble
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fetch the sense data, and tuck it away, in the required slot.  The&n;&t;&t;   Adaptec automatically fetches it, and there is no guarantee that&n;&t;&t;   we will still have it in the cdb when we come back */
r_if
c_cond
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
op_eq
l_int|2
)paren
id|memcpy
c_func
(paren
id|SCtmp-&gt;sense_buffer
comma
op_amp
id|ccb
(braket
id|mbo
)braket
dot
id|cdb
(braket
id|ccb
(braket
id|mbo
)braket
dot
id|cdblen
)braket
comma
r_sizeof
(paren
id|SCtmp-&gt;sense_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/* is there mail :-) */
multiline_comment|/* more error checking left out here */
r_if
c_cond
(paren
id|mbistatus
op_ne
l_int|1
)paren
multiline_comment|/* This is surely wrong, but I don&squot;t know what&squot;s right */
id|errstatus
op_assign
id|makecode
c_func
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|hastat
comma
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
)paren
suffix:semicolon
r_else
id|errstatus
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|errstatus
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;(aha1542 error:%x %x %x) &quot;
comma
id|errstatus
comma
id|ccb
(braket
id|mbo
)braket
dot
id|hastat
comma
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|tarstat
op_eq
l_int|2
)paren
(brace
macro_line|#ifdef DEBUG
r_int
id|i
suffix:semicolon
macro_line|#endif
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1542_intr_handle: sense:&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|ccb
(braket
id|mbo
)braket
dot
id|cdb
(braket
id|ccb
(braket
id|mbo
)braket
dot
id|cdblen
op_plus
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;   DEB(printk(&quot;aha1542_intr_handle: buf:&quot;));&n;&t;&t;&t;   for (i = 0; i &lt; bufflen; i++)&n;&t;&t;&t;   printk(&quot;%02x &quot;, ((unchar *)buff)[i]);&n;&t;&t;&t;   printk(&quot;&bslash;n&quot;);&n;&t;&t;&t; */
)brace
id|DEB
c_func
(paren
r_if
(paren
id|errstatus
)paren
id|printk
c_func
(paren
l_string|&quot;aha1542_intr_handle: returning %6x&bslash;n&quot;
comma
id|errstatus
)paren
)paren
suffix:semicolon
id|SCtmp-&gt;result
op_assign
id|errstatus
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* This effectively frees up the mailbox slot, as&n;&t;&t;&t;&t;&t;&t;&t;   far as queuecommand is concerned */
id|my_done
c_func
(paren
id|SCtmp
)paren
suffix:semicolon
id|number_serviced
op_increment
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|function|aha1542_queuecommand
r_int
id|aha1542_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|unchar
id|ahacmd
op_assign
id|CMD_START_SCSI
suffix:semicolon
id|unchar
id|direction
suffix:semicolon
id|unchar
op_star
id|cmd
op_assign
(paren
id|unchar
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
id|unchar
id|target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|unchar
id|lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_void
op_star
id|buff
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_int
id|bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_int
id|mbo
suffix:semicolon
r_struct
id|mailbox
op_star
id|mb
suffix:semicolon
r_struct
id|ccb
op_star
id|ccb
suffix:semicolon
id|DEB
c_func
(paren
r_int
id|i
)paren
suffix:semicolon
id|mb
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
suffix:semicolon
id|ccb
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|ccb
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|target
OG
l_int|1
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|REQUEST_SENSE
)paren
(brace
multiline_comment|/* Don&squot;t do the command - we have the sense data already */
macro_line|#if 0
multiline_comment|/* scsi_request_sense() provides a buffer of size 256,&n;&t;&t;   so there is no reason to expect equality */
r_if
c_cond
(paren
id|bufflen
op_ne
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aha1542: Wrong buffer length supplied &quot;
l_string|&quot;for request sense (%d)&bslash;n&quot;
comma
id|bufflen
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|READ_10
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_10
)paren
id|i
op_assign
id|xscsi2int
c_func
(paren
id|cmd
op_plus
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|READ_6
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_6
)paren
id|i
op_assign
id|scsi2int
c_func
(paren
id|cmd
op_plus
l_int|2
)paren
suffix:semicolon
r_else
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha1542_queuecommand: dev %d cmd %02x pos %d len %d &quot;
comma
id|target
comma
op_star
id|cmd
comma
id|i
comma
id|bufflen
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha1542_command: dev %d cmd %02x pos %d len %d &quot;
comma
id|target
comma
op_star
id|cmd
comma
id|i
comma
id|bufflen
)paren
suffix:semicolon
id|aha1542_stat
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha1542_queuecommand: dumping scsi cmd:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|cmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|WRITE_10
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_6
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* we are still testing, so *don&squot;t* write */
macro_line|#endif
multiline_comment|/* Use the outgoing mailboxes in a round-robin fashion, because this&n;&t;   is how the host adapter will scan for them */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mbo
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mbo
op_ge
id|AHA1542_MAILBOXES
)paren
id|mbo
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|mb
(braket
id|mbo
)braket
dot
id|status
op_eq
l_int|0
op_logical_and
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|mbo
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mbo
op_ge
id|AHA1542_MAILBOXES
)paren
id|mbo
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mbo
op_ne
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
id|mbo
)braket
dot
id|status
op_logical_or
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
)paren
id|panic
c_func
(paren
l_string|&quot;Unable to find empty mailbox for aha1542.&bslash;n&quot;
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
op_assign
id|SCpnt
suffix:semicolon
multiline_comment|/* This will effectively prevent someone else from&n;&t;&t;&t;&t;&t;&t;&t;   screwing with this cdb. */
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
op_assign
id|mbo
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Sending command (%d %x)...&quot;
comma
id|mbo
comma
id|done
)paren
suffix:semicolon
macro_line|#endif
id|any2scsi
c_func
(paren
id|mb
(braket
id|mbo
)braket
dot
id|ccbptr
comma
id|SCSI_PA
c_func
(paren
op_amp
id|ccb
(braket
id|mbo
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* This gets trashed for some reason */
id|memset
c_func
(paren
op_amp
id|ccb
(braket
id|mbo
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccb
)paren
)paren
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|cdblen
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|direction
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|READ_10
op_logical_or
op_star
id|cmd
op_eq
id|READ_6
)paren
id|direction
op_assign
l_int|8
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|WRITE_10
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_6
)paren
id|direction
op_assign
l_int|16
suffix:semicolon
id|memcpy
c_func
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|cdb
comma
id|cmd
comma
id|ccb
(braket
id|mbo
)braket
dot
id|cdblen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sgpnt
suffix:semicolon
r_struct
id|chain
op_star
id|cptr
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
r_char
op_star
id|ptr
suffix:semicolon
macro_line|#endif
r_int
id|i
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|op
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* SCSI Initiator Command  w/scatter-gather */
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|scsi_malloc
c_func
(paren
l_int|512
)paren
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|cptr
op_assign
(paren
r_struct
id|chain
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;aha1542.c: unable to allocate DMA memory&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sgpnt
(braket
id|i
)braket
dot
id|length
op_eq
l_int|0
op_logical_or
id|SCpnt-&gt;use_sg
OG
l_int|16
op_logical_or
(paren
(paren
(paren
r_int
)paren
id|sgpnt
(braket
id|i
)braket
dot
id|address
)paren
op_amp
l_int|1
)paren
op_logical_or
(paren
id|sgpnt
(braket
id|i
)braket
dot
id|length
op_amp
l_int|1
)paren
)paren
(brace
r_int
r_char
op_star
id|ptr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Bad segment list supplied to aha1542.c (%d, %d)&bslash;n&quot;
comma
id|SCpnt-&gt;use_sg
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%d: %x %x %d&bslash;n&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|sgpnt
(braket
id|i
)braket
dot
id|address
comma
(paren
r_int
r_int
)paren
id|sgpnt
(braket
id|i
)braket
dot
id|alt_address
comma
id|sgpnt
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;cptr %x: &quot;
comma
(paren
r_int
r_int
)paren
id|cptr
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|cptr
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Foooooooood fight!&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
id|any2scsi
c_func
(paren
id|cptr
(braket
id|i
)braket
dot
id|dataptr
comma
id|SCSI_PA
c_func
(paren
id|sgpnt
(braket
id|i
)braket
dot
id|address
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCSI_PA
c_func
(paren
id|sgpnt
(braket
id|i
)braket
dot
id|address
op_plus
id|sgpnt
(braket
id|i
)braket
dot
id|length
op_minus
l_int|1
)paren
OG
id|ISA_DMA_THRESHOLD
)paren
id|BAD_SG_DMA
c_func
(paren
id|SCpnt
comma
id|sgpnt
comma
id|SCpnt-&gt;use_sg
comma
id|i
)paren
suffix:semicolon
id|any2scsi
c_func
(paren
id|cptr
(braket
id|i
)braket
dot
id|datalen
comma
id|sgpnt
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
)brace
suffix:semicolon
id|any2scsi
c_func
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|datalen
comma
id|SCpnt-&gt;use_sg
op_star
r_sizeof
(paren
r_struct
id|chain
)paren
)paren
suffix:semicolon
id|any2scsi
c_func
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|dataptr
comma
id|SCSI_PA
c_func
(paren
id|cptr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;cptr %x: &quot;
comma
id|cptr
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|cptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|ccb
(braket
id|mbo
)braket
dot
id|op
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* SCSI Initiator Command */
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|any2scsi
c_func
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|datalen
comma
id|bufflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_logical_and
id|SCSI_PA
c_func
(paren
id|buff
op_plus
id|bufflen
op_minus
l_int|1
)paren
OG
id|ISA_DMA_THRESHOLD
)paren
id|BAD_DMA
c_func
(paren
id|buff
comma
id|bufflen
)paren
suffix:semicolon
id|any2scsi
c_func
(paren
id|ccb
(braket
id|mbo
)braket
dot
id|dataptr
comma
id|SCSI_PA
c_func
(paren
id|buff
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|idlun
op_assign
(paren
id|target
op_amp
l_int|7
)paren
op_lshift
l_int|5
op_or
id|direction
op_or
(paren
id|lun
op_amp
l_int|7
)paren
suffix:semicolon
multiline_comment|/*SCSI Target Id */
id|ccb
(braket
id|mbo
)braket
dot
id|rsalen
op_assign
l_int|16
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|linkptr
(braket
l_int|0
)braket
op_assign
id|ccb
(braket
id|mbo
)braket
dot
id|linkptr
(braket
l_int|1
)braket
op_assign
id|ccb
(braket
id|mbo
)braket
dot
id|linkptr
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|commlinkid
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha1542_command: sending.. &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ccb
(braket
id|mbo
)braket
)paren
op_minus
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
id|unchar
op_star
)paren
op_amp
id|ccb
(braket
id|mbo
)braket
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|done
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1542_queuecommand: now waiting for interrupt &quot;
)paren
suffix:semicolon
id|aha1542_stat
c_func
(paren
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|mb
(braket
id|mbo
)braket
dot
id|status
op_assign
l_int|1
suffix:semicolon
id|aha1542_out
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
op_amp
id|ahacmd
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* start scsi command */
id|DEB
c_func
(paren
id|aha1542_stat
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;aha1542_queuecommand: done can&squot;t be NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|SCpnt-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
DECL|function|aha1542_command
r_int
id|aha1542_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1542_command: ..calling aha1542_queuecommand&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|aha1542_queuecommand
c_func
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCpnt-&gt;SCp.Status
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
multiline_comment|/* Initialize mailboxes */
DECL|function|setup_mailboxes
r_static
r_void
id|setup_mailboxes
c_func
(paren
r_int
id|bse
comma
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|mailbox
op_star
id|mb
suffix:semicolon
r_struct
id|ccb
op_star
id|ccb
suffix:semicolon
id|unchar
id|cmd
(braket
l_int|5
)braket
op_assign
(brace
id|CMD_MBINIT
comma
id|AHA1542_MAILBOXES
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|mb
op_assign
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|mb
suffix:semicolon
id|ccb
op_assign
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|ccb
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
id|mb
(braket
id|AHA1542_MAILBOXES
op_plus
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|any2scsi
c_func
(paren
id|mb
(braket
id|i
)braket
dot
id|ccbptr
comma
id|SCSI_PA
c_func
(paren
op_amp
id|ccb
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|aha1542_intr_reset
c_func
(paren
id|bse
)paren
suffix:semicolon
multiline_comment|/* reset interrupts, so they don&squot;t block */
id|any2scsi
c_func
(paren
(paren
id|cmd
op_plus
l_int|2
)paren
comma
id|SCSI_PA
c_func
(paren
id|mb
)paren
)paren
suffix:semicolon
id|aha1542_out
c_func
(paren
id|bse
comma
id|cmd
comma
l_int|5
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|bse
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|0
)paren
(brace
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_detect: failed setting up mailboxes&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|aha1542_intr_reset
c_func
(paren
id|bse
)paren
suffix:semicolon
)brace
DECL|function|aha1542_getconfig
r_static
r_int
id|aha1542_getconfig
c_func
(paren
r_int
id|base_io
comma
r_int
r_char
op_star
id|irq_level
comma
r_int
r_char
op_star
id|dma_chan
comma
r_int
r_char
op_star
id|scsi_id
)paren
(brace
id|unchar
id|inquiry_cmd
(braket
)braket
op_assign
(brace
id|CMD_RETCONF
)brace
suffix:semicolon
id|unchar
id|inquiry_result
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|base_io
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|DF
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|DATA
c_func
(paren
id|base_io
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base_io
comma
id|inquiry_cmd
comma
l_int|1
)paren
suffix:semicolon
id|aha1542_in
c_func
(paren
id|base_io
comma
id|inquiry_result
comma
l_int|3
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base_io
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|0
)paren
(brace
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_detect: query board settings&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|aha1542_intr_reset
c_func
(paren
id|base_io
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|inquiry_result
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x80
suffix:colon
op_star
id|dma_chan
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
op_star
id|dma_chan
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
op_star
id|dma_chan
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
op_star
id|dma_chan
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* This means that the adapter, although Adaptec 1542 compatible, doesn&squot;t use a DMA channel.&n;&t;&t;   Currently only aware of the BusLogic BT-445S VL-Bus adapter which needs this. */
op_star
id|dma_chan
op_assign
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to determine Adaptec DMA priority.  Disabling board&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|inquiry_result
(braket
l_int|1
)braket
)paren
(brace
r_case
l_int|0x40
suffix:colon
op_star
id|irq_level
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
op_star
id|irq_level
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
op_star
id|irq_level
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4
suffix:colon
op_star
id|irq_level
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2
suffix:colon
op_star
id|irq_level
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1
suffix:colon
op_star
id|irq_level
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to determine Adaptec IRQ level.  Disabling board&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
suffix:semicolon
op_star
id|scsi_id
op_assign
id|inquiry_result
(braket
l_int|2
)braket
op_amp
l_int|7
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function should only be called for 1542C boards - we can detect&n;   the special firmware settings and unlock the board */
DECL|function|aha1542_mbenable
r_static
r_int
id|aha1542_mbenable
c_func
(paren
r_int
id|base
)paren
(brace
r_static
id|unchar
id|mbenable_cmd
(braket
l_int|3
)braket
suffix:semicolon
r_static
id|unchar
id|mbenable_result
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|BIOS_TRANSLATION_6432
suffix:semicolon
id|mbenable_cmd
(braket
l_int|0
)braket
op_assign
id|CMD_EXTBIOS
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base
comma
id|mbenable_cmd
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aha1542_in1
c_func
(paren
id|base
comma
id|mbenable_result
comma
l_int|2
)paren
)paren
r_return
id|retval
suffix:semicolon
id|WAITd
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
comma
l_int|100
)paren
suffix:semicolon
id|aha1542_intr_reset
c_func
(paren
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mbenable_result
(braket
l_int|0
)braket
op_amp
l_int|0x08
)paren
op_logical_or
id|mbenable_result
(braket
l_int|1
)braket
)paren
(brace
id|mbenable_cmd
(braket
l_int|0
)braket
op_assign
id|CMD_MBENABLE
suffix:semicolon
id|mbenable_cmd
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|mbenable_cmd
(braket
l_int|2
)braket
op_assign
id|mbenable_result
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mbenable_result
(braket
l_int|0
)braket
op_amp
l_int|0x08
)paren
op_logical_and
(paren
id|mbenable_result
(braket
l_int|1
)braket
op_amp
l_int|0x03
)paren
)paren
id|retval
op_assign
id|BIOS_TRANSLATION_25563
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base
comma
id|mbenable_cmd
comma
l_int|3
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
)brace
suffix:semicolon
r_while
c_loop
(paren
l_int|0
)paren
(brace
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_mbenable: Mailbox init failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|aha1542_intr_reset
c_func
(paren
id|base
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Query the board to find out if it is a 1542 or a 1740, or whatever. */
DECL|function|aha1542_query
r_static
r_int
id|aha1542_query
c_func
(paren
r_int
id|base_io
comma
r_int
op_star
id|transl
)paren
(brace
id|unchar
id|inquiry_cmd
(braket
)braket
op_assign
(brace
id|CMD_INQUIRY
)brace
suffix:semicolon
id|unchar
id|inquiry_result
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|base_io
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|DF
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|DATA
c_func
(paren
id|base_io
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base_io
comma
id|inquiry_cmd
comma
l_int|1
)paren
suffix:semicolon
id|aha1542_in
c_func
(paren
id|base_io
comma
id|inquiry_result
comma
l_int|4
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base_io
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|0
)paren
(brace
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_detect: query card type&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|aha1542_intr_reset
c_func
(paren
id|base_io
)paren
suffix:semicolon
op_star
id|transl
op_assign
id|BIOS_TRANSLATION_6432
suffix:semicolon
multiline_comment|/* Default case */
multiline_comment|/* For an AHA1740 series board, we ignore the board since there is a&n;&t;   hardware bug which can lead to wrong blocks being returned if the board&n;&t;   is operating in the 1542 emulation mode.  Since there is an extended mode&n;&t;   driver, we simply ignore the board and let the 1740 driver pick it up.&n;&t; */
r_if
c_cond
(paren
id|inquiry_result
(braket
l_int|0
)braket
op_eq
l_int|0x43
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha1542.c: Emulation mode not supported for AHA 174N hardware.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Always call this - boards that do not support extended bios translation&n;&t;   will ignore the command, and we will set the proper default */
op_star
id|transl
op_assign
id|aha1542_mbenable
c_func
(paren
id|base_io
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* called from init/main.c */
DECL|function|aha1542_setup
r_void
id|__init
id|aha1542_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_const
r_char
op_star
id|ahausage
op_assign
l_string|&quot;aha1542: usage: aha1542=&lt;PORTBASE&gt;[,&lt;BUSON&gt;,&lt;BUSOFF&gt;[,&lt;DMASPEED&gt;]]&bslash;n&quot;
suffix:semicolon
r_static
r_int
id|setup_idx
op_assign
l_int|0
suffix:semicolon
r_int
id|setup_portbase
suffix:semicolon
r_if
c_cond
(paren
id|setup_idx
op_ge
id|MAXBOARDS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542: aha1542_setup called too many times! Bad LILO params ?&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;   Entryline 1: %s&bslash;n&quot;
comma
id|setup_str
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;   Entryline 2: %s&bslash;n&quot;
comma
id|setup_str
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;   This line:   %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
template_param
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542: %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
id|printk
c_func
(paren
id|ahausage
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542: Wrong parameters may cause system malfunction.. We try anyway..&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|setup_called
(braket
id|setup_idx
)braket
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|setup_str
(braket
id|setup_idx
)braket
op_assign
id|str
suffix:semicolon
id|setup_portbase
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|1
ques
c_cond
id|ints
(braket
l_int|1
)braket
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Preserve the default value.. */
id|setup_buson
(braket
id|setup_idx
)braket
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|2
ques
c_cond
id|ints
(braket
l_int|2
)braket
suffix:colon
l_int|7
suffix:semicolon
id|setup_busoff
(braket
id|setup_idx
)braket
op_assign
id|ints
(braket
l_int|0
)braket
op_ge
l_int|3
ques
c_cond
id|ints
(braket
l_int|3
)braket
suffix:colon
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|4
)paren
(brace
r_int
id|atbt
op_assign
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|ints
(braket
l_int|4
)braket
)paren
(brace
r_case
l_int|5
suffix:colon
id|atbt
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|atbt
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|atbt
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|atbt
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|atbt
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542: %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
id|printk
c_func
(paren
id|ahausage
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542: Valid values for DMASPEED are 5-8, 10 MB/s.  Using jumper defaults.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|setup_dmaspeed
(braket
id|setup_idx
)braket
op_assign
id|atbt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup_portbase
op_ne
l_int|0
)paren
id|bases
(braket
id|setup_idx
)braket
op_assign
id|setup_portbase
suffix:semicolon
op_increment
id|setup_idx
suffix:semicolon
)brace
multiline_comment|/* return non-zero on detection */
DECL|function|aha1542_detect
r_int
id|aha1542_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_char
id|dma_chan
suffix:semicolon
r_int
r_char
id|irq_level
suffix:semicolon
r_int
r_char
id|scsi_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|base_io
suffix:semicolon
r_int
id|trans
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|indx
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1542_detect: &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;aha1542&quot;
suffix:semicolon
macro_line|#ifdef MODULE
id|bases
(braket
l_int|0
)braket
op_assign
id|aha1542
(braket
l_int|0
)braket
suffix:semicolon
id|setup_buson
(braket
l_int|0
)braket
op_assign
id|aha1542
(braket
l_int|1
)braket
suffix:semicolon
id|setup_busoff
(braket
l_int|0
)braket
op_assign
id|aha1542
(braket
l_int|2
)braket
suffix:semicolon
(brace
r_int
id|atbt
op_assign
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|aha1542
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|5
suffix:colon
id|atbt
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|atbt
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|atbt
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|atbt
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|atbt
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|setup_dmaspeed
(braket
l_int|0
)braket
op_assign
id|atbt
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Find MicroChannel cards (AHA1640)&n;&t; */
macro_line|#ifdef CONFIG_MCA
r_if
c_cond
(paren
id|MCA_bus
)paren
(brace
r_int
id|slot
op_assign
l_int|0
suffix:semicolon
r_int
id|pos
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|indx
op_assign
l_int|0
suffix:semicolon
(paren
id|slot
op_ne
id|MCA_NOTFOUND
)paren
op_logical_and
(paren
id|indx
OL
r_sizeof
(paren
id|bases
)paren
op_div
r_sizeof
(paren
id|bases
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|indx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bases
(braket
id|indx
)braket
)paren
r_continue
suffix:semicolon
multiline_comment|/* Detect only AHA-1640 cards -- MCA ID 0F1F */
id|slot
op_assign
id|mca_find_unused_adapter
c_func
(paren
l_int|0x0f1f
comma
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
id|MCA_NOTFOUND
)paren
r_break
suffix:semicolon
multiline_comment|/* Found one */
id|pos
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Decode address */
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x02
)paren
(brace
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x01
)paren
id|bases
(braket
id|indx
)braket
op_assign
l_int|0x334
suffix:semicolon
r_else
id|bases
(braket
id|indx
)braket
op_assign
l_int|0x234
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x01
)paren
id|bases
(braket
id|indx
)braket
op_assign
l_int|0x134
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x02
)paren
(brace
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x01
)paren
id|bases
(braket
id|indx
)braket
op_assign
l_int|0x330
suffix:semicolon
r_else
id|bases
(braket
id|indx
)braket
op_assign
l_int|0x230
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pos
op_amp
l_int|0x01
)paren
id|bases
(braket
id|indx
)braket
op_assign
l_int|0x130
suffix:semicolon
)brace
)brace
multiline_comment|/* No need to decode IRQ and Arb level -- those are&n;&t;&t;&t; * read off the card later.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found an AHA-1640 in MCA slot %d, I/O 0x%04x&bslash;n&quot;
comma
id|slot
comma
id|bases
(braket
id|indx
)braket
)paren
suffix:semicolon
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;Adapter AHA-1640&quot;
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|slot
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|slot
)paren
suffix:semicolon
multiline_comment|/* Go on */
id|slot
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Hunt for ISA Plug&squot;n&squot;Pray Adaptecs (AHA1535)&n;&t; */
r_if
c_cond
(paren
id|isapnp
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|indx
op_assign
l_int|0
suffix:semicolon
id|indx
OL
r_sizeof
(paren
id|bases
)paren
op_div
r_sizeof
(paren
id|bases
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|indx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bases
(braket
id|indx
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
id|pdev
op_assign
id|isapnp_find_dev
c_func
(paren
l_int|NULL
comma
id|ISAPNP_VENDOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;P&squot;
)paren
comma
id|ISAPNP_FUNCTION
c_func
(paren
l_int|0x1542
)paren
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Activate the PnP card&n;&t;&t;&t; */
r_if
c_cond
(paren
id|pdev
op_member_access_from_pointer
id|prepare
c_func
(paren
id|pdev
)paren
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|IORESOURCE_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|pdev
op_member_access_from_pointer
id|activate
c_func
(paren
id|pdev
)paren
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|bases
(braket
id|indx
)braket
op_assign
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
multiline_comment|/* The card can be queried for its DMA, we have &n;&t;&t;&t;   the DMA set up that is enough */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ISAPnP found an AHA1535 at I/O 0x%03X&bslash;n&quot;
comma
id|bases
(braket
id|indx
)braket
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|indx
op_assign
l_int|0
suffix:semicolon
id|indx
OL
r_sizeof
(paren
id|bases
)paren
op_div
r_sizeof
(paren
id|bases
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|indx
op_increment
)paren
r_if
c_cond
(paren
id|bases
(braket
id|indx
)braket
op_ne
l_int|0
op_logical_and
op_logical_neg
id|check_region
c_func
(paren
id|bases
(braket
id|indx
)braket
comma
l_int|4
)paren
)paren
(brace
id|shpnt
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|aha1542_hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shpnt
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* For now we do this - until kmalloc is more intelligent&n;&t;&t;&t;   we are resigned to stupid hacks like this */
r_if
c_cond
(paren
id|SCSI_PA
c_func
(paren
id|shpnt
)paren
op_ge
id|ISA_DMA_THRESHOLD
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid address for shpnt with 1542.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unregister
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|aha1542_test_port
c_func
(paren
id|bases
(braket
id|indx
)braket
comma
id|shpnt
)paren
)paren
r_goto
id|unregister
suffix:semicolon
id|base_io
op_assign
id|bases
(braket
id|indx
)braket
suffix:semicolon
multiline_comment|/* Set the Bus on/off-times as not to ruin floppy performance */
(brace
id|unchar
id|oncmd
(braket
)braket
op_assign
(brace
id|CMD_BUSON_TIME
comma
l_int|7
)brace
suffix:semicolon
id|unchar
id|offcmd
(braket
)braket
op_assign
(brace
id|CMD_BUSOFF_TIME
comma
l_int|5
)brace
suffix:semicolon
r_if
c_cond
(paren
id|setup_called
(braket
id|indx
)braket
)paren
(brace
id|oncmd
(braket
l_int|1
)braket
op_assign
id|setup_buson
(braket
id|indx
)braket
suffix:semicolon
id|offcmd
(braket
l_int|1
)braket
op_assign
id|setup_busoff
(braket
id|indx
)braket
suffix:semicolon
)brace
id|aha1542_intr_reset
c_func
(paren
id|base_io
)paren
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base_io
comma
id|oncmd
comma
l_int|2
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base_io
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
id|aha1542_intr_reset
c_func
(paren
id|base_io
)paren
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base_io
comma
id|offcmd
comma
l_int|2
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base_io
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup_dmaspeed
(braket
id|indx
)braket
op_ge
l_int|0
)paren
(brace
id|unchar
id|dmacmd
(braket
)braket
op_assign
(brace
id|CMD_DMASPEED
comma
l_int|0
)brace
suffix:semicolon
id|dmacmd
(braket
l_int|1
)braket
op_assign
id|setup_dmaspeed
(braket
id|indx
)braket
suffix:semicolon
id|aha1542_intr_reset
c_func
(paren
id|base_io
)paren
suffix:semicolon
id|aha1542_out
c_func
(paren
id|base_io
comma
id|dmacmd
comma
l_int|2
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|base_io
)paren
comma
id|INTRMASK
comma
id|HACC
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|0
)paren
(brace
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542_detect: setting bus on/off-time failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|aha1542_intr_reset
c_func
(paren
id|base_io
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aha1542_query
c_func
(paren
id|base_io
comma
op_amp
id|trans
)paren
)paren
r_goto
id|unregister
suffix:semicolon
r_if
c_cond
(paren
id|aha1542_getconfig
c_func
(paren
id|base_io
comma
op_amp
id|irq_level
comma
op_amp
id|dma_chan
comma
op_amp
id|scsi_id
)paren
op_eq
op_minus
l_int|1
)paren
r_goto
id|unregister
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Configuring Adaptec (SCSI-ID %d) at IO:%x, IRQ %d&quot;
comma
id|scsi_id
comma
id|base_io
comma
id|irq_level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_chan
op_ne
l_int|0xFF
)paren
id|printk
c_func
(paren
l_string|&quot;, DMA priority %d&quot;
comma
id|dma_chan
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|aha1542_stat
c_func
(paren
)paren
)paren
suffix:semicolon
id|setup_mailboxes
c_func
(paren
id|base_io
comma
id|shpnt
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|aha1542_stat
c_func
(paren
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1542_detect: enable interrupt channel %d&bslash;n&quot;
comma
id|irq_level
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq_level
comma
id|do_aha1542_intr_handle
comma
l_int|0
comma
l_string|&quot;aha1542&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to allocate IRQ for adaptec controller.&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|unregister
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_chan
op_ne
l_int|0xFF
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dma_chan
comma
l_string|&quot;aha1542&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to allocate DMA channel for Adaptec.&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq_level
comma
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|unregister
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_chan
op_eq
l_int|0
op_logical_or
id|dma_chan
op_ge
l_int|5
)paren
(brace
id|set_dma_mode
c_func
(paren
id|dma_chan
comma
id|DMA_MODE_CASCADE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
)brace
)brace
id|aha_host
(braket
id|irq_level
op_minus
l_int|9
)braket
op_assign
id|shpnt
suffix:semicolon
id|shpnt-&gt;this_id
op_assign
id|scsi_id
suffix:semicolon
id|shpnt-&gt;unique_id
op_assign
id|base_io
suffix:semicolon
id|shpnt-&gt;io_port
op_assign
id|base_io
suffix:semicolon
id|shpnt-&gt;n_io_port
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Number of bytes of I/O space used */
id|shpnt-&gt;dma_channel
op_assign
id|dma_chan
suffix:semicolon
id|shpnt-&gt;irq
op_assign
id|irq_level
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|bios_translation
op_assign
id|trans
suffix:semicolon
r_if
c_cond
(paren
id|trans
op_eq
id|BIOS_TRANSLATION_25563
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aha1542.c: Using extended bios translation&bslash;n&quot;
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|aha1542_last_mbi_used
op_assign
(paren
l_int|2
op_star
id|AHA1542_MAILBOXES
op_minus
l_int|1
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
op_assign
(paren
id|AHA1542_MAILBOXES
op_minus
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|SCint
comma
l_int|0
comma
r_sizeof
(paren
id|HOSTDATA
c_func
(paren
id|shpnt
)paren
op_member_access_from_pointer
id|SCint
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if 0
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; *** READ CAPACITY ***&bslash;n&quot;
)paren
)paren
suffix:semicolon
(brace
id|unchar
id|buf
(braket
l_int|8
)braket
suffix:semicolon
r_static
id|unchar
id|cmd
(braket
)braket
op_assign
(brace
id|READ_CAPACITY
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
op_increment
id|i
)paren
id|buf
(braket
id|i
)braket
op_assign
l_int|0x87
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
op_logical_neg
id|aha1542_command
c_func
(paren
id|i
comma
id|cmd
comma
id|buf
comma
r_sizeof
(paren
id|buf
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aha_detect: LU %d sector_size %d device_size %d&bslash;n&quot;
comma
id|i
comma
id|xscsi2int
c_func
(paren
id|buf
op_plus
l_int|4
)paren
comma
id|xscsi2int
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
)brace
)brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; *** NOW RUNNING MY OWN TEST *** &bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
op_increment
id|i
)paren
(brace
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
r_static
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_10
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|xany2scsi
c_func
(paren
id|cmd
op_plus
l_int|2
comma
id|i
)paren
suffix:semicolon
id|cmd
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd
(braket
l_int|8
)braket
op_assign
l_int|1
suffix:semicolon
id|cmd
(braket
l_int|9
)braket
op_assign
l_int|0
suffix:semicolon
id|aha1542_command
c_func
(paren
l_int|0
comma
id|cmd
comma
id|buffer
comma
l_int|512
)paren
suffix:semicolon
)brace
macro_line|#endif
id|request_region
c_func
(paren
id|bases
(braket
id|indx
)braket
comma
l_int|4
comma
l_string|&quot;aha1542&quot;
)paren
suffix:semicolon
multiline_comment|/* Register the IO ports that we use */
id|count
op_increment
suffix:semicolon
r_continue
suffix:semicolon
id|unregister
suffix:colon
id|scsi_unregister
c_func
(paren
id|shpnt
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|aha1542_restart
r_static
r_int
id|aha1542_restart
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shost
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|unchar
id|ahacmd
op_assign
id|CMD_START_SCSI
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_logical_and
op_logical_neg
(paren
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_member_access_from_pointer
id|device-&gt;soft_reset
)paren
)paren
(brace
macro_line|#if 0
id|HOSTDATA
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Indicate ready to restart... */
macro_line|#endif
id|count
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Potential to restart %d stalled commands...&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* start scsi command */
r_if
c_cond
(paren
id|count
)paren
id|aha1542_out
c_func
(paren
id|shost-&gt;io_port
comma
op_amp
id|ahacmd
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aha1542_abort
r_int
id|aha1542_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
multiline_comment|/*&n;&t; * The abort command does not leave the device in a clean state where&n;&t; *  it is available to be used again.  Until this gets worked out, we&n;&t; * will leave it commented out.  &n;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aha1542.c: Unable to abort command for target %d&bslash;n&quot;
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/*&n; * This is a device reset.  This is handled by sending a special command&n; * to the device.&n; */
DECL|function|aha1542_dev_reset
r_int
id|aha1542_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|mailbox
op_star
id|mb
suffix:semicolon
id|unchar
id|target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|unchar
id|lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
r_int
id|mbo
suffix:semicolon
r_struct
id|ccb
op_star
id|ccb
suffix:semicolon
id|unchar
id|ahacmd
op_assign
id|CMD_START_SCSI
suffix:semicolon
id|ccb
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|ccb
suffix:semicolon
id|mb
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mbo
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mbo
op_ge
id|AHA1542_MAILBOXES
)paren
id|mbo
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|mb
(braket
id|mbo
)braket
dot
id|status
op_eq
l_int|0
op_logical_and
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|mbo
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mbo
op_ge
id|AHA1542_MAILBOXES
)paren
id|mbo
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mbo
op_ne
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
id|mbo
)braket
dot
id|status
op_logical_or
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
)paren
id|panic
c_func
(paren
l_string|&quot;Unable to find empty mailbox for aha1542.&bslash;n&quot;
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
op_assign
id|SCpnt
suffix:semicolon
multiline_comment|/* This will effectively&n;&t;&t;&t;&t;&t;&t;&t;   prevent someone else from&n;&t;&t;&t;&t;&t;&t;&t;   screwing with this cdb. */
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbo_used
op_assign
id|mbo
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|any2scsi
c_func
(paren
id|mb
(braket
id|mbo
)braket
dot
id|ccbptr
comma
id|SCSI_PA
c_func
(paren
op_amp
id|ccb
(braket
id|mbo
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* This gets trashed for some reason */
id|memset
c_func
(paren
op_amp
id|ccb
(braket
id|mbo
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccb
)paren
)paren
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|op
op_assign
l_int|0x81
suffix:semicolon
multiline_comment|/* BUS DEVICE RESET */
id|ccb
(braket
id|mbo
)braket
dot
id|idlun
op_assign
(paren
id|target
op_amp
l_int|7
)paren
op_lshift
l_int|5
op_or
(paren
id|lun
op_amp
l_int|7
)paren
suffix:semicolon
multiline_comment|/*SCSI Target Id */
id|ccb
(braket
id|mbo
)braket
dot
id|linkptr
(braket
l_int|0
)braket
op_assign
id|ccb
(braket
id|mbo
)braket
dot
id|linkptr
(braket
l_int|1
)braket
op_assign
id|ccb
(braket
id|mbo
)braket
dot
id|linkptr
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ccb
(braket
id|mbo
)braket
dot
id|commlinkid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; * Now tell the 1542 to flush all pending commands for this &n;&t; * target &n;&t; */
id|aha1542_out
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
op_amp
id|ahacmd
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;aha1542.c: Trying device reset for target %d&bslash;n&quot;
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
macro_line|#ifdef ERIC_neverdef
multiline_comment|/* &n;&t; * With the 1542 we apparently never get an interrupt to&n;&t; * acknowledge a device reset being sent.  Then again, Leonard&n;&t; * says we are doing this wrong in the first place...&n;&t; *&n;&t; * Take a wait and see attitude.  If we get spurious interrupts,&n;&t; * then the device reset is doing something sane and useful, and&n;&t; * we will wait for the interrupt to post completion.&n;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sent BUS DEVICE RESET to target %d&bslash;n&quot;
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Free the command block for all commands running on this &n;&t; * target... &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_logical_and
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_member_access_from_pointer
id|target
op_eq
id|SCpnt-&gt;target
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
id|SCtmp
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
(brace
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
id|SCtmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|SUCCESS
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ERIC_neverdef */
)brace
DECL|function|aha1542_bus_reset
r_int
id|aha1542_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* &n;&t; * This does a scsi reset for all devices on the bus.&n;&t; * In principle, we could also reset the 1542 - should&n;&t; * we do this?  Try this first, and we can add that later&n;&t; * if it turns out to be useful.&n;&t; */
id|outb
c_func
(paren
id|SCRST
comma
id|CONTROL
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for the thing to settle down a bit.  Unfortunately&n;&t; * this is going to basically lock up the machine while we&n;&t; * wait for this to complete.  To be 100% correct, we need to&n;&t; * check for timeout, and if we are doing something like this&n;&t; * we are pretty desperate anyways.&n;&t; */
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|scsi_sleep
c_func
(paren
l_int|4
op_star
id|HZ
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
comma
id|STATMASK
comma
id|INIT
op_or
id|IDLE
comma
id|STST
op_or
id|DIAGF
op_or
id|INVDCMD
op_or
id|DF
op_or
id|CDF
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now try to pick up the pieces.  For all pending commands,&n;&t; * free any internal data structures, and basically clear things&n;&t; * out.  We do not try and restart any commands or anything - &n;&t; * the strategy handler takes care of that crap.&n;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sent BUS RESET to scsi host %d&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
id|SCtmp
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;device-&gt;soft_reset
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * If this device implements the soft reset option,&n;&t;&t;&t;&t; * then it is still holding onto the command, and&n;&t;&t;&t;&t; * may yet complete it.  In this case, we don&squot;t&n;&t;&t;&t;&t; * flush the data.&n;&t;&t;&t;&t; */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
(brace
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
id|SCtmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|SUCCESS
suffix:semicolon
id|fail
suffix:colon
r_return
id|FAILED
suffix:semicolon
)brace
DECL|function|aha1542_host_reset
r_int
id|aha1542_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* &n;&t; * This does a scsi reset for all devices on the bus.&n;&t; * In principle, we could also reset the 1542 - should&n;&t; * we do this?  Try this first, and we can add that later&n;&t; * if it turns out to be useful.&n;&t; */
id|outb
c_func
(paren
id|HRST
op_or
id|SCRST
comma
id|CONTROL
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for the thing to settle down a bit.  Unfortunately&n;&t; * this is going to basically lock up the machine while we&n;&t; * wait for this to complete.  To be 100% correct, we need to&n;&t; * check for timeout, and if we are doing something like this&n;&t; * we are pretty desperate anyways.&n;&t; */
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|scsi_sleep
c_func
(paren
l_int|4
op_star
id|HZ
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
comma
id|STATMASK
comma
id|INIT
op_or
id|IDLE
comma
id|STST
op_or
id|DIAGF
op_or
id|INVDCMD
op_or
id|DF
op_or
id|CDF
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to do this too before the 1542 can interact with&n;&t; * us again.&n;&t; */
id|setup_mailboxes
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
id|SCpnt-&gt;host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now try to pick up the pieces.  For all pending commands,&n;&t; * free any internal data structures, and basically clear things&n;&t; * out.  We do not try and restart any commands or anything - &n;&t; * the strategy handler takes care of that crap.&n;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sent BUS RESET to scsi host %d&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
id|SCtmp
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;device-&gt;soft_reset
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * If this device implements the soft reset option,&n;&t;&t;&t;&t; * then it is still holding onto the command, and&n;&t;&t;&t;&t; * may yet complete it.  In this case, we don&squot;t&n;&t;&t;&t;&t; * flush the data.&n;&t;&t;&t;&t; */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
(brace
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
id|SCtmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
)brace
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|SUCCESS
suffix:semicolon
id|fail
suffix:colon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/*&n; * These are the old error handling routines.  They are only temporarily&n; * here while we play with the new error handling code.&n; */
DECL|function|aha1542_old_abort
r_int
id|aha1542_old_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
macro_line|#if 0
id|unchar
id|ahacmd
op_assign
id|CMD_START_SCSI
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|mailbox
op_star
id|mb
suffix:semicolon
r_int
id|mbi
comma
id|mbo
comma
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;In aha1542_abort: %x %x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|STATUS
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
)paren
comma
id|inb
c_func
(paren
id|INTRFLAGS
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mb
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
suffix:semicolon
id|mbi
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbi_used
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mbi
op_ge
l_int|2
op_star
id|AHA1542_MAILBOXES
)paren
id|mbi
op_assign
id|AHA1542_MAILBOXES
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|mb
(braket
id|mbi
)braket
dot
id|status
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|mbi
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mbi
op_ge
l_int|2
op_star
id|AHA1542_MAILBOXES
)paren
id|mbi
op_assign
id|AHA1542_MAILBOXES
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mbi
op_ne
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|aha1542_last_mbi_used
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
id|mbi
)braket
dot
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Lost interrupt discovered on irq %d - attempting to recover&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;irq
)paren
suffix:semicolon
id|aha1542_intr_handle
c_func
(paren
id|SCpnt-&gt;host-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* OK, no lost interrupt.  Try looking to see how many pending commands&n;&t;   we think we have. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_eq
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Timed out command pending for %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|SCpnt-&gt;request.rq_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;OGMB still full - restarting&bslash;n&quot;
)paren
suffix:semicolon
id|aha1542_out
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
op_amp
id|ahacmd
comma
l_int|1
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Other pending command %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|SCpnt-&gt;request.rq_dev
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1542_abort&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if 0
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mbo
op_assign
l_int|0
suffix:semicolon
id|mbo
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|mbo
op_increment
)paren
r_if
c_cond
(paren
id|SCpnt
op_eq
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|mbo
)braket
)paren
(brace
id|mb
(braket
id|mbo
)braket
dot
id|status
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Abort command */
id|aha1542_out
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
op_amp
id|ahacmd
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* start scsi command */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
multiline_comment|/* We do not implement a reset function here, but the upper level code&n;   assumes that it will get some kind of response for the command in&n;   SCpnt.  We must oblige, or the command will hang the scsi system.&n;   For a first go, we assume that the 1542 notifies us with all of the&n;   pending commands (it does implement soft reset, after all). */
DECL|function|aha1542_old_reset
r_int
id|aha1542_old_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|unchar
id|ahacmd
op_assign
id|CMD_START_SCSI
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * See if a bus reset was suggested.&n;&t; */
r_if
c_cond
(paren
id|reset_flags
op_amp
id|SCSI_RESET_SUGGEST_BUS_RESET
)paren
(brace
multiline_comment|/* &n;&t;&t; * This does a scsi reset for all devices on the bus.&n;&t;&t; * In principle, we could also reset the 1542 - should&n;&t;&t; * we do this?  Try this first, and we can add that later&n;&t;&t; * if it turns out to be useful.&n;&t;&t; */
id|outb
c_func
(paren
id|HRST
op_or
id|SCRST
comma
id|CONTROL
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Wait for the thing to settle down a bit.  Unfortunately&n;&t;&t; * this is going to basically lock up the machine while we&n;&t;&t; * wait for this to complete.  To be 100% correct, we need to&n;&t;&t; * check for timeout, and if we are doing something like this&n;&t;&t; * we are pretty desperate anyways.&n;&t;&t; */
id|WAIT
c_func
(paren
id|STATUS
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
)paren
comma
id|STATMASK
comma
id|INIT
op_or
id|IDLE
comma
id|STST
op_or
id|DIAGF
op_or
id|INVDCMD
op_or
id|DF
op_or
id|CDF
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We need to do this too before the 1542 can interact with&n;&t;&t; * us again.&n;&t;&t; */
id|setup_mailboxes
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
id|SCpnt-&gt;host
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now try to pick up the pieces.  Restart all commands&n;&t;&t; * that are currently active on the bus, and reset all of&n;&t;&t; * the datastructures.  We have some time to kill while&n;&t;&t; * things settle down, so print a nice message.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sent BUS RESET to scsi host %d&bslash;n&quot;
comma
id|SCpnt-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
id|SCtmp
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
suffix:semicolon
id|SCtmp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
(brace
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
id|SCtmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sending DID_RESET for target %d&bslash;n&quot;
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|SCtmp
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Now tell the mid-level code what we did here.  Since&n;&t;&t; * we have restarted all of the outstanding commands,&n;&t;&t; * then report SUCCESS.&n;&t;&t; */
r_return
(paren
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_BUS_RESET
)paren
suffix:semicolon
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aha1542.c: Unable to perform hard reset.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Power cycle machine to reset&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_ERROR
op_or
id|SCSI_RESET_BUS_RESET
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This does a selective reset of just the one device */
multiline_comment|/* First locate the ccb for this command */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_eq
id|SCpnt
)paren
(brace
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|ccb
(braket
id|i
)braket
dot
id|op
op_assign
l_int|0x81
suffix:semicolon
multiline_comment|/* BUS DEVICE RESET */
multiline_comment|/* Now tell the 1542 to flush all pending commands for this target */
id|aha1542_out
c_func
(paren
id|SCpnt-&gt;host-&gt;io_port
comma
op_amp
id|ahacmd
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Here is the tricky part.  What to do next.  Do we get an interrupt&n;&t;&t;&t;&t;   for the commands that we aborted with the specified target, or&n;&t;&t;&t;&t;   do we generate this on our own?  Try it without first and see&n;&t;&t;&t;&t;   what happens */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sent BUS DEVICE RESET to target %d&bslash;n&quot;
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
multiline_comment|/* If the first does not work, then try the second.  I think the&n;&t;&t;&t;&t;   first option is more likely to be correct. Free the command&n;&t;&t;&t;&t;   block for all commands running on this target... */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AHA1542_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_logical_and
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_member_access_from_pointer
id|target
op_eq
id|SCpnt-&gt;target
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
id|SCtmp
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
suffix:semicolon
id|SCtmp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
(brace
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
id|SCtmp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sending DID_RESET for target %d&bslash;n&quot;
comma
id|SCpnt-&gt;target
)paren
suffix:semicolon
id|SCtmp
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
op_member_access_from_pointer
id|mb
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
)brace
multiline_comment|/* No active command at this time, so this means that each time we got&n;&t;   some kind of response the last time through.  Tell the mid-level code&n;&t;   to request sense information in order to decide what to do next. */
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
macro_line|#include &quot;sd.h&quot;
DECL|function|aha1542_biosparam
r_int
id|aha1542_biosparam
c_func
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|ip
)paren
(brace
r_int
id|translation_algorithm
suffix:semicolon
r_int
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|translation_algorithm
op_assign
id|HOSTDATA
c_func
(paren
id|disk-&gt;device-&gt;host
)paren
op_member_access_from_pointer
id|bios_translation
suffix:semicolon
r_if
c_cond
(paren
(paren
id|size
op_rshift
l_int|11
)paren
OG
l_int|1024
op_logical_and
id|translation_algorithm
op_eq
id|BIOS_TRANSLATION_25563
)paren
(brace
multiline_comment|/* Please verify that this is the same as what DOS returns */
id|ip
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_div
l_int|255
op_div
l_int|63
suffix:semicolon
)brace
r_else
(brace
id|ip
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|AHA1542
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
