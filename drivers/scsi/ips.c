multiline_comment|/*****************************************************************************/
multiline_comment|/* ips.c -- driver for the IBM ServeRAID controller                          */
multiline_comment|/*                                                                           */
multiline_comment|/* Written By: Keith Mitchell, IBM Corporation                               */
multiline_comment|/*                                                                           */
multiline_comment|/* Copyright (C) 1999 IBM Corporation                                        */
multiline_comment|/*                                                                           */
multiline_comment|/* This program is free software; you can redistribute it and/or modify      */
multiline_comment|/* it under the terms of the GNU General Public License as published by      */
multiline_comment|/* the Free Software Foundation; either version 2 of the License, or         */
multiline_comment|/* (at your option) any later version.                                       */
multiline_comment|/*                                                                           */
multiline_comment|/* This program is distributed in the hope that it will be useful,           */
multiline_comment|/* but WITHOUT ANY WARRANTY; without even the implied warranty of            */
multiline_comment|/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             */
multiline_comment|/* GNU General Public License for more details.                              */
multiline_comment|/*                                                                           */
multiline_comment|/* NO WARRANTY                                                               */
multiline_comment|/* THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR        */
multiline_comment|/* CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT      */
multiline_comment|/* LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,      */
multiline_comment|/* MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is    */
multiline_comment|/* solely responsible for determining the appropriateness of using and       */
multiline_comment|/* distributing the Program and assumes all risks associated with its        */
multiline_comment|/* exercise of rights under this Agreement, including but not limited to     */
multiline_comment|/* the risks and costs of program errors, damage to or loss of data,         */
multiline_comment|/* programs or equipment, and unavailability or interruption of operations.  */
multiline_comment|/*                                                                           */
multiline_comment|/* DISCLAIMER OF LIABILITY                                                   */
multiline_comment|/* NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY   */
multiline_comment|/* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL        */
multiline_comment|/* DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND   */
multiline_comment|/* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR     */
multiline_comment|/* TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE    */
multiline_comment|/* USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED  */
multiline_comment|/* HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES             */
multiline_comment|/*                                                                           */
multiline_comment|/* You should have received a copy of the GNU General Public License         */
multiline_comment|/* along with this program; if not, write to the Free Software               */
multiline_comment|/* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA */
multiline_comment|/*                                                                           */
multiline_comment|/* Bugs/Comments/Suggestions should be mailed to:                            */
multiline_comment|/*      ipslinux@us.ibm.com                                                  */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
multiline_comment|/*****************************************************************************/
multiline_comment|/* Change Log                                                                */
multiline_comment|/*                                                                           */
multiline_comment|/* 0.99.02  - Breakup commands that are bigger than 8 * the stripe size      */
multiline_comment|/* 0.99.03  - Make interrupt routine handle all completed request on the     */
multiline_comment|/*            adapter not just the first one                                 */
multiline_comment|/*          - Make sure passthru commands get woken up if we run out of      */
multiline_comment|/*            SCBs                                                           */
multiline_comment|/*          - Send all of the commands on the queue at once rather than      */
multiline_comment|/*            one at a time since the card will support it.                  */
multiline_comment|/* 0.99.04  - Fix race condition in the passthru mechanism -- this required  */
multiline_comment|/*            the interface to the utilities to change                       */
multiline_comment|/*          - Fix error recovery code                                        */
multiline_comment|/* 0.99.05  - Fix an oops when we get certain passthru commands              */
multiline_comment|/* 1.00.00  - Initial Public Release                                         */
multiline_comment|/*            Functionally equivalent to 0.99.05                             */
multiline_comment|/* 3.60.00  - Bump max commands to 128 for use with ServeRAID firmware 3.60  */
multiline_comment|/*          - Change version to 3.60 to coincide with ServeRAID release      */
multiline_comment|/*            numbering.                                                     */
multiline_comment|/* 3.60.01  - Remove bogus error check in passthru routine                   */
multiline_comment|/* 3.60.02  - Make DCDB direction based on lookup table                      */
multiline_comment|/*          - Only allow one DCDB command to a SCSI ID at a time             */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * Conditional Compilation directives for this driver:&n; *&n; * NO_IPS_RESET         - Don&squot;t reset the controller (no matter what)&n; * IPS_DEBUG            - More verbose error messages&n; * IPS_PCI_PROBE_DEBUG  - Print out more detail on the PCI probe&n; *&n; */
macro_line|#if defined (MODULE)
macro_line|#include &lt;linux/module.h&gt;
macro_line|#endif /* MODULE */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#ifndef NO_IPS_CMDLINE
macro_line|#include &lt;scsi/sg.h&gt;
macro_line|#endif
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ips.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
multiline_comment|/*&n; * DRIVER_VER&n; */
DECL|macro|IPS_VERSION_HIGH
mdefine_line|#define IPS_VERSION_HIGH        &quot;3.60&quot;  /* MUST be 4 chars */
DECL|macro|IPS_VERSION_LOW
mdefine_line|#define IPS_VERSION_LOW         &quot;.02 &quot;  /* MUST be 4 chars */
macro_line|#if !defined(__i386__)
macro_line|#error &quot;This driver has only been tested on the x86 platform&quot;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,2,0)
macro_line|#error &quot;This driver only works with kernel 2.2.0 and later&quot;
macro_line|#endif
macro_line|#if !defined(NO_IPS_CMDLINE) &amp;&amp; ((SG_BIG_BUFF &lt; 8192) || !defined(SG_BIG_BUFF))
macro_line|#error &quot;To use the command-line interface you need to define SG_BIG_BUFF&quot;
macro_line|#endif
macro_line|#if IPS_DEBUG &gt;= 12
DECL|macro|DBG
mdefine_line|#define DBG(s)       printk(KERN_NOTICE s &quot;&bslash;n&quot;); MDELAY(2*ONE_SEC)
macro_line|#elif IPS_DEBUG &gt;= 11
DECL|macro|DBG
mdefine_line|#define DBG(s)       printk(KERN_NOTICE s &quot;&bslash;n&quot;)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(s)
macro_line|#endif
multiline_comment|/*&n; * global variables&n; */
DECL|variable|ips_name
r_static
r_const
r_char
op_star
id|ips_name
op_assign
l_string|&quot;ips&quot;
suffix:semicolon
DECL|variable|ips_sh
r_static
r_struct
id|Scsi_Host
op_star
id|ips_sh
(braket
id|IPS_MAX_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/* Array of host controller structures */
DECL|variable|ips_ha
r_static
id|ips_ha_t
op_star
id|ips_ha
(braket
id|IPS_MAX_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/* Array of HA structures */
DECL|variable|ips_num_controllers
r_static
r_int
r_int
id|ips_num_controllers
op_assign
l_int|0
suffix:semicolon
DECL|variable|ips_cmd_timeout
r_static
r_int
id|ips_cmd_timeout
op_assign
l_int|60
suffix:semicolon
DECL|variable|ips_reset_timeout
r_static
r_int
id|ips_reset_timeout
op_assign
l_int|60
op_star
l_int|5
suffix:semicolon
DECL|macro|MAX_ADAPTER_NAME
mdefine_line|#define MAX_ADAPTER_NAME 6
DECL|variable|ips_adapter_name
r_static
r_char
id|ips_adapter_name
(braket
)braket
(braket
l_int|30
)braket
op_assign
(brace
l_string|&quot;ServeRAID&quot;
comma
l_string|&quot;ServeRAID II&quot;
comma
l_string|&quot;ServeRAID on motherboard&quot;
comma
l_string|&quot;ServeRAID on motherboard&quot;
comma
l_string|&quot;ServeRAID 3H&quot;
comma
l_string|&quot;ServeRAID 3L&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * Direction table&n; */
DECL|variable|ips_command_direction
r_static
r_char
id|ips_command_direction
(braket
)braket
op_assign
(brace
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
)brace
suffix:semicolon
multiline_comment|/*&n; * Function prototypes&n; */
r_int
id|ips_detect
c_func
(paren
id|Scsi_Host_Template
op_star
)paren
suffix:semicolon
r_int
id|ips_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_int
id|ips_abort
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|ips_reset
c_func
(paren
id|Scsi_Cmnd
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_int
id|ips_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|ips_eh_reset
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|ips_queue
c_func
(paren
id|Scsi_Cmnd
op_star
comma
r_void
(paren
op_star
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
suffix:semicolon
r_int
id|ips_biosparam
c_func
(paren
id|Disk
op_star
comma
id|kdev_t
comma
r_int
op_star
)paren
suffix:semicolon
r_const
r_char
op_star
id|ips_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_void
id|do_ipsintr
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_hainit
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_map_status
c_func
(paren
id|ips_scb_t
op_star
comma
id|ips_stat_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_send
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
comma
id|scb_callback
)paren
suffix:semicolon
r_static
r_int
id|ips_send_wait
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_send_cmd
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_chkstatus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_online
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_inquiry
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_rdcap
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_msense
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_reqsen
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_allocatescbs
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_reset_adapter
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_statupd
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_issue
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isintr
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_wait
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_write_driver_status
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_read_adapter_status
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_read_subsystem_parameters
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_read_config
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_clear_adapter
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_readwrite_page5
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ips_intr
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_next
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipsintr_blocking
c_func
(paren
id|ips_ha_t
op_star
comma
r_struct
id|ips_scb
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipsintr_done
c_func
(paren
id|ips_ha_t
op_star
comma
r_struct
id|ips_scb
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_done
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_free
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_init_scb
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_freescb
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_statinit
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
id|ips_scb_t
op_star
id|ips_getscb
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_scb_tail
c_func
(paren
id|ips_scb_queue_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|ips_scb_t
op_star
id|ips_removeq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|ips_scb_t
op_star
id|ips_removeq_scb
c_func
(paren
id|ips_scb_queue_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_wait_tail
c_func
(paren
id|ips_wait_queue_t
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_inline
id|Scsi_Cmnd
op_star
id|ips_removeq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|Scsi_Cmnd
op_star
id|ips_removeq_wait
c_func
(paren
id|ips_wait_queue_t
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_static
r_int
id|ips_is_passthru
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_make_passthru
c_func
(paren
id|ips_ha_t
op_star
comma
id|Scsi_Cmnd
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_usrcmd
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_passthru_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
macro_line|#endif
r_int
id|ips_proc_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_host_info
c_func
(paren
id|ips_ha_t
op_star
comma
r_char
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|copy_mem_info
c_func
(paren
id|INFOSTR
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|copy_info
c_func
(paren
id|INFOSTR
op_star
comma
r_char
op_star
comma
dot
dot
dot
)paren
suffix:semicolon
multiline_comment|/*--------------------------------------------------------------------------*/
multiline_comment|/* Exported Functions                                                       */
multiline_comment|/*--------------------------------------------------------------------------*/
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_detect                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Detect and initialize the driver                                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_detect
id|ips_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|SHT
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|u32
id|io_addr
suffix:semicolon
id|u16
id|planer
suffix:semicolon
id|u8
id|bus
suffix:semicolon
id|u8
id|func
suffix:semicolon
id|u8
id|irq
suffix:semicolon
r_int
id|index
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_detect&quot;
)paren
suffix:semicolon
id|SHT-&gt;proc_info
op_assign
id|ips_proc_info
suffix:semicolon
id|SHT-&gt;proc_name
op_assign
l_string|&quot;ips&quot;
suffix:semicolon
macro_line|#if defined(CONFIG_PCI)
multiline_comment|/* initalize number of controllers */
id|ips_num_controllers
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|IPS_MAX_ADAPTERS
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|IPS_VENDORID
comma
id|IPS_DEVICEID
comma
id|dev
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* stuff that we get in dev */
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
id|func
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|io_addr
op_assign
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
multiline_comment|/* get planer status */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0x04
comma
op_amp
id|planer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) can&squot;t get planer status.&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* check I/O address */
r_if
c_cond
(paren
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|flags
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
op_ne
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
r_continue
suffix:semicolon
multiline_comment|/* check to see if an onboard planer controller is disabled */
r_if
c_cond
(paren
op_logical_neg
(paren
id|planer
op_amp
l_int|0x000C
)paren
)paren
(brace
macro_line|#ifdef IPS_PCI_PROBE_DEBUG
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) detect, Onboard ServeRAID disabled by BIOS&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
macro_line|#endif
r_continue
suffix:semicolon
)brace
macro_line|#ifdef IPS_PCI_PROBE_DEBUG
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) detect bus %d, func %x, irq %d, io %x&bslash;n&quot;
comma
id|ips_name
comma
id|index
comma
id|bus
comma
id|func
comma
id|irq
comma
id|io_addr
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* found a controller */
id|sh
op_assign
id|scsi_register
c_func
(paren
id|SHT
comma
r_sizeof
(paren
id|ips_ha_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to register controller with SCSI subsystem - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha
op_assign
id|HA
c_func
(paren
id|sh
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha
comma
l_int|0
comma
r_sizeof
(paren
id|ips_ha_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize spin lock */
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;scb_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;copp_lock
)paren
suffix:semicolon
id|ips_sh
(braket
id|ips_num_controllers
)braket
op_assign
id|sh
suffix:semicolon
id|ips_ha
(braket
id|ips_num_controllers
)braket
op_assign
id|ha
suffix:semicolon
id|ips_num_controllers
op_increment
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;enq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ENQCMD
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;enq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host inquiry structure - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;adapt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ADAPTER_AREA
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;adapt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host adapt structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;conf
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|CONFCMD
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;conf
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host conf structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;nvram
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|NVRAM_PAGE5
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;nvram
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host nvram structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;subsys
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|SUBSYS_PARAM
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;subsys
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host subsystem structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;dummy
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|BASIC_IO_CMD
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;dummy
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host dummy structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Store away needed values for later use */
id|sh-&gt;io_port
op_assign
id|io_addr
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
l_int|255
suffix:semicolon
id|sh-&gt;unique_id
op_assign
id|io_addr
suffix:semicolon
id|sh-&gt;irq
op_assign
id|irq
suffix:semicolon
id|sh-&gt;select_queue_depths
op_assign
l_int|NULL
suffix:semicolon
id|sh-&gt;sg_tablesize
op_assign
id|sh-&gt;hostt-&gt;sg_tablesize
suffix:semicolon
id|sh-&gt;can_queue
op_assign
id|sh-&gt;hostt-&gt;can_queue
suffix:semicolon
id|sh-&gt;cmd_per_lun
op_assign
id|sh-&gt;hostt-&gt;cmd_per_lun
suffix:semicolon
id|sh-&gt;unchecked_isa_dma
op_assign
id|sh-&gt;hostt-&gt;unchecked_isa_dma
suffix:semicolon
id|sh-&gt;use_clustering
op_assign
id|sh-&gt;hostt-&gt;use_clustering
suffix:semicolon
multiline_comment|/* Store info in HA structure */
id|ha-&gt;io_addr
op_assign
id|io_addr
suffix:semicolon
id|ha-&gt;irq
op_assign
id|irq
suffix:semicolon
id|ha-&gt;host_num
op_assign
id|index
suffix:semicolon
multiline_comment|/* install the interrupt handler */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|do_ipsintr
comma
id|SA_SHIRQ
comma
id|ips_name
comma
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to install interrupt handler - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;       * Allocate a temporary SCB for initialization&n;       */
id|ha-&gt;scbs
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ips_scb_t
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;scbs
)paren
(brace
multiline_comment|/* couldn&squot;t allocate a temp SCB */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to allocate CCBs - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;scbs
comma
l_int|0
comma
r_sizeof
(paren
id|ips_scb_t
)paren
)paren
suffix:semicolon
id|ha-&gt;scbs-&gt;sg_list
op_assign
(paren
id|SG_LIST
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|SG_LIST
)paren
op_star
id|MAX_SG_ELEMENTS
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;scbs-&gt;sg_list
)paren
(brace
multiline_comment|/* couldn&squot;t allocate a temp SCB S/G list */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to allocate CCBs - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;max_cmds
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_hainit
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to initialize controller - skipping&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;       * Free the temporary SCB&n;       */
id|kfree
c_func
(paren
id|ha-&gt;scbs-&gt;sg_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ha-&gt;scbs
)paren
suffix:semicolon
id|ha-&gt;scbs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* allocate CCBs */
r_if
c_cond
(paren
op_logical_neg
id|ips_allocatescbs
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to allocate CCBs - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|index
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* finish setting values */
id|sh-&gt;max_id
op_assign
id|ha-&gt;ntargets
suffix:semicolon
id|sh-&gt;max_lun
op_assign
id|ha-&gt;nlun
suffix:semicolon
id|sh-&gt;max_channel
op_assign
id|ha-&gt;nbus
suffix:semicolon
id|sh-&gt;can_queue
op_assign
id|ha-&gt;max_cmds
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* end for */
r_return
(paren
id|ips_num_controllers
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* No PCI -- No ServeRAID */
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_release                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove a driver                                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_release
id|ips_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_release&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPS_MAX_ADAPTERS
op_logical_and
id|ips_sh
(braket
id|i
)braket
op_ne
id|sh
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|IPS_MAX_ADAPTERS
)paren
id|panic
c_func
(paren
l_string|&quot;(%s) release, invalid Scsi_Host pointer.&bslash;n&quot;
comma
id|ips_name
)paren
suffix:semicolon
id|ha
op_assign
id|HA
c_func
(paren
id|sh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* flush the cache on the controller */
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|FLUSH_CACHE
suffix:semicolon
id|scb-&gt;cmd.flush_cache.op_code
op_assign
id|FLUSH_CACHE
suffix:semicolon
id|scb-&gt;cmd.flush_cache.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.flush_cache.state
op_assign
id|NORM_STATE
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved3
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved4
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(%s%d) Flushing Cache.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
)paren
op_eq
id|IPS_FAILURE
)paren
id|printk
c_func
(paren
l_string|&quot;(%s%d) Incomplete Flush.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(%s%d) Flushing Complete.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|ips_sh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_ha
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* free extra memory */
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* free IRQ */
id|free_irq
c_func
(paren
id|ha-&gt;irq
comma
id|ha
)paren
suffix:semicolon
multiline_comment|/* unregister with SCSI sub system */
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_eh_abort                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Abort a command (using the new error code stuff)                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_eh_abort
id|ips_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_eh_abort&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SC-&gt;serial_number
op_ne
id|SC-&gt;serial_number_at_timeout
)paren
(brace
multiline_comment|/* HMM, looks like a bogus command */
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Abort called with bogus scsi command&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
multiline_comment|/* See if the command is on the wait queue */
r_if
c_cond
(paren
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
op_logical_or
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|SC
)paren
)paren
(brace
multiline_comment|/* command not sent yet */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* command must have already been sent */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_abort                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Abort a command                                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_abort
id|ips_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_abort&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
r_return
(paren
id|SCSI_ABORT_SNOOZE
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
id|SCSI_ABORT_SNOOZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|SCSI_ABORT_SNOOZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SC-&gt;serial_number
op_ne
id|SC-&gt;serial_number_at_timeout
)paren
(brace
multiline_comment|/* HMM, looks like a bogus command */
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Abort called with bogus scsi command&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
)paren
r_return
(paren
id|SCSI_ABORT_SNOOZE
)paren
suffix:semicolon
multiline_comment|/* See if the command is on the wait queue */
r_if
c_cond
(paren
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
op_logical_or
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|SC
)paren
)paren
(brace
multiline_comment|/* command not sent yet */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_PENDING
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* command must have already been sent */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_ABORT_SNOOZE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_eh_reset                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller (with new eh error code)                          */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_eh_reset
id|ips_eh_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_eh_reset&quot;
)paren
suffix:semicolon
macro_line|#ifdef NO_IPS_RESET
r_return
(paren
id|FAILED
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Reset called with NULL scsi command&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Reset called with NULL ha struct&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
multiline_comment|/* See if the command is on the waiting queue */
r_if
c_cond
(paren
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
op_logical_or
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|SC
)paren
)paren
(brace
multiline_comment|/* command not sent yet */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    * command must have already been sent&n;    * reset the controller&n;    */
r_if
c_cond
(paren
op_logical_neg
id|ips_reset_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_clear_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* Now fail all of the active commands */
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Failing active commands&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|scb
op_assign
id|ips_removeq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
)paren
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset the number of active IOCTLs */
id|ha-&gt;num_ioctl
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
multiline_comment|/*&n;       * Only execute the next command when&n;       * we are not being called from the&n;       * interrupt handler.  The interrupt&n;       * handler wants to do this and since&n;       * interrupts are turned off here....&n;       */
id|ips_next
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
macro_line|#endif /* NO_IPS_RESET */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reset                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_reset
id|ips_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
comma
r_int
r_int
id|flags
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_reset&quot;
)paren
suffix:semicolon
macro_line|#ifdef NO_IPS_RESET
r_return
(paren
id|SCSI_RESET_SNOOZE
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Reset called with NULL scsi command&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_SNOOZE
)paren
suffix:semicolon
)brace
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Reset called with NULL ha struct&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_SNOOZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|SCSI_RESET_SNOOZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
)paren
r_return
(paren
id|SCSI_RESET_SNOOZE
)paren
suffix:semicolon
multiline_comment|/* See if the command is on the waiting queue */
r_if
c_cond
(paren
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
op_logical_or
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|SC
)paren
)paren
(brace
multiline_comment|/* command not sent yet */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_SNOOZE
)paren
suffix:semicolon
)brace
multiline_comment|/* reset the controller */
r_if
c_cond
(paren
op_logical_neg
id|ips_reset_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_ERROR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_clear_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SCSI_RESET_ERROR
)paren
suffix:semicolon
)brace
multiline_comment|/* Now fail all of the active commands */
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Failing active commands&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|scb
op_assign
id|ips_removeq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
)paren
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset the number of active IOCTLs */
id|ha-&gt;num_ioctl
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
multiline_comment|/*&n;       * Only execute the next command when&n;       * we are not being called from the&n;       * interrupt handler.  The interrupt&n;       * handler wants to do this and since&n;       * interrupts are turned off here....&n;       */
id|ips_next
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_return
(paren
id|SCSI_RESET_SUCCESS
)paren
suffix:semicolon
macro_line|#endif /* NO_IPS_RESET */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_queue                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command to the controller                                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_queue
id|ips_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_queue&quot;
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
id|ips_is_passthru
c_func
(paren
id|SC
)paren
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;copp_waitlist.count
op_eq
id|IPS_MAX_IOCTL_QUEUE
)paren
(brace
id|SC-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;scb_waitlist.count
op_eq
id|IPS_MAX_QUEUE
)paren
(brace
id|SC-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
)brace
macro_line|#endif
id|SC-&gt;scsi_done
op_assign
id|done
suffix:semicolon
macro_line|#if IPS_DEBUG &gt;= 10
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: ips_queue: cmd 0x%X (%d %d %d)&bslash;n&quot;
comma
id|ips_name
comma
id|SC-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SC-&gt;channel
comma
id|SC-&gt;target
comma
id|SC-&gt;lun
)paren
suffix:semicolon
macro_line|#if IPS_DEBUG &gt;= 11
id|MDELAY
c_func
(paren
l_int|2
op_star
id|ONE_SEC
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
id|ips_is_passthru
c_func
(paren
id|SC
)paren
)paren
id|ips_putq_wait_tail
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|SC
)paren
suffix:semicolon
r_else
macro_line|#endif
id|ips_putq_wait_tail
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
)paren
)paren
id|ips_next
c_func
(paren
id|ha
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_biosparam                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Set bios geometry for the controller                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_biosparam
id|ips_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
id|heads
suffix:semicolon
r_int
id|sectors
suffix:semicolon
r_int
id|cylinders
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_biosparam&quot;
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
multiline_comment|/* ?!?! host adater info invalid */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_read_adapter_status
c_func
(paren
id|ha
)paren
)paren
multiline_comment|/* ?!?! Enquiry command failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disk-&gt;capacity
OG
l_int|0x400000
)paren
op_logical_and
(paren
(paren
id|ha-&gt;enq-&gt;ucMiscFlag
op_amp
l_int|0x8
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|heads
op_assign
id|NORM_MODE_HEADS
suffix:semicolon
id|sectors
op_assign
id|NORM_MODE_SECTORS
suffix:semicolon
)brace
r_else
(brace
id|heads
op_assign
id|COMP_MODE_HEADS
suffix:semicolon
id|sectors
op_assign
id|COMP_MODE_SECTORS
suffix:semicolon
)brace
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
macro_line|#if IPS_DEBUG &gt;= 2
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Geometry: heads: %d, sectors: %d, cylinders: %d&bslash;n&quot;
comma
id|heads
comma
id|sectors
comma
id|cylinders
)paren
suffix:semicolon
macro_line|#endif
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: do_ipsintr                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Wrapper for the interrupt handler                                      */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_void
DECL|function|do_ipsintr
id|do_ipsintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;do_ipsintr&quot;
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|dev_id
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ips_intr
c_func
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_intr                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Polling interrupt handler                                              */
multiline_comment|/*                                                                          */
multiline_comment|/*   ASSUMES interrupts are disabled                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_void
DECL|function|ips_intr
id|ips_intr
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_stat_t
op_star
id|sp
suffix:semicolon
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|status
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_intr&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|ips_isintr
c_func
(paren
id|ha
)paren
)paren
(brace
id|sp
op_assign
op_amp
id|ha-&gt;sp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ips_chkstatus
c_func
(paren
id|ha
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* unexpected interrupt - no ccb */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Spurious interrupt; no ccb.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|scb
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|sp-&gt;scb_addr
suffix:semicolon
multiline_comment|/*&n;       * use the callback function to finish things up&n;       * NOTE: interrupts are OFF for this&n;       */
(paren
op_star
id|scb-&gt;callback
)paren
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_info                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Return info about the driver                                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_const
r_char
op_star
DECL|function|ips_info
id|ips_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SH
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|256
)braket
suffix:semicolon
r_char
op_star
id|bp
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_info&quot;
)paren
suffix:semicolon
id|ha
op_assign
id|HA
c_func
(paren
id|SH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|bp
op_assign
op_amp
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|bp
comma
l_int|0
comma
r_sizeof
(paren
id|buffer
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bp
comma
l_string|&quot;IBM PCI ServeRAID &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bp
comma
id|IPS_VERSION_HIGH
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bp
comma
id|IPS_VERSION_LOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;ad_type
OG
l_int|0
op_logical_and
id|ha-&gt;ad_type
op_le
id|MAX_ADAPTER_NAME
)paren
(brace
id|strcat
c_func
(paren
id|bp
comma
l_string|&quot; &lt;&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bp
comma
id|ips_adapter_name
(braket
id|ha-&gt;ad_type
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bp
comma
l_string|&quot;&gt;&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|bp
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_proc_info                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   The passthru interface for the driver                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_proc_info
id|ips_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|func
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ips_ha_t
op_star
id|ha
op_assign
l_int|NULL
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_proc_info&quot;
)paren
suffix:semicolon
multiline_comment|/* Find our host structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ips_num_controllers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ips_sh
(braket
id|i
)braket
op_logical_and
id|ips_sh
(braket
id|i
)braket
op_member_access_from_pointer
id|host_no
op_eq
id|hostno
)paren
(brace
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|ips_sh
(braket
id|i
)braket
op_member_access_from_pointer
id|hostdata
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func
)paren
(brace
multiline_comment|/* write */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* read */
r_if
c_cond
(paren
id|start
)paren
op_star
id|start
op_assign
id|buffer
suffix:semicolon
id|ret
op_assign
id|ips_host_info
c_func
(paren
id|ha
comma
id|buffer
comma
id|offset
comma
id|length
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*--------------------------------------------------------------------------*/
multiline_comment|/* Helper Functions                                                         */
multiline_comment|/*--------------------------------------------------------------------------*/
macro_line|#ifndef NO_IPS_CMDLINE
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_is_passthru                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Determine if the specified SCSI command is really a passthru command   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_is_passthru
id|ips_is_passthru
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_is_passthru&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SC-&gt;channel
op_eq
l_int|0
)paren
op_logical_and
(paren
id|SC-&gt;target
op_eq
id|IPS_ADAPTER_ID
)paren
op_logical_and
(paren
id|SC-&gt;lun
op_eq
l_int|0
)paren
op_logical_and
(paren
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
l_int|0x0d
)paren
op_logical_and
(paren
id|SC-&gt;request_bufflen
)paren
op_logical_and
(paren
op_logical_neg
id|SC-&gt;use_sg
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_eq
l_char|&squot;C&squot;
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|1
)braket
op_eq
l_char|&squot;O&squot;
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|2
)braket
op_eq
l_char|&squot;P&squot;
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|3
)braket
op_eq
l_char|&squot;P&squot;
)paren
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_is_passthru                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Make a passthru command out of the info in the Scsi block              */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_make_passthru
id|ips_make_passthru
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|Scsi_Cmnd
op_star
id|SC
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_make_passthru&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC-&gt;request_bufflen
op_logical_or
op_logical_neg
id|SC-&gt;request_buffer
)paren
(brace
multiline_comment|/* no data */
macro_line|#if IPS_DEBUG_PT &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) No passthru structure&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OL
r_sizeof
(paren
id|ips_passthru_t
)paren
)paren
(brace
multiline_comment|/* wrong size */
macro_line|#if IPS_DEBUG_PT &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Passthru structure wrong size&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_ne
l_char|&squot;C&squot;
)paren
op_logical_or
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|1
)braket
op_ne
l_char|&squot;O&squot;
)paren
op_logical_or
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
)paren
op_logical_or
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|3
)braket
op_ne
l_char|&squot;P&squot;
)paren
)paren
(brace
multiline_comment|/* signature doesn&squot;t match */
macro_line|#if IPS_DEBUG_PT &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Wrong signature on passthru structure.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|SC-&gt;request_buffer
suffix:semicolon
id|scb-&gt;scsi_cmd
op_assign
id|SC
suffix:semicolon
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OL
(paren
r_sizeof
(paren
id|ips_passthru_t
)paren
op_plus
id|pt-&gt;CmdBSize
)paren
)paren
(brace
multiline_comment|/* wrong size */
macro_line|#if IPS_DEBUG_PT &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Passthru structure wrong size&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pt-&gt;CoppCmd
)paren
(brace
r_case
id|IPS_NUMCTRLS
suffix:colon
id|memcpy
c_func
(paren
id|SC-&gt;request_buffer
op_plus
r_sizeof
(paren
id|ips_passthru_t
)paren
comma
op_amp
id|ips_num_controllers
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
r_case
id|IPS_CTRLINFO
suffix:colon
id|memcpy
c_func
(paren
id|SC-&gt;request_buffer
op_plus
r_sizeof
(paren
id|ips_passthru_t
)paren
comma
id|ha
comma
r_sizeof
(paren
id|ips_ha_t
)paren
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
r_case
id|COPPUSRCMD
suffix:colon
r_if
c_cond
(paren
id|ips_usrcmd
c_func
(paren
id|ha
comma
id|pt
comma
id|scb
)paren
)paren
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
r_else
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_usrcmd                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Process a user command and make it ready to send                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_usrcmd
id|ips_usrcmd
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_passthru_t
op_star
id|pt
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|SG_LIST
op_star
id|sg_list
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_usrcmd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|scb
)paren
op_logical_or
(paren
op_logical_neg
id|pt
)paren
op_logical_or
(paren
op_logical_neg
id|ha
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Save the S/G list pointer so it doesn&squot;t get clobbered */
id|sg_list
op_assign
id|scb-&gt;sg_list
suffix:semicolon
multiline_comment|/* copy in the CP */
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;cmd
comma
op_amp
id|pt-&gt;CoppCP.cmd
comma
r_sizeof
(paren
id|IOCTL_INFO
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;dcdb
comma
op_amp
id|pt-&gt;CoppCP.dcdb
comma
r_sizeof
(paren
id|DCDB_TABLE
)paren
)paren
suffix:semicolon
multiline_comment|/* FIX stuff that might be wrong */
id|scb-&gt;sg_list
op_assign
id|sg_list
suffix:semicolon
id|scb-&gt;scb_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb
)paren
suffix:semicolon
id|scb-&gt;bus
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;target_id
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;lun
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;op_code
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;callback
op_assign
id|ipsintr_done
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t support DCDB/READ/WRITE Scatter Gather */
r_if
c_cond
(paren
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|READ_SCATTER_GATHER
)paren
op_logical_or
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|WRITE_SCATTER_GATHER
)paren
op_logical_or
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|DIRECT_CDB_SCATTER_GATHER
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
)paren
(brace
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
op_plus
r_sizeof
(paren
id|ips_passthru_t
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_busaddr
op_assign
l_int|0L
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;cmd.dcdb.op_code
op_eq
id|DIRECT_CDB
)paren
(brace
id|scb-&gt;cmd.dcdb.dcdb_address
op_assign
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|scb-&gt;dcdb
)paren
suffix:semicolon
id|scb-&gt;dcdb.buffer_pointer
op_assign
id|scb-&gt;data_busaddr
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|scb-&gt;data_busaddr
suffix:semicolon
)brace
)brace
multiline_comment|/* set timeouts */
r_if
c_cond
(paren
id|pt-&gt;TimeOut
)paren
(brace
id|scb-&gt;timeout
op_assign
id|pt-&gt;TimeOut
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;TimeOut
op_le
l_int|10
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pt-&gt;TimeOut
op_le
l_int|60
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_60
suffix:semicolon
r_else
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_20M
suffix:semicolon
)brace
multiline_comment|/* assume error */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* success */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_cleanup_passthru                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Cleanup after a passthru command                                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_cleanup_passthru
id|ips_cleanup_passthru
c_func
(paren
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_cleanup_passthru&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|scb
)paren
op_logical_or
(paren
op_logical_neg
id|scb-&gt;scsi_cmd
)paren
op_logical_or
(paren
op_logical_neg
id|scb-&gt;scsi_cmd-&gt;request_buffer
)paren
)paren
(brace
macro_line|#if IPS_DEBUG_PT &gt;= 1
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;IPS couldn&squot;t cleanup&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
suffix:semicolon
multiline_comment|/* Copy data back to the user */
id|pt-&gt;BasicStatus
op_assign
id|scb-&gt;basic_status
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
id|scb-&gt;extended_status
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_host_info                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   The passthru interface for the driver                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_host_info
id|ips_host_info
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_char
op_star
id|ptr
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
id|INFOSTR
id|info
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_host_info&quot;
)paren
suffix:semicolon
id|info.buffer
op_assign
id|ptr
suffix:semicolon
id|info.length
op_assign
id|len
suffix:semicolon
id|info.offset
op_assign
id|offset
suffix:semicolon
id|info.pos
op_assign
l_int|0
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;nIBM ServeRAID General Information:&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ha-&gt;nvram-&gt;signature
op_eq
id|NVRAM_PAGE5_SIGNATURE
)paren
op_logical_and
(paren
id|ha-&gt;nvram-&gt;adapter_type
op_ne
l_int|0
)paren
)paren
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tController Type                   : %s&bslash;n&quot;
comma
id|ips_adapter_name
(braket
id|ha-&gt;ad_type
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_else
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tController Type                   : Unknown&bslash;n&quot;
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tIO port address                   : 0x%lx&bslash;n&quot;
comma
id|ha-&gt;io_addr
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tIRQ number                        : %d&bslash;n&quot;
comma
id|ha-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;nvram-&gt;signature
op_eq
id|NVRAM_PAGE5_SIGNATURE
)paren
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tBIOS Version                      : %c%c%c%c%c%c%c%c&bslash;n&quot;
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|3
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tFirmware Version                  : %c%c%c%c%c%c%c%c&bslash;n&quot;
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|0
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|1
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|2
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|3
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|4
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|5
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|6
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tBoot Block Version                : %c%c%c%c%c%c%c%c&bslash;n&quot;
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|0
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|1
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|2
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|3
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|4
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|5
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|6
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tDriver Version                    : %s%s&bslash;n&quot;
comma
id|IPS_VERSION_HIGH
comma
id|IPS_VERSION_LOW
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tMax Physical Devices              : %d&bslash;n&quot;
comma
id|ha-&gt;enq-&gt;ucMaxPhysicalDevices
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tMax Active Commands               : %d&bslash;n&quot;
comma
id|ha-&gt;max_cmds
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Queued Commands           : %d&bslash;n&quot;
comma
id|ha-&gt;scb_waitlist.count
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Active Commands           : %d&bslash;n&quot;
comma
id|ha-&gt;scb_activelist.count
op_minus
id|ha-&gt;num_ioctl
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Queued PT Commands        : %d&bslash;n&quot;
comma
id|ha-&gt;copp_waitlist.count
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Active PT Commands        : %d&bslash;n&quot;
comma
id|ha-&gt;num_ioctl
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|info.pos
OG
id|info.offset
ques
c_cond
id|info.pos
op_minus
id|info.offset
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: copy_mem_info                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Copy data into an INFOSTR structure                                    */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|copy_mem_info
id|copy_mem_info
c_func
(paren
id|INFOSTR
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;copy_mem_info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OG
id|info-&gt;length
)paren
id|len
op_assign
id|info-&gt;length
op_minus
id|info-&gt;pos
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OL
id|info-&gt;offset
)paren
(brace
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;pos
OL
id|info-&gt;offset
)paren
(brace
id|data
op_add_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|info-&gt;buffer
op_plus
id|info-&gt;pos
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: copy_info                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   printf style wrapper for an info structure                             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|copy_info
id|copy_info
c_func
(paren
id|INFOSTR
op_star
id|info
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
l_int|81
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;copy_info&quot;
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|len
op_assign
id|vsprintf
c_func
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|copy_mem_info
c_func
(paren
id|info
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_hainit                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize the controller                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* NOTE: Assumes to be called from with a lock                              */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_hainit
id|ips_hainit
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_hainit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* initialize status queue */
id|ips_statinit
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Setup HBA ID&squot;s */
r_if
c_cond
(paren
op_logical_neg
id|ips_read_config
c_func
(paren
id|ha
)paren
)paren
(brace
macro_line|#ifndef NO_IPS_RESET
multiline_comment|/* Try to reset the controller and try again */
r_if
c_cond
(paren
op_logical_neg
id|ips_reset_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to reset controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_clear_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to initialize controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ips_read_config
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read config from controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end if */
multiline_comment|/* write driver version */
r_if
c_cond
(paren
op_logical_neg
id|ips_write_driver_status
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to write driver info to controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_read_adapter_status
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read controller status.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_read_subsystem_parameters
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read subsystem parameters.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* set limits on SID, LUN, BUS */
id|ha-&gt;ntargets
op_assign
id|MAX_TARGETS
op_plus
l_int|1
suffix:semicolon
id|ha-&gt;nlun
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;nbus
op_assign
(paren
id|ha-&gt;enq-&gt;ucMaxPhysicalDevices
op_div
id|MAX_TARGETS
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ha-&gt;conf-&gt;logical_drive
(braket
l_int|0
)braket
dot
id|ucStripeSize
)paren
(brace
r_case
l_int|4
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x10000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x20000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x40000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
r_default
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x80000
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* setup max concurrent commands */
r_if
c_cond
(paren
id|ha-&gt;subsys-&gt;param
(braket
l_int|4
)braket
op_amp
l_int|0x1
)paren
(brace
multiline_comment|/* Use the new method */
id|ha-&gt;max_cmds
op_assign
id|ha-&gt;enq-&gt;ucConcurrentCmdCount
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* use the old method */
r_switch
c_cond
(paren
id|ha-&gt;conf-&gt;logical_drive
(braket
l_int|0
)braket
dot
id|ucStripeSize
)paren
(brace
r_case
l_int|4
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
r_default
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* set controller IDs */
id|ha-&gt;ha_id
(braket
l_int|0
)braket
op_assign
id|IPS_ADAPTER_ID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ha-&gt;nbus
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ha-&gt;ha_id
(braket
id|i
)braket
op_assign
id|ha-&gt;conf-&gt;init_id
(braket
id|i
op_minus
l_int|1
)braket
op_amp
l_int|0x1f
suffix:semicolon
id|ha-&gt;dcdb_active
(braket
id|i
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_next                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Take the next command off the queue and send it to the controller      */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_next
id|ips_next
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SC
suffix:semicolon
id|Scsi_Cmnd
op_star
id|p
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_next&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
multiline_comment|/*&n;    * Send passthru commands&n;    * These have priority over normal I/O&n;    * but shouldn&squot;t affect performance too much&n;    * since we limit the number that can be active&n;    * on the card at any one time&n;    */
r_while
c_loop
(paren
(paren
id|ha-&gt;num_ioctl
OL
id|IPS_MAX_IOCTL
)paren
op_logical_and
(paren
id|ha-&gt;copp_waitlist.head
)paren
op_logical_and
(paren
id|scb
op_assign
id|ips_getscb
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|SC
op_assign
id|ips_removeq_wait_head
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|ret
op_assign
id|ips_make_passthru
c_func
(paren
id|ha
comma
id|SC
comma
id|scb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
r_if
c_cond
(paren
id|ret
op_ne
id|IPS_SUCCESS
)paren
r_continue
suffix:semicolon
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|IPS_SUCCESS
)paren
(brace
id|ips_putq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
comma
id|scb
)paren
suffix:semicolon
id|ha-&gt;num_ioctl
op_increment
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
)brace
macro_line|#endif
multiline_comment|/*&n;    * Send &quot;Normal&quot; I/O commands&n;    */
id|p
op_assign
id|ha-&gt;scb_waitlist.head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|scb
op_assign
id|ips_getscb
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;channel
OG
l_int|0
)paren
op_logical_and
(paren
id|ha-&gt;dcdb_active
(braket
id|p-&gt;channel
op_minus
l_int|1
)braket
op_amp
(paren
l_int|1
op_lshift
id|p-&gt;target
)paren
)paren
)paren
(brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|p
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|SC
op_assign
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|p
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_OK
suffix:semicolon
id|SC-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|SC-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|SC-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|scb-&gt;target_id
op_assign
id|SC-&gt;target
suffix:semicolon
id|scb-&gt;lun
op_assign
id|SC-&gt;lun
suffix:semicolon
id|scb-&gt;bus
op_assign
id|SC-&gt;channel
suffix:semicolon
id|scb-&gt;scsi_cmd
op_assign
id|SC
suffix:semicolon
id|scb-&gt;breakup
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;callback
op_assign
id|ipsintr_done
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scb-&gt;cmd
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* copy in the CDB */
id|memcpy
c_func
(paren
id|scb-&gt;cdb
comma
id|SC-&gt;cmnd
comma
id|SC-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* Now handle the data buffer */
r_if
c_cond
(paren
id|SC-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sg
op_assign
id|SC-&gt;request_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SC-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scb-&gt;sg_list
(braket
id|i
)braket
dot
id|address
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
id|scb-&gt;sg_list
(braket
id|i
)braket
dot
id|length
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_plus
id|sg
(braket
id|i
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/*&n;                * Data Breakup required&n;                */
id|scb-&gt;breakup
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scb-&gt;data_len
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;breakup
)paren
id|scb-&gt;sg_len
op_assign
id|SC-&gt;use_sg
suffix:semicolon
r_else
id|scb-&gt;sg_len
op_assign
id|scb-&gt;breakup
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;sg_list
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
)paren
(brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/*&n;                * Data breakup required&n;                */
id|scb-&gt;breakup
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_len
op_assign
id|SC-&gt;request_bufflen
suffix:semicolon
)brace
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|SC-&gt;request_buffer
)paren
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_busaddr
op_assign
l_int|0L
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|ips_command_direction
(braket
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;dcdb.cmd_attribute
op_amp
l_int|0x3
)paren
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_ge
id|IPS_MAX_XFER
)paren
(brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TRANSFER_64K
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|IPS_SUCCESS
)paren
id|ips_putq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
comma
id|scb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
id|p
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
suffix:semicolon
)brace
multiline_comment|/* end while */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_scb_head                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the head of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_scb_head
id|ips_putq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
comma
id|ips_scb_t
op_star
id|item
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_putq_scb_head&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|item-&gt;q_next
op_assign
id|queue-&gt;head
suffix:semicolon
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;tail
)paren
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_scb_tail                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the tail of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_scb_tail
id|ips_putq_scb_tail
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
comma
id|ips_scb_t
op_star
id|item
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_putq_scb_tail&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|item-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
)paren
id|queue-&gt;tail-&gt;q_next
op_assign
id|item
suffix:semicolon
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;head
)paren
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_scb_head                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove the head of the queue                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|ips_scb_t
op_star
DECL|function|ips_removeq_scb_head
id|ips_removeq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
)paren
(brace
id|ips_scb_t
op_star
id|item
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_removeq_scb_head&quot;
)paren
suffix:semicolon
id|item
op_assign
id|queue-&gt;head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|queue-&gt;head
op_assign
id|item-&gt;q_next
suffix:semicolon
id|item-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
op_eq
id|item
)paren
id|queue-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_scb                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an item from a queue                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|ips_scb_t
op_star
DECL|function|ips_removeq_scb
id|ips_removeq_scb
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
comma
id|ips_scb_t
op_star
id|item
)paren
(brace
id|ips_scb_t
op_star
id|p
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_removeq_scb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
op_eq
id|queue-&gt;head
)paren
r_return
(paren
id|ips_removeq_scb_head
c_func
(paren
id|queue
)paren
)paren
suffix:semicolon
id|p
op_assign
id|queue-&gt;head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|item
op_ne
id|p-&gt;q_next
)paren
)paren
id|p
op_assign
id|p-&gt;q_next
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* found a match */
id|p-&gt;q_next
op_assign
id|item-&gt;q_next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item-&gt;q_next
)paren
id|queue-&gt;tail
op_assign
id|p
suffix:semicolon
id|item-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_wait_head                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the head of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_wait_head
id|ips_putq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
comma
id|Scsi_Cmnd
op_star
id|item
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_putq_wait_head&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|item-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
id|queue-&gt;head
suffix:semicolon
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;tail
)paren
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_wait_tail                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the tail of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_wait_tail
id|ips_putq_wait_tail
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
comma
id|Scsi_Cmnd
op_star
id|item
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_putq_wait_tail&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|item-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
)paren
id|queue-&gt;tail-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
id|item
suffix:semicolon
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;head
)paren
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_wait_head                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove the head of the queue                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|Scsi_Cmnd
op_star
DECL|function|ips_removeq_wait_head
id|ips_removeq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
)paren
(brace
id|Scsi_Cmnd
op_star
id|item
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_removeq_wait_head&quot;
)paren
suffix:semicolon
id|item
op_assign
id|queue-&gt;head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|queue-&gt;head
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|item-&gt;host_scribble
suffix:semicolon
id|item-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
op_eq
id|item
)paren
id|queue-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_wait                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an item from a queue                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|Scsi_Cmnd
op_star
DECL|function|ips_removeq_wait
id|ips_removeq_wait
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
comma
id|Scsi_Cmnd
op_star
id|item
)paren
(brace
id|Scsi_Cmnd
op_star
id|p
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_removeq_wait&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
op_eq
id|queue-&gt;head
)paren
r_return
(paren
id|ips_removeq_wait_head
c_func
(paren
id|queue
)paren
)paren
suffix:semicolon
id|p
op_assign
id|queue-&gt;head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|item
op_ne
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
)paren
)paren
id|p
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* found a match */
id|p-&gt;host_scribble
op_assign
id|item-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item-&gt;host_scribble
)paren
id|queue-&gt;tail
op_assign
id|p
suffix:semicolon
id|item-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ipsintr_blocking                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Finalize an interrupt for internal commands                            */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ipsintr_blocking
id|ipsintr_blocking
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ipsintr_blocking&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ha-&gt;waitflag
op_eq
id|TRUE
)paren
op_logical_and
(paren
id|ha-&gt;cmd_in_progress
op_eq
id|scb-&gt;cdb
(braket
l_int|0
)braket
)paren
)paren
(brace
id|ha-&gt;waitflag
op_assign
id|FALSE
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ipsintr_done                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Finalize an interrupt for non-internal commands                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ipsintr_done
id|ipsintr_done
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ipsintr_done&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* unexpected interrupt */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Spurious interrupt; scsi_cmd not set.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ips_done
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_done                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Do housekeeping on completed commands                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_done
id|ips_done
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_done&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb
)paren
r_return
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd
)paren
op_logical_and
(paren
id|ips_is_passthru
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
)paren
)paren
(brace
id|ips_cleanup_passthru
c_func
(paren
id|scb
)paren
suffix:semicolon
id|ha-&gt;num_ioctl
op_decrement
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
multiline_comment|/*&n;       * Check to see if this command had too much&n;       * data and had to be broke up.  If so, queue&n;       * the rest of the data and continue.&n;       */
r_if
c_cond
(paren
id|scb-&gt;breakup
)paren
(brace
multiline_comment|/* we had a data breakup */
id|u16
id|bk_save
suffix:semicolon
id|bk_save
op_assign
id|scb-&gt;breakup
suffix:semicolon
id|scb-&gt;breakup
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* S/G request */
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sg
op_assign
id|scb-&gt;scsi_cmd-&gt;request_buffer
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|bk_save
suffix:semicolon
id|i
OL
id|scb-&gt;scsi_cmd-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scb-&gt;sg_list
(braket
id|i
op_minus
id|bk_save
)braket
dot
id|address
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
id|scb-&gt;sg_list
(braket
id|i
op_minus
id|bk_save
)braket
dot
id|length
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_plus
id|sg
(braket
id|i
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/*&n;                   * Data Breakup required&n;                   */
id|scb-&gt;breakup
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scb-&gt;data_len
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;breakup
)paren
id|scb-&gt;sg_len
op_assign
id|scb-&gt;scsi_cmd-&gt;use_sg
op_minus
id|bk_save
suffix:semicolon
r_else
id|scb-&gt;sg_len
op_assign
id|scb-&gt;breakup
op_minus
id|bk_save
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;sg_list
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Non S/G Request */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;request_bufflen
op_minus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
(brace
multiline_comment|/* Further breakup required */
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
op_plus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
suffix:semicolon
id|scb-&gt;breakup
op_assign
id|bk_save
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_len
op_assign
id|scb-&gt;scsi_cmd-&gt;request_bufflen
op_minus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
op_plus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
suffix:semicolon
)brace
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
)brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|ips_command_direction
(braket
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;dcdb.cmd_attribute
op_amp
l_int|0x3
)paren
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_ge
id|IPS_MAX_XFER
)paren
(brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TRANSFER_64K
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
r_return
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
)brace
multiline_comment|/* end if passthru */
macro_line|#endif
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
multiline_comment|/* call back to SCSI layer */
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
multiline_comment|/* do the next command */
id|ips_next
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_map_status                                             */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Map ServeRAID error codes to Linux Error Codes                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_map_status
id|ips_map_status
c_func
(paren
id|ips_scb_t
op_star
id|scb
comma
id|ips_stat_t
op_star
id|sp
)paren
(brace
r_int
id|errcode
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_map_status&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 10
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s) Physical device error: %x %x, Sense Key: %x, ASC: %x, ASCQ: %x&bslash;n&quot;
comma
id|ips_name
comma
id|scb-&gt;basic_status
comma
id|scb-&gt;extended_status
comma
id|scb-&gt;dcdb.sense_info
(braket
l_int|2
)braket
op_amp
l_int|0xf
comma
id|scb-&gt;dcdb.sense_info
(braket
l_int|12
)braket
comma
id|scb-&gt;dcdb.sense_info
(braket
l_int|13
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* copy SCSI status and sense data for DCDB commands */
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
comma
id|scb-&gt;dcdb.sense_info
comma
r_sizeof
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|scb-&gt;dcdb.scsi_status
suffix:semicolon
)brace
r_else
id|scb-&gt;scsi_cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default driver error */
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;basic_status
op_amp
id|GSC_STATUS_MASK
)paren
(brace
r_case
id|CMD_TIMEOUT
suffix:colon
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INVAL_OPCO
suffix:colon
r_case
id|INVAL_CMD_BLK
suffix:colon
r_case
id|INVAL_PARM_BLK
suffix:colon
r_case
id|LOG_DRV_ERROR
suffix:colon
r_case
id|CMD_CMPLT_WERROR
suffix:colon
r_break
suffix:semicolon
r_case
id|PHYS_DRV_ERROR
suffix:colon
multiline_comment|/*&n;       * For physical drive errors that&n;       * are not on a logical drive should&n;       * be DID_OK.  The SCSI errcode will&n;       * show what the real error is.&n;       */
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|errcode
op_assign
id|DID_OK
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;extended_status
)paren
(brace
r_case
id|SELECTION_TIMEOUT
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_or_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DATA_OVER_UNDER_RUN
suffix:colon
r_if
c_cond
(paren
(paren
id|scb-&gt;bus
)paren
op_logical_and
(paren
id|scb-&gt;dcdb.transfer_length
OL
id|scb-&gt;data_len
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
(paren
(paren
(paren
(paren
r_char
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_eq
id|TYPE_DISK
)paren
)paren
(brace
multiline_comment|/* underflow -- no error               */
multiline_comment|/* restrict access to physical DASD    */
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* normal underflow Occured */
r_if
c_cond
(paren
id|scb-&gt;dcdb.transfer_length
op_ge
id|scb-&gt;scsi_cmd-&gt;underflow
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_or_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|EXT_RECOVERY
suffix:colon
multiline_comment|/* don&squot;t fail recovered errors */
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_or_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXT_HOST_RESET
suffix:colon
r_case
id|EXT_DEVICE_RESET
suffix:colon
id|errcode
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXT_CHECK_CONDITION
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
)brace
multiline_comment|/* end switch */
id|scb-&gt;scsi_cmd-&gt;result
op_or_assign
(paren
id|errcode
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_send                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Wrapper for ips_send_cmd                                               */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_send
id|ips_send
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
comma
id|scb_callback
id|callback
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_send&quot;
)paren
suffix:semicolon
id|scb-&gt;callback
op_assign
id|callback
suffix:semicolon
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_send_wait                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command to the controller and wait for it to return             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_send_wait
id|ips_send_wait
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
comma
r_int
id|timeout
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_send_wait&quot;
)paren
suffix:semicolon
id|ha-&gt;waitflag
op_assign
id|TRUE
suffix:semicolon
id|ha-&gt;cmd_in_progress
op_assign
id|scb-&gt;cdb
(braket
l_int|0
)braket
suffix:semicolon
id|ret
op_assign
id|ips_send
c_func
(paren
id|ha
comma
id|scb
comma
id|ipsintr_blocking
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
)paren
r_return
(paren
id|ret
)paren
suffix:semicolon
id|ret
op_assign
id|ips_wait
c_func
(paren
id|ha
comma
id|timeout
comma
id|IPS_INTR_OFF
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_send_cmd                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Map SCSI commands to ServeRAID commands for logical drives             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_send_cmd
id|ips_send_cmd
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_send_cmd&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;scsi_cmd
)paren
(brace
multiline_comment|/* internal command */
r_if
c_cond
(paren
id|scb-&gt;bus
OG
l_int|0
)paren
(brace
multiline_comment|/* ServeRAID commands can&squot;t be issued */
multiline_comment|/* to real devices -- fail them       */
r_if
c_cond
(paren
(paren
id|ha-&gt;waitflag
op_eq
id|TRUE
)paren
op_logical_and
(paren
id|ha-&gt;cmd_in_progress
op_eq
id|scb-&gt;cdb
(braket
l_int|0
)braket
)paren
)paren
(brace
id|ha-&gt;waitflag
op_assign
id|FALSE
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
)brace
r_else
r_if
c_cond
(paren
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|ips_is_passthru
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
)paren
)paren
(brace
macro_line|#else
)brace
r_else
r_if
c_cond
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
(brace
macro_line|#endif
multiline_comment|/* command to logical bus -- interpret */
id|ret
op_assign
id|IPS_SUCCESS_IMM
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_case
id|REZERO_UNIT
suffix:colon
r_case
id|ERASE
suffix:colon
r_case
id|WRITE_FILEMARKS
suffix:colon
r_case
id|SPACE
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_STOP
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
r_case
id|INQUIRY
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;target_id
op_eq
id|IPS_ADAPTER_ID
)paren
(brace
multiline_comment|/*&n;             * Either we have a TUR&n;             * or we have a SCSI inquiry&n;             */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
)paren
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
(brace
id|IPS_INQUIRYDATA
id|inq
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|inq
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_INQUIRYDATA
)paren
)paren
suffix:semicolon
id|inq.DeviceType
op_assign
id|TYPE_PROCESSOR
suffix:semicolon
id|inq.DeviceTypeQualifier
op_assign
l_int|0
suffix:semicolon
id|inq.RemoveableMedia
op_assign
l_int|0
suffix:semicolon
id|inq.Versions
op_assign
l_int|0x1
suffix:semicolon
multiline_comment|/* SCSI I */
id|inq.AdditionalLength
op_assign
l_int|31
suffix:semicolon
id|strncpy
c_func
(paren
id|inq.VendorId
comma
l_string|&quot;IBM     &quot;
comma
l_int|8
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inq.ProductId
comma
l_string|&quot;SERVERAID       &quot;
comma
l_int|16
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inq.ProductRevisionLevel
comma
l_string|&quot;1.00&quot;
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|inq
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
r_else
(brace
id|scb-&gt;cmd.logical_info.op_code
op_assign
id|GET_LOGICAL_DRIVE_INFO
suffix:semicolon
id|scb-&gt;cmd.logical_info.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.buffer_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|ha-&gt;adapt-&gt;logical_drive_info
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved2
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|ips_reqsen
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;sg_len
)paren
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
ques
c_cond
id|IPS_READ
suffix:colon
id|IPS_WRITE
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
ques
c_cond
id|READ_SCATTER_GATHER
suffix:colon
id|WRITE_SCATTER_GATHER
suffix:semicolon
)brace
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
id|scb-&gt;target_id
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
id|scb-&gt;sg_len
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|scb-&gt;data_busaddr
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;cmd.basic_io.lba
)paren
id|scb-&gt;cmd.basic_io.lba
op_add_assign
id|scb-&gt;cmd.basic_io.sector_count
suffix:semicolon
r_else
id|scb-&gt;cmd.basic_io.lba
op_assign
(paren
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
id|scb-&gt;data_len
op_div
id|IPS_BLKSIZE
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;cmd.basic_io.sector_count
op_eq
l_int|0
)paren
id|scb-&gt;cmd.basic_io.sector_count
op_assign
l_int|256
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;sg_len
)paren
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
)paren
ques
c_cond
id|IPS_READ
suffix:colon
id|IPS_WRITE
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
)paren
ques
c_cond
id|READ_SCATTER_GATHER
suffix:colon
id|WRITE_SCATTER_GATHER
suffix:semicolon
)brace
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
id|scb-&gt;target_id
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
id|scb-&gt;sg_len
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|scb-&gt;data_busaddr
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;cmd.basic_io.lba
)paren
id|scb-&gt;cmd.basic_io.lba
op_add_assign
id|scb-&gt;cmd.basic_io.sector_count
suffix:semicolon
r_else
id|scb-&gt;cmd.basic_io.lba
op_assign
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
id|scb-&gt;data_len
op_div
id|IPS_BLKSIZE
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;cmd.basic_io.sector_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;             * This is a null condition&n;             * we don&squot;t have to do anything&n;             * so just return&n;             */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESERVE
suffix:colon
r_case
id|RELEASE
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|ENQUIRY
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;enq
)paren
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|scb-&gt;cmd.logical_info.op_code
op_assign
id|GET_LOGICAL_DRIVE_INFO
suffix:semicolon
id|scb-&gt;cmd.logical_info.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.buffer_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|ha-&gt;adapt-&gt;logical_drive_info
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved3
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|FORMAT_UNIT
suffix:colon
r_case
id|SEEK_10
suffix:colon
r_case
id|VERIFY
suffix:colon
r_case
id|READ_DEFECT_DATA
suffix:colon
r_case
id|READ_BUFFER
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
)brace
multiline_comment|/* end if */
r_if
c_cond
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
r_return
(paren
id|ret
)paren
suffix:semicolon
multiline_comment|/* setup DCDB */
r_if
c_cond
(paren
id|scb-&gt;bus
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;sg_len
)paren
id|scb-&gt;cmd.dcdb.op_code
op_assign
id|DIRECT_CDB
suffix:semicolon
r_else
id|scb-&gt;cmd.dcdb.op_code
op_assign
id|DIRECT_CDB_SCATTER_GATHER
suffix:semicolon
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|scb-&gt;cmd.dcdb.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.dcdb.dcdb_address
op_assign
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|scb-&gt;dcdb
)paren
suffix:semicolon
id|scb-&gt;cmd.dcdb.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.dcdb.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.dcdb.reserved3
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;dcdb.device_address
op_assign
(paren
(paren
id|scb-&gt;bus
op_minus
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
id|scb-&gt;target_id
suffix:semicolon
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|DISCONNECT_ALLOWED
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;timeout
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;timeout
op_le
l_int|10
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scb-&gt;timeout
op_le
l_int|60
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_60
suffix:semicolon
r_else
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_20M
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|scb-&gt;dcdb.cmd_attribute
op_amp
id|TIMEOUT_20M
)paren
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|TIMEOUT_20M
suffix:semicolon
id|scb-&gt;dcdb.sense_length
op_assign
r_sizeof
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|scb-&gt;dcdb.buffer_pointer
op_assign
id|scb-&gt;data_busaddr
suffix:semicolon
id|scb-&gt;dcdb.sg_count
op_assign
id|scb-&gt;sg_len
suffix:semicolon
id|scb-&gt;dcdb.cdb_length
op_assign
id|scb-&gt;scsi_cmd-&gt;cmd_len
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;dcdb.scsi_cdb
comma
id|scb-&gt;scsi_cmd-&gt;cmnd
comma
id|scb-&gt;scsi_cmd-&gt;cmd_len
)paren
suffix:semicolon
)brace
r_return
(paren
id|ips_issue
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_chk_status                                             */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Check the status of commands to logical drives                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_chkstatus
id|ips_chkstatus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|ips_stat_t
op_star
id|sp
op_assign
op_amp
id|ha-&gt;sp
suffix:semicolon
id|u8
id|basic_status
suffix:semicolon
id|u8
id|ext_status
suffix:semicolon
r_int
id|command_id
suffix:semicolon
r_int
id|errcode
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_chkstatus&quot;
)paren
suffix:semicolon
id|command_id
op_assign
id|ips_statupd
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command_id
OG
(paren
id|MAX_CMDS
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) invalid command id received: %d&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|command_id
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|command_id
)braket
suffix:semicolon
id|sp-&gt;scb_addr
op_assign
(paren
id|u32
)paren
id|scb
suffix:semicolon
id|sp-&gt;residue_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;basic_status
op_assign
id|basic_status
op_assign
id|ha-&gt;adapt-&gt;p_status_tail-&gt;basic_status
op_amp
id|BASIC_STATUS_MASK
suffix:semicolon
id|scb-&gt;extended_status
op_assign
id|ext_status
op_assign
id|ha-&gt;adapt-&gt;p_status_tail-&gt;extended_status
suffix:semicolon
multiline_comment|/* Remove the item from the active queue */
id|ips_removeq_scb
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
comma
id|scb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;scsi_cmd
)paren
multiline_comment|/* internal commands are handled in do_ipsintr */
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd
)paren
op_logical_and
(paren
id|ips_is_passthru
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
)paren
)paren
multiline_comment|/* passthru - just returns the raw result */
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|errcode
op_assign
id|DID_OK
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|basic_status
op_amp
id|GSC_STATUS_MASK
)paren
op_eq
id|SSUCCESS
)paren
op_logical_or
(paren
(paren
id|basic_status
op_amp
id|GSC_STATUS_MASK
)paren
op_eq
id|RECOVERED_ERROR
)paren
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 1
r_if
c_cond
(paren
(paren
id|basic_status
op_amp
id|GSC_STATUS_MASK
)paren
op_eq
id|RECOVERED_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Recovered Logical Drive Error OpCode: %x, BSB: %x, ESB: %x&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.op_code
comma
id|basic_status
comma
id|ext_status
)paren
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_case
id|REZERO_UNIT
suffix:colon
r_case
id|ERASE
suffix:colon
r_case
id|WRITE_FILEMARKS
suffix:colon
r_case
id|SPACE
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_STOP
suffix:colon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
(brace
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
r_if
c_cond
(paren
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
(brace
id|ips_inquiry
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
r_else
(brace
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|ips_reqsen
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|RELEASE
suffix:colon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
op_logical_or
op_logical_neg
id|ips_msense
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
(brace
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
r_if
c_cond
(paren
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
id|ips_rdcap
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_else
(brace
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_break
suffix:semicolon
r_case
id|FORMAT_UNIT
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEEK_10
suffix:colon
r_case
id|VERIFY
suffix:colon
r_case
id|READ_DEFECT_DATA
suffix:colon
r_case
id|READ_BUFFER
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|errcode
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* bus == 0 */
multiline_comment|/* restrict access to physical drives */
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
(paren
(paren
(paren
(paren
r_char
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_eq
id|TYPE_DISK
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* else */
)brace
r_else
(brace
multiline_comment|/* recovered error / success */
macro_line|#if IPS_DEBUG &gt;= 1
r_if
c_cond
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Unrecovered Logical Drive Error OpCode: %x, BSB: %x, ESB: %x&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.op_code
comma
id|basic_status
comma
id|ext_status
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ret
op_assign
id|ips_map_status
c_func
(paren
id|scb
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* else */
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_online                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Determine if a logical drive is online                                 */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_online
id|ips_online
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_online&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;target_id
op_ge
id|MAX_LOGICAL_DRIVES
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
(brace
id|memset
c_func
(paren
op_amp
id|ha-&gt;adapt-&gt;logical_drive_info
comma
l_int|0
comma
r_sizeof
(paren
id|ha-&gt;adapt-&gt;logical_drive_info
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scb-&gt;target_id
OL
id|ha-&gt;adapt-&gt;logical_drive_info.no_of_log_drive
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|OFF_LINE
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|FREE
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|CRS
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|SYS
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_inquiry                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate an inquiry command to a logical drive                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_inquiry
id|ips_inquiry
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_INQUIRYDATA
id|inq
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_inquiry&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|inq
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_INQUIRYDATA
)paren
)paren
suffix:semicolon
id|inq.DeviceType
op_assign
id|TYPE_DISK
suffix:semicolon
id|inq.DeviceTypeQualifier
op_assign
l_int|0
suffix:semicolon
id|inq.RemoveableMedia
op_assign
l_int|0
suffix:semicolon
id|inq.Versions
op_assign
l_int|0x1
suffix:semicolon
multiline_comment|/* SCSI I */
id|inq.AdditionalLength
op_assign
l_int|31
suffix:semicolon
id|strncpy
c_func
(paren
id|inq.VendorId
comma
l_string|&quot;IBM     &quot;
comma
l_int|8
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inq.ProductId
comma
l_string|&quot;SERVERAID       &quot;
comma
l_int|16
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inq.ProductRevisionLevel
comma
l_string|&quot;1.00&quot;
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|inq
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_rdcap                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate a read capacity command to a logical drive                    */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_rdcap
id|ips_rdcap
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|CAPACITY_T
op_star
id|cap
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_rdcap&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;bufflen
OL
l_int|8
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cap
op_assign
(paren
id|CAPACITY_T
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
suffix:semicolon
id|cap-&gt;lba
op_assign
id|htonl
c_func
(paren
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|sector_count
op_minus
l_int|1
)paren
suffix:semicolon
id|cap-&gt;len
op_assign
id|htonl
c_func
(paren
(paren
id|u32
)paren
id|IPS_BLKSIZE
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_msense                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate a mode sense command to a logical drive                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_msense
id|ips_msense
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|u16
id|heads
suffix:semicolon
id|u16
id|sectors
suffix:semicolon
id|u32
id|cylinders
suffix:semicolon
id|ips_mdata_t
id|mdata
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_msense&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;enq-&gt;ulDriveSize
(braket
id|scb-&gt;target_id
)braket
OG
l_int|0x400000
op_logical_and
(paren
id|ha-&gt;enq-&gt;ucMiscFlag
op_amp
l_int|0x8
)paren
op_eq
l_int|0
)paren
(brace
id|heads
op_assign
id|NORM_MODE_HEADS
suffix:semicolon
id|sectors
op_assign
id|NORM_MODE_SECTORS
suffix:semicolon
)brace
r_else
(brace
id|heads
op_assign
id|COMP_MODE_HEADS
suffix:semicolon
id|sectors
op_assign
id|COMP_MODE_SECTORS
suffix:semicolon
)brace
id|cylinders
op_assign
id|ha-&gt;enq-&gt;ulDriveSize
(braket
id|scb-&gt;target_id
)braket
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
id|mdata.plh.plh_type
op_assign
l_int|0
suffix:semicolon
id|mdata.plh.plh_wp
op_assign
l_int|0
suffix:semicolon
id|mdata.plh.plh_bdl
op_assign
l_int|8
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|2
)braket
op_amp
l_int|0x3f
)paren
(brace
r_case
l_int|0x03
suffix:colon
multiline_comment|/* page 3 */
id|mdata.pdata.pg3.pg_pc
op_assign
l_int|0x3
suffix:semicolon
id|mdata.pdata.pg3.pg_res1
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_len
op_assign
r_sizeof
(paren
id|DADF_T
)paren
suffix:semicolon
id|mdata.plh.plh_len
op_assign
l_int|3
op_plus
id|mdata.plh.plh_bdl
op_plus
id|mdata.pdata.pg3.pg_len
suffix:semicolon
id|mdata.pdata.pg3.pg_trk_z
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_asec_z
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_atrk_z
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_atrk_v
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_sec_t
op_assign
id|htons
c_func
(paren
id|sectors
)paren
suffix:semicolon
id|mdata.pdata.pg3.pg_bytes_s
op_assign
id|htons
c_func
(paren
id|IPS_BLKSIZE
)paren
suffix:semicolon
id|mdata.pdata.pg3.pg_intl
op_assign
id|htons
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|mdata.pdata.pg3.pg_trkskew
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_cylskew
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_res2
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_ins
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_surf
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_rmb
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_hsec
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.pg_ssec
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4
suffix:colon
id|mdata.pdata.pg4.pg_pc
op_assign
l_int|0x4
suffix:semicolon
id|mdata.pdata.pg4.pg_res1
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.pg_len
op_assign
r_sizeof
(paren
id|RDDG_T
)paren
suffix:semicolon
id|mdata.plh.plh_len
op_assign
l_int|3
op_plus
id|mdata.plh.plh_bdl
op_plus
id|mdata.pdata.pg4.pg_len
suffix:semicolon
id|mdata.pdata.pg4.pg_cylu
op_assign
(paren
id|cylinders
op_rshift
l_int|8
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mdata.pdata.pg4.pg_cyll
op_assign
id|cylinders
op_amp
l_int|0xff
suffix:semicolon
id|mdata.pdata.pg4.pg_head
op_assign
id|heads
suffix:semicolon
id|mdata.pdata.pg4.pg_wrpcompu
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.pg_wrpcompl
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.pg_redwrcur
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.pg_drstep
op_assign
id|htons
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|mdata.pdata.pg4.pg_landu
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.pg_landl
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.pg_res2
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|mdata
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reqsen                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate a request sense command to a logical drive                    */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_reqsen
id|ips_reqsen
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_char
op_star
id|sp
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_reqsen&quot;
)paren
suffix:semicolon
id|sp
op_assign
(paren
r_char
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
suffix:semicolon
id|memset
c_func
(paren
id|sp
comma
l_int|0
comma
r_sizeof
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|sp
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sp
(braket
l_int|3
)braket
op_assign
id|NO_SENSE
suffix:semicolon
id|sp
(braket
l_int|7
)braket
op_assign
l_int|0xe
suffix:semicolon
id|sp
(braket
l_int|12
)braket
op_assign
id|NO_SENSE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_free                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Free any allocated space for this controller                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_free
id|ips_free
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_free&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;enq
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;enq
)paren
suffix:semicolon
id|ha-&gt;enq
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;conf
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;conf
)paren
suffix:semicolon
id|ha-&gt;conf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;adapt
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;adapt
)paren
suffix:semicolon
id|ha-&gt;adapt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;nvram
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;nvram
)paren
suffix:semicolon
id|ha-&gt;nvram
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;subsys
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;subsys
)paren
suffix:semicolon
id|ha-&gt;subsys
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;dummy
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;dummy
)paren
suffix:semicolon
id|ha-&gt;dummy
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;scbs
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ha-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;scbs
(braket
id|i
)braket
dot
id|sg_list
)paren
id|kfree
c_func
(paren
id|ha-&gt;scbs
(braket
id|i
)braket
dot
id|sg_list
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ha-&gt;scbs
)paren
suffix:semicolon
id|ha-&gt;scbs
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* end if */
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_allocatescbs                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Allocate the command blocks                                            */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_allocatescbs
id|ips_allocatescbs
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb_p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_allocatescbs&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the CCBs */
id|ha-&gt;scbs
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|kmalloc
c_func
(paren
id|ha-&gt;max_cmds
op_star
r_sizeof
(paren
id|ips_scb_t
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;scbs
comma
l_int|0
comma
id|ha-&gt;max_cmds
op_star
r_sizeof
(paren
id|ips_scb_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ha-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scb_p
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* allocate S/G list */
id|scb_p-&gt;sg_list
op_assign
(paren
id|SG_LIST
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|SG_LIST
)paren
op_star
id|MAX_SG_ELEMENTS
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb_p-&gt;sg_list
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* add to the free list */
r_if
c_cond
(paren
id|i
OL
id|ha-&gt;max_cmds
op_minus
l_int|1
)paren
(brace
id|scb_p-&gt;q_next
op_assign
id|ha-&gt;scb_freelist
suffix:semicolon
id|ha-&gt;scb_freelist
op_assign
id|scb_p
suffix:semicolon
)brace
)brace
multiline_comment|/* success */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_init_scb                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a CCB to default values                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_init_scb
id|ips_init_scb
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|SG_LIST
op_star
id|sg_list
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_init_scb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|sg_list
op_assign
id|scb-&gt;sg_list
suffix:semicolon
multiline_comment|/* zero fill */
id|memset
c_func
(paren
id|scb
comma
l_int|0
comma
r_sizeof
(paren
id|ips_scb_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;dummy
comma
l_int|0
comma
r_sizeof
(paren
id|BASIC_IO_CMD
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize dummy command bucket */
id|ha-&gt;dummy-&gt;op_code
op_assign
l_int|0xFF
suffix:semicolon
id|ha-&gt;dummy-&gt;ccsar
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;dummy
)paren
suffix:semicolon
id|ha-&gt;dummy-&gt;command_id
op_assign
id|MAX_CMDS
suffix:semicolon
multiline_comment|/* set bus address of scb */
id|scb-&gt;scb_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb
)paren
suffix:semicolon
id|scb-&gt;sg_list
op_assign
id|sg_list
suffix:semicolon
multiline_comment|/* Neptune Fix */
id|scb-&gt;cmd.basic_io.cccr
op_assign
id|ILE
suffix:semicolon
id|scb-&gt;cmd.basic_io.ccsar
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;dummy
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_get_scb                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a CCB to default values                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be callled from within a lock                                 */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
id|ips_scb_t
op_star
DECL|function|ips_getscb
id|ips_getscb
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_getscb&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;scb_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scb
op_assign
id|ha-&gt;scb_freelist
)paren
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;scb_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|ha-&gt;scb_freelist
op_assign
id|scb-&gt;q_next
suffix:semicolon
id|scb-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;scb_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_return
(paren
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_free_scb                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Return an unused CCB back to the free list                             */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_freescb
id|ips_freescb
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
r_int
id|cpu_flags
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_freescb&quot;
)paren
suffix:semicolon
multiline_comment|/* check to make sure this is not our &quot;special&quot; scb */
r_if
c_cond
(paren
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
OL
(paren
id|ha-&gt;max_cmds
op_minus
l_int|1
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;scb_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|scb-&gt;q_next
op_assign
id|ha-&gt;scb_freelist
suffix:semicolon
id|ha-&gt;scb_freelist
op_assign
id|scb
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;scb_lock
comma
id|cpu_flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reset_adapter                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_reset_adapter
id|ips_reset_adapter
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u8
id|Isr
suffix:semicolon
id|u8
id|Cbsp
suffix:semicolon
id|u8
id|PostByte
(braket
id|MAX_POST_BYTES
)braket
suffix:semicolon
id|u8
id|ConfigByte
(braket
id|MAX_CONFIG_BYTES
)braket
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|reset_counter
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_reset_adapter&quot;
)paren
suffix:semicolon
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ips_reset_adapter: io addr: %x, irq: %d&bslash;n&quot;
comma
id|ha-&gt;io_addr
comma
id|ha-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
id|reset_counter
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reset_counter
OL
l_int|2
)paren
(brace
id|reset_counter
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|RST
comma
id|ha-&gt;io_addr
op_plus
id|SCPR
)paren
suffix:semicolon
id|MDELAY
c_func
(paren
id|ONE_SEC
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|SCPR
)paren
suffix:semicolon
id|MDELAY
c_func
(paren
id|ONE_SEC
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_POST_BYTES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|45
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|GHI
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|45
)paren
(brace
multiline_comment|/* error occured */
r_if
c_cond
(paren
id|reset_counter
OL
l_int|2
)paren
r_continue
suffix:semicolon
r_else
multiline_comment|/* reset failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|PostByte
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|ISPR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Isr
comma
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|PostByte
(braket
l_int|0
)braket
OL
id|GOOD_POST_BASIC_STATUS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(%s%d) reset controller fails (post status %x %x).&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|PostByte
(braket
l_int|0
)braket
comma
id|PostByte
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CONFIG_BYTES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|240
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|GHI
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|ONE_SEC
)paren
suffix:semicolon
multiline_comment|/* 100 msec */
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|240
)paren
(brace
multiline_comment|/* error occured */
r_if
c_cond
(paren
id|reset_counter
OL
l_int|2
)paren
r_continue
suffix:semicolon
r_else
multiline_comment|/* reset failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|ConfigByte
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|ISPR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Isr
comma
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ConfigByte
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_and
id|ConfigByte
(braket
l_int|1
)braket
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(%s%d) reset controller fails (status %x %x).&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ConfigByte
(braket
l_int|0
)braket
comma
id|ConfigByte
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|240
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Cbsp
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|CBSP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Cbsp
op_amp
id|OP
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|240
)paren
(brace
multiline_comment|/* error occured */
r_if
c_cond
(paren
id|reset_counter
OL
l_int|2
)paren
r_continue
suffix:semicolon
r_else
multiline_comment|/* reset failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* setup CCCR */
id|outw
c_func
(paren
l_int|0x1010
comma
id|ha-&gt;io_addr
op_plus
id|CCCR
)paren
suffix:semicolon
multiline_comment|/* Enable busmastering */
id|outb
c_func
(paren
id|EBM
comma
id|ha-&gt;io_addr
op_plus
id|SCPR
)paren
suffix:semicolon
multiline_comment|/* setup status queues */
id|ips_statinit
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|outb
c_func
(paren
id|EI
comma
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
multiline_comment|/* if we get here then everything went OK */
r_break
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statinit                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize the status queues on the controller                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_statinit
id|ips_statinit
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u32
id|phys_status_start
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_statinit&quot;
)paren
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_start
op_assign
id|ha-&gt;adapt-&gt;status
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_end
op_assign
id|ha-&gt;adapt-&gt;status
op_plus
id|MAX_CMDS
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_tail
op_assign
id|ha-&gt;adapt-&gt;status
suffix:semicolon
id|phys_status_start
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;adapt-&gt;status
)paren
suffix:semicolon
id|outl
c_func
(paren
id|phys_status_start
comma
id|ha-&gt;io_addr
op_plus
id|SQSR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|phys_status_start
op_plus
id|STATUS_Q_SIZE
comma
id|ha-&gt;io_addr
op_plus
id|SQER
)paren
suffix:semicolon
id|outl
c_func
(paren
id|phys_status_start
op_plus
id|STATUS_SIZE
comma
id|ha-&gt;io_addr
op_plus
id|SQHR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|phys_status_start
comma
id|ha-&gt;io_addr
op_plus
id|SQTR
)paren
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_start
op_assign
id|phys_status_start
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_assign
id|phys_status_start
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statupd                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an element from the status queue                                */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_statupd
id|ips_statupd
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|command_id
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_statupd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;adapt-&gt;p_status_tail
op_ne
id|ha-&gt;adapt-&gt;p_status_end
)paren
(brace
id|ha-&gt;adapt-&gt;p_status_tail
op_increment
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_add_assign
r_sizeof
(paren
id|STATUS
)paren
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;adapt-&gt;p_status_tail
op_assign
id|ha-&gt;adapt-&gt;p_status_start
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_assign
id|ha-&gt;adapt-&gt;hw_status_start
suffix:semicolon
)brace
id|outl
c_func
(paren
id|ha-&gt;adapt-&gt;hw_status_tail
comma
id|ha-&gt;io_addr
op_plus
id|SQTR
)paren
suffix:semicolon
id|command_id
op_assign
id|ha-&gt;adapt-&gt;p_status_tail-&gt;command_id
suffix:semicolon
r_return
(paren
id|command_id
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_issue                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command down to the controller                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_issue
id|ips_issue
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|u32
id|TimeOut
suffix:semicolon
id|u16
id|val
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_issue&quot;
)paren
suffix:semicolon
macro_line|#if IPS_DEBUG &gt;= 10
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: ips_issue: cmd 0x%X id %d (%d %d %d)&bslash;n&quot;
comma
id|ips_name
comma
id|scb-&gt;cdb
(braket
l_int|0
)braket
comma
id|scb-&gt;cmd.basic_io.command_id
comma
id|scb-&gt;bus
comma
id|scb-&gt;target_id
comma
id|scb-&gt;lun
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: ips_issue: logical cmd id %d&bslash;n&quot;
comma
id|ips_name
comma
id|scb-&gt;cmd.basic_io.command_id
)paren
suffix:semicolon
macro_line|#if IPS_DEBUG &gt;= 11
id|MDELAY
c_func
(paren
id|ONE_SEC
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|TimeOut
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|val
op_assign
id|inw
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|CCCR
)paren
)paren
op_amp
id|SEMAPHORE
)paren
(brace
id|UDELAY
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|TimeOut
op_ge
id|SEMAPHORE_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|START_STOP_BIT
)paren
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ips_issue val [0x%x].&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|val
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ips_issue semaphore chk timeout.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* end if */
)brace
multiline_comment|/* end while */
id|outl
c_func
(paren
id|scb-&gt;scb_busaddr
comma
id|ha-&gt;io_addr
op_plus
id|CCSAR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|START_COMMAND
comma
id|ha-&gt;io_addr
op_plus
id|CCCR
)paren
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isintr                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Test to see if an interrupt is for us                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isintr
id|ips_isintr
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u8
id|Isr
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_isintr&quot;
)paren
suffix:semicolon
id|Isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_eq
l_int|0xFF
)paren
multiline_comment|/* ?!?! Nothing really there */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|SCE
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Isr
op_amp
(paren
id|SQO
op_or
id|GHI
)paren
)paren
(brace
multiline_comment|/* status queue overflow or GHI */
multiline_comment|/* just clear the interrupt */
id|outb
c_func
(paren
id|Isr
comma
id|ha-&gt;io_addr
op_plus
id|HISR
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_wait                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Wait for a command to complete                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_wait
id|ips_wait
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|time
comma
r_int
id|intr
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_wait&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|IPS_FAILURE
suffix:semicolon
id|time
op_mul_assign
id|ONE_SEC
suffix:semicolon
multiline_comment|/* convert seconds to milliseconds */
r_while
c_loop
(paren
id|time
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|intr
op_eq
id|IPS_INTR_OFF
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;waitflag
op_eq
id|FALSE
)paren
(brace
multiline_comment|/*&n;             * controller generated an interupt to&n;             * acknowledge completion of the command&n;             * and ips_intr() has serviced the interrupt.&n;             */
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;          * NOTE: Interrupts are disabled here&n;          * On an SMP system interrupts will only&n;          * be disabled on one processor.&n;          * So, ultimately we still need to set the&n;          * &quot;I&squot;m in the interrupt handler flag&quot;&n;          */
r_while
c_loop
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
id|UDELAY
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|ips_intr
c_func
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ha-&gt;waitflag
op_eq
id|FALSE
)paren
(brace
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|UDELAY
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* 1 milisecond */
id|time
op_decrement
suffix:semicolon
)brace
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_write_driver_status                                    */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Write OS/Driver version to Page 5 of the nvram on the controller       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_write_driver_status
id|ips_write_driver_status
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;ips_write_driver_status&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_readwrite_page5
c_func
(paren
id|ha
comma
id|FALSE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read NVRAM page 5.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* check to make sure the page has a valid */
multiline_comment|/* signature */
r_if
c_cond
(paren
id|ha-&gt;nvram-&gt;signature
op_ne
id|NVRAM_PAGE5_SIGNATURE
)paren
(brace
macro_line|#if IPS_DEBUG &gt;= 1
id|printk
c_func
(paren
l_string|&quot;(%s%d) NVRAM page 5 has an invalid signature: %X.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ha-&gt;nvram-&gt;signature
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if IPS_DEBUG &gt;= 2
id|printk
c_func
(paren
l_string|&quot;(%s%d) Ad Type: %d, Ad Slot: %d, BIOS: %c%c%c%c %c%c%c%c.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ha-&gt;nvram-&gt;adapter_type
comma
id|ha-&gt;nvram-&gt;adapter_slot
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|3
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* save controller type */
id|ha-&gt;ad_type
op_assign
id|ha-&gt;nvram-&gt;adapter_type
suffix:semicolon
multiline_comment|/* change values (as needed) */
id|ha-&gt;nvram-&gt;operating_system
op_assign
id|OS_LINUX
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|ha-&gt;nvram-&gt;driver_high
comma
id|IPS_VERSION_HIGH
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|ha-&gt;nvram-&gt;driver_low
comma
id|IPS_VERSION_LOW
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* now update the page */
r_if
c_cond
(paren
op_logical_neg
id|ips_readwrite_page5
c_func
(paren
id|ha
comma
id|TRUE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to write NVRAM page 5.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_read_adapter_status                                    */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Do an Inquiry command to the adapter                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_read_adapter_status
id|ips_read_adapter_status
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_read_adapter_status&quot;
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|ENQUIRY
suffix:semicolon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|ENQUIRY
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;enq
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.lba
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* send command */
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_read_subsystem_parameters                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Read subsystem parameters from the adapter                             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_read_subsystem_parameters
id|ips_read_subsystem_parameters
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_read_subsystem_parameters&quot;
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|GET_SUBSYS_PARAM
suffix:semicolon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|GET_SUBSYS_PARAM
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;subsys
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.lba
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* send command */
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_read_config                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Read the configuration on the adapter                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_read_config
id|ips_read_config
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_read_config&quot;
)paren
suffix:semicolon
multiline_comment|/* set defaults for initiator IDs */
id|ha-&gt;conf-&gt;init_id
(braket
l_int|0
)braket
op_assign
id|IPS_ADAPTER_ID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|ha-&gt;conf-&gt;init_id
(braket
id|i
)braket
op_assign
l_int|7
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|READ_NVRAM_CONFIGURATION
suffix:semicolon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|READ_NVRAM_CONFIGURATION
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;conf
)paren
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
(brace
id|memset
c_func
(paren
id|ha-&gt;conf
comma
l_int|0
comma
r_sizeof
(paren
id|CONFCMD
)paren
)paren
suffix:semicolon
multiline_comment|/* reset initiator IDs */
id|ha-&gt;conf-&gt;init_id
(braket
l_int|0
)braket
op_assign
id|IPS_ADAPTER_ID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|ha-&gt;conf-&gt;init_id
(braket
id|i
)braket
op_assign
l_int|7
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_readwrite_page5                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Read the configuration on the adapter                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_readwrite_page5
id|ips_readwrite_page5
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|write
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_readwrite_page5&quot;
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|RW_NVRAM_PAGE
suffix:semicolon
id|scb-&gt;cmd.nvram.op_code
op_assign
id|RW_NVRAM_PAGE
suffix:semicolon
id|scb-&gt;cmd.nvram.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.nvram.page
op_assign
l_int|5
suffix:semicolon
id|scb-&gt;cmd.nvram.write
op_assign
id|write
suffix:semicolon
id|scb-&gt;cmd.nvram.buffer_addr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;nvram
)paren
suffix:semicolon
id|scb-&gt;cmd.nvram.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.nvram.reserved2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue the command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
(brace
id|memset
c_func
(paren
id|ha-&gt;nvram
comma
l_int|0
comma
r_sizeof
(paren
id|NVRAM_PAGE5
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_clear_adapter                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Clear the stripe lock tables                                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_clear_adapter
id|ips_clear_adapter
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ips_clear_adapter&quot;
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_reset_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|CONFIG_SYNC
suffix:semicolon
id|scb-&gt;cmd.config_sync.op_code
op_assign
id|CONFIG_SYNC
suffix:semicolon
id|scb-&gt;cmd.config_sync.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.config_sync.channel
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.config_sync.source_target
op_assign
id|POCL
suffix:semicolon
id|scb-&gt;cmd.config_sync.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.config_sync.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.config_sync.reserved3
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue command */
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_reset_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* send unlock stripe command */
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|GET_ERASE_ERROR_TABLE
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_reset_timeout
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.op_code
op_assign
id|GET_ERASE_ERROR_TABLE
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.log_drv
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.control
op_assign
id|CSL
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.reserved3
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue command */
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_reset_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if defined (MODULE)
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|IPS
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we almost follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 2&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -2&n; * c-argdecl-indent: 2&n; * c-label-offset: -2&n; * c-continued-statement-offset: 2&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
