multiline_comment|/*&n;  SCSI Tape Driver for Linux version 1.1 and newer. See the accompanying&n;  file README.st for more information.&n;&n;  History:&n;  Rewritten from Dwayne Forsyth&squot;s SCSI tape driver by Kai Makisara.&n;  Contribution and ideas from several people including (in alphabetical&n;  order) Klaus Ehrenfried, Wolfgang Denk, Steve Hirsch, Andreas Koppenh&quot;ofer,&n;  Eyal Lebedinsky, J&quot;org Weule, and Eric Youngdale.&n;&n;  Copyright 1992 - 1996 Kai Makisara&n;&t;&t; email Kai.Makisara@metla.fi&n;&n;  Last modified: Tue Oct  1 22:53:51 1996 by makisara@kai.makisara.fi&n;  Some small formal changes - aeb, 950809&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
multiline_comment|/* The driver prints some debugging information on the console if DEBUG&n;   is defined and non-zero. */
DECL|macro|DEBUG
mdefine_line|#define DEBUG 0
multiline_comment|/* The message level for the debug messages is currently set to KERN_NOTICE&n;   so that people can easily see the messages. Later when the debugging messages&n;   in the drivers are more widely classified, this may be changed to KERN_DEBUG. */
DECL|macro|ST_DEB_MSG
mdefine_line|#define ST_DEB_MSG  KERN_NOTICE
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR SCSI_TAPE_MAJOR
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
macro_line|#include &quot;st.h&quot;
macro_line|#include &quot;constants.h&quot;
multiline_comment|/* The default definitions have been moved to st_options.h */
DECL|macro|ST_BLOCK_SIZE
mdefine_line|#define ST_BLOCK_SIZE 1024
macro_line|#include &quot;st_options.h&quot;
DECL|macro|ST_BUFFER_SIZE
mdefine_line|#define ST_BUFFER_SIZE (ST_BUFFER_BLOCKS * ST_BLOCK_SIZE)
DECL|macro|ST_WRITE_THRESHOLD
mdefine_line|#define ST_WRITE_THRESHOLD (ST_WRITE_THRESHOLD_BLOCKS * ST_BLOCK_SIZE)
multiline_comment|/* The buffer size should fit into the 24 bits for length in the&n;   6-byte SCSI read and write commands. */
macro_line|#if ST_BUFFER_SIZE &gt;= (2 &lt;&lt; 24 - 1)
macro_line|#error &quot;Buffer size should not exceed (2 &lt;&lt; 24 - 1) bytes!&quot;
macro_line|#endif
macro_line|#if DEBUG
DECL|variable|debugging
r_static
r_int
id|debugging
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES 0
DECL|macro|MAX_WRITE_RETRIES
mdefine_line|#define MAX_WRITE_RETRIES 0
DECL|macro|MAX_READY_RETRIES
mdefine_line|#define MAX_READY_RETRIES 5
DECL|macro|NO_TAPE
mdefine_line|#define NO_TAPE  NOT_READY
DECL|macro|ST_TIMEOUT
mdefine_line|#define ST_TIMEOUT (900 * HZ)
DECL|macro|ST_LONG_TIMEOUT
mdefine_line|#define ST_LONG_TIMEOUT (14000 * HZ)
DECL|macro|TAPE_NR
mdefine_line|#define TAPE_NR(x) (MINOR(x) &amp; ~(128 | ST_MODE_MASK))
DECL|macro|TAPE_MODE
mdefine_line|#define TAPE_MODE(x) ((MINOR(x) &amp; ST_MODE_MASK) &gt;&gt; ST_MODE_SHIFT)
multiline_comment|/* Internal ioctl to set both density (uppermost 8 bits) and blocksize (lower&n;   24 bits) */
DECL|macro|SET_DENS_AND_BLK
mdefine_line|#define SET_DENS_AND_BLK 0x10001
DECL|variable|st_nbr_buffers
r_static
r_int
id|st_nbr_buffers
suffix:semicolon
DECL|variable|st_buffers
r_static
id|ST_buffer
op_star
op_star
id|st_buffers
suffix:semicolon
DECL|variable|st_buffer_size
r_static
r_int
id|st_buffer_size
op_assign
id|ST_BUFFER_SIZE
suffix:semicolon
DECL|variable|st_write_threshold
r_static
r_int
id|st_write_threshold
op_assign
id|ST_WRITE_THRESHOLD
suffix:semicolon
DECL|variable|st_max_buffers
r_static
r_int
id|st_max_buffers
op_assign
id|ST_MAX_BUFFERS
suffix:semicolon
DECL|variable|scsi_tapes
id|Scsi_Tape
op_star
id|scsi_tapes
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|modes_defined
r_static
r_int
id|modes_defined
op_assign
id|FALSE
suffix:semicolon
r_static
id|ST_buffer
op_star
id|new_tape_buffer
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|enlarge_buffer
c_func
(paren
id|ST_buffer
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|normalize_buffer
c_func
(paren
id|ST_buffer
op_star
)paren
suffix:semicolon
r_static
r_int
id|st_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|st_attach
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_int
id|st_detect
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_void
id|st_detach
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
DECL|variable|st_template
r_struct
id|Scsi_Device_Template
id|st_template
op_assign
(brace
l_int|NULL
comma
l_string|&quot;tape&quot;
comma
l_string|&quot;st&quot;
comma
l_int|NULL
comma
id|TYPE_TAPE
comma
id|SCSI_TAPE_MAJOR
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|st_detect
comma
id|st_init
comma
l_int|NULL
comma
id|st_attach
comma
id|st_detach
)brace
suffix:semicolon
r_static
r_int
id|st_compression
c_func
(paren
id|Scsi_Tape
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|find_partition
c_func
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_int
id|update_partition
c_func
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_int
id|st_int_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
"&f;"
multiline_comment|/* Convert the result to success code */
r_static
r_int
DECL|function|st_chk_result
id|st_chk_result
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|SCpnt-&gt;request.rq_dev
)paren
suffix:semicolon
r_int
id|result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
r_int
r_char
op_star
id|sense
op_assign
id|SCpnt-&gt;sense_buffer
comma
id|scode
suffix:semicolon
macro_line|#if DEBUG
r_const
r_char
op_star
id|stp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|result
multiline_comment|/* &amp;&amp; SCpnt-&gt;sense_buffer[0] == 0 */
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Error: %x, cmd: %x %x %x %x %x %x Len: %d&bslash;n&quot;
comma
id|dev
comma
id|result
comma
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;data_cmnd
(braket
l_int|1
)braket
comma
id|SCpnt-&gt;data_cmnd
(braket
l_int|2
)braket
comma
id|SCpnt-&gt;data_cmnd
(braket
l_int|3
)braket
comma
id|SCpnt-&gt;data_cmnd
(braket
l_int|4
)braket
comma
id|SCpnt-&gt;data_cmnd
(braket
l_int|5
)braket
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
id|print_sense
c_func
(paren
l_string|&quot;st&quot;
comma
id|SCpnt
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|scode
op_assign
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0x0f
suffix:semicolon
macro_line|#if !DEBUG
r_if
c_cond
(paren
op_logical_neg
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
op_logical_or
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
id|scode
op_ne
id|NO_SENSE
op_logical_and
id|scode
op_ne
id|RECOVERED_ERROR
op_logical_and
multiline_comment|/*       scode != UNIT_ATTENTION &amp;&amp; */
id|scode
op_ne
id|BLANK_CHECK
op_logical_and
id|scode
op_ne
id|VOLUME_OVERFLOW
op_logical_and
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
op_ne
id|MODE_SENSE
op_logical_and
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
op_ne
id|TEST_UNIT_READY
)paren
)paren
(brace
multiline_comment|/* Abnormal conditions for tape */
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_SENSE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Error with sense data: &quot;
comma
id|dev
)paren
suffix:semicolon
id|print_sense
c_func
(paren
l_string|&quot;st&quot;
comma
id|SCpnt
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Error %x.&bslash;n&quot;
comma
id|dev
comma
id|result
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
id|scode
op_eq
id|RECOVERED_ERROR
macro_line|#if ST_RECOVERED_WRITE_FATAL
op_logical_and
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
op_ne
id|WRITE_6
op_logical_and
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
op_ne
id|WRITE_FILEMARKS
macro_line|#endif
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|recover_count
op_increment
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|mt_status-&gt;mt_erreg
op_add_assign
(paren
l_int|1
op_lshift
id|MT_ST_SOFTERR_SHIFT
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
id|stp
op_assign
l_string|&quot;read&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;data_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
id|stp
op_assign
l_string|&quot;write&quot;
suffix:semicolon
r_else
id|stp
op_assign
l_string|&quot;ioctl&quot;
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Recovered %s error (%d).&bslash;n&quot;
comma
id|dev
comma
id|stp
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|recover_count
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0xe0
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* Wakeup from interrupt */
r_static
r_void
DECL|function|st_sleep_done
id|st_sleep_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|st_nbr
suffix:semicolon
r_int
id|remainder
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|st_nbr
op_assign
id|TAPE_NR
c_func
(paren
id|SCpnt-&gt;request.rq_dev
)paren
)paren
OL
id|st_template.nr_dev
)paren
(brace
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|st_nbr
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
)paren
(brace
multiline_comment|/* EOM at write-behind, has all been written? */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|remainder
op_assign
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
r_else
id|remainder
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|VOLUME_OVERFLOW
op_logical_or
id|remainder
OG
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
multiline_comment|/* Error */
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
op_assign
id|INT_MAX
suffix:semicolon
multiline_comment|/* OK */
)brace
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
)paren
(brace
multiline_comment|/* Process errors before releasing request */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_assign
id|st_chk_result
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
)brace
r_else
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_SCSI_DONE
suffix:semicolon
macro_line|#if DEBUG
id|STp-&gt;write_pending
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|up
c_func
(paren
id|SCpnt-&gt;request.sem
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_else
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st?: Illegal interrupt device %x&bslash;n&quot;
comma
id|st_nbr
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Do the scsi command */
r_static
id|Scsi_Cmnd
op_star
DECL|function|st_do_scsi
id|st_do_scsi
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|Scsi_Tape
op_star
id|STp
comma
r_int
r_char
op_star
id|cmd
comma
r_int
id|bytes
comma
r_int
id|timeout
comma
r_int
id|retries
)paren
(brace
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|STp-&gt;device
comma
l_int|1
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Can&squot;t get SCSI request.&bslash;n&quot;
comma
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|cmd
(braket
l_int|1
)braket
op_or_assign
(paren
id|SCpnt-&gt;lun
op_lshift
l_int|5
)paren
op_amp
l_int|0xe0
suffix:semicolon
id|STp-&gt;sem
op_assign
id|MUTEX_LOCKED
suffix:semicolon
id|SCpnt-&gt;request.sem
op_assign
op_amp
(paren
id|STp-&gt;sem
)paren
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|SCpnt-&gt;request.rq_dev
op_assign
id|STp-&gt;devt
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
comma
id|bytes
comma
id|st_sleep_done
comma
id|timeout
comma
id|retries
)paren
suffix:semicolon
id|down
c_func
(paren
id|SCpnt-&gt;request.sem
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_assign
id|st_chk_result
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCpnt
suffix:semicolon
)brace
multiline_comment|/* Handle the write-behind checking */
r_static
r_void
DECL|function|write_behind_check
id|write_behind_check
c_func
(paren
id|Scsi_Tape
op_star
id|STp
)paren
(brace
id|ST_buffer
op_star
id|STbuffer
suffix:semicolon
id|STbuffer
op_assign
id|STp-&gt;buffer
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|STp-&gt;write_pending
)paren
id|STp-&gt;nbr_waits
op_increment
suffix:semicolon
r_else
id|STp-&gt;nbr_finished
op_increment
suffix:semicolon
macro_line|#endif
id|down
c_func
(paren
op_amp
(paren
id|STp-&gt;sem
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STbuffer-&gt;writing
OL
id|STbuffer-&gt;buffer_bytes
)paren
id|memcpy
c_func
(paren
id|STbuffer-&gt;b_data
comma
id|STbuffer-&gt;b_data
op_plus
id|STbuffer-&gt;writing
comma
id|STbuffer-&gt;buffer_bytes
op_minus
id|STbuffer-&gt;writing
)paren
suffix:semicolon
id|STbuffer-&gt;buffer_bytes
op_sub_assign
id|STbuffer-&gt;writing
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STp-&gt;drv_block
op_increment
suffix:semicolon
r_else
id|STp-&gt;drv_block
op_add_assign
id|STbuffer-&gt;writing
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|STbuffer-&gt;writing
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Back over EOF if it has been inadvertently crossed (ioctl not used because&n;   it messes up the block number). */
r_static
r_int
DECL|function|back_over_eof
id|back_over_eof
c_func
(paren
id|Scsi_Tape
op_star
id|STp
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|cmd
(braket
l_int|2
)braket
op_assign
id|cmd
(braket
l_int|3
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* -1 filemarks */
id|cmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Backing over filemark failed.&bslash;n&quot;
comma
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_add_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_blkno
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
suffix:semicolon
)brace
multiline_comment|/* Flush the write buffer (never need to write if variable blocksize). */
r_static
r_int
DECL|function|flush_write_buffer
id|flush_write_buffer
c_func
(paren
id|Scsi_Tape
op_star
id|STp
)paren
(brace
r_int
id|offset
comma
id|transfer
comma
id|blks
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
)paren
(brace
id|write_behind_check
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Async write error (flush) %x.&bslash;n&quot;
comma
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
op_eq
id|INT_MAX
)paren
r_return
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;dirty
op_eq
l_int|1
)paren
(brace
id|offset
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:semicolon
id|transfer
op_assign
(paren
(paren
id|offset
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
)paren
op_star
id|STp-&gt;block_size
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Flushing %d bytes.&bslash;n&quot;
comma
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
comma
id|transfer
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
id|offset
comma
l_int|0
comma
id|transfer
op_minus
id|offset
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|blks
op_assign
id|transfer
op_div
id|STp-&gt;block_size
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|ST_TIMEOUT
comma
id|MAX_WRITE_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NO_SENSE
)paren
(brace
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Error on flush.&bslash;n&quot;
comma
id|TAPE_NR
c_func
(paren
id|STp-&gt;devt
)paren
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
id|STp-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Flush the tape buffer. The tape will be positioned correctly unless&n;   seek_next is true. */
r_static
r_int
DECL|function|flush_buffer
id|flush_buffer
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|seek_next
)paren
(brace
r_int
id|backspace
comma
id|result
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_buffer
op_star
id|STbuffer
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
id|STbuffer
op_assign
id|STp-&gt;buffer
suffix:semicolon
multiline_comment|/*&n;   * If there was a bus reset, block further access&n;   * to this device.&n;   */
r_if
c_cond
(paren
id|STp-&gt;device-&gt;was_reset
)paren
(brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_eq
id|ST_WRITING
)paren
multiline_comment|/* Writing */
r_return
id|flush_write_buffer
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
(brace
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|backspace
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
)paren
op_div
id|STp-&gt;block_size
op_minus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|seek_next
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;eof
op_eq
id|ST_FM
)paren
op_logical_and
op_logical_neg
id|STp-&gt;eof_hit
)paren
(brace
id|result
op_assign
id|back_over_eof
c_func
(paren
id|STp
)paren
suffix:semicolon
multiline_comment|/* Back over the EOF hit */
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
op_logical_and
id|backspace
OG
l_int|0
)paren
id|result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTBSR
comma
id|backspace
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|STp-&gt;eof
op_eq
id|ST_FM
)paren
op_logical_and
op_logical_neg
id|STp-&gt;eof_hit
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_increment
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Set the mode parameters */
r_static
r_int
DECL|function|set_mode_densblk
id|set_mode_densblk
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|Scsi_Tape
op_star
id|STp
comma
id|ST_mode
op_star
id|STm
)paren
(brace
r_int
id|set_it
op_assign
id|FALSE
suffix:semicolon
r_int
r_int
id|arg
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;density_changed
op_logical_and
id|STm-&gt;default_density
op_ge
l_int|0
op_logical_and
id|STm-&gt;default_density
op_ne
id|STp-&gt;density
)paren
(brace
id|arg
op_assign
id|STm-&gt;default_density
suffix:semicolon
id|set_it
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
id|arg
op_assign
id|STp-&gt;density
suffix:semicolon
id|arg
op_lshift_assign
id|MT_ST_DENSITY_SHIFT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;blksize_changed
op_logical_and
id|STm-&gt;default_blksize
op_ge
l_int|0
op_logical_and
id|STm-&gt;default_blksize
op_ne
id|STp-&gt;block_size
)paren
(brace
id|arg
op_or_assign
id|STm-&gt;default_blksize
suffix:semicolon
id|set_it
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
id|arg
op_or_assign
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
id|set_it
op_logical_and
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|SET_DENS_AND_BLK
comma
id|arg
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Can&squot;t set default block size to %d bytes and density %x.&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;default_blksize
comma
id|STm-&gt;default_density
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modes_defined
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Open the device */
r_static
r_int
DECL|function|scsi_tape_open
id|scsi_tape_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|need_dma_buffer
comma
id|new_session
op_assign
id|FALSE
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|mode
op_assign
id|TAPE_MODE
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|st_template.dev_max
op_logical_or
op_logical_neg
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;in_use
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Device already in use.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
id|STp-&gt;rew_at_close
op_assign
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|STp-&gt;current_mode
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Mode change from %d to %d.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;current_mode
comma
id|mode
)paren
suffix:semicolon
macro_line|#endif
id|new_session
op_assign
id|TRUE
suffix:semicolon
id|STp-&gt;current_mode
op_assign
id|mode
suffix:semicolon
)brace
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
multiline_comment|/* Allocate buffer for this user */
id|need_dma_buffer
op_assign
id|STp-&gt;restr_dma
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_nbr_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|in_use
op_logical_and
(paren
op_logical_neg
id|need_dma_buffer
op_logical_or
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|dma
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|st_nbr_buffers
)paren
(brace
id|STp-&gt;buffer
op_assign
id|new_tape_buffer
c_func
(paren
id|FALSE
comma
id|need_dma_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Can&squot;t allocate tape buffer.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
)brace
r_else
id|STp-&gt;buffer
op_assign
id|st_buffers
(braket
id|i
)braket
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_assign
l_int|0
suffix:semicolon
id|flags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|STp-&gt;write_prot
op_assign
(paren
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDONLY
)paren
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ready
op_assign
id|ST_READY
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;eof
op_ne
id|ST_EOD
)paren
multiline_comment|/* Save EOD across opens */
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;recover_count
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|STp-&gt;nbr_waits
op_assign
id|STp-&gt;nbr_finished
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_increment
suffix:semicolon
)brace
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|ST_LONG_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_decrement
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|UNIT_ATTENTION
)paren
(brace
multiline_comment|/* New media? */
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|ST_LONG_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This guess will be updated later if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|moves_after_eof
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|at_sm
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|last_block_valid
op_assign
id|FALSE
suffix:semicolon
)brace
id|new_session
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NO_TAPE
)paren
(brace
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;st%d: No tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|STp-&gt;ready
op_assign
id|ST_NO_TAPE
suffix:semicolon
)brace
r_else
(brace
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STp-&gt;ready
op_assign
id|ST_NOT_READY
suffix:semicolon
)brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
id|STp-&gt;density
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the erroneous &quot;residue&quot; */
id|STp-&gt;write_prot
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;block_size
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
id|STp-&gt;in_use
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;omit_blklims
)paren
id|STp-&gt;min_block
op_assign
id|STp-&gt;max_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_else
(brace
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_BLOCK_LIMITS
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
l_int|6
comma
id|ST_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;result
op_logical_and
op_logical_neg
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
)paren
(brace
id|STp-&gt;max_block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
suffix:semicolon
id|STp-&gt;min_block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Block limits %d - %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;min_block
comma
id|STp-&gt;max_block
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|STp-&gt;min_block
op_assign
id|STp-&gt;max_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Can&squot;t read block limits.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|12
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
l_int|12
comma
id|ST_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: No Mode Sense.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;block_size
op_assign
id|ST_DEFAULT_BLOCK
suffix:semicolon
multiline_comment|/* Educated guess (?) */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Prevent error propagation */
id|STp-&gt;drv_write_prot
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Mode sense. Length %d, medium %x, WBS %x, BLL %d&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
op_ge
l_int|8
)paren
(brace
id|STp-&gt;drv_buffer
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|7
suffix:semicolon
id|STp-&gt;density
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
suffix:semicolon
id|STp-&gt;block_size
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Density %x, tape length: %x, drv buffer: %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;density
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
op_star
l_int|65536
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|6
)braket
op_star
l_int|256
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|7
)braket
comma
id|STp-&gt;drv_buffer
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|STp-&gt;block_size
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_logical_and
op_logical_neg
id|enlarge_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|STp-&gt;block_size
comma
id|STp-&gt;restr_dma
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;st%d: Blocksize %d too large for buffer.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;block_size
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_decrement
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;drv_write_prot
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
id|STp-&gt;block_size
OG
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
id|st_buffer_size
op_div
id|STp-&gt;block_size
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Block size: %d, buffer size: %d (%d blocks).&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;block_size
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;drv_write_prot
)paren
(brace
id|STp-&gt;write_prot
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Write protected&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_WRONLY
op_logical_or
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDWR
)paren
(brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_decrement
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EROFS
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
id|STp-&gt;nbr_partitions
OL
l_int|1
)paren
(brace
multiline_comment|/* This code is reached when the device is opened for the first time&n;&t; after the driver has been initialized with tape in the drive and the&n;&t; partition support has been enabled. */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Updating partition number in status.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;partition
op_assign
id|find_partition
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
(brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_decrement
suffix:semicolon
)brace
r_return
id|STp-&gt;partition
suffix:semicolon
)brace
id|STp-&gt;new_partition
op_assign
id|STp-&gt;partition
suffix:semicolon
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This guess will be updated when necessary */
)brace
r_if
c_cond
(paren
id|new_session
)paren
(brace
multiline_comment|/* Change the drive parameters for the new mode */
id|STp-&gt;density_changed
op_assign
id|STp-&gt;blksize_changed
op_assign
id|FALSE
suffix:semicolon
id|STp-&gt;compression_changed
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|STm-&gt;defaults_for_writes
)paren
op_logical_and
(paren
id|i
op_assign
id|set_mode_densblk
c_func
(paren
id|inode
comma
id|STp
comma
id|STm
)paren
)paren
OL
l_int|0
)paren
(brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_decrement
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;default_drvbuffer
op_ne
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTSETDRVBUFFER
comma
id|STp-&gt;default_drvbuffer
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Can&squot;t set default drive buffering to %d.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;default_drvbuffer
)paren
suffix:semicolon
)brace
)brace
id|STp-&gt;in_use
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Close the device*/
r_static
r_void
DECL|function|scsi_tape_close
id|scsi_tape_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|result
suffix:semicolon
r_static
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|kdev_t
id|devt
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
r_int
id|dev
suffix:semicolon
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|devt
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
id|update_partition
c_func
(paren
id|inode
)paren
OL
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: update_partition at close failed.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
dot
id|rw
op_eq
id|ST_WRITING
op_logical_and
op_logical_neg
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
)paren
(brace
id|result
op_assign
id|flush_write_buffer
c_func
(paren
id|STp
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: File length %ld bytes.&bslash;n&quot;
comma
id|dev
comma
(paren
r_int
)paren
(paren
id|filp-&gt;f_pos
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Async write waits %d, finished %d.&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;nbr_waits
comma
id|STp-&gt;nbr_finished
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|result
op_eq
l_int|0
op_logical_or
id|result
op_eq
(paren
op_minus
id|ENOSPC
)paren
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
op_plus
id|STp-&gt;two_fm
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|ST_TIMEOUT
comma
id|MAX_WRITE_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_goto
id|out
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
op_logical_and
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_ne
l_int|0x70
op_logical_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x4f
)paren
op_ne
l_int|0x40
op_logical_or
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
)paren
op_eq
l_int|0
)paren
)paren
)paren
multiline_comment|/* Filter out successful write at EOM */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Error on write filemark.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_increment
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;two_fm
)paren
id|back_over_eof
c_func
(paren
id|STp
)paren
suffix:semicolon
)brace
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Buffer flushed, %d EOF(s) written&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;rew_at_close
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;can_bsr
)paren
id|flush_buffer
c_func
(paren
id|inode
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|STp-&gt;eof
op_eq
id|ST_FM
)paren
op_logical_and
op_logical_neg
id|STp-&gt;eof_hit
)paren
id|back_over_eof
c_func
(paren
id|STp
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;rew_at_close
)paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTREW
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_eq
id|ST_LOCKED_AUTO
)paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTUNLOCK
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;buffer
op_ne
l_int|NULL
)paren
(brace
id|normalize_buffer
c_func
(paren
id|STp-&gt;buffer
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|in_use
op_assign
l_int|0
suffix:semicolon
)brace
id|STp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
(paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;host-&gt;hostt-&gt;usage_count
)paren
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|st_template.usage_count
)paren
(brace
(paren
op_star
id|st_template.usage_count
)paren
op_decrement
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Write command */
r_static
r_int
DECL|function|st_write
id|st_write
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|total
comma
id|do_count
comma
id|blks
comma
id|retval
comma
id|transfer
suffix:semicolon
r_int
id|write_threshold
suffix:semicolon
r_int
id|doing_write
op_assign
l_int|0
suffix:semicolon
r_static
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
r_const
r_char
op_star
id|b_point
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/*&n;     * If there was a bus reset, block further access&n;     * to this device.&n;     */
r_if
c_cond
(paren
id|STp-&gt;device-&gt;was_reset
)paren
(brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|retval
op_assign
id|update_partition
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
id|count
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_logical_and
op_logical_neg
id|enlarge_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|count
comma
id|STp-&gt;restr_dma
)paren
)paren
r_return
(paren
op_minus
id|EOVERFLOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;do_auto_lock
op_logical_and
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
op_logical_and
op_logical_neg
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_READING
)paren
(brace
id|retval
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_WRITING
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;rw
op_ne
id|ST_WRITING
op_logical_and
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_eq
l_int|0
op_logical_and
id|STp-&gt;drv_block
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|set_mode_densblk
c_func
(paren
id|inode
comma
id|STp
comma
id|STm
)paren
)paren
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|STm-&gt;default_compression
op_ne
id|ST_DONT_TOUCH
op_logical_and
op_logical_neg
(paren
id|STp-&gt;compression_changed
)paren
)paren
(brace
r_if
c_cond
(paren
id|st_compression
c_func
(paren
id|STp
comma
(paren
id|STm-&gt;default_compression
op_eq
id|ST_YES
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Can&squot;t set default compression.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modes_defined
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|STps-&gt;moves_after_eof
OL
l_int|255
)paren
id|STps-&gt;moves_after_eof
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
)paren
(brace
id|write_behind_check
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Async write error (write) %x.&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result
op_eq
id|INT_MAX
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
multiline_comment|/* All has been written */
id|STp-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
)brace
r_else
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STp-&gt;eof
op_eq
id|ST_EOM_OK
)paren
r_return
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;eof
op_eq
id|ST_EOM_ERROR
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;do_buffer_writes
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Write must be integral number of blocks */
id|write_threshold
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|write_threshold
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_star
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;do_async_writes
)paren
id|write_threshold
op_decrement
suffix:semicolon
id|total
op_assign
id|count
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_WRITING
suffix:semicolon
id|b_point
op_assign
id|buf
suffix:semicolon
r_while
c_loop
(paren
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
op_logical_neg
id|STm-&gt;do_async_writes
op_logical_and
id|count
OG
l_int|0
)paren
op_logical_or
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
id|count
OG
id|write_threshold
)paren
)paren
(brace
id|doing_write
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|do_count
op_assign
id|count
suffix:semicolon
r_else
(brace
id|do_count
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_star
id|STp-&gt;block_size
op_minus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:semicolon
r_if
c_cond
(paren
id|do_count
OG
id|count
)paren
id|do_count
op_assign
id|count
suffix:semicolon
)brace
id|memcpy_fromfs
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
comma
id|b_point
comma
id|do_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|blks
op_assign
id|transfer
op_assign
id|do_count
suffix:semicolon
r_else
(brace
id|blks
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
id|do_count
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
id|transfer
op_assign
id|blks
op_star
id|STp-&gt;block_size
suffix:semicolon
)brace
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|ST_TIMEOUT
comma
id|MAX_WRITE_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Error on write:&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|transfer
op_assign
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|VOLUME_OVERFLOW
)paren
id|transfer
op_assign
id|do_count
suffix:semicolon
r_else
id|transfer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
id|transfer
op_mul_assign
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
id|transfer
op_le
id|do_count
)paren
(brace
id|filp-&gt;f_pos
op_add_assign
id|do_count
op_minus
id|transfer
suffix:semicolon
id|count
op_sub_assign
id|do_count
op_minus
id|transfer
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
id|transfer
OL
id|do_count
)paren
id|STp-&gt;drv_block
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
id|STp-&gt;drv_block
op_add_assign
(paren
id|do_count
op_minus
id|transfer
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|STp-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
multiline_comment|/* EOM within current request */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: EOM with %d bytes unwritten.&bslash;n&quot;
comma
id|dev
comma
id|transfer
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|STp-&gt;eof
op_assign
id|ST_EOM_ERROR
suffix:semicolon
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Too cautious? */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* EOM for old data */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: EOM with lost data.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Too cautious? */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|total
)paren
r_return
id|total
op_minus
id|count
suffix:semicolon
r_else
r_return
id|retval
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_add_assign
id|do_count
suffix:semicolon
id|b_point
op_add_assign
id|do_count
suffix:semicolon
id|count
op_sub_assign
id|do_count
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STp-&gt;drv_block
op_increment
suffix:semicolon
r_else
id|STp-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
)brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ne
l_int|0
)paren
(brace
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
comma
id|b_point
comma
id|count
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_add_assign
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|doing_write
op_logical_and
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STm-&gt;do_async_writes
op_logical_and
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_ge
id|STp-&gt;write_threshold
op_logical_or
id|STp-&gt;block_size
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* Schedule an asynchronous write */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|STp-&gt;device
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_div
id|STp-&gt;block_size
)paren
op_star
id|STp-&gt;block_size
suffix:semicolon
id|STp-&gt;dirty
op_assign
op_logical_neg
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_eq
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|blks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
suffix:semicolon
r_else
id|blks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_div
id|STp-&gt;block_size
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|STp-&gt;sem
op_assign
id|MUTEX_LOCKED
suffix:semicolon
id|SCpnt-&gt;request.sem
op_assign
op_amp
(paren
id|STp-&gt;sem
)paren
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|SCpnt-&gt;request.rq_dev
op_assign
id|STp-&gt;devt
suffix:semicolon
macro_line|#if DEBUG
id|STp-&gt;write_pending
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|scsi_do_cmd
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_WRITE_RETRIES
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt
op_ne
l_int|NULL
)paren
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
id|STps-&gt;at_sm
op_and_assign
(paren
id|total
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|total
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Read command */
r_static
r_int
DECL|function|st_read
id|st_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|total
suffix:semicolon
r_int
id|transfer
comma
id|blks
comma
id|bytes
suffix:semicolon
r_static
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|total
op_assign
id|update_partition
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
r_return
id|total
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
id|count
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_logical_and
op_logical_neg
id|enlarge_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|count
comma
id|STp-&gt;restr_dma
)paren
)paren
r_return
(paren
op_minus
id|EOVERFLOW
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|STm-&gt;do_read_ahead
)paren
op_logical_and
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Read must be integral number of blocks */
r_if
c_cond
(paren
id|STp-&gt;do_auto_lock
op_logical_and
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
op_logical_and
op_logical_neg
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
(brace
id|transfer
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transfer
)paren
r_return
id|transfer
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_READING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STps-&gt;moves_after_eof
OL
l_int|255
)paren
id|STps-&gt;moves_after_eof
op_increment
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
id|STp-&gt;eof
op_ne
id|ST_NOEOF
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: EOF flag up. Bytes %d&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_eq
l_int|0
)paren
op_logical_and
(paren
id|STp-&gt;eof
op_eq
id|ST_EOM_OK
op_logical_or
id|STp-&gt;eof
op_eq
id|ST_EOD
)paren
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* EOM or Blank Check */
id|STps-&gt;rw
op_assign
id|ST_READING
suffix:semicolon
r_for
c_loop
(paren
id|total
op_assign
l_int|0
suffix:semicolon
id|total
OL
id|count
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_eq
l_int|0
op_logical_and
id|STp-&gt;eof
op_eq
id|ST_NOEOF
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|blks
op_assign
id|bytes
op_assign
id|count
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|STm-&gt;do_read_ahead
)paren
(brace
id|blks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
suffix:semicolon
id|bytes
op_assign
id|blks
op_star
id|STp-&gt;block_size
suffix:semicolon
)brace
r_else
(brace
id|bytes
op_assign
id|count
op_minus
id|total
suffix:semicolon
r_if
c_cond
(paren
id|bytes
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
)paren
id|bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
suffix:semicolon
id|blks
op_assign
id|bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
id|bytes
op_assign
id|blks
op_star
id|STp-&gt;block_size
suffix:semicolon
)brace
)brace
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
id|bytes
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Sense: %2x %2x %2x %2x %2x %2x %2x %2x&bslash;n&quot;
comma
id|dev
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|1
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|7
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
)paren
(brace
multiline_comment|/* extended sense */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|BLANK_CHECK
)paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_and_assign
l_int|0xcf
suffix:semicolon
multiline_comment|/* No need for EOM in this case */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xe0
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* EOF, EOM, or ILI */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|transfer
op_assign
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
r_else
id|transfer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|MEDIUM_ERROR
)paren
id|transfer
op_assign
id|bytes
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x20
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|transfer
op_le
l_int|0
)paren
id|transfer
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
id|transfer
op_eq
id|blks
)paren
(brace
multiline_comment|/* We did not get anything, signal error */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;st%d: Incorrect block size.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
id|STp-&gt;drv_block
op_add_assign
id|blks
op_minus
id|transfer
op_plus
l_int|1
suffix:semicolon
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTBSR
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* We have some data, deliver it */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
(paren
id|blks
op_minus
id|transfer
)paren
op_star
id|STp-&gt;block_size
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: ILI but enough data received %d %d.&bslash;n&quot;
comma
id|dev
comma
id|count
op_minus
id|total
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|count
op_minus
id|total
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
id|count
op_assign
id|total
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
id|STp-&gt;drv_block
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTBSR
comma
l_int|1
)paren
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* FM overrides EOM */
id|STp-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
op_star
id|STp-&gt;block_size
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: EOF detected (%d bytes read, transferred %d bytes).&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
comma
id|total
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
(brace
id|STp-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
op_star
id|STp-&gt;block_size
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: EOM detected (%d bytes read).&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/* end of EOF, EOM, ILI test */
r_else
(brace
multiline_comment|/* nonzero sense key */
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Tape error while reading.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|total
)paren
r_return
id|total
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;moves_after_eof
op_eq
l_int|1
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|BLANK_CHECK
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Zero returned for first BLANK CHECK after EOF.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|STp-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* First BLANK_CHECK after EOF */
)brace
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* End of extended sense test */
r_else
(brace
id|transfer
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|transfer
suffix:semicolon
)brace
)brace
multiline_comment|/* End of error handling */
r_else
multiline_comment|/* Read successful */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
id|bytes
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STp-&gt;drv_block
op_increment
suffix:semicolon
r_else
id|STp-&gt;drv_block
op_add_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
)brace
multiline_comment|/* if ((STp-&gt;buffer)-&gt;buffer_bytes == 0 &amp;&amp;&n;&t;   STp-&gt;eof == ST_NOEOF) */
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
OG
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
id|STp-&gt;eof
op_ne
id|ST_NOEOF
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: EOF up. Left %d, needed %d.&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
comma
id|count
op_minus
id|total
)paren
suffix:semicolon
macro_line|#endif
id|transfer
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
OL
id|count
op_minus
id|total
ques
c_cond
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:colon
id|count
op_minus
id|total
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|buf
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
comma
id|transfer
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|transfer
suffix:semicolon
id|buf
op_add_assign
id|transfer
suffix:semicolon
id|total
op_add_assign
id|transfer
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_sub_assign
id|transfer
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_add_assign
id|transfer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STp-&gt;eof
op_ne
id|ST_NOEOF
)paren
(brace
id|STp-&gt;eof_hit
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_ne
l_int|NULL
)paren
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
id|total
op_eq
l_int|0
op_logical_and
id|STp-&gt;eof
op_eq
id|ST_FM
)paren
(brace
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;moves_after_eof
OG
l_int|1
)paren
id|STps-&gt;moves_after_eof
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|total
op_eq
l_int|0
op_logical_and
id|STp-&gt;eof
op_eq
id|ST_EOM_OK
)paren
r_return
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
multiline_comment|/* ST_EOM_ERROR not used in read */
r_return
id|total
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|count
op_assign
id|total
suffix:semicolon
multiline_comment|/* Read only one variable length block */
)brace
multiline_comment|/* for (total = 0; total &lt; count; ) */
r_if
c_cond
(paren
id|SCpnt
op_ne
l_int|NULL
)paren
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|total
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Set the driver options */
r_static
r_void
DECL|function|st_log_options
id|st_log_options
c_func
(paren
id|Scsi_Tape
op_star
id|STp
comma
id|ST_mode
op_star
id|STm
comma
r_int
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Mode %d options: buffer writes: %d, async writes: %d, read ahead: %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;current_mode
comma
id|STm-&gt;do_buffer_writes
comma
id|STm-&gt;do_async_writes
comma
id|STm-&gt;do_read_ahead
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d:    can bsr: %d, two FMs: %d, fast mteom: %d, auto lock: %d,&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;can_bsr
comma
id|STp-&gt;two_fm
comma
id|STp-&gt;fast_mteom
comma
id|STp-&gt;do_auto_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d:    defs for wr: %d, no block limits: %d, partitions: %d, s2 log: %d&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;defaults_for_writes
comma
id|STp-&gt;omit_blklims
comma
id|STp-&gt;can_partitions
comma
id|STp-&gt;scsi2_logical
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d:    debugging: %d&bslash;n&quot;
comma
id|dev
comma
id|debugging
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|st_set_options
id|st_set_options
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|options
)paren
(brace
r_int
id|value
suffix:semicolon
r_int
id|code
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|memcpy
c_func
(paren
id|STm
comma
op_amp
(paren
id|STp-&gt;modes
(braket
l_int|0
)braket
)paren
comma
r_sizeof
(paren
id|ST_mode
)paren
)paren
suffix:semicolon
id|modes_defined
op_assign
id|TRUE
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Initialized mode %d definition from mode 0&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;current_mode
)paren
suffix:semicolon
macro_line|#endif
)brace
id|code
op_assign
id|options
op_amp
id|MT_ST_OPTIONS
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_BOOLEANS
)paren
(brace
id|STm-&gt;do_buffer_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_BUFFER_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;do_async_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_ASYNC_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;defaults_for_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_DEF_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;do_read_ahead
op_assign
(paren
id|options
op_amp
id|MT_ST_READ_AHEAD
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;two_fm
op_assign
(paren
id|options
op_amp
id|MT_ST_TWO_FM
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;fast_mteom
op_assign
(paren
id|options
op_amp
id|MT_ST_FAST_MTEOM
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;do_auto_lock
op_assign
(paren
id|options
op_amp
id|MT_ST_AUTO_LOCK
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;can_bsr
op_assign
(paren
id|options
op_amp
id|MT_ST_CAN_BSR
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;omit_blklims
op_assign
(paren
id|options
op_amp
id|MT_ST_NO_BLKLIMS
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
)paren
id|STp-&gt;can_partitions
op_assign
(paren
id|options
op_amp
id|MT_ST_CAN_PARTITIONS
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;scsi2_logical
op_assign
(paren
id|options
op_amp
id|MT_ST_SCSI2LOGICAL
)paren
op_ne
l_int|0
suffix:semicolon
macro_line|#if DEBUG
id|debugging
op_assign
(paren
id|options
op_amp
id|MT_ST_DEBUGGING
)paren
op_ne
l_int|0
suffix:semicolon
macro_line|#endif
id|st_log_options
c_func
(paren
id|STp
comma
id|STm
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_SETBOOLEANS
op_logical_or
id|code
op_eq
id|MT_ST_CLEARBOOLEANS
)paren
(brace
id|value
op_assign
(paren
id|code
op_eq
id|MT_ST_SETBOOLEANS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_BUFFER_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_buffer_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_ASYNC_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_async_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_DEF_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;defaults_for_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_READ_AHEAD
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_read_ahead
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_TWO_FM
)paren
op_ne
l_int|0
)paren
id|STp-&gt;two_fm
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_FAST_MTEOM
)paren
op_ne
l_int|0
)paren
id|STp-&gt;fast_mteom
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_AUTO_LOCK
)paren
op_ne
l_int|0
)paren
id|STp-&gt;do_auto_lock
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_CAN_BSR
)paren
op_ne
l_int|0
)paren
id|STp-&gt;can_bsr
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_NO_BLKLIMS
)paren
op_ne
l_int|0
)paren
id|STp-&gt;omit_blklims
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
id|options
op_amp
id|MT_ST_CAN_PARTITIONS
)paren
op_ne
l_int|0
)paren
id|STp-&gt;can_partitions
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_SCSI2LOGICAL
)paren
op_ne
l_int|0
)paren
id|STp-&gt;scsi2_logical
op_assign
id|value
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_DEBUGGING
)paren
op_ne
l_int|0
)paren
id|debugging
op_assign
id|value
suffix:semicolon
macro_line|#endif
id|st_log_options
c_func
(paren
id|STp
comma
id|STm
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_WRITE_THRESHOLD
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
op_star
id|ST_BLOCK_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|value
template_param
id|st_buffer_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Write threshold %d too small or too large.&bslash;n&quot;
comma
id|dev
comma
id|value
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;write_threshold
op_assign
id|value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Write threshold set to %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_BLKSIZE
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
op_complement
id|MT_ST_OPTIONS
)paren
(brace
id|STm-&gt;default_blksize
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Default block size disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_blksize
op_assign
id|value
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Default block size set to %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;default_blksize
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_OPTIONS
)paren
(brace
id|code
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_CLEAR_DEFAULT
)paren
suffix:semicolon
id|value
op_assign
(paren
id|options
op_amp
id|MT_ST_CLEAR_DEFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_DENSITY
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STm-&gt;default_density
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Density default disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_density
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Density default set to %x&bslash;n&quot;
comma
id|dev
comma
id|STm-&gt;default_density
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_DRVBUFFER
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STp-&gt;default_drvbuffer
op_assign
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Drive buffer default disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;default_drvbuffer
op_assign
id|value
op_amp
l_int|7
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Drive buffer default set to %x&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;default_drvbuffer
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_COMPRESSION
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STm-&gt;default_compression
op_assign
id|ST_DONT_TOUCH
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Compression default disabled.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_compression
op_assign
(paren
id|value
op_amp
l_int|1
ques
c_cond
id|ST_YES
suffix:colon
id|ST_NO
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Compression default set to %x&bslash;n&quot;
comma
id|dev
comma
(paren
id|value
op_amp
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
DECL|macro|COMPRESSION_PAGE
mdefine_line|#define COMPRESSION_PAGE        0x0f
DECL|macro|COMPRESSION_PAGE_LENGTH
mdefine_line|#define COMPRESSION_PAGE_LENGTH 16
DECL|macro|MODE_HEADER_LENGTH
mdefine_line|#define MODE_HEADER_LENGTH  4
DECL|macro|DCE_MASK
mdefine_line|#define DCE_MASK  0x80
DECL|macro|DCC_MASK
mdefine_line|#define DCC_MASK  0x40
DECL|macro|RED_MASK
mdefine_line|#define RED_MASK  0x60
multiline_comment|/* Control the compression with mode page 15. Algorithm not changed if zero. */
r_static
r_int
DECL|function|st_compression
id|st_compression
c_func
(paren
id|Scsi_Tape
op_star
id|STp
comma
r_int
id|state
)paren
(brace
r_int
id|dev
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Read the current page contents */
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|COMPRESSION_PAGE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|COMPRESSION_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|ST_TIMEOUT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|SCpnt-&gt;request.rq_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Compression mode page not supported.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Compression state is %d.&bslash;n&quot;
comma
id|dev
comma
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_amp
id|DCE_MASK
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check if compression can be changed */
r_if
c_cond
(paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_amp
id|DCC_MASK
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Compression not supported.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* Do the change */
r_if
c_cond
(paren
id|state
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_or_assign
id|DCE_MASK
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|2
)braket
op_and_assign
op_complement
id|DCE_MASK
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|COMPRESSION_PAGE_LENGTH
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved data length */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved media type byte */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
)braket
op_and_assign
l_int|0x3f
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|ST_TIMEOUT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Compression change failed.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Compression state changed to %d.&bslash;n&quot;
comma
id|dev
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
id|STp-&gt;compression_changed
op_assign
id|TRUE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Internal ioctl function */
r_static
r_int
DECL|function|st_int_ioctl
id|st_int_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|timeout
op_assign
id|ST_LONG_TIMEOUT
suffix:semicolon
r_int
id|ltmp
suffix:semicolon
r_int
id|i
comma
id|ioctl_result
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|fileno
comma
id|blkno
comma
id|at_sm
comma
id|undone
comma
id|datalen
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
op_logical_and
id|cmd_in
op_ne
id|MTLOAD
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|fileno
op_assign
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
suffix:semicolon
id|blkno
op_assign
id|STp-&gt;drv_block
suffix:semicolon
id|at_sm
op_assign
id|STps-&gt;at_sm
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|datalen
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|MTFSF
suffix:colon
r_case
id|MTFSFM
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing tape forward over %d filemarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSF
suffix:colon
r_case
id|MTBSFM
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|ltmp
op_assign
l_int|0xff000000
suffix:semicolon
id|ltmp
op_assign
id|ltmp
op_or
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing tape backward over %ld filemarks.&bslash;n&quot;
comma
id|dev
comma
(paren
op_minus
id|ltmp
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_sub_assign
id|arg
suffix:semicolon
id|blkno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We can&squot;t know the block number */
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Space Blocks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing tape forward %d blocks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_add_assign
id|arg
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Space Blocks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|ltmp
op_assign
l_int|0xff000000
suffix:semicolon
id|ltmp
op_assign
id|ltmp
op_or
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing tape backward %ld blocks.&bslash;n&quot;
comma
id|dev
comma
(paren
op_minus
id|ltmp
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_sub_assign
id|arg
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSS
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Space Setmarks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing tape forward %d setmarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
)paren
(brace
id|blkno
op_assign
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|at_sm
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTBSS
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Space Setmarks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|ltmp
op_assign
l_int|0xff000000
suffix:semicolon
id|ltmp
op_assign
id|ltmp
op_or
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing tape backward %ld setmarks.&bslash;n&quot;
comma
id|dev
comma
(paren
op_minus
id|ltmp
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
)paren
(brace
id|blkno
op_assign
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|at_sm
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
r_case
id|MTWSM
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWSM
)paren
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWEOF
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Writing %d filemarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Writing %d setmarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_assign
(paren
id|cmd_in
op_eq
id|MTWSM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|REZERO_UNIT
suffix:semicolon
macro_line|#if ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Rewinding tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
r_case
id|MTLOAD
suffix:colon
r_case
id|MTUNLOAD
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOAD
)paren
id|cmd
(braket
l_int|4
)braket
op_or_assign
l_int|1
suffix:semicolon
macro_line|#if ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#else
id|timeout
op_assign
id|ST_LONG_TIMEOUT
op_star
l_int|8
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_ne
id|MTLOAD
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Unloading tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Loading tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: No op on tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Should do something ? */
r_break
suffix:semicolon
r_case
id|MTRETEN
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
macro_line|#if ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Retensioning tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;fast_mteom
)paren
(brace
multiline_comment|/* space to the end of tape */
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTFSF
comma
l_int|0x3fff
)paren
suffix:semicolon
id|fileno
op_assign
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;eof
op_eq
id|ST_EOD
op_logical_or
id|STp-&gt;eof
op_eq
id|ST_EOM_OK
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* The next lines would hide the number of spaced FileMarks&n;&t;    That&squot;s why I inserted the previous lines. I had no luck&n;&t;    with detecting EOM with FSF, so we go now to EOM.&n;&t;    Joerg Weule */
)brace
r_else
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Spacing to end of recorded medium.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ERASE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To the end of tape */
macro_line|#if ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_or_assign
l_int|2
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#else
id|timeout
op_assign
id|ST_LONG_TIMEOUT
op_star
l_int|8
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Erasing tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOCK
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ALLOW_MEDIUM_REMOVAL
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|SCSI_REMOVAL_PREVENT
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Locking drive door.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif;
r_break
suffix:semicolon
r_case
id|MTUNLOCK
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ALLOW_MEDIUM_REMOVAL
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|SCSI_REMOVAL_ALLOW
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Unlocking drive door.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif;
r_break
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
multiline_comment|/* Set block length */
r_case
id|MTSETDENSITY
suffix:colon
multiline_comment|/* Set tape density */
r_case
id|MTSETDRVBUFFER
suffix:colon
multiline_comment|/* Set drive buffering */
r_case
id|SET_DENS_AND_BLK
suffix:colon
multiline_comment|/* Set density and block size */
r_if
c_cond
(paren
id|STp-&gt;dirty
op_logical_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Not allowed if data in buffer */
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
op_logical_and
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
op_ne
l_int|0
op_logical_and
(paren
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
template_param
id|STp-&gt;max_block
op_logical_or
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
OG
id|st_buffer_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: Illegal block size.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|datalen
op_assign
l_int|12
suffix:semicolon
id|memset
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDRVBUFFER
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_amp
l_int|7
)paren
op_lshift
l_int|4
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_assign
id|STp-&gt;drv_buffer
op_lshift
l_int|4
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* block descriptor length */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDENSITY
)paren
(brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|STp-&gt;density_changed
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* At least we tried ;-) */
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_assign
id|arg
op_rshift
l_int|24
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_assign
id|STp-&gt;density
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(brace
id|ltmp
op_assign
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
)paren
id|STp-&gt;blksize_changed
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* At least we tried ;-) */
)brace
r_else
id|ltmp
op_assign
id|STp-&gt;block_size
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
op_assign
id|ltmp
suffix:semicolon
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Setting block size to %d bytes.&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDENSITY
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Setting density code to %x.&bslash;n&quot;
comma
id|dev
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDRVBUFFER
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Setting drive buffer code to %d.&bslash;n&quot;
comma
id|dev
comma
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|7
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
)brace
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
id|datalen
comma
id|timeout
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|ioctl_result
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSF
)paren
id|STps-&gt;moves_after_eof
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_ne
id|MTLOAD
op_logical_and
id|cmd_in
op_ne
id|MTLOCK
op_logical_and
id|cmd_in
op_ne
id|MTUNLOCK
op_logical_and
id|cmd_in
op_ne
id|MTSETBLK
op_logical_and
id|cmd_in
op_ne
id|MTSETDENSITY
op_logical_and
id|cmd_in
op_ne
id|MTSETDRVBUFFER
)paren
id|STps-&gt;moves_after_eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioctl_result
)paren
(brace
multiline_comment|/* SCSI command successful */
id|STp-&gt;drv_block
op_assign
id|blkno
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|fileno
suffix:semicolon
id|STps-&gt;at_sm
op_assign
id|at_sm
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOCK
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_EXPLICIT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTUNLOCK
)paren
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSFM
)paren
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTFSF
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSFM
)paren
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTBSF
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(brace
id|STp-&gt;block_size
op_assign
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_div
id|STp-&gt;block_size
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDRVBUFFER
)paren
id|STp-&gt;drv_buffer
op_assign
(paren
id|arg
op_amp
l_int|7
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDENSITY
)paren
id|STp-&gt;density
op_assign
id|arg
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTEOM
)paren
(brace
id|STp-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_ne
id|MTSETBLK
op_logical_and
id|cmd_in
op_ne
id|MTNOP
)paren
(brace
id|STp-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
id|STp-&gt;density
op_assign
id|arg
op_rshift
id|MT_ST_DENSITY_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTOFFL
op_logical_or
id|cmd_in
op_eq
id|MTUNLOAD
)paren
id|STp-&gt;rew_at_close
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOAD
)paren
(brace
id|STp-&gt;rew_at_close
op_assign
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|moves_after_eof
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|last_block_valid
op_assign
id|FALSE
suffix:semicolon
)brace
id|STp-&gt;partition
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* SCSI command was not completely successful */
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_ne
id|MTBSF
op_logical_and
id|cmd_in
op_ne
id|MTBSFM
op_logical_and
id|cmd_in
op_ne
id|MTBSR
op_logical_and
id|cmd_in
op_ne
id|MTBSS
)paren
id|STp-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
id|STp-&gt;eof_hit
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
id|undone
op_assign
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_plus
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWEOF
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x4f
)paren
op_eq
l_int|0x40
op_logical_and
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
op_logical_or
id|undone
op_eq
l_int|0
)paren
)paren
(brace
id|ioctl_result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EOF written succesfully at EOM */
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_increment
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|fileno
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTFSF
)paren
op_logical_or
(paren
id|cmd_in
op_eq
id|MTFSFM
)paren
)paren
(brace
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|fileno
op_minus
id|undone
suffix:semicolon
r_else
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|fileno
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTBSF
)paren
op_logical_or
(paren
id|cmd_in
op_eq
id|MTBSFM
)paren
)paren
(brace
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
id|fileno
op_plus
id|undone
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSR
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* Hit filemark */
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_increment
suffix:semicolon
id|STp-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|blkno
op_ge
id|undone
)paren
id|STp-&gt;drv_block
op_assign
id|blkno
op_minus
id|undone
suffix:semicolon
r_else
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSR
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* Hit filemark */
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_decrement
suffix:semicolon
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|STp-&gt;drv_block
op_assign
id|blkno
op_plus
id|undone
suffix:semicolon
r_else
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTEOM
)paren
(brace
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STp-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;eof
op_eq
id|ST_NOEOF
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|BLANK_CHECK
)paren
id|STp-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTLOCK
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCK_FAILS
suffix:semicolon
)brace
r_return
id|ioctl_result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Get the tape position. If bt == 2, arg points into a kernel space mt_loc&n;    structure. */
r_static
r_int
DECL|function|get_location
id|get_location
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
op_star
id|block
comma
r_int
op_star
id|partition
comma
r_int
id|logical
)paren
(brace
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
id|scmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|memset
(paren
id|scmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
OL
id|SCSI_2
)paren
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|QFA_REQUEST_BLOCK
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|READ_POSITION
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|logical
op_logical_and
op_logical_neg
id|STp-&gt;scsi2_logical
)paren
id|scmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
)brace
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|scmd
comma
l_int|20
comma
id|ST_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
op_logical_or
(paren
id|STp-&gt;device-&gt;scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_amp
l_int|4
)paren
op_ne
l_int|0
)paren
)paren
(brace
op_star
id|block
op_assign
op_star
id|partition
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Can&squot;t read tape position.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
OL
id|SCSI_2
)paren
(brace
op_star
id|block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
suffix:semicolon
op_star
id|partition
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|7
)braket
suffix:semicolon
op_star
id|partition
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_logical_and
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
multiline_comment|/* BOP of partition 0 */
id|STp-&gt;drv_block
op_assign
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Got tape pos. blk %d part %d.&bslash;n&quot;
comma
id|dev
comma
op_star
id|block
comma
op_star
id|partition
)paren
suffix:semicolon
macro_line|#endif
)brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Set the tape block and partition. Negative partition means that only the&n;   block should be set in vendor specific way. */
r_static
r_int
DECL|function|set_location
id|set_location
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|block
comma
r_int
id|partition
comma
r_int
id|logical
)paren
(brace
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|result
comma
id|p
suffix:semicolon
r_int
r_int
id|blk
suffix:semicolon
r_int
id|timeout
op_assign
id|ST_LONG_TIMEOUT
suffix:semicolon
r_int
r_char
id|scmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Setting block to %d and partition to %d.&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|partition
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partition
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Update the location at the partition we are leaving */
r_if
c_cond
(paren
(paren
op_logical_neg
id|STp-&gt;can_partitions
op_logical_and
id|partition
op_ne
l_int|0
)paren
op_logical_or
id|partition
op_ge
id|ST_NBR_PARTITIONS
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partition
op_ne
id|STp-&gt;partition
)paren
(brace
r_if
c_cond
(paren
id|get_location
c_func
(paren
id|inode
comma
op_amp
id|blk
comma
op_amp
id|p
comma
l_int|1
)paren
)paren
id|STps-&gt;last_block_valid
op_assign
id|FALSE
suffix:semicolon
r_else
(brace
id|STps-&gt;last_block_valid
op_assign
id|TRUE
suffix:semicolon
id|STps-&gt;last_block_visited
op_assign
id|blk
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Visited block %d for partition %d saved.&bslash;n&quot;
comma
id|dev
comma
id|blk
comma
id|STp-&gt;partition
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|memset
(paren
id|scmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
OL
id|SCSI_2
)paren
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|QFA_SEEK_BLOCK
suffix:semicolon
id|scmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
suffix:semicolon
id|scmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
id|block
suffix:semicolon
id|scmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|SEEK_10
suffix:semicolon
id|scmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|24
)paren
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
suffix:semicolon
id|scmd
(braket
l_int|5
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
suffix:semicolon
id|scmd
(braket
l_int|6
)braket
op_assign
id|block
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|logical
op_logical_and
op_logical_neg
id|STp-&gt;scsi2_logical
)paren
id|scmd
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;partition
op_ne
id|partition
)paren
(brace
id|scmd
(braket
l_int|1
)braket
op_or_assign
l_int|2
suffix:semicolon
id|scmd
(braket
l_int|8
)braket
op_assign
id|partition
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Trying to change partition from %d to %d&bslash;n&quot;
comma
id|dev
comma
id|STp-&gt;partition
comma
id|partition
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#if ST_NOWAIT
id|scmd
(braket
l_int|1
)braket
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|scmd
comma
l_int|20
comma
id|timeout
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|STp-&gt;drv_block
op_assign
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
id|p
op_assign
id|find_partition
c_func
(paren
id|inode
)paren
)paren
op_ge
l_int|0
)paren
id|STp-&gt;partition
op_assign
id|p
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
(brace
id|STp-&gt;partition
op_assign
id|partition
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STps-&gt;last_block_valid
op_logical_or
id|STps-&gt;last_block_visited
op_ne
id|block
)paren
(brace
id|STps-&gt;moves_after_eof
op_assign
l_int|1
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
)brace
r_else
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|block
op_eq
l_int|0
)paren
id|STp-&gt;drv_block
op_assign
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Find the current partition number for the drive status. Called from open and&n;   returns either partition number of negative error code. */
r_static
r_int
DECL|function|find_partition
id|find_partition
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|i
comma
id|partition
suffix:semicolon
r_int
r_int
id|block
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|get_location
c_func
(paren
id|inode
comma
op_amp
id|block
comma
op_amp
id|partition
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|partition
op_ge
id|ST_NBR_PARTITIONS
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
id|partition
suffix:semicolon
)brace
multiline_comment|/* Change the partition if necessary */
r_static
r_int
DECL|function|update_partition
id|update_partition
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;partition
op_eq
id|STp-&gt;new_partition
)paren
r_return
l_int|0
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;new_partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STps-&gt;last_block_valid
)paren
id|STps-&gt;last_block_visited
op_assign
l_int|0
suffix:semicolon
r_return
id|set_location
c_func
(paren
id|inode
comma
id|STps-&gt;last_block_visited
comma
id|STp-&gt;new_partition
comma
l_int|1
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Functions for reading and writing the medium partition mode page. These&n;   seem to work with Wangtek 6200HS and HP C1533A. */
DECL|macro|PART_PAGE
mdefine_line|#define PART_PAGE   0x11
DECL|macro|PART_PAGE_LENGTH
mdefine_line|#define PART_PAGE_LENGTH 10
multiline_comment|/* Get the number of partitions on the tape. As a side effect reads the&n;   mode page into the tape buffer. */
r_static
r_int
DECL|function|nbr_partitions
id|nbr_partitions
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|result
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Page format */
id|cmd
(braket
l_int|2
)braket
op_assign
id|PART_PAGE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|200
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
l_int|200
comma
id|ST_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Can&squot;t read medium partition page.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_plus
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Number of partitions %d.&bslash;n&quot;
comma
id|dev
comma
id|result
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Partition the tape into two partitions if size &gt; 0 or one partition if&n;   size == 0 */
r_static
r_int
DECL|function|partition_tape
id|partition_tape
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|size
)paren
(brace
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|result
suffix:semicolon
r_int
id|length
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
comma
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|nbr_partitions
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
multiline_comment|/* The mode page is in the buffer. Let&squot;s modify it and write it. */
id|bp
op_assign
op_amp
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
(brace
id|length
op_assign
l_int|8
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Formatting tape with one partition.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|length
op_assign
l_int|10
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|8
)braket
op_assign
(paren
id|size
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|9
)braket
op_assign
id|size
op_amp
l_int|0xff
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Formatting tape with two partition (1 = %d MB).&bslash;n&quot;
comma
id|dev
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
)brace
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|4
)braket
op_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* IDP | PSUM = MB */
id|bp
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
)braket
op_and_assign
l_int|0x3f
suffix:semicolon
id|bp
(braket
id|MODE_HEADER_LENGTH
op_plus
l_int|1
)braket
op_assign
id|length
op_minus
l_int|2
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|length
op_plus
id|MODE_HEADER_LENGTH
suffix:semicolon
id|SCpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SCpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|ST_LONG_TIMEOUT
comma
id|MAX_READY_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|SCpnt-&gt;request.rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_result_fatal
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st%d: Partitioning of tape failed.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
id|result
op_assign
l_int|0
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* The ioctl command */
r_static
r_int
DECL|function|st_ioctl
id|st_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
comma
id|cmd_nr
comma
id|cmd_type
comma
id|bt
suffix:semicolon
r_int
r_int
id|blk
suffix:semicolon
r_struct
id|mtop
id|mtc
suffix:semicolon
r_struct
id|mtpos
id|mt_pos
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|dev
)braket
)paren
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
op_logical_and
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|cmd_type
op_assign
id|_IOC_TYPE
c_func
(paren
id|cmd_in
)paren
suffix:semicolon
id|cmd_nr
op_assign
id|_IOC_NR
c_func
(paren
id|cmd_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCTOP
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCTOP
)paren
)paren
(brace
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
id|mtc
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|mtc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|mtc
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETDRVBUFFER
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: MTSETDRVBUFFER only allowed for root.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
op_logical_and
(paren
id|mtc.mt_op
op_ne
id|MTSETDRVBUFFER
op_logical_and
(paren
id|mtc.mt_count
op_amp
id|MT_ST_OPTIONS
)paren
op_eq
l_int|0
)paren
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|was_reset
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;eof_hit
)paren
(brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTFSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTFSFM
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
)paren
(brace
id|mtc.mt_count
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_add_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTBSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSFM
)paren
(brace
id|mtc.mt_count
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_ge
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
id|i
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|file
comma
multiline_comment|/* mtc.mt_op == MTSEEK || */
id|mtc.mt_op
op_eq
id|MTREW
op_logical_or
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_or
id|mtc.mt_op
op_eq
id|MTRETEN
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
op_logical_or
id|mtc.mt_op
op_eq
id|MTLOCK
op_logical_or
id|mtc.mt_op
op_eq
id|MTLOAD
op_logical_or
id|mtc.mt_op
op_eq
id|MTCOMPRESSION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;* If there was a bus reset, block further access&n;&t;* to this device.  If the user wants to rewind the tape,&n;&t;* then reset the flag and allow access again.&n;&t;*/
r_if
c_cond
(paren
id|mtc.mt_op
op_ne
id|MTREW
op_logical_and
id|mtc.mt_op
op_ne
id|MTOFFL
op_logical_and
id|mtc.mt_op
op_ne
id|MTRETEN
op_logical_and
id|mtc.mt_op
op_ne
id|MTERASE
op_logical_and
id|mtc.mt_op
op_ne
id|MTSEEK
op_logical_and
id|mtc.mt_op
op_ne
id|MTEOM
)paren
(brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|STp-&gt;device-&gt;was_reset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_ne
id|ST_UNLOCKED
op_logical_and
id|STp-&gt;door_locked
op_ne
id|ST_LOCK_FAILS
)paren
(brace
r_if
c_cond
(paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTLOCK
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;st%d: Could not relock door after bus reset.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_ne
id|MTNOP
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETBLK
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETDENSITY
op_logical_and
id|mtc.mt_op
op_ne
id|MTWSM
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETDRVBUFFER
op_logical_and
id|mtc.mt_op
op_ne
id|MTSEEK
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETPART
)paren
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
multiline_comment|/* Prevent automatic WEOF */
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_and
id|STp-&gt;door_locked
op_ne
id|ST_UNLOCKED
)paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTUNLOCK
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Ignore result! */
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETDRVBUFFER
op_logical_and
(paren
id|mtc.mt_count
op_amp
id|MT_ST_OPTIONS
)paren
op_ne
l_int|0
)paren
r_return
id|st_set_options
c_func
(paren
id|inode
comma
id|mtc.mt_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETPART
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
op_logical_or
id|mtc.mt_count
OL
l_int|0
op_logical_or
id|mtc.mt_count
op_ge
id|ST_NBR_PARTITIONS
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtc.mt_count
op_ge
id|STp-&gt;nbr_partitions
op_logical_and
(paren
id|STp-&gt;nbr_partitions
op_assign
id|nbr_partitions
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtc.mt_count
op_ge
id|STp-&gt;nbr_partitions
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|STp-&gt;new_partition
op_assign
id|mtc.mt_count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTMKPART
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|MTREW
comma
l_int|0
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|i
op_assign
id|partition_tape
c_func
(paren
id|inode
comma
id|mtc.mt_count
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|moves_after_eof
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|at_sm
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|last_block_valid
op_assign
id|FALSE
suffix:semicolon
)brace
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Bad guess ?-) */
id|STp-&gt;drv_block
op_assign
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSEEK
)paren
(brace
id|i
op_assign
id|set_location
c_func
(paren
id|inode
comma
id|mtc.mt_count
comma
id|STp-&gt;new_partition
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
)paren
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
id|STp-&gt;ready
op_eq
id|ST_READY
op_logical_and
(paren
id|i
op_assign
id|update_partition
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTCOMPRESSION
)paren
r_return
id|st_compression
c_func
(paren
id|STp
comma
(paren
id|mtc.mt_count
op_amp
l_int|1
)paren
)paren
suffix:semicolon
r_else
r_return
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|mtc.mt_op
comma
id|mtc.mt_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|file
comma
id|FALSE
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|i
op_assign
id|update_partition
c_func
(paren
id|inode
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCGET
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCGET
)paren
)paren
(brace
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_dsreg
op_assign
(paren
(paren
id|STp-&gt;block_size
op_lshift
id|MT_ST_BLKSIZE_SHIFT
)paren
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
op_or
(paren
(paren
id|STp-&gt;density
op_lshift
id|MT_ST_DENSITY_SHIFT
)paren
op_amp
id|MT_ST_DENSITY_MASK
)paren
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_blkno
op_assign
id|STp-&gt;drv_block
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_blkno
op_add_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_READING
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_blkno
op_sub_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_write_prot
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_WR_PROT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_blkno
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_eq
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_BOT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_EOF
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
)brace
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_resid
op_assign
id|STp-&gt;partition
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;eof
op_eq
id|ST_EOM_OK
op_logical_or
id|STp-&gt;eof
op_eq
id|ST_EOM_ERROR
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_EOT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;eof
op_eq
id|ST_EOD
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_EOD
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|1
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_D_800
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|2
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_D_1600
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|3
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_D_6250
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_ONLINE
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_DR_OPEN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;at_sm
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_SM
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STm-&gt;do_async_writes
op_logical_or
(paren
id|STm-&gt;do_buffer_writes
op_logical_and
id|STp-&gt;block_size
op_ne
l_int|0
)paren
op_logical_or
id|STp-&gt;drv_buffer
op_ne
l_int|0
)paren
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_gstat
op_or_assign
id|GMT_IM_REP_EN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
(paren
id|STp-&gt;mt_status
)paren
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
(paren
id|STp-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_erreg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear after read */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End of MTIOCGET */
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCPOS
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCPOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|get_location
c_func
(paren
id|inode
comma
op_amp
id|blk
comma
op_amp
id|bt
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|mt_pos
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|mt_pos.mt_blkno
op_assign
id|blk
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
(paren
op_amp
id|mt_pos
)paren
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|scsi_ioctl
c_func
(paren
id|STp-&gt;device
comma
id|cmd_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Try to allocate a new tape buffer */
r_static
id|ST_buffer
op_star
DECL|function|new_tape_buffer
id|new_tape_buffer
c_func
(paren
r_int
id|from_initialization
comma
r_int
id|need_dma
)paren
(brace
r_int
id|priority
comma
id|a_size
suffix:semicolon
id|ST_buffer
op_star
id|tb
suffix:semicolon
r_if
c_cond
(paren
id|st_nbr_buffers
op_ge
id|st_template.dev_max
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Should never happen */
r_if
c_cond
(paren
id|from_initialization
)paren
(brace
id|priority
op_assign
id|GFP_ATOMIC
suffix:semicolon
id|a_size
op_assign
id|st_buffer_size
suffix:semicolon
)brace
r_else
(brace
id|priority
op_assign
id|GFP_KERNEL
suffix:semicolon
r_for
c_loop
(paren
id|a_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|a_size
OL
id|st_buffer_size
suffix:semicolon
id|a_size
op_lshift_assign
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Make sure we allocate efficiently */
)brace
id|tb
op_assign
(paren
id|ST_buffer
op_star
)paren
id|scsi_init_malloc
c_func
(paren
r_sizeof
(paren
id|ST_buffer
)paren
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tb
)paren
(brace
r_if
c_cond
(paren
id|need_dma
)paren
id|priority
op_or_assign
id|GFP_DMA
suffix:semicolon
id|tb-&gt;b_data
op_assign
(paren
r_int
r_char
op_star
)paren
id|scsi_init_malloc
c_func
(paren
id|a_size
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tb-&gt;b_data
)paren
(brace
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|tb
comma
r_sizeof
(paren
id|ST_buffer
)paren
)paren
suffix:semicolon
id|tb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|tb
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;st: Can&squot;t allocate new tape buffer (nbr %d).&bslash;n&quot;
comma
id|st_nbr_buffers
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st: Allocated tape buffer %d (%d bytes, dma: %d, a: %p).&bslash;n&quot;
comma
id|st_nbr_buffers
comma
id|a_size
comma
id|need_dma
comma
id|tb-&gt;b_data
)paren
suffix:semicolon
macro_line|#endif
id|tb-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|tb-&gt;dma
op_assign
id|need_dma
suffix:semicolon
id|tb-&gt;buffer_size
op_assign
id|a_size
suffix:semicolon
id|tb-&gt;writing
op_assign
l_int|0
suffix:semicolon
id|tb-&gt;orig_b_data
op_assign
l_int|NULL
suffix:semicolon
id|st_buffers
(braket
id|st_nbr_buffers
op_increment
)braket
op_assign
id|tb
suffix:semicolon
r_return
id|tb
suffix:semicolon
)brace
multiline_comment|/* Try to allocate a temporary enlarged tape buffer */
r_static
r_int
DECL|function|enlarge_buffer
id|enlarge_buffer
c_func
(paren
id|ST_buffer
op_star
id|STbuffer
comma
r_int
id|new_size
comma
r_int
id|need_dma
)paren
(brace
r_int
id|a_size
comma
id|priority
suffix:semicolon
r_int
r_char
op_star
id|tbd
suffix:semicolon
id|normalize_buffer
c_func
(paren
id|STbuffer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|a_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|a_size
OL
id|new_size
suffix:semicolon
id|a_size
op_lshift_assign
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Make sure that we allocate efficiently */
id|priority
op_assign
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|need_dma
)paren
id|priority
op_or_assign
id|GFP_DMA
suffix:semicolon
id|tbd
op_assign
(paren
r_int
r_char
op_star
)paren
id|scsi_init_malloc
c_func
(paren
id|a_size
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tbd
)paren
r_return
id|FALSE
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st: Buffer at %p enlarged to %d bytes (dma: %d, a: %p).&bslash;n&quot;
comma
id|STbuffer-&gt;b_data
comma
id|a_size
comma
id|need_dma
comma
id|tbd
)paren
suffix:semicolon
macro_line|#endif
id|STbuffer-&gt;orig_b_data
op_assign
id|STbuffer-&gt;b_data
suffix:semicolon
id|STbuffer-&gt;orig_size
op_assign
id|STbuffer-&gt;buffer_size
suffix:semicolon
id|STbuffer-&gt;b_data
op_assign
id|tbd
suffix:semicolon
id|STbuffer-&gt;buffer_size
op_assign
id|a_size
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* Release the extra buffer */
r_static
r_void
DECL|function|normalize_buffer
id|normalize_buffer
c_func
(paren
id|ST_buffer
op_star
id|STbuffer
)paren
(brace
r_if
c_cond
(paren
id|STbuffer-&gt;orig_b_data
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|scsi_init_free
c_func
(paren
id|STbuffer-&gt;b_data
comma
id|STbuffer-&gt;buffer_size
)paren
suffix:semicolon
id|STbuffer-&gt;b_data
op_assign
id|STbuffer-&gt;orig_b_data
suffix:semicolon
id|STbuffer-&gt;orig_b_data
op_assign
l_int|NULL
suffix:semicolon
id|STbuffer-&gt;buffer_size
op_assign
id|STbuffer-&gt;orig_size
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|debugging
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st: Buffer at %p normalized to %d bytes.&bslash;n&quot;
comma
id|STbuffer-&gt;b_data
comma
id|STbuffer-&gt;buffer_size
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Set the boot options. Syntax: st=xxx,yyy&n;   where xxx is buffer size in 1024 byte blocks and yyy is write threshold&n;   in 1024 byte blocks. */
r_void
DECL|function|st_setup
id|st_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
op_logical_and
id|ints
(braket
l_int|1
)braket
OG
l_int|0
)paren
id|st_buffer_size
op_assign
id|ints
(braket
l_int|1
)braket
op_star
id|ST_BLOCK_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
op_logical_and
id|ints
(braket
l_int|2
)braket
OG
l_int|0
)paren
(brace
id|st_write_threshold
op_assign
id|ints
(braket
l_int|2
)braket
op_star
id|ST_BLOCK_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|st_write_threshold
OG
id|st_buffer_size
)paren
id|st_write_threshold
op_assign
id|st_buffer_size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|2
op_logical_and
id|ints
(braket
l_int|3
)braket
OG
l_int|0
)paren
id|st_max_buffers
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
)brace
DECL|variable|st_fops
r_static
r_struct
id|file_operations
id|st_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|st_read
comma
multiline_comment|/* read - general block-dev read */
id|st_write
comma
multiline_comment|/* write - general block-dev write */
l_int|NULL
comma
multiline_comment|/* readdir - bad */
l_int|NULL
comma
multiline_comment|/* select */
id|st_ioctl
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|scsi_tape_open
comma
multiline_comment|/* open */
id|scsi_tape_close
comma
multiline_comment|/* release */
l_int|NULL
multiline_comment|/* fsync */
)brace
suffix:semicolon
DECL|function|st_attach
r_static
r_int
(def_block
id|st_attach
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
id|Scsi_Tape
op_star
id|tpnt
suffix:semicolon
id|ST_mode
op_star
id|STm
suffix:semicolon
id|ST_partstat
op_star
id|STps
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|SDp-&gt;type
op_ne
id|TYPE_TAPE
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st_template.nr_dev
op_ge
id|st_template.dev_max
)paren
(brace
id|SDp-&gt;attached
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|tpnt
op_assign
id|scsi_tapes
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_template.dev_max
suffix:semicolon
id|i
op_increment
comma
id|tpnt
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|tpnt-&gt;device
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|st_template.dev_max
)paren
(brace
id|panic
(paren
l_string|&quot;scsi_devices corrupt (st)&quot;
)paren
suffix:semicolon
)brace
id|scsi_tapes
(braket
id|i
)braket
dot
id|device
op_assign
id|SDp
suffix:semicolon
r_if
c_cond
(paren
id|SDp-&gt;scsi_level
op_le
l_int|2
)paren
id|scsi_tapes
(braket
id|i
)braket
dot
id|mt_status-&gt;mt_type
op_assign
id|MT_ISSCSI1
suffix:semicolon
r_else
id|scsi_tapes
(braket
id|i
)braket
dot
id|mt_status-&gt;mt_type
op_assign
id|MT_ISSCSI2
suffix:semicolon
id|tpnt-&gt;devt
op_assign
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|i
)paren
suffix:semicolon
id|tpnt-&gt;dirty
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|tpnt-&gt;waiting
op_assign
l_int|NULL
suffix:semicolon
id|tpnt-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;drv_buffer
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Try buffering if no mode sense */
id|tpnt-&gt;restr_dma
op_assign
(paren
id|SDp-&gt;host
)paren
op_member_access_from_pointer
id|unchecked_isa_dma
suffix:semicolon
id|tpnt-&gt;density
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;do_auto_lock
op_assign
id|ST_AUTO_LOCK
suffix:semicolon
id|tpnt-&gt;can_bsr
op_assign
id|ST_IN_FILE_POS
suffix:semicolon
id|tpnt-&gt;can_partitions
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;two_fm
op_assign
id|ST_TWO_FM
suffix:semicolon
id|tpnt-&gt;fast_mteom
op_assign
id|ST_FAST_MTEOM
suffix:semicolon
id|tpnt-&gt;scsi2_logical
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;write_threshold
op_assign
id|st_write_threshold
suffix:semicolon
id|tpnt-&gt;default_drvbuffer
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* No forced buffering */
id|tpnt-&gt;partition
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;nbr_partitions
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
(paren
id|tpnt-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_fileno
op_assign
(paren
id|tpnt-&gt;mt_status
)paren
op_member_access_from_pointer
id|mt_blkno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_MODES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STm
op_assign
op_amp
(paren
id|tpnt-&gt;modes
(braket
id|i
)braket
)paren
suffix:semicolon
id|STm-&gt;defined
op_assign
id|FALSE
suffix:semicolon
id|STm-&gt;defaults_for_writes
op_assign
l_int|0
suffix:semicolon
id|STm-&gt;do_async_writes
op_assign
id|ST_ASYNC_WRITES
suffix:semicolon
id|STm-&gt;do_buffer_writes
op_assign
id|ST_BUFFER_WRITES
suffix:semicolon
id|STm-&gt;do_read_ahead
op_assign
id|ST_READ_AHEAD
suffix:semicolon
id|STm-&gt;default_compression
op_assign
id|ST_DONT_TOUCH
suffix:semicolon
id|STm-&gt;default_blksize
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No forced size */
id|STm-&gt;default_density
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No forced density */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|tpnt-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;moves_after_eof
op_assign
l_int|1
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
id|FALSE
suffix:semicolon
)brace
id|tpnt-&gt;current_mode
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;modes
(braket
l_int|0
)braket
dot
id|defined
op_assign
id|TRUE
suffix:semicolon
id|tpnt-&gt;density_changed
op_assign
id|tpnt-&gt;compression_changed
op_assign
id|tpnt-&gt;blksize_changed
op_assign
id|FALSE
suffix:semicolon
id|st_template.nr_dev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
suffix:semicolon
DECL|function|st_detect
r_static
r_int
id|st_detect
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
r_if
c_cond
(paren
id|SDp-&gt;type
op_ne
id|TYPE_TAPE
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Detected scsi tape st%d at scsi%d, channel %d, id %d, lun %d&bslash;n&quot;
comma
id|st_template.dev_noticed
op_increment
comma
id|SDp-&gt;host-&gt;host_no
comma
id|SDp-&gt;channel
comma
id|SDp-&gt;id
comma
id|SDp-&gt;lun
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|st_registered
r_static
r_int
id|st_registered
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Driver initialization */
DECL|function|st_init
r_static
r_int
id|st_init
c_func
(paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|Scsi_Tape
op_star
id|STp
suffix:semicolon
macro_line|#if !ST_RUNTIME_BUFFERS
r_int
id|target_nbr
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|st_template.dev_noticed
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_registered
)paren
(brace
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_string|&quot;st&quot;
comma
op_amp
id|st_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to get major %d for SCSI tapes&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|st_registered
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_tapes
)paren
r_return
l_int|0
suffix:semicolon
id|st_template.dev_max
op_assign
id|st_template.dev_noticed
op_plus
id|ST_EXTRA_DEVS
suffix:semicolon
r_if
c_cond
(paren
id|st_template.dev_max
OL
id|ST_MAX_TAPES
)paren
id|st_template.dev_max
op_assign
id|ST_MAX_TAPES
suffix:semicolon
r_if
c_cond
(paren
id|st_template.dev_max
OG
l_int|128
op_div
id|ST_NBR_MODES
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st: Only %d tapes accessible.&bslash;n&quot;
comma
l_int|128
op_div
id|ST_NBR_MODES
)paren
suffix:semicolon
id|scsi_tapes
op_assign
(paren
id|Scsi_Tape
op_star
)paren
id|scsi_init_malloc
c_func
(paren
id|st_template.dev_max
op_star
r_sizeof
(paren
id|Scsi_Tape
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to allocate descriptors for SCSI tapes.&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_string|&quot;st&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;st: Buffer size %d bytes, write threshold %d bytes.&bslash;n&quot;
comma
id|st_buffer_size
comma
id|st_write_threshold
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|scsi_tapes
comma
l_int|0
comma
id|st_template.dev_max
op_star
r_sizeof
(paren
id|Scsi_Tape
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_template.dev_max
suffix:semicolon
op_increment
id|i
)paren
(brace
id|STp
op_assign
op_amp
(paren
id|scsi_tapes
(braket
id|i
)braket
)paren
suffix:semicolon
id|STp-&gt;capacity
op_assign
l_int|0xfffff
suffix:semicolon
id|STp-&gt;mt_status
op_assign
(paren
r_struct
id|mtget
op_star
)paren
id|scsi_init_malloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtget
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/* Initialize status */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|i
)braket
dot
id|mt_status
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate the buffers */
id|st_buffers
op_assign
(paren
id|ST_buffer
op_star
op_star
)paren
id|scsi_init_malloc
c_func
(paren
id|st_template.dev_max
op_star
r_sizeof
(paren
id|ST_buffer
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_buffers
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to allocate tape buffer pointers.&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_string|&quot;st&quot;
)paren
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsi_tapes
comma
id|st_template.dev_max
op_star
r_sizeof
(paren
id|Scsi_Tape
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if ST_RUNTIME_BUFFERS
id|st_nbr_buffers
op_assign
l_int|0
suffix:semicolon
macro_line|#else
id|target_nbr
op_assign
id|st_template.dev_noticed
suffix:semicolon
r_if
c_cond
(paren
id|target_nbr
OL
id|ST_EXTRA_DEVS
)paren
id|target_nbr
op_assign
id|ST_EXTRA_DEVS
suffix:semicolon
r_if
c_cond
(paren
id|target_nbr
OG
id|st_max_buffers
)paren
id|target_nbr
op_assign
id|st_max_buffers
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|st_nbr_buffers
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|target_nbr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|new_tape_buffer
c_func
(paren
id|TRUE
comma
id|TRUE
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t continue without at least one tape buffer.&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_string|&quot;st&quot;
)paren
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|st_buffers
comma
id|st_template.dev_max
op_star
r_sizeof
(paren
id|ST_buffer
op_star
)paren
)paren
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsi_tapes
comma
id|st_template.dev_max
op_star
r_sizeof
(paren
id|Scsi_Tape
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;No tape buffers allocated at initialization.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Number of tape buffers adjusted.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|st_detach
r_static
r_void
id|st_detach
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
id|Scsi_Tape
op_star
id|tpnt
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|tpnt
op_assign
id|scsi_tapes
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_template.dev_max
suffix:semicolon
id|i
op_increment
comma
id|tpnt
op_increment
)paren
r_if
c_cond
(paren
id|tpnt-&gt;device
op_eq
id|SDp
)paren
(brace
id|tpnt-&gt;device
op_assign
l_int|NULL
suffix:semicolon
id|SDp-&gt;attached
op_decrement
suffix:semicolon
id|st_template.nr_dev
op_decrement
suffix:semicolon
id|st_template.dev_noticed
op_decrement
suffix:semicolon
r_return
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|st_template.usage_count
op_assign
op_amp
id|mod_use_count_
suffix:semicolon
r_return
id|scsi_register_module
c_func
(paren
id|MODULE_SCSI_DEV
comma
op_amp
id|st_template
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|scsi_unregister_module
c_func
(paren
id|MODULE_SCSI_DEV
comma
op_amp
id|st_template
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_string|&quot;st&quot;
)paren
suffix:semicolon
id|st_registered
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
op_ne
l_int|NULL
)paren
(brace
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsi_tapes
comma
id|st_template.dev_max
op_star
r_sizeof
(paren
id|Scsi_Tape
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_buffers
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_nbr_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|st_buffers
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|b_data
comma
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|buffer_size
)paren
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|st_buffers
(braket
id|i
)braket
comma
r_sizeof
(paren
id|ST_buffer
)paren
)paren
suffix:semicolon
)brace
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|st_buffers
comma
id|st_template.dev_max
op_star
r_sizeof
(paren
id|ST_buffer
op_star
)paren
)paren
suffix:semicolon
)brace
)brace
id|st_template.dev_max
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st: Unloaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
