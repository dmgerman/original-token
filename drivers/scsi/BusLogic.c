multiline_comment|/*&n;&n;  Linux Driver for BusLogic SCSI Host Adapters&n;&n;  Copyright 1995 by Leonard N. Zubkoff &lt;lnz@dandelion.com&gt;&n;&n;  This program is free software; you may redistribute and/or modify it under&n;  the terms of the GNU General Public License Version 2 as published by the&n;  Free Software Foundation, provided that none of the source code or runtime&n;  copyright notices are removed or modified.&n;&n;  This program is distributed in the hope that it will be useful, but&n;  WITHOUT ANY WARRANTY, without even the implied warranty of MERCHANTABILITY&n;  or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n;  for complete details.&n;&n;  The author respectfully requests that all modifications to this software be&n;  sent directly to him for evaluation and testing.&n;&n;  Special thanks to Alex T. Win of BusLogic, whose advice has been invaluable,&n;  and to David B. Gentzel, for writing the original Linux BusLogic driver.&n;&n;*/
DECL|macro|BusLogic_DriverVersion
mdefine_line|#define BusLogic_DriverVersion&t;&t;&quot;1.3.0&quot;
DECL|macro|BusLogic_DriverDate
mdefine_line|#define BusLogic_DriverDate&t;&t;&quot;13 November 1995&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;BusLogic.h&quot;
multiline_comment|/*&n;  BusLogic_CommandLineEntryCount is a count of the number of &quot;BusLogic=&quot;&n;  entries provided on the Linux Kernel Command Line.&n;*/
r_static
r_int
DECL|variable|BusLogic_CommandLineEntryCount
id|BusLogic_CommandLineEntryCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;  BusLogic_CommandLineEntries is an array of Command Line Entry structures&n;  representing the &quot;BusLogic=&quot; entries provided on the Linux Kernel Command&n;  Line.&n;*/
r_static
id|BusLogic_CommandLineEntry_T
DECL|variable|BusLogic_CommandLineEntries
id|BusLogic_CommandLineEntries
(braket
id|BusLogic_MaxHostAdapters
)braket
suffix:semicolon
multiline_comment|/*&n;  BusLogic_TracingOptions is a bit mask of Tracing Options to be applied&n;  across all Host Adapters.&n;*/
r_static
r_int
DECL|variable|BusLogic_TracingOptions
id|BusLogic_TracingOptions
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;  BusLogic_RegisteredHostAdapters is a linked list of all the registered&n;  BusLogic Host Adapters.&n;*/
r_static
id|BusLogic_HostAdapter_T
DECL|variable|BusLogic_RegisteredHostAdapters
op_star
id|BusLogic_RegisteredHostAdapters
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;  BusLogic_Standard_IO_Addresses is the list of standard I/O Addresses at which&n;  BusLogic Host Adapters may potentially be found.&n;*/
r_static
r_int
r_int
DECL|variable|BusLogic_IO_StandardAddresses
id|BusLogic_IO_StandardAddresses
(braket
)braket
op_assign
(brace
l_int|0x330
comma
l_int|0x334
comma
l_int|0x230
comma
l_int|0x234
comma
l_int|0x130
comma
l_int|0x134
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n;  BusLogic_IO_AddressProbeList is the list of I/O Addresses to be probed for&n;  potential BusLogic Host Adapters.  It is initialized by interrogating the&n;  PCI Configuration Space on PCI machines as well as from the list of&n;  standard BusLogic I/O Addresses.&n;*/
r_static
r_int
r_int
DECL|variable|BusLogic_IO_AddressProbeList
id|BusLogic_IO_AddressProbeList
(braket
id|BusLogic_IO_MaxProbeAddresses
op_plus
l_int|1
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n;  BusLogic_IRQ_UsageCount stores a count of the number of Host Adapters using&n;  a given IRQ Channel, which is necessary to support PCI, EISA, or MCA shared&n;  interrupts.  Only IRQ Channels 9, 10, 11, 12, 14, and 15 are supported by&n;  BusLogic Host Adapters.&n;*/
r_static
r_int
DECL|variable|BusLogic_IRQ_UsageCount
id|BusLogic_IRQ_UsageCount
(braket
l_int|7
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n;  BusLogic_CommandFailureReason holds a string identifying the reason why a&n;  call to BusLogic_Command failed.  It is only valid when BusLogic_Command&n;  returns a failure code.&n;*/
r_static
r_char
DECL|variable|BusLogic_CommandFailureReason
op_star
id|BusLogic_CommandFailureReason
suffix:semicolon
multiline_comment|/*&n;  BusLogic_ProcDirectoryEntry is the BusLogic /proc/scsi directory entry.&n;*/
r_static
r_struct
id|proc_dir_entry
DECL|variable|BusLogic_ProcDirectoryEntry
id|BusLogic_ProcDirectoryEntry
op_assign
(brace
id|PROC_SCSI_BUSLOGIC
comma
l_int|8
comma
l_string|&quot;BusLogic&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
multiline_comment|/*&n;  BusLogic_AnnounceDriver announces the Driver Version and Date, Author&squot;s&n;  Name, Copyright Notice, and Contact Address.&n;*/
DECL|function|BusLogic_AnnounceDriver
r_static
r_void
id|BusLogic_AnnounceDriver
c_func
(paren
r_void
)paren
(brace
r_static
id|boolean
id|DriverAnnouncementPrinted
op_assign
l_bool|false
suffix:semicolon
r_if
c_cond
(paren
id|DriverAnnouncementPrinted
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi: ***** BusLogic SCSI Driver Version &quot;
id|BusLogic_DriverVersion
l_string|&quot; of &quot;
id|BusLogic_DriverDate
l_string|&quot; *****&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi: Copyright 1995 by Leonard N. Zubkoff &quot;
l_string|&quot;&lt;lnz@dandelion.com&gt;&bslash;n&quot;
)paren
suffix:semicolon
id|DriverAnnouncementPrinted
op_assign
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_DriverInfo returns the Board Name to identify this SCSI Driver&n;  and Host Adapter.&n;*/
DECL|function|BusLogic_DriverInfo
r_const
r_char
op_star
id|BusLogic_DriverInfo
c_func
(paren
id|SCSI_Host_T
op_star
id|Host
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Host-&gt;hostdata
suffix:semicolon
r_return
id|HostAdapter-&gt;BoardName
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_InitializeAddressProbeList initializes the list of I/O Addresses&n;  to be probed for potential BusLogic SCSI Host Adapters by interrogating the&n;  PCI Configuration Space on PCI machines as well as from the list of standard&n;  BusLogic I/O Addresses.&n;*/
DECL|function|BusLogic_InitializeAddressProbeList
r_static
r_void
id|BusLogic_InitializeAddressProbeList
c_func
(paren
r_void
)paren
(brace
r_int
id|DestinationIndex
op_assign
l_int|0
comma
id|SourceIndex
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    If BusLogic_Setup has been called, do not override the Kernel Command&n;    Line specifications.&n;  */
r_if
c_cond
(paren
id|BusLogic_IO_AddressProbeList
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
r_return
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
multiline_comment|/*&n;    Interrogate PCI Configuration Space for any BusLogic SCSI Host Adapters.&n;  */
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_int
r_int
id|Index
op_assign
l_int|0
comma
id|VendorID
suffix:semicolon
r_int
r_char
id|Bus
comma
id|DeviceAndFunction
suffix:semicolon
r_int
r_int
id|BaseAddress0
suffix:semicolon
r_while
c_loop
(paren
id|pcibios_find_class
c_func
(paren
id|PCI_CLASS_STORAGE_SCSI
op_lshift
l_int|8
comma
id|Index
op_increment
comma
op_amp
id|Bus
comma
op_amp
id|DeviceAndFunction
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|pcibios_read_config_word
c_func
(paren
id|Bus
comma
id|DeviceAndFunction
comma
id|PCI_VENDOR_ID
comma
op_amp
id|VendorID
)paren
op_eq
l_int|0
op_logical_and
id|VendorID
op_eq
id|PCI_VENDOR_ID_BUSLOGIC
op_logical_and
id|pcibios_read_config_dword
c_func
(paren
id|Bus
comma
id|DeviceAndFunction
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|BaseAddress0
)paren
op_eq
l_int|0
op_logical_and
(paren
id|BaseAddress0
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
op_eq
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|BusLogic_IO_AddressProbeList
(braket
id|DestinationIndex
op_increment
)braket
op_assign
id|BaseAddress0
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n;    Append the list of standard BusLogic I/O Addresses.&n;  */
r_while
c_loop
(paren
id|DestinationIndex
template_param
l_int|0
)paren
id|BusLogic_IO_AddressProbeList
(braket
id|DestinationIndex
op_increment
)braket
op_assign
id|BusLogic_IO_StandardAddresses
(braket
id|SourceIndex
op_increment
)braket
suffix:semicolon
id|BusLogic_IO_AddressProbeList
(braket
id|DestinationIndex
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_RegisterHostAdapter adds Host Adapter to the list of registered&n;  BusLogic Host Adapters.&n;*/
DECL|function|BusLogic_RegisterHostAdapter
r_static
r_void
id|BusLogic_RegisterHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|HostAdapter-&gt;Next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_RegisteredHostAdapters
op_ne
l_int|NULL
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|LastHostAdapter
op_assign
id|BusLogic_RegisteredHostAdapters
suffix:semicolon
id|BusLogic_HostAdapter_T
op_star
id|NextHostAdapter
suffix:semicolon
r_while
c_loop
(paren
(paren
id|NextHostAdapter
op_assign
id|LastHostAdapter-&gt;Next
)paren
op_ne
l_int|NULL
)paren
id|LastHostAdapter
op_assign
id|NextHostAdapter
suffix:semicolon
id|LastHostAdapter-&gt;Next
op_assign
id|HostAdapter
suffix:semicolon
)brace
r_else
id|BusLogic_RegisteredHostAdapters
op_assign
id|HostAdapter
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_UnregisterHostAdapter removes Host Adapter from the list of&n;  registered BusLogic Host Adapters.&n;*/
DECL|function|BusLogic_UnregisterHostAdapter
r_static
r_void
id|BusLogic_UnregisterHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
r_if
c_cond
(paren
id|BusLogic_RegisteredHostAdapters
op_ne
id|HostAdapter
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|LastHostAdapter
op_assign
id|BusLogic_RegisteredHostAdapters
suffix:semicolon
r_while
c_loop
(paren
id|LastHostAdapter
op_ne
l_int|NULL
op_logical_and
id|LastHostAdapter-&gt;Next
op_ne
id|HostAdapter
)paren
id|LastHostAdapter
op_assign
id|LastHostAdapter-&gt;Next
suffix:semicolon
r_if
c_cond
(paren
id|LastHostAdapter
op_ne
l_int|NULL
)paren
id|LastHostAdapter-&gt;Next
op_assign
id|HostAdapter-&gt;Next
suffix:semicolon
)brace
r_else
id|BusLogic_RegisteredHostAdapters
op_assign
id|HostAdapter-&gt;Next
suffix:semicolon
id|HostAdapter-&gt;Next
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_CreateCCBs allocates the initial Command Control Blocks (CCBs)&n;  for Host Adapter.&n;*/
DECL|function|BusLogic_CreateCCBs
r_static
id|boolean
id|BusLogic_CreateCCBs
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BusLogic_InitialCCBs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BusLogic_CCB_T
op_star
id|CCB
op_assign
(paren
id|BusLogic_CCB_T
op_star
)paren
id|scsi_init_malloc
c_func
(paren
r_sizeof
(paren
id|BusLogic_CCB_T
)paren
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CCB
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: UNABLE TO ALLOCATE CCB %d - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|i
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
id|memset
c_func
(paren
id|CCB
comma
l_int|0
comma
r_sizeof
(paren
id|BusLogic_CCB_T
)paren
)paren
suffix:semicolon
id|CCB-&gt;HostAdapter
op_assign
id|HostAdapter
suffix:semicolon
id|CCB-&gt;Status
op_assign
id|BusLogic_CCB_Free
suffix:semicolon
id|CCB-&gt;Next
op_assign
id|HostAdapter-&gt;Free_CCBs
suffix:semicolon
id|CCB-&gt;NextAll
op_assign
id|HostAdapter-&gt;All_CCBs
suffix:semicolon
id|HostAdapter-&gt;Free_CCBs
op_assign
id|CCB
suffix:semicolon
id|HostAdapter-&gt;All_CCBs
op_assign
id|CCB
suffix:semicolon
)brace
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_DestroyCCBs deallocates the CCBs for Host Adapter.&n;*/
DECL|function|BusLogic_DestroyCCBs
r_static
r_void
id|BusLogic_DestroyCCBs
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|BusLogic_CCB_T
op_star
id|NextCCB
op_assign
id|HostAdapter-&gt;All_CCBs
comma
op_star
id|CCB
suffix:semicolon
id|HostAdapter-&gt;All_CCBs
op_assign
l_int|NULL
suffix:semicolon
id|HostAdapter-&gt;Free_CCBs
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|CCB
op_assign
id|NextCCB
)paren
op_ne
l_int|NULL
)paren
(brace
id|NextCCB
op_assign
id|CCB-&gt;NextAll
suffix:semicolon
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|CCB
comma
r_sizeof
(paren
id|BusLogic_CCB_T
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;  BusLogic_AllocateCCB allocates a CCB from the Host Adapter&squot;s free list,&n;  allocating more memory from the Kernel if necessary.&n;*/
DECL|function|BusLogic_AllocateCCB
r_static
id|BusLogic_CCB_T
op_star
id|BusLogic_AllocateCCB
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
r_static
r_int
r_int
id|SerialNumber
op_assign
l_int|0
suffix:semicolon
id|BusLogic_CCB_T
op_star
id|CCB
suffix:semicolon
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|CCB
op_assign
id|HostAdapter-&gt;Free_CCBs
suffix:semicolon
r_if
c_cond
(paren
id|CCB
op_ne
l_int|NULL
)paren
(brace
id|CCB-&gt;SerialNumber
op_assign
id|SerialNumber
op_increment
suffix:semicolon
id|HostAdapter-&gt;Free_CCBs
op_assign
id|CCB-&gt;Next
suffix:semicolon
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_return
id|CCB
suffix:semicolon
)brace
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|CCB
op_assign
(paren
id|BusLogic_CCB_T
op_star
)paren
id|scsi_init_malloc
c_func
(paren
r_sizeof
(paren
id|BusLogic_CCB_T
)paren
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CCB
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Failed to allocate an additional CCB&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Allocated an additional CCB&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|memset
c_func
(paren
id|CCB
comma
l_int|0
comma
r_sizeof
(paren
id|BusLogic_CCB_T
)paren
)paren
suffix:semicolon
id|CCB-&gt;HostAdapter
op_assign
id|HostAdapter
suffix:semicolon
id|CCB-&gt;Status
op_assign
id|BusLogic_CCB_Free
suffix:semicolon
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|CCB-&gt;SerialNumber
op_assign
id|SerialNumber
op_increment
suffix:semicolon
id|CCB-&gt;NextAll
op_assign
id|HostAdapter-&gt;All_CCBs
suffix:semicolon
id|HostAdapter-&gt;All_CCBs
op_assign
id|CCB
suffix:semicolon
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_return
id|CCB
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_DeallocateCCB deallocates a CCB, returning it to the Host Adapter&squot;s&n;  free list.&n;*/
DECL|function|BusLogic_DeallocateCCB
r_static
r_void
id|BusLogic_DeallocateCCB
c_func
(paren
id|BusLogic_CCB_T
op_star
id|CCB
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
id|CCB-&gt;HostAdapter
suffix:semicolon
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|CCB-&gt;Command
op_assign
l_int|NULL
suffix:semicolon
id|CCB-&gt;Status
op_assign
id|BusLogic_CCB_Free
suffix:semicolon
id|CCB-&gt;SerialNumber
op_assign
l_int|0
suffix:semicolon
id|CCB-&gt;Next
op_assign
id|HostAdapter-&gt;Free_CCBs
suffix:semicolon
id|HostAdapter-&gt;Free_CCBs
op_assign
id|CCB
suffix:semicolon
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_Command sends the command OperationCode to HostAdapter, optionally&n;  providing ParameterLength bytes of ParameterData and receiving at most&n;  ReplyLength bytes of ReplyData; any excess reply data is received but&n;  discarded.&n;&n;  On success, this function returns the number of reply bytes read from&n;  the Host Adapter (including any discarded data); on failure, it returns&n;  -1 if the command was invalid, or -2 if a timeout occurred.&n;&n;  This function is only called during board detection and initialization, so&n;  performance and latency are not critical, and exclusive access to the Host&n;  Adapter hardware is assumed.  Once the board and driver are initialized, the&n;  only Host Adapter command that is issued is the single byte Start Mailbox&n;  Scan command, which does not require waiting for the Host Adapter Ready bit&n;  to be set in the Status Register.&n;*/
DECL|function|BusLogic_Command
r_static
r_int
id|BusLogic_Command
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
comma
id|BusLogic_OperationCode_T
id|OperationCode
comma
r_void
op_star
id|ParameterData
comma
r_int
id|ParameterLength
comma
r_void
op_star
id|ReplyData
comma
r_int
id|ReplyLength
)paren
(brace
r_int
r_char
op_star
id|ParameterPointer
op_assign
(paren
r_int
r_char
op_star
)paren
id|ParameterData
suffix:semicolon
r_int
r_char
op_star
id|ReplyPointer
op_assign
(paren
r_int
r_char
op_star
)paren
id|ReplyData
suffix:semicolon
r_int
r_char
id|StatusRegister
op_assign
l_int|0
comma
id|InterruptRegister
suffix:semicolon
r_int
id|TimeoutCounter
suffix:semicolon
r_int
id|ReplyBytes
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    Clear out the Reply Data if provided.&n;  */
r_if
c_cond
(paren
id|ReplyLength
OG
l_int|0
)paren
id|memset
c_func
(paren
id|ReplyData
comma
l_int|0
comma
id|ReplyLength
)paren
suffix:semicolon
multiline_comment|/*&n;    Select an appropriate timeout value.&n;  */
r_switch
c_cond
(paren
id|OperationCode
)paren
(brace
r_case
id|BusLogic_InquireInstalledDevicesID0to7
suffix:colon
r_case
id|BusLogic_InquireInstalledDevicesID8to15
suffix:colon
multiline_comment|/* Approximately 60 seconds. */
id|TimeoutCounter
op_assign
id|loops_per_sec
op_lshift
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Approximately 1 second. */
id|TimeoutCounter
op_assign
id|loops_per_sec
op_rshift
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;    Wait for the Host Adapter Ready bit to be set and the Command/Parameter&n;    Register Busy bit to be reset in the Status Register.&n;  */
r_while
c_loop
(paren
op_decrement
id|TimeoutCounter
op_ge
l_int|0
)paren
(brace
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|StatusRegister
op_amp
id|BusLogic_HostAdapterReady
)paren
op_logical_and
op_logical_neg
(paren
id|StatusRegister
op_amp
id|BusLogic_CommandParameterRegisterBusy
)paren
)paren
r_break
suffix:semicolon
)brace
id|BusLogic_CommandFailureReason
op_assign
l_string|&quot;Timeout waiting for Host Adapter Ready&quot;
suffix:semicolon
r_if
c_cond
(paren
id|TimeoutCounter
OL
l_int|0
)paren
r_return
op_minus
l_int|2
suffix:semicolon
multiline_comment|/*&n;    Write the OperationCode to the Command/Parameter Register.&n;  */
id|BusLogic_WriteCommandParameterRegister
c_func
(paren
id|HostAdapter
comma
id|OperationCode
)paren
suffix:semicolon
multiline_comment|/*&n;    Write any additional Parameter Bytes.&n;  */
id|HostAdapter-&gt;HostAdapterCommandCompleted
op_assign
l_bool|false
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|ParameterLength
op_ge
l_int|0
)paren
(brace
id|InterruptRegister
op_assign
id|BusLogic_ReadInterruptRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_CommandComplete
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;HostAdapterCommandCompleted
)paren
r_break
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|TimeoutCounter
op_ge
l_int|0
)paren
(brace
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|StatusRegister
op_amp
id|BusLogic_CommandParameterRegisterBusy
)paren
)paren
r_break
suffix:semicolon
)brace
id|BusLogic_CommandFailureReason
op_assign
l_string|&quot;Timeout waiting for Parameter Acceptance&quot;
suffix:semicolon
r_if
c_cond
(paren
id|TimeoutCounter
OL
l_int|0
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|BusLogic_WriteCommandParameterRegister
c_func
(paren
id|HostAdapter
comma
op_star
id|ParameterPointer
op_increment
)paren
suffix:semicolon
)brace
id|BusLogic_CommandFailureReason
op_assign
l_string|&quot;Excess Parameters Supplied&quot;
suffix:semicolon
r_if
c_cond
(paren
id|ParameterLength
op_ge
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;    The Modify I/O Address command does not cause a Command Complete Interrupt.&n;  */
r_if
c_cond
(paren
id|OperationCode
op_eq
id|BusLogic_ModifyIOAddress
)paren
(brace
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|BusLogic_CommandFailureReason
op_assign
l_string|&quot;Modify I/O Address Invalid&quot;
suffix:semicolon
r_return
(paren
(paren
id|StatusRegister
op_amp
id|BusLogic_CommandInvalid
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Receive any Reply Bytes, waiting for either the Command Complete bit to&n;    be set in the Interrupt Register, or for the Interrupt Handler to set the&n;    HostAdapterCommandCompleted bit in the Host Adapter structure.&n;  */
id|HostAdapter-&gt;HostAdapterCommandCompleted
op_assign
l_bool|false
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|TimeoutCounter
op_ge
l_int|0
)paren
(brace
id|InterruptRegister
op_assign
id|BusLogic_ReadInterruptRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_CommandComplete
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;HostAdapterCommandCompleted
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|StatusRegister
op_amp
id|BusLogic_DataInRegisterReady
)paren
r_if
c_cond
(paren
op_increment
id|ReplyBytes
op_le
id|ReplyLength
)paren
op_star
id|ReplyPointer
op_increment
op_assign
id|BusLogic_ReadDataInRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_else
id|BusLogic_ReadDataInRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
)brace
id|BusLogic_CommandFailureReason
op_assign
l_string|&quot;Timeout waiting for Command Complete&quot;
suffix:semicolon
r_if
c_cond
(paren
id|TimeoutCounter
OL
l_int|0
)paren
r_return
op_minus
l_int|2
suffix:semicolon
multiline_comment|/*&n;    Clear any pending Command Complete Interrupt, unless this is a&n;    Test Command Complete Interrupt command.&n;  */
r_if
c_cond
(paren
id|OperationCode
op_ne
id|BusLogic_TestCommandCompleteInterrupt
)paren
id|BusLogic_WriteControlRegister
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InterruptReset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_TracingOptions
op_amp
id|BusLogic_TraceConfiguration
)paren
r_if
c_cond
(paren
id|OperationCode
op_ne
id|BusLogic_TestCommandCompleteInterrupt
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BusLogic_Command(%02X) Status = %02X: %2d ==&gt; %2d:&quot;
comma
id|OperationCode
comma
id|StatusRegister
comma
id|ReplyLength
comma
id|ReplyBytes
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ReplyBytes
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|ReplyData
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Return count of Reply Bytes, or -1 if the command was invalid.&n;  */
id|BusLogic_CommandFailureReason
op_assign
l_string|&quot;Command Invalid&quot;
suffix:semicolon
r_return
(paren
(paren
id|StatusRegister
op_amp
id|BusLogic_CommandInvalid
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
id|ReplyBytes
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_Failure prints a standardized error message for tests that are&n;  executed before the SCSI Host is registered, and then returns false.&n;*/
DECL|function|BusLogic_Failure
r_static
id|boolean
id|BusLogic_Failure
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
comma
r_char
op_star
id|ErrorMessage
)paren
(brace
id|BusLogic_AnnounceDriver
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;While configuring BusLogic Host Adapter at I/O Address 0x%X:&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s FAILED - DETACHING&bslash;n&quot;
comma
id|ErrorMessage
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_CommandFailureReason
op_ne
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;ADDITIONAL FAILURE INFO - %s&bslash;n&quot;
comma
id|BusLogic_CommandFailureReason
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ProbeHostAdapter probes for a BusLogic Host Adapter.&n;*/
DECL|function|BusLogic_ProbeHostAdapter
r_static
id|boolean
id|BusLogic_ProbeHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|boolean
id|TraceProbe
op_assign
(paren
id|BusLogic_TracingOptions
op_amp
id|BusLogic_TraceProbe
)paren
suffix:semicolon
r_int
r_char
id|StatusRegister
comma
id|GeometryRegister
suffix:semicolon
multiline_comment|/*&n;    Read the Status Register to test if there is an I/O port that responds.  A&n;    nonexistent I/O port will return 0xFF, in which case there is definitely no&n;    BusLogic Host Adapter at this base I/O Address.&n;  */
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TraceProbe
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic_Probe(0x%X): Status 0x%02X&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
comma
id|StatusRegister
)paren
suffix:semicolon
r_if
c_cond
(paren
id|StatusRegister
op_eq
l_int|0xFF
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/*&n;    Read the undocumented BusLogic Geometry Register to test if there is an I/O&n;    port that responds.  Adaptec Host Adapters do not implement the Geometry&n;    Register, so this test helps serve to avoid incorrectly recognizing an&n;    Adaptec 1542A or 1542B as a BusLogic.  Unfortunately, the Adaptec 1542C&n;    series does respond to the Geometry Register I/O port, but it will be&n;    rejected later when the Inquire Extended Setup Information command is&n;    issued in BusLogic_CheckHostAdapter.  The AMI FastDisk Host Adapter is a&n;    BusLogic clone that implements the same interface as earlier BusLogic&n;    boards, including the undocumented commands, and is therefore supported by&n;    this driver.  However, the AMI FastDisk always returns 0x00 upon reading&n;    the Geometry Register, so the extended translation option should always be&n;    left disabled on the AMI FastDisk.&n;  */
id|GeometryRegister
op_assign
id|BusLogic_ReadGeometryRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TraceProbe
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic_Probe(0x%X): Geometry 0x%02X&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
comma
id|GeometryRegister
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GeometryRegister
op_eq
l_int|0xFF
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/*&n;    Indicate the Host Adapter Probe completed successfully.&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_HardResetHostAdapter issues a Hard Reset to the Host Adapter,&n;  and waits for Host Adapter Diagnostics to complete.&n;*/
DECL|function|BusLogic_HardResetHostAdapter
r_static
id|boolean
id|BusLogic_HardResetHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|boolean
id|TraceHardReset
op_assign
(paren
id|BusLogic_TracingOptions
op_amp
id|BusLogic_TraceHardReset
)paren
suffix:semicolon
r_int
id|TimeoutCounter
op_assign
id|loops_per_sec
op_rshift
l_int|2
suffix:semicolon
r_int
r_char
id|StatusRegister
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    Issue a Hard Reset Command to the Host Adapter.  The Host Adapter should&n;    respond by setting Diagnostic Active in the Status Register.&n;  */
id|BusLogic_WriteControlRegister
c_func
(paren
id|HostAdapter
comma
id|BusLogic_HardReset
)paren
suffix:semicolon
multiline_comment|/*&n;    Wait until Diagnostic Active is set in the Status Register.&n;  */
r_while
c_loop
(paren
op_decrement
id|TimeoutCounter
op_ge
l_int|0
)paren
(brace
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|StatusRegister
op_amp
id|BusLogic_DiagnosticActive
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TraceHardReset
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic_HardReset(0x%X): Diagnostic Active, Status 0x%02X&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
comma
id|StatusRegister
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TimeoutCounter
OL
l_int|0
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/*&n;    Wait until Diagnostic Active is reset in the Status Register.&n;  */
r_while
c_loop
(paren
op_decrement
id|TimeoutCounter
op_ge
l_int|0
)paren
(brace
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|StatusRegister
op_amp
id|BusLogic_DiagnosticActive
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TraceHardReset
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic_HardReset(0x%X): Diagnostic Completed, Status 0x%02X&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
comma
id|StatusRegister
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TimeoutCounter
OL
l_int|0
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/*&n;    Wait until at least one of the Diagnostic Failure, Host Adapter Ready,&n;    or Data In Register Ready bits is set in the Status Register.&n;  */
r_while
c_loop
(paren
op_decrement
id|TimeoutCounter
op_ge
l_int|0
)paren
(brace
id|StatusRegister
op_assign
id|BusLogic_ReadStatusRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|StatusRegister
op_amp
(paren
id|BusLogic_DiagnosticFailure
op_or
id|BusLogic_HostAdapterReady
op_or
id|BusLogic_DataInRegisterReady
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TraceHardReset
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic_HardReset(0x%X): Host Adapter Ready, Status 0x%02X&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
comma
id|StatusRegister
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TimeoutCounter
OL
l_int|0
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/*&n;    If Diagnostic Failure is set or Host Adapter Ready is reset, then an&n;    error occurred during the Host Adapter diagnostics.  If Data In Register&n;    Ready is set, then there is an Error Code available.&n;  */
r_if
c_cond
(paren
(paren
id|StatusRegister
op_amp
id|BusLogic_DiagnosticFailure
)paren
op_logical_or
op_logical_neg
(paren
id|StatusRegister
op_amp
id|BusLogic_HostAdapterReady
)paren
)paren
(brace
id|BusLogic_CommandFailureReason
op_assign
l_int|NULL
suffix:semicolon
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;HARD RESET DIAGNOSTICS&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HOST ADAPTER STATUS REGISTER = %02X&bslash;n&quot;
comma
id|StatusRegister
)paren
suffix:semicolon
r_if
c_cond
(paren
id|StatusRegister
op_amp
id|BusLogic_DataInRegisterReady
)paren
(brace
r_int
r_char
id|ErrorCode
op_assign
id|BusLogic_ReadDataInRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HOST ADAPTER ERROR CODE = %d&bslash;n&quot;
comma
id|ErrorCode
)paren
suffix:semicolon
)brace
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/*&n;    Indicate the Host Adapter Hard Reset completed successfully.&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_CheckHostAdapter checks to be sure this really is a BusLogic&n;  Host Adapter.&n;*/
DECL|function|BusLogic_CheckHostAdapter
r_static
id|boolean
id|BusLogic_CheckHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|BusLogic_ExtendedSetupInformation_T
id|ExtendedSetupInformation
suffix:semicolon
id|BusLogic_RequestedReplyLength_T
id|RequestedReplyLength
suffix:semicolon
r_int
r_int
id|ProcessorFlags
suffix:semicolon
r_int
id|Result
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Setup Information command.  Only genuine BusLogic Host&n;    Adapters and true clones support this command.  Adaptec 1542C series Host&n;    Adapters that respond to the Geometry Register I/O port will fail this&n;    command.  Interrupts must be disabled around the call to BusLogic_Command&n;    since a Command Complete interrupt could occur if the IRQ Channel was&n;    previously enabled for another BusLogic Host Adapter sharing the same IRQ&n;    Channel.&n;  */
id|save_flags
c_func
(paren
id|ProcessorFlags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|RequestedReplyLength
op_assign
r_sizeof
(paren
id|ExtendedSetupInformation
)paren
suffix:semicolon
id|Result
op_assign
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireExtendedSetupInformation
comma
op_amp
id|RequestedReplyLength
comma
r_sizeof
(paren
id|RequestedReplyLength
)paren
comma
op_amp
id|ExtendedSetupInformation
comma
r_sizeof
(paren
id|ExtendedSetupInformation
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|ProcessorFlags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_TracingOptions
op_amp
id|BusLogic_TraceProbe
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic_Check(0x%X): Result %d&bslash;n&quot;
comma
id|HostAdapter-&gt;IO_Address
comma
id|Result
)paren
suffix:semicolon
r_return
(paren
id|Result
op_eq
r_sizeof
(paren
id|ExtendedSetupInformation
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ReadHostAdapterConfiguration reads the Configuration Information&n;  from Host Adapter.&n;*/
DECL|function|BusLogic_ReadHostAdapterConfiguration
r_static
id|boolean
id|BusLogic_ReadHostAdapterConfiguration
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|BusLogic_BoardID_T
id|BoardID
suffix:semicolon
id|BusLogic_Configuration_T
id|Configuration
suffix:semicolon
id|BusLogic_SetupInformation_T
id|SetupInformation
suffix:semicolon
id|BusLogic_ExtendedSetupInformation_T
id|ExtendedSetupInformation
suffix:semicolon
id|BusLogic_ModelAndRevision_T
id|ModelAndRevision
suffix:semicolon
id|BusLogic_FirmwareVersion3rdDigit_T
id|FirmwareVersion3rdDigit
suffix:semicolon
id|BusLogic_FirmwareVersionLetter_T
id|FirmwareVersionLetter
suffix:semicolon
id|BusLogic_RequestedReplyLength_T
id|RequestedReplyLength
suffix:semicolon
r_int
r_char
id|GeometryRegister
comma
op_star
id|TargetPointer
comma
id|Character
suffix:semicolon
r_int
r_int
id|AllTargetsMask
comma
id|DisconnectPermitted
suffix:semicolon
r_int
r_int
id|TaggedQueuingPermitted
comma
id|TaggedQueuingPermittedDefault
suffix:semicolon
id|boolean
id|CommonErrorRecovery
suffix:semicolon
r_int
id|TargetID
comma
id|i
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Board ID command.&n;  */
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireBoardID
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|BoardID
comma
r_sizeof
(paren
id|BoardID
)paren
)paren
op_ne
r_sizeof
(paren
id|BoardID
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE BOARD ID&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Configuration command.&n;  */
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireConfiguration
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|Configuration
comma
r_sizeof
(paren
id|Configuration
)paren
)paren
op_ne
r_sizeof
(paren
id|Configuration
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE CONFIGURATION&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Setup Information command.&n;  */
id|RequestedReplyLength
op_assign
r_sizeof
(paren
id|SetupInformation
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireSetupInformation
comma
op_amp
id|RequestedReplyLength
comma
r_sizeof
(paren
id|RequestedReplyLength
)paren
comma
op_amp
id|SetupInformation
comma
r_sizeof
(paren
id|SetupInformation
)paren
)paren
op_ne
r_sizeof
(paren
id|SetupInformation
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE SETUP INFORMATION&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Extended Setup Information command.&n;  */
id|RequestedReplyLength
op_assign
r_sizeof
(paren
id|ExtendedSetupInformation
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireExtendedSetupInformation
comma
op_amp
id|RequestedReplyLength
comma
r_sizeof
(paren
id|RequestedReplyLength
)paren
comma
op_amp
id|ExtendedSetupInformation
comma
r_sizeof
(paren
id|ExtendedSetupInformation
)paren
)paren
op_ne
r_sizeof
(paren
id|ExtendedSetupInformation
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE EXTENDED SETUP INFORMATION&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Board Model and Revision command.&n;  */
id|RequestedReplyLength
op_assign
r_sizeof
(paren
id|ModelAndRevision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireBoardModelAndRevision
comma
op_amp
id|RequestedReplyLength
comma
r_sizeof
(paren
id|RequestedReplyLength
)paren
comma
op_amp
id|ModelAndRevision
comma
r_sizeof
(paren
id|ModelAndRevision
)paren
)paren
op_ne
r_sizeof
(paren
id|ModelAndRevision
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE BOARD MODEL AND REVISION&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Firmware Version 3rd Digit command.&n;  */
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireFirmwareVersion3rdDigit
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|FirmwareVersion3rdDigit
comma
r_sizeof
(paren
id|FirmwareVersion3rdDigit
)paren
)paren
op_ne
r_sizeof
(paren
id|FirmwareVersion3rdDigit
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE FIRMWARE 3RD DIGIT&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Firmware Version Letter command.&n;  */
id|FirmwareVersionLetter
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|BoardID.FirmwareVersion1stDigit
op_ge
l_char|&squot;3&squot;
)paren
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireFirmwareVersionLetter
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|FirmwareVersionLetter
comma
r_sizeof
(paren
id|FirmwareVersionLetter
)paren
)paren
op_ne
r_sizeof
(paren
id|FirmwareVersionLetter
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE FIRMWARE VERSION LETTER&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    BusLogic Host Adapters can be identified by their model number and&n;    the major version number of their firmware as follows:&n;&n;    4.xx&t;BusLogic &quot;C&quot; Series Host Adapters:&n;&t;&t;  946C/956C/956CD/747C/757C/757CD/445C/545C/540CF&n;    3.xx&t;BusLogic &quot;S&quot; Series Host Adapters:&n;&t;&t;  747S/747D/757S/757D/445S/545S/542D&n;&t;&t;  542B/742A (revision H)&n;    2.xx&t;BusLogic &quot;A&quot; Series Host Adapters:&n;&t;&t;  542B/742A (revision G and below)&n;    0.xx&t;AMI FastDisk VLB BusLogic Clone Host Adapter&n;  */
multiline_comment|/*&n;    Save the Model Name and Board Name in the Host Adapter structure.&n;  */
id|TargetPointer
op_assign
id|HostAdapter-&gt;ModelName
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ModelAndRevision.Model
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Character
op_assign
id|ModelAndRevision.Model
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|Character
op_eq
l_char|&squot; &squot;
op_logical_or
id|Character
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_break
suffix:semicolon
op_star
id|TargetPointer
op_increment
op_assign
id|Character
suffix:semicolon
)brace
op_star
id|TargetPointer
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|HostAdapter-&gt;BoardName
comma
l_string|&quot;BusLogic &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|HostAdapter-&gt;BoardName
comma
id|HostAdapter-&gt;ModelName
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|HostAdapter-&gt;InterruptLabel
comma
id|HostAdapter-&gt;BoardName
)paren
suffix:semicolon
multiline_comment|/*&n;    Save the Firmware Version in the Host Adapter structure.&n;  */
id|TargetPointer
op_assign
id|HostAdapter-&gt;FirmwareVersion
suffix:semicolon
op_star
id|TargetPointer
op_increment
op_assign
id|BoardID.FirmwareVersion1stDigit
suffix:semicolon
op_star
id|TargetPointer
op_increment
op_assign
l_char|&squot;.&squot;
suffix:semicolon
op_star
id|TargetPointer
op_increment
op_assign
id|BoardID.FirmwareVersion2ndDigit
suffix:semicolon
r_if
c_cond
(paren
id|FirmwareVersion3rdDigit
op_ne
l_char|&squot; &squot;
op_logical_and
id|FirmwareVersion3rdDigit
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_star
id|TargetPointer
op_increment
op_assign
id|FirmwareVersion3rdDigit
suffix:semicolon
r_if
c_cond
(paren
id|FirmwareVersionLetter
op_ne
l_char|&squot; &squot;
op_logical_and
id|FirmwareVersionLetter
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_star
id|TargetPointer
op_increment
op_assign
id|FirmwareVersionLetter
suffix:semicolon
op_star
id|TargetPointer
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/*&n;    Determine the IRQ Channel and save it in the Host Adapter structure.&n;  */
r_if
c_cond
(paren
id|Configuration.IRQ_Channel9
)paren
id|HostAdapter-&gt;IRQ_Channel
op_assign
l_int|9
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.IRQ_Channel10
)paren
id|HostAdapter-&gt;IRQ_Channel
op_assign
l_int|10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.IRQ_Channel11
)paren
id|HostAdapter-&gt;IRQ_Channel
op_assign
l_int|11
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.IRQ_Channel12
)paren
id|HostAdapter-&gt;IRQ_Channel
op_assign
l_int|12
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.IRQ_Channel14
)paren
id|HostAdapter-&gt;IRQ_Channel
op_assign
l_int|14
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.IRQ_Channel15
)paren
id|HostAdapter-&gt;IRQ_Channel
op_assign
l_int|15
suffix:semicolon
multiline_comment|/*&n;    Determine the DMA Channel and save it in the Host Adapter structure.&n;  */
r_if
c_cond
(paren
id|Configuration.DMA_Channel5
)paren
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|5
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.DMA_Channel6
)paren
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Configuration.DMA_Channel7
)paren
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|7
suffix:semicolon
multiline_comment|/*&n;    Save the Host Adapter SCSI ID in the Host Adapter structure.&n;  */
id|HostAdapter-&gt;SCSI_ID
op_assign
id|Configuration.HostAdapterID
suffix:semicolon
multiline_comment|/*&n;    Save the Synchronous Initiation flag and SCSI Parity Checking flag&n;    in the Host Adapter structure.&n;  */
id|HostAdapter-&gt;SynchronousInitiation
op_assign
id|SetupInformation.SynchronousInitiationEnabled
suffix:semicolon
id|HostAdapter-&gt;ParityChecking
op_assign
id|SetupInformation.ParityCheckEnabled
suffix:semicolon
multiline_comment|/*&n;    Determine the Bus Type and save it in the Host Adapter structure,&n;    overriding the DMA Channel if it is inappropriate for the bus type.&n;  */
r_if
c_cond
(paren
id|ExtendedSetupInformation.BusType
op_eq
l_char|&squot;A&squot;
)paren
id|HostAdapter-&gt;BusType
op_assign
id|BusLogic_ISA_Bus
suffix:semicolon
r_else
r_switch
c_cond
(paren
id|HostAdapter-&gt;ModelName
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;4&squot;
suffix:colon
id|HostAdapter-&gt;BusType
op_assign
id|BusLogic_VESA_Bus
suffix:semicolon
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;5&squot;
suffix:colon
id|HostAdapter-&gt;BusType
op_assign
id|BusLogic_ISA_Bus
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;6&squot;
suffix:colon
id|HostAdapter-&gt;BusType
op_assign
id|BusLogic_MCA_Bus
suffix:semicolon
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;7&squot;
suffix:colon
id|HostAdapter-&gt;BusType
op_assign
id|BusLogic_EISA_Bus
suffix:semicolon
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;9&squot;
suffix:colon
id|HostAdapter-&gt;BusType
op_assign
id|BusLogic_PCI_Bus
suffix:semicolon
id|HostAdapter-&gt;DMA_Channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;    Determine whether Extended Translation is enabled and save it in&n;    the Host Adapter structure.&n;  */
id|GeometryRegister
op_assign
id|BusLogic_ReadGeometryRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GeometryRegister
op_amp
id|BusLogic_ExtendedTranslationEnabled
)paren
id|HostAdapter-&gt;ExtendedTranslation
op_assign
l_bool|true
suffix:semicolon
multiline_comment|/*&n;    Save the Disconnect/Reconnect Permitted flag bits in the Host Adapter&n;    structure.  The Disconnect Permitted information is only valid on &quot;C&quot;&n;    Series boards, but Disconnect/Reconnect is always permitted on &quot;S&quot; and&n;    &quot;A&quot; Series boards.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|0
)braket
op_ge
l_char|&squot;4&squot;
)paren
id|HostAdapter-&gt;DisconnectPermitted
op_assign
(paren
id|SetupInformation.DisconnectPermittedID8to15
op_lshift
l_int|8
)paren
op_or
id|SetupInformation.DisconnectPermittedID0to7
suffix:semicolon
r_else
id|HostAdapter-&gt;DisconnectPermitted
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/*&n;    Save the Scatter Gather Limits, Level Triggered Interrupts flag,&n;    Wide SCSI flag, and Differential SCSI flag in the Host Adapter structure.&n;  */
id|HostAdapter-&gt;HostAdapterScatterGatherLimit
op_assign
id|ExtendedSetupInformation.ScatterGatherLimit
suffix:semicolon
id|HostAdapter-&gt;DriverScatterGatherLimit
op_assign
id|HostAdapter-&gt;HostAdapterScatterGatherLimit
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;HostAdapterScatterGatherLimit
OG
id|BusLogic_ScatterGatherLimit
)paren
id|HostAdapter-&gt;DriverScatterGatherLimit
op_assign
id|BusLogic_ScatterGatherLimit
suffix:semicolon
r_if
c_cond
(paren
id|ExtendedSetupInformation.Misc.LevelTriggeredInterrupts
)paren
id|HostAdapter-&gt;LevelTriggeredInterrupts
op_assign
l_bool|true
suffix:semicolon
r_if
c_cond
(paren
id|ExtendedSetupInformation.HostWideSCSI
)paren
(brace
id|HostAdapter-&gt;HostWideSCSI
op_assign
l_bool|true
suffix:semicolon
id|HostAdapter-&gt;MaxTargetIDs
op_assign
l_int|16
suffix:semicolon
id|HostAdapter-&gt;MaxLogicalUnits
op_assign
l_int|64
suffix:semicolon
)brace
r_else
(brace
id|HostAdapter-&gt;HostWideSCSI
op_assign
l_bool|false
suffix:semicolon
id|HostAdapter-&gt;MaxTargetIDs
op_assign
l_int|8
suffix:semicolon
id|HostAdapter-&gt;MaxLogicalUnits
op_assign
l_int|8
suffix:semicolon
)brace
id|HostAdapter-&gt;HostDifferentialSCSI
op_assign
id|ExtendedSetupInformation.HostDifferentialSCSI
suffix:semicolon
multiline_comment|/*&n;    Determine the Host Adapter BIOS Address if the BIOS is enabled and&n;    save it in the Host Adapter structure.  The BIOS is disabled if the&n;    BIOS_Address is 0.&n;  */
id|HostAdapter-&gt;BIOS_Address
op_assign
id|ExtendedSetupInformation.BIOS_Address
op_lshift
l_int|12
suffix:semicolon
multiline_comment|/*&n;    Select an appropriate value for Concurrency (Commands per Logical Unit)&n;    either from a Command Line Entry, or based on whether this is an ISA&n;    or non-ISA Host Adapter.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;CommandLineEntry
op_ne
l_int|NULL
op_logical_and
id|HostAdapter-&gt;CommandLineEntry-&gt;Concurrency
OG
l_int|0
)paren
id|HostAdapter-&gt;Concurrency
op_assign
id|HostAdapter-&gt;CommandLineEntry-&gt;Concurrency
suffix:semicolon
r_else
r_if
c_cond
(paren
id|HostAdapter-&gt;BusType
op_eq
id|BusLogic_ISA_Bus
)paren
id|HostAdapter-&gt;Concurrency
op_assign
id|BusLogic_Concurrency_ISA
suffix:semicolon
r_else
id|HostAdapter-&gt;Concurrency
op_assign
id|BusLogic_Concurrency
suffix:semicolon
multiline_comment|/*&n;    Select an appropriate value for Bus Settle Time either from a Command&n;    Line Entry, or from BusLogic_DefaultBusSettleTime.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;CommandLineEntry
op_ne
l_int|NULL
op_logical_and
id|HostAdapter-&gt;CommandLineEntry-&gt;BusSettleTime
OG
l_int|0
)paren
id|HostAdapter-&gt;BusSettleTime
op_assign
id|HostAdapter-&gt;CommandLineEntry-&gt;BusSettleTime
suffix:semicolon
r_else
id|HostAdapter-&gt;BusSettleTime
op_assign
id|BusLogic_DefaultBusSettleTime
suffix:semicolon
multiline_comment|/*&n;    Select appropriate values for the Error Recovery Option array either from&n;    a Command Line Entry, or using BusLogic_ErrorRecoveryDefault.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;CommandLineEntry
op_ne
l_int|NULL
)paren
id|memcpy
c_func
(paren
id|HostAdapter-&gt;ErrorRecoveryOption
comma
id|HostAdapter-&gt;CommandLineEntry-&gt;ErrorRecoveryOption
comma
r_sizeof
(paren
id|HostAdapter-&gt;ErrorRecoveryOption
)paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|HostAdapter-&gt;ErrorRecoveryOption
comma
id|BusLogic_ErrorRecoveryDefault
comma
r_sizeof
(paren
id|HostAdapter-&gt;ErrorRecoveryOption
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    Tagged Queuing support is available and operates properly only on &quot;C&quot;&n;    Series boards with firmware version 4.22 and above and on &quot;S&quot; Series&n;    boards with firmware version 3.35 and above.  Tagged Queuing is disabled&n;    by default when the Concurrency value is 1 since queuing multiple commands&n;    is not possible.&n;  */
id|TaggedQueuingPermittedDefault
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;Concurrency
OG
l_int|1
)paren
r_switch
c_cond
(paren
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;4&squot;
suffix:colon
r_if
c_cond
(paren
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|2
)braket
OG
l_char|&squot;2&squot;
op_logical_or
(paren
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|2
)braket
op_eq
l_char|&squot;2&squot;
op_logical_and
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|3
)braket
op_ge
l_char|&squot;2&squot;
)paren
)paren
id|TaggedQueuingPermittedDefault
op_assign
l_int|0xFFFF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;3&squot;
suffix:colon
r_if
c_cond
(paren
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|2
)braket
OG
l_char|&squot;3&squot;
op_logical_or
(paren
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|2
)braket
op_eq
l_char|&squot;3&squot;
op_logical_and
id|HostAdapter-&gt;FirmwareVersion
(braket
l_int|3
)braket
op_ge
l_char|&squot;5&squot;
)paren
)paren
id|TaggedQueuingPermittedDefault
op_assign
l_int|0xFFFF
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;    Combine the default Tagged Queuing permission based on the Host Adapter&n;    firmware version and Concurrency with any Command Line Entry Tagged&n;    Queuing specification.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;CommandLineEntry
op_ne
l_int|NULL
)paren
id|HostAdapter-&gt;TaggedQueuingPermitted
op_assign
(paren
id|HostAdapter-&gt;CommandLineEntry-&gt;TaggedQueuingPermitted
op_amp
id|HostAdapter-&gt;CommandLineEntry-&gt;TaggedQueuingPermittedMask
)paren
op_or
(paren
id|TaggedQueuingPermittedDefault
op_amp
op_complement
id|HostAdapter-&gt;CommandLineEntry-&gt;TaggedQueuingPermittedMask
)paren
suffix:semicolon
r_else
id|HostAdapter-&gt;TaggedQueuingPermitted
op_assign
id|TaggedQueuingPermittedDefault
suffix:semicolon
multiline_comment|/*&n;    Announce the Host Adapter Configuration.&n;  */
id|printk
c_func
(paren
l_string|&quot;scsi%d: Configuring BusLogic Model %s %s%s%s SCSI Host Adapter&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;ModelName
comma
id|BusLogic_BusNames
(braket
id|HostAdapter-&gt;BusType
)braket
comma
(paren
id|HostAdapter-&gt;HostWideSCSI
ques
c_cond
l_string|&quot; Wide&quot;
suffix:colon
l_string|&quot;&quot;
)paren
comma
(paren
id|HostAdapter-&gt;HostDifferentialSCSI
ques
c_cond
l_string|&quot; Differential&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Firmware Version: %s, I/O Address: 0x%X, &quot;
l_string|&quot;IRQ Channel: %d/%s&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;FirmwareVersion
comma
id|HostAdapter-&gt;IO_Address
comma
id|HostAdapter-&gt;IRQ_Channel
comma
(paren
id|HostAdapter-&gt;LevelTriggeredInterrupts
ques
c_cond
l_string|&quot;Level&quot;
suffix:colon
l_string|&quot;Edge&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   DMA Channel: &quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;DMA_Channel
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%d, &quot;
comma
id|HostAdapter-&gt;DMA_Channel
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;None, &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;BIOS_Address
OG
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;BIOS Address: 0x%lX, &quot;
comma
id|HostAdapter-&gt;BIOS_Address
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;BIOS Address: None, &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Host Adapter SCSI ID: %d&bslash;n&quot;
comma
id|HostAdapter-&gt;SCSI_ID
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Scatter/Gather Limit: %d segments, &quot;
l_string|&quot;Synchronous Initiation: %s&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;HostAdapterScatterGatherLimit
comma
(paren
id|HostAdapter-&gt;SynchronousInitiation
ques
c_cond
l_string|&quot;Enabled&quot;
suffix:colon
l_string|&quot;Disabled&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   SCSI Parity Checking: %s, &quot;
l_string|&quot;Extended Disk Translation: %s&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
(paren
id|HostAdapter-&gt;ParityChecking
ques
c_cond
l_string|&quot;Enabled&quot;
suffix:colon
l_string|&quot;Disabled&quot;
)paren
comma
(paren
id|HostAdapter-&gt;ExtendedTranslation
ques
c_cond
l_string|&quot;Enabled&quot;
suffix:colon
l_string|&quot;Disabled&quot;
)paren
)paren
suffix:semicolon
id|AllTargetsMask
op_assign
(paren
l_int|1
op_lshift
id|HostAdapter-&gt;MaxTargetIDs
)paren
op_minus
l_int|1
suffix:semicolon
id|DisconnectPermitted
op_assign
id|HostAdapter-&gt;DisconnectPermitted
op_amp
id|AllTargetsMask
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Disconnect/Reconnect: &quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DisconnectPermitted
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Disabled&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|DisconnectPermitted
op_eq
id|AllTargetsMask
)paren
id|printk
c_func
(paren
l_string|&quot;Enabled&quot;
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|0
suffix:semicolon
id|TargetID
OL
id|HostAdapter-&gt;MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
(paren
id|DisconnectPermitted
op_amp
(paren
l_int|1
op_lshift
id|TargetID
)paren
)paren
ques
c_cond
l_char|&squot;Y&squot;
suffix:colon
l_char|&squot;N&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, Tagged Queuing: &quot;
)paren
suffix:semicolon
id|TaggedQueuingPermitted
op_assign
id|HostAdapter-&gt;TaggedQueuingPermitted
op_amp
id|AllTargetsMask
suffix:semicolon
r_if
c_cond
(paren
id|TaggedQueuingPermitted
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Disabled&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|TaggedQueuingPermitted
op_eq
id|AllTargetsMask
)paren
id|printk
c_func
(paren
l_string|&quot;Enabled&quot;
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|0
suffix:semicolon
id|TargetID
OL
id|HostAdapter-&gt;MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
(paren
id|TaggedQueuingPermitted
op_amp
(paren
l_int|1
op_lshift
id|TargetID
)paren
)paren
ques
c_cond
l_char|&squot;Y&squot;
suffix:colon
l_char|&squot;N&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|CommonErrorRecovery
op_assign
l_bool|true
suffix:semicolon
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|1
suffix:semicolon
id|TargetID
OL
id|HostAdapter-&gt;MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
r_if
c_cond
(paren
id|HostAdapter-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
op_ne
id|HostAdapter-&gt;ErrorRecoveryOption
(braket
l_int|0
)braket
)paren
(brace
id|CommonErrorRecovery
op_assign
l_bool|false
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Error Recovery: &quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CommonErrorRecovery
)paren
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|BusLogic_ErrorRecoveryOptions
(braket
id|HostAdapter-&gt;ErrorRecoveryOption
(braket
l_int|0
)braket
)braket
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|0
suffix:semicolon
id|TargetID
OL
id|HostAdapter-&gt;MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|BusLogic_ErrorRecoveryOptions2
(braket
id|HostAdapter-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, Mailboxes: %d, Initial CCBs: %d&bslash;n&quot;
comma
id|BusLogic_MailboxCount
comma
id|BusLogic_InitialCCBs
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Driver Scatter/Gather Limit: %d segments, &quot;
l_string|&quot;Concurrency: %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;DriverScatterGatherLimit
comma
id|HostAdapter-&gt;Concurrency
)paren
suffix:semicolon
multiline_comment|/*&n;    Indicate reading the Host Adapter Configuration completed successfully.&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_AcquireResources acquires the system resources necessary to use Host&n;  Adapter, and initializes the fields in the SCSI Host structure.  The base,&n;  io_port, n_io_ports, irq, and dma_channel fields in the SCSI Host structure&n;  are intentionally left uninitialized, as this driver handles acquisition and&n;  release of these resources explicitly, as well as ensuring exclusive access&n;  to the Host Adapter hardware and data structures through explicit locking.&n;*/
DECL|function|BusLogic_AcquireResources
r_static
id|boolean
id|BusLogic_AcquireResources
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
comma
id|SCSI_Host_T
op_star
id|Host
)paren
(brace
multiline_comment|/*&n;    Acquire exclusive or shared access to the IRQ Channel.  A usage count is&n;    maintained so that PCI, EISA, or MCA shared Interrupts can be supported.&n;  */
r_if
c_cond
(paren
id|BusLogic_IRQ_UsageCount
(braket
id|HostAdapter-&gt;IRQ_Channel
op_minus
l_int|9
)braket
op_increment
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|HostAdapter-&gt;IRQ_Channel
comma
id|BusLogic_InterruptHandler
comma
id|SA_INTERRUPT
comma
id|HostAdapter-&gt;InterruptLabel
)paren
OL
l_int|0
)paren
(brace
id|BusLogic_IRQ_UsageCount
(braket
id|HostAdapter-&gt;IRQ_Channel
op_minus
l_int|9
)braket
op_decrement
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: UNABLE TO ACQUIRE IRQ CHANNEL %d - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;IRQ_Channel
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
)brace
r_else
(brace
id|BusLogic_HostAdapter_T
op_star
id|FirstHostAdapter
op_assign
id|BusLogic_RegisteredHostAdapters
suffix:semicolon
r_while
c_loop
(paren
id|FirstHostAdapter
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|FirstHostAdapter-&gt;IRQ_Channel
op_eq
id|HostAdapter-&gt;IRQ_Channel
)paren
(brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|FirstHostAdapter-&gt;InterruptLabel
)paren
op_plus
l_int|8
OL
r_sizeof
(paren
id|FirstHostAdapter-&gt;InterruptLabel
)paren
)paren
(brace
id|strcat
c_func
(paren
id|FirstHostAdapter-&gt;InterruptLabel
comma
l_string|&quot; + &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|FirstHostAdapter-&gt;InterruptLabel
comma
id|HostAdapter-&gt;ModelName
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|FirstHostAdapter
op_assign
id|FirstHostAdapter-&gt;Next
suffix:semicolon
)brace
)brace
id|HostAdapter-&gt;IRQ_ChannelAcquired
op_assign
l_bool|true
suffix:semicolon
multiline_comment|/*&n;    Acquire exclusive access to the DMA Channel.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;DMA_Channel
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|HostAdapter-&gt;DMA_Channel
comma
id|HostAdapter-&gt;BoardName
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: UNABLE TO ACQUIRE DMA CHANNEL %d - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;DMA_Channel
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
id|set_dma_mode
c_func
(paren
id|HostAdapter-&gt;DMA_Channel
comma
id|DMA_MODE_CASCADE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|HostAdapter-&gt;DMA_Channel
)paren
suffix:semicolon
id|HostAdapter-&gt;DMA_ChannelAcquired
op_assign
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;    Initialize necessary fields in the SCSI Host structure.&n;  */
id|Host-&gt;max_id
op_assign
id|HostAdapter-&gt;MaxTargetIDs
suffix:semicolon
id|Host-&gt;max_lun
op_assign
id|HostAdapter-&gt;MaxLogicalUnits
suffix:semicolon
id|Host-&gt;max_channel
op_assign
l_int|0
suffix:semicolon
id|Host-&gt;this_id
op_assign
id|HostAdapter-&gt;SCSI_ID
suffix:semicolon
id|Host-&gt;can_queue
op_assign
id|BusLogic_MailboxCount
suffix:semicolon
id|Host-&gt;cmd_per_lun
op_assign
id|HostAdapter-&gt;Concurrency
suffix:semicolon
id|Host-&gt;sg_tablesize
op_assign
id|HostAdapter-&gt;DriverScatterGatherLimit
suffix:semicolon
id|Host-&gt;unchecked_isa_dma
op_assign
(paren
id|HostAdapter-&gt;BusType
op_eq
id|BusLogic_ISA_Bus
)paren
suffix:semicolon
multiline_comment|/*&n;    BusLogic 445S Host Adapters prior to board revision D have a hardware bug&n;    whereby when the BIOS is enabled, transfers to/from the same address range&n;    the BIOS occupies modulo 16MB are handled incorrectly.  Since 16KB out of&n;    each 16MB after the first is such a small amount of memory, this memory&n;    can be marked as reserved without a significant loss of performance; this&n;    is a much cheaper solution than requiring that ISA bounce buffers be used.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;BIOS_Address
OG
l_int|0
op_logical_and
id|strcmp
c_func
(paren
id|HostAdapter-&gt;ModelName
comma
l_string|&quot;445S&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|Host-&gt;forbidden_addr
op_assign
id|HostAdapter-&gt;BIOS_Address
suffix:semicolon
id|Host-&gt;forbidden_size
op_assign
l_int|16
op_star
l_int|1024
suffix:semicolon
)brace
multiline_comment|/*&n;    Indicate the System Resource Acquisition completed successfully,&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ReleaseResources releases any system resources previously acquired&n;  by BusLogic_AcquireResources.&n;*/
DECL|function|BusLogic_ReleaseResources
r_static
r_void
id|BusLogic_ReleaseResources
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
multiline_comment|/*&n;    Release exclusive or shared access to the IRQ Channel.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;IRQ_ChannelAcquired
)paren
r_if
c_cond
(paren
op_decrement
id|BusLogic_IRQ_UsageCount
(braket
id|HostAdapter-&gt;IRQ_Channel
op_minus
l_int|9
)braket
op_eq
l_int|0
)paren
id|free_irq
c_func
(paren
id|HostAdapter-&gt;IRQ_Channel
)paren
suffix:semicolon
multiline_comment|/*&n;    Release exclusive access to the DMA Channel.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;DMA_ChannelAcquired
)paren
id|free_dma
c_func
(paren
id|HostAdapter-&gt;DMA_Channel
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_TestInterrupts tests for proper functioning of the Host Adapter&n;  Interrupt Register and that interrupts generated by the Host Adapter are&n;  getting through to the Interrupt Handler.  A large proportion of initial&n;  problems with installing PCI Host Adapters are due to configuration problems&n;  where either the Host Adapter or Motherboard is configured incorrectly, and&n;  interrupts do not get through as a result.&n;*/
DECL|function|BusLogic_TestInterrupts
r_static
id|boolean
id|BusLogic_TestInterrupts
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
r_int
r_int
id|InitialInterruptCount
comma
id|FinalInterruptCount
suffix:semicolon
r_int
id|TestCount
op_assign
l_int|5
comma
id|i
suffix:semicolon
id|InitialInterruptCount
op_assign
id|kstat.interrupts
(braket
id|HostAdapter-&gt;IRQ_Channel
)braket
suffix:semicolon
multiline_comment|/*&n;    Issue the Test Command Complete Interrupt commands.&n;  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TestCount
suffix:semicolon
id|i
op_increment
)paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_TestCommandCompleteInterrupt
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;    Verify that BusLogic_InterruptHandler was called at least TestCount times.&n;    Shared IRQ Channels could cause more than TestCount interrupts to occur,&n;    but there should never be fewer than TestCount.&n;  */
id|FinalInterruptCount
op_assign
id|kstat.interrupts
(braket
id|HostAdapter-&gt;IRQ_Channel
)braket
suffix:semicolon
r_if
c_cond
(paren
id|FinalInterruptCount
OL
id|InitialInterruptCount
op_plus
id|TestCount
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: HOST ADAPTER INTERRUPT TEST FAILED - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  Interrupts are not getting through &quot;
l_string|&quot;from the Host Adapter to the&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  BusLogic Driver Interrupt Handler.  &quot;
l_string|&quot;The most likely cause is that&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  either the Host Adapter or Motherboard &quot;
l_string|&quot;is configured incorrectly.&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  Please check the Host Adapter configuration &quot;
l_string|&quot;with AutoSCSI or by&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  examining any dip switch and jumper settings &quot;
l_string|&quot;on the Host Adapter, and&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  verify that no other device is attempting to &quot;
l_string|&quot;use the same IRQ Channel.&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  For PCI Host Adapters, it may also be necessary &quot;
l_string|&quot;to investigate and&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  manually set the PCI interrupt assignments &quot;
l_string|&quot;and edge/level interrupt&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:  type selection in the BIOS Setup Program or &quot;
l_string|&quot;with Motherboard jumpers.&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/*&n;    Indicate the Host Adapter Interrupt Test completed successfully.&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_InitializeHostAdapter initializes Host Adapter.  This is the only&n;  function called during SCSI Host Adapter detection which modifies the state&n;  of the Host Adapter from its initial power on or hard reset state.&n;*/
DECL|function|BusLogic_InitializeHostAdapter
r_static
id|boolean
id|BusLogic_InitializeHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|BusLogic_ExtendedMailboxRequest_T
id|ExtendedMailboxRequest
suffix:semicolon
id|BusLogic_RoundRobinModeRequest_T
id|RoundRobinModeRequest
suffix:semicolon
id|BusLogic_WideModeCCBRequest_T
id|WideModeCCBRequest
suffix:semicolon
id|BusLogic_ModifyIOAddressRequest_T
id|ModifyIOAddressRequest
suffix:semicolon
multiline_comment|/*&n;    Initialize Read/Write Operation Count and Command Successful Flag&n;    for each Target.&n;  */
id|memset
c_func
(paren
id|HostAdapter-&gt;ReadWriteOperationCount
comma
l_int|0
comma
r_sizeof
(paren
id|HostAdapter-&gt;ReadWriteOperationCount
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|HostAdapter-&gt;CommandSuccessfulFlag
comma
l_bool|false
comma
r_sizeof
(paren
id|HostAdapter-&gt;CommandSuccessfulFlag
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    Initialize the Outgoing and Incoming Mailbox structures.&n;  */
id|memset
c_func
(paren
id|HostAdapter-&gt;OutgoingMailboxes
comma
l_int|0
comma
r_sizeof
(paren
id|HostAdapter-&gt;OutgoingMailboxes
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|HostAdapter-&gt;IncomingMailboxes
comma
l_int|0
comma
r_sizeof
(paren
id|HostAdapter-&gt;IncomingMailboxes
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    Initialize the pointers to the First, Last, and Next Mailboxes.&n;  */
id|HostAdapter-&gt;FirstOutgoingMailbox
op_assign
op_amp
id|HostAdapter-&gt;OutgoingMailboxes
(braket
l_int|0
)braket
suffix:semicolon
id|HostAdapter-&gt;LastOutgoingMailbox
op_assign
op_amp
id|HostAdapter-&gt;OutgoingMailboxes
(braket
id|BusLogic_MailboxCount
op_minus
l_int|1
)braket
suffix:semicolon
id|HostAdapter-&gt;NextOutgoingMailbox
op_assign
id|HostAdapter-&gt;FirstOutgoingMailbox
suffix:semicolon
id|HostAdapter-&gt;FirstIncomingMailbox
op_assign
op_amp
id|HostAdapter-&gt;IncomingMailboxes
(braket
l_int|0
)braket
suffix:semicolon
id|HostAdapter-&gt;LastIncomingMailbox
op_assign
op_amp
id|HostAdapter-&gt;IncomingMailboxes
(braket
id|BusLogic_MailboxCount
op_minus
l_int|1
)braket
suffix:semicolon
id|HostAdapter-&gt;NextIncomingMailbox
op_assign
id|HostAdapter-&gt;FirstIncomingMailbox
suffix:semicolon
multiline_comment|/*&n;    Initialize the Host Adapter&squot;s Pointer to the Outgoing/Incoming Mailboxes.&n;  */
id|ExtendedMailboxRequest.MailboxCount
op_assign
id|BusLogic_MailboxCount
suffix:semicolon
id|ExtendedMailboxRequest.BaseMailboxAddress
op_assign
id|HostAdapter-&gt;OutgoingMailboxes
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InitializeExtendedMailbox
comma
op_amp
id|ExtendedMailboxRequest
comma
r_sizeof
(paren
id|ExtendedMailboxRequest
)paren
comma
l_int|NULL
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: MAILBOX INITIALIZATION FAILED - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/*&n;    Enable Strict Round Robin Mode if supported by the Host Adapter.  In Strict&n;    Round Robin Mode, the Host Adapter only looks at the next Outgoing Mailbox&n;    for each new command, rather than scanning through all the Outgoing&n;    Mailboxes to find any that have new commands in them.  BusLogic indicates&n;    that Strict Round Robin Mode is significantly more efficient.&n;  */
id|RoundRobinModeRequest
op_assign
id|BusLogic_StrictRoundRobinMode
suffix:semicolon
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_EnableStrictRoundRobinMode
comma
op_amp
id|RoundRobinModeRequest
comma
r_sizeof
(paren
id|RoundRobinModeRequest
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;    For Wide SCSI Host Adapters, issue the Enable Wide Mode CCB command to&n;    allow more than 8 Logical Units per Target to be supported.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;HostWideSCSI
)paren
(brace
id|WideModeCCBRequest
op_assign
id|BusLogic_WideModeCCB
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_EnableWideModeCCB
comma
op_amp
id|WideModeCCBRequest
comma
r_sizeof
(paren
id|WideModeCCBRequest
)paren
comma
l_int|NULL
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: ENABLE WIDE MODE CCB FAILED - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;    For PCI Host Adapters being accessed through the PCI compliant I/O&n;    Address, disable the ISA compatible I/O Address to avoid detecting the&n;    same Host Adapter at both I/O Addresses.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;BusType
op_eq
id|BusLogic_PCI_Bus
)paren
(brace
r_int
id|Index
suffix:semicolon
r_for
c_loop
(paren
id|Index
op_assign
l_int|0
suffix:semicolon
id|BusLogic_IO_StandardAddresses
(braket
id|Index
)braket
OG
l_int|0
suffix:semicolon
id|Index
op_increment
)paren
r_if
c_cond
(paren
id|HostAdapter-&gt;IO_Address
op_eq
id|BusLogic_IO_StandardAddresses
(braket
id|Index
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_IO_StandardAddresses
(braket
id|Index
)braket
op_eq
l_int|0
)paren
(brace
id|ModifyIOAddressRequest
op_assign
id|BusLogic_ModifyIO_Disable
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_ModifyIOAddress
comma
op_amp
id|ModifyIOAddressRequest
comma
r_sizeof
(paren
id|ModifyIOAddressRequest
)paren
comma
l_int|NULL
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: MODIFY I/O ADDRESS FAILED - DETACHING&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;    Announce Successful Initialization.&n;  */
id|printk
c_func
(paren
l_string|&quot;scsi%d: *** %s Initialized Successfully ***&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;BoardName
)paren
suffix:semicolon
multiline_comment|/*&n;    Indicate the Host Adapter Initialization completed successfully.&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_InquireTargetDevices inquires about the Target Devices accessible&n;  through Host Adapter and reports on the results.&n;*/
DECL|function|BusLogic_InquireTargetDevices
r_static
id|boolean
id|BusLogic_InquireTargetDevices
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
)paren
(brace
id|BusLogic_InstalledDevices8_T
id|InstalledDevicesID0to7
suffix:semicolon
id|BusLogic_InstalledDevices8_T
id|InstalledDevicesID8to15
suffix:semicolon
id|BusLogic_SetupInformation_T
id|SetupInformation
suffix:semicolon
id|BusLogic_SynchronousPeriod_T
id|SynchronousPeriod
suffix:semicolon
id|BusLogic_RequestedReplyLength_T
id|RequestedReplyLength
suffix:semicolon
r_int
id|TargetDevicesFound
op_assign
l_int|0
comma
id|TargetID
suffix:semicolon
multiline_comment|/*&n;    Wait a few seconds between the Host Adapter Hard Reset which initiates&n;    a SCSI Bus Reset and issuing any SCSI commands.  Some SCSI devices get&n;    confused if they receive SCSI commands too soon after a SCSI Bus Reset.&n;  */
id|BusLogic_Delay
c_func
(paren
id|HostAdapter-&gt;BusSettleTime
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Installed Devices ID 0 to 7 command, and for Wide SCSI&n;    Host Adapters the Inquire Installed Devices ID 8 to 15 command.  This is&n;    necessary to force Synchronous Transfer Negotiation so that the Inquire&n;    Setup Information and Inquire Synchronous Period commands will return&n;    valid data.&n;  */
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireInstalledDevicesID0to7
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|InstalledDevicesID0to7
comma
r_sizeof
(paren
id|InstalledDevicesID0to7
)paren
)paren
op_ne
r_sizeof
(paren
id|InstalledDevicesID0to7
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE INSTALLED DEVICES ID 0 TO 7&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;HostWideSCSI
)paren
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireInstalledDevicesID8to15
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|InstalledDevicesID8to15
comma
r_sizeof
(paren
id|InstalledDevicesID8to15
)paren
)paren
op_ne
r_sizeof
(paren
id|InstalledDevicesID8to15
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE INSTALLED DEVICES ID 8 TO 15&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Setup Information command.&n;  */
id|RequestedReplyLength
op_assign
r_sizeof
(paren
id|SetupInformation
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireSetupInformation
comma
op_amp
id|RequestedReplyLength
comma
r_sizeof
(paren
id|RequestedReplyLength
)paren
comma
op_amp
id|SetupInformation
comma
r_sizeof
(paren
id|SetupInformation
)paren
)paren
op_ne
r_sizeof
(paren
id|SetupInformation
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE SETUP INFORMATION&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Issue the Inquire Synchronous Period command.&n;  */
id|RequestedReplyLength
op_assign
r_sizeof
(paren
id|SynchronousPeriod
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_Command
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InquireSynchronousPeriod
comma
op_amp
id|RequestedReplyLength
comma
l_int|1
comma
op_amp
id|SynchronousPeriod
comma
r_sizeof
(paren
id|SynchronousPeriod
)paren
)paren
op_ne
r_sizeof
(paren
id|SynchronousPeriod
)paren
)paren
r_return
id|BusLogic_Failure
c_func
(paren
id|HostAdapter
comma
l_string|&quot;INQUIRE SYNCHRONOUS PERIOD&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    Save the Installed Devices, Synchronous Values, and Synchronous Period&n;    information in the Host Adapter structure.&n;  */
id|memcpy
c_func
(paren
id|HostAdapter-&gt;InstalledDevices
comma
id|InstalledDevicesID0to7
comma
r_sizeof
(paren
id|BusLogic_InstalledDevices8_T
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|HostAdapter-&gt;SynchronousValues
comma
id|SetupInformation.SynchronousValuesID0to7
comma
r_sizeof
(paren
id|BusLogic_SynchronousValues8_T
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;HostWideSCSI
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|HostAdapter-&gt;InstalledDevices
(braket
l_int|8
)braket
comma
id|InstalledDevicesID8to15
comma
r_sizeof
(paren
id|BusLogic_InstalledDevices8_T
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|HostAdapter-&gt;SynchronousValues
(braket
l_int|8
)braket
comma
id|SetupInformation.SynchronousValuesID8to15
comma
r_sizeof
(paren
id|BusLogic_SynchronousValues8_T
)paren
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|HostAdapter-&gt;SynchronousPeriod
comma
id|SynchronousPeriod
comma
r_sizeof
(paren
id|BusLogic_SynchronousPeriod_T
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|0
suffix:semicolon
id|TargetID
OL
id|HostAdapter-&gt;MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
r_if
c_cond
(paren
id|HostAdapter-&gt;InstalledDevices
(braket
id|TargetID
)braket
op_ne
l_int|0
)paren
(brace
r_int
id|SynchronousPeriod
op_assign
id|HostAdapter-&gt;SynchronousPeriod
(braket
id|TargetID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SynchronousPeriod
OG
l_int|10
)paren
(brace
r_int
id|SynchronousTransferRate
op_assign
l_int|100000000
op_div
id|SynchronousPeriod
suffix:semicolon
r_int
id|RoundedSynchronousTransferRate
op_assign
(paren
id|SynchronousTransferRate
op_plus
l_int|5000
)paren
op_div
l_int|10000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Target %d: Synchronous at &quot;
l_string|&quot;%d.%02d mega-transfers/sec, offset %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|TargetID
comma
id|RoundedSynchronousTransferRate
op_div
l_int|100
comma
id|RoundedSynchronousTransferRate
op_mod
l_int|100
comma
id|HostAdapter-&gt;SynchronousValues
(braket
id|TargetID
)braket
dot
id|Offset
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SynchronousPeriod
OG
l_int|0
)paren
(brace
r_int
id|SynchronousTransferRate
op_assign
l_int|100000000
op_div
id|SynchronousPeriod
suffix:semicolon
r_int
id|RoundedSynchronousTransferRate
op_assign
(paren
id|SynchronousTransferRate
op_plus
l_int|50000
)paren
op_div
l_int|100000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Target %d: Synchronous at &quot;
l_string|&quot;%d.%01d mega-transfers/sec, offset %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|TargetID
comma
id|RoundedSynchronousTransferRate
op_div
l_int|10
comma
id|RoundedSynchronousTransferRate
op_mod
l_int|10
comma
id|HostAdapter-&gt;SynchronousValues
(braket
id|TargetID
)braket
dot
id|Offset
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;scsi%d:   Target %d: Asynchronous&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|TargetID
)paren
suffix:semicolon
id|TargetDevicesFound
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TargetDevicesFound
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d:   No Target Devices Found&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
multiline_comment|/*&n;    Indicate the Target Device Inquiry completed successfully.&n;  */
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_DetectHostAdapter probes for BusLogic Host Adapters at the standard&n;  I/O Addresses where they may be located, initializing, registering, and&n;  reporting the configuration of each BusLogic Host Adapter it finds.  It&n;  returns the number of BusLogic Host Adapters successfully initialized and&n;  registered.&n;*/
DECL|function|BusLogic_DetectHostAdapter
r_int
id|BusLogic_DetectHostAdapter
c_func
(paren
id|SCSI_Host_Template_T
op_star
id|HostTemplate
)paren
(brace
r_int
id|BusLogicHostAdapterCount
op_assign
l_int|0
comma
id|CommandLineEntryIndex
op_assign
l_int|0
suffix:semicolon
r_int
id|AddressProbeIndex
op_assign
l_int|0
suffix:semicolon
id|BusLogic_InitializeAddressProbeList
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|BusLogic_IO_AddressProbeList
(braket
id|AddressProbeIndex
)braket
OG
l_int|0
)paren
(brace
id|BusLogic_HostAdapter_T
id|HostAdapterPrototype
suffix:semicolon
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
op_amp
id|HostAdapterPrototype
suffix:semicolon
id|SCSI_Host_T
op_star
id|Host
suffix:semicolon
id|memset
c_func
(paren
id|HostAdapter
comma
l_int|0
comma
r_sizeof
(paren
id|BusLogic_HostAdapter_T
)paren
)paren
suffix:semicolon
id|HostAdapter-&gt;IO_Address
op_assign
id|BusLogic_IO_AddressProbeList
(braket
id|AddressProbeIndex
op_increment
)braket
suffix:semicolon
multiline_comment|/*&n;&t;Initialize the Command Line Entry field if an explicit I/O Address&n;&t;was specified.&n;      */
r_if
c_cond
(paren
id|CommandLineEntryIndex
OL
id|BusLogic_CommandLineEntryCount
op_logical_and
id|BusLogic_CommandLineEntries
(braket
id|CommandLineEntryIndex
)braket
dot
id|IO_Address
op_eq
id|HostAdapter-&gt;IO_Address
)paren
id|HostAdapter-&gt;CommandLineEntry
op_assign
op_amp
id|BusLogic_CommandLineEntries
(braket
id|CommandLineEntryIndex
op_increment
)braket
suffix:semicolon
multiline_comment|/*&n;&t;Check whether the I/O Address range is already in use.&n;      */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|HostAdapter-&gt;IO_Address
comma
id|BusLogic_IO_PortCount
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;Probe the Host Adapter.  If unsuccessful, abort further initialization.&n;      */
r_if
c_cond
(paren
op_logical_neg
id|BusLogic_ProbeHostAdapter
c_func
(paren
id|HostAdapter
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;Hard Reset the Host Adapter.  If unsuccessful, abort further&n;&t;initialization.&n;      */
r_if
c_cond
(paren
op_logical_neg
id|BusLogic_HardResetHostAdapter
c_func
(paren
id|HostAdapter
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;Check the Host Adapter.  If unsuccessful, abort further initialization.&n;      */
r_if
c_cond
(paren
op_logical_neg
id|BusLogic_CheckHostAdapter
c_func
(paren
id|HostAdapter
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;Initialize the Command Line Entry field if an explicit I/O Address&n;&t;was not specified.&n;      */
r_if
c_cond
(paren
id|CommandLineEntryIndex
OL
id|BusLogic_CommandLineEntryCount
op_logical_and
id|BusLogic_CommandLineEntries
(braket
id|CommandLineEntryIndex
)braket
dot
id|IO_Address
op_eq
l_int|0
)paren
id|HostAdapter-&gt;CommandLineEntry
op_assign
op_amp
id|BusLogic_CommandLineEntries
(braket
id|CommandLineEntryIndex
op_increment
)braket
suffix:semicolon
multiline_comment|/*&n;&t;Announce the Driver Version and Date, Author&squot;s Name, Copyright Notice,&n;&t;and Contact Address.&n;      */
id|BusLogic_AnnounceDriver
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;Register usage of the I/O Address range.  From this point onward, any&n;&t;failure will be assumed to be due to a problem with the Host Adapter,&n;&t;rather than due to having mistakenly identified this port as belonging&n;&t;to a BusLogic Host Adapter.  The I/O Address range will not be&n;&t;released, thereby preventing it from being incorrectly identified as&n;&t;any other type of Host Adapter.&n;      */
id|request_region
c_func
(paren
id|HostAdapter-&gt;IO_Address
comma
id|BusLogic_IO_PortCount
comma
l_string|&quot;BusLogic&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;Register the SCSI Host structure.&n;      */
id|HostTemplate-&gt;proc_dir
op_assign
op_amp
id|BusLogic_ProcDirectoryEntry
suffix:semicolon
id|Host
op_assign
id|scsi_register
c_func
(paren
id|HostTemplate
comma
r_sizeof
(paren
id|BusLogic_HostAdapter_T
)paren
)paren
suffix:semicolon
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Host-&gt;hostdata
suffix:semicolon
id|memcpy
c_func
(paren
id|HostAdapter
comma
op_amp
id|HostAdapterPrototype
comma
r_sizeof
(paren
id|BusLogic_HostAdapter_T
)paren
)paren
suffix:semicolon
id|HostAdapter-&gt;SCSI_Host
op_assign
id|Host
suffix:semicolon
id|HostAdapter-&gt;HostNumber
op_assign
id|Host-&gt;host_no
suffix:semicolon
multiline_comment|/*&n;&t;Add Host Adapter to the end of the list of registered BusLogic&n;&t;Host Adapters.  In order for Command Complete Interrupts to be&n;&t;properly dismissed by BusLogic_InterruptHandler, the Host Adapter&n;&t;must be registered.  This must be done before the IRQ Channel is&n;&t;acquired, and in a shared IRQ Channel environment, must be done&n;&t;before any Command Complete Interrupts occur, since the IRQ Channel&n;&t;may have already been acquired by a previous BusLogic Host Adapter.&n;      */
id|BusLogic_RegisterHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
multiline_comment|/*&n;&t;Read the Host Adapter Configuration, Acquire the System Resources&n;&t;necessary to use Host Adapter and initialize the fields in the SCSI&n;&t;Host structure, then Test Interrupts, Create the CCBs, and finally&n;&t;Initialize the Host Adapter.&n;      */
r_if
c_cond
(paren
id|BusLogic_ReadHostAdapterConfiguration
c_func
(paren
id|HostAdapter
)paren
op_logical_and
id|BusLogic_AcquireResources
c_func
(paren
id|HostAdapter
comma
id|Host
)paren
op_logical_and
id|BusLogic_TestInterrupts
c_func
(paren
id|HostAdapter
)paren
op_logical_and
id|BusLogic_CreateCCBs
c_func
(paren
id|HostAdapter
)paren
op_logical_and
id|BusLogic_InitializeHostAdapter
c_func
(paren
id|HostAdapter
)paren
op_logical_and
id|BusLogic_InquireTargetDevices
c_func
(paren
id|HostAdapter
)paren
)paren
(brace
multiline_comment|/*&n;&t;    Initialization has been completed successfully.  Release and&n;&t;    re-register usage of the I/O Address range so that the Model&n;&t;    Name of the Host Adapter will appear.&n;&t;  */
id|release_region
c_func
(paren
id|HostAdapter-&gt;IO_Address
comma
id|BusLogic_IO_PortCount
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|HostAdapter-&gt;IO_Address
comma
id|BusLogic_IO_PortCount
comma
id|HostAdapter-&gt;BoardName
)paren
suffix:semicolon
id|BusLogicHostAdapterCount
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;    An error occurred during Host Adapter Configuration Querying,&n;&t;    Resource Acquisition, Interrupt Testing, CCB Creation, or Host&n;&t;    Adapter Initialization, so remove Host Adapter from the list of&n;&t;    registered BusLogic Host Adapters, destroy the CCBs, Release&n;&t;    the System Resources, and Unregister the SCSI Host.&n;&t;  */
id|BusLogic_DestroyCCBs
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|BusLogic_ReleaseResources
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|BusLogic_UnregisterHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|Host
)paren
suffix:semicolon
)brace
)brace
r_return
id|BusLogicHostAdapterCount
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ReleaseHostAdapter releases all resources previously acquired to&n;  support a specific Host Adapter, including the I/O Address range, and&n;  unregisters the BusLogic Host Adapter.&n;*/
DECL|function|BusLogic_ReleaseHostAdapter
r_int
id|BusLogic_ReleaseHostAdapter
c_func
(paren
id|SCSI_Host_T
op_star
id|Host
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Host-&gt;hostdata
suffix:semicolon
multiline_comment|/*&n;    Destroy the CCBs and release any system resources acquired to use&n;    Host Adapter.&n;  */
id|BusLogic_DestroyCCBs
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|BusLogic_ReleaseResources
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
multiline_comment|/*&n;    Release usage of the I/O Address range.&n;  */
id|release_region
c_func
(paren
id|HostAdapter-&gt;IO_Address
comma
id|BusLogic_IO_PortCount
)paren
suffix:semicolon
multiline_comment|/*&n;    Remove Host Adapter from the list of registered BusLogic Host Adapters.&n;  */
id|BusLogic_UnregisterHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ComputeResultCode computes a SCSI Subsystem Result Code from&n;  the Host Adapter Status and Target Device Status.&n;*/
DECL|function|BusLogic_ComputeResultCode
r_static
r_int
id|BusLogic_ComputeResultCode
c_func
(paren
id|BusLogic_HostAdapterStatus_T
id|HostAdapterStatus
comma
id|BusLogic_TargetDeviceStatus_T
id|TargetDeviceStatus
)paren
(brace
r_int
id|HostStatus
suffix:semicolon
r_switch
c_cond
(paren
id|HostAdapterStatus
)paren
(brace
r_case
id|BusLogic_CommandCompletedNormally
suffix:colon
r_case
id|BusLogic_LinkedCommandCompleted
suffix:colon
r_case
id|BusLogic_LinkedCommandCompletedWithFlag
suffix:colon
id|HostStatus
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BusLogic_SCSISelectionTimeout
suffix:colon
id|HostStatus
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BusLogic_InvalidOutgoingMailboxActionCode
suffix:colon
r_case
id|BusLogic_InvalidCommandOperationCode
suffix:colon
r_case
id|BusLogic_InvalidCommandParameter
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BusLogic: BusLogic Driver Protocol Error 0x%02X&bslash;n&quot;
comma
id|HostAdapterStatus
)paren
suffix:semicolon
r_case
id|BusLogic_DataOverUnderRun
suffix:colon
r_case
id|BusLogic_UnexpectedBusFree
suffix:colon
r_case
id|BusLogic_LinkedCCBhasInvalidLUN
suffix:colon
r_case
id|BusLogic_AutoRequestSenseFailed
suffix:colon
r_case
id|BusLogic_TaggedQueuingMessageRejected
suffix:colon
r_case
id|BusLogic_UnsupportedMessageReceived
suffix:colon
r_case
id|BusLogic_HostAdapterHardwareFailed
suffix:colon
r_case
id|BusLogic_TargetDeviceReconnectedImproperly
suffix:colon
r_case
id|BusLogic_AbortQueueGenerated
suffix:colon
r_case
id|BusLogic_HostAdapterSoftwareError
suffix:colon
r_case
id|BusLogic_HostAdapterHardwareTimeoutError
suffix:colon
r_case
id|BusLogic_SCSIParityErrorDetected
suffix:colon
id|HostStatus
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BusLogic_InvalidBusPhaseRequested
suffix:colon
r_case
id|BusLogic_TargetFailedResponseToATN
suffix:colon
r_case
id|BusLogic_HostAdapterAssertedRST
suffix:colon
r_case
id|BusLogic_OtherDeviceAssertedRST
suffix:colon
r_case
id|BusLogic_HostAdapterAssertedBusDeviceReset
suffix:colon
id|HostStatus
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BusLogic: unknown Host Adapter Status 0x%02X&bslash;n&quot;
comma
id|HostAdapterStatus
)paren
suffix:semicolon
id|HostStatus
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|HostStatus
op_lshift
l_int|16
)paren
op_or
id|TargetDeviceStatus
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_InterruptHandler handles hardware interrupts from BusLogic Host&n;  Adapters.  To simplify handling shared IRQ Channels, all installed BusLogic&n;  Host Adapters are scanned whenever any one of them signals a hardware&n;  interrupt.&n;*/
DECL|function|BusLogic_InterruptHandler
r_static
r_void
id|BusLogic_InterruptHandler
c_func
(paren
r_int
id|IRQ_Channel
comma
id|Registers_T
op_star
id|InterruptRegisters
)paren
(brace
id|BusLogic_CCB_T
op_star
id|FirstCompletedCCB
op_assign
l_int|NULL
comma
op_star
id|LastCompletedCCB
op_assign
l_int|NULL
suffix:semicolon
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
suffix:semicolon
r_int
id|HostAdapterResetPendingCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    Iterate over the installed BusLogic Host Adapters accepting any Incoming&n;    Mailbox entries and saving the completed CCBs for processing.  This&n;    interrupt handler is installed with SA_INTERRUPT, so interrupts are&n;    disabled when the interrupt handler is entered.&n;  */
r_for
c_loop
(paren
id|HostAdapter
op_assign
id|BusLogic_RegisteredHostAdapters
suffix:semicolon
id|HostAdapter
op_ne
l_int|NULL
suffix:semicolon
id|HostAdapter
op_assign
id|HostAdapter-&gt;Next
)paren
(brace
r_int
r_char
id|InterruptRegister
suffix:semicolon
multiline_comment|/*&n;&t;Acquire exclusive access to Host Adapter.&n;      */
id|BusLogic_LockHostAdapterID
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
multiline_comment|/*&n;&t;Read the Host Adapter Interrupt Register.&n;      */
id|InterruptRegister
op_assign
id|BusLogic_ReadInterruptRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_InterruptValid
)paren
(brace
multiline_comment|/*&n;&t;    Acknowledge the interrupt and reset the Host Adapter&n;&t;    Interrupt Register.&n;&t;  */
id|BusLogic_WriteControlRegister
c_func
(paren
id|HostAdapter
comma
id|BusLogic_InterruptReset
)paren
suffix:semicolon
multiline_comment|/*&n;&t;    Process valid SCSI Reset State and Incoming Mailbox Loaded&n;&t;    interrupts.  Command Complete interrupts are noted, and&n;&t;    Outgoing Mailbox Available interrupts are ignored, as they&n;&t;    are never enabled.&n;&t;  */
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_SCSIResetState
)paren
(brace
id|HostAdapter-&gt;HostAdapterResetPending
op_assign
l_bool|true
suffix:semicolon
id|HostAdapterResetPendingCount
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_IncomingMailboxLoaded
)paren
(brace
multiline_comment|/*&n;&t;&t;Scan through the Incoming Mailboxes in Strict Round Robin&n;&t;&t;fashion, saving any completed CCBs for further processing.&n;&t;&t;It is essential that for each CCB and SCSI Command issued,&n;&t;&t;completion processing is performed exactly once.  Therefore,&n;&t;&t;only Incoming Mailbox entries with completion code Command&n;&t;&t;Completed Without Error, Command Completed With Error, or&n;&t;&t;Command Aborted At Host Request are saved for completion&n;&t;&t;processing.  When an Incoming Mailbox entry has a completion&n;&t;&t;code of Aborted Command Not Found, the CCB had already&n;&t;&t;completed or been aborted before the current Abort request&n;&t;&t;was processed, and so completion processing has already&n;&t;&t;occurred and no further action should be taken.&n;&t;      */
id|BusLogic_IncomingMailbox_T
op_star
id|NextIncomingMailbox
op_assign
id|HostAdapter-&gt;NextIncomingMailbox
suffix:semicolon
r_while
c_loop
(paren
id|NextIncomingMailbox-&gt;CompletionCode
op_ne
id|BusLogic_IncomingMailboxFree
)paren
(brace
id|BusLogic_CCB_T
op_star
id|CCB
op_assign
id|NextIncomingMailbox-&gt;CCB
suffix:semicolon
id|BusLogic_CompletionCode_T
id|MailboxCompletionCode
op_assign
id|NextIncomingMailbox-&gt;CompletionCode
suffix:semicolon
r_if
c_cond
(paren
id|MailboxCompletionCode
op_ne
id|BusLogic_AbortedCommandNotFound
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;Mark this CCB as completed and add it to the end&n;&t;&t;&t;of the list of completed CCBs.&n;&t;&t;      */
id|CCB-&gt;Status
op_assign
id|BusLogic_CCB_Completed
suffix:semicolon
id|CCB-&gt;MailboxCompletionCode
op_assign
id|MailboxCompletionCode
suffix:semicolon
id|CCB-&gt;Next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|FirstCompletedCCB
op_eq
l_int|NULL
)paren
(brace
id|FirstCompletedCCB
op_assign
id|CCB
suffix:semicolon
id|LastCompletedCCB
op_assign
id|CCB
suffix:semicolon
)brace
r_else
(brace
id|LastCompletedCCB-&gt;Next
op_assign
id|CCB
suffix:semicolon
id|LastCompletedCCB
op_assign
id|CCB
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;scsi%d: Aborted CCB #%d Not Found&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
)paren
suffix:semicolon
id|NextIncomingMailbox-&gt;CompletionCode
op_assign
id|BusLogic_IncomingMailboxFree
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|NextIncomingMailbox
OG
id|HostAdapter-&gt;LastIncomingMailbox
)paren
id|NextIncomingMailbox
op_assign
id|HostAdapter-&gt;FirstIncomingMailbox
suffix:semicolon
)brace
id|HostAdapter-&gt;NextIncomingMailbox
op_assign
id|NextIncomingMailbox
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_CommandComplete
)paren
id|HostAdapter-&gt;HostAdapterCommandCompleted
op_assign
l_bool|true
suffix:semicolon
)brace
multiline_comment|/*&n;&t;Release exclusive access to Host Adapter.&n;      */
id|BusLogic_UnlockHostAdapterID
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Enable interrupts while the completed CCBs are processed.&n;  */
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;    Iterate over the Host Adapters performing any pending Host Adapter Resets.&n;  */
r_if
c_cond
(paren
id|HostAdapterResetPendingCount
OG
l_int|0
)paren
r_for
c_loop
(paren
id|HostAdapter
op_assign
id|BusLogic_RegisteredHostAdapters
suffix:semicolon
id|HostAdapter
op_ne
l_int|NULL
suffix:semicolon
id|HostAdapter
op_assign
id|HostAdapter-&gt;Next
)paren
r_if
c_cond
(paren
id|HostAdapter-&gt;HostAdapterResetPending
)paren
(brace
id|BusLogic_ResetHostAdapter
c_func
(paren
id|HostAdapter
comma
l_int|NULL
)paren
suffix:semicolon
id|HostAdapter-&gt;HostAdapterResetPending
op_assign
l_bool|false
suffix:semicolon
id|scsi_mark_host_bus_reset
c_func
(paren
id|HostAdapter-&gt;SCSI_Host
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Iterate over the completed CCBs setting the SCSI Command Result Codes,&n;    deallocating the CCBs, and calling the Completion Routines.&n;  */
r_while
c_loop
(paren
id|FirstCompletedCCB
op_ne
l_int|NULL
)paren
(brace
id|BusLogic_CCB_T
op_star
id|CCB
op_assign
id|FirstCompletedCCB
suffix:semicolon
id|SCSI_Command_T
op_star
id|Command
op_assign
id|CCB-&gt;Command
suffix:semicolon
id|FirstCompletedCCB
op_assign
id|FirstCompletedCCB-&gt;Next
suffix:semicolon
id|HostAdapter
op_assign
id|CCB-&gt;HostAdapter
suffix:semicolon
multiline_comment|/*&n;&t;Bus Device Reset CCBs have the Command field non-NULL only when a Bus&n;&t;Device Reset was requested for a command that was not currently active&n;&t;in the Host Adapter, and hence would not have its Completion Routine&n;&t;called otherwise.&n;      */
r_if
c_cond
(paren
id|CCB-&gt;Opcode
op_eq
id|BusLogic_SCSIBusDeviceReset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Bus Device Reset CCB #%d to Target %d Completed&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
comma
id|CCB-&gt;TargetID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Command
op_ne
l_int|NULL
)paren
id|Command-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
multiline_comment|/*&n;&t;  Translate the Mailbox Completion Code, Host Adapter Status, and&n;&t;  Target Device Status into a SCSI Subsystem Result Code.&n;&t;*/
r_switch
c_cond
(paren
id|CCB-&gt;MailboxCompletionCode
)paren
(brace
r_case
id|BusLogic_IncomingMailboxFree
suffix:colon
r_case
id|BusLogic_AbortedCommandNotFound
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d: CCB #%d Impossible State&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BusLogic_CommandCompletedWithoutError
suffix:colon
id|HostAdapter-&gt;CommandSuccessfulFlag
(braket
id|CCB-&gt;TargetID
)braket
op_assign
l_bool|true
suffix:semicolon
id|Command-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BusLogic_CommandAbortedAtHostRequest
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scsi%d: CCB #%d Aborted&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
)paren
suffix:semicolon
id|Command-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BusLogic_CommandCompletedWithError
suffix:colon
id|Command-&gt;result
op_assign
id|BusLogic_ComputeResultCode
c_func
(paren
id|CCB-&gt;HostAdapterStatus
comma
id|CCB-&gt;TargetDeviceStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BusLogic_TracingOptions
op_amp
id|BusLogic_TraceErrors
)paren
r_if
c_cond
(paren
id|CCB-&gt;HostAdapterStatus
op_ne
id|BusLogic_SCSISelectionTimeout
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: CCB #%d Target %d: Result %X &quot;
l_string|&quot;Host Adapter Status %02X Target Status %02X&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
comma
id|CCB-&gt;TargetID
comma
id|Command-&gt;result
comma
id|CCB-&gt;HostAdapterStatus
comma
id|CCB-&gt;TargetDeviceStatus
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: CDB   &quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CCB-&gt;CDB_Length
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
id|CCB-&gt;CDB
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Sense &quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CCB-&gt;SenseDataLength
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
(paren
op_star
id|CCB-&gt;SenseDataPointer
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;Place CCB back on the Host Adapter&squot;s free list.&n;      */
id|BusLogic_DeallocateCCB
c_func
(paren
id|CCB
)paren
suffix:semicolon
multiline_comment|/*&n;&t;Call the SCSI Command Completion Routine if appropriate.&n;      */
r_if
c_cond
(paren
id|Command
op_ne
l_int|NULL
)paren
id|Command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|Command
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;  BusLogic_WriteOutgoingMailboxEntry writes an Outgoing Mailbox entry&n;  for Host Adapter with Action Code and CCB.&n;*/
DECL|function|BusLogic_WriteOutgoingMailboxEntry
r_static
id|boolean
id|BusLogic_WriteOutgoingMailboxEntry
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
comma
id|BusLogic_ActionCode_T
id|ActionCode
comma
id|BusLogic_CCB_T
op_star
id|CCB
)paren
(brace
id|BusLogic_OutgoingMailbox_T
op_star
id|NextOutgoingMailbox
suffix:semicolon
id|boolean
id|Result
op_assign
l_bool|false
suffix:semicolon
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|NextOutgoingMailbox
op_assign
id|HostAdapter-&gt;NextOutgoingMailbox
suffix:semicolon
r_if
c_cond
(paren
id|NextOutgoingMailbox-&gt;ActionCode
op_eq
id|BusLogic_OutgoingMailboxFree
)paren
(brace
id|NextOutgoingMailbox-&gt;ActionCode
op_assign
id|ActionCode
suffix:semicolon
id|NextOutgoingMailbox-&gt;CCB
op_assign
id|CCB
suffix:semicolon
id|CCB-&gt;Status
op_assign
id|BusLogic_CCB_Active
suffix:semicolon
id|BusLogic_StartMailboxScan
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|NextOutgoingMailbox
OG
id|HostAdapter-&gt;LastOutgoingMailbox
)paren
id|NextOutgoingMailbox
op_assign
id|HostAdapter-&gt;FirstOutgoingMailbox
suffix:semicolon
id|HostAdapter-&gt;NextOutgoingMailbox
op_assign
id|NextOutgoingMailbox
suffix:semicolon
id|Result
op_assign
l_bool|true
suffix:semicolon
)brace
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_return
id|Result
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_QueueCommand creates a CCB for Command and places it into an&n;  Outgoing Mailbox for execution by the associated Host Adapter.&n;*/
DECL|function|BusLogic_QueueCommand
r_int
id|BusLogic_QueueCommand
c_func
(paren
id|SCSI_Command_T
op_star
id|Command
comma
r_void
(paren
op_star
id|CompletionRoutine
)paren
(paren
id|SCSI_Command_T
op_star
)paren
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Command-&gt;host-&gt;hostdata
suffix:semicolon
r_int
r_char
op_star
id|CDB
op_assign
id|Command-&gt;cmnd
suffix:semicolon
r_int
r_char
id|CDB_Length
op_assign
id|Command-&gt;cmd_len
suffix:semicolon
r_int
r_char
id|TargetID
op_assign
id|Command-&gt;target
suffix:semicolon
r_int
r_char
id|LogicalUnit
op_assign
id|Command-&gt;lun
suffix:semicolon
r_void
op_star
id|BufferPointer
op_assign
id|Command-&gt;request_buffer
suffix:semicolon
r_int
id|BufferLength
op_assign
id|Command-&gt;request_bufflen
suffix:semicolon
r_int
id|SegmentCount
op_assign
id|Command-&gt;use_sg
suffix:semicolon
id|BusLogic_CCB_T
op_star
id|CCB
suffix:semicolon
r_int
id|EnableTQ
suffix:semicolon
multiline_comment|/*&n;    SCSI REQUEST_SENSE commands will be executed automatically by the Host&n;    Adapter for any errors, so they should not be executed explicitly unless&n;    the Sense Data is zero indicating that no error occurred.&n;  */
r_if
c_cond
(paren
id|CDB
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
op_logical_and
id|Command-&gt;sense_buffer
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|Command-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|CompletionRoutine
c_func
(paren
id|Command
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    Allocate a CCB from the Host Adapter&squot;s free list, aborting the command&n;    with an error if there are none available and memory allocation fails.&n;  */
id|CCB
op_assign
id|BusLogic_AllocateCCB
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CCB
op_eq
l_int|NULL
)paren
(brace
id|Command-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|CompletionRoutine
c_func
(paren
id|Command
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    Initialize the fields in the BusLogic Command Control Block (CCB).&n;  */
r_if
c_cond
(paren
id|SegmentCount
op_eq
l_int|0
)paren
(brace
id|CCB-&gt;Opcode
op_assign
id|BusLogic_InitiatorCCB
suffix:semicolon
id|CCB-&gt;DataLength
op_assign
id|BufferLength
suffix:semicolon
id|CCB-&gt;DataPointer
op_assign
id|BufferPointer
suffix:semicolon
)brace
r_else
(brace
id|SCSI_ScatterList_T
op_star
id|ScatterList
op_assign
(paren
id|SCSI_ScatterList_T
op_star
)paren
id|BufferPointer
suffix:semicolon
r_int
id|Segment
suffix:semicolon
id|CCB-&gt;Opcode
op_assign
id|BusLogic_InitiatorCCB_ScatterGather
suffix:semicolon
id|CCB-&gt;DataLength
op_assign
id|SegmentCount
op_star
r_sizeof
(paren
id|BusLogic_ScatterGatherSegment_T
)paren
suffix:semicolon
id|CCB-&gt;DataPointer
op_assign
id|CCB-&gt;ScatterGatherList
suffix:semicolon
r_for
c_loop
(paren
id|Segment
op_assign
l_int|0
suffix:semicolon
id|Segment
OL
id|SegmentCount
suffix:semicolon
id|Segment
op_increment
)paren
(brace
id|CCB-&gt;ScatterGatherList
(braket
id|Segment
)braket
dot
id|SegmentByteCount
op_assign
id|ScatterList
(braket
id|Segment
)braket
dot
id|length
suffix:semicolon
id|CCB-&gt;ScatterGatherList
(braket
id|Segment
)braket
dot
id|SegmentDataPointer
op_assign
id|ScatterList
(braket
id|Segment
)braket
dot
id|address
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|CDB
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_6
suffix:colon
r_case
id|READ_10
suffix:colon
id|CCB-&gt;DataDirection
op_assign
id|BusLogic_DataInLengthChecked
suffix:semicolon
id|HostAdapter-&gt;ReadWriteOperationCount
(braket
id|TargetID
)braket
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
id|CCB-&gt;DataDirection
op_assign
id|BusLogic_DataOutLengthChecked
suffix:semicolon
id|HostAdapter-&gt;ReadWriteOperationCount
(braket
id|TargetID
)braket
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|CCB-&gt;DataDirection
op_assign
id|BusLogic_UncheckedDataTransfer
suffix:semicolon
r_break
suffix:semicolon
)brace
id|CCB-&gt;CDB_Length
op_assign
id|CDB_Length
suffix:semicolon
id|CCB-&gt;SenseDataLength
op_assign
r_sizeof
(paren
id|Command-&gt;sense_buffer
)paren
suffix:semicolon
id|CCB-&gt;TargetID
op_assign
id|TargetID
suffix:semicolon
id|CCB-&gt;LogicalUnit
op_assign
id|LogicalUnit
suffix:semicolon
multiline_comment|/*&n;    For Wide SCSI Host Adapters, Wide Mode CCBs are used to support more than&n;    8 Logical Units per Target, and this requires setting the overloaded&n;    TagEnable field to Logical Unit bit 5.&n;  */
r_if
c_cond
(paren
id|HostAdapter-&gt;HostWideSCSI
)paren
(brace
id|CCB-&gt;TagEnable
op_assign
id|LogicalUnit
op_rshift
l_int|5
suffix:semicolon
id|CCB-&gt;WideModeTagEnable
op_assign
l_bool|false
suffix:semicolon
)brace
r_else
id|CCB-&gt;TagEnable
op_assign
l_bool|false
suffix:semicolon
multiline_comment|/*&n;    BusLogic recommends that after a Reset the first couple of commands that&n;    are sent to a Target be sent in a non Tagged Queue fashion so that the Host&n;    Adapter and Target can establish Synchronous Transfer before Queue Tag&n;    messages can interfere with the Synchronous Negotiation message.&n;  */
r_if
c_cond
(paren
(paren
id|HostAdapter-&gt;TaggedQueuingPermitted
op_amp
(paren
l_int|1
op_lshift
id|TargetID
)paren
)paren
op_logical_and
id|Command-&gt;device-&gt;tagged_supported
op_logical_and
(paren
id|EnableTQ
op_assign
id|HostAdapter-&gt;ReadWriteOperationCount
(braket
id|TargetID
)braket
op_minus
l_int|5
)paren
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|EnableTQ
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: Tagged Queuing now active for Target %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|TargetID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;HostWideSCSI
)paren
(brace
id|CCB-&gt;WideModeTagEnable
op_assign
l_bool|true
suffix:semicolon
id|CCB-&gt;WideModeQueueTag
op_assign
id|BusLogic_SimpleQueueTag
suffix:semicolon
)brace
r_else
(brace
id|CCB-&gt;TagEnable
op_assign
l_bool|true
suffix:semicolon
id|CCB-&gt;QueueTag
op_assign
id|BusLogic_SimpleQueueTag
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|CCB-&gt;CDB
comma
id|CDB
comma
id|CDB_Length
)paren
suffix:semicolon
id|CCB-&gt;SenseDataPointer
op_assign
(paren
id|SCSI_SenseData_T
op_star
)paren
op_amp
id|Command-&gt;sense_buffer
suffix:semicolon
id|CCB-&gt;Command
op_assign
id|Command
suffix:semicolon
id|Command-&gt;scsi_done
op_assign
id|CompletionRoutine
suffix:semicolon
multiline_comment|/*&n;    Place the CCB in an Outgoing Mailbox, aborting the command with an&n;    error if there are none available.&n;  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|BusLogic_WriteOutgoingMailboxEntry
c_func
(paren
id|HostAdapter
comma
id|BusLogic_MailboxStartCommand
comma
id|CCB
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: cannot write Outgoing Mailbox Entry&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|BusLogic_DeallocateCCB
c_func
(paren
id|CCB
)paren
suffix:semicolon
id|Command-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|CompletionRoutine
c_func
(paren
id|Command
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_AbortCommand aborts Command if possible.&n;*/
DECL|function|BusLogic_AbortCommand
r_int
id|BusLogic_AbortCommand
c_func
(paren
id|SCSI_Command_T
op_star
id|Command
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Command-&gt;host-&gt;hostdata
suffix:semicolon
r_int
r_char
id|InterruptRegister
suffix:semicolon
id|BusLogic_CCB_T
op_star
id|CCB
suffix:semicolon
r_int
id|Result
suffix:semicolon
multiline_comment|/*&n;    If the Host Adapter has posted an interrupt but the Interrupt Handler&n;    has not been called for some reason (i.e. the interrupt was lost), try&n;    calling the Interrupt Handler directly to process the commands that&n;    have been completed.&n;  */
id|InterruptRegister
op_assign
id|BusLogic_ReadInterruptRegister
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InterruptRegister
op_amp
id|BusLogic_InterruptValid
)paren
(brace
r_int
r_int
id|ProcessorFlags
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Recovering Lost Interrupt for IRQ Channel %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;IRQ_Channel
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|ProcessorFlags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BusLogic_InterruptHandler
c_func
(paren
id|HostAdapter-&gt;IRQ_Channel
comma
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|ProcessorFlags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
multiline_comment|/*&n;    Find the CCB to be aborted and determine how to proceed.&n;  */
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
id|Result
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
r_for
c_loop
(paren
id|CCB
op_assign
id|HostAdapter-&gt;All_CCBs
suffix:semicolon
id|CCB
op_ne
l_int|NULL
suffix:semicolon
id|CCB
op_assign
id|CCB-&gt;NextAll
)paren
r_if
c_cond
(paren
id|CCB-&gt;Command
op_eq
id|Command
)paren
(brace
r_if
c_cond
(paren
id|CCB-&gt;Status
op_eq
id|BusLogic_CCB_Active
)paren
r_if
c_cond
(paren
(paren
id|HostAdapter-&gt;HostWideSCSI
op_logical_and
id|CCB-&gt;WideModeTagEnable
op_logical_and
id|CCB-&gt;WideModeQueueTag
op_ne
id|BusLogic_SimpleQueueTag
)paren
op_logical_or
(paren
op_logical_neg
id|HostAdapter-&gt;HostWideSCSI
op_logical_and
id|CCB-&gt;TagEnable
op_logical_and
id|CCB-&gt;QueueTag
op_ne
id|BusLogic_SimpleQueueTag
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;CCBs using Tagged Queuing with other than Simple Queue Tag&n;&t;&t;should not be aborted.&n;&t;      */
id|Result
op_assign
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;Attempt to abort the CCB.&n;&t;      */
r_if
c_cond
(paren
id|BusLogic_WriteOutgoingMailboxEntry
c_func
(paren
id|HostAdapter
comma
id|BusLogic_MailboxAbortCommand
comma
id|CCB
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Aborting CCB #%d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
)paren
suffix:semicolon
id|Result
op_assign
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
r_else
id|Result
op_assign
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_return
id|Result
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ResetHostAdapter resets Host Adapter if possible, marking all&n;  currently executing SCSI commands as having been reset, as well as&n;  the specified Command if non-NULL.&n;*/
DECL|function|BusLogic_ResetHostAdapter
r_static
r_int
id|BusLogic_ResetHostAdapter
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
comma
id|SCSI_Command_T
op_star
id|Command
)paren
(brace
id|BusLogic_CCB_T
op_star
id|CCB
suffix:semicolon
r_if
c_cond
(paren
id|Command
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: Resetting %s due to SCSI Reset State Interrupt&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;BoardName
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;scsi%d: Resetting %s due to Target %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;BoardName
comma
id|Command-&gt;target
)paren
suffix:semicolon
multiline_comment|/*&n;    Attempt to Reset and Reinitialize the Host Adapter.&n;  */
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|BusLogic_HardResetHostAdapter
c_func
(paren
id|HostAdapter
)paren
op_logical_and
id|BusLogic_InitializeHostAdapter
c_func
(paren
id|HostAdapter
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Resetting %s Failed&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|HostAdapter-&gt;BoardName
)paren
suffix:semicolon
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
multiline_comment|/*&n;    Wait a few seconds between the Host Adapter Hard Reset which initiates&n;    a SCSI Bus Reset and issuing any SCSI commands.  Some SCSI devices get&n;    confused if they receive SCSI commands too soon after a SCSI Bus Reset.&n;  */
id|BusLogic_Delay
c_func
(paren
id|HostAdapter-&gt;BusSettleTime
)paren
suffix:semicolon
multiline_comment|/*&n;    Mark all currently executing CCBs as having been reset.&n;  */
r_for
c_loop
(paren
id|CCB
op_assign
id|HostAdapter-&gt;All_CCBs
suffix:semicolon
id|CCB
op_ne
l_int|NULL
suffix:semicolon
id|CCB
op_assign
id|CCB-&gt;NextAll
)paren
r_if
c_cond
(paren
id|CCB-&gt;Status
op_eq
id|BusLogic_CCB_Active
)paren
(brace
id|SCSI_Command_T
op_star
id|ActiveCommand
op_assign
id|CCB-&gt;Command
suffix:semicolon
r_if
c_cond
(paren
id|ActiveCommand
op_eq
id|Command
)paren
id|Command
op_assign
l_int|NULL
suffix:semicolon
id|BusLogic_DeallocateCCB
c_func
(paren
id|CCB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ActiveCommand
op_ne
l_int|NULL
)paren
(brace
id|ActiveCommand-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|ActiveCommand
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|ActiveCommand
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|Command
op_ne
l_int|NULL
)paren
(brace
id|Command-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|Command
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|Command
)paren
suffix:semicolon
)brace
r_return
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_BUS_RESET
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_BusDeviceReset sends a Bus Device Reset to the Target&n;  associated with Command.&n;*/
DECL|function|BusLogic_BusDeviceReset
r_static
r_int
id|BusLogic_BusDeviceReset
c_func
(paren
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
comma
id|SCSI_Command_T
op_star
id|Command
)paren
(brace
id|BusLogic_CCB_T
op_star
id|CCB
op_assign
id|BusLogic_AllocateCCB
c_func
(paren
id|HostAdapter
)paren
comma
op_star
id|XCCB
suffix:semicolon
r_int
r_char
id|TargetID
op_assign
id|Command-&gt;target
suffix:semicolon
multiline_comment|/*&n;    If sending a Bus Device Reset is impossible, attempt a full Host&n;    Adapter Hard Reset and SCSI Bus Reset.&n;  */
r_if
c_cond
(paren
id|CCB
op_eq
l_int|NULL
)paren
r_return
id|BusLogic_ResetHostAdapter
c_func
(paren
id|HostAdapter
comma
id|Command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: Sending Bus Device Reset CCB #%d to Target %d&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
comma
id|CCB-&gt;SerialNumber
comma
id|TargetID
)paren
suffix:semicolon
id|CCB-&gt;Opcode
op_assign
id|BusLogic_SCSIBusDeviceReset
suffix:semicolon
id|CCB-&gt;TargetID
op_assign
id|TargetID
suffix:semicolon
id|CCB-&gt;Command
op_assign
id|Command
suffix:semicolon
multiline_comment|/*&n;    If there is a currently executing CCB in the Host Adapter for this Command,&n;    then an Incoming Mailbox entry will be made with a completion code of&n;    BusLogic_HostAdapterAssertedBusDeviceReset.  Otherwise, the CCB Command&n;    field will be left pointing to the Command so that the interrupt for the&n;    completion of the Bus Device Reset can call the Completion Routine for the&n;    Command.&n;  */
id|BusLogic_LockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
r_for
c_loop
(paren
id|XCCB
op_assign
id|HostAdapter-&gt;All_CCBs
suffix:semicolon
id|XCCB
op_ne
l_int|NULL
suffix:semicolon
id|XCCB
op_assign
id|XCCB-&gt;NextAll
)paren
r_if
c_cond
(paren
id|XCCB-&gt;Status
op_eq
id|BusLogic_CCB_Active
op_logical_and
id|XCCB-&gt;Command
op_eq
id|Command
)paren
(brace
id|CCB-&gt;Command
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|BusLogic_UnlockHostAdapter
c_func
(paren
id|HostAdapter
)paren
suffix:semicolon
multiline_comment|/*&n;    Attempt to write an Outgoing Mailbox with the Bus Device Reset CCB.&n;    If sending a Bus Device Reset is impossible, attempt a full Host&n;    Adapter Hard Reset and SCSI Bus Reset.&n;  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|BusLogic_WriteOutgoingMailboxEntry
c_func
(paren
id|HostAdapter
comma
id|BusLogic_MailboxStartCommand
comma
id|CCB
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: cannot write Outgoing Mailbox Entry for &quot;
l_string|&quot;Bus Device Reset&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
id|BusLogic_DeallocateCCB
c_func
(paren
id|CCB
)paren
suffix:semicolon
r_return
id|BusLogic_ResetHostAdapter
c_func
(paren
id|HostAdapter
comma
id|Command
)paren
suffix:semicolon
)brace
id|HostAdapter-&gt;ReadWriteOperationCount
(braket
id|TargetID
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_ResetCommand takes appropriate action to reset Command.&n;*/
DECL|function|BusLogic_ResetCommand
r_int
id|BusLogic_ResetCommand
c_func
(paren
id|SCSI_Command_T
op_star
id|Command
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Command-&gt;host-&gt;hostdata
suffix:semicolon
r_int
r_char
id|TargetID
op_assign
id|Command-&gt;target
suffix:semicolon
r_int
r_char
id|ErrorRecoveryOption
op_assign
id|HostAdapter-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ErrorRecoveryOption
op_eq
id|BusLogic_ErrorRecoveryDefault
)paren
r_if
c_cond
(paren
id|Command-&gt;host-&gt;suggest_bus_reset
)paren
id|ErrorRecoveryOption
op_assign
id|BusLogic_ErrorRecoveryHardReset
suffix:semicolon
r_else
id|ErrorRecoveryOption
op_assign
id|BusLogic_ErrorRecoveryBusDeviceReset
suffix:semicolon
r_switch
c_cond
(paren
id|ErrorRecoveryOption
)paren
(brace
r_case
id|BusLogic_ErrorRecoveryHardReset
suffix:colon
r_return
id|BusLogic_ResetHostAdapter
c_func
(paren
id|HostAdapter
comma
id|Command
)paren
suffix:semicolon
r_case
id|BusLogic_ErrorRecoveryBusDeviceReset
suffix:colon
r_if
c_cond
(paren
id|HostAdapter-&gt;CommandSuccessfulFlag
(braket
id|TargetID
)braket
)paren
(brace
id|HostAdapter-&gt;CommandSuccessfulFlag
(braket
id|TargetID
)braket
op_assign
l_bool|false
suffix:semicolon
r_return
id|BusLogic_BusDeviceReset
c_func
(paren
id|HostAdapter
comma
id|Command
)paren
suffix:semicolon
)brace
r_else
r_return
id|BusLogic_ResetHostAdapter
c_func
(paren
id|HostAdapter
comma
id|Command
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: Error Recovery Suppressed&bslash;n&quot;
comma
id|HostAdapter-&gt;HostNumber
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_BIOSDiskParameters returns the Heads/Sectors/Cylinders BIOS Disk&n;  Parameters for Disk.  The default disk geometry is 64 heads, 32 sectors, and&n;  the appropriate number of cylinders so as not to exceed drive capacity.  In&n;  order for disks equal to or larger than 1 GB to be addressable by the BIOS&n;  without exceeding the BIOS limitation of 1024 cylinders, Extended Translation&n;  may be enabled in AutoSCSI on &quot;C&quot; Series boards or by a dip switch setting&n;  on older boards.  With Extended Translation enabled, drives between 1 GB&n;  inclusive and 2 GB exclusive are given a disk geometry of 128 heads and 32&n;  sectors, and drives between 2 GB inclusive and 8 GB exclusive are given a&n;  disk geometry of 255 heads and 63 sectors.  On &quot;C&quot; Series boards the firmware&n;  can be queried for the precise translation in effect for each drive&n;  individually, but there is really no need to do so since we know the total&n;  capacity of the drive and whether Extended Translation is enabled, hence we&n;  can deduce the BIOS disk geometry that must be in effect.&n;*/
DECL|function|BusLogic_BIOSDiskParameters
r_int
id|BusLogic_BIOSDiskParameters
c_func
(paren
id|SCSI_Disk_T
op_star
id|Disk
comma
id|KernelDevice_T
id|Device
comma
r_int
op_star
id|Parameters
)paren
(brace
id|BusLogic_HostAdapter_T
op_star
id|HostAdapter
op_assign
(paren
id|BusLogic_HostAdapter_T
op_star
)paren
id|Disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|BIOS_DiskParameters_T
op_star
id|DiskParameters
op_assign
(paren
id|BIOS_DiskParameters_T
op_star
)paren
id|Parameters
suffix:semicolon
r_if
c_cond
(paren
id|HostAdapter-&gt;ExtendedTranslation
op_logical_and
id|Disk-&gt;capacity
op_ge
l_int|2
op_star
l_int|1024
op_star
l_int|1024
multiline_comment|/* 1 GB in 512 byte sectors */
)paren
r_if
c_cond
(paren
id|Disk-&gt;capacity
op_ge
l_int|4
op_star
l_int|1024
op_star
l_int|1024
multiline_comment|/* 2 GB in 512 byte sectors */
)paren
(brace
id|DiskParameters-&gt;Heads
op_assign
l_int|255
suffix:semicolon
id|DiskParameters-&gt;Sectors
op_assign
l_int|63
suffix:semicolon
)brace
r_else
(brace
id|DiskParameters-&gt;Heads
op_assign
l_int|128
suffix:semicolon
id|DiskParameters-&gt;Sectors
op_assign
l_int|32
suffix:semicolon
)brace
r_else
(brace
id|DiskParameters-&gt;Heads
op_assign
l_int|64
suffix:semicolon
id|DiskParameters-&gt;Sectors
op_assign
l_int|32
suffix:semicolon
)brace
id|DiskParameters-&gt;Cylinders
op_assign
id|Disk-&gt;capacity
op_div
(paren
id|DiskParameters-&gt;Heads
op_star
id|DiskParameters-&gt;Sectors
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;  BusLogic_Setup handles processing of Kernel Command Line Arguments.&n;&n;  For the BusLogic driver, a kernel command line entry comprises the driver&n;  identifier &quot;BusLogic=&quot; optionally followed by a comma-separated sequence of&n;  integers and then optionally followed by a comma-separated sequence of&n;  strings.  Each command line entry applies to one BusLogic Host Adapter.&n;  Multiple command line entries may be used in systems which contain multiple&n;  BusLogic Host Adapters.&n;&n;  The first integer specified is the I/O Address at which the Host Adapter is&n;  located.  If unspecified, it defaults to 0 which means to apply this entry to&n;  the first BusLogic Host Adapter found during the default probe sequence.  If&n;  any I/O Address parameters are provided on the command line, then the default&n;  probe sequence is omitted.&n;&n;  The second integer specified is the number of Concurrent Commands per Logical&n;  Unit to allow for Target Devices on the Host Adapter.  If unspecified, it&n;  defaults to 0 which means to use the value of BusLogic_Concurrency for&n;  non-ISA Host Adapters, or BusLogic_Concurrency_ISA for ISA Host Adapters.&n;&n;  The third integer specified is the Bus Settle Time in seconds.  This is&n;  the amount of time to wait between a Host Adapter Hard Reset which initiates&n;  a SCSI Bus Reset and issuing any SCSI commands.  If unspecified, it defaults&n;  to 0 which means to use the value of BusLogic_DefaultBusSettleTime.&n;&n;  The fourth integer specified is the Tracing Options.  If unspecified, it&n;  defaults to 0 which means that no special tracing information is to be&n;  printed.  Note that Tracing Options are applied across all Host Adapters.&n;&n;  The string options are used to provide control over Tagged Queuing and Error&n;  Recovery. If both Tagged Queuing and Error Recovery strings are provided, the&n;  Tagged Queuing specification string must come first.&n;&n;  The Tagged Queuing specification begins with &quot;TQ:&quot; and allows for explicitly&n;  specifying whether Tagged Queuing is permitted on Target Devices that support&n;  it.  The following specification options are available:&n;&n;  TQ:Default&t;&t;Tagged Queuing will be permitted based on the firmware&n;&t;&t;&t;version of the BusLogic Host Adapter and based on&n;&t;&t;&t;whether the Concurrency value allows queuing multiple&n;&t;&t;&t;commands.&n;&n;  TQ:Enable&t;&t;Tagged Queuing will be enabled for all Target Devices&n;&t;&t;&t;on this Host Adapter overriding any limitation that&n;&t;&t;&t;would otherwise be imposed based on the Host Adapter&n;&t;&t;&t;firmware version.&n;&n;  TQ:Disable&t;&t;Tagged Queuing will be disabled for all Target Devices&n;&t;&t;&t;on this Host Adapter.&n;&n;  TQ:&lt;Per-Target-Spec&gt;&t;Tagged Queuing will be controlled individually for each&n;&t;&t;&t;Target Device.  &lt;Per-Target-Spec&gt; is a sequence of &quot;Y&quot;,&n;&t;&t;&t;&quot;N&quot;, and &quot;X&quot; characters.  &quot;Y&quot; enabled Tagged Queuing,&n;&t;&t;&t;&quot;N&quot; disables Tagged Queuing, and &quot;X&quot; accepts the&n;&t;&t;&t;default based on the firmware version.  The first&n;&t;&t;&t;character refers to Target 0, the second to Target 1,&n;&t;&t;&t;and so on; if the sequence of &quot;Y&quot;, &quot;N&quot;, and &quot;X&quot;&n;&t;&t;&t;characters does not cover all the Target Devices,&n;&t;&t;&t;unspecified characters are assumed to be &quot;X&quot;.&n;&n;  Note that explicitly requesting Tagged Queuing may lead to problems; this&n;  facility is provided primarily to allow disabling Tagged Queuing on Target&n;  Devices that do not implement it correctly.&n;&n;  The Error Recovery specification begins with &quot;ER:&quot; and allows for explicitly&n;  specifying the Error Recovery action to be performed when ResetCommand is&n;  called due to a SCSI Command failing to complete successfully.  The following&n;  specification options are available:&n;&n;  ER:Default&t;&t;Error Recovery will select between the Hard Reset and&n;&t;&t;&t;Bus Device Reset options based on the recommendation&n;&t;&t;&t;of the SCSI Subsystem.&n;&n;  ER:HardReset&t;&t;Error Recovery will initiate a Host Adapter Hard Reset&n;&t;&t;&t;which also causes a SCSI Bus Reset.&n;&n;  ER:BusDeviceReset&t;Error Recovery will send a Bus Device Reset message to&n;&t;&t;&t;the individual Target Device causing the error.  If&n;&t;&t;&t;Error Recovery is again initiated for this Target&n;&t;&t;&t;Device and no SCSI Command to this Target Device has&n;&t;&t;&t;completed successfully since the Bus Device Reset&n;&t;&t;&t;message was sent, then a Hard Reset will be attempted.&n;&n;  ER:None&t;&t;Error Recovery will be suppressed.  This option should&n;&t;&t;&t;only be selected if a SCSI Bus Reset or Bus Device&n;&t;&t;&t;Reset will cause the Target Device to fail completely&n;&t;&t;&t;and unrecoverably.&n;&n;  ER:&lt;Per-Target-Spec&gt;&t;Error Recovery will be controlled individually for each&n;&t;&t;&t;Target Device.  &lt;Per-Target-Spec&gt; is a sequence of &quot;D&quot;,&n;&t;&t;&t;&quot;H&quot;, &quot;B&quot;, and &quot;N&quot; characters.  &quot;D&quot; selects Default, &quot;H&quot;&n;&t;&t;&t;selects Hard Reset, &quot;B&quot; selects Bus Device Reset, and&n;&t;&t;&t;&quot;N&quot; selects None.  The first character refers to Target&n;&t;&t;&t;0, the second to Target 1, and so on; if the sequence&n;&t;&t;&t;of &quot;D&quot;, &quot;H&quot;, &quot;B&quot;, and &quot;N&quot; characters does not cover all&n;&t;&t;&t;the Target Devices, unspecified characters are assumed&n;&t;&t;&t;to be &quot;D&quot;.&n;*/
DECL|function|BusLogic_Setup
r_void
id|BusLogic_Setup
c_func
(paren
r_char
op_star
id|Strings
comma
r_int
op_star
id|Integers
)paren
(brace
id|BusLogic_CommandLineEntry_T
op_star
id|CommandLineEntry
op_assign
op_amp
id|BusLogic_CommandLineEntries
(braket
id|BusLogic_CommandLineEntryCount
op_increment
)braket
suffix:semicolon
r_static
r_int
id|ProbeListIndex
op_assign
l_int|0
suffix:semicolon
r_int
id|IntegerCount
op_assign
id|Integers
(braket
l_int|0
)braket
comma
id|TargetID
comma
id|i
suffix:semicolon
id|CommandLineEntry-&gt;IO_Address
op_assign
l_int|0
suffix:semicolon
id|CommandLineEntry-&gt;Concurrency
op_assign
l_int|0
suffix:semicolon
id|CommandLineEntry-&gt;BusSettleTime
op_assign
l_int|0
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermitted
op_assign
l_int|0
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermittedMask
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
comma
id|BusLogic_ErrorRecoveryDefault
comma
r_sizeof
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntegerCount
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic: Unexpected Command Line Integers ignored&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IntegerCount
op_ge
l_int|1
)paren
(brace
r_int
r_int
id|IO_Address
op_assign
id|Integers
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|IO_Address
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|BusLogic_IO_StandardAddresses
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BusLogic: Invalid Command Line Entry &quot;
l_string|&quot;(illegal I/O Address 0x%X)&bslash;n&quot;
comma
id|IO_Address
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
OL
id|ProbeListIndex
op_logical_and
id|IO_Address
op_eq
id|BusLogic_IO_AddressProbeList
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BusLogic: Invalid Command Line Entry &quot;
l_string|&quot;(duplicate I/O Address 0x%X)&bslash;n&quot;
comma
id|IO_Address
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IO_Address
op_eq
id|BusLogic_IO_StandardAddresses
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
id|BusLogic_IO_AddressProbeList
(braket
id|ProbeListIndex
op_increment
)braket
op_assign
id|IO_Address
suffix:semicolon
id|BusLogic_IO_AddressProbeList
(braket
id|ProbeListIndex
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|CommandLineEntry-&gt;IO_Address
op_assign
id|IO_Address
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IntegerCount
op_ge
l_int|2
)paren
(brace
r_int
r_int
id|Concurrency
op_assign
id|Integers
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|Concurrency
OG
id|BusLogic_MailboxCount
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BusLogic: Invalid Command Line Entry &quot;
l_string|&quot;(illegal Concurrency %d)&bslash;n&quot;
comma
id|Concurrency
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CommandLineEntry-&gt;Concurrency
op_assign
id|Concurrency
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IntegerCount
op_ge
l_int|3
)paren
id|CommandLineEntry-&gt;BusSettleTime
op_assign
id|Integers
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|IntegerCount
op_ge
l_int|4
)paren
id|BusLogic_TracingOptions
op_or_assign
id|Integers
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|BusLogic_CommandLineEntryCount
op_eq
l_int|0
op_logical_or
id|ProbeListIndex
op_eq
l_int|0
op_logical_or
id|BusLogic_CommandLineEntryCount
op_eq
id|ProbeListIndex
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BusLogic: Invalid Command Line Entry &quot;
l_string|&quot;(all or no I/O Addresses must be specified)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Strings
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;TQ:&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;Default&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
id|Strings
op_add_assign
l_int|7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;Enable&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|6
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermitted
op_assign
l_int|0xFFFF
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermittedMask
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;Disable&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|7
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermitted
op_assign
l_int|0x0000
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermittedMask
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|0
suffix:semicolon
id|TargetID
OL
id|BusLogic_MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
r_switch
c_cond
(paren
op_star
id|Strings
op_increment
)paren
(brace
r_case
l_char|&squot;Y&squot;
suffix:colon
id|CommandLineEntry-&gt;TaggedQueuingPermitted
op_or_assign
l_int|1
op_lshift
id|TargetID
suffix:semicolon
id|CommandLineEntry-&gt;TaggedQueuingPermittedMask
op_or_assign
l_int|1
op_lshift
id|TargetID
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;N&squot;
suffix:colon
id|CommandLineEntry-&gt;TaggedQueuingPermittedMask
op_or_assign
l_int|1
op_lshift
id|TargetID
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;X&squot;
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|Strings
op_decrement
suffix:semicolon
id|TargetID
op_assign
id|BusLogic_MaxTargetIDs
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|Strings
op_eq
l_char|&squot;,&squot;
)paren
id|Strings
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;ER:&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;Default&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
id|Strings
op_add_assign
l_int|7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;HardReset&quot;
comma
l_int|9
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|9
suffix:semicolon
id|memset
c_func
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
comma
id|BusLogic_ErrorRecoveryHardReset
comma
r_sizeof
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;BusDeviceReset&quot;
comma
l_int|14
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|14
suffix:semicolon
id|memset
c_func
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
comma
id|BusLogic_ErrorRecoveryBusDeviceReset
comma
r_sizeof
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|Strings
comma
l_string|&quot;None&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|Strings
op_add_assign
l_int|4
suffix:semicolon
id|memset
c_func
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
comma
id|BusLogic_ErrorRecoveryNone
comma
r_sizeof
(paren
id|CommandLineEntry-&gt;ErrorRecoveryOption
)paren
)paren
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|TargetID
op_assign
l_int|0
suffix:semicolon
id|TargetID
OL
id|BusLogic_MaxTargetIDs
suffix:semicolon
id|TargetID
op_increment
)paren
r_switch
c_cond
(paren
op_star
id|Strings
op_increment
)paren
(brace
r_case
l_char|&squot;D&squot;
suffix:colon
id|CommandLineEntry-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
op_assign
id|BusLogic_ErrorRecoveryDefault
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;H&squot;
suffix:colon
id|CommandLineEntry-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
op_assign
id|BusLogic_ErrorRecoveryHardReset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;B&squot;
suffix:colon
id|CommandLineEntry-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
op_assign
id|BusLogic_ErrorRecoveryBusDeviceReset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;N&squot;
suffix:colon
id|CommandLineEntry-&gt;ErrorRecoveryOption
(braket
id|TargetID
)braket
op_assign
id|BusLogic_ErrorRecoveryNone
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|Strings
op_decrement
suffix:semicolon
id|TargetID
op_assign
id|BusLogic_MaxTargetIDs
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|Strings
op_ne
l_char|&squot;&bslash;0&squot;
)paren
id|printk
c_func
(paren
l_string|&quot;BusLogic: Unexpected Command Line String &squot;%s&squot; ignored&bslash;n&quot;
comma
id|Strings
)paren
suffix:semicolon
)brace
eof
