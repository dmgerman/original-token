multiline_comment|/*      ppa.c   --  low level driver for the IOMEGA PPA3 &n;                    parallel port SCSI host adapter.&n;&n;        (The PPA3 is the embedded controller in the ZIP drive.)&n;&n;        (c) 1995,1996 Grant R. Guenther, grant@torque.net,&n;                      under the terms of the GNU Public License.&n;&n;*/
multiline_comment|/*      This driver was developed without the benefit of any technical&n;        specifications for the interface.  Instead, a modified version of&n;        DOSemu was used to monitor the protocol used by the DOS driver&n;        for this adapter.  I have no idea how my programming model relates&n;        to IOMEGA&squot;s design.&n;&n;        IOMEGA&squot;s driver does not generate linked commands.  I&squot;ve never&n;        observed a SCSI message byte in the protocol transactions, so&n;        I am assuming that as long as linked commands are not used&n;        we won&squot;t see any.  &n;&n;        So far, this driver has been tested with the embedded PPA3 in the&n;        ZIP drive, only.   It can detect and adapt to 4- and 8-bit parallel&n;        ports, but there is currently no support for EPP or ECP ports, as&n;        I have been unable to make the DOS drivers work in these modes on&n;        my test rig.&n;&n;        For more information, see the file drivers/scsi/README.ppa.&n;&n;*/
DECL|macro|PPA_VERSION
mdefine_line|#define   PPA_VERSION   &quot;0.26&quot;
multiline_comment|/* Change these variables here or with insmod or with a LILO or LOADLIN&n;   command line argument&n;*/
DECL|variable|ppa_base
r_static
r_int
id|ppa_base
op_assign
l_int|0x378
suffix:semicolon
multiline_comment|/* parallel port address    */
DECL|variable|ppa_speed_high
r_static
r_int
id|ppa_speed_high
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* port delay in data phase */
DECL|variable|ppa_speed_low
r_static
r_int
id|ppa_speed_low
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* port delay otherwise     */
DECL|variable|ppa_nybble
r_static
r_int
id|ppa_nybble
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t force nybble mode  */
DECL|macro|PPA_CAN_QUEUE
mdefine_line|#define   PPA_CAN_QUEUE         1       /* use &quot;queueing&quot; interface */
DECL|macro|PPA_SELECT_TMO
mdefine_line|#define   PPA_SELECT_TMO        5000    /* how long to wait for target ? */
DECL|macro|PPA_SPIN_TMO
mdefine_line|#define   PPA_SPIN_TMO          5000000 /* ppa_wait loop limiter */
DECL|macro|PPA_SECTOR_SIZE
mdefine_line|#define   PPA_SECTOR_SIZE       512     /* for a performance hack only */
macro_line|#include  &lt;linux/stddef.h&gt;
macro_line|#include  &lt;linux/module.h&gt;
macro_line|#include  &lt;linux/kernel.h&gt;
macro_line|#include  &lt;linux/tqueue.h&gt;
macro_line|#include  &lt;linux/ioport.h&gt;
macro_line|#include  &lt;linux/delay.h&gt;
macro_line|#include  &lt;linux/blk.h&gt;
macro_line|#include  &lt;linux/proc_fs.h&gt;
macro_line|#include  &lt;linux/stat.h&gt;
macro_line|#include  &lt;asm/io.h&gt;
macro_line|#include  &quot;sd.h&quot;
macro_line|#include  &quot;hosts.h&quot;
macro_line|#include  &quot;ppa.h&quot;
DECL|variable|proc_scsi_ppa
r_struct
id|proc_dir_entry
id|proc_scsi_ppa
op_assign
(brace
id|PROC_SCSI_PPA
comma
l_int|3
comma
l_string|&quot;ppa&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
DECL|variable|ppa_abort_flag
r_static
r_int
id|ppa_abort_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|ppa_error_code
r_static
r_int
id|ppa_error_code
op_assign
id|DID_OK
suffix:semicolon
DECL|variable|ppa_info_string
r_static
r_char
id|ppa_info_string
(braket
l_int|132
)braket
suffix:semicolon
DECL|variable|ppa_current
r_static
id|Scsi_Cmnd
op_star
id|ppa_current
op_assign
l_int|0
suffix:semicolon
DECL|variable|ppa_done
r_static
r_void
(paren
op_star
id|ppa_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
DECL|variable|ppa_port_delay
r_static
r_int
id|ppa_port_delay
suffix:semicolon
DECL|function|out_p
r_void
id|out_p
c_func
(paren
r_int
id|port
comma
r_char
id|byte
)paren
(brace
id|outb
c_func
(paren
id|byte
comma
id|ppa_base
op_plus
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ppa_port_delay
)paren
suffix:semicolon
)brace
DECL|function|in_p
r_char
id|in_p
c_func
(paren
r_int
id|port
)paren
(brace
r_return
id|inb
c_func
(paren
id|ppa_base
op_plus
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ppa_port_delay
)paren
suffix:semicolon
)brace
DECL|function|ppa_d_pulse
r_void
id|ppa_d_pulse
c_func
(paren
r_char
id|b
)paren
(brace
id|out_p
c_func
(paren
l_int|0
comma
id|b
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xe
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
)brace
DECL|function|ppa_disconnect
r_void
id|ppa_disconnect
c_func
(paren
r_void
)paren
(brace
id|ppa_d_pulse
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ppa_d_pulse
c_func
(paren
l_int|0x3c
)paren
suffix:semicolon
id|ppa_d_pulse
c_func
(paren
l_int|0x20
)paren
suffix:semicolon
id|ppa_d_pulse
c_func
(paren
l_int|0xf
)paren
suffix:semicolon
)brace
DECL|function|ppa_c_pulse
r_void
id|ppa_c_pulse
c_func
(paren
r_char
id|b
)paren
(brace
id|out_p
c_func
(paren
l_int|0
comma
id|b
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x6
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
)brace
DECL|function|ppa_connect
r_void
id|ppa_connect
c_func
(paren
r_void
)paren
(brace
id|ppa_c_pulse
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ppa_c_pulse
c_func
(paren
l_int|0x3c
)paren
suffix:semicolon
id|ppa_c_pulse
c_func
(paren
l_int|0x20
)paren
suffix:semicolon
id|ppa_c_pulse
c_func
(paren
l_int|0x8f
)paren
suffix:semicolon
)brace
DECL|function|ppa_do_reset
r_void
id|ppa_do_reset
c_func
(paren
r_void
)paren
(brace
id|out_p
c_func
(paren
l_int|2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* This is really just a guess */
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
DECL|function|ppa_select
r_char
id|ppa_select
c_func
(paren
r_int
id|initiator
comma
r_int
id|target
)paren
(brace
r_char
id|r
suffix:semicolon
r_int
id|k
suffix:semicolon
id|r
op_assign
id|in_p
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
(paren
l_int|1
op_lshift
id|target
)paren
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xe
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
(paren
l_int|1
op_lshift
id|initiator
)paren
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x8
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|r
op_assign
(paren
id|in_p
c_func
(paren
l_int|1
)paren
op_amp
l_int|0xf0
)paren
)paren
op_logical_and
(paren
id|k
op_increment
OL
id|PPA_SELECT_TMO
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|ppa_wait
r_char
id|ppa_wait
c_func
(paren
r_void
)paren
multiline_comment|/*      Wait for the high bit to be set.&n;&n;        In principle, this could be tied to an interrupt, but the adapter&n;        doesn&squot;t appear to be designed to support interrupts.  We spin on&n;        the 0x80 ready bit. &n;*/
(brace
r_int
id|k
suffix:semicolon
r_char
id|r
suffix:semicolon
id|ppa_error_code
op_assign
id|DID_OK
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|r
op_assign
id|in_p
c_func
(paren
l_int|1
)paren
)paren
op_amp
l_int|0x80
)paren
op_logical_and
(paren
id|k
op_increment
OL
id|PPA_SPIN_TMO
)paren
op_logical_and
op_logical_neg
id|ppa_abort_flag
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppa_abort_flag
)paren
(brace
r_if
c_cond
(paren
id|ppa_abort_flag
op_eq
l_int|1
)paren
id|ppa_error_code
op_assign
id|DID_ABORT
suffix:semicolon
r_else
(brace
id|ppa_do_reset
c_func
(paren
)paren
suffix:semicolon
id|ppa_error_code
op_assign
id|DID_RESET
suffix:semicolon
)brace
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_ge
id|PPA_SPIN_TMO
)paren
(brace
id|ppa_error_code
op_assign
id|DID_TIME_OUT
suffix:semicolon
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* command timed out */
)brace
r_return
(paren
id|r
op_amp
l_int|0xf0
)paren
suffix:semicolon
)brace
DECL|function|ppa_init
r_int
id|ppa_init
c_func
(paren
r_void
)paren
multiline_comment|/* This is based on a trace of what the Iomega DOS &squot;guest&squot; driver does.&n;   I&squot;ve tried several different kinds of parallel ports with guest and&n;   coded this to react in the same ways that it does.&n;&n;   The return value from this function is just a hint about where the&n;   handshaking failed.&n;&n;*/
(brace
r_char
id|r
comma
id|s
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_p
c_func
(paren
l_int|0
)paren
op_ne
(paren
r_char
)paren
l_int|0xaa
)paren
r_return
l_int|1
suffix:semicolon
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
id|ppa_connect
c_func
(paren
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x6
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_p
c_func
(paren
l_int|1
)paren
op_amp
l_int|0xf0
)paren
op_ne
l_int|0xf0
)paren
r_return
l_int|2
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_p
c_func
(paren
l_int|1
)paren
op_amp
l_int|0xf0
)paren
op_ne
l_int|0x80
)paren
r_return
l_int|3
suffix:semicolon
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
id|in_p
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xec
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
l_int|0x55
)paren
suffix:semicolon
id|r
op_assign
id|in_p
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
(paren
r_char
)paren
l_int|0xff
)paren
(brace
id|ppa_nybble
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
(paren
r_char
)paren
l_int|0x55
)paren
r_return
l_int|4
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_p
c_func
(paren
l_int|0
)paren
op_ne
(paren
r_char
)paren
l_int|0xaa
)paren
r_return
l_int|5
suffix:semicolon
)brace
id|out_p
c_func
(paren
l_int|2
comma
id|s
)paren
suffix:semicolon
id|ppa_connect
c_func
(paren
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
l_int|0x40
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x8
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ppa_start
r_int
id|ppa_start
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_int
id|k
suffix:semicolon
id|ppa_error_code
op_assign
id|DID_OK
suffix:semicolon
id|ppa_abort_flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;target
op_eq
id|PPA_INITIATOR
)paren
(brace
id|ppa_error_code
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ppa_connect
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppa_select
c_func
(paren
id|PPA_INITIATOR
comma
id|cmd-&gt;target
)paren
)paren
(brace
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
id|ppa_error_code
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|k
op_increment
)paren
(brace
multiline_comment|/* send the command */
r_if
c_cond
(paren
op_logical_neg
id|ppa_wait
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|out_p
c_func
(paren
l_int|0
comma
id|cmd-&gt;cmnd
(braket
id|k
)braket
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xe
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
)brace
macro_line|#ifdef PPA_DEBUG
id|printk
c_func
(paren
l_string|&quot;PPA: command out: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|k
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%3x&quot;
comma
(paren
id|cmd-&gt;cmnd
(braket
id|k
)braket
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ppa_completion
r_int
id|ppa_completion
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
multiline_comment|/* The bulk flag enables some optimisations in the data transfer loops,&n;   it should be true for any command that transfers data in integral&n;   numbers of sectors.&n;&n;   The driver appears to remain stable if we speed up the parallel port&n;   i/o in this function, but not elsewhere.&n;*/
(brace
r_char
id|r
comma
id|l
comma
id|h
comma
id|v
suffix:semicolon
r_int
id|dir
comma
id|cnt
comma
id|blen
comma
id|fast
comma
id|bulk
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
macro_line|#ifdef PPA_DEBUG
r_int
id|k
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_assign
id|ppa_wait
c_func
(paren
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|v
op_assign
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
suffix:semicolon
id|bulk
op_assign
(paren
(paren
id|v
op_eq
id|READ_6
)paren
op_logical_or
(paren
id|v
op_eq
id|READ_10
)paren
op_logical_or
(paren
id|v
op_eq
id|WRITE_6
)paren
op_logical_or
(paren
id|v
op_eq
id|WRITE_10
)paren
)paren
suffix:semicolon
id|buffer
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|blen
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
id|cnt
op_assign
l_int|0
suffix:semicolon
id|dir
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|r
op_eq
(paren
r_char
)paren
l_int|0xc0
)paren
id|dir
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* d0 = read c0 = write f0 = status */
id|ppa_port_delay
op_assign
id|ppa_speed_high
suffix:semicolon
r_while
c_loop
(paren
id|r
op_ne
(paren
r_char
)paren
l_int|0xf0
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|r
op_amp
l_int|0xc0
)paren
op_ne
l_int|0xc0
)paren
op_logical_or
(paren
id|cnt
op_ge
id|blen
)paren
)paren
(brace
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
id|ppa_error_code
op_assign
id|DID_ERROR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fast
op_assign
id|bulk
op_logical_and
(paren
(paren
id|blen
op_minus
id|cnt
)paren
op_ge
id|PPA_SECTOR_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
r_do
(brace
id|out_p
c_func
(paren
l_int|0
comma
id|buffer
(braket
id|cnt
op_increment
)braket
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xe
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fast
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cnt
op_mod
id|PPA_SECTOR_SIZE
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|ppa_nybble
)paren
r_do
(brace
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
id|h
op_assign
id|in_p
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x6
)paren
suffix:semicolon
id|l
op_assign
id|in_p
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|v
op_assign
(paren
(paren
id|l
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|h
op_amp
l_int|0xf0
)paren
suffix:semicolon
id|buffer
(braket
id|cnt
op_increment
)braket
op_assign
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fast
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cnt
op_mod
id|PPA_SECTOR_SIZE
)paren
suffix:semicolon
r_else
r_do
(brace
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x25
)paren
suffix:semicolon
id|v
op_assign
id|in_p
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x27
)paren
suffix:semicolon
id|buffer
(braket
id|cnt
op_increment
)braket
op_assign
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fast
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cnt
op_mod
id|PPA_SECTOR_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppa_nybble
)paren
(brace
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x5
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
)brace
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_assign
id|ppa_wait
c_func
(paren
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|ppa_port_delay
op_assign
id|ppa_speed_low
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x4
)paren
suffix:semicolon
multiline_comment|/* now read status byte */
id|h
op_assign
id|in_p
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0x6
)paren
suffix:semicolon
id|l
op_assign
id|in_p
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
id|r
op_assign
(paren
(paren
id|l
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|h
op_amp
l_int|0xf0
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xe
)paren
suffix:semicolon
id|out_p
c_func
(paren
l_int|2
comma
l_int|0xc
)paren
suffix:semicolon
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef PPA_DEBUG
id|printk
c_func
(paren
l_string|&quot;PPA: status: %x, data[%d]: &quot;
comma
id|r
op_amp
id|STATUS_MASK
comma
id|cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
l_int|12
)paren
id|cnt
op_assign
l_int|12
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|cnt
suffix:semicolon
id|k
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%3x&quot;
comma
id|buffer
(braket
id|k
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|r
op_amp
id|STATUS_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/* deprecated synchronous interface */
DECL|function|ppa_command
r_int
id|ppa_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_int
id|s
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|s
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppa_start
c_func
(paren
id|cmd
)paren
)paren
r_if
c_cond
(paren
id|ppa_wait
c_func
(paren
)paren
)paren
id|s
op_assign
id|ppa_completion
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|s
op_plus
(paren
id|ppa_error_code
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* pseudo-interrupt queueing interface */
multiline_comment|/* Since the PPA itself doesn&squot;t generate interrupts, we use&n;   the scheduler&squot;s task queue to generate a stream of call-backs and&n;   complete the request when the drive is ready.&n;*/
r_static
r_void
id|ppa_interrupt
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|variable|ppa_tq
r_static
r_struct
id|tq_struct
id|ppa_tq
op_assign
(brace
l_int|0
comma
l_int|0
comma
id|ppa_interrupt
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|ppa_interrupt
r_static
r_void
id|ppa_interrupt
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
id|cmd
op_assign
id|ppa_current
suffix:semicolon
id|done
op_assign
id|ppa_done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ppa_abort_flag
)paren
(brace
id|ppa_disconnect
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppa_abort_flag
op_eq
l_int|1
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|ppa_do_reset
c_func
(paren
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
id|ppa_current
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|in_p
c_func
(paren
l_int|1
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|ppa_tq
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cmd-&gt;result
op_assign
id|ppa_completion
c_func
(paren
id|cmd
)paren
op_plus
(paren
id|ppa_error_code
op_lshift
l_int|16
)paren
suffix:semicolon
id|ppa_current
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ppa_queuecommand
r_int
id|ppa_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_if
c_cond
(paren
id|ppa_current
)paren
r_return
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|ppa_current
op_assign
id|cmd
suffix:semicolon
id|ppa_done
op_assign
id|done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppa_start
c_func
(paren
id|cmd
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
id|ppa_error_code
op_lshift
l_int|16
suffix:semicolon
id|ppa_current
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|queue_task
c_func
(paren
op_amp
id|ppa_tq
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ppa_detect
r_int
id|ppa_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|host
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|hreg
suffix:semicolon
r_int
id|rs
suffix:semicolon
multiline_comment|/* can we have the ports ? */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ppa_base
comma
l_int|3
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PPA: ports at 0x%3x are not available&bslash;n&quot;
comma
id|ppa_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* attempt to initialise the controller */
id|ppa_port_delay
op_assign
id|ppa_speed_low
suffix:semicolon
id|rs
op_assign
id|ppa_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PPA: unable to initialise controller at 0x%x, error %d&bslash;n&quot;
comma
id|ppa_base
comma
id|rs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* now the glue ... */
id|host-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_ppa
suffix:semicolon
id|request_region
c_func
(paren
id|ppa_base
comma
l_int|3
comma
l_string|&quot;ppa&quot;
)paren
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|PPA_CAN_QUEUE
suffix:semicolon
id|hreg
op_assign
id|scsi_register
c_func
(paren
id|host
comma
l_int|0
)paren
suffix:semicolon
id|hreg-&gt;io_port
op_assign
id|ppa_base
suffix:semicolon
id|hreg-&gt;n_io_port
op_assign
l_int|3
suffix:semicolon
id|hreg-&gt;dma_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|ppa_info_string
comma
l_string|&quot;PPA driver version %s using %d-bit mode on port 0x%x.&quot;
comma
id|PPA_VERSION
comma
l_int|8
op_minus
id|ppa_nybble
op_star
l_int|4
comma
id|ppa_base
)paren
suffix:semicolon
id|host-&gt;name
op_assign
id|ppa_info_string
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* 1 host detected */
)brace
DECL|function|ppa_biosparam
r_int
id|ppa_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|ip
(braket
)braket
)paren
multiline_comment|/*  Apparently the the disk-&gt;capacity attribute is off by 1 sector &n;    for all disk drives.  We add the one here, but it should really&n;    be done in sd.c.  Even if it gets fixed there, this will still&n;    work.&n;*/
(brace
id|ip
(braket
l_int|0
)braket
op_assign
l_int|0x40
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|0x20
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
(paren
id|disk-&gt;capacity
op_plus
l_int|1
)paren
op_div
(paren
id|ip
(braket
l_int|0
)braket
op_star
id|ip
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
(braket
l_int|2
)braket
OG
l_int|1024
)paren
(brace
id|ip
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|ip
(braket
l_int|1
)braket
op_assign
l_int|0x3f
suffix:semicolon
id|ip
(braket
l_int|2
)braket
op_assign
(paren
id|disk-&gt;capacity
op_plus
l_int|1
)paren
op_div
(paren
id|ip
(braket
l_int|0
)braket
op_star
id|ip
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
(braket
l_int|2
)braket
OG
l_int|1023
)paren
id|ip
(braket
l_int|2
)braket
op_assign
l_int|1023
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ppa_abort
r_int
id|ppa_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|ppa_abort_flag
op_assign
l_int|1
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
DECL|function|ppa_reset
r_int
id|ppa_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|ignored
)paren
(brace
id|ppa_abort_flag
op_assign
l_int|2
suffix:semicolon
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
DECL|function|ppa_info
r_const
r_char
op_star
id|ppa_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_return
id|ppa_info_string
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/* Command line parameters (for built-in driver):&n;&n;   Syntax:  ppa=base[,speed_high[,speed_low[,nybble]]]&n;&n;   For example:  ppa=0x378   or   ppa=0x378,0,3&n;&n;*/
DECL|function|ppa_setup
r_void
id|ppa_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|ppa_base
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
)paren
id|ppa_speed_high
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|2
)paren
id|ppa_speed_low
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|3
)paren
id|ppa_nybble
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|4
)paren
id|ppa_nybble
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
)brace
macro_line|#else
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|PPA
suffix:semicolon
macro_line|#include  &quot;scsi_module.c&quot;
macro_line|#endif
multiline_comment|/* end of ppa.c */
eof
