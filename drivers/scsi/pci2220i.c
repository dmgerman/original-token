multiline_comment|/*+M*************************************************************************&n; * Perceptive Solutions, Inc. PCI-2000 device driver proc support for Linux.&n; *&n; * Copyright (c) 1997 Perceptive Solutions, Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; see the file COPYING.  If not, write to&n; * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *&n; *&t;File Name:&t;&t;pci2220i.c&n; *&n; *&t;Description:&t;SCSI driver for the PCI2220I EIDE interface card.&n; *&n; *-M*************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;pci2220i.h&quot;
macro_line|#include &quot;psi_dale.h&quot;
macro_line|#include&lt;linux/stat.h&gt;
DECL|variable|Proc_Scsi_Pci2220i
r_struct
id|proc_dir_entry
id|Proc_Scsi_Pci2220i
op_assign
(brace
id|PROC_SCSI_PCI2220I
comma
l_int|7
comma
l_string|&quot;pci2220i&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
singleline_comment|//#define DEBUG 1
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
DECL|macro|STOP_HERE
mdefine_line|#define STOP_HERE&t;{int st;for(st=0;st&lt;100;st++){st=1;}}
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|STOP_HERE
mdefine_line|#define STOP_HERE
macro_line|#endif
DECL|macro|MAXADAPTER
mdefine_line|#define MAXADAPTER 4&t;/* Increase this and the sizes of the arrays below, if you need more. */
DECL|macro|MAX_BUS_MASTER_BLOCKS
mdefine_line|#define&t;MAX_BUS_MASTER_BLOCKS&t;1&t;&t;
singleline_comment|// This is the maximum we can bus master for (1024 bytes)
DECL|macro|PORT_DATA
mdefine_line|#define&t;PORT_DATA&t;&t;&t;&t;0
DECL|macro|PORT_ERROR
mdefine_line|#define&t;PORT_ERROR&t;&t;&t;&t;1
DECL|macro|PORT_SECTOR_COUNT
mdefine_line|#define&t;PORT_SECTOR_COUNT&t;&t;2
DECL|macro|PORT_LBA_0
mdefine_line|#define&t;PORT_LBA_0&t;&t;&t;&t;3
DECL|macro|PORT_LBA_8
mdefine_line|#define&t;PORT_LBA_8&t;&t;&t;&t;4
DECL|macro|PORT_LBA_16
mdefine_line|#define&t;PORT_LBA_16&t;&t;&t;&t;5
DECL|macro|PORT_LBA_24
mdefine_line|#define&t;PORT_LBA_24&t;&t;&t;&t;6
DECL|macro|PORT_STAT_CMD
mdefine_line|#define&t;PORT_STAT_CMD&t;&t;&t;7
DECL|macro|PORT_STAT_SEL
mdefine_line|#define&t;PORT_STAT_SEL&t;&t;&t;8
DECL|macro|PORT_FAIL
mdefine_line|#define&t;PORT_FAIL&t;&t;&t;&t;9
DECL|macro|PORT_ALT_STAT
mdefine_line|#define&t;PORT_ALT_STAT&t;&t;   &t;10
r_typedef
r_struct
(brace
DECL|member|device
id|UCHAR
id|device
suffix:semicolon
singleline_comment|// device code
DECL|member|byte6
id|UCHAR
id|byte6
suffix:semicolon
singleline_comment|// device select register image
DECL|member|spigot
id|UCHAR
id|spigot
suffix:semicolon
singleline_comment|// spigot number
DECL|member|sparebyte
id|UCHAR
id|sparebyte
suffix:semicolon
singleline_comment|// placeholder
DECL|member|sectors
id|USHORT
id|sectors
suffix:semicolon
singleline_comment|// number of sectors per track
DECL|member|heads
id|USHORT
id|heads
suffix:semicolon
singleline_comment|// number of heads
DECL|member|cylinders
id|USHORT
id|cylinders
suffix:semicolon
singleline_comment|// number of cylinders for this device
DECL|member|spareword
id|USHORT
id|spareword
suffix:semicolon
singleline_comment|// placeholder
DECL|member|blocks
id|ULONG
id|blocks
suffix:semicolon
singleline_comment|// number of blocks on device
DECL|typedef|OUR_DEVICE
DECL|typedef|POUR_DEVICE
)brace
id|OUR_DEVICE
comma
op_star
id|POUR_DEVICE
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ports
id|USHORT
id|ports
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|regDmaDesc
id|USHORT
id|regDmaDesc
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
DECL|member|regDmaCmdStat
id|USHORT
id|regDmaCmdStat
suffix:semicolon
singleline_comment|// Byte #1 of DMA command status register
DECL|member|regDmaAddrPci
id|USHORT
id|regDmaAddrPci
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
DECL|member|regDmaAddrLoc
id|USHORT
id|regDmaAddrLoc
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
DECL|member|regDmaCount
id|USHORT
id|regDmaCount
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
DECL|member|regDmaMode
id|USHORT
id|regDmaMode
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
DECL|member|regRemap
id|USHORT
id|regRemap
suffix:semicolon
singleline_comment|// 32 bit local space remap
DECL|member|regDesc
id|USHORT
id|regDesc
suffix:semicolon
singleline_comment|// 32 bit local region descriptor
DECL|member|regRange
id|USHORT
id|regRange
suffix:semicolon
singleline_comment|// 32 bit local range
DECL|member|regIrqControl
id|USHORT
id|regIrqControl
suffix:semicolon
singleline_comment|// 16 bit Interrupt enable/disable and status
DECL|member|regScratchPad
id|USHORT
id|regScratchPad
suffix:semicolon
singleline_comment|// scratch pad I/O base address
DECL|member|regBase
id|USHORT
id|regBase
suffix:semicolon
singleline_comment|// Base I/O register for data space
DECL|member|basePort
id|USHORT
id|basePort
suffix:semicolon
singleline_comment|// PLX base I/O port
DECL|member|timingMode
id|USHORT
id|timingMode
suffix:semicolon
singleline_comment|// timing mode currently set for adapter
DECL|member|timingAddress
id|ULONG
id|timingAddress
suffix:semicolon
singleline_comment|// address to use on adapter for current timing mode
DECL|member|device
id|OUR_DEVICE
id|device
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|ide
id|IDE_STRUCT
id|ide
suffix:semicolon
DECL|member|startSector
id|ULONG
id|startSector
suffix:semicolon
DECL|member|sectorCount
id|USHORT
id|sectorCount
suffix:semicolon
DECL|member|SCpnt
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
DECL|member|buffer
id|VOID
op_star
id|buffer
suffix:semicolon
DECL|member|expectingIRQ
id|USHORT
id|expectingIRQ
suffix:semicolon
DECL|member|readPhase
id|USHORT
id|readPhase
suffix:semicolon
DECL|typedef|ADAPTER2220I
DECL|typedef|PADAPTER2220I
)brace
id|ADAPTER2220I
comma
op_star
id|PADAPTER2220I
suffix:semicolon
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(host) ((PADAPTER2220I)&amp;host-&gt;hostdata)
DECL|variable|PsiHost
r_static
r_struct
id|Scsi_Host
op_star
id|PsiHost
(braket
id|MAXADAPTER
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
singleline_comment|// One for each adapter
DECL|variable|NumAdapters
r_static
r_int
id|NumAdapters
op_assign
l_int|0
suffix:semicolon
DECL|variable|identifyData
r_static
id|IDENTIFY_DATA
id|identifyData
suffix:semicolon
DECL|variable|DaleSetup
r_static
id|SETUP
id|DaleSetup
suffix:semicolon
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteData&t;:LOCAL&n; *&n; *&t;Description:&t;Write data to device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WriteData
r_static
r_int
id|WriteData
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|timer
suffix:semicolon
id|USHORT
op_star
id|pports
op_assign
id|padapter-&gt;ports
suffix:semicolon
id|timer
op_assign
id|jiffies
op_plus
id|TIMEOUT_DRQ
suffix:semicolon
singleline_comment|// calculate the timeout value
r_do
(brace
r_if
c_cond
(paren
id|inb_p
(paren
id|pports
(braket
id|PORT_STAT_CMD
)braket
)paren
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|outb_p
(paren
l_int|0
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// write operation
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|virt_to_bus
(paren
id|padapter-&gt;buffer
)paren
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|outl
(paren
(paren
id|ULONG
)paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|2
)braket
op_star
(paren
id|ULONG
)paren
l_int|512
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// interrupts off
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|timer
OG
id|jiffies
)paren
suffix:semicolon
singleline_comment|// test for timeout
id|padapter-&gt;ide.ide.ides.cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;IdeCmd&t;:LOCAL&n; *&n; *&t;Description:&t;Process a queued command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Zero if no error or status register contents on error.&n; *&n; ****************************************************************/
DECL|function|IdeCmd
r_static
id|UCHAR
id|IdeCmd
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|timer
suffix:semicolon
id|USHORT
op_star
id|pports
op_assign
id|padapter-&gt;ports
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ides.spigot
comma
id|pports
(braket
id|PORT_STAT_SEL
)braket
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
comma
id|pports
(braket
id|PORT_LBA_24
)braket
)paren
suffix:semicolon
singleline_comment|// select the drive
id|timer
op_assign
id|jiffies
op_plus
id|TIMEOUT_READY
suffix:semicolon
singleline_comment|// calculate the timeout value
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i Issueing new command: 0x%X&quot;
comma
id|padapter-&gt;ide.ide.ides.cmd
)paren
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;ports
(braket
id|PORT_STAT_CMD
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRDY
)paren
(brace
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|2
)braket
comma
id|pports
(braket
id|PORT_SECTOR_COUNT
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|3
)braket
comma
id|pports
(braket
id|PORT_LBA_0
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|4
)braket
comma
id|pports
(braket
id|PORT_LBA_8
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|5
)braket
comma
id|pports
(braket
id|PORT_LBA_16
)braket
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|1
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;ide.ide.ide
(braket
l_int|7
)braket
comma
id|pports
(braket
id|PORT_STAT_CMD
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;ide.ide.ides.cmd
op_eq
id|IDE_CMD_WRITE_MULTIPLE
)paren
r_return
(paren
id|WriteData
(paren
id|padapter
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|timer
OG
id|jiffies
)paren
suffix:semicolon
singleline_comment|// test for timeout
id|padapter-&gt;ide.ide.ides.cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;SetupTransfer&t;:LOCAL&n; *&n; *&t;Description:&t;Setup a data transfer command.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;drive&t; - Drive/head register upper nibble only.&n; *&n; *&t;Returns:&t;&t;TRUE if no data to transfer.&n; *&n; ****************************************************************/
DECL|function|SetupTransfer
r_static
r_int
id|SetupTransfer
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|drive
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
op_star
(paren
id|ULONG
op_star
)paren
id|padapter-&gt;ide.ide.ides.lba
op_assign
id|padapter-&gt;startSector
suffix:semicolon
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_or_assign
id|drive
suffix:semicolon
singleline_comment|//&t;&t;padapter-&gt;ide.ide.ides.sectors = ( padapter-&gt;sectorCount &gt; SECTORSXFER ) ? SECTORSXFER : padapter-&gt;sectorCount;
id|padapter-&gt;ide.ide.ides.sectors
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|padapter-&gt;ide.ide.ides.sectors
suffix:semicolon
singleline_comment|// bump the start and count for next xfer
id|padapter-&gt;startSector
op_add_assign
id|padapter-&gt;ide.ide.ides.sectors
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|padapter-&gt;ide.ide.ides.cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;DecodeError&t;:LOCAL&n; *&n; *&t;Description:&t;Decode and process device errors.&n; *&n; *&t;Parameters:&t;&t;pshost - Pointer to host data block.&n; *&t;&t;&t;&t;&t;status - Status register code.&n; *&n; *&t;Returns:&t;&t;The driver status code.&n; *&n; ****************************************************************/
DECL|function|DecodeError
r_static
id|ULONG
id|DecodeError
(paren
r_struct
id|Scsi_Host
op_star
id|pshost
comma
id|UCHAR
id|status
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
id|UCHAR
id|error
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_WRITE_FAULT
)paren
(brace
r_return
id|DID_PARITY
op_lshift
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_BUSY
)paren
r_return
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|error
op_assign
id|inb_p
(paren
id|padapter-&gt;ports
(braket
id|PORT_ERROR
)braket
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i error register: %x&quot;
comma
id|error
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|IDE_ERROR_AMNF
suffix:colon
r_case
id|IDE_ERROR_TKONF
suffix:colon
r_case
id|IDE_ERROR_ABRT
suffix:colon
r_case
id|IDE_ERROR_IDFN
suffix:colon
r_case
id|IDE_ERROR_UNC
suffix:colon
r_case
id|IDE_ERROR_BBK
suffix:colon
r_default
suffix:colon
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Irq_Handler&t;:LOCAL&n; *&n; *&t;Description:&t;Interrupt handler.&n; *&n; *&t;Parameters:&t;&t;irq&t;&t;- Hardware IRQ number.&n; *&t;&t;&t;&t;&t;dev_id&t;-&n; *&t;&t;&t;&t;&t;regs&t;-&n; *&n; *&t;Returns:&t;&t;TRUE if drive is not ready in time.&n; *&n; ****************************************************************/
DECL|function|Irq_Handler
r_static
r_void
id|Irq_Handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// Pointer to host data block
id|PADAPTER2220I
id|padapter
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|USHORT
op_star
id|pports
suffix:semicolon
singleline_comment|// I/O port array
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_int
id|z
suffix:semicolon
singleline_comment|//&t;DEB(printk (&quot;&bslash;npci2220i recieved interrupt&bslash;n&quot;));
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|NumAdapters
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// scan for interrupt to process
(brace
r_if
c_cond
(paren
id|PsiHost
(braket
id|z
)braket
op_member_access_from_pointer
id|irq
op_eq
(paren
id|UCHAR
)paren
(paren
id|irq
op_amp
l_int|0xFF
)paren
)paren
(brace
r_if
c_cond
(paren
id|inw_p
(paren
id|HOSTDATA
c_func
(paren
id|PsiHost
(braket
id|z
)braket
)paren
op_member_access_from_pointer
id|regIrqControl
)paren
op_amp
l_int|0x8000
)paren
(brace
id|shost
op_assign
id|PsiHost
(braket
id|z
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: not my interrupt&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
suffix:semicolon
id|pports
op_assign
id|padapter-&gt;ports
suffix:semicolon
id|SCpnt
op_assign
id|padapter-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;expectingIRQ
)paren
(brace
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i Unsolicited interrupt&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;ports
(braket
id|PORT_STAT_CMD
)braket
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
r_goto
id|irqerror
suffix:semicolon
r_switch
c_cond
(paren
id|padapter-&gt;ide.ide.ides.cmd
)paren
singleline_comment|// decide how to handle the interrupt
(brace
r_case
id|IDE_CMD_READ_MULTIPLE
suffix:colon
r_if
c_cond
(paren
id|padapter-&gt;readPhase
op_eq
l_int|1
)paren
singleline_comment|// is this a bus master channel complete?
(brace
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i processing read interrupt cleanup&quot;
)paren
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// cancel interrupt from DMA engine
id|padapter-&gt;buffer
op_add_assign
id|padapter-&gt;ide.ide.ides.sectors
op_star
l_int|512
suffix:semicolon
r_if
c_cond
(paren
id|SetupTransfer
(paren
id|padapter
comma
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_amp
l_int|0xF0
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|padapter-&gt;readPhase
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|IdeCmd
(paren
id|padapter
)paren
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i interrupt complete, waiting for another&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i processing read interrupt start bus master cycle&quot;
)paren
)paren
suffix:semicolon
id|outb_p
(paren
l_int|8
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// read operation
id|padapter-&gt;readPhase
op_assign
l_int|1
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|1
suffix:semicolon
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|virt_to_bus
(paren
id|padapter-&gt;buffer
)paren
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|outl
(paren
(paren
id|ULONG
)paren
id|padapter-&gt;ide.ide.ides.sectors
op_star
(paren
id|ULONG
)paren
l_int|512
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
id|outb_p
(paren
l_int|5
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// interrupt enable/disable
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IDE_CMD_WRITE_MULTIPLE
suffix:colon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i processing write interrupt cleanup&quot;
)paren
)paren
suffix:semicolon
id|padapter-&gt;buffer
op_add_assign
id|padapter-&gt;ide.ide.ides.sectors
op_star
l_int|512
suffix:semicolon
r_if
c_cond
(paren
id|SetupTransfer
(paren
id|padapter
comma
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_amp
l_int|0xF0
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|IdeCmd
(paren
id|padapter
)paren
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i interrupt complete, waiting for another&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IDE_COMMAND_IDENTIFY
suffix:colon
(brace
id|PINQUIRYDATA
id|pinquiryData
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i processing verify interrupt cleanup&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|insw
(paren
id|pports
(braket
id|PORT_DATA
)braket
comma
op_amp
id|identifyData
comma
r_sizeof
(paren
id|identifyData
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|memset
(paren
id|pinquiryData
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
singleline_comment|// Zero INQUIRY data structure.
id|pinquiryData-&gt;DeviceType
op_assign
l_int|0
suffix:semicolon
id|pinquiryData-&gt;Versions
op_assign
l_int|2
suffix:semicolon
id|pinquiryData-&gt;AdditionalLength
op_assign
l_int|35
op_minus
l_int|4
suffix:semicolon
singleline_comment|// Fill in vendor identification fields.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|20
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;VendorId
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.ModelNumber
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;VendorId
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.ModelNumber
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
singleline_comment|// Initialize unused portion of product id.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_increment
)paren
id|pinquiryData-&gt;ProductId
(braket
l_int|12
op_plus
id|z
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
singleline_comment|// Move firmware revision from IDENTIFY data to
singleline_comment|// product revision in INQUIRY data.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.FirmwareRevision
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|identifyData.FirmwareRevision
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i no real process here!&quot;
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|irqerror
suffix:colon
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i error  Device Status: %X&bslash;n&quot;
comma
id|status
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DecodeError
(paren
id|shost
comma
id|status
)paren
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_QueueCommand&n; *&n; *&t;Description:&t;Process a queued command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;done  - Pointer to done function to call.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_QueueCommand
r_int
id|Pci2220i_QueueCommand
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|UCHAR
op_star
id|cdb
op_assign
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
singleline_comment|// Pointer to SCSI CDB
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|SCpnt-&gt;target
)braket
suffix:semicolon
singleline_comment|// Pointer to device information
id|UCHAR
id|rc
suffix:semicolon
singleline_comment|// command return code
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|padapter-&gt;ide.ide.ides.spigot
op_assign
id|pdev-&gt;spigot
suffix:semicolon
id|padapter-&gt;buffer
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;device
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;pci2220i_queuecommand: %02X: done can&squot;t be NULL&bslash;n&quot;
comma
op_star
id|cdb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEB
(paren
r_if
(paren
op_star
id|cdb
)paren
id|printk
(paren
l_string|&quot;&bslash;nCDB: %X-  %X %X %X %X %X %X %X %X %X %X &quot;
comma
id|SCpnt-&gt;cmd_len
comma
id|cdb
(braket
l_int|0
)braket
comma
id|cdb
(braket
l_int|1
)braket
comma
id|cdb
(braket
l_int|2
)braket
comma
id|cdb
(braket
l_int|3
)braket
comma
id|cdb
(braket
l_int|4
)braket
comma
id|cdb
(braket
l_int|5
)braket
comma
id|cdb
(braket
l_int|6
)braket
comma
id|cdb
(braket
l_int|7
)braket
comma
id|cdb
(braket
l_int|8
)braket
comma
id|cdb
(braket
l_int|9
)braket
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|cdb
)paren
(brace
r_case
id|SCSIOP_INQUIRY
suffix:colon
singleline_comment|// inquiry CDB
(brace
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_assign
id|pdev-&gt;byte6
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_COMMAND_IDENTIFY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SCSIOP_TEST_UNIT_READY
suffix:colon
singleline_comment|// test unit ready CDB
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSIOP_READ_CAPACITY
suffix:colon
singleline_comment|// read capctiy CDB
(brace
id|PREAD_CAPACITY_DATA
id|pdata
op_assign
(paren
id|PREAD_CAPACITY_DATA
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|pdata-&gt;blksiz
op_assign
l_int|0x20000
suffix:semicolon
id|XANY2SCSI
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|pdata-&gt;blks
comma
id|pdev-&gt;blocks
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SCSIOP_VERIFY
suffix:colon
singleline_comment|// verify CDB
op_star
(paren
id|ULONG
op_star
)paren
id|padapter-&gt;ide.ide.ides.lba
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ide
(braket
l_int|6
)braket
op_or_assign
id|pdev-&gt;byte6
suffix:semicolon
id|padapter-&gt;ide.ide.ide
(braket
l_int|2
)braket
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_COMMAND_VERIFY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ
suffix:colon
singleline_comment|// read10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_READ_MULTIPLE
suffix:semicolon
id|padapter-&gt;readPhase
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ6
suffix:colon
singleline_comment|// read6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_READ_MULTIPLE
suffix:semicolon
id|padapter-&gt;readPhase
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE
suffix:colon
singleline_comment|// write10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_WRITE_MULTIPLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE6
suffix:colon
singleline_comment|// write6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|SetupTransfer
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|padapter-&gt;ide.ide.ides.cmd
op_assign
id|IDE_CMD_WRITE_MULTIPLE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEB
(paren
id|printk
(paren
l_string|&quot;pci2220i_queuecommand: Unsupported command %02X&bslash;n&quot;
comma
op_star
id|cdb
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
singleline_comment|// Save this command data
id|rc
op_assign
id|IdeCmd
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;pci2220i_queuecommand: %02X, %02X: Device failed to respond for command&bslash;n&quot;
comma
op_star
id|cdb
comma
id|padapter-&gt;ide.ide.ides.cmd
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;ide.ide.ides.cmd
op_eq
id|IDE_CMD_WRITE_MULTIPLE
)paren
(brace
r_if
c_cond
(paren
id|WriteData
(paren
id|padapter
)paren
)paren
(brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;pci2220i_queuecommand: %02X, %02X: Device failed to accept data&bslash;n&quot;
comma
op_star
id|cdb
comma
id|padapter-&gt;ide.ide.ides.cmd
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|DEB
(paren
id|printk
c_func
(paren
l_string|&quot;  now waiting for initial interrupt &quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|SCpnt-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Command&n; *&n; *&t;Description:&t;Process a command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Command
r_int
id|Pci2220i_Command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;pci2220i_command: ..calling pci2220i_queuecommand&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCpnt-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;ReadFlash&n; *&n; *&t;Description:&t;Read information from controller Flash memory.&n; *&n; *&t;Parameters:&t;&t;hostdata - Pointer to host interface data structure.&n; *&t;&t;&t;&t;&t;pdata&t; - Pointer to data structures.&n; *&t;&t;&t;&t;&t;base&t; - base address in Flash.&n; *&t;&t;&t;&t;&t;length&t; - lenght of data space in bytes.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|ReadFlash
id|VOID
id|ReadFlash
(paren
id|PADAPTER2220I
id|hostdata
comma
id|VOID
op_star
id|pdata
comma
id|ULONG
id|base
comma
id|ULONG
id|length
)paren
(brace
id|ULONG
id|oldremap
suffix:semicolon
id|UCHAR
id|olddesc
suffix:semicolon
id|ULONG
id|z
suffix:semicolon
id|UCHAR
op_star
id|pd
op_assign
(paren
id|UCHAR
op_star
)paren
id|pdata
suffix:semicolon
id|oldremap
op_assign
id|inl
(paren
id|hostdata-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// save values to restore later
id|olddesc
op_assign
id|inb_p
(paren
id|hostdata-&gt;regDesc
)paren
suffix:semicolon
id|outl
(paren
id|base
op_or
l_int|1
comma
id|hostdata-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// remap to Flash space as specified
id|outb_p
(paren
l_int|0x40
comma
id|hostdata-&gt;regDesc
)paren
suffix:semicolon
singleline_comment|// describe remap region as 8 bit
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|length
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// get &quot;length&quot; data count
op_star
id|pd
op_increment
op_assign
id|inb_p
(paren
id|hostdata-&gt;regBase
op_plus
id|z
)paren
suffix:semicolon
singleline_comment|// read in the data
id|outl
(paren
id|oldremap
comma
id|hostdata-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// restore remap register values
id|outb_p
(paren
id|olddesc
comma
id|hostdata-&gt;regDesc
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Detect&n; *&n; *&t;Description:&t;Detect and initialize our boards.&n; *&n; *&t;Parameters:&t;&t;tpnt - Pointer to SCSI host template structure.&n; *&n; *&t;Returns:&t;&t;Number of adapters found.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Detect
r_int
id|Pci2220i_Detect
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|pci_index
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|pshost
suffix:semicolon
id|PADAPTER2220I
id|hostdata
suffix:semicolon
id|ULONG
id|modearray
(braket
)braket
op_assign
(brace
id|DALE_DATA_MODE2
comma
id|DALE_DATA_MODE3
comma
id|DALE_DATA_MODE4
comma
id|DALE_DATA_MODE4P
)brace
suffix:semicolon
r_int
id|unit
suffix:semicolon
r_int
id|z
suffix:semicolon
r_int
id|setirq
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_present
(paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|pci_index
op_assign
l_int|0
suffix:semicolon
id|pci_index
op_le
id|MAXADAPTER
suffix:semicolon
op_increment
id|pci_index
)paren
(brace
id|UCHAR
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_find_device
(paren
id|VENDOR_PSI
comma
id|DEVICE_DALE_1
comma
id|pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|pshost
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
id|ADAPTER2220I
)paren
)paren
suffix:semicolon
id|hostdata
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
id|pcibios_read_config_word
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|hostdata-&gt;basePort
)paren
suffix:semicolon
id|hostdata-&gt;basePort
op_and_assign
l_int|0xFFFE
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nBase Regs = %#04X&quot;
comma
id|hostdata-&gt;basePort
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regRemap
op_assign
id|hostdata-&gt;basePort
op_plus
id|RTR_LOCAL_REMAP
suffix:semicolon
singleline_comment|// 32 bit local space remap
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regRemap
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regDesc
op_assign
id|hostdata-&gt;basePort
op_plus
id|RTR_REGIONS
suffix:semicolon
singleline_comment|// 32 bit local region descriptor
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regDesc
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regRange
op_assign
id|hostdata-&gt;basePort
op_plus
id|RTR_LOCAL_RANGE
suffix:semicolon
singleline_comment|// 32 bit local range
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regRange
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regIrqControl
op_assign
id|hostdata-&gt;basePort
op_plus
id|RTR_INT_CONTROL_STATUS
suffix:semicolon
singleline_comment|// 16 bit interupt control and status
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regIrqControl
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regScratchPad
op_assign
id|hostdata-&gt;basePort
op_plus
id|RTR_MAILBOX
suffix:semicolon
singleline_comment|// 16 byte scratchpad I/O base address
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regScratchPad
)paren
)paren
suffix:semicolon
id|pcibios_read_config_word
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_BASE_ADDRESS_2
comma
op_amp
id|hostdata-&gt;regBase
)paren
suffix:semicolon
id|hostdata-&gt;regBase
op_and_assign
l_int|0xFFFE
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|9
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// build regester address array
id|hostdata-&gt;ports
(braket
id|z
)braket
op_assign
id|hostdata-&gt;regBase
op_plus
l_int|0x80
op_plus
(paren
id|z
op_star
l_int|4
)paren
suffix:semicolon
id|hostdata-&gt;ports
(braket
id|PORT_FAIL
)braket
op_assign
id|hostdata-&gt;regBase
op_plus
id|REG_FAIL
suffix:semicolon
id|hostdata-&gt;ports
(braket
id|PORT_ALT_STAT
)braket
op_assign
id|hostdata-&gt;regBase
op_plus
id|REG_ALT_STAT
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPorts =&quot;
)paren
)paren
suffix:semicolon
id|DEB
(paren
r_for
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|11
suffix:semicolon
id|z
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;ports
(braket
id|z
)braket
)paren
suffix:semicolon
)paren
suffix:semicolon
id|hostdata-&gt;regDmaDesc
op_assign
id|hostdata-&gt;regBase
op_plus
id|RTL_DMA1_DESC_PTR
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nDMA Regs = %#04X&quot;
comma
id|hostdata-&gt;regDmaDesc
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regDmaCmdStat
op_assign
id|hostdata-&gt;regBase
op_plus
id|RTL_DMA_COMMAND_STATUS
op_plus
l_int|1
suffix:semicolon
singleline_comment|// Byte #1 of DMA command status register
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regDmaCmdStat
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regDmaAddrPci
op_assign
id|hostdata-&gt;regBase
op_plus
id|RTL_DMA1_PCI_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regDmaAddrPci
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regDmaAddrLoc
op_assign
id|hostdata-&gt;regBase
op_plus
id|RTL_DMA1_LOCAL_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regDmaAddrLoc
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regDmaCount
op_assign
id|hostdata-&gt;regBase
op_plus
id|RTL_DMA1_COUNT
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regDmaCount
)paren
)paren
suffix:semicolon
id|hostdata-&gt;regDmaMode
op_assign
id|hostdata-&gt;regBase
op_plus
id|RTL_DMA1_MODE
op_plus
l_int|1
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
id|DEB
(paren
id|printk
(paren
l_string|&quot; %#04X&quot;
comma
id|hostdata-&gt;regDmaMode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inb_p
(paren
id|hostdata-&gt;regScratchPad
op_plus
id|DALE_NUM_DRIVES
)paren
)paren
singleline_comment|// if no devices on this board
r_goto
id|unregister
suffix:semicolon
id|pcibios_read_config_byte
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pshost-&gt;irq
)paren
suffix:semicolon
id|setirq
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|pci_index
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// scan for shared interrupts
(brace
r_if
c_cond
(paren
id|PsiHost
(braket
id|z
)braket
op_member_access_from_pointer
id|irq
op_eq
id|pshost-&gt;irq
)paren
singleline_comment|// if shared then, don&squot;t posses
id|setirq
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setirq
)paren
singleline_comment|// if not shared, posses
(brace
r_if
c_cond
(paren
id|request_irq
(paren
id|pshost-&gt;irq
comma
id|Irq_Handler
comma
l_int|0
comma
l_string|&quot;pci2220i&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to allocate IRQ for PSI-2220I controller.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unregister
suffix:semicolon
)brace
)brace
id|PsiHost
(braket
id|pci_index
)braket
op_assign
id|pshost
suffix:semicolon
singleline_comment|// save SCSI_HOST pointer
id|pshost-&gt;unique_id
op_assign
id|hostdata-&gt;regBase
suffix:semicolon
id|pshost-&gt;max_id
op_assign
l_int|4
suffix:semicolon
id|outb_p
(paren
l_int|0x01
comma
id|hostdata-&gt;regRange
)paren
suffix:semicolon
singleline_comment|// fix our range register because other drivers want to tromp on it
id|hostdata-&gt;timingMode
op_assign
id|inb_p
(paren
id|hostdata-&gt;regScratchPad
op_plus
id|DALE_TIMING_MODE
)paren
suffix:semicolon
id|hostdata-&gt;timingAddress
op_assign
id|modearray
(braket
id|hostdata-&gt;timingMode
op_minus
l_int|2
)braket
suffix:semicolon
id|ReadFlash
(paren
id|hostdata
comma
op_amp
id|DaleSetup
comma
id|DALE_FLASH_SETUP
comma
r_sizeof
(paren
id|SETUP
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|inb_p
(paren
id|hostdata-&gt;regScratchPad
op_plus
id|DALE_NUM_DRIVES
)paren
suffix:semicolon
op_increment
id|z
)paren
(brace
id|unit
op_assign
id|inb_p
(paren
id|hostdata-&gt;regScratchPad
op_plus
id|DALE_CHANNEL_DEVICE_0
op_plus
id|z
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|device
op_assign
id|inb_p
(paren
id|hostdata-&gt;regScratchPad
op_plus
id|DALE_SCRATH_DEVICE_0
op_plus
id|unit
)paren
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|byte6
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
(paren
id|unit
op_amp
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
l_int|0xE0
)paren
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|spigot
op_assign
(paren
id|UCHAR
)paren
(paren
l_int|1
op_lshift
(paren
id|unit
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|sectors
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|sectors
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|heads
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|heads
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|cylinders
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|cylinders
suffix:semicolon
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|blocks
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|blocks
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nHOSTDATA-&gt;device    = %X&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|device
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          byte6     = %X&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|byte6
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          spigot    = %X&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|spigot
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          sectors   = %X&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|sectors
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          heads     = %X&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|heads
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          cylinders = %X&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|cylinders
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n          blocks    = %lX&quot;
comma
id|hostdata-&gt;device
(braket
id|unit
)braket
dot
id|blocks
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nPSI-2220I EIDE CONTROLLER: at I/O = %X/%X  IRQ = %d&bslash;n&quot;
comma
id|hostdata-&gt;basePort
comma
id|hostdata-&gt;regBase
comma
id|pshost-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(C) 1997 Perceptive Solutions, Inc. All rights reserved&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
id|unregister
suffix:colon
id|scsi_unregister
(paren
id|pshost
)paren
suffix:semicolon
id|NumAdapters
op_increment
suffix:semicolon
)brace
)brace
r_return
id|NumAdapters
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Abort&n; *&n; *&t;Description:&t;Process the Abort command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Allways snooze.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Abort
r_int
id|Pci2220i_Abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;pci2220i_abort&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Reset&n; *&n; *&t;Description:&t;Process the Reset command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;flags - Flags about the reset command&n; *&n; *&t;Returns:&t;&t;No active command at this time, so this means&n; *&t;&t;&t;&t;&t;that each time we got some kind of response the&n; *&t;&t;&t;&t;&t;last time through.  Tell the mid-level code to&n; *&t;&t;&t;&t;&t;request sense information in order to decide what&n; *&t;&t;&t;&t;&t;to do next.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Reset
r_int
id|Pci2220i_Reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
macro_line|#include &quot;sd.h&quot;
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_BiosParam&n; *&n; *&t;Description:&t;Process the biosparam request from the SCSI manager to&n; *&t;&t;&t;&t;&t;return C/H/S data.&n; *&n; *&t;Parameters:&t;&t;disk - Pointer to SCSI disk structure.&n; *&t;&t;&t;&t;&t;dev&t; - Major/minor number from kernel.&n; *&t;&t;&t;&t;&t;geom - Pointer to integer array to place geometry data.&n; *&n; *&t;Returns:&t;&t;zero.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_BiosParam
r_int
id|Pci2220i_BiosParam
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|pdev
op_assign
op_amp
(paren
id|HOSTDATA
c_func
(paren
id|disk-&gt;device-&gt;host
)paren
op_member_access_from_pointer
id|device
(braket
id|disk-&gt;device-&gt;id
)braket
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|pdev-&gt;heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|pdev-&gt;sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|pdev-&gt;cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|PCI2220I
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
