multiline_comment|/****************************************************************************&n; * Perceptive Solutions, Inc. PCI-2220I device driver for Linux.&n; *&n; * pci2220i.c - Linux Host Driver for PCI-2220I EIDE RAID Adapters&n; *&n; * Copyright (c) 1997-1999 Perceptive Solutions, Inc.&n; * All Rights Reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that redistributions of source&n; * code retain the above copyright notice and this comment without&n; * modification.&n; *&n; * Technical updates and product information at:&n; *  http://www.psidisk.com&n; *&n; * Please send questions, comments, bug reports to:&n; *  tech@psidisk.com Technical Support&n; *&n; *&n; *&t;Revisions 1.10&t;&t;Mar-26-1999&n; *&t;&t;- Updated driver for RAID and hot reconstruct support.&n; *&n; *&t;Revisions 1.11&t;&t;Mar-26-1999&n; *&t;&t;- Fixed spinlock and PCI configuration.&n; *&n; *&t;Revision 2.00&t;&t;December-1-1999&n; *&t;&t;- Added code for the PCI-2240I controller&n; *&t;&t;- Added code for ATAPI devices.&n; *&t;&t;- Double buffer for scatter/gather support&n; *&n; *&t;Revision 2.10&t;&t;March-27-2000&n; *&t;&t;- Added support for dynamic DMA&n; *&n; ****************************************************************************/
singleline_comment|//#define DEBUG 1
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;pci2220i.h&quot;
macro_line|#include &quot;psi_dale.h&quot;
DECL|macro|PCI2220I_VERSION
mdefine_line|#define&t;PCI2220I_VERSION&t;&t;&quot;2.10&quot;
DECL|macro|READ_CMD
mdefine_line|#define&t;READ_CMD&t;&t;&t;&t;IDE_CMD_READ_MULTIPLE
DECL|macro|WRITE_CMD
mdefine_line|#define&t;WRITE_CMD&t;&t;&t;&t;IDE_CMD_WRITE_MULTIPLE
DECL|macro|MAX_BUS_MASTER_BLOCKS
mdefine_line|#define&t;MAX_BUS_MASTER_BLOCKS&t;SECTORSXFER&t;&t;
singleline_comment|// This is the maximum we can bus master
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
DECL|macro|STOP_HERE
mdefine_line|#define STOP_HERE()&t;{int st;for(st=0;st&lt;100;st++){st=1;}}
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|STOP_HERE
mdefine_line|#define STOP_HERE()
macro_line|#endif
DECL|macro|MAXADAPTER
mdefine_line|#define MAXADAPTER 4&t;&t;&t;&t;&t;
singleline_comment|// Increase this and the sizes of the arrays below, if you need more.
r_typedef
r_struct
(brace
DECL|member|byte6
id|UCHAR
id|byte6
suffix:semicolon
singleline_comment|// device select register image
DECL|member|spigot
id|UCHAR
id|spigot
suffix:semicolon
singleline_comment|// spigot number
DECL|member|spigots
id|UCHAR
id|spigots
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// RAID spigots
DECL|member|deviceID
id|UCHAR
id|deviceID
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// device ID codes
DECL|member|sectors
id|USHORT
id|sectors
suffix:semicolon
singleline_comment|// number of sectors per track
DECL|member|heads
id|USHORT
id|heads
suffix:semicolon
singleline_comment|// number of heads
DECL|member|cylinders
id|USHORT
id|cylinders
suffix:semicolon
singleline_comment|// number of cylinders for this device
DECL|member|spareword
id|USHORT
id|spareword
suffix:semicolon
singleline_comment|// placeholder
DECL|member|blocks
id|ULONG
id|blocks
suffix:semicolon
singleline_comment|// number of blocks on device
DECL|member|DiskMirror
id|DISK_MIRROR
id|DiskMirror
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// RAID status and control
DECL|member|lastsectorlba
id|ULONG
id|lastsectorlba
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// last addressable sector on the drive
DECL|member|raid
id|USHORT
id|raid
suffix:semicolon
singleline_comment|// RAID active flag
DECL|member|mirrorRecon
id|USHORT
id|mirrorRecon
suffix:semicolon
DECL|member|reconOn
id|UCHAR
id|reconOn
suffix:semicolon
DECL|member|reconCount
id|USHORT
id|reconCount
suffix:semicolon
DECL|member|reconIsStarting
id|USHORT
id|reconIsStarting
suffix:semicolon
singleline_comment|// indicate hot reconstruct is starting
DECL|member|cmdDrqInt
id|UCHAR
id|cmdDrqInt
suffix:semicolon
singleline_comment|// flag for command interrupt
DECL|member|packet
id|UCHAR
id|packet
suffix:semicolon
singleline_comment|// command packet size in bytes
DECL|typedef|OUR_DEVICE
DECL|typedef|POUR_DEVICE
)brace
id|OUR_DEVICE
comma
op_star
id|POUR_DEVICE
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|bigD
id|USHORT
id|bigD
suffix:semicolon
singleline_comment|// identity is a PCI-2240I if true, otherwise a PCI-2220I
DECL|member|atapi
id|USHORT
id|atapi
suffix:semicolon
singleline_comment|// this interface is for ATAPI devices only
DECL|member|regDmaDesc
id|ULONG
id|regDmaDesc
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
DECL|member|regDmaCmdStat
id|ULONG
id|regDmaCmdStat
suffix:semicolon
singleline_comment|// Byte #1 of DMA command status register
DECL|member|regDmaAddrPci
id|ULONG
id|regDmaAddrPci
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
DECL|member|regDmaAddrLoc
id|ULONG
id|regDmaAddrLoc
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
DECL|member|regDmaCount
id|ULONG
id|regDmaCount
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
DECL|member|regDmaMode
id|ULONG
id|regDmaMode
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
DECL|member|regRemap
id|ULONG
id|regRemap
suffix:semicolon
singleline_comment|// 32 bit local space remap
DECL|member|regDesc
id|ULONG
id|regDesc
suffix:semicolon
singleline_comment|// 32 bit local region descriptor
DECL|member|regRange
id|ULONG
id|regRange
suffix:semicolon
singleline_comment|// 32 bit local range
DECL|member|regIrqControl
id|ULONG
id|regIrqControl
suffix:semicolon
singleline_comment|// 16 bit Interrupt enable/disable and status
DECL|member|regScratchPad
id|ULONG
id|regScratchPad
suffix:semicolon
singleline_comment|// scratch pad I/O base address
DECL|member|regBase
id|ULONG
id|regBase
suffix:semicolon
singleline_comment|// Base I/O register for data space
DECL|member|regData
id|ULONG
id|regData
suffix:semicolon
singleline_comment|// data register I/O address
DECL|member|regError
id|ULONG
id|regError
suffix:semicolon
singleline_comment|// error register I/O address
DECL|member|regSectCount
id|ULONG
id|regSectCount
suffix:semicolon
singleline_comment|// sector count register I/O address
DECL|member|regLba0
id|ULONG
id|regLba0
suffix:semicolon
singleline_comment|// least significant byte of LBA
DECL|member|regLba8
id|ULONG
id|regLba8
suffix:semicolon
singleline_comment|// next least significant byte of LBA
DECL|member|regLba16
id|ULONG
id|regLba16
suffix:semicolon
singleline_comment|// next most significan byte of LBA
DECL|member|regLba24
id|ULONG
id|regLba24
suffix:semicolon
singleline_comment|// head and most 4 significant bits of LBA
DECL|member|regStatCmd
id|ULONG
id|regStatCmd
suffix:semicolon
singleline_comment|// status on read and command on write register
DECL|member|regStatSel
id|ULONG
id|regStatSel
suffix:semicolon
singleline_comment|// board status on read and spigot select on write register
DECL|member|regFail
id|ULONG
id|regFail
suffix:semicolon
singleline_comment|// fail bits control register
DECL|member|regAltStat
id|ULONG
id|regAltStat
suffix:semicolon
singleline_comment|// alternate status and drive control register
DECL|member|basePort
id|ULONG
id|basePort
suffix:semicolon
singleline_comment|// PLX base I/O port
DECL|member|timingMode
id|USHORT
id|timingMode
suffix:semicolon
singleline_comment|// timing mode currently set for adapter
DECL|member|timingPIO
id|USHORT
id|timingPIO
suffix:semicolon
singleline_comment|// TRUE if PIO timing is active
DECL|member|pcidev
r_struct
id|pci_dev
op_star
id|pcidev
suffix:semicolon
DECL|member|timingAddress
id|ULONG
id|timingAddress
suffix:semicolon
singleline_comment|// address to use on adapter for current timing mode
DECL|member|irqOwned
id|ULONG
id|irqOwned
suffix:semicolon
singleline_comment|// owned IRQ or zero if shared
DECL|member|numberOfDrives
id|UCHAR
id|numberOfDrives
suffix:semicolon
singleline_comment|// saved number of drives on this controller
DECL|member|failRegister
id|UCHAR
id|failRegister
suffix:semicolon
singleline_comment|// current inverted data in fail register
DECL|member|device
id|OUR_DEVICE
id|device
(braket
id|BIGD_MAXDRIVES
)braket
suffix:semicolon
DECL|member|raidData
id|DISK_MIRROR
op_star
id|raidData
(braket
id|BIGD_MAXDRIVES
)braket
suffix:semicolon
DECL|member|startSector
id|ULONG
id|startSector
suffix:semicolon
DECL|member|sectorCount
id|USHORT
id|sectorCount
suffix:semicolon
DECL|member|readCount
id|ULONG
id|readCount
suffix:semicolon
DECL|member|currentSgBuffer
id|UCHAR
op_star
id|currentSgBuffer
suffix:semicolon
DECL|member|currentSgCount
id|ULONG
id|currentSgCount
suffix:semicolon
DECL|member|nextSg
id|USHORT
id|nextSg
suffix:semicolon
DECL|member|cmd
id|UCHAR
id|cmd
suffix:semicolon
DECL|member|SCpnt
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
DECL|member|pdev
id|POUR_DEVICE
id|pdev
suffix:semicolon
singleline_comment|// current device opearating on
DECL|member|devInReconIndex
id|USHORT
id|devInReconIndex
suffix:semicolon
DECL|member|expectingIRQ
id|USHORT
id|expectingIRQ
suffix:semicolon
DECL|member|reconOn
id|USHORT
id|reconOn
suffix:semicolon
singleline_comment|// Hot reconstruct is to be done.
DECL|member|reconPhase
id|USHORT
id|reconPhase
suffix:semicolon
singleline_comment|// Hot reconstruct operation is in progress.
DECL|member|reconSize
id|ULONG
id|reconSize
suffix:semicolon
DECL|member|demoFail
id|USHORT
id|demoFail
suffix:semicolon
singleline_comment|// flag for RAID failure demonstration
DECL|member|survivor
id|USHORT
id|survivor
suffix:semicolon
DECL|member|failinprog
id|USHORT
id|failinprog
suffix:semicolon
DECL|member|reconTimer
r_struct
id|timer_list
id|reconTimer
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|kBuffer
id|UCHAR
op_star
id|kBuffer
suffix:semicolon
DECL|member|kBufferDma
id|dma_addr_t
id|kBufferDma
suffix:semicolon
DECL|member|reqSense
id|UCHAR
id|reqSense
suffix:semicolon
DECL|member|atapiCdb
id|UCHAR
id|atapiCdb
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|atapiSpecial
id|UCHAR
id|atapiSpecial
suffix:semicolon
DECL|typedef|ADAPTER2220I
DECL|typedef|PADAPTER2220I
)brace
id|ADAPTER2220I
comma
op_star
id|PADAPTER2220I
suffix:semicolon
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(host) ((PADAPTER2220I)&amp;host-&gt;hostdata)
DECL|macro|RECON_PHASE_READY
mdefine_line|#define&t;RECON_PHASE_READY&t;&t;0x01
DECL|macro|RECON_PHASE_COPY
mdefine_line|#define&t;RECON_PHASE_COPY&t;&t;0x02
DECL|macro|RECON_PHASE_UPDATE
mdefine_line|#define&t;RECON_PHASE_UPDATE&t;&t;0x03
DECL|macro|RECON_PHASE_LAST
mdefine_line|#define&t;RECON_PHASE_LAST&t;&t;0x04
DECL|macro|RECON_PHASE_END
mdefine_line|#define&t;RECON_PHASE_END&t;&t;&t;0x07&t;
DECL|macro|RECON_PHASE_MARKING
mdefine_line|#define&t;RECON_PHASE_MARKING&t;&t;0x80
DECL|macro|RECON_PHASE_FAILOVER
mdefine_line|#define&t;RECON_PHASE_FAILOVER&t;0xFF
DECL|variable|PsiHost
r_static
r_struct
id|Scsi_Host
op_star
id|PsiHost
(braket
id|MAXADAPTER
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
singleline_comment|// One for each adapter
DECL|variable|NumAdapters
r_static
r_int
id|NumAdapters
op_assign
l_int|0
suffix:semicolon
DECL|variable|Installed
r_static
r_int
id|Installed
op_assign
l_int|0
suffix:semicolon
DECL|variable|DaleSetup
r_static
id|SETUP
id|DaleSetup
suffix:semicolon
DECL|variable|DiskMirror
r_static
id|DISK_MIRROR
id|DiskMirror
(braket
id|BIGD_MAXDRIVES
)braket
suffix:semicolon
DECL|variable|ModeArray
r_static
id|ULONG
id|ModeArray
(braket
)braket
op_assign
(brace
id|DALE_DATA_MODE2
comma
id|DALE_DATA_MODE3
comma
id|DALE_DATA_MODE4
comma
id|DALE_DATA_MODE5
)brace
suffix:semicolon
DECL|variable|ModeArray2
r_static
id|ULONG
id|ModeArray2
(braket
)braket
op_assign
(brace
id|BIGD_DATA_MODE2
comma
id|BIGD_DATA_MODE3
comma
id|BIGD_DATA_MODE4
comma
id|BIGD_DATA_MODE5
)brace
suffix:semicolon
r_static
r_void
id|ReconTimerExpiry
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
multiline_comment|/*******************************************************************************************************&n; *&t;Name:&t;&t;&t;Alarm&n; *&n; *&t;Description:&t;Sound the for the given device&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;device&t; - Device number.&n; *&t;&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ******************************************************************************************************/
DECL|function|Alarm
r_static
r_void
id|Alarm
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|device
)paren
(brace
id|UCHAR
id|zc
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
(brace
id|zc
op_assign
id|device
op_or
(paren
id|FAIL_ANY
op_or
id|FAIL_AUDIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;failRegister
op_amp
id|FAIL_ANY
)paren
id|zc
op_or_assign
id|FAIL_MULTIPLE
suffix:semicolon
id|padapter-&gt;failRegister
op_assign
id|zc
suffix:semicolon
id|outb_p
(paren
op_complement
id|zc
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
)brace
r_else
id|outb_p
(paren
l_int|0x3C
op_or
(paren
l_int|1
op_lshift
id|device
)paren
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
singleline_comment|// sound alarm and set fail light&t;&t;
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;MuteAlarm&t;:LOCAL&n; *&n; *&t;Description:&t;Mute the audible alarm.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|MuteAlarm
r_static
r_void
id|MuteAlarm
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|UCHAR
id|old
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
(brace
id|padapter-&gt;failRegister
op_and_assign
op_complement
id|FAIL_AUDIBLE
suffix:semicolon
id|outb_p
(paren
op_complement
id|padapter-&gt;failRegister
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
)brace
r_else
(brace
id|old
op_assign
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_rshift
l_int|3
)paren
op_or
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_amp
l_int|0x83
)paren
suffix:semicolon
id|outb_p
(paren
id|old
op_or
l_int|0x40
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WaitReady&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WaitReady
r_static
r_int
id|WaitReady
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|z
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
id|TIMEOUT_READY
op_star
l_int|4
)paren
suffix:semicolon
id|z
op_increment
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|IDE_STATUS_DRDY
op_or
id|IDE_STATUS_BUSY
)paren
)paren
op_eq
id|IDE_STATUS_DRDY
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WaitReadyReset&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WaitReadyReset
r_static
r_int
id|WaitReadyReset
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|z
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
l_int|125
op_star
l_int|16
)paren
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// wait up to 1/4 second
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|IDE_STATUS_DRDY
op_or
id|IDE_STATUS_BUSY
)paren
)paren
op_eq
id|IDE_STATUS_DRDY
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I:  Reset took %ld mSec to be ready&quot;
comma
id|z
op_div
l_int|8
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
(paren
l_int|125
)paren
suffix:semicolon
)brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I:  Reset took more than 2 Seconds to come ready, Disk Failure&quot;
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WaitDrq&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready for data transfer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WaitDrq
r_static
r_int
id|WaitDrq
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|z
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
id|TIMEOUT_DRQ
op_star
l_int|4
)paren
suffix:semicolon
id|z
op_increment
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiWaitReady&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device busy and DRQ to be cleared.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;msec&t; - Number of milliseconds to wait.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not clear busy in time.&n; *&n; ****************************************************************/
DECL|function|AtapiWaitReady
r_static
r_int
id|AtapiWaitReady
(paren
id|PADAPTER2220I
id|padapter
comma
r_int
id|msec
)paren
(brace
r_int
id|z
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
id|msec
op_star
l_int|16
)paren
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
op_amp
(paren
id|IDE_STATUS_BUSY
op_or
id|IDE_STATUS_DRQ
)paren
)paren
)paren
r_return
id|FALSE
suffix:semicolon
id|udelay
(paren
l_int|125
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiWaitDrq&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready for data transfer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;msec&t; - Number of milliseconds to wait.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|AtapiWaitDrq
r_static
r_int
id|AtapiWaitDrq
(paren
id|PADAPTER2220I
id|padapter
comma
r_int
id|msec
)paren
(brace
id|ULONG
id|z
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
id|msec
op_star
l_int|16
)paren
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
op_amp
id|IDE_STATUS_DRQ
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|128
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;HardReset&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready for data transfer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&t;&t;&t;&t;&t;spigot&t; - Spigot number.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|HardReset
r_static
r_int
id|HardReset
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
id|UCHAR
id|spigot
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i:RESET  spigot = %X  devices = %d, %d&quot;
comma
id|spigot
comma
id|pdev-&gt;deviceID
(braket
l_int|0
)braket
comma
id|pdev-&gt;deviceID
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|mdelay
(paren
l_int|100
)paren
suffix:semicolon
singleline_comment|// just wait 100 mSec to let drives flush&t;
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0E
comma
id|padapter-&gt;regAltStat
)paren
suffix:semicolon
singleline_comment|// reset the suvivor
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
singleline_comment|// wait a little&t;
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regAltStat
)paren
suffix:semicolon
singleline_comment|// clear the reset
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xA0
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the master drive
r_if
c_cond
(paren
id|WaitReadyReset
(paren
id|padapter
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: master not ready after reset&quot;
)paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|outb_p
(paren
l_int|0xB0
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// try the slave drive
r_if
c_cond
(paren
(paren
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
op_amp
(paren
id|IDE_STATUS_DRDY
op_or
id|IDE_STATUS_BUSY
)paren
)paren
op_eq
id|IDE_STATUS_DRDY
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I: initializing slave drive on spigot %X&quot;
comma
id|spigot
)paren
)paren
suffix:semicolon
id|outb_p
(paren
id|SECTORSXFER
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_CMD_SET_MULTIPLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: slave not ready after set multiple&quot;
)paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
)brace
id|outb_p
(paren
l_int|0xA0
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|outb_p
(paren
id|SECTORSXFER
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_CMD_SET_MULTIPLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: master not ready after set multiple&quot;
)paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiReset&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready for data transfer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not come ready.&n; *&n; ****************************************************************/
DECL|function|AtapiReset
r_static
r_int
id|AtapiReset
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
id|AtapiDevice
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|AtapiCountLo
(paren
id|padapter
comma
l_int|0
)paren
suffix:semicolon
id|AtapiCountHi
(paren
id|padapter
comma
l_int|0
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_ATAPI_RESET
)paren
suffix:semicolon
id|udelay
(paren
l_int|125
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AtapiWaitReady
(paren
id|padapter
comma
l_int|1000
)paren
)paren
r_return
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
op_logical_or
(paren
id|inb_p
(paren
id|padapter-&gt;regLba8
)paren
op_ne
l_int|0x14
)paren
op_logical_or
(paren
id|inb_p
(paren
id|padapter-&gt;regLba16
)paren
op_ne
l_int|0xEB
)paren
)paren
r_return
id|TRUE
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WalkScatGath&t;:LOCAL&n; *&n; *&t;Description:&t;Transfer data to/from scatter/gather buffers.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;datain   - TRUE if data read.&n; *&t;&t;&t;&t;&t;length   - Number of bytes to transfer.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|WalkScatGath
r_static
r_void
id|WalkScatGath
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|datain
comma
id|ULONG
id|length
)paren
(brace
id|ULONG
id|count
suffix:semicolon
id|UCHAR
op_star
id|buffer
op_assign
id|padapter-&gt;kBuffer
suffix:semicolon
r_while
c_loop
(paren
id|length
)paren
(brace
id|count
op_assign
(paren
id|length
OG
id|padapter-&gt;currentSgCount
)paren
ques
c_cond
id|padapter-&gt;currentSgCount
suffix:colon
id|length
suffix:semicolon
r_if
c_cond
(paren
id|datain
)paren
id|memcpy
(paren
id|padapter-&gt;currentSgBuffer
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
r_else
id|memcpy
(paren
id|buffer
comma
id|padapter-&gt;currentSgBuffer
comma
id|count
)paren
suffix:semicolon
id|padapter-&gt;currentSgCount
op_sub_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;currentSgCount
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;nextSg
OL
id|padapter-&gt;SCpnt-&gt;use_sg
)paren
(brace
id|padapter-&gt;currentSgBuffer
op_assign
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|padapter-&gt;SCpnt-&gt;request_buffer
)paren
(braket
id|padapter-&gt;nextSg
)braket
dot
id|address
suffix:semicolon
id|padapter-&gt;currentSgCount
op_assign
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|padapter-&gt;SCpnt-&gt;request_buffer
)paren
(braket
id|padapter-&gt;nextSg
)braket
dot
id|length
suffix:semicolon
id|padapter-&gt;nextSg
op_increment
suffix:semicolon
)brace
)brace
r_else
id|padapter-&gt;currentSgBuffer
op_add_assign
id|count
suffix:semicolon
id|length
op_sub_assign
id|count
suffix:semicolon
id|buffer
op_add_assign
id|count
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;BusMaster&t;:LOCAL&n; *&n; *&t;Description:&t;Do a bus master I/O.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;datain&t; - TRUE if data read.&n; *&t;&t;&t;&t;&t;irq&t;&t; - TRUE if bus master interrupt expected.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|BusMaster
r_static
r_void
id|BusMaster
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|datain
comma
id|UCHAR
id|irq
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
id|zl
op_mul_assign
(paren
id|ULONG
)paren
id|BYTES_PER_SECTOR
suffix:semicolon
r_if
c_cond
(paren
id|datain
)paren
(brace
id|padapter-&gt;readCount
op_assign
id|zl
suffix:semicolon
id|outb_p
(paren
l_int|8
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// read operation
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
(brace
r_if
c_cond
(paren
id|irq
op_logical_and
op_logical_neg
id|padapter-&gt;sectorCount
)paren
id|outb_p
(paren
l_int|0x0C
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// interrupt on
r_else
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
)brace
r_else
(brace
r_if
c_cond
(paren
id|irq
op_logical_and
op_logical_neg
id|padapter-&gt;sectorCount
)paren
id|outb_p
(paren
l_int|0x05
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// interrupt on
r_else
id|outb_p
(paren
l_int|0x01
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
)brace
)brace
r_else
(brace
id|outb_p
(paren
l_int|0x00
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// write operation
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt&t;&t;&t;&t;&t;&t;
r_else
id|outb_p
(paren
l_int|0x01
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
id|WalkScatGath
(paren
id|padapter
comma
id|FALSE
comma
id|zl
)paren
suffix:semicolon
)brace
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|padapter-&gt;kBufferDma
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|outl
(paren
id|zl
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiBusMaster&t;:LOCAL&n; *&n; *&t;Description:&t;Do a bus master I/O.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;datain&t; - TRUE if data read.&n; *&t;&t;&t;&t;&t;length&t; - Number of bytes to transfer.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|AtapiBusMaster
r_static
r_void
id|AtapiBusMaster
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|datain
comma
id|ULONG
id|length
)paren
(brace
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|padapter-&gt;kBufferDma
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|outl
(paren
id|length
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datain
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;readCount
)paren
id|WalkScatGath
(paren
id|padapter
comma
id|TRUE
comma
id|padapter-&gt;readCount
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// read operation
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
id|padapter-&gt;readCount
op_assign
id|length
suffix:semicolon
)brace
r_else
(brace
id|outb_p
(paren
l_int|0x00
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// write operation
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt&t;&t;&t;&t;&t;&t;
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;atapiSpecial
)paren
id|WalkScatGath
(paren
id|padapter
comma
id|FALSE
comma
id|length
)paren
suffix:semicolon
)brace
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteData&t;:LOCAL&n; *&n; *&t;Description:&t;Write data to device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WriteData
r_static
r_int
id|WriteData
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|WaitDrq
(paren
id|padapter
)paren
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|WalkScatGath
(paren
id|padapter
comma
id|FALSE
comma
id|zl
op_star
id|BYTES_PER_SECTOR
)paren
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|zl
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
)brace
r_else
id|BusMaster
(paren
id|padapter
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteDataBoth&t;:LOCAL&n; *&n; *&t;Description:&t;Write data to device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to adapter structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device structure&n; *&n; *&t;Returns:&t;&t;Index + 1 of drive not failed or zero for OK.&n; *&n; ****************************************************************/
DECL|function|WriteDataBoth
r_static
r_int
id|WriteDataBoth
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
id|UCHAR
id|status0
comma
id|status1
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|status0
op_assign
id|WaitDrq
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status0
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|status1
op_assign
id|WaitDrq
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status1
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_or
id|pdev-&gt;spigots
(braket
l_int|1
)braket
op_or
id|padapter-&gt;bigD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|WalkScatGath
(paren
id|padapter
comma
id|FALSE
comma
id|zl
op_star
id|BYTES_PER_SECTOR
)paren
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|zl
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
)brace
r_else
id|BusMaster
(paren
id|padapter
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_if
c_cond
(paren
id|status0
)paren
r_return
l_int|2
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;IdeCmd&t;:LOCAL&n; *&n; *&t;Description:&t;Process an IDE command.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&n; *&t;Returns:&t;&t;Zero if no error or status register contents on error.&n; *&n; ****************************************************************/
DECL|function|IdeCmd
r_static
id|UCHAR
id|IdeCmd
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|UCHAR
id|status
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
id|padapter-&gt;bigD
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|status
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|outb_p
(paren
id|padapter-&gt;sectorCount
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|padapter-&gt;cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;IdeCmdBoth&t;:LOCAL&n; *&n; *&t;Description:&t;Process an IDE command to both drivers.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device structure&n; *&n; *&t;Returns:&t;&t;Index + 1 of drive not failed or zero for OK.&n; *&n; ****************************************************************/
DECL|function|IdeCmdBoth
r_static
id|UCHAR
id|IdeCmdBoth
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|UCHAR
id|status0
suffix:semicolon
id|UCHAR
id|status1
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_or
id|pdev-&gt;spigots
(braket
l_int|1
)braket
)paren
suffix:semicolon
singleline_comment|// select the spigots
id|outb_p
(paren
id|padapter-&gt;pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|status0
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status0
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|status1
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status1
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_or
id|pdev-&gt;spigots
(braket
l_int|1
)braket
op_or
id|padapter-&gt;bigD
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;sectorCount
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|padapter-&gt;cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_if
c_cond
(paren
id|status0
)paren
r_return
l_int|2
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;OpDone&t;:LOCAL&n; *&n; *&t;Description:&t;Complete an operatoin done sequence.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host data block.&n; *&t;&t;&t;&t;&t;spigot&t; - Spigot select code.&n; *&t;&t;&t;&t;&t;device&t; - Device byte code.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|OpDone
r_static
r_void
id|OpDone
(paren
id|PADAPTER2220I
id|padapter
comma
id|ULONG
id|result
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|padapter-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
id|padapter-&gt;reconPhase
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;SCpnt
)paren
(brace
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|SCpnt-&gt;scsi_done
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|padapter-&gt;reconOn
)paren
(brace
id|ReconTimerExpiry
(paren
(paren
r_int
r_int
)paren
id|padapter
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|padapter-&gt;pdev
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconOn
op_logical_and
op_logical_neg
id|padapter-&gt;reconTimer.data
)paren
(brace
id|padapter-&gt;reconTimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
singleline_comment|// start in 1/4 second
id|padapter-&gt;reconTimer.data
op_assign
(paren
r_int
r_int
)paren
id|padapter
suffix:semicolon
id|add_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;InlineIdentify&t;:LOCAL&n; *&n; *&t;Description:&t;Do an intline inquiry on a drive.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host data block.&n; *&t;&t;&t;&t;&t;spigot&t; - Spigot select code.&n; *&t;&t;&t;&t;&t;device&t; - Device byte code.&n; *&n; *&t;Returns:&t;&t;Last addressable sector or zero if none.&n; *&n; ****************************************************************/
DECL|function|InlineIdentify
r_static
id|ULONG
id|InlineIdentify
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|spigot
comma
id|UCHAR
id|device
)paren
(brace
id|PIDENTIFY_DATA
id|pid
op_assign
(paren
id|PIDENTIFY_DATA
)paren
id|padapter-&gt;kBuffer
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|outb_p
(paren
(paren
id|device
op_lshift
l_int|4
)paren
op_or
l_int|0xA0
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_IDENTIFY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitDrq
(paren
id|padapter
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
r_sizeof
(paren
id|IDENTIFY_DATA
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|pid-&gt;LBATotalSectors
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiIdentify&t;:LOCAL&n; *&n; *&t;Description:&t;Do an intline inquiry on a drive.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host data block.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device table.&n; *&n; *&t;Returns:&t;&t;TRUE on error.&n; *&n; ****************************************************************/
DECL|function|AtapiIdentify
r_static
id|ULONG
id|AtapiIdentify
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|ATAPI_GENERAL_0
id|ag0
suffix:semicolon
id|USHORT
id|zs
suffix:semicolon
r_int
id|z
suffix:semicolon
id|AtapiDevice
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_ATAPI_IDENTIFY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AtapiWaitDrq
(paren
id|padapter
comma
l_int|3000
)paren
)paren
r_return
id|TRUE
suffix:semicolon
op_star
(paren
id|USHORT
op_star
)paren
op_amp
id|ag0
op_assign
id|inw_p
(paren
id|padapter-&gt;regData
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|255
suffix:semicolon
id|z
op_increment
)paren
id|zs
op_assign
id|inw_p
(paren
id|padapter-&gt;regData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ag0.ProtocolType
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|ag0.CmdDrqType
op_eq
l_int|1
)paren
id|pdev-&gt;cmdDrqInt
op_assign
id|TRUE
suffix:semicolon
r_switch
c_cond
(paren
id|ag0.CmdPacketSize
)paren
(brace
r_case
l_int|0
suffix:colon
id|pdev-&gt;packet
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|pdev-&gt;packet
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pdev-&gt;packet
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Atapi2Scsi&n; *&n; *&t;Description:&t;Convert ATAPI data to SCSI data.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;SCpnt&t; - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|Atapi2Scsi
r_void
id|Atapi2Scsi
(paren
id|PADAPTER2220I
id|padapter
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|UCHAR
op_star
id|buff
op_assign
id|padapter-&gt;currentSgBuffer
suffix:semicolon
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SCSIOP_MODE_SENSE
suffix:colon
id|buff
(braket
l_int|0
)braket
op_assign
id|padapter-&gt;kBuffer
(braket
l_int|1
)braket
suffix:semicolon
id|buff
(braket
l_int|1
)braket
op_assign
id|padapter-&gt;kBuffer
(braket
l_int|2
)braket
suffix:semicolon
id|buff
(braket
l_int|2
)braket
op_assign
id|padapter-&gt;kBuffer
(braket
l_int|3
)braket
suffix:semicolon
id|buff
(braket
l_int|3
)braket
op_assign
id|padapter-&gt;kBuffer
(braket
l_int|7
)braket
suffix:semicolon
id|memcpy
(paren
op_amp
id|buff
(braket
l_int|4
)braket
comma
op_amp
id|padapter-&gt;kBuffer
(braket
l_int|8
)braket
comma
id|padapter-&gt;atapiCdb
(braket
l_int|8
)braket
op_minus
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_INQUIRY
suffix:colon
id|padapter-&gt;kBuffer
(braket
l_int|2
)braket
op_assign
l_int|2
suffix:semicolon
id|memcpy
(paren
id|buff
comma
id|padapter-&gt;kBuffer
comma
id|padapter-&gt;currentSgCount
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|padapter-&gt;readCount
)paren
id|WalkScatGath
(paren
id|padapter
comma
id|TRUE
comma
id|padapter-&gt;readCount
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Scsi2Atapi&n; *&n; *&t;Description:&t;Convert SCSI packet command to Atapi packet command.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;SCpnt&t; - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|Scsi2Atapi
r_static
r_void
id|Scsi2Atapi
(paren
id|PADAPTER2220I
id|padapter
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|UCHAR
op_star
id|cdb
op_assign
id|SCpnt-&gt;cmnd
suffix:semicolon
id|UCHAR
op_star
id|buff
op_assign
id|padapter-&gt;currentSgBuffer
suffix:semicolon
r_switch
c_cond
(paren
id|cdb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SCSIOP_READ6
suffix:colon
id|padapter-&gt;atapiCdb
(braket
l_int|0
)braket
op_assign
id|SCSIOP_READ
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|1
)braket
op_assign
id|cdb
(braket
l_int|1
)braket
op_amp
l_int|0xE0
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|3
)braket
op_assign
id|cdb
(braket
l_int|1
)braket
op_amp
l_int|0x1F
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|4
)braket
op_assign
id|cdb
(braket
l_int|2
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|5
)braket
op_assign
id|cdb
(braket
l_int|3
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|8
)braket
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|9
)braket
op_assign
id|cdb
(braket
l_int|5
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE6
suffix:colon
id|padapter-&gt;atapiCdb
(braket
l_int|0
)braket
op_assign
id|SCSIOP_WRITE
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|1
)braket
op_assign
id|cdb
(braket
l_int|1
)braket
op_amp
l_int|0xE0
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|3
)braket
op_assign
id|cdb
(braket
l_int|1
)braket
op_amp
l_int|0x1F
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|4
)braket
op_assign
id|cdb
(braket
l_int|2
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|5
)braket
op_assign
id|cdb
(braket
l_int|3
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|8
)braket
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|9
)braket
op_assign
id|cdb
(braket
l_int|5
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_MODE_SENSE
suffix:colon
id|padapter-&gt;atapiCdb
(braket
l_int|0
)braket
op_assign
id|SCSIOP_MODE_SENSE10
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|2
)braket
op_assign
id|cdb
(braket
l_int|2
)braket
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|8
)braket
op_assign
id|cdb
(braket
l_int|4
)braket
op_plus
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_MODE_SELECT
suffix:colon
id|padapter-&gt;atapiSpecial
op_assign
id|TRUE
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|0
)braket
op_assign
id|SCSIOP_MODE_SELECT10
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|1
)braket
op_assign
id|cdb
(braket
l_int|1
)braket
op_or
l_int|0x10
suffix:semicolon
id|memcpy
(paren
id|padapter-&gt;kBuffer
comma
id|buff
comma
l_int|4
)paren
suffix:semicolon
id|padapter-&gt;kBuffer
(braket
l_int|4
)braket
op_assign
id|padapter-&gt;kBuffer
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;kBuffer
(braket
l_int|6
)braket
op_assign
id|padapter-&gt;kBuffer
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
l_int|8
)braket
comma
op_amp
id|buff
(braket
l_int|4
)braket
comma
id|cdb
(braket
l_int|4
)braket
op_minus
l_int|4
)paren
suffix:semicolon
id|padapter-&gt;atapiCdb
(braket
l_int|8
)braket
op_assign
id|cdb
(braket
l_int|4
)braket
op_plus
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiSendCdb&n; *&n; *&t;Description:&t;Send the CDB packet to the device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&t;&t;&t;&t;&t;cdb&t;&t; - Pointer to 16 byte SCSI cdb.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|AtapiSendCdb
r_static
r_void
id|AtapiSendCdb
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
id|CHAR
op_star
id|cdb
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2242I: CDB: %X %X %X %X %X %X %X %X %X %X %X %X&quot;
comma
id|cdb
(braket
l_int|0
)braket
comma
id|cdb
(braket
l_int|1
)braket
comma
id|cdb
(braket
l_int|2
)braket
comma
id|cdb
(braket
l_int|3
)braket
comma
id|cdb
(braket
l_int|4
)braket
comma
id|cdb
(braket
l_int|5
)braket
comma
id|cdb
(braket
l_int|6
)braket
comma
id|cdb
(braket
l_int|7
)braket
comma
id|cdb
(braket
l_int|8
)braket
comma
id|cdb
(braket
l_int|9
)braket
comma
id|cdb
(braket
l_int|10
)braket
comma
id|cdb
(braket
l_int|11
)braket
)paren
)paren
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|cdb
comma
id|pdev-&gt;packet
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;AtapiRequestSense&n; *&n; *&t;Description:&t;Send the CDB packet to the device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&t;&t;&t;&t;&t;SCpnt&t; - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;pass&t; - If true then this is the second pass to send cdb.&n; *&n; *&t;Returns:&t;&t;TRUE on error.&n; *&n; ****************************************************************/
DECL|function|AtapiRequestSense
r_static
r_int
id|AtapiRequestSense
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|UCHAR
id|pass
)paren
(brace
id|UCHAR
id|cdb
(braket
l_int|16
)braket
op_assign
(brace
id|SCSIOP_REQUEST_SENSE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2242I: AUTO REQUEST SENSE&quot;
)paren
)paren
suffix:semicolon
id|cdb
(braket
l_int|4
)braket
op_assign
(paren
id|UCHAR
)paren
(paren
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pass
)paren
(brace
id|padapter-&gt;reqSense
op_assign
id|TRUE
suffix:semicolon
id|AtapiCountLo
(paren
id|padapter
comma
id|cdb
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|AtapiCountHi
(paren
id|padapter
comma
l_int|0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|padapter-&gt;regError
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_ATAPI_PACKET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;cmdDrqInt
)paren
r_return
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|AtapiWaitDrq
(paren
id|padapter
comma
l_int|500
)paren
)paren
r_return
id|TRUE
suffix:semicolon
)brace
id|AtapiSendCdb
(paren
id|padapter
comma
id|pdev
comma
id|cdb
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;InlineReadSignature&t;:LOCAL&n; *&n; *&t;Description:&t;Do an inline read RAID sigature.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&t;&t;&t;&t;&t;index&t; - index of data to read.&n; *&n; *&t;Returns:&t;&t;Zero if no error or status register contents on error.&n; *&n; ****************************************************************/
DECL|function|InlineReadSignature
r_static
id|UCHAR
id|InlineReadSignature
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
r_int
id|index
)paren
(brace
id|UCHAR
id|status
suffix:semicolon
id|ULONG
id|zl
op_assign
id|pdev-&gt;lastsectorlba
(braket
id|index
)braket
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|index
)braket
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
singleline_comment|// select the spigot without interrupts
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
id|status
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_READ
)paren
suffix:semicolon
id|status
op_assign
id|WaitDrq
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|1
)braket
suffix:semicolon
singleline_comment|// some drives assert DRQ before IRQ so let&squot;s make sure we clear the IRQ
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;DecodeError&t;:LOCAL&n; *&n; *&t;Description:&t;Decode and process device errors.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to adapter data.&n; *&t;&t;&t;&t;&t;status - Status register code.&n; *&n; *&t;Returns:&t;&t;The driver status code.&n; *&n; ****************************************************************/
DECL|function|DecodeError
r_static
id|ULONG
id|DecodeError
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|status
)paren
(brace
id|UCHAR
id|error
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_WRITE_FAULT
)paren
(brace
r_return
id|DID_PARITY
op_lshift
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_BUSY
)paren
r_return
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|error
op_assign
id|inb_p
(paren
id|padapter-&gt;regError
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i error register: %x&quot;
comma
id|error
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|IDE_ERROR_AMNF
suffix:colon
r_case
id|IDE_ERROR_TKONF
suffix:colon
r_case
id|IDE_ERROR_ABRT
suffix:colon
r_case
id|IDE_ERROR_IDFN
suffix:colon
r_case
id|IDE_ERROR_UNC
suffix:colon
r_case
id|IDE_ERROR_BBK
suffix:colon
r_default
suffix:colon
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;StartTimer&t;:LOCAL&n; *&n; *&t;Description:&t;Start the timer.&n; *&n; *&t;Parameters:&t;&t;ipadapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|StartTimer
r_static
r_void
id|StartTimer
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|padapter-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TIMEOUT_DATA
suffix:semicolon
id|add_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteSignature&t;:LOCAL&n; *&n; *&t;Description:&t;Start the timer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to our device.&n; *&t;&t;&t;&t;&t;spigot&t; - Selected spigot.&n; *&t;&t;&t;&t;&t;index&t; - index of mirror signature on device.&n; *&n; *&t;Returns:&t;&t;TRUE on any error.&n; *&n; ****************************************************************/
DECL|function|WriteSignature
r_static
r_int
id|WriteSignature
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
id|UCHAR
id|spigot
comma
r_int
id|index
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
)paren
suffix:semicolon
id|zl
op_assign
id|pdev-&gt;lastsectorlba
(braket
id|index
)braket
suffix:semicolon
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitDrq
(paren
id|padapter
)paren
)paren
r_return
id|TRUE
suffix:semicolon
id|StartTimer
(paren
id|padapter
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|1
)braket
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************************************&n; *&t;Name:&t;&t;&t;InitFailover&n; *&n; *&t;Description:&t;This is the beginning of the failover routine&n; *&n; *&t;Parameters:&t;&t;SCpnt&t; - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to our device.&n; *&t;&n; *&t;Returns:&t;&t;TRUE on error.&n; *&n; ******************************************************************************************************/
DECL|function|InitFailover
r_static
r_int
id|InitFailover
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|UCHAR
id|spigot
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i:  Initialize failover process - survivor = %d&quot;
comma
id|pdev-&gt;deviceID
(braket
id|padapter-&gt;survivor
)braket
)paren
)paren
suffix:semicolon
id|pdev-&gt;raid
op_assign
id|FALSE
suffix:semicolon
singleline_comment|//initializes system for non raid mode
id|pdev-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
id|spigot
op_assign
id|pdev-&gt;spigots
(braket
id|padapter-&gt;survivor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
id|padapter-&gt;survivor
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n         failed, is survivor&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HardReset
(paren
id|padapter
comma
id|pdev
comma
id|spigot
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n         failed, reset&quot;
)paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|Alarm
(paren
id|padapter
comma
id|pdev-&gt;deviceID
(braket
id|padapter-&gt;survivor
op_xor
l_int|1
)braket
)paren
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
id|padapter-&gt;survivor
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
singleline_comment|//clear present status
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|spigot
comma
id|padapter-&gt;survivor
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n         failed, write signature&quot;
)paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|padapter-&gt;failinprog
op_assign
id|TRUE
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;TimerExpiry&t;:LOCAL&n; *&n; *&t;Description:&t;Timer expiry routine.&n; *&n; *&t;Parameters:&t;&t;data - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|TimerExpiry
r_static
r_void
id|TimerExpiry
(paren
r_int
r_int
id|data
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
(paren
id|PADAPTER2220I
)paren
id|data
suffix:semicolon
id|POUR_DEVICE
id|pdev
op_assign
id|padapter-&gt;pdev
suffix:semicolon
id|UCHAR
id|status
op_assign
id|IDE_STATUS_BUSY
suffix:semicolon
id|UCHAR
id|temp
comma
id|temp1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;     * Disable interrupts, if they aren&squot;t already disabled and acquire&n;     * the I/O spinlock.&n;     */
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I: Timeout expired &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;failinprog
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in failover process&quot;
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
)paren
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
r_while
c_loop
(paren
id|padapter-&gt;reconPhase
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in recon phase %X&quot;
comma
id|padapter-&gt;reconPhase
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
r_case
id|RECON_PHASE_MARKING
suffix:colon
r_case
id|RECON_PHASE_LAST
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 1&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_READY
suffix:colon
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_COPY
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 2&quot;
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n       spig/stat = %X&quot;
comma
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
)paren
suffix:semicolon
r_if
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_UPDATE
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 3&quot;
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_END
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 4&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_default
suffix:colon
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|padapter-&gt;cmd
)paren
(brace
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// cancel interrupt from DMA engine
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;cmd
op_eq
id|WRITE_CMD
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in RAID write operation&quot;
)paren
)paren
suffix:semicolon
id|temp
op_assign
(paren
id|pdev-&gt;spigot
op_amp
(paren
id|SEL_1
op_or
id|SEL_2
)paren
)paren
ques
c_cond
id|SEL_1
suffix:colon
id|SEL_3
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_amp
id|temp
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: Determined A OK&quot;
)paren
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|temp
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
singleline_comment|// Masking the interrupt during spigot select
id|temp
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
)brace
r_else
id|temp
op_assign
id|IDE_STATUS_BUSY
suffix:semicolon
id|temp1
op_assign
(paren
id|pdev-&gt;spigot
op_amp
(paren
id|SEL_1
op_or
id|SEL_2
)paren
)paren
ques
c_cond
id|SEL_2
suffix:colon
id|SEL_4
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|padapter-&gt;regStatSel
)paren
op_amp
id|temp1
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: Determined B OK&quot;
)paren
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|temp1
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
singleline_comment|// Masking the interrupt during spigot select
id|temp1
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
)brace
r_else
id|temp1
op_assign
id|IDE_STATUS_BUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|IDE_STATUS_BUSY
)paren
op_logical_or
(paren
id|temp1
op_amp
id|IDE_STATUS_BUSY
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: Status A: %X   B: %X&quot;
comma
id|temp
op_amp
l_int|0xFF
comma
id|temp1
op_amp
l_int|0xFF
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|IDE_STATUS_BUSY
)paren
op_logical_and
(paren
id|temp1
op_amp
id|IDE_STATUS_BUSY
)paren
)paren
(brace
id|status
op_assign
id|temp
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|temp
op_amp
id|IDE_STATUS_BUSY
)paren
id|padapter-&gt;survivor
op_assign
l_int|1
suffix:semicolon
r_else
id|padapter-&gt;survivor
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in RAID read operation&quot;
)paren
)paren
suffix:semicolon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 6&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in I/O operation&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
id|timerExpiryDone
suffix:colon
suffix:semicolon
multiline_comment|/*&n;     * Release the I/O spinlock and restore the original flags&n;     * which will enable interrupts if and only if they were&n;     * enabled on entry.&n;     */
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;SetReconstruct&t;:LOCAL&n; *&n; *&t;Description:&t;Set the reconstruct up.&n; *&n; *&t;Parameters:&t;&t;pdev&t;- Pointer to device structure.&n; *&t;&t;&t;&t;&t;index&t;- Mirror index number.&n; *&n; *&t;Returns:&t;&t;Number of sectors on new disk required.&n; *&n; ****************************************************************/
DECL|function|SetReconstruct
r_static
id|LONG
id|SetReconstruct
(paren
id|POUR_DEVICE
id|pdev
comma
r_int
id|index
)paren
(brace
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
suffix:semicolon
singleline_comment|// setup the flags
id|pdev-&gt;DiskMirror
(braket
id|index
op_xor
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_REBUILD
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
id|index
op_xor
l_int|1
)braket
dot
id|reconstructPoint
op_assign
l_int|0
suffix:semicolon
singleline_comment|// start the reconstruct
id|pdev-&gt;reconCount
op_assign
l_int|1990
suffix:semicolon
singleline_comment|// mark target drive early
r_return
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
dot
id|reconstructPoint
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;ReconTimerExpiry&t;:LOCAL&n; *&n; *&t;Description:&t;Reconstruct timer expiry routine.&n; *&n; *&t;Parameters:&t;&t;data - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|ReconTimerExpiry
r_static
r_void
id|ReconTimerExpiry
(paren
r_int
r_int
id|data
)paren
(brace
id|PADAPTER2220I
id|padapter
suffix:semicolon
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|ULONG
id|testsize
op_assign
l_int|0
suffix:semicolon
id|PIDENTIFY_DATA
id|pid
suffix:semicolon
id|USHORT
id|minmode
suffix:semicolon
id|ULONG
id|zl
suffix:semicolon
id|UCHAR
id|zc
suffix:semicolon
id|USHORT
id|z
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;     * Disable interrupts, if they aren&squot;t already disabled and acquire&n;     * the I/O spinlock.&n;     */
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|padapter
op_assign
(paren
id|PADAPTER2220I
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;SCpnt
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
id|padapter-&gt;devInReconIndex
op_plus
l_int|1
suffix:semicolon
id|z
OL
id|BIGD_MAXDRIVES
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|reconOn
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|z
OL
id|BIGD_MAXDRIVES
)paren
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|BIGD_MAXDRIVES
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|reconOn
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|z
OL
id|BIGD_MAXDRIVES
)paren
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
suffix:semicolon
r_else
(brace
id|padapter-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
)brace
id|padapter-&gt;devInReconIndex
op_assign
id|z
suffix:semicolon
id|pid
op_assign
(paren
id|PIDENTIFY_DATA
)paren
id|padapter-&gt;kBuffer
suffix:semicolon
id|padapter-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;reconIsStarting
)paren
(brace
id|pdev-&gt;reconIsStarting
op_assign
id|FALSE
suffix:semicolon
id|pdev-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|pairIdentifier
op_eq
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|pairIdentifier
op_xor
l_int|1
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_MATCHED
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_MATCHED
)paren
)paren
r_break
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
singleline_comment|// is first drive survivor?
id|testsize
op_assign
id|SetReconstruct
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
singleline_comment|// is second drive survivor?
id|testsize
op_assign
id|SetReconstruct
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
id|pdev-&gt;mirrorRecon
op_assign
l_int|0
suffix:semicolon
r_else
id|pdev-&gt;mirrorRecon
op_assign
l_int|1
suffix:semicolon
id|pdev-&gt;reconOn
op_assign
id|TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;reconOn
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
(brace
id|padapter-&gt;failRegister
op_assign
l_int|0
suffix:semicolon
id|outb_p
(paren
op_complement
id|padapter-&gt;failRegister
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
)brace
r_else
(brace
id|zc
op_assign
(paren
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_rshift
l_int|3
)paren
op_or
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
)paren
op_amp
l_int|0x83
suffix:semicolon
singleline_comment|// mute the alarm
id|outb_p
(paren
l_int|0xFF
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: hard reset issue&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HardReset
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 1&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pdev-&gt;lastsectorlba
(braket
id|pdev-&gt;mirrorRecon
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
comma
id|pdev-&gt;deviceID
(braket
id|pdev-&gt;mirrorRecon
)braket
op_amp
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;lastsectorlba
(braket
id|pdev-&gt;mirrorRecon
)braket
OL
id|testsize
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 2 %ld %ld&quot;
comma
id|pdev-&gt;lastsectorlba
(braket
id|pdev-&gt;mirrorRecon
)braket
comma
id|testsize
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// test LBA and multiper sector transfer compatability
r_if
c_cond
(paren
op_logical_neg
id|pid-&gt;SupportLBA
op_logical_or
(paren
id|pid-&gt;NumSectorsPerInt
OL
id|SECTORSXFER
)paren
op_logical_or
op_logical_neg
id|pid-&gt;Valid_64_70
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 3&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// test PIO/bus matering mode compatability
r_if
c_cond
(paren
(paren
id|pid-&gt;MinPIOCycleWithoutFlow
OG
l_int|240
)paren
op_logical_and
op_logical_neg
id|pid-&gt;SupportIORDYDisable
op_logical_and
op_logical_neg
id|padapter-&gt;timingPIO
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 4&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCycleWithoutFlow
op_le
l_int|120
)paren
singleline_comment|// setup timing mode of drive
id|minmode
op_assign
l_int|5
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCylceWithFlow
op_le
l_int|150
)paren
id|minmode
op_assign
l_int|4
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCylceWithFlow
op_le
l_int|180
)paren
id|minmode
op_assign
l_int|3
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCylceWithFlow
op_le
l_int|240
)paren
id|minmode
op_assign
l_int|2
suffix:semicolon
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 5&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|padapter-&gt;timingMode
OG
id|minmode
)paren
singleline_comment|// set minimum timing mode
id|padapter-&gt;timingMode
op_assign
id|minmode
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingMode
op_ge
l_int|2
)paren
id|padapter-&gt;timingAddress
op_assign
id|ModeArray
(braket
id|padapter-&gt;timingMode
op_minus
l_int|2
)braket
suffix:semicolon
r_else
id|padapter-&gt;timingPIO
op_assign
id|TRUE
suffix:semicolon
id|padapter-&gt;reconOn
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;reconOn
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_FAILOVER
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 7&quot;
)paren
)paren
suffix:semicolon
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|pdev-&gt;raid
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigot
comma
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)paren
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_MARKING
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
singleline_comment|//**********************************
singleline_comment|// reconstruct copy starts here&t;
singleline_comment|//**********************************
r_if
c_cond
(paren
id|pdev-&gt;reconCount
op_increment
OG
l_int|2000
)paren
(brace
id|pdev-&gt;reconCount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
comma
id|pdev-&gt;mirrorRecon
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_FAILOVER
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 8&quot;
)paren
)paren
suffix:semicolon
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_UPDATE
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|zl
op_assign
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
)braket
dot
id|reconstructPoint
suffix:semicolon
id|padapter-&gt;reconSize
op_assign
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)braket
dot
id|reconstructPoint
op_minus
id|zl
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconSize
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
id|padapter-&gt;reconSize
op_assign
id|MAX_BUS_MASTER_BLOCKS
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconSize
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_or
id|pdev-&gt;spigots
(braket
l_int|1
)braket
)paren
suffix:semicolon
singleline_comment|// select the spigots
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_FAILOVER
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 9&quot;
)paren
)paren
suffix:semicolon
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_or
id|pdev-&gt;spigots
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;reconSize
op_amp
l_int|0xFF
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_READY
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|WRITE_CMD
)paren
suffix:semicolon
id|StartTimer
(paren
id|padapter
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|READ_CMD
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_MATCHED
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_MATCHED
suffix:semicolon
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigot
comma
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)paren
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_LAST
suffix:semicolon
id|reconTimerExpiry
suffix:colon
suffix:semicolon
multiline_comment|/*&n;     * Release the I/O spinlock and restore the original flags&n;     * which will enable interrupts if and only if they were&n;     * enabled on entry.&n;     */
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Irq_Handler&t;:LOCAL&n; *&n; *&t;Description:&t;Interrupt handler.&n; *&n; *&t;Parameters:&t;&t;irq&t;&t;- Hardware IRQ number.&n; *&t;&t;&t;&t;&t;dev_id&t;-&n; *&t;&t;&t;&t;&t;regs&t;-&n; *&n; *&t;Returns:&t;&t;TRUE if drive is not ready in time.&n; *&n; ****************************************************************/
DECL|function|Irq_Handler
r_static
r_void
id|Irq_Handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// Pointer to host data block
id|PADAPTER2220I
id|padapter
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
id|UCHAR
id|status1
suffix:semicolon
id|ATAPI_STATUS
id|statusa
suffix:semicolon
id|ATAPI_REASON
id|reasona
suffix:semicolon
id|ATAPI_ERROR
id|errora
suffix:semicolon
r_int
id|z
suffix:semicolon
id|ULONG
id|zl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;     * Disable interrupts, if they aren&squot;t already disabled and acquire&n;     * the I/O spinlock.&n;     */
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|//&t;DEB (printk (&quot;&bslash;npci2220i received interrupt&bslash;n&quot;));
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|NumAdapters
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// scan for interrupt to process
(brace
r_if
c_cond
(paren
id|PsiHost
(braket
id|z
)braket
op_member_access_from_pointer
id|irq
op_eq
(paren
id|UCHAR
)paren
(paren
id|irq
op_amp
l_int|0xFF
)paren
)paren
(brace
r_if
c_cond
(paren
id|inw_p
(paren
id|HOSTDATA
c_func
(paren
id|PsiHost
(braket
id|z
)braket
)paren
op_member_access_from_pointer
id|regIrqControl
)paren
op_amp
l_int|0x8000
)paren
(brace
id|shost
op_assign
id|PsiHost
(braket
id|z
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: not my interrupt&quot;
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
suffix:semicolon
id|pdev
op_assign
id|padapter-&gt;pdev
suffix:semicolon
id|SCpnt
op_assign
id|padapter-&gt;SCpnt
suffix:semicolon
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// cancel interrupt from DMA engine
r_if
c_cond
(paren
id|padapter-&gt;atapi
op_logical_and
id|SCpnt
)paren
(brace
op_star
(paren
r_char
op_star
)paren
op_amp
id|statusa
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
op_star
(paren
r_char
op_star
)paren
op_amp
id|reasona
op_assign
id|inb_p
(paren
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
singleline_comment|// read the device interrupt reason
r_if
c_cond
(paren
op_logical_neg
id|statusa.bsy
)paren
(brace
r_if
c_cond
(paren
id|statusa.drq
)paren
singleline_comment|// test for transfer phase
(brace
r_if
c_cond
(paren
op_logical_neg
id|reasona.cod
)paren
singleline_comment|// test for data phase
(brace
id|z
op_assign
(paren
id|ULONG
)paren
id|inb_p
(paren
id|padapter-&gt;regLba8
)paren
op_or
(paren
id|ULONG
)paren
(paren
id|inb_p
(paren
id|padapter-&gt;regLba16
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reqSense
)paren
id|insw
(paren
id|padapter-&gt;regData
comma
id|SCpnt-&gt;sense_buffer
comma
id|z
op_div
l_int|2
)paren
suffix:semicolon
r_else
id|AtapiBusMaster
(paren
id|padapter
comma
id|reasona.io
comma
id|z
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reasona.cod
op_logical_and
op_logical_neg
id|reasona.io
)paren
singleline_comment|// test for command packet phase
(brace
r_if
c_cond
(paren
id|padapter-&gt;reqSense
)paren
id|AtapiRequestSense
(paren
id|padapter
comma
id|pdev
comma
id|SCpnt
comma
id|TRUE
)paren
suffix:semicolon
r_else
id|AtapiSendCdb
(paren
id|padapter
comma
id|pdev
comma
id|padapter-&gt;atapiCdb
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|reasona.io
op_logical_and
id|statusa.drdy
)paren
singleline_comment|// test for status phase
(brace
id|Atapi2Scsi
(paren
id|padapter
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|statusa.check
)paren
(brace
op_star
(paren
id|UCHAR
op_star
)paren
op_amp
id|errora
op_assign
id|inb_p
(paren
id|padapter-&gt;regError
)paren
suffix:semicolon
singleline_comment|// read the device error
r_if
c_cond
(paren
id|errora.senseKey
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;reqSense
op_logical_or
id|AtapiRequestSense
(paren
id|padapter
comma
id|pdev
comma
id|SCpnt
comma
id|FALSE
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|errora.ili
op_logical_or
id|errora
dot
m_abort
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_else
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|padapter-&gt;reqSense
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;PCI2242I: Sense codes - %X %X %X &quot;
comma
(paren
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;sense_buffer
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;sense_buffer
)paren
(braket
l_int|12
)braket
comma
(paren
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;sense_buffer
)paren
(braket
l_int|13
)braket
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
(paren
id|DRIVER_SENSE
op_lshift
l_int|24
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
l_int|2
)paren
suffix:semicolon
)brace
r_else
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
)brace
)brace
r_goto
id|irq_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;expectingIRQ
op_logical_or
op_logical_neg
(paren
id|SCpnt
op_logical_or
id|padapter-&gt;reconPhase
)paren
)paren
(brace
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i Unsolicited interrupt&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|STOP_HERE
(paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;failinprog
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i interrupt failover complete&quot;
)paren
)paren
suffix:semicolon
id|padapter-&gt;failinprog
op_assign
id|FALSE
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: interrupt failover error from drive %X&quot;
comma
id|status
)paren
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: restarting failed opertation.&quot;
)paren
)paren
suffix:semicolon
id|pdev-&gt;spigot
op_assign
(paren
id|padapter-&gt;survivor
)paren
ques
c_cond
id|pdev-&gt;spigots
(braket
l_int|1
)braket
suffix:colon
id|pdev-&gt;spigots
(braket
l_int|0
)braket
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_else
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|SCpnt-&gt;scsi_done
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
r_switch
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
r_case
id|RECON_PHASE_MARKING
suffix:colon
r_case
id|RECON_PHASE_LAST
suffix:colon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
op_eq
id|RECON_PHASE_LAST
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 10&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
comma
id|pdev-&gt;mirrorRecon
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 11&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_END
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
r_case
id|RECON_PHASE_READY
suffix:colon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitDrq
(paren
id|padapter
)paren
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 12&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
id|SEL_COPY
op_or
id|padapter-&gt;bigD
)paren
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_COPY
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|padapter-&gt;reconSize
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|padapter-&gt;timingMode
OG
l_int|3
)paren
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
id|outl
(paren
id|BIGD_DATA_MODE3
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
r_else
id|outl
(paren
id|DALE_DATA_MODE3
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
)brace
r_else
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|padapter-&gt;kBufferDma
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|outl
(paren
id|padapter-&gt;reconSize
op_star
id|BYTES_PER_SECTOR
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
id|outb_p
(paren
l_int|8
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// read operation
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
id|outb_p
(paren
l_int|8
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
r_else
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
)brace
r_goto
id|irq_return
suffix:semicolon
r_case
id|RECON_PHASE_COPY
suffix:colon
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
)braket
dot
id|reconstructPoint
op_add_assign
id|padapter-&gt;reconSize
suffix:semicolon
r_case
id|RECON_PHASE_UPDATE
suffix:colon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|pdev-&gt;mirrorRecon
)braket
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 13&quot;
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n  status register = %X   error = %X&quot;
comma
id|status
comma
id|inb_p
(paren
id|padapter-&gt;regError
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
r_case
id|RECON_PHASE_END
suffix:colon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 14&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|pdev-&gt;reconOn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
(brace
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|padapter-&gt;numberOfDrives
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
(brace
id|Alarm
(paren
id|padapter
comma
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|deviceID
(braket
l_int|0
)braket
op_xor
l_int|2
)paren
suffix:semicolon
id|MuteAlarm
(paren
id|padapter
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
(brace
id|Alarm
(paren
id|padapter
comma
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|deviceID
(braket
l_int|1
)braket
op_xor
l_int|2
)paren
suffix:semicolon
id|MuteAlarm
(paren
id|padapter
)paren
suffix:semicolon
)brace
)brace
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
r_default
suffix:colon
r_goto
id|irq_return
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|padapter-&gt;cmd
)paren
singleline_comment|// decide how to handle the interrupt
(brace
r_case
id|READ_CMD
suffix:colon
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_eq
id|pdev-&gt;spigots
(braket
l_int|0
)braket
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 15&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|padapter-&gt;readCount
op_div
l_int|2
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|padapter-&gt;readCount
op_div
id|BYTES_PER_SECTOR
suffix:semicolon
id|WalkScatGath
(paren
id|padapter
comma
id|TRUE
comma
id|padapter-&gt;readCount
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;sectorCount
)paren
(brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|padapter-&gt;readCount
)paren
id|WalkScatGath
(paren
id|padapter
comma
id|TRUE
comma
id|padapter-&gt;readCount
)paren
suffix:semicolon
id|BusMaster
(paren
id|padapter
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;readCount
op_logical_and
op_logical_neg
id|padapter-&gt;timingPIO
)paren
id|WalkScatGath
(paren
id|padapter
comma
id|TRUE
comma
id|padapter-&gt;readCount
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE_CMD
suffix:colon
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|1
)braket
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|status1
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
)brace
r_else
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|status1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;raid
op_logical_and
op_logical_neg
(paren
id|status1
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 16  status = %X  error = %X&quot;
comma
id|status
comma
id|inb_p
(paren
id|padapter-&gt;regError
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
r_if
c_cond
(paren
id|status1
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
l_int|0
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 17  status = %X  error = %X&quot;
comma
id|status1
comma
id|inb_p
(paren
id|padapter-&gt;regError
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
id|status
op_assign
id|status1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
id|status
op_assign
id|WriteDataBoth
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|status
op_rshift
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 18&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
id|status
)braket
op_or
id|SEL_IRQ_OFF
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_break
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
id|padapter-&gt;bigD
)paren
suffix:semicolon
id|status
op_assign
id|WriteData
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IDE_COMMAND_IDENTIFY
suffix:colon
(brace
id|PINQUIRYDATA
id|pinquiryData
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|PIDENTIFY_DATA
id|pid
op_assign
(paren
id|PIDENTIFY_DATA
)paren
id|padapter-&gt;kBuffer
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|pid
comma
r_sizeof
(paren
id|IDENTIFY_DATA
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|memset
(paren
id|pinquiryData
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
singleline_comment|// Zero INQUIRY data structure.
id|pinquiryData-&gt;DeviceType
op_assign
l_int|0
suffix:semicolon
id|pinquiryData-&gt;Versions
op_assign
l_int|2
suffix:semicolon
id|pinquiryData-&gt;AdditionalLength
op_assign
l_int|35
op_minus
l_int|4
suffix:semicolon
singleline_comment|// Fill in vendor identification fields.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|20
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;VendorId
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;ModelNumber
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;VendorId
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;ModelNumber
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
singleline_comment|// Initialize unused portion of product id.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_increment
)paren
id|pinquiryData-&gt;ProductId
(braket
l_int|12
op_plus
id|z
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
singleline_comment|// Move firmware revision from IDENTIFY data to
singleline_comment|// product revision in INQUIRY data.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;FirmwareRevision
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;FirmwareRevision
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev
op_eq
id|padapter-&gt;device
)paren
op_star
(paren
(paren
id|USHORT
op_star
)paren
(paren
op_amp
id|pinquiryData-&gt;VendorSpecific
)paren
)paren
op_assign
id|DEVICE_DALE_1
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i Interupt hanlder return error&quot;
)paren
)paren
suffix:semicolon
id|zl
op_assign
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
suffix:semicolon
)brace
r_else
id|zl
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|zl
)paren
suffix:semicolon
id|irq_return
suffix:colon
suffix:semicolon
multiline_comment|/*&n;     * Release the I/O spinlock and restore the original flags&n;     * which will enable interrupts if and only if they were&n;     * enabled on entry.&n;     */
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_QueueCommand&n; *&n; *&t;Description:&t;Process a queued command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;done  - Pointer to done function to call.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_QueueCommand
r_int
id|Pci2220i_QueueCommand
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|UCHAR
op_star
id|cdb
op_assign
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
singleline_comment|// Pointer to SCSI CDB
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|SCpnt-&gt;target
)braket
suffix:semicolon
singleline_comment|// Pointer to device information
id|UCHAR
id|rc
suffix:semicolon
singleline_comment|// command return code
r_int
id|z
suffix:semicolon
id|PDEVICE_RAID1
id|pdr
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
singleline_comment|// Save this command data
id|padapter-&gt;readCount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|padapter-&gt;currentSgBuffer
op_assign
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
)paren
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|padapter-&gt;currentSgCount
op_assign
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
)paren
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
)brace
r_else
(brace
id|padapter-&gt;currentSgBuffer
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|padapter-&gt;currentSgCount
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
)brace
id|padapter-&gt;nextSg
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pci2220i_queuecommand: %02X: done can&squot;t be NULL&bslash;n&quot;
comma
op_star
id|cdb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;atapi
)paren
(brace
id|UCHAR
id|zlo
comma
id|zhi
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2242I: ID %d, LUN %d opcode %X &quot;
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
op_star
id|cdb
)paren
)paren
suffix:semicolon
id|padapter-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;byte6
op_logical_or
id|SCpnt-&gt;lun
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;atapiSpecial
op_assign
id|FALSE
suffix:semicolon
id|padapter-&gt;reqSense
op_assign
id|FALSE
suffix:semicolon
id|memset
(paren
id|padapter-&gt;atapiCdb
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|AtapiDevice
(paren
id|padapter
comma
id|pdev-&gt;byte6
)paren
suffix:semicolon
singleline_comment|// select the drive
r_if
c_cond
(paren
id|AtapiWaitReady
(paren
id|padapter
comma
l_int|100
)paren
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cdb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SCSIOP_MODE_SENSE
suffix:colon
r_case
id|SCSIOP_MODE_SELECT
suffix:colon
id|Scsi2Atapi
(paren
id|padapter
comma
id|SCpnt
)paren
suffix:semicolon
id|z
op_assign
id|SCpnt-&gt;request_bufflen
op_plus
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ6
suffix:colon
r_case
id|SCSIOP_WRITE6
suffix:colon
id|Scsi2Atapi
(paren
id|padapter
comma
id|SCpnt
)paren
suffix:semicolon
id|z
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|memcpy
(paren
id|padapter-&gt;atapiCdb
comma
id|cdb
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|z
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|z
OG
id|ATAPI_TRANSFER
)paren
id|z
op_assign
id|ATAPI_TRANSFER
suffix:semicolon
id|zlo
op_assign
(paren
id|UCHAR
)paren
(paren
id|z
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|zhi
op_assign
(paren
id|UCHAR
)paren
(paren
id|z
op_rshift
l_int|8
)paren
suffix:semicolon
id|AtapiCountLo
(paren
id|padapter
comma
id|zlo
)paren
suffix:semicolon
id|AtapiCountHi
(paren
id|padapter
comma
id|zhi
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|padapter-&gt;regError
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_ATAPI_PACKET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;cmdDrqInt
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|AtapiWaitDrq
(paren
id|padapter
comma
l_int|500
)paren
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|AtapiSendCdb
(paren
id|padapter
comma
id|pdev
comma
id|padapter-&gt;atapiCdb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconTimer.data
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;target
op_ge
id|padapter-&gt;numberOfDrives
)paren
op_logical_or
id|SCpnt-&gt;lun
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
op_star
id|cdb
)paren
(brace
r_case
id|SCSIOP_INQUIRY
suffix:colon
singleline_comment|// inquiry CDB
(brace
r_if
c_cond
(paren
id|cdb
(braket
l_int|2
)braket
op_eq
id|SC_MY_RAID
)paren
(brace
r_switch
c_cond
(paren
id|cdb
(braket
l_int|3
)braket
)paren
(brace
r_case
id|MY_SCSI_REBUILD
suffix:colon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|padapter-&gt;numberOfDrives
suffix:semicolon
id|z
op_increment
)paren
(brace
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_MIRRORED
)paren
)paren
op_logical_or
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_MIRRORED
)paren
)paren
)paren
(brace
id|padapter-&gt;reconOn
op_assign
id|pdev-&gt;reconOn
op_assign
id|pdev-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MY_SCSI_ALARMMUTE
suffix:colon
id|MuteAlarm
(paren
id|padapter
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MY_SCSI_DEMOFAIL
suffix:colon
id|padapter-&gt;demoFail
op_assign
id|TRUE
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|z
op_assign
id|cdb
(braket
l_int|5
)braket
suffix:semicolon
singleline_comment|// get index
id|pdr
op_assign
(paren
id|PDEVICE_RAID1
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;raidData
(braket
id|z
)braket
)paren
(brace
id|memcpy
(paren
op_amp
id|pdr-&gt;DiskRaid1
comma
id|padapter-&gt;raidData
(braket
id|z
)braket
comma
r_sizeof
(paren
id|DISK_MIRROR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;raidData
(braket
id|z
)braket
op_member_access_from_pointer
id|reconstructPoint
OG
id|padapter-&gt;raidData
(braket
id|z
op_xor
l_int|2
)braket
op_member_access_from_pointer
id|reconstructPoint
)paren
id|pdr-&gt;TotalSectors
op_assign
id|padapter-&gt;raidData
(braket
id|z
)braket
op_member_access_from_pointer
id|reconstructPoint
suffix:semicolon
r_else
id|pdr-&gt;TotalSectors
op_assign
id|padapter-&gt;raidData
(braket
id|z
op_xor
l_int|2
)braket
op_member_access_from_pointer
id|reconstructPoint
suffix:semicolon
)brace
r_else
id|memset
(paren
id|pdr
comma
l_int|0
comma
r_sizeof
(paren
id|DEVICE_RAID1
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;cmd
op_assign
id|IDE_COMMAND_IDENTIFY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SCSIOP_TEST_UNIT_READY
suffix:colon
singleline_comment|// test unit ready CDB
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSIOP_READ_CAPACITY
suffix:colon
singleline_comment|// read capctiy CDB
(brace
id|PREAD_CAPACITY_DATA
id|pdata
op_assign
(paren
id|PREAD_CAPACITY_DATA
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|pdata-&gt;blksiz
op_assign
l_int|0x20000
suffix:semicolon
id|XANY2SCSI
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|pdata-&gt;blks
comma
id|pdev-&gt;blocks
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SCSIOP_VERIFY
suffix:colon
singleline_comment|// verify CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|IDE_COMMAND_VERIFY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ
suffix:colon
singleline_comment|// read10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|READ_CMD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ6
suffix:colon
singleline_comment|// read6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|READ_CMD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE
suffix:colon
singleline_comment|// write10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|WRITE_CMD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE6
suffix:colon
singleline_comment|// write6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|WRITE_CMD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEB
(paren
id|printk
(paren
l_string|&quot;pci2220i_queuecommand: Unsupported command %02X&bslash;n&quot;
comma
op_star
id|cdb
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
r_return
l_int|0
suffix:semicolon
id|padapter-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_while
c_loop
(paren
id|padapter-&gt;demoFail
)paren
(brace
id|pdev
op_assign
id|padapter-&gt;pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
l_int|0
)braket
suffix:semicolon
id|padapter-&gt;demoFail
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;raid
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
id|padapter-&gt;survivor
op_assign
l_int|1
suffix:semicolon
r_else
id|padapter-&gt;survivor
op_assign
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 19&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_break
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|StartTimer
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;raid
op_logical_and
(paren
id|padapter-&gt;cmd
op_eq
id|WRITE_CMD
)paren
)paren
(brace
id|rc
op_assign
id|IdeCmdBoth
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|WriteDataBoth
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;survivor
op_assign
id|rc
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 20&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|rc
op_assign
id|IdeCmd
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|padapter-&gt;cmd
op_eq
id|WRITE_CMD
)paren
op_logical_and
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|WriteData
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 21&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|SCpnt-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Command&n; *&n; *&t;Description:&t;Process a command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Command
r_int
id|Pci2220i_Command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCpnt-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;ReadFlash&n; *&n; *&t;Description:&t;Read information from controller Flash memory.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host interface data structure.&n; *&t;&t;&t;&t;&t;pdata&t; - Pointer to data structures.&n; *&t;&t;&t;&t;&t;base&t; - base address in Flash.&n; *&t;&t;&t;&t;&t;length&t; - lenght of data space in bytes.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|ReadFlash
r_static
id|VOID
id|ReadFlash
(paren
id|PADAPTER2220I
id|padapter
comma
id|VOID
op_star
id|pdata
comma
id|ULONG
id|base
comma
id|ULONG
id|length
)paren
(brace
id|ULONG
id|oldremap
suffix:semicolon
id|UCHAR
id|olddesc
suffix:semicolon
id|ULONG
id|z
suffix:semicolon
id|UCHAR
op_star
id|pd
op_assign
(paren
id|UCHAR
op_star
)paren
id|pdata
suffix:semicolon
id|oldremap
op_assign
id|inl
(paren
id|padapter-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// save values to restore later
id|olddesc
op_assign
id|inb_p
(paren
id|padapter-&gt;regDesc
)paren
suffix:semicolon
id|outl
(paren
id|base
op_or
l_int|1
comma
id|padapter-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// remap to Flash space as specified
id|outb_p
(paren
l_int|0x40
comma
id|padapter-&gt;regDesc
)paren
suffix:semicolon
singleline_comment|// describe remap region as 8 bit
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|length
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// get &quot;length&quot; data count
op_star
id|pd
op_increment
op_assign
id|inb_p
(paren
id|padapter-&gt;regBase
op_plus
id|z
)paren
suffix:semicolon
singleline_comment|// read in the data
id|outl
(paren
id|oldremap
comma
id|padapter-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// restore remap register values
id|outb_p
(paren
id|olddesc
comma
id|padapter-&gt;regDesc
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;GetRegs&n; *&n; *&t;Description:&t;Initialize the regester information.&n; *&n; *&t;Parameters:&t;&t;pshost&t;&t;  - Pointer to SCSI host data structure.&n; *&t;&t;&t;&t;&t;bigd&t;&t;  - PCI-2240I identifier&n; *&t;&t;&t;&t;&t;pcidev&t;&t;  - Pointer to device data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if failure to install.&n; *&n; ****************************************************************/
DECL|function|GetRegs
r_static
id|USHORT
id|GetRegs
(paren
r_struct
id|Scsi_Host
op_star
id|pshost
comma
id|BOOL
id|bigd
comma
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
id|PADAPTER2220I
id|padapter
suffix:semicolon
r_int
id|setirq
suffix:semicolon
r_int
id|z
suffix:semicolon
id|USHORT
id|zr
comma
id|zl
suffix:semicolon
id|UCHAR
op_star
id|consistent
suffix:semicolon
id|dma_addr_t
id|consistentDma
suffix:semicolon
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
id|memset
(paren
id|padapter
comma
l_int|0
comma
r_sizeof
(paren
id|ADAPTER2220I
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|DaleSetup
comma
l_int|0
comma
r_sizeof
(paren
id|DaleSetup
)paren
)paren
suffix:semicolon
id|memset
(paren
id|DiskMirror
comma
l_int|0
comma
r_sizeof
(paren
id|DiskMirror
)paren
)paren
suffix:semicolon
id|zr
op_assign
id|pci_resource_start
(paren
id|pcidev
comma
l_int|1
)paren
suffix:semicolon
id|zl
op_assign
id|pci_resource_start
(paren
id|pcidev
comma
l_int|2
)paren
suffix:semicolon
id|padapter-&gt;basePort
op_assign
id|zr
suffix:semicolon
id|padapter-&gt;regRemap
op_assign
id|zr
op_plus
id|RTR_LOCAL_REMAP
suffix:semicolon
singleline_comment|// 32 bit local space remap
id|padapter-&gt;regDesc
op_assign
id|zr
op_plus
id|RTR_REGIONS
suffix:semicolon
singleline_comment|// 32 bit local region descriptor
id|padapter-&gt;regRange
op_assign
id|zr
op_plus
id|RTR_LOCAL_RANGE
suffix:semicolon
singleline_comment|// 32 bit local range
id|padapter-&gt;regIrqControl
op_assign
id|zr
op_plus
id|RTR_INT_CONTROL_STATUS
suffix:semicolon
singleline_comment|// 16 bit interupt control and status
id|padapter-&gt;regScratchPad
op_assign
id|zr
op_plus
id|RTR_MAILBOX
suffix:semicolon
singleline_comment|// 16 byte scratchpad I/O base address
id|padapter-&gt;regBase
op_assign
id|zl
suffix:semicolon
id|padapter-&gt;regData
op_assign
id|zl
op_plus
id|REG_DATA
suffix:semicolon
singleline_comment|// data register I/O address
id|padapter-&gt;regError
op_assign
id|zl
op_plus
id|REG_ERROR
suffix:semicolon
singleline_comment|// error register I/O address
id|padapter-&gt;regSectCount
op_assign
id|zl
op_plus
id|REG_SECTOR_COUNT
suffix:semicolon
singleline_comment|// sector count register I/O address
id|padapter-&gt;regLba0
op_assign
id|zl
op_plus
id|REG_LBA_0
suffix:semicolon
singleline_comment|// least significant byte of LBA
id|padapter-&gt;regLba8
op_assign
id|zl
op_plus
id|REG_LBA_8
suffix:semicolon
singleline_comment|// next least significant byte of LBA
id|padapter-&gt;regLba16
op_assign
id|zl
op_plus
id|REG_LBA_16
suffix:semicolon
singleline_comment|// next most significan byte of LBA
id|padapter-&gt;regLba24
op_assign
id|zl
op_plus
id|REG_LBA_24
suffix:semicolon
singleline_comment|// head and most 4 significant bits of LBA
id|padapter-&gt;regStatCmd
op_assign
id|zl
op_plus
id|REG_STAT_CMD
suffix:semicolon
singleline_comment|// status on read and command on write register
id|padapter-&gt;regStatSel
op_assign
id|zl
op_plus
id|REG_STAT_SEL
suffix:semicolon
singleline_comment|// board status on read and spigot select on write register
id|padapter-&gt;regFail
op_assign
id|zl
op_plus
id|REG_FAIL
suffix:semicolon
id|padapter-&gt;regAltStat
op_assign
id|zl
op_plus
id|REG_ALT_STAT
suffix:semicolon
id|padapter-&gt;pcidev
op_assign
id|pcidev
suffix:semicolon
r_if
c_cond
(paren
id|bigd
)paren
(brace
id|padapter-&gt;regDmaDesc
op_assign
id|zr
op_plus
id|RTR_DMA0_DESC_PTR
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
id|padapter-&gt;regDmaCmdStat
op_assign
id|zr
op_plus
id|RTR_DMA_COMMAND_STATUS
suffix:semicolon
singleline_comment|// Byte #0 of DMA command status register
id|padapter-&gt;regDmaAddrPci
op_assign
id|zr
op_plus
id|RTR_DMA0_PCI_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
id|padapter-&gt;regDmaAddrLoc
op_assign
id|zr
op_plus
id|RTR_DMA0_LOCAL_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
id|padapter-&gt;regDmaCount
op_assign
id|zr
op_plus
id|RTR_DMA0_COUNT
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
id|padapter-&gt;regDmaMode
op_assign
id|zr
op_plus
id|RTR_DMA0_MODE
op_plus
l_int|1
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
id|padapter-&gt;bigD
op_assign
id|SEL_NEW_SPEED_1
suffix:semicolon
singleline_comment|// set spigot speed control bit
)brace
r_else
(brace
id|padapter-&gt;regDmaDesc
op_assign
id|zl
op_plus
id|RTL_DMA1_DESC_PTR
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
id|padapter-&gt;regDmaCmdStat
op_assign
id|zl
op_plus
id|RTL_DMA_COMMAND_STATUS
op_plus
l_int|1
suffix:semicolon
singleline_comment|// Byte #1 of DMA command status register
id|padapter-&gt;regDmaAddrPci
op_assign
id|zl
op_plus
id|RTL_DMA1_PCI_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
id|padapter-&gt;regDmaAddrLoc
op_assign
id|zl
op_plus
id|RTL_DMA1_LOCAL_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
id|padapter-&gt;regDmaCount
op_assign
id|zl
op_plus
id|RTL_DMA1_COUNT
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
id|padapter-&gt;regDmaMode
op_assign
id|zl
op_plus
id|RTL_DMA1_MODE
op_plus
l_int|1
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
)brace
id|padapter-&gt;numberOfDrives
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_NUM_DRIVES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bigd
op_logical_and
op_logical_neg
id|padapter-&gt;numberOfDrives
)paren
singleline_comment|// if no devices on this board
r_return
id|TRUE
suffix:semicolon
id|pshost-&gt;irq
op_assign
id|pcidev-&gt;irq
suffix:semicolon
id|setirq
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|Installed
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// scan for shared interrupts
(brace
r_if
c_cond
(paren
id|PsiHost
(braket
id|z
)braket
op_member_access_from_pointer
id|irq
op_eq
id|pshost-&gt;irq
)paren
singleline_comment|// if shared then, don&squot;t posses
id|setirq
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setirq
)paren
singleline_comment|// if not shared, posses
(brace
r_if
c_cond
(paren
id|request_irq
(paren
id|pshost-&gt;irq
comma
id|Irq_Handler
comma
id|SA_SHIRQ
comma
l_string|&quot;pci2220i&quot;
comma
id|padapter
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_irq
(paren
id|pshost-&gt;irq
comma
id|Irq_Handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;pci2220i&quot;
comma
id|padapter
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to allocate IRQ for PCI-2220I controller.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
)brace
id|padapter-&gt;irqOwned
op_assign
id|pshost-&gt;irq
suffix:semicolon
singleline_comment|// set IRQ as owned
)brace
r_if
c_cond
(paren
id|padapter-&gt;numberOfDrives
)paren
id|consistent
op_assign
id|pci_alloc_consistent
(paren
id|pcidev
comma
id|SECTORSXFER
op_star
id|BYTES_PER_SECTOR
comma
op_amp
id|consistentDma
)paren
suffix:semicolon
r_else
id|consistent
op_assign
id|pci_alloc_consistent
(paren
id|pcidev
comma
id|ATAPI_TRANSFER
comma
op_amp
id|consistentDma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|consistent
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to allocate DMA buffer for PCI-2220I controller.&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
(paren
id|pshost-&gt;irq
comma
id|padapter
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|padapter-&gt;kBuffer
op_assign
id|consistent
suffix:semicolon
id|padapter-&gt;kBufferDma
op_assign
id|consistentDma
suffix:semicolon
id|PsiHost
(braket
id|Installed
)braket
op_assign
id|pshost
suffix:semicolon
singleline_comment|// save SCSI_HOST pointer
id|pshost-&gt;io_port
op_assign
id|padapter-&gt;basePort
suffix:semicolon
id|pshost-&gt;n_io_port
op_assign
l_int|0xFF
suffix:semicolon
id|pshost-&gt;unique_id
op_assign
id|padapter-&gt;regBase
suffix:semicolon
id|outb_p
(paren
l_int|0x01
comma
id|padapter-&gt;regRange
)paren
suffix:semicolon
singleline_comment|// fix our range register because other drivers want to tromp on it
id|padapter-&gt;timingMode
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_TIMING_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingMode
op_ge
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|bigd
)paren
id|padapter-&gt;timingAddress
op_assign
id|ModeArray2
(braket
id|padapter-&gt;timingMode
op_minus
l_int|2
)braket
suffix:semicolon
r_else
id|padapter-&gt;timingAddress
op_assign
id|ModeArray
(braket
id|padapter-&gt;timingMode
op_minus
l_int|2
)braket
suffix:semicolon
)brace
r_else
id|padapter-&gt;timingPIO
op_assign
id|TRUE
suffix:semicolon
id|ReadFlash
(paren
id|padapter
comma
op_amp
id|DaleSetup
comma
id|DALE_FLASH_SETUP
comma
r_sizeof
(paren
id|SETUP
)paren
)paren
suffix:semicolon
id|ReadFlash
(paren
id|padapter
comma
op_amp
id|DiskMirror
comma
id|DALE_FLASH_RAID
comma
r_sizeof
(paren
id|DiskMirror
)paren
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;SetupFinish&n; *&n; *&t;Description:&t;Complete the driver initialization process for a card&n; *&n; *&t;Parameters:&t;&t;padapter  - Pointer to SCSI host data structure.&n; *&t;&t;&t;&t;&t;str&t;&t;  - Pointer to board type string.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|SetupFinish
id|VOID
id|SetupFinish
(paren
id|PADAPTER2220I
id|padapter
comma
r_char
op_star
id|str
comma
r_int
id|irq
)paren
(brace
id|init_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;timer.function
op_assign
id|TimerExpiry
suffix:semicolon
id|padapter-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|padapter
suffix:semicolon
id|init_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
id|padapter-&gt;reconTimer.function
op_assign
id|ReconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
(paren
r_int
r_int
)paren
id|padapter
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nPCI-%sI EIDE CONTROLLER: at I/O = %lX/%lX  IRQ = %d&bslash;n&quot;
comma
id|str
comma
id|padapter-&gt;basePort
comma
id|padapter-&gt;regBase
comma
id|irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Version %s, Compiled %s %s&bslash;n&bslash;n&quot;
comma
id|PCI2220I_VERSION
comma
id|__DATE__
comma
id|__TIME__
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Detect&n; *&n; *&t;Description:&t;Detect and initialize our boards.&n; *&n; *&t;Parameters:&t;&t;tpnt - Pointer to SCSI host template structure.&n; *&n; *&t;Returns:&t;&t;Number of adapters installed.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Detect
r_int
id|Pci2220i_Detect
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|pshost
suffix:semicolon
id|PADAPTER2220I
id|padapter
suffix:semicolon
id|POUR_DEVICE
id|pdev
suffix:semicolon
r_int
id|unit
suffix:semicolon
r_int
id|z
suffix:semicolon
id|USHORT
id|raidon
suffix:semicolon
id|UCHAR
id|spigot1
comma
id|spigot2
suffix:semicolon
id|UCHAR
id|device
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
(paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;pci2220i: PCI BIOS not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
(paren
id|VENDOR_PSI
comma
id|DEVICE_DALE_1
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pcidev
)paren
)paren
r_continue
suffix:semicolon
id|pshost
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
id|ADAPTER2220I
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pshost
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GetRegs
(paren
id|pshost
comma
id|FALSE
comma
id|pcidev
)paren
)paren
r_goto
id|unregister
suffix:semicolon
id|pshost-&gt;max_id
op_assign
id|padapter-&gt;numberOfDrives
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|padapter-&gt;numberOfDrives
suffix:semicolon
id|z
op_increment
)paren
(brace
id|unit
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_CHANNEL_DEVICE_0
op_plus
id|z
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
suffix:semicolon
id|pdev-&gt;byte6
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
(paren
id|unit
op_amp
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
l_int|0xE0
)paren
suffix:semicolon
id|pdev-&gt;spigot
op_assign
(paren
id|UCHAR
)paren
(paren
l_int|1
op_lshift
(paren
id|unit
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|pdev-&gt;sectors
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|sectors
suffix:semicolon
id|pdev-&gt;heads
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|heads
suffix:semicolon
id|pdev-&gt;cylinders
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|cylinders
suffix:semicolon
id|pdev-&gt;blocks
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|blocks
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|z
)paren
(brace
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_0_STATUS
)paren
suffix:semicolon
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_1_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|pairIdentifier
op_eq
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|pairIdentifier
op_xor
l_int|1
)paren
)paren
)paren
(brace
id|raidon
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|unit
OG
(paren
id|unit
op_xor
l_int|2
)paren
)paren
id|unit
op_assign
id|unit
op_xor
l_int|2
suffix:semicolon
)brace
r_else
id|raidon
op_assign
id|FALSE
suffix:semicolon
id|memcpy
(paren
id|pdev-&gt;DiskMirror
comma
id|DiskMirror
comma
r_sizeof
(paren
id|DiskMirror
)paren
)paren
suffix:semicolon
id|padapter-&gt;raidData
(braket
l_int|0
)braket
op_assign
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
suffix:semicolon
id|padapter-&gt;raidData
(braket
l_int|2
)braket
op_assign
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
suffix:semicolon
id|spigot1
op_assign
id|spigot2
op_assign
id|FALSE
suffix:semicolon
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
id|pdev-&gt;spigots
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
id|pdev-&gt;lastsectorlba
(braket
l_int|0
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|pdev-&gt;lastsectorlba
(braket
l_int|1
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
id|pdev-&gt;lastsectorlba
(braket
l_int|0
)braket
)paren
id|spigot1
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
id|pdev-&gt;lastsectorlba
(braket
l_int|1
)braket
)paren
id|spigot2
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
id|spigot1
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|spigot1
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|InlineReadSignature
(paren
id|padapter
comma
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spigot2
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|InlineReadSignature
(paren
id|padapter
comma
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spigot1
op_logical_and
id|spigot2
op_logical_and
id|raidon
)paren
(brace
id|pdev-&gt;raid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
id|pdev-&gt;spigot
op_assign
l_int|2
suffix:semicolon
r_else
id|pdev-&gt;spigot
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|padapter-&gt;reconOn
op_assign
id|pdev-&gt;reconOn
op_assign
id|pdev-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|spigot1
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_goto
id|unregister
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
id|pdev-&gt;spigot
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_goto
id|unregister
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
id|pdev-&gt;spigot
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DaleSetup.rebootRebuild
op_logical_and
id|raidon
)paren
id|padapter-&gt;reconOn
op_assign
id|pdev-&gt;reconOn
op_assign
id|pdev-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|raidon
)paren
r_break
suffix:semicolon
)brace
)brace
id|SetupFinish
(paren
id|padapter
comma
l_string|&quot;2220&quot;
comma
id|pshost-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|Installed
OL
id|MAXADAPTER
)paren
r_continue
suffix:semicolon
r_break
suffix:semicolon
suffix:semicolon
id|unregister
suffix:colon
suffix:semicolon
id|scsi_unregister
(paren
id|pshost
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
(paren
id|VENDOR_PSI
comma
id|DEVICE_BIGD_1
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pshost
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
id|ADAPTER2220I
)paren
)paren
suffix:semicolon
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GetRegs
(paren
id|pshost
comma
id|TRUE
comma
id|pcidev
)paren
)paren
r_goto
id|unregister1
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|BIGD_MAXDRIVES
suffix:semicolon
id|z
op_increment
)paren
id|DiskMirror
(braket
id|z
)braket
dot
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_RAID_0_STATUS
op_plus
id|z
)paren
suffix:semicolon
id|pshost-&gt;max_id
op_assign
id|padapter-&gt;numberOfDrives
suffix:semicolon
id|padapter-&gt;failRegister
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_ALARM_IMAGE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|padapter-&gt;numberOfDrives
suffix:semicolon
id|z
op_increment
)paren
(brace
id|unit
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_DEVICE_0
op_plus
id|z
)paren
suffix:semicolon
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
suffix:semicolon
id|pdev-&gt;byte6
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
(paren
id|unit
op_amp
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
l_int|0xE0
)paren
suffix:semicolon
id|pdev-&gt;spigot
op_assign
(paren
id|UCHAR
)paren
(paren
l_int|1
op_lshift
(paren
id|unit
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|pdev-&gt;sectors
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|sectors
suffix:semicolon
id|pdev-&gt;heads
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|heads
suffix:semicolon
id|pdev-&gt;cylinders
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|cylinders
suffix:semicolon
id|pdev-&gt;blocks
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|blocks
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DiskMirror
(braket
id|unit
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|DiskMirror
(braket
id|unit
op_xor
l_int|2
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|DiskMirror
(braket
id|unit
)braket
dot
id|pairIdentifier
op_eq
(paren
id|DiskMirror
(braket
id|unit
op_xor
l_int|2
)braket
dot
id|pairIdentifier
op_xor
l_int|1
)paren
)paren
)paren
(brace
id|raidon
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|unit
OG
(paren
id|unit
op_xor
l_int|2
)paren
)paren
id|unit
op_assign
id|unit
op_xor
l_int|2
suffix:semicolon
)brace
r_else
id|raidon
op_assign
id|FALSE
suffix:semicolon
id|spigot1
op_assign
id|spigot2
op_assign
id|FALSE
suffix:semicolon
id|memcpy
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
comma
op_amp
id|DiskMirror
(braket
id|unit
)braket
comma
r_sizeof
(paren
id|DISK_MIRROR
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
comma
op_amp
id|DiskMirror
(braket
id|unit
op_xor
l_int|2
)braket
comma
r_sizeof
(paren
id|DISK_MIRROR
)paren
)paren
suffix:semicolon
id|padapter-&gt;raidData
(braket
id|unit
)braket
op_assign
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
suffix:semicolon
id|padapter-&gt;raidData
(braket
id|unit
op_xor
l_int|2
)braket
op_assign
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
suffix:semicolon
id|pdev-&gt;spigots
(braket
l_int|0
)braket
op_assign
l_int|1
op_lshift
(paren
id|unit
op_rshift
l_int|1
)paren
suffix:semicolon
id|pdev-&gt;spigots
(braket
l_int|1
)braket
op_assign
l_int|1
op_lshift
(paren
(paren
id|unit
op_xor
l_int|2
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|pdev-&gt;deviceID
(braket
l_int|0
)braket
op_assign
id|unit
suffix:semicolon
id|pdev-&gt;deviceID
(braket
l_int|1
)braket
op_assign
id|unit
op_xor
l_int|2
suffix:semicolon
id|pdev-&gt;lastsectorlba
(braket
l_int|0
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|0
)braket
comma
id|unit
op_amp
l_int|1
)paren
suffix:semicolon
id|pdev-&gt;lastsectorlba
(braket
l_int|1
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
id|pdev-&gt;spigots
(braket
l_int|1
)braket
comma
id|unit
op_amp
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
id|pdev-&gt;lastsectorlba
(braket
l_int|0
)braket
)paren
id|spigot1
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
id|pdev-&gt;lastsectorlba
(braket
l_int|1
)braket
)paren
id|spigot2
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
id|spigot1
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|spigot1
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|InlineReadSignature
(paren
id|padapter
comma
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spigot2
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|InlineReadSignature
(paren
id|padapter
comma
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spigot1
op_logical_and
id|spigot2
op_logical_and
id|raidon
)paren
(brace
id|pdev-&gt;raid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
id|pdev-&gt;spigot
op_assign
id|pdev-&gt;spigots
(braket
l_int|1
)braket
suffix:semicolon
r_else
id|pdev-&gt;spigot
op_assign
id|pdev-&gt;spigots
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|padapter-&gt;reconOn
op_assign
id|pdev-&gt;reconOn
op_assign
id|pdev-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|spigot1
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_goto
id|unregister1
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
id|pdev-&gt;spigot
op_assign
id|pdev-&gt;spigots
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_goto
id|unregister
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
id|pdev-&gt;spigot
op_assign
id|pdev-&gt;spigots
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DaleSetup.rebootRebuild
op_logical_and
id|raidon
)paren
id|padapter-&gt;reconOn
op_assign
id|pdev-&gt;reconOn
op_assign
id|pdev-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;numberOfDrives
)paren
singleline_comment|// If no ATA devices then scan ATAPI
(brace
id|unit
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|spigot1
op_assign
l_int|0
suffix:semicolon
id|spigot1
OL
l_int|4
suffix:semicolon
id|spigot1
op_increment
)paren
(brace
r_for
c_loop
(paren
id|device
op_assign
l_int|0
suffix:semicolon
id|device
OL
l_int|2
suffix:semicolon
id|device
op_increment
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2242I: scanning for ID %d &quot;
comma
(paren
id|spigot1
op_star
l_int|2
)paren
op_plus
id|device
)paren
)paren
suffix:semicolon
id|pdev
op_assign
op_amp
(paren
id|padapter-&gt;device
(braket
(paren
id|spigot1
op_star
l_int|2
)paren
op_plus
id|device
)braket
)paren
suffix:semicolon
id|pdev-&gt;byte6
op_assign
l_int|0x0A
op_or
(paren
id|device
op_lshift
l_int|4
)paren
suffix:semicolon
id|pdev-&gt;spigot
op_assign
l_int|1
op_lshift
id|spigot1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|AtapiReset
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot; Device found &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|AtapiIdentify
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot; Device verified&quot;
)paren
)paren
suffix:semicolon
id|unit
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
id|pdev-&gt;spigot
op_assign
id|pdev-&gt;byte6
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|unit
)paren
(brace
id|padapter-&gt;atapi
op_assign
id|TRUE
suffix:semicolon
id|padapter-&gt;timingAddress
op_assign
id|DALE_DATA_MODE3
suffix:semicolon
id|outw_p
(paren
l_int|0x0900
comma
id|padapter-&gt;regIrqControl
)paren
suffix:semicolon
singleline_comment|// Turn our interrupts on
id|outw_p
(paren
l_int|0x0C41
comma
id|padapter-&gt;regDmaMode
op_minus
l_int|1
)paren
suffix:semicolon
singleline_comment|// setup for 16 bits, ready enabled, done IRQ enabled, no incriment
id|outb_p
(paren
l_int|0xFF
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
singleline_comment|// all fail lights and alarm off
id|pshost-&gt;max_id
op_assign
l_int|8
suffix:semicolon
)brace
)brace
id|SetupFinish
(paren
id|padapter
comma
l_string|&quot;2240&quot;
comma
id|pshost-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|Installed
OL
id|MAXADAPTER
)paren
r_continue
suffix:semicolon
r_break
suffix:semicolon
suffix:semicolon
id|unregister1
suffix:colon
suffix:semicolon
id|scsi_unregister
(paren
id|pshost
)paren
suffix:semicolon
)brace
id|NumAdapters
op_assign
id|Installed
suffix:semicolon
r_return
id|Installed
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Abort&n; *&n; *&t;Description:&t;Process the Abort command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Allways snooze.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Abort
r_int
id|Pci2220i_Abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|SCpnt-&gt;target
)braket
suffix:semicolon
singleline_comment|// Pointer to device information
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;SCpnt
)paren
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;atapi
)paren
(brace
r_if
c_cond
(paren
id|AtapiReset
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_return
id|SCSI_ABORT_ERROR
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Reset&n; *&n; *&t;Description:&t;Process the Reset command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;flags - Flags about the reset command&n; *&n; *&t;Returns:&t;&t;No active command at this time, so this means&n; *&t;&t;&t;&t;&t;that each time we got some kind of response the&n; *&t;&t;&t;&t;&t;last time through.  Tell the mid-level code to&n; *&t;&t;&t;&t;&t;request sense information in order to decide what&n; *&t;&t;&t;&t;&t;to do next.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Reset
r_int
id|Pci2220i_Reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|SCpnt-&gt;target
)braket
suffix:semicolon
singleline_comment|// Pointer to device information
r_if
c_cond
(paren
id|padapter-&gt;atapi
)paren
(brace
r_if
c_cond
(paren
id|AtapiReset
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Release&n; *&n; *&t;Description:&t;Release resources allocated for a single each adapter.&n; *&n; *&t;Parameters:&t;&t;pshost - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;zero.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Release
r_int
id|Pci2220i_Release
(paren
r_struct
id|Scsi_Host
op_star
id|pshost
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
(paren
id|pshost
)paren
suffix:semicolon
id|USHORT
id|z
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconOn
)paren
(brace
id|padapter-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
singleline_comment|// shut down the hot reconstruct
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
id|mdelay
(paren
l_int|300
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconTimer.data
)paren
singleline_comment|// is the timer running?
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|// save RAID status on the board
r_if
c_cond
(paren
id|padapter-&gt;bigD
)paren
(brace
id|outb_p
(paren
id|padapter-&gt;failRegister
comma
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_ALARM_IMAGE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|BIGD_MAXDRIVES
suffix:semicolon
id|z
op_increment
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;raidData
)paren
id|outb_p
(paren
id|padapter-&gt;raidData
(braket
id|z
)braket
op_member_access_from_pointer
id|status
comma
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_RAID_0_STATUS
op_plus
id|z
)paren
suffix:semicolon
r_else
id|outb_p
(paren
l_int|0
comma
id|padapter-&gt;regScratchPad
op_plus
id|BIGD_RAID_0_STATUS
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|outb_p
(paren
id|padapter-&gt;device
(braket
l_int|0
)braket
dot
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
comma
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_0_STATUS
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;device
(braket
l_int|0
)braket
dot
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
comma
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_1_STATUS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;irqOwned
)paren
id|free_irq
(paren
id|pshost-&gt;irq
comma
id|padapter
)paren
suffix:semicolon
id|release_region
(paren
id|pshost-&gt;io_port
comma
id|pshost-&gt;n_io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;numberOfDrives
)paren
id|pci_free_consistent
(paren
id|padapter-&gt;pcidev
comma
id|SECTORSXFER
op_star
id|BYTES_PER_SECTOR
comma
id|padapter-&gt;kBuffer
comma
id|padapter-&gt;kBufferDma
)paren
suffix:semicolon
r_else
id|pci_free_consistent
(paren
id|padapter-&gt;pcidev
comma
id|ATAPI_TRANSFER
comma
id|padapter-&gt;kBuffer
comma
id|padapter-&gt;kBufferDma
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|pshost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#include &quot;sd.h&quot;
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_BiosParam&n; *&n; *&t;Description:&t;Process the biosparam request from the SCSI manager to&n; *&t;&t;&t;&t;&t;return C/H/S data.&n; *&n; *&t;Parameters:&t;&t;disk - Pointer to SCSI disk structure.&n; *&t;&t;&t;&t;&t;dev&t; - Major/minor number from kernel.&n; *&t;&t;&t;&t;&t;geom - Pointer to integer array to place geometry data.&n; *&n; *&t;Returns:&t;&t;zero.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_BiosParam
r_int
id|Pci2220i_BiosParam
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|POUR_DEVICE
id|pdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|HOSTDATA
c_func
(paren
id|disk-&gt;device-&gt;host
)paren
)paren
op_member_access_from_pointer
id|atapi
)paren
(brace
id|pdev
op_assign
op_amp
(paren
id|HOSTDATA
c_func
(paren
id|disk-&gt;device-&gt;host
)paren
op_member_access_from_pointer
id|device
(braket
id|disk-&gt;device-&gt;id
)braket
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|pdev-&gt;heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|pdev-&gt;sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|pdev-&gt;cylinders
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|PCI2220I
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
