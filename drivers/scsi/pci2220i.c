multiline_comment|/****************************************************************************&n; * Perceptive Solutions, Inc. PCI-2220I device driver for Linux.&n; *&n; * pci2220i.c - Linux Host Driver for PCI-2220I EIDE RAID Adapters&n; *&n; * Copyright (c) 1997-1999 Perceptive Solutions, Inc.&n; * All Rights Reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that redistributions of source&n; * code retain the above copyright notice and this comment without&n; * modification.&n; *&n; * Technical updates and product information at:&n; *  http://www.psidisk.com&n; *&n; * Please send questions, comments, bug reports to:&n; *  tech@psidisk.com Technical Support&n; *&n; *&n; *&t;Revisions 1.10&t;&t;Mar-26-1999&n; *&t;&t;- Updated driver for RAID and hot reconstruct support.&n; *&n; *&t;Revisions 1.11&t;&t;Mar-26-1999&n; *&t;&t;- Fixed spinlock and PCI configuration.&n; *&n; ****************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;pci2220i.h&quot;
macro_line|#if LINUX_VERSION_CODE &gt;= LINUXVERSION(2,1,95)
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,93)
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#endif
DECL|macro|PCI2220I_VERSION
mdefine_line|#define&t;PCI2220I_VERSION&t;&t;&quot;1.11&quot;
singleline_comment|//#define&t;READ_CMD&t;&t;&t;&t;IDE_COMMAND_READ
singleline_comment|//#define&t;WRITE_CMD&t;&t;&t;&t;IDE_COMMAND_WRITE
singleline_comment|//#define&t;MAX_BUS_MASTER_BLOCKS&t;1&t;&t;// This is the maximum we can bus master
DECL|macro|READ_CMD
mdefine_line|#define&t;READ_CMD&t;&t;&t;&t;IDE_CMD_READ_MULTIPLE
DECL|macro|WRITE_CMD
mdefine_line|#define&t;WRITE_CMD&t;&t;&t;&t;IDE_CMD_WRITE_MULTIPLE
DECL|macro|MAX_BUS_MASTER_BLOCKS
mdefine_line|#define&t;MAX_BUS_MASTER_BLOCKS&t;SECTORSXFER&t;&t;
singleline_comment|// This is the maximum we can bus master
DECL|variable|Proc_Scsi_Pci2220i
r_struct
id|proc_dir_entry
id|Proc_Scsi_Pci2220i
op_assign
(brace
id|PROC_SCSI_PCI2220I
comma
l_int|8
comma
l_string|&quot;pci2220i&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
singleline_comment|//#define DEBUG 1
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
DECL|macro|STOP_HERE
mdefine_line|#define STOP_HERE()&t;{int st;for(st=0;st&lt;100;st++){st=1;}}
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|STOP_HERE
mdefine_line|#define STOP_HERE()
macro_line|#endif
DECL|macro|MAXADAPTER
mdefine_line|#define MAXADAPTER 4&t;&t;&t;&t;&t;
singleline_comment|// Increase this and the sizes of the arrays below, if you need more.
r_typedef
r_struct
(brace
DECL|member|device
id|UCHAR
id|device
suffix:semicolon
singleline_comment|// device code
DECL|member|byte6
id|UCHAR
id|byte6
suffix:semicolon
singleline_comment|// device select register image
DECL|member|spigot
id|UCHAR
id|spigot
suffix:semicolon
singleline_comment|// spigot number
DECL|member|sparebyte
id|UCHAR
id|sparebyte
suffix:semicolon
singleline_comment|// placeholder
DECL|member|sectors
id|USHORT
id|sectors
suffix:semicolon
singleline_comment|// number of sectors per track
DECL|member|heads
id|USHORT
id|heads
suffix:semicolon
singleline_comment|// number of heads
DECL|member|cylinders
id|USHORT
id|cylinders
suffix:semicolon
singleline_comment|// number of cylinders for this device
DECL|member|spareword
id|USHORT
id|spareword
suffix:semicolon
singleline_comment|// placeholder
DECL|member|blocks
id|ULONG
id|blocks
suffix:semicolon
singleline_comment|// number of blocks on device
DECL|member|DiskMirror
id|DISK_MIRROR
id|DiskMirror
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// RAID status and control
DECL|member|lastsectorlba
id|ULONG
id|lastsectorlba
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// last addressable sector on the drive
DECL|member|raid
id|USHORT
id|raid
suffix:semicolon
singleline_comment|// RAID active flag
DECL|member|mirrorRecon
id|USHORT
id|mirrorRecon
suffix:semicolon
DECL|member|hotRecon
id|UCHAR
id|hotRecon
suffix:semicolon
DECL|member|reconCount
id|USHORT
id|reconCount
suffix:semicolon
DECL|typedef|OUR_DEVICE
DECL|typedef|POUR_DEVICE
)brace
id|OUR_DEVICE
comma
op_star
id|POUR_DEVICE
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|regDmaDesc
id|USHORT
id|regDmaDesc
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
DECL|member|regDmaCmdStat
id|USHORT
id|regDmaCmdStat
suffix:semicolon
singleline_comment|// Byte #1 of DMA command status register
DECL|member|regDmaAddrPci
id|USHORT
id|regDmaAddrPci
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
DECL|member|regDmaAddrLoc
id|USHORT
id|regDmaAddrLoc
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
DECL|member|regDmaCount
id|USHORT
id|regDmaCount
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
DECL|member|regDmaMode
id|USHORT
id|regDmaMode
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
DECL|member|regRemap
id|USHORT
id|regRemap
suffix:semicolon
singleline_comment|// 32 bit local space remap
DECL|member|regDesc
id|USHORT
id|regDesc
suffix:semicolon
singleline_comment|// 32 bit local region descriptor
DECL|member|regRange
id|USHORT
id|regRange
suffix:semicolon
singleline_comment|// 32 bit local range
DECL|member|regIrqControl
id|USHORT
id|regIrqControl
suffix:semicolon
singleline_comment|// 16 bit Interrupt enable/disable and status
DECL|member|regScratchPad
id|USHORT
id|regScratchPad
suffix:semicolon
singleline_comment|// scratch pad I/O base address
DECL|member|regBase
id|USHORT
id|regBase
suffix:semicolon
singleline_comment|// Base I/O register for data space
DECL|member|regData
id|USHORT
id|regData
suffix:semicolon
singleline_comment|// data register I/O address
DECL|member|regError
id|USHORT
id|regError
suffix:semicolon
singleline_comment|// error register I/O address
DECL|member|regSectCount
id|USHORT
id|regSectCount
suffix:semicolon
singleline_comment|// sector count register I/O address
DECL|member|regLba0
id|USHORT
id|regLba0
suffix:semicolon
singleline_comment|// least significant byte of LBA
DECL|member|regLba8
id|USHORT
id|regLba8
suffix:semicolon
singleline_comment|// next least significant byte of LBA
DECL|member|regLba16
id|USHORT
id|regLba16
suffix:semicolon
singleline_comment|// next most significan byte of LBA
DECL|member|regLba24
id|USHORT
id|regLba24
suffix:semicolon
singleline_comment|// head and most 4 significant bits of LBA
DECL|member|regStatCmd
id|USHORT
id|regStatCmd
suffix:semicolon
singleline_comment|// status on read and command on write register
DECL|member|regStatSel
id|USHORT
id|regStatSel
suffix:semicolon
singleline_comment|// board status on read and spigot select on write register
DECL|member|regFail
id|USHORT
id|regFail
suffix:semicolon
singleline_comment|// fail bits control register
DECL|member|regAltStat
id|USHORT
id|regAltStat
suffix:semicolon
singleline_comment|// alternate status and drive control register
DECL|member|basePort
id|USHORT
id|basePort
suffix:semicolon
singleline_comment|// PLX base I/O port
DECL|member|timingMode
id|USHORT
id|timingMode
suffix:semicolon
singleline_comment|// timing mode currently set for adapter
DECL|member|timingPIO
id|USHORT
id|timingPIO
suffix:semicolon
singleline_comment|// TRUE if PIO timing is active
DECL|member|timingAddress
id|ULONG
id|timingAddress
suffix:semicolon
singleline_comment|// address to use on adapter for current timing mode
DECL|member|irqOwned
id|ULONG
id|irqOwned
suffix:semicolon
singleline_comment|// owned IRQ or zero if shared
DECL|member|device
id|OUR_DEVICE
id|device
(braket
id|DALE_MAXDRIVES
)braket
suffix:semicolon
DECL|member|raidData
id|DISK_MIRROR
op_star
id|raidData
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|startSector
id|ULONG
id|startSector
suffix:semicolon
DECL|member|sectorCount
id|USHORT
id|sectorCount
suffix:semicolon
DECL|member|cmd
id|UCHAR
id|cmd
suffix:semicolon
DECL|member|SCpnt
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
DECL|member|buffer
id|VOID
op_star
id|buffer
suffix:semicolon
DECL|member|pdev
id|POUR_DEVICE
id|pdev
suffix:semicolon
singleline_comment|// current device opearating on
DECL|member|expectingIRQ
id|USHORT
id|expectingIRQ
suffix:semicolon
DECL|member|reconIsStarting
id|USHORT
id|reconIsStarting
suffix:semicolon
singleline_comment|// indicate hot reconstruct is starting
DECL|member|reconOn
id|USHORT
id|reconOn
suffix:semicolon
singleline_comment|// Hot reconstruct is to be done.
DECL|member|reconPhase
id|USHORT
id|reconPhase
suffix:semicolon
singleline_comment|// Hot reconstruct operation is in progress.
DECL|member|reconSize
id|ULONG
id|reconSize
suffix:semicolon
DECL|member|demoFail
id|USHORT
id|demoFail
suffix:semicolon
singleline_comment|// flag for RAID failure demonstration
DECL|member|survivor
id|USHORT
id|survivor
suffix:semicolon
DECL|member|failinprog
id|USHORT
id|failinprog
suffix:semicolon
DECL|member|reconTimer
r_struct
id|timer_list
id|reconTimer
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|kBuffer
id|UCHAR
op_star
id|kBuffer
suffix:semicolon
DECL|typedef|ADAPTER2220I
DECL|typedef|PADAPTER2220I
)brace
id|ADAPTER2220I
comma
op_star
id|PADAPTER2220I
suffix:semicolon
DECL|macro|HOSTDATA
mdefine_line|#define HOSTDATA(host) ((PADAPTER2220I)&amp;host-&gt;hostdata)
DECL|macro|RECON_PHASE_READY
mdefine_line|#define&t;RECON_PHASE_READY&t;&t;0x01
DECL|macro|RECON_PHASE_COPY
mdefine_line|#define&t;RECON_PHASE_COPY&t;&t;0x02
DECL|macro|RECON_PHASE_UPDATE
mdefine_line|#define&t;RECON_PHASE_UPDATE&t;&t;0x03
DECL|macro|RECON_PHASE_LAST
mdefine_line|#define&t;RECON_PHASE_LAST&t;&t;0x04
DECL|macro|RECON_PHASE_END
mdefine_line|#define&t;RECON_PHASE_END&t;&t;&t;0x07&t;
DECL|macro|RECON_PHASE_MARKING
mdefine_line|#define&t;RECON_PHASE_MARKING&t;&t;0x80
DECL|macro|RECON_PHASE_FAILOVER
mdefine_line|#define&t;RECON_PHASE_FAILOVER&t;0xFF
DECL|variable|PsiHost
r_static
r_struct
id|Scsi_Host
op_star
id|PsiHost
(braket
id|MAXADAPTER
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
singleline_comment|// One for each adapter
DECL|variable|NumAdapters
r_static
r_int
id|NumAdapters
op_assign
l_int|0
suffix:semicolon
DECL|variable|DaleSetup
r_static
id|SETUP
id|DaleSetup
suffix:semicolon
DECL|variable|DiskMirror
r_static
id|DISK_MIRROR
id|DiskMirror
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|ModeArray
r_static
id|ULONG
id|ModeArray
(braket
)braket
op_assign
(brace
id|DALE_DATA_MODE2
comma
id|DALE_DATA_MODE3
comma
id|DALE_DATA_MODE4
comma
id|DALE_DATA_MODE4P
)brace
suffix:semicolon
r_static
r_void
id|ReconTimerExpiry
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
multiline_comment|/****************************************************************&n; *&t;Name:&t;MuteAlarm&t;:LOCAL&n; *&n; *&t;Description:&t;Mute the audible alarm.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|MuteAlarm
r_static
r_void
id|MuteAlarm
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|UCHAR
id|old
suffix:semicolon
id|old
op_assign
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_rshift
l_int|3
)paren
op_or
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_amp
l_int|0x83
)paren
suffix:semicolon
id|outb_p
(paren
id|old
op_or
l_int|0x40
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WaitReady&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WaitReady
r_static
r_int
id|WaitReady
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|z
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
id|TIMEOUT_READY
op_star
l_int|4
)paren
suffix:semicolon
id|z
op_increment
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|IDE_STATUS_DRDY
op_or
id|IDE_STATUS_BUSY
)paren
)paren
op_eq
id|IDE_STATUS_DRDY
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WaitReadyReset&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WaitReadyReset
r_static
r_int
id|WaitReadyReset
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|z
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
l_int|250
op_star
l_int|4
)paren
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// wait up to 1/4 second
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|IDE_STATUS_DRDY
op_or
id|IDE_STATUS_BUSY
)paren
)paren
op_eq
id|IDE_STATUS_DRDY
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I:  Reset took %ld mSec to be ready&quot;
comma
id|z
op_div
l_int|4
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
)brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I:  Reset took more than 1 Second to come ready, Disk Failure&quot;
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WaitDrq&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready for data transfer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WaitDrq
r_static
r_int
id|WaitDrq
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|z
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
(paren
id|TIMEOUT_DRQ
op_star
l_int|4
)paren
suffix:semicolon
id|z
op_increment
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;HardReset&t;:LOCAL&n; *&n; *&t;Description:&t;Wait for device ready for data transfer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&t;&t;&t;&t;&t;spigot&t; - Spigot number.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|HardReset
r_static
r_int
id|HardReset
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
id|UCHAR
id|spigot
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
op_or
l_int|0x80
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x0E
comma
id|padapter-&gt;regAltStat
)paren
suffix:semicolon
singleline_comment|// reset the suvivor
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
singleline_comment|// wait a little&t;
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regAltStat
)paren
suffix:semicolon
singleline_comment|// clear the reset
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0xA0
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|//Specify drive
id|outb_p
(paren
id|pdev-&gt;byte6
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
r_if
c_cond
(paren
id|WaitReadyReset
(paren
id|padapter
)paren
)paren
r_return
id|TRUE
suffix:semicolon
id|outb_p
(paren
id|SECTORSXFER
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_CMD_SET_MULTIPLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
r_return
id|TRUE
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;BusMaster&t;:LOCAL&n; *&n; *&t;Description:&t;Do a bus master I/O.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;datain&t; - TRUE if data read.&n; *&t;&t;&t;&t;&t;irq&t;&t; - TRUE if bus master interrupt expected.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|BusMaster
r_static
r_void
id|BusMaster
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|datain
comma
id|UCHAR
id|irq
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|virt_to_bus
(paren
id|padapter-&gt;buffer
)paren
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
id|zl
op_mul_assign
(paren
id|ULONG
)paren
id|BYTES_PER_SECTOR
suffix:semicolon
id|padapter-&gt;buffer
op_add_assign
id|zl
suffix:semicolon
id|outl
(paren
id|zl
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datain
)paren
(brace
id|outb_p
(paren
l_int|8
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// read operation
r_if
c_cond
(paren
id|irq
op_logical_and
op_logical_neg
id|padapter-&gt;sectorCount
)paren
id|outb_p
(paren
l_int|5
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// interrupt on
r_else
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
)brace
r_else
(brace
id|outb_p
(paren
l_int|0
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// write operation
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
)brace
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteData&t;:LOCAL&n; *&n; *&t;Description:&t;Write data to device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WriteData
r_static
r_int
id|WriteData
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|WaitDrq
(paren
id|padapter
)paren
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;buffer
comma
id|zl
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
id|padapter-&gt;buffer
op_add_assign
id|zl
op_star
id|BYTES_PER_SECTOR
suffix:semicolon
)brace
r_else
id|BusMaster
(paren
id|padapter
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteDataBoth&t;:LOCAL&n; *&n; *&t;Description:&t;Write data to device.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;TRUE if drive does not assert DRQ in time.&n; *&n; ****************************************************************/
DECL|function|WriteDataBoth
r_static
r_int
id|WriteDataBoth
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
id|UCHAR
id|status0
comma
id|status1
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
l_int|1
)paren
suffix:semicolon
id|status0
op_assign
id|WaitDrq
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status0
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|2
)paren
suffix:semicolon
id|status1
op_assign
id|WaitDrq
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status1
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;buffer
comma
id|zl
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
id|padapter-&gt;buffer
op_add_assign
id|zl
op_star
id|BYTES_PER_SECTOR
suffix:semicolon
)brace
r_else
id|BusMaster
(paren
id|padapter
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_if
c_cond
(paren
id|status0
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;IdeCmd&t;:LOCAL&n; *&n; *&t;Description:&t;Process an IDE command.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&n; *&t;Returns:&t;&t;Zero if no error or status register contents on error.&n; *&n; ****************************************************************/
DECL|function|IdeCmd
r_static
id|UCHAR
id|IdeCmd
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|UCHAR
id|status
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|status
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|outb_p
(paren
id|padapter-&gt;sectorCount
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|padapter-&gt;cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;IdeCmdBoth&t;:LOCAL&n; *&n; *&t;Description:&t;Process an IDE command to both drivers.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Zero if no error or spigot of error.&n; *&n; ****************************************************************/
DECL|function|IdeCmdBoth
r_static
id|UCHAR
id|IdeCmdBoth
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|UCHAR
id|status0
suffix:semicolon
id|UCHAR
id|status1
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// select the spigots
id|outb_p
(paren
id|padapter-&gt;pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|SelectSpigot
(paren
id|padapter
comma
l_int|1
)paren
suffix:semicolon
id|status0
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status0
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|2
)paren
suffix:semicolon
id|status1
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status1
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|3
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;sectorCount
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|padapter-&gt;startSector
)paren
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|padapter-&gt;cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// null out the command byte
r_if
c_cond
(paren
id|status0
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;OpDone&t;:LOCAL&n; *&n; *&t;Description:&t;Complete an operatoin done sequence.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host data block.&n; *&t;&t;&t;&t;&t;spigot&t; - Spigot select code.&n; *&t;&t;&t;&t;&t;device&t; - Device byte code.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|OpDone
r_static
r_void
id|OpDone
(paren
id|PADAPTER2220I
id|padapter
comma
id|ULONG
id|result
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
id|padapter-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
id|padapter-&gt;reconPhase
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;SCpnt
)paren
(brace
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|SCpnt-&gt;scsi_done
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|padapter-&gt;reconOn
)paren
(brace
id|ReconTimerExpiry
(paren
(paren
r_int
r_int
)paren
id|padapter
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|result
suffix:semicolon
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconOn
op_logical_and
op_logical_neg
id|padapter-&gt;reconTimer.data
)paren
(brace
id|padapter-&gt;reconTimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
singleline_comment|// start in 1/4 second
id|padapter-&gt;reconTimer.data
op_assign
(paren
r_int
r_int
)paren
id|padapter
suffix:semicolon
id|add_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;InlineIdentify&t;:LOCAL&n; *&n; *&t;Description:&t;Do an intline inquiry on a drive.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host data block.&n; *&t;&t;&t;&t;&t;spigot&t; - Spigot select code.&n; *&t;&t;&t;&t;&t;device&t; - Device byte code.&n; *&n; *&t;Returns:&t;&t;Last addressable sector or zero if none.&n; *&n; ****************************************************************/
DECL|function|InlineIdentify
r_static
id|ULONG
id|InlineIdentify
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|spigot
comma
id|UCHAR
id|device
)paren
(brace
id|PIDENTIFY_DATA
id|pid
op_assign
(paren
id|PIDENTIFY_DATA
)paren
id|padapter-&gt;kBuffer
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
op_or
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// select the spigot
id|outb_p
(paren
id|device
op_lshift
l_int|4
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_IDENTIFY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitDrq
(paren
id|padapter
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
r_sizeof
(paren
id|IDENTIFY_DATA
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|pid-&gt;LBATotalSectors
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;InlineReadSignature&t;:LOCAL&n; *&n; *&t;Description:&t;Do an inline read RAID sigature.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to device.&n; *&t;&t;&t;&t;&t;index&t; - index of data to read.&n; *&n; *&t;Returns:&t;&t;Zero if no error or status register contents on error.&n; *&n; ****************************************************************/
DECL|function|InlineReadSignature
r_static
id|UCHAR
id|InlineReadSignature
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
r_int
id|index
)paren
(brace
id|UCHAR
id|status
suffix:semicolon
id|UCHAR
id|spigot
op_assign
l_int|1
op_lshift
id|index
suffix:semicolon
id|ULONG
id|zl
op_assign
id|pdev-&gt;lastsectorlba
(braket
id|index
)braket
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
op_or
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// select the spigot without interrupts
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
id|status
op_assign
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_READ
)paren
suffix:semicolon
id|status
op_assign
id|WaitDrq
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|1
)braket
suffix:semicolon
singleline_comment|// some drives assert DRQ before IRQ so let&squot;s make sure we clear the IRQ
id|WaitReady
(paren
id|padapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;DecodeError&t;:LOCAL&n; *&n; *&t;Description:&t;Decode and process device errors.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to adapter data.&n; *&t;&t;&t;&t;&t;status - Status register code.&n; *&n; *&t;Returns:&t;&t;The driver status code.&n; *&n; ****************************************************************/
DECL|function|DecodeError
r_static
id|ULONG
id|DecodeError
(paren
id|PADAPTER2220I
id|padapter
comma
id|UCHAR
id|status
)paren
(brace
id|UCHAR
id|error
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_WRITE_FAULT
)paren
(brace
r_return
id|DID_PARITY
op_lshift
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_BUSY
)paren
r_return
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|error
op_assign
id|inb_p
(paren
id|padapter-&gt;regError
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i error register: %x&quot;
comma
id|error
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|IDE_ERROR_AMNF
suffix:colon
r_case
id|IDE_ERROR_TKONF
suffix:colon
r_case
id|IDE_ERROR_ABRT
suffix:colon
r_case
id|IDE_ERROR_IDFN
suffix:colon
r_case
id|IDE_ERROR_UNC
suffix:colon
r_case
id|IDE_ERROR_BBK
suffix:colon
r_default
suffix:colon
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;StartTimer&t;:LOCAL&n; *&n; *&t;Description:&t;Start the timer.&n; *&n; *&t;Parameters:&t;&t;ipadapter - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|StartTimer
r_static
r_void
id|StartTimer
(paren
id|PADAPTER2220I
id|padapter
)paren
(brace
id|padapter-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TIMEOUT_DATA
suffix:semicolon
id|add_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;WriteSignature&t;:LOCAL&n; *&n; *&t;Description:&t;Start the timer.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to our device.&n; *&t;&t;&t;&t;&t;spigot&t; - Selected spigot.&n; *&t;&t;&t;&t;&t;index&t; - index of mirror signature on device.&n; *&n; *&t;Returns:&t;&t;TRUE on any error.&n; *&n; ****************************************************************/
DECL|function|WriteSignature
r_static
r_int
id|WriteSignature
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
comma
id|UCHAR
id|spigot
comma
r_int
id|index
)paren
(brace
id|ULONG
id|zl
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|spigot
)paren
suffix:semicolon
id|zl
op_assign
id|pdev-&gt;lastsectorlba
(braket
id|index
)braket
suffix:semicolon
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|zl
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|IDE_COMMAND_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitDrq
(paren
id|padapter
)paren
)paren
r_return
id|TRUE
suffix:semicolon
id|StartTimer
(paren
id|padapter
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|padapter-&gt;kBuffer
(braket
id|DISK_MIRROR_POSITION
)braket
)paren
)paren
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|ULONG
op_star
)paren
(paren
op_amp
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
)paren
)paren
(braket
l_int|1
)braket
suffix:semicolon
id|outsw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************************************&n; *&t;Name:&t;&t;&t;InitFailover&n; *&n; *&t;Description:&t;This is the beginning of the failover routine&n; *&n; *&t;Parameters:&t;&t;SCpnt&t; - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;padapter - Pointer adapter data structure.&n; *&t;&t;&t;&t;&t;pdev&t; - Pointer to our device.&n; *&t;&n; *&t;Returns:&t;&t;TRUE on error.&n; *&n; ******************************************************************************************************/
DECL|function|InitFailover
r_static
r_int
id|InitFailover
(paren
id|PADAPTER2220I
id|padapter
comma
id|POUR_DEVICE
id|pdev
)paren
(brace
id|UCHAR
id|spigot
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i:  Initialize failover process - survivor = %d&quot;
comma
id|padapter-&gt;survivor
)paren
)paren
suffix:semicolon
id|pdev-&gt;raid
op_assign
id|FALSE
suffix:semicolon
singleline_comment|//initializes system for non raid mode
id|pdev-&gt;hotRecon
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
id|spigot
op_assign
(paren
id|padapter-&gt;survivor
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
id|padapter-&gt;survivor
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_return
(paren
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HardReset
(paren
id|padapter
comma
id|pdev
comma
id|spigot
)paren
)paren
r_return
id|TRUE
suffix:semicolon
id|outb_p
(paren
l_int|0x3C
op_or
id|spigot
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
singleline_comment|// sound alarm and set fail light&t;&t;
id|pdev-&gt;DiskMirror
(braket
id|padapter-&gt;survivor
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
singleline_comment|//clear present status
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|spigot
comma
id|padapter-&gt;survivor
)paren
)paren
r_return
id|TRUE
suffix:semicolon
id|padapter-&gt;failinprog
op_assign
id|TRUE
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;TimerExpiry&t;:LOCAL&n; *&n; *&t;Description:&t;Timer expiry routine.&n; *&n; *&t;Parameters:&t;&t;data - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|TimerExpiry
r_static
r_void
id|TimerExpiry
(paren
r_int
r_int
id|data
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
(paren
id|PADAPTER2220I
)paren
id|data
suffix:semicolon
id|POUR_DEVICE
id|pdev
op_assign
id|padapter-&gt;pdev
suffix:semicolon
id|UCHAR
id|status
op_assign
id|IDE_STATUS_BUSY
suffix:semicolon
id|UCHAR
id|temp
comma
id|temp1
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
r_int
id|flags
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
multiline_comment|/* Disable interrupts, if they aren&squot;t already disabled. */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
multiline_comment|/*&n;     * Disable interrupts, if they aren&squot;t already disabled and acquire&n;     * the I/O spinlock.&n;     */
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;nPCI2220I: Timeout expired &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;failinprog
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in failover process&quot;
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
)paren
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
r_while
c_loop
(paren
id|padapter-&gt;reconPhase
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in recon phase %X&quot;
comma
id|padapter-&gt;reconPhase
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
r_case
id|RECON_PHASE_MARKING
suffix:colon
r_case
id|RECON_PHASE_LAST
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 1&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_READY
suffix:colon
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_COPY
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 2&quot;
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;n       spig/stat = %X&quot;
comma
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
)paren
suffix:semicolon
r_if
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_UPDATE
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 3&quot;
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_case
id|RECON_PHASE_END
suffix:colon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 4&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|timerExpiryDone
suffix:semicolon
r_default
suffix:colon
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|padapter-&gt;cmd
)paren
(brace
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// cancel interrupt from DMA engine
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
r_if
c_cond
(paren
id|padapter-&gt;cmd
op_eq
id|WRITE_CMD
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in RAID write operation&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_amp
l_int|1
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|0x81
)paren
suffix:semicolon
singleline_comment|// Masking the interrupt during spigot select
id|temp
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
)brace
r_else
id|temp
op_assign
id|IDE_STATUS_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|padapter-&gt;regStatSel
)paren
op_amp
l_int|2
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|0x82
)paren
suffix:semicolon
singleline_comment|// Masking the interrupt during spigot select
id|temp1
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
)brace
r_else
id|temp1
op_assign
id|IDE_STATUS_BUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|IDE_STATUS_BUSY
)paren
op_logical_or
(paren
id|temp1
op_amp
id|IDE_STATUS_BUSY
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|IDE_STATUS_BUSY
)paren
op_logical_and
(paren
id|temp1
op_amp
id|IDE_STATUS_BUSY
)paren
)paren
(brace
id|status
op_assign
id|temp
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|temp
op_amp
id|IDE_STATUS_BUSY
)paren
id|padapter-&gt;survivor
op_assign
l_int|1
suffix:semicolon
r_else
id|padapter-&gt;survivor
op_assign
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 5&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in RAID read operation&quot;
)paren
)paren
suffix:semicolon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 6&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|timerExpiryDone
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;in I/O operation&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
id|timerExpiryDone
suffix:colon
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
multiline_comment|/*&n;     * Restore the original flags which will enable interrupts&n;     * if and only if they were enabled on entry.&n;     */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
multiline_comment|/*&n;     * Release the I/O spinlock and restore the original flags&n;     * which will enable interrupts if and only if they were&n;     * enabled on entry.&n;     */
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;SetReconstruct&t;:LOCAL&n; *&n; *&t;Description:&t;Set the reconstruct up.&n; *&n; *&t;Parameters:&t;&t;pdev&t;- Pointer to device structure.&n; *&t;&t;&t;&t;&t;index&t;- Mirror index number.&n; *&n; *&t;Returns:&t;&t;Number of sectors on new disk required.&n; *&n; ****************************************************************/
DECL|function|SetReconstruct
r_static
id|LONG
id|SetReconstruct
(paren
id|POUR_DEVICE
id|pdev
comma
r_int
id|index
)paren
(brace
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
suffix:semicolon
singleline_comment|// setup the flags
id|pdev-&gt;DiskMirror
(braket
id|index
op_xor
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_REBUILD
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
id|index
op_xor
l_int|1
)braket
dot
id|reconstructPoint
op_assign
l_int|0
suffix:semicolon
singleline_comment|// start the reconstruct
id|pdev-&gt;reconCount
op_assign
l_int|1990
suffix:semicolon
singleline_comment|// mark target drive early
id|pdev-&gt;hotRecon
op_assign
l_int|1
op_rshift
id|index
suffix:semicolon
r_return
id|pdev-&gt;DiskMirror
(braket
id|index
)braket
dot
id|reconstructPoint
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;ReconTimerExpiry&t;:LOCAL&n; *&n; *&t;Description:&t;Reconstruct timer expiry routine.&n; *&n; *&t;Parameters:&t;&t;data - Pointer adapter data structure.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|ReconTimerExpiry
r_static
r_void
id|ReconTimerExpiry
(paren
r_int
r_int
id|data
)paren
(brace
id|PADAPTER2220I
id|padapter
suffix:semicolon
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|ULONG
id|testsize
op_assign
l_int|0
suffix:semicolon
id|PIDENTIFY_DATA
id|pid
suffix:semicolon
id|USHORT
id|minmode
suffix:semicolon
id|ULONG
id|zl
suffix:semicolon
id|UCHAR
id|zc
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
r_int
id|flags
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
multiline_comment|/* Disable interrupts, if they aren&squot;t already disabled. */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
multiline_comment|/*&n;     * Disable interrupts, if they aren&squot;t already disabled and acquire&n;     * the I/O spinlock.&n;     */
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
id|padapter
op_assign
(paren
id|PADAPTER2220I
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;SCpnt
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|pdev
op_assign
id|padapter-&gt;device
suffix:semicolon
id|pid
op_assign
(paren
id|PIDENTIFY_DATA
)paren
id|padapter-&gt;kBuffer
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconIsStarting
)paren
(brace
id|padapter-&gt;reconIsStarting
op_assign
id|FALSE
suffix:semicolon
id|padapter-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
id|pdev-&gt;hotRecon
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|pairIdentifier
op_eq
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|pairIdentifier
op_xor
l_int|1
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_MATCHED
)paren
op_logical_and
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_MATCHED
)paren
)paren
(brace
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
singleline_comment|// is first drive survivor?
id|testsize
op_assign
id|SetReconstruct
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
singleline_comment|// is second drive survivor?
id|testsize
op_assign
id|SetReconstruct
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
(brace
id|pdev-&gt;hotRecon
op_assign
l_int|1
suffix:semicolon
id|pdev-&gt;mirrorRecon
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pdev-&gt;hotRecon
op_assign
l_int|2
suffix:semicolon
id|pdev-&gt;mirrorRecon
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;hotRecon
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|zc
op_assign
(paren
(paren
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
op_rshift
l_int|3
)paren
op_or
id|inb_p
(paren
id|padapter-&gt;regStatSel
)paren
)paren
op_amp
l_int|0x83
suffix:semicolon
singleline_comment|// mute the alarm
id|outb_p
(paren
id|zc
op_or
id|pdev-&gt;hotRecon
op_or
l_int|0x40
comma
id|padapter-&gt;regFail
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|HardReset
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;hotRecon
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 1&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pdev-&gt;lastsectorlba
(braket
id|pdev-&gt;mirrorRecon
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
id|pdev-&gt;hotRecon
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;lastsectorlba
(braket
id|pdev-&gt;mirrorRecon
)braket
OL
id|testsize
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 2 %ld %ld&quot;
comma
id|pdev-&gt;lastsectorlba
(braket
id|pdev-&gt;mirrorRecon
)braket
comma
id|testsize
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// test LBA and multiper sector transfer compatability
r_if
c_cond
(paren
op_logical_neg
id|pid-&gt;SupportLBA
op_logical_or
(paren
id|pid-&gt;NumSectorsPerInt
OL
id|SECTORSXFER
)paren
op_logical_or
op_logical_neg
id|pid-&gt;Valid_64_70
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 3&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// test PIO/bus matering mode compatability
r_if
c_cond
(paren
(paren
id|pid-&gt;MinPIOCycleWithoutFlow
OG
l_int|240
)paren
op_logical_and
op_logical_neg
id|pid-&gt;SupportIORDYDisable
op_logical_and
op_logical_neg
id|padapter-&gt;timingPIO
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 4&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCycleWithoutFlow
op_le
l_int|120
)paren
singleline_comment|// setup timing mode of drive
id|minmode
op_assign
l_int|5
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCylceWithFlow
op_le
l_int|150
)paren
id|minmode
op_assign
l_int|4
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCylceWithFlow
op_le
l_int|180
)paren
id|minmode
op_assign
l_int|3
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pid-&gt;MinPIOCylceWithFlow
op_le
l_int|240
)paren
id|minmode
op_assign
l_int|2
suffix:semicolon
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: sub 5&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|padapter-&gt;timingMode
OG
id|minmode
)paren
singleline_comment|// set minimum timing mode
id|padapter-&gt;timingMode
op_assign
id|minmode
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingMode
op_ge
l_int|2
)paren
id|padapter-&gt;timingAddress
op_assign
id|ModeArray
(braket
id|padapter-&gt;timingMode
op_minus
l_int|2
)braket
suffix:semicolon
r_else
id|padapter-&gt;timingPIO
op_assign
id|TRUE
suffix:semicolon
id|padapter-&gt;reconOn
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;reconOn
)paren
(brace
id|pdev-&gt;hotRecon
op_assign
id|FALSE
suffix:semicolon
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_FAILOVER
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 7&quot;
)paren
)paren
suffix:semicolon
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|pdev-&gt;raid
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigot
comma
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)paren
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_MARKING
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
singleline_comment|//**********************************
singleline_comment|// reconstruct copy starts here&t;
singleline_comment|//**********************************
r_if
c_cond
(paren
id|pdev-&gt;reconCount
op_increment
OG
l_int|2000
)paren
(brace
id|pdev-&gt;reconCount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;hotRecon
comma
id|pdev-&gt;mirrorRecon
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_FAILOVER
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 8&quot;
)paren
)paren
suffix:semicolon
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_UPDATE
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|zl
op_assign
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
)braket
dot
id|reconstructPoint
suffix:semicolon
id|padapter-&gt;reconSize
op_assign
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)braket
dot
id|reconstructPoint
op_minus
id|zl
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconSize
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
id|padapter-&gt;reconSize
op_assign
id|MAX_BUS_MASTER_BLOCKS
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconSize
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// select the spigots
id|outb_p
(paren
id|pdev-&gt;byte6
op_or
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|3
)braket
comma
id|padapter-&gt;regLba24
)paren
suffix:semicolon
singleline_comment|// select the drive
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;hotRecon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitReady
(paren
id|padapter
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_FAILOVER
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 9&quot;
)paren
)paren
suffix:semicolon
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|SelectSpigot
(paren
id|padapter
comma
l_int|3
)paren
suffix:semicolon
id|outb_p
(paren
id|padapter-&gt;reconSize
op_amp
l_int|0xFF
comma
id|padapter-&gt;regSectCount
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|0
)braket
comma
id|padapter-&gt;regLba0
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|1
)braket
comma
id|padapter-&gt;regLba8
)paren
suffix:semicolon
id|outb_p
(paren
(paren
(paren
id|UCHAR
op_star
)paren
(paren
op_amp
id|zl
)paren
)paren
(braket
l_int|2
)braket
comma
id|padapter-&gt;regLba16
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_READY
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;hotRecon
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|WRITE_CMD
)paren
suffix:semicolon
id|StartTimer
(paren
id|padapter
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
id|WriteCommand
(paren
id|padapter
comma
id|READ_CMD
)paren
suffix:semicolon
r_goto
id|reconTimerExpiry
suffix:semicolon
)brace
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_MATCHED
suffix:semicolon
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_MATCHED
suffix:semicolon
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;spigot
comma
id|pdev-&gt;mirrorRecon
op_xor
l_int|1
)paren
)paren
r_goto
id|reconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_LAST
suffix:semicolon
id|reconTimerExpiry
suffix:colon
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
multiline_comment|/*&n;     * Restore the original flags which will enable interrupts&n;     * if and only if they were enabled on entry.&n;     */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
multiline_comment|/*&n;     * Release the I/O spinlock and restore the original flags&n;     * which will enable interrupts if and only if they were&n;     * enabled on entry.&n;     */
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Irq_Handler&t;:LOCAL&n; *&n; *&t;Description:&t;Interrupt handler.&n; *&n; *&t;Parameters:&t;&t;irq&t;&t;- Hardware IRQ number.&n; *&t;&t;&t;&t;&t;dev_id&t;-&n; *&t;&t;&t;&t;&t;regs&t;-&n; *&n; *&t;Returns:&t;&t;TRUE if drive is not ready in time.&n; *&n; ****************************************************************/
DECL|function|Irq_Handler
r_static
r_void
id|Irq_Handler
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// Pointer to host data block
id|PADAPTER2220I
id|padapter
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|UCHAR
id|status
suffix:semicolon
id|UCHAR
id|status1
suffix:semicolon
r_int
id|z
suffix:semicolon
id|ULONG
id|zl
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
r_int
id|flags
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
multiline_comment|/* Disable interrupts, if they aren&squot;t already disabled. */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
multiline_comment|/*&n;     * Disable interrupts, if they aren&squot;t already disabled and acquire&n;     * the I/O spinlock.&n;     */
id|spin_lock_irqsave
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
singleline_comment|//&t;DEB (printk (&quot;&bslash;npci2220i recieved interrupt&bslash;n&quot;));
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|NumAdapters
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// scan for interrupt to process
(brace
r_if
c_cond
(paren
id|PsiHost
(braket
id|z
)braket
op_member_access_from_pointer
id|irq
op_eq
(paren
id|UCHAR
)paren
(paren
id|irq
op_amp
l_int|0xFF
)paren
)paren
(brace
r_if
c_cond
(paren
id|inw_p
(paren
id|HOSTDATA
c_func
(paren
id|PsiHost
(braket
id|z
)braket
)paren
op_member_access_from_pointer
id|regIrqControl
)paren
op_amp
l_int|0x8000
)paren
(brace
id|shost
op_assign
id|PsiHost
(braket
id|z
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: not my interrupt&quot;
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|shost
)paren
suffix:semicolon
id|pdev
op_assign
id|padapter-&gt;pdev
suffix:semicolon
id|SCpnt
op_assign
id|padapter-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;expectingIRQ
op_logical_or
op_logical_neg
(paren
id|SCpnt
op_logical_or
id|padapter-&gt;reconPhase
)paren
)paren
(brace
id|DEB
c_func
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i Unsolicited interrupt&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|STOP_HERE
(paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|outb_p
(paren
l_int|0x08
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// cancel interrupt from DMA engine
r_if
c_cond
(paren
id|padapter-&gt;failinprog
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i interrupt failover complete&quot;
)paren
)paren
suffix:semicolon
id|padapter-&gt;failinprog
op_assign
id|FALSE
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: interrupt failover error from drive %X&quot;
comma
id|status
)paren
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: restarting failed opertation.&quot;
)paren
)paren
suffix:semicolon
id|pdev-&gt;spigot
op_assign
(paren
id|padapter-&gt;survivor
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_else
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|SCpnt-&gt;scsi_done
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
r_switch
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
(brace
r_case
id|RECON_PHASE_MARKING
suffix:colon
r_case
id|RECON_PHASE_LAST
suffix:colon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
op_eq
id|RECON_PHASE_LAST
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 10&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|WriteSignature
(paren
id|padapter
comma
id|pdev
comma
id|pdev-&gt;hotRecon
comma
id|pdev-&gt;mirrorRecon
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 11&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_END
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
r_case
id|RECON_PHASE_READY
suffix:colon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;hotRecon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WaitDrq
(paren
id|padapter
)paren
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 12&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
l_int|0x40
)paren
suffix:semicolon
id|padapter-&gt;reconPhase
op_assign
id|RECON_PHASE_COPY
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;kBuffer
comma
id|padapter-&gt;reconSize
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|outl
(paren
id|padapter-&gt;timingAddress
comma
id|padapter-&gt;regDmaAddrLoc
)paren
suffix:semicolon
id|outl
(paren
id|virt_to_bus
(paren
id|padapter-&gt;kBuffer
)paren
comma
id|padapter-&gt;regDmaAddrPci
)paren
suffix:semicolon
id|outl
(paren
id|padapter-&gt;reconSize
op_star
id|BYTES_PER_SECTOR
comma
id|padapter-&gt;regDmaCount
)paren
suffix:semicolon
id|outb_p
(paren
l_int|8
comma
id|padapter-&gt;regDmaDesc
)paren
suffix:semicolon
singleline_comment|// read operation
id|outb_p
(paren
l_int|1
comma
id|padapter-&gt;regDmaMode
)paren
suffix:semicolon
singleline_comment|// no interrupt
id|outb_p
(paren
l_int|0x03
comma
id|padapter-&gt;regDmaCmdStat
)paren
suffix:semicolon
singleline_comment|// kick the DMA engine in gear
)brace
r_goto
id|irq_return
suffix:semicolon
r_case
id|RECON_PHASE_COPY
suffix:colon
id|pdev-&gt;DiskMirror
(braket
id|pdev-&gt;mirrorRecon
)braket
dot
id|reconstructPoint
op_add_assign
id|padapter-&gt;reconSize
suffix:semicolon
r_case
id|RECON_PHASE_UPDATE
suffix:colon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;hotRecon
op_or
l_int|0x80
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 13&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
r_case
id|RECON_PHASE_END
suffix:colon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 14&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
id|OpDone
(paren
id|padapter
comma
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|padapter-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
id|pdev-&gt;hotRecon
op_assign
l_int|0
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
r_default
suffix:colon
r_goto
id|irq_return
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|padapter-&gt;cmd
)paren
singleline_comment|// decide how to handle the interrupt
(brace
r_case
id|READ_CMD
suffix:colon
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 15&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;timingPIO
)paren
(brace
id|zl
op_assign
(paren
id|padapter-&gt;sectorCount
OG
id|MAX_BUS_MASTER_BLOCKS
)paren
ques
c_cond
id|MAX_BUS_MASTER_BLOCKS
suffix:colon
id|padapter-&gt;sectorCount
suffix:semicolon
id|insw
(paren
id|padapter-&gt;regData
comma
id|padapter-&gt;buffer
comma
id|zl
op_star
(paren
id|BYTES_PER_SECTOR
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_sub_assign
id|zl
suffix:semicolon
id|padapter-&gt;buffer
op_add_assign
id|zl
op_star
id|BYTES_PER_SECTOR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;sectorCount
)paren
(brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|BusMaster
(paren
id|padapter
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE_CMD
suffix:colon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
l_int|0x80
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
id|status1
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
)brace
r_else
id|status1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;raid
op_logical_and
op_logical_neg
(paren
id|status1
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
op_or
l_int|0x80
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 16  status = %X  error = %X&quot;
comma
id|status
comma
id|inb_p
(paren
id|padapter-&gt;regError
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
r_if
c_cond
(paren
id|status1
op_amp
(paren
id|IDE_STATUS_ERROR
op_or
id|IDE_STATUS_WRITE_FAULT
)paren
)paren
(brace
id|padapter-&gt;survivor
op_assign
id|pdev-&gt;spigot
op_rshift
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 17  status = %X  error = %X&quot;
comma
id|status1
comma
id|inb_p
(paren
id|padapter-&gt;regError
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
id|status
op_assign
id|status1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
id|status
op_assign
id|WriteDataBoth
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|status
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 18&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_goto
id|irq_return
suffix:semicolon
id|SelectSpigot
(paren
id|padapter
comma
id|status
op_or
l_int|0x80
)paren
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
singleline_comment|// read the device status
r_break
suffix:semicolon
)brace
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;sectorCount
)paren
(brace
id|SelectSpigot
(paren
id|padapter
comma
id|pdev-&gt;spigot
)paren
suffix:semicolon
id|status
op_assign
id|WriteData
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
id|TRUE
suffix:semicolon
r_goto
id|irq_return
suffix:semicolon
)brace
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IDE_COMMAND_IDENTIFY
suffix:colon
(brace
id|PINQUIRYDATA
id|pinquiryData
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|PIDENTIFY_DATA
id|pid
op_assign
(paren
id|PIDENTIFY_DATA
)paren
id|padapter-&gt;kBuffer
suffix:semicolon
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regStatCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IDE_STATUS_DRQ
)paren
(brace
id|insw
(paren
id|padapter-&gt;regData
comma
id|pid
comma
r_sizeof
(paren
id|IDENTIFY_DATA
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|memset
(paren
id|pinquiryData
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
singleline_comment|// Zero INQUIRY data structure.
id|pinquiryData-&gt;DeviceType
op_assign
l_int|0
suffix:semicolon
id|pinquiryData-&gt;Versions
op_assign
l_int|2
suffix:semicolon
id|pinquiryData-&gt;AdditionalLength
op_assign
l_int|35
op_minus
l_int|4
suffix:semicolon
singleline_comment|// Fill in vendor identification fields.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|20
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;VendorId
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;ModelNumber
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;VendorId
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;ModelNumber
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
singleline_comment|// Initialize unused portion of product id.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_increment
)paren
id|pinquiryData-&gt;ProductId
(braket
l_int|12
op_plus
id|z
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
singleline_comment|// Move firmware revision from IDENTIFY data to
singleline_comment|// product revision in INQUIRY data.
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|4
suffix:semicolon
id|z
op_add_assign
l_int|2
)paren
(brace
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;FirmwareRevision
)paren
(braket
id|z
op_plus
l_int|1
)braket
suffix:semicolon
id|pinquiryData-&gt;ProductRevisionLevel
(braket
id|z
op_plus
l_int|1
)braket
op_assign
(paren
(paren
id|UCHAR
op_star
)paren
id|pid-&gt;FirmwareRevision
)paren
(braket
id|z
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev
op_eq
id|padapter-&gt;device
)paren
op_star
(paren
(paren
id|USHORT
op_star
)paren
(paren
op_amp
id|pinquiryData-&gt;VendorSpecific
)paren
)paren
op_assign
id|DEVICE_DALE_1
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i Interupt hanlder return error&quot;
)paren
)paren
suffix:semicolon
id|zl
op_assign
id|DecodeError
(paren
id|padapter
comma
id|status
)paren
suffix:semicolon
)brace
r_else
id|zl
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|zl
)paren
suffix:semicolon
id|irq_return
suffix:colon
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(2,1,95)
multiline_comment|/*&n;     * Restore the original flags which will enable interrupts&n;     * if and only if they were enabled on entry.&n;     */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v2.1.95 */
multiline_comment|/*&n;     * Release the I/O spinlock and restore the original flags&n;     * which will enable interrupts if and only if they were&n;     * enabled on entry.&n;     */
id|spin_unlock_irqrestore
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v2.1.95 */
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_QueueCommand&n; *&n; *&t;Description:&t;Process a queued command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;done  - Pointer to done function to call.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_QueueCommand
r_int
id|Pci2220i_QueueCommand
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|UCHAR
op_star
id|cdb
op_assign
(paren
id|UCHAR
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
singleline_comment|// Pointer to SCSI CDB
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|SCpnt-&gt;host
)paren
suffix:semicolon
singleline_comment|// Pointer to adapter control structure
id|POUR_DEVICE
id|pdev
op_assign
op_amp
id|padapter-&gt;device
(braket
id|SCpnt-&gt;target
)braket
suffix:semicolon
singleline_comment|// Pointer to device information
id|UCHAR
id|rc
suffix:semicolon
singleline_comment|// command return code
r_int
id|z
suffix:semicolon
id|PDEVICE_RAID1
id|pdr
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|padapter-&gt;buffer
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|padapter-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
singleline_comment|// Save this command data
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pci2220i_queuecommand: %02X: done can&squot;t be NULL&bslash;n&quot;
comma
op_star
id|cdb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconTimer.data
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;device
op_logical_or
id|SCpnt-&gt;lun
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
op_star
id|cdb
)paren
(brace
r_case
id|SCSIOP_INQUIRY
suffix:colon
singleline_comment|// inquiry CDB
(brace
r_if
c_cond
(paren
id|cdb
(braket
l_int|2
)braket
op_eq
id|SC_MY_RAID
)paren
(brace
r_switch
c_cond
(paren
id|cdb
(braket
l_int|3
)braket
)paren
(brace
r_case
id|MY_SCSI_REBUILD
suffix:colon
id|padapter-&gt;reconOn
op_assign
id|padapter-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MY_SCSI_ALARMMUTE
suffix:colon
id|MuteAlarm
(paren
id|padapter
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MY_SCSI_DEMOFAIL
suffix:colon
id|padapter-&gt;demoFail
op_assign
id|TRUE
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|z
op_assign
id|cdb
(braket
l_int|5
)braket
suffix:semicolon
singleline_comment|// get index
id|pdr
op_assign
(paren
id|PDEVICE_RAID1
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;raidData
(braket
id|z
)braket
)paren
(brace
id|memcpy
(paren
op_amp
id|pdr-&gt;DiskRaid1
comma
id|padapter-&gt;raidData
(braket
id|z
)braket
comma
r_sizeof
(paren
id|DISK_MIRROR
)paren
)paren
suffix:semicolon
id|pdr-&gt;TotalSectors
op_assign
id|padapter-&gt;device
(braket
l_int|0
)braket
dot
id|blocks
suffix:semicolon
)brace
r_else
id|memset
(paren
id|pdr
comma
l_int|0
comma
r_sizeof
(paren
id|DEVICE_RAID1
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|padapter-&gt;cmd
op_assign
id|IDE_COMMAND_IDENTIFY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SCSIOP_TEST_UNIT_READY
suffix:colon
singleline_comment|// test unit ready CDB
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSIOP_READ_CAPACITY
suffix:colon
singleline_comment|// read capctiy CDB
(brace
id|PREAD_CAPACITY_DATA
id|pdata
op_assign
(paren
id|PREAD_CAPACITY_DATA
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|pdata-&gt;blksiz
op_assign
l_int|0x20000
suffix:semicolon
id|XANY2SCSI
(paren
(paren
id|UCHAR
op_star
)paren
op_amp
id|pdata-&gt;blks
comma
id|pdev-&gt;blocks
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SCSIOP_VERIFY
suffix:colon
singleline_comment|// verify CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|IDE_COMMAND_VERIFY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ
suffix:colon
singleline_comment|// read10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|READ_CMD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_READ6
suffix:colon
singleline_comment|// read6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|READ_CMD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE
suffix:colon
singleline_comment|// write10 CDB
id|padapter-&gt;startSector
op_assign
id|XSCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|8
)braket
op_or
(paren
(paren
id|USHORT
)paren
id|cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|WRITE_CMD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSIOP_WRITE6
suffix:colon
singleline_comment|// write6  CDB
id|padapter-&gt;startSector
op_assign
id|SCSI2LONG
(paren
op_amp
id|cdb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|padapter-&gt;sectorCount
op_assign
id|cdb
(braket
l_int|4
)braket
suffix:semicolon
id|padapter-&gt;cmd
op_assign
id|WRITE_CMD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEB
(paren
id|printk
(paren
l_string|&quot;pci2220i_queuecommand: Unsupported command %02X&bslash;n&quot;
comma
op_star
id|cdb
)paren
)paren
suffix:semicolon
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
r_return
l_int|0
suffix:semicolon
id|padapter-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_while
c_loop
(paren
id|padapter-&gt;demoFail
)paren
(brace
id|padapter-&gt;demoFail
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;raid
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_or
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
id|padapter-&gt;survivor
op_assign
l_int|1
suffix:semicolon
r_else
id|padapter-&gt;survivor
op_assign
l_int|0
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 19&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_break
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|StartTimer
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;raid
op_logical_and
(paren
id|padapter-&gt;cmd
op_eq
id|WRITE_CMD
)paren
)paren
(brace
id|rc
op_assign
id|IdeCmdBoth
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|WriteDataBoth
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
id|padapter-&gt;survivor
op_assign
(paren
id|rc
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 20&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
(brace
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|rc
op_assign
id|IdeCmd
(paren
id|padapter
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|padapter-&gt;cmd
op_eq
id|WRITE_CMD
)paren
op_logical_and
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|WriteData
(paren
id|padapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;expectingIRQ
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;raid
)paren
(brace
id|padapter-&gt;survivor
op_assign
(paren
id|pdev-&gt;spigot
op_xor
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;&bslash;npci2220i: FAILURE 21&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|InitFailover
(paren
id|padapter
comma
id|pdev
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|OpDone
(paren
id|padapter
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|SCpnt-&gt;SCp.Status
op_increment
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Command&n; *&n; *&t;Description:&t;Process a command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Status code.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Command
r_int
id|Pci2220i_Command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|Pci2220i_QueueCommand
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|SCpnt-&gt;SCp.Status
)paren
id|barrier
(paren
)paren
suffix:semicolon
r_return
id|SCpnt-&gt;result
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;&t;&t;ReadFlash&n; *&n; *&t;Description:&t;Read information from controller Flash memory.&n; *&n; *&t;Parameters:&t;&t;padapter - Pointer to host interface data structure.&n; *&t;&t;&t;&t;&t;pdata&t; - Pointer to data structures.&n; *&t;&t;&t;&t;&t;base&t; - base address in Flash.&n; *&t;&t;&t;&t;&t;length&t; - lenght of data space in bytes.&n; *&n; *&t;Returns:&t;&t;Nothing.&n; *&n; ****************************************************************/
DECL|function|ReadFlash
id|VOID
id|ReadFlash
(paren
id|PADAPTER2220I
id|padapter
comma
id|VOID
op_star
id|pdata
comma
id|ULONG
id|base
comma
id|ULONG
id|length
)paren
(brace
id|ULONG
id|oldremap
suffix:semicolon
id|UCHAR
id|olddesc
suffix:semicolon
id|ULONG
id|z
suffix:semicolon
id|UCHAR
op_star
id|pd
op_assign
(paren
id|UCHAR
op_star
)paren
id|pdata
suffix:semicolon
id|oldremap
op_assign
id|inl
(paren
id|padapter-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// save values to restore later
id|olddesc
op_assign
id|inb_p
(paren
id|padapter-&gt;regDesc
)paren
suffix:semicolon
id|outl
(paren
id|base
op_or
l_int|1
comma
id|padapter-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// remap to Flash space as specified
id|outb_p
(paren
l_int|0x40
comma
id|padapter-&gt;regDesc
)paren
suffix:semicolon
singleline_comment|// describe remap region as 8 bit
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|length
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// get &quot;length&quot; data count
op_star
id|pd
op_increment
op_assign
id|inb_p
(paren
id|padapter-&gt;regBase
op_plus
id|z
)paren
suffix:semicolon
singleline_comment|// read in the data
id|outl
(paren
id|oldremap
comma
id|padapter-&gt;regRemap
)paren
suffix:semicolon
singleline_comment|// restore remap register values
id|outb_p
(paren
id|olddesc
comma
id|padapter-&gt;regDesc
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Detect&n; *&n; *&t;Description:&t;Detect and initialize our boards.&n; *&n; *&t;Parameters:&t;&t;tpnt - Pointer to SCSI host template structure.&n; *&n; *&t;Returns:&t;&t;Number of adapters installed.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Detect
r_int
id|Pci2220i_Detect
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|installed
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|pshost
suffix:semicolon
id|PADAPTER2220I
id|padapter
suffix:semicolon
r_int
id|unit
suffix:semicolon
r_int
id|z
suffix:semicolon
id|USHORT
id|zs
suffix:semicolon
id|USHORT
id|raidon
op_assign
id|FALSE
suffix:semicolon
r_int
id|setirq
suffix:semicolon
id|UCHAR
id|spigot1
op_assign
id|FALSE
suffix:semicolon
id|UCHAR
id|spigot2
op_assign
id|FALSE
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; LINUXVERSION(2,1,92)
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#else
id|UCHAR
id|pci_bus
comma
id|pci_device_fn
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt; LINUXVERSION(2,1,92)
r_if
c_cond
(paren
op_logical_neg
id|pci_present
(paren
)paren
)paren
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
(paren
)paren
)paren
macro_line|#endif
(brace
id|printk
(paren
l_string|&quot;pci2220i: PCI BIOS not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt; LINUXVERSION(2,1,92)
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
(paren
id|VENDOR_PSI
comma
id|DEVICE_DALE_1
comma
id|pdev
)paren
)paren
op_ne
l_int|NULL
)paren
macro_line|#else
r_while
c_loop
(paren
op_logical_neg
id|pcibios_find_device
(paren
id|VENDOR_PSI
comma
id|DEVICE_DALE_1
comma
id|found
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_device_fn
)paren
)paren
macro_line|#endif
(brace
id|pshost
op_assign
id|scsi_register
(paren
id|tpnt
comma
r_sizeof
(paren
id|ADAPTER2220I
)paren
)paren
suffix:semicolon
id|padapter
op_assign
id|HOSTDATA
c_func
(paren
id|pshost
)paren
suffix:semicolon
id|memset
(paren
id|padapter
comma
l_int|0
comma
r_sizeof
(paren
id|ADAPTER2220I
)paren
)paren
suffix:semicolon
id|zs
op_assign
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
suffix:semicolon
id|padapter-&gt;basePort
op_assign
id|zs
suffix:semicolon
id|padapter-&gt;regRemap
op_assign
id|zs
op_plus
id|RTR_LOCAL_REMAP
suffix:semicolon
singleline_comment|// 32 bit local space remap
id|padapter-&gt;regDesc
op_assign
id|zs
op_plus
id|RTR_REGIONS
suffix:semicolon
singleline_comment|// 32 bit local region descriptor
id|padapter-&gt;regRange
op_assign
id|zs
op_plus
id|RTR_LOCAL_RANGE
suffix:semicolon
singleline_comment|// 32 bit local range
id|padapter-&gt;regIrqControl
op_assign
id|zs
op_plus
id|RTR_INT_CONTROL_STATUS
suffix:semicolon
singleline_comment|// 16 bit interupt control and status
id|padapter-&gt;regScratchPad
op_assign
id|zs
op_plus
id|RTR_MAILBOX
suffix:semicolon
singleline_comment|// 16 byte scratchpad I/O base address
id|zs
op_assign
id|pdev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
suffix:semicolon
id|padapter-&gt;regBase
op_assign
id|zs
suffix:semicolon
id|padapter-&gt;regData
op_assign
id|zs
op_plus
id|REG_DATA
suffix:semicolon
singleline_comment|// data register I/O address
id|padapter-&gt;regError
op_assign
id|zs
op_plus
id|REG_ERROR
suffix:semicolon
singleline_comment|// error register I/O address
id|padapter-&gt;regSectCount
op_assign
id|zs
op_plus
id|REG_SECTOR_COUNT
suffix:semicolon
singleline_comment|// sector count register I/O address
id|padapter-&gt;regLba0
op_assign
id|zs
op_plus
id|REG_LBA_0
suffix:semicolon
singleline_comment|// least significant byte of LBA
id|padapter-&gt;regLba8
op_assign
id|zs
op_plus
id|REG_LBA_8
suffix:semicolon
singleline_comment|// next least significant byte of LBA
id|padapter-&gt;regLba16
op_assign
id|zs
op_plus
id|REG_LBA_16
suffix:semicolon
singleline_comment|// next most significan byte of LBA
id|padapter-&gt;regLba24
op_assign
id|zs
op_plus
id|REG_LBA_24
suffix:semicolon
singleline_comment|// head and most 4 significant bits of LBA
id|padapter-&gt;regStatCmd
op_assign
id|zs
op_plus
id|REG_STAT_CMD
suffix:semicolon
singleline_comment|// status on read and command on write register
id|padapter-&gt;regStatSel
op_assign
id|zs
op_plus
id|REG_STAT_SEL
suffix:semicolon
singleline_comment|// board status on read and spigot select on write register
id|padapter-&gt;regFail
op_assign
id|zs
op_plus
id|REG_FAIL
suffix:semicolon
id|padapter-&gt;regAltStat
op_assign
id|zs
op_plus
id|REG_ALT_STAT
suffix:semicolon
id|padapter-&gt;regDmaDesc
op_assign
id|zs
op_plus
id|RTL_DMA1_DESC_PTR
suffix:semicolon
singleline_comment|// address of the DMA discriptor register for direction of transfer
id|padapter-&gt;regDmaCmdStat
op_assign
id|zs
op_plus
id|RTL_DMA_COMMAND_STATUS
op_plus
l_int|1
suffix:semicolon
singleline_comment|// Byte #1 of DMA command status register
id|padapter-&gt;regDmaAddrPci
op_assign
id|zs
op_plus
id|RTL_DMA1_PCI_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for PCI address of DMA
id|padapter-&gt;regDmaAddrLoc
op_assign
id|zs
op_plus
id|RTL_DMA1_LOCAL_ADDR
suffix:semicolon
singleline_comment|// 32 bit register for local bus address of DMA
id|padapter-&gt;regDmaCount
op_assign
id|zs
op_plus
id|RTL_DMA1_COUNT
suffix:semicolon
singleline_comment|// 32 bit register for DMA transfer count
id|padapter-&gt;regDmaMode
op_assign
id|zs
op_plus
id|RTL_DMA1_MODE
op_plus
l_int|1
suffix:semicolon
singleline_comment|// 32 bit register for DMA mode control
r_if
c_cond
(paren
op_logical_neg
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_NUM_DRIVES
)paren
)paren
singleline_comment|// if no devices on this board
r_goto
id|unregister
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; LINUXVERSION(2,1,92)
id|pshost-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#else
id|pcibios_read_config_byte
(paren
id|pci_bus
comma
id|pci_device_fn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pshost-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
id|setirq
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|installed
suffix:semicolon
id|z
op_increment
)paren
singleline_comment|// scan for shared interrupts
(brace
r_if
c_cond
(paren
id|PsiHost
(braket
id|z
)braket
op_member_access_from_pointer
id|irq
op_eq
id|pshost-&gt;irq
)paren
singleline_comment|// if shared then, don&squot;t posses
id|setirq
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setirq
)paren
singleline_comment|// if not shared, posses
(brace
r_if
c_cond
(paren
id|request_irq
(paren
id|pshost-&gt;irq
comma
id|Irq_Handler
comma
id|SA_SHIRQ
comma
l_string|&quot;pci2220i&quot;
comma
id|padapter
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_irq
(paren
id|pshost-&gt;irq
comma
id|Irq_Handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;pci2220i&quot;
comma
id|padapter
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to allocate IRQ for PCI-2220I controller.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unregister
suffix:semicolon
)brace
)brace
id|padapter-&gt;irqOwned
op_assign
id|pshost-&gt;irq
suffix:semicolon
singleline_comment|// set IRQ as owned
)brace
id|padapter-&gt;kBuffer
op_assign
id|kmalloc
(paren
id|SECTORSXFER
op_star
id|BYTES_PER_SECTOR
comma
id|GFP_DMA
op_or
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|padapter-&gt;kBuffer
)paren
(brace
id|printk
(paren
l_string|&quot;Unable to allocate DMA buffer for PCI-2220I controller.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(1,3,70)
id|free_irq
(paren
id|pshost-&gt;irq
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v1.3.70 */
id|free_irq
(paren
id|pshost-&gt;irq
comma
id|padapter
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v1.3.70 */
r_goto
id|unregister
suffix:semicolon
)brace
id|PsiHost
(braket
id|installed
)braket
op_assign
id|pshost
suffix:semicolon
singleline_comment|// save SCSI_HOST pointer
id|pshost-&gt;io_port
op_assign
id|padapter-&gt;basePort
suffix:semicolon
id|pshost-&gt;n_io_port
op_assign
l_int|0xFF
suffix:semicolon
id|pshost-&gt;unique_id
op_assign
id|padapter-&gt;regBase
suffix:semicolon
id|pshost-&gt;max_id
op_assign
l_int|4
suffix:semicolon
id|outb_p
(paren
l_int|0x01
comma
id|padapter-&gt;regRange
)paren
suffix:semicolon
singleline_comment|// fix our range register because other drivers want to tromp on it
id|padapter-&gt;timingMode
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_TIMING_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;timingMode
op_ge
l_int|2
)paren
id|padapter-&gt;timingAddress
op_assign
id|ModeArray
(braket
id|padapter-&gt;timingMode
op_minus
l_int|2
)braket
suffix:semicolon
r_else
id|padapter-&gt;timingPIO
op_assign
id|TRUE
suffix:semicolon
id|ReadFlash
(paren
id|padapter
comma
op_amp
id|DaleSetup
comma
id|DALE_FLASH_SETUP
comma
r_sizeof
(paren
id|SETUP
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_NUM_DRIVES
)paren
suffix:semicolon
op_increment
id|z
)paren
(brace
id|unit
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_CHANNEL_DEVICE_0
op_plus
id|z
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|device
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_SCRATH_DEVICE_0
op_plus
id|unit
)paren
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|byte6
op_assign
(paren
id|UCHAR
)paren
(paren
(paren
(paren
id|unit
op_amp
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
l_int|0xE0
)paren
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|spigot
op_assign
(paren
id|UCHAR
)paren
(paren
l_int|1
op_lshift
(paren
id|unit
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|sectors
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|sectors
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|heads
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|heads
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|cylinders
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|cylinders
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|blocks
op_assign
id|DaleSetup.setupDevice
(braket
id|unit
)braket
dot
id|blocks
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|z
)paren
(brace
id|ReadFlash
(paren
id|padapter
comma
op_amp
id|DiskMirror
comma
id|DALE_FLASH_RAID
comma
r_sizeof
(paren
id|DiskMirror
)paren
)paren
suffix:semicolon
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_0_STATUS
)paren
suffix:semicolon
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_assign
id|inb_p
(paren
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_1_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|signature
op_eq
id|SIGNATURE
)paren
op_logical_and
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|pairIdentifier
op_eq
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|pairIdentifier
op_xor
l_int|1
)paren
)paren
)paren
(brace
id|raidon
op_assign
id|TRUE
suffix:semicolon
)brace
id|memcpy
(paren
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|DiskMirror
comma
id|DiskMirror
comma
r_sizeof
(paren
id|DiskMirror
)paren
)paren
suffix:semicolon
id|padapter-&gt;raidData
(braket
l_int|0
)braket
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|DiskMirror
(braket
l_int|0
)braket
suffix:semicolon
id|padapter-&gt;raidData
(braket
l_int|2
)braket
op_assign
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|DiskMirror
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|raidon
)paren
(brace
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|lastsectorlba
(braket
l_int|0
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|lastsectorlba
(braket
l_int|1
)braket
op_assign
id|InlineIdentify
(paren
id|padapter
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|lastsectorlba
(braket
l_int|0
)braket
)paren
id|spigot1
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
op_logical_and
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|lastsectorlba
(braket
l_int|1
)braket
)paren
id|spigot2
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
op_amp
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_SURVIVOR
)paren
id|spigot1
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|spigot1
op_logical_and
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|InlineReadSignature
(paren
id|padapter
comma
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spigot2
op_logical_and
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
id|InlineReadSignature
(paren
id|padapter
comma
op_amp
id|padapter-&gt;device
(braket
id|z
)braket
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spigot1
op_logical_and
id|spigot2
)paren
(brace
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|raid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|spigot
op_assign
l_int|2
suffix:semicolon
r_else
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|spigot
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
op_logical_or
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
)paren
(brace
id|padapter-&gt;reconOn
op_assign
id|padapter-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|spigot1
)paren
(brace
r_if
c_cond
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_goto
id|unregister
suffix:semicolon
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|spigot
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_amp
id|UCBF_REBUILD
)paren
r_goto
id|unregister
suffix:semicolon
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
op_assign
id|UCBF_MIRRORED
op_or
id|UCBF_SURVIVOR
suffix:semicolon
id|padapter-&gt;device
(braket
id|z
)braket
dot
id|spigot
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DaleSetup.rebootRebuil
)paren
id|padapter-&gt;reconOn
op_assign
id|padapter-&gt;reconIsStarting
op_assign
id|TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|init_timer
(paren
op_amp
id|padapter-&gt;timer
)paren
suffix:semicolon
id|padapter-&gt;timer.function
op_assign
id|TimerExpiry
suffix:semicolon
id|padapter-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|padapter
suffix:semicolon
id|init_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
id|padapter-&gt;reconTimer.function
op_assign
id|ReconTimerExpiry
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
(paren
r_int
r_int
)paren
id|padapter
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nPCI-2220I EIDE CONTROLLER: at I/O = %X/%X  IRQ = %d&bslash;n&quot;
comma
id|padapter-&gt;basePort
comma
id|padapter-&gt;regBase
comma
id|pshost-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Version %s, Compiled %s %s&bslash;n&bslash;n&quot;
comma
id|PCI2220I_VERSION
comma
id|__DATE__
comma
id|__TIME__
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|installed
OL
id|MAXADAPTER
)paren
r_continue
suffix:semicolon
r_break
suffix:semicolon
suffix:semicolon
id|unregister
suffix:colon
suffix:semicolon
id|scsi_unregister
(paren
id|pshost
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
id|NumAdapters
op_assign
id|installed
suffix:semicolon
r_return
id|installed
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Abort&n; *&n; *&t;Description:&t;Process the Abort command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;Allways snooze.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Abort
r_int
id|Pci2220i_Abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Reset&n; *&n; *&t;Description:&t;Process the Reset command from the SCSI manager.&n; *&n; *&t;Parameters:&t;&t;SCpnt - Pointer to SCSI command structure.&n; *&t;&t;&t;&t;&t;flags - Flags about the reset command&n; *&n; *&t;Returns:&t;&t;No active command at this time, so this means&n; *&t;&t;&t;&t;&t;that each time we got some kind of response the&n; *&t;&t;&t;&t;&t;last time through.  Tell the mid-level code to&n; *&t;&t;&t;&t;&t;request sense information in order to decide what&n; *&t;&t;&t;&t;&t;to do next.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Reset
r_int
id|Pci2220i_Reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_Release&n; *&n; *&t;Description:&t;Release resources allocated for a single each adapter.&n; *&n; *&t;Parameters:&t;&t;pshost - Pointer to SCSI command structure.&n; *&n; *&t;Returns:&t;&t;zero.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_Release
r_int
id|Pci2220i_Release
(paren
r_struct
id|Scsi_Host
op_star
id|pshost
)paren
(brace
id|PADAPTER2220I
id|padapter
op_assign
id|HOSTDATA
(paren
id|pshost
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconOn
)paren
(brace
id|padapter-&gt;reconOn
op_assign
id|FALSE
suffix:semicolon
singleline_comment|// shut down the hot reconstruct
r_if
c_cond
(paren
id|padapter-&gt;reconPhase
)paren
id|udelay
(paren
l_int|300000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;reconTimer.data
)paren
singleline_comment|// is the timer running?
(brace
id|del_timer
(paren
op_amp
id|padapter-&gt;reconTimer
)paren
suffix:semicolon
id|padapter-&gt;reconTimer.data
op_assign
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|// save RAID status on the board
id|outb_p
(paren
id|DiskMirror
(braket
l_int|0
)braket
dot
id|status
comma
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_0_STATUS
)paren
suffix:semicolon
id|outb_p
(paren
id|DiskMirror
(braket
l_int|1
)braket
dot
id|status
comma
id|padapter-&gt;regScratchPad
op_plus
id|DALE_RAID_1_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|padapter-&gt;irqOwned
)paren
macro_line|#if LINUX_VERSION_CODE &lt; LINUXVERSION(1,3,70)
id|free_irq
(paren
id|pshost-&gt;irq
)paren
suffix:semicolon
macro_line|#else /* version &gt;= v1.3.70 */
id|free_irq
(paren
id|pshost-&gt;irq
comma
id|padapter
)paren
suffix:semicolon
macro_line|#endif /* version &gt;= v1.3.70 */
id|release_region
(paren
id|pshost-&gt;io_port
comma
id|pshost-&gt;n_io_port
)paren
suffix:semicolon
id|kfree
(paren
id|padapter-&gt;kBuffer
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|pshost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#include &quot;sd.h&quot;
multiline_comment|/****************************************************************&n; *&t;Name:&t;Pci2220i_BiosParam&n; *&n; *&t;Description:&t;Process the biosparam request from the SCSI manager to&n; *&t;&t;&t;&t;&t;return C/H/S data.&n; *&n; *&t;Parameters:&t;&t;disk - Pointer to SCSI disk structure.&n; *&t;&t;&t;&t;&t;dev&t; - Major/minor number from kernel.&n; *&t;&t;&t;&t;&t;geom - Pointer to integer array to place geometry data.&n; *&n; *&t;Returns:&t;&t;zero.&n; *&n; ****************************************************************/
DECL|function|Pci2220i_BiosParam
r_int
id|Pci2220i_BiosParam
(paren
id|Scsi_Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|POUR_DEVICE
id|pdev
suffix:semicolon
id|pdev
op_assign
op_amp
(paren
id|HOSTDATA
c_func
(paren
id|disk-&gt;device-&gt;host
)paren
op_member_access_from_pointer
id|device
(braket
id|disk-&gt;device-&gt;id
)braket
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|pdev-&gt;heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|pdev-&gt;sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|pdev-&gt;cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|PCI2220I
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
