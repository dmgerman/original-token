multiline_comment|/**************************************************************************&n; * Initio A100 device driver for Linux.&n; *&n; * Copyright (c) 1994-1998 Initio Corporation&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; see the file COPYING.  If not, write to&n; * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * --------------------------------------------------------------------------&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification, immediately at the beginning of the file.&n; * 2. Redistributions in binary form must reproduce the above copyright&n; *    notice, this list of conditions and the following disclaimer in the&n; *    documentation and/or other materials provided with the distribution.&n; * 3. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Where this Software is combined with software released under the terms of &n; * the GNU Public License (&quot;GPL&quot;) and the terms of the GPL would require the &n; * combined work to also be released under the terms of the GPL, the terms&n; * and conditions of this License will apply in addition to those of the&n; * GPL with the exception of any terms or conditions of this License that&n; * conflict with, or are expressly prohibited by, the GPL.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; *************************************************************************&n; *&n; * module: i60uscsi.c &n; * DESCRIPTION:&n; * &t;This is the Linux low-level SCSI driver for Initio INIA100 SCSI host&n; * adapters&n; *&n; * 07/02/98 hl&t;- v.91n Initial drivers.&n; * 09/14/98 hl - v1.01 Support new Kernel.&n; * 09/22/98 hl - v1.01a Support reset.&n; * 09/24/98 hl - v1.01b Fixed reset.&n; * 10/05/98 hl - v1.02 split the source code and release.&n; * 12/19/98 bv - v1.02a Use spinlocks for 2.1.95 and up&n; * 01/31/99 bv - v1.02b Use mdelay instead of waitForPause&n; * 08/08/99 bv - v1.02c Use waitForPause again.&n; **************************************************************************/
macro_line|#ifndef CVT_LINUX_VERSION
DECL|macro|CVT_LINUX_VERSION
mdefine_line|#define CVT_LINUX_VERSION(V,P,S)        (V * 65536 + P * 256 + S)
macro_line|#endif
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;i60uscsi.h&quot;
DECL|macro|JIFFIES_TO_MS
mdefine_line|#define JIFFIES_TO_MS(t) ((t) * 1000 / HZ)
DECL|macro|MS_TO_JIFFIES
mdefine_line|#define MS_TO_JIFFIES(j) ((j * HZ) / 1000)
multiline_comment|/* ---- INTERNAL FUNCTIONS ---- */
r_static
id|UCHAR
id|waitChipReady
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|waitFWReady
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|waitFWReady
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|waitSCSIRSTdone
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|waitHDOoff
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|waitHDIset
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
id|UCHAR
op_star
id|pData
)paren
suffix:semicolon
r_static
r_int
r_int
id|get_FW_version
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|set_NVRAM
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
r_int
r_char
id|address
comma
r_int
r_char
id|value
)paren
suffix:semicolon
r_static
id|UCHAR
id|get_NVRAM
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
r_int
r_char
id|address
comma
r_int
r_char
op_star
id|pDataIn
)paren
suffix:semicolon
r_static
r_int
id|se2_rd_all
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
r_void
id|se2_update_all
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* setup default pattern        */
r_static
r_void
id|read_eeprom
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
id|UCHAR
id|load_FW
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
r_void
id|setup_SCBs
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
r_static
r_void
id|initAFlag
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
id|ORC_SCB
op_star
id|orc_alloc_scb
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* ---- EXTERNAL FUNCTIONS ---- */
r_extern
r_void
id|inia100SCBPost
c_func
(paren
id|BYTE
op_star
id|pHcb
comma
id|BYTE
op_star
id|pScb
)paren
suffix:semicolon
multiline_comment|/* ---- INTERNAL VARIABLES ---- */
DECL|variable|orc_hcs
id|ORC_HCS
id|orc_hcs
(braket
id|MAX_SUPPORTED_ADAPTERS
)braket
suffix:semicolon
DECL|variable|inia100_adpt
r_static
id|INIA100_ADPT_STRUCT
id|inia100_adpt
(braket
id|MAX_SUPPORTED_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/* set by inia100_setup according to the command line */
DECL|variable|orc_num_scb
r_int
id|orc_num_scb
suffix:semicolon
DECL|variable|nvram
DECL|variable|nvramp
id|NVRAM
id|nvram
comma
op_star
id|nvramp
op_assign
op_amp
id|nvram
suffix:semicolon
DECL|variable|dftNvRam
r_static
id|UCHAR
id|dftNvRam
(braket
l_int|64
)braket
op_assign
(brace
multiline_comment|/*----------header -------------*/
l_int|0x01
comma
multiline_comment|/* 0x00: Sub System Vendor ID 0 */
l_int|0x11
comma
multiline_comment|/* 0x01: Sub System Vendor ID 1 */
l_int|0x60
comma
multiline_comment|/* 0x02: Sub System ID 0        */
l_int|0x10
comma
multiline_comment|/* 0x03: Sub System ID 1        */
l_int|0x00
comma
multiline_comment|/* 0x04: SubClass               */
l_int|0x01
comma
multiline_comment|/* 0x05: Vendor ID 0            */
l_int|0x11
comma
multiline_comment|/* 0x06: Vendor ID 1            */
l_int|0x60
comma
multiline_comment|/* 0x07: Device ID 0            */
l_int|0x10
comma
multiline_comment|/* 0x08: Device ID 1            */
l_int|0x00
comma
multiline_comment|/* 0x09: Reserved               */
l_int|0x00
comma
multiline_comment|/* 0x0A: Reserved               */
l_int|0x01
comma
multiline_comment|/* 0x0B: Revision of Data Structure     */
multiline_comment|/* -- Host Adapter Structure --- */
l_int|0x01
comma
multiline_comment|/* 0x0C: Number Of SCSI Channel */
l_int|0x01
comma
multiline_comment|/* 0x0D: BIOS Configuration 1   */
l_int|0x00
comma
multiline_comment|/* 0x0E: BIOS Configuration 2   */
l_int|0x00
comma
multiline_comment|/* 0x0F: BIOS Configuration 3   */
multiline_comment|/* --- SCSI Channel 0 Configuration --- */
l_int|0x07
comma
multiline_comment|/* 0x10: H/A ID                 */
l_int|0x83
comma
multiline_comment|/* 0x11: Channel Configuration  */
l_int|0x20
comma
multiline_comment|/* 0x12: MAX TAG per target     */
l_int|0x0A
comma
multiline_comment|/* 0x13: SCSI Reset Recovering time     */
l_int|0x00
comma
multiline_comment|/* 0x14: Channel Configuration4 */
l_int|0x00
comma
multiline_comment|/* 0x15: Channel Configuration5 */
multiline_comment|/* SCSI Channel 0 Target Configuration  */
multiline_comment|/* 0x16-0x25                    */
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
multiline_comment|/* --- SCSI Channel 1 Configuration --- */
l_int|0x07
comma
multiline_comment|/* 0x26: H/A ID                 */
l_int|0x83
comma
multiline_comment|/* 0x27: Channel Configuration  */
l_int|0x20
comma
multiline_comment|/* 0x28: MAX TAG per target     */
l_int|0x0A
comma
multiline_comment|/* 0x29: SCSI Reset Recovering time     */
l_int|0x00
comma
multiline_comment|/* 0x2A: Channel Configuration4 */
l_int|0x00
comma
multiline_comment|/* 0x2B: Channel Configuration5 */
multiline_comment|/* SCSI Channel 1 Target Configuration  */
multiline_comment|/* 0x2C-0x3B                    */
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0xC8
comma
l_int|0x00
comma
multiline_comment|/* 0x3C: Reserved               */
l_int|0x00
comma
multiline_comment|/* 0x3D: Reserved               */
l_int|0x00
comma
multiline_comment|/* 0x3E: Reserved               */
l_int|0x00
multiline_comment|/* 0x3F: Checksum               */
)brace
suffix:semicolon
multiline_comment|/***************************************************************************/
DECL|function|waitForPause
r_static
r_void
id|waitForPause
c_func
(paren
r_int
id|amount
)paren
(brace
id|ULONG
id|the_time
op_assign
id|jiffies
op_plus
id|MS_TO_JIFFIES
c_func
(paren
id|amount
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= CVT_LINUX_VERSION(2,1,95)
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|the_time
)paren
)paren
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
id|jiffies
OL
id|the_time
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/***************************************************************************/
DECL|function|waitChipReady
id|UCHAR
id|waitChipReady
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait 1 second for report timeout     */
r_if
c_cond
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HCTRL
)paren
op_amp
id|HOSTSTOP
)paren
multiline_comment|/* Wait HOSTSTOP set */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
id|waitForPause
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* wait 100ms before try again  */
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|waitFWReady
id|UCHAR
id|waitFWReady
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait 1 second for report timeout     */
r_if
c_cond
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HSTUS
)paren
op_amp
id|RREADY
)paren
multiline_comment|/* Wait READY set */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
id|waitForPause
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* wait 100ms before try again  */
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|waitSCSIRSTdone
id|UCHAR
id|waitSCSIRSTdone
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait 1 second for report timeout     */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HCTRL
)paren
op_amp
id|SCSIRST
)paren
)paren
multiline_comment|/* Wait SCSIRST done */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
id|waitForPause
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* wait 100ms before try again  */
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|waitHDOoff
id|UCHAR
id|waitHDOoff
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait 1 second for report timeout     */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HCTRL
)paren
op_amp
id|HDO
)paren
)paren
multiline_comment|/* Wait HDO off */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
id|waitForPause
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* wait 100ms before try again  */
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|waitHDIset
id|UCHAR
id|waitHDIset
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
id|UCHAR
op_star
id|pData
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait 1 second for report timeout     */
r_if
c_cond
(paren
(paren
op_star
id|pData
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HSTUS
)paren
)paren
op_amp
id|HDI
)paren
r_return
(paren
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* Wait HDI set */
id|waitForPause
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* wait 100ms before try again  */
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|get_FW_version
r_int
r_int
id|get_FW_version
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|UCHAR
id|bData
suffix:semicolon
r_union
(brace
r_int
r_int
id|sVersion
suffix:semicolon
r_int
r_char
id|cVersion
(braket
l_int|2
)braket
suffix:semicolon
)brace
id|Version
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|ORC_CMD_VERSION
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDIset
c_func
(paren
id|hcsp
comma
op_amp
id|bData
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDI set   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|Version.cVersion
(braket
l_int|0
)braket
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HDATA
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HSTUS
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Clear HDI            */
r_if
c_cond
(paren
id|waitHDIset
c_func
(paren
id|hcsp
comma
op_amp
id|bData
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDI set   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|Version.cVersion
(braket
l_int|1
)braket
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HDATA
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HSTUS
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Clear HDI            */
r_return
(paren
id|Version.sVersion
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|set_NVRAM
id|UCHAR
id|set_NVRAM
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
r_int
r_char
id|address
comma
r_int
r_char
id|value
)paren
(brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|ORC_CMD_SET_NVM
)paren
suffix:semicolon
multiline_comment|/* Write command */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* Write address */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Write value  */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|get_NVRAM
id|UCHAR
id|get_NVRAM
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
r_int
r_char
id|address
comma
r_int
r_char
op_star
id|pDataIn
)paren
(brace
r_int
r_char
id|bData
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|ORC_CMD_GET_NVM
)paren
suffix:semicolon
multiline_comment|/* Write command */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* Write address */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDIset
c_func
(paren
id|hcsp
comma
op_amp
id|bData
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDI set   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
op_star
id|pDataIn
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HDATA
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HSTUS
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Clear HDI    */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|orc_exec_scb
r_void
id|orc_exec_scb
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
id|ORC_SCB
op_star
id|scbp
)paren
(brace
id|scbp-&gt;SCB_Status
op_assign
id|SCB_POST
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_PQUEUE
comma
id|scbp-&gt;SCB_ScbIdx
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; Read SCSI H/A configuration parameters from serial EEPROM&n;************************************************************************/
DECL|function|se2_rd_all
r_int
id|se2_rd_all
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
r_int
id|i
suffix:semicolon
id|UCHAR
op_star
id|np
comma
id|chksum
op_assign
l_int|0
suffix:semicolon
id|np
op_assign
(paren
id|UCHAR
op_star
)paren
id|nvramp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
comma
id|np
op_increment
)paren
(brace
multiline_comment|/* &lt;01&gt; */
r_if
c_cond
(paren
id|get_NVRAM
c_func
(paren
id|hcsp
comma
(paren
r_int
r_char
)paren
id|i
comma
id|np
)paren
op_eq
id|FALSE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|//      *np++ = get_NVRAM(hcsp, (unsigned char ) i);
)brace
multiline_comment|/*------ Is ckecksum ok ? ------*/
id|np
op_assign
(paren
id|UCHAR
op_star
)paren
id|nvramp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|63
suffix:semicolon
id|i
op_increment
)paren
id|chksum
op_add_assign
op_star
id|np
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nvramp-&gt;CheckSum
op_ne
(paren
id|UCHAR
)paren
id|chksum
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; Update SCSI H/A configuration parameters from serial EEPROM&n;*************************************************************************/
DECL|function|se2_update_all
r_void
id|se2_update_all
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
multiline_comment|/* setup default pattern  */
r_int
id|i
suffix:semicolon
id|UCHAR
op_star
id|np
comma
op_star
id|np1
comma
id|chksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Calculate checksum first   */
id|np
op_assign
(paren
id|UCHAR
op_star
)paren
id|dftNvRam
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|63
suffix:semicolon
id|i
op_increment
)paren
id|chksum
op_add_assign
op_star
id|np
op_increment
suffix:semicolon
op_star
id|np
op_assign
id|chksum
suffix:semicolon
id|np
op_assign
(paren
id|UCHAR
op_star
)paren
id|dftNvRam
suffix:semicolon
id|np1
op_assign
(paren
id|UCHAR
op_star
)paren
id|nvramp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
comma
id|np
op_increment
comma
id|np1
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|np
op_ne
op_star
id|np1
)paren
(brace
id|set_NVRAM
c_func
(paren
id|hcsp
comma
(paren
r_int
r_char
)paren
id|i
comma
op_star
id|np
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n; Function name  : read_eeprom&n;**************************************************************************/
DECL|function|read_eeprom
r_void
id|read_eeprom
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
r_if
c_cond
(paren
id|se2_rd_all
c_func
(paren
id|hcsp
)paren
op_ne
l_int|1
)paren
(brace
id|se2_update_all
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* setup default pattern        */
id|se2_rd_all
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* load again                   */
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|load_FW
id|UCHAR
id|load_FW
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|U32
id|dData
suffix:semicolon
id|USHORT
id|wBIOSAddress
suffix:semicolon
id|USHORT
id|i
suffix:semicolon
id|UCHAR
op_star
id|pData
comma
id|bData
suffix:semicolon
id|bData
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_GCFG
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GCFG
comma
id|bData
op_or
id|EEPRG
)paren
suffix:semicolon
multiline_comment|/* Enable EEPROM programming */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR2
comma
l_int|0x00
)paren
suffix:semicolon
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
op_ne
l_int|0x55
)paren
(brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GCFG
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Disable EEPROM programming */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
op_ne
l_int|0xAA
)paren
(brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GCFG
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Disable EEPROM programming */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_RISCCTL
comma
id|PRGMRST
op_or
id|DOWNLOAD
)paren
suffix:semicolon
multiline_comment|/* Enable SRAM programming */
id|pData
op_assign
(paren
id|UCHAR
op_star
)paren
op_amp
id|dData
suffix:semicolon
id|dData
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initial FW address to 0 */
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
l_int|0x10
)paren
suffix:semicolon
op_star
id|pData
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
suffix:semicolon
multiline_comment|/* Read from BIOS */
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
l_int|0x11
)paren
suffix:semicolon
op_star
(paren
id|pData
op_plus
l_int|1
)paren
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
suffix:semicolon
multiline_comment|/* Read from BIOS */
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
l_int|0x12
)paren
suffix:semicolon
op_star
(paren
id|pData
op_plus
l_int|2
)paren
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
suffix:semicolon
multiline_comment|/* Read from BIOS */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR2
comma
op_star
(paren
id|pData
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|ORC_WRLONG
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_FWBASEADR
comma
id|dData
)paren
suffix:semicolon
multiline_comment|/* Write FW address */
id|wBIOSAddress
op_assign
(paren
id|USHORT
)paren
id|dData
suffix:semicolon
multiline_comment|/* FW code locate at BIOS address + ? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|pData
op_assign
(paren
id|UCHAR
op_star
)paren
op_amp
id|dData
suffix:semicolon
multiline_comment|/* Download the code    */
id|i
OL
l_int|0x1000
suffix:semicolon
multiline_comment|/* Firmware code size = 4K      */
id|i
op_increment
comma
id|wBIOSAddress
op_increment
)paren
(brace
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
id|wBIOSAddress
)paren
suffix:semicolon
op_star
id|pData
op_increment
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
suffix:semicolon
multiline_comment|/* Read from BIOS */
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|4
)paren
op_eq
l_int|3
)paren
(brace
id|ORC_WRLONG
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_RISCRAM
comma
id|dData
)paren
suffix:semicolon
multiline_comment|/* Write every 4 bytes */
id|pData
op_assign
(paren
id|UCHAR
op_star
)paren
op_amp
id|dData
suffix:semicolon
)brace
)brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_RISCCTL
comma
id|PRGMRST
op_or
id|DOWNLOAD
)paren
suffix:semicolon
multiline_comment|/* Reset program count 0 */
id|wBIOSAddress
op_sub_assign
l_int|0x1000
suffix:semicolon
multiline_comment|/* Reset the BIOS adddress      */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|pData
op_assign
(paren
id|UCHAR
op_star
)paren
op_amp
id|dData
suffix:semicolon
multiline_comment|/* Check the code       */
id|i
OL
l_int|0x1000
suffix:semicolon
multiline_comment|/* Firmware code size = 4K      */
id|i
op_increment
comma
id|wBIOSAddress
op_increment
)paren
(brace
id|ORC_WRSHORT
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_EBIOSADR0
comma
id|wBIOSAddress
)paren
suffix:semicolon
op_star
id|pData
op_increment
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_EBIOSDATA
)paren
suffix:semicolon
multiline_comment|/* Read from BIOS */
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|4
)paren
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|ORC_RDLONG
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_RISCRAM
)paren
op_ne
id|dData
)paren
(brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_RISCCTL
comma
id|PRGMRST
)paren
suffix:semicolon
multiline_comment|/* Reset program to 0 */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GCFG
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/*Disable EEPROM programming */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|pData
op_assign
(paren
id|UCHAR
op_star
)paren
op_amp
id|dData
suffix:semicolon
)brace
)brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_RISCCTL
comma
id|PRGMRST
)paren
suffix:semicolon
multiline_comment|/* Reset program to 0   */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GCFG
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Disable EEPROM programming */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|setup_SCBs
r_void
id|setup_SCBs
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|ORC_SCB
op_star
id|pVirScb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|UCHAR
id|j
suffix:semicolon
id|ESCB
op_star
id|pVirEscb
suffix:semicolon
id|PVOID
id|pPhysEscb
suffix:semicolon
id|PVOID
id|tPhysEscb
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
id|pVirScb
op_assign
l_int|NULL
suffix:semicolon
id|tPhysEscb
op_assign
(paren
id|PVOID
)paren
l_int|NULL
suffix:semicolon
id|pPhysEscb
op_assign
(paren
id|PVOID
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* Setup SCB HCS_Base and SCB Size registers */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_SCBSIZE
comma
id|orc_num_scb
)paren
suffix:semicolon
multiline_comment|/* Total number of SCBs */
multiline_comment|/* SCB HCS_Base address 0      */
id|ORC_WRLONG
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_SCBBASE0
comma
id|hcsp-&gt;HCS_physScbArray
)paren
suffix:semicolon
multiline_comment|/* SCB HCS_Base address 1      */
id|ORC_WRLONG
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_SCBBASE1
comma
id|hcsp-&gt;HCS_physScbArray
)paren
suffix:semicolon
multiline_comment|/* setup scatter list address with one buffer */
id|pVirScb
op_assign
(paren
id|ORC_SCB
op_star
)paren
id|hcsp-&gt;HCS_virScbArray
suffix:semicolon
id|pVirEscb
op_assign
(paren
id|ESCB
op_star
)paren
id|hcsp-&gt;HCS_virEscbArray
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|orc_num_scb
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pPhysEscb
op_assign
(paren
id|PVOID
)paren
(paren
id|hcsp-&gt;HCS_physEscbArray
op_plus
(paren
r_sizeof
(paren
id|ESCB
)paren
op_star
id|i
)paren
)paren
suffix:semicolon
id|pVirScb-&gt;SCB_SGPAddr
op_assign
(paren
id|U32
)paren
id|pPhysEscb
suffix:semicolon
id|pVirScb-&gt;SCB_SensePAddr
op_assign
(paren
id|U32
)paren
id|pPhysEscb
suffix:semicolon
id|pVirScb-&gt;SCB_EScb
op_assign
id|pVirEscb
suffix:semicolon
id|pVirScb-&gt;SCB_ScbIdx
op_assign
id|i
suffix:semicolon
id|pVirScb
op_increment
suffix:semicolon
id|pVirEscb
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|initAFlag
r_static
r_void
id|initAFlag
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|UCHAR
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|hcsp-&gt;BitAllocFlag
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|init_orchid
r_int
id|init_orchid
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|UBYTE
op_star
id|readBytep
suffix:semicolon
id|USHORT
id|revision
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|initAFlag
c_func
(paren
id|hcsp
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GIMSK
comma
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* Disable all interrupt        */
r_if
c_cond
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HSTUS
)paren
op_amp
id|RREADY
)paren
(brace
multiline_comment|/* Orchid is ready              */
id|revision
op_assign
id|get_FW_version
c_func
(paren
id|hcsp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
op_eq
l_int|0xFFFF
)paren
(brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|DEVRST
)paren
suffix:semicolon
multiline_comment|/* Reset Host Adapter   */
r_if
c_cond
(paren
id|waitChipReady
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|load_FW
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* Download FW                  */
id|setup_SCBs
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* Setup SCB HCS_Base and SCB Size registers */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* clear HOSTSTOP       */
r_if
c_cond
(paren
id|waitFWReady
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Wait for firmware ready     */
)brace
r_else
(brace
id|setup_SCBs
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* Setup SCB HCS_Base and SCB Size registers */
)brace
)brace
r_else
(brace
multiline_comment|/* Orchid is not Ready          */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|DEVRST
)paren
suffix:semicolon
multiline_comment|/* Reset Host Adapter   */
r_if
c_cond
(paren
id|waitChipReady
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|load_FW
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* Download FW                  */
id|setup_SCBs
c_func
(paren
id|hcsp
)paren
suffix:semicolon
multiline_comment|/* Setup SCB HCS_Base and SCB Size registers */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
multiline_comment|/* Do Hardware Reset &amp;  */
multiline_comment|/*     clear HOSTSTOP  */
r_if
c_cond
(paren
id|waitFWReady
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait for firmware ready      */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*------------- get serial EEProm settting -------*/
id|read_eeprom
c_func
(paren
id|hcsp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nvramp-&gt;Revision
op_ne
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|hcsp-&gt;HCS_SCSI_ID
op_assign
id|nvramp-&gt;SCSI0Id
suffix:semicolon
id|hcsp-&gt;HCS_BIOS
op_assign
id|nvramp-&gt;BIOSConfig1
suffix:semicolon
id|hcsp-&gt;HCS_MaxTar
op_assign
id|MAX_TARGETS
suffix:semicolon
id|readBytep
op_assign
(paren
id|UCHAR
op_star
)paren
op_amp
(paren
id|nvramp-&gt;Target00Config
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|readBytep
op_increment
comma
id|i
op_increment
)paren
(brace
id|hcsp-&gt;TargetFlag
(braket
id|i
)braket
op_assign
op_star
id|readBytep
suffix:semicolon
id|hcsp-&gt;MaximumTags
(braket
id|i
)braket
op_assign
id|orc_num_scb
suffix:semicolon
)brace
multiline_comment|/* for                          */
r_if
c_cond
(paren
id|nvramp-&gt;SCSI0Config
op_amp
id|NCC_BUSRESET
)paren
(brace
multiline_comment|/* Reset SCSI bus               */
id|hcsp-&gt;HCS_Flags
op_or_assign
id|HCF_SCSI_RESET
suffix:semicolon
)brace
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_GIMSK
comma
l_int|0xFB
)paren
suffix:semicolon
multiline_comment|/* enable RP FIFO interrupt     */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; Function name  : orc_reset_scsi_bus&n; Description    : Reset registers, reset a hanging bus and&n;                  kill active and disconnected commands for target w/o soft reset&n; Input          : pHCB  -       Pointer to host adapter structure&n; Output         : None.&n; Return         : pSRB  -       Pointer to SCSI request block.&n;*****************************************************************************/
DECL|function|orc_reset_scsi_bus
r_int
id|orc_reset_scsi_bus
c_func
(paren
id|ORC_HCS
op_star
id|pHCB
)paren
(brace
multiline_comment|/* I need Host Control Block Information */
id|ULONG
id|flags
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;inia100: enter inia100_reset&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|initAFlag
c_func
(paren
id|pHCB
)paren
suffix:semicolon
multiline_comment|/* reset scsi bus */
id|ORC_WR
c_func
(paren
id|pHCB-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|SCSIRST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitSCSIRSTdone
c_func
(paren
id|pHCB
)paren
op_eq
id|FALSE
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_ERROR
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_SUCCESS
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************&n; Function name  : orc_device_reset&n; Description    : Reset registers, reset a hanging bus and&n;                  kill active and disconnected commands for target w/o soft reset&n; Input          : pHCB  -       Pointer to host adapter structure&n; Output         : None.&n; Return         : pSRB  -       Pointer to SCSI request block.&n;*****************************************************************************/
DECL|function|orc_device_reset
r_int
id|orc_device_reset
c_func
(paren
id|ORC_HCS
op_star
id|pHCB
comma
id|ULONG
id|SCpnt
comma
r_int
r_int
id|target
comma
r_int
r_int
id|ResetFlags
)paren
(brace
multiline_comment|/* I need Host Control Block Information */
id|ORC_SCB
op_star
id|pScb
suffix:semicolon
id|ESCB
op_star
id|pVirEscb
suffix:semicolon
id|ORC_SCB
op_star
id|pVirScb
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;inia100: enter inia100_reset&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pScb
op_assign
(paren
id|ORC_SCB
op_star
)paren
l_int|NULL
suffix:semicolon
id|pVirEscb
op_assign
(paren
id|ESCB
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* setup scatter list address with one buffer */
id|pVirScb
op_assign
(paren
id|ORC_SCB
op_star
)paren
id|pHCB-&gt;HCS_virScbArray
suffix:semicolon
id|initAFlag
c_func
(paren
id|pHCB
)paren
suffix:semicolon
multiline_comment|/* device reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|orc_num_scb
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pVirEscb
op_assign
id|pVirScb-&gt;SCB_EScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pVirScb-&gt;SCB_Status
)paren
op_logical_and
(paren
id|pVirEscb-&gt;SCB_Srb
op_eq
(paren
r_int
r_char
op_star
)paren
id|SCpnt
)paren
)paren
r_break
suffix:semicolon
id|pVirScb
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|orc_num_scb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to Reset - No SCB Found&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_NOT_RUNNING
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|orc_alloc_scb
c_func
(paren
id|pHCB
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_RESET_NOT_RUNNING
)paren
suffix:semicolon
)brace
id|pScb-&gt;SCB_Opcode
op_assign
id|ORC_BUSDEVRST
suffix:semicolon
id|pScb-&gt;SCB_Target
op_assign
id|target
suffix:semicolon
id|pScb-&gt;SCB_HaStat
op_assign
l_int|0
suffix:semicolon
id|pScb-&gt;SCB_TaStat
op_assign
l_int|0
suffix:semicolon
id|pScb-&gt;SCB_Status
op_assign
l_int|0x0
suffix:semicolon
id|pScb-&gt;SCB_Link
op_assign
l_int|0xFF
suffix:semicolon
id|pScb-&gt;SCB_Reserved0
op_assign
l_int|0
suffix:semicolon
id|pScb-&gt;SCB_Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScb-&gt;SCB_XferLen
op_assign
l_int|0
suffix:semicolon
id|pScb-&gt;SCB_SGLen
op_assign
l_int|0
suffix:semicolon
id|pVirEscb-&gt;SCB_Srb
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ResetFlags
op_amp
id|SCSI_RESET_SYNCHRONOUS
)paren
(brace
id|pVirEscb-&gt;SCB_Srb
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
)brace
id|orc_exec_scb
c_func
(paren
id|pHCB
comma
id|pScb
)paren
suffix:semicolon
multiline_comment|/* Start execute SCB            */
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|pHCB-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|orc_alloc_scb
id|ORC_SCB
op_star
id|orc_alloc_scb
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|ORC_SCB
op_star
id|pTmpScb
suffix:semicolon
id|UCHAR
id|Ch
suffix:semicolon
id|ULONG
id|idx
suffix:semicolon
id|UCHAR
id|index
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|Ch
op_assign
id|hcsp-&gt;HCS_Index
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
l_int|32
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|hcsp-&gt;BitAllocFlag
(braket
id|Ch
)braket
(braket
id|i
)braket
op_rshift
id|index
)paren
op_amp
l_int|0x01
)paren
(brace
id|hcsp-&gt;BitAllocFlag
(braket
id|Ch
)braket
(braket
id|i
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|idx
op_assign
id|index
op_plus
l_int|32
op_star
id|i
suffix:semicolon
id|pTmpScb
op_assign
(paren
id|PVOID
)paren
(paren
(paren
id|ULONG
)paren
id|hcsp-&gt;HCS_virScbArray
op_plus
(paren
id|idx
op_star
r_sizeof
(paren
id|ORC_SCB
)paren
)paren
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pTmpScb
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|orc_release_scb
r_void
id|orc_release_scb
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
id|ORC_SCB
op_star
id|scbp
)paren
(brace
id|ULONG
id|flags
suffix:semicolon
id|UCHAR
id|Index
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|UCHAR
id|Ch
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|Ch
op_assign
id|hcsp-&gt;HCS_Index
suffix:semicolon
id|Index
op_assign
id|scbp-&gt;SCB_ScbIdx
suffix:semicolon
id|i
op_assign
id|Index
op_div
l_int|32
suffix:semicolon
id|Index
op_mod_assign
l_int|32
suffix:semicolon
id|hcsp-&gt;BitAllocFlag
(braket
id|Ch
)braket
(braket
id|i
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|Index
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*****************************************************************************&n; Function name&t;: Addinia100_into_Adapter_table&n; Description&t;: This function will scan PCI bus to get all Orchid card&n; Input&t;&t;: None.&n; Output&t;&t;: None.&n; Return&t;&t;: SUCCESSFUL&t;- Successful scan&n; ohterwise&t;- No drives founded&n;*****************************************************************************/
DECL|function|Addinia100_into_Adapter_table
r_int
id|Addinia100_into_Adapter_table
c_func
(paren
id|WORD
id|wBIOS
comma
id|WORD
id|wBASE
comma
id|BYTE
id|bInterrupt
comma
id|BYTE
id|bBus
comma
id|BYTE
id|bDevice
)paren
(brace
r_int
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SUPPORTED_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
OL
id|wBIOS
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
op_eq
id|wBIOS
)paren
(brace
r_if
c_cond
(paren
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
op_eq
id|wBASE
)paren
(brace
r_if
c_cond
(paren
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_Bus
op_ne
l_int|0xFF
)paren
r_return
(paren
id|FAILURE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
OL
id|wBASE
)paren
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
id|MAX_SUPPORTED_ADAPTERS
op_minus
l_int|1
suffix:semicolon
id|j
OG
id|i
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|inia100_adpt
(braket
id|j
)braket
dot
id|ADPT_BASE
op_assign
id|inia100_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_BASE
suffix:semicolon
id|inia100_adpt
(braket
id|j
)braket
dot
id|ADPT_INTR
op_assign
id|inia100_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_INTR
suffix:semicolon
id|inia100_adpt
(braket
id|j
)braket
dot
id|ADPT_BIOS
op_assign
id|inia100_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_BIOS
suffix:semicolon
id|inia100_adpt
(braket
id|j
)braket
dot
id|ADPT_Bus
op_assign
id|inia100_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_Bus
suffix:semicolon
id|inia100_adpt
(braket
id|j
)braket
dot
id|ADPT_Device
op_assign
id|inia100_adpt
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ADPT_Device
suffix:semicolon
)brace
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
op_assign
id|wBASE
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_INTR
op_assign
id|bInterrupt
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
op_assign
id|wBIOS
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_Bus
op_assign
id|bBus
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_Device
op_assign
id|bDevice
suffix:semicolon
r_return
(paren
id|SUCCESSFUL
)paren
suffix:semicolon
)brace
r_return
(paren
id|FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; Function name&t;: init_inia100Adapter_table&n; Description&t;: This function will scan PCI bus to get all Orchid card&n; Input&t;&t;: None.&n; Output&t;&t;: None.&n; Return&t;&t;: SUCCESSFUL&t;- Successful scan&n; ohterwise&t;- No drives founded&n;*****************************************************************************/
DECL|function|init_inia100Adapter_table
r_void
id|init_inia100Adapter_table
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SUPPORTED_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Initialize adapter structure */
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BIOS
op_assign
l_int|0xffff
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_BASE
op_assign
l_int|0xffff
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_INTR
op_assign
l_int|0xff
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_Bus
op_assign
l_int|0xff
suffix:semicolon
id|inia100_adpt
(braket
id|i
)braket
dot
id|ADPT_Device
op_assign
l_int|0xff
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************&n; Function name  : get_orcPCIConfig&n; Description    : &n; Input          : pHCB  -       Pointer to host adapter structure&n; Output         : None.&n; Return         : pSRB  -       Pointer to SCSI request block.&n;*****************************************************************************/
DECL|function|get_orcPCIConfig
r_void
id|get_orcPCIConfig
c_func
(paren
id|ORC_HCS
op_star
id|pCurHcb
comma
r_int
id|ch_idx
)paren
(brace
id|pCurHcb-&gt;HCS_Base
op_assign
id|inia100_adpt
(braket
id|ch_idx
)braket
dot
id|ADPT_BASE
suffix:semicolon
multiline_comment|/* Supply base address  */
id|pCurHcb-&gt;HCS_BIOS
op_assign
id|inia100_adpt
(braket
id|ch_idx
)braket
dot
id|ADPT_BIOS
suffix:semicolon
multiline_comment|/* Supply BIOS address  */
id|pCurHcb-&gt;HCS_Intr
op_assign
id|inia100_adpt
(braket
id|ch_idx
)braket
dot
id|ADPT_INTR
suffix:semicolon
multiline_comment|/* Supply interrupt line */
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; Function name  : abort_SCB&n; Description    : Abort a queued command.&n;&t;                 (commands that are on the bus can&squot;t be aborted easily)&n; Input          : pHCB  -       Pointer to host adapter structure&n; Output         : None.&n; Return         : pSRB  -       Pointer to SCSI request block.&n;*****************************************************************************/
DECL|function|abort_SCB
r_int
id|abort_SCB
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
id|ORC_SCB
op_star
id|pScb
)paren
(brace
r_int
r_char
id|bData
comma
id|bStatus
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|ORC_CMD_ABORT_SCB
)paren
suffix:semicolon
multiline_comment|/* Write command */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HDATA
comma
id|pScb-&gt;SCB_ScbIdx
)paren
suffix:semicolon
multiline_comment|/* Write address */
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HCTRL
comma
id|HDO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDOoff
c_func
(paren
id|hcsp
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDO off   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitHDIset
c_func
(paren
id|hcsp
comma
op_amp
id|bData
)paren
op_eq
id|FALSE
)paren
multiline_comment|/* Wait HDI set   */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|bStatus
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_HDATA
)paren
suffix:semicolon
id|ORC_WR
c_func
(paren
id|hcsp-&gt;HCS_Base
op_plus
id|ORC_HSTUS
comma
id|bData
)paren
suffix:semicolon
multiline_comment|/* Clear HDI    */
r_if
c_cond
(paren
id|bStatus
op_eq
l_int|1
)paren
multiline_comment|/* 0 - Successfully               */
r_return
(paren
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* 1 - Fail                     */
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; Function name  : inia100_abort&n; Description    : Abort a queued command.&n;&t;                 (commands that are on the bus can&squot;t be aborted easily)&n; Input          : pHCB  -       Pointer to host adapter structure&n; Output         : None.&n; Return         : pSRB  -       Pointer to SCSI request block.&n;*****************************************************************************/
DECL|function|orc_abort_srb
r_int
id|orc_abort_srb
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
comma
id|ULONG
id|SCpnt
)paren
(brace
id|ESCB
op_star
id|pVirEscb
suffix:semicolon
id|ORC_SCB
op_star
id|pVirScb
suffix:semicolon
id|UCHAR
id|i
suffix:semicolon
id|ULONG
id|flags
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;inia100: abort SRB &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|pVirScb
op_assign
(paren
id|ORC_SCB
op_star
)paren
id|hcsp-&gt;HCS_virScbArray
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|orc_num_scb
suffix:semicolon
id|i
op_increment
comma
id|pVirScb
op_increment
)paren
(brace
id|pVirEscb
op_assign
id|pVirScb-&gt;SCB_EScb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pVirScb-&gt;SCB_Status
)paren
op_logical_and
(paren
id|pVirEscb-&gt;SCB_Srb
op_eq
(paren
r_int
r_char
op_star
)paren
id|SCpnt
)paren
)paren
(brace
r_if
c_cond
(paren
id|pVirScb-&gt;SCB_TagMsg
op_eq
l_int|0
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_ABORT_BUSY
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|abort_SCB
c_func
(paren
id|hcsp
comma
id|pVirScb
)paren
)paren
(brace
id|pVirEscb-&gt;SCB_Srb
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_ABORT_SUCCESS
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#if LINUX_VERSION_CODE &lt; CVT_LINUX_VERSION(2,1,95)
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|hcsp-&gt;BitAllocFlagLock
)paren
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|SCSI_ABORT_NOT_RUNNING
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; Routine Description:&n;&t;  This is the interrupt service routine for the Orchid SCSI adapter.&n;&t;  It reads the interrupt register to determine if the adapter is indeed&n;&t;  the source of the interrupt and clears the interrupt at the device.&n; Arguments:&n;&t;  HwDeviceExtension - HBA miniport driver&squot;s adapter data storage&n; Return Value:&n;***********************************************************************/
DECL|function|orc_interrupt
r_void
id|orc_interrupt
c_func
(paren
id|ORC_HCS
op_star
id|hcsp
)paren
(brace
id|BYTE
id|bScbIdx
suffix:semicolon
id|ORC_SCB
op_star
id|pScb
suffix:semicolon
r_if
c_cond
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_RQUEUECNT
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
singleline_comment|// (FALSE);
)brace
r_do
(brace
id|bScbIdx
op_assign
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_RQUEUE
)paren
suffix:semicolon
id|pScb
op_assign
(paren
id|ORC_SCB
op_star
)paren
(paren
(paren
id|ULONG
)paren
id|hcsp-&gt;HCS_virScbArray
op_plus
(paren
id|ULONG
)paren
(paren
r_sizeof
(paren
id|ORC_SCB
)paren
op_star
id|bScbIdx
)paren
)paren
suffix:semicolon
id|pScb-&gt;SCB_Status
op_assign
l_int|0x0
suffix:semicolon
id|inia100SCBPost
c_func
(paren
(paren
id|BYTE
op_star
)paren
id|hcsp
comma
(paren
id|BYTE
op_star
)paren
id|pScb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ORC_RD
c_func
(paren
id|hcsp-&gt;HCS_Base
comma
id|ORC_RQUEUECNT
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
singleline_comment|//(TRUE);
)brace
multiline_comment|/* End of I1060Interrupt() */
eof
