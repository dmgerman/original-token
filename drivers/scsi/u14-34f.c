multiline_comment|/*&n; *      u14-34f.c - Low-level driver for UltraStor 14F/34F SCSI host adapters.&n; *&n; *      28 Jan 1995 rev. 1.14 for linux 1.1.86&n; *          Added module support.&n; *          Log and do a retry when a disk drive returns a target status&n; *          different from zero on a recovered error.&n; *          Auto detects if U14F boards have an old firmware revision.&n; *          Max number of scatter/gather lists set to 16 for all boards&n; *          (most installation run fine using 33 sglists, while other&n; *          has problems when using more then 16).&n; *&n; *      16 Jan 1995 rev. 1.13 for linux 1.1.81&n; *          Display a message if check_region detects a port address&n; *          already in use.&n; *&n; *      15 Dec 1994 rev. 1.12 for linux 1.1.74&n; *          The host-&gt;block flag is set for all the detected ISA boards.&n; *&n; *      30 Nov 1994 rev. 1.11 for linux 1.1.68&n; *          Redo i/o on target status CHECK_CONDITION for TYPE_DISK only.&n; *          Added optional support for using a single board at a time.&n; *&n; *      14 Nov 1994 rev. 1.10 for linux 1.1.63&n; *&n; *      28 Oct 1994 rev. 1.09 for linux 1.1.58  Final BETA release.&n; *      16 Jul 1994 rev. 1.00 for linux 1.1.29  Initial ALPHA release.&n; *&n; *          This driver is a total replacement of the original UltraStor &n; *          scsi driver, but it supports ONLY the 14F and 34F boards.&n; *          It can be configured in the same kernel in which the original&n; *          ultrastor driver is configured to allow the original U24F&n; *          support.&n; * &n; *          Multiple U14F and/or U34F host adapters are supported.&n; *&n; *      Released by Dario Ballabio (Dario_Ballabio@milano.europe.dg.com)&n; *&n; *      WARNING: if your 14F board has an old firmware revision (see below)&n; *               you must change &quot;#undef&quot; into &quot;#define&quot; in the following&n; *               statement.&n; */
DECL|macro|HAVE_OLD_U14F_FIRMWARE
macro_line|#undef HAVE_OLD_U14F_FIRMWARE
multiline_comment|/*&n; *  The UltraStor 14F, 24F, and 34F are a family of intelligent, high&n; *  performance SCSI-2 host adapters.&n; *  Here is the scoop on the various models:&n; *&n; *  14F - ISA first-party DMA HA with floppy support and WD1003 emulation.&n; *  24F - EISA Bus Master HA with floppy support and WD1003 emulation.&n; *  34F - VESA Local-Bus Bus Master HA (no WD1003 emulation).&n; *&n; *  This code has been tested with up to two U14F boards, using both &n; *  firmware 28004-005/38004-004 (BIOS rev. 2.00) and the latest firmware&n; *  28004-006/38004-005 (BIOS rev. 2.01). &n; *&n; *  The latest firmware is required in order to get reliable operations when &n; *  clustering is enabled. ENABLE_CLUSTERING provides a performance increase&n; *  up to 50% on sequential access.&n; *&n; *  Since the Scsi_Host_Template structure is shared among all 14F and 34F,&n; *  the last setting of use_clustering is in effect for all of these boards.&n; *&n; *  Here a sample configuration using two U14F boards:&n; *&n; U14F0: PORT 0x330, BIOS 0xc8000, IRQ 11, DMA 5, SG 16, Mbox 16, CmdLun 2, C1.&n; U14F1: PORT 0x340, BIOS 0x00000, IRQ 10, DMA 6, SG 16, Mbox 16, CmdLun 2, C1.&n; *&n; *  The boot controller must have its BIOS enabled, while other boards can&n; *  have their BIOS disabled, or enabled to an higher address.&n; *  Boards are named Ux4F0, Ux4F1..., according to the port address order in&n; *  the io_port[] array.&n; *  &n; *  The following facts are based on real testing results (not on&n; *  documentation) on the above U14F board.&n; *  &n; *  - The U14F board should be jumpered for bus on time less or equal to 7 &n; *    microseconds, while the default is 11 microseconds. This is order to &n; *    get acceptable performance while using floppy drive and hard disk &n; *    together. The jumpering for 7 microseconds is: JP13 pin 15-16, &n; *    JP14 pin 7-8 and pin 9-10.&n; *    The reduction has a little impact on scsi performance.&n; *  &n; *  - If scsi bus length exceeds 3m., the scsi bus speed needs to be reduced&n; *    from 10Mhz to 5Mhz (do this by inserting a jumper on JP13 pin 7-8).&n; *&n; *  - If U14F on board firmware is older than 28004-006/38004-005,&n; *    the U14F board is unable to provide reliable operations if the scsi &n; *    request length exceeds 16Kbyte. When this length is exceeded the&n; *    behavior is: &n; *    - adapter_status equal 0x96 or 0xa3 or 0x93 or 0x94;&n; *    - adapter_status equal 0 and target_status equal 2 on for all targets&n; *      in the next operation following the reset.&n; *    This sequence takes a long time (&gt;3 seconds), so in the meantime&n; *    the SD_TIMEOUT in sd.c could expire giving rise to scsi aborts&n; *    (SD_TIMEOUT has been increased from 3 to 6 seconds in 1.1.31).&n; *    Because of this I had to DISABLE_CLUSTERING and to work around the&n; *    bus reset in the interrupt service routine, returning DID_BUS_BUSY&n; *    so that the operations are retried without complains from the scsi.c&n; *    code.&n; *    Any reset of the scsi bus is going to kill tape operations, since&n; *    no retry is allowed for tapes. Bus resets are more likely when the&n; *    scsi bus is under heavy load.&n; *    Requests using scatter/gather have a maximum length of 16 x 1024 bytes &n; *    when DISABLE_CLUSTERING is in effect, but unscattered requests could be&n; *    larger than 16Kbyte.&n; *&n; *    The new firmware has fixed all the above problems.&n; *&n; *  In order to support multiple ISA boards in a reliable way,&n; *  the driver sets host-&gt;block = TRUE for all ISA boards.&n; */
macro_line|#if defined(MODULE)
macro_line|#include &lt;linux/module.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;../block/blk.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;sd.h&quot;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;u14-34f.h&quot;
multiline_comment|/* Values for the PRODUCT_ID ports for the 14/34F */
DECL|macro|PRODUCT_ID1
mdefine_line|#define PRODUCT_ID1  0x56
DECL|macro|PRODUCT_ID2
mdefine_line|#define PRODUCT_ID2  0x40        /* NOTE: Only upper nibble is used */
multiline_comment|/* Subversion values */
DECL|macro|ISA
mdefine_line|#define ISA  0
DECL|macro|ESA
mdefine_line|#define ESA 1
DECL|macro|OP_HOST_ADAPTER
mdefine_line|#define OP_HOST_ADAPTER   0x1
DECL|macro|OP_SCSI
mdefine_line|#define OP_SCSI           0x2
DECL|macro|OP_RESET
mdefine_line|#define OP_RESET          0x4
DECL|macro|DTD_SCSI
mdefine_line|#define DTD_SCSI          0x0
DECL|macro|DTD_IN
mdefine_line|#define DTD_IN            0x1
DECL|macro|DTD_OUT
mdefine_line|#define DTD_OUT           0x2
DECL|macro|DTD_NONE
mdefine_line|#define DTD_NONE          0x3
DECL|macro|HA_CMD_INQUIRY
mdefine_line|#define HA_CMD_INQUIRY    0x1
DECL|macro|HA_CMD_SELF_DIAG
mdefine_line|#define HA_CMD_SELF_DIAG  0x2
DECL|macro|HA_CMD_READ_BUFF
mdefine_line|#define HA_CMD_READ_BUFF  0x3
DECL|macro|HA_CMD_WRITE_BUFF
mdefine_line|#define HA_CMD_WRITE_BUFF 0x4
DECL|macro|DEBUG_DETECT
macro_line|#undef  DEBUG_DETECT
DECL|macro|DEBUG_INTERRUPT
macro_line|#undef  DEBUG_INTERRUPT
DECL|macro|DEBUG_STATISTICS
macro_line|#undef  DEBUG_STATISTICS
DECL|macro|MAX_TARGET
mdefine_line|#define MAX_TARGET 8
DECL|macro|MAX_IRQ
mdefine_line|#define MAX_IRQ 16
DECL|macro|MAX_BOARDS
mdefine_line|#define MAX_BOARDS 4
DECL|macro|MAX_MAILBOXES
mdefine_line|#define MAX_MAILBOXES 16
DECL|macro|MAX_SGLIST
mdefine_line|#define MAX_SGLIST 16
DECL|macro|MAX_CMD_PER_LUN
mdefine_line|#define MAX_CMD_PER_LUN 2
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE 1
DECL|macro|FREE
mdefine_line|#define FREE 0
DECL|macro|IN_USE
mdefine_line|#define IN_USE   1
DECL|macro|LOCKED
mdefine_line|#define LOCKED   2
DECL|macro|IN_RESET
mdefine_line|#define IN_RESET 3
DECL|macro|IGNORE
mdefine_line|#define IGNORE   4
DECL|macro|NO_IRQ
mdefine_line|#define NO_IRQ  0xff
DECL|macro|NO_DMA
mdefine_line|#define NO_DMA  0xff
DECL|macro|MAXLOOP
mdefine_line|#define MAXLOOP 200000
DECL|macro|REG_LCL_MASK
mdefine_line|#define REG_LCL_MASK      0
DECL|macro|REG_LCL_INTR
mdefine_line|#define REG_LCL_INTR      1
DECL|macro|REG_SYS_MASK
mdefine_line|#define REG_SYS_MASK      2
DECL|macro|REG_SYS_INTR
mdefine_line|#define REG_SYS_INTR      3
DECL|macro|REG_PRODUCT_ID1
mdefine_line|#define REG_PRODUCT_ID1   4
DECL|macro|REG_PRODUCT_ID2
mdefine_line|#define REG_PRODUCT_ID2   5
DECL|macro|REG_CONFIG1
mdefine_line|#define REG_CONFIG1       6
DECL|macro|REG_CONFIG2
mdefine_line|#define REG_CONFIG2       7
DECL|macro|REG_OGM
mdefine_line|#define REG_OGM           8
DECL|macro|REG_ICM
mdefine_line|#define REG_ICM           12
DECL|macro|REGION_SIZE
mdefine_line|#define REGION_SIZE       13
DECL|macro|BSY_ASSERTED
mdefine_line|#define BSY_ASSERTED      0x01
DECL|macro|IRQ_ASSERTED
mdefine_line|#define IRQ_ASSERTED      0x01
DECL|macro|CMD_RESET
mdefine_line|#define CMD_RESET         0xc0
DECL|macro|CMD_OGM_INTR
mdefine_line|#define CMD_OGM_INTR      0x01
DECL|macro|CMD_CLR_INTR
mdefine_line|#define CMD_CLR_INTR      0x01
DECL|macro|CMD_ENA_INTR
mdefine_line|#define CMD_ENA_INTR      0x81
DECL|macro|ASOK
mdefine_line|#define ASOK              0x00
DECL|macro|ASST
mdefine_line|#define ASST              0x91
DECL|macro|PACKED
mdefine_line|#define PACKED          __attribute__((packed))
multiline_comment|/* MailBox SCSI Command Packet */
DECL|struct|mscp
r_struct
id|mscp
(brace
DECL|member|opcode
r_int
r_char
id|opcode
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* type of command */
DECL|member|xdir
r_int
r_char
id|xdir
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* data transfer direction */
DECL|member|dcn
r_int
r_char
id|dcn
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* disable disconnect */
DECL|member|ca
r_int
r_char
id|ca
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* use cache (if available) */
DECL|member|sg
r_int
r_char
id|sg
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* scatter/gather operation */
DECL|member|target
r_int
r_char
id|target
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* target SCSI id */
DECL|member|ch_no
r_int
r_char
id|ch_no
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* SCSI channel (always 0 for 14f) */
DECL|member|lun
r_int
r_char
id|lun
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* logical unit number */
DECL|member|PACKED
r_int
r_int
id|data_address
id|PACKED
suffix:semicolon
multiline_comment|/* transfer data pointer */
DECL|member|PACKED
r_int
r_int
id|data_len
id|PACKED
suffix:semicolon
multiline_comment|/* length in bytes */
DECL|member|PACKED
r_int
r_int
id|command_link
id|PACKED
suffix:semicolon
multiline_comment|/* for linking command chains */
DECL|member|scsi_command_link_id
r_int
r_char
id|scsi_command_link_id
suffix:semicolon
multiline_comment|/* identifies command in chain */
DECL|member|use_sg
r_int
r_char
id|use_sg
suffix:semicolon
multiline_comment|/* (if sg is set) 8 bytes per list */
DECL|member|sense_len
r_int
r_char
id|sense_len
suffix:semicolon
DECL|member|scsi_cdbs_len
r_int
r_char
id|scsi_cdbs_len
suffix:semicolon
multiline_comment|/* 6, 10, or 12 */
DECL|member|scsi_cdbs
r_int
r_char
id|scsi_cdbs
(braket
l_int|12
)braket
suffix:semicolon
multiline_comment|/* SCSI commands */
DECL|member|adapter_status
r_int
r_char
id|adapter_status
suffix:semicolon
multiline_comment|/* non-zero indicates HA error */
DECL|member|target_status
r_int
r_char
id|target_status
suffix:semicolon
multiline_comment|/* non-zero indicates target error */
DECL|member|PACKED
r_int
r_int
id|sense_addr
id|PACKED
suffix:semicolon
DECL|member|SCpnt
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
DECL|struct|sg_list
r_struct
id|sg_list
(brace
DECL|member|address
r_int
r_int
id|address
suffix:semicolon
multiline_comment|/* Segment Address */
DECL|member|num_bytes
r_int
r_int
id|num_bytes
suffix:semicolon
multiline_comment|/* Segment Length */
DECL|member|sglist
)brace
id|sglist
(braket
id|MAX_SGLIST
)braket
suffix:semicolon
DECL|member|index
r_int
r_int
id|index
suffix:semicolon
multiline_comment|/* cp index */
)brace
suffix:semicolon
DECL|struct|hostdata
r_struct
id|hostdata
(brace
DECL|member|cp
r_struct
id|mscp
id|cp
(braket
id|MAX_MAILBOXES
)braket
suffix:semicolon
multiline_comment|/* Mailboxes for this board */
DECL|member|cp_stat
r_int
r_int
id|cp_stat
(braket
id|MAX_MAILBOXES
)braket
suffix:semicolon
multiline_comment|/* FREE, IN_USE, LOCKED, IN_RESET */
DECL|member|last_cp_used
r_int
r_int
id|last_cp_used
suffix:semicolon
multiline_comment|/* Index of last mailbox used */
DECL|member|iocount
r_int
r_int
id|iocount
suffix:semicolon
multiline_comment|/* Total i/o done for this board */
DECL|member|multicount
r_int
r_int
id|multicount
suffix:semicolon
multiline_comment|/* Total ... in second ihdlr loop */
DECL|member|board_number
r_int
id|board_number
suffix:semicolon
multiline_comment|/* Number of this board */
DECL|member|board_name
r_char
id|board_name
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* Name of this board */
DECL|member|board_id
r_char
id|board_id
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* data from INQUIRY on this board */
DECL|member|in_reset
r_int
id|in_reset
suffix:semicolon
multiline_comment|/* True if board is doing a reset */
DECL|member|target_time_out
r_int
id|target_time_out
(braket
id|MAX_TARGET
)braket
suffix:semicolon
multiline_comment|/* N. of timeout errors on target */
DECL|member|target_reset
r_int
id|target_reset
(braket
id|MAX_TARGET
)braket
suffix:semicolon
multiline_comment|/* If TRUE redo operation on target */
DECL|member|subversion
r_int
r_char
id|subversion
suffix:semicolon
multiline_comment|/* Bus type, either ISA or ESA */
DECL|member|heads
r_int
r_char
id|heads
suffix:semicolon
DECL|member|sectors
r_int
r_char
id|sectors
suffix:semicolon
multiline_comment|/* slot != 0 for the U24F, slot == 0 for both the U14F and U34F */
DECL|member|slot
r_int
r_char
id|slot
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sh
r_static
r_struct
id|Scsi_Host
op_star
id|sh
(braket
id|MAX_BOARDS
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;Ux4F&quot;
suffix:semicolon
DECL|variable|irqlist
DECL|variable|calls
r_static
r_int
r_int
id|irqlist
(braket
id|MAX_IRQ
)braket
comma
id|calls
(braket
id|MAX_IRQ
)braket
suffix:semicolon
DECL|macro|HD
mdefine_line|#define HD(board) ((struct hostdata *) &amp;sh[board]-&gt;hostdata)
DECL|macro|BN
mdefine_line|#define BN(board) (HD(board)-&gt;board_name)
r_static
r_void
id|u14_34f_interrupt_handler
c_func
(paren
r_int
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|variable|do_trace
r_static
r_int
id|do_trace
op_assign
id|FALSE
suffix:semicolon
DECL|function|wait_on_busy
r_static
r_inline
id|unchar
id|wait_on_busy
c_func
(paren
id|ushort
id|iobase
)paren
(brace
r_int
r_int
id|loop
op_assign
id|MAXLOOP
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|REG_LCL_INTR
)paren
op_amp
id|BSY_ASSERTED
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
id|TRUE
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
DECL|function|board_inquiry
r_static
r_int
id|board_inquiry
c_func
(paren
r_int
r_int
id|j
)paren
(brace
r_struct
id|mscp
op_star
id|cpp
suffix:semicolon
r_int
r_int
id|time
comma
id|limit
op_assign
l_int|0
suffix:semicolon
id|cpp
op_assign
op_amp
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cpp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mscp
)paren
)paren
suffix:semicolon
id|cpp-&gt;opcode
op_assign
id|OP_HOST_ADAPTER
suffix:semicolon
id|cpp-&gt;xdir
op_assign
id|DTD_IN
suffix:semicolon
id|cpp-&gt;data_address
op_assign
(paren
r_int
r_int
)paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_id
suffix:semicolon
id|cpp-&gt;data_len
op_assign
r_sizeof
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_id
)paren
suffix:semicolon
id|cpp-&gt;scsi_cdbs_len
op_assign
l_int|6
suffix:semicolon
id|cpp-&gt;scsi_cdbs
(braket
l_int|0
)braket
op_assign
id|HA_CMD_INQUIRY
suffix:semicolon
r_if
c_cond
(paren
id|wait_on_busy
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: board_inquiry, adapter busy.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
l_int|0
)braket
op_assign
id|IGNORE
suffix:semicolon
multiline_comment|/* Clear the interrupt indication */
id|outb
c_func
(paren
id|CMD_CLR_INTR
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_SYS_INTR
)paren
suffix:semicolon
multiline_comment|/* Store pointer in OGM address bytes */
id|outl
c_func
(paren
(paren
r_int
r_int
)paren
id|cpp
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_OGM
)paren
suffix:semicolon
multiline_comment|/* Issue OGM interrupt */
id|outb
c_func
(paren
id|CMD_OGM_INTR
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_LCL_INTR
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
(paren
id|time
op_plus
l_int|100
)paren
op_logical_and
id|limit
op_increment
OL
l_int|100000000
)paren
id|sti
c_func
(paren
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpp-&gt;adapter_status
op_logical_or
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
l_int|0
)braket
op_ne
id|FREE
)paren
(brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
l_int|0
)braket
op_assign
id|FREE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: board_inquiry, err 0x%x.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|cpp-&gt;adapter_status
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
DECL|function|port_detect
r_static
r_inline
r_int
id|port_detect
c_func
(paren
id|ushort
op_star
id|port_base
comma
r_int
r_int
id|j
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_char
id|irq
comma
id|dma_channel
comma
id|subversion
suffix:semicolon
r_int
r_char
id|in_byte
suffix:semicolon
multiline_comment|/* Allowed BIOS base addresses (NULL indicates reserved) */
r_void
op_star
id|bios_segment_table
(braket
l_int|8
)braket
op_assign
(brace
l_int|NULL
comma
(paren
r_void
op_star
)paren
l_int|0xc4000
comma
(paren
r_void
op_star
)paren
l_int|0xc8000
comma
(paren
r_void
op_star
)paren
l_int|0xcc000
comma
(paren
r_void
op_star
)paren
l_int|0xd0000
comma
(paren
r_void
op_star
)paren
l_int|0xd4000
comma
(paren
r_void
op_star
)paren
l_int|0xd8000
comma
(paren
r_void
op_star
)paren
l_int|0xdc000
)brace
suffix:semicolon
multiline_comment|/* Allowed IRQs */
r_int
r_char
id|interrupt_table
(braket
l_int|4
)braket
op_assign
(brace
l_int|15
comma
l_int|14
comma
l_int|11
comma
l_int|10
)brace
suffix:semicolon
multiline_comment|/* Allowed DMA channels for ISA (0 indicates reserved) */
r_int
r_char
id|dma_channel_table
(braket
l_int|4
)braket
op_assign
(brace
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Head/sector mappings */
r_struct
(brace
r_int
r_char
id|heads
suffix:semicolon
r_int
r_char
id|sectors
suffix:semicolon
)brace
id|mapping_table
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|16
comma
l_int|63
)brace
comma
(brace
l_int|64
comma
l_int|32
)brace
comma
(brace
l_int|64
comma
l_int|63
)brace
comma
(brace
l_int|64
comma
l_int|32
)brace
)brace
suffix:semicolon
r_struct
id|config_1
(brace
r_int
r_char
id|bios_segment
suffix:colon
l_int|3
suffix:semicolon
r_int
r_char
id|removable_disks_as_fixed
suffix:colon
l_int|1
suffix:semicolon
r_int
r_char
id|interrupt
suffix:colon
l_int|2
suffix:semicolon
r_int
r_char
id|dma_channel
suffix:colon
l_int|2
suffix:semicolon
)brace
id|config_1
suffix:semicolon
r_struct
id|config_2
(brace
r_int
r_char
id|ha_scsi_id
suffix:colon
l_int|3
suffix:semicolon
r_int
r_char
id|mapping_mode
suffix:colon
l_int|2
suffix:semicolon
r_int
r_char
id|bios_drive_number
suffix:colon
l_int|1
suffix:semicolon
r_int
r_char
id|tfr_port
suffix:colon
l_int|2
suffix:semicolon
)brace
id|config_2
suffix:semicolon
r_char
id|name
(braket
l_int|16
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s%d&quot;
comma
id|driver_name
comma
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
op_star
id|port_base
comma
id|REGION_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: address 0x%03x in use, skipping probe.&bslash;n&quot;
comma
id|name
comma
op_star
id|port_base
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inb
c_func
(paren
op_star
id|port_base
op_plus
id|REG_PRODUCT_ID1
)paren
op_ne
id|PRODUCT_ID1
)paren
r_return
id|FALSE
suffix:semicolon
id|in_byte
op_assign
id|inb
c_func
(paren
op_star
id|port_base
op_plus
id|REG_PRODUCT_ID2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_byte
op_amp
l_int|0xf0
)paren
op_ne
id|PRODUCT_ID2
)paren
r_return
id|FALSE
suffix:semicolon
op_star
(paren
r_char
op_star
)paren
op_amp
id|config_1
op_assign
id|inb
c_func
(paren
op_star
id|port_base
op_plus
id|REG_CONFIG1
)paren
suffix:semicolon
op_star
(paren
r_char
op_star
)paren
op_amp
id|config_2
op_assign
id|inb
c_func
(paren
op_star
id|port_base
op_plus
id|REG_CONFIG2
)paren
suffix:semicolon
id|irq
op_assign
id|interrupt_table
(braket
id|config_1.interrupt
)braket
suffix:semicolon
id|dma_channel
op_assign
id|dma_channel_table
(braket
id|config_1.dma_channel
)braket
suffix:semicolon
id|subversion
op_assign
(paren
id|in_byte
op_amp
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Board detected, allocate its IRQ if not already done */
r_if
c_cond
(paren
(paren
id|irq
op_ge
id|MAX_IRQ
)paren
op_logical_or
(paren
(paren
id|irqlist
(braket
id|irq
)braket
op_eq
id|NO_IRQ
)paren
op_logical_and
id|request_irq
(paren
id|irq
comma
id|u14_34f_interrupt_handler
comma
id|SA_INTERRUPT
comma
id|driver_name
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to allocate IRQ %u, detaching.&bslash;n&quot;
comma
id|name
comma
id|irq
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|subversion
op_eq
id|ISA
op_logical_and
id|request_dma
c_func
(paren
id|dma_channel
comma
id|driver_name
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to allocate DMA channel %u, detaching.&bslash;n&quot;
comma
id|name
comma
id|dma_channel
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|sh
(braket
id|j
)braket
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|hostdata
)paren
)paren
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_assign
op_star
id|port_base
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|n_io_port
op_assign
id|REGION_SIZE
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|base
op_assign
id|bios_segment_table
(braket
id|config_1.bios_segment
)braket
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|irq
op_assign
id|irq
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|sg_tablesize
op_assign
id|MAX_SGLIST
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|this_id
op_assign
id|config_2.ha_scsi_id
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
op_assign
id|MAX_MAILBOXES
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
macro_line|#if defined(DEBUG_DETECT)
(brace
r_int
r_char
id|sys_mask
comma
id|lcl_mask
suffix:semicolon
id|sys_mask
op_assign
id|inb
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_SYS_MASK
)paren
suffix:semicolon
id|lcl_mask
op_assign
id|inb
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_LCL_MASK
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYS_MASK 0x%x, LCL_MASK 0x%x.&bslash;n&quot;
comma
id|sys_mask
comma
id|lcl_mask
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* If BIOS is disabled, force enable interrupts */
r_if
c_cond
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|base
op_eq
l_int|0
)paren
id|outb
c_func
(paren
id|CMD_ENA_INTR
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_SYS_MASK
)paren
suffix:semicolon
multiline_comment|/* Register the I/O space that we use */
id|request_region
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
comma
id|REGION_SIZE
comma
id|driver_name
)paren
suffix:semicolon
id|memset
c_func
(paren
id|HD
c_func
(paren
id|j
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hostdata
)paren
)paren
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|heads
op_assign
id|mapping_table
(braket
id|config_2.mapping_mode
)braket
dot
id|heads
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|sectors
op_assign
id|mapping_table
(braket
id|config_2.mapping_mode
)braket
dot
id|sectors
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|subversion
op_assign
id|subversion
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_number
op_assign
id|j
suffix:semicolon
id|irqlist
(braket
id|irq
)braket
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|subversion
op_eq
id|ESA
)paren
(brace
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|dma_channel
op_assign
id|NO_DMA
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|unchecked_isa_dma
op_assign
id|FALSE
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|hostt-&gt;use_clustering
op_assign
id|ENABLE_CLUSTERING
suffix:semicolon
id|sprintf
c_func
(paren
id|BN
c_func
(paren
id|j
)paren
comma
l_string|&quot;U34F%d&quot;
comma
id|j
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if !defined(MODULE)
multiline_comment|/* The module code does not checkin/checkout in the blocking list yet */
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|block
op_assign
id|sh
(braket
id|j
)braket
suffix:semicolon
macro_line|#endif
macro_line|#if defined (HAVE_OLD_U14F_FIRMWARE)
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|hostt-&gt;use_clustering
op_assign
id|DISABLE_CLUSTERING
suffix:semicolon
macro_line|#else
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|hostt-&gt;use_clustering
op_assign
id|ENABLE_CLUSTERING
suffix:semicolon
macro_line|#endif
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|dma_channel
op_assign
id|dma_channel
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|unchecked_isa_dma
op_assign
id|TRUE
suffix:semicolon
id|sprintf
c_func
(paren
id|BN
c_func
(paren
id|j
)paren
comma
l_string|&quot;U14F%d&quot;
comma
id|j
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dma_channel
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|dma_channel
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|dma_channel
comma
id|DMA_MODE_CASCADE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|dma_channel
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|subversion
op_eq
id|ISA
op_logical_and
op_logical_neg
id|board_inquiry
c_func
(paren
id|j
)paren
)paren
(brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_id
(braket
l_int|40
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
op_amp
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_id
(braket
l_int|32
)braket
comma
l_string|&quot;06000600&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
op_amp
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_id
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: firmware %s is outdated, BIOS rev. should be 2.01.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
op_amp
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|board_id
(braket
l_int|32
)braket
)paren
suffix:semicolon
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|hostt-&gt;use_clustering
op_assign
id|DISABLE_CLUSTERING
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;%s: PORT 0x%03x, BIOS 0x%05x, IRQ %u, DMA %u, SG %d, &quot;
"&bslash;"
l_string|&quot;Mbox %d, CmdLun %d, C%d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
comma
(paren
r_int
)paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|base
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|irq
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|dma_channel
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|sg_tablesize
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|cmd_per_lun
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|hostt-&gt;use_clustering
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
DECL|function|u14_34f_detect
r_int
id|u14_34f_detect
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_int
id|j
op_assign
l_int|0
comma
id|k
comma
id|flags
suffix:semicolon
id|ushort
id|io_port
(braket
)braket
op_assign
(brace
l_int|0x330
comma
l_int|0x340
comma
l_int|0x230
comma
l_int|0x240
comma
l_int|0x210
comma
l_int|0x130
comma
l_int|0x140
comma
l_int|0x0
)brace
suffix:semicolon
id|ushort
op_star
id|port_base
op_assign
id|io_port
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|MAX_IRQ
suffix:semicolon
id|k
op_increment
)paren
(brace
id|irqlist
(braket
id|k
)braket
op_assign
id|NO_IRQ
suffix:semicolon
id|calls
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|MAX_BOARDS
op_plus
l_int|1
suffix:semicolon
id|k
op_increment
)paren
id|sh
(braket
id|k
)braket
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
op_star
id|port_base
)paren
(brace
r_if
c_cond
(paren
id|j
OL
id|MAX_BOARDS
op_logical_and
id|port_detect
c_func
(paren
id|port_base
comma
id|j
comma
id|tpnt
)paren
)paren
id|j
op_increment
suffix:semicolon
id|port_base
op_increment
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|j
suffix:semicolon
)brace
DECL|function|build_sg_list
r_static
r_inline
r_void
id|build_sg_list
c_func
(paren
r_struct
id|mscp
op_star
id|cpp
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|k
comma
id|data_len
op_assign
l_int|0
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgpnt
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|SCpnt-&gt;use_sg
suffix:semicolon
id|k
op_increment
)paren
(brace
id|cpp-&gt;sglist
(braket
id|k
)braket
dot
id|address
op_assign
(paren
r_int
r_int
)paren
id|sgpnt
(braket
id|k
)braket
dot
id|address
suffix:semicolon
id|cpp-&gt;sglist
(braket
id|k
)braket
dot
id|num_bytes
op_assign
id|sgpnt
(braket
id|k
)braket
dot
id|length
suffix:semicolon
id|data_len
op_add_assign
id|sgpnt
(braket
id|k
)braket
dot
id|length
suffix:semicolon
)brace
id|cpp-&gt;use_sg
op_assign
id|SCpnt-&gt;use_sg
suffix:semicolon
id|cpp-&gt;data_address
op_assign
(paren
r_int
r_int
)paren
id|cpp-&gt;sglist
suffix:semicolon
id|cpp-&gt;data_len
op_assign
id|data_len
suffix:semicolon
)brace
DECL|function|u14_34f_queuecommand
r_int
id|u14_34f_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|i
comma
id|j
comma
id|k
comma
id|flags
suffix:semicolon
r_struct
id|mscp
op_star
id|cpp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* j is the board number */
id|j
op_assign
(paren
(paren
r_struct
id|hostdata
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_member_access_from_pointer
id|board_number
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
id|panic
c_func
(paren
l_string|&quot;%s: qcomm, pid %ld, null done.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCpnt-&gt;pid
)paren
suffix:semicolon
multiline_comment|/* i is the mailbox number, look for the first free mailbox &n;      starting from last_cp_used */
id|i
op_assign
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|last_cp_used
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
suffix:semicolon
id|k
op_increment
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_ge
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|FREE
)paren
(brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|last_cp_used
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|k
op_eq
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: qcomm, no free mailbox, resetting.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|in_reset
)paren
id|printk
c_func
(paren
l_string|&quot;%s: qcomm, already in reset.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|u14_34f_reset
c_func
(paren
id|SCpnt
)paren
op_eq
id|SCSI_RESET_SUCCESS
)paren
id|panic
c_func
(paren
l_string|&quot;%s: qcomm, SCSI_RESET_SUCCESS.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: qcomm, pid %ld, DID_BUS_BUSY, done.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCpnt-&gt;pid
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set pointer to control packet structure */
id|cpp
op_assign
op_amp
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cpp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mscp
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cpp-&gt;index
op_assign
id|i
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|cpp-&gt;index
suffix:semicolon
r_if
c_cond
(paren
id|do_trace
)paren
id|printk
c_func
(paren
l_string|&quot;%s: qcomm, mbox %d, target %d, pid %ld.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;pid
)paren
suffix:semicolon
id|cpp-&gt;opcode
op_assign
id|OP_SCSI
suffix:semicolon
id|cpp-&gt;xdir
op_assign
id|DTD_SCSI
suffix:semicolon
id|cpp-&gt;target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|cpp-&gt;lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|cpp-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
id|cpp-&gt;sense_addr
op_assign
(paren
r_int
r_int
)paren
id|SCpnt-&gt;sense_buffer
suffix:semicolon
id|cpp-&gt;sense_len
op_assign
r_sizeof
id|SCpnt-&gt;sense_buffer
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|cpp-&gt;sg
op_assign
id|TRUE
suffix:semicolon
id|build_sg_list
c_func
(paren
id|cpp
comma
id|SCpnt
)paren
suffix:semicolon
)brace
r_else
(brace
id|cpp-&gt;data_address
op_assign
(paren
r_int
r_int
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|cpp-&gt;data_len
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
)brace
id|cpp-&gt;scsi_cdbs_len
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|memcpy
c_func
(paren
id|cpp-&gt;scsi_cdbs
comma
id|SCpnt-&gt;cmnd
comma
id|cpp-&gt;scsi_cdbs_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_on_busy
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: qcomm, target %d, pid %ld, adapter busy, DID_ERROR, done.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;pid
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Store pointer in OGM address bytes */
id|outl
c_func
(paren
(paren
r_int
r_int
)paren
id|cpp
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_OGM
)paren
suffix:semicolon
multiline_comment|/* Issue OGM interrupt */
id|outb
c_func
(paren
id|CMD_OGM_INTR
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_LCL_INTR
)paren
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|IN_USE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|u14_34f_abort
r_int
id|u14_34f_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCarg
)paren
(brace
r_int
r_int
id|i
comma
id|j
comma
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|j
op_assign
(paren
(paren
r_struct
id|hostdata
op_star
)paren
id|SCarg-&gt;host-&gt;hostdata
)paren
op_member_access_from_pointer
id|board_number
suffix:semicolon
r_if
c_cond
(paren
id|SCarg-&gt;host_scribble
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: abort, target %d, pid %ld inactive.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCarg-&gt;target
comma
id|SCarg-&gt;pid
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
id|i
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|SCarg-&gt;host_scribble
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: abort, mbox %d, target %d, pid %ld.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCarg-&gt;target
comma
id|SCarg-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
)paren
id|panic
c_func
(paren
l_string|&quot;%s: abort, invalid SCarg-&gt;host_scribble.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_on_busy
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: abort, timeout error.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|FREE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: abort, mbox %d is free.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|IN_USE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: abort, mbox %d is in use.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCarg
op_ne
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
(braket
id|i
)braket
dot
id|SCpnt
)paren
id|panic
c_func
(paren
l_string|&quot;%s: abort, mbox %d, SCarg %p, cp SCpnt %p.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCarg
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
(braket
id|i
)braket
dot
id|SCpnt
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|IN_RESET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: abort, mbox %d is in reset.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|LOCKED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: abort, mbox %d is locked.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
r_else
id|panic
c_func
(paren
l_string|&quot;%s: abort, mbox %d, invalid cp_stat.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
)brace
DECL|function|u14_34f_reset
r_int
id|u14_34f_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCarg
)paren
(brace
r_int
r_int
id|i
comma
id|j
comma
id|flags
comma
id|time
comma
id|k
comma
id|limit
op_assign
l_int|0
suffix:semicolon
r_int
id|arg_done
op_assign
id|FALSE
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|j
op_assign
(paren
(paren
r_struct
id|hostdata
op_star
)paren
id|SCarg-&gt;host-&gt;hostdata
)paren
op_member_access_from_pointer
id|board_number
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: reset, enter, target %d, pid %ld.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCarg-&gt;target
comma
id|SCarg-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCarg-&gt;host_scribble
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;%s: reset, pid %ld inactive.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCarg-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|in_reset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: reset, exit, already in reset.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait_on_busy
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: reset, exit, timeout error.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|MAX_TARGET
suffix:semicolon
id|k
op_increment
)paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_reset
(braket
id|k
)braket
op_assign
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|FREE
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|LOCKED
)paren
(brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|FREE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: reset, locked mbox %d forced free.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|SCpnt
op_assign
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
(braket
id|i
)braket
dot
id|SCpnt
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|IN_RESET
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: reset, mbox %d in reset, pid %ld.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCpnt-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;%s: reset, mbox %d, SCpnt == NULL.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;host_scribble
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;%s: reset, mbox %d, garbled SCpnt.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|SCpnt-&gt;host_scribble
op_ne
id|i
)paren
id|panic
c_func
(paren
l_string|&quot;%s: reset, mbox %d, index mismatch.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;scsi_done
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;%s: reset, mbox %d, SCpnt-&gt;scsi_done == NULL.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
id|SCarg
)paren
id|arg_done
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait_on_busy
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: reset, cannot reset, timeout error.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_RESET_ERROR
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CMD_RESET
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_LCL_INTR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: reset, board reset done, enabling interrupts.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
id|do_trace
op_assign
id|TRUE
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|in_reset
op_assign
id|TRUE
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|time
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
(paren
id|time
op_plus
l_int|200
)paren
op_logical_and
id|limit
op_increment
OL
l_int|100000000
)paren
id|sti
c_func
(paren
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: reset, interrupts disabled, loops %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|limit
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Skip mailboxes already set free by interrupt */
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_ne
id|IN_RESET
)paren
r_continue
suffix:semicolon
id|SCpnt
op_assign
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
(braket
id|i
)braket
dot
id|SCpnt
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* This mailbox is still waiting for its interrupt */
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|LOCKED
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s, reset, mbox %d locked, DID_RESET, pid %ld done.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCpnt-&gt;pid
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|in_reset
op_assign
id|FALSE
suffix:semicolon
id|do_trace
op_assign
id|FALSE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: reset, exit, success.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: reset, exit, wakeup.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
)brace
DECL|function|u14_34f_biosparam
r_int
id|u14_34f_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
r_int
id|dev
comma
r_int
op_star
id|dkinfo
)paren
(brace
r_int
r_int
id|j
op_assign
l_int|0
suffix:semicolon
r_int
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|dkinfo
(braket
l_int|0
)braket
op_assign
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|heads
suffix:semicolon
id|dkinfo
(braket
l_int|1
)braket
op_assign
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|sectors
suffix:semicolon
id|dkinfo
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|heads
op_star
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|sectors
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|u14_34f_interrupt_handler
r_static
r_void
id|u14_34f_interrupt_handler
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_int
r_int
id|i
comma
id|j
comma
id|k
comma
id|flags
comma
id|status
comma
id|tstatus
comma
id|loops
comma
id|total_loops
op_assign
l_int|0
suffix:semicolon
r_struct
id|mscp
op_star
id|spp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqlist
(braket
id|irq
)braket
op_eq
id|NO_IRQ
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, ihdlr, irq %d, unexpected interrupt.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_trace
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, enter, irq %d, calls %d.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
comma
id|calls
(braket
id|irq
)braket
)paren
suffix:semicolon
multiline_comment|/* Service all the boards configured on this irq */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|sh
(braket
id|j
)braket
op_ne
l_int|NULL
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|irq
op_ne
id|irq
)paren
r_continue
suffix:semicolon
id|loops
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Loop until all interrupts for a board are serviced */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_SYS_INTR
)paren
op_amp
id|IRQ_ASSERTED
)paren
(brace
id|total_loops
op_increment
suffix:semicolon
id|loops
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|do_trace
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, start service, count %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
)paren
suffix:semicolon
id|spp
op_assign
(paren
r_struct
id|mscp
op_star
)paren
id|inl
c_func
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_ICM
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt pending flag */
id|outb
c_func
(paren
id|CMD_CLR_INTR
comma
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|io_port
op_plus
id|REG_SYS_INTR
)paren
suffix:semicolon
id|i
op_assign
id|spp
op_minus
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|can_queue
)paren
id|panic
c_func
(paren
l_string|&quot;%s: ihdlr, invalid mscp address.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|IGNORE
)paren
(brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|FREE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|LOCKED
)paren
(brace
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|FREE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d unlocked, count %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|FREE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d is free, count %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_eq
id|IN_RESET
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d is in reset.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_ne
id|IN_USE
)paren
id|panic
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d, invalid cp_stat.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|cp_stat
(braket
id|i
)braket
op_assign
id|FREE
suffix:semicolon
id|SCpnt
op_assign
id|spp-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d, SCpnt == NULL.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;host_scribble
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d, pid %ld, SCpnt %p garbled.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCpnt-&gt;pid
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|SCpnt-&gt;host_scribble
op_ne
id|i
)paren
id|panic
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d, pid %ld, index mismatch %d,&quot;
"&bslash;"
l_string|&quot; irq %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|SCpnt-&gt;pid
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|SCpnt-&gt;host_scribble
comma
id|irq
)paren
suffix:semicolon
id|tstatus
op_assign
id|status_byte
c_func
(paren
id|spp-&gt;target_status
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|spp-&gt;adapter_status
)paren
(brace
r_case
id|ASOK
suffix:colon
multiline_comment|/* status OK */
multiline_comment|/* Forces a reset if a disk drive keeps returning BUSY */
r_if
c_cond
(paren
id|tstatus
op_eq
id|BUSY
op_logical_and
id|SCpnt-&gt;device-&gt;type
op_ne
id|TYPE_TAPE
)paren
id|status
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* If there was a bus reset, redo operation on each target */
r_else
r_if
c_cond
(paren
id|tstatus
op_ne
id|GOOD
op_logical_and
id|SCpnt-&gt;device-&gt;type
op_eq
id|TYPE_DISK
op_logical_and
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_reset
(braket
id|SCpnt-&gt;target
)braket
)paren
id|status
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* Works around a flaw in scsi.c */
r_else
r_if
c_cond
(paren
id|tstatus
op_eq
id|CHECK_CONDITION
op_logical_and
id|SCpnt-&gt;device-&gt;type
op_eq
id|TYPE_DISK
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
op_eq
id|RECOVERED_ERROR
)paren
id|status
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tstatus
op_eq
id|CHECK_CONDITION
op_logical_and
(paren
id|SCpnt-&gt;device-&gt;type
op_eq
id|TYPE_DISK
op_logical_or
id|SCpnt-&gt;device-&gt;type
op_eq
id|TYPE_ROM
)paren
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
op_eq
id|UNIT_ATTENTION
)paren
id|status
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_else
id|status
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|tstatus
op_eq
id|GOOD
)paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_reset
(braket
id|SCpnt-&gt;target
)braket
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|spp-&gt;target_status
op_logical_and
(paren
id|SCpnt-&gt;device-&gt;type
op_eq
id|TYPE_DISK
op_logical_or
id|SCpnt-&gt;device-&gt;type
op_eq
id|TYPE_ROM
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, target %d:%d, pid %ld, target_status &quot;
"&bslash;"
l_string|&quot;0x%x, sense key 0x%x.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|SCpnt-&gt;pid
comma
id|spp-&gt;target_status
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_time_out
(braket
id|SCpnt-&gt;target
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ASST
suffix:colon
multiline_comment|/* Selection Time Out */
r_if
c_cond
(paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_time_out
(braket
id|SCpnt-&gt;target
)braket
OG
l_int|1
)paren
id|status
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_else
(brace
id|status
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_time_out
(braket
id|SCpnt-&gt;target
)braket
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x92
suffix:colon
multiline_comment|/* Data over/under-run */
r_case
l_int|0x93
suffix:colon
multiline_comment|/* Unexpected bus free */
r_case
l_int|0x94
suffix:colon
multiline_comment|/* Target bus phase sequence failure */
r_case
l_int|0x96
suffix:colon
multiline_comment|/* Illegal SCSI command */
r_case
l_int|0xa3
suffix:colon
multiline_comment|/* SCSI bus reset error */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;type
op_ne
id|TYPE_TAPE
)paren
id|status
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_else
id|status
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|MAX_TARGET
suffix:semicolon
id|k
op_increment
)paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|target_reset
(braket
id|k
)braket
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Invalid command */
r_case
l_int|0x02
suffix:colon
multiline_comment|/* Invalid parameters */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* Invalid data list */
r_case
l_int|0x84
suffix:colon
multiline_comment|/* SCSI bus abort error */
r_case
l_int|0x9b
suffix:colon
multiline_comment|/* Auto request sense error */
r_case
l_int|0x9f
suffix:colon
multiline_comment|/* Unexpected command complete message error */
r_case
l_int|0xff
suffix:colon
multiline_comment|/* Invalid parameter in the S/G list */
r_default
suffix:colon
id|status
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SCpnt-&gt;result
op_assign
id|status
op_or
id|spp-&gt;target_status
suffix:semicolon
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|loops
OG
l_int|1
)paren
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|multicount
op_increment
suffix:semicolon
macro_line|#if defined (DEBUG_INTERRUPT)
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_logical_or
id|do_trace
)paren
macro_line|#else
r_if
c_cond
(paren
(paren
id|spp-&gt;adapter_status
op_ne
id|ASOK
op_logical_and
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
OG
l_int|1000
)paren
op_logical_or
(paren
id|spp-&gt;adapter_status
op_ne
id|ASOK
op_logical_and
id|spp-&gt;adapter_status
op_ne
id|ASST
op_logical_and
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
op_le
l_int|1000
)paren
op_logical_or
id|do_trace
)paren
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, mbox %d, err 0x%x:%x,&quot;
"&bslash;"
l_string|&quot; target %d:%d, pid %ld, count %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|i
comma
id|spp-&gt;adapter_status
comma
id|spp-&gt;target_status
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|SCpnt-&gt;pid
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
)paren
suffix:semicolon
multiline_comment|/* Set the command state to inactive */
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Multiple command loop */
)brace
multiline_comment|/* Boards loop */
id|calls
(braket
id|irq
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|total_loops
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, irq %d, no command completed, calls %d.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
comma
id|calls
(braket
id|irq
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_trace
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, exit, irq %d, calls %d.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
comma
id|calls
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#if defined (DEBUG_STATISTICS)
r_if
c_cond
(paren
(paren
id|calls
(braket
id|irq
)braket
op_mod
l_int|100000
)paren
op_eq
l_int|10000
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|sh
(braket
id|j
)braket
op_ne
l_int|NULL
suffix:semicolon
id|j
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ihdlr, calls %d, count %d, multi %d.&bslash;n&quot;
comma
id|BN
c_func
(paren
id|j
)paren
comma
id|calls
(braket
(paren
id|sh
(braket
id|j
)braket
op_member_access_from_pointer
id|irq
)paren
)braket
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|iocount
comma
id|HD
c_func
(paren
id|j
)paren
op_member_access_from_pointer
id|multicount
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if defined(MODULE)
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|ULTRASTOR_14_34F
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
eof
